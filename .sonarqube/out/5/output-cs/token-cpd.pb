»F
Ö/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Views/Memberships/Components/TitleBar.axaml.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Views

 
.

 
Memberships

 )
.

) *

Components

* 4
;

4 5
public 
partial 
class 
TitleBar 
: 
UserControl  +
{ 
public 

static 
readonly 
StyledProperty )
<) *
bool* .
>. /&
DisableCloseButtonProperty0 J
=K L
AvaloniaProperty 
. 
Register !
<! "
TitleBar" *
,* +
bool, 0
>0 1
(1 2
nameof2 8
(8 9
DisableCloseButton9 K
)K L
,L M
trueN R
)R S
;S T
public 

static 
readonly 
StyledProperty )
<) *
bool* .
>. /)
DisableMinimizeButtonProperty0 M
=N O
AvaloniaProperty 
. 
Register !
<! "
TitleBar" *
,* +
bool, 0
>0 1
(1 2
nameof2 8
(8 9!
DisableMinimizeButton9 N
)N O
,O P
trueQ U
)U V
;V W
public 

static 
readonly 
StyledProperty )
<) *
bool* .
>. /)
DisableMaximizeButtonProperty0 M
=N O
AvaloniaProperty 
. 
Register !
<! "
TitleBar" *
,* +
bool, 0
>0 1
(1 2
nameof2 8
(8 9!
DisableMaximizeButton9 N
)N O
,O P
trueQ U
)U V
;V W
public 

ReactiveCommand 
< 
Unit 
,  
Unit! %
>% &
CloseCommand' 3
{4 5
get6 9
;9 :
}; <
public 

ReactiveCommand 
< 
Unit 
,  
Unit! %
>% &
MinimizeCommand' 6
{7 8
get9 <
;< =
}> ?
public 

ReactiveCommand 
< 
Unit 
,  
Unit! %
>% &
MaximizeCommand' 6
{7 8
get9 <
;< =
}> ?
private 
readonly 
IDisposable  
?  !'
_pointerPressedSubscription" =
;= >
public 

TitleBar 
( 
) 
{ 
InitializeComponent 
( 
) 
; 
CloseCommand!! 
=!! 
ReactiveCommand!! &
.!!& '
Create!!' -
(!!- .
("" 
)"" 
=>"" 
Window"" 
?"" 
."" 
Close"" 
(""  
)""  !
,""! "
this## 
.## 
WhenAnyValue## 
(## 
x## 
=>##  "
x### $
.##$ %
DisableCloseButton##% 7
)##7 8
.##8 9
Select##9 ?
(##? @
disable##@ G
=>##H J
!##K L
disable##L S
)##S T
)$$ 	
;$$	 

MinimizeCommand&& 
=&& 
ReactiveCommand&& )
.&&) *
Create&&* 0
(&&0 1
('' 
)'' 
=>'' 
{(( 
if)) 
()) 
Window)) 
!=)) 
null)) "
)))" #
{** 
Window++ 
.++ 
WindowState++ &
=++' (
WindowState++) 4
.++4 5
	Minimized++5 >
;++> ?
},, 
}-- 
,-- 
this.. 
... 
WhenAnyValue.. 
(.. 
x.. 
=>..  "
x..# $
...$ %!
DisableMinimizeButton..% :
)..: ;
...; <
Select..< B
(..B C
disable..C J
=>..K M
!..N O
disable..O V
)..V W
)// 	
;//	 

MaximizeCommand11 
=11 
ReactiveCommand11 )
.11) *
Create11* 0
(110 1
(22 
)22 
=>22 
{33 
if44 
(44 
Window44 
!=44 
null44 "
)44" #
{55 
Window66 
.66 
WindowState66 &
=66' (
Window66) /
.66/ 0
WindowState660 ;
==66< >
WindowState66? J
.66J K
	Maximized66K T
?77 
WindowState77 %
.77% &
Normal77& ,
:88 
WindowState88 %
.88% &
	Maximized88& /
;88/ 0
}99 
}:: 
,:: 
this;; 
.;; 
WhenAnyValue;; 
(;; 
x;; 
=>;;  "
x;;# $
.;;$ %!
DisableMaximizeButton;;% :
);;: ;
.;;; <
Select;;< B
(;;B C
disable;;C J
=>;;K M
!;;N O
disable;;O V
);;V W
)<< 	
;<<	 

Panel>> 
?>> 
	rootPanel>> 
=>> 
this>> 
.>>  
FindControl>>  +
<>>+ ,
Panel>>, 1
>>>1 2
(>>2 3
$str>>3 >
)>>> ?
;>>? @
if?? 

(?? 
	rootPanel?? 
!=?? 
null?? 
)?? 
{@@ 	'
_pointerPressedSubscriptionAA '
=AA( )

ObservableAA* 4
.AA4 5
FromEventPatternAA5 E
<AAE F#
PointerPressedEventArgsAAF ]
>AA] ^
(AA^ _
hBB 
=>BB 
	rootPanelBB 
.BB 
PointerPressedBB -
+=BB. 0
hBB1 2
,BB2 3
hCC 
=>CC 
	rootPanelCC 
.CC 
PointerPressedCC -
-=CC. 0
hCC1 2
)DD 
.DD 
	SubscribeDD 
(DD 
eDD 
=>DD 
{EE 
ifFF 
(FF 
eFF 
.FF 
	EventArgsFF 
.FF  
GetCurrentPointFF  /
(FF/ 0
thisFF0 4
)FF4 5
.FF5 6

PropertiesFF6 @
.FF@ A
IsLeftButtonPressedFFA T
)FFT U
{GG 
WindowHH 
?HH 
.HH 
BeginMoveDragHH )
(HH) *
eHH* +
.HH+ ,
	EventArgsHH, 5
)HH5 6
;HH6 7
}II 
}JJ 
)JJ 
;JJ 
}KK 	
thisMM 
.MM 
UnloadedMM 
+=MM 
(MM 
sMM 
,MM 
eMM 
)MM 
=>MM  "'
_pointerPressedSubscriptionMM# >
?MM> ?
.MM? @
DisposeMM@ G
(MMG H
)MMH I
;MMI J
}NN 
publicPP 

boolPP 
DisableCloseButtonPP "
{QQ 
getRR 
=>RR 
GetValueRR 
(RR &
DisableCloseButtonPropertyRR 2
)RR2 3
;RR3 4
setSS 
=>SS 
SetValueSS 
(SS &
DisableCloseButtonPropertySS 2
,SS2 3
valueSS4 9
)SS9 :
;SS: ;
}TT 
publicVV 

boolVV !
DisableMinimizeButtonVV %
{WW 
getXX 
=>XX 
GetValueXX 
(XX )
DisableMinimizeButtonPropertyXX 5
)XX5 6
;XX6 7
setYY 
=>YY 
SetValueYY 
(YY )
DisableMinimizeButtonPropertyYY 5
,YY5 6
valueYY7 <
)YY< =
;YY= >
}ZZ 
public\\ 

bool\\ !
DisableMaximizeButton\\ %
{]] 
get^^ 
=>^^ 
GetValue^^ 
(^^ )
DisableMaximizeButtonProperty^^ 5
)^^5 6
;^^6 7
set__ 
=>__ 
SetValue__ 
(__ )
DisableMaximizeButtonProperty__ 5
,__5 6
value__7 <
)__< =
;__= >
}`` 
privatebb 
Windowbb 
?bb 
Windowbb 
=>bb 

VisualRootbb (
asbb) +
Windowbb, 2
;bb2 3
privatedd 
voiddd 
InitializeComponentdd $
(dd$ %
)dd% &
{ee 
AvaloniaXamlLoaderff 
.ff 
Loadff 
(ff  
thisff  $
)ff$ %
;ff% &
}gg 
}hh ©
o/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Views/Core/MainWindow.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Views 
. 
Core "
;" #
public 
partial 
class 

MainWindow 
:  !
ReactiveWindow" 0
<0 1
MainWindowViewModel1 D
>D E
{ 
private 
bool #
_languageSelectorLoaded (
;( )
private 
readonly 
Border 
? &
_languageSelectorContainer 7
;7 8
public 


MainWindow 
( 
) 
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
IconService 
. 
SetIconForWindow $
($ %
this% )
)) *
;* +&
_languageSelectorContainer "
=# $
this% )
.) *
FindControl* 5
<5 6
Border6 <
>< =
(= >
$str> Y
)Y Z
;Z [%
SetupLazyLanguageSelector !
(! "
)" #
;# $
this 
. 
AttachDevTools 
( 
) 
; 
}   
private"" 
void"" %
SetupLazyLanguageSelector"" *
(""* +
)""+ ,
{## 
this$$ 
.$$ 
WhenActivated$$ 
($$ 
disposables$$ &
=>$$' )
{%% 	
this&& 
.&& 
WhenAnyValue&& 
(&& 
x&& 
=>&&  "
x&&# $
.&&$ %
DataContext&&% 0
)&&0 1
.'' 
Where'' 
('' 
dc'' 
=>'' 
dc'' 
!=''  "
null''# '
)''' (
.(( 
Select(( 
((( 
dc(( 
=>(( 
dc((  
!((  !
)((! "
.)) 
OfType)) 
<)) 
MainWindowViewModel)) +
>))+ ,
()), -
)))- .
.** 
Take** 
(** 
$num** 
)** 
.++ 
Where++ 
(++ 
_++ 
=>++ 
!++ #
_languageSelectorLoaded++ 4
)++4 5
.,, 
	ObserveOn,, 
(,, 
RxApp,,  
.,,  !
MainThreadScheduler,,! 4
),,4 5
.-- 
	Subscribe-- 
(--  
LoadLanguageSelector-- /
)--/ 0
... 
DisposeWith.. 
(.. 
disposables.. (
)..( )
;..) *
}// 	
)//	 

;//
 
}00 
private22 
void22  
LoadLanguageSelector22 %
(22% &
MainWindowViewModel22& 9
	viewModel22: C
)22C D
{33 
if44 

(44 #
_languageSelectorLoaded44 #
||44$ &&
_languageSelectorContainer44' A
==44B D
null44E I
)44I J
{55 	
return66 
;66 
}77 	 
LanguageSelectorView99 
languageSelector99 -
=99. /
new990 3
(993 4
)994 5
{:: 	
DataContext;; 
=;; 
	viewModel;; #
.;;# $
LanguageSelector;;$ 4
}<< 	
;<<	 
&
_languageSelectorContainer>> "
.>>" #
Child>># (
=>>) *
languageSelector>>+ ;
;>>; <#
_languageSelectorLoaded?? 
=??  !
true??" &
;??& '
}@@ 
}AA êp
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/ViewModels/Core/MainWindowViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 

ViewModels "
." #
Core# '
;' (
public 
sealed 
class 
MainWindowViewModel '
:( )
ReactiveObject* 8
,8 9
IDisposable: E
{ 
private 
readonly 
IBottomSheetService (
_bottomSheetService) <
;< =
private 
readonly 
CompositeDisposable (
_disposables) 5
=6 7
new8 ;
(; <
)< =
;= >
private 
bool 
_isDisposed 
; 
[ 
Reactive 
] 
public 
object 
? 
CurrentContent ,
{- .
get/ 2
;2 3
private4 ;
set< ?
;? @
}A B
[ 
Reactive 
] 
public 
double 
WindowWidth (
{) *
get+ .
;. /
private0 7
set8 ;
;; <
}= >
[!! 
Reactive!! 
]!! 
public!! 
double!! 
WindowHeight!! )
{!!* +
get!!, /
;!!/ 0
private!!1 8
set!!9 <
;!!< =
}!!> ?
[## 
Reactive## 
]## 
public## 
bool## 
	CanResize## $
{##% &
get##' *
;##* +
private##, 3
set##4 7
;##7 8
}##9 :
[%% 
Reactive%% 
]%% 
public%% 
bool%% 
IsAuthenticated%% *
{%%+ ,
get%%- 0
;%%0 1
private%%2 9
set%%: =
;%%= >
}%%? @
['' 
Reactive'' 
]'' 
public'' 
string'' 
WindowTitle'' (
{'') *
get''+ .
;''. /
set''0 3
;''3 4
}''5 6
public)) 
%
LanguageSelectorViewModel)) $
LanguageSelector))% 5
{))6 7
get))8 ;
;)); <
}))= >
public++ 
-
!ConnectivityNotificationViewModel++ ,$
ConnectivityNotification++- E
{++F G
get++H K
;++K L
}++M N
public-- 

MainWindowViewModel-- 
(-- 
IBottomSheetService.. 
bottomSheetService.. .
,... / 
ILocalizationService// 
localizationService// 0
,//0 1-
!IApplicationSecureStorageProvider00 )
storageProvider00* 9
,009 : 
IRpcMetaDataProvider11 
rpcMetaDataProvider11 0
,110 1-
!ConnectivityNotificationViewModel22 )$
connectivityNotification22* B
)22B C
{33 
_bottomSheetService44 
=44 
bottomSheetService44 0
;440 1
WindowWidth66 
=66 
$num66 
;66 
WindowHeight77 
=77 
$num77 
;77 
	CanResize88 
=88 
false88 
;88 
IsAuthenticated99 
=99 
false99 
;99  
WindowTitle:: 
=:: 
string:: 
.:: 
Empty:: "
;::" #
LanguageSelector<< 
=<< 
new<< %
LanguageSelectorViewModel<< 8
(<<8 9
localizationService== 
,==  
storageProvider>> 
,>> 
rpcMetaDataProvider?? 
)??  
;??  !$
ConnectivityNotificationAA  
=AA! "$
connectivityNotificationAA# ;
;AA; <
SetupHandlersAsyncCC 
(CC 
)CC 
.CC 
ContinueWithCC )
(CC) *
taskDD 
=>DD 
{EE 
ifFF 
(FF 
taskFF 
.FF 
	IsFaultedFF "
&&FF# %
taskFF& *
.FF* +
	ExceptionFF+ 4
!=FF5 7
nullFF8 <
)FF< =
{GG 
LogHH 
.HH 
ErrorHH 
(HH 
taskHH "
.HH" #
	ExceptionHH# ,
,HH, -
$strHH. f
)HHf g
;HHg h
}II 
}JJ 
,JJ 
TaskSchedulerKK 
.KK 
DefaultKK !
)KK! "
;KK" #
}LL 
publicNN 

asyncNN 
TaskNN )
SetAuthenticationContentAsyncNN 3
(NN3 4
objectNN4 :
contentNN; B
)NNB C
{OO 
awaitPP $
AnimateWindowResizeAsyncPP &
(PP& '
$numPP' *
,PP* +
$numPP, /
,PP/ 0
TimeSpanPP1 9
.PP9 :
FromMillisecondsPP: J
(PPJ K
$numPPK N
)PPN O
)PPO P
.PPP Q
ConfigureAwaitPPQ _
(PP_ `
falsePP` e
)PPe f
;PPf g
	CanResizeRR 
=RR 
falseRR 
;RR 
IsAuthenticatedSS 
=SS 
falseSS 
;SS  
awaitUU #
SetContentWithFadeAsyncUU %
(UU% &
contentUU& -
)UU- .
.UU. /
ConfigureAwaitUU/ =
(UU= >
falseUU> C
)UUC D
;UUD E
}VV 
publicXX 

asyncXX 
TaskXX 
SetMainContentAsyncXX )
(XX) *
objectXX* 0
contentXX1 8
)XX8 9
{YY 
awaitZZ $
AnimateWindowResizeAsyncZZ &
(ZZ& '
$numZZ' +
,ZZ+ ,
$numZZ- 0
,ZZ0 1
TimeSpanZZ2 :
.ZZ: ;
FromMillisecondsZZ; K
(ZZK L
$numZZL O
)ZZO P
)ZZP Q
.ZZQ R
ConfigureAwaitZZR `
(ZZ` a
falseZZa f
)ZZf g
;ZZg h
	CanResize\\ 
=\\ 
true\\ 
;\\ 
IsAuthenticated]] 
=]] 
true]] 
;]] 
await__ #
SetContentWithFadeAsync__ %
(__% &
content__& -
)__- .
.__. /
ConfigureAwait__/ =
(__= >
false__> C
)__C D
;__D E
}`` 
publicbb 

asyncbb 
Taskbb  
ShowBottomSheetAsyncbb *
(bb* +$
BottomSheetComponentTypecc  
typecc! %
,cc% &
UserControldd 
viewdd 
,dd 
boolee 
	showScrimee 
=ee 
trueee 
,ee 
boolff 
isDismissableff 
=ff 
falseff "
)ff" #
{gg 
awaithh 
_bottomSheetServicehh !
.hh! "
	ShowAsynchh" +
(hh+ ,
typehh, 0
,hh0 1
viewhh2 6
,hh6 7
	showScrimhh8 A
,hhA B
isDismissablehhC P
)hhP Q
.hhQ R
ConfigureAwaithhR `
(hh` a
falsehha f
)hhf g
;hhg h
}ii 
publickk 

asynckk 
Taskkk  
HideBottomSheetAsynckk *
(kk* +
)kk+ ,
{ll 
awaitmm 
_bottomSheetServicemm !
.mm! "
	HideAsyncmm" +
(mm+ ,
)mm, -
.mm- .
ConfigureAwaitmm. <
(mm< =
falsemm= B
)mmB C
;mmC D
}nn 
publicpp 

IDisposablepp 
OnBottomSheetHiddenpp *
(pp* +
Funcpp+ /
<pp/ 0"
BottomSheetHiddenEventpp0 F
,ppF G
TaskppH L
>ppL M
handlerppN U
,ppU V 
SubscriptionLifetimeppW k
lifetimeppl t
)ppt u
{qq 
returnrr 
_bottomSheetServicerr "
.rr" #
OnBottomSheetHiddenrr# 6
(rr6 7
handlerrr7 >
,rr> ?
lifetimerr@ H
)rrH I
;rrI J
}ss 
publicuu 

voiduu 
Disposeuu 
(uu 
)uu 
{vv 
ifww 

(ww 
_isDisposedww 
)ww 
{xx 	
returnyy 
;yy 
}zz 	
_disposables|| 
.|| 
Dispose|| 
(|| 
)|| 
;|| 
LanguageSelector}} 
.}} 
Dispose}}  
(}}  !
)}}! "
;}}" #$
ConnectivityNotification~~  
.~~  !
Dispose~~! (
(~~( )
)~~) *
;~~* +
_isDisposed
ÄÄ 
=
ÄÄ 
true
ÄÄ 
;
ÄÄ 
}
ÅÅ 
private
ÉÉ 
static
ÉÉ 
double
ÉÉ 
EaseInOutCubic
ÉÉ (
(
ÉÉ( )
double
ÉÉ) /
t
ÉÉ0 1
)
ÉÉ1 2
{
ÑÑ 
return
ÖÖ 
t
ÖÖ 
<
ÖÖ 
$num
ÖÖ 
?
ÖÖ 
$num
ÖÖ 
*
ÖÖ 
t
ÖÖ 
*
ÖÖ  
t
ÖÖ! "
*
ÖÖ# $
t
ÖÖ% &
:
ÖÖ' (
$num
ÖÖ) *
-
ÖÖ+ ,
Math
ÖÖ- 1
.
ÖÖ1 2
Pow
ÖÖ2 5
(
ÖÖ5 6
-
ÖÖ6 7
$num
ÖÖ7 8
*
ÖÖ9 :
t
ÖÖ; <
+
ÖÖ= >
$num
ÖÖ? @
,
ÖÖ@ A
$num
ÖÖB C
)
ÖÖC D
/
ÖÖE F
$num
ÖÖG H
;
ÖÖH I
}
ÜÜ 
private
àà 
static
àà 
Task
àà  
SetupHandlersAsync
àà *
(
àà* +
)
àà+ ,
=>
àà- /
Task
àà0 4
.
àà4 5
CompletedTask
àà5 B
;
ààB C
private
ää 
async
ää 
Task
ää &
AnimateWindowResizeAsync
ää /
(
ää/ 0
double
ää0 6
targetWidth
ää7 B
,
ääB C
double
ääD J
targetHeight
ääK W
,
ääW X
TimeSpan
ääY a
duration
ääb j
)
ääj k
{
ãã 
double
åå 

startWidth
åå 
=
åå 
WindowWidth
åå '
;
åå' (
double
çç 
startHeight
çç 
=
çç 
WindowHeight
çç )
;
çç) *
if
èè 

(
èè 
Math
èè 
.
èè 
Abs
èè 
(
èè 

startWidth
èè 
-
èè  !
targetWidth
èè" -
)
èè- .
<
èè/ 0
$num
èè1 5
&&
èè6 8
Math
èè9 =
.
èè= >
Abs
èè> A
(
èèA B
startHeight
èèB M
-
èèN O
targetHeight
èèP \
)
èè\ ]
<
èè^ _
$num
èè` d
)
èèd e
{
êê 	
return
ëë 
;
ëë 
}
íí 	
Log
îî 
.
îî 
Debug
îî 
(
îî 
$str
îî }
,
îî} ~

startWidth
ïï 
,
ïï 
startHeight
ïï #
,
ïï# $
targetWidth
ïï% 0
,
ïï0 1
targetHeight
ïï2 >
)
ïï> ?
;
ïï? @
int
óó 
steps
óó 
=
óó 
$num
óó 
;
óó 
TimeSpan
òò 
stepDuration
òò 
=
òò 
TimeSpan
òò  (
.
òò( )
FromMilliseconds
òò) 9
(
òò9 :
duration
òò: B
.
òòB C
TotalMilliseconds
òòC T
/
òòU V
steps
òòW \
)
òò\ ]
;
òò] ^
for
öö 
(
öö 
int
öö 
i
öö 
=
öö 
$num
öö 
;
öö 
i
öö 
<=
öö 
steps
öö "
;
öö" #
i
öö$ %
++
öö% '
)
öö' (
{
õõ 	
double
úú 
progress
úú 
=
úú 
(
úú 
double
úú %
)
úú% &
i
úú& '
/
úú( )
steps
úú* /
;
úú/ 0
double
ùù 
easedProgress
ùù  
=
ùù! "
EaseInOutCubic
ùù# 1
(
ùù1 2
progress
ùù2 :
)
ùù: ;
;
ùù; <
WindowWidth
üü 
=
üü 

startWidth
üü $
+
üü% &
(
üü' (
targetWidth
üü( 3
-
üü4 5

startWidth
üü6 @
)
üü@ A
*
üüB C
easedProgress
üüD Q
;
üüQ R
WindowHeight
†† 
=
†† 
startHeight
†† &
+
††' (
(
††) *
targetHeight
††* 6
-
††7 8
startHeight
††9 D
)
††D E
*
††F G
easedProgress
††H U
;
††U V
await
¢¢ 
Task
¢¢ 
.
¢¢ 
Delay
¢¢ 
(
¢¢ 
stepDuration
¢¢ )
)
¢¢) *
.
¢¢* +
ConfigureAwait
¢¢+ 9
(
¢¢9 :
false
¢¢: ?
)
¢¢? @
;
¢¢@ A
}
££ 	
WindowWidth
•• 
=
•• 
targetWidth
•• !
;
••! "
WindowHeight
¶¶ 
=
¶¶ 
targetHeight
¶¶ #
;
¶¶# $
}
ßß 
private
©© 
async
©© 
Task
©© %
SetContentWithFadeAsync
©© .
(
©©. /
object
©©/ 5
content
©©6 =
)
©©= >
{
™™ 
if
´´ 

(
´´ 
CurrentContent
´´ 
!=
´´ 
null
´´ "
)
´´" #
{
¨¨ 	
await
≠≠ 
Task
≠≠ 
.
≠≠ 
Delay
≠≠ 
(
≠≠ 
$num
≠≠  
)
≠≠  !
.
≠≠! "
ConfigureAwait
≠≠" 0
(
≠≠0 1
false
≠≠1 6
)
≠≠6 7
;
≠≠7 8
}
ÆÆ 	
CurrentContent
∞∞ 
=
∞∞ 
content
∞∞  
;
∞∞  !
await
≤≤ 
Task
≤≤ 
.
≤≤ 
Delay
≤≤ 
(
≤≤ 
$num
≤≤ 
)
≤≤ 
.
≤≤ 
ConfigureAwait
≤≤ ,
(
≤≤, -
false
≤≤- 2
)
≤≤2 3
;
≤≤3 4
}
≥≥ 
}¥¥ ˛>
g/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/VersionHelper.cs
	namespace 	
Ecliptix
 
. 
Core 
; 
[

 '
JsonSourceGenerationOptions

 
(

  
PropertyNamingPolicy 
= !
JsonKnownNamingPolicy 0
.0 1
	CamelCase1 :
,: ;
WriteIndented 
= 
false 
, 
GenerationMode 
= $
JsonSourceGenerationMode -
.- .
Metadata. 6
|7 8$
JsonSourceGenerationMode9 Q
.Q R
SerializationR _
)_ `
]` a
[ 
JsonSerializable 
( 
typeof 
( 
	BuildInfo "
)" #
)# $
]$ %
public 
partial 
class 
EcliptixJsonContext (
:) *!
JsonSerializerContext+ @
;@ A
public 
static 
class 
VersionHelper !
{ 
private 
static 
readonly 
Lazy  
<  !
string! '
>' (
ApplicationVersion) ;
=< =
new> A
(A B'
CalculateApplicationVersionB ]
)] ^
;^ _
[ (
UnconditionalSuppressMessage !
(! "
$str" ,
,, -
$str. 6
,6 7
Justification 
= 
$str w
)w x
]x y
private 
static 
readonly 
Lazy  
<  !
string! '
>' ( 
InformationalVersion) =
=> ?
new@ C
(C D)
CalculateInformationalVersionD a
)a b
;b c
private 
static 
readonly 
Lazy  
<  !
Option! '
<' (
	BuildInfo( 1
>1 2
>2 3
	BuildInfo4 =
=> ?
new@ C
(C D
LoadBuildInfoD Q
)Q R
;R S
private 
static 
readonly 
Lazy  
<  !
string! '
>' (
DisplayVersion) 7
=8 9
new: =
(= >#
CalculateDisplayVersion> U
)U V
;V W
public 

static 
string !
GetApplicationVersion .
(. /
)/ 0
=>1 3
ApplicationVersion4 F
.F G
ValueG L
;L M
public 

static 
string #
GetInformationalVersion 0
(0 1
)1 2
=>3 5 
InformationalVersion6 J
.J K
ValueK P
;P Q
public   

static   
Option   
<   
	BuildInfo   "
>  " #
GetBuildInfo  $ 0
(  0 1
)  1 2
=>  3 5
	BuildInfo  6 ?
.  ? @
Value  @ E
;  E F
public"" 

static"" 
string"" 
GetDisplayVersion"" *
(""* +
)""+ ,
=>""- /
DisplayVersion""0 >
.""> ?
Value""? D
;""D E
private$$ 
static$$ 
string$$ '
CalculateApplicationVersion$$ 5
($$5 6
)$$6 7
{%% 
return&& 
typeof&& 
(&& 
VersionHelper&& #
)&&# $
.&&$ %
Assembly&&% -
.&&- .
GetName&&. 5
(&&5 6
)&&6 7
.&&7 8
Version&&8 ?
?&&? @
.&&@ A
ToString&&A I
(&&I J
$num&&J K
)&&K L
??&&M O
$str&&P W
;&&W X
}'' 
[)) $
RequiresUnreferencedCode)) 
()) 
$str)) N
)))N O
]))O P
private** 
static** 
string** )
CalculateInformationalVersion** 7
(**7 8
)**8 9
{++ 
try,, 
{-- 	
string..  
informationalVersion.. '
=..( )
typeof..* 0
(..0 1
VersionHelper..1 >
)..> ?
...? @
Assembly..@ H
.// 
GetCustomAttributes// (
(//( )
typeof//) /
(/// 0
System//0 6
.//6 7

Reflection//7 A
.//A B1
%AssemblyInformationalVersionAttribute//B g
)//g h
,//h i
false//j o
)//o p
is00 
System00 
.00 

Reflection00 $
.00$ %1
%AssemblyInformationalVersionAttribute00% J
[00J K
]00K L
{00M N
Length00O U
:00U V
>00W X
$num00Y Z
}00[ \
attrs00] b
?11 
attrs11 
[11 
$num11 
]11 
.11  
InformationalVersion11 /
:22 !
GetApplicationVersion22 '
(22' (
)22( )
;22) *
return33  
informationalVersion33 '
;33' (
}44 	
catch55 
{66 	
return77 !
GetApplicationVersion77 (
(77( )
)77) *
;77* +
}88 	
}99 
private;; 
static;; 
Option;; 
<;; 
	BuildInfo;; #
>;;# $
LoadBuildInfo;;% 2
(;;2 3
);;3 4
{<< 
try== 
{>> 	
string?? 
buildInfoPath??  
=??! "
Path??# '
.??' (
Combine??( /
(??/ 0

AppContext??0 :
.??: ;
BaseDirectory??; H
,??H I
$str??J [
)??[ \
;??\ ]
if@@ 
(@@ 
!@@ 
File@@ 
.@@ 
Exists@@ 
(@@ 
buildInfoPath@@ *
)@@* +
)@@+ ,
{AA 
returnBB 
OptionBB 
<BB 
	BuildInfoBB '
>BB' (
.BB( )
NoneBB) -
;BB- .
}CC 
stringEE 
jsonEE 
=EE 
FileEE 
.EE 
ReadAllTextEE *
(EE* +
buildInfoPathEE+ 8
)EE8 9
;EE9 :
returnFF 
JsonSerializerFF !
.FF! "
DeserializeFF" -
(FF- .
jsonFF. 2
,FF2 3
EcliptixJsonContextFF4 G
.FFG H
DefaultFFH O
.FFO P
	BuildInfoFFP Y
)FFY Z
.FFZ [
ToOptionFF[ c
(FFc d
)FFd e
;FFe f
}GG 	
catchHH 
{II 	
returnJJ 
OptionJJ 
<JJ 
	BuildInfoJJ #
>JJ# $
.JJ$ %
NoneJJ% )
;JJ) *
}KK 	
}LL 
privateNN 
staticNN 
stringNN #
CalculateDisplayVersionNN 1
(NN1 2
)NN2 3
{OO 
returnPP 
GetBuildInfoPP 
(PP 
)PP 
.QQ 
SelectQQ 
(QQ 
infoQQ 
=>QQ 
infoQQ  
.QQ  !
FullVersionQQ! ,
)QQ, -
.RR 
ValueOrRR 
(RR #
GetInformationalVersionRR ,
(RR, -
)RR- .
)RR. /
;RR/ 0
}SS 
}TT 
publicVV 
recordVV 
	BuildInfoVV 
(VV 
stringWW 

VersionWW 
,WW 
stringXX 

BuildNumberXX 
,XX 
stringYY 

FullVersionYY 
,YY 
stringZZ 

	TimestampZZ 
,ZZ 
string[[ 

	GitCommit[[ 
,[[ 
string\\ 

	GitBranch\\ 
)]] 
;]] èA
z/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Shared/Converters/MathConverters.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Shared 
. 

Converters )
;) *
public 
static 
class 
MathConverters "
{ 
public		 

static		 
readonly		 
IValueConverter		 *
Add		+ .
=		/ 0
new		1 4
AddConverter		5 A
(		A B
)		B C
;		C D
public

 

static

 
readonly

 
IValueConverter

 *
Subtract

+ 3
=

4 5
new

6 9
SubtractConverter

: K
(

K L
)

L M
;

M N
public 

static 
readonly 
IValueConverter *
Multiply+ 3
=4 5
new6 9
MultiplyConverter: K
(K L
)L M
;M N
public 

static 
readonly 
IValueConverter *
Divide+ 1
=2 3
new4 7
DivideConverter8 G
(G H
)H I
;I J
} 
public 
class 
AddConverter 
: 
IValueConverter +
{ 
public 

object 
? 
Convert 
( 
object !
?! "
value# (
,( )
Type* .

targetType/ 9
,9 :
object; A
?A B
	parameterC L
,L M
CultureInfoN Y
cultureZ a
)a b
{ 
return 
value 
switch 
{ 	
double 
doubleValue 
when #
	parameter$ -
is. 0
string1 7
paramStr8 @
&&A C
doubleD J
.J K
TryParseK S
(S T
paramStrT \
,\ ]
out^ a
doubleb h
parami n
)n o
=>p r
doubleValue 
+ 
param #
,# $
int 
intValue 
when 
	parameter '
is( *
string+ 1
	paramStr22 ;
&&< >
int? B
.B C
TryParseC K
(K L
	paramStr2L U
,U V
outW Z
int[ ^
param2_ e
)e f
=>g i
intValuej r
+s t
param2 
, 
_ 
=> 
value 
} 	
;	 

} 
public 

object 
ConvertBack 
( 
object $
?$ %
value& +
,+ ,
Type- 1

targetType2 <
,< =
object> D
?D E
	parameterF O
,O P
CultureInfoQ \
culture] d
)d e
{ 
throw 
new !
NotSupportedException '
(' (
$str( a
)a b
;b c
}   
}!! 
public## 
class## 
SubtractConverter## 
:##  
IValueConverter##! 0
{$$ 
public%% 

object%% 
?%% 
Convert%% 
(%% 
object%% !
?%%! "
value%%# (
,%%( )
Type%%* .

targetType%%/ 9
,%%9 :
object%%; A
?%%A B
	parameter%%C L
,%%L M
CultureInfo%%N Y
culture%%Z a
)%%a b
{&& 
if'' 

('' 
value'' 
is'' 
double'' 
doubleValue'' '
&&''( *
	parameter''+ 4
is''5 7
string''8 >
paramStr''? G
&&''H J
double''K Q
.''Q R
TryParse''R Z
(''Z [
paramStr''[ c
,''c d
out''e h
double''i o
param''p u
)''u v
)''v w
{(( 	
return)) 
doubleValue)) 
-))  
param))! &
;))& '
}** 	
return,, 
value,, 
;,, 
}-- 
public// 

object// 
ConvertBack// 
(// 
object// $
?//$ %
value//& +
,//+ ,
Type//- 1

targetType//2 <
,//< =
object//> D
?//D E
	parameter//F O
,//O P
CultureInfo//Q \
culture//] d
)//d e
{00 
throw11 
new11 !
NotSupportedException11 '
(11' (
$str11( a
)11a b
;11b c
}22 
}33 
public55 
class55 
MultiplyConverter55 
:55  
IValueConverter55! 0
{66 
public77 

object77 
?77 
Convert77 
(77 
object77 !
?77! "
value77# (
,77( )
Type77* .

targetType77/ 9
,779 :
object77; A
?77A B
	parameter77C L
,77L M
CultureInfo77N Y
culture77Z a
)77a b
{88 
if99 

(99 
value99 
is99 
double99 
doubleValue99 '
&&99( *
	parameter99+ 4
is995 7
string998 >
paramStr99? G
&&99H J
double99K Q
.99Q R
TryParse99R Z
(99Z [
paramStr99[ c
,99c d
out99e h
double99i o
param99p u
)99u v
)99v w
{:: 	
return;; 
doubleValue;; 
*;;  
param;;! &
;;;& '
}<< 	
return>> 
value>> 
;>> 
}?? 
publicAA 

objectAA 
ConvertBackAA 
(AA 
objectAA $
?AA$ %
valueAA& +
,AA+ ,
TypeAA- 1

targetTypeAA2 <
,AA< =
objectAA> D
?AAD E
	parameterAAF O
,AAO P
CultureInfoAAQ \
cultureAA] d
)AAd e
{BB 
throwCC 
newCC !
NotSupportedExceptionCC '
(CC' (
$strCC( a
)CCa b
;CCb c
}DD 
}EE 
publicGG 
classGG 
DivideConverterGG 
:GG 
IValueConverterGG .
{HH 
publicII 

objectII 
?II 
ConvertII 
(II 
objectII !
?II! "
valueII# (
,II( )
TypeII* .

targetTypeII/ 9
,II9 :
objectII; A
?IIA B
	parameterIIC L
,IIL M
CultureInfoIIN Y
cultureIIZ a
)IIa b
{JJ 
ifKK 

(KK 
valueKK 
isKK 
doubleKK 
doubleValueKK '
&&KK( *
	parameterKK+ 4
isKK5 7
stringKK8 >
paramStrKK? G
&&KKH J
doubleLL 
.LL 
TryParseLL 
(LL 
paramStrLL $
,LL$ %
outLL& )
doubleLL* 0
paramLL1 6
)LL6 7
&&LL8 :
MathLL; ?
.LL? @
AbsLL@ C
(LLC D
paramLLD I
)LLI J
>LLK L
doubleLLM S
.LLS T
EpsilonLLT [
)LL[ \
{MM 	
returnNN 
doubleValueNN 
/NN  
paramNN! &
;NN& '
}OO 	
returnQQ 
valueQQ 
;QQ 
}RR 
publicTT 

objectTT 
ConvertBackTT 
(TT 
objectTT $
?TT$ %
valueTT& +
,TT+ ,
TypeTT- 1

targetTypeTT2 <
,TT< =
objectTT> D
?TTD E
	parameterTTF O
,TTO P
CultureInfoTTQ \
cultureTT] d
)TTd e
{UU 
throwVV 
newVV !
NotSupportedExceptionVV '
(VV' (
$strVV( a
)VVa b
;VVb c
}WW 
}XX Â
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Shared/Converters/EqualityConverter.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Shared 
. 

Converters )
;) *
public 
class 
EqualityConverter 
:  
IValueConverter! 0
{ 
public		 

object		 
?		 
Convert		 
(		 
object		 !
?		! "
value		# (
,		( )
Type		* .

targetType		/ 9
,		9 :
object		; A
?		A B
	parameter		C L
,		L M
CultureInfo		N Y
culture		Z a
)		a b
{

 
return 
value 
? 
. 
Equals 
( 
	parameter &
)& '
??( *
false+ 0
;0 1
} 
public 

object 
ConvertBack 
( 
object $
?$ %
value& +
,+ ,
Type- 1

targetType2 <
,< =
object> D
?D E
	parameterF O
,O P
CultureInfoQ \
culture] d
)d e
{ 
throw 
new #
NotImplementedException )
() *
$str* e
)e f
;f g
} 
} ¶
Ö/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Shared/Converters/BooleanToOpacityConverter.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Shared 
. 

Converters )
;) *
public 
class %
BooleanToOpacityConverter &
:' (
IValueConverter) 8
{ 
public		 

double		 
TrueOpacity		 
{		 
get		  #
;		# $
set		% (
;		( )
}		* +
=		, -
$num		. 1
;		1 2
public

 

double

 
FalseOpacity

 
{

  
get

! $
;

$ %
set

& )
;

) *
}

+ ,
=

- .
$num

/ 0
;

0 1
public 

object 
Convert 
( 
object  
?  !
value" '
,' (
Type) -

targetType. 8
,8 9
object: @
?@ A
	parameterB K
,K L
CultureInfoM X
cultureY `
)` a
{ 
if 

( 
value 
is 
bool 
	boolValue #
)# $
{ 	
return 
	boolValue 
? 
TrueOpacity *
:+ ,
FalseOpacity- 9
;9 :
} 	
return 
FalseOpacity 
; 
} 
public 

object 
ConvertBack 
( 
object $
?$ %
value& +
,+ ,
Type- 1

targetType2 <
,< =
object> D
?D E
	parameterF O
,O P
CultureInfoQ \
culture] d
)d e
{ 
throw 
new #
NotImplementedException )
() *
$str* d
)d e
;e f
} 
} —
x/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Settings/DefaultSystemSettings.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Settings  
;  !
public 
class !
DefaultSystemSettings "
{ 
public 

required 
string 
DEFAULT_THEME (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
public 

required 
string 
ENVIRONMENT &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
public 

required 
string )
DATA_CENTER_CONNECTION_STRING 8
{9 :
get; >
;> ?
set@ C
;C D
}E F
public 

required 
string 
COUNTRY_CODE_API +
{, -
get. 1
;1 2
set3 6
;6 7
}8 9
public

 

required

 
string

 
DOMAIN_NAME

 &
{

' (
get

) ,
;

, -
set

. 1
;

1 2
}

3 4
public 

string 
? 
CULTURE 
{ 
get  
;  !
set" %
;% &
}' (
public 

required 
string 
PrivacyPolicyUrl +
{, -
get. 1
;1 2
set3 6
;6 7
}8 9
public 

required 
string 
TermsOfServiceUrl ,
{- .
get/ 2
;2 3
set4 7
;7 8
}9 :
public 

required 
string 

SupportUrl %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
} Í
à/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Settings/Constants/AppCultureSettingsConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Settings  
.  !
	Constants! *
;* +
public 
static 
class '
AppCultureSettingsConstants /
{ 
public 

const 
string  
DEFAULT_CULTURE_CODE ,
=- .
$str/ 6
;6 7
public 

const 
string "
UKRAINIAN_CULTURE_CODE .
=/ 0
$str1 8
;8 9
public 

const 
string &
UNITED_STATES_COUNTRY_CODE 2
=3 4
$str5 9
;9 :
public		 

const		 
string		  
UKRAINE_COUNTRY_CODE		 ,
=		- .
$str		/ 3
;		3 4
public 

const 
string #
UNITED_STATES_FLAG_PATH /
=0 1
$str2 j
;j k
public 

const 
string 
UKRAINE_FLAG_PATH )
=* +
$str, h
;h i
public 

const 
int "
DEFAULT_LANGUAGE_INDEX +
=, -
$num. /
;/ 0
public 

const 
int 
INITIAL_CAPACITY %
=& '
$num( )
;) *
public 

const 
char *
CULTURE_DISPLAY_NAME_SEPARATOR 4
=5 6
$char7 :
;: ;
public 

static 
readonly 
string !
EmptyString" -
=. /
string0 6
.6 7
Empty7 <
;< =
} ¯H
u/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Settings/AppCultureSettings.cs
	namespace		 	
Ecliptix		
 
.		 
Core		 
.		 
Settings		  
;		  !
public 
sealed 
class 
AppCultureSettings &
{ 
private 
static 
readonly 
Lazy  
<  !
AppCultureSettings! 3
>3 4
Instance5 =
=> ?
new@ C
(C D
(D E
)E F
=>G I
newJ M
AppCultureSettingsN `
(` a
)a b
)b c
;c d
public 

static 
AppCultureSettings $
Default% ,
=>- /
Instance0 8
.8 9
Value9 >
;> ?
private 
readonly 
FrozenDictionary %
<% &
string& ,
,, -
LanguageItem. :
>: ;
_languagesByCode< L
;L M
private 
readonly 
FrozenDictionary %
<% &
string& ,
,, -
string. 4
>4 5
_countryCultureMap6 H
;H I
private 
readonly 
FrozenDictionary %
<% &
string& ,
,, -
int. 1
>1 2
_languageIndexMap3 D
;D E
private 
AppCultureSettings 
( 
)  
{ 
List 
< 
LanguageItem 
> 
supportedLanguages -
=. /
new0 3
(3 4'
AppCultureSettingsConstants4 O
.O P
INITIAL_CAPACITYP `
)` a
{ 	
new 
LanguageItem 
( '
AppCultureSettingsConstants 8
.8 9 
DEFAULT_CULTURE_CODE9 M
,M N'
AppCultureSettingsConstants +
.+ ,&
UNITED_STATES_COUNTRY_CODE, F
,F G'
AppCultureSettingsConstants +
.+ ,#
UNITED_STATES_FLAG_PATH, C
)C D
,D E
new 
LanguageItem 
( '
AppCultureSettingsConstants 8
.8 9"
UKRAINIAN_CULTURE_CODE9 O
,O P'
AppCultureSettingsConstants +
.+ , 
UKRAINE_COUNTRY_CODE, @
,@ A'
AppCultureSettingsConstants +
.+ ,
UKRAINE_FLAG_PATH, =
)= >
} 	
;	 


Dictionary!! 
<!! 
string!! 
,!! 
string!! !
>!!! "
countryCultureMap!!# 4
=!!5 6
new!!7 :
(!!: ;'
AppCultureSettingsConstants!!; V
.!!V W
INITIAL_CAPACITY!!W g
)!!g h
{"" 	
{## '
AppCultureSettingsConstants## )
.##) *&
UNITED_STATES_COUNTRY_CODE##* D
,##D E'
AppCultureSettingsConstants##F a
.##a b 
DEFAULT_CULTURE_CODE##b v
}##w x
,##x y
{$$ '
AppCultureSettingsConstants$$ )
.$$) * 
UKRAINE_COUNTRY_CODE$$* >
,$$> ?'
AppCultureSettingsConstants$$@ [
.$$[ \"
UKRAINIAN_CULTURE_CODE$$\ r
}$$s t
,$$t u
}%% 	
;%%	 

_languagesByCode'' 
='' 
supportedLanguages'' -
.''- .
ToFrozenDictionary''. @
(''@ A
lang''A E
=>''F H
lang''I M
.''M N
Code''N R
,''R S
lang''T X
=>''Y [
lang''\ `
)''` a
;''a b
_countryCultureMap(( 
=(( 
countryCultureMap(( .
.((. /
ToFrozenDictionary((/ A
(((A B
)((B C
;((C D
_languageIndexMap)) 
=)) "
CreateLanguageIndexMap)) 2
())2 3
supportedLanguages))3 E
)))E F
;))F G
}** 
private,, 
static,, 
FrozenDictionary,, #
<,,# $
string,,$ *
,,,* +
int,,, /
>,,/ 0"
CreateLanguageIndexMap,,1 G
(,,G H
List,,H L
<,,L M
LanguageItem,,M Y
>,,Y Z
supportedLanguages,,[ m
),,m n
{-- 

Dictionary.. 
<.. 
string.. 
,.. 
int.. 
>.. 
indexMap..  (
=..) *
new..+ .
(... /
supportedLanguages../ A
...A B
Count..B G
)..G H
;..H I
for// 
(// 
int// 
i// 
=// 
$num// 
;// 
i// 
<// 
supportedLanguages// .
.//. /
Count/// 4
;//4 5
i//6 7
++//7 9
)//9 :
{00 	
indexMap11 
[11 
supportedLanguages11 '
[11' (
i11( )
]11) *
.11* +
Code11+ /
]11/ 0
=111 2
i113 4
;114 5
}22 	
return33 
indexMap33 
.33 
ToFrozenDictionary33 *
(33* +
)33+ ,
;33, -
}44 
public66 

IReadOnlyCollection66 
<66 
LanguageItem66 +
>66+ ,
SupportedLanguages66- ?
=>66@ B
_languagesByCode66C S
.66S T
Values66T Z
;66Z [
public88 

Option88 
<88 
LanguageItem88 
>88 
GetLanguageByCode88  1
(881 2
string882 8
cultureCode889 D
)88D E
=>88F H
_languagesByCode99 
.99 
GetValueOrDefault99 *
(99* +
cultureCode99+ 6
)996 7
.997 8
ToOption998 @
(99@ A
)99A B
;99B C
public;; 

string;; 
GetCultureByCountry;; %
(;;% &
string;;& ,
countryCode;;- 8
);;8 9
=>;;: <
_countryCultureMap<< 
.<< 
GetValueOrDefault<< ,
(<<, -
countryCode<<- 8
?<<8 9
.<<9 :
ToUpperInvariant<<: J
(<<J K
)<<K L
??<<M O'
AppCultureSettingsConstants<<P k
.<<k l
EmptyString<<l w
,<<w x(
AppCultureSettingsConstants	<<y î
.
<<î ï"
DEFAULT_CULTURE_CODE
<<ï ©
)
<<© ™
;
<<™ ´
public>> 

int>> 
GetLanguageIndex>> 
(>>  
string>>  &
cultureCode>>' 2
)>>2 3
=>>>4 6
_languageIndexMap?? 
.?? 
GetValueOrDefault?? +
(??+ ,
cultureCode??, 7
,??7 8'
AppCultureSettingsConstants??9 T
.??T U"
DEFAULT_LANGUAGE_INDEX??U k
)??k l
;??l m
publicAA 

stringAA 
GetDisplayNameAA  
(AA  !
stringAA! '
cultureCodeAA( 3
)AA3 4
{BB 
returnCC 
GetLanguageByCodeCC  
(CC  !
cultureCodeCC! ,
)CC, -
.DD 
SelectDD 
(DD 
langDD 
=>DD 
langDD  
.DD  !
DisplayNameDD! ,
)DD, -
.EE 
GetValueOrDefaultEE 
(EE 
(EE  
)EE  !
=>EE" $
{FF 
tryGG 
{HH 
CultureInfoII 
cultureII  '
=II( )
CultureInfoII* 5
.II5 6
GetCultureInfoII6 D
(IID E
cultureCodeIIE P
)IIP Q
;IIQ R
stringJJ 
englishNameJJ &
=JJ' (
cultureJJ) 0
.JJ0 1
EnglishNameJJ1 <
;JJ< =
intKK 
separatorIndexKK &
=KK' (
englishNameKK) 4
.KK4 5
IndexOfKK5 <
(KK< ='
AppCultureSettingsConstantsKK= X
.KKX Y*
CULTURE_DISPLAY_NAME_SEPARATORKKY w
)KKw x
;KKx y
returnLL 
separatorIndexLL )
>LL* +
$numLL, -
?LL. /
englishNameLL0 ;
[LL; <
..LL< >
separatorIndexLL> L
]LLL M
.LLM N
TrimLLN R
(LLR S
)LLS T
:LLU V
englishNameLLW b
.LLb c
TrimLLc g
(LLg h
)LLh i
;LLi j
}MM 
catchNN 
(NN $
CultureNotFoundExceptionNN /
exNN0 2
)NN2 3
{OO 
SystemPP 
.PP 
DiagnosticsPP &
.PP& '
DebugPP' ,
.PP, -
	WriteLinePP- 6
(PP6 7
$"PP7 9
$strPP9 Z
{PPZ [
cultureCodePP[ f
}PPf g
$strPPg p
{PPp q
exPPq s
.PPs t
MessagePPt {
}PP{ |
"PP| }
)PP} ~
;PP~ 
returnQQ 
cultureCodeQQ &
;QQ& '
}RR 
}SS 
)SS 
;SS 
}TT 
}UU ¿
É/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Security/ServerPublicKeyProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Security! )
;) *
internal

 
sealed

	 
class

 #
ServerPublicKeyProvider

 -
(

- .
NetworkProvider

. =
networkProvider

> M
)

M N
:

O P$
IServerPublicKeyProvider

Q i
{ 
private 
readonly 
Lock 
_lock 
=  !
new" %
(% &
)& '
;' (
private 
Option 
< 
byte 
[ 
] 
> 

_cachedKey %
=& '
Option( .
<. /
byte/ 3
[3 4
]4 5
>5 6
.6 7
None7 ;
;; <
public 

byte 
[ 
] 
GetServerPublicKey $
($ %
)% &
{ 
lock 
( 
_lock 
) 
{ 	
Option 
< 
byte 
[ 
] 
> 
key 
=  

_cachedKey! +
.+ ,
Or, .
(. /
(/ 0
)0 1
=>2 4
{ 
byte 
[ 
] 
newKey 
= #
SecureByteStringInterop  7
.7 8 
WithByteStringAsSpan8 L
(L M
networkProvider #
.# $'
ApplicationInstanceSettings$ ?
.? @
ServerPublicKey@ O
,O P
span 
=> 
span  
.  !
ToArray! (
(( )
)) *
)* +
;+ ,

_cachedKey 
= 
Option #
<# $
byte$ (
[( )
]) *
>* +
.+ ,
Some, 0
(0 1
newKey1 7
)7 8
;8 9
return 

_cachedKey !
;! "
} 
) 
; 
if 
( 
! 
key 
. 
IsSome 
) 
{ 
throw 
new %
InvalidOperationException 3
(3 4
$str4 V
)V W
;W X
} 
return!! 
(!! 
byte!! 
[!! 
]!! 
)!! 
key!! 
.!! 
Value!! $
!!!$ %
.!!% &
Clone!!& +
(!!+ ,
)!!, -
;!!- .
}"" 	
}## 
}$$ ç⁄
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/UnaryRpcServices.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
sealed 
class 
UnaryRpcServices $
:% &
IUnaryRpcServices' 8
{ 
private 
readonly 

Dictionary 
<  
RpcServiceType  .
,. /
GrpcMethodDelegate0 B
>B C
_serviceMethodsD S
;S T
private 
readonly 
MembershipServices '
.' ($
MembershipServicesClient( @%
_membershipServicesClientA Z
;Z [
private 
readonly 
IGrpcErrorProcessor (
_errorProcessor) 8
;8 9
private 
readonly #
IGrpcCallOptionsFactory ,
_callOptionsFactory- @
;@ A
private 
delegate 
Task 
< 
Result  
<  !
SecureEnvelope! /
,/ 0
NetworkFailure1 ?
>? @
>@ A
GrpcMethodDelegateB T
(T U
SecureEnvelope 
payload 
, 
RpcRequestContext 
? 
requestContext )
,) * 
IConnectivityService 
connectivityService 0
,0 1
CancellationToken 
token 
) 
; 
public 

UnaryRpcServices 
( 
MembershipServices   
.   $
MembershipServicesClient   3$
membershipServicesClient  4 L
,  L M
DeviceService!! 
.!! 
DeviceServiceClient!! )
deviceServiceClient!!* =
,!!= >$
AuthVerificationServices""  
.""  !*
AuthVerificationServicesClient""! ?(
authenticationServicesClient""@ \
,""\ ]
IGrpcErrorProcessor## 
errorProcessor## *
,##* +#
IGrpcCallOptionsFactory$$ 
callOptionsFactory$$  2
)%% 
{&& %
_membershipServicesClient'' !
=''" #$
membershipServicesClient''$ <
;''< =
_errorProcessor(( 
=(( 
errorProcessor(( (
;((( )
_callOptionsFactory)) 
=)) 
callOptionsFactory)) 0
;))0 1
_serviceMethods++ 
=++ 
new++ 

Dictionary++ (
<++( )
RpcServiceType++) 7
,++7 8
GrpcMethodDelegate++9 K
>++K L
{,, 	
[-- 
RpcServiceType-- 
.-- 
RegisterAppDevice-- -
]--- .
=--/ 0
RegisterDeviceAsync--1 D
,--D E
[.. 
RpcServiceType.. 
...  
ValidateMobileNumber.. 0
]..0 1
=..2 3%
ValidateMobileNumberAsync..4 M
,..M N
[// 
RpcServiceType// 
.// )
CheckMobileNumberAvailability// 9
]//9 :
=//; <.
"CheckMobileNumberAvailabilityAsync//= _
,//_ `
[00 
RpcServiceType00 
.00 
RegistrationInit00 ,
]00, -
=00. /0
$OpaqueRegistrationRecordRequestAsync000 T
,00T U
[11 
RpcServiceType11 
.11 
	VerifyOtp11 %
]11% &
=11' (
VerifyCodeAsync11) 8
,118 9
[22 
RpcServiceType22 
.22  
RegistrationComplete22 0
]220 1
=222 32
&OpaqueRegistrationCompleteRequestAsync224 Z
,22Z [
[33 
RpcServiceType33 
.33 !
RecoverySecretKeyInit33 1
]331 2
=333 4*
OpaqueRecoveryInitRequestAsync335 S
,33S T
[44 
RpcServiceType44 
.44 %
RecoverySecretKeyComplete44 5
]445 6
=447 8.
"OpaqueRecoveryCompleteRequestAsync449 [
,44[ \
[55 
RpcServiceType55 
.55 
SignInInitRequest55 -
]55- .
=55/ 0(
OpaqueSignInInitRequestAsync551 M
,55M N
[66 
RpcServiceType66 
.66 !
SignInCompleteRequest66 1
]661 2
=663 4,
 OpaqueSignInCompleteRequestAsync665 U
,66U V
[77 
RpcServiceType77 
.77 
Logout77 "
]77" #
=77$ %
LogoutAsync77& 1
,771 2
[88 
RpcServiceType88 
.88 
AnonymousLogout88 +
]88+ ,
=88- . 
AnonymousLogoutAsync88/ C
}99 	
;99	 

return:: 
;:: 
async<< 
Task<< 
<<< 
Result<< 
<<< 
SecureEnvelope<< (
,<<( )
NetworkFailure<<* 8
><<8 9
><<9 :
LogoutAsync<<; F
(<<F G
SecureEnvelope== 
payload== "
,==" #
RpcRequestContext>> 
?>> 
requestContext>> -
,>>- . 
IConnectivityService??  
connectivityService??! 4
,??4 5
CancellationToken@@ 
token@@ #
)AA 	
{BB 	
returnCC 
awaitCC  
ExecuteGrpcCallAsyncCC -
(CC- .
RpcServiceTypeDD 
.DD 
LogoutDD %
,DD% &
connectivityServiceEE #
,EE# $
requestContextFF 
,FF 
tokenGG 
,GG 
callOptionsHH 
=>HH %
_membershipServicesClientII -
.II- .
LogoutAsyncII. 9
(II9 :
payloadJJ 
,JJ  
callOptionsKK #
)LL 
)MM 
.MM 
ConfigureAwaitMM 
(MM 
falseMM "
)MM" #
;MM# $
}NN 	
asyncPP 
TaskPP 
<PP 
ResultPP 
<PP 
SecureEnvelopePP (
,PP( )
NetworkFailurePP* 8
>PP8 9
>PP9 : 
AnonymousLogoutAsyncPP; O
(PPO P
SecureEnvelopeQQ 
payloadQQ "
,QQ" #
RpcRequestContextRR 
?RR 
requestContextRR -
,RR- . 
IConnectivityServiceSS  
connectivityServiceSS! 4
,SS4 5
CancellationTokenTT 
tokenTT #
)UU 	
{VV 	
returnWW 
awaitWW  
ExecuteGrpcCallAsyncWW -
(WW- .
RpcServiceTypeXX 
.XX 
AnonymousLogoutXX .
,XX. /
connectivityServiceYY #
,YY# $
requestContextZZ 
,ZZ 
token[[ 
,[[ 
callOptions\\ 
=>\\ %
_membershipServicesClient]] -
.]]- . 
AnonymousLogoutAsync]]. B
(]]B C
payload^^ 
,^^  
callOptions__ #
)`` 
)aa 
.aa 
ConfigureAwaitaa 
(aa 
falseaa "
)aa" #
;aa# $
}bb 	
asyncdd 
Taskdd 
<dd 
Resultdd 
<dd 
SecureEnvelopedd (
,dd( )
NetworkFailuredd* 8
>dd8 9
>dd9 :
RegisterDeviceAsyncdd; N
(ddN O
SecureEnvelopeee 
payloadee "
,ee" #
RpcRequestContextff 
?ff 
requestContextff -
,ff- . 
IConnectivityServicegg  
connectivityServicegg! 4
,gg4 5
CancellationTokenhh 
tokenhh #
)ii 	
{jj 	
returnkk 
awaitkk  
ExecuteGrpcCallAsynckk -
(kk- .
RpcServiceTypell 
.ll 
RegisterAppDevicell 0
,ll0 1
connectivityServicemm #
,mm# $
requestContextnn 
,nn 
tokenoo 
,oo 
callOptionspp 
=>pp 
deviceServiceClientqq '
.qq' (
RegisterDeviceAsyncqq( ;
(qq; <
payloadrr 
,rr  
callOptionsss #
)tt 
)uu 
.uu 
ConfigureAwaituu 
(uu 
falseuu "
)uu" #
;uu# $
}vv 	
asyncxx 
Taskxx 
<xx 
Resultxx 
<xx 
SecureEnvelopexx (
,xx( )
NetworkFailurexx* 8
>xx8 9
>xx9 :%
ValidateMobileNumberAsyncxx; T
(xxT U
SecureEnvelopeyy 
payloadyy "
,yy" #
RpcRequestContextzz 
?zz 
requestContextzz -
,zz- . 
IConnectivityService{{  
connectivityService{{! 4
,{{4 5
CancellationToken|| 
token|| #
)}} 	
{~~ 	
return 
await  
ExecuteGrpcCallAsync -
(- .
RpcServiceType
ÄÄ 
.
ÄÄ "
ValidateMobileNumber
ÄÄ 3
,
ÄÄ3 4!
connectivityService
ÅÅ #
,
ÅÅ# $
requestContext
ÇÇ 
,
ÇÇ 
token
ÉÉ 
,
ÉÉ 
callOptions
ÑÑ 
=>
ÑÑ *
authenticationServicesClient
ÖÖ 0
.
ÖÖ0 1'
ValidateMobileNumberAsync
ÖÖ1 J
(
ÖÖJ K
payload
ÜÜ 
,
ÜÜ  
callOptions
áá #
)
àà 
)
ââ 
.
ââ 
ConfigureAwait
ââ 
(
ââ 
false
ââ "
)
ââ" #
;
ââ# $
}
ää 	
async
åå 
Task
åå 
<
åå 
Result
åå 
<
åå 
SecureEnvelope
åå (
,
åå( )
NetworkFailure
åå* 8
>
åå8 9
>
åå9 :0
"CheckMobileNumberAvailabilityAsync
åå; ]
(
åå] ^
SecureEnvelope
çç 
payload
çç "
,
çç" #
RpcRequestContext
éé 
?
éé 
requestContext
éé -
,
éé- ."
IConnectivityService
èè  !
connectivityService
èè! 4
,
èè4 5
CancellationToken
êê 
token
êê #
)
ëë 	
{
íí 	
return
ìì 
await
ìì "
ExecuteGrpcCallAsync
ìì -
(
ìì- .
RpcServiceType
îî 
.
îî +
CheckMobileNumberAvailability
îî <
,
îî< =!
connectivityService
ïï #
,
ïï# $
requestContext
ññ 
,
ññ 
token
óó 
,
óó 
callOptions
òò 
=>
òò *
authenticationServicesClient
ôô 0
.
ôô0 10
"CheckMobileNumberAvailabilityAsync
ôô1 S
(
ôôS T
payload
öö 
,
öö  
callOptions
õõ #
)
úú 
)
ùù 
.
ùù 
ConfigureAwait
ùù 
(
ùù 
false
ùù "
)
ùù" #
;
ùù# $
}
ûû 	
async
†† 
Task
†† 
<
†† 
Result
†† 
<
†† 
SecureEnvelope
†† (
,
††( )
NetworkFailure
††* 8
>
††8 9
>
††9 :2
$OpaqueRegistrationRecordRequestAsync
††; _
(
††_ `
SecureEnvelope
°° 
payload
°° "
,
°°" #
RpcRequestContext
¢¢ 
?
¢¢ 
requestContext
¢¢ -
,
¢¢- ."
IConnectivityService
££  !
connectivityService
££! 4
,
££4 5
CancellationToken
§§ 
token
§§ #
)
•• 	
{
¶¶ 	
return
ßß 
await
ßß "
ExecuteGrpcCallAsync
ßß -
(
ßß- .
RpcServiceType
®® 
.
®® 
RegistrationInit
®® /
,
®®/ 0!
connectivityService
©© #
,
©©# $
requestContext
™™ 
,
™™ 
token
´´ 
,
´´ 
callOptions
¨¨ 
=>
¨¨ &
membershipServicesClient
≠≠ ,
.
≠≠, -0
"OpaqueRegistrationInitRequestAsync
≠≠- O
(
≠≠O P
payload
ÆÆ 
,
ÆÆ  
callOptions
ØØ #
)
∞∞ 
)
±± 
.
±± 
ConfigureAwait
±± 
(
±± 
false
±± "
)
±±" #
;
±±# $
}
≤≤ 	
async
¥¥ 
Task
¥¥ 
<
¥¥ 
Result
¥¥ 
<
¥¥ 
SecureEnvelope
¥¥ (
,
¥¥( )
NetworkFailure
¥¥* 8
>
¥¥8 9
>
¥¥9 :
VerifyCodeAsync
¥¥; J
(
¥¥J K
SecureEnvelope
µµ 
payload
µµ "
,
µµ" #
RpcRequestContext
∂∂ 
?
∂∂ 
requestContext
∂∂ -
,
∂∂- ."
IConnectivityService
∑∑  !
connectivityService
∑∑! 4
,
∑∑4 5
CancellationToken
∏∏ 
token
∏∏ #
)
ππ 	
{
∫∫ 	
return
ªª 
await
ªª "
ExecuteGrpcCallAsync
ªª -
(
ªª- .
RpcServiceType
ºº 
.
ºº 
	VerifyOtp
ºº (
,
ºº( )!
connectivityService
ΩΩ #
,
ΩΩ# $
requestContext
ææ 
,
ææ 
token
øø 
,
øø 
callOptions
¿¿ 
=>
¿¿ *
authenticationServicesClient
¡¡ 0
.
¡¡0 1
VerifyOtpAsync
¡¡1 ?
(
¡¡? @
payload
¬¬ 
,
¬¬  
callOptions
√√ #
)
ƒƒ 
)
≈≈ 
.
≈≈ 
ConfigureAwait
≈≈ 
(
≈≈ 
false
≈≈ "
)
≈≈" #
;
≈≈# $
}
∆∆ 	
async
»» 
Task
»» 
<
»» 
Result
»» 
<
»» 
SecureEnvelope
»» (
,
»»( )
NetworkFailure
»»* 8
>
»»8 9
>
»»9 :4
&OpaqueRegistrationCompleteRequestAsync
»»; a
(
»»a b
SecureEnvelope
…… 
payload
…… "
,
……" #
RpcRequestContext
   
?
   
requestContext
   -
,
  - ."
IConnectivityService
ÀÀ  !
connectivityService
ÀÀ! 4
,
ÀÀ4 5
CancellationToken
ÃÃ 
token
ÃÃ #
)
ÕÕ 	
{
ŒŒ 	
return
œœ 
await
œœ "
ExecuteGrpcCallAsync
œœ -
(
œœ- .
RpcServiceType
–– 
.
–– "
RegistrationComplete
–– 3
,
––3 4!
connectivityService
—— #
,
——# $
requestContext
““ 
,
““ 
token
”” 
,
”” 
callOptions
‘‘ 
=>
‘‘ &
membershipServicesClient
’’ ,
.
’’, -4
&OpaqueRegistrationCompleteRequestAsync
’’- S
(
’’S T
payload
÷÷ 
,
÷÷  
callOptions
◊◊ #
)
ÿÿ 
)
ŸŸ 
.
ŸŸ 
ConfigureAwait
ŸŸ 
(
ŸŸ 
false
ŸŸ "
)
ŸŸ" #
;
ŸŸ# $
}
⁄⁄ 	
async
‹‹ 
Task
‹‹ 
<
‹‹ 
Result
‹‹ 
<
‹‹ 
SecureEnvelope
‹‹ (
,
‹‹( )
NetworkFailure
‹‹* 8
>
‹‹8 9
>
‹‹9 :*
OpaqueSignInInitRequestAsync
‹‹; W
(
‹‹W X
SecureEnvelope
›› 
payload
›› "
,
››" #
RpcRequestContext
ﬁﬁ 
?
ﬁﬁ 
requestContext
ﬁﬁ -
,
ﬁﬁ- ."
IConnectivityService
ﬂﬂ  !
connectivityService
ﬂﬂ! 4
,
ﬂﬂ4 5
CancellationToken
‡‡ 
token
‡‡ #
)
·· 	
{
‚‚ 	
return
„„ 
await
„„ "
ExecuteGrpcCallAsync
„„ -
(
„„- .
RpcServiceType
‰‰ 
.
‰‰ 
SignInInitRequest
‰‰ 0
,
‰‰0 1!
connectivityService
ÂÂ #
,
ÂÂ# $
requestContext
ÊÊ 
,
ÊÊ 
token
ÁÁ 
,
ÁÁ 
callOptions
ËË 
=>
ËË &
membershipServicesClient
ÈÈ ,
.
ÈÈ, -*
OpaqueSignInInitRequestAsync
ÈÈ- I
(
ÈÈI J
payload
ÍÍ 
,
ÍÍ  
callOptions
ÎÎ #
)
ÏÏ 
)
ÌÌ 
.
ÌÌ 
ConfigureAwait
ÌÌ 
(
ÌÌ 
false
ÌÌ "
)
ÌÌ" #
;
ÌÌ# $
}
ÓÓ 	
async
 
Task
 
<
 
Result
 
<
 
SecureEnvelope
 (
,
( )
NetworkFailure
* 8
>
8 9
>
9 :.
 OpaqueSignInCompleteRequestAsync
; [
(
[ \
SecureEnvelope
ÒÒ 
payload
ÒÒ "
,
ÒÒ" #
RpcRequestContext
ÚÚ 
?
ÚÚ 
requestContext
ÚÚ -
,
ÚÚ- ."
IConnectivityService
ÛÛ  !
connectivityService
ÛÛ! 4
,
ÛÛ4 5
CancellationToken
ÙÙ 
token
ÙÙ #
)
ıı 	
{
ˆˆ 	
return
˜˜ 
await
˜˜ "
ExecuteGrpcCallAsync
˜˜ -
(
˜˜- .
RpcServiceType
¯¯ 
.
¯¯ #
SignInCompleteRequest
¯¯ 4
,
¯¯4 5!
connectivityService
˘˘ #
,
˘˘# $
requestContext
˙˙ 
,
˙˙ 
token
˚˚ 
,
˚˚ 
callOptions
¸¸ 
=>
¸¸ &
membershipServicesClient
˝˝ ,
.
˝˝, -.
 OpaqueSignInCompleteRequestAsync
˝˝- M
(
˝˝M N
payload
˛˛ 
,
˛˛  
callOptions
ˇˇ #
)
ÄÄ 
)
ÅÅ 
.
ÅÅ 
ConfigureAwait
ÅÅ 
(
ÅÅ 
false
ÅÅ "
)
ÅÅ" #
;
ÅÅ# $
}
ÇÇ 	
async
ÑÑ 
Task
ÑÑ 
<
ÑÑ 
Result
ÑÑ 
<
ÑÑ 
SecureEnvelope
ÑÑ (
,
ÑÑ( )
NetworkFailure
ÑÑ* 8
>
ÑÑ8 9
>
ÑÑ9 :,
OpaqueRecoveryInitRequestAsync
ÑÑ; Y
(
ÑÑY Z
SecureEnvelope
ÖÖ 
payload
ÖÖ "
,
ÖÖ" #
RpcRequestContext
ÜÜ 
?
ÜÜ 
requestContext
ÜÜ -
,
ÜÜ- ."
IConnectivityService
áá  !
connectivityService
áá! 4
,
áá4 5
CancellationToken
àà 
token
àà #
)
ââ 	
{
ää 	
return
ãã 
await
ãã "
ExecuteGrpcCallAsync
ãã -
(
ãã- .
RpcServiceType
åå 
.
åå #
RecoverySecretKeyInit
åå 4
,
åå4 5!
connectivityService
çç #
,
çç# $
requestContext
éé 
,
éé 
token
èè 
,
èè 
callOptions
êê 
=>
êê &
membershipServicesClient
ëë ,
.
ëë, -5
'OpaqueRecoverySecretKeyInitRequestAsync
ëë- T
(
ëëT U
payload
íí 
,
íí  
callOptions
ìì #
)
îî 
)
ïï 
.
ïï 
ConfigureAwait
ïï 
(
ïï 
false
ïï "
)
ïï" #
;
ïï# $
}
ññ 	
async
òò 
Task
òò 
<
òò 
Result
òò 
<
òò 
SecureEnvelope
òò (
,
òò( )
NetworkFailure
òò* 8
>
òò8 9
>
òò9 :0
"OpaqueRecoveryCompleteRequestAsync
òò; ]
(
òò] ^
SecureEnvelope
ôô 
payload
ôô "
,
ôô" #
RpcRequestContext
öö 
?
öö 
requestContext
öö -
,
öö- ."
IConnectivityService
õõ  !
connectivityService
õõ! 4
,
õõ4 5
CancellationToken
úú 
token
úú #
)
ùù 	
{
ûû 	
return
üü 
await
üü "
ExecuteGrpcCallAsync
üü -
(
üü- .
RpcServiceType
†† 
.
†† '
RecoverySecretKeyComplete
†† 8
,
††8 9!
connectivityService
°° #
,
°°# $
requestContext
¢¢ 
,
¢¢ 
token
££ 
,
££ 
callOptions
§§ 
=>
§§ &
membershipServicesClient
•• ,
.
••, -9
+OpaqueRecoverySecretKeyCompleteRequestAsync
••- X
(
••X Y
payload
¶¶ 
,
¶¶  
callOptions
ßß #
)
®® 
)
©© 
.
©© 
ConfigureAwait
©© 
(
©© 
false
©© "
)
©©" #
;
©©# $
}
™™ 	
}
´´ 
public
≠≠ 

async
≠≠ 
Task
≠≠ 
<
≠≠ 
Result
≠≠ 
<
≠≠ 
RpcFlow
≠≠ $
,
≠≠$ %
NetworkFailure
≠≠& 4
>
≠≠4 5
>
≠≠5 6 
InvokeRequestAsync
≠≠7 I
(
≠≠I J
ServiceRequest
ÆÆ 
request
ÆÆ 
,
ÆÆ "
IConnectivityService
ØØ !
connectivityService
ØØ 0
,
ØØ0 1
CancellationToken
∞∞ 
token
∞∞ 
)
±± 
{
≤≤ 
if
≥≥ 

(
≥≥ 
_serviceMethods
≥≥ 
.
≥≥ 
TryGetValue
≥≥ '
(
≥≥' (
request
≥≥( /
.
≥≥/ 0
RpcServiceMethod
≥≥0 @
,
≥≥@ A
out
≥≥B E 
GrpcMethodDelegate
≥≥F X
?
≥≥X Y
method
≥≥Z `
)
≥≥` a
)
≥≥a b
{
¥¥ 	
Result
µµ 
<
µµ 
SecureEnvelope
µµ !
,
µµ! "
NetworkFailure
µµ# 1
>
µµ1 2
result
µµ3 9
=
µµ: ;
await
µµ< A
method
µµB H
(
µµH I
request
∂∂ 
.
∂∂ 
Payload
∂∂ 
,
∂∂  
request
∑∑ 
.
∑∑ 
RequestContext
∑∑ &
,
∑∑& '!
connectivityService
∏∏ #
,
∏∏# $
token
ππ 
)
∫∫ 
.
∫∫ 
ConfigureAwait
∫∫ 
(
∫∫ 
false
∫∫ "
)
∫∫" #
;
∫∫# $
if
ºº 
(
ºº 
result
ºº 
.
ºº 
IsOk
ºº 
)
ºº 
{
ΩΩ 
return
ææ 
Result
ææ 
<
ææ 
RpcFlow
ææ %
,
ææ% &
NetworkFailure
ææ' 5
>
ææ5 6
.
ææ6 7
Ok
ææ7 9
(
ææ9 :
new
øø 
RpcFlow
øø 
.
øø  

SingleCall
øø  *
(
øø* +
Task
øø+ /
.
øø/ 0

FromResult
øø0 :
(
øø: ;
result
øø; A
)
øøA B
)
øøB C
)
¿¿ 
;
¿¿ 
}
¡¡ 
return
√√ 
Result
√√ 
<
√√ 
RpcFlow
√√ !
,
√√! "
NetworkFailure
√√# 1
>
√√1 2
.
√√2 3
Err
√√3 6
(
√√6 7
result
√√7 =
.
√√= >
	UnwrapErr
√√> G
(
√√G H
)
√√H I
)
√√I J
;
√√J K
}
ƒƒ 	
return
∆∆ 
Result
∆∆ 
<
∆∆ 
RpcFlow
∆∆ 
,
∆∆ 
NetworkFailure
∆∆ -
>
∆∆- .
.
∆∆. /
Err
∆∆/ 2
(
∆∆2 3
NetworkFailure
«« 
.
««  
InvalidRequestType
«« -
(
««- .
$str
««. D
)
««D E
)
»» 	
;
»»	 

}
…… 
private
ÀÀ 
async
ÀÀ 
Task
ÀÀ 
<
ÀÀ 
Result
ÀÀ 
<
ÀÀ 
SecureEnvelope
ÀÀ ,
,
ÀÀ, -
NetworkFailure
ÀÀ. <
>
ÀÀ< =
>
ÀÀ= >"
ExecuteGrpcCallAsync
ÀÀ? S
(
ÀÀS T
RpcServiceType
ÃÃ 
serviceType
ÃÃ "
,
ÃÃ" #"
IConnectivityService
ÕÕ !
connectivityService
ÕÕ 0
,
ÕÕ0 1
RpcRequestContext
ŒŒ 
?
ŒŒ 
requestContext
ŒŒ )
,
ŒŒ) *
CancellationToken
œœ 
token
œœ 
,
œœ  
Func
–– 
<
–– 
CallOptions
–– 
,
–– 
AsyncUnaryCall
–– (
<
––( )
SecureEnvelope
––) 7
>
––7 8
>
––8 9
grpcCallFactory
––: I
)
—— 
{
““ 
try
”” 
{
‘‘ 	
CallOptions
’’ 
callOptions
’’ #
=
’’$ %!
_callOptionsFactory
’’& 9
.
’’9 :
Create
’’: @
(
’’@ A
serviceType
’’A L
,
’’L M
requestContext
’’N \
,
’’\ ]
token
’’^ c
)
’’c d
;
’’d e
AsyncUnaryCall
÷÷ 
<
÷÷ 
SecureEnvelope
÷÷ )
>
÷÷) *
call
÷÷+ /
=
÷÷0 1
grpcCallFactory
÷÷2 A
(
÷÷A B
callOptions
÷÷B M
)
÷÷M N
;
÷÷N O
SecureEnvelope
◊◊ 
response
◊◊ #
=
◊◊$ %
await
◊◊& +
call
◊◊, 0
.
◊◊0 1
ResponseAsync
◊◊1 >
.
◊◊> ?
ConfigureAwait
◊◊? M
(
◊◊M N
false
◊◊N S
)
◊◊S T
;
◊◊T U
await
ŸŸ !
connectivityService
ŸŸ %
.
ŸŸ% &
PublishAsync
ŸŸ& 2
(
ŸŸ2 3 
ConnectivityIntent
⁄⁄ &
.
⁄⁄& '
	Connected
⁄⁄' 0
(
⁄⁄0 1
)
⁄⁄1 2
)
⁄⁄2 3
.
€€ 
ConfigureAwait
€€ 
(
€€  
false
€€  %
)
€€% &
;
€€& '
return
›› 
Result
›› 
<
›› 
SecureEnvelope
›› (
,
››( )
NetworkFailure
››* 8
>
››8 9
.
››9 :
Ok
››: <
(
››< =
response
››= E
)
››E F
;
››F G
}
ﬁﬁ 	
catch
ﬂﬂ 
(
ﬂﬂ 
RpcException
ﬂﬂ 
rpcEx
ﬂﬂ !
)
ﬂﬂ! "
{
‡‡ 	
NetworkFailure
·· 
failure
·· "
=
··# $
await
··% *
_errorProcessor
··+ :
.
··: ;
ProcessAsync
··; G
(
··G H
rpcEx
··H M
)
··M N
.
··N O
ConfigureAwait
··O ]
(
··] ^
false
··^ c
)
··c d
;
··d e
if
„„ 
(
„„ 
failure
„„ 
.
„„ 
FailureType
„„ #
!=
„„$ & 
NetworkFailureType
„„' 9
.
„„9 :#
ProtocolStateMismatch
„„: O
)
„„O P
{
‰‰ 
await
ÂÂ !
connectivityService
ÂÂ )
.
ÂÂ) *
PublishAsync
ÂÂ* 6
(
ÂÂ6 7 
ConnectivityIntent
ÊÊ *
.
ÊÊ* +
Disconnected
ÊÊ+ 7
(
ÊÊ7 8
failure
ÊÊ8 ?
)
ÊÊ? @
)
ÊÊ@ A
.
ÁÁ 
ConfigureAwait
ÁÁ #
(
ÁÁ# $
false
ÁÁ$ )
)
ÁÁ) *
;
ÁÁ* +
}
ËË 
return
ÍÍ 
Result
ÍÍ 
<
ÍÍ 
SecureEnvelope
ÍÍ (
,
ÍÍ( )
NetworkFailure
ÍÍ* 8
>
ÍÍ8 9
.
ÍÍ9 :
Err
ÍÍ: =
(
ÍÍ= >
failure
ÍÍ> E
)
ÍÍE F
;
ÍÍF G
}
ÎÎ 	
catch
ÏÏ 
(
ÏÏ 
	Exception
ÏÏ 
ex
ÏÏ 
)
ÏÏ 
{
ÌÌ 	
return
ÓÓ 
Result
ÓÓ 
<
ÓÓ 
SecureEnvelope
ÓÓ (
,
ÓÓ( )
NetworkFailure
ÓÓ* 8
>
ÓÓ8 9
.
ÓÓ9 :
Err
ÓÓ: =
(
ÓÓ= >
NetworkFailure
ÔÔ 
.
ÔÔ %
DataCenterNotResponding
ÔÔ 6
(
ÔÔ6 7
ex
ÔÔ7 9
.
ÔÔ9 :
Message
ÔÔ: A
)
ÔÔA B
)
ÔÔB C
;
ÔÔC D
}
 	
}
ÒÒ 
}ÚÚ Ÿ
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/ServiceRequest.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
class 
ServiceRequest 
{ 
private 
ServiceRequest 
( 
uint		 
reqId		 
,		 
ServiceFlowType

 

actionType

 "
,

" #
RpcServiceType 
rpcServiceMethod '
,' (
SecureEnvelope 
payload 
, 
List 
< 
SecureEnvelope 
> 
encryptedChunks ,
,, -
RpcRequestContext 
? 
requestContext )
)) *
{ 
ReqId 
= 
reqId 
; 

ActionType 
= 

actionType 
;  
RpcServiceMethod 
= 
rpcServiceMethod +
;+ ,
Payload 
= 
payload 
; 
EncryptedChunks 
= 
encryptedChunks )
;) *
RequestContext 
= 
requestContext '
;' (
} 
public 

uint 
ReqId 
{ 
get 
; 
} 
public 

ServiceFlowType 

ActionType %
{& '
get( +
;+ ,
}- .
public 

RpcServiceType 
RpcServiceMethod *
{+ ,
get- 0
;0 1
}2 3
public 

SecureEnvelope 
Payload !
{" #
get$ '
;' (
}) *
public   

List   
<   
SecureEnvelope   
>   
EncryptedChunks    /
{  0 1
get  2 5
;  5 6
}  7 8
public"" 

RpcRequestContext"" 
?"" 
RequestContext"" ,
{""- .
get""/ 2
;""2 3
}""4 5
public$$ 

static$$ 
ServiceRequest$$  
New$$! $
($$$ %
uint$$% )
reqId$$* /
,$$/ 0
ServiceFlowType$$1 @

actionType$$A K
,$$K L
RpcServiceType$$M [
rpcServiceMethod$$\ l
,$$l m
SecureEnvelope%% 
payload%% 
,%% 
List%%  $
<%%$ %
SecureEnvelope%%% 3
>%%3 4
encryptedChunks%%5 D
,%%D E
RpcRequestContext%%F W
?%%W X
requestContext%%Y g
=%%h i
null%%j n
)%%n o
{&& 
return'' 
new'' 
ServiceRequest'' !
(''! "
reqId''" '
,''' (

actionType'') 3
,''3 4
rpcServiceMethod''5 E
,''E F
payload''G N
,''N O
encryptedChunks''P _
,''_ `
requestContext''a o
)''o p
;''p q
}(( 
})) ¥
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/ServiceFlowType.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
enum 
ServiceFlowType 
{ 
Single 

,
 
ReceiveStream 
, 

SendStream 
, 
BidirectionalStream 
}		 ±ö
à/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/SecrecyChannelRpcServices.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
sealed 
class %
SecrecyChannelRpcServices -
:. /&
ISecrecyChannelRpcServices0 J
{ 
private 
readonly 
DeviceService "
." #
DeviceServiceClient# 6 
_deviceServiceClient7 K
;K L
private 
readonly 
IGrpcErrorProcessor (
_errorProcessor) 8
;8 9
private 
readonly #
IGrpcCallOptionsFactory ,
_callOptionsFactory- @
;@ A
public 
%
SecrecyChannelRpcServices $
($ %
DeviceService 
. 
DeviceServiceClient )
deviceServiceClient* =
,= >
IGrpcErrorProcessor 
errorProcessor *
,* +#
IGrpcCallOptionsFactory 
callOptionsFactory  2
)2 3
{  
_deviceServiceClient 
= 
deviceServiceClient 2
;2 3
_errorProcessor 
= 
errorProcessor (
;( )
_callOptionsFactory 
= 
callOptionsFactory 0
;0 1
} 
public!! 

async!! 
Task!! 
<!! 
Result!! 
<!! 
SecureEnvelope!! +
,!!+ ,
NetworkFailure!!- ;
>!!; <
>!!< =1
%EstablishAppDeviceSecrecyChannelAsync!!> c
(!!c d 
IConnectivityService"" 
connectivityService"" 0
,""0 1
SecureEnvelope## 
request## 
,## 
PubKeyExchangeType$$ 
?$$ 
EXCHANGE_TYPE$$ )
=$$* +
null$$, 0
,$$0 1
CancellationToken%% 
cancellationToken%% +
=%%, -
default%%. 5
)%%5 6
{&& !
ArgumentNullException'' 
.'' 
ThrowIfNull'' )
('') *
request''* 1
)''1 2
;''2 3
Metadata)) 
headers)) 
=)) 
new)) 
()) 
)))  
;))  !
if** 

(** 
EXCHANGE_TYPE** 
.** 
HasValue** "
)**" #
{++ 	
headers,, 
.,, 
Add,, 
(,, 
$str,, '
,,,' (
EXCHANGE_TYPE,,) 6
.,,6 7
Value,,7 <
.,,< =
ToString,,= E
(,,E F
),,F G
),,G H
;,,H I
}-- 	
return// 
await// &
ExecuteSecureEnvelopeAsync// /
(/// 0
RpcServiceType00 
.00 #
EstablishSecrecyChannel00 6
,006 7
connectivityService11 #
,11# $
request22 
,22 
headers33 
,33 
cancellationToken44 !
)44! "
.55 
ConfigureAwait55 
(55 
false55 !
)55! "
;55" #
}66 
public88 

async88 
Task88 
<88 
Result88 
<88 "
RestoreChannelResponse88 3
,883 4
NetworkFailure885 C
>88C D
>88D E/
#RestoreAppDeviceSecrecyChannelAsync88F i
(88i j 
IConnectivityService99 
connectivityService99 0
,990 1!
RestoreChannelRequest:: 
request:: %
,::% &
CancellationToken;; 
cancellationToken;; +
=;;, -
default;;. 5
);;5 6
{<< !
ArgumentNullException== 
.== 
ThrowIfNull== )
(==) *
request==* 1
)==1 2
;==2 3
return?? 
await?? 
ExecuteAsync?? !
(??! "
RpcServiceType@@ 
.@@ !
RestoreSecrecyChannel@@ 4
,@@4 5
connectivityServiceAA #
,AA# $
optionsBB 
=>BB  
_deviceServiceClientBB /
.BB/ 0%
RestoreSecureChannelAsyncBB0 I
(BBI J
requestBBJ Q
,BBQ R
optionsBBS Z
)BBZ [
,BB[ \
cancellationTokenCC !
)CC! "
.DD 
ConfigureAwaitDD 
(DD 
falseDD !
)DD! "
;DD" #
}EE 
publicGG 

asyncGG 
TaskGG 
<GG 
ResultGG 
<GG 
SecureEnvelopeGG +
,GG+ ,
NetworkFailureGG- ;
>GG; <
>GG< =4
(AuthenticatedEstablishSecureChannelAsyncGG> f
(GGf g 
IConnectivityServiceHH 
connectivityServiceHH 0
,HH0 1)
AuthenticatedEstablishRequestII %
requestII& -
,II- .
CancellationTokenJJ 
cancellationTokenJJ +
=JJ, -
defaultJJ. 5
)JJ5 6
{KK !
ArgumentNullExceptionLL 
.LL 
ThrowIfNullLL )
(LL) *
requestLL* 1
)LL1 2
;LL2 3
tryNN 
{OO 	
CallOptionsPP 
callOptionsPP #
=PP$ %
_callOptionsFactoryPP& 9
.PP9 :
CreatePP: @
(PP@ A
RpcServiceTypeQQ 
.QQ /
#EstablishAuthenticatedSecureChannelQQ B
,QQB C
requestContextRR 
:RR 
nullRR  $
,RR$ %
cancellationTokenSS !
)SS! "
;SS" #
AsyncUnaryCallTT 
<TT 
SecureEnvelopeTT )
>TT) *
callTT+ /
=TT0 1 
_deviceServiceClientTT2 F
.TTF G4
(AuthenticatedEstablishSecureChannelAsyncTTG o
(TTo p
requestUU 
,UU 
callOptionsVV 
)VV 
;VV 
SecureEnvelopeXX 
responseXX #
=XX$ %
awaitXX& +
callXX, 0
.XX0 1
ResponseAsyncXX1 >
.XX> ?
ConfigureAwaitXX? M
(XXM N
falseXXN S
)XXS T
;XXT U
awaitZZ 
connectivityServiceZZ %
.ZZ% &
PublishAsyncZZ& 2
(ZZ2 3
ConnectivityIntentZZ3 E
.ZZE F
	ConnectedZZF O
(ZZO P
)ZZP Q
)ZZQ R
.ZZR S
ConfigureAwaitZZS a
(ZZa b
falseZZb g
)ZZg h
;ZZh i
return[[ 
Result[[ 
<[[ 
SecureEnvelope[[ (
,[[( )
NetworkFailure[[* 8
>[[8 9
.[[9 :
Ok[[: <
([[< =
response[[= E
)[[E F
;[[F G
}\\ 	
catch]] 
(]] 
RpcException]] 
rpcEx]] !
)]]! "
{^^ 	
if__ 
(__ 
GrpcErrorClassifier__ #
.__# $
IsCancelled__$ /
(__/ 0
rpcEx__0 5
)__5 6
)__6 7
{`` 
throwaa 
;aa 
}bb 
NetworkFailuredd 
failuredd "
=dd# $
awaitdd% *
_errorProcessordd+ :
.dd: ;
ProcessAsyncdd; G
(ddG H
rpcExddH M
)ddM N
.ddN O
ConfigureAwaitddO ]
(dd] ^
falsedd^ c
)ddc d
;ddd e
ifff 
(ff 
GrpcErrorClassifierff #
.ff# $*
IsIdentityKeyDerivationFailureff$ B
(ffB C
rpcExffC H
)ffH I
)ffI J
{gg 
UserFacingErrorhh 
	userErrorhh  )
=hh* +
failurehh, 3
.hh3 4
	UserErrorhh4 =
??hh> @
newii, /
UserFacingErrorii0 ?
(ii? @
	ErrorCodejj0 9
.jj9 :
UNAUTHENTICATEDjj: I
,jjI J
ErrorI18nKeyskk0 =
.kk= >
UNAUTHENTICATEDkk> M
,kkM N
failurell0 7
.ll7 8
Messagell8 ?
)ll? @
;ll@ A
failurenn 
=nn 
newnn 
NetworkFailurenn ,
(nn, -
NetworkFailureTypeoo &
.oo& ')
CriticalAuthenticationFailureoo' D
,ooD E
	userErrorpp 
.pp 
Messagepp %
,pp% &
rpcExqq 
)qq 
{rr 
	UserErrorss 
=ss 
	userErrorss  )
}tt 
;tt 
}uu 
awaitww 
connectivityServiceww %
.ww% &
PublishAsyncww& 2
(ww2 3
ConnectivityIntentxx &
.xx& '
Disconnectedxx' 3
(xx3 4
failurexx4 ;
)xx; <
)xx< =
.yy 
ConfigureAwaityy 
(yy  
falseyy  %
)yy% &
;yy& '
returnzz 
Resultzz 
<zz 
SecureEnvelopezz (
,zz( )
NetworkFailurezz* 8
>zz8 9
.zz9 :
Errzz: =
(zz= >
failurezz> E
)zzE F
;zzF G
}{{ 	
catch|| 
(|| &
OperationCanceledException|| )
)||) *
when||+ /
(||0 1
cancellationToken||1 B
.||B C#
IsCancellationRequested||C Z
)||Z [
{}} 	
throw~~ 
;~~ 
} 	
catch
ÄÄ 
(
ÄÄ 
	Exception
ÄÄ 
ex
ÄÄ 
)
ÄÄ 
{
ÅÅ 	
return
ÇÇ 
Result
ÇÇ 
<
ÇÇ 
SecureEnvelope
ÇÇ (
,
ÇÇ( )
NetworkFailure
ÇÇ* 8
>
ÇÇ8 9
.
ÇÇ9 :
Err
ÇÇ: =
(
ÇÇ= >
NetworkFailure
ÉÉ 
.
ÉÉ %
DataCenterNotResponding
ÉÉ 6
(
ÉÉ6 7
ex
ÉÉ7 9
.
ÉÉ9 :
Message
ÉÉ: A
,
ÉÉA B
ex
ÉÉC E
)
ÉÉE F
)
ÉÉF G
;
ÉÉG H
}
ÑÑ 	
}
ÖÖ 
private
áá 
async
áá 
Task
áá 
<
áá 
Result
áá 
<
áá 
SecureEnvelope
áá ,
,
áá, -
NetworkFailure
áá. <
>
áá< =
>
áá= >(
ExecuteSecureEnvelopeAsync
áá? Y
(
ááY Z
RpcServiceType
àà 
serviceType
àà "
,
àà" #"
IConnectivityService
ââ !
connectivityService
ââ 0
,
ââ0 1
SecureEnvelope
ää 
request
ää 
,
ää 
Metadata
ãã 
headers
ãã 
,
ãã 
CancellationToken
åå 
cancellationToken
åå +
)
åå+ ,
{
çç 
try
éé 
{
èè 	
CallOptions
êê 
callOptions
êê #
=
êê$ %!
_callOptionsFactory
êê& 9
.
êê9 :
Create
êê: @
(
êê@ A
serviceType
êêA L
,
êêL M
null
êêN R
,
êêR S
cancellationToken
êêT e
,
êêe f
headers
êêg n
)
êên o
;
êêo p
AsyncUnaryCall
ëë 
<
ëë 
SecureEnvelope
ëë )
>
ëë) *
call
ëë+ /
=
ëë0 1"
_deviceServiceClient
ëë2 F
.
ëëF G)
EstablishSecureChannelAsync
ëëG b
(
ëëb c
request
íí 
,
íí 
callOptions
ìì 
)
ìì 
;
ìì 
SecureEnvelope
ïï 
response
ïï #
=
ïï$ %
await
ïï& +
call
ïï, 0
.
ïï0 1
ResponseAsync
ïï1 >
.
ïï> ?
ConfigureAwait
ïï? M
(
ïïM N
false
ïïN S
)
ïïS T
;
ïïT U
await
óó !
connectivityService
óó %
.
óó% &
PublishAsync
óó& 2
(
óó2 3 
ConnectivityIntent
òò &
.
òò& '
	Connected
òò' 0
(
òò0 1
null
òò1 5
,
òò5 6 
ConnectivityReason
òò7 I
.
òòI J 
HandshakeSucceeded
òòJ \
)
òò\ ]
)
òò] ^
.
ôô 
ConfigureAwait
ôô 
(
ôô  
false
ôô  %
)
ôô% &
;
ôô& '
return
õõ 
Result
õõ 
<
õõ 
SecureEnvelope
õõ (
,
õõ( )
NetworkFailure
õõ* 8
>
õõ8 9
.
õõ9 :
Ok
õõ: <
(
õõ< =
response
õõ= E
)
õõE F
;
õõF G
}
úú 	
catch
ùù 
(
ùù 
RpcException
ùù 
rpcEx
ùù !
)
ùù! "
{
ûû 	
if
üü 
(
üü !
GrpcErrorClassifier
üü #
.
üü# $
IsCancelled
üü$ /
(
üü/ 0
rpcEx
üü0 5
)
üü5 6
)
üü6 7
{
†† 
throw
°° 
;
°° 
}
¢¢ 
NetworkFailure
§§ 
failure
§§ "
=
§§# $
await
§§% *
_errorProcessor
§§+ :
.
§§: ;
ProcessAsync
§§; G
(
§§G H
rpcEx
§§H M
)
§§M N
.
§§N O
ConfigureAwait
§§O ]
(
§§] ^
false
§§^ c
)
§§c d
;
§§d e
await
•• !
connectivityService
•• %
.
••% &
PublishAsync
••& 2
(
••2 3 
ConnectivityIntent
¶¶ &
.
¶¶& '
Disconnected
¶¶' 3
(
¶¶3 4
failure
¶¶4 ;
)
¶¶; <
)
¶¶< =
.
ßß 
ConfigureAwait
ßß 
(
ßß  
false
ßß  %
)
ßß% &
;
ßß& '
return
®® 
Result
®® 
<
®® 
SecureEnvelope
®® (
,
®®( )
NetworkFailure
®®* 8
>
®®8 9
.
®®9 :
Err
®®: =
(
®®= >
failure
®®> E
)
®®E F
;
®®F G
}
©© 	
catch
™™ 
(
™™ (
OperationCanceledException
™™ )
)
™™) *
when
™™+ /
(
™™0 1
cancellationToken
™™1 B
.
™™B C%
IsCancellationRequested
™™C Z
)
™™Z [
{
´´ 	
throw
¨¨ 
;
¨¨ 
}
≠≠ 	
catch
ÆÆ 
(
ÆÆ 
	Exception
ÆÆ 
ex
ÆÆ 
)
ÆÆ 
{
ØØ 	
return
∞∞ 
Result
∞∞ 
<
∞∞ 
SecureEnvelope
∞∞ (
,
∞∞( )
NetworkFailure
∞∞* 8
>
∞∞8 9
.
∞∞9 :
Err
∞∞: =
(
∞∞= >
NetworkFailure
±± 
.
±± %
DataCenterNotResponding
±± 6
(
±±6 7
ex
±±7 9
.
±±9 :
Message
±±: A
,
±±A B
ex
±±C E
)
±±E F
)
±±F G
;
±±G H
}
≤≤ 	
}
≥≥ 
private
µµ 
async
µµ 
Task
µµ 
<
µµ 
Result
µµ 
<
µµ 
	TResponse
µµ '
,
µµ' (
NetworkFailure
µµ) 7
>
µµ7 8
>
µµ8 9
ExecuteAsync
µµ: F
<
µµF G
	TResponse
µµG P
>
µµP Q
(
µµQ R
RpcServiceType
∂∂ 
serviceType
∂∂ "
,
∂∂" #"
IConnectivityService
∑∑ !
connectivityService
∑∑ 0
,
∑∑0 1
Func
∏∏ 
<
∏∏ 
CallOptions
∏∏ 
,
∏∏ 
AsyncUnaryCall
∏∏ (
<
∏∏( )
	TResponse
∏∏) 2
>
∏∏2 3
>
∏∏3 4
grpcCallFactory
∏∏5 D
,
∏∏D E
CancellationToken
ππ 
cancellationToken
ππ +
)
ππ+ ,
{
∫∫ 
try
ªª 
{
ºº 	
CallOptions
ΩΩ 
callOptions
ΩΩ #
=
ΩΩ$ %!
_callOptionsFactory
ΩΩ& 9
.
ΩΩ9 :
Create
ΩΩ: @
(
ΩΩ@ A
serviceType
ΩΩA L
,
ΩΩL M
null
ΩΩN R
,
ΩΩR S
cancellationToken
ΩΩT e
)
ΩΩe f
;
ΩΩf g
AsyncUnaryCall
ææ 
<
ææ 
	TResponse
ææ $
>
ææ$ %
call
ææ& *
=
ææ+ ,
grpcCallFactory
ææ- <
(
ææ< =
callOptions
ææ= H
)
ææH I
;
ææI J
	TResponse
øø 
response
øø 
=
øø  
await
øø! &
call
øø' +
.
øø+ ,
ResponseAsync
øø, 9
.
øø9 :
ConfigureAwait
øø: H
(
øøH I
false
øøI N
)
øøN O
;
øøO P
await
¡¡ !
connectivityService
¡¡ %
.
¡¡% &
PublishAsync
¡¡& 2
(
¡¡2 3 
ConnectivityIntent
¬¬ &
.
¬¬& '
	Connected
¬¬' 0
(
¬¬0 1
null
¬¬1 5
,
¬¬5 6 
ConnectivityReason
¬¬7 I
.
¬¬I J 
HandshakeSucceeded
¬¬J \
)
¬¬\ ]
)
¬¬] ^
.
√√ 
ConfigureAwait
√√ 
(
√√  
false
√√  %
)
√√% &
;
√√& '
return
≈≈ 
Result
≈≈ 
<
≈≈ 
	TResponse
≈≈ #
,
≈≈# $
NetworkFailure
≈≈% 3
>
≈≈3 4
.
≈≈4 5
Ok
≈≈5 7
(
≈≈7 8
response
≈≈8 @
)
≈≈@ A
;
≈≈A B
}
∆∆ 	
catch
«« 
(
«« 
RpcException
«« 
rpcEx
«« !
)
««! "
{
»» 	
if
…… 
(
…… !
GrpcErrorClassifier
…… #
.
……# $
IsCancelled
……$ /
(
……/ 0
rpcEx
……0 5
)
……5 6
)
……6 7
{
   
throw
ÀÀ 
;
ÀÀ 
}
ÃÃ 
NetworkFailure
ŒŒ 
failure
ŒŒ "
=
ŒŒ# $
await
ŒŒ% *
_errorProcessor
ŒŒ+ :
.
ŒŒ: ;
ProcessAsync
ŒŒ; G
(
ŒŒG H
rpcEx
ŒŒH M
)
ŒŒM N
.
ŒŒN O
ConfigureAwait
ŒŒO ]
(
ŒŒ] ^
false
ŒŒ^ c
)
ŒŒc d
;
ŒŒd e
await
œœ !
connectivityService
œœ %
.
œœ% &
PublishAsync
œœ& 2
(
œœ2 3 
ConnectivityIntent
–– &
.
––& '
Disconnected
––' 3
(
––3 4
failure
––4 ;
)
––; <
)
––< =
.
—— 
ConfigureAwait
—— 
(
——  
false
——  %
)
——% &
;
——& '
return
““ 
Result
““ 
<
““ 
	TResponse
““ #
,
““# $
NetworkFailure
““% 3
>
““3 4
.
““4 5
Err
““5 8
(
““8 9
failure
““9 @
)
““@ A
;
““A B
}
”” 	
catch
‘‘ 
(
‘‘ (
OperationCanceledException
‘‘ )
)
‘‘) *
when
‘‘+ /
(
‘‘0 1
cancellationToken
‘‘1 B
.
‘‘B C%
IsCancellationRequested
‘‘C Z
)
‘‘Z [
{
’’ 	
throw
÷÷ 
;
÷÷ 
}
◊◊ 	
catch
ÿÿ 
(
ÿÿ 
	Exception
ÿÿ 
ex
ÿÿ 
)
ÿÿ 
{
ŸŸ 	
return
⁄⁄ 
Result
⁄⁄ 
<
⁄⁄ 
	TResponse
⁄⁄ #
,
⁄⁄# $
NetworkFailure
⁄⁄% 3
>
⁄⁄3 4
.
⁄⁄4 5
Err
⁄⁄5 8
(
⁄⁄8 9
NetworkFailure
€€ 
.
€€ %
DataCenterNotResponding
€€ 6
(
€€6 7
ex
€€7 9
.
€€9 :
Message
€€: A
,
€€A B
ex
€€C E
)
€€E F
)
€€F G
;
€€G H
}
‹‹ 	
}
›› 
}ﬁﬁ  	
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/RpcServiceType.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
enum 
RpcServiceType 
: 
short "
{ #
EstablishSecrecyChannel 
, !
RestoreSecrecyChannel 
, /
#EstablishAuthenticatedSecureChannel '
,' (
RegisterAppDevice		 
,		  
ValidateMobileNumber 
, )
CheckMobileNumberAvailability !
,! " 
InitiateVerification 
, 
	VerifyOtp 
, 
RegistrationInit 
,  
RegistrationComplete 
, !
RecoverySecretKeyInit 
, %
RecoverySecretKeyComplete 
, 
SignInInitRequest 
, !
SignInCompleteRequest 
, 
Logout 

,
 
AnonymousLogout 
, 
} ¡;
Ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/RpcServiceManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
internal 
class	 
RpcServiceManager  
:! "
IRpcServiceManager# 5
{ 
private 
readonly &
ISecrecyChannelRpcServices /&
_secrecyChannelRpcServices0 J
;J K
private 
readonly 

Dictionary 
< 
ServiceFlowType "
," #
Func 
< 
ServiceRequest 
,  
CancellationToken! 2
,2 3
Task4 8
<8 9
Result9 ?
<? @
RpcFlow@ G
,G H
NetworkFailureI W
>W X
>X Y
>Y Z
>Z [
_serviceInvokers\ l
;l m
public 

RpcServiceManager 
( 
IUnaryRpcServices 
unaryRpcServices *
,* +%
IReceiveStreamRpcServices !$
receiveStreamRpcServices" :
,: ;&
ISecrecyChannelRpcServices "%
secrecyChannelRpcServices# <
,< = 
IConnectivityService 
connectivityService 0
)0 1
{ &
_secrecyChannelRpcServices "
=# $%
secrecyChannelRpcServices% >
;> ?
_serviceInvokers 
= 
new   

Dictionary   
<   
ServiceFlowType   *
,  * +
Func!! 
<!! 
ServiceRequest!! #
,!!# $
CancellationToken!!% 6
,!!6 7
Task!!8 <
<!!< =
Result!!= C
<!!C D
RpcFlow!!D K
,!!K L
NetworkFailure!!M [
>!![ \
>!!\ ]
>!!] ^
>!!^ _
{"" 
{## 
ServiceFlowType$$ #
.$$# $
Single$$$ *
,$$* +
(%% 
req%% 
,%% 
token%% 
)%%  
=>%%! #
unaryRpcServices%%$ 4
.%%4 5
InvokeRequestAsync%%5 G
(%%G H
req%%H K
,%%K L
connectivityService%%M `
,%%` a
token%%b g
)%%g h
}&& 
,&& 
{'' 
ServiceFlowType(( #
.((# $
ReceiveStream(($ 1
,((1 2$
receiveStreamRpcServices((3 K
.((K L
ProcessRequest((L Z
})) 
}** 
;** 
}++ 
public-- 

async-- 
Task-- 
<-- 
Result-- 
<-- 
SecureEnvelope-- +
,--+ ,
NetworkFailure--- ;
>--; <
>--< =(
EstablishSecrecyChannelAsync--> Z
(--Z [ 
IConnectivityService.. 
connectivityService.. 0
,..0 1
SecureEnvelope// 
envelope// 
,//  
PubKeyExchangeType00 
?00 
EXCHANGE_TYPE00 )
=00* +
null00, 0
,000 1
CancellationToken11 
cancellationToken11 +
=11, -
default11. 5
)115 6
{22 
return33 
await33 &
_secrecyChannelRpcServices33 /
.33/ 01
%EstablishAppDeviceSecrecyChannelAsync330 U
(33U V
connectivityService33V i
,33i j
envelope44 
,44 
EXCHANGE_TYPE55 
,55 
cancellationToken66 
)66 
.66 
ConfigureAwait66 -
(66- .
false66. 3
)663 4
;664 5
}77 
public99 

async99 
Task99 
<99 
Result99 
<99 "
RestoreChannelResponse99 3
,993 4
NetworkFailure995 C
>99C D
>99D E&
RestoreSecrecyChannelAsync99F `
(99` a 
IConnectivityService:: 
connectivityService:: 0
,::0 1!
RestoreChannelRequest;; 
request;; %
,;;% &
CancellationToken<< 
cancellationToken<< +
=<<, -
default<<. 5
)<<5 6
{== 
return>> 
await>> &
_secrecyChannelRpcServices>> /
.>>/ 0/
#RestoreAppDeviceSecrecyChannelAsync>>0 S
(>>S T
connectivityService>>T g
,>>g h
request?? 
,?? 
cancellationToken@@ 
)@@ 
.@@ 
ConfigureAwait@@ -
(@@- .
false@@. 3
)@@3 4
;@@4 5
}AA 
publicCC 

asyncCC 
TaskCC 
<CC 
ResultCC 
<CC 
SecureEnvelopeCC +
,CC+ ,
NetworkFailureCC- ;
>CC; <
>CC< =4
(EstablishAuthenticatedSecureChannelAsyncCC> f
(CCf g 
IConnectivityServiceDD 
connectivityServiceDD 0
,DD0 1)
AuthenticatedEstablishRequestEE %
requestEE& -
,EE- .
CancellationTokenFF 
cancellationTokenFF +
=FF, -
defaultFF. 5
)FF5 6
{GG 
returnHH 
awaitHH &
_secrecyChannelRpcServicesHH /
.HH/ 04
(AuthenticatedEstablishSecureChannelAsyncHH0 X
(HHX Y
connectivityServiceHHY l
,HHl m
requestII 
,II 
cancellationTokenJJ 
)JJ 
.JJ 
ConfigureAwaitJJ -
(JJ- .
falseJJ. 3
)JJ3 4
;JJ4 5
}KK 
publicMM 

asyncMM 
TaskMM 
<MM 
ResultMM 
<MM 
RpcFlowMM $
,MM$ %
NetworkFailureMM& 4
>MM4 5
>MM5 6%
InvokeServiceRequestAsyncMM7 P
(MMP Q
ServiceRequestMMQ _
requestMM` g
,MMg h
CancellationTokenNN 
tokenNN 
)NN  
{OO 
ifPP 

(PP 
_serviceInvokersPP 
.PP 
TryGetValuePP (
(PP( )
requestPP) 0
.PP0 1

ActionTypePP1 ;
,PP; <
outQQ 
FuncQQ 
<QQ 
ServiceRequestQQ '
,QQ' (
CancellationTokenQQ) :
,QQ: ;
TaskQQ< @
<QQ@ A
ResultQQA G
<QQG H
RpcFlowQQH O
,QQO P
NetworkFailureQQQ _
>QQ_ `
>QQ` a
>QQa b
?QQb c
invokerQQd k
)QQk l
)QQl m
{RR 	
ResultSS 
<SS 
RpcFlowSS 
,SS 
NetworkFailureSS *
>SS* +
resultSS, 2
=SS3 4
awaitSS5 :
invokerSS; B
(SSB C
requestSSC J
,SSJ K
tokenSSL Q
)SSQ R
.SSR S
ConfigureAwaitSSS a
(SSa b
falseSSb g
)SSg h
;SSh i
returnUU 
resultUU 
;UU 
}VV 	
returnXX 
ResultXX 
<XX 
RpcFlowXX 
,XX 
NetworkFailureXX -
>XX- .
.XX. /
ErrXX/ 2
(XX2 3
NetworkFailureXX3 A
.XXA B
InvalidRequestTypeXXB T
(XXT U
$strXXU j
)XXj k
)XXk l
;XXl m
}YY 
}ZZ º
Ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/RpcRequestContext.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
sealed 
class 
RpcRequestContext %
(% &
string& ,
correlationId- :
,: ;
string< B
idempotencyKeyC Q
,Q R
intS V
attemptW ^
=_ `
$numa b
)b c
{ 
public 

string 
CORRELATION_ID  
{! "
get# &
;& '
}( )
=* +
correlationId, 9
;9 :
public		 

string		 
IdempotencyKey		  
{		! "
get		# &
;		& '
}		( )
=		* +
idempotencyKey		, :
;		: ;
public 

int 
Attempt 
{ 
get 
; 
} 
=  !
attempt" )
;) *
public 

bool 
ReinitAttempted 
{  !
get" %
;% &
private' .
set/ 2
;2 3
}4 5
public 

static 
RpcRequestContext #
	CreateNew$ -
(- .
int. 1
attempt2 9
=: ;
$num< =
)= >
{ 
return 
new 
RpcRequestContext $
($ %
Guid 
. 
NewGuid 
( 
) 
. 
ToString #
(# $
$str$ '
)' (
,( )
Guid 
. 
NewGuid 
( 
) 
. 
ToString #
(# $
$str$ '
)' (
,( )
attempt 
) 
; 
} 
public 

static 
RpcRequestContext #"
CreateNewWithStableKey$ :
(: ;
string; A 
stableIdempotencyKeyB V
,V W
intX [
attempt\ c
=d e
$numf g
)g h
{ 
return 
new 
RpcRequestContext $
($ %
Guid 
. 
NewGuid 
( 
) 
. 
ToString #
(# $
$str$ '
)' (
,( ) 
stableIdempotencyKey  
,  !
attempt 
) 
; 
} 
public 

void 
MarkReinitAttempted #
(# $
)$ %
{   
ReinitAttempted!! 
=!! 
true!! 
;!! 
}"" 
}## ôF
v/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/RpcFlow.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
abstract 
class 
RpcFlow 
{ 
public 

static 
RpcFlow !
NewEmptyInboundStream /
(/ 0
)0 1
{ 
async 
IAsyncEnumerable 
< 
Result %
<% &
SecureEnvelope& 4
,4 5
NetworkFailure6 D
>D E
>E F
EmptyStreamG R
(R S
)S T
{ 	
yield 
break 
; 
} 	
return 
new 
InboundStream  
(  !
EmptyStream! ,
(, -
)- .
). /
;/ 0
} 
public 

static 
RpcFlow  
NewDrainOutboundSink .
(. /
)/ 0
=>1 3
new 
OutboundSink 
( 
new 
	DrainSink &
(& '
)' (
)( )
;) *
public 

static 
RpcFlow "
NewBidirectionalStream 0
(0 1
)1 2
{ 
Channel   
<   
SecureEnvelope   
>   
channel    '
=  ( )
Channel  * 1
.  1 2
CreateUnbounded  2 A
<  A B
SecureEnvelope  B P
>  P Q
(  Q R
)  R S
;  S T
IAsyncEnumerable!! 
<!! 
Result!! 
<!!  
SecureEnvelope!!  .
,!!. /
NetworkFailure!!0 >
>!!> ?
>!!? @
inbound!!A H
=!!I J

ToOkStream!!K U
(!!U V
channel!!V ]
.!!] ^
Reader!!^ d
)!!d e
;!!e f
ChannelSink"" 
outboundSink""  
=""! "
new""# &
(""& '
channel""' .
."". /
Writer""/ 5
)""5 6
;""6 7
return## 
new## 
BidirectionalStream## &
(##& '
inbound##' .
,##. /
outboundSink##0 <
)##< =
;##= >
}$$ 
private&& 
static&& 
IAsyncEnumerable&& #
<&&# $
Result&&$ *
<&&* +
SecureEnvelope&&+ 9
,&&9 :
NetworkFailure&&; I
>&&I J
>&&J K

ToOkStream&&L V
(&&V W
ChannelReader'' 
<'' 
SecureEnvelope'' $
>''$ %
reader''& ,
)'', -
=>''. 0
reader(( 
.(( 
ReadAllAsync(( 
((( 
)(( 
.(( 
Select(( $
((($ %
payload((% ,
=>((- /
Result((0 6
<((6 7
SecureEnvelope((7 E
,((E F
NetworkFailure((G U
>((U V
.((V W
Ok((W Y
(((Y Z
payload((Z a
)((a b
)((b c
;((c d
public** 

sealed** 
class** 

SingleCall** "
(**" #
Task**# '
<**' (
Result**( .
<**. /
SecureEnvelope**/ =
,**= >
NetworkFailure**? M
>**M N
>**N O
result**P V
)**V W
:**X Y
RpcFlow**Z a
{++ 
public,, 

SingleCall,, 
(,, 
Result,,  
<,,  !
SecureEnvelope,,! /
,,,/ 0
NetworkFailure,,1 ?
>,,? @
result,,A G
),,G H
:-- 
this-- 
(-- 
Task-- 
.-- 

FromResult-- "
(--" #
result--# )
)--) *
)--* +
{.. 	
}// 	
public11 
Task11 
<11 
Result11 
<11 
SecureEnvelope11 )
,11) *
NetworkFailure11+ 9
>119 :
>11: ;
Result11< B
{11C D
get11E H
;11H I
}11J K
=11L M
result11N T
;11T U
}22 
public44 

sealed44 
class44 
InboundStream44 %
(44% &
IAsyncEnumerable44& 6
<446 7
Result447 =
<44= >
SecureEnvelope44> L
,44L M
NetworkFailure44N \
>44\ ]
>44] ^
stream44_ e
)44e f
:55 	
RpcFlow55
 
{66 
public77 
IAsyncEnumerable77 
<77  
Result77  &
<77& '
SecureEnvelope77' 5
,775 6
NetworkFailure777 E
>77E F
>77F G
Stream77H N
{77O P
get77Q T
;77T U
}77V W
=77X Y
stream77Z `
;77` a
}88 
public:: 

sealed:: 
class:: 
OutboundSink:: $
(::$ %
IOutboundSink::% 2
sink::3 7
)::7 8
:::9 :
RpcFlow::; B
{;; 
public<< 
IOutboundSink<< 
Sink<< !
{<<" #
get<<$ '
;<<' (
}<<) *
=<<+ ,
sink<<- 1
;<<1 2
}== 
public?? 

sealed?? 
class?? 
BidirectionalStream?? +
(??+ ,
IAsyncEnumerable@@ 
<@@ 
Result@@ 
<@@  
SecureEnvelope@@  .
,@@. /
NetworkFailure@@0 >
>@@> ?
>@@? @
inbound@@A H
,@@H I
IOutboundSinkAA 
outboundSinkAA "
)AA" #
:BB 	
RpcFlowBB
 
{CC 
publicDD 
IAsyncEnumerableDD 
<DD  
ResultDD  &
<DD& '
SecureEnvelopeDD' 5
,DD5 6
NetworkFailureDD7 E
>DDE F
>DDF G
InboundDDH O
{DDP Q
getDDR U
;DDU V
}DDW X
=DDY Z
inboundDD[ b
;DDb c
publicEE 
IOutboundSinkEE 
OutboundEE %
{EE& '
getEE( +
;EE+ ,
}EE- .
=EE/ 0
outboundSinkEE1 =
;EE= >
}FF 
}GG 
internalII 
sealedII	 
classII 
	DrainSinkII 
:II  !
IOutboundSinkII" /
{JJ 
publicKK 

TaskKK 
<KK 
ResultKK 
<KK 
UnitKK 
,KK 
NetworkFailureKK +
>KK+ ,
>KK, -
	SendAsyncKK. 7
(KK7 8
SecureEnvelopeKK8 F
envelopeKKG O
)KKO P
=>KKQ S
TaskLL 
.LL 

FromResultLL 
(LL 
ResultLL 
<LL 
UnitLL #
,LL# $
NetworkFailureLL% 3
>LL3 4
.LL4 5
OkLL5 7
(LL7 8
UnitLL8 <
.LL< =
ValueLL= B
)LLB C
)LLC D
;LLD E
}MM 
internalOO 
sealedOO	 
classOO 
ChannelSinkOO !
(OO! "
ChannelWriterOO" /
<OO/ 0
SecureEnvelopeOO0 >
>OO> ?
writerOO@ F
)OOF G
:OOH I
IOutboundSinkOOJ W
{PP 
publicQQ 

asyncQQ 
TaskQQ 
<QQ 
ResultQQ 
<QQ 
UnitQQ !
,QQ! "
NetworkFailureQQ# 1
>QQ1 2
>QQ2 3
	SendAsyncQQ4 =
(QQ= >
SecureEnvelopeQQ> L
envelopeQQM U
)QQU V
{RR 
trySS 
{TT 	
awaitUU 
writerUU 
.UU 

WriteAsyncUU #
(UU# $
envelopeUU$ ,
)UU, -
.UU- .
ConfigureAwaitUU. <
(UU< =
falseUU= B
)UUB C
;UUC D
returnVV 
ResultVV 
<VV 
UnitVV 
,VV 
NetworkFailureVV  .
>VV. /
.VV/ 0
OkVV0 2
(VV2 3
UnitVV3 7
.VV7 8
ValueVV8 =
)VV= >
;VV> ?
}WW 	
catchXX 
(XX 
	ExceptionXX 
exXX 
)XX 
{YY 	
returnZZ 
ResultZZ 
<ZZ 
UnitZZ 
,ZZ 
NetworkFailureZZ  .
>ZZ. /
.ZZ/ 0
ErrZZ0 3
(ZZ3 4
NetworkFailure[[ 
.[[ #
DataCenterNotResponding[[ 6
([[6 7
ex[[7 9
.[[9 :
Message[[: A
,[[A B
ex[[C E
)[[E F
)[[F G
;[[G H
}\\ 	
}]] 
}^^ µ
|/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/RetryBehavior.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
sealed 
record 
RetryBehavior "
{ 
public 

required 
bool 
ShouldRetry $
{% &
get' *
;* +
init, 0
;0 1
}2 3
public 

required 
int 
MAX_ATTEMPTS $
{% &
get' *
;* +
init, 0
;0 1
}2 3
public 

required 
bool #
ReinitOnCompleteFailure 0
{1 2
get3 6
;6 7
init8 <
;< =
}> ?
public		 

static		 
RetryBehavior		 
NoRetry		  '
{		( )
get		* -
;		- .
}		/ 0
=		1 2
new		3 6
(		6 7
)		7 8
{

 
ShouldRetry 
= 
false 
, 
MAX_ATTEMPTS 
= 
$num 
, #
ReinitOnCompleteFailure 
=  !
false" '
} 
; 
} µQ
á/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/ReceiveStreamRpcServices.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
sealed 
class $
ReceiveStreamRpcServices ,
:- .%
IReceiveStreamRpcServices/ H
{ 
private 
readonly 

Dictionary 
< 
RpcServiceType !
,! "
Func# '
<' (
ServiceRequest( 6
,6 7
CancellationToken8 I
,I J
ResultK Q
<Q R
RpcFlowR Y
,Y Z
NetworkFailure[ i
>i j
>j k
>k l
_serviceHandlers 
; 
private 
readonly $
AuthVerificationServices -
.- .*
AuthVerificationServicesClient. L)
_authenticationServicesClientM j
;j k
private 
readonly 
IGrpcErrorProcessor (
_errorProcessor) 8
;8 9
private 
readonly #
IGrpcCallOptionsFactory ,
_callOptionsFactory- @
;@ A
public 
$
ReceiveStreamRpcServices #
(# $$
AuthVerificationServices  
.  !*
AuthVerificationServicesClient! ?(
authenticationServicesClient@ \
,\ ]
IGrpcErrorProcessor 
errorProcessor *
,* +#
IGrpcCallOptionsFactory 
callOptionsFactory  2
)2 3
{ )
_authenticationServicesClient %
=& '(
authenticationServicesClient( D
;D E
_errorProcessor   
=   
errorProcessor   (
;  ( )
_callOptionsFactory!! 
=!! 
callOptionsFactory!! 0
;!!0 1
_serviceHandlers"" 
="" 
new## 

Dictionary## 
<## 
RpcServiceType## )
,##) *
Func##+ /
<##/ 0
ServiceRequest##0 >
,##> ?
CancellationToken##@ Q
,##Q R
Result##S Y
<##Y Z
RpcFlow##Z a
,##a b
NetworkFailure##c q
>##q r
>##r s
>##s t
{$$ 
{%% 
RpcServiceType%%  
.%%  ! 
InitiateVerification%%! 5
,%%5 6 
InitiateVerification%%7 K
}%%L M
}&& 
;&& 
}'' 
public)) 

Task)) 
<)) 
Result)) 
<)) 
RpcFlow)) 
,)) 
NetworkFailure))  .
>)). /
>))/ 0
ProcessRequest))1 ?
())? @
ServiceRequest))@ N
request))O V
,))V W
CancellationToken** 
token** 
)**  
{++ 
if,, 

(,, 
_serviceHandlers,, 
.,, 
TryGetValue,, (
(,,( )
request-- 
.-- 
RpcServiceMethod-- (
,--( )
out.. 
Func.. 
<.. 
ServiceRequest.. '
,..' (
CancellationToken..) :
,..: ;
Result..< B
<..B C
RpcFlow..C J
,..J K
NetworkFailure..L Z
>..Z [
>..[ \
?..\ ]
handler..^ e
)..e f
)..f g
{// 	
try00 
{11 
Result22 
<22 
RpcFlow22 
,22 
NetworkFailure22  .
>22. /
result220 6
=227 8
handler229 @
(22@ A
request22A H
,22H I
token22J O
)22O P
;22P Q
return33 
Task33 
.33 

FromResult33 &
(33& '
result33' -
)33- .
;33. /
}44 
catch55 
(55 
RpcException55 
rpcEx55  %
)55% &
{66 
return77 
Task77 
.77 

FromResult77 &
(77& '
Result77' -
<77- .
RpcFlow77. 5
,775 6
NetworkFailure777 E
>77E F
.77F G
Err77G J
(77J K
_errorProcessor77K Z
.77Z [
Process77[ b
(77b c
rpcEx77c h
)77h i
)77i j
)77j k
;77k l
}88 
catch99 
(99 
	Exception99 
ex99 
)99  
{:: 
return;; 
Task;; 
.;; 

FromResult;; &
(;;& '
Result;;' -
<;;- .
RpcFlow;;. 5
,;;5 6
NetworkFailure;;7 E
>;;E F
.;;F G
Err;;G J
(;;J K
NetworkFailure<< "
.<<" ##
DataCenterNotResponding<<# :
(<<: ;
ex<<; =
.<<= >
Message<<> E
,<<E F
ex<<G I
)<<I J
)== 
)== 
;== 
}>> 
}?? 	
returnAA 
TaskAA 
.AA 

FromResultAA 
(AA 
ResultAA %
<AA% &
RpcFlowAA& -
,AA- .
NetworkFailureAA/ =
>AA= >
.AA> ?
ErrAA? B
(AAB C
NetworkFailureBB 
.BB 
InvalidRequestTypeBB -
(BB- ."
NetworkServiceMessagesBB. D
.BBD E

RpcServiceBBE O
.BBO P&
UNSUPPORTED_SERVICE_METHODBBP j
)BBj k
)CC 	
)CC	 

;CC
 
}DD 
privateFF 
ResultFF 
<FF 
RpcFlowFF 
,FF 
NetworkFailureFF *
>FF* + 
InitiateVerificationFF, @
(FF@ A
ServiceRequestFFA O
requestFFP W
,FFW X
CancellationTokenGG 
tokenGG 
)GG  
{HH 
tryII 
{JJ 	
CallOptionsKK 
callOptionsKK #
=KK$ %
_callOptionsFactoryKK& 9
.KK9 :
CreateKK: @
(KK@ A
RpcServiceTypeLL 
.LL  
InitiateVerificationLL 3
,LL3 4
requestMM 
.MM 
RequestContextMM &
,MM& '
tokenNN 
)NN 
;NN $
AsyncServerStreamingCallPP $
<PP$ %
SecureEnvelopePP% 3
>PP3 4
streamingCallPP5 B
=PPC D)
_authenticationServicesClientQQ -
.QQ- . 
InitiateVerificationQQ. B
(QQB C
requestQQC J
.QQJ K
PayloadQQK R
,QQR S
callOptionsQQT _
)QQ_ `
;QQ` a
IAsyncEnumerableSS 
<SS 
ResultSS #
<SS# $
SecureEnvelopeSS$ 2
,SS2 3
NetworkFailureSS4 B
>SSB C
>SSC D
streamSSE K
=SSL M
streamingCallTT 
.TT 
ResponseStreamTT ,
.TT, -
ReadAllAsyncTT- 9
(TT9 :
tokenTT: ?
)TT? @
.UU 
ToObservableUU !
(UU! "
)UU" #
.VV 
SelectVV 
(VV 
ResultVV "
<VV" #
SecureEnvelopeVV# 1
,VV1 2
NetworkFailureVV3 A
>VVA B
.VVB C
OkVVC E
)VVE F
.WW 
CatchWW 
<WW 
ResultWW !
<WW! "
SecureEnvelopeWW" 0
,WW0 1
NetworkFailureWW2 @
>WW@ A
,WWA B
RpcExceptionWWC O
>WWO P
(WWP Q
rpcExWWQ V
=>WWW Y

ObservableXX "
.XX" #
ReturnXX# )
(XX) *
ResultXX* 0
<XX0 1
SecureEnvelopeXX1 ?
,XX? @
NetworkFailureXXA O
>XXO P
.XXP Q
ErrXXQ T
(XXT U
_errorProcessorYY +
.YY+ ,
ProcessYY, 3
(YY3 4
rpcExYY4 9
)YY9 :
)YY: ;
)YY; <
)YY< =
.ZZ 
CatchZZ 
<ZZ 
ResultZZ !
<ZZ! "
SecureEnvelopeZZ" 0
,ZZ0 1
NetworkFailureZZ2 @
>ZZ@ A
,ZZA B
	ExceptionZZC L
>ZZL M
(ZZM N
exZZN P
=>ZZQ S

Observable[[ "
.[[" #
Return[[# )
([[) *
Result[[* 0
<[[0 1
SecureEnvelope[[1 ?
,[[? @
NetworkFailure[[A O
>[[O P
.[[P Q
Err[[Q T
([[T U
NetworkFailure\\ *
.\\* +#
DataCenterNotResponding\\+ B
(\\B C
ex\\C E
.\\E F
Message\\F M
,\\M N
ex\\O Q
)\\Q R
)\\R S
)\\S T
)\\T U
.]] 
ToAsyncEnumerable]] &
(]]& '
)]]' (
;]]( )
return__ 
Result__ 
<__ 
RpcFlow__ !
,__! "
NetworkFailure__# 1
>__1 2
.__2 3
Ok__3 5
(__5 6
new__6 9
RpcFlow__: A
.__A B
InboundStream__B O
(__O P
stream__P V
)__V W
)__W X
;__X Y
}`` 	
catchaa 
(aa 
RpcExceptionaa 
rpcExaa !
)aa! "
{bb 	
returncc 
Resultcc 
<cc 
RpcFlowcc !
,cc! "
NetworkFailurecc# 1
>cc1 2
.cc2 3
Errcc3 6
(cc6 7
_errorProcessorcc7 F
.ccF G
ProcessccG N
(ccN O
rpcExccO T
)ccT U
)ccU V
;ccV W
}dd 	
catchee 
(ee 
	Exceptionee 
exee 
)ee 
{ff 	
returngg 
Resultgg 
<gg 
RpcFlowgg !
,gg! "
NetworkFailuregg# 1
>gg1 2
.gg2 3
Errgg3 6
(gg6 7
NetworkFailurehh 
.hh #
DataCenterNotRespondinghh 6
(hh6 7
exhh7 9
.hh9 :
Messagehh: A
,hhA B
exhhC E
)hhE F
)hhF G
;hhG H
}ii 	
}jj 
}kk Ü
Ç/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/IGrpcErrorProcessor.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
	interface 
IGrpcErrorProcessor $
{ 
NetworkFailure		 
Process		 
(		 
RpcException		 '
rpcException		( 4
)		4 5
;		5 6
Task

 
<

 	
NetworkFailure

	 
>

 
ProcessAsync

 %
(

% &
RpcException

& 2
rpcException

3 ?
)

? @
;

@ A
} å«
Å/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/GrpcErrorProcessor.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
internal 
sealed	 
class 
GrpcErrorProcessor (
(( ) 
ILocalizationService) =
localizationService> Q
)Q R
:S T
IGrpcErrorProcessorU h
{ 
public 

NetworkFailure 
Process !
(! "
RpcException" .
rpcException/ ;
); <
=>= ?
CreateFailure@ M
(M N
rpcExceptionN Z
)Z [
;[ \
public 

Task 
< 
NetworkFailure 
> 
ProcessAsync  ,
(, -
RpcException- 9
rpcException: F
)F G
=>H J
Task 
. 

FromResult 
( 
CreateFailure %
(% &
rpcException& 2
)2 3
)3 4
;4 5
private 
NetworkFailure 
CreateFailure (
(( )
RpcException) 5
rpcException6 B
)B C
{ 
UserFacingError 
	userError !
=" #!
CreateUserFacingError$ 9
(9 :
rpcException: F
)F G
;G H
NetworkFailureType 
failureType &
=' ( 
DetermineFailureType) =
(= >
rpcException> J
,J K
	userErrorL U
)U V
;V W
return 
failureType 
switch !
{ 	
NetworkFailureType 
. 
InvalidRequestType 1
=>2 4
NetworkFailure5 C
.C D
InvalidRequestTypeD V
(V W
	userErrorW `
.` a
Messagea h
,h i
rpcExceptionj v
,v w
	userError 
) 
, 
NetworkFailureType 
. 
DataCenterShutdown 1
=>2 4
NetworkFailure5 C
.C D
DataCenterShutdownD V
(V W
	userErrorW `
.` a
Messagea h
,h i
rpcExceptionj v
,v w
	userError 
) 
, 
NetworkFailureType 
. !
ProtocolStateMismatch 4
=>5 7
NetworkFailure8 F
.F G!
ProtocolStateMismatchG \
(\ ]
	userError] f
.f g
Messageg n
,n o
rpcException   
,   
	userError   '
)  ' (
,  ( )
NetworkFailureType!! 
.!! )
CriticalAuthenticationFailure!! <
=>!!= ?
NetworkFailure!!@ N
.!!N O)
CriticalAuthenticationFailure!!O l
(!!l m
	userError"" 
."" 
Message"" !
,""! "
rpcException""# /
,""/ 0
	userError""1 :
)"": ;
,""; <
NetworkFailureType## 
.## 
OperationCancelled## 1
=>##2 4
NetworkFailure##5 C
.##C D
OperationCancelled##D V
(##V W
	userError##W `
.##` a
Message##a h
,##h i
rpcException##j v
,##v w
	userError$$ 
)$$ 
,$$ 
_%% 
=>%% 
NetworkFailure%% 
.%%  #
DataCenterNotResponding%%  7
(%%7 8
	userError%%8 A
.%%A B
Message%%B I
,%%I J
rpcException%%K W
,%%W X
	userError%%Y b
)%%b c
}&& 	
;&&	 

}'' 
private)) 
UserFacingError)) !
CreateUserFacingError)) 1
())1 2
RpcException))2 >
rpcException))? K
)))K L
{** 
Metadata++ 
trailers++ 
=++ 
rpcException++ (
.++( )
Trailers++) 1
;++1 2
	ErrorCode-- 
	errorCode-- 
=-- 
ParseErrorCode-- ,
(--, -
rpcException--- 9
,--9 :
trailers--; C
)--C D
;--D E
(.. 	
string..	 
message.. 
,.. 
string.. 
keyUsed..  '
)..' (
=..) *
ResolveMessage..+ 9
(..9 :
GetMetadataValue// 
(// 
trailers// %
,//% &!
GrpcErrorMetadataKeys//' <
.//< =
	I_18N_KEY//= F
)//F G
,//G H
	errorCode00 
,00 
rpcException11 
.11 
Status11 
.11  
Detail11  &
)11& '
;11' (
bool33 
?33 
	retryable33 
=33 
ParseRetryable33 (
(33( )
trailers33) 1
)331 2
??333 5
IsTransientStatus336 G
(33G H
rpcException33H T
.33T U

StatusCode33U _
)33_ `
;33` a
if55 

(55 
GrpcErrorClassifier55 
.55  
IsAuthFlowMissing55  1
(551 2
rpcException552 >
)55> ?
)55? @
{66 	
	retryable77 
=77 
true77 
;77 
}88 	
int:: 
?:: 

retryAfter:: 
=:: 
ParseRetryAfter:: )
(::) *
trailers::* 2
)::2 3
;::3 4
string;; 
?;; 
correlationId;; 
=;; 
GetMetadataValue;;  0
(;;0 1
trailers;;1 9
,;;9 :!
GrpcErrorMetadataKeys;;; P
.;;P Q
CORRELATION_ID;;Q _
);;_ `
;;;` a
string<< 
?<< 
locale<< 
=<< 
GetMetadataValue<< )
(<<) *
trailers<<* 2
,<<2 3!
GrpcErrorMetadataKeys<<4 I
.<<I J
LOCALE<<J P
)<<P Q
;<<Q R
return>> 
new>> 
UserFacingError>> "
(>>" #
	errorCode?? 
,?? 
keyUsed@@ 
,@@ 
messageAA 
,AA 
	retryableBB 
,BB 

retryAfterCC 
,CC 
correlationIdDD 
,DD 
localeEE 
,EE 
rpcExceptionFF 
.FF 

StatusCodeFF #
)FF# $
;FF$ %
}GG 
privateII 
	ErrorCodeII 
ParseErrorCodeII $
(II$ %
RpcExceptionII% 1
rpcExceptionII2 >
,II> ?
MetadataII@ H
trailersIII Q
)IIQ R
{JJ 
ifKK 

(KK 
GrpcErrorClassifierKK 
.KK  
IsAuthFlowMissingKK  1
(KK1 2
rpcExceptionKK2 >
)KK> ?
)KK? @
{LL 	
returnMM 
	ErrorCodeMM 
.MM "
DEPENDENCY_UNAVAILABLEMM 3
;MM3 4
}NN 	
stringPP 
?PP 
rawCodePP 
=PP 
GetMetadataValuePP *
(PP* +
trailersPP+ 3
,PP3 4!
GrpcErrorMetadataKeysPP5 J
.PPJ K

ERROR_CODEPPK U
)PPU V
;PPV W
ifQQ 

(QQ 
!QQ 
stringQQ 
.QQ 
IsNullOrWhiteSpaceQQ &
(QQ& '
rawCodeQQ' .
)QQ. /
&&QQ0 2
EnumRR 
.RR 
TryParseRR 
(RR 
rawCodeRR !
,RR! "

ignoreCaseRR# -
:RR- .
trueRR/ 3
,RR3 4
outRR5 8
	ErrorCodeRR9 B
parsedRRC I
)RRI J
)RRJ K
{SS 	
returnTT 
parsedTT 
;TT 
}UU 	
returnWW 
MapStatusCodeWW 
(WW 
rpcExceptionWW )
.WW) *

StatusCodeWW* 4
)WW4 5
;WW5 6
}XX 
privateZZ 
(ZZ 
stringZZ 
MessageZZ 
,ZZ 
stringZZ #
KeyUsedZZ$ +
)ZZ+ ,
ResolveMessageZZ- ;
(ZZ; <
stringZZ< B
?ZZB C
requestedKeyZZD P
,ZZP Q
	ErrorCodeZZR [
	errorCodeZZ\ e
,ZZe f
string[[ 
statusDetail[[ 
)[[ 
{\\ 
if]] 

(]] 
!]] 
string]] 
.]] 
IsNullOrWhiteSpace]] &
(]]& '
requestedKey]]' 3
)]]3 4
)]]4 5
{^^ 	
string__ 
	localized__ 
=__ 
Localize__ '
(__' (
requestedKey__( 4
)__4 5
;__5 6
if`` 
(`` 
!`` 
	IsMissing`` 
(`` 
	localized`` $
)``$ %
)``% &
{aa 
returnbb 
(bb 
	localizedbb !
,bb! "
requestedKeybb# /
)bb/ 0
;bb0 1
}cc 
}dd 	
stringff 
fallbackKeyff 
=ff 
GetFallbackKeyff +
(ff+ ,
	errorCodeff, 5
)ff5 6
;ff6 7
stringgg 
fallbackMessagegg 
=gg  
Localizegg! )
(gg) *
fallbackKeygg* 5
)gg5 6
;gg6 7
ifhh 

(hh 
!hh 
	IsMissinghh 
(hh 
fallbackMessagehh &
)hh& '
)hh' (
{ii 	
returnjj 
(jj 
fallbackMessagejj #
,jj# $
fallbackKeyjj% 0
)jj0 1
;jj1 2
}kk 	
ifmm 

(mm 
!mm 
stringmm 
.mm 
IsNullOrWhiteSpacemm &
(mm& '
statusDetailmm' 3
)mm3 4
)mm4 5
{nn 	
returnoo 
(oo 
statusDetailoo  
,oo  !
fallbackKeyoo" -
)oo- .
;oo. /
}pp 	
stringrr 
internalMessagerr 
=rr  
Localizerr! )
(rr) *
ErrorI18nKeysrr* 7
.rr7 8
INTERNALrr8 @
)rr@ A
;rrA B
ifss 

(ss 
	IsMissingss 
(ss 
internalMessagess %
)ss% &
)ss& '
{tt 	
internalMessageuu 
=uu 
$struu <
;uu< =
}vv 	
returnxx 
(xx 
internalMessagexx 
,xx  
ErrorI18nKeysxx! .
.xx. /
INTERNALxx/ 7
)xx7 8
;xx8 9
}yy 
private{{ 
string{{ 
Localize{{ 
({{ 
string{{ "
key{{# &
){{& '
{|| 
try}} 
{~~ 	
return 
localizationService &
[& '
key' *
]* +
;+ ,
}
ÄÄ 	
catch
ÅÅ 
{
ÇÇ 	
return
ÉÉ 
$"
ÉÉ 
$str
ÉÉ 
{
ÉÉ 
key
ÉÉ 
}
ÉÉ 
$str
ÉÉ 
"
ÉÉ 
;
ÉÉ 
}
ÑÑ 	
}
ÖÖ 
private
áá 
static
áá 
bool
áá 
	IsMissing
áá !
(
áá! "
string
áá" (
value
áá) .
)
áá. /
{
àà 
return
ââ 
string
ââ 
.
ââ  
IsNullOrWhiteSpace
ââ (
(
ââ( )
value
ââ) .
)
ââ. /
||
ââ0 2
value
ää 
.
ää 

StartsWith
ää 
(
ää  
$str
ää  #
,
ää# $
StringComparison
ää% 5
.
ää5 6
Ordinal
ää6 =
)
ää= >
&&
ää? A
value
ääB G
.
ääG H
EndsWith
ääH P
(
ääP Q
$str
ääQ T
,
ääT U
StringComparison
ääV f
.
ääf g
Ordinal
ääg n
)
ään o
;
ääo p
}
ãã 
private
çç 
static
çç 
bool
çç 
?
çç 
ParseRetryable
çç '
(
çç' (
Metadata
çç( 0
trailers
çç1 9
)
çç9 :
{
éé 
string
èè 
?
èè 
retryableValue
èè 
=
èè  
GetMetadataValue
èè! 1
(
èè1 2
trailers
èè2 :
,
èè: ;#
GrpcErrorMetadataKeys
èè< Q
.
èèQ R
	RETRYABLE
èèR [
)
èè[ \
;
èè\ ]
if
êê 

(
êê 
string
êê 
.
êê  
IsNullOrWhiteSpace
êê %
(
êê% &
retryableValue
êê& 4
)
êê4 5
)
êê5 6
{
ëë 	
return
íí 
null
íí 
;
íí 
}
ìì 	
return
ïï 
bool
ïï 
.
ïï 
TryParse
ïï 
(
ïï 
retryableValue
ïï +
,
ïï+ ,
out
ïï- 0
bool
ïï1 5
parsed
ïï6 <
)
ïï< =
?
ïï> ?
parsed
ïï@ F
:
ïïG H
null
ïïI M
;
ïïM N
}
ññ 
private
òò 
static
òò 
int
òò 
?
òò 
ParseRetryAfter
òò '
(
òò' (
Metadata
òò( 0
trailers
òò1 9
)
òò9 :
{
ôô 
string
öö 
?
öö 
retryAfterValue
öö 
=
öö  !
GetMetadataValue
öö" 2
(
öö2 3
trailers
öö3 ;
,
öö; <#
GrpcErrorMetadataKeys
öö= R
.
ööR S&
RETRY_AFTER_MILLISECONDS
ööS k
)
öök l
;
ööl m
if
õõ 

(
õõ 
string
õõ 
.
õõ  
IsNullOrWhiteSpace
õõ %
(
õõ% &
retryAfterValue
õõ& 5
)
õõ5 6
)
õõ6 7
{
úú 	
return
ùù 
null
ùù 
;
ùù 
}
ûû 	
return
†† 
int
†† 
.
†† 
TryParse
†† 
(
†† 
retryAfterValue
†† +
,
††+ ,
NumberStyles
††- 9
.
††9 :
Integer
††: A
,
††A B
CultureInfo
††C N
.
††N O
InvariantCulture
††O _
,
††_ `
out
††a d
int
††e h
parsed
††i o
)
††o p
?
°° 
parsed
°° 
:
¢¢ 
null
¢¢ 
;
¢¢ 
}
££ 
private
•• 
static
•• 
string
•• 
?
•• 
GetMetadataValue
•• +
(
••+ ,
Metadata
••, 4
metadata
••5 =
,
••= >
string
••? E
key
••F I
)
••I J
{
¶¶ 
foreach
ßß 
(
ßß 
Metadata
ßß 
.
ßß 
Entry
ßß 
entry
ßß  %
in
ßß& (
metadata
ßß) 1
)
ßß1 2
{
®® 	
if
©© 
(
©© 
entry
©© 
.
©© 
Key
©© 
.
©© 
Equals
©©  
(
©©  !
key
©©! $
,
©©$ %
StringComparison
©©& 6
.
©©6 7
OrdinalIgnoreCase
©©7 H
)
©©H I
)
©©I J
{
™™ 
return
´´ 
entry
´´ 
.
´´ 
Value
´´ "
;
´´" #
}
¨¨ 
}
≠≠ 	
return
ØØ 
null
ØØ 
;
ØØ 
}
∞∞ 
private
≤≤ 
static
≤≤ 
bool
≤≤ 
IsTransientStatus
≤≤ )
(
≤≤) *

StatusCode
≤≤* 4

statusCode
≤≤5 ?
)
≤≤? @
=>
≤≤A C

statusCode
≥≥ 
is
≥≥ 

StatusCode
≥≥  
.
≥≥  !
Unavailable
≥≥! ,
or
≥≥- /

StatusCode
≥≥0 :
.
≥≥: ;
DeadlineExceeded
≥≥; K
or
≥≥L N

StatusCode
≥≥O Y
.
≥≥Y Z
	Cancelled
≥≥Z c
;
≥≥c d
private
µµ 
static
µµ 
	ErrorCode
µµ 
MapStatusCode
µµ *
(
µµ* +

StatusCode
µµ+ 5

statusCode
µµ6 @
)
µµ@ A
=>
µµB D

statusCode
∂∂ 
switch
∂∂ 
{
∑∑ 	

StatusCode
∏∏ 
.
∏∏ 
InvalidArgument
∏∏ &
or
∏∏' )

StatusCode
∏∏* 4
.
∏∏4 5

OutOfRange
∏∏5 ?
=>
∏∏@ B
	ErrorCode
∏∏C L
.
∏∏L M
VALIDATION_FAILED
∏∏M ^
,
∏∏^ _

StatusCode
ππ 
.
ππ 
NotFound
ππ 
=>
ππ  "
	ErrorCode
ππ# ,
.
ππ, -
	NOT_FOUND
ππ- 6
,
ππ6 7

StatusCode
∫∫ 
.
∫∫ 
AlreadyExists
∫∫ $
=>
∫∫% '
	ErrorCode
∫∫( 1
.
∫∫1 2
ALREADY_EXISTS
∫∫2 @
,
∫∫@ A

StatusCode
ªª 
.
ªª 
PermissionDenied
ªª '
=>
ªª( *
	ErrorCode
ªª+ 4
.
ªª4 5
PERMISSION_DENIED
ªª5 F
,
ªªF G

StatusCode
ºº 
.
ºº 
Unauthenticated
ºº &
=>
ºº' )
	ErrorCode
ºº* 3
.
ºº3 4
UNAUTHENTICATED
ºº4 C
,
ººC D

StatusCode
ΩΩ 
.
ΩΩ  
FailedPrecondition
ΩΩ )
=>
ΩΩ* ,
	ErrorCode
ΩΩ- 6
.
ΩΩ6 7!
PRECONDITION_FAILED
ΩΩ7 J
,
ΩΩJ K

StatusCode
ææ 
.
ææ 
Aborted
ææ 
=>
ææ !
	ErrorCode
ææ" +
.
ææ+ ,
CONFLICT
ææ, 4
,
ææ4 5

StatusCode
øø 
.
øø 
ResourceExhausted
øø (
=>
øø) +
	ErrorCode
øø, 5
.
øø5 6 
RESOURCE_EXHAUSTED
øø6 H
,
øøH I

StatusCode
¿¿ 
.
¿¿ 
Unavailable
¿¿ "
=>
¿¿# %
	ErrorCode
¿¿& /
.
¿¿/ 0!
SERVICE_UNAVAILABLE
¿¿0 C
,
¿¿C D

StatusCode
¡¡ 
.
¡¡ 
DeadlineExceeded
¡¡ '
=>
¡¡( *
	ErrorCode
¡¡+ 4
.
¡¡4 5
DEADLINE_EXCEEDED
¡¡5 F
,
¡¡F G

StatusCode
¬¬ 
.
¬¬ 
	Cancelled
¬¬  
=>
¬¬! #
	ErrorCode
¬¬$ -
.
¬¬- .
	CANCELLED
¬¬. 7
,
¬¬7 8
_
√√ 
=>
√√ 
	ErrorCode
√√ 
.
√√ 
INTERNAL_ERROR
√√ )
}
ƒƒ 	
;
ƒƒ	 

private
∆∆ 
static
∆∆ 
string
∆∆ 
GetFallbackKey
∆∆ (
(
∆∆( )
	ErrorCode
∆∆) 2
	errorCode
∆∆3 <
)
∆∆< =
=>
∆∆> @
	errorCode
«« 
switch
«« 
{
»» 	
	ErrorCode
…… 
.
…… 
VALIDATION_FAILED
…… '
=>
……( *
ErrorI18nKeys
……+ 8
.
……8 9

VALIDATION
……9 C
,
……C D
	ErrorCode
   
.
   "
MAX_ATTEMPTS_REACHED
   *
=>
  + -
ErrorI18nKeys
  . ;
.
  ; <
MAX_ATTEMPTS
  < H
,
  H I
	ErrorCode
ÀÀ 
.
ÀÀ #
INVALID_MOBILE_NUMBER
ÀÀ +
=>
ÀÀ, .
ErrorI18nKeys
ÀÀ/ <
.
ÀÀ< =
INVALID_MOBILE
ÀÀ= K
,
ÀÀK L
	ErrorCode
ÃÃ 
.
ÃÃ 
OTP_EXPIRED
ÃÃ !
=>
ÃÃ" $
ErrorI18nKeys
ÃÃ% 2
.
ÃÃ2 3
OTP_EXPIRED
ÃÃ3 >
,
ÃÃ> ?
	ErrorCode
ÕÕ 
.
ÕÕ 
	NOT_FOUND
ÕÕ 
=>
ÕÕ  "
ErrorI18nKeys
ÕÕ# 0
.
ÕÕ0 1
	NOT_FOUND
ÕÕ1 :
,
ÕÕ: ;
	ErrorCode
ŒŒ 
.
ŒŒ 
ALREADY_EXISTS
ŒŒ $
=>
ŒŒ% '
ErrorI18nKeys
ŒŒ( 5
.
ŒŒ5 6
ALREADY_EXISTS
ŒŒ6 D
,
ŒŒD E
	ErrorCode
œœ 
.
œœ 
UNAUTHENTICATED
œœ %
=>
œœ& (
ErrorI18nKeys
œœ) 6
.
œœ6 7
UNAUTHENTICATED
œœ7 F
,
œœF G
	ErrorCode
–– 
.
–– 
PERMISSION_DENIED
–– '
=>
––( *
ErrorI18nKeys
––+ 8
.
––8 9
PERMISSION_DENIED
––9 J
,
––J K
	ErrorCode
—— 
.
—— !
PRECONDITION_FAILED
—— )
=>
——* ,
ErrorI18nKeys
——- :
.
——: ;!
PRECONDITION_FAILED
——; N
,
——N O
	ErrorCode
““ 
.
““ 
CONFLICT
““ 
=>
““ !
ErrorI18nKeys
““" /
.
““/ 0
CONFLICT
““0 8
,
““8 9
	ErrorCode
”” 
.
””  
RESOURCE_EXHAUSTED
”” (
=>
””) +
ErrorI18nKeys
””, 9
.
””9 : 
RESOURCE_EXHAUSTED
””: L
,
””L M
	ErrorCode
‘‘ 
.
‘‘ !
SERVICE_UNAVAILABLE
‘‘ )
=>
‘‘* ,
ErrorI18nKeys
‘‘- :
.
‘‘: ;!
SERVICE_UNAVAILABLE
‘‘; N
,
‘‘N O
	ErrorCode
’’ 
.
’’ $
DEPENDENCY_UNAVAILABLE
’’ ,
=>
’’- /
ErrorI18nKeys
’’0 =
.
’’= >$
DEPENDENCY_UNAVAILABLE
’’> T
,
’’T U
	ErrorCode
÷÷ 
.
÷÷ 
DEADLINE_EXCEEDED
÷÷ '
=>
÷÷( *
ErrorI18nKeys
÷÷+ 8
.
÷÷8 9
DEADLINE_EXCEEDED
÷÷9 J
,
÷÷J K
	ErrorCode
◊◊ 
.
◊◊ 
	CANCELLED
◊◊ 
=>
◊◊  "
ErrorI18nKeys
◊◊# 0
.
◊◊0 1
	CANCELLED
◊◊1 :
,
◊◊: ;
	ErrorCode
ÿÿ 
.
ÿÿ "
DATABASE_UNAVAILABLE
ÿÿ *
=>
ÿÿ+ -
ErrorI18nKeys
ÿÿ. ;
.
ÿÿ; <"
DATABASE_UNAVAILABLE
ÿÿ< P
,
ÿÿP Q
_
ŸŸ 
=>
ŸŸ 
ErrorI18nKeys
ŸŸ 
.
ŸŸ 
INTERNAL
ŸŸ '
}
⁄⁄ 	
;
⁄⁄	 

private
‹‹ 
static
‹‹  
NetworkFailureType
‹‹ %"
DetermineFailureType
‹‹& :
(
‹‹: ;
RpcException
‹‹; G
rpcException
‹‹H T
,
‹‹T U
UserFacingError
‹‹V e
	userError
‹‹f o
)
‹‹o p
{
›› 
if
ﬁﬁ 

(
ﬁﬁ !
GrpcErrorClassifier
ﬁﬁ 
.
ﬁﬁ  ,
IsIdentityKeyDerivationFailure
ﬁﬁ  >
(
ﬁﬁ> ?
rpcException
ﬁﬁ? K
)
ﬁﬁK L
||
ﬁﬁM O!
GrpcErrorClassifier
ﬂﬂ 
.
ﬂﬂ  #
IsAuthenticationError
ﬂﬂ  5
(
ﬂﬂ5 6
rpcException
ﬂﬂ6 B
)
ﬂﬂB C
||
ﬂﬂD F
	userError
‡‡ 
.
‡‡ 

ERROR_CODE
‡‡  
==
‡‡! #
	ErrorCode
‡‡$ -
.
‡‡- .
UNAUTHENTICATED
‡‡. =
)
‡‡= >
{
·· 	
return
‚‚  
NetworkFailureType
‚‚ %
.
‚‚% &+
CriticalAuthenticationFailure
‚‚& C
;
‚‚C D
}
„„ 	
if
ÂÂ 

(
ÂÂ !
GrpcErrorClassifier
ÂÂ 
.
ÂÂ  %
IsProtocolStateMismatch
ÂÂ  7
(
ÂÂ7 8
rpcException
ÂÂ8 D
)
ÂÂD E
)
ÂÂE F
{
ÊÊ 	
return
ÁÁ  
NetworkFailureType
ÁÁ %
.
ÁÁ% &#
ProtocolStateMismatch
ÁÁ& ;
;
ÁÁ; <
}
ËË 	
if
ÍÍ 

(
ÍÍ !
GrpcErrorClassifier
ÍÍ 
.
ÍÍ  
IsServerShutdown
ÍÍ  0
(
ÍÍ0 1
rpcException
ÍÍ1 =
)
ÍÍ= >
)
ÍÍ> ?
{
ÎÎ 	
return
ÏÏ  
NetworkFailureType
ÏÏ %
.
ÏÏ% & 
DataCenterShutdown
ÏÏ& 8
;
ÏÏ8 9
}
ÌÌ 	
if
ÔÔ 

(
ÔÔ !
GrpcErrorClassifier
ÔÔ 
.
ÔÔ  
IsBusinessError
ÔÔ  /
(
ÔÔ/ 0
rpcException
ÔÔ0 <
)
ÔÔ< =
&&
ÔÔ> @
!
 !
GrpcErrorClassifier
  
.
  !
IsAuthFlowMissing
! 2
(
2 3
rpcException
3 ?
)
? @
)
@ A
{
ÒÒ 	
return
ÚÚ  
NetworkFailureType
ÚÚ %
.
ÚÚ% & 
InvalidRequestType
ÚÚ& 8
;
ÚÚ8 9
}
ÛÛ 	
if
ıı 

(
ıı !
GrpcErrorClassifier
ıı 
.
ıı  '
IsTransientInfrastructure
ıı  9
(
ıı9 :
rpcException
ıı: F
)
ııF G
||
ııH J!
GrpcErrorClassifier
ˆˆ 
.
ˆˆ  '
RequiresHandshakeRecovery
ˆˆ  9
(
ˆˆ9 :
rpcException
ˆˆ: F
)
ˆˆF G
||
ˆˆH J!
GrpcErrorClassifier
˜˜ 
.
˜˜  
IsAuthFlowMissing
˜˜  1
(
˜˜1 2
rpcException
˜˜2 >
)
˜˜> ?
)
˜˜? @
{
¯¯ 	
return
˘˘  
NetworkFailureType
˘˘ %
.
˘˘% &%
DataCenterNotResponding
˘˘& =
;
˘˘= >
}
˙˙ 	
if
¸¸ 

(
¸¸ 
rpcException
¸¸ 
.
¸¸ 

StatusCode
¸¸ #
==
¸¸$ &

StatusCode
¸¸' 1
.
¸¸1 2
	Cancelled
¸¸2 ;
)
¸¸; <
{
˝˝ 	
}
˛˛ 	
return
ÄÄ  
NetworkFailureType
ÄÄ !
.
ÄÄ! "%
DataCenterNotResponding
ÄÄ" 9
;
ÄÄ9 :
}
ÅÅ 
}ÇÇ Ö
ê/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Resilience/RetryStrategyConfiguration.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )

Resilience) 3
;3 4
public 
class &
RetryStrategyConfiguration '
{ 
public 

TimeSpan 
INITIAL_RETRY_DELAY '
{( )
get* -
;- .
init/ 3
;3 4
}5 6
=7 8
TimeSpan9 A
.A B
FromSecondsB M
(M N
$numN O
)O P
;P Q
public 

TimeSpan 
MAX_RETRY_DELAY #
{$ %
get& )
;) *
init+ /
;/ 0
}1 2
=3 4
TimeSpan5 =
.= >
FromMinutes> I
(I J
$numJ K
)K L
;L M
public		 

int		 
MAX_RETRIES		 
{		 
get		  
;		  !
init		" &
;		& '
}		( )
=		* +
$num		, .
;		. /
public

 

bool

 
USE_ADAPTIVE_RETRY

 "
{

# $
get

% (
;

( )
init

* .
;

. /
}

0 1
=

2 3
true

4 8
;

8 9
public 

TimeSpan 
PER_ATTEMPT_TIMEOUT '
{( )
get* -
;- .
init/ 3
;3 4
}5 6
=7 8
TimeSpan9 A
.A B
FromSecondsB M
(M N
$numN P
)P Q
;Q R
} ˛˝
É/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Resilience/RetryStrategy.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )

Resilience) 3
;3 4
public 
sealed 
class 
RetryStrategy !
:" #
IRetryStrategy$ 2
{ 
private 
const 
int "
MAX_TRACKED_OPERATIONS ,
=- .
$num/ 3
;3 4
private 
const 
int $
CLEANUP_INTERVAL_MINUTES .
=/ 0
$num1 2
;2 3
private 
const 
int %
OPERATION_TIMEOUT_MINUTES /
=0 1
$num2 4
;4 5
private   
const   
string   
ATTEMPT_KEY   $
=  % &
$str  ' 0
;  0 1
private"" 
readonly"" &
RetryStrategyConfiguration"" /"
_strategyConfiguration""0 F
;""F G
private## 
readonly##  
IConnectivityService## ) 
_connectivityService##* >
;##> ?
private$$ 
readonly$$  
ConcurrentDictionary$$ )
<$$) *
string$$* 0
,$$0 1
RetryOperationInfo$$2 D
>$$D E"
_activeRetryOperations$$F \
=$$] ^
new$$_ b
($$b c
)$$c d
;$$d e
private%% 
readonly%%  
ConcurrentDictionary%% )
<%%) *
string%%* 0
,%%0 1
object%%2 8
>%%8 9
_pipelineCache%%: H
=%%I J
new%%K N
(%%N O
)%%O P
;%%P Q
private&& 
readonly&& 
SemaphoreSlim&& "

_stateLock&&# -
=&&. /
new&&0 3
(&&3 4
$num&&4 5
,&&5 6
$num&&7 8
)&&8 9
;&&9 :
private'' 
readonly'' 
Timer'' 
_cleanupTimer'' (
;''( )
private(( 
readonly(( 
IDisposable((  
?((  !$
_manualRetrySubscription((" :
;((: ;
private** 
Lazy** 
<** 
NetworkProvider**  
>**  !
?**! " 
_lazyNetworkProvider**# 7
;**7 8
private++ 
volatile++ 
bool++ 
_isDisposed++ %
;++% &
private-- 
sealed-- 
class-- 
RetryOperationInfo-- +
{.. 
public// 
required// 
string// 
OperationName// ,
{//- .
get/// 2
;//2 3
init//4 8
;//8 9
}//: ;
public00 
required00 
uint00 
	ConnectId00 &
{00' (
get00) ,
;00, -
init00. 2
;002 3
}004 5
public11 
required11 
DateTime11  
	StartTime11! *
{11+ ,
get11- 0
;110 1
init112 6
;116 7
}118 9
public22 
required22 
int22 
MAX_RETRIES22 '
{22( )
get22* -
;22- .
init22/ 3
;223 4
}225 6
public33 
required33 
string33 
	UniqueKey33 (
{33) *
get33+ .
;33. /
init330 4
;334 5
}336 7
public44 
required44 
RpcServiceType44 &
?44& '
ServiceType44( 3
{444 5
get446 9
;449 :
init44; ?
;44? @
}44A B
private66 
int66 
_currentRetryCount66 &
;66& '
private77 
int77 
_isExhausted77  
;77  !
public99 
int99 
CurrentRetryCount99 $
{:: 	
get;; 
=>;; 
_currentRetryCount;; %
;;;% &
set<< 
=><< 
Interlocked<< 
.<< 
Exchange<< '
(<<' (
ref<<( +
_currentRetryCount<<, >
,<<> ?
value<<@ E
)<<E F
;<<F G
}== 	
public?? 
bool?? 
IsExhausted?? 
{@@ 	
getAA 
=>AA 
_isExhaustedAA 
==AA  "
$numAA# $
;AA$ %
setBB 
=>BB 
InterlockedBB 
.BB 
ExchangeBB '
(BB' (
refBB( +
_isExhaustedBB, 8
,BB8 9
valueBB: ?
?BB@ A
$numBBB C
:BBD E
$numBBF G
)BBG H
;BBH I
}CC 	
}DD 
publicFF 

RetryStrategyFF 
(FF &
RetryStrategyConfigurationGG "!
strategyConfigurationGG# 8
,GG8 9 
IConnectivityServiceHH 
connectivityServiceHH 0
,HH0 1%
IOperationTimeoutProviderII !
_II" #
)II# $
{JJ "
_strategyConfigurationKK 
=KK  !
strategyConfigurationKK! 6
;KK6 7 
_connectivityServiceLL 
=LL 
connectivityServiceLL 2
;LL2 3
_cleanupTimerNN 
=NN 
newNN 
TimerNN !
(NN! "&
CleanupAbandonedOperationsOO &
,OO& '
nullPP 
,PP 
TimeSpanQQ 
.QQ 
FromMinutesQQ  
(QQ  !$
CLEANUP_INTERVAL_MINUTESQQ! 9
)QQ9 :
,QQ: ;
TimeSpanRR 
.RR 
FromMinutesRR  
(RR  !$
CLEANUP_INTERVAL_MINUTESRR! 9
)RR9 :
)RR: ;
;RR; <
tryTT 
{UU 	$
_manualRetrySubscriptionVV $
=VV% & 
_connectivityServiceVV' ;
.VV; <"
OnManualRetryRequestedVV< R
(VVR S)
HandleManualRetryRequestAsyncVVS p
)VVp q
;VVq r
}WW 	
catchXX 
(XX 
	ExceptionXX 
exXX 
)XX 
{YY 	
LogZZ 
.ZZ 
ErrorZZ 
(ZZ 
exZZ 
,ZZ 
$strZZ F
)ZZF G
;ZZG H
Dispose[[ 
([[ 
)[[ 
;[[ 
throw\\ 
;\\ 
}]] 	
Log__ 
.__ 
Information__ 
(__ 
$str	`` Ä
,
``Ä Å"
_strategyConfigurationaa "
.aa" #
MAX_RETRIESaa# .
,aa. /"
_strategyConfigurationaa0 F
.aaF G
INITIAL_RETRY_DELAYaaG Z
)aaZ [
;aa[ \
}bb 
publicdd 

voiddd "
SetLazyNetworkProviderdd &
(dd& '
Lazydd' +
<dd+ ,
NetworkProviderdd, ;
>dd; <
lazyNetworkProviderdd= P
)ddP Q
{ee 
ifff 

(ff 
_isDisposedff 
)ff 
{gg 	
throwhh 
newhh #
ObjectDisposedExceptionhh -
(hh- .
nameofhh. 4
(hh4 5
RetryStrategyhh5 B
)hhB C
)hhC D
;hhD E
}ii 	 
_lazyNetworkProviderkk 
=kk 
lazyNetworkProviderkk 2
;kk2 3
}ll 
publicnn 

asyncnn 
Tasknn 
<nn 
Resultnn 
<nn 
	TResponsenn &
,nn& '
NetworkFailurenn( 6
>nn6 7
>nn7 8$
ExecuteRpcOperationAsyncnn9 Q
<nnQ R
	TResponsennR [
>nn[ \
(nn\ ]
Funcoo 
<oo 
intoo 
,oo 
CancellationTokenoo #
,oo# $
Taskoo% )
<oo) *
Resultoo* 0
<oo0 1
	TResponseoo1 :
,oo: ;
NetworkFailureoo< J
>ooJ K
>ooK L
>ooL M
	operationooN W
,ooW X
stringpp 
operationNamepp 
,pp 
uintqq 
	connectIdqq 
,qq 
RpcServiceTyperr 
?rr 
serviceTyperr #
=rr$ %
nullrr& *
,rr* +
intss 
?ss 

maxRetriesss 
=ss 
nullss 
,ss 
CancellationTokentt 
cancellationTokentt +
=tt, -
defaulttt. 5
)tt5 6
{uu 
returnvv 
awaitvv 7
+ExecuteSecrecyChannelOperationInternalAsyncvv @
(vv@ A
	operationww 
,ww 
operationNameww (
,ww( )
	connectIdww* 3
,ww3 4
serviceTypeww5 @
,ww@ A

maxRetrieswwB L
,wwL M
cancellationTokenwwN _
,ww_ `!
bypassExhaustionCheckxx %
:xx% &
falsexx' ,
)xx, -
.yy 
ConfigureAwaityy 
(yy 
falseyy !
)yy! "
;yy" #
}zz 
public|| 

async|| 
Task|| 
<|| 
Result|| 
<|| 
	TResponse|| &
,||& '
NetworkFailure||( 6
>||6 7
>||7 8/
#ExecuteManualRetryRpcOperationAsync||9 \
<||\ ]
	TResponse||] f
>||f g
(||g h
Func}} 
<}} 
int}} 
,}} 
CancellationToken}} #
,}}# $
Task}}% )
<}}) *
Result}}* 0
<}}0 1
	TResponse}}1 :
,}}: ;
NetworkFailure}}< J
>}}J K
>}}K L
>}}L M
	operation}}N W
,}}W X
string~~ 
operationName~~ 
,~~ 
uint 
	connectId 
, 
RpcServiceType
ÄÄ 
?
ÄÄ 
serviceType
ÄÄ #
=
ÄÄ$ %
null
ÄÄ& *
,
ÄÄ* +
int
ÅÅ 
?
ÅÅ 

maxRetries
ÅÅ 
=
ÅÅ 
null
ÅÅ 
,
ÅÅ 
CancellationToken
ÇÇ 
cancellationToken
ÇÇ +
=
ÇÇ, -
default
ÇÇ. 5
)
ÇÇ5 6
{
ÉÉ 
Log
ÑÑ 
.
ÑÑ 
Information
ÑÑ 
(
ÑÑ 
$str
ÑÑ l
,
ÑÑl m
operationName
ÖÖ 
)
ÖÖ 
;
ÖÖ 
return
ÜÜ 
await
ÜÜ 9
+ExecuteSecrecyChannelOperationInternalAsync
ÜÜ @
(
ÜÜ@ A
	operation
áá 
,
áá 
operationName
áá (
,
áá( )
	connectId
áá* 3
,
áá3 4
serviceType
áá5 @
,
áá@ A

maxRetries
ááB L
,
ááL M
cancellationToken
ááN _
,
áá_ `#
bypassExhaustionCheck
àà %
:
àà% &
true
àà' +
)
àà+ ,
.
ââ 
ConfigureAwait
ââ 
(
ââ 
false
ââ !
)
ââ! "
;
ââ" #
}
ää 
private
åå 
async
åå 
Task
åå 
<
åå 
Result
åå 
<
åå 
	TResponse
åå '
,
åå' (
NetworkFailure
åå) 7
>
åå7 8
>
åå8 99
+ExecuteSecrecyChannelOperationInternalAsync
åå: e
<
ååe f
	TResponse
ååf o
>
ååo p
(
ååp q
Func
çç 
<
çç 
int
çç 
,
çç 
CancellationToken
çç #
,
çç# $
Task
çç% )
<
çç) *
Result
çç* 0
<
çç0 1
	TResponse
çç1 :
,
çç: ;
NetworkFailure
çç< J
>
ççJ K
>
ççK L
>
ççL M
	operation
ççN W
,
ççW X
string
éé 
operationName
éé 
,
éé 
uint
èè 
?
èè 
	connectId
èè 
,
èè 
RpcServiceType
êê 
?
êê 
serviceType
êê #
,
êê# $
int
ëë 
?
ëë 

maxRetries
ëë 
,
ëë 
CancellationToken
íí 
cancellationToken
íí +
,
íí+ ,
bool
ìì #
bypassExhaustionCheck
ìì "
)
ìì" #
{
îî 
uint
ïï 
actualConnectId
ïï 
=
ïï 
	connectId
ïï (
??
ïï) +
$num
ïï, -
;
ïï- .
int
ññ 
actualMaxRetries
ññ 
=
ññ 

maxRetries
ññ )
??
ññ* ,$
_strategyConfiguration
ññ- C
.
ññC D
MAX_RETRIES
ññD O
;
ññO P
if
òò 

(
òò 
!
òò #
bypassExhaustionCheck
òò "
&&
òò# %
await
òò& +&
IsGloballyExhaustedAsync
òò, D
(
òòD E
)
òòE F
.
òòF G
ConfigureAwait
òòG U
(
òòU V
false
òòV [
)
òò[ \
)
òò\ ]
{
ôô 	
return
öö 
Result
öö 
<
öö 
	TResponse
öö #
,
öö# $
NetworkFailure
öö% 3
>
öö3 4
.
öö4 5
Err
öö5 8
(
öö8 9
NetworkFailure
õõ 
.
õõ %
DataCenterNotResponding
õõ 6
(
õõ6 7
$str
õõ7 h
)
õõh i
)
õõi j
;
õõj k
}
úú 	
DateTime
ûû  
operationStartTime
ûû #
=
ûû$ %
DateTime
ûû& .
.
ûû. /
UtcNow
ûû/ 5
;
ûû5 6
string
üü 
operationKey
üü 
=
üü  
CreateOperationKey
üü 0
(
üü0 1
operationName
üü1 >
,
üü> ?
actualConnectId
üü@ O
,
üüO P 
operationStartTime
üüQ c
)
üüc d
;
üüd e
try
°° 
{
¢¢ 	
IAsyncPolicy
££ 
<
££ 
Result
££ 
<
££  
	TResponse
££  )
,
££) *
NetworkFailure
££+ 9
>
££9 :
>
££: ;
retryPolicy
££< G
=
££H I$
CreateTypedRetryPolicy
§§ &
<
§§& '
	TResponse
§§' 0
>
§§0 1
(
§§1 2
actualMaxRetries
•• $
,
••$ %
operationKey
¶¶  
,
¶¶  !
operationName
ßß !
,
ßß! "
actualConnectId
®® #
,
®®# $
serviceType
©© 
,
©©  
cancellationToken
™™ %
)
™™% &
;
™™& '
Context
¨¨ 
context
¨¨ 
=
¨¨ 
new
¨¨ !
(
¨¨! "
operationName
¨¨" /
)
¨¨/ 0
{
¨¨1 2
[
¨¨3 4
ATTEMPT_KEY
¨¨4 ?
]
¨¨? @
=
¨¨A B
$num
¨¨C D
}
¨¨E F
;
¨¨F G
Result
ÆÆ 
<
ÆÆ 
	TResponse
ÆÆ 
,
ÆÆ 
NetworkFailure
ÆÆ ,
>
ÆÆ, -
result
ÆÆ. 4
=
ÆÆ5 6
await
ÆÆ7 <
retryPolicy
ÆÆ= H
.
ÆÆH I
ExecuteAsync
ÆÆI U
(
ÆÆU V
(
ØØ 
ctx
ØØ 
,
ØØ 
ct
ØØ 
)
ØØ 
=>
ØØ )
ExecuteOperationWithLogging
ØØ 8
(
ØØ8 9
ctx
ØØ9 <
,
ØØ< =
ct
ØØ> @
,
ØØ@ A
	operation
ØØB K
,
ØØK L
operationName
ØØM Z
)
ØØZ [
,
ØØ[ \
context
∞∞ 
,
∞∞ 
cancellationToken
±± !
)
±±! "
.
±±" #
ConfigureAwait
±±# 1
(
±±1 2
false
±±2 7
)
±±7 8
;
±±8 9
if
≥≥ 
(
≥≥ 
result
≥≥ 
.
≥≥ 
IsOk
≥≥ 
)
≥≥ 
{
¥¥ #
StopTrackingOperation
µµ %
(
µµ% &
operationKey
µµ& 2
,
µµ2 3
$str
µµ4 L
)
µµL M
;
µµM N
}
∂∂ 
else
∑∑ 
{
∏∏ 
Log
ππ 
.
ππ 
Warning
ππ 
(
ππ 
$str
∫∫ q
,
∫∫q r
operationName
ªª !
,
ªª! "
result
ªª# )
.
ªª) *
	UnwrapErr
ªª* 3
(
ªª3 4
)
ªª4 5
.
ªª5 6
Message
ªª6 =
)
ªª= >
;
ªª> ?
Log
ºº 
.
ºº 
Debug
ºº 
(
ºº 
$str
ºº v
,
ººv w
operationName
ΩΩ !
)
ΩΩ! "
;
ΩΩ" #
}
ææ 
return
¿¿ 
result
¿¿ 
;
¿¿ 
}
¡¡ 	
catch
¬¬ 
(
¬¬ (
OperationCanceledException
¬¬ )
)
¬¬) *
when
¬¬+ /
(
¬¬0 1
cancellationToken
¬¬1 B
.
¬¬B C%
IsCancellationRequested
¬¬C Z
)
¬¬Z [
{
√√ 	#
StopTrackingOperation
ƒƒ !
(
ƒƒ! "
operationKey
ƒƒ" .
,
ƒƒ. /
$str
ƒƒ0 E
)
ƒƒE F
;
ƒƒF G
return
≈≈ 
Result
≈≈ 
<
≈≈ 
	TResponse
≈≈ #
,
≈≈# $
NetworkFailure
≈≈% 3
>
≈≈3 4
.
≈≈4 5
Err
≈≈5 8
(
≈≈8 9
NetworkFailure
∆∆ 
.
∆∆  
OperationCancelled
∆∆ 1
(
∆∆1 2
$str
∆∆2 O
)
∆∆O P
)
∆∆P Q
;
∆∆Q R
}
«« 	
catch
»» 
(
»» 
	Exception
»» 
ex
»» 
)
»» 
{
…… 	
Log
   
.
   
Error
   
(
   
ex
   
,
   
$str
   k
,
  k l
operationName
ÀÀ 
)
ÀÀ 
;
ÀÀ #
StopTrackingOperation
ÃÃ !
(
ÃÃ! "
operationKey
ÃÃ" .
,
ÃÃ. /
$"
ÃÃ0 2
$str
ÃÃ2 D
{
ÃÃD E
ex
ÃÃE G
.
ÃÃG H
Message
ÃÃH O
}
ÃÃO P
"
ÃÃP Q
)
ÃÃQ R
;
ÃÃR S
return
ÕÕ 
Result
ÕÕ 
<
ÕÕ 
	TResponse
ÕÕ #
,
ÕÕ# $
NetworkFailure
ÕÕ% 3
>
ÕÕ3 4
.
ÕÕ4 5
Err
ÕÕ5 8
(
ÕÕ8 9
NetworkFailure
ŒŒ 
.
ŒŒ %
DataCenterNotResponding
ŒŒ 6
(
ŒŒ6 7
$"
ŒŒ7 9
$str
ŒŒ9 K
{
ŒŒK L
ex
ŒŒL N
.
ŒŒN O
Message
ŒŒO V
}
ŒŒV W
"
ŒŒW X
)
ŒŒX Y
)
ŒŒY Z
;
ŒŒZ [
}
œœ 	
}
–– 
public
““ 

void
““ #
MarkConnectionHealthy
““ %
(
““% &
uint
““& *
	connectId
““+ 4
)
““4 5
{
”” 
if
‘‘ 

(
‘‘ 
_isDisposed
‘‘ 
)
‘‘ 
{
’’ 	
throw
÷÷ 
new
÷÷ %
ObjectDisposedException
÷÷ -
(
÷÷- .
nameof
÷÷. 4
(
÷÷4 5
RetryStrategy
÷÷5 B
)
÷÷B C
)
÷÷C D
;
÷÷D E
}
◊◊ 	
Task
ŸŸ 
.
ŸŸ 
Run
ŸŸ 
(
ŸŸ 
async
ŸŸ 
(
ŸŸ 
)
ŸŸ 
=>
ŸŸ 
{
⁄⁄ 	
if
€€ 
(
€€ 
_isDisposed
€€ 
)
€€ 
{
‹‹ 
return
›› 
;
›› 
}
ﬁﬁ 
try
‡‡ 
{
·· 
await
‚‚ 

_stateLock
‚‚  
.
‚‚  !
	WaitAsync
‚‚! *
(
‚‚* +
)
‚‚+ ,
.
‚‚, -
ConfigureAwait
‚‚- ;
(
‚‚; <
false
‚‚< A
)
‚‚A B
;
‚‚B C
try
„„ 
{
‰‰ 
int
ÂÂ 

resetCount
ÂÂ "
=
ÂÂ# $
$num
ÂÂ% &
;
ÂÂ& '
foreach
ÊÊ 
(
ÊÊ  
RetryOperationInfo
ÊÊ /
	operation
ÊÊ0 9
in
ÊÊ: <$
_activeRetryOperations
ÊÊ= S
.
ÊÊS T
Values
ÊÊT Z
.
ÊÊZ [
ToArray
ÊÊ[ b
(
ÊÊb c
)
ÊÊc d
)
ÊÊd e
{
ÁÁ 
if
ËË 
(
ËË 
	operation
ËË %
.
ËË% &
	ConnectId
ËË& /
==
ËË0 2
	connectId
ËË3 <
&&
ËË= ?
	operation
ËË@ I
.
ËËI J
IsExhausted
ËËJ U
)
ËËU V
{
ÈÈ 
	operation
ÍÍ %
.
ÍÍ% &
IsExhausted
ÍÍ& 1
=
ÍÍ2 3
false
ÍÍ4 9
;
ÍÍ9 :
	operation
ÎÎ %
.
ÎÎ% &
CurrentRetryCount
ÎÎ& 7
=
ÎÎ8 9
$num
ÎÎ: ;
;
ÎÎ; <
Log
ÏÏ 
.
ÏÏ  
Information
ÏÏ  +
(
ÏÏ+ ,
$str
ÌÌ  
,ÌÌ Ä
	operation
ÓÓ  )
.
ÓÓ) *
OperationName
ÓÓ* 7
,
ÓÓ7 8
	connectId
ÓÓ9 B
)
ÓÓB C
;
ÓÓC D#
StopTrackingOperation
 1
(
1 2
	operation
2 ;
.
; <
	UniqueKey
< E
,
E F
$str
G \
)
\ ]
;
] ^

resetCount
ÒÒ &
++
ÒÒ& (
;
ÒÒ( )
}
ÚÚ 
}
ÛÛ 
if
ıı 
(
ıı 

resetCount
ıı "
>
ıı# $
$num
ıı% &
)
ıı& '
{
ˆˆ 
Log
˜˜ 
.
˜˜ 
Information
˜˜ '
(
˜˜' (
$str¯¯ Ñ
,¯¯Ñ Ö
	connectId
˘˘ %
,
˘˘% &

resetCount
˘˘' 1
)
˘˘1 2
;
˘˘2 3
}
˙˙ 
}
˚˚ 
finally
¸¸ 
{
˝˝ 

_stateLock
˛˛ 
.
˛˛ 
Release
˛˛ &
(
˛˛& '
)
˛˛' (
;
˛˛( )
}
ˇˇ 
}
ÄÄ 
catch
ÅÅ 
(
ÅÅ 
	Exception
ÅÅ 
ex
ÅÅ 
)
ÅÅ  
{
ÇÇ 
Log
ÉÉ 
.
ÉÉ 
Error
ÉÉ 
(
ÉÉ 
ex
ÉÉ 
,
ÉÉ 
$str
ÉÉ [
,
ÉÉ[ \
	connectId
ÉÉ] f
)
ÉÉf g
;
ÉÉg h
}
ÑÑ 
}
ÖÖ 	
)
ÖÖ	 

.
ÖÖ
 
ContinueWith
ÖÖ 
(
ÖÖ 
task
ÖÖ 
=>
ÖÖ 
{
ÜÜ 	
if
áá 
(
áá 
task
áá 
.
áá 
	IsFaulted
áá 
&&
áá !
task
áá" &
.
áá& '
	Exception
áá' 0
!=
áá1 3
null
áá4 8
)
áá8 9
{
àà 
Log
ââ 
.
ââ 
Error
ââ 
(
ââ 
task
ââ 
.
ââ 
	Exception
ââ (
.
ââ( )
GetBaseException
ââ) 9
(
ââ9 :
)
ââ: ;
,
ââ; <
$str
ää l
,
ääl m
	connectId
ãã 
)
ãã 
;
ãã 
}
åå 
}
çç 	
,
çç	 
%
TaskContinuationOptions
çç "
.
çç" #
OnlyOnFaulted
çç# 0
)
çç0 1
;
çç1 2
}
éé 
public
êê 

void
êê &
ClearExhaustedOperations
êê (
(
êê( )
)
êê) *
{
ëë 
if
íí 

(
íí 
_isDisposed
íí 
)
íí 
{
ìì 	
throw
îî 
new
îî %
ObjectDisposedException
îî -
(
îî- .
nameof
îî. 4
(
îî4 5
RetryStrategy
îî5 B
)
îîB C
)
îîC D
;
îîD E
}
ïï 	
try
óó 
{
òò 	
List
ôô 
<
ôô 
string
ôô 
>
ôô 
exhaustedKeys
ôô &
=
ôô' (
[
ôô) *
]
ôô* +
;
ôô+ ,
exhaustedKeys
öö 
.
öö 
AddRange
öö "
(
öö" #
from
öö# '
	operation
öö( 1
in
öö2 4$
_activeRetryOperations
öö5 K
.
ööK L
Values
ööL R
where
õõ# (
	operation
õõ) 2
.
õõ2 3
IsExhausted
õõ3 >
select
úú# )
	operation
úú* 3
.
úú3 4
	UniqueKey
úú4 =
)
úú= >
;
úú> ?
foreach
ûû 
(
ûû 
string
ûû 
key
ûû 
in
ûû  "
exhaustedKeys
ûû# 0
)
ûû0 1
{
üü 
if
†† 
(
†† $
_activeRetryOperations
†† *
.
††* +
	TryRemove
††+ 4
(
††4 5
key
††5 8
,
††8 9
out
††: = 
RetryOperationInfo
††> P
?
††P Q
	operation
††R [
)
††[ \
&&
††] _
Log
††` c
.
††c d
	IsEnabled
††d m
(
††m n
LogEventLevel
††n {
.
††{ |
Debug††| Å
)††Å Ç
)††Ç É
{
°° 
Log
¢¢ 
.
¢¢ 
Debug
¢¢ 
(
¢¢ 
$str
¢¢ g
,
¢¢g h
	operation
££ !
.
££! "
OperationName
££" /
)
££/ 0
;
££0 1
}
§§ 
}
•• 
if
ßß 
(
ßß 
exhaustedKeys
ßß 
.
ßß 
Count
ßß #
>
ßß$ %
$num
ßß& '
)
ßß' (
{
®® 
Log
©© 
.
©© 
Information
©© 
(
©©  
$str
©©  g
,
©©g h
exhaustedKeys
™™ !
.
™™! "
Count
™™" '
)
™™' (
;
™™( )
}
´´ 
}
¨¨ 	
catch
≠≠ 
(
≠≠ 
	Exception
≠≠ 
ex
≠≠ 
)
≠≠ 
{
ÆÆ 	
Log
ØØ 
.
ØØ 
Error
ØØ 
(
ØØ 
ex
ØØ 
,
ØØ 
$str
ØØ @
)
ØØ@ A
;
ØØA B
}
∞∞ 	
}
±± 
private
≥≥ 
async
≥≥ 
Task
≥≥ 
<
≥≥ 
bool
≥≥ 
>
≥≥ &
IsGloballyExhaustedAsync
≥≥ 5
(
≥≥5 6
RpcServiceType
≥≥6 D
?
≥≥D E
serviceType
≥≥F Q
=
≥≥R S
null
≥≥T X
)
≥≥X Y
{
¥¥ 
if
µµ 

(
µµ $
_activeRetryOperations
µµ "
.
µµ" #
IsEmpty
µµ# *
)
µµ* +
{
∂∂ 	
return
∑∑ 
false
∑∑ 
;
∑∑ 
}
∏∏ 	
await
∫∫ 

_stateLock
∫∫ 
.
∫∫ 
	WaitAsync
∫∫ "
(
∫∫" #
)
∫∫# $
.
∫∫$ %
ConfigureAwait
∫∫% 3
(
∫∫3 4
false
∫∫4 9
)
∫∫9 :
;
∫∫: ;
try
ªª 
{
ºº 	
bool
ΩΩ (
hasAnyOperationsForService
ΩΩ +
=
ΩΩ, -
false
ΩΩ. 3
;
ΩΩ3 4
foreach
ææ 
(
ææ  
RetryOperationInfo
ææ '
	operation
ææ( 1
in
ææ2 4$
_activeRetryOperations
ææ5 K
.
ææK L
Values
ææL R
.
ææR S
ToArray
ææS Z
(
ææZ [
)
ææ[ \
)
ææ\ ]
{
øø 
if
¿¿ 
(
¿¿ 
serviceType
¿¿ 
.
¿¿  
HasValue
¿¿  (
&&
¿¿) +
	operation
¿¿, 5
.
¿¿5 6
ServiceType
¿¿6 A
!=
¿¿B D
serviceType
¿¿E P
.
¿¿P Q
Value
¿¿Q V
)
¿¿V W
{
¡¡ 
continue
¬¬ 
;
¬¬ 
}
√√ (
hasAnyOperationsForService
≈≈ *
=
≈≈+ ,
true
≈≈- 1
;
≈≈1 2
if
∆∆ 
(
∆∆ 
!
∆∆ 
	operation
∆∆ 
.
∆∆ 
IsExhausted
∆∆ *
)
∆∆* +
{
«« 
return
»» 
false
»»  
;
»»  !
}
…… 
}
   
return
ÃÃ (
hasAnyOperationsForService
ÃÃ -
;
ÃÃ- .
}
ÕÕ 	
finally
ŒŒ 
{
œœ 	

_stateLock
–– 
.
–– 
Release
–– 
(
–– 
)
––  
;
––  !
}
—— 	
}
““ 
private
‘‘ 
async
‘‘ 
Task
‘‘ +
HandleManualRetryRequestAsync
‘‘ 4
(
‘‘4 5'
ManualRetryRequestedEvent
‘‘5 N
evt
‘‘O R
)
‘‘R S
{
’’ 
if
÷÷ 

(
÷÷ 
_isDisposed
÷÷ 
)
÷÷ 
{
◊◊ 	
return
ÿÿ 
;
ÿÿ 
}
ŸŸ 	
try
€€ 
{
‹‹ 	&
ClearExhaustedOperations
›› $
(
››$ %
)
››% &
;
››& '
NetworkProvider
ﬂﬂ 
networkProvider
ﬂﬂ +
=
ﬂﬂ, - 
GetNetworkProvider
ﬂﬂ. @
(
ﬂﬂ@ A
)
ﬂﬂA B
;
ﬂﬂB C
Result
‡‡ 
<
‡‡ 
Unit
‡‡ 
,
‡‡ 
NetworkFailure
‡‡ '
>
‡‡' (
retryResult
‡‡) 4
=
‡‡5 6
await
·· 
networkProvider
·· %
.
··% &'
ForceFreshConnectionAsync
··& ?
(
··? @
)
··@ A
.
··A B
ConfigureAwait
··B P
(
··P Q
false
··Q V
)
··V W
;
··W X
if
„„ 
(
„„ 
retryResult
„„ 
.
„„ 
IsOk
„„  
)
„„  !
{
‰‰ 
Log
ÂÂ 
.
ÂÂ 
Information
ÂÂ 
(
ÂÂ  
$str
ÂÂ  S
)
ÂÂS T
;
ÂÂT U&
NotifyConnectionRestored
ÊÊ (
(
ÊÊ( )
evt
ÊÊ) ,
.
ÊÊ, -
	ConnectId
ÊÊ- 6
)
ÊÊ6 7
;
ÊÊ7 8
}
ÁÁ 
else
ËË 
{
ÈÈ 
NetworkFailure
ÍÍ 
failure
ÍÍ &
=
ÍÍ' (
retryResult
ÍÍ) 4
.
ÍÍ4 5
	UnwrapErr
ÍÍ5 >
(
ÍÍ> ?
)
ÍÍ? @
;
ÍÍ@ A
Log
ÎÎ 
.
ÎÎ 
Warning
ÎÎ 
(
ÎÎ 
$str
ÎÎ Q
,
ÎÎQ R
failure
ÎÎS Z
.
ÎÎZ [
Message
ÎÎ[ b
)
ÎÎb c
;
ÎÎc d$
NotifyConnectionFailed
ÏÏ &
(
ÏÏ& '
failure
ÏÏ' .
,
ÏÏ. /
evt
ÏÏ0 3
.
ÏÏ3 4
	ConnectId
ÏÏ4 =
)
ÏÏ= >
;
ÏÏ> ?
}
ÌÌ 
}
ÓÓ 	
catch
ÔÔ 
(
ÔÔ 
	Exception
ÔÔ 
ex
ÔÔ 
)
ÔÔ 
{
 	
Log
ÒÒ 
.
ÒÒ 
Error
ÒÒ 
(
ÒÒ 
ex
ÒÒ 
,
ÒÒ 
$str
ÒÒ X
)
ÒÒX Y
;
ÒÒY Z
}
ÚÚ 	
}
ÛÛ 
private
ıı 
void
ıı &
NotifyConnectionRestored
ıı )
(
ıı) *
uint
ıı* .
?
ıı. /
	connectId
ıı0 9
)
ıı9 :
{
ˆˆ 

Dispatcher
˜˜ 
.
˜˜ 
UIThread
˜˜ 
.
˜˜ 
Post
˜˜  
(
˜˜  !
(
˜˜! "
)
˜˜" #
=>
˜˜$ &
{
¯¯ 	
try
˘˘ 
{
˙˙ 
_
˚˚ 
=
˚˚ "
_connectivityService
˚˚ (
.
˚˚( )
PublishAsync
˚˚) 5
(
˚˚5 6 
ConnectivityIntent
¸¸ &
.
¸¸& '
	Connected
¸¸' 0
(
¸¸0 1
	connectId
˝˝ !
,
˝˝! " 
ConnectivityReason
˛˛ *
.
˛˛* +
ManualRetry
˛˛+ 6
)
˛˛6 7
)
˛˛7 8
.
˛˛8 9
ContinueWith
˛˛9 E
(
˛˛E F
task
ˇˇ 
=>
ˇˇ 
{
ÄÄ 
if
ÅÅ 
(
ÅÅ 
task
ÅÅ  
.
ÅÅ  !
	IsFaulted
ÅÅ! *
&&
ÅÅ+ -
task
ÅÅ. 2
.
ÅÅ2 3
	Exception
ÅÅ3 <
!=
ÅÅ= ?
null
ÅÅ@ D
)
ÅÅD E
{
ÇÇ 
Log
ÉÉ 
.
ÉÉ  
Error
ÉÉ  %
(
ÉÉ% &
task
ÉÉ& *
.
ÉÉ* +
	Exception
ÉÉ+ 4
,
ÉÉ4 5
$str
ÉÉ6 j
)
ÉÉj k
;
ÉÉk l
}
ÑÑ 
}
ÖÖ 
,
ÖÖ 
TaskScheduler
ÜÜ !
.
ÜÜ! "
Default
ÜÜ" )
)
ÜÜ) *
;
ÜÜ* +
}
áá 
catch
àà 
(
àà 
	Exception
àà 
ex
àà 
)
àà  
{
ââ 
Log
ää 
.
ää 
Error
ää 
(
ää 
ex
ää 
,
ää 
$str
ää P
)
ääP Q
;
ääQ R
}
ãã 
}
åå 	
)
åå	 

;
åå
 
}
çç 
private
èè 
void
èè $
NotifyConnectionFailed
èè '
(
èè' (
NetworkFailure
èè( 6
failure
èè7 >
,
èè> ?
uint
èè@ D
?
èèD E
	connectId
èèF O
)
èèO P
{
êê 

Dispatcher
ëë 
.
ëë 
UIThread
ëë 
.
ëë 
Post
ëë  
(
ëë  !
(
ëë! "
)
ëë" #
=>
ëë$ &
{
íí 	
try
ìì 
{
îî 
_
ïï 
=
ïï "
_connectivityService
ïï (
.
ïï( )
PublishAsync
ïï) 5
(
ïï5 6 
ConnectivityIntent
ññ &
.
ññ& '
Disconnected
ññ' 3
(
ññ3 4
failure
ññ4 ;
,
ññ; <
	connectId
ññ= F
)
ññF G
)
ññG H
.
ññH I
ContinueWith
ññI U
(
ññU V
task
óó 
=>
óó 
{
òò 
if
ôô 
(
ôô 
task
ôô  
.
ôô  !
	IsFaulted
ôô! *
&&
ôô+ -
task
ôô. 2
.
ôô2 3
	Exception
ôô3 <
!=
ôô= ?
null
ôô@ D
)
ôôD E
{
öö 
Log
õõ 
.
õõ  
Error
õõ  %
(
õõ% &
task
õõ& *
.
õõ* +
	Exception
õõ+ 4
,
õõ4 5
$str
õõ6 i
)
õõi j
;
õõj k
}
úú 
}
ùù 
,
ùù 
TaskScheduler
ûû !
.
ûû! "
Default
ûû" )
)
ûû) *
;
ûû* +
}
üü 
catch
†† 
(
†† 
	Exception
†† 
ex
†† 
)
††  
{
°° 
Log
¢¢ 
.
¢¢ 
Error
¢¢ 
(
¢¢ 
ex
¢¢ 
,
¢¢ 
$str
¢¢ I
)
¢¢I J
;
¢¢J K
}
££ 
}
§§ 	
)
§§	 

;
§§
 
}
•• 
private
ßß 
void
ßß $
StartTrackingOperation
ßß '
(
ßß' (
string
ßß( .
operationName
ßß/ <
,
ßß< =
uint
ßß> B
	connectId
ßßC L
,
ßßL M
int
ßßN Q

maxRetries
ßßR \
,
ßß\ ]
string
ßß^ d
operationKey
ßße q
,
ßßq r
RpcServiceType
®® 
?
®® 
serviceType
®® #
)
®®# $
{
©© 
if
™™ 

(
™™ $
_activeRetryOperations
™™ "
.
™™" #
Count
™™# (
>=
™™) +$
MAX_TRACKED_OPERATIONS
™™, B
)
™™B C
{
´´ 	
Log
¨¨ 
.
¨¨ 
Warning
¨¨ 
(
¨¨ 
$str
¨¨ p
,
¨¨p q$
MAX_TRACKED_OPERATIONS
≠≠ &
)
≠≠& '
;
≠≠' ((
CleanupAbandonedOperations
ÆÆ &
(
ÆÆ& '
null
ÆÆ' +
)
ÆÆ+ ,
;
ÆÆ, -
}
ØØ 	 
RetryOperationInfo
±± 
operationInfo
±± (
=
±±) *
new
±±+ .
(
±±. /
)
±±/ 0
{
≤≤ 	
OperationName
≥≥ 
=
≥≥ 
operationName
≥≥ )
,
≥≥) *
	ConnectId
¥¥ 
=
¥¥ 
	connectId
¥¥ !
,
¥¥! "
	StartTime
µµ 
=
µµ 
DateTime
µµ  
.
µµ  !
UtcNow
µµ! '
,
µµ' (
MAX_RETRIES
∂∂ 
=
∂∂ 

maxRetries
∂∂ $
,
∂∂$ %
	UniqueKey
∑∑ 
=
∑∑ 
operationKey
∑∑ $
,
∑∑$ %
ServiceType
∏∏ 
=
∏∏ 
serviceType
∏∏ %
,
∏∏% &
CurrentRetryCount
ππ 
=
ππ 
$num
ππ  !
,
ππ! "
IsExhausted
∫∫ 
=
∫∫ 
false
∫∫ 
}
ªª 	
;
ªª	 
$
_activeRetryOperations
ΩΩ 
.
ΩΩ 
TryAdd
ΩΩ %
(
ΩΩ% &
operationKey
ΩΩ& 2
,
ΩΩ2 3
operationInfo
ΩΩ4 A
)
ΩΩA B
;
ΩΩB C
Log
ææ 
.
ææ 
Debug
ææ 
(
ææ 
$strøø ™
,øø™ ´
operationName
¿¿ 
,
¿¿ 
serviceType
¿¿ &
?
¿¿& '
.
¿¿' (
ToString
¿¿( 0
(
¿¿0 1
)
¿¿1 2
??
¿¿3 5
$str
¿¿6 ?
,
¿¿? @
	connectId
¿¿A J
,
¿¿J K
operationKey
¿¿L X
,
¿¿X Y$
_activeRetryOperations
¿¿Z p
.
¿¿p q
Count
¿¿q v
)
¿¿v w
;
¿¿w x
}
¡¡ 
private
√√ 
void
√√ '
UpdateOperationRetryCount
√√ *
(
√√* +
string
√√+ 1
operationKey
√√2 >
,
√√> ?
int
√√@ C

retryCount
√√D N
)
√√N O
{
ƒƒ 
if
≈≈ 

(
≈≈ $
_activeRetryOperations
≈≈ "
.
≈≈" #
TryGetValue
≈≈# .
(
≈≈. /
operationKey
≈≈/ ;
,
≈≈; <
out
≈≈= @ 
RetryOperationInfo
≈≈A S
?
≈≈S T
	operation
≈≈U ^
)
≈≈^ _
)
≈≈_ `
{
∆∆ 	
	operation
«« 
.
«« 
CurrentRetryCount
«« '
=
««( )

retryCount
««* 4
;
««4 5
Log
»» 
.
»» 
Debug
»» 
(
»» 
$str
»» i
,
»»i j
operationKey
…… 
,
…… 

retryCount
…… (
,
……( )
	operation
……* 3
.
……3 4
MAX_RETRIES
……4 ?
)
……? @
;
……@ A
}
   	
}
ÀÀ 
private
ÕÕ 
void
ÕÕ #
StopTrackingOperation
ÕÕ &
(
ÕÕ& '
string
ÕÕ' -
operationKey
ÕÕ. :
,
ÕÕ: ;
string
ÕÕ< B
reason
ÕÕC I
)
ÕÕI J
{
ŒŒ 
if
œœ 

(
œœ $
_activeRetryOperations
œœ "
.
œœ" #
	TryRemove
œœ# ,
(
œœ, -
operationKey
œœ- 9
,
œœ9 :
out
œœ; > 
RetryOperationInfo
œœ? Q
?
œœQ R
	operation
œœS \
)
œœ\ ]
)
œœ] ^
{
–– 	
Log
—— 
.
—— 
Debug
—— 
(
—— 
$str““ ò
,““ò ô
	operation
”” 
.
”” 
OperationName
”” '
,
””' (
	operation
””) 2
.
””2 3
	ConnectId
””3 <
,
””< =
reason
””> D
,
””D E$
_activeRetryOperations
””F \
.
””\ ]
Count
””] b
)
””b c
;
””c d
}
‘‘ 	
}
’’ 
private
◊◊ 
void
◊◊ &
MarkOperationAsExhausted
◊◊ )
(
◊◊) *
string
◊◊* 0
operationKey
◊◊1 =
)
◊◊= >
{
ÿÿ 
if
ŸŸ 

(
ŸŸ $
_activeRetryOperations
ŸŸ "
.
ŸŸ" #
TryGetValue
ŸŸ# .
(
ŸŸ. /
operationKey
ŸŸ/ ;
,
ŸŸ; <
out
ŸŸ= @ 
RetryOperationInfo
ŸŸA S
?
ŸŸS T
	operation
ŸŸU ^
)
ŸŸ^ _
)
ŸŸ_ `
{
⁄⁄ 	
	operation
€€ 
.
€€ 
IsExhausted
€€ !
=
€€" #
true
€€$ (
;
€€( )
Log
‹‹ 
.
‹‹ 
Debug
‹‹ 
(
‹‹ 
$str
›› r
,
››r s
	operation
ﬁﬁ 
.
ﬁﬁ 
OperationName
ﬁﬁ '
,
ﬁﬁ' (
	operation
ﬁﬁ) 2
.
ﬁﬁ2 3
	ConnectId
ﬁﬁ3 <
,
ﬁﬁ< =
operationKey
ﬁﬁ> J
)
ﬁﬁJ K
;
ﬁﬁK L
}
ﬂﬂ 	
}
‡‡ 
private
‚‚ 
void
‚‚ (
CleanupAbandonedOperations
‚‚ +
(
‚‚+ ,
object
‚‚, 2
?
‚‚2 3
state
‚‚4 9
)
‚‚9 :
{
„„ 
if
‰‰ 

(
‰‰ 
_isDisposed
‰‰ 
)
‰‰ 
{
ÂÂ 	
return
ÊÊ 
;
ÊÊ 
}
ÁÁ 	
try
ÈÈ 
{
ÍÍ 	
DateTime
ÎÎ 
cutoff
ÎÎ 
=
ÎÎ 
DateTime
ÎÎ &
.
ÎÎ& '
UtcNow
ÎÎ' -
.
ÎÎ- .

AddMinutes
ÎÎ. 8
(
ÎÎ8 9
-
ÎÎ9 :'
OPERATION_TIMEOUT_MINUTES
ÎÎ: S
)
ÎÎS T
;
ÎÎT U
List
ÏÏ 
<
ÏÏ 
string
ÏÏ 
>
ÏÏ 
abandonedKeys
ÏÏ &
=
ÏÏ' (
new
ÏÏ) ,
(
ÏÏ, -
)
ÏÏ- .
;
ÏÏ. /
foreach
ÌÌ 
(
ÌÌ  
RetryOperationInfo
ÌÌ '
	operation
ÌÌ( 1
in
ÌÌ2 4$
_activeRetryOperations
ÌÌ5 K
.
ÌÌK L
Values
ÌÌL R
.
ÌÌR S
ToArray
ÌÌS Z
(
ÌÌZ [
)
ÌÌ[ \
)
ÌÌ\ ]
{
ÓÓ 
if
ÔÔ 
(
ÔÔ 
	operation
ÔÔ 
.
ÔÔ 
	StartTime
ÔÔ '
<
ÔÔ( )
cutoff
ÔÔ* 0
)
ÔÔ0 1
{
 
abandonedKeys
ÒÒ !
.
ÒÒ! "
Add
ÒÒ" %
(
ÒÒ% &
	operation
ÒÒ& /
.
ÒÒ/ 0
	UniqueKey
ÒÒ0 9
)
ÒÒ9 :
;
ÒÒ: ;
}
ÚÚ 
}
ÛÛ 
foreach
ıı 
(
ıı 
string
ıı 
key
ıı 
in
ıı  "
abandonedKeys
ıı# 0
)
ıı0 1
{
ˆˆ 
if
˜˜ 
(
˜˜ $
_activeRetryOperations
˜˜ *
.
˜˜* +
	TryRemove
˜˜+ 4
(
˜˜4 5
key
˜˜5 8
,
˜˜8 9
out
˜˜: = 
RetryOperationInfo
˜˜> P
?
˜˜P Q
	operation
˜˜R [
)
˜˜[ \
&&
˜˜] _
Serilog
˜˜` g
.
˜˜g h
Log
˜˜h k
.
˜˜k l
	IsEnabled
˜˜l u
(
˜˜u v
LogEventLevel˜˜v É
.˜˜É Ñ
Debug˜˜Ñ â
)˜˜â ä
)˜˜ä ã
{
¯¯ 
Log
˘˘ 
.
˘˘ 
Debug
˘˘ 
(
˘˘ 
$str
˘˘ o
,
˘˘o p
	operation
˙˙ !
.
˙˙! "
OperationName
˙˙" /
,
˙˙/ 0'
OPERATION_TIMEOUT_MINUTES
˙˙1 J
)
˙˙J K
;
˙˙K L
}
˚˚ 
}
¸¸ 
if
˛˛ 
(
˛˛ 
abandonedKeys
˛˛ 
.
˛˛ 
Count
˛˛ #
>
˛˛$ %
$num
˛˛& '
)
˛˛' (
{
ˇˇ 
Log
ÄÄ 
.
ÄÄ 
Information
ÄÄ 
(
ÄÄ  
$str
ÄÄ  `
,
ÄÄ` a
abandonedKeys
ÄÄb o
.
ÄÄo p
Count
ÄÄp u
)
ÄÄu v
;
ÄÄv w
}
ÅÅ 
}
ÇÇ 	
catch
ÉÉ 
(
ÉÉ 
	Exception
ÉÉ 
ex
ÉÉ 
)
ÉÉ 
{
ÑÑ 	
Log
ÖÖ 
.
ÖÖ 
Error
ÖÖ 
(
ÖÖ 
ex
ÖÖ 
,
ÖÖ 
$str
ÖÖ :
)
ÖÖ: ;
;
ÖÖ; <
}
ÜÜ 	
}
áá 
private
ââ 
string
ââ "
CreateDelaysCacheKey
ââ '
(
ââ' (
int
ââ( +

maxRetries
ââ, 6
)
ââ6 7
{
ää 
return
ãã 
$"
ãã 
$str
ãã 
{
ãã 

maxRetries
ãã #
}
ãã# $
"
ãã$ %
;
ãã% &
}
åå 
private
éé 
TimeSpan
éé 
[
éé 
]
éé $
GetOrCreateRetryDelays
éé -
(
éé- .
int
éé. 1

maxRetries
éé2 <
)
éé< =
{
èè 
string
êê 
cacheKey
êê 
=
êê "
CreateDelaysCacheKey
êê .
(
êê. /

maxRetries
êê/ 9
)
êê9 :
;
êê: ;
if
íí 

(
íí 
_pipelineCache
íí 
.
íí 
TryGetValue
íí &
(
íí& '
cacheKey
íí' /
,
íí/ 0
out
íí1 4
object
íí5 ;
?
íí; <
cachedDelays
íí= I
)
ííI J
&&
ííK M
cachedDelays
ííN Z
is
íí[ ]
TimeSpan
íí^ f
[
ííf g
]
ííg h
delays
ííi o
)
íío p
{
ìì 	
if
îî 
(
îî 
Log
îî 
.
îî 
	IsEnabled
îî 
(
îî 
LogEventLevel
îî +
.
îî+ ,
Debug
îî, 1
)
îî1 2
)
îî2 3
{
ïï 
Log
ññ 
.
ññ 
Debug
ññ 
(
ññ 
$str
ññ i
,
ññi j

maxRetries
óó 
)
óó 
;
óó  
}
òò 
return
öö 
delays
öö 
;
öö 
}
õõ 	
if
ùù 

(
ùù 
Log
ùù 
.
ùù 
	IsEnabled
ùù 
(
ùù 
LogEventLevel
ùù '
.
ùù' (
Debug
ùù( -
)
ùù- .
)
ùù. /
{
ûû 	
Log
üü 
.
üü 
Debug
üü 
(
üü 
$str
üü h
,
üüh i

maxRetries
†† 
)
†† 
;
†† 
}
°° 	
TimeSpan
££ 
	baseDelay
££ 
=
££ $
_strategyConfiguration
££ 3
.
££3 4!
INITIAL_RETRY_DELAY
££4 G
;
££G H
TimeSpan
§§ 
maxDelay
§§ 
=
§§ $
_strategyConfiguration
§§ 2
.
§§2 3
MAX_RETRY_DELAY
§§3 B
;
§§B C
bool
•• 
	useJitter
•• 
=
•• $
_strategyConfiguration
•• /
.
••/ 0 
USE_ADAPTIVE_RETRY
••0 B
;
••B C
IEnumerable
ßß 
<
ßß 
TimeSpan
ßß 
>
ßß 
	rawDelays
ßß '
=
ßß( )
	useJitter
ßß* 3
?
®® 
Backoff
®® 
.
®® )
DecorrelatedJitterBackoffV2
®® 1
(
®®1 2#
medianFirstRetryDelay
©© %
:
©©% &
	baseDelay
©©' 0
,
©©0 1

retryCount
™™ 
:
™™ 

maxRetries
™™ &
,
™™& '
	fastFirst
´´ 
:
´´ 
true
´´ 
)
´´  
:
¨¨ 
Backoff
¨¨ 
.
¨¨  
ExponentialBackoff
¨¨ (
(
¨¨( )
initialDelay
≠≠ 
:
≠≠ 
	baseDelay
≠≠ '
,
≠≠' (

retryCount
ÆÆ 
:
ÆÆ 

maxRetries
ÆÆ &
,
ÆÆ& '
factor
ØØ 
:
ØØ 
$num
ØØ 
,
ØØ 
	fastFirst
∞∞ 
:
∞∞ 
true
∞∞ 
)
∞∞  
;
∞∞  !
TimeSpan
≤≤ 
[
≤≤ 
]
≤≤ 
retryDelays
≤≤ 
=
≤≤  
	rawDelays
≤≤! *
.
≤≤* +
Select
≤≤+ 1
(
≤≤1 2
delay
≤≤2 7
=>
≤≤8 :
delay
≥≥ 
>
≥≥ 
maxDelay
≥≥ 
?
≥≥ 
maxDelay
≥≥ '
:
≥≥( )
delay
≥≥* /
)
≥≥/ 0
.
≥≥0 1
ToArray
≥≥1 8
(
≥≥8 9
)
≥≥9 :
;
≥≥: ;
_pipelineCache
µµ 
.
µµ 
TryAdd
µµ 
(
µµ 
cacheKey
µµ &
,
µµ& '
retryDelays
µµ( 3
)
µµ3 4
;
µµ4 5
return
∑∑ 
retryDelays
∑∑ 
;
∑∑ 
}
∏∏ 
private
∫∫ 
IAsyncPolicy
∫∫ 
<
∫∫ 
Result
∫∫ 
<
∫∫  
	TResponse
∫∫  )
,
∫∫) *
NetworkFailure
∫∫+ 9
>
∫∫9 :
>
∫∫: ;$
CreateTypedRetryPolicy
∫∫< R
<
∫∫R S
	TResponse
∫∫S \
>
∫∫\ ]
(
∫∫] ^
int
ªª 

maxRetries
ªª 
,
ªª 
string
ºº 
operationKey
ºº 
,
ºº 
string
ΩΩ 
operationName
ΩΩ 
,
ΩΩ 
uint
ææ 
	connectId
ææ 
,
ææ 
RpcServiceType
øø 
?
øø 
serviceType
øø #
,
øø# $
CancellationToken
¿¿ 
cancellationToken
¿¿ +
)
¿¿+ ,
{
¡¡ 
TimeSpan
¬¬ 
[
¬¬ 
]
¬¬ 
retryDelays
¬¬ 
=
¬¬  $
GetOrCreateRetryDelays
¬¬! 7
(
¬¬7 8

maxRetries
¬¬8 B
)
¬¬B C
;
¬¬C D!
ShouldRetryDelegate
ƒƒ 
<
ƒƒ 
	TResponse
ƒƒ %
>
ƒƒ% &!
shouldRetryDelegate
≈≈ 
=
≈≈  !"
RetryDecisionFactory
≈≈" 6
.
≈≈6 7'
CreateShouldRetryDelegate
≈≈7 P
<
≈≈P Q
	TResponse
≈≈Q Z
>
≈≈Z [
(
≈≈[ \
)
≈≈\ ]
;
≈≈] ^0
"RequiresConnectionRecoveryDelegate
∆∆ *
<
∆∆* +
	TResponse
∆∆+ 4
>
∆∆4 5(
connectionRecoveryDelegate
∆∆6 P
=
∆∆Q R"
RetryDecisionFactory
««  
.
««  !.
 CreateConnectionRecoveryDelegate
««! A
<
««A B
	TResponse
««B K
>
««K L
(
««L M
)
««M N
;
««N O
IAsyncPolicy
…… 
<
…… 
Result
…… 
<
…… 
	TResponse
…… %
,
……% &
NetworkFailure
……' 5
>
……5 6
>
……6 7
retryPolicy
……8 C
=
……D E
Policy
……F L
<
……L M
Result
……M S
<
……S T
	TResponse
……T ]
,
……] ^
NetworkFailure
……_ m
>
……m n
>
……n o
.
   
Handle
   
<
   &
TimeoutRejectedException
   ,
>
  , -
(
  - .
)
  . /
.
ÀÀ 
OrResult
ÀÀ 
(
ÀÀ 
result
ÀÀ 
=>
ÀÀ !
shouldRetryDelegate
ÀÀ  3
(
ÀÀ3 4
result
ÀÀ4 :
)
ÀÀ: ;
)
ÀÀ; <
.
ÃÃ 
WaitAndRetryAsync
ÃÃ 
(
ÃÃ 
retryDelays
ÕÕ 
,
ÕÕ 
async
ŒŒ 
(
ŒŒ 
outcome
ŒŒ 
,
ŒŒ 
delay
ŒŒ  %
,
ŒŒ% &

retryCount
ŒŒ' 1
,
ŒŒ1 2
context
ŒŒ3 :
)
ŒŒ: ;
=>
ŒŒ< >
{
œœ 
context
–– 
[
–– 
ATTEMPT_KEY
–– '
]
––' (
=
––) *

retryCount
––+ 5
+
––6 7
$num
––8 9
;
––9 :
bool
““ 
	isTimeout
““ "
=
““# $
outcome
““% ,
.
““, -
	Exception
““- 6
is
““7 9&
TimeoutRejectedException
““: R
;
““R S
bool
”” 
	hasResult
”” "
=
””# $
outcome
””% ,
.
””, -
	Exception
””- 6
is
””7 9
null
””: >
;
””> ?
Result
‘‘ 
<
‘‘ 
	TResponse
‘‘ $
,
‘‘$ %
NetworkFailure
‘‘& 4
>
‘‘4 5
result
‘‘6 <
=
‘‘= >
	hasResult
‘‘? H
?
‘‘I J
outcome
‘‘K R
.
‘‘R S
Result
‘‘S Y
:
‘‘Z [
default
‘‘\ c
;
‘‘c d
LogRetryAttempt
÷÷ #
(
÷÷# $
	isTimeout
÷÷$ -
,
÷÷- .
operationName
÷÷/ <
,
÷÷< =
	connectId
÷÷> G
,
÷÷G H

retryCount
÷÷I S
,
÷÷S T
retryDelays
÷÷U `
.
÷÷` a
Length
÷÷a g
,
÷÷g h
delay
÷÷i n
)
÷÷n o
;
÷÷o p!
TrackRetryOperation
ÿÿ '
(
ÿÿ' (

retryCount
ÿÿ( 2
,
ÿÿ2 3
operationName
ÿÿ4 A
,
ÿÿA B
	connectId
ÿÿC L
,
ÿÿL M
retryDelays
ÿÿN Y
.
ÿÿY Z
Length
ÿÿZ `
,
ÿÿ` a
operationKey
ÿÿb n
,
ÿÿn o
serviceType
ÿÿp {
)
ÿÿ{ |
;
ÿÿ| }
NetworkFailure
⁄⁄ "
?
⁄⁄" #
currentFailure
⁄⁄$ 2
=
⁄⁄3 4#
ExtractCurrentFailure
⁄⁄5 J
(
⁄⁄J K
	isTimeout
⁄⁄K T
,
⁄⁄T U
	hasResult
⁄⁄V _
,
⁄⁄_ `
result
⁄⁄a g
)
⁄⁄g h
;
⁄⁄h i
await
‹‹ "
_connectivityService
‹‹ .
.
‹‹. /
PublishAsync
‹‹/ ;
(
‹‹; < 
ConnectivityIntent
›› .
.
››. /

Recovering
››/ 9
(
››9 :
currentFailure
ﬁﬁ  .
??
ﬁﬁ/ 1
NetworkFailure
ﬁﬁ2 @
.
ﬁﬁ@ A%
DataCenterNotResponding
ﬁﬁA X
(
ﬁﬁX Y
$str
ﬁﬁY m
)
ﬁﬁm n
,
ﬁﬁn o
	connectId
ﬂﬂ  )
,
ﬂﬂ) *

retryCount
ﬂﬂ+ 5
+
ﬂﬂ6 7
$num
ﬂﬂ8 9
,
ﬂﬂ9 :
delay
ﬂﬂ; @
)
ﬂﬂ@ A
)
ﬂﬂA B
.
‡‡ 
ConfigureAwait
‡‡ '
(
‡‡' (
false
‡‡( -
)
‡‡- .
;
‡‡. /
if
‚‚ 
(
‚‚ 

retryCount
‚‚ "
==
‚‚# %
retryDelays
‚‚& 1
.
‚‚1 2
Length
‚‚2 8
)
‚‚8 9
{
„„ 
await
‰‰ )
HandleRetriesExhaustedAsync
‰‰ 9
(
‰‰9 :
operationKey
ÂÂ (
,
ÂÂ( )
operationName
ÂÂ* 7
,
ÂÂ7 8
	connectId
ÂÂ9 B
,
ÂÂB C

retryCount
ÂÂD N
,
ÂÂN O
retryDelays
ÂÂP [
.
ÂÂ[ \
Length
ÂÂ\ b
,
ÂÂb c
currentFailure
ÂÂd r
)
ÂÂr s
.
ÊÊ 
ConfigureAwait
ÊÊ +
(
ÊÊ+ ,
false
ÊÊ, 1
)
ÊÊ1 2
;
ÊÊ2 3
}
ÁÁ 
bool
ÈÈ 
requiresRecovery
ÈÈ )
=
ÈÈ* +)
DetermineIfRecoveryRequired
ÈÈ, G
(
ÈÈG H
	isTimeout
ÈÈH Q
,
ÈÈQ R
	hasResult
ÈÈS \
,
ÈÈ\ ]
result
ÈÈ^ d
,
ÈÈd e)
connectionRecoveryDelegateÈÈf Ä
)ÈÈÄ Å
;ÈÈÅ Ç
if
ÎÎ 
(
ÎÎ 
requiresRecovery
ÎÎ (
&&
ÎÎ) +
!
ÎÎ, -
_isDisposed
ÎÎ- 8
&&
ÎÎ9 ;
!
ÎÎ< =
cancellationToken
ÎÎ= N
.
ÎÎN O%
IsCancellationRequested
ÎÎO f
)
ÎÎf g
{
ÏÏ 
await
ÌÌ '
EnsureSecrecyChannelAsync
ÌÌ 7
(
ÌÌ7 8
	connectId
ÌÌ8 A
,
ÌÌA B
cancellationToken
ÌÌC T
)
ÌÌT U
.
ÌÌU V
ConfigureAwait
ÌÌV d
(
ÌÌd e
false
ÌÌe j
)
ÌÌj k
;
ÌÌk l
}
ÓÓ 
}
ÔÔ 
)
ÔÔ 
;
ÔÔ 
IAsyncPolicy
ÒÒ 
<
ÒÒ 
Result
ÒÒ 
<
ÒÒ 
	TResponse
ÒÒ %
,
ÒÒ% &
NetworkFailure
ÒÒ' 5
>
ÒÒ5 6
>
ÒÒ6 7
timeoutPolicy
ÒÒ8 E
=
ÒÒF G!
CreateTimeoutPolicy
ÒÒH [
<
ÒÒ[ \
	TResponse
ÒÒ\ e
>
ÒÒe f
(
ÒÒf g
operationName
ÒÒg t
,
ÒÒt u
	connectId
ÒÒv 
)ÒÒ Ä
;ÒÒÄ Å
IAsyncPolicy
ÛÛ 
<
ÛÛ 
Result
ÛÛ 
<
ÛÛ 
	TResponse
ÛÛ %
,
ÛÛ% &
NetworkFailure
ÛÛ' 5
>
ÛÛ5 6
>
ÛÛ6 7
combinedPolicy
ÛÛ8 F
=
ÛÛG H
Policy
ÙÙ 
.
ÙÙ 
	WrapAsync
ÙÙ 
(
ÙÙ 
retryPolicy
ÙÙ (
,
ÙÙ( )
timeoutPolicy
ÙÙ* 7
)
ÙÙ7 8
;
ÙÙ8 9
return
ˆˆ 
combinedPolicy
ˆˆ 
;
ˆˆ 
}
˜˜ 
private
˘˘ 
void
˘˘ 
LogRetryAttempt
˘˘  
(
˘˘  !
bool
˙˙ 
	isTimeout
˙˙ 
,
˙˙ 
string
˚˚ 
operationName
˚˚ 
,
˚˚ 
uint
¸¸ 
	connectId
¸¸ 
,
¸¸ 
int
˝˝ 

retryCount
˝˝ 
,
˝˝ 
int
˛˛ 

maxRetries
˛˛ 
,
˛˛ 
TimeSpan
ˇˇ 
delay
ˇˇ 
)
ˇˇ 
{
ÄÄ 
if
ÅÅ 

(
ÅÅ 
	isTimeout
ÅÅ 
)
ÅÅ 
{
ÇÇ 	
Log
ÉÉ 
.
ÉÉ 
Warning
ÉÉ 
(
ÉÉ 
$strÑÑ ö
,ÑÑö õ
operationName
ÖÖ 
,
ÖÖ 
	connectId
ÖÖ (
,
ÖÖ( )

retryCount
ÖÖ* 4
,
ÖÖ4 5

maxRetries
ÖÖ6 @
,
ÖÖ@ A
delay
ÖÖB G
.
ÖÖG H
TotalMilliseconds
ÖÖH Y
)
ÖÖY Z
;
ÖÖZ [
}
ÜÜ 	
else
áá 
{
àà 	
Log
ââ 
.
ââ 
Information
ââ 
(
ââ 
$strää è
,ääè ê
operationName
ãã 
,
ãã 
	connectId
ãã (
,
ãã( )

retryCount
ãã* 4
,
ãã4 5

maxRetries
ãã6 @
,
ãã@ A
delay
ããB G
.
ããG H
TotalMilliseconds
ããH Y
)
ããY Z
;
ããZ [
}
åå 	
}
çç 
private
èè 
void
èè !
TrackRetryOperation
èè $
(
èè$ %
int
êê 

retryCount
êê 
,
êê 
string
ëë 
operationName
ëë 
,
ëë 
uint
íí 
	connectId
íí 
,
íí 
int
ìì 

maxRetries
ìì 
,
ìì 
string
îî 
operationKey
îî 
,
îî 
RpcServiceType
ïï 
?
ïï 
serviceType
ïï #
)
ïï# $
{
ññ 
if
óó 

(
óó 

retryCount
óó 
==
óó 
$num
óó 
)
óó 
{
òò 	$
StartTrackingOperation
ôô "
(
ôô" #
operationName
ôô# 0
,
ôô0 1
	connectId
ôô2 ;
,
ôô; <

maxRetries
ôô= G
,
ôôG H
operationKey
ôôI U
,
ôôU V
serviceType
ôôW b
)
ôôb c
;
ôôc d
}
öö 	
else
õõ 
{
úú 	'
UpdateOperationRetryCount
ùù %
(
ùù% &
operationKey
ùù& 2
,
ùù2 3

retryCount
ùù4 >
)
ùù> ?
;
ùù? @
}
ûû 	
}
üü 
private
°° 
static
°° 
NetworkFailure
°° !
?
°°! "#
ExtractCurrentFailure
°°# 8
<
°°8 9
	TResponse
°°9 B
>
°°B C
(
°°C D
bool
¢¢ 
	isTimeout
¢¢ 
,
¢¢ 
bool
££ 
	hasResult
££ 
,
££ 
Result
§§ 
<
§§ 
	TResponse
§§ 
,
§§ 
NetworkFailure
§§ (
>
§§( )
result
§§* 0
)
§§0 1
{
•• 
if
¶¶ 

(
¶¶ 
	hasResult
¶¶ 
&&
¶¶ 
result
¶¶ 
.
¶¶  
IsErr
¶¶  %
)
¶¶% &
{
ßß 	
return
®® 
result
®® 
.
®® 
	UnwrapErr
®® #
(
®®# $
)
®®$ %
;
®®% &
}
©© 	
if
´´ 

(
´´ 
	isTimeout
´´ 
)
´´ 
{
¨¨ 	
return
≠≠ 
NetworkFailure
≠≠ !
.
≠≠! "%
DataCenterNotResponding
≠≠" 9
(
≠≠9 :
$str
≠≠: M
)
≠≠M N
;
≠≠N O
}
ÆÆ 	
return
∞∞ 
null
∞∞ 
;
∞∞ 
}
±± 
private
≥≥ 
async
≥≥ 
Task
≥≥ )
HandleRetriesExhaustedAsync
≥≥ 2
(
≥≥2 3
string
¥¥ 
operationKey
¥¥ 
,
¥¥ 
string
µµ 
operationName
µµ 
,
µµ 
uint
∂∂ 
	connectId
∂∂ 
,
∂∂ 
int
∑∑ 

retryCount
∑∑ 
,
∑∑ 
int
∏∏ 

maxRetries
∏∏ 
,
∏∏ 
NetworkFailure
ππ 
?
ππ 
currentFailure
ππ &
)
ππ& '
{
∫∫ 
Log
ªª 
.
ªª 
Warning
ªª 
(
ªª 
$strºº ñ
,ººñ ó
operationName
ΩΩ 
,
ΩΩ 
	connectId
ΩΩ $
,
ΩΩ$ %

retryCount
ΩΩ& 0
,
ΩΩ0 1

maxRetries
ΩΩ2 <
)
ΩΩ< =
;
ΩΩ= >&
MarkOperationAsExhausted
øø  
(
øø  !
operationKey
øø! -
)
øø- .
;
øø. /
NetworkProvider
¡¡ 
?
¡¡ 
networkProvider
¡¡ (
=
¡¡) * 
GetNetworkProvider
¡¡+ =
(
¡¡= >
)
¡¡> ?
;
¡¡? @
networkProvider
¬¬ 
?
¬¬ 
.
¬¬ 2
$BeginSecrecyChannelEstablishRecovery
¬¬ =
(
¬¬= >
)
¬¬> ?
;
¬¬? @
bool
ƒƒ 
allExhausted
ƒƒ 
=
ƒƒ 
await
ƒƒ !&
IsGloballyExhaustedAsync
ƒƒ" :
(
ƒƒ: ;
)
ƒƒ; <
.
ƒƒ< =
ConfigureAwait
ƒƒ= K
(
ƒƒK L
false
ƒƒL Q
)
ƒƒQ R
;
ƒƒR S
if
≈≈ 

(
≈≈ 
allExhausted
≈≈ 
)
≈≈ 
{
∆∆ 	(
PublishAllRetriesExhausted
«« &
(
««& '
	connectId
««' 0
,
««0 1

retryCount
««2 <
,
««< =
currentFailure
««> L
)
««L M
;
««M N
}
»» 	
else
…… 
{
   	%
HandlePartialExhaustion
ÀÀ #
(
ÀÀ# $
	connectId
ÀÀ$ -
,
ÀÀ- .
currentFailure
ÀÀ/ =
)
ÀÀ= >
;
ÀÀ> ?
}
ÃÃ 	
}
ÕÕ 
private
œœ 
void
œœ (
PublishAllRetriesExhausted
œœ +
(
œœ+ ,
uint
œœ, 0
	connectId
œœ1 :
,
œœ: ;
int
œœ< ?

retryCount
œœ@ J
,
œœJ K
NetworkFailure
œœL Z
?
œœZ [
currentFailure
œœ\ j
)
œœj k
{
–– 
Log
—— 
.
—— 
Warning
—— 
(
—— 
$str
““ x
)
““x y
;
““y z

Dispatcher
‘‘ 
.
‘‘ 
UIThread
‘‘ 
.
‘‘ 
Post
‘‘  
(
‘‘  !
(
‘‘! "
)
‘‘" #
=>
‘‘$ &
{
’’ 	
try
÷÷ 
{
◊◊ "
_connectivityService
ÿÿ $
.
ÿÿ$ %
PublishAsync
ÿÿ% 1
(
ÿÿ1 2 
ConnectivityIntent
ŸŸ &
.
ŸŸ& '
RetriesExhausted
ŸŸ' 7
(
ŸŸ7 8
currentFailure
⁄⁄ &
??
⁄⁄' )
NetworkFailure
⁄⁄* 8
.
⁄⁄8 9%
DataCenterNotResponding
⁄⁄9 P
(
⁄⁄P Q
$str
⁄⁄Q d
)
⁄⁄d e
,
⁄⁄e f
	connectId
€€ !
,
€€! "

retryCount
‹‹ "
)
‹‹" #
)
‹‹# $
.
‹‹$ %
ContinueWith
‹‹% 1
(
‹‹1 2
task
›› 
=>
›› 
{
ﬁﬁ 
if
ﬂﬂ 
(
ﬂﬂ 
task
ﬂﬂ  
.
ﬂﬂ  !
	IsFaulted
ﬂﬂ! *
&&
ﬂﬂ+ -
task
ﬂﬂ. 2
.
ﬂﬂ2 3
	Exception
ﬂﬂ3 <
!=
ﬂﬂ= ?
null
ﬂﬂ@ D
)
ﬂﬂD E
{
‡‡ 
Log
·· 
.
··  
Error
··  %
(
··% &
task
··& *
.
··* +
	Exception
··+ 4
,
··4 5
$str
··6 h
)
··h i
;
··i j
}
‚‚ 
}
„„ 
,
„„ 
TaskScheduler
‰‰ !
.
‰‰! "
Default
‰‰" )
)
‰‰) *
;
‰‰* +
}
ÂÂ 
catch
ÊÊ 
(
ÊÊ 
	Exception
ÊÊ 
ex
ÊÊ 
)
ÊÊ  
{
ÁÁ 
Log
ËË 
.
ËË 
Error
ËË 
(
ËË 
ex
ËË 
,
ËË 
$str
ËË F
)
ËËF G
;
ËËG H
}
ÈÈ 
}
ÍÍ 	
)
ÍÍ	 

;
ÍÍ
 
}
ÎÎ 
private
ÌÌ 
void
ÌÌ %
HandlePartialExhaustion
ÌÌ (
(
ÌÌ( )
uint
ÌÌ) -
	connectId
ÌÌ. 7
,
ÌÌ7 8
NetworkFailure
ÌÌ9 G
?
ÌÌG H
currentFailure
ÌÌI W
)
ÌÌW X
{
ÓÓ 
int
ÔÔ 
exhaustedCount
ÔÔ 
=
ÔÔ &
CountExhaustedOperations
ÔÔ 5
(
ÔÔ5 6
)
ÔÔ6 7
;
ÔÔ7 8
if
ÒÒ 

(
ÒÒ 
exhaustedCount
ÒÒ 
==
ÒÒ 
$num
ÒÒ 
)
ÒÒ  
{
ÚÚ 	
Log
ÛÛ 
.
ÛÛ 
Information
ÛÛ 
(
ÛÛ 
$str
ÙÙ `
)
ÙÙ` a
;
ÙÙa b&
PublishDisconnectedState
ˆˆ $
(
ˆˆ$ %
	connectId
ˆˆ% .
,
ˆˆ. /
currentFailure
ˆˆ0 >
)
ˆˆ> ?
;
ˆˆ? @
}
˜˜ 	
if
˘˘ 

(
˘˘ 
Log
˘˘ 
.
˘˘ 
	IsEnabled
˘˘ 
(
˘˘ 
LogEventLevel
˘˘ '
.
˘˘' (
Debug
˘˘( -
)
˘˘- .
)
˘˘. /
{
˙˙ 	
Log
˚˚ 
.
˚˚ 
Debug
˚˚ 
(
˚˚ 
$str
¸¸ y
,
¸¸y z
exhaustedCount
˝˝ 
)
˝˝ 
;
˝˝  
}
˛˛ 	
}
ˇˇ 
private
ÅÅ 
int
ÅÅ &
CountExhaustedOperations
ÅÅ (
(
ÅÅ( )
)
ÅÅ) *
{
ÇÇ 
int
ÉÉ 
exhaustedCount
ÉÉ 
=
ÉÉ 
$num
ÉÉ 
;
ÉÉ 
foreach
ÑÑ 
(
ÑÑ  
RetryOperationInfo
ÑÑ #
	operation
ÑÑ$ -
in
ÑÑ. 0$
_activeRetryOperations
ÑÑ1 G
.
ÑÑG H
Values
ÑÑH N
.
ÑÑN O
ToArray
ÑÑO V
(
ÑÑV W
)
ÑÑW X
)
ÑÑX Y
{
ÖÖ 	
if
ÜÜ 
(
ÜÜ 
	operation
ÜÜ 
.
ÜÜ 
IsExhausted
ÜÜ %
)
ÜÜ% &
{
áá 
exhaustedCount
àà 
++
àà  
;
àà  !
}
ââ 
}
ää 	
return
ãã 
exhaustedCount
ãã 
;
ãã 
}
åå 
private
éé 
void
éé &
PublishDisconnectedState
éé )
(
éé) *
uint
éé* .
	connectId
éé/ 8
,
éé8 9
NetworkFailure
éé: H
?
ééH I
currentFailure
ééJ X
)
ééX Y
{
èè 

Dispatcher
êê 
.
êê 
UIThread
êê 
.
êê 
Post
êê  
(
êê  !
(
êê! "
)
êê" #
=>
êê$ &
{
ëë 	
try
íí 
{
ìì "
_connectivityService
îî $
.
îî$ %
PublishAsync
îî% 1
(
îî1 2 
ConnectivityIntent
ïï &
.
ïï& '
Disconnected
ïï' 3
(
ïï3 4
currentFailure
ññ &
??
ññ' )
NetworkFailure
ññ* 8
.
ññ8 9%
DataCenterNotResponding
ññ9 P
(
ññP Q
$str
ññQ b
)
ññb c
,
ññc d
	connectId
óó !
)
óó! "
)
óó" #
.
óó# $
ContinueWith
óó$ 0
(
óó0 1
task
òò 
=>
òò 
{
ôô 
if
öö 
(
öö 
task
öö  
.
öö  !
	IsFaulted
öö! *
&&
öö+ -
task
öö. 2
.
öö2 3
	Exception
öö3 <
!=
öö= ?
null
öö@ D
)
ööD E
{
õõ 
Log
úú 
.
úú  
Error
úú  %
(
úú% &
task
úú& *
.
úú* +
	Exception
úú+ 4
,
úú4 5
$str
úú6 {
)
úú{ |
;
úú| }
}
ùù 
}
ûû 
,
ûû 
TaskScheduler
üü !
.
üü! "
Default
üü" )
)
üü) *
;
üü* +
}
†† 
catch
°° 
(
°° 
	Exception
°° 
ex
°° 
)
°°  
{
¢¢ 
Log
££ 
.
££ 
Error
££ 
(
££ 
ex
££ 
,
££ 
$str
££ I
)
££I J
;
££J K
}
§§ 
}
•• 	
)
••	 

;
••
 
}
¶¶ 
private
®® 
static
®® 
bool
®® )
DetermineIfRecoveryRequired
®® 3
<
®®3 4
	TResponse
®®4 =
>
®®= >
(
®®> ?
bool
©© 
	isTimeout
©© 
,
©© 
bool
™™ 
	hasResult
™™ 
,
™™ 
Result
´´ 
<
´´ 
	TResponse
´´ 
,
´´ 
NetworkFailure
´´ (
>
´´( )
result
´´* 0
,
´´0 10
"RequiresConnectionRecoveryDelegate
¨¨ *
<
¨¨* +
	TResponse
¨¨+ 4
>
¨¨4 5(
connectionRecoveryDelegate
¨¨6 P
)
¨¨P Q
{
≠≠ 
if
ÆÆ 

(
ÆÆ 
	isTimeout
ÆÆ 
)
ÆÆ 
{
ØØ 	
return
∞∞ 
true
∞∞ 
;
∞∞ 
}
±± 	
if
≥≥ 

(
≥≥ 
	hasResult
≥≥ 
)
≥≥ 
{
¥¥ 	
return
µµ (
connectionRecoveryDelegate
µµ -
(
µµ- .
result
µµ. 4
)
µµ4 5
;
µµ5 6
}
∂∂ 	
return
∏∏ 
false
∏∏ 
;
∏∏ 
}
ππ 
private
ªª 
IAsyncPolicy
ªª 
<
ªª 
Result
ªª 
<
ªª  
	TResponse
ªª  )
,
ªª) *
NetworkFailure
ªª+ 9
>
ªª9 :
>
ªª: ;!
CreateTimeoutPolicy
ªª< O
<
ªªO P
	TResponse
ªªP Y
>
ªªY Z
(
ªªZ [
string
ºº 
operationName
ºº 
,
ºº 
uint
ΩΩ 
	connectId
ΩΩ 
)
ΩΩ 
{
ææ 
return
øø 
Policy
øø 
.
¿¿ 
TimeoutAsync
¿¿ 
<
¿¿ 
Result
¿¿  
<
¿¿  !
	TResponse
¿¿! *
,
¿¿* +
NetworkFailure
¿¿, :
>
¿¿: ;
>
¿¿; <
(
¿¿< =
(
¡¡ 
context
¡¡ 
)
¡¡ 
=>
¡¡ 
{
¬¬ 
int
√√ 
currentAttempt
√√ &
=
√√' (
GetCurrentAttempt
√√) :
(
√√: ;
context
√√; B
)
√√B C
;
√√C D
TimeSpan
ƒƒ 
timeout
ƒƒ $
=
ƒƒ% &$
_strategyConfiguration
ƒƒ' =
.
ƒƒ= >!
PER_ATTEMPT_TIMEOUT
ƒƒ> Q
;
ƒƒQ R
if
∆∆ 
(
∆∆ 
Log
∆∆ 
.
∆∆ 
	IsEnabled
∆∆ %
(
∆∆% &
LogEventLevel
∆∆& 3
.
∆∆3 4
Debug
∆∆4 9
)
∆∆9 :
)
∆∆: ;
{
«« 
Log
»» 
.
»» 
Debug
»» !
(
»»! "
$str…… Å
,……Å Ç
operationName
   )
,
  ) *
currentAttempt
  + 9
,
  9 :
timeout
  ; B
.
  B C
TotalSeconds
  C O
)
  O P
;
  P Q
}
ÀÀ 
return
ÕÕ 
timeout
ÕÕ "
;
ÕÕ" #
}
ŒŒ 
,
ŒŒ 
TimeoutStrategy
œœ 
.
œœ  
Pessimistic
œœ  +
,
œœ+ ,
onTimeoutAsync
–– 
:
–– 
(
––  !
context
––! (
,
––( )
timespan
––* 2
,
––2 3
_
––4 5
,
––5 6
_
––7 8
)
––8 9
=>
––: <
{
—— 
int
““ 
currentAttempt
““ &
=
““' (
GetCurrentAttempt
““) :
(
““: ;
context
““; B
)
““B C
;
““C D
Log
”” 
.
”” 
Warning
”” 
(
””  
$str‘‘ ã
,‘‘ã å
operationName
’’ %
,
’’% &
	connectId
’’' 0
,
’’0 1
currentAttempt
’’2 @
,
’’@ A
timespan
’’B J
.
’’J K
TotalSeconds
’’K W
)
’’W X
;
’’X Y
return
÷÷ 
Task
÷÷ 
.
÷÷  
CompletedTask
÷÷  -
;
÷÷- .
}
◊◊ 
)
◊◊ 
;
◊◊ 
}
ÿÿ 
private
⁄⁄ 
async
⁄⁄ 
Task
⁄⁄ '
EnsureSecrecyChannelAsync
⁄⁄ 0
(
⁄⁄0 1
uint
⁄⁄1 5
	connectId
⁄⁄6 ?
,
⁄⁄? @
CancellationToken
⁄⁄A R
cancellationToken
⁄⁄S d
)
⁄⁄d e
{
€€ 
if
‹‹ 

(
‹‹ 
cancellationToken
‹‹ 
.
‹‹ %
IsCancellationRequested
‹‹ 5
)
‹‹5 6
{
›› 	
return
ﬁﬁ 
;
ﬁﬁ 
}
ﬂﬂ 	
NetworkProvider
·· 
networkProvider
·· '
=
··( ) 
GetNetworkProvider
··* <
(
··< =
)
··= >
;
··> ?
try
„„ 
{
‰‰ 	
networkProvider
ÂÂ 
.
ÂÂ 2
$BeginSecrecyChannelEstablishRecovery
ÂÂ @
(
ÂÂ@ A
)
ÂÂA B
;
ÂÂB C
if
ÁÁ 
(
ÁÁ 
cancellationToken
ÁÁ !
.
ÁÁ! "%
IsCancellationRequested
ÁÁ" 9
)
ÁÁ9 :
{
ËË 
return
ÈÈ 
;
ÈÈ 
}
ÍÍ 
if
ÏÏ 
(
ÏÏ 
networkProvider
ÏÏ 
.
ÏÏ  !
IsConnectionHealthy
ÏÏ  3
(
ÏÏ3 4
	connectId
ÏÏ4 =
)
ÏÏ= >
)
ÏÏ> ?
{
ÌÌ 
return
ÓÓ 
;
ÓÓ 
}
ÔÔ 
Log
ÒÒ 
.
ÒÒ 
Debug
ÒÒ 
(
ÒÒ 
$str
ÒÒ R
,
ÒÒR S
	connectId
ÒÒT ]
)
ÒÒ] ^
;
ÒÒ^ _
Result
ÚÚ 
<
ÚÚ 
bool
ÚÚ 
,
ÚÚ 
NetworkFailure
ÚÚ '
>
ÚÚ' (
restoreResult
ÚÚ) 6
=
ÚÚ7 8
await
ÛÛ 
networkProvider
ÛÛ %
.
ÛÛ% &'
TryRestoreConnectionAsync
ÛÛ& ?
(
ÛÛ? @
	connectId
ÛÛ@ I
)
ÛÛI J
.
ÛÛJ K
ConfigureAwait
ÛÛK Y
(
ÛÛY Z
false
ÛÛZ _
)
ÛÛ_ `
;
ÛÛ` a
if
ıı 
(
ıı 
cancellationToken
ıı !
.
ıı! "%
IsCancellationRequested
ıı" 9
)
ıı9 :
{
ˆˆ 
return
˜˜ 
;
˜˜ 
}
¯¯ 
cancellationToken
˙˙ 
.
˙˙ *
ThrowIfCancellationRequested
˙˙ :
(
˙˙: ;
)
˙˙; <
;
˙˙< =
if
¸¸ 
(
¸¸ 
restoreResult
¸¸ 
.
¸¸ 
IsOk
¸¸ "
&&
¸¸# %
restoreResult
¸¸& 3
.
¸¸3 4
Unwrap
¸¸4 :
(
¸¸: ;
)
¸¸; <
)
¸¸< =
{
˝˝ 
Log
˛˛ 
.
˛˛ 
Information
˛˛ 
(
˛˛  
$str
˛˛  \
,
˛˛\ ]
	connectId
˛˛^ g
)
˛˛g h
;
˛˛h i
}
ˇˇ 
else
ÄÄ 
if
ÄÄ 
(
ÄÄ 
restoreResult
ÄÄ "
.
ÄÄ" #
IsErr
ÄÄ# (
)
ÄÄ( )
{
ÅÅ 
Log
ÇÇ 
.
ÇÇ 
Warning
ÇÇ 
(
ÇÇ 
$str
ÇÇ ]
,
ÇÇ] ^
	connectId
ÇÇ_ h
,
ÇÇh i
restoreResult
ÉÉ !
.
ÉÉ! "
	UnwrapErr
ÉÉ" +
(
ÉÉ+ ,
)
ÉÉ, -
.
ÉÉ- .
Message
ÉÉ. 5
)
ÉÉ5 6
;
ÉÉ6 7
}
ÑÑ 
}
ÖÖ 	
catch
ÜÜ 
(
ÜÜ 
	Exception
ÜÜ 
ex
ÜÜ 
)
ÜÜ 
{
áá 	
Log
àà 
.
àà 
Warning
àà 
(
àà 
ex
àà 
,
àà 
$str
àà ^
,
àà^ _
	connectId
àà` i
)
àài j
;
ààj k
}
ââ 	
}
ää 
private
åå 
NetworkProvider
åå  
GetNetworkProvider
åå .
(
åå. /
)
åå/ 0
{
çç 
if
éé 

(
éé "
_lazyNetworkProvider
éé  
==
éé! #
null
éé$ (
||
éé) +
!
éé, -"
_lazyNetworkProvider
éé- A
.
ééA B
IsValueCreated
ééB P
)
ééP Q
{
èè 	
throw
êê 
new
êê '
InvalidOperationException
êê /
(
êê/ 0
$str
êê0 Z
)
êêZ [
;
êê[ \
}
ëë 	
return
íí "
_lazyNetworkProvider
íí #
.
íí# $
Value
íí$ )
;
íí) *
}
ìì 
private
ïï 
static
ïï 
string
ïï  
CreateOperationKey
ïï ,
(
ïï, -
string
ïï- 3
operationName
ïï4 A
,
ïïA B
uint
ïïC G
	connectId
ïïH Q
,
ïïQ R
DateTime
ïïS [
	startTime
ïï\ e
)
ïïe f
{
ññ 
return
óó 
$"
óó 
{
óó 
operationName
óó 
}
óó  
$str
óó  !
{
óó! "
	connectId
óó" +
}
óó+ ,
$str
óó, -
{
óó- .
	startTime
óó. 7
.
óó7 8
Ticks
óó8 =
}
óó= >
$str
óó> ?
{
óó? @
Guid
óó@ D
.
óóD E
NewGuid
óóE L
(
óóL M
)
óóM N
:
óóN O
$str
óóO P
}
óóP Q
"
óóQ R
;
óóR S
}
òò 
private
öö 
static
öö 
int
öö 
GetCurrentAttempt
öö (
(
öö( )
Context
öö) 0
ctx
öö1 4
)
öö4 5
=>
öö6 8
ctx
õõ 
.
õõ 
TryGetValue
õõ 
(
õõ 
ATTEMPT_KEY
õõ #
,
õõ# $
out
õõ% (
object
õõ) /
?
õõ/ 0
val
õõ1 4
)
õõ4 5
&&
õõ6 8
val
õõ9 <
is
õõ= ?
int
õõ@ C
attempt
õõD K
?
õõL M
attempt
õõN U
:
õõV W
$num
õõX Y
;
õõY Z
private
ùù 
async
ùù 
Task
ùù 
<
ùù 
Result
ùù 
<
ùù 
	TResponse
ùù '
,
ùù' (
NetworkFailure
ùù) 7
>
ùù7 8
>
ùù8 9)
ExecuteOperationWithLogging
ùù: U
<
ùùU V
	TResponse
ùùV _
>
ùù_ `
(
ùù` a
Context
ûû 
ctx
ûû 
,
ûû 
CancellationToken
üü 
ct
üü 
,
üü 
Func
†† 
<
†† 
int
†† 
,
†† 
CancellationToken
†† #
,
††# $
Task
††% )
<
††) *
Result
††* 0
<
††0 1
	TResponse
††1 :
,
††: ;
NetworkFailure
††< J
>
††J K
>
††K L
>
††L M
	operation
††N W
,
††W X
string
°° 
operationName
°° 
)
°° 
{
¢¢ 
ct
££ 

.
££
 *
ThrowIfCancellationRequested
££ '
(
££' (
)
££( )
;
££) *
int
§§ 
currentAttempt
§§ 
=
§§ 
GetCurrentAttempt
§§ .
(
§§. /
ctx
§§/ 2
)
§§2 3
;
§§3 4
Result
•• 
<
•• 
	TResponse
•• 
,
•• 
NetworkFailure
•• (
>
••( )
opResult
••* 2
=
••3 4
await
¶¶ 
	operation
¶¶ 
(
¶¶ 
currentAttempt
¶¶ *
,
¶¶* +
ct
¶¶, .
)
¶¶. /
.
¶¶/ 0
ConfigureAwait
¶¶0 >
(
¶¶> ?
false
¶¶? D
)
¶¶D E
;
¶¶E F
if
ßß 

(
ßß 
Log
ßß 
.
ßß 
	IsEnabled
ßß 
(
ßß 
LogEventLevel
ßß '
.
ßß' (
Debug
ßß( -
)
ßß- .
)
ßß. /
{
®® 	
Log
©© 
.
©© 
Debug
©© 
(
©© 
$str
™™ f
,
™™f g
operationName
´´ 
,
´´ 
currentAttempt
´´ -
,
´´- .
opResult
´´/ 7
.
´´7 8
IsOk
´´8 <
)
´´< =
;
´´= >
}
¨¨ 	
return
ÆÆ 
opResult
ÆÆ 
;
ÆÆ 
}
ØØ 
public
±± 

void
±± 
Dispose
±± 
(
±± 
)
±± 
{
≤≤ 
if
≥≥ 

(
≥≥ 
_isDisposed
≥≥ 
)
≥≥ 
{
¥¥ 	
return
µµ 
;
µµ 
}
∂∂ 	
_isDisposed
∏∏ 
=
∏∏ 
true
∏∏ 
;
∏∏ 
try
∫∫ 
{
ªª 	&
_manualRetrySubscription
ºº $
?
ºº$ %
.
ºº% &
Dispose
ºº& -
(
ºº- .
)
ºº. /
;
ºº/ 0
_cleanupTimer
ΩΩ 
.
ΩΩ 
Dispose
ΩΩ !
(
ΩΩ! "
)
ΩΩ" #
;
ΩΩ# $

_stateLock
ææ 
.
ææ 
Dispose
ææ 
(
ææ 
)
ææ  
;
ææ  !
Log
¿¿ 
.
¿¿ 
Information
¿¿ 
(
¿¿ 
$str
¿¿ O
)
¿¿O P
;
¿¿P Q
}
¡¡ 	
catch
¬¬ 
(
¬¬ 
	Exception
¬¬ 
ex
¬¬ 
)
¬¬ 
{
√√ 	
Log
ƒƒ 
.
ƒƒ 
Error
ƒƒ 
(
ƒƒ 
ex
ƒƒ 
,
ƒƒ 
$str
ƒƒ M
)
ƒƒM N
;
ƒƒN O
}
≈≈ 	
}
∆∆ 
}«« ù
à/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Resilience/RetryPolicyHelpers.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )

Resilience) 3
;3 4
public 
delegate 
bool 
ShouldRetryDelegate (
<( )
	TResponse) 2
>2 3
(3 4
Result4 :
<: ;
	TResponse; D
,D E
NetworkFailureF T
>T U
resultV \
)\ ]
;] ^
public 
delegate 
bool .
"RequiresConnectionRecoveryDelegate 7
<7 8
	TResponse8 A
>A B
(B C
ResultC I
<I J
	TResponseJ S
,S T
NetworkFailureU c
>c d
resulte k
)k l
;l m
public		 
static		 
class		  
RetryDecisionFactory		 (
{

 
public 

static 
ShouldRetryDelegate %
<% &
	TResponse& /
>/ 0%
CreateShouldRetryDelegate1 J
<J K
	TResponseK T
>T U
(U V
)V W
{ 
return 
static 
result 
=> 
result  &
.& '
IsErr' ,
&&- /!
FailureClassification0 E
.E F
IsTransientF Q
(Q R
resultR X
.X Y
	UnwrapErrY b
(b c
)c d
)d e
;e f
} 
public 

static .
"RequiresConnectionRecoveryDelegate 4
<4 5
	TResponse5 >
>> ?,
 CreateConnectionRecoveryDelegate@ `
<` a
	TResponsea j
>j k
(k l
)l m
{ 
return 
static 
result 
=> 
{ 	
if 
( 
result 
. 
IsOk 
) 
{ 
return 
false 
; 
} 
NetworkFailure 
failure "
=# $
result% +
.+ ,
	UnwrapErr, 5
(5 6
)6 7
;7 8
return !
FailureClassification (
.( )#
IsProtocolStateMismatch) @
(@ A
failureA H
)H I
||J L!
FailureClassification (
.( )
IsCryptoDesync) 7
(7 8
failure8 ?
)? @
;@ A
} 	
;	 

} 
} Ö7
â/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Resilience/RetryPolicyProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )

Resilience) 3
;3 4
public 
sealed 
class 
RetryPolicyProvider '
(' (&
RetryStrategyConfiguration( B&
retryStrategyConfigurationC ]
)] ^
:_ ` 
IRetryPolicyProvidera u
{		 
private

 
static

 
readonly

 
FrozenDictionary

 ,
<

, -
RpcServiceType

- ;
,

; <
ServiceRetryConfig

= O
>

O P
ServiceConfigs

Q _
=

` a
new 

Dictionary 
< 
RpcServiceType %
,% &
ServiceRetryConfig' 9
>9 :
{ 	
[ 
RpcServiceType 
. 
RegisterAppDevice -
]- .
=/ 0
new1 4
(4 5
ShouldRetry5 @
:@ A
trueB F
,F G#
ReinitOnCompleteFailureH _
:_ `
falsea f
)f g
,g h
[ 
RpcServiceType 
. )
CheckMobileNumberAvailability 9
]9 :
=; <
new= @
(@ A
ShouldRetryA L
:L M
trueN R
,R S#
ReinitOnCompleteFailureT k
:k l
falsem r
)r s
,s t
[ 
RpcServiceType 
.  
ValidateMobileNumber 0
]0 1
=2 3
new4 7
(7 8
ShouldRetry8 C
:C D
trueE I
,I J#
ReinitOnCompleteFailureK b
:b c
falsed i
)i j
,j k
[ 
RpcServiceType 
.  
InitiateVerification 0
]0 1
=2 3
new4 7
(7 8
ShouldRetry8 C
:C D
falseE J
,J K#
ReinitOnCompleteFailureL c
:c d
falsee j
)j k
,k l
[ 
RpcServiceType 
. 
	VerifyOtp %
]% &
=' (
new) ,
(, -
ShouldRetry- 8
:8 9
true: >
,> ?#
ReinitOnCompleteFailure@ W
:W X
falseY ^
)^ _
,_ `
[ 
RpcServiceType 
. 
RegistrationInit ,
], -
=. /
new0 3
(3 4
ShouldRetry4 ?
:? @
trueA E
,E F#
ReinitOnCompleteFailureG ^
:^ _
false` e
)e f
,f g
[ 
RpcServiceType 
.  
RegistrationComplete 0
]0 1
=2 3
new4 7
(7 8
ShouldRetry8 C
:C D
trueE I
,I J#
ReinitOnCompleteFailureK b
:b c
trued h
)h i
,i j
[ 
RpcServiceType 
. 
SignInInitRequest -
]- .
=/ 0
new1 4
(4 5
ShouldRetry5 @
:@ A
trueB F
,F G#
ReinitOnCompleteFailureH _
:_ `
falsea f
)f g
,g h
[ 
RpcServiceType 
. !
SignInCompleteRequest 1
]1 2
=3 4
new5 8
(8 9
ShouldRetry9 D
:D E
trueF J
,J K#
ReinitOnCompleteFailureL c
:c d
truee i
)i j
,j k
[ 
RpcServiceType 
. 
Logout "
]" #
=$ %
new& )
() *
ShouldRetry* 5
:5 6
false7 <
,< =#
ReinitOnCompleteFailure> U
:U V
falseW \
)\ ]
,] ^
[ 
RpcServiceType 
. 
AnonymousLogout +
]+ ,
=- .
new/ 2
(2 3
ShouldRetry3 >
:> ?
false@ E
,E F#
ReinitOnCompleteFailureG ^
:^ _
false` e
)e f
,f g
[ 
RpcServiceType 
. /
#EstablishAuthenticatedSecureChannel ?
]? @
=A B
newC F
(F G
ShouldRetryG R
:R S
trueT X
,X Y#
ReinitOnCompleteFailureZ q
:q r
trues w
)w x
,x y
[ 
RpcServiceType 
. !
RecoverySecretKeyInit 1
]1 2
=3 4
new5 8
(8 9
ShouldRetry9 D
:D E
trueF J
,J K#
ReinitOnCompleteFailureL c
:c d
falsee j
)j k
,k l
[ 
RpcServiceType 
. %
RecoverySecretKeyComplete 5
]5 6
=7 8
new9 <
(< =
ShouldRetry= H
:H I
trueJ N
,N O#
ReinitOnCompleteFailureP g
:g h
truei m
)m n
,n o
} 	
.	 

ToFrozenDictionary
 
( 
) 
; 
private 
sealed 
record 
ServiceRetryConfig ,
(, -
bool- 1
ShouldRetry2 =
,= >
bool? C#
ReinitOnCompleteFailureD [
)[ \
;\ ]
public 

RetryBehavior 
GetRetryBehavior )
() *
RpcServiceType* 8
serviceType9 D
)D E
{   
if!! 

(!! 
!!! 
ServiceConfigs!! 
.!! 
TryGetValue!! '
(!!' (
serviceType!!( 3
,!!3 4
out!!5 8
ServiceRetryConfig!!9 K
?!!K L
config!!M S
)!!S T
)!!T U
{"" 	
return## 
RetryBehavior##  
.##  !
NoRetry##! (
;##( )
}$$ 	
return&& 
new&& 
RetryBehavior&&  
{'' 	
ShouldRetry(( 
=(( 
config((  
.((  !
ShouldRetry((! ,
,((, -
MAX_ATTEMPTS)) 
=)) &
retryStrategyConfiguration)) 5
.))5 6
MAX_RETRIES))6 A
,))A B#
ReinitOnCompleteFailure** #
=**$ %
config**& ,
.**, -#
ReinitOnCompleteFailure**- D
}++ 	
;++	 

},, 
}-- ¯R
â/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Resilience/GrpcErrorClassifier.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )

Resilience) 3
;3 4
public		 
static		 
class		 
GrpcErrorClassifier		 '
{

 
public 

static 
bool 
IsBusinessError &
(& '
RpcException' 3
ex4 6
)6 7
=>8 :
ex 

.
 

StatusCode 
is 

StatusCode 
. 
InvalidArgument &
or' )

StatusCode 
. 
NotFound 
or  "

StatusCode 
. 
AlreadyExists $
or% '

StatusCode 
. 
FailedPrecondition )
or* ,

StatusCode 
. 

OutOfRange !
or" $

StatusCode 
. 
Unimplemented $
;$ %
public 

static 
bool !
IsAuthenticationError ,
(, -
RpcException- 9
ex: <
)< =
=>> @
ex 

.
 

StatusCode 
is 

StatusCode 
. 
Unauthenticated &
or' )

StatusCode 
. 
PermissionDenied '
;' (
public 

static 
bool %
IsTransientInfrastructure 0
(0 1
RpcException1 =
ex> @
)@ A
=>B D
ex 

.
 

StatusCode 
is 

StatusCode 
. 
DeadlineExceeded '
or( *

StatusCode 
. 
Unavailable "
or# %

StatusCode 
. 
	Cancelled  
;  !
public 

static 
bool %
RequiresHandshakeRecovery 0
(0 1
RpcException1 =
ex> @
)@ A
=>B D
ex   

.  
 

StatusCode   
is   

StatusCode!! 
.!! 
Internal!! 
or!!  "

StatusCode"" 
."" 
Unknown"" 
or"" !

StatusCode## 
.## 
DataLoss## 
;##  
public%% 

static%% 
bool%% #
IsProtocolStateMismatch%% .
(%%. /
RpcException%%/ ;
ex%%< >
)%%> ?
{&& 
if'' 

('' 
ex'' 
.'' 

StatusCode'' 
!='' 

StatusCode'' '
.''' (
Internal''( 0
&&''1 3
ex''4 6
.''6 7

StatusCode''7 A
!=''B D

StatusCode''E O
.''O P
FailedPrecondition''P b
)''b c
{(( 	
return)) 
false)) 
;)) 
}** 	
string,, 
detail,, 
=,, 
ex,, 
.,, 
Status,, !
.,,! "
Detail,," (
?,,( )
.,,) *
ToLowerInvariant,,* :
(,,: ;
),,; <
??,,= ?
string,,@ F
.,,F G
Empty,,G L
;,,L M
return.. 
detail.. 
... 
Contains.. 
(.. 
$str.. =
)..= >
||..? A
detail// 
.// 
Contains// 
(// 
$str// 0
)//0 1
&&//2 4
detail//5 ;
.//; <
Contains//< D
(//D E
$str//E Q
)//Q R
||//S U
detail00 
.00 
Contains00 
(00 
$str00 /
)00/ 0
||001 3
detail11 
.11 
Contains11 
(11 
$str11 2
)112 3
||114 6
detail22 
.22 
Contains22 
(22 
$str22 /
)22/ 0
&&221 3
detail224 :
.22: ;
Contains22; C
(22C D
$str22D N
)22N O
||22P R
detail33 
.33 
Contains33 
(33 
$str33 /
)33/ 0
&&331 3
detail334 :
.33: ;
Contains33; C
(33C D
$str33D T
)33T U
||33V X
detail44 
.44 
Contains44 
(44 
$str44 )
)44) *
&&44+ -
detail44. 4
.444 5
Contains445 =
(44= >
$str44> G
)44G H
||44I K
detail55 
.55 
Contains55 
(55 
$str55 -
)55- .
&&55/ 1
detail552 8
.558 9
Contains559 A
(55A B
$str55B K
)55K L
||55M O
detail66 
.66 
Contains66 
(66 
$str66 /
)66/ 0
&&661 3
detail664 :
.66: ;
Contains66; C
(66C D
$str66D M
)66M N
||66O Q
detail77 
.77 
Contains77 
(77 
$str77 1
)771 2
||773 5
detail88 
.88 
Contains88 
(88 
$str88 .
)88. /
||880 2
detail99 
.99 
Contains99 
(99 
$str99 .
)99. /
&&990 2
detail993 9
.999 :
Contains99: B
(99B C
$str99C L
)99L M
;99M N
}:: 
public<< 

static<< 
bool<< 
IsServerShutdown<< '
(<<' (
RpcException<<( 4
ex<<5 7
)<<7 8
=><<9 ;
ex== 

.==
 

StatusCode== 
==== 

StatusCode== #
.==# $
Unavailable==$ /
&&==0 2
(>> 	
ex>>	 
.>> 
Status>> 
.>> 
Detail>> 
?>> 
.>> 
Contains>> #
(>># $
$str>>$ .
,>>. /
StringComparison>>0 @
.>>@ A
OrdinalIgnoreCase>>A R
)>>R S
is>>T V
true>>W [
||>>\ ^
ex??	 
.?? 
Status?? 
.?? 
Detail?? 
??? 
.?? 
Contains?? #
(??# $
$str??$ 1
,??1 2
StringComparison??3 C
.??C D
OrdinalIgnoreCase??D U
)??U V
is??W Y
true??Z ^
)??^ _
;??_ `
publicAA 

staticAA 
boolAA 
IsCancelledAA "
(AA" #
RpcExceptionAA# /
exAA0 2
)AA2 3
=>AA4 6
exBB 

.BB
 

StatusCodeBB 
==BB 

StatusCodeBB #
.BB# $
	CancelledBB$ -
;BB- .
publicDD 

staticDD 
boolDD *
IsIdentityKeyDerivationFailureDD 5
(DD5 6
RpcExceptionDD6 B
exDDC E
)DDE F
=>DDG I
exEE 

.EE
 

StatusCodeEE 
==EE 

StatusCodeEE #
.EE# $
UnauthenticatedEE$ 3
&&EE4 6
(FF 	
exFF	 
.FF 
StatusFF 
.FF 
DetailFF 
?FF 
.FF 
ContainsFF #
(FF# $
$strFF$ D
,FFD E
SystemFFF L
.FFL M
StringComparisonFFM ]
.FF] ^
OrdinalFF^ e
)FFe f
isFFg i
trueFFj n
)FFn o
;FFo p
publicHH 

staticHH 
boolHH 
IsAuthFlowMissingHH (
(HH( )
RpcExceptionHH) 5
exHH6 8
)HH8 9
{II 
ifJJ 

(JJ 
exJJ 
.JJ 

StatusCodeJJ 
!=JJ 

StatusCodeJJ '
.JJ' (
NotFoundJJ( 0
)JJ0 1
{KK 	
returnLL 
falseLL 
;LL 
}MM 	
returnOO 
GetMetadataValueOO 
(OO  
exOO  "
.OO" #
TrailersOO# +
,OO+ ,!
GrpcErrorMetadataKeysOO- B
.OOB C

ERROR_CODEOOC M
)OOM N
.PP 
WherePP 
(PP 
codePP 
=>PP !
stringPP" (
.PP( )
EqualsPP) /
(PP/ 0
codePP0 4
,PP4 5
$strPP6 G
,PPG H
StringComparisonPPI Y
.PPY Z
OrdinalIgnoreCasePPZ k
)PPk l
)PPl m
.QQ 
IsSomeQQ 
||RR 
GetMetadataValueSS 
(SS  
exSS  "
.SS" #
TrailersSS# +
,SS+ ,!
GrpcErrorMetadataKeysSS- B
.SSB C
	I_18N_KEYSSC L
)SSL M
.TT 
WhereTT 
(TT 
keyTT 
=>TT  
stringTT! '
.TT' (
EqualsTT( .
(TT. /
keyTT/ 2
,TT2 3
$strTT4 M
,TTM N
StringComparisonTTO _
.TT_ `
OrdinalIgnoreCaseTT` q
)TTq r
)TTr s
.UU 
IsSomeUU 
;UU 
}VV 
privateXX 
staticXX 
OptionXX 
<XX 
stringXX  
>XX  !
GetMetadataValueXX" 2
(XX2 3
MetadataXX3 ;
metadataXX< D
,XXD E
stringXXF L
keyXXM P
)XXP Q
{YY 
MetadataZZ 
.ZZ 
EntryZZ 
?ZZ 
entryZZ 
=ZZ 
metadataZZ  (
.[[ 
FirstOrDefault[[ 
([[ 
e[[ 
=>[[  
string[[! '
.[[' (
Equals[[( .
([[. /
e[[/ 0
.[[0 1
Key[[1 4
,[[4 5
key[[6 9
,[[9 :
StringComparison[[; K
.[[K L
OrdinalIgnoreCase[[L ]
)[[] ^
)[[^ _
;[[_ `
return]] 
entry]] 
?]] 
.]] 
Value]] 
.]] 
ToOption]] $
(]]$ %
)]]% &
??]]' )
Option]]* 0
<]]0 1
string]]1 7
>]]7 8
.]]8 9
None]]9 =
;]]= >
}^^ 
}__ †
ã/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Resilience/FailureClassification.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )

Resilience) 3
;3 4
public 
static 
class !
FailureClassification )
{ 
public 

static 
bool 
IsTransient "
(" #
NetworkFailure# 1
failure2 9
)9 :
{ 
if		 

(		 
failure		 
.		 
FailureType		 
==		  "
NetworkFailureType		# 5
.		5 6
OperationCancelled		6 H
)		H I
{

 	
return 
false 
; 
} 	
if 

( 
failure 
. 
FailureType 
==  "
NetworkFailureType# 5
.5 6!
ProtocolStateMismatch6 K
)K L
{ 	
return 
false 
; 
} 	
if 

( 
failure 
. 
	UserError 
? 
. 
	RETRYABLE (
is) +
bool, 0
	retryable1 :
): ;
{ 	
return 
	retryable 
; 
} 	
return 
failure 
. 
FailureType "
==# %
NetworkFailureType& 8
.8 9#
DataCenterNotResponding9 P
;P Q
} 
public 

static 
bool 
IsServerShutdown '
(' (
NetworkFailure( 6
failure7 >
)> ?
{ 
return 
failure 
. 
FailureType "
==# %
NetworkFailureType& 8
.8 9
DataCenterShutdown9 K
;K L
} 
public   

static   
bool   
IsCryptoDesync   %
(  % &
NetworkFailure  & 4
failure  5 <
)  < =
{!! 
return"" 
failure"" 
."" 
FailureType"" "
==""# %
NetworkFailureType""& 8
.""8 9 
RsaEncryptionFailure""9 M
;""M N
}## 
public%% 

static%% 
bool%% #
IsProtocolStateMismatch%% .
(%%. /
NetworkFailure%%/ =
failure%%> E
)%%E F
{&& 
return'' 
failure'' 
.'' 
FailureType'' "
==''# %
NetworkFailureType''& 8
.''8 9!
ProtocolStateMismatch''9 N
;''N O
}(( 
public** 

static** 
bool** #
IsChainRotationMismatch** .
(**. /
NetworkFailure**/ =
failure**> E
)**E F
{++ 
return-- #
IsProtocolStateMismatch-- &
(--& '
failure--' .
)--. /
;--/ 0
}.. 
public00 

static00 
bool00 
IsCancellation00 %
(00% &
NetworkFailure00& 4
failure005 <
)00< =
{11 
return22 
failure22 
.22 
FailureType22 "
==22# %
NetworkFailureType22& 8
.228 9
OperationCancelled229 K
;22K L
}33 
}44 ã7
Å/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/PendingLogoutProcessor.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
internal 
sealed	 
class "
PendingLogoutProcessor ,
(, -
NetworkProvider 
networkProvider #
,# $'
PendingLogoutRequestStorage  
pendingLogoutStorage  4
)4 5
{ 
public 

async 
Task %
ProcessPendingLogoutAsync /
(/ 0
uint 
	connectId 
, 
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
{ 
try 
{ 	
Result 
< 
Option 
< 
LogoutRequest '
>' (
,( )
LogoutFailure* 7
>7 8
	getResult9 B
=C D
await  
pendingLogoutStorage *
.* +!
GetPendingLogoutAsync+ @
(@ A
)A B
.B C
ConfigureAwaitC Q
(Q R
falseR W
)W X
;X Y
if 
( 
	getResult 
. 
IsErr 
||  "
!# $
	getResult$ -
.- .
Unwrap. 4
(4 5
)5 6
.6 7
IsSome7 =
)= >
{ 
return   
;   
}!! 
LogoutRequest## 
pendingRequest## (
=##) *
	getResult##+ 4
.##4 5
Unwrap##5 ;
(##; <
)##< =
.##= >
Value##> C
!##C D
;##D E 
TaskCompletionSource%%  
<%%  !
bool%%! %
>%%% &$
responseCompletionSource%%' ?
=%%@ A
new&& 
(&& 
TaskCreationOptions&& '
.&&' (*
RunContinuationsAsynchronously&&( F
)&&F G
;&&G H
Result(( 
<(( 
Unit(( 
,(( 
NetworkFailure(( '
>((' (
networkResult(() 6
=((7 8
await((9 >
networkProvider((? N
.((N O$
ExecuteUnaryRequestAsync((O g
(((g h
	connectId)) 
,)) 
RpcServiceType** 
.** 
AnonymousLogout** .
,**. /
pendingRequest++ 
.++ 
ToByteArray++ *
(++* +
)+++ ,
,++, -
async,, 
responsePayload,, %
=>,,& (
{-- #
AnonymousLogoutResponse00 +
.00+ ,
Parser00, 2
.002 3
	ParseFrom003 <
(00< =
responsePayload00= L
)00L M
;00M N$
responseCompletionSource11 ,
.11, -
TrySetResult11- 9
(119 :
true11: >
)11> ?
;11? @
return33 
await33  
Task33! %
.33% &

FromResult33& 0
(330 1
Result331 7
<337 8
Unit338 <
,33< =
NetworkFailure33> L
>33L M
.33M N
Ok33N P
(33P Q
Unit33Q U
.33U V
Value33V [
)33[ \
)33\ ]
;33] ^
}44 
,44 
allowDuplicates55 
:55  
false55! &
,55& '
token66 
:66 
cancellationToken66 (
)66( )
.66) *
ConfigureAwait66* 8
(668 9
false669 >
)66> ?
;66? @
if88 
(88 
networkResult88 
.88 
IsOk88 "
)88" #
{99 
await:: $
responseCompletionSource:: .
.::. /
Task::/ 3
.::3 4
ConfigureAwait::4 B
(::B C
false::C H
)::H I
;::I J
};; 
else<< 
{== 
Log>> 
.>> 
Warning>> 
(>> 
$str	>> é
,
>>é è
networkResult?? !
.??! "
	UnwrapErr??" +
(??+ ,
)??, -
.??- .
Message??. 5
)??5 6
;??6 7
_@@ 
=@@ 
Task@@ 
.@@ 
Run@@ 
(@@ 
async@@ "
(@@# $
)@@$ %
=>@@& (
{AA 
tryBB 
{CC 
awaitDD &
EnsureProtocolInBackgroundDD 8
(DD8 9
)DD9 :
;DD: ;
}EE 
catchFF 
(FF 
	ExceptionFF $
exFF% '
)FF' (
{GG 
LogHH 
.HH 
WarningHH #
(HH# $
exHH$ &
,HH& '
$strHH( f
)HHf g
;HHg h
}II 
}JJ 
)JJ 
.JJ 
ContinueWithJJ 
(JJ  
taskKK 
=>KK 
{LL 
ifMM 
(MM 
taskMM  
.MM  !
	IsFaultedMM! *
&&MM+ -
taskMM. 2
.MM2 3
	ExceptionMM3 <
!=MM= ?
nullMM@ D
)MMD E
{NN 
LogOO 
.OO  
ErrorOO  %
(OO% &
taskOO& *
.OO* +
	ExceptionOO+ 4
,OO4 5
$strOO6 t
)OOt u
;OOu v
}PP 
}QQ 
,QQ 
TaskSchedulerRR !
.RR! "
DefaultRR" )
)RR) *
;RR* +
}SS  
pendingLogoutStorageVV  
.VV  !
ClearPendingLogoutVV! 3
(VV3 4
)VV4 5
;VV5 6
}WW 	
catchXX 
(XX 
	ExceptionXX 
exXX 
)XX 
{YY 	
LogZZ 
.ZZ 
ErrorZZ 
(ZZ 
exZZ 
,ZZ 
$strZZ ]
)ZZ] ^
;ZZ^ _
}[[ 	
}\\ 
private^^ 
async^^ 
Task^^ &
EnsureProtocolInBackground^^ 1
(^^1 2
)^^2 3
{__ 
Result`` 
<`` 
uint`` 
,`` 
NetworkFailure`` #
>``# $
ensureResult``% 1
=``2 3
await``4 9
networkProvider``: I
.``I J&
EnsureProtocolForTypeAsync``J d
(``d e
PubKeyExchangeTypeaa 
.aa &
DataCenterEphemeralConnectaa 9
)aa9 :
;aa: ;
ifcc 

(cc 
ensureResultcc 
.cc 
IsErrcc 
)cc 
{dd 	
Logee 
.ee 
Erroree 
(ee 
$stree G
,eeG H
ensureResultff 
.ff 
	UnwrapErrff &
(ff& '
)ff' (
.ff( )
Messageff) 0
)ff0 1
;ff1 2
}gg 	
}hh 
}ii ß2
É/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/OperationTimeoutProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
public		 
sealed		 
class		 $
OperationTimeoutProvider		 ,
:		- .%
IOperationTimeoutProvider		/ H
{

 
private 
static 
readonly 
TimeSpan $
DefaultTimeout% 3
=4 5
Timeout6 =
.= >
InfiniteTimeSpan> N
;N O
private 
const 
double #
MAX_ADAPTIVE_MULTIPLIER 0
=1 2
$num3 6
;6 7
private 
const 
double )
ADAPTIVE_MULTIPLIER_INCREMENT 6
=7 8
$num9 <
;< =
private 
static 
readonly 
FrozenDictionary ,
<, -
RpcServiceType- ;
,; <
TimeSpan= E
>E F
ServiceTimeoutsG V
=W X
new 

Dictionary 
< 
RpcServiceType %
,% &
TimeSpan' /
>/ 0
{ 	
[ 
RpcServiceType 
.  
InitiateVerification 0
]0 1
=2 3
Timeout4 ;
.; <
InfiniteTimeSpan< L
,L M
[ 
RpcServiceType 
. #
EstablishSecrecyChannel 3
]3 4
=5 6
Timeout7 >
.> ?
InfiniteTimeSpan? O
,O P
[ 
RpcServiceType 
. !
RestoreSecrecyChannel 1
]1 2
=3 4
Timeout5 <
.< =
InfiniteTimeSpan= M
,M N
[ 
RpcServiceType 
. /
#EstablishAuthenticatedSecureChannel ?
]? @
=A B
TimeoutC J
.J K
InfiniteTimeSpanK [
,[ \
[ 
RpcServiceType 
. 
RegistrationInit ,
], -
=. /
Timeout0 7
.7 8
InfiniteTimeSpan8 H
,H I
[ 
RpcServiceType 
.  
RegistrationComplete 0
]0 1
=2 3
Timeout4 ;
.; <
InfiniteTimeSpan< L
,L M
[ 
RpcServiceType 
. !
RecoverySecretKeyInit 1
]1 2
=3 4
Timeout5 <
.< =
InfiniteTimeSpan= M
,M N
[ 
RpcServiceType 
. %
RecoverySecretKeyComplete 5
]5 6
=7 8
Timeout9 @
.@ A
InfiniteTimeSpanA Q
,Q R
[ 
RpcServiceType 
. 
SignInInitRequest -
]- .
=/ 0
Timeout1 8
.8 9
InfiniteTimeSpan9 I
,I J
[ 
RpcServiceType 
. !
SignInCompleteRequest 1
]1 2
=3 4
Timeout5 <
.< =
InfiniteTimeSpan= M
,M N
[ 
RpcServiceType 
.  
ValidateMobileNumber 0
]0 1
=2 3
Timeout4 ;
.; <
InfiniteTimeSpan< L
,L M
[ 
RpcServiceType 
. )
CheckMobileNumberAvailability 9
]9 :
=; <
Timeout= D
.D E
InfiniteTimeSpanE U
,U V
[ 
RpcServiceType 
. 
	VerifyOtp %
]% &
=' (
Timeout) 0
.0 1
InfiniteTimeSpan1 A
,A B
[   
RpcServiceType   
.   
RegisterAppDevice   -
]  - .
=  / 0
Timeout  1 8
.  8 9
InfiniteTimeSpan  9 I
,  I J
[!! 
RpcServiceType!! 
.!! 
Logout!! "
]!!" #
=!!$ %
Timeout!!& -
.!!- .
InfiniteTimeSpan!!. >
}"" 	
.""	 

ToFrozenDictionary""
 
("" 
)"" 
;"" 
public== 

TimeSpan== 

GetTimeout== 
(== 
RpcServiceType== -
serviceType==. 9
,==9 :
RpcRequestContext==; L
?==L M
requestContext==N \
===] ^
null==_ c
)==c d
{>> 
TimeSpan?? 
baseTimeout?? 
=?? 
ServiceTimeouts?? .
.??. /
GetValueOrDefault??/ @
(??@ A
serviceType??A L
,??L M
DefaultTimeout??N \
)??\ ]
;??] ^
ifAA 

(AA 
requestContextAA 
isAA 
{AA 
AttemptAA  '
:AA' (
>AA) *
$numAA+ ,
}AA- .
)AA. /
{BB 	
doubleCC 

multiplierCC 
=CC '
CalculateAdaptiveMultiplierCC  ;
(CC; <
requestContextCC< J
.CCJ K
AttemptCCK R
)CCR S
;CCS T
baseTimeoutDD 
=DD 
TimeSpanDD "
.DD" #
FromMillisecondsDD# 3
(DD3 4
baseTimeoutDD4 ?
.DD? @
TotalMillisecondsDD@ Q
*DDR S

multiplierDDT ^
)DD^ _
;DD_ `
}EE 	
returnGG 
baseTimeoutGG 
;GG 
}HH 
privateJJ 
staticJJ 
doubleJJ '
CalculateAdaptiveMultiplierJJ 5
(JJ5 6
intJJ6 9
attemptJJ: A
)JJA B
{KK 
doubleLL 

multiplierLL 
=LL 
$numLL 
+LL  !
(LL" #
attemptLL# *
-LL+ ,
$numLL- .
)LL. /
*LL0 1)
ADAPTIVE_MULTIPLIER_INCREMENTLL2 O
;LLO P
returnMM 
MathMM 
.MM 
MinMM 
(MM 

multiplierMM "
,MM" ##
MAX_ADAPTIVE_MULTIPLIERMM$ ;
)MM; <
;MM< =
}NN 
}OO  ˆ
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/LogoutProofHandler.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
public 
class 
LogoutProofHandler 
(  
IIdentityService  0
identityService1 @
,@ A-
!IApplicationSecureStorageProviderB c-
 applicationSecureStorageProvider	d Ñ
)
Ñ Ö
{ 
public 

async 
Task 
< 
Result 
< 
Unit !
,! "
LogoutFailure# 0
>0 1
>1 2&
VerifyRevocationProofAsync3 M
(M N
LogoutResponse 
response 
,  
string 
membershipId 
, 
uint 
	connectId 
) 
{ 
Result 
< 
byte 
[ 
] 
, 
LogoutFailure $
>$ %
proofValidation& 5
=6 7)
ValidateRevocationProofFormat8 U
(U V
responseV ^
)^ _
;_ `
if 

( 
proofValidation 
. 
IsErr !
)! "
{ 	
return   
Result   
<   
Unit   
,   
LogoutFailure    -
>  - .
.  . /
Err  / 2
(  2 3
proofValidation  3 B
.  B C
	UnwrapErr  C L
(  L M
)  M N
)  N O
;  O P
}!! 	
byte## 
[## 
]## 
revocationProof## 
=##  
proofValidation##! 0
.##0 1
Unwrap##1 7
(##7 8
)##8 9
;##9 :
Result%% 
<%% 
ParsedProof%% 
,%% 
LogoutFailure%% )
>%%) *
parseResult%%+ 6
=%%7 8 
ParseRevocationProof%%9 M
(%%M N
revocationProof%%N ]
)%%] ^
;%%^ _
if&& 

(&& 
parseResult&& 
.&& 
IsErr&& 
)&& 
{'' 	
return(( 
Result(( 
<(( 
Unit(( 
,(( 
LogoutFailure((  -
>((- .
.((. /
Err((/ 2
(((2 3
parseResult((3 >
.((> ?
	UnwrapErr((? H
(((H I
)((I J
)((J K
;((K L
})) 	
ParsedProof++ 
parsed++ 
=++ 
parseResult++ (
.++( )
Unwrap++) /
(++/ 0
)++0 1
;++1 2
return-- 
await-- $
VerifyAndStoreProofAsync-- -
(--- .
membershipId--. :
,--: ;
	connectId--< E
,--E F
response--G O
.--O P
ServerTimestamp--P _
,--_ `
parsed--a g
,--g h
revocationProof--i x
)--x y
;--y z
}.. 
private00 
static00 
Result00 
<00 
byte00 
[00 
]00  
,00  !
LogoutFailure00" /
>00/ 0)
ValidateRevocationProofFormat001 N
(00N O
LogoutResponse00O ]
response00^ f
)00f g
{11 
if22 

(22 
response22 
.22 
RevocationProof22 $
==22% '
null22( ,
||22- /
response220 8
.228 9
RevocationProof229 H
.22H I
IsEmpty22I P
)22P Q
{33 	
Log44 
.44 
Warning44 
(44 
$str44 M
)44M N
;44N O
return55 
Result55 
<55 
byte55 
[55 
]55  
,55  !
LogoutFailure55" /
>55/ 0
.550 1
Err551 4
(554 5
LogoutFailure66 
.66 "
InvalidRevocationProof66 4
(664 5
$str665 ^
)66^ _
)66_ `
;66` a
}77 	
byte99 
[99 
]99 
revocationProof99 
=99  
response99! )
.99) *
RevocationProof99* 9
.999 :
ToByteArray99: E
(99E F
)99F G
;99G H
const:: 
int:: 

NONCE_SIZE:: 
=:: 
$num:: !
;::! "
const;; 
int;; 
	HMAC_SIZE;; 
=;; 
$num;;  
;;;  !
int<< 
minSize<< 
=<< 
$num<< 
+<< 
sizeof<<  
(<<  !
int<<! $
)<<$ %
*<<& '
$num<<( )
+<<* +

NONCE_SIZE<<, 6
+<<7 8
	HMAC_SIZE<<9 B
;<<B C
if>> 

(>> 
revocationProof>> 
.>> 
Length>> "
<>># $
minSize>>% ,
)>>, -
{?? 	
Log@@ 
.@@ 
Warning@@ 
(@@ 
$str@@ T
,@@T U
revocationProof@@V e
.@@e f
Length@@f l
)@@l m
;@@m n
returnAA 
ResultAA 
<AA 
byteAA 
[AA 
]AA  
,AA  !
LogoutFailureAA" /
>AA/ 0
.AA0 1
ErrAA1 4
(AA4 5
LogoutFailureBB 
.BB "
InvalidRevocationProofBB 4
(BB4 5
$"BB5 7
$strBB7 S
{BBS T
revocationProofBBT c
.BBc d
LengthBBd j
}BBj k
$strBBk q
"BBq r
)BBr s
)BBs t
;BBt u
}CC 	
returnEE 
ResultEE 
<EE 
byteEE 
[EE 
]EE 
,EE 
LogoutFailureEE +
>EE+ ,
.EE, -
OkEE- /
(EE/ 0
revocationProofEE0 ?
)EE? @
;EE@ A
}FF 
privateHH 
readonlyHH 
recordHH 
structHH "
ParsedProofHH# .
(HH. /
byteHH/ 3
[HH3 4
]HH4 5
NonceHH6 ;
,HH; <
intHH= @
FingerprintLengthHHA R
,HHR S
byteHHT X
[HHX Y
]HHY Z
FingerprintHH[ f
,HHf g
byteHHh l
[HHl m
]HHm n
	HmacProofHHo x
)HHx y
;HHy z
privateJJ 
staticJJ 
ResultJJ 
<JJ 
ParsedProofJJ %
,JJ% &
LogoutFailureJJ' 4
>JJ4 5 
ParseRevocationProofJJ6 J
(JJJ K
byteJJK O
[JJO P
]JJP Q
revocationProofJJR a
)JJa b
{KK 
constLL 
byteLL 
PROOF_VERSION_HMACLL %
=LL& '
$numLL( )
;LL) *
constMM 
intMM 

NONCE_SIZEMM 
=MM 
$numMM !
;MM! "
constNN 
intNN 
	HMAC_SIZENN 
=NN 
$numNN  
;NN  !
constOO 
intOO  
MAX_FINGERPRINT_SIZEOO &
=OO' (
$numOO) +
;OO+ ,
tryQQ 
{RR 	
usingSS 
MemoryStreamSS 
proofStreamSS *
=SS+ ,
newSS- 0
(SS0 1
revocationProofSS1 @
,SS@ A
writableSSB J
:SSJ K
falseSSL Q
)SSQ R
;SSR S
usingTT 
BinaryReaderTT 
readerTT %
=TT& '
newTT( +
(TT+ ,
proofStreamTT, 7
)TT7 8
;TT8 9
ResultVV 
<VV 
UnitVV 
,VV 
LogoutFailureVV &
>VV& '
versionCheckVV( 4
=VV5 6 
ValidateProofVersionVV7 K
(VVK L
readerVVL R
,VVR S
PROOF_VERSION_HMACVVT f
)VVf g
;VVg h
ifWW 
(WW 
versionCheckWW 
.WW 
IsErrWW "
)WW" #
{XX 
returnYY 
ResultYY 
<YY 
ParsedProofYY )
,YY) *
LogoutFailureYY+ 8
>YY8 9
.YY9 :
ErrYY: =
(YY= >
versionCheckYY> J
.YYJ K
	UnwrapErrYYK T
(YYT U
)YYU V
)YYV W
;YYW X
}ZZ 
Result\\ 
<\\ 
byte\\ 
[\\ 
]\\ 
,\\ 
LogoutFailure\\ (
>\\( )
nonceResult\\* 5
=\\6 7
	ReadNonce\\8 A
(\\A B
reader\\B H
,\\H I

NONCE_SIZE\\J T
)\\T U
;\\U V
if]] 
(]] 
nonceResult]] 
.]] 
IsErr]] !
)]]! "
{^^ 
return__ 
Result__ 
<__ 
ParsedProof__ )
,__) *
LogoutFailure__+ 8
>__8 9
.__9 :
Err__: =
(__= >
nonceResult__> I
.__I J
	UnwrapErr__J S
(__S T
)__T U
)__U V
;__V W
}`` 
bytebb 
[bb 
]bb 
noncebb 
=bb 
nonceResultbb &
.bb& '
Unwrapbb' -
(bb- .
)bb. /
;bb/ 0
Resultdd 
<dd 
FingerprintDatadd "
,dd" #
LogoutFailuredd$ 1
>dd1 2
fingerprintResultdd3 D
=ddE F
ReadFingerprintddG V
(ddV W
readerddW ]
,dd] ^ 
MAX_FINGERPRINT_SIZEdd_ s
)dds t
;ddt u
ifee 
(ee 
fingerprintResultee !
.ee! "
IsErree" '
)ee' (
{ff 
returngg 
Resultgg 
<gg 
ParsedProofgg )
,gg) *
LogoutFailuregg+ 8
>gg8 9
.gg9 :
Errgg: =
(gg= >
fingerprintResultgg> O
.ggO P
	UnwrapErrggP Y
(ggY Z
)ggZ [
)gg[ \
;gg\ ]
}hh 
FingerprintDatajj 
fingerprintDatajj +
=jj, -
fingerprintResultjj. ?
.jj? @
Unwrapjj@ F
(jjF G
)jjG H
;jjH I
Resultll 
<ll 
bytell 
[ll 
]ll 
,ll 
LogoutFailurell (
>ll( )

hmacResultll* 4
=ll5 6
ReadHmacll7 ?
(ll? @
readerll@ F
,llF G
revocationProofllH W
.llW X
LengthllX ^
,ll^ _
	HMAC_SIZEll` i
)lli j
;llj k
ifmm 
(mm 

hmacResultmm 
.mm 
IsErrmm  
)mm  !
{nn 
returnoo 
Resultoo 
<oo 
ParsedProofoo )
,oo) *
LogoutFailureoo+ 8
>oo8 9
.oo9 :
Erroo: =
(oo= >

hmacResultoo> H
.ooH I
	UnwrapErrooI R
(ooR S
)ooS T
)ooT U
;ooU V
}pp 
byterr 
[rr 
]rr 
	hmacProofrr 
=rr 

hmacResultrr )
.rr) *
Unwraprr* 0
(rr0 1
)rr1 2
;rr2 3
returntt 
Resulttt 
<tt 
ParsedProoftt %
,tt% &
LogoutFailurett' 4
>tt4 5
.tt5 6
Oktt6 8
(tt8 9
newtt9 <
ParsedProoftt= H
(ttH I
noncettI N
,ttN O
fingerprintDatattP _
.tt_ `
Lengthtt` f
,ttf g
fingerprintDatatth w
.ttw x
Datattx |
,tt| }
	hmacProof	tt~ á
)
ttá à
)
ttà â
;
ttâ ä
}uu 	
catchvv 
(vv  
EndOfStreamExceptionvv #
exvv$ &
)vv& '
{ww 	
Logxx 
.xx 
Warningxx 
(xx 
exxx 
,xx 
$strxx V
)xxV W
;xxW X
returnyy 
Resultyy 
<yy 
ParsedProofyy %
,yy% &
LogoutFailureyy' 4
>yy4 5
.yy5 6
Erryy6 9
(yy9 :
LogoutFailurezz 
.zz "
InvalidRevocationProofzz 4
(zz4 5
$strzz5 `
)zz` a
)zza b
;zzb c
}{{ 	
}|| 
private~~ 
static~~ 
Result~~ 
<~~ 
Unit~~ 
,~~ 
LogoutFailure~~  -
>~~- . 
ValidateProofVersion~~/ C
(~~C D
BinaryReader~~D P
reader~~Q W
,~~W X
byte~~Y ]
expectedVersion~~^ m
)~~m n
{ 
byte
ÄÄ 
version
ÄÄ 
=
ÄÄ 
reader
ÄÄ 
.
ÄÄ 
ReadByte
ÄÄ &
(
ÄÄ& '
)
ÄÄ' (
;
ÄÄ( )
if
ÅÅ 

(
ÅÅ 
version
ÅÅ 
!=
ÅÅ 
expectedVersion
ÅÅ &
)
ÅÅ& '
{
ÇÇ 	
Log
ÉÉ 
.
ÉÉ 
Warning
ÉÉ 
(
ÉÉ 
$str
ÉÉ X
,
ÉÉX Y
version
ÉÉZ a
)
ÉÉa b
;
ÉÉb c
return
ÑÑ 
Result
ÑÑ 
<
ÑÑ 
Unit
ÑÑ 
,
ÑÑ 
LogoutFailure
ÑÑ  -
>
ÑÑ- .
.
ÑÑ. /
Err
ÑÑ/ 2
(
ÑÑ2 3
LogoutFailure
ÖÖ 
.
ÖÖ $
InvalidRevocationProof
ÖÖ 4
(
ÖÖ4 5
$"
ÖÖ5 7
$str
ÖÖ7 ]
{
ÖÖ] ^
version
ÖÖ^ e
}
ÖÖe f
"
ÖÖf g
)
ÖÖg h
)
ÖÖh i
;
ÖÖi j
}
ÜÜ 	
return
áá 
Result
áá 
<
áá 
Unit
áá 
,
áá 
LogoutFailure
áá )
>
áá) *
.
áá* +
Ok
áá+ -
(
áá- .
Unit
áá. 2
.
áá2 3
Value
áá3 8
)
áá8 9
;
áá9 :
}
àà 
private
ää 
static
ää 
Result
ää 
<
ää 
byte
ää 
[
ää 
]
ää  
,
ää  !
LogoutFailure
ää" /
>
ää/ 0
	ReadNonce
ää1 :
(
ää: ;
BinaryReader
ää; G
reader
ääH N
,
ääN O
int
ääP S
expectedSize
ääT `
)
ää` a
{
ãã 
int
åå 
nonceLength
åå 
=
åå 
reader
åå  
.
åå  !
	ReadInt32
åå! *
(
åå* +
)
åå+ ,
;
åå, -
if
çç 

(
çç 
nonceLength
çç 
!=
çç 
expectedSize
çç '
)
çç' (
{
éé 	
Log
èè 
.
èè 
Warning
èè 
(
èè 
$str
èè ]
,
èè] ^
nonceLength
èè_ j
,
èèj k
expectedSize
èèl x
)
èèx y
;
èèy z
return
êê 
Result
êê 
<
êê 
byte
êê 
[
êê 
]
êê  
,
êê  !
LogoutFailure
êê" /
>
êê/ 0
.
êê0 1
Err
êê1 4
(
êê4 5
LogoutFailure
ëë 
.
ëë $
InvalidRevocationProof
ëë 4
(
ëë4 5
$"
ëë5 7
$str
ëë7 L
{
ëëL M
nonceLength
ëëM X
}
ëëX Y
"
ëëY Z
)
ëëZ [
)
ëë[ \
;
ëë\ ]
}
íí 	
byte
îî 
[
îî 
]
îî 
nonce
îî 
=
îî 
reader
îî 
.
îî 
	ReadBytes
îî '
(
îî' (
nonceLength
îî( 3
)
îî3 4
;
îî4 5
if
ïï 

(
ïï 
nonce
ïï 
.
ïï 
Length
ïï 
!=
ïï 
nonceLength
ïï '
)
ïï' (
{
ññ 	
Log
óó 
.
óó 
Warning
óó 
(
óó 
$str
óó g
,
óóg h
nonceLength
óói t
,
óót u
nonce
óóv {
.
óó{ |
Lengthóó| Ç
)óóÇ É
;óóÉ Ñ
return
òò 
Result
òò 
<
òò 
byte
òò 
[
òò 
]
òò  
,
òò  !
LogoutFailure
òò" /
>
òò/ 0
.
òò0 1
Err
òò1 4
(
òò4 5
LogoutFailure
ôô 
.
ôô $
InvalidRevocationProof
ôô 4
(
ôô4 5
$str
ôô5 e
)
ôôe f
)
ôôf g
;
ôôg h
}
öö 	
return
úú 
Result
úú 
<
úú 
byte
úú 
[
úú 
]
úú 
,
úú 
LogoutFailure
úú +
>
úú+ ,
.
úú, -
Ok
úú- /
(
úú/ 0
nonce
úú0 5
)
úú5 6
;
úú6 7
}
ùù 
private
üü 
readonly
üü 
record
üü 
struct
üü "
FingerprintData
üü# 2
(
üü2 3
int
üü3 6
Length
üü7 =
,
üü= >
byte
üü? C
[
üüC D
]
üüD E
Data
üüF J
)
üüJ K
;
üüK L
private
°° 
static
°° 
Result
°° 
<
°° 
FingerprintData
°° )
,
°°) *
LogoutFailure
°°+ 8
>
°°8 9
ReadFingerprint
°°: I
(
°°I J
BinaryReader
°°J V
reader
°°W ]
,
°°] ^
int
°°_ b
maxSize
°°c j
)
°°j k
{
¢¢ 
int
££ 
fingerprintLength
££ 
=
££ 
reader
££  &
.
££& '
	ReadInt32
££' 0
(
££0 1
)
££1 2
;
££2 3
if
§§ 

(
§§ 
fingerprintLength
§§ 
<
§§ 
$num
§§  !
||
§§" $
fingerprintLength
§§% 6
>
§§7 8
maxSize
§§9 @
)
§§@ A
{
•• 	
Log
¶¶ 
.
¶¶ 
Warning
¶¶ 
(
¶¶ 
$str
¶¶ U
,
¶¶U V
fingerprintLength
¶¶W h
)
¶¶h i
;
¶¶i j
return
ßß 
Result
ßß 
<
ßß 
FingerprintData
ßß )
,
ßß) *
LogoutFailure
ßß+ 8
>
ßß8 9
.
ßß9 :
Err
ßß: =
(
ßß= >
LogoutFailure
®® 
.
®® $
InvalidRevocationProof
®® 4
(
®®4 5
$"
®®5 7
$str
®®7 R
{
®®R S
fingerprintLength
®®S d
}
®®d e
"
®®e f
)
®®f g
)
®®g h
;
®®h i
}
©© 	
byte
´´ 
[
´´ 
]
´´ 
fingerprint
´´ 
=
´´ 
fingerprintLength
´´ .
>
´´/ 0
$num
´´1 2
?
´´3 4
reader
´´5 ;
.
´´; <
	ReadBytes
´´< E
(
´´E F
fingerprintLength
´´F W
)
´´W X
:
´´Y Z
Array
´´[ `
.
´´` a
Empty
´´a f
<
´´f g
byte
´´g k
>
´´k l
(
´´l m
)
´´m n
;
´´n o
if
¨¨ 

(
¨¨ 
fingerprint
¨¨ 
.
¨¨ 
Length
¨¨ 
!=
¨¨ !
fingerprintLength
¨¨" 3
)
¨¨3 4
{
≠≠ 	
Log
ÆÆ 
.
ÆÆ 
Warning
ÆÆ 
(
ÆÆ 
$str
ÆÆ m
,
ÆÆm n 
fingerprintLengthÆÆo Ä
,ÆÆÄ Å
fingerprintÆÆÇ ç
.ÆÆç é
LengthÆÆé î
)ÆÆî ï
;ÆÆï ñ
return
ØØ 
Result
ØØ 
<
ØØ 
FingerprintData
ØØ )
,
ØØ) *
LogoutFailure
ØØ+ 8
>
ØØ8 9
.
ØØ9 :
Err
ØØ: =
(
ØØ= >
LogoutFailure
∞∞ 
.
∞∞ $
InvalidRevocationProof
∞∞ 4
(
∞∞4 5
$str
∞∞5 k
)
∞∞k l
)
∞∞l m
;
∞∞m n
}
±± 	
return
≥≥ 
Result
≥≥ 
<
≥≥ 
FingerprintData
≥≥ %
,
≥≥% &
LogoutFailure
≥≥' 4
>
≥≥4 5
.
≥≥5 6
Ok
≥≥6 8
(
≥≥8 9
new
≥≥9 <
FingerprintData
≥≥= L
(
≥≥L M
fingerprintLength
≥≥M ^
,
≥≥^ _
fingerprint
≥≥` k
)
≥≥k l
)
≥≥l m
;
≥≥m n
}
¥¥ 
private
∂∂ 
static
∂∂ 
Result
∂∂ 
<
∂∂ 
byte
∂∂ 
[
∂∂ 
]
∂∂  
,
∂∂  !
LogoutFailure
∂∂" /
>
∂∂/ 0
ReadHmac
∂∂1 9
(
∂∂9 :
BinaryReader
∂∂: F
reader
∂∂G M
,
∂∂M N
int
∂∂O R
totalProofLength
∂∂S c
,
∂∂c d
int
∂∂e h
expectedHmacSize
∂∂i y
)
∂∂y z
{
∑∑ 
int
∏∏ 
remainingBytes
∏∏ 
=
∏∏ 
(
∏∏ 
int
∏∏ !
)
∏∏! "
(
∏∏" #
totalProofLength
∏∏# 3
-
∏∏4 5
reader
∏∏6 <
.
∏∏< =

BaseStream
∏∏= G
.
∏∏G H
Position
∏∏H P
)
∏∏P Q
;
∏∏Q R
if
ππ 

(
ππ 
remainingBytes
ππ 
!=
ππ 
expectedHmacSize
ππ .
)
ππ. /
{
∫∫ 	
Log
ªª 
.
ªª 
Warning
ªª 
(
ªª 
$str
ªª I
,
ªªI J
remainingBytes
ªªK Y
)
ªªY Z
;
ªªZ [
return
ºº 
Result
ºº 
<
ºº 
byte
ºº 
[
ºº 
]
ºº  
,
ºº  !
LogoutFailure
ºº" /
>
ºº/ 0
.
ºº0 1
Err
ºº1 4
(
ºº4 5
LogoutFailure
ΩΩ 
.
ΩΩ $
InvalidRevocationProof
ΩΩ 4
(
ΩΩ4 5
$"
ΩΩ5 7
$str
ΩΩ7 K
{
ΩΩK L
remainingBytes
ΩΩL Z
}
ΩΩZ [
"
ΩΩ[ \
)
ΩΩ\ ]
)
ΩΩ] ^
;
ΩΩ^ _
}
ææ 	
byte
¿¿ 
[
¿¿ 
]
¿¿ 
	hmacProof
¿¿ 
=
¿¿ 
reader
¿¿ !
.
¿¿! "
	ReadBytes
¿¿" +
(
¿¿+ ,
expectedHmacSize
¿¿, <
)
¿¿< =
;
¿¿= >
if
¡¡ 

(
¡¡ 
	hmacProof
¡¡ 
.
¡¡ 
Length
¡¡ 
!=
¡¡ 
expectedHmacSize
¡¡  0
)
¡¡0 1
{
¬¬ 	
Log
√√ 
.
√√ 
Warning
√√ 
(
√√ 
$str
√√ f
,
√√f g
expectedHmacSize
√√h x
,
√√x y
	hmacProof√√z É
.√√É Ñ
Length√√Ñ ä
)√√ä ã
;√√ã å
return
ƒƒ 
Result
ƒƒ 
<
ƒƒ 
byte
ƒƒ 
[
ƒƒ 
]
ƒƒ  
,
ƒƒ  !
LogoutFailure
ƒƒ" /
>
ƒƒ/ 0
.
ƒƒ0 1
Err
ƒƒ1 4
(
ƒƒ4 5
LogoutFailure
≈≈ 
.
≈≈ $
InvalidRevocationProof
≈≈ 4
(
≈≈4 5
$str
≈≈5 d
)
≈≈d e
)
≈≈e f
;
≈≈f g
}
∆∆ 	
return
»» 
Result
»» 
<
»» 
byte
»» 
[
»» 
]
»» 
,
»» 
LogoutFailure
»» +
>
»»+ ,
.
»», -
Ok
»»- /
(
»»/ 0
	hmacProof
»»0 9
)
»»9 :
;
»»: ;
}
…… 
private
ÀÀ 
async
ÀÀ 
Task
ÀÀ 
<
ÀÀ 
Result
ÀÀ 
<
ÀÀ 
Unit
ÀÀ "
,
ÀÀ" #
LogoutFailure
ÀÀ$ 1
>
ÀÀ1 2
>
ÀÀ2 3&
VerifyAndStoreProofAsync
ÀÀ4 L
(
ÀÀL M
string
ÃÃ 
membershipId
ÃÃ 
,
ÃÃ 
uint
ÕÕ 
	connectId
ÕÕ 
,
ÕÕ 
long
ŒŒ 
serverTimestamp
ŒŒ 
,
ŒŒ 
ParsedProof
œœ 
parsed
œœ 
,
œœ 
byte
–– 
[
–– 
]
–– 
revocationProof
–– 
)
–– 
{
—— 
byte
““ 
[
““ 
]
““ 
?
““ 
proofKey
““ 
=
““ 
null
““ 
;
““  
try
‘‘ 
{
’’ 	
Result
÷÷ 
<
÷÷ 
byte
÷÷ 
[
÷÷ 
]
÷÷ 
,
÷÷ 
LogoutFailure
÷÷ (
>
÷÷( )
proofKeyResult
÷÷* 8
=
÷÷9 :
await
÷÷; @
LoadProofKeyAsync
÷÷A R
(
÷÷R S
membershipId
÷÷S _
)
÷÷_ `
;
÷÷` a
if
◊◊ 
(
◊◊ 
proofKeyResult
◊◊ 
.
◊◊ 
IsErr
◊◊ $
)
◊◊$ %
{
ÿÿ 
return
ŸŸ 
Result
ŸŸ 
<
ŸŸ 
Unit
ŸŸ "
,
ŸŸ" #
LogoutFailure
ŸŸ$ 1
>
ŸŸ1 2
.
ŸŸ2 3
Err
ŸŸ3 6
(
ŸŸ6 7
proofKeyResult
ŸŸ7 E
.
ŸŸE F
	UnwrapErr
ŸŸF O
(
ŸŸO P
)
ŸŸP Q
)
ŸŸQ R
;
ŸŸR S
}
⁄⁄ 
proofKey
‹‹ 
=
‹‹ 
proofKeyResult
‹‹ %
.
‹‹% &
Unwrap
‹‹& ,
(
‹‹, -
)
‹‹- .
;
‹‹. /
byte
ﬁﬁ 
[
ﬁﬁ 
]
ﬁﬁ 
canonicalData
ﬁﬁ  
=
ﬁﬁ! " 
BuildCanonicalData
ﬁﬁ# 5
(
ﬁﬁ5 6
membershipId
ﬁﬁ6 B
,
ﬁﬁB C
	connectId
ﬁﬁD M
,
ﬁﬁM N
serverTimestamp
ﬁﬁO ^
,
ﬁﬁ^ _
parsed
ﬁﬁ` f
)
ﬁﬁf g
;
ﬁﬁg h
bool
‡‡ 
isValid
‡‡ 
=
‡‡ !
LogoutKeyDerivation
‡‡ .
.
‡‡. /

VerifyHmac
‡‡/ 9
(
‡‡9 :
proofKey
‡‡: B
,
‡‡B C
canonicalData
‡‡D Q
,
‡‡Q R
parsed
‡‡S Y
.
‡‡Y Z
	HmacProof
‡‡Z c
)
‡‡c d
;
‡‡d e
if
·· 
(
·· 
!
·· 
isValid
·· 
)
·· 
{
‚‚ 
Log
„„ 
.
„„ 
Warning
„„ 
(
„„ 
$str
„„ _
)
„„_ `
;
„„` a
return
‰‰ 
Result
‰‰ 
<
‰‰ 
Unit
‰‰ "
,
‰‰" #
LogoutFailure
‰‰$ 1
>
‰‰1 2
.
‰‰2 3
Err
‰‰3 6
(
‰‰6 7
LogoutFailure
ÂÂ !
.
ÂÂ! "$
InvalidRevocationProof
ÂÂ" 8
(
ÂÂ8 9
$str
ÂÂ9 k
)
ÂÂk l
)
ÂÂl m
;
ÂÂm n
}
ÊÊ 
Result
ËË 
<
ËË 
Unit
ËË 
,
ËË 
LogoutFailure
ËË &
>
ËË& '
storeResult
ËË( 3
=
ËË4 5
await
ËË6 ;'
StoreRevocationProofAsync
ËË< U
(
ËËU V
membershipId
ËËV b
,
ËËb c
revocationProof
ËËd s
)
ËËs t
;
ËËt u
if
ÈÈ 
(
ÈÈ 
storeResult
ÈÈ 
.
ÈÈ 
IsErr
ÈÈ !
)
ÈÈ! "
{
ÍÍ 
Log
ÎÎ 
.
ÎÎ 
Warning
ÎÎ 
(
ÎÎ 
$str
ÎÎ V
,
ÎÎV W
storeResult
ÎÎX c
.
ÎÎc d
	UnwrapErr
ÎÎd m
(
ÎÎm n
)
ÎÎn o
.
ÎÎo p
Message
ÎÎp w
)
ÎÎw x
;
ÎÎx y
}
ÏÏ 
return
ÓÓ 
Result
ÓÓ 
<
ÓÓ 
Unit
ÓÓ 
,
ÓÓ 
LogoutFailure
ÓÓ  -
>
ÓÓ- .
.
ÓÓ. /
Ok
ÓÓ/ 1
(
ÓÓ1 2
Unit
ÓÓ2 6
.
ÓÓ6 7
Value
ÓÓ7 <
)
ÓÓ< =
;
ÓÓ= >
}
ÔÔ 	
finally
 
{
ÒÒ 	
if
ÚÚ 
(
ÚÚ 
proofKey
ÚÚ 
!=
ÚÚ 
null
ÚÚ  
)
ÚÚ  !
{
ÛÛ %
CryptographicOperations
ÙÙ '
.
ÙÙ' (

ZeroMemory
ÙÙ( 2
(
ÙÙ2 3
proofKey
ÙÙ3 ;
)
ÙÙ; <
;
ÙÙ< =
}
ıı 
}
ˆˆ 	
}
˜˜ 
private
˘˘ 
async
˘˘ 
Task
˘˘ 
<
˘˘ 
Result
˘˘ 
<
˘˘ 
byte
˘˘ "
[
˘˘" #
]
˘˘# $
,
˘˘$ %
LogoutFailure
˘˘& 3
>
˘˘3 4
>
˘˘4 5
LoadProofKeyAsync
˘˘6 G
(
˘˘G H
string
˘˘H N
membershipId
˘˘O [
)
˘˘[ \
{
˙˙ 
Result
˚˚ 
<
˚˚ &
SodiumSecureMemoryHandle
˚˚ '
,
˚˚' (#
AuthenticationFailure
˚˚) >
>
˚˚> ?
handleResult
˚˚@ L
=
˚˚M N
await
¸¸ 
identityService
¸¸ !
.
¸¸! "&
LoadMasterKeyHandleAsync
¸¸" :
(
¸¸: ;
membershipId
¸¸; G
)
¸¸G H
.
¸¸H I
ConfigureAwait
¸¸I W
(
¸¸W X
false
¸¸X ]
)
¸¸] ^
;
¸¸^ _
if
˛˛ 

(
˛˛ 
handleResult
˛˛ 
.
˛˛ 
IsErr
˛˛ 
)
˛˛ 
{
ˇˇ 	
Log
ÄÄ 
.
ÄÄ 
Error
ÄÄ 
(
ÄÄ 
$str
ÄÄ ^
)
ÄÄ^ _
;
ÄÄ_ `
return
ÅÅ 
Result
ÅÅ 
<
ÅÅ 
byte
ÅÅ 
[
ÅÅ 
]
ÅÅ  
,
ÅÅ  !
LogoutFailure
ÅÅ" /
>
ÅÅ/ 0
.
ÅÅ0 1
Err
ÅÅ1 4
(
ÅÅ4 5
LogoutFailure
ÇÇ 
.
ÇÇ *
CryptographicOperationFailed
ÇÇ :
(
ÇÇ: ;
$"
ÉÉ 
$str
ÉÉ 3
{
ÉÉ3 4
handleResult
ÉÉ4 @
.
ÉÉ@ A
	UnwrapErr
ÉÉA J
(
ÉÉJ K
)
ÉÉK L
.
ÉÉL M
Message
ÉÉM T
}
ÉÉT U
"
ÉÉU V
)
ÉÉV W
)
ÉÉW X
;
ÉÉX Y
}
ÑÑ 	
using
ÜÜ &
SodiumSecureMemoryHandle
ÜÜ &
masterKeyHandle
ÜÜ' 6
=
ÜÜ7 8
handleResult
ÜÜ9 E
.
ÜÜE F
Unwrap
ÜÜF L
(
ÜÜL M
)
ÜÜM N
;
ÜÜN O
Result
àà 
<
àà 
byte
àà 
[
àà 
]
àà 
,
àà 
SodiumFailure
àà $
>
àà$ %
proofKeyResult
àà& 4
=
àà5 6!
LogoutKeyDerivation
àà7 J
.
ààJ K"
DeriveLogoutProofKey
ààK _
(
àà_ `
masterKeyHandle
àà` o
)
àào p
;
ààp q
if
ââ 

(
ââ 
proofKeyResult
ââ 
.
ââ 
IsErr
ââ  
)
ââ  !
{
ää 	
Log
ãã 
.
ãã 
Error
ãã 
(
ãã 
$str
ãã H
)
ããH I
;
ããI J
return
åå 
Result
åå 
<
åå 
byte
åå 
[
åå 
]
åå  
,
åå  !
LogoutFailure
åå" /
>
åå/ 0
.
åå0 1
Err
åå1 4
(
åå4 5
LogoutFailure
çç 
.
çç *
CryptographicOperationFailed
çç :
(
çç: ;
$"
éé 
$str
éé 3
{
éé3 4
proofKeyResult
éé4 B
.
ééB C
	UnwrapErr
ééC L
(
ééL M
)
ééM N
.
ééN O
Message
ééO V
}
ééV W
"
ééW X
)
ééX Y
)
ééY Z
;
ééZ [
}
èè 	
return
ëë 
Result
ëë 
<
ëë 
byte
ëë 
[
ëë 
]
ëë 
,
ëë 
LogoutFailure
ëë +
>
ëë+ ,
.
ëë, -
Ok
ëë- /
(
ëë/ 0
proofKeyResult
ëë0 >
.
ëë> ?
Unwrap
ëë? E
(
ëëE F
)
ëëF G
)
ëëG H
;
ëëH I
}
íí 
private
îî 
static
îî 
byte
îî 
[
îî 
]
îî  
BuildCanonicalData
îî ,
(
îî, -
string
îî- 3
membershipId
îî4 @
,
îî@ A
uint
îîB F
	connectId
îîG P
,
îîP Q
long
îîR V
serverTimestamp
îîW f
,
îîf g
ParsedProof
îîh s
parsed
îît z
)
îîz {
{
ïï 
using
ññ 
MemoryStream
ññ 
ms
ññ 
=
ññ 
new
ññ  #
(
ññ# $
)
ññ$ %
;
ññ% &
using
óó 
BinaryWriter
óó 
writer
óó !
=
óó" #
new
óó$ '
(
óó' (
ms
óó( *
)
óó* +
;
óó+ ,
writer
ôô 
.
ôô 
Write
ôô 
(
ôô 
Guid
ôô 
.
ôô 
Parse
ôô 
(
ôô  
membershipId
ôô  ,
)
ôô, -
.
ôô- .
ToByteArray
ôô. 9
(
ôô9 :
)
ôô: ;
)
ôô; <
;
ôô< =
writer
öö 
.
öö 
Write
öö 
(
öö 
	connectId
öö 
)
öö 
;
öö  
writer
õõ 
.
õõ 
Write
õõ 
(
õõ 
serverTimestamp
õõ $
)
õõ$ %
;
õõ% &
writer
úú 
.
úú 
Write
úú 
(
úú 
parsed
úú 
.
úú 
FingerprintLength
úú -
)
úú- .
;
úú. /
if
ùù 

(
ùù 
parsed
ùù 
.
ùù 
FingerprintLength
ùù $
>
ùù% &
$num
ùù' (
)
ùù( )
{
ûû 	
writer
üü 
.
üü 
Write
üü 
(
üü 
parsed
üü 
.
üü  
Fingerprint
üü  +
)
üü+ ,
;
üü, -
}
†† 	
writer
°° 
.
°° 
Write
°° 
(
°° 
parsed
°° 
.
°° 
Nonce
°° !
)
°°! "
;
°°" #
writer
¢¢ 
.
¢¢ 
Flush
¢¢ 
(
¢¢ 
)
¢¢ 
;
¢¢ 
return
§§ 
ms
§§ 
.
§§ 
ToArray
§§ 
(
§§ 
)
§§ 
;
§§ 
}
•• 
private
ßß 
async
ßß 
Task
ßß 
<
ßß 
Result
ßß 
<
ßß 
Unit
ßß "
,
ßß" #
LogoutFailure
ßß$ 1
>
ßß1 2
>
ßß2 3'
StoreRevocationProofAsync
ßß4 M
(
ßßM N
string
®® 
membershipId
®® 
,
®® 
byte
©© 
[
©© 
]
©© 
revocationProof
©© 
)
©© 
{
™™ 
try
´´ 
{
¨¨ 	
string
≠≠ 

storageKey
≠≠ 
=
≠≠ *
GetRevocationProofStorageKey
≠≠  <
(
≠≠< =
membershipId
≠≠= I
)
≠≠I J
;
≠≠J K
Result
ØØ 
<
ØØ 
Unit
ØØ 
,
ØØ '
InternalServiceApiFailure
ØØ 2
>
ØØ2 3
storeResult
ØØ4 ?
=
ØØ@ A
await
∞∞ .
 applicationSecureStorageProvider
∞∞ 6
.
∞∞6 7

StoreAsync
∞∞7 A
(
∞∞A B

storageKey
∞∞B L
,
∞∞L M
revocationProof
∞∞N ]
)
∞∞] ^
.
±± 
ConfigureAwait
±± #
(
±±# $
false
±±$ )
)
±±) *
;
±±* +
if
≥≥ 
(
≥≥ 
storeResult
≥≥ 
.
≥≥ 
IsErr
≥≥ !
)
≥≥! "
{
¥¥ 
Log
µµ 
.
µµ 
Error
µµ 
(
µµ 
$str
µµ r
,
µµr s
membershipId
∂∂  
)
∂∂  !
;
∂∂! "
return
∑∑ 
Result
∑∑ 
<
∑∑ 
Unit
∑∑ "
,
∑∑" #
LogoutFailure
∑∑$ 1
>
∑∑1 2
.
∑∑2 3
Err
∑∑3 6
(
∑∑6 7
LogoutFailure
∏∏ !
.
∏∏! "
UnexpectedError
∏∏" 1
(
∏∏1 2
$"
ππ 
$str
ππ ;
{
ππ; <
storeResult
ππ< G
.
ππG H
	UnwrapErr
ππH Q
(
ππQ R
)
ππR S
.
ππS T
Message
ππT [
}
ππ[ \
"
ππ\ ]
)
ππ] ^
)
ππ^ _
;
ππ_ `
}
∫∫ 
return
ºº 
Result
ºº 
<
ºº 
Unit
ºº 
,
ºº 
LogoutFailure
ºº  -
>
ºº- .
.
ºº. /
Ok
ºº/ 1
(
ºº1 2
Unit
ºº2 6
.
ºº6 7
Value
ºº7 <
)
ºº< =
;
ºº= >
}
ΩΩ 	
catch
ææ 
(
ææ 
	Exception
ææ 
ex
ææ 
)
ææ 
{
øø 	
Log
¿¿ 
.
¿¿ 
Error
¿¿ 
(
¿¿ 
ex
¿¿ 
,
¿¿ 
$str
¿¿ Z
)
¿¿Z [
;
¿¿[ \
return
¡¡ 
Result
¡¡ 
<
¡¡ 
Unit
¡¡ 
,
¡¡ 
LogoutFailure
¡¡  -
>
¡¡- .
.
¡¡. /
Err
¡¡/ 2
(
¡¡2 3
LogoutFailure
¬¬ 
.
¬¬ 
UnexpectedError
¬¬ -
(
¬¬- .
$"
¬¬. 0
$str
¬¬0 B
{
¬¬B C
ex
¬¬C E
.
¬¬E F
Message
¬¬F M
}
¬¬M N
"
¬¬N O
,
¬¬O P
ex
¬¬Q S
)
¬¬S T
)
¬¬T U
;
¬¬U V
}
√√ 	
}
ƒƒ 
public
∆∆ 

static
∆∆ 
async
∆∆ 
Task
∆∆ 
<
∆∆ 
bool
∆∆ !
>
∆∆! "%
HasRevocationProofAsync
∆∆# :
(
∆∆: ;/
!IApplicationSecureStorageProvider
«« )
storageProvider
««* 9
,
««9 :
string
»» 
membershipId
»» 
)
»» 
{
…… 
try
   
{
ÀÀ 	
string
ÃÃ 

storageKey
ÃÃ 
=
ÃÃ *
GetRevocationProofStorageKey
ÃÃ  <
(
ÃÃ< =
membershipId
ÃÃ= I
)
ÃÃI J
;
ÃÃJ K
Result
ŒŒ 
<
ŒŒ 
Option
ŒŒ 
<
ŒŒ 
byte
ŒŒ 
[
ŒŒ 
]
ŒŒ  
>
ŒŒ  !
,
ŒŒ! "'
InternalServiceApiFailure
ŒŒ# <
>
ŒŒ< =
	getResult
ŒŒ> G
=
ŒŒH I
await
œœ 
storageProvider
œœ %
.
œœ% &
TryGetByKeyAsync
œœ& 6
(
œœ6 7

storageKey
œœ7 A
)
œœA B
.
œœB C
ConfigureAwait
œœC Q
(
œœQ R
false
œœR W
)
œœW X
;
œœX Y
if
—— 
(
—— 
	getResult
—— 
.
—— 
IsErr
—— 
)
——  
{
““ 
Log
”” 
.
”” 
Warning
”” 
(
”” 
$str
”” t
,
””t u
membershipId
‘‘  
)
‘‘  !
;
‘‘! "
return
’’ 
false
’’ 
;
’’ 
}
÷÷ 
Option
ÿÿ 
<
ÿÿ 
byte
ÿÿ 
[
ÿÿ 
]
ÿÿ 
>
ÿÿ 
proofOption
ÿÿ &
=
ÿÿ' (
	getResult
ÿÿ) 2
.
ÿÿ2 3
Unwrap
ÿÿ3 9
(
ÿÿ9 :
)
ÿÿ: ;
;
ÿÿ; <
return
⁄⁄ 
proofOption
⁄⁄ 
.
⁄⁄ 
IsSome
⁄⁄ %
;
⁄⁄% &
}
€€ 	
catch
‹‹ 
(
‹‹ 
	Exception
‹‹ 
ex
‹‹ 
)
‹‹ 
{
›› 	
Log
ﬁﬁ 
.
ﬁﬁ 
Error
ﬁﬁ 
(
ﬁﬁ 
ex
ﬁﬁ 
,
ﬁﬁ 
$str
ﬁﬁ [
)
ﬁﬁ[ \
;
ﬁﬁ\ ]
return
ﬂﬂ 
false
ﬂﬂ 
;
ﬂﬂ 
}
‡‡ 	
}
·· 
public
„„ 

static
„„ 
void
„„ "
ClearRevocationProof
„„ +
(
„„+ ,/
!IApplicationSecureStorageProvider
‰‰ )
storageProvider
‰‰* 9
,
‰‰9 :
string
ÂÂ 
membershipId
ÂÂ 
)
ÂÂ 
{
ÊÊ 
try
ÁÁ 
{
ËË 	
string
ÈÈ 

storageKey
ÈÈ 
=
ÈÈ *
GetRevocationProofStorageKey
ÈÈ  <
(
ÈÈ< =
membershipId
ÈÈ= I
)
ÈÈI J
;
ÈÈJ K
Result
ÍÍ 
<
ÍÍ 
Unit
ÍÍ 
,
ÍÍ '
InternalServiceApiFailure
ÍÍ 2
>
ÍÍ2 3
deleteResult
ÍÍ4 @
=
ÍÍA B
storageProvider
ÍÍC R
.
ÍÍR S
Delete
ÍÍS Y
(
ÍÍY Z

storageKey
ÍÍZ d
)
ÍÍd e
;
ÍÍe f
if
ÏÏ 
(
ÏÏ 
deleteResult
ÏÏ 
.
ÏÏ 
IsErr
ÏÏ "
)
ÏÏ" #
{
ÌÌ 
Log
ÓÓ 
.
ÓÓ 
Warning
ÓÓ 
(
ÓÓ 
$str
ÓÓ t
,
ÓÓt u
membershipId
ÔÔ  
)
ÔÔ  !
;
ÔÔ! "
}
 
}
ÒÒ 	
catch
ÚÚ 
(
ÚÚ 
	Exception
ÚÚ 
ex
ÚÚ 
)
ÚÚ 
{
ÛÛ 	
Log
ÙÙ 
.
ÙÙ 
Error
ÙÙ 
(
ÙÙ 
ex
ÙÙ 
,
ÙÙ 
$str
ÙÙ [
)
ÙÙ[ \
;
ÙÙ\ ]
}
ıı 	
}
ˆˆ 
private
¯¯ 
static
¯¯ 
string
¯¯ *
GetRevocationProofStorageKey
¯¯ 6
(
¯¯6 7
string
¯¯7 =
membershipId
¯¯> J
)
¯¯J K
=>
¯¯L N
$"
˘˘ 

{
˘˘
 $
SecureStorageConstants
˘˘ !
.
˘˘! "
Identity
˘˘" *
.
˘˘* +%
REVOCATION_PROOF_PREFIX
˘˘+ B
}
˘˘B C
{
˘˘C D
membershipId
˘˘D P
}
˘˘P Q
"
˘˘Q R
;
˘˘R S
public
˚˚ 

async
˚˚ 
Task
˚˚ 
<
˚˚ 
Result
˚˚ 
<
˚˚ 
Unit
˚˚ !
,
˚˚! "
LogoutFailure
˚˚# 0
>
˚˚0 1
>
˚˚1 2*
GenerateLogoutHmacProofAsync
˚˚3 O
(
˚˚O P
LogoutRequest
¸¸ 
request
¸¸ 
,
¸¸ 
string
˝˝ 
membershipId
˝˝ 
)
˝˝ 
{
˛˛ &
SodiumSecureMemoryHandle
ˇˇ  
?
ˇˇ  !
masterKeyHandle
ˇˇ" 1
=
ˇˇ2 3
null
ˇˇ4 8
;
ˇˇ8 9
byte
ÄÄ 
[
ÄÄ 
]
ÄÄ 
?
ÄÄ 
hmacKey
ÄÄ 
=
ÄÄ 
null
ÄÄ 
;
ÄÄ 
try
ÇÇ 
{
ÉÉ 	
Result
ÑÑ 
<
ÑÑ &
SodiumSecureMemoryHandle
ÑÑ +
,
ÑÑ+ ,#
AuthenticationFailure
ÑÑ- B
>
ÑÑB C
handleResult
ÑÑD P
=
ÑÑQ R
await
ÖÖ 
identityService
ÖÖ %
.
ÖÖ% &&
LoadMasterKeyHandleAsync
ÖÖ& >
(
ÖÖ> ?
membershipId
ÖÖ? K
)
ÖÖK L
.
ÖÖL M
ConfigureAwait
ÖÖM [
(
ÖÖ[ \
false
ÖÖ\ a
)
ÖÖa b
;
ÖÖb c
if
áá 
(
áá 
handleResult
áá 
.
áá 
IsErr
áá "
)
áá" #
{
àà 
Log
ââ 
.
ââ 
Error
ââ 
(
ââ 
$str
ââ k
,
ââk l
membershipId
ää  
)
ää  !
;
ää! "
return
ãã 
Result
ãã 
<
ãã 
Unit
ãã "
,
ãã" #
LogoutFailure
ãã$ 1
>
ãã1 2
.
ãã2 3
Err
ãã3 6
(
ãã6 7
LogoutFailure
åå !
.
åå! "*
CryptographicOperationFailed
åå" >
(
åå> ?
$"
çç 
$str
çç 7
{
çç7 8
handleResult
çç8 D
.
ççD E
	UnwrapErr
ççE N
(
ççN O
)
ççO P
.
ççP Q
Message
ççQ X
}
ççX Y
"
ççY Z
)
ççZ [
)
çç[ \
;
çç\ ]
}
éé 
masterKeyHandle
êê 
=
êê 
handleResult
êê *
.
êê* +
Unwrap
êê+ 1
(
êê1 2
)
êê2 3
;
êê3 4
Result
íí 
<
íí 
byte
íí 
[
íí 
]
íí 
,
íí 
SodiumFailure
íí (
>
íí( )
hmacKeyResult
íí* 7
=
íí8 9!
LogoutKeyDerivation
ìì #
.
ìì# $!
DeriveLogoutHmacKey
ìì$ 7
(
ìì7 8
masterKeyHandle
ìì8 G
)
ììG H
;
ììH I
if
ïï 
(
ïï 
hmacKeyResult
ïï 
.
ïï 
IsErr
ïï #
)
ïï# $
{
ññ 
Log
óó 
.
óó 
Error
óó 
(
óó 
$str
óó k
,
óók l
membershipId
òò  
)
òò  !
;
òò! "
return
ôô 
Result
ôô 
<
ôô 
Unit
ôô "
,
ôô" #
LogoutFailure
ôô$ 1
>
ôô1 2
.
ôô2 3
Err
ôô3 6
(
ôô6 7
LogoutFailure
öö !
.
öö! "*
CryptographicOperationFailed
öö" >
(
öö> ?
$"
õõ 
$str
õõ 6
{
õõ6 7
hmacKeyResult
õõ7 D
.
õõD E
	UnwrapErr
õõE N
(
õõN O
)
õõO P
.
õõP Q
Message
õõQ X
}
õõX Y
"
õõY Z
)
õõZ [
)
õõ[ \
;
õõ\ ]
}
úú 
hmacKey
ûû 
=
ûû 
hmacKeyResult
ûû #
.
ûû# $
Unwrap
ûû$ *
(
ûû* +
)
ûû+ ,
;
ûû, -
string
†† 
	canonical
†† 
=
†† 
$"
†† !
$str
††! +
{
††+ ,
request
††, 3
.
††3 4"
MembershipIdentifier
††4 H
.
††H I
ToBase64
††I Q
(
††Q R
)
††R S
}
††S T
$str
††T U
"
††U V
+
††W X
$"
°° !
{
°°! "
request
°°" )
.
°°) *
	Timestamp
°°* 3
}
°°3 4
$str
°°4 5
{
°°5 6
request
°°6 =
.
°°= >
Scope
°°> C
}
°°C D
$str
°°D E
{
°°E F
request
°°F M
.
°°M N
LogoutReason
°°N Z
}
°°Z [
"
°°[ \
;
°°\ ]
byte
¢¢ 
[
¢¢ 
]
¢¢ 
canonicalBytes
¢¢ !
=
¢¢" #
Encoding
¢¢$ ,
.
¢¢, -
UTF8
¢¢- 1
.
¢¢1 2
GetBytes
¢¢2 :
(
¢¢: ;
	canonical
¢¢; D
)
¢¢D E
;
¢¢E F
byte
§§ 
[
§§ 
]
§§ 
	hmacProof
§§ 
=
§§ !
LogoutKeyDerivation
§§ 2
.
§§2 3
ComputeHmac
§§3 >
(
§§> ?
hmacKey
§§? F
,
§§F G
canonicalBytes
§§H V
)
§§V W
;
§§W X
request
•• 
.
•• 
	HmacProof
•• 
=
•• 

ByteString
••  *
.
••* +
CopyFrom
••+ 3
(
••3 4
	hmacProof
••4 =
)
••= >
;
••> ?
return
ßß 
Result
ßß 
<
ßß 
Unit
ßß 
,
ßß 
LogoutFailure
ßß  -
>
ßß- .
.
ßß. /
Ok
ßß/ 1
(
ßß1 2
Unit
ßß2 6
.
ßß6 7
Value
ßß7 <
)
ßß< =
;
ßß= >
}
®® 	
finally
©© 
{
™™ 	
masterKeyHandle
´´ 
?
´´ 
.
´´ 
Dispose
´´ $
(
´´$ %
)
´´% &
;
´´& '
if
¨¨ 
(
¨¨ 
hmacKey
¨¨ 
!=
¨¨ 
null
¨¨ 
)
¨¨  
{
≠≠ %
CryptographicOperations
ÆÆ '
.
ÆÆ' (

ZeroMemory
ÆÆ( 2
(
ÆÆ2 3
hmacKey
ÆÆ3 :
)
ÆÆ: ;
;
ÆÆ; <
}
ØØ 
}
∞∞ 	
}
±± 
}≥≥ ü
Ñ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/IOperationTimeoutProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
public 
	interface %
IOperationTimeoutProvider *
{ 
TimeSpan 

GetTimeout 
( 
RpcServiceType &
serviceType' 2
,2 3
RpcRequestContext4 E
?E F
requestContextG U
=V W
nullX \
)\ ]
;] ^
}		 ¥˘
è/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Infrastructure/PendingRequestManager.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Services

  
.

  !
Network

! (
.

( )
Infrastructure

) 7
;

7 8
internal 
	interface	  
ITypedPendingRequest '
{ 
Task 
ExecuteAsync	 
( 
CancellationToken '
cancellationToken( 9
)9 :
;: ;
void 
Cancel	 
( 
) 
; 
} 
public 
	interface "
IPendingRequestManager '
{ 
void "
RegisterPendingRequest	 
(  
string  &
	requestId' 0
,0 1
Func2 6
<6 7
CancellationToken7 H
,H I
TaskJ N
>N O
retryActionP [
)[ \
;\ ]
void  
RemovePendingRequest	 
( 
string $
	requestId% .
). /
;/ 0
Task 
< 	
int	 
> (
RetryAllPendingRequestsAsync *
(* +
CancellationToken+ <
cancellationToken= N
=O P
defaultQ X
)X Y
;Y Z
} 
public 
sealed 
class !
PendingRequestManager )
:* +"
IPendingRequestManager, B
{ 
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
Func2 6
<6 7
CancellationToken7 H
,H I
TaskJ N
>N O
>O P
_pendingRequestsQ a
=b c
newd g
(g h
)h i
;i j
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1 
ITypedPendingRequest2 F
>F G!
_typedPendingRequestsH ]
=^ _
new` c
(c d
)d e
;e f
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
bool2 6
>6 7
_retryingRequests8 I
=J K
newL O
(O P
)P Q
;Q R
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1#
CancellationTokenSource2 I
>I J'
_requestCancellationSourcesK f
=g h
newi l
(l m
)m n
;n o
private 
readonly 
SemaphoreSlim "
_retryAllSemaphore# 5
=6 7
new8 ;
(; <
$num< =
,= >
$num? @
)@ A
;A B
private   
int   
_pendingCount   
;   
public"" 

event"" 
EventHandler"" 
<"" 
int"" !
>""! "
?""" #
PendingCountChanged""$ 7
;""7 8
public$$ 

int$$ 
PendingRequestCount$$ "
=>$$# %
_pendingCount$$& 3
;$$3 4
public&& 

void&& "
RegisterPendingRequest&& &
(&&& '
string&&' -
	requestId&&. 7
,&&7 8
Func&&9 =
<&&= >
CancellationToken&&> O
,&&O P
Task&&Q U
>&&U V
retryAction&&W b
)&&b c
{'' #
CancellationTokenSource(( 

requestCts((  *
=((+ ,
new((- 0
(((0 1
)((1 2
;((2 3
if** 

(** 
!** 
_pendingRequests** 
.** 
TryAdd** $
(**$ %
	requestId**% .
,**. /
retryAction**0 ;
)**; <
)**< =
{++ 	

requestCts,, 
.,, 
Dispose,, 
(,, 
),,  
;,,  !
return-- 
;-- 
}.. 	
if00 

(00 
!00 '
_requestCancellationSources00 (
.00( )
TryAdd00) /
(00/ 0
	requestId000 9
,009 :

requestCts00; E
)00E F
)00F G
{11 	
_pendingRequests22 
.22 
	TryRemove22 &
(22& '
	requestId22' 0
,220 1
out222 5
_226 7
)227 8
;228 9

requestCts33 
.33 
Dispose33 
(33 
)33  
;33  !
return44 
;44 
}55 	
int77 
newCount77 
=77 
Interlocked77 "
.77" #
	Increment77# ,
(77, -
ref77- 0
_pendingCount771 >
)77> ?
;77? @
PendingCountChanged88 
?88 
.88 
Invoke88 #
(88# $
this88$ (
,88( )
newCount88* 2
)882 3
;883 4
}99 
public;; 

void;; "
RegisterPendingRequest;; &
<;;& '
T;;' (
>;;( )
(;;) *
string;;* 0
	requestId;;1 :
,;;: ;
Func;;< @
<;;@ A
CancellationToken;;A R
,;;R S
Task;;T X
<;;X Y
T;;Y Z
>;;Z [
>;;[ \
retryAction;;] h
,;;h i 
TaskCompletionSource<< 
<<< 
T<< 
><< (
originalTaskCompletionSource<<  <
)<<< =
{== #
CancellationTokenSource>> 

requestCts>>  *
=>>+ ,
new>>- 0
(>>0 1
)>>1 2
;>>2 3
TypedPendingRequest?? 
<?? 
T?? 
>?? 
typedRequest?? +
=??, -
new??. 1
(??1 2
retryAction??2 =
,??= >(
originalTaskCompletionSource??? [
)??[ \
;??\ ]
ifAA 

(AA 
!AA !
_typedPendingRequestsAA "
.AA" #
TryAddAA# )
(AA) *
	requestIdAA* 3
,AA3 4
typedRequestAA5 A
)AAA B
)AAB C
{BB 	

requestCtsCC 
.CC 
DisposeCC 
(CC 
)CC  
;CC  !
returnDD 
;DD 
}EE 	
ifGG 

(GG 
!GG '
_requestCancellationSourcesGG (
.GG( )
TryAddGG) /
(GG/ 0
	requestIdGG0 9
,GG9 :

requestCtsGG; E
)GGE F
)GGF G
{HH 	!
_typedPendingRequestsII !
.II! "
	TryRemoveII" +
(II+ ,
	requestIdII, 5
,II5 6
outII7 :
_II; <
)II< =
;II= >

requestCtsJJ 
.JJ 
DisposeJJ 
(JJ 
)JJ  
;JJ  !
returnKK 
;KK 
}LL 	
intNN 
newCountNN 
=NN 
InterlockedNN "
.NN" #
	IncrementNN# ,
(NN, -
refNN- 0
_pendingCountNN1 >
)NN> ?
;NN? @
PendingCountChangedOO 
?OO 
.OO 
InvokeOO #
(OO# $
thisOO$ (
,OO( )
newCountOO* 2
)OO2 3
;OO3 4
}PP 
publicRR 

voidRR  
RemovePendingRequestRR $
(RR$ %
stringRR% +
	requestIdRR, 5
)RR5 6
{SS 
boolTT 
removedTT 
=TT 
_pendingRequestsTT '
.TT' (
	TryRemoveTT( 1
(TT1 2
	requestIdTT2 ;
,TT; <
outTT= @
_TTA B
)TTB C
||TTD F!
_typedPendingRequestsUU ,
.UU, -
	TryRemoveUU- 6
(UU6 7
	requestIdUU7 @
,UU@ A
outUUB E
_UUF G
)UUG H
;UUH I
ifWW 

(WW '
_requestCancellationSourcesWW '
.WW' (
	TryRemoveWW( 1
(WW1 2
	requestIdWW2 ;
,WW; <
outWW= @#
CancellationTokenSourceWWA X
?WWX Y

requestCtsWWZ d
)WWd e
)WWe f
{XX 	

requestCtsYY 
.YY 
DisposeYY 
(YY 
)YY  
;YY  !
}ZZ 	
if\\ 

(\\ 
removed\\ 
)\\ 
{]] 	
int^^ 
newCount^^ 
=^^ 
Interlocked^^ &
.^^& '
	Decrement^^' 0
(^^0 1
ref^^1 4
_pendingCount^^5 B
)^^B C
;^^C D
PendingCountChanged__ 
?__  
.__  !
Invoke__! '
(__' (
this__( ,
,__, -
newCount__. 6
)__6 7
;__7 8
}`` 	
}aa 
publiccc 

asynccc 
Taskcc 
<cc 
intcc 
>cc (
RetryAllPendingRequestsAsynccc 7
(cc7 8
CancellationTokencc8 I
cancellationTokenccJ [
=cc\ ]
defaultcc^ e
)cce f
{dd 
awaitee 
_retryAllSemaphoreee  
.ee  !
	WaitAsyncee! *
(ee* +
cancellationTokenee+ <
)ee< =
.ee= >
ConfigureAwaitee> L
(eeL M
falseeeM R
)eeR S
;eeS T
tryff 
{gg 	
KeyValuePairhh 
<hh 
stringhh 
,hh  
Funchh! %
<hh% &
CancellationTokenhh& 7
,hh7 8
Taskhh9 =
>hh= >
>hh> ?
[hh? @
]hh@ A
untypedRequestshhB Q
=hhR S
_pendingRequestshhT d
.hhd e
ToArrayhhe l
(hhl m
)hhm n
;hhn o
KeyValuePairii 
<ii 
stringii 
,ii   
ITypedPendingRequestii! 5
>ii5 6
[ii6 7
]ii7 8
typedRequestsii9 F
=iiG H!
_typedPendingRequestsiiI ^
.ii^ _
ToArrayii_ f
(iif g
)iig h
;iih i
intjj 
successCountjj 
=jj 
$numjj  
;jj  !
Logll 
.ll 
Informationll 
(ll 
$strll o
,llo p
untypedRequestsmm 
.mm  
Lengthmm  &
,mm& '
typedRequestsmm( 5
.mm5 6
Lengthmm6 <
)mm< =
;mm= >
Listoo 
<oo 
KeyValuePairoo 
<oo 
stringoo $
,oo$ %
Funcoo& *
<oo* +
CancellationTokenoo+ <
,oo< =
Taskoo> B
>ooB C
>ooC D
>ooD E#
filteredUntypedRequestsooF ]
=oo^ _
[oo` a
]ooa b
;oob c
Listpp 
<pp 
KeyValuePairpp 
<pp 
stringpp $
,pp$ % 
ITypedPendingRequestpp& :
>pp: ;
>pp; <!
filteredTypedRequestspp= R
=ppS T
[ppU V
]ppV W
;ppW X
foreachrr 
(rr 
KeyValuePairrr !
<rr! "
stringrr" (
,rr( )
Funcrr* .
<rr. /
CancellationTokenrr/ @
,rr@ A
TaskrrB F
>rrF G
>rrG H
requestrrI P
inrrQ S
untypedRequestsrrT c
)rrc d
{ss 
iftt 
(tt 
_retryingRequeststt %
.tt% &
TryAddtt& ,
(tt, -
requesttt- 4
.tt4 5
Keytt5 8
,tt8 9
truett: >
)tt> ?
)tt? @
{uu #
filteredUntypedRequestsvv +
.vv+ ,
Addvv, /
(vv/ 0
requestvv0 7
)vv7 8
;vv8 9
}ww 
elsexx 
ifxx 
(xx 
Logxx 
.xx 
	IsEnabledxx &
(xx& '
LogEventLevelxx' 4
.xx4 5
Debugxx5 :
)xx: ;
)xx; <
{yy 
Logzz 
.zz 
Debugzz 
(zz 
$strzz ^
,zz^ _
requestzz` g
.zzg h
Keyzzh k
)zzk l
;zzl m
}{{ 
}|| 
foreach~~ 
(~~ 
KeyValuePair~~ !
<~~! "
string~~" (
,~~( ) 
ITypedPendingRequest~~* >
>~~> ?
request~~@ G
in~~H J
typedRequests~~K X
)~~X Y
{ 
if
ÄÄ 
(
ÄÄ 
_retryingRequests
ÄÄ %
.
ÄÄ% &
TryAdd
ÄÄ& ,
(
ÄÄ, -
request
ÄÄ- 4
.
ÄÄ4 5
Key
ÄÄ5 8
,
ÄÄ8 9
true
ÄÄ: >
)
ÄÄ> ?
)
ÄÄ? @
{
ÅÅ #
filteredTypedRequests
ÇÇ )
.
ÇÇ) *
Add
ÇÇ* -
(
ÇÇ- .
request
ÇÇ. 5
)
ÇÇ5 6
;
ÇÇ6 7
}
ÉÉ 
else
ÑÑ 
if
ÑÑ 
(
ÑÑ 
Log
ÑÑ 
.
ÑÑ 
	IsEnabled
ÑÑ &
(
ÑÑ& '
LogEventLevel
ÑÑ' 4
.
ÑÑ4 5
Debug
ÑÑ5 :
)
ÑÑ: ;
)
ÑÑ; <
{
ÖÖ 
Log
ÜÜ 
.
ÜÜ 
Debug
ÜÜ 
(
ÜÜ 
$str
ÜÜ d
,
ÜÜd e
request
ÜÜf m
.
ÜÜm n
Key
ÜÜn q
)
ÜÜq r
;
ÜÜr s
}
áá 
}
àà 
Task
ää 
[
ää 
]
ää 
untypedTasks
ää 
=
ää  !
new
ää" %
Task
ää& *
[
ää* +%
filteredUntypedRequests
ää+ B
.
ääB C
Count
ääC H
]
ääH I
;
ääI J
for
ãã 
(
ãã 
int
ãã 
i
ãã 
=
ãã 
$num
ãã 
;
ãã 
i
ãã 
<
ãã %
filteredUntypedRequests
ãã  7
.
ãã7 8
Count
ãã8 =
;
ãã= >
i
ãã? @
++
ãã@ B
)
ããB C
{
åå 
KeyValuePair
çç 
<
çç 
string
çç #
,
çç# $
Func
çç% )
<
çç) *
CancellationToken
çç* ;
,
çç; <
Task
çç= A
>
ççA B
>
ççB C
request
ççD K
=
ççL M%
filteredUntypedRequests
ççN e
[
ççe f
i
ççf g
]
ççg h
;
ççh i
untypedTasks
éé 
[
éé 
i
éé 
]
éé 
=
éé  !
RetryRequestAsync
éé" 3
(
éé3 4
request
éé4 ;
.
éé; <
Key
éé< ?
,
éé? @
request
ééA H
.
ééH I
Value
ééI N
,
ééN O
cancellationToken
ééP a
)
ééa b
;
ééb c
}
èè 
Task
ëë 
[
ëë 
]
ëë 

typedTasks
ëë 
=
ëë 
new
ëë  #
Task
ëë$ (
[
ëë( )#
filteredTypedRequests
ëë) >
.
ëë> ?
Count
ëë? D
]
ëëD E
;
ëëE F
for
íí 
(
íí 
int
íí 
i
íí 
=
íí 
$num
íí 
;
íí 
i
íí 
<
íí #
filteredTypedRequests
íí  5
.
íí5 6
Count
íí6 ;
;
íí; <
i
íí= >
++
íí> @
)
íí@ A
{
ìì 
KeyValuePair
îî 
<
îî 
string
îî #
,
îî# $"
ITypedPendingRequest
îî% 9
>
îî9 :
request
îî; B
=
îîC D#
filteredTypedRequests
îîE Z
[
îîZ [
i
îî[ \
]
îî\ ]
;
îî] ^

typedTasks
ïï 
[
ïï 
i
ïï 
]
ïï 
=
ïï $
RetryTypedRequestAsync
ïï  6
(
ïï6 7
request
ïï7 >
.
ïï> ?
Key
ïï? B
,
ïïB C
request
ïïD K
.
ïïK L
Value
ïïL Q
,
ïïQ R
cancellationToken
ïïS d
)
ïïd e
;
ïïe f
}
ññ 
Task
òò 
[
òò 
]
òò 
allTasks
òò 
=
òò 
new
òò !
Task
òò" &
[
òò& '
untypedTasks
òò' 3
.
òò3 4
Length
òò4 :
+
òò; <

typedTasks
òò= G
.
òòG H
Length
òòH N
]
òòN O
;
òòO P
Array
ôô 
.
ôô 
Copy
ôô 
(
ôô 
untypedTasks
ôô #
,
ôô# $
allTasks
ôô% -
,
ôô- .
untypedTasks
ôô/ ;
.
ôô; <
Length
ôô< B
)
ôôB C
;
ôôC D
Array
öö 
.
öö 
Copy
öö 
(
öö 

typedTasks
öö !
,
öö! "
$num
öö# $
,
öö$ %
allTasks
öö& .
,
öö. /
untypedTasks
öö0 <
.
öö< =
Length
öö= C
,
ööC D

typedTasks
ööE O
.
ööO P
Length
ööP V
)
ööV W
;
ööW X
if
úú 
(
úú 
allTasks
úú 
.
úú 
Length
úú 
>
úú  !
$num
úú" #
)
úú# $
{
ùù 
await
ûû 
Task
ûû 
.
ûû 
WhenAll
ûû "
(
ûû" #
allTasks
ûû# +
)
ûû+ ,
.
ûû, -
ConfigureAwait
ûû- ;
(
ûû; <
false
ûû< A
)
ûûA B
;
ûûB C
successCount
†† 
+=
†† 
allTasks
††  (
.
††( )
Count
††) .
(
††. /
task
††/ 3
=>
††4 6
task
††7 ;
.
††; <%
IsCompletedSuccessfully
††< S
)
††S T
;
††T U
}
°° 
Log
££ 
.
££ 
Information
££ 
(
££ 
$str
££ g
,
££g h
successCount
§§ 
,
§§ 
allTasks
§§ &
.
§§& '
Length
§§' -
)
§§- .
;
§§. /
return
¶¶ 
successCount
¶¶ 
;
¶¶  
}
ßß 	
finally
®® 
{
©© 	 
_retryAllSemaphore
™™ 
.
™™ 
Release
™™ &
(
™™& '
)
™™' (
;
™™( )
}
´´ 	
}
¨¨ 
private
ÆÆ 
async
ÆÆ 
Task
ÆÆ 
RetryRequestAsync
ÆÆ (
(
ÆÆ( )
string
ÆÆ) /
	requestId
ÆÆ0 9
,
ÆÆ9 :
Func
ÆÆ; ?
<
ÆÆ? @
CancellationToken
ÆÆ@ Q
,
ÆÆQ R
Task
ÆÆS W
>
ÆÆW X
retryAction
ÆÆY d
,
ÆÆd e
CancellationToken
ØØ 
cancellationToken
ØØ +
)
ØØ+ ,
{
∞∞ %
CancellationTokenSource
±± 
?
±±  
	linkedCts
±±! *
=
±±+ ,
null
±±- 1
;
±±1 2
try
≤≤ 
{
≥≥ 	
CancellationToken
¥¥ 

tokenToUse
¥¥ (
=
¥¥) *
cancellationToken
¥¥+ <
;
¥¥< =
if
µµ 
(
µµ )
_requestCancellationSources
µµ +
.
µµ+ ,
TryGetValue
µµ, 7
(
µµ7 8
	requestId
µµ8 A
,
µµA B
out
µµC F%
CancellationTokenSource
µµG ^
?
µµ^ _

requestCts
µµ` j
)
µµj k
)
µµk l
{
∂∂ 
	linkedCts
∑∑ 
=
∑∑ %
CancellationTokenSource
∑∑ 3
.
∑∑3 4%
CreateLinkedTokenSource
∑∑4 K
(
∑∑K L
cancellationToken
∑∑L ]
,
∑∑] ^

requestCts
∑∑_ i
.
∑∑i j
Token
∑∑j o
)
∑∑o p
;
∑∑p q

tokenToUse
∏∏ 
=
∏∏ 
	linkedCts
∏∏ &
.
∏∏& '
Token
∏∏' ,
;
∏∏, -
}
ππ 

tokenToUse
ªª 
.
ªª *
ThrowIfCancellationRequested
ªª 3
(
ªª3 4
)
ªª4 5
;
ªª5 6
Task
ΩΩ 
	retryTask
ΩΩ 
=
ΩΩ 
retryAction
ΩΩ (
(
ΩΩ( )

tokenToUse
ΩΩ) 3
)
ΩΩ3 4
;
ΩΩ4 5
if
ææ 
(
ææ 
!
ææ 
	retryTask
ææ 
.
ææ 
IsCompleted
ææ &
)
ææ& '
{
øø 
await
¿¿ 
	retryTask
¿¿ 
.
¿¿  
	WaitAsync
¿¿  )
(
¿¿) *

tokenToUse
¿¿* 4
)
¿¿4 5
.
¿¿5 6
ConfigureAwait
¿¿6 D
(
¿¿D E
false
¿¿E J
)
¿¿J K
;
¿¿K L
}
¡¡ 
else
¬¬ 
{
√√ 
await
ƒƒ 
	retryTask
ƒƒ 
.
ƒƒ  
ConfigureAwait
ƒƒ  .
(
ƒƒ. /
false
ƒƒ/ 4
)
ƒƒ4 5
;
ƒƒ5 6
}
≈≈ "
RemovePendingRequest
««  
(
««  !
	requestId
««! *
)
««* +
;
««+ ,
Log
»» 
.
»» 
Debug
»» 
(
»» 
$str
»» @
,
»»@ A
	requestId
»»B K
)
»»K L
;
»»L M
}
…… 	
catch
   
(
   (
OperationCanceledException
   )
ex
  * ,
)
  , -
{
ÀÀ 	
Log
ÃÃ 
.
ÃÃ 
Debug
ÃÃ 
(
ÃÃ 
ex
ÃÃ 
,
ÃÃ 
$str
ÃÃ K
,
ÃÃK L
	requestId
ÃÃM V
)
ÃÃV W
;
ÃÃW X
}
ÕÕ 	
catch
ŒŒ 
(
ŒŒ 
	Exception
ŒŒ 
ex
ŒŒ 
)
ŒŒ 
{
œœ 	
Log
–– 
.
–– 
Warning
–– 
(
–– 
ex
–– 
,
–– 
$str
–– p
,
––p q
	requestId
––r {
)
––{ |
;
––| }
}
““ 	
finally
”” 
{
‘‘ 	
	linkedCts
’’ 
?
’’ 
.
’’ 
Dispose
’’ 
(
’’ 
)
’’  
;
’’  !
_retryingRequests
÷÷ 
.
÷÷ 
	TryRemove
÷÷ '
(
÷÷' (
	requestId
÷÷( 1
,
÷÷1 2
out
÷÷3 6
_
÷÷7 8
)
÷÷8 9
;
÷÷9 :
}
◊◊ 	
}
ÿÿ 
private
⁄⁄ 
async
⁄⁄ 
Task
⁄⁄ $
RetryTypedRequestAsync
⁄⁄ -
(
⁄⁄- .
string
⁄⁄. 4
	requestId
⁄⁄5 >
,
⁄⁄> ?"
ITypedPendingRequest
⁄⁄@ T
typedRequest
⁄⁄U a
,
⁄⁄a b
CancellationToken
€€ 
cancellationToken
€€ +
)
€€+ ,
{
‹‹ %
CancellationTokenSource
›› 
?
››  
	linkedCts
››! *
=
››+ ,
null
››- 1
;
››1 2
try
ﬁﬁ 
{
ﬂﬂ 	
CancellationToken
‡‡ 

tokenToUse
‡‡ (
=
‡‡) *
cancellationToken
‡‡+ <
;
‡‡< =
if
·· 
(
·· )
_requestCancellationSources
·· +
.
··+ ,
TryGetValue
··, 7
(
··7 8
	requestId
··8 A
,
··A B
out
··C F%
CancellationTokenSource
··G ^
?
··^ _

requestCts
··` j
)
··j k
)
··k l
{
‚‚ 
	linkedCts
„„ 
=
„„ %
CancellationTokenSource
„„ 3
.
„„3 4%
CreateLinkedTokenSource
„„4 K
(
„„K L
cancellationToken
„„L ]
,
„„] ^

requestCts
„„_ i
.
„„i j
Token
„„j o
)
„„o p
;
„„p q

tokenToUse
‰‰ 
=
‰‰ 
	linkedCts
‰‰ &
.
‰‰& '
Token
‰‰' ,
;
‰‰, -
}
ÂÂ 
await
ÁÁ 
typedRequest
ÁÁ 
.
ÁÁ 
ExecuteAsync
ÁÁ +
(
ÁÁ+ ,

tokenToUse
ÁÁ, 6
)
ÁÁ6 7
.
ÁÁ7 8
ConfigureAwait
ÁÁ8 F
(
ÁÁF G
false
ÁÁG L
)
ÁÁL M
;
ÁÁM N"
RemovePendingRequest
ËË  
(
ËË  !
	requestId
ËË! *
)
ËË* +
;
ËË+ ,
Log
ÈÈ 
.
ÈÈ 
Debug
ÈÈ 
(
ÈÈ 
$str
ÈÈ F
,
ÈÈF G
	requestId
ÈÈH Q
)
ÈÈQ R
;
ÈÈR S
}
ÍÍ 	
catch
ÎÎ 
(
ÎÎ (
OperationCanceledException
ÎÎ )
ex
ÎÎ* ,
)
ÎÎ, -
{
ÏÏ 	
Log
ÌÌ 
.
ÌÌ 
Debug
ÌÌ 
(
ÌÌ 
ex
ÌÌ 
,
ÌÌ 
$str
ÌÌ Q
,
ÌÌQ R
	requestId
ÌÌS \
)
ÌÌ\ ]
;
ÌÌ] ^
}
ÓÓ 	
catch
ÔÔ 
(
ÔÔ 
	Exception
ÔÔ 
ex
ÔÔ 
)
ÔÔ 
{
 	
Log
ÒÒ 
.
ÒÒ 
Warning
ÒÒ 
(
ÒÒ 
ex
ÒÒ 
,
ÒÒ 
$str
ÒÒ v
,
ÒÒv w
	requestIdÒÒx Å
)ÒÒÅ Ç
;ÒÒÇ É
}
ÚÚ 	
finally
ÛÛ 
{
ÙÙ 	
	linkedCts
ıı 
?
ıı 
.
ıı 
Dispose
ıı 
(
ıı 
)
ıı  
;
ıı  !
_retryingRequests
ˆˆ 
.
ˆˆ 
	TryRemove
ˆˆ '
(
ˆˆ' (
	requestId
ˆˆ( 1
,
ˆˆ1 2
out
ˆˆ3 6
_
ˆˆ7 8
)
ˆˆ8 9
;
ˆˆ9 :
}
˜˜ 	
}
¯¯ 
public
˙˙ 

void
˙˙ &
CancelAllPendingRequests
˙˙ (
(
˙˙( )
)
˙˙) *
{
˚˚ 
foreach
¸¸ 
(
¸¸ 
KeyValuePair
¸¸ 
<
¸¸ 
string
¸¸ $
,
¸¸$ %%
CancellationTokenSource
¸¸& =
>
¸¸= >
entry
¸¸? D
in
¸¸E G)
_requestCancellationSources
¸¸H c
.
¸¸c d
ToArray
¸¸d k
(
¸¸k l
)
¸¸l m
)
¸¸m n
{
˝˝ 	
if
˛˛ 
(
˛˛ 
!
˛˛ )
_requestCancellationSources
˛˛ ,
.
˛˛, -
	TryRemove
˛˛- 6
(
˛˛6 7
entry
˛˛7 <
.
˛˛< =
Key
˛˛= @
,
˛˛@ A
out
˛˛B E%
CancellationTokenSource
˛˛F ]
?
˛˛] ^

requestCts
˛˛_ i
)
˛˛i j
)
˛˛j k
{
ˇˇ 
continue
ÄÄ 
;
ÄÄ 
}
ÅÅ 
try
ÉÉ 
{
ÑÑ 

requestCts
ÖÖ 
.
ÖÖ 
Cancel
ÖÖ !
(
ÖÖ! "
)
ÖÖ" #
;
ÖÖ# $
}
ÜÜ 
catch
áá 
(
áá %
ObjectDisposedException
áá *
)
áá* +
{
àà 
}
ää 
finally
ãã 
{
åå 

requestCts
çç 
.
çç 
Dispose
çç "
(
çç" #
)
çç# $
;
çç$ %
}
éé 
}
èè 	
foreach
ëë 
(
ëë "
ITypedPendingRequest
ëë %
typedRequest
ëë& 2
in
ëë3 5#
_typedPendingRequests
ëë6 K
.
ëëK L
Values
ëëL R
)
ëëR S
{
íí 	
typedRequest
ìì 
.
ìì 
Cancel
ìì 
(
ìì  
)
ìì  !
;
ìì! "
}
îî 	
_pendingRequests
ññ 
.
ññ 
Clear
ññ 
(
ññ 
)
ññ  
;
ññ  !#
_typedPendingRequests
óó 
.
óó 
Clear
óó #
(
óó# $
)
óó$ %
;
óó% &
_retryingRequests
òò 
.
òò 
Clear
òò 
(
òò  
)
òò  !
;
òò! ")
_requestCancellationSources
ôô #
.
ôô# $
Clear
ôô$ )
(
ôô) *
)
ôô* +
;
ôô+ ,
Interlocked
õõ 
.
õõ 
Exchange
õõ 
(
õõ 
ref
õõ  
_pendingCount
õõ! .
,
õõ. /
$num
õõ0 1
)
õõ1 2
;
õõ2 3!
PendingCountChanged
úú 
?
úú 
.
úú 
Invoke
úú #
(
úú# $
this
úú$ (
,
úú( )
$num
úú* +
)
úú+ ,
;
úú, -
}
ùù 
}ûû 
internal†† 
sealed
††	 
class
†† !
TypedPendingRequest
†† )
<
††) *
T
††* +
>
††+ ,
:
††- ."
ITypedPendingRequest
††/ C
{°° 
private
¢¢ 
readonly
¢¢ 
Func
¢¢ 
<
¢¢ 
CancellationToken
¢¢ +
,
¢¢+ ,
Task
¢¢- 1
<
¢¢1 2
T
¢¢2 3
>
¢¢3 4
>
¢¢4 5
_retryAction
¢¢6 B
;
¢¢B C
private
££ 
readonly
££ "
TaskCompletionSource
££ )
<
££) *
T
££* +
>
££+ ,+
_originalTaskCompletionSource
££- J
;
££J K
public
•• 
!
TypedPendingRequest
•• 
(
•• 
Func
•• #
<
••# $
CancellationToken
••$ 5
,
••5 6
Task
••7 ;
<
••; <
T
••< =
>
••= >
>
••> ?
retryAction
••@ K
,
••K L"
TaskCompletionSource
¶¶ 
<
¶¶ 
T
¶¶ 
>
¶¶ *
originalTaskCompletionSource
¶¶  <
)
¶¶< =
{
ßß 
_retryAction
®® 
=
®® 
retryAction
®® "
;
®®" #+
_originalTaskCompletionSource
©© %
=
©©& '*
originalTaskCompletionSource
©©( D
;
©©D E
}
™™ 
public
¨¨ 

async
¨¨ 
Task
¨¨ 
ExecuteAsync
¨¨ "
(
¨¨" #
CancellationToken
¨¨# 4
cancellationToken
¨¨5 F
)
¨¨F G
{
≠≠ 
try
ÆÆ 
{
ØØ 	
cancellationToken
∞∞ 
.
∞∞ *
ThrowIfCancellationRequested
∞∞ :
(
∞∞: ;
)
∞∞; <
;
∞∞< =
Task
≤≤ 
<
≤≤ 
T
≤≤ 
>
≤≤ 
	retryTask
≤≤ 
=
≤≤ 
_retryAction
≤≤  ,
(
≤≤, -
cancellationToken
≤≤- >
)
≤≤> ?
;
≤≤? @
T
≥≥ 
result
≥≥ 
=
≥≥ 
await
≥≥ 
(
≥≥ 
	retryTask
≥≥ '
.
≥≥' (
IsCompleted
≥≥( 3
?
¥¥ 
	retryTask
¥¥ 
:
µµ 
	retryTask
µµ 
.
µµ  
	WaitAsync
µµ  )
(
µµ) *
cancellationToken
µµ* ;
)
µµ; <
)
µµ< =
.
∂∂ 
ConfigureAwait
∂∂ 
(
∂∂  
false
∂∂  %
)
∂∂% &
;
∂∂& '+
_originalTaskCompletionSource
∏∏ )
.
∏∏) *
	SetResult
∏∏* 3
(
∏∏3 4
result
∏∏4 :
)
∏∏: ;
;
∏∏; <
}
ππ 	
catch
∫∫ 
(
∫∫ (
OperationCanceledException
∫∫ )
)
∫∫) *
{
ªª 	+
_originalTaskCompletionSource
ºº )
.
ºº) *
TrySetCanceled
ºº* 8
(
ºº8 9
cancellationToken
ºº9 J
)
ººJ K
;
ººK L
throw
ΩΩ 
;
ΩΩ 
}
ææ 	
catch
øø 
(
øø 
	Exception
øø 
ex
øø 
)
øø 
{
¿¿ 	+
_originalTaskCompletionSource
¡¡ )
.
¡¡) *
SetException
¡¡* 6
(
¡¡6 7
ex
¡¡7 9
)
¡¡9 :
;
¡¡: ;
throw
¬¬ 
;
¬¬ 
}
√√ 	
}
ƒƒ 
public
∆∆ 

void
∆∆ 
Cancel
∆∆ 
(
∆∆ 
)
∆∆ 
{
«« +
_originalTaskCompletionSource
»» %
.
»»% &
TrySetCanceled
»»& 4
(
»»4 5
)
»»5 6
;
»»6 7
}
…… 
}   ˙
Ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/IGrpcDeadlineProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
public 
	interface !
IGrpcDeadlineProvider &
{ 
DateTime 
GetDeadlineUtc 
( 
RpcServiceType *
serviceType+ 6
,6 7
RpcRequestContext8 I
?I J
requestContextK Y
)Y Z
;Z [
}		 ∫
Ç/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/IGrpcCallOptionsFactory.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
public 
	interface #
IGrpcCallOptionsFactory (
{ 
CallOptions		 
Create		 
(		 
RpcServiceType

 
serviceType

 "
,

" #
RpcRequestContext 
? 
requestContext )
,) *
CancellationToken 
cancellationToken +
,+ ,
Metadata 
? 
additionalHeaders #
=$ %
null& *
)* +
;+ ,
} ÿ
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/GrpcDeadlineProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
internal 
sealed	 
class  
GrpcDeadlineProvider *
(* +%
IOperationTimeoutProvider+ D
timeoutProviderE T
)T U
:V W!
IGrpcDeadlineProviderX m
{		 
private

 
static

 
readonly

 
TimeSpan

 $
DefaultDeadline

% 4
=

5 6
TimeSpan

7 ?
.

? @
FromSeconds

@ K
(

K L
$num

L N
)

N O
;

O P
public 

DateTime 
GetDeadlineUtc "
(" #
RpcServiceType# 1
serviceType2 =
,= >
RpcRequestContext? P
?P Q
requestContextR `
)` a
{ 
TimeSpan 
operationTimeout !
=" #
timeoutProvider$ 3
.3 4

GetTimeout4 >
(> ?
serviceType? J
,J K
requestContextL Z
)Z [
;[ \
TimeSpan 
normalizedTimeout "
=# $
NormalizeTimeout% 5
(5 6
operationTimeout6 F
)F G
;G H
DateTime 
now 
= 
DateTime 
.  
UtcNow  &
;& '
try 
{ 	
return 
now 
. 
Add 
( 
normalizedTimeout ,
), -
;- .
} 	
catch 
( '
ArgumentOutOfRangeException *
ex+ -
)- .
{ 	
Log 
. 
Warning 
( 
ex 
, 
$str	 Ø
,
Ø ∞
normalizedTimeout !
,! "
serviceType 
, 
requestContext 
? 
.  
CORRELATION_ID  .
??/ 1
$str2 7
)7 8
;8 9
return 
DateTime 
. 
SpecifyKind '
(' (
DateTime( 0
.0 1
MaxValue1 9
.9 :
AddTicks: B
(B C
-C D
$numD E
)E F
,F G
DateTimeKindH T
.T U
UtcU X
)X Y
;Y Z
} 	
} 
private   
static   
TimeSpan   
NormalizeTimeout   ,
(  , -
TimeSpan  - 5
timeout  6 =
)  = >
{!! 
if"" 

("" 
timeout"" 
=="" 
Timeout"" 
."" 
InfiniteTimeSpan"" /
)""/ 0
{## 	
return$$ 
TimeSpan$$ 
.$$ 
	FromHours$$ %
($$% &
$num$$& (
)$$( )
;$$) *
}%% 	
return'' 
timeout'' 
<='' 
TimeSpan'' "
.''" #
Zero''# '
?''( )
DefaultDeadline''* 9
:'': ;
timeout''< C
;''C D
}(( 
})) ö-
Å/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/GrpcCallOptionsFactory.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
internal		 
sealed			 
class		 "
GrpcCallOptionsFactory		 ,
(		, -!
IGrpcDeadlineProvider		- B
deadlineProvider		C S
)		S T
:		U V#
IGrpcCallOptionsFactory		W n
{

 
public 

CallOptions 
Create 
( 
RpcServiceType 
serviceType "
," #
RpcRequestContext 
? 
requestContext )
,) *
CancellationToken 
cancellationToken +
,+ ,
Metadata 
? 
additionalHeaders #
=$ %
null& *
)* +
{ 
Metadata 
? 
headers 
= 
MergeHeaders (
(( )
BuildHeaders) 5
(5 6
requestContext6 D
)D E
,E F
additionalHeadersG X
)X Y
;Y Z
DateTime 
deadlineUtc 
= 
deadlineProvider /
./ 0
GetDeadlineUtc0 >
(> ?
serviceType? J
,J K
requestContextL Z
)Z [
;[ \
return 
new 
CallOptions 
( 
headers &
,& '
deadline( 0
:0 1
deadlineUtc2 =
,= >
cancellationToken? P
:P Q
cancellationTokenR c
)c d
;d e
} 
private 
static 
Metadata 
? 
BuildHeaders )
() *
RpcRequestContext* ;
?; <
requestContext= K
)K L
{ 
if 

( 
requestContext 
== 
null "
)" #
{ 	
return 
null 
; 
} 	
Metadata 
headers 
= 
new 
( 
)  
{ 	
{ 
$str  
,  !
requestContext" 0
.0 1
CORRELATION_ID1 ?
}@ A
,A B
{   
$str   !
,  ! "
requestContext  # 1
.  1 2
IdempotencyKey  2 @
}  A B
,  B C
{!! 
$str!! 
,!! 
requestContext!! )
.!!) *
Attempt!!* 1
.!!1 2
ToString!!2 :
(!!: ;
CultureInfo!!; F
.!!F G
InvariantCulture!!G W
)!!W X
}!!Y Z
}"" 	
;""	 

if$$ 

($$ 
requestContext$$ 
.$$ 
ReinitAttempted$$ *
)$$* +
{%% 	
headers&& 
.&& 
Add&& 
(&& 
$str&& ,
,&&, -
$str&&. 4
)&&4 5
;&&5 6
}'' 	
return)) 
headers)) 
;)) 
}** 
private,, 
static,, 
Metadata,, 
?,, 
MergeHeaders,, )
(,,) *
Metadata,,* 2
?,,2 3
baseHeaders,,4 ?
,,,? @
Metadata,,A I
?,,I J
additionalHeaders,,K \
),,\ ]
{-- 
if.. 

(.. 
additionalHeaders.. 
==..  
null..! %
||..& (
additionalHeaders..) :
...: ;
Count..; @
==..A C
$num..D E
)..E F
{// 	
return00 
baseHeaders00 
;00 
}11 	
Metadata33 
merged33 
=33 
[33 
]33 
;33 
if55 

(55 
baseHeaders55 
!=55 
null55 
)55  
{66 	
foreach77 
(77 
Metadata77 
.77 
Entry77 #
entry77$ )
in77* ,
baseHeaders77- 8
)778 9
{88 
AddEntry99 
(99 
merged99 
,99  
entry99! &
)99& '
;99' (
}:: 
};; 	
foreach== 
(== 
Metadata== 
.== 
Entry== 
entry==  %
in==& (
additionalHeaders==) :
)==: ;
{>> 	
AddEntry?? 
(?? 
merged?? 
,?? 
entry?? "
)??" #
;??# $
}@@ 	
returnBB 
mergedBB 
;BB 
}CC 
privateEE 
staticEE 
voidEE 
AddEntryEE  
(EE  !
MetadataEE! )
targetEE* 0
,EE0 1
MetadataEE2 :
.EE: ;
EntryEE; @
entryEEA F
)EEF G
{FF 
ifGG 

(GG 
entryGG 
.GG 
IsBinaryGG 
)GG 
{HH 	
targetII 
.II 
AddII 
(II 
entryII 
.II 
KeyII  
,II  !
entryII" '
.II' (

ValueBytesII( 2
)II2 3
;II3 4
}JJ 	
elseKK 
{LL 	
targetMM 
.MM 
AddMM 
(MM 
entryMM 
.MM 
KeyMM  
,MM  !
entryMM" '
.MM' (
ValueMM( -
)MM- .
;MM. /
}NN 	
}OO 
}PP ∫Ã
Ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Membership/SecureKeyValidator.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !

Membership! +
;+ ,
public

 
static

 
partial

 
class

 
SecureKeyValidator

 .
{ 
private 
static 
readonly 
Regex !
HasUppercaseRegex" 3
=4 5$
HasUppercaseRegexPattern6 N
(N O
)O P
;P Q
private 
static 
readonly 
Regex !
HasDigitRegex" /
=0 1 
HasDigitRegexPattern2 F
(F G
)G H
;H I
private 
static 
readonly 
Regex !
HasLowercaseRegex" 3
=4 5$
HasLowercaseRegexPattern6 N
(N O
)O P
;P Q
private 
static 
readonly 
Regex !
HasSpecialCharRegex" 5
=6 7&
HasSpecialCharRegexPattern8 R
(R S
)S T
;T U
private 
static 
readonly 
Regex !$
HasNonEnglishLetterRegex" :
=; <+
HasNonEnglishLetterRegexPattern= \
(\ ]
)] ^
;^ _
[ 
GeneratedRegex 
( 
$str 
, 
RegexOptions )
.) *
Compiled* 2
)2 3
]3 4
private 
static 
partial 
Regex  $
HasUppercaseRegexPattern! 9
(9 :
): ;
;; <
[ 
GeneratedRegex 
( 
$str 
, 
RegexOptions '
.' (
Compiled( 0
)0 1
]1 2
private 
static 
partial 
Regex   
HasDigitRegexPattern! 5
(5 6
)6 7
;7 8
[ 
GeneratedRegex 
( 
$str 
, 
RegexOptions )
.) *
Compiled* 2
)2 3
]3 4
private 
static 
partial 
Regex  $
HasLowercaseRegexPattern! 9
(9 :
): ;
;; <
[ 
GeneratedRegex 
( 
$str "
," #
RegexOptions$ 0
.0 1
Compiled1 9
)9 :
]: ;
private 
static 
partial 
Regex  &
HasSpecialCharRegexPattern! ;
(; <
)< =
;= >
[ 
GeneratedRegex 
( 
$str '
,' (
RegexOptions) 5
.5 6
Compiled6 >
)> ?
]? @
private   
static   
partial   
Regex    +
HasNonEnglishLetterRegexPattern  ! @
(  @ A
)  A B
;  B C
public"" 

static"" 
("" 
string"" 
?"" 
ERROR""  
,""  !
List""" &
<""& '
string""' -
>""- .
Recommendations""/ >
)""> ?
Validate""@ H
(""H I
string""I O
	secureKey""P Y
,""Y Z 
ILocalizationService## 
localizationService## 0
,##0 1
bool##2 6
_##7 8
=##9 :
false##; @
)##@ A
{$$ 
List%% 
<%% 
string%% 
>%% 
recommendations%% $
=%%% &
[%%' (
]%%( )
;%%) *
string&& 
?&& 
error&& 
=&& 
null&& 
;&& 
List(( 
<(( 
((( 
Func(( 
<(( 
string(( 
,(( 
bool(( 
>((  
	IsInvalid((! *
,((* +
string((, 2
ErrorMessageKey((3 B
,((B C
object((D J
[((J K
]((K L
?((L M
Args((N R
)((R S
>((S T
hardValidationRules((U h
=((i j
[)) 	
(**  
HasNonEnglishLetters** !
,**! "'
SecureKeyValidatorConstants**# >
.**> ?
LocalizationKeys**? O
.**O P
NON_ENGLISH_LETTERS**P c
,**c d
null**e i
)**i j
,**j k
(++ 
string++ 
.++ 
IsNullOrWhiteSpace++ &
,++& ''
SecureKeyValidatorConstants++( C
.++C D
LocalizationKeys++D T
.++T U
REQUIRED++U ]
,++] ^
null++_ c
)++c d
,++d e
(,, 
s,, 
=>,, 
s,, 
.,, 
Length,, 
<,, '
SecureKeyValidatorConstants,, 8
.,,8 9
ValidationRules,,9 H
.,,H I

MIN_LENGTH,,I S
,,,S T'
SecureKeyValidatorConstants-- +
.--+ ,
LocalizationKeys--, <
.--< =

MIN_LENGTH--= G
,--G H
[.. '
SecureKeyValidatorConstants.. ,
..., -
ValidationRules..- <
...< =

MIN_LENGTH..= G
]..G H
)..H I
,..I J
(// 
s// 
=>// 
!// 
HasUppercaseRegex// $
.//$ %
IsMatch//% ,
(//, -
s//- .
)//. /
,/// 0'
SecureKeyValidatorConstants//1 L
.//L M
LocalizationKeys//M ]
.//] ^
NO_UPPERCASE//^ j
,//j k
null//l p
)//p q
,//q r
(00 
s00 
=>00 
!00 
HasLowercaseRegex00 $
.00$ %
IsMatch00% ,
(00, -
s00- .
)00. /
,00/ 0'
SecureKeyValidatorConstants001 L
.00L M
LocalizationKeys00M ]
.00] ^
NO_LOWERCASE00^ j
,00j k
null00l p
)00p q
,00q r
(11 
s11 
=>11 
!11 
HasSpecialCharRegex11 &
.11& '
IsMatch11' .
(11. /
s11/ 0
)110 1
,111 2'
SecureKeyValidatorConstants113 N
.11N O
LocalizationKeys11O _
.11_ `
NO_SPECIAL_CHAR11` o
,11o p
null11q u
)11u v
]22 	
;22	 

List44 
<44 
(44 
Func44 
<44 
string44 
,44 
bool44 
>44  
IsWeak44! '
,44' (
string44) /
ErrorMessageKey440 ?
,44? @
object44A G
[44G H
]44H I
?44I J
Args44K O
)44O P
>44P Q
recommendationRules44R e
=44f g
[55 	
(66 
s66 
=>66 
!66 
HasDigitRegex66  
.66  !
IsMatch66! (
(66( )
s66) *
)66* +
,66+ ,'
SecureKeyValidatorConstants66- H
.66H I
LocalizationKeys66I Y
.66Y Z
NO_DIGIT66Z b
,66b c
null66d h
)66h i
,66i j
(77 
s77 
=>77 
s77 
.77 
Length77 
>77 '
SecureKeyValidatorConstants77 8
.778 9
ValidationRules779 H
.77H I

MAX_LENGTH77I S
,77S T'
SecureKeyValidatorConstants88 +
.88+ ,
LocalizationKeys88, <
.88< =

MAX_LENGTH88= G
,88G H
[99 '
SecureKeyValidatorConstants99 ,
.99, -
ValidationRules99- <
.99< =

MAX_LENGTH99= G
]99G H
)99H I
,99I J
(:: 
s:: 
=>:: 
s:: 
.:: 
Trim:: 
(:: 
):: 
!=:: 
s:: 
,::  '
SecureKeyValidatorConstants::! <
.::< =
LocalizationKeys::= M
.::M N
	NO_SPACES::N W
,::W X
null::Y ]
)::] ^
,::^ _
(;; 
s;; 
=>;; (
CalculateTotalShannonEntropy;; .
(;;. /
s;;/ 0
);;0 1
<;;2 3'
SecureKeyValidatorConstants;;4 O
.;;O P
ValidationRules;;P _
.;;_ `"
MIN_TOTAL_ENTROPY_BITS;;` v
,;;v w'
SecureKeyValidatorConstants<< +
.<<+ ,
LocalizationKeys<<, <
.<<< =

TOO_SIMPLE<<= G
,<<G H
null<<I M
)<<M N
,<<N O
(== 
s== 
=>== '
SecureKeyValidatorConstants== -
.==- ."
CommonlyUsedSecureKeys==. D
.==D E
Contains==E M
(==M N
s==N O
)==O P
,==P Q'
SecureKeyValidatorConstants>> +
.>>+ ,
LocalizationKeys>>, <
.>>< =

TOO_COMMON>>= G
,>>G H
null>>I M
)>>M N
,>>N O
(?? )
IsSequentialOrKeyboardPattern?? *
,??* +'
SecureKeyValidatorConstants??, G
.??G H
LocalizationKeys??H X
.??X Y
SEQUENTIAL_PATTERN??Y k
,??k l
null??m q
)??q r
,??r s
(@@ 
HasExcessiveRepeats@@  
,@@  !'
SecureKeyValidatorConstants@@" =
.@@= >
LocalizationKeys@@> N
.@@N O
REPEATED_CHARS@@O ]
,@@] ^
null@@_ c
)@@c d
,@@d e
(AA #
LacksCharacterDiversityAA $
,AA$ %'
SecureKeyValidatorConstantsAA& A
.AAA B
LocalizationKeysAAB R
.AAR S
LACKS_DIVERSITYAAS b
,AAb c
[BB '
SecureKeyValidatorConstantsBB ,
.BB, -
ValidationRulesBB- <
.BB< =
MIN_CHAR_CLASSESBB= M
]BBM N
)BBN O
,BBO P
(CC "
ContainsAppNameVariantCC #
,CC# $'
SecureKeyValidatorConstantsCC% @
.CC@ A
LocalizationKeysCCA Q
.CCQ R
CONTAINS_APP_NAMECCR c
,CCc d
nullCCe i
)CCi j
]DD 	
;DD	 

foreachFF 
(FF 
(FF 
FuncFF 
<FF 
stringFF 
,FF 
boolFF #
>FF# $
	isInvalidFF% .
,FF. /
stringFF0 6
errorMessageKeyFF7 F
,FFF G
objectFFH N
[FFN O
]FFO P
?FFP Q
argsFFR V
)FFV W
inFFX Z
hardValidationRulesFF[ n
)FFn o
{GG 	
boolHH 
resultHH 
=HH 
	isInvalidHH #
(HH# $
	secureKeyHH$ -
)HH- .
;HH. /
ifII 
(II 
resultII 
)II 
{JJ 
stringKK 
messageKK 
=KK  
localizationServiceKK! 4
[KK4 5
errorMessageKeyKK5 D
]KKD E
;KKE F
errorLL 
=LL 
argsLL 
!=LL 
nullLL  $
?LL% &
stringLL' -
.LL- .
FormatLL. 4
(LL4 5
messageLL5 <
,LL< =
argsLL> B
)LLB C
:LLD E
messageLLF M
;LLM N
returnMM 
(MM 
errorMM 
,MM 
recommendationsMM .
)MM. /
;MM/ 0
}NN 
}OO 	
foreachQQ 
(QQ 
(QQ 
FuncQQ 
<QQ 
stringQQ 
,QQ 
boolQQ #
>QQ# $
isWeakQQ% +
,QQ+ ,
stringQQ- 3
errorMessageKeyQQ4 C
,QQC D
objectQQE K
[QQK L
]QQL M
?QQM N
argsQQO S
)QQS T
inQQU W
recommendationRulesQQX k
)QQk l
{RR 	
boolSS 
resultSS 
=SS 
isWeakSS  
(SS  !
	secureKeySS! *
)SS* +
;SS+ ,
ifTT 
(TT 
resultTT 
)TT 
{UU 
stringVV 
messageVV 
=VV  
localizationServiceVV! 4
[VV4 5
errorMessageKeyVV5 D
]VVD E
;VVE F
recommendationsWW 
.WW  
AddWW  #
(WW# $
argsWW$ (
!=WW) +
nullWW, 0
?WW1 2
stringWW3 9
.WW9 :
FormatWW: @
(WW@ A
messageWWA H
,WWH I
argsWWJ N
)WWN O
:WWP Q
messageWWR Y
)WWY Z
;WWZ [
}XX 
}YY 	
return[[ 
([[ 
null[[ 
,[[ 
recommendations[[ %
)[[% &
;[[& '
}\\ 
public^^ 

static^^ 
SecureKeyStrength^^ #%
EstimateSecureKeyStrength^^$ =
(^^= >
string^^> D
	secureKey^^E N
,^^N O 
ILocalizationService^^P d
localizationService^^e x
)^^x y
{__ 
(`` 	
string``	 
?`` 
error`` 
,`` 
List`` 
<`` 
string`` #
>``# $
recommendations``% 4
)``4 5
=``6 7
Validate``8 @
(``@ A
	secureKey``A J
,``J K
localizationService``L _
)``_ `
;``` a
ifaa 

(aa 
erroraa 
!=aa 
nullaa 
)aa 
{bb 	
returncc 
SecureKeyStrengthcc $
.cc$ %
Invalidcc% ,
;cc, -
}dd 	
intff 
scoreff 
=ff 
$numff 
;ff 
scoregg 
+=gg 
	secureKeygg 
.gg 
Lengthgg !
switchgg" (
{hh 	
>=ii 
$numii 
=>ii 
$numii 
,ii 
>=jj 
$numjj 
=>jj 
$numjj 
,jj 
>=kk 
$numkk 
=>kk 
$numkk 
,kk 
>=ll 
$numll 
=>ll 
$numll 
,ll 
_mm 
=>mm 
$nummm 
}nn 	
;nn	 

intpp 
varietypp 
=pp "
GetCharacterClassCountpp ,
(pp, -
	secureKeypp- 6
)pp6 7
;pp7 8
ifqq 

(qq 
varietyqq 
>=qq 
$numqq 
)qq 
{rr 	
scoress 
+=ss 
$numss 
;ss 
}tt 	
ifvv 

(vv 
varietyvv 
>=vv 
$numvv 
)vv 
{ww 	
scorexx 
+=xx 
$numxx 
;xx 
}yy 	
if{{ 

({{ 
variety{{ 
=={{ 
$num{{ 
){{ 
{|| 	
score}} 
+=}} 
$num}} 
;}} 
}~~ 	
score
ÄÄ 
-=
ÄÄ 
recommendations
ÄÄ  
.
ÄÄ  !
Count
ÄÄ! &
;
ÄÄ& '
SecureKeyStrength
ÇÇ 
strength
ÇÇ "
=
ÇÇ# $
score
ÇÇ% *
switch
ÇÇ+ 1
{
ÉÉ 	
<=
ÑÑ 
$num
ÑÑ 
=>
ÑÑ 
SecureKeyStrength
ÑÑ %
.
ÑÑ% &
Weak
ÑÑ& *
,
ÑÑ* +
<=
ÖÖ 
$num
ÖÖ 
=>
ÖÖ 
SecureKeyStrength
ÖÖ %
.
ÖÖ% &
Good
ÖÖ& *
,
ÖÖ* +
<=
ÜÜ 
$num
ÜÜ 
=>
ÜÜ 
SecureKeyStrength
ÜÜ %
.
ÜÜ% &
Strong
ÜÜ& ,
,
ÜÜ, -
_
áá 
=>
áá 
SecureKeyStrength
áá "
.
áá" #

VeryStrong
áá# -
}
àà 	
;
àà	 

return
ââ 
strength
ââ 
;
ââ 
}
ää 
private
çç 
static
çç 
bool
çç +
IsSequentialOrKeyboardPattern
çç 5
(
çç5 6
string
çç6 <
s
çç= >
)
çç> ?
{
éé 
if
èè 

(
èè 
s
èè 
.
èè 
Length
èè 
<
èè 
$num
èè 
)
èè 
{
êê 	
return
ëë 
false
ëë 
;
ëë 
}
íí 	
string
îî 
lower
îî 
=
îî 
s
îî 
.
îî 
ToLowerInvariant
îî )
(
îî) *
)
îî* +
;
îî+ ,
for
ïï 
(
ïï 
int
ïï 
i
ïï 
=
ïï 
$num
ïï 
;
ïï 
i
ïï 
<=
ïï 
lower
ïï "
.
ïï" #
Length
ïï# )
-
ïï* +
$num
ïï, -
;
ïï- .
i
ïï/ 0
++
ïï0 2
)
ïï2 3
{
ññ 	
string
óó 
sub
óó 
=
óó 
lower
óó 
.
óó 
	Substring
óó (
(
óó( )
i
óó) *
,
óó* +
$num
óó, -
)
óó- .
;
óó. /
if
òò 
(
òò )
SecureKeyValidatorConstants
òò +
.
òò+ ,
KeyboardRows
òò, 8
.
òò8 9
Any
òò9 <
(
òò< =
row
òò= @
=>
òòA C
row
òòD G
.
òòG H
Contains
òòH P
(
òòP Q
sub
òòQ T
)
òòT U
)
òòU V
||
òòW Y
IsCharSequence
òòZ h
(
òòh i
sub
òòi l
)
òòl m
)
òòm n
{
ôô 
return
öö 
true
öö 
;
öö 
}
õõ 
}
úú 	
return
ûû 
false
ûû 
;
ûû 
}
üü 
private
°° 
static
°° 
bool
°° 
IsCharSequence
°° &
(
°°& '
string
°°' -
sub
°°. 1
)
°°1 2
{
¢¢ 
bool
££ 
asc
££ 
=
££ 
true
££ 
,
££ 
desc
££ 
=
££ 
true
££  $
;
££$ %
for
§§ 
(
§§ 
int
§§ 
j
§§ 
=
§§ 
$num
§§ 
;
§§ 
j
§§ 
<
§§ 
sub
§§ 
.
§§  
Length
§§  &
;
§§& '
j
§§( )
++
§§) +
)
§§+ ,
{
•• 	
if
¶¶ 
(
¶¶ 
sub
¶¶ 
[
¶¶ 
j
¶¶ 
]
¶¶ 
!=
¶¶ 
sub
¶¶ 
[
¶¶ 
j
¶¶ 
-
¶¶  !
$num
¶¶" #
]
¶¶# $
+
¶¶% &
$num
¶¶' (
)
¶¶( )
{
ßß 
asc
®® 
=
®® 
false
®® 
;
®® 
}
©© 
if
´´ 
(
´´ 
sub
´´ 
[
´´ 
j
´´ 
]
´´ 
!=
´´ 
sub
´´ 
[
´´ 
j
´´ 
-
´´  !
$num
´´" #
]
´´# $
-
´´% &
$num
´´' (
)
´´( )
{
¨¨ 
desc
≠≠ 
=
≠≠ 
false
≠≠ 
;
≠≠ 
}
ÆÆ 
}
ØØ 	
return
±± 
asc
±± 
||
±± 
desc
±± 
;
±± 
}
≤≤ 
private
¥¥ 
static
¥¥ 
bool
¥¥ !
HasExcessiveRepeats
¥¥ +
(
¥¥+ ,
string
¥¥, 2
s
¥¥3 4
)
¥¥4 5
{
µµ 
if
∂∂ 

(
∂∂ 
s
∂∂ 
.
∂∂ 
Length
∂∂ 
<
∂∂ 
$num
∂∂ 
)
∂∂ 
{
∑∑ 	
return
∏∏ 
false
∏∏ 
;
∏∏ 
}
ππ 	
for
ªª 
(
ªª 
int
ªª 
i
ªª 
=
ªª 
$num
ªª 
;
ªª 
i
ªª 
<=
ªª 
s
ªª 
.
ªª 
Length
ªª %
-
ªª& '
$num
ªª( )
;
ªª) *
i
ªª+ ,
++
ªª, .
)
ªª. /
{
ºº 	
if
ΩΩ 
(
ΩΩ 
s
ΩΩ 
[
ΩΩ 
i
ΩΩ 
]
ΩΩ 
==
ΩΩ 
s
ΩΩ 
[
ΩΩ 
i
ΩΩ 
+
ΩΩ 
$num
ΩΩ 
]
ΩΩ  
&&
ΩΩ! #
s
ΩΩ$ %
[
ΩΩ% &
i
ΩΩ& '
]
ΩΩ' (
==
ΩΩ) +
s
ΩΩ, -
[
ΩΩ- .
i
ΩΩ. /
+
ΩΩ0 1
$num
ΩΩ2 3
]
ΩΩ3 4
&&
ΩΩ5 7
s
ΩΩ8 9
[
ΩΩ9 :
i
ΩΩ: ;
]
ΩΩ; <
==
ΩΩ= ?
s
ΩΩ@ A
[
ΩΩA B
i
ΩΩB C
+
ΩΩD E
$num
ΩΩF G
]
ΩΩG H
)
ΩΩH I
{
ææ 
return
øø 
true
øø 
;
øø 
}
¿¿ 
}
¡¡ 	
return
√√ 
false
√√ 
;
√√ 
}
ƒƒ 
private
∆∆ 
static
∆∆ 
bool
∆∆ %
LacksCharacterDiversity
∆∆ /
(
∆∆/ 0
string
∆∆0 6
s
∆∆7 8
)
∆∆8 9
=>
∆∆: <$
GetCharacterClassCount
«« 
(
«« 
s
««  
)
««  !
<
««" #)
SecureKeyValidatorConstants
««$ ?
.
««? @
ValidationRules
««@ O
.
««O P
MIN_CHAR_CLASSES
««P `
;
««` a
private
…… 
static
…… 
int
…… $
GetCharacterClassCount
…… -
(
……- .
string
……. 4
s
……5 6
)
……6 7
{
   
int
ÀÀ 
classes
ÀÀ 
=
ÀÀ 
$num
ÀÀ 
;
ÀÀ 
if
ÃÃ 

(
ÃÃ 
HasLowercaseRegex
ÃÃ 
.
ÃÃ 
IsMatch
ÃÃ %
(
ÃÃ% &
s
ÃÃ& '
)
ÃÃ' (
)
ÃÃ( )
{
ÕÕ 	
classes
ŒŒ 
++
ŒŒ 
;
ŒŒ 
}
œœ 	
if
—— 

(
—— 
HasUppercaseRegex
—— 
.
—— 
IsMatch
—— %
(
——% &
s
——& '
)
——' (
)
——( )
{
““ 	
classes
”” 
++
”” 
;
”” 
}
‘‘ 	
if
÷÷ 

(
÷÷ 
HasDigitRegex
÷÷ 
.
÷÷ 
IsMatch
÷÷ !
(
÷÷! "
s
÷÷" #
)
÷÷# $
)
÷÷$ %
{
◊◊ 	
classes
ÿÿ 
++
ÿÿ 
;
ÿÿ 
}
ŸŸ 	
if
€€ 

(
€€ !
HasSpecialCharRegex
€€ 
.
€€  
IsMatch
€€  '
(
€€' (
s
€€( )
)
€€) *
)
€€* +
{
‹‹ 	
classes
›› 
++
›› 
;
›› 
}
ﬁﬁ 	
return
‡‡ 
classes
‡‡ 
;
‡‡ 
}
·· 
private
„„ 
static
„„ 
bool
„„ $
ContainsAppNameVariant
„„ .
(
„„. /
string
„„/ 5
s
„„6 7
)
„„7 8
=>
„„9 ;)
SecureKeyValidatorConstants
‰‰ #
.
‰‰# $
AppNameVariants
‰‰$ 3
.
‰‰3 4
Any
‰‰4 7
(
‰‰7 8
v
‰‰8 9
=>
‰‰: <
s
ÂÂ 
.
ÂÂ 
Contains
ÂÂ 
(
ÂÂ 
v
ÂÂ 
,
ÂÂ 
StringComparison
ÂÂ *
.
ÂÂ* +(
InvariantCultureIgnoreCase
ÂÂ+ E
)
ÂÂE F
)
ÂÂF G
;
ÂÂG H
private
ÁÁ 
static
ÁÁ 
double
ÁÁ *
CalculateTotalShannonEntropy
ÁÁ 6
(
ÁÁ6 7
string
ÁÁ7 =
s
ÁÁ> ?
)
ÁÁ? @
{
ËË 
if
ÈÈ 

(
ÈÈ 
string
ÈÈ 
.
ÈÈ 
IsNullOrEmpty
ÈÈ  
(
ÈÈ  !
s
ÈÈ! "
)
ÈÈ" #
)
ÈÈ# $
{
ÍÍ 	
return
ÎÎ 
$num
ÎÎ 
;
ÎÎ 
}
ÏÏ 	

Dictionary
ÓÓ 
<
ÓÓ 
char
ÓÓ 
,
ÓÓ 
int
ÓÓ 
>
ÓÓ 
freqMap
ÓÓ %
=
ÓÓ& '
s
ÓÓ( )
.
ÓÓ) *
GroupBy
ÓÓ* 1
(
ÓÓ1 2
c
ÓÓ2 3
=>
ÓÓ4 6
c
ÓÓ7 8
)
ÓÓ8 9
.
ÓÓ9 :
ToDictionary
ÓÓ: F
(
ÓÓF G
g
ÓÓG H
=>
ÓÓI K
g
ÓÓL M
.
ÓÓM N
Key
ÓÓN Q
,
ÓÓQ R
g
ÓÓS T
=>
ÓÓU W
g
ÓÓX Y
.
ÓÓY Z
Count
ÓÓZ _
(
ÓÓ_ `
)
ÓÓ` a
)
ÓÓa b
;
ÓÓb c
double
ÔÔ 
totalLength
ÔÔ 
=
ÔÔ 
s
ÔÔ 
.
ÔÔ 
Length
ÔÔ %
;
ÔÔ% &
double
 
perCharEntropy
 
=
 
freqMap
  '
.
' (
Values
( .
.
ÒÒ 
Select
ÒÒ 
(
ÒÒ 
count
ÒÒ 
=>
ÒÒ 
count
ÒÒ "
/
ÒÒ# $
totalLength
ÒÒ% 0
)
ÒÒ0 1
.
ÚÚ 
Sum
ÚÚ 
(
ÚÚ 
p
ÚÚ 
=>
ÚÚ 
-
ÚÚ 
p
ÚÚ 
*
ÚÚ 
Math
ÚÚ 
.
ÚÚ  
Log
ÚÚ  #
(
ÚÚ# $
p
ÚÚ$ %
,
ÚÚ% &
$num
ÚÚ' (
)
ÚÚ( )
)
ÚÚ) *
;
ÚÚ* +
return
ÛÛ 
perCharEntropy
ÛÛ 
*
ÛÛ 
totalLength
ÛÛ  +
;
ÛÛ+ ,
}
ÙÙ 
private
ˆˆ 
static
ˆˆ 
bool
ˆˆ "
HasNonEnglishLetters
ˆˆ ,
(
ˆˆ, -
string
ˆˆ- 3
s
ˆˆ4 5
)
ˆˆ5 6
=>
ˆˆ7 9&
HasNonEnglishLetterRegex
ˆˆ: R
.
ˆˆR S
IsMatch
ˆˆS Z
(
ˆˆZ [
s
ˆˆ[ \
)
ˆˆ\ ]
;
ˆˆ] ^
}˜˜ À
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Membership/SecureKeyStrength.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !

Membership! +
;+ ,
public 
enum 
SecureKeyStrength 
{ 
Invalid 
, 
VeryWeak 
, 
Weak 
, 	
Good 
, 	
Strong		 

,		
 

VeryStrong

 
} í&
É/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Membership/MobileNumberValidator.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !

Membership! +
;+ ,
public		 
static		 
partial		 
class		 !
MobileNumberValidator		 1
{

 
public 

static 
string 
Validate !
(! "
string" (
mobileNumber) 5
,5 6 
ILocalizationService7 K
localizationServiceL _
)_ `
{ 
List 
< 
( 
Func 
< 
string 
, 
bool 
>  
	IsInvalid! *
,* +
string, 2
ErrorMessageKey3 B
,B C
objectD J
[J K
]K L
?L M
ArgsN R
)R S
>S T
validationRulesU d
=e f
[ 	
( 
string 
. 
IsNullOrWhiteSpace &
,& '*
MobileNumberValidatorConstants( F
.F G
LocalizationKeysG W
.W X
CANNOT_BE_EMPTYX g
,g h
nulli m
)m n
,n o
( 
s 
=> 
! 
s 
. 

StartsWith 
(  *
MobileNumberValidatorConstants  >
.> ?
ValidationRules? N
.N O
COUNTRY_CODE_PREFIXO b
)b c
,c d*
MobileNumberValidatorConstants .
.. /
LocalizationKeys/ ?
.? @(
MUST_START_WITH_COUNTRY_CODE@ \
,\ ]
null^ b
)b c
,c d
( 
s 
=> 
s 
. 
Length 
> 
$num 
&& !"
ContainsNonDigitsRegex" 8
(8 9
)9 :
.: ;
IsMatch; B
(B C
sC D
[D E
$numE F
..F H
]H I
)I J
,J K*
MobileNumberValidatorConstants .
.. /
LocalizationKeys/ ?
.? @
CONTAINS_NON_DIGITS@ S
,S T
nullU Y
)Y Z
,Z [
( 
s 
=> 
s 
. 
Length 
is 
< *
MobileNumberValidatorConstants  >
.> ?
ValidationRules? N
.N O

MIN_DIGITSO Y
+Z [
$num\ ]
or 
> *
MobileNumberValidatorConstants 3
.3 4
ValidationRules4 C
.C D

MAX_DIGITSD N
+O P
$numQ R
,R S*
MobileNumberValidatorConstants .
.. /
LocalizationKeys/ ?
.? @
INCORRECT_LENGTH@ P
,P Q
[ *
MobileNumberValidatorConstants /
./ 0
ValidationRules0 ?
.? @

MIN_DIGITS@ J
,J K*
MobileNumberValidatorConstants /
./ 0
ValidationRules0 ?
.? @

MAX_DIGITS@ J
]J K
)K L
] 	
;	 

foreach 
( 
( 
Func 
< 
string 
, 
bool #
># $
	isInvalid% .
,. /
string0 6
errorMessageKey7 F
,F G
objectH N
[N O
]O P
?P Q
argsR V
)V W
inX Z
validationRules[ j
)j k
{ 	
if 
( 
	isInvalid 
( 
mobileNumber &
)& '
)' (
{ 
string 
message 
=  
localizationService! 4
[4 5
errorMessageKey5 D
]D E
;E F
return   
args   
!=   
null   #
?  $ %
string  & ,
.  , -
Format  - 3
(  3 4
message  4 ;
,  ; <
args  = A
)  A B
:  C D
message  E L
;  L M
}!! 
}"" 	
return$$ 
string$$ 
.$$ 
Empty$$ 
;$$ 
}%% 
['' 
GeneratedRegex'' 
('' 
$str'' 
)'' 
]'' 
private(( 
static(( 
partial(( 
Regex((  "
ContainsNonDigitsRegex((! 7
(((7 8
)((8 9
;((9 :
})) ◊†
{/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Membership/LogoutService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !

Membership! +
;+ ,
internal 
sealed	 
class 
LogoutService #
(# $
NetworkProvider 
networkProvider #
,# $
IMessageBus 

messageBus 
, -
!IApplicationSecureStorageProvider %,
 applicationSecureStorageProvider& F
,F G$
IApplicationStateManager 
stateManager )
,) * 
IStateCleanupService   
stateCleanupService   ,
,  , -
IApplicationRouter!! 
router!! 
,!! 
IIdentityService"" 
identityService"" $
)""$ %
:## 
ILogoutService## 
{$$ 
private%% 
readonly%% '
PendingLogoutRequestStorage%% 0(
_pendingLogoutRequestStorage%%1 M
=%%N O
new%%P S
(%%S T,
 applicationSecureStorageProvider%%T t
)%%t u
;%%u v
private&& 
readonly&& 
LogoutProofHandler&& '
_logoutProofHandler&&( ;
=&&< =
new&&> A
(&&A B
identityService&&B Q
,&&Q R,
 applicationSecureStorageProvider&&S s
)&&s t
;&&t u
private(( 
readonly(( "
PendingLogoutProcessor(( +#
_pendingLogoutProcessor((, C
=((D E
new)) 
()) 
networkProvider)) 
,)) 
new))  '
PendingLogoutRequestStorage))! <
())< =,
 applicationSecureStorageProvider))= ]
)))] ^
)))^ _
;))_ `
private++ 
const++ 
bool++ 
KEEP_PENDING_LOGOUT++ *
=+++ ,
true++- 1
;++1 2
private,, 
const,, 
bool,,  
CLEAR_PENDING_LOGOUT,, +
=,,, -
false,,. 3
;,,3 4
public.. 

async.. 
Task.. 
<.. 
Result.. 
<.. 
Unit.. !
,..! "
LogoutFailure..# 0
>..0 1
>..1 2
LogoutAsync..3 >
(..> ?
LogoutReason..? K
reason..L R
,..R S
CancellationToken// 
cancellationToken// +
=//, -
default//. 5
)//5 6
{00 
Result11 
<11 
string11 
,11 
LogoutFailure11 $
>11$ %
membershipResult11& 6
=117 8
await119 >)
ValidateAndGetMembershipAsync11? \
(11\ ]
)11] ^
.11^ _
ConfigureAwait11_ m
(11m n
false11n s
)11s t
;11t u
if22 

(22 
membershipResult22 
.22 
IsErr22 "
)22" #
{33 	
return44 
Result44 
<44 
Unit44 
,44 
LogoutFailure44  -
>44- .
.44. /
Err44/ 2
(442 3
membershipResult443 C
.44C D
	UnwrapErr44D M
(44M N
)44N O
)44O P
;44P Q
}55 	
string77 
membershipId77 
=77 
membershipResult77 .
.77. /
Unwrap77/ 5
(775 6
)776 7
;777 8
Result99 
<99 
(99 
LogoutRequest99 
request99 %
,99% &
uint99' +
	connectId99, 5
)995 6
,996 7
LogoutFailure998 E
>99E F
prepareResult99G T
=99U V
await:: %
PrepareLogoutRequestAsync:: +
(::+ ,
membershipId::, 8
,::8 9
reason::: @
)::@ A
.::A B
ConfigureAwait::B P
(::P Q
false::Q V
)::V W
;::W X
if<< 

(<< 
prepareResult<< 
.<< 
IsErr<< 
)<<  
{== 	
return>> 
Result>> 
<>> 
Unit>> 
,>> 
LogoutFailure>>  -
>>>- .
.>>. /
Err>>/ 2
(>>2 3
prepareResult>>3 @
.>>@ A
	UnwrapErr>>A J
(>>J K
)>>K L
)>>L M
;>>M N
}?? 	
(AA 	
LogoutRequestAA	 
logoutRequestAA $
,AA$ %
uintAA& *
	connectIdAA+ 4
)AA4 5
=AA6 7
prepareResultAA8 E
.AAE F
UnwrapAAF L
(AAL M
)AAM N
;AAN O
ResultCC 
<CC 
LogoutResponseCC 
,CC 
LogoutFailureCC ,
>CC, -
logoutResultCC. :
=CC; <
awaitDD $
ExecuteServerLogoutAsyncDD *
(DD* +
logoutRequestDD+ 8
,DD8 9
	connectIdDD: C
,DDC D
cancellationTokenDDE V
)DDV W
.DDW X
ConfigureAwaitDDX f
(DDf g
falseDDg l
)DDl m
;DDm n
ifFF 

(FF 
logoutResultFF 
.FF 
IsErrFF 
)FF 
{GG 	
returnHH 
awaitHH #
HandleFailedLogoutAsyncHH 0
(HH0 1
logoutRequestHH1 >
,HH> ?
membershipIdHH@ L
,HHL M
reasonHHN T
,HHT U
	connectIdHHV _
,HH_ `
cancellationTokenII !
)II! "
.II" #
ConfigureAwaitII# 1
(II1 2
falseII2 7
)II7 8
;II8 9
}JJ 	
LogoutResponseLL 
responseLL 
=LL  !
logoutResultLL" .
.LL. /
UnwrapLL/ 5
(LL5 6
)LL6 7
;LL7 8
returnNN 
awaitNN (
ProcessSuccessfulLogoutAsyncNN 1
(NN1 2
responseNN2 :
,NN: ;
membershipIdNN< H
,NNH I
reasonNNJ P
,NNP Q
	connectIdNNR [
,NN[ \
cancellationTokenNN] n
)NNn o
.OO 
ConfigureAwaitOO 
(OO 
falseOO !
)OO! "
;OO" #
}PP 
publicRR 

staticRR 
asyncRR 
TaskRR 
<RR 
boolRR !
>RR! "#
HasRevocationProofAsyncRR# :
(RR: ;-
!IApplicationSecureStorageProviderRR; \
storageProviderRR] l
,RRl m
stringSS 
membershipIdSS 
)SS 
{TT 
returnUU 
awaitUU 
LogoutProofHandlerUU '
.UU' (#
HasRevocationProofAsyncUU( ?
(UU? @
storageProviderUU@ O
,UUO P
membershipIdUUQ ]
)UU] ^
;UU^ _
}VV 
privateXX 
asyncXX 
TaskXX &
TryStorePendingLogoutAsyncXX 1
(XX1 2
LogoutRequestXX2 ?
requestXX@ G
)XXG H
{YY 
ResultZZ 
<ZZ 
UnitZZ 
,ZZ 
LogoutFailureZZ "
>ZZ" #
storeResultZZ$ /
=ZZ0 1
await[[ (
_pendingLogoutRequestStorage[[ .
.[[. /#
StorePendingLogoutAsync[[/ F
([[F G
request[[G N
)[[N O
.[[O P
ConfigureAwait[[P ^
([[^ _
false[[_ d
)[[d e
;[[e f
if]] 

(]] 
storeResult]] 
.]] 
IsErr]] 
)]] 
{^^ 	
Log__ 
.__ 
Warning__ 
(__ 
$str__ R
,__R S
storeResult`` 
.`` 
	UnwrapErr`` %
(``% &
)``& '
.``' (
Message``( /
)``/ 0
;``0 1
}aa 	
}bb 
privatedd 
asyncdd 
Taskdd 
<dd 
Resultdd 
<dd 
Unitdd "
,dd" #
LogoutFailuredd$ 1
>dd1 2
>dd2 3#
HandleFailedLogoutAsyncdd4 K
(ddK L
LogoutRequestee 
logoutRequestee #
,ee# $
stringff 
membershipIdff 
,ff 
LogoutReasongg 
reasongg 
,gg 
uinthh 
	connectIdhh 
,hh 
CancellationTokenii 
cancellationTokenii +
)ii+ ,
{jj 
awaitkk &
TryStorePendingLogoutAsynckk (
(kk( )
logoutRequestkk) 6
)kk6 7
.kk7 8
ConfigureAwaitkk8 F
(kkF G
falsekkG L
)kkL M
;kkM N
awaitmm *
CompleteLogoutWithCleanupAsyncmm ,
(mm, -
membershipIdmm- 9
,mm9 :
reasonmm; A
,mmA B
	connectIdmmC L
,mmL M
KEEP_PENDING_LOGOUTmmN a
,mma b
cancellationTokenmmc t
)mmt u
.nn 
ConfigureAwaitnn 
(nn 
falsenn !
)nn! "
;nn" #
returnpp 
Resultpp 
<pp 
Unitpp 
,pp 
LogoutFailurepp )
>pp) *
.pp* +
Okpp+ -
(pp- .
Unitpp. 2
.pp2 3
Valuepp3 8
)pp8 9
;pp9 :
}qq 
privatess 
asyncss 
Taskss 
<ss 
Resultss 
<ss 
stringss $
,ss$ %
LogoutFailuress& 3
>ss3 4
>ss4 5)
ValidateAndGetMembershipAsyncss6 S
(ssS T
)ssT U
{tt 
Resultuu 
<uu '
ApplicationInstanceSettingsuu *
,uu* +%
InternalServiceApiFailureuu, E
>uuE F
settingsResultuuG U
=uuV W
awaitvv ,
 applicationSecureStorageProvidervv 2
.vv2 3/
#GetApplicationInstanceSettingsAsyncvv3 V
(vvV W
)vvW X
.vvX Y
ConfigureAwaitvvY g
(vvg h
falsevvh m
)vvm n
;vvn o
ifxx 

(xx 
settingsResultxx 
.xx 
IsErrxx  
)xx  !
{yy 	
returnzz 
Resultzz 
<zz 
stringzz  
,zz  !
LogoutFailurezz" /
>zz/ 0
.zz0 1
Errzz1 4
(zz4 5
LogoutFailure{{ 
.{{ '
InvalidMembershipIdentifier{{ 9
({{9 :
$str{{: S
){{S T
){{T U
;{{U V
}|| 	'
ApplicationInstanceSettings~~ #
settings~~$ ,
=~~- .
settingsResult~~/ =
.~~= >
Unwrap~~> D
(~~D E
)~~E F
;~~F G
if
ÄÄ 

(
ÄÄ 
settings
ÄÄ 
.
ÄÄ 

Membership
ÄÄ 
?
ÄÄ  
.
ÄÄ  !
UniqueIdentifier
ÄÄ! 1
==
ÄÄ2 4
null
ÄÄ5 9
)
ÄÄ9 :
{
ÅÅ 	
return
ÇÇ 
Result
ÇÇ 
<
ÇÇ 
string
ÇÇ  
,
ÇÇ  !
LogoutFailure
ÇÇ" /
>
ÇÇ/ 0
.
ÇÇ0 1
Err
ÇÇ1 4
(
ÇÇ4 5
LogoutFailure
ÉÉ 
.
ÉÉ )
InvalidMembershipIdentifier
ÉÉ 9
(
ÉÉ9 :
$str
ÉÉ: S
)
ÉÉS T
)
ÉÉT U
;
ÉÉU V
}
ÑÑ 	
string
ÜÜ 
membershipId
ÜÜ 
=
ÜÜ 
Helpers
ÜÜ %
.
ÜÜ% &"
FromByteStringToGuid
ÜÜ& :
(
ÜÜ: ;
settings
ÜÜ; C
.
ÜÜC D

Membership
ÜÜD N
.
ÜÜN O
UniqueIdentifier
ÜÜO _
)
ÜÜ_ `
.
ÜÜ` a
ToString
ÜÜa i
(
ÜÜi j
)
ÜÜj k
;
ÜÜk l
return
áá 
Result
áá 
<
áá 
string
áá 
,
áá 
LogoutFailure
áá +
>
áá+ ,
.
áá, -
Ok
áá- /
(
áá/ 0
membershipId
áá0 <
)
áá< =
;
áá= >
}
àà 
private
ää 
async
ää 
Task
ää 
<
ää 
Result
ää 
<
ää 
(
ää 
LogoutRequest
ää ,
request
ää- 4
,
ää4 5
uint
ää6 :
	connectId
ää; D
)
ääD E
,
ääE F
LogoutFailure
ääG T
>
ääT U
>
ääU V'
PrepareLogoutRequestAsync
ääW p
(
ääp q
string
ãã 
membershipId
ãã 
,
ãã 
LogoutReason
åå 
reason
åå 
)
åå 
{
çç 
Result
éé 
<
éé )
ApplicationInstanceSettings
éé *
,
éé* +'
InternalServiceApiFailure
éé, E
>
ééE F
settingsResult
ééG U
=
ééV W
await
èè .
 applicationSecureStorageProvider
èè 2
.
èè2 31
#GetApplicationInstanceSettingsAsync
èè3 V
(
èèV W
)
èèW X
.
èèX Y
ConfigureAwait
èèY g
(
èèg h
false
èèh m
)
èèm n
;
èèn o
if
ëë 

(
ëë 
settingsResult
ëë 
.
ëë 
IsErr
ëë  
)
ëë  !
{
íí 	
return
ìì 
Result
ìì 
<
ìì 
(
ìì 
LogoutRequest
ìì (
,
ìì( )
uint
ìì* .
)
ìì. /
,
ìì/ 0
LogoutFailure
ìì1 >
>
ìì> ?
.
ìì? @
Err
ìì@ C
(
ììC D
LogoutFailure
îî 
.
îî "
NetworkRequestFailed
îî 2
(
îî2 3
$str
îî3 W
,
îîW X
new
ïï 
	Exception
ïï !
(
ïï! "
settingsResult
ïï" 0
.
ïï0 1
	UnwrapErr
ïï1 :
(
ïï: ;
)
ïï; <
.
ïï< =
Message
ïï= D
)
ïïD E
)
ïïE F
)
ïïF G
;
ïïG H
}
ññ 	)
ApplicationInstanceSettings
òò #
settings
òò$ ,
=
òò- .
settingsResult
òò/ =
.
òò= >
Unwrap
òò> D
(
òòD E
)
òòE F
;
òòF G
long
öö 
	timestamp
öö 
=
öö 
DateTimeOffset
öö '
.
öö' (
UtcNow
öö( .
.
öö. /
ToUnixTimeSeconds
öö/ @
(
öö@ A
)
ööA B
;
ööB C

ByteString
õõ 
membershipIdBytes
õõ $
=
õõ% &
Helpers
õõ' .
.
õõ. /
GuidToByteString
õõ/ ?
(
õõ? @
Guid
õõ@ D
.
õõD E
Parse
õõE J
(
õõJ K
membershipId
õõK W
)
õõW X
)
õõX Y
;
õõY Z
LogoutRequest
ùù 
logoutRequest
ùù #
=
ùù$ %
new
ùù& )
(
ùù) *
)
ùù* +
{
ûû 	"
MembershipIdentifier
üü  
=
üü! "
membershipIdBytes
üü# 4
,
üü4 5
LogoutReason
†† 
=
†† 
reason
†† !
.
††! "
ToString
††" *
(
††* +
)
††+ ,
,
††, -
	Timestamp
°° 
=
°° 
	timestamp
°° !
,
°°! "
Scope
¢¢ 
=
¢¢ 
LogoutScope
¢¢ 
.
¢¢  

ThisDevice
¢¢  *
,
¢¢* +
AccountIdentifier
££ 
=
££ 
settings
££  (
.
££( )
CurrentAccountId
££) 9
}
§§ 	
;
§§	 

Result
¶¶ 
<
¶¶ 
Unit
¶¶ 
,
¶¶ 
LogoutFailure
¶¶ "
>
¶¶" #

hmacResult
¶¶$ .
=
¶¶/ 0
await
ßß !
_logoutProofHandler
ßß %
.
ßß% &*
GenerateLogoutHmacProofAsync
ßß& B
(
ßßB C
logoutRequest
ßßC P
,
ßßP Q
membershipId
ßßR ^
)
ßß^ _
;
ßß_ `
if
©© 

(
©© 

hmacResult
©© 
.
©© 
IsErr
©© 
)
©© 
{
™™ 	
Log
´´ 
.
´´ 
Warning
´´ 
(
´´ 
$str
´´ I
,
´´I J

hmacResult
´´K U
.
´´U V
	UnwrapErr
´´V _
(
´´_ `
)
´´` a
.
´´a b
Message
´´b i
)
´´i j
;
´´j k
return
¨¨ 
Result
¨¨ 
<
¨¨ 
(
¨¨ 
LogoutRequest
¨¨ (
,
¨¨( )
uint
¨¨* .
)
¨¨. /
,
¨¨/ 0
LogoutFailure
¨¨1 >
>
¨¨> ?
.
¨¨? @
Err
¨¨@ C
(
¨¨C D

hmacResult
¨¨D N
.
¨¨N O
	UnwrapErr
¨¨O X
(
¨¨X Y
)
¨¨Y Z
)
¨¨Z [
;
¨¨[ \
}
≠≠ 	
uint
ØØ 
	connectId
ØØ 
=
ØØ 
NetworkProvider
ØØ (
.
ØØ( )$
ComputeUniqueConnectId
ØØ) ?
(
ØØ? @
settings
∞∞ 
,
∞∞  
PubKeyExchangeType
±± 
.
±± (
DataCenterEphemeralConnect
±± 9
)
±±9 :
;
±±: ;
return
≥≥ 
Result
≥≥ 
<
≥≥ 
(
≥≥ 
LogoutRequest
≥≥ $
,
≥≥$ %
uint
≥≥& *
)
≥≥* +
,
≥≥+ ,
LogoutFailure
≥≥- :
>
≥≥: ;
.
≥≥; <
Ok
≥≥< >
(
≥≥> ?
(
≥≥? @
logoutRequest
≥≥@ M
,
≥≥M N
	connectId
≥≥O X
)
≥≥X Y
)
≥≥Y Z
;
≥≥Z [
}
¥¥ 
private
∂∂ 
async
∂∂ 
Task
∂∂ 
<
∂∂ 
Result
∂∂ 
<
∂∂ 
LogoutResponse
∂∂ ,
,
∂∂, -
LogoutFailure
∂∂. ;
>
∂∂; <
>
∂∂< =&
ExecuteServerLogoutAsync
∂∂> V
(
∂∂V W
LogoutRequest
∑∑ 
logoutRequest
∑∑ #
,
∑∑# $
uint
∏∏ 
	connectId
∏∏ 
,
∏∏ 
CancellationToken
ππ 
cancellationToken
ππ +
)
ππ+ ,
{
∫∫ "
TaskCompletionSource
ªª 
<
ªª 
Result
ªª #
<
ªª# $
LogoutResponse
ªª$ 2
,
ªª2 3
LogoutFailure
ªª4 A
>
ªªA B
>
ªªB C&
responseCompletionSource
ªªD \
=
ªª] ^
new
ºº 
(
ºº !
TaskCreationOptions
ºº #
.
ºº# $,
RunContinuationsAsynchronously
ºº$ B
)
ººB C
;
ººC D
Result
ææ 
<
ææ 
Unit
ææ 
,
ææ 
NetworkFailure
ææ #
>
ææ# $
networkResult
ææ% 2
=
ææ3 4
await
ææ5 :
networkProvider
ææ; J
.
ææJ K&
ExecuteUnaryRequestAsync
ææK c
(
ææc d
	connectId
øø 
,
øø 
RpcServiceType
¿¿ 
.
¿¿ 
Logout
¿¿ !
,
¿¿! "
logoutRequest
¡¡ 
.
¡¡ 
ToByteArray
¡¡ %
(
¡¡% &
)
¡¡& '
,
¡¡' (
responsePayload
¬¬ 
=>
¬¬ 
{
√√ 
LogoutResponse
ƒƒ 
logoutResponse
ƒƒ -
=
ƒƒ. /
LogoutResponse
ƒƒ0 >
.
ƒƒ> ?
Parser
ƒƒ? E
.
ƒƒE F
	ParseFrom
ƒƒF O
(
ƒƒO P
responsePayload
ƒƒP _
)
ƒƒ_ `
;
ƒƒ` a
if
∆∆ 
(
∆∆ 
logoutResponse
∆∆ "
.
∆∆" #
Result
∆∆# )
!=
∆∆* ,
LogoutResponse
∆∆- ;
.
∆∆; <
Types
∆∆< A
.
∆∆A B
Result
∆∆B H
.
∆∆H I
	Succeeded
∆∆I R
)
∆∆R S
{
«« 
Log
»» 
.
»» 
Warning
»» 
(
»»  
$str
»»  W
,
»»W X
logoutResponse
»»Y g
.
»»g h
Result
»»h n
)
»»n o
;
»»o p
}
…… &
responseCompletionSource
ÀÀ (
.
ÀÀ( )
TrySetResult
ÀÀ) 5
(
ÀÀ5 6
MapLogoutResponse
ÀÀ6 G
(
ÀÀG H
logoutResponse
ÀÀH V
)
ÀÀV W
)
ÀÀW X
;
ÀÀX Y
return
ÃÃ 
Task
ÃÃ 
.
ÃÃ 

FromResult
ÃÃ &
(
ÃÃ& '
Result
ÃÃ' -
<
ÃÃ- .
Unit
ÃÃ. 2
,
ÃÃ2 3
NetworkFailure
ÃÃ4 B
>
ÃÃB C
.
ÃÃC D
Ok
ÃÃD F
(
ÃÃF G
Unit
ÃÃG K
.
ÃÃK L
Value
ÃÃL Q
)
ÃÃQ R
)
ÃÃR S
;
ÃÃS T
}
ÕÕ 
,
ÕÕ 
allowDuplicates
ŒŒ 
:
ŒŒ 
false
ŒŒ "
,
ŒŒ" #
token
œœ 
:
œœ 
cancellationToken
œœ $
,
œœ$ %
waitForRecovery
–– 
:
–– 
false
–– "
)
––" #
.
––# $
ConfigureAwait
––$ 2
(
––2 3
false
––3 8
)
––8 9
;
––9 :
if
““ 

(
““ 
networkResult
““ 
.
““ 
IsErr
““ 
)
““  
{
”” 	
NetworkFailure
‘‘ 
failure
‘‘ "
=
‘‘# $
networkResult
‘‘% 2
.
‘‘2 3
	UnwrapErr
‘‘3 <
(
‘‘< =
)
‘‘= >
;
‘‘> ?
Log
’’ 
.
’’ 
Warning
’’ 
(
’’ 
$str
’’ B
,
’’B C
failure
’’D K
.
’’K L
Message
’’L S
)
’’S T
;
’’T U
return
÷÷ 
Result
÷÷ 
<
÷÷ 
LogoutResponse
÷÷ (
,
÷÷( )
LogoutFailure
÷÷* 7
>
÷÷7 8
.
÷÷8 9
Err
÷÷9 <
(
÷÷< =
LogoutFailure
◊◊ 
.
◊◊ "
NetworkRequestFailed
◊◊ 2
(
◊◊2 3
$str
◊◊3 K
,
◊◊K L
new
◊◊M P
	Exception
◊◊Q Z
(
◊◊Z [
failure
◊◊[ b
.
◊◊b c
Message
◊◊c j
)
◊◊j k
)
◊◊k l
)
◊◊l m
;
◊◊m n
}
ÿÿ 	
Result
⁄⁄ 
<
⁄⁄ 
LogoutResponse
⁄⁄ 
,
⁄⁄ 
LogoutFailure
⁄⁄ ,
>
⁄⁄, -
responseResult
⁄⁄. <
=
⁄⁄= >
await
€€ &
responseCompletionSource
€€ *
.
€€* +
Task
€€+ /
.
€€/ 0
ConfigureAwait
€€0 >
(
€€> ?
false
€€? D
)
€€D E
;
€€E F
if
›› 

(
›› 
responseResult
›› 
.
›› 
IsErr
››  
)
››  !
{
ﬁﬁ 	
LogoutFailure
ﬂﬂ 
serverFailure
ﬂﬂ '
=
ﬂﬂ( )
responseResult
ﬂﬂ* 8
.
ﬂﬂ8 9
	UnwrapErr
ﬂﬂ9 B
(
ﬂﬂB C
)
ﬂﬂC D
;
ﬂﬂD E
Log
‡‡ 
.
‡‡ 
Warning
‡‡ 
(
‡‡ 
$str
‡‡ A
,
‡‡A B
serverFailure
‡‡C P
.
‡‡P Q
Message
‡‡Q X
)
‡‡X Y
;
‡‡Y Z
return
·· 
Result
·· 
<
·· 
LogoutResponse
·· (
,
··( )
LogoutFailure
··* 7
>
··7 8
.
··8 9
Err
··9 <
(
··< =
serverFailure
··= J
)
··J K
;
··K L
}
‚‚ 	
return
‰‰ 
Result
‰‰ 
<
‰‰ 
LogoutResponse
‰‰ $
,
‰‰$ %
LogoutFailure
‰‰& 3
>
‰‰3 4
.
‰‰4 5
Ok
‰‰5 7
(
‰‰7 8
responseResult
‰‰8 F
.
‰‰F G
Unwrap
‰‰G M
(
‰‰M N
)
‰‰N O
)
‰‰O P
;
‰‰P Q
}
ÂÂ 
private
ÁÁ 
async
ÁÁ 
Task
ÁÁ 
<
ÁÁ 
Result
ÁÁ 
<
ÁÁ 
Unit
ÁÁ "
,
ÁÁ" #
LogoutFailure
ÁÁ$ 1
>
ÁÁ1 2
>
ÁÁ2 3*
ProcessSuccessfulLogoutAsync
ÁÁ4 P
(
ÁÁP Q
LogoutResponse
ËË 
response
ËË 
,
ËË  
string
ÈÈ 
membershipId
ÈÈ 
,
ÈÈ 
LogoutReason
ÍÍ 
reason
ÍÍ 
,
ÍÍ 
uint
ÎÎ 
	connectId
ÎÎ 
,
ÎÎ 
CancellationToken
ÏÏ 
cancellationToken
ÏÏ +
)
ÏÏ+ ,
{
ÌÌ 
Result
ÓÓ 
<
ÓÓ 
Unit
ÓÓ 
,
ÓÓ 
LogoutFailure
ÓÓ "
>
ÓÓ" #
proofVerification
ÓÓ$ 5
=
ÓÓ6 7
await
ÔÔ !
_logoutProofHandler
ÔÔ %
.
ÔÔ% &(
VerifyRevocationProofAsync
ÔÔ& @
(
ÔÔ@ A
response
ÔÔA I
,
ÔÔI J
membershipId
ÔÔK W
,
ÔÔW X
	connectId
ÔÔY b
)
ÔÔb c
;
ÔÔc d
if
ÒÒ 

(
ÒÒ 
proofVerification
ÒÒ 
.
ÒÒ 
IsErr
ÒÒ #
)
ÒÒ# $
{
ÚÚ 	
Log
ÛÛ 
.
ÛÛ 
Error
ÛÛ 
(
ÛÛ 
$str
ÛÛ f
,
ÛÛf g
membershipId
ÙÙ 
)
ÙÙ 
;
ÙÙ 
}
ıı 	
await
˜˜ ,
CompleteLogoutWithCleanupAsync
˜˜ ,
(
˜˜, -
membershipId
˜˜- 9
,
˜˜9 :
reason
˜˜; A
,
˜˜A B
	connectId
˜˜C L
,
˜˜L M"
CLEAR_PENDING_LOGOUT
˜˜N b
,
˜˜b c
cancellationToken
˜˜d u
)
˜˜u v
.
¯¯ 
ConfigureAwait
¯¯ 
(
¯¯ 
false
¯¯ !
)
¯¯! "
;
¯¯" #
return
˙˙ 
Result
˙˙ 
<
˙˙ 
Unit
˙˙ 
,
˙˙ 
LogoutFailure
˙˙ )
>
˙˙) *
.
˙˙* +
Ok
˙˙+ -
(
˙˙- .
Unit
˙˙. 2
.
˙˙2 3
Value
˙˙3 8
)
˙˙8 9
;
˙˙9 :
}
˚˚ 
private
˝˝ 
async
˝˝ 
Task
˝˝ !
FinalizeLogoutAsync
˝˝ *
(
˝˝* +
string
˝˝+ 1
membershipId
˝˝2 >
,
˝˝> ?
LogoutReason
˝˝@ L
reason
˝˝M S
,
˝˝S T
bool
˝˝U Y&
shouldRetryPendingLogout
˝˝Z r
,
˝˝r s
CancellationToken
˛˛ 
cancellationToken
˛˛ +
)
˛˛+ ,
{
ˇˇ 
await
ÄÄ 
stateManager
ÄÄ 
.
ÄÄ (
TransitionToAnonymousAsync
ÄÄ 5
(
ÄÄ5 6
)
ÄÄ6 7
.
ÄÄ7 8
ConfigureAwait
ÄÄ8 F
(
ÄÄF G
false
ÄÄG L
)
ÄÄL M
;
ÄÄM N
await
ÇÇ 

messageBus
ÇÇ 
.
ÇÇ 
PublishAsync
ÇÇ %
(
ÇÇ% &
new
ÇÇ& )&
MembershipLoggedOutEvent
ÇÇ* B
(
ÇÇB C
membershipId
ÇÇC O
,
ÇÇO P
reason
ÇÇQ W
.
ÇÇW X
ToString
ÇÇX `
(
ÇÇ` a
)
ÇÇa b
)
ÇÇb c
,
ÇÇc d
cancellationToken
ÇÇe v
)
ÇÇv w
.
ÉÉ 
ConfigureAwait
ÉÉ 
(
ÉÉ 
false
ÉÉ !
)
ÉÉ! "
;
ÉÉ" #
await
ÖÖ 
router
ÖÖ 
.
ÖÖ +
NavigateToAuthenticationAsync
ÖÖ 2
(
ÖÖ2 3
)
ÖÖ3 4
.
ÖÖ4 5
ConfigureAwait
ÖÖ5 C
(
ÖÖC D
false
ÖÖD I
)
ÖÖI J
;
ÖÖJ K
if
áá 

(
áá &
shouldRetryPendingLogout
áá $
)
áá$ %
{
àà 	
_
ââ 
=
ââ 
Task
ââ 
.
ââ 
Run
ââ 
(
ââ 
async
ââ 
(
ââ  
)
ââ  !
=>
ââ" $
{
ää 
try
ãã 
{
åå 
Result
çç 
<
çç )
ApplicationInstanceSettings
çç 6
,
çç6 7'
InternalServiceApiFailure
çç8 Q
>
ççQ R
settingsResult
ççS a
=
ççb c
await
éé .
 applicationSecureStorageProvider
éé >
.
éé> ?1
#GetApplicationInstanceSettingsAsync
éé? b
(
ééb c
)
ééc d
.
èè 
ConfigureAwait
èè +
(
èè+ ,
false
èè, 1
)
èè1 2
;
èè2 3
if
ëë 
(
ëë 
settingsResult
ëë &
.
ëë& '
IsOk
ëë' +
)
ëë+ ,
{
íí )
ApplicationInstanceSettings
ìì 3
settings
ìì4 <
=
ìì= >
settingsResult
ìì? M
.
ììM N
Unwrap
ììN T
(
ììT U
)
ììU V
;
ììV W
uint
îî  
anonymousConnectId
îî /
=
îî0 1
NetworkProvider
îî2 A
.
îîA B$
ComputeUniqueConnectId
îîB X
(
îîX Y
settings
ïï $
,
ïï$ % 
PubKeyExchangeType
ññ .
.
ññ. /(
DataCenterEphemeralConnect
ññ/ I
)
ññI J
;
ññJ K
await
òò %
_pendingLogoutProcessor
òò 5
.
òò5 6'
ProcessPendingLogoutAsync
òò6 O
(
òòO P 
anonymousConnectId
òòP b
)
òòb c
.
ôô 
ConfigureAwait
ôô +
(
ôô+ ,
false
ôô, 1
)
ôô1 2
;
ôô2 3
}
öö 
else
õõ 
{
úú 
Log
ùù 
.
ùù 
Warning
ùù #
(
ùù# $
$str
ûû |
,
ûû| }
settingsResult
üü *
.
üü* +
	UnwrapErr
üü+ 4
(
üü4 5
)
üü5 6
.
üü6 7
Message
üü7 >
)
üü> ?
;
üü? @
}
†† 
}
°° 
catch
¢¢ 
(
¢¢ 
	Exception
¢¢  
ex
¢¢! #
)
¢¢# $
{
££ 
Log
§§ 
.
§§ 
Warning
§§ 
(
§§  
ex
§§  "
,
§§" #
$str
§§$ v
)
§§v w
;
§§w x
}
•• 
}
¶¶ 
)
¶¶ 
.
¶¶ 
ContinueWith
¶¶ 
(
¶¶ 
task
ßß 
=>
ßß 
{
®® 
if
©© 
(
©© 
task
©© 
.
©© 
	IsFaulted
©© &
&&
©©' )
task
©©* .
.
©©. /
	Exception
©©/ 8
!=
©©9 ;
null
©©< @
)
©©@ A
{
™™ 
Log
´´ 
.
´´ 
Error
´´ !
(
´´! "
task
´´" &
.
´´& '
	Exception
´´' 0
,
´´0 1
$str
´´2 n
)
´´n o
;
´´o p
}
¨¨ 
}
≠≠ 
,
≠≠ 
TaskScheduler
ÆÆ 
.
ÆÆ 
Default
ÆÆ %
)
ÆÆ% &
;
ÆÆ& '
}
ØØ 	
}
∞∞ 
private
≤≤ 
static
≤≤ 
Result
≤≤ 
<
≤≤ 
LogoutResponse
≤≤ (
,
≤≤( )
LogoutFailure
≤≤* 7
>
≤≤7 8
MapLogoutResponse
≤≤9 J
(
≤≤J K
LogoutResponse
≤≤K Y
response
≤≤Z b
)
≤≤b c
{
≥≥ 
return
¥¥ 
response
¥¥ 
.
¥¥ 
Result
¥¥ 
switch
¥¥ %
{
µµ 	
LogoutResponse
∂∂ 
.
∂∂ 
Types
∂∂  
.
∂∂  !
Result
∂∂! '
.
∂∂' (
	Succeeded
∂∂( 1
=>
∂∂2 4
Result
∂∂5 ;
<
∂∂; <
LogoutResponse
∂∂< J
,
∂∂J K
LogoutFailure
∂∂L Y
>
∂∂Y Z
.
∂∂Z [
Ok
∂∂[ ]
(
∂∂] ^
response
∂∂^ f
)
∂∂f g
,
∂∂g h
LogoutResponse
∑∑ 
.
∑∑ 
Types
∑∑  
.
∑∑  !
Result
∑∑! '
.
∑∑' (
AlreadyLoggedOut
∑∑( 8
=>
∑∑9 ;
Result
∑∑< B
<
∑∑B C
LogoutResponse
∑∑C Q
,
∑∑Q R
LogoutFailure
∑∑S `
>
∑∑` a
.
∑∑a b
Err
∑∑b e
(
∑∑e f
LogoutFailure
∏∏ 
.
∏∏ 
AlreadyLoggedOut
∏∏ .
(
∏∏. /
$str
∏∏/ \
)
∏∏\ ]
)
∏∏] ^
,
∏∏^ _
LogoutResponse
ππ 
.
ππ 
Types
ππ  
.
ππ  !
Result
ππ! '
.
ππ' (
SessionNotFound
ππ( 7
=>
ππ8 :
Result
ππ; A
<
ππA B
LogoutResponse
ππB P
,
ππP Q
LogoutFailure
ππR _
>
ππ_ `
.
ππ` a
Err
ππa d
(
ππd e
LogoutFailure
∫∫ 
.
∫∫ 
SESSION_NOT_FOUND
∫∫ /
(
∫∫/ 0
$str
∫∫0 \
)
∫∫\ ]
)
∫∫] ^
,
∫∫^ _
LogoutResponse
ªª 
.
ªª 
Types
ªª  
.
ªª  !
Result
ªª! '
.
ªª' (
InvalidTimestamp
ªª( 8
=>
ªª9 ;
Result
ªª< B
<
ªªB C
LogoutResponse
ªªC Q
,
ªªQ R
LogoutFailure
ªªS `
>
ªª` a
.
ªªa b
Err
ªªb e
(
ªªe f
LogoutFailure
ºº 
.
ºº 
UnexpectedError
ºº -
(
ºº- .
$str
ºº. `
)
ºº` a
)
ººa b
,
ººb c
LogoutResponse
ΩΩ 
.
ΩΩ 
Types
ΩΩ  
.
ΩΩ  !
Result
ΩΩ! '
.
ΩΩ' (
InvalidHmac
ΩΩ( 3
=>
ΩΩ4 6
Result
ΩΩ7 =
<
ΩΩ= >
LogoutResponse
ΩΩ> L
,
ΩΩL M
LogoutFailure
ΩΩN [
>
ΩΩ[ \
.
ΩΩ\ ]
Err
ΩΩ] `
(
ΩΩ` a
LogoutFailure
ææ 
.
ææ *
CryptographicOperationFailed
ææ :
(
ææ: ;
$str
ææ; g
)
ææg h
)
ææh i
,
ææi j
LogoutResponse
øø 
.
øø 
Types
øø  
.
øø  !
Result
øø! '
.
øø' (
Failed
øø( .
=>
øø/ 1
Result
øø2 8
<
øø8 9
LogoutResponse
øø9 G
,
øøG H
LogoutFailure
øøI V
>
øøV W
.
øøW X
Err
øøX [
(
øø[ \
LogoutFailure
¿¿ 
.
¿¿ 
UnexpectedError
¿¿ -
(
¿¿- .
$str
¿¿. P
)
¿¿P Q
)
¿¿Q R
,
¿¿R S
_
¡¡ 
=>
¡¡ 
Result
¡¡ 
<
¡¡ 
LogoutResponse
¡¡ &
,
¡¡& '
LogoutFailure
¡¡( 5
>
¡¡5 6
.
¡¡6 7
Err
¡¡7 :
(
¡¡: ;
LogoutFailure
¬¬ 
.
¬¬ 
UnexpectedError
¬¬ -
(
¬¬- .
$str
¬¬. U
)
¬¬U V
)
¬¬V W
}
√√ 	
;
√√	 

}
ƒƒ 
private
∆∆ 
async
∆∆ 
Task
∆∆ ,
CompleteLogoutWithCleanupAsync
∆∆ 5
(
∆∆5 6
string
∆∆6 <
membershipId
∆∆= I
,
∆∆I J
LogoutReason
∆∆K W
reason
∆∆X ^
,
∆∆^ _
uint
∆∆` d
	connectId
∆∆e n
,
∆∆n o
bool
«« 
keepPendingLogout
«« 
,
«« 
CancellationToken
««  1
cancellationToken
««2 C
)
««C D
{
»» 
Result
…… 
<
…… 
Unit
…… 
,
…… 
	Exception
…… 
>
…… 
cleanupResult
……  -
=
……. /
await
   !
stateCleanupService
   %
.
  % &1
#CleanupMembershipStateWithKeysAsync
  & I
(
  I J
membershipId
  J V
,
  V W
	connectId
  X a
)
  a b
.
ÀÀ 
ConfigureAwait
ÀÀ 
(
ÀÀ  
false
ÀÀ  %
)
ÀÀ% &
;
ÀÀ& '
if
ÃÃ 

(
ÃÃ 
cleanupResult
ÃÃ 
.
ÃÃ 
IsErr
ÃÃ 
)
ÃÃ  
{
ÕÕ 	
Log
ŒŒ 
.
ŒŒ 
Warning
ŒŒ 
(
ŒŒ 
$str
ŒŒ w
,
ŒŒw x
membershipId
œœ 
,
œœ 
cleanupResult
œœ +
.
œœ+ ,
	UnwrapErr
œœ, 5
(
œœ5 6
)
œœ6 7
.
œœ7 8
Message
œœ8 ?
)
œœ? @
;
œœ@ A
}
–– 	 
LogoutProofHandler
““ 
.
““ "
ClearRevocationProof
““ /
(
““/ 0.
 applicationSecureStorageProvider
““0 P
,
““P Q
membershipId
““R ^
)
““^ _
;
““_ `
if
‘‘ 

(
‘‘ 
!
‘‘ 
keepPendingLogout
‘‘ 
)
‘‘ 
{
’’ 	*
_pendingLogoutRequestStorage
÷÷ (
.
÷÷( ) 
ClearPendingLogout
÷÷) ;
(
÷÷; <
)
÷÷< =
;
÷÷= >
}
◊◊ 	
await
ŸŸ !
FinalizeLogoutAsync
ŸŸ !
(
ŸŸ! "
membershipId
ŸŸ" .
,
ŸŸ. /
reason
ŸŸ0 6
,
ŸŸ6 7
keepPendingLogout
ŸŸ8 I
,
ŸŸI J
cancellationToken
ŸŸK \
)
ŸŸ\ ]
.
ŸŸ] ^
ConfigureAwait
ŸŸ^ l
(
ŸŸl m
false
ŸŸm r
)
ŸŸr s
;
ŸŸs t
}
⁄⁄ 
}€€ ¶$
ì/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Membership/Constants/SecureKeyValidatorConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !

Membership! +
.+ ,
	Constants, 5
;5 6
public 
static 
class '
SecureKeyValidatorConstants /
{ 
public 

static 
class 
LocalizationKeys (
{		 
public

 
const

 
string

 
NON_ENGLISH_LETTERS

 /
=

0 1
$str

2 b
;

b c
public 
const 
string 
REQUIRED $
=% &
$str' L
;L M
public 
const 
string 

MIN_LENGTH &
=' (
$str) P
;P Q
public 
const 
string 
NO_UPPERCASE (
=) *
$str+ T
;T U
public 
const 
string 
NO_LOWERCASE (
=) *
$str+ T
;T U
public 
const 
string 
NO_SPECIAL_CHAR +
=, -
$str. Z
;Z [
public 
const 
string 
NO_DIGIT $
=% &
$str' L
;L M
public 
const 
string 

MAX_LENGTH &
=' (
$str) P
;P Q
public 
const 
string 
	NO_SPACES %
=& '
$str( N
;N O
public 
const 
string 

TOO_SIMPLE &
=' (
$str) P
;P Q
public 
const 
string 

TOO_COMMON &
=' (
$str) P
;P Q
public 
const 
string 
SEQUENTIAL_PATTERN .
=/ 0
$str1 `
;` a
public 
const 
string 
REPEATED_CHARS *
=+ ,
$str- X
;X Y
public 
const 
string 
LACKS_DIVERSITY +
=, -
$str. Z
;Z [
public 
const 
string 
CONTAINS_APP_NAME -
=. /
$str0 ^
;^ _
} 
public 

static 
class 
ValidationRules '
{ 
public 
const 
int 

MIN_LENGTH #
=$ %
$num& '
;' (
public 
const 
int 

MAX_LENGTH #
=$ %
$num& (
;( )
public 
const 
int 
MIN_CHAR_CLASSES )
=* +
$num, -
;- .
public   
const   
double   "
MIN_TOTAL_ENTROPY_BITS   2
=  3 4
$num  5 7
;  7 8
}!! 
public## 

static## 
readonly## 
	FrozenSet## $
<##$ %
string##% +
>##+ ,
KeyboardRows##- 9
=##: ;
	FrozenSet##< E
.##E F
ToFrozenSet##F Q
(##Q R
[$$ 
$str%% 
,%% 
$str&& 
,&& 
$str'' 
,'' 
$str(( 
])) 
))) 
;)) 
public++ 

static++ 
readonly++ 
	FrozenSet++ $
<++$ %
string++% +
>+++ ,
AppNameVariants++- <
=++= >
	FrozenSet++? H
.++H I
ToFrozenSet++I T
(++T U
[,, 
$str-- 
,-- 
$str.. 
,.. 
$str// 
]00 
)00 
;00 
public22 

static22 
readonly22 
	FrozenSet22 $
<22$ %
string22% +
>22+ ,"
CommonlyUsedSecureKeys22- C
=22D E
	FrozenSet22F O
.22O P
ToFrozenSet22P [
(22[ \
[33 
$str44 
,44 
$str55 
,55 
$str66 
,66 
$str77 
,77 
$str88 
]99 
,99 
StringComparer99 
.99 
OrdinalIgnoreCase99 '
)99' (
;99( )
}:: ÉZ
é/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/External/IpGeolocation/IpGeolocationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
External! )
.) *
IpGeolocation* 7
;7 8
internal 
sealed	 
class  
IpGeolocationService *
(* +

HttpClient+ 5
http6 :
): ;
:< =!
IIpGeolocationService> S
{ 
private 
const 
string 
BASE_URL !
=" #
$str$ <
;< =
public 

async 
Task 
< 
Result 
< 
	IpCountry &
,& '%
InternalServiceApiFailure( A
>A B
>B C
GetIpCountryAsyncD U
(U V
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
{ 
using 
HttpRequestMessage  
req! $
=% &
new' *
(* +

HttpMethod+ 5
.5 6
Get6 9
,9 :
BASE_URL; C
)C D
;D E
req 
. 
Headers 
. 
Accept 
. 
Add 
( 
new "+
MediaTypeWithQualityHeaderValue# B
(B C
$strC U
)U V
)V W
;W X
try 
{ 	
using 
HttpResponseMessage %
res& )
=* +
await, 1
http2 6
.6 7
	SendAsync7 @
(@ A
reqA D
,D E 
HttpCompletionOptionF Z
.Z [
ResponseHeadersRead[ n
,n o
cancellationToken	p Å
)
Å Ç
.
Ç É
ConfigureAwait
É ë
(
ë í
false
í ó
)
ó ò
;
ò ô
if 
( 
! 
res 
. 
IsSuccessStatusCode (
)( )
{ 
string 
error 
= 
await $!
SafeReadAsStringAsync% :
(: ;
res; >
.> ?
Content? F
,F G
cancellationTokenH Y
)Y Z
.Z [
ConfigureAwait[ i
(i j
falsej o
)o p
;p q
return   
Result   
<   
	IpCountry   '
,  ' (%
InternalServiceApiFailure  ) B
>  B C
.  C D
Err  D G
(  G H%
InternalServiceApiFailure!! -
.!!- .
ApiRequestFailed!!. >
(!!> ?
$""" 
$str"" .
{"". /
(""/ 0
int""0 3
)""3 4
res""4 7
.""7 8

StatusCode""8 B
}""B C
$str""C D
{""D E
res""E H
.""H I
ReasonPhrase""I U
}""U V
$str""V X
{""X Y
Trim""Y ]
(""] ^
error""^ c
,""c d
$num""e i
)""i j
}""j k
"""k l
)""l m
)""m n
;""n o
}## 
await%% 
using%% 
Stream%% 
stream%% %
=%%& '
await%%( -
res%%. 1
.%%1 2
Content%%2 9
.%%9 :
ReadAsStreamAsync%%: K
(%%K L
cancellationToken%%L ]
)%%] ^
.%%^ _
ConfigureAwait%%_ m
(%%m n
false%%n s
)%%s t
;%%t u
using&& 
JsonDocument&& 
doc&& "
=&&# $
await&&% *
JsonDocument&&+ 7
.&&7 8

ParseAsync&&8 B
(&&B C
stream&&C I
,&&I J
cancellationToken&&K \
:&&\ ]
cancellationToken&&^ o
)&&o p
.&&p q
ConfigureAwait&&q 
(	&& Ä
false
&&Ä Ö
)
&&Ö Ü
;
&&Ü á
JsonElement'' 
root'' 
='' 
doc'' "
.''" #
RootElement''# .
;''. /
string)) 
ipParsed)) 
=)) $
TryGetAnyCaseInsensitive)) 6
())6 7
root))7 ;
,)); <
$str))= A
,))A B
$str))C N
,))N O
$str))P W
)))W X
??))Y [
$str))\ e
;))e f
string** 
?** 
country** 
=** $
TryGetAnyCaseInsensitive++ (
(++( )
root++) -
,++- .
$str++/ 8
,++8 9
$str++: H
,++H I
$str++J W
)++W X
??++Y [$
TryGetAnyCaseInsensitive,, (
(,,( )
root,,) -
,,,- .
$str,,/ <
,,,< =
$str,,> L
),,L M
;,,M N
if.. 
(.. 
string.. 
... 
IsNullOrWhiteSpace.. )
(..) *
country..* 1
)..1 2
)..2 3
{// 
return00 
Result00 
<00 
	IpCountry00 '
,00' (%
InternalServiceApiFailure00) B
>00B C
.00C D
Err00D G
(00G H%
InternalServiceApiFailure11 -
.11- .
ApiRequestFailed11. >
(11> ?
$str11? ]
)11] ^
)11^ _
;11_ `
}22 
return44 
Result44 
<44 
	IpCountry44 #
,44# $%
InternalServiceApiFailure44% >
>44> ?
.44? @
Ok44@ B
(44B C
new44C F
	IpCountry44G P
(44P Q
ipParsed44Q Y
,44Y Z
country44[ b
)44b c
)44c d
;44d e
}55 	
catch66 
(66 !
TaskCanceledException66 $
)66$ %
when66& *
(66+ ,
!66, -
cancellationToken66- >
.66> ?#
IsCancellationRequested66? V
)66V W
{77 	
return88 
Result88 
<88 
	IpCountry88 #
,88# $%
InternalServiceApiFailure88% >
>88> ?
.88? @
Err88@ C
(88C D%
InternalServiceApiFailure99 )
.99) *
ApiRequestFailed99* :
(99: ;
$str99; W
)99W X
)99X Y
;99Y Z
}:: 	
catch;; 
(;; &
OperationCanceledException;; )
);;) *
when;;+ /
(;;0 1
cancellationToken;;1 B
.;;B C#
IsCancellationRequested;;C Z
);;Z [
{<< 	
return== 
Result== 
<== 
	IpCountry== #
,==# $%
InternalServiceApiFailure==% >
>==> ?
.==? @
Err==@ C
(==C D%
InternalServiceApiFailure>> )
.>>) *
ApiRequestFailed>>* :
(>>: ;
$str>>; `
)>>` a
)>>a b
;>>b c
}?? 	
catch@@ 
(@@  
HttpRequestException@@ #
ex@@$ &
)@@& '
{AA 	
returnBB 
ResultBB 
<BB 
	IpCountryBB #
,BB# $%
InternalServiceApiFailureBB% >
>BB> ?
.BB? @
ErrBB@ C
(BBC D%
InternalServiceApiFailureCC )
.CC) *
ApiRequestFailedCC* :
(CC: ;
$strCC; [
,CC[ \
exCC] _
)CC_ `
)CC` a
;CCa b
}DD 	
catchEE 
(EE 
JsonExceptionEE 
exEE 
)EE  
{FF 	
returnGG 
ResultGG 
<GG 
	IpCountryGG #
,GG# $%
InternalServiceApiFailureGG% >
>GG> ?
.GG? @
ErrGG@ C
(GGC D%
InternalServiceApiFailureHH )
.HH) *
ApiRequestFailedHH* :
(HH: ;
$strHH; W
,HHW X
exHHY [
)HH[ \
)HH\ ]
;HH] ^
}II 	
}JJ 
privateLL 
staticLL 
stringLL 
?LL $
TryGetAnyCaseInsensitiveLL 3
(LL3 4
JsonElementLL4 ?
rootLL@ D
,LLD E
paramsLLF L
stringLLM S
[LLS T
]LLT U
namesLLV [
)LL[ \
{MM 
foreachNN 
(NN 
stringNN 
nNN 
inNN 
namesNN "
)NN" #
{OO 	
ifPP 
(PP 
rootPP 
.PP 
TryGetPropertyPP #
(PP# $
nPP$ %
,PP% &
outPP' *
JsonElementPP+ 6
elPP7 9
)PP9 :
&&PP; =
elPP> @
.PP@ A
	ValueKindPPA J
==PPK M
JsonValueKindPPN [
.PP[ \
StringPP\ b
)PPb c
{QQ 
returnRR 
elRR 
.RR 
	GetStringRR #
(RR# $
)RR$ %
;RR% &
}SS 
}TT 	
returnVV 
(VV 
fromVV 
pVV 
inVV 
rootVV 
.VV 
EnumerateObjectVV .
(VV. /
)VV/ 0
fromWW 
nWW 
inWW 
namesWW 
whereXX 
pXX 
.XX 
NameXX 
.XX 
EqualsXX #
(XX# $
nXX$ %
,XX% &
StringComparisonXX' 7
.XX7 8
OrdinalIgnoreCaseXX8 I
)XXI J
&&XXK M
pXXN O
.XXO P
ValueXXP U
.XXU V
	ValueKindXXV _
==XX` b
JsonValueKindXXc p
.XXp q
StringXXq w
selectYY 
pYY 
.YY 
ValueYY 
.YY 
	GetStringYY (
(YY( )
)YY) *
)YY* +
.YY+ ,
FirstOrDefaultYY, :
(YY: ;
)YY; <
;YY< =
}ZZ 
private\\ 
static\\ 
async\\ 
Task\\ 
<\\ 
string\\ $
>\\$ %!
SafeReadAsStringAsync\\& ;
(\\; <
HttpContent\\< G
content\\H O
,\\O P
CancellationToken\\Q b
cancellationToken\\c t
)\\t u
{]] 
try^^ 
{__ 	
return`` 
await`` 
content``  
.``  !
ReadAsStringAsync``! 2
(``2 3
cancellationToken``3 D
)``D E
.``E F
ConfigureAwait``F T
(``T U
false``U Z
)``Z [
;``[ \
}aa 	
catchbb 
{cc 	
returndd 
stringdd 
.dd 
Emptydd 
;dd  
}ee 	
}ff 
privatehh 
statichh 
stringhh 
Trimhh 
(hh 
stringhh %
shh& '
,hh' (
inthh) ,
maxhh- 0
)hh0 1
=>hh2 4
stringii 
.ii 
IsNullOrEmptyii 
(ii 
sii 
)ii 
||ii  "
sii# $
.ii$ %
Lengthii% +
<=ii, .
maxii/ 2
?ii3 4
sii5 6
:ii7 8
sii9 :
[ii: ;
..ii; =
maxii= @
]ii@ A
+iiB C
$striiD G
;iiG H
}jj ¢
É/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/External/IpGeolocation/IpCountry.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
External! )
.) *
IpGeolocation* 7
;7 8
public 
record 
	IpCountry 
( 
string 
	IpAddress (
,( )
string* 0
Country1 8
)8 9
;9 :ê
ñ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Membership/Constants/MobileNumberValidatorConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !

Membership! +
.+ ,
	Constants, 5
;5 6
public 
static 
class *
MobileNumberValidatorConstants 2
{ 
public 

static 
class 
LocalizationKeys (
{ 
public 
const 
string 
CANNOT_BE_EMPTY +
=, -
$str. ]
;] ^
public 
const 
string (
MUST_START_WITH_COUNTRY_CODE 8
=9 :
$str; w
;w x
public		 
const		 
string		 
CONTAINS_NON_DIGITS		 /
=		0 1
$str		2 e
;		e f
public

 
const

 
string

 
INCORRECT_LENGTH

 ,
=

- .
$str

/ _
;

_ `
} 
public 

static 
class 
ValidationRules '
{ 
public 
const 
string 
COUNTRY_CODE_PREFIX /
=0 1
$str2 5
;5 6
public 
const 
int 

MIN_DIGITS #
=$ %
$num& '
;' (
public 
const 
int 

MAX_DIGITS #
=$ %
$num& (
;( )
} 
} ≥6
{/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/StateCleanupService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
;% &
internal 
sealed	 
class 
StateCleanupService )
() *
IIdentityService 
identityService $
,$ %-
!IApplicationSecureStorageProvider %,
 applicationSecureStorageProvider& F
,F G'
ISecureProtocolStateStorage &
secureProtocolStateStorage  :
,: ;
NetworkProvider 
networkProvider #
)# $
:% & 
IStateCleanupService' ;
{ 
public 

async 
Task 
< 
Result 
< 
Unit !
,! "
	Exception# ,
>, -
>- .'
CleanupMembershipStateAsync/ J
(J K
stringK Q
membershipIdR ^
,^ _
uint` d
	connectIde n
)n o
{ 
try 
{ 	
Result 
< 
Unit 
,  
SecureStorageFailure -
>- .
deleteResult/ ;
=< =
await> C&
secureProtocolStateStorageD ^
.^ _
DeleteStateAsync_ o
(o p
	connectIdp y
.y z
ToString	z Ç
(
Ç É
)
É Ñ
)
Ñ Ö
.
Ö Ü
ConfigureAwait
Ü î
(
î ï
false
ï ö
)
ö õ
;
õ ú
if 
( 
deleteResult 
. 
IsErr "
)" #
{ 
Log 
. 
Warning 
( 
$str	 Ñ
,
Ñ Ö
	connectId 
, 
deleteResult +
.+ ,
	UnwrapErr, 5
(5 6
)6 7
.7 8
Message8 ?
)? @
;@ A
} 
await   ,
 applicationSecureStorageProvider   2
.  2 3)
SetApplicationMembershipAsync  3 P
(  P Q
null  Q U
)  U V
.  V W
ConfigureAwait  W e
(  e f
false  f k
)  k l
;  l m
networkProvider"" 
."" 
ClearConnection"" +
(""+ ,
	connectId"", 5
)""5 6
;""6 7
return$$ 
Result$$ 
<$$ 
Unit$$ 
,$$ 
	Exception$$  )
>$$) *
.$$* +
Ok$$+ -
($$- .
Unit$$. 2
.$$2 3
Value$$3 8
)$$8 9
;$$9 :
}%% 	
catch&& 
(&& 
	Exception&& 
ex&& 
)&& 
{'' 	
Log(( 
.(( 
Error(( 
((( 
ex(( 
,(( 
$str(( [
,(([ \
membershipId((] i
)((i j
;((j k
return)) 
Result)) 
<)) 
Unit)) 
,)) 
	Exception))  )
>))) *
.))* +
Err))+ .
()). /
ex))/ 1
)))1 2
;))2 3
}** 	
}++ 
public-- 

async-- 
Task-- 
<-- 
Result-- 
<-- 
Unit-- !
,--! "
	Exception--# ,
>--, -
>--- ./
#CleanupMembershipStateWithKeysAsync--/ R
(--R S
string--S Y
membershipId--Z f
,--f g
uint--h l
	connectId--m v
)--v w
{.. 
try// 
{00 	
Result11 
<11 
Unit11 
,11  
SecureStorageFailure11 -
>11- .
deleteResult11/ ;
=11< =
await11> C&
secureProtocolStateStorage11D ^
.11^ _
DeleteStateAsync11_ o
(11o p
	connectId11p y
.11y z
ToString	11z Ç
(
11Ç É
)
11É Ñ
)
11Ñ Ö
.
11Ö Ü
ConfigureAwait
11Ü î
(
11î ï
false
11ï ö
)
11ö õ
;
11õ ú
if33 
(33 
deleteResult33 
.33 
IsErr33 "
)33" #
{44 
Log55 
.55 
Warning55 
(55 
$str	55 â
,
55â ä
	connectId66 
,66 
deleteResult66 +
.66+ ,
	UnwrapErr66, 5
(665 6
)666 7
.667 8
Message668 ?
)66? @
;66@ A
}77 
Result99 
<99 
Unit99 
,99 
Ecliptix99 !
.99! "
	Utilities99" +
.99+ ,
Failures99, 4
.994 5
Authentication995 C
.99C D!
AuthenticationFailure99D Y
>99Y Z
clearResult99[ f
=99g h
await:: 
identityService:: %
.::% &
ClearAllCacheAsync::& 8
(::8 9
membershipId::9 E
)::E F
.::F G
ConfigureAwait::G U
(::U V
false::V [
)::[ \
;::\ ]
if<< 
(<< 
clearResult<< 
.<< 
IsErr<< !
)<<! "
{== 
Log>> 
.>> 
Warning>> 
(>> 
$str>> W
,>>W X
clearResult?? 
.??  
	UnwrapErr??  )
(??) *
)??* +
.??+ ,
Message??, 3
)??3 4
;??4 5
}@@ 
awaitBB ,
 applicationSecureStorageProviderBB 2
.BB2 3)
SetApplicationMembershipAsyncBB3 P
(BBP Q
nullBBQ U
)BBU V
.BBV W
ConfigureAwaitBBW e
(BBe f
falseBBf k
)BBk l
;BBl m
networkProviderDD 
.DD 
ClearConnectionDD +
(DD+ ,
	connectIdDD, 5
)DD5 6
;DD6 7
returnFF 
ResultFF 
<FF 
UnitFF 
,FF 
	ExceptionFF  )
>FF) *
.FF* +
OkFF+ -
(FF- .
UnitFF. 2
.FF2 3
ValueFF3 8
)FF8 9
;FF9 :
}GG 	
catchHH 
(HH 
	ExceptionHH 
exHH 
)HH 
{II 	
LogJJ 
.JJ 
ErrorJJ 
(JJ 
exJJ 
,JJ 
$strJJ e
,JJe f
membershipIdJJg s
)JJs t
;JJt u
returnKK 
ResultKK 
<KK 
UnitKK 
,KK 
	ExceptionKK  )
>KK) *
.KK* +
ErrKK+ .
(KK. /
exKK/ 1
)KK1 2
;KK2 3
}LL 	
}MM 
}NN ÍY
à/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/Localization/LocalizationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
.% &
Localization& 2
;2 3
internal 
sealed	 
class 
LocalizationService )
:* + 
ILocalizationService, @
{ 
private 
readonly 
FrozenDictionary %
<% &
string& ,
,, -
string. 4
>4 5#
_defaultLanguageStrings6 M
;M N
private 
readonly 
Lock 
_cultureChangeLock ,
=- .
new/ 2
(2 3
)3 4
;4 5
private 
FrozenDictionary 
< 
string #
,# $
string% +
>+ ,#
_currentLanguageStrings- D
;D E
private 
CultureInfo 
_currentCultureInfo +
;+ ,
public 

event 
Action 
? 
LanguageChanged (
;( )
public 

event '
PropertyChangedEventHandler ,
?, -
PropertyChanged. =
=> ?
delegate@ H
{I J
}K L
;L M
public 

CultureInfo 
CurrentCultureInfo )
=>* ,
_currentCultureInfo- @
;@ A
public 

string 
CurrentCultureName $
=>% '
_currentCultureInfo( ;
.; <
Name< @
;@ A
public 

string 
this 
[ 
string 
key !
]! "
{ 
get 
{ 	
if   
(   
string   
.   
IsNullOrWhiteSpace   )
(  ) *
key  * -
)  - .
)  . /
{!! 
return"" 
$str"" &
;""& '
}## 
if%% 
(%% #
_currentLanguageStrings%% '
.%%' (
TryGetValue%%( 3
(%%3 4
key%%4 7
,%%7 8
out%%9 <
string%%= C
?%%C D
value%%E J
)%%J K
)%%K L
{&& 
return'' 
value'' 
;'' 
}(( 
return** #
_defaultLanguageStrings** *
.*** +
TryGetValue**+ 6
(**6 7
key**7 :
,**: ;
out**< ?
string**@ F
?**F G
defaultValue**H T
)**T U
?**V W
defaultValue**X d
:**e f
$"**g i
$str**i j
{**j k
key**k n
}**n o
$str**o p
"**p q
;**q r
}++ 	
},, 
public.. 

LocalizationService.. 
(.. !
DefaultSystemSettings.. 4!
defaultSystemSettings..5 J
)..J K
{// 
string00 
?00 
defaultCultureName00 "
=00# $!
defaultSystemSettings00% :
.00: ;
CULTURE00; B
;00B C
_currentCultureInfo22 
=22 
CreateCultureInfo22 /
(22/ 0
defaultCultureName220 B
)22B C
;22C D#
_defaultLanguageStrings33 
=33  !
LocalizationData33" 2
.332 3
EnglishStrings333 A
;33A B#
_currentLanguageStrings55 
=55  !
GetLanguageStrings55" 4
(554 5
defaultCultureName555 G
.55G H
ToOption55H P
(55P Q
)55Q R
)55R S
.66 
ValueOr66 
(66 #
_defaultLanguageStrings66 ,
)66, -
;66- .
}77 
public99 

string99 
	GetString99 
(99 
string99 "
key99# &
,99& '
params99( .
object99/ 5
[995 6
]996 7
args998 <
)99< =
{:: 
string;; 
formatString;; 
=;; 
this;; "
[;;" #
key;;# &
];;& '
;;;' (
if== 

(== 
formatString== 
.== 

StartsWith== #
(==# $
$char==$ '
)==' (
&&==) +
formatString==, 8
.==8 9
EndsWith==9 A
(==A B
$char==B E
)==E F
||==G I
args==J N
.==N O
Length==O U
====V X
$num==Y Z
)==Z [
{>> 	
return?? 
formatString?? 
;??  
}@@ 	
tryBB 
{CC 	
returnDD 
stringDD 
.DD 
FormatDD  
(DD  !
_currentCultureInfoDD! 4
,DD4 5
formatStringDD6 B
,DDB C
argsDDD H
)DDH I
;DDI J
}EE 	
catchFF 
(FF 
FormatExceptionFF 
)FF 
{GG 	
returnHH 
formatStringHH 
;HH  
}II 	
}JJ 
publicLL 

voidLL 

SetCultureLL 
(LL 
stringLL !
?LL! "
cultureNameLL# .
,LL. /
ActionLL0 6
?LL6 7
onCultureChangedLL8 H
=LLI J
nullLLK O
)LLO P
{MM 
CultureInfoNN 
newCultureInfoNN "
=NN# $
CreateCultureInfoNN% 6
(NN6 7
cultureNameNN7 B
)NNB C
;NNC D
lockPP 
(PP 
_cultureChangeLockPP  
)PP  !
{QQ 	
ifRR 
(RR 
_currentCultureInfoRR #
.RR# $
NameRR$ (
.RR( )
EqualsRR) /
(RR/ 0
newCultureInfoRR0 >
.RR> ?
NameRR? C
,RRC D
StringComparisonRRE U
.RRU V
OrdinalIgnoreCaseRRV g
)RRg h
)RRh i
{SS 
returnTT 
;TT 
}UU 
_currentCultureInfoWW 
=WW  !
newCultureInfoWW" 0
;WW0 1#
_currentLanguageStringsXX #
=XX$ %
GetLanguageStringsXX& 8
(XX8 9
cultureNameXX9 D
.XXD E
ToOptionXXE M
(XXM N
)XXN O
)XXO P
.YY 
ValueOrYY 
(YY #
_defaultLanguageStringsYY 0
)YY0 1
;YY1 2
}ZZ 	
if\\ 

(\\ 
onCultureChanged\\ 
is\\ 
not\\  #
null\\$ (
)\\( )
{]] 	
OnLanguageChanged^^ 
(^^ 
)^^ 
;^^  &
NotifyAllPropertiesChanged__ &
(__& '
)__' (
;__( )
onCultureChanged`` 
.`` 
Invoke`` #
(``# $
)``$ %
;``% &
}aa 	
}bb 
privatedd 
staticdd 
CultureInfodd 
CreateCultureInfodd 0
(dd0 1
stringdd1 7
?dd7 8
cultureNamedd9 D
)ddD E
{ee 
tryff 
{gg 	
returnhh 
CultureInfohh 
.hh 
GetCultureInfohh -
(hh- .
cultureNamehh. 9
??hh: <
$strhh= D
)hhD E
;hhE F
}ii 	
catchjj 
(jj $
CultureNotFoundExceptionjj '
)jj' (
{kk 	
returnll 
CultureInfoll 
.ll 
GetCultureInfoll -
(ll- .
$strll. 5
)ll5 6
;ll6 7
}mm 	
}nn 
privatepp 
staticpp 
Optionpp 
<pp 
FrozenDictionarypp *
<pp* +
stringpp+ 1
,pp1 2
stringpp3 9
>pp9 :
>pp: ;
GetLanguageStringspp< N
(ppN O
OptionppO U
<ppU V
stringppV \
>pp\ ]
cultureNamepp^ i
)ppi j
{qq 
returnrr 
cultureNamerr 
.ss 
Wheress 
(ss 
namess 
=>ss 
!ss 
stringss "
.ss" #
IsNullOrEmptyss# 0
(ss0 1
namess1 5
)ss5 6
)ss6 7
.tt 
Bindtt 
(tt 
namett 
=>tt 
LocalizationDatatt *
.tt* +
AllLanguagestt+ 7
.tt7 8
GetValueOrDefaulttt8 I
(ttI J
namettJ N
)ttN O
.ttO P
ToOptionttP X
(ttX Y
)ttY Z
)ttZ [
;tt[ \
}uu 
privateww 
voidww 
OnLanguageChangedww "
(ww" #
)ww# $
{xx 
ifyy 

(yy 

Dispatcheryy 
.yy 
UIThreadyy 
.yy  
CheckAccessyy  +
(yy+ ,
)yy, -
)yy- .
{zz 	
LanguageChanged{{ 
?{{ 
.{{ 
Invoke{{ #
({{# $
){{$ %
;{{% &
}|| 	
else}} 
{~~ 	

Dispatcher 
. 
UIThread 
.  
Post  $
($ %
(% &
)& '
=>( *
LanguageChanged+ :
?: ;
.; <
Invoke< B
(B C
)C D
)D E
;E F
}
ÄÄ 	
}
ÅÅ 
private
ÉÉ 
void
ÉÉ (
NotifyAllPropertiesChanged
ÉÉ +
(
ÉÉ+ ,
)
ÉÉ, -
{
ÑÑ 
if
ÖÖ 

(
ÖÖ 

Dispatcher
ÖÖ 
.
ÖÖ 
UIThread
ÖÖ 
.
ÖÖ  
CheckAccess
ÖÖ  +
(
ÖÖ+ ,
)
ÖÖ, -
)
ÖÖ- .
{
ÜÜ 	
PropertyChanged
áá 
?
áá 
.
áá 
Invoke
áá #
(
áá# $
this
áá$ (
,
áá( )
new
áá* -&
PropertyChangedEventArgs
áá. F
(
ááF G
$str
ááG M
)
ááM N
)
ááN O
;
ááO P
PropertyChanged
àà 
?
àà 
.
àà 
Invoke
àà #
(
àà# $
this
àà$ (
,
àà( )
new
àà* -&
PropertyChangedEventArgs
àà. F
(
ààF G
$str
ààG O
)
ààO P
)
ààP Q
;
ààQ R
}
ââ 	
else
ää 
{
ãã 	

Dispatcher
åå 
.
åå 
UIThread
åå 
.
åå  
Post
åå  $
(
åå$ %
(
åå% &
)
åå& '
=>
åå( *
{
çç 
PropertyChanged
éé 
?
éé  
.
éé  !
Invoke
éé! '
(
éé' (
this
éé( ,
,
éé, -
new
éé. 1&
PropertyChangedEventArgs
éé2 J
(
ééJ K
$str
ééK Q
)
ééQ R
)
ééR S
;
ééS T
PropertyChanged
èè 
?
èè  
.
èè  !
Invoke
èè! '
(
èè' (
this
èè( ,
,
èè, -
new
èè. 1&
PropertyChangedEventArgs
èè2 J
(
èèJ K
$str
èèK S
)
èèS T
)
èèT U
;
èèU V
}
êê 
)
êê 
;
êê 
}
ëë 	
}
íí 
}ìì  µ
Ö/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/Localization/LocalizationData.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
.% &
Localization& 2
;2 3
public 
static 
class 
LocalizationData $
{ 
public		 

static		 
readonly		 
FrozenDictionary		 +
<		+ ,
string		, 2
,		2 3
string		4 :
>		: ;
EnglishStrings		< J
=		K L
new		M P

Dictionary		Q [
<		[ \
string		\ b
,		b c
string		d j
>		j k
{

 
[ 	
ErrorI18nKeys	 
. 

VALIDATION !
]! "
=# $
$str% a
,a b
[ 	
ErrorI18nKeys	 
. 
MAX_ATTEMPTS #
]# $
=% &
$str' b
,b c
[ 	
ErrorI18nKeys	 
. 
INVALID_MOBILE %
]% &
=' (
$str) H
,H I
[ 	
ErrorI18nKeys	 
. 
OTP_EXPIRED "
]" #
=$ %
$str& U
,U V
[ 	
ErrorI18nKeys	 
. 
	NOT_FOUND  
]  !
=" #
$str$ C
,C D
[ 	
ErrorI18nKeys	 
. 
ALREADY_EXISTS %
]% &
=' (
$str) C
,C D
[ 	
ErrorI18nKeys	 
. 
UNAUTHENTICATED &
]& '
=( )
$str* Z
,Z [
[ 	
ErrorI18nKeys	 
. 
PERMISSION_DENIED (
]( )
=* +
$str, `
,` a
[ 	
ErrorI18nKeys	 
. 
PRECONDITION_FAILED *
]* +
=, -
$str. `
,` a
[ 	
ErrorI18nKeys	 
. 
CONFLICT 
]  
=! "
$str# `
,` a
[ 	
ErrorI18nKeys	 
. 
RESOURCE_EXHAUSTED )
]) *
=+ ,
$str- Y
,Y Z
[ 	
ErrorI18nKeys	 
. 
SERVICE_UNAVAILABLE *
]* +
=, -
$str. c
,c d
[ 	
ErrorI18nKeys	 
. "
DEPENDENCY_UNAVAILABLE -
]- .
=/ 0
$str1 d
,d e
[ 	
ErrorI18nKeys	 
. 
DEADLINE_EXCEEDED (
]( )
=* +
$str, R
,R S
[ 	
ErrorI18nKeys	 
. 
	CANCELLED  
]  !
=" #
$str$ <
,< =
[ 	
ErrorI18nKeys	 
. 
INTERNAL 
]  
=! "
$str# R
,R S
[ 	
ErrorI18nKeys	 
.  
DATABASE_UNAVAILABLE +
]+ ,
=- .
$str/ ]
,] ^
[ 	
$str	 1
]1 2
=3 4
$str5 X
,X Y
[ 	
$str	 <
]< =
=> ?
$str@ c
,c d
[   	
$str  	 /
]  / 0
=  1 2
$str  3 {
,  { |
[!! 	
$str!!	 6
]!!6 7
=!!8 9
$str	!!: Ö
,
!!Ö Ü
[$$ 	
$str$$	 #
]$$# $
=$$% &
$str$$' a
,$$a b
[%% 	
$str%%	 9
]%%9 :
=%%; <
$str%%= M
,%%M N
[&& 	
$str&&	 ?
]&&? @
=&&A B
$str&&C }
,&&} ~
['' 	
$str''	 8
]''8 9
='': ;
$str''< R
,''R S
[(( 	
$str((	 =
]((= >
=((? @
$str((A P
,((P Q
[)) 	
$str))	 :
])): ;
=))< =
$str))> H
,))H I
[,, 	
$str,,	 D
],,D E
=,,F G
$str,,H Z
,,,Z [
[-- 	
$str--	 J
]--J K
=--L M
$str	--N à
,
--à â
[.. 	
$str..	 C
]..C D
=..E F
$str..G ]
,..] ^
[// 	
$str//	 H
]//H I
=//J K
$str//L [
,//[ \
[00 	
$str00	 E
]00E F
=00G H
$str00I S
,00S T
[33 	
$str33	 <
]33< =
=33> ?
$str33@ T
,33T U
[44 	
$str44	 B
]44B C
=44D E
$str44F k
,44k l
[55 	
$str55	 ;
]55; <
=55= >
$str55? R
,55R S
[66 	
$str66	 H
]66H I
=66J K
$str66L m
,66m n
[77 	
$str77	 D
]77D E
=77F G
$str77H P
,77P Q
[88 	
$str88	 D
]88D E
=88F G
$str88H U
,88U V
[:: 	
$str::	 4
]::4 5
=::6 7
$str::8 K
,::K L
[;; 	
$str;;	 :
];;: ;
=;;< =
$str;;> d
,;;d e
[<< 	
$str<<	 3
]<<3 4
=<<5 6
$str<<7 F
,<<F G
[== 	
$str==	 8
]==8 9
===: ;
$str==< F
,==F G
[>> 	
$str>>	 5
]>>5 6
=>>7 8
$str>>9 B
,>>B C
[@@ 	
$str@@	 <
]@@< =
=@@> ?
$str@@@ P
,@@P Q
[AA 	
$strAA	 B
]AAB C
=AAD E
$strAAF u
,AAu v
[BB 	
$strBB	 M
]BBM N
=BBO P
$strBBQ ]
,BB] ^
[CC 	
$strCC	 F
]CCF G
=CCH I
$strCCJ i
,CCi j
[DD 	
$strDD	 T
]DDT U
=DDV W
$strDDX l
,DDl m
[EE 	
$strEE	 M
]EEM N
=EEO P
$strEEQ u
,EEu v
[FF 	
$strFF	 N
]FFN O
=FFP Q
$strFFR m
,FFm n
[GG 	
$strGG	 =
]GG= >
=GG? @
$strGGA Q
,GGQ R
[II 	
$strII	 7
]II7 8
=II9 :
$strII; M
,IIM N
[JJ 	
$strJJ	 =
]JJ= >
=JJ? @
$strJJA l
,JJl m
[KK 	
$strKK	 I
]KKI J
=KKK L
$strKKM ]
,KK] ^
[LL 	
$strLL	 B
]LLB C
=LLD E
$strLLF e
,LLe f
[MM 	
$strMM	 M
]MMM N
=MMO P
$strMMQ b
,MMb c
[NN 	
$strNN	 F
]NNF G
=NNH I
$strNNJ h
,NNh i
[OO 	
$strOO	 8
]OO8 9
=OO: ;
$strOO< N
,OON O
[QQ 	
$strQQ	 0
]QQ0 1
=QQ2 3
$strQQ4 =
,QQ= >
[RR 	
$strRR	 6
]RR6 7
=RR8 9
$strRR: `
,RR` a
[SS 	
$strSS	 /
]SS/ 0
=SS1 2
$strSS3 =
,SS= >
[TT 	
$strTT	 4
]TT4 5
=TT6 7
$strTT8 >
,TT> ?
[UU 	
$strUU	 1
]UU1 2
=UU3 4
$strUU5 B
,UUB C
[XX 	
$strXX	 &
]XX& '
=XX( )
$strXX* 3
,XX3 4
[YY 	
$strYY	 (
]YY( )
=YY* +
$strYY, v
,YYv w
[ZZ 	
$strZZ	 2
]ZZ2 3
=ZZ4 5
$strZZ6 E
,ZZE F
[[[ 	
$str[[	 +
][[+ ,
=[[- .
$str[[/ P
,[[P Q
[\\ 	
$str\\	 7
]\\7 8
=\\9 :
$str\\; G
,\\G H
[]] 	
$str]]	 0
]]]0 1
=]]2 3
$str]]4 P
,]]P Q
[^^ 	
$str^^	 0
]^^0 1
=^^2 3
$str^^4 A
,^^A B
[__ 	
$str__	 )
]__) *
=__+ ,
$str__- 7
,__7 8
[bb 	
$strbb	 ;
]bb; <
=bb= >
$str	bb? ≈
,
bb≈ ∆
[cc 	
$strcc	 ,
]cc, -
=cc. /
$strcc0 c
,ccc d
[dd 	
$strdd	 2
]dd2 3
=dd4 5
$strdd6 k
,ddk l
[ee 	
$stree	 &
]ee& '
=ee( )
$str	ee* Ñ
,
eeÑ Ö
[ff 	
$strff	 (
]ff( )
=ff* +
$str	ff, ç
,
ffç é
[gg 	
$strgg	 1
]gg1 2
=gg3 4
$str	gg5 Ü
,
ggÜ á
[hh 	
$strhh	 *
]hh* +
=hh, -
$strhh. p
,hhp q
[kk 	
$strkk	 ,
]kk, -
=kk. /
$strkk0 K
,kkK L
[ll 	
$strll	 $
]ll$ %
=ll& '
$strll( =
,ll= >
[mm 	
$strmm	 '
]mm' (
=mm) *
$strmm+ K
,mmK L
[nn 	
$strnn	 -
]nn- .
=nn/ 0
$strnn1 S
,nnS T
[oo 	
$stroo	 -
]oo- .
=oo/ 0
$stroo1 Q
,ooQ R
[qq 	
$strqq	 0
]qq0 1
=qq2 3
$strqq4 [
,qq[ \
[rr 	
$strrr	 0
]rr0 1
=rr2 3
$strrr4 I
,rrI J
[ss 	
$strss	 -
]ss- .
=ss/ 0
$strss1 Q
,ssQ R
[tt 	
$strtt	 5
]tt5 6
=tt7 8
$strtt9 d
,ttd e
[uu 	
$struu	 (
]uu( )
=uu* +
$struu, <
,uu< =
[vv 	
$strvv	 1
]vv1 2
=vv3 4
$strvv5 T
,vvT U
[yy 	
$stryy	 E
]yyE F
=yyG H
$stryyI \
,yy\ ]
[zz 	
$strzz	 <
]zz< =
=zz> ?
$strzz@ X
,zzX Y
[{{ 	
$str{{	 9
]{{9 :
={{; <
$str{{= V
,{{V W
[|| 	
$str||	 8
]||8 9
=||: ;
$str||< F
,||F G
[~~ 	
$str~~	 ?
]~~? @
=~~A B
$str	~~C ï
,
~~ï ñ
[ 	
$str	 A
]A B
=C D
$strE v
,v w
[
ÄÄ 	
$str
ÄÄ	 0
]
ÄÄ0 1
=
ÄÄ2 3
$str
ÄÄ4 `
,
ÄÄ` a
[
ÇÇ 	
$str
ÇÇ	 1
]
ÇÇ1 2
=
ÇÇ3 4
$str
ÇÇ5 P
,
ÇÇP Q
[
ÉÉ 	
$str
ÉÉ	 ;
]
ÉÉ; <
=
ÉÉ= >
$str
ÉÉ? e
,
ÉÉe f
[
ÑÑ 	
$str
ÑÑ	 5
]
ÑÑ5 6
=
ÑÑ7 8
$str
ÑÑ9 X
,
ÑÑX Y
[
ÖÖ 	
$str
ÖÖ	 6
]
ÖÖ6 7
=
ÖÖ8 9
$str
ÖÖ: Z
,
ÖÖZ [
[
ÜÜ 	
$str
ÜÜ	 9
]
ÜÜ9 :
=
ÜÜ; <
$str
ÜÜ= `
,
ÜÜ` a
[
ââ 	
$str
ââ	 .
]
ââ. /
=
ââ0 1
$str
ââ2 <
,
ââ< =
[
ää 	
$str
ää	 0
]
ää0 1
=
ää2 3
$str
ää4 H
,
ääH I
[
ãã 	
$str
ãã	 0
]
ãã0 1
=
ãã2 3
$str
ãã4 H
,
ããH I
[
åå 	
$str
åå	 /
]
åå/ 0
=
åå1 2
$str
åå3 F
,
ååF G
[
çç 	
$str
çç	 2
]
çç2 3
=
çç4 5
$str
çç6 T
,
ççT U
[
éé 	
$str
éé	 2
]
éé2 3
=
éé4 5
$str
éé6 S
,
ééS T
[
èè 	
$str
èè	 .
]
èè. /
=
èè0 1
$str
èè2 D
,
èèD E
[
êê 	
$str
êê	 0
]
êê0 1
=
êê2 3
$str
êê4 M
,
êêM N
[
ëë 	
$str
ëë	 0
]
ëë0 1
=
ëë2 3
$str
ëë4 @
,
ëë@ A
[
íí 	
$str
íí	 8
]
íí8 9
=
íí: ;
$str
íí< [
,
íí[ \
[
ìì 	
$str
ìì	 4
]
ìì4 5
=
ìì6 7
$str
ìì8 U
,
ììU V
[
îî 	
$str
îî	 5
]
îî5 6
=
îî7 8
$str
îî9 d
,
îîd e
[
ïï 	
$str
ïï	 7
]
ïï7 8
=
ïï9 :
$str
ïï; T
,
ïïT U
[
ññ 	
$str
ññ	 8
]
ññ8 9
=
ññ: ;
$str
ññ< Q
,
ññQ R
[
óó 	
$str
óó	 9
]
óó9 :
=
óó; <
$str
óó= Q
,
óóQ R
[
òò 	
$str
òò	 5
]
òò5 6
=
òò7 8
$str
òò9 W
,
òòW X
[
öö 	
$str
öö	 8
]
öö8 9
=
öö: ;
$str
öö< V
,
ööV W
[
úú 	
$str
úú	 5
]
úú5 6
=
úú7 8
$str
úú9 B
,
úúB C
[
ùù 	
$str
ùù	 6
]
ùù6 7
=
ùù8 9
$str
ùù: E
,
ùùE F
[
ûû 	
$str
ûû	 2
]
ûû2 3
=
ûû4 5
$str
ûû6 <
,
ûû< =
[
üü 	
$str
üü	 2
]
üü2 3
=
üü4 5
$str
üü6 <
,
üü< =
[
†† 	
$str
††	 4
]
††4 5
=
††6 7
$str
††8 @
,
††@ A
[
°° 	
$str
°°	 8
]
°°8 9
=
°°: ;
$str
°°< I
,
°°I J
[
££ 	
$str
££	 6
]
££6 7
=
££8 9
$str
££: N
,
££N O
[
§§ 	
$str
§§	 8
]
§§8 9
=
§§: ;
$str
§§< T
,
§§T U
[
•• 	
$str
••	 :
]
••: ;
=
••< =
$str
••> d
,
••d e
[
ßß 	
$str
ßß	 
]
ßß  
=
ßß! "
$str
ßß# ,
,
ßß, -
[
®® 	
$str
®®	 &
]
®®& '
=
®®( )
$str
®®* :
,
®®: ;
[
´´ 	
$str
´´	 
]
´´  
=
´´! "
$str
´´# 3
,
´´3 4
[
¨¨ 	
$str
¨¨	  
]
¨¨  !
=
¨¨" #
$str
¨¨$ 6
,
¨¨6 7
[
≠≠ 	
$str
≠≠	 
]
≠≠ 
=
≠≠ 
$str
≠≠ &
,
≠≠& '
[
ÆÆ 	
$str
ÆÆ	 
]
ÆÆ  
=
ÆÆ! "
$str
ÆÆ# ^
,
ÆÆ^ _
[
ØØ 	
$str
ØØ	 
]
ØØ 
=
ØØ 
$str
ØØ N
,
ØØN O
[
≤≤ 	
$str
≤≤	 
]
≤≤ 
=
≤≤ 
$str
≤≤ $
,
≤≤$ %
[
≥≥ 	
$str
≥≥	 
]
≥≥ 
=
≥≥ 
$str
≥≥ &
,
≥≥& '
[
¥¥ 	
$str
¥¥	 
]
¥¥ 
=
¥¥  !
$str
¥¥" ,
,
¥¥, -
[
µµ 	
$str
µµ	 
]
µµ 
=
µµ  !
$str
µµ" ,
,
µµ, -
[
∏∏ 	
$str
∏∏	 
]
∏∏ 
=
∏∏ 
$str
∏∏ )
,
∏∏) *
[
ππ 	
$str
ππ	 
]
ππ 
=
ππ 
$str
ππ "
,
ππ" #
[
∫∫ 	
$str
∫∫	 
]
∫∫ 
=
∫∫ 
$str
∫∫ &
,
∫∫& '
[
ªª 	
$str
ªª	 
]
ªª 
=
ªª 
$str
ªª $
,
ªª$ %
[
ºº 	
$str
ºº	 !
]
ºº! "
=
ºº# $
$str
ºº% C
,
ººC D
[
ΩΩ 	
$str
ΩΩ	 
]
ΩΩ 
=
ΩΩ 
$str
ΩΩ 
,
ΩΩ 
[
ææ 	
$str
ææ	 &
]
ææ& '
=
ææ( )
$str
ææ* B
,
ææB C
[
øø 	
$str
øø	 !
]
øø! "
=
øø# $
$str
øø% E
,
øøE F
[
¬¬ 	
$str
¬¬	 /
]
¬¬/ 0
=
¬¬1 2
$str
¬¬3 K
,
¬¬K L
[
√√ 	
$str
√√	 5
]
√√5 6
=
√√7 8
$str
√√9 ^
,
√√^ _
[
ƒƒ 	
$str
ƒƒ	 5
]
ƒƒ5 6
=
ƒƒ7 8
$str
ƒƒ9 N
,
ƒƒN O
[
≈≈ 	
$str
≈≈	 ;
]
≈≈; <
=
≈≈= >
$str
≈≈? `
,
≈≈` a
[
∆∆ 	
$str
∆∆	 5
]
∆∆5 6
=
∆∆7 8
$str
∆∆9 N
,
∆∆N O
[
«« 	
$str
««	 ;
]
««; <
=
««= >
$str
««? \
,
««\ ]
[
»» 	
$str
»»	 /
]
»»/ 0
=
»»1 2
$str
»»3 ?
,
»»? @
[
…… 	
$str
……	 5
]
……5 6
=
……7 8
$str
……9 \
,
……\ ]
[
   	
$str
  	 1
]
  1 2
=
  3 4
$str
  5 C
,
  C D
[
ÀÀ 	
$str
ÀÀ	 7
]
ÀÀ7 8
=
ÀÀ9 :
$str
ÀÀ; ^
,
ÀÀ^ _
[
ÃÃ 	
$str
ÃÃ	 8
]
ÃÃ8 9
=
ÃÃ: ;
$str
ÃÃ< P
,
ÃÃP Q
[
ÕÕ 	
$str
ÕÕ	 >
]
ÕÕ> ?
=
ÕÕ@ A
$str
ÕÕB b
,
ÕÕb c
[
ŒŒ 	
$str
ŒŒ	 7
]
ŒŒ7 8
=
ŒŒ9 :
$str
ŒŒ; O
,
ŒŒO P
[
œœ 	
$str
œœ	 =
]
œœ= >
=
œœ? @
$str
œœA Z
,
œœZ [
[
–– 	
$str
––	 5
]
––5 6
=
––7 8
$str
––9 L
,
––L M
[
—— 	
$str
——	 ;
]
——; <
=
——= >
$str
——? j
,
——j k
[
““ 	
$str
““	 6
]
““6 7
=
““8 9
$str
““: G
,
““G H
[
”” 	
$str
””	 <
]
””< =
=
””> ?
$str
””@ d
,
””d e
[
‘‘ 	
$str
‘‘	 +
]
‘‘+ ,
=
‘‘- .
$str
‘‘/ 6
,
‘‘6 7
[
◊◊ 	
$str
◊◊	 "
]
◊◊" #
=
◊◊$ %
$str
◊◊& ;
,
◊◊; <
[
ÿÿ 	
$str
ÿÿ	 #
]
ÿÿ# $
=
ÿÿ% &
$str
ÿÿ' 7
,
ÿÿ7 8
[
ŸŸ 	
$str
ŸŸ	 +
]
ŸŸ+ ,
=
ŸŸ- .
$str
ŸŸ/ @
,
ŸŸ@ A
[
⁄⁄ 	
$str
⁄⁄	 +
]
⁄⁄+ ,
=
⁄⁄- .
$str
⁄⁄/ 8
}
€€ 
.
€€  
ToFrozenDictionary
€€ 
(
€€ 
)
€€ 
;
€€ 
public
›› 

static
›› 
readonly
›› 
FrozenDictionary
›› +
<
››+ ,
string
››, 2
,
››2 3
string
››4 :
>
››: ;
UkrainianStrings
››< L
=
››M N
new
››O R

Dictionary
››S ]
<
››] ^
string
››^ d
,
››d e
string
››f l
>
››l m
{
ﬁﬁ 
[
ﬂﬂ 	
ErrorI18nKeys
ﬂﬂ	 
.
ﬂﬂ 

VALIDATION
ﬂﬂ !
]
ﬂﬂ! "
=
ﬂﬂ# $
$str
ﬂﬂ% `
,
ﬂﬂ` a
[
‡‡ 	
ErrorI18nKeys
‡‡	 
.
‡‡ 
MAX_ATTEMPTS
‡‡ #
]
‡‡# $
=
‡‡% &
$str
‡‡' v
,
‡‡v w
[
·· 	
ErrorI18nKeys
··	 
.
·· 
INVALID_MOBILE
·· %
]
··% &
=
··' (
$str
··) O
,
··O P
[
‚‚ 	
ErrorI18nKeys
‚‚	 
.
‚‚ 
OTP_EXPIRED
‚‚ "
]
‚‚" #
=
‚‚$ %
$str
‚‚& ]
,
‚‚] ^
[
„„ 	
ErrorI18nKeys
„„	 
.
„„ 
	NOT_FOUND
„„  
]
„„  !
=
„„" #
$str
„„$ C
,
„„C D
[
‰‰ 	
ErrorI18nKeys
‰‰	 
.
‰‰ 
ALREADY_EXISTS
‰‰ %
]
‰‰% &
=
‰‰' (
$str
‰‰) B
,
‰‰B C
[
ÂÂ 	
ErrorI18nKeys
ÂÂ	 
.
ÂÂ 
UNAUTHENTICATED
ÂÂ &
]
ÂÂ& '
=
ÂÂ( )
$str
ÂÂ* U
,
ÂÂU V
[
ÊÊ 	
ErrorI18nKeys
ÊÊ	 
.
ÊÊ 
PERMISSION_DENIED
ÊÊ (
]
ÊÊ( )
=
ÊÊ* +
$str
ÊÊ, L
,
ÊÊL M
[
ÁÁ 	
ErrorI18nKeys
ÁÁ	 
.
ÁÁ !
PRECONDITION_FAILED
ÁÁ *
]
ÁÁ* +
=
ÁÁ, -
$str
ÁÁ. Y
,
ÁÁY Z
[
ËË 	
ErrorI18nKeys
ËË	 
.
ËË 
CONFLICT
ËË 
]
ËË  
=
ËË! "
$str
ËË# a
,
ËËa b
[
ÈÈ 	
ErrorI18nKeys
ÈÈ	 
.
ÈÈ  
RESOURCE_EXHAUSTED
ÈÈ )
]
ÈÈ) *
=
ÈÈ+ ,
$str
ÈÈ- Q
,
ÈÈQ R
[
ÍÍ 	
ErrorI18nKeys
ÍÍ	 
.
ÍÍ !
SERVICE_UNAVAILABLE
ÍÍ *
]
ÍÍ* +
=
ÍÍ, -
$str
ÍÍ. `
,
ÍÍ` a
[
ÎÎ 	
ErrorI18nKeys
ÎÎ	 
.
ÎÎ $
DEPENDENCY_UNAVAILABLE
ÎÎ -
]
ÎÎ- .
=
ÎÎ/ 0
$str
ÎÎ1 d
,
ÎÎd e
[
ÏÏ 	
ErrorI18nKeys
ÏÏ	 
.
ÏÏ 
DEADLINE_EXCEEDED
ÏÏ (
]
ÏÏ( )
=
ÏÏ* +
$str
ÏÏ, `
,
ÏÏ` a
[
ÌÌ 	
ErrorI18nKeys
ÌÌ	 
.
ÌÌ 
	CANCELLED
ÌÌ  
]
ÌÌ  !
=
ÌÌ" #
$str
ÌÌ$ ;
,
ÌÌ; <
[
ÓÓ 	
ErrorI18nKeys
ÓÓ	 
.
ÓÓ 
INTERNAL
ÓÓ 
]
ÓÓ  
=
ÓÓ! "
$str
ÓÓ# H
,
ÓÓH I
[
ÔÔ 	
ErrorI18nKeys
ÔÔ	 
.
ÔÔ "
DATABASE_UNAVAILABLE
ÔÔ +
]
ÔÔ+ ,
=
ÔÔ- .
$str
ÔÔ/ a
,
ÔÔa b
[
 	
$str
	 #
]
# $
=
% &
$str
' b
,
b c
[
ÛÛ 	
$str
ÛÛ	 1
]
ÛÛ1 2
=
ÛÛ3 4
$str
ÛÛ5 \
,
ÛÛ\ ]
[
ÙÙ 	
$str
ÙÙ	 <
]
ÙÙ< =
=
ÙÙ> ?
$str
ÙÙ@ g
,
ÙÙg h
[
ıı 	
$str
ıı	 /
]
ıı/ 0
=
ıı1 2
$str
ıı3 u
,
ııu v
[
ˆˆ 	
$str
ˆˆ	 6
]
ˆˆ6 7
=
ˆˆ8 9
$strˆˆ: Å
,ˆˆÅ Ç
[
˘˘ 	
$str
˘˘	 9
]
˘˘9 :
=
˘˘; <
$str
˘˘= N
,
˘˘N O
[
˙˙ 	
$str
˙˙	 ?
]
˙˙? @
=
˙˙A B
$str
˙˙C o
,
˙˙o p
[
˚˚ 	
$str
˚˚	 8
]
˚˚8 9
=
˚˚: ;
$str
˚˚< T
,
˚˚T U
[
¸¸ 	
$str
¸¸	 =
]
¸¸= >
=
¸¸? @
$str
¸¸A S
,
¸¸S T
[
˝˝ 	
$str
˝˝	 :
]
˝˝: ;
=
˝˝< =
$str
˝˝> J
,
˝˝J K
[
ÄÄ 	
$str
ÄÄ	 D
]
ÄÄD E
=
ÄÄF G
$str
ÄÄH ^
,
ÄÄ^ _
[
ÅÅ 	
$str
ÅÅ	 J
]
ÅÅJ K
=
ÅÅL M
$strÅÅN É
,ÅÅÉ Ñ
[
ÇÇ 	
$str
ÇÇ	 C
]
ÇÇC D
=
ÇÇE F
$str
ÇÇG _
,
ÇÇ_ `
[
ÉÉ 	
$str
ÉÉ	 H
]
ÉÉH I
=
ÉÉJ K
$str
ÉÉL ^
,
ÉÉ^ _
[
ÑÑ 	
$str
ÑÑ	 E
]
ÑÑE F
=
ÑÑG H
$str
ÑÑI U
,
ÑÑU V
[
áá 	
$str
áá	 <
]
áá< =
=
áá> ?
$str
áá@ V
,
ááV W
[
àà 	
$str
àà	 B
]
ààB C
=
ààD E
$str
ààF q
,
ààq r
[
ââ 	
$str
ââ	 ;
]
ââ; <
=
ââ= >
$str
ââ? R
,
ââR S
[
ää 	
$str
ää	 H
]
ääH I
=
ääJ K
$str
ääL q
,
ääq r
[
ãã 	
$str
ãã	 D
]
ããD E
=
ããF G
$str
ããH U
,
ããU V
[
åå 	
$str
åå	 D
]
ååD E
=
ååF G
$str
ååH Y
,
ååY Z
[
éé 	
$str
éé	 4
]
éé4 5
=
éé6 7
$str
éé8 I
,
ééI J
[
èè 	
$str
èè	 :
]
èè: ;
=
èè< =
$str
èè> _
,
èè_ `
[
êê 	
$str
êê	 3
]
êê3 4
=
êê5 6
$str
êê7 D
,
êêD E
[
ëë 	
$str
ëë	 8
]
ëë8 9
=
ëë: ;
$str
ëë< E
,
ëëE F
[
íí 	
$str
íí	 5
]
íí5 6
=
íí7 8
$str
íí9 F
,
ííF G
[
îî 	
$str
îî	 <
]
îî< =
=
îî> ?
$str
îî@ Y
,
îîY Z
[
ïï 	
$str
ïï	 B
]
ïïB C
=
ïïD E
$str
ïïF y
,
ïïy z
[
ññ 	
$str
ññ	 M
]
ññM N
=
ññO P
$str
ññQ _
,
ññ_ `
[
óó 	
$str
óó	 F
]
óóF G
=
óóH I
$str
óóJ r
,
óór s
[
òò 	
$str
òò	 T
]
òòT U
=
òòV W
$str
òòX h
,
òòh i
[
ôô 	
$str
ôô	 M
]
ôôM N
=
ôôO P
$str
ôôQ x
,
ôôx y
[
öö 	
$str
öö	 N
]
ööN O
=
ööP Q
$str
ööR p
,
ööp q
[
õõ 	
$str
õõ	 =
]
õõ= >
=
õõ? @
$str
õõA Z
,
õõZ [
[
ùù 	
$str
ùù	 7
]
ùù7 8
=
ùù9 :
$str
ùù; S
,
ùùS T
[
ûû 	
$str
ûû	 =
]
ûû= >
=
ûû? @
$str
ûûA u
,
ûûu v
[
üü 	
$str
üü	 I
]
üüI J
=
üüK L
$str
üüM a
,
üüa b
[
†† 	
$str
††	 B
]
††B C
=
††D E
$str
††F n
,
††n o
[
°° 	
$str
°°	 M
]
°°M N
=
°°O P
$str
°°Q i
,
°°i j
[
¢¢ 	
$str
¢¢	 F
]
¢¢F G
=
¢¢H I
$str
¢¢J e
,
¢¢e f
[
££ 	
$str
££	 8
]
££8 9
=
££: ;
$str
££< R
,
££R S
[
•• 	
$str
••	 0
]
••0 1
=
••2 3
$str
••4 H
,
••H I
[
¶¶ 	
$str
¶¶	 6
]
¶¶6 7
=
¶¶8 9
$str
¶¶: d
,
¶¶d e
[
ßß 	
$str
ßß	 /
]
ßß/ 0
=
ßß1 2
$str
ßß3 @
,
ßß@ A
[
®® 	
$str
®®	 4
]
®®4 5
=
®®6 7
$str
®®8 >
,
®®> ?
[
©© 	
$str
©©	 1
]
©©1 2
=
©©3 4
$str
©©5 F
,
©©F G
[
¨¨ 	
$str
¨¨	 &
]
¨¨& '
=
¨¨( )
$str
¨¨* 0
,
¨¨0 1
[
≠≠ 	
$str
≠≠	 (
]
≠≠( )
=
≠≠* +
$str
≠≠, _
,
≠≠_ `
[
ÆÆ 	
$str
ÆÆ	 2
]
ÆÆ2 3
=
ÆÆ4 5
$str
ÆÆ6 F
,
ÆÆF G
[
ØØ 	
$str
ØØ	 +
]
ØØ+ ,
=
ØØ- .
$str
ØØ/ T
,
ØØT U
[
∞∞ 	
$str
∞∞	 7
]
∞∞7 8
=
∞∞9 :
$str
∞∞; I
,
∞∞I J
[
±± 	
$str
±±	 0
]
±±0 1
=
±±2 3
$str
±±4 Y
,
±±Y Z
[
≤≤ 	
$str
≤≤	 0
]
≤≤0 1
=
≤≤2 3
$str
≤≤4 B
,
≤≤B C
[
≥≥ 	
$str
≥≥	 )
]
≥≥) *
=
≥≥+ ,
$str
≥≥- 9
,
≥≥9 :
[
∂∂ 	
$str
∂∂	 ;
]
∂∂; <
=
∂∂= >
$str∂∂? »
,∂∂» …
[
∑∑ 	
$str
∑∑	 ,
]
∑∑, -
=
∑∑. /
$str
∑∑0 U
,
∑∑U V
[
∏∏ 	
$str
∏∏	 2
]
∏∏2 3
=
∏∏4 5
$str
∏∏6 \
,
∏∏\ ]
[
ππ 	
$str
ππ	 &
]
ππ& '
=
ππ( )
$str
ππ* r
,
ππr s
[
∫∫ 	
$str
∫∫	 (
]
∫∫( )
=
∫∫* +
$str∫∫, á
,∫∫á à
[
ªª 	
$str
ªª	 1
]
ªª1 2
=
ªª3 4
$strªª5 Ö
,ªªÖ Ü
[
ºº 	
$str
ºº	 *
]
ºº* +
=
ºº, -
$str
ºº. e
,
ººe f
[
øø 	
$str
øø	 ,
]
øø, -
=
øø. /
$str
øø0 P
,
øøP Q
[
¿¿ 	
$str
¿¿	 $
]
¿¿$ %
=
¿¿& '
$str
¿¿( D
,
¿¿D E
[
¡¡ 	
$str
¡¡	 '
]
¡¡' (
=
¡¡) *
$str
¡¡+ L
,
¡¡L M
[
¬¬ 	
$str
¬¬	 -
]
¬¬- .
=
¬¬/ 0
$str
¬¬1 W
,
¬¬W X
[
√√ 	
$str
√√	 -
]
√√- .
=
√√/ 0
$str
√√1 U
,
√√U V
[
≈≈ 	
$str
≈≈	 0
]
≈≈0 1
=
≈≈2 3
$str
≈≈4 i
,
≈≈i j
[
∆∆ 	
$str
∆∆	 0
]
∆∆0 1
=
∆∆2 3
$str
∆∆4 N
,
∆∆N O
[
«« 	
$str
««	 -
]
««- .
=
««/ 0
$str
««1 R
,
««R S
[
»» 	
$str
»»	 5
]
»»5 6
=
»»7 8
$str
»»9 d
,
»»d e
[
…… 	
$str
……	 (
]
……( )
=
……* +
$str
……, @
,
……@ A
[
   	
$str
  	 1
]
  1 2
=
  3 4
$str
  5 Z
,
  Z [
[
ÕÕ 	
$str
ÕÕ	 E
]
ÕÕE F
=
ÕÕG H
$str
ÕÕI ^
,
ÕÕ^ _
[
ŒŒ 	
$str
ŒŒ	 <
]
ŒŒ< =
=
ŒŒ> ?
$str
ŒŒ@ W
,
ŒŒW X
[
œœ 	
$str
œœ	 9
]
œœ9 :
=
œœ; <
$str
œœ= T
,
œœT U
[
–– 	
$str
––	 8
]
––8 9
=
––: ;
$str
––< N
,
––N O
[
”” 	
$str
””	 1
]
””1 2
=
””3 4
$str
””5 _
,
””_ `
[
‘‘ 	
$str
‘‘	 ;
]
‘‘; <
=
‘‘= >
$str
‘‘? x
,
‘‘x y
[
’’ 	
$str
’’	 5
]
’’5 6
=
’’7 8
$str
’’9 `
,
’’` a
[
÷÷ 	
$str
÷÷	 6
]
÷÷6 7
=
÷÷8 9
$str
÷÷: ^
,
÷÷^ _
[
◊◊ 	
$str
◊◊	 9
]
◊◊9 :
=
◊◊; <
$str
◊◊= d
,
◊◊d e
[
ŸŸ 	
$str
ŸŸ	 ?
]
ŸŸ? @
=
ŸŸA B
$strŸŸC §
,ŸŸ§ •
[
⁄⁄ 	
$str
⁄⁄	 A
]
⁄⁄A B
=
⁄⁄C D
$str
⁄⁄E u
,
⁄⁄u v
[
€€ 	
$str
€€	 0
]
€€0 1
=
€€2 3
$str
€€4 k
,
€€k l
[
ﬁﬁ 	
$str
ﬁﬁ	 .
]
ﬁﬁ. /
=
ﬁﬁ0 1
$str
ﬁﬁ2 D
,
ﬁﬁD E
[
ﬂﬂ 	
$str
ﬂﬂ	 0
]
ﬂﬂ0 1
=
ﬂﬂ2 3
$str
ﬂﬂ4 G
,
ﬂﬂG H
[
‡‡ 	
$str
‡‡	 0
]
‡‡0 1
=
‡‡2 3
$str
‡‡4 H
,
‡‡H I
[
·· 	
$str
··	 /
]
··/ 0
=
··1 2
$str
··3 A
,
··A B
[
‚‚ 	
$str
‚‚	 2
]
‚‚2 3
=
‚‚4 5
$str
‚‚6 N
,
‚‚N O
[
„„ 	
$str
„„	 2
]
„„2 3
=
„„4 5
$str
„„6 L
,
„„L M
[
‰‰ 	
$str
‰‰	 .
]
‰‰. /
=
‰‰0 1
$str
‰‰2 B
,
‰‰B C
[
ÂÂ 	
$str
ÂÂ	 0
]
ÂÂ0 1
=
ÂÂ2 3
$str
ÂÂ4 T
,
ÂÂT U
[
ÊÊ 	
$str
ÊÊ	 0
]
ÊÊ0 1
=
ÊÊ2 3
$str
ÊÊ4 G
,
ÊÊG H
[
ÁÁ 	
$str
ÁÁ	 8
]
ÁÁ8 9
=
ÁÁ: ;
$str
ÁÁ< [
,
ÁÁ[ \
[
ËË 	
$str
ËË	 4
]
ËË4 5
=
ËË6 7
$str
ËË8 Q
,
ËËQ R
[
ÈÈ 	
$str
ÈÈ	 5
]
ÈÈ5 6
=
ÈÈ7 8
$str
ÈÈ9 b
,
ÈÈb c
[
ÍÍ 	
$str
ÍÍ	 7
]
ÍÍ7 8
=
ÍÍ9 :
$str
ÍÍ; Z
,
ÍÍZ [
[
ÎÎ 	
$str
ÎÎ	 8
]
ÎÎ8 9
=
ÎÎ: ;
$str
ÎÎ< W
,
ÎÎW X
[
ÏÏ 	
$str
ÏÏ	 9
]
ÏÏ9 :
=
ÏÏ; <
$str
ÏÏ= T
,
ÏÏT U
[
ÌÌ 	
$str
ÌÌ	 5
]
ÌÌ5 6
=
ÌÌ7 8
$str
ÌÌ9 V
,
ÌÌV W
[
ÔÔ 	
$str
ÔÔ	 8
]
ÔÔ8 9
=
ÔÔ: ;
$str
ÔÔ< Y
,
ÔÔY Z
[
ÒÒ 	
$str
ÒÒ	 5
]
ÒÒ5 6
=
ÒÒ7 8
$str
ÒÒ9 F
,
ÒÒF G
[
ÚÚ 	
$str
ÚÚ	 6
]
ÚÚ6 7
=
ÚÚ8 9
$str
ÚÚ: H
,
ÚÚH I
[
ÛÛ 	
$str
ÛÛ	 2
]
ÛÛ2 3
=
ÛÛ4 5
$str
ÛÛ6 ?
,
ÛÛ? @
[
ÙÙ 	
$str
ÙÙ	 2
]
ÙÙ2 3
=
ÙÙ4 5
$str
ÙÙ6 ?
,
ÙÙ? @
[
ıı 	
$str
ıı	 4
]
ıı4 5
=
ıı6 7
$str
ıı8 A
,
ııA B
[
ˆˆ 	
$str
ˆˆ	 8
]
ˆˆ8 9
=
ˆˆ: ;
$str
ˆˆ< J
,
ˆˆJ K
[
¯¯ 	
$str
¯¯	 6
]
¯¯6 7
=
¯¯8 9
$str
¯¯: Q
,
¯¯Q R
[
˘˘ 	
$str
˘˘	 8
]
˘˘8 9
=
˘˘: ;
$str
˘˘< ]
,
˘˘] ^
[
˙˙ 	
$str
˙˙	 :
]
˙˙: ;
=
˙˙< =
$str
˙˙> [
,
˙˙[ \
[
˝˝ 	
$str
˝˝	 
]
˝˝  
=
˝˝! "
$str
˝˝# +
,
˝˝+ ,
[
˛˛ 	
$str
˛˛	 &
]
˛˛& '
=
˛˛( )
$str
˛˛* ;
,
˛˛; <
[
ÅÅ 	
$str
ÅÅ	 
]
ÅÅ  
=
ÅÅ! "
$str
ÅÅ# >
,
ÅÅ> ?
[
ÇÇ 	
$str
ÇÇ	  
]
ÇÇ  !
=
ÇÇ" #
$str
ÇÇ$ :
,
ÇÇ: ;
[
ÉÉ 	
$str
ÉÉ	 
]
ÉÉ 
=
ÉÉ 
$str
ÉÉ (
,
ÉÉ( )
[
ÑÑ 	
$str
ÑÑ	 
]
ÑÑ  
=
ÑÑ! "
$str
ÑÑ# s
,
ÑÑs t
[
ÖÖ 	
$str
ÖÖ	 
]
ÖÖ 
=
ÖÖ 
$str
ÖÖ M
,
ÖÖM N
[
àà 	
$str
àà	 
]
àà 
=
àà 
$str
àà %
,
àà% &
[
ââ 	
$str
ââ	 
]
ââ 
=
ââ 
$str
ââ (
,
ââ( )
[
ää 	
$str
ää	 
]
ää 
=
ää  !
$str
ää" ,
,
ää, -
[
ãã 	
$str
ãã	 
]
ãã 
=
ãã  !
$str
ãã" .
,
ãã. /
[
éé 	
$str
éé	 
]
éé 
=
éé 
$str
éé .
,
éé. /
[
èè 	
$str
èè	 
]
èè 
=
èè 
$str
èè $
,
èè$ %
[
êê 	
$str
êê	 
]
êê 
=
êê 
$str
êê &
,
êê& '
[
ëë 	
$str
ëë	 
]
ëë 
=
ëë 
$str
ëë '
,
ëë' (
[
íí 	
$str
íí	 !
]
íí! "
=
íí# $
$str
íí% :
,
íí: ;
[
ìì 	
$str
ìì	 
]
ìì 
=
ìì 
$str
ìì  
,
ìì  !
[
îî 	
$str
îî	 &
]
îî& '
=
îî( )
$str
îî* J
,
îîJ K
[
ïï 	
$str
ïï	 !
]
ïï! "
=
ïï# $
$str
ïï% H
,
ïïH I
[
òò 	
$str
òò	 /
]
òò/ 0
=
òò1 2
$str
òò3 S
,
òòS T
[
ôô 	
$str
ôô	 5
]
ôô5 6
=
ôô7 8
$str
ôô9 a
,
ôôa b
[
öö 	
$str
öö	 5
]
öö5 6
=
öö7 8
$str
öö9 N
,
ööN O
[
õõ 	
$str
õõ	 ;
]
õõ; <
=
õõ= >
$str
õõ? e
,
õõe f
[
úú 	
$str
úú	 5
]
úú5 6
=
úú7 8
$str
úú9 O
,
úúO P
[
ùù 	
$str
ùù	 ;
]
ùù; <
=
ùù= >
$str
ùù? d
,
ùùd e
[
ûû 	
$str
ûû	 /
]
ûû/ 0
=
ûû1 2
$str
ûû3 @
,
ûû@ A
[
üü 	
$str
üü	 5
]
üü5 6
=
üü7 8
$str
üü9 \
,
üü\ ]
[
†† 	
$str
††	 1
]
††1 2
=
††3 4
$str
††5 F
,
††F G
[
°° 	
$str
°°	 7
]
°°7 8
=
°°9 :
$str
°°; g
,
°°g h
[
¢¢ 	
$str
¢¢	 8
]
¢¢8 9
=
¢¢: ;
$str
¢¢< P
,
¢¢P Q
[
££ 	
$str
££	 >
]
££> ?
=
££@ A
$str
££B `
,
££` a
[
§§ 	
$str
§§	 7
]
§§7 8
=
§§9 :
$str
§§; S
,
§§S T
[
•• 	
$str
••	 =
]
••= >
=
••? @
$str
••A U
,
••U V
[
¶¶ 	
$str
¶¶	 5
]
¶¶5 6
=
¶¶7 8
$str
¶¶9 R
,
¶¶R S
[
ßß 	
$str
ßß	 ;
]
ßß; <
=
ßß= >
$str
ßß? k
,
ßßk l
[
®® 	
$str
®®	 6
]
®®6 7
=
®®8 9
$str
®®: F
,
®®F G
[
©© 	
$str
©©	 <
]
©©< =
=
©©> ?
$str
©©@ _
,
©©_ `
[
™™ 	
$str
™™	 +
]
™™+ ,
=
™™- .
$str
™™/ :
,
™™: ;
[
≠≠ 	
$str
≠≠	 "
]
≠≠" #
=
≠≠$ %
$str
≠≠& 7
,
≠≠7 8
[
ÆÆ 	
$str
ÆÆ	 #
]
ÆÆ# $
=
ÆÆ% &
$str
ÆÆ' =
,
ÆÆ= >
[
ØØ 	
$str
ØØ	 +
]
ØØ+ ,
=
ØØ- .
$str
ØØ/ =
,
ØØ= >
[
∞∞ 	
$str
∞∞	 +
]
∞∞+ ,
=
∞∞- .
$str
∞∞/ 9
}
±± 
.
±±  
ToFrozenDictionary
±± 
(
±± 
)
±± 
;
±± 
public
≥≥ 

static
≥≥ 
readonly
≥≥ 
FrozenDictionary
≥≥ +
<
≥≥+ ,
string
≥≥, 2
,
≥≥2 3
FrozenDictionary
≥≥4 D
<
≥≥D E
string
≥≥E K
,
≥≥K L
string
≥≥M S
>
≥≥S T
>
≥≥T U
AllLanguages
≥≥V b
=
≥≥c d
new
≥≥e h

Dictionary
≥≥i s
<
≥≥s t
string
≥≥t z
,
≥≥z {
FrozenDictionary≥≥| å
<≥≥å ç
string≥≥ç ì
,≥≥ì î
string≥≥ï õ
>≥≥õ ú
>≥≥ú ù
{
¥¥ 
[
µµ 	
$str
µµ	 
]
µµ 
=
µµ 
EnglishStrings
µµ "
,
µµ" #
[
∂∂ 	
$str
∂∂	 
]
∂∂ 
=
∂∂ 
UkrainianStrings
∂∂ $
}
∑∑ 
.
∑∑  
ToFrozenDictionary
∑∑ 
(
∑∑ 
)
∑∑ 
;
∑∑ 
}∏∏ ö"
s/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/IconService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
;% &
internal 
static	 
class 
IconService !
{ 
private 
static 
Option 
< 

WindowIcon $
>$ %
_cachedIcon& 1
=2 3
Option4 :
<: ;

WindowIcon; E
>E F
.F G
NoneG K
;K L
public 

static 
void 
SetIconForWindow '
(' (
Window( .
window/ 5
)5 6
{ 
_cachedIcon 
. 
Or 
( 
LoadPlatformIcon '
)' (
. 
Do 
( 
icon 
=> 
{ 
_cachedIcon 
= 
Option $
<$ %

WindowIcon% /
>/ 0
.0 1
Some1 5
(5 6
icon6 :
): ;
;; <
window 
. 
Icon 
= 
icon "
;" #
} 
) 
; 
} 
private 
static 
Option 
< 

WindowIcon $
>$ %
LoadPlatformIcon& 6
(6 7
)7 8
{ 
return 
GetPlatformIconUri !
(! "
)" #
. 
Bind 
( 
uri 
=> 
{ 
try 
{   
Bitmap!! 
bitmap!! !
=!!" #
new!!$ '
(!!' (
AssetLoader!!( 3
.!!3 4
Open!!4 8
(!!8 9
uri!!9 <
)!!< =
)!!= >
;!!> ?
return"" 
Option"" !
<""! "

WindowIcon""" ,
>"", -
.""- .
Some"". 2
(""2 3
new""3 6

WindowIcon""7 A
(""A B
bitmap""B H
)""H I
)""I J
;""J K
}## 
catch$$ 
($$ 
	Exception$$  
ex$$! #
)$$# $
{%% 
Log&& 
.&& 
Warning&& 
(&&  
ex&&  "
,&&" #
$str&&$ E
)&&E F
;&&F G
return'' 
Option'' !
<''! "

WindowIcon''" ,
>'', -
.''- .
None''. 2
;''2 3
}(( 
})) 
))) 
;)) 
}** 
private,, 
static,, 
Option,, 
<,, 
Uri,, 
>,, 
GetPlatformIconUri,, 1
(,,1 2
),,2 3
{-- 
if.. 

(.. 
OperatingSystem.. 
... 
	IsWindows.. %
(..% &
)..& '
)..' (
{// 	
return00 
Option00 
<00 
Uri00 
>00 
.00 
Some00 #
(00# $
new00$ '
Uri00( +
(00+ ,
$str00, r
)00r s
)00s t
;00t u
}11 	
if33 

(33 
OperatingSystem33 
.33 
IsMacOS33 #
(33# $
)33$ %
)33% &
{44 	
return55 
Option55 
<55 
Uri55 
>55 
.55 
Some55 #
(55# $
new55$ '
Uri55( +
(55+ ,
$str55, u
)55u v
)55v w
;55w x
}66 	
if88 

(88 
OperatingSystem88 
.88 
IsLinux88 #
(88# $
)88$ %
)88% &
{99 	
return:: 
Option:: 
<:: 
Uri:: 
>:: 
.:: 
Some:: #
(::# $
new::$ '
Uri::( +
(::+ ,
$str::, t
)::t u
)::u v
;::v w
};; 	
return== 
Option== 
<== 
Uri== 
>== 
.== 
None== 
;==  
}>> 
}?? ‰
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/ApplicationStateManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
;% &
public		 
sealed		 
class		 #
ApplicationStateManager		 +
:		, -$
IApplicationStateManager		. F
,		F G
IDisposable		H S
{

 
private 
readonly 
BehaviorSubject $
<$ %
ApplicationState% 5
>5 6
_stateSubject7 D
=E F
newG J
(J K
ApplicationStateK [
.[ \
INITIALIZING\ h
)h i
;i j
private 
Option 
< 
string 
>  
_currentMembershipId /
=0 1
Option2 8
<8 9
string9 ?
>? @
.@ A
NoneA E
;E F
private 
bool 
	_disposed 
; 
public 

ApplicationState 
CurrentState (
=>) +
_stateSubject, 9
.9 :
Value: ?
;? @
public 

IObservable 
< 
ApplicationState '
>' (
StateChanges) 5
=>6 8
_stateSubject9 F
;F G
public 

Option 
< 
string 
> 
CurrentMembershipId -
=>. 0 
_currentMembershipId1 E
;E F
public 

Task &
TransitionToAnonymousAsync *
(* +
)+ ,
{  
_currentMembershipId 
= 
Option %
<% &
string& ,
>, -
.- .
None. 2
;2 3
_stateSubject 
. 
OnNext 
( 
ApplicationState -
.- .
	Anonymous. 7
)7 8
;8 9
return 
Task 
. 
CompletedTask !
;! "
} 
public 

Task *
TransitionToAuthenticatedAsync .
(. /
string/ 5
membershipId6 B
)B C
{ 
if 

( 
string 
. 
IsNullOrEmpty  
(  !
membershipId! -
)- .
). /
{ 	
throw   
new   
ArgumentException   '
(  ' (
$str  ( O
,  O P
nameof  Q W
(  W X
membershipId  X d
)  d e
)  e f
;  f g
}!! 	 
_currentMembershipId## 
=## 
Option## %
<##% &
string##& ,
>##, -
.##- .
Some##. 2
(##2 3
membershipId##3 ?
)##? @
;##@ A
_stateSubject$$ 
.$$ 
OnNext$$ 
($$ 
ApplicationState$$ -
.$$- .
Authenticated$$. ;
)$$; <
;$$< =
return%% 
Task%% 
.%% 
CompletedTask%% !
;%%! "
}&& 
public(( 

void(( 
Dispose(( 
((( 
)(( 
{)) 
if** 

(** 
	_disposed** 
)** 
{++ 	
return,, 
;,, 
}-- 	
_stateSubject// 
?// 
.// 
Dispose// 
(// 
)//  
;//  !
	_disposed00 
=00 
true00 
;00 
}11 
}22 • 
y/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/ApplicationRouter.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
;% &
public 
sealed 
class 
ApplicationRouter %
(% &3
'IClassicDesktopStyleApplicationLifetime +
desktop, 3
,3 4
IModuleManager   
moduleManager    
,    !
NetworkProvider!! 
networkProvider!! #
,!!# $-
!IApplicationSecureStorageProvider"" %,
 applicationSecureStorageProvider""& F
,""F G
MainWindowViewModel## 
mainWindowViewModel## +
)##+ ,
:##- .
IApplicationRouter##/ A
{$$ 
private%% 
const%% 
int%% 
FADE_DURATION_MS%% &
=%%' (
$num%%) ,
;%%, -
private&& 
const&& 
int&&  
WINDOW_SHOW_DELAY_MS&& *
=&&+ ,
$num&&- /
;&&/ 0
private'' 
const'' 
int'' 
FRAME_DELAY_MS'' $
=''% &
$num''' )
;'') *
public)) 

async)) 
Task)) )
NavigateToAuthenticationAsync)) 3
())3 4
)))4 5
{** 
Option++ 
<++ 
IModule++ 
>++ 
authModuleOption++ (
=++) *
await+++ 0
moduleManager++1 >
.++> ?
LoadModuleAsync++? N
(++N O
$str++O _
)++_ `
.++` a
ConfigureAwait++a o
(++o p
false++p u
)++u v
;++v w
if-- 

(-- 
!-- 
authModuleOption-- 
.-- 
IsSome-- $
)--$ %
{.. 	
throw// 
new// %
InvalidOperationException// /
(/// 0$
ApplicationErrorMessages//0 H
.//H I
ApplicationRouter//I Z
.//Z [&
FAILED_TO_LOAD_AUTH_MODULE//[ u
)//u v
;//v w
}00 	
IModule22 

authModule22 
=22 
authModuleOption22 -
.22- .
Value22. 3
!223 4
;224 5
if44 

(44 

authModule44 
.44 
ServiceScope44 #
?44# $
.44$ %
ServiceProvider44% 4
==445 7
null448 <
)44< =
{55 	
throw66 
new66 %
InvalidOperationException66 /
(66/ 0$
ApplicationErrorMessages660 H
.66H I
ApplicationRouter66I Z
.66Z [&
FAILED_TO_LOAD_AUTH_MODULE66[ u
)66u v
;66v w
}77 	#
AuthenticationViewModel99 
?99  
membershipViewModel99! 4
=995 6

authModule:: 
.:: 
ServiceScope:: #
.::# $
ServiceProvider::$ 3
.::3 4

GetService::4 >
<::> ?#
AuthenticationViewModel::? V
>::V W
(::W X
)::X Y
;::Y Z
if<< 

(<< 
membershipViewModel<< 
==<<  "
null<<# '
)<<' (
{== 	
throw>> 
new>> %
InvalidOperationException>> /
(>>/ 0$
ApplicationErrorMessages>>0 H
.>>H I
ApplicationRouter>>I Z
.?? 2
&FAILED_TO_CREATE_MEMBERSHIP_VIEW_MODEL?? 7
)??7 8
;??8 9
}@@ 	
awaitBB 
mainWindowViewModelBB !
.BB! ")
SetAuthenticationContentAsyncBB" ?
(BB? @
membershipViewModelBB@ S
)BBS T
.BBT U
ConfigureAwaitBBU c
(BBc d
falseBBd i
)BBi j
;BBj k
awaitCC 
moduleManagerCC 
.CC 
UnloadModuleAsyncCC -
(CC- .
$strCC. 4
)CC4 5
.CC5 6
ConfigureAwaitCC6 D
(CCD E
falseCCE J
)CCJ K
;CCK L
awaitDD (
EnsureAnonymousProtocolAsyncDD *
(DD* +
)DD+ ,
.DD, -
ConfigureAwaitDD- ;
(DD; <
falseDD< A
)DDA B
;DDB C
}EE 
publicGG 

asyncGG 
TaskGG 
NavigateToMainAsyncGG )
(GG) *
)GG* +
{HH 
LogII 
.II 
DebugII 
(II 
$strII D
)IID E
;IIE F
OptionKK 
<KK 
IModuleKK 
>KK 
mainModuleOptionKK (
=KK) *
awaitKK+ 0
moduleManagerKK1 >
.KK> ?
LoadModuleAsyncKK? N
(KKN O
$strKKO U
)KKU V
.KKV W
ConfigureAwaitKKW e
(KKe f
falseKKf k
)KKk l
;KKl m
ifMM 

(MM 
!MM 
mainModuleOptionMM 
.MM 
IsSomeMM $
)MM$ %
{NN 	
LogOO 
.OO 
ErrorOO 
(OO 
$strOO ?
)OO? @
;OO@ A
throwPP 
newPP %
InvalidOperationExceptionPP /
(PP/ 0$
ApplicationErrorMessagesPP0 H
.PPH I
ApplicationRouterPPI Z
.PPZ [&
FAILED_TO_LOAD_MAIN_MODULEPP[ u
)PPu v
;PPv w
}QQ 	
IModuleSS 

mainModuleSS 
=SS 
mainModuleOptionSS -
.SS- .
ValueSS. 3
!SS3 4
;SS4 5
ifUU 

(UU 

mainModuleUU 
.UU 
ServiceScopeUU #
?UU# $
.UU$ %
ServiceProviderUU% 4
==UU5 7
nullUU8 <
)UU< =
{VV 	
LogWW 
.WW 
ErrorWW 
(WW 
$strWW ?
)WW? @
;WW@ A
throwXX 
newXX %
InvalidOperationExceptionXX /
(XX/ 0$
ApplicationErrorMessagesXX0 H
.XXH I
ApplicationRouterXXI Z
.XXZ [&
FAILED_TO_LOAD_MAIN_MODULEXX[ u
)XXu v
;XXv w
}YY 	
MasterViewModel[[ 
?[[ 
mainViewModel[[ &
=[[' (

mainModule\\ 
.\\ 
ServiceScope\\ #
.\\# $
ServiceProvider\\$ 3
.\\3 4

GetService\\4 >
<\\> ?
MasterViewModel\\? N
>\\N O
(\\O P
)\\P Q
;\\Q R
if^^ 

(^^ 
mainViewModel^^ 
==^^ 
null^^ !
)^^! "
{__ 	
Log`` 
.`` 
Error`` 
(`` 
$str`` E
)``E F
;``F G
throwaa 
newaa %
InvalidOperationExceptionaa /
(aa/ 0$
ApplicationErrorMessagesaa0 H
.aaH I
ApplicationRouteraaI Z
.aaZ [,
 FAILED_TO_CREATE_MAIN_VIEW_MODELaa[ {
)aa{ |
;aa| }
}bb 	
Logdd 
.dd 
Debugdd 
(dd 
$strdd C
)ddC D
;ddD E
awaitee 
mainWindowViewModelee !
.ee! "
SetMainContentAsyncee" 5
(ee5 6
mainViewModelee6 C
)eeC D
.eeD E
ConfigureAwaiteeE S
(eeS T
falseeeT Y
)eeY Z
;eeZ [
Loggg 
.gg 
Debuggg 
(gg 
$strgg @
)gg@ A
;ggA B
awaithh 
moduleManagerhh 
.hh 
UnloadModuleAsynchh -
(hh- .
$strhh. >
)hh> ?
.hh? @
ConfigureAwaithh@ N
(hhN O
falsehhO T
)hhT U
;hhU V
Logjj 
.jj 
Debugjj 
(jj 
$strjj J
)jjJ K
;jjK L
}kk 
publicmm 

asyncmm 
Taskmm %
TransitionFromSplashAsyncmm /
(mm/ 0
Windowmm0 6
splashWindowmm7 C
,mmC D
boolmmE I
isAuthenticatedmmJ Y
)mmY Z
{nn 

MainWindowoo 

mainWindowoo 
=oo 
awaitoo  %

Dispatcheroo& 0
.oo0 1
UIThreadoo1 9
.oo9 :
InvokeAsyncoo: E
(ooE F
(ooF G
)ooG H
=>ooI K
newooL O

MainWindowooP Z
{pp 	
DataContextqq 
=qq 
mainWindowViewModelqq -
}rr 	
)rr	 

;rr
 
iftt 

(tt 
isAuthenticatedtt 
)tt 
{uu 	
Optionvv 
<vv 
IModulevv 
>vv 
mainModuleOptionvv ,
=vv- .
awaitvv/ 4
moduleManagervv5 B
.vvB C
LoadModuleAsyncvvC R
(vvR S
$strvvS Y
)vvY Z
.vvZ [
ConfigureAwaitvv[ i
(vvi j
falsevvj o
)vvo p
;vvp q
ifxx 
(xx 
!xx 
mainModuleOptionxx !
.xx! "
IsSomexx" (
||xx) +
mainModuleOptionxx, <
.xx< =
Valuexx= B
!xxB C
.xxC D
ServiceScopexxD P
?xxP Q
.xxQ R
ServiceProviderxxR a
==xxb d
nullxxe i
)xxi j
{yy 
throwzz 
newzz %
InvalidOperationExceptionzz 3
(zz3 4$
ApplicationErrorMessageszz4 L
.zzL M
ApplicationRouterzzM ^
.{{ 2
&FAILED_TO_LOAD_MAIN_MODULE_FROM_SPLASH{{ ;
){{; <
;{{< =
}|| 
IModule~~ 

mainModule~~ 
=~~  
mainModuleOption~~! 1
.~~1 2
Value~~2 7
!~~7 8
;~~8 9
MasterViewModel
ÄÄ 
?
ÄÄ 
mainViewModel
ÄÄ *
=
ÄÄ+ ,

mainModule
ÅÅ 
.
ÅÅ 
ServiceScope
ÅÅ '
.
ÅÅ' (
ServiceProvider
ÅÅ( 7
.
ÅÅ7 8

GetService
ÅÅ8 B
<
ÅÅB C
MasterViewModel
ÅÅC R
>
ÅÅR S
(
ÅÅS T
)
ÅÅT U
;
ÅÅU V
if
ÉÉ 
(
ÉÉ 
mainViewModel
ÉÉ 
==
ÉÉ  
null
ÉÉ! %
)
ÉÉ% &
{
ÑÑ 
throw
ÖÖ 
new
ÖÖ '
InvalidOperationException
ÖÖ 3
(
ÖÖ3 4&
ApplicationErrorMessages
ÖÖ4 L
.
ÖÖL M
ApplicationRouter
ÖÖM ^
.
ÜÜ .
 FAILED_TO_CREATE_MAIN_VIEW_MODEL
ÜÜ 5
)
ÜÜ5 6
;
ÜÜ6 7
}
áá 
await
ââ !
mainWindowViewModel
ââ %
.
ââ% &!
SetMainContentAsync
ââ& 9
(
ââ9 :
mainViewModel
ââ: G
)
ââG H
.
ââH I
ConfigureAwait
ââI W
(
ââW X
false
ââX ]
)
ââ] ^
;
ââ^ _
}
ää 	
else
ãã 
{
åå 	
Option
çç 
<
çç 
IModule
çç 
>
çç 
authModuleOption
çç ,
=
çç- .
await
çç/ 4
moduleManager
çç5 B
.
ççB C
LoadModuleAsync
ççC R
(
ççR S
$str
ççS c
)
ççc d
.
ççd e
ConfigureAwait
ççe s
(
ççs t
false
ççt y
)
ççy z
;
ççz {
if
èè 
(
èè 
!
èè 
authModuleOption
èè !
.
èè! "
IsSome
èè" (
||
èè) +
authModuleOption
èè, <
.
èè< =
Value
èè= B
!
èèB C
.
èèC D
ServiceScope
èèD P
?
èèP Q
.
èèQ R
ServiceProvider
èèR a
==
èèb d
null
èèe i
)
èèi j
{
êê 
throw
ëë 
new
ëë '
InvalidOperationException
ëë 3
(
ëë3 4&
ApplicationErrorMessages
ëë4 L
.
ëëL M
ApplicationRouter
ëëM ^
.
íí 4
&FAILED_TO_LOAD_AUTH_MODULE_FROM_SPLASH
íí ;
)
íí; <
;
íí< =
}
ìì 
IModule
ïï 

authModule
ïï 
=
ïï  
authModuleOption
ïï! 1
.
ïï1 2
Value
ïï2 7
!
ïï7 8
;
ïï8 9%
AuthenticationViewModel
óó #
?
óó# $!
membershipViewModel
óó% 8
=
óó9 :

authModule
òò 
.
òò 
ServiceScope
òò '
.
òò' (
ServiceProvider
òò( 7
.
òò7 8

GetService
òò8 B
<
òòB C%
AuthenticationViewModel
òòC Z
>
òòZ [
(
òò[ \
)
òò\ ]
;
òò] ^
if
öö 
(
öö !
membershipViewModel
öö #
==
öö$ &
null
öö' +
)
öö+ ,
{
õõ 
throw
úú 
new
úú '
InvalidOperationException
úú 3
(
úú3 4&
ApplicationErrorMessages
úú4 L
.
úúL M
ApplicationRouter
úúM ^
.
ùù 4
&FAILED_TO_CREATE_MEMBERSHIP_VIEW_MODEL
ùù ;
)
ùù; <
;
ùù< =
}
ûû 
await
†† !
mainWindowViewModel
†† %
.
††% &+
SetAuthenticationContentAsync
††& C
(
††C D!
membershipViewModel
††D W
)
††W X
.
††X Y
ConfigureAwait
††Y g
(
††g h
false
††h m
)
††m n
;
††n o
}
°° 	
await
££ '
PrepareAndShowWindowAsync
££ '
(
££' (

mainWindow
££( 2
)
££2 3
.
££3 4
ConfigureAwait
££4 B
(
££B C
false
££C H
)
££H I
;
££I J
desktop
§§ 
.
§§ 

MainWindow
§§ 
=
§§ 

mainWindow
§§ '
;
§§' (
await
•• (
PerformFadeTransitionAsync
•• (
(
••( )
splashWindow
••) 5
,
••5 6

mainWindow
••7 A
)
••A B
.
••B C
ConfigureAwait
••C Q
(
••Q R
false
••R W
)
••W X
;
••X Y
}
¶¶ 
private
®® 
static
®® 
async
®® 
Task
®® '
PrepareAndShowWindowAsync
®® 7
(
®®7 8
Window
®®8 >
window
®®? E
)
®®E F
{
©© 
await
™™ 

Dispatcher
™™ 
.
™™ 
UIThread
™™ !
.
™™! "
InvokeAsync
™™" -
(
™™- .
(
™™. /
)
™™/ 0
=>
™™1 3
{
´´ 	
window
¨¨ 
.
¨¨ #
WindowStartupLocation
¨¨ (
=
¨¨) *#
WindowStartupLocation
¨¨+ @
.
¨¨@ A
CenterScreen
¨¨A M
;
¨¨M N
window
≠≠ 
.
≠≠ 
Opacity
≠≠ 
=
≠≠ 
$num
≠≠ 
;
≠≠ 
window
ÆÆ 
.
ÆÆ 
Show
ÆÆ 
(
ÆÆ 
)
ÆÆ 
;
ÆÆ 
}
ØØ 	
)
ØØ	 

;
ØØ
 
await
∞∞ 
Task
∞∞ 
.
∞∞ 
Delay
∞∞ 
(
∞∞ "
WINDOW_SHOW_DELAY_MS
∞∞ -
)
∞∞- .
.
∞∞. /
ConfigureAwait
∞∞/ =
(
∞∞= >
false
∞∞> C
)
∞∞C D
;
∞∞D E
}
±± 
private
≥≥ 
async
≥≥ 
Task
≥≥ (
PerformFadeTransitionAsync
≥≥ 1
(
≥≥1 2
Window
≥≥2 8

fromWindow
≥≥9 C
,
≥≥C D
Window
≥≥E K
toWindow
≥≥L T
)
≥≥T U
{
¥¥ 
TimeSpan
µµ 
duration
µµ 
=
µµ 
TimeSpan
µµ $
.
µµ$ %
FromMilliseconds
µµ% 5
(
µµ5 6
FADE_DURATION_MS
µµ6 F
)
µµF G
;
µµG H
DateTime
∂∂ 
start
∂∂ 
=
∂∂ 
DateTime
∂∂ !
.
∂∂! "
UtcNow
∂∂" (
;
∂∂( )
while
∏∏ 
(
∏∏ 
DateTime
∏∏ 
.
∏∏ 
UtcNow
∏∏ 
-
∏∏  
start
∏∏! &
<
∏∏' (
duration
∏∏) 1
)
∏∏1 2
{
ππ 	
double
∫∫ 
progress
∫∫ 
=
∫∫ 
(
∫∫ 
DateTime
∫∫ '
.
∫∫' (
UtcNow
∫∫( .
-
∫∫/ 0
start
∫∫1 6
)
∫∫6 7
.
∫∫7 8
TotalMilliseconds
∫∫8 I
/
∫∫J K
FADE_DURATION_MS
∫∫L \
;
∫∫\ ]
await
ªª 

Dispatcher
ªª 
.
ªª 
UIThread
ªª %
.
ªª% &
InvokeAsync
ªª& 1
(
ªª1 2
(
ªª2 3
)
ªª3 4
=>
ªª5 7
{
ºº 

fromWindow
ΩΩ 
.
ΩΩ 
Opacity
ΩΩ "
=
ΩΩ# $
$num
ΩΩ% &
-
ΩΩ' (
progress
ΩΩ) 1
;
ΩΩ1 2
toWindow
ææ 
.
ææ 
Opacity
ææ  
=
ææ! "
progress
ææ# +
;
ææ+ ,
}
øø 
)
øø 
;
øø 
await
¿¿ 
Task
¿¿ 
.
¿¿ 
Delay
¿¿ 
(
¿¿ 
FRAME_DELAY_MS
¿¿ +
)
¿¿+ ,
.
¿¿, -
ConfigureAwait
¿¿- ;
(
¿¿; <
false
¿¿< A
)
¿¿A B
;
¿¿B C
}
¡¡ 	
await
√√ 

Dispatcher
√√ 
.
√√ 
UIThread
√√ !
.
√√! "
InvokeAsync
√√" -
(
√√- .
(
√√. /
)
√√/ 0
=>
√√1 3
{
ƒƒ 	
try
≈≈ 
{
∆∆ 

fromWindow
«« 
.
«« 
Opacity
«« "
=
««# $
$num
««% &
;
««& '
toWindow
»» 
.
»» 
Opacity
»»  
=
»»! "
$num
»»# $
;
»»$ %
desktop
   
.
   

MainWindow
   "
=
  # $
toWindow
  % -
;
  - .

fromWindow
ÀÀ 
.
ÀÀ 
Hide
ÀÀ 
(
ÀÀ  
)
ÀÀ  !
;
ÀÀ! "

fromWindow
ÃÃ 
.
ÃÃ 
Close
ÃÃ  
(
ÃÃ  !
)
ÃÃ! "
;
ÃÃ" #
}
ÕÕ 
catch
ŒŒ 
{
œœ 

fromWindow
–– 
.
–– 
Hide
–– 
(
––  
)
––  !
;
––! "

fromWindow
—— 
.
—— 
Opacity
—— "
=
——# $
$num
——% &
;
——& '
}
““ 
}
”” 	
)
””	 

;
””
 
await
’’ 
Task
’’ 
.
’’ 
Delay
’’ 
(
’’ 
$num
’’ 
)
’’ 
.
’’ 
ConfigureAwait
’’ ,
(
’’, -
false
’’- 2
)
’’2 3
;
’’3 4
bool
÷÷ 
isStillVisible
÷÷ 
=
÷÷ 
await
÷÷ #

Dispatcher
÷÷$ .
.
÷÷. /
UIThread
÷÷/ 7
.
÷÷7 8
InvokeAsync
÷÷8 C
(
÷÷C D
(
÷÷D E
)
÷÷E F
=>
÷÷G I

fromWindow
÷÷J T
.
÷÷T U
	IsVisible
÷÷U ^
)
÷÷^ _
;
÷÷_ `
if
ÿÿ 

(
ÿÿ 
isStillVisible
ÿÿ 
)
ÿÿ 
{
ŸŸ 	
await
⁄⁄ 

Dispatcher
⁄⁄ 
.
⁄⁄ 
UIThread
⁄⁄ %
.
⁄⁄% &
InvokeAsync
⁄⁄& 1
(
⁄⁄1 2
(
⁄⁄2 3
)
⁄⁄3 4
=>
⁄⁄5 7
{
€€ 

fromWindow
‹‹ 
.
‹‹ 
Hide
‹‹ 
(
‹‹  
)
‹‹  !
;
‹‹! "

fromWindow
›› 
.
›› 
Close
››  
(
››  !
)
››! "
;
››" #
}
ﬁﬁ 
)
ﬁﬁ 
;
ﬁﬁ 
}
ﬂﬂ 	
}
‡‡ 
private
‚‚ 
async
‚‚ 
Task
‚‚ *
EnsureAnonymousProtocolAsync
‚‚ 3
(
‚‚3 4
)
‚‚4 5
{
„„ 
Result
‰‰ 
<
‰‰ )
ApplicationInstanceSettings
‰‰ *
,
‰‰* +'
InternalServiceApiFailure
‰‰, E
>
‰‰E F
settingsResult
‰‰G U
=
‰‰V W
await
ÂÂ .
 applicationSecureStorageProvider
ÂÂ 2
.
ÂÂ2 31
#GetApplicationInstanceSettingsAsync
ÂÂ3 V
(
ÂÂV W
)
ÂÂW X
.
ÂÂX Y
ConfigureAwait
ÂÂY g
(
ÂÂg h
false
ÂÂh m
)
ÂÂm n
;
ÂÂn o
if
ÁÁ 

(
ÁÁ 
settingsResult
ÁÁ 
.
ÁÁ 
IsErr
ÁÁ  
)
ÁÁ  !
{
ËË 	
return
ÈÈ 
;
ÈÈ 
}
ÍÍ 	)
ApplicationInstanceSettings
ÏÏ #
settings
ÏÏ$ ,
=
ÏÏ- .
settingsResult
ÏÏ/ =
.
ÏÏ= >
Unwrap
ÏÏ> D
(
ÏÏD E
)
ÏÏE F
;
ÏÏF G
if
ÓÓ 

(
ÓÓ 
settings
ÓÓ 
.
ÓÓ 

Membership
ÓÓ 
!=
ÓÓ  "
null
ÓÓ# '
)
ÓÓ' (
{
ÔÔ 	
return
 
;
 
}
ÒÒ 	
uint
ÛÛ 
	connectId
ÛÛ 
=
ÛÛ 
NetworkProvider
ÛÛ (
.
ÛÛ( )$
ComputeUniqueConnectId
ÛÛ) ?
(
ÛÛ? @
settings
ÛÛ@ H
,
ÛÛH I 
PubKeyExchangeType
ÙÙ 
.
ÙÙ (
DataCenterEphemeralConnect
ÙÙ 9
)
ÙÙ9 :
;
ÙÙ: ;
if
ˆˆ 

(
ˆˆ 
networkProvider
ˆˆ 
.
ˆˆ 
HasConnection
ˆˆ )
(
ˆˆ) *
	connectId
ˆˆ* 3
)
ˆˆ3 4
)
ˆˆ4 5
{
˜˜ 	
return
¯¯ 
;
¯¯ 
}
˘˘ 	
networkProvider
˚˚ 
.
˚˚ ,
InitiateEcliptixProtocolSystem
˚˚ 6
(
˚˚6 7
settings
˚˚7 ?
,
˚˚? @
	connectId
˚˚A J
)
˚˚J K
;
˚˚K L
Result
˝˝ 
<
˝˝ "
EcliptixSessionState
˝˝ #
,
˝˝# $
NetworkFailure
˝˝% 3
>
˝˝3 4
establishResult
˝˝5 D
=
˝˝E F
await
˛˛ 
networkProvider
˛˛ !
.
˛˛! "*
EstablishSecrecyChannelAsync
˛˛" >
(
˛˛> ?
	connectId
˛˛? H
)
˛˛H I
.
˛˛I J
ConfigureAwait
˛˛J X
(
˛˛X Y
false
˛˛Y ^
)
˛˛^ _
;
˛˛_ `
if
ÄÄ 

(
ÄÄ 
establishResult
ÄÄ 
.
ÄÄ 
IsErr
ÄÄ !
)
ÄÄ! "
{
ÅÅ 	
return
ÇÇ 
;
ÇÇ 
}
ÉÉ 	
await
ÖÖ !
RegisterDeviceAsync
ÖÖ !
(
ÖÖ! "
	connectId
ÖÖ" +
,
ÖÖ+ ,
settings
ÖÖ- 5
)
ÖÖ5 6
.
ÖÖ6 7
ConfigureAwait
ÖÖ7 E
(
ÖÖE F
false
ÖÖF K
)
ÖÖK L
;
ÖÖL M
}
ÜÜ 
private
àà 
async
àà 
Task
àà !
RegisterDeviceAsync
àà *
(
àà* +
uint
àà+ /
	connectId
àà0 9
,
àà9 :)
ApplicationInstanceSettings
ââ #
settings
ââ$ ,
)
ââ, -
{
ää 
	AppDevice
ãã 
	appDevice
ãã 
=
ãã 
new
ãã !
(
ãã! "
)
ãã" #
{
åå 	
AppInstanceId
çç 
=
çç 
settings
çç $
.
çç$ %
AppInstanceId
çç% 2
,
çç2 3
DeviceId
éé 
=
éé 
settings
éé 
.
éé  
DeviceId
éé  (
,
éé( )

DeviceType
èè 
=
èè 
	AppDevice
èè "
.
èè" #
Types
èè# (
.
èè( )

DeviceType
èè) 3
.
èè3 4
Desktop
èè4 ;
}
êê 	
;
êê	 

await
íí 
networkProvider
íí 
.
íí &
ExecuteUnaryRequestAsync
íí 6
(
íí6 7
	connectId
ìì 
,
ìì 
RpcServiceType
îî 
.
îî 
RegisterAppDevice
îî ,
,
îî, -%
SecureByteStringInterop
ïï #
.
ïï# $"
WithByteStringAsSpan
ïï$ 8
(
ïï8 9
	appDevice
ïï9 B
.
ïïB C
ToByteString
ïïC O
(
ïïO P
)
ïïP Q
,
ïïQ R
span
ññ 
=>
ññ 
span
ññ 
.
ññ 
ToArray
ññ $
(
ññ$ %
)
ññ% &
)
ññ& '
,
ññ' (
decryptedPayload
óó 
=>
óó 
{
òò (
DeviceRegistrationResponse
ôô *
reply
ôô+ 0
=
ôô1 2
Helpers
öö 
.
öö 
ParseFromBytes
öö *
<
öö* +(
DeviceRegistrationResponse
öö+ E
>
ööE F
(
ööF G
decryptedPayload
ööG W
)
ööW X
;
ööX Y
settings
úú 
.
úú 
ServerPublicKey
úú (
=
úú) *%
SecureByteStringInterop
úú+ B
.
úúB C"
WithByteStringAsSpan
úúC W
(
úúW X
reply
úúX ]
.
úú] ^
ServerPublicKey
úú^ m
,
úúm n

ByteString
ùù 
.
ùù 
CopyFrom
ùù '
)
ùù' (
;
ùù( )
return
üü 
Task
üü 
.
üü 

FromResult
üü &
(
üü& '
Result
üü' -
<
üü- .
Unit
üü. 2
,
üü2 3
NetworkFailure
üü4 B
>
üüB C
.
üüC D
Ok
üüD F
(
üüF G
Unit
üüG K
.
üüK L
Value
üüL Q
)
üüQ R
)
üüR S
;
üüS T
}
†† 
,
†† 
false
†† 
,
†† 
CancellationToken
†† '
.
††' (
None
††( ,
)
††, -
.
††- .
ConfigureAwait
††. <
(
††< =
false
††= B
)
††B C
;
††C D
}
°° 
}¢¢ ÕÉ
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/ApplicationInitializer.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
;% &
public!! 
record!! "
InstanceSettingsResult!! $
(!!$ %'
ApplicationInstanceSettings!!% @
Settings!!A I
,!!I J
bool!!K O
IsNewInstance!!P ]
)!!] ^
;!!^ _
public## 
sealed## 
class## "
ApplicationInitializer## *
(##* +
NetworkProvider$$ 
networkProvider$$ #
,$$# $-
!IApplicationSecureStorageProvider%% %,
 applicationSecureStorageProvider%%& F
,%%F G'
ISecureProtocolStateStorage&& &
secureProtocolStateStorage&&  :
,&&: ; 
ILocalizationService'' 
localizationService'' ,
,'', -!
IIpGeolocationService((  
ipGeolocationService(( .
,((. /
IIdentityService)) 
identityService)) $
,))$ %$
IApplicationStateManager** 
stateManager** )
,**) * 
IStateCleanupService++ 
stateCleanupService++ ,
)++, -
:++. /#
IApplicationInitializer++0 G
{,, 
private// 
const// 
int// *
IP_GEOLOCATION_TIMEOUT_SECONDS// 4
=//5 6
$num//7 9
;//9 :
private11 
readonly11 "
PendingLogoutProcessor11 +#
_pendingLogoutProcessor11, C
=11D E
new11F I
(11I J
networkProvider22 
,22 
new33 '
PendingLogoutRequestStorage33 '
(33' (,
 applicationSecureStorageProvider33( H
)33H I
)33I J
;33J K
public99 

async99 
Task99 
<99 
bool99 
>99 
InitializeAsync99 +
(99+ ,!
DefaultSystemSettings99, A!
defaultSystemSettings99B W
)99W X
{:: 
Result;; 
<;; "
InstanceSettingsResult;; %
,;;% &%
InternalServiceApiFailure;;' @
>;;@ A
settingsResult;;B P
=;;Q R
await<< ,
 applicationSecureStorageProvider<< 2
.<<2 30
$InitApplicationInstanceSettingsAsync<<3 W
(<<W X!
defaultSystemSettings<<X m
.<<m n
CULTURE<<n u
)<<u v
.== 
ConfigureAwait== 
(==  
false==  %
)==% &
;==& '
if?? 

(?? 
settingsResult?? 
.?? 
IsErr??  
)??  !
{@@ 	
returnAA 
falseAA 
;AA 
}BB 	
(DD 	'
ApplicationInstanceSettingsDD	 $
settingsDD% -
,DD- .
boolDD/ 3
isNewInstanceDD4 A
)DDA B
=DDC D
settingsResultDDE S
.DDS T
UnwrapDDT Z
(DDZ [
)DD[ \
;DD\ ]
_FF 	
=FF
 
TaskFF 
.FF 
RunFF 
(FF 
asyncFF 
(FF 
)FF 
=>FF  
{GG 	
awaitHH ,
 applicationSecureStorageProviderHH 2
.HH2 3'
SetApplicationInstanceAsyncHH3 N
(HHN O
isNewInstanceHHO \
)HH\ ]
.HH] ^
ConfigureAwaitHH^ l
(HHl m
falseHHm r
)HHr s
;HHs t
}II 	
)II	 

;II
 
stringKK 
cultureKK 
=KK 
stringKK 
.KK  
IsNullOrEmptyKK  -
(KK- .
settingsKK. 6
.KK6 7
CultureKK7 >
)KK> ?
?LL '
AppCultureSettingsConstantsLL )
.LL) * 
DEFAULT_CULTURE_CODELL* >
:MM 
settingsMM 
.MM 
CultureMM 
;MM 
localizationServiceNN 
.NN 

SetCultureNN &
(NN& '
cultureNN' .
)NN. /
;NN/ 0
ifPP 

(PP 
isNewInstancePP 
)PP 
{QQ 	
_RR 
=RR /
#FetchIpGeolocationInBackgroundAsyncRR 3
(RR3 4
)RR4 5
.RR5 6
ContinueWithRR6 B
(RRB C
taskSS 
=>SS 
{TT 
ifUU 
(UU 
taskUU 
.UU 
	IsFaultedUU &
&&UU' )
taskUU* .
.UU. /
	ExceptionUU/ 8
!=UU9 ;
nullUU< @
)UU@ A
{VV 
SerilogWW 
.WW  
LogWW  #
.WW# $
ErrorWW$ )
(WW) *
taskWW* .
.WW. /
	ExceptionWW/ 8
,WW8 9
$strXX c
)XXc d
;XXd e
}YY 
}ZZ 
,ZZ 
TaskScheduler[[ 
.[[ 
Default[[ %
)[[% &
;[[& '
}\\ 	
Result^^ 
<^^ 
uint^^ 
,^^ 
NetworkFailure^^ #
>^^# $
connectIdResult^^% 4
=^^5 6
await__ %
EnsureSecrecyChannelAsync__ +
(__+ ,
settings__, 4
,__4 5
isNewInstance__6 C
)__C D
.__D E
ConfigureAwait__E S
(__S T
false__T Y
)__Y Z
;__Z [
if`` 

(`` 
connectIdResult`` 
.`` 
IsErr`` !
)``! "
{aa 	
returnbb 
falsebb 
;bb 
}cc 	
uintee 
	connectIdee 
=ee 
connectIdResultee (
.ee( )
Unwrapee) /
(ee/ 0
)ee0 1
;ee1 2
Resultgg 
<gg 
Unitgg 
,gg 
NetworkFailuregg #
>gg# $
registrationResultgg% 7
=gg8 9
awaithh 
RegisterDeviceAsynchh %
(hh% &
	connectIdhh& /
,hh/ 0
settingshh1 9
)hh9 :
.hh: ;
ConfigureAwaithh; I
(hhI J
falsehhJ O
)hhO P
;hhP Q
ifii 

(ii 
registrationResultii 
.ii 
IsErrii $
)ii$ %
{jj 	
Logkk 
.kk 
Errorkk 
(kk 
$strkk g
,kkg h
	connectIdll 
,ll 
registrationResultll -
.ll- .
	UnwrapErrll. 7
(ll7 8
)ll8 9
.ll9 :
Messagell: A
)llA B
;llB C
returnmm 
falsemm 
;mm 
}nn 	
awaitpp -
!ProcessPendingLogoutRequestsAsyncpp /
(pp/ 0
	connectIdpp0 9
)pp9 :
.pp: ;
ConfigureAwaitpp; I
(ppI J
falseppJ O
)ppO P
;ppP Q
returnrr 
truerr 
;rr 
}ss 
privateyy 
asyncyy 
Taskyy -
!ProcessPendingLogoutRequestsAsyncyy 8
(yy8 9
uintyy9 =
	connectIdyy> G
)yyG H
{zz 
try{{ 
{|| 	
await}} #
_pendingLogoutProcessor}} )
.}}) *%
ProcessPendingLogoutAsync}}* C
(}}C D
	connectId}}D M
)}}M N
.}}N O
ConfigureAwait}}O ]
(}}] ^
false}}^ c
)}}c d
;}}d e
}~~ 	
catch 
( 
	Exception 
ex 
) 
{
ÄÄ 	
Log
ÅÅ 
.
ÅÅ 
Error
ÅÅ 
(
ÅÅ 
ex
ÅÅ 
,
ÅÅ 
$str
ÅÅ [
)
ÅÅ[ \
;
ÅÅ\ ]
}
ÇÇ 	
}
ÉÉ 
private
ÖÖ 
Task
ÖÖ 1
#FetchIpGeolocationInBackgroundAsync
ÖÖ 4
(
ÖÖ4 5
)
ÖÖ5 6
=>
ÖÖ7 9
Task
ÜÜ 
.
ÜÜ 
Run
ÜÜ 
(
ÜÜ 
async
ÜÜ 
(
ÜÜ 
)
ÜÜ 
=>
ÜÜ 
{
áá 	
using
àà %
CancellationTokenSource
àà )
cts
àà* -
=
àà. /
new
àà0 3
(
àà3 4
TimeSpan
àà4 <
.
àà< =
FromSeconds
àà= H
(
ààH I,
IP_GEOLOCATION_TIMEOUT_SECONDS
ààI g
)
ààg h
)
ààh i
;
àài j
Result
ââ 
<
ââ 
	IpCountry
ââ 
,
ââ '
InternalServiceApiFailure
ââ 7
>
ââ7 8
countryResult
ââ9 F
=
ââG H
await
ää "
ipGeolocationService
ää *
.
ää* +
GetIpCountryAsync
ää+ <
(
ää< =
cts
ää= @
.
ää@ A
Token
ääA F
)
ääF G
.
ääG H
ConfigureAwait
ääH V
(
ääV W
false
ääW \
)
ää\ ]
;
ää] ^
if
åå 
(
åå 
countryResult
åå 
.
åå 
IsOk
åå "
)
åå" #
{
çç 
	IpCountry
éé 
country
éé !
=
éé" #
countryResult
éé$ 1
.
éé1 2
Unwrap
éé2 8
(
éé8 9
)
éé9 :
;
éé: ;
networkProvider
èè 
.
èè  

SetCountry
èè  *
(
èè* +
country
èè+ 2
.
èè2 3
Country
èè3 :
)
èè: ;
;
èè; <
await
êê .
 applicationSecureStorageProvider
êê 6
.
êê6 7*
SetApplicationIpCountryAsync
êê7 S
(
êêS T
country
êêT [
)
êê[ \
.
êê\ ]
ConfigureAwait
êê] k
(
êêk l
false
êêl q
)
êêq r
;
êêr s
}
ëë 
}
íí 	
)
íí	 

;
íí
 
private
òò 
async
òò 
Task
òò 
<
òò 
Result
òò 
<
òò 
uint
òò "
,
òò" #
NetworkFailure
òò$ 2
>
òò2 3
>
òò3 4'
EnsureSecrecyChannelAsync
òò5 N
(
òòN O)
ApplicationInstanceSettings
ôô #)
applicationInstanceSettings
ôô$ ?
,
ôô? @
bool
ôôA E
isNewInstance
ôôF S
)
ôôS T
{
öö 
uint
õõ 
	connectId
õõ 
=
õõ 
NetworkProvider
úú 
.
úú $
ComputeUniqueConnectId
úú 2
(
úú2 3)
applicationInstanceSettings
úú3 N
,
úúN O 
PubKeyExchangeType
ùù "
.
ùù" #(
DataCenterEphemeralConnect
ùù# =
)
ùù= >
;
ùù> ?
string
üü 
?
üü 
membershipId
üü 
=
üü !
ExtractMembershipId
üü 2
(
üü2 3)
applicationInstanceSettings
üü3 N
)
üüN O
;
üüO P
if
°° 

(
°° 
!
°° 
isNewInstance
°° 
)
°° 
{
¢¢ 	
Result
££ 
<
££ 
uint
££ 
,
££ 
NetworkFailure
££ '
>
££' (
?
££( )
restoreResult
££* 7
=
££8 9
await
§§ ,
TryRestoreExistingSessionAsync
§§ 4
(
§§4 5
	connectId
§§5 >
,
§§> ?)
applicationInstanceSettings
§§@ [
,
§§[ \
membershipId
§§] i
)
§§i j
.
•• 
ConfigureAwait
•• #
(
••# $
false
••$ )
)
••) *
;
••* +
if
ßß 
(
ßß 
restoreResult
ßß 
.
ßß 
HasValue
ßß &
)
ßß& '
{
®® 
return
©© 
restoreResult
©© $
.
©©$ %
Value
©©% *
;
©©* +
}
™™ 
}
´´ 	
return
≠≠ 
await
≠≠ -
EstablishNewSecrecyChannelAsync
≠≠ 4
(
≠≠4 5)
applicationInstanceSettings
≠≠5 P
,
≠≠P Q
	connectId
≠≠R [
,
≠≠[ \
membershipId
≠≠] i
)
≠≠i j
.
ÆÆ 
ConfigureAwait
ÆÆ 
(
ÆÆ 
false
ÆÆ !
)
ÆÆ! "
;
ÆÆ" #
}
ØØ 
private
±± 
static
±± 
string
±± 
?
±± !
ExtractMembershipId
±± .
(
±±. /)
ApplicationInstanceSettings
±±/ J)
applicationInstanceSettings
±±K f
)
±±f g
{
≤≤ 
if
≥≥ 

(
≥≥ )
applicationInstanceSettings
≥≥ '
.
≥≥' (

Membership
≥≥( 2
?
≥≥2 3
.
≥≥3 4
UniqueIdentifier
≥≥4 D
?
≥≥D E
.
≥≥E F
IsEmpty
≥≥F M
is
≥≥N P
false
≥≥Q V
)
≥≥V W
{
¥¥ 	
return
µµ 
Helpers
µµ 
.
µµ "
FromByteStringToGuid
µµ /
(
µµ/ 0)
applicationInstanceSettings
µµ0 K
.
µµK L

Membership
µµL V
.
µµV W
UniqueIdentifier
µµW g
)
µµg h
.
µµh i
ToString
µµi q
(
µµq r
)
µµr s
;
µµs t
}
∂∂ 	
return
∏∏ 
null
∏∏ 
;
∏∏ 
}
ππ 
private
ªª 
async
ªª 
Task
ªª 
<
ªª 
Result
ªª 
<
ªª 
uint
ªª "
,
ªª" #
NetworkFailure
ªª$ 2
>
ªª2 3
?
ªª3 4
>
ªª4 5,
TryRestoreExistingSessionAsync
ªª6 T
(
ªªT U
uint
ºº 
	connectId
ºº 
,
ºº )
ApplicationInstanceSettings
ΩΩ #)
applicationInstanceSettings
ΩΩ$ ?
,
ΩΩ? @
string
ææ 
?
ææ 
membershipId
ææ 
)
ææ 
{
øø 
Result
¿¿ 
<
¿¿ 
bool
¿¿ 
,
¿¿ 
NetworkFailure
¿¿ #
>
¿¿# $
restoreResult
¿¿% 2
=
¿¿3 4
await
¡¡ )
TryRestoreSessionStateAsync
¡¡ -
(
¡¡- .
	connectId
¡¡. 7
,
¡¡7 8)
applicationInstanceSettings
¡¡9 T
)
¡¡T U
.
¡¡U V
ConfigureAwait
¡¡V d
(
¡¡d e
false
¡¡e j
)
¡¡j k
;
¡¡k l
if
√√ 

(
√√ 
restoreResult
√√ 
.
√√ 
IsErr
√√ 
)
√√  
{
ƒƒ 	
return
≈≈ 
Result
≈≈ 
<
≈≈ 
uint
≈≈ 
,
≈≈ 
NetworkFailure
≈≈  .
>
≈≈. /
.
≈≈/ 0
Err
≈≈0 3
(
≈≈3 4
restoreResult
≈≈4 A
.
≈≈A B
	UnwrapErr
≈≈B K
(
≈≈K L
)
≈≈L M
)
≈≈M N
;
≈≈N O
}
∆∆ 	
if
»» 

(
»» 
!
»» 
restoreResult
»» 
.
»» 
Unwrap
»» !
(
»»! "
)
»»" #
)
»»# $
{
…… 	
return
   
null
   
;
   
}
ÀÀ 	
if
ÕÕ 

(
ÕÕ 
!
ÕÕ 
string
ÕÕ 
.
ÕÕ 
IsNullOrEmpty
ÕÕ !
(
ÕÕ! "
membershipId
ÕÕ" .
)
ÕÕ. /
&&
ÕÕ0 2
await
ŒŒ 
identityService
ŒŒ !
.
ŒŒ! "$
HasStoredIdentityAsync
ŒŒ" 8
(
ŒŒ8 9
membershipId
ŒŒ9 E
)
ŒŒE F
.
ŒŒF G
ConfigureAwait
ŒŒG U
(
ŒŒU V
false
ŒŒV [
)
ŒŒ[ \
)
ŒŒ\ ]
{
œœ 	
await
–– 
stateManager
–– 
.
–– ,
TransitionToAuthenticatedAsync
–– =
(
––= >
membershipId
––> J
)
––J K
.
––K L
ConfigureAwait
––L Z
(
––Z [
false
––[ `
)
––` a
;
––a b
}
—— 	
return
”” 
Result
”” 
<
”” 
uint
”” 
,
”” 
NetworkFailure
”” *
>
””* +
.
””+ ,
Ok
””, .
(
””. /
	connectId
””/ 8
)
””8 9
;
””9 :
}
‘‘ 
private
÷÷ 
async
÷÷ 
Task
÷÷ 
<
÷÷ 
Result
÷÷ 
<
÷÷ 
uint
÷÷ "
,
÷÷" #
NetworkFailure
÷÷$ 2
>
÷÷2 3
>
÷÷3 4-
EstablishNewSecrecyChannelAsync
÷÷5 T
(
÷÷T U)
ApplicationInstanceSettings
◊◊ #)
applicationInstanceSettings
◊◊$ ?
,
◊◊? @
uint
ÿÿ 
	connectId
ÿÿ 
,
ÿÿ 
string
ŸŸ 
?
ŸŸ 
membershipId
ŸŸ 
)
ŸŸ 
{
⁄⁄ 
Option
€€ 
<
€€ &
SodiumSecureMemoryHandle
€€ '
>
€€' (
masterKeyHandle
€€) 8
=
€€9 :
await
€€; @)
PrepareMasterKeyHandleAsync
€€A \
(
€€\ ]
membershipId
€€] i
,
€€i j*
applicationInstanceSettings€€k Ü
)€€Ü á
.
‹‹ 
ConfigureAwait
‹‹ 
(
‹‹ 
false
‹‹ !
)
‹‹! "
;
‹‹" #
try
ﬁﬁ 
{
ﬂﬂ 	
bool
‡‡ ,
shouldUseAuthenticatedProtocol
‡‡ /
=
‡‡0 1
masterKeyHandle
‡‡2 A
.
‡‡A B
IsSome
‡‡B H
;
‡‡H I
if
‚‚ 
(
‚‚ ,
shouldUseAuthenticatedProtocol
‚‚ .
)
‚‚. /
{
„„ 
Result
‰‰ 
<
‰‰ 
uint
‰‰ 
,
‰‰ 
NetworkFailure
‰‰ +
>
‰‰+ ,
?
‰‰, -!
authenticatedResult
‰‰. A
=
‰‰B C
await
ÂÂ .
 TryUseAuthenticatedProtocolAsync
ÂÂ :
(
ÂÂ: ;)
applicationInstanceSettings
ÊÊ 3
,
ÊÊ3 4
	connectId
ÁÁ !
,
ÁÁ! "
membershipId
ËË $
!
ËË$ %
,
ËË% &
masterKeyHandle
ÈÈ '
.
ÈÈ' (
Value
ÈÈ( -
!
ÈÈ- .
)
ÈÈ. /
.
ÍÍ 
ConfigureAwait
ÍÍ #
(
ÍÍ# $
false
ÍÍ$ )
)
ÍÍ) *
;
ÍÍ* +
if
ÏÏ 
(
ÏÏ !
authenticatedResult
ÏÏ '
.
ÏÏ' (
HasValue
ÏÏ( 0
)
ÏÏ0 1
{
ÌÌ 
return
ÓÓ !
authenticatedResult
ÓÓ .
.
ÓÓ. /
Value
ÓÓ/ 4
;
ÓÓ4 5
}
ÔÔ 
}
 
await
ÚÚ 4
&InitializeProtocolWithoutIdentityAsync
ÚÚ 8
(
ÚÚ8 9)
applicationInstanceSettings
ÚÚ9 T
,
ÚÚT U
	connectId
ÚÚV _
)
ÚÚ_ `
.
ÛÛ 
ConfigureAwait
ÛÛ 
(
ÛÛ  
false
ÛÛ  %
)
ÛÛ% &
;
ÛÛ& '
byte
ıı 
[
ıı 
]
ıı 
?
ıı 
membershipIdBytes
ıı %
=
ıı& ')
applicationInstanceSettings
ıı( C
.
ııC D

Membership
ııD N
?
ııN O
.
ııO P
UniqueIdentifier
ııP `
?
ıı` a
.
ııa b
ToByteArray
ııb m
(
ıım n
)
ıın o
;
ııo p
return
ˆˆ 
await
ˆˆ 1
#EstablishAndSaveSecrecyChannelAsync
ˆˆ <
(
ˆˆ< =
	connectId
ˆˆ= F
,
ˆˆF G
membershipIdBytes
ˆˆH Y
)
ˆˆY Z
.
ˆˆZ [
ConfigureAwait
ˆˆ[ i
(
ˆˆi j
false
ˆˆj o
)
ˆˆo p
;
ˆˆp q
}
˜˜ 	
finally
¯¯ 
{
˘˘ 	
masterKeyHandle
˙˙ 
.
˙˙ 
Do
˙˙ 
(
˙˙ 
handle
˙˙ %
=>
˙˙& (
handle
˙˙) /
.
˙˙/ 0
Dispose
˙˙0 7
(
˙˙7 8
)
˙˙8 9
)
˙˙9 :
;
˙˙: ;
}
˚˚ 	
}
¸¸ 
private
˛˛ 
async
˛˛ 
Task
˛˛ 
<
˛˛ 
Option
˛˛ 
<
˛˛ &
SodiumSecureMemoryHandle
˛˛ 6
>
˛˛6 7
>
˛˛7 8)
PrepareMasterKeyHandleAsync
˛˛9 T
(
˛˛T U
string
ˇˇ 
?
ˇˇ 
membershipId
ˇˇ 
,
ˇˇ )
ApplicationInstanceSettings
ÄÄ #)
applicationInstanceSettings
ÄÄ$ ?
)
ÄÄ? @
{
ÅÅ 
if
ÇÇ 

(
ÇÇ 
string
ÇÇ 
.
ÇÇ 
IsNullOrEmpty
ÇÇ  
(
ÇÇ  !
membershipId
ÇÇ! -
)
ÇÇ- .
)
ÇÇ. /
{
ÉÉ 	
return
ÑÑ 
Option
ÑÑ 
<
ÑÑ &
SodiumSecureMemoryHandle
ÑÑ 2
>
ÑÑ2 3
.
ÑÑ3 4
None
ÑÑ4 8
;
ÑÑ8 9
}
ÖÖ 	
bool
áá 
hasStoredIdentity
áá 
=
áá  
await
áá! &
identityService
áá' 6
.
áá6 7$
HasStoredIdentityAsync
áá7 M
(
ááM N
membershipId
ááN Z
)
ááZ [
.
áá[ \
ConfigureAwait
áá\ j
(
ááj k
false
áák p
)
ááp q
;
ááq r
if
àà 

(
àà 
!
àà 
hasStoredIdentity
àà 
)
àà 
{
ââ 	
return
ää 
Option
ää 
<
ää &
SodiumSecureMemoryHandle
ää 2
>
ää2 3
.
ää3 4
None
ää4 8
;
ää8 9
}
ãã 	
return
çç 
await
çç *
TryReconstructMasterKeyAsync
çç 1
(
çç1 2
membershipId
çç2 >
,
çç> ?)
applicationInstanceSettings
çç@ [
)
çç[ \
.
éé 
ConfigureAwait
éé 
(
éé 
false
éé !
)
éé! "
;
éé" #
}
èè 
private
ëë 
async
ëë 
Task
ëë 
<
ëë 
Result
ëë 
<
ëë 
uint
ëë "
,
ëë" #
NetworkFailure
ëë$ 2
>
ëë2 3
?
ëë3 4
>
ëë4 5.
 TryUseAuthenticatedProtocolAsync
ëë6 V
(
ëëV W)
ApplicationInstanceSettings
íí #)
applicationInstanceSettings
íí$ ?
,
íí? @
uint
ìì 
	connectId
ìì 
,
ìì 
string
îî 
membershipId
îî 
,
îî &
SodiumSecureMemoryHandle
ïï  
masterKeyHandle
ïï! 0
)
ïï0 1
{
ññ 
if
óó 

(
óó )
applicationInstanceSettings
óó '
.
óó' (

Membership
óó( 2
?
óó2 3
.
óó3 4
UniqueIdentifier
óó4 D
==
óóE G
null
óóH L
)
óóL M
{
òò 	
return
ôô 
Result
ôô 
<
ôô 
uint
ôô 
,
ôô 
NetworkFailure
ôô  .
>
ôô. /
.
ôô/ 0
Err
ôô0 3
(
ôô3 4
NetworkFailure
öö 
.
öö  
InvalidRequestType
öö 1
(
öö1 2
$str
õõ R
)
õõR S
)
õõS T
;
õõT U
}
úú 	

ByteString
ûû "
membershipByteString
ûû '
=
ûû( ))
applicationInstanceSettings
ûû* E
.
ûûE F

Membership
ûûF P
.
ûûP Q
UniqueIdentifier
ûûQ a
;
ûûa b
Result
†† 
<
†† 
Unit
†† 
,
†† 
NetworkFailure
†† #
>
††# $
recreateResult
††% 3
=
††4 5
await
°° 
networkProvider
°° !
.
°°! "0
"RecreateProtocolWithMasterKeyAsync
°°" D
(
°°D E
masterKeyHandle
¢¢ 
,
¢¢  "
membershipByteString
¢¢! 5
,
¢¢5 6
	connectId
¢¢7 @
)
¢¢@ A
.
¢¢A B
ConfigureAwait
¢¢B P
(
¢¢P Q
false
¢¢Q V
)
¢¢V W
;
¢¢W X
if
§§ 

(
§§ 
recreateResult
§§ 
.
§§ 
IsErr
§§  
)
§§  !
{
•• 	
await
¶¶ 5
'HandleAuthenticatedProtocolFailureAsync
¶¶ 9
(
¶¶9 :
recreateResult
¶¶: H
.
¶¶H I
	UnwrapErr
¶¶I R
(
¶¶R S
)
¶¶S T
,
¶¶T U
membershipId
¶¶V b
,
¶¶b c)
applicationInstanceSettings
¶¶d 
,¶¶ Ä
	connectId¶¶Å ä
)¶¶ä ã
.
ßß 
ConfigureAwait
ßß 
(
ßß  
false
ßß  %
)
ßß% &
;
ßß& '
return
®® 
null
®® 
;
®® 
}
©© 	
await
´´ 
stateManager
´´ 
.
´´ ,
TransitionToAuthenticatedAsync
´´ 9
(
´´9 :
membershipId
´´: F
)
´´F G
.
´´G H
ConfigureAwait
´´H V
(
´´V W
false
´´W \
)
´´\ ]
;
´´] ^
return
¨¨ 
Result
¨¨ 
<
¨¨ 
uint
¨¨ 
,
¨¨ 
NetworkFailure
¨¨ *
>
¨¨* +
.
¨¨+ ,
Ok
¨¨, .
(
¨¨. /
	connectId
¨¨/ 8
)
¨¨8 9
;
¨¨9 :
}
≠≠ 
private
ØØ 
async
ØØ 
Task
ØØ 5
'HandleAuthenticatedProtocolFailureAsync
ØØ >
(
ØØ> ?
NetworkFailure
∞∞ 
failure
∞∞ 
,
∞∞ 
string
±± 
membershipId
±± 
,
±± )
ApplicationInstanceSettings
≤≤ #)
applicationInstanceSettings
≤≤$ ?
,
≤≤? @
uint
≥≥ 
	connectId
≥≥ 
)
≥≥ 
{
¥¥ 
if
µµ 

(
µµ 
failure
µµ 
.
µµ 
FailureType
µµ 
==
µµ  " 
NetworkFailureType
µµ# 5
.
µµ5 6+
CriticalAuthenticationFailure
µµ6 S
)
µµS T
{
∂∂ 	
await
∑∑ /
!CleanupCorruptedIdentityDataAsync
∑∑ 3
(
∑∑3 4
membershipId
∑∑4 @
,
∑∑@ A)
applicationInstanceSettings
∑∑B ]
)
∑∑] ^
.
∏∏ 
ConfigureAwait
∏∏ 
(
∏∏  
false
∏∏  %
)
∏∏% &
;
∏∏& '
}
ππ 	
await
ªª 4
&InitializeProtocolWithoutIdentityAsync
ªª 4
(
ªª4 5)
applicationInstanceSettings
ªª5 P
,
ªªP Q
	connectId
ªªR [
)
ªª[ \
.
ºº 
ConfigureAwait
ºº 
(
ºº 
false
ºº !
)
ºº! "
;
ºº" #
}
ΩΩ 
private
øø 
async
øø 
Task
øø 
<
øø 
Result
øø 
<
øø 
uint
øø "
,
øø" #
NetworkFailure
øø$ 2
>
øø2 3
>
øø3 41
#EstablishAndSaveSecrecyChannelAsync
øø5 X
(
øøX Y
uint
øøY ]
	connectId
øø^ g
,
øøg h
byte
¿¿ 
[
¿¿ 
]
¿¿ 
?
¿¿ 
membershipId
¿¿ 
)
¿¿ 
{
¡¡ 
Result
¬¬ 
<
¬¬ "
EcliptixSessionState
¬¬ #
,
¬¬# $
NetworkFailure
¬¬% 3
>
¬¬3 4
establishResult
¬¬5 D
=
¬¬E F
await
√√ 
networkProvider
√√ !
.
√√! "*
EstablishSecrecyChannelAsync
√√" >
(
√√> ?
	connectId
√√? H
)
√√H I
.
√√I J
ConfigureAwait
√√J X
(
√√X Y
false
√√Y ^
)
√√^ _
;
√√_ `
if
≈≈ 

(
≈≈ 
establishResult
≈≈ 
.
≈≈ 
IsErr
≈≈ !
)
≈≈! "
{
∆∆ 	
return
«« 
Result
«« 
<
«« 
uint
«« 
,
«« 
NetworkFailure
««  .
>
««. /
.
««/ 0
Err
««0 3
(
««3 4
establishResult
««4 C
.
««C D
	UnwrapErr
««D M
(
««M N
)
««N O
)
««O P
;
««P Q
}
»» 	"
EcliptixSessionState
   !
secrecyChannelState
   0
=
  1 2
establishResult
  3 B
.
  B C
Unwrap
  C I
(
  I J
)
  J K
;
  K L
if
ÃÃ 

(
ÃÃ 
membershipId
ÃÃ 
!=
ÃÃ 
null
ÃÃ  
)
ÃÃ  !
{
ÕÕ 	
await
ŒŒ %
SecureByteStringInterop
ŒŒ )
.
ŒŒ) *"
WithByteStringAsSpan
ŒŒ* >
(
ŒŒ> ?!
secrecyChannelState
œœ '
.
œœ' (
ToByteString
œœ( 4
(
œœ4 5
)
œœ5 6
,
œœ6 7
span
–– 
=>
–– (
secureProtocolStateStorage
–– 6
.
––6 7
SaveStateAsync
––7 E
(
––E F
span
––F J
.
––J K
ToArray
––K R
(
––R S
)
––S T
,
––T U
	connectId
––V _
.
––_ `
ToString
––` h
(
––h i
)
––i j
,
––j k
membershipId
—— $
)
——$ %
)
——% &
.
““ 
ConfigureAwait
““ 
(
““  
false
““  %
)
““% &
;
““& '
}
”” 	
return
’’ 
Result
’’ 
<
’’ 
uint
’’ 
,
’’ 
NetworkFailure
’’ *
>
’’* +
.
’’+ ,
Ok
’’, .
(
’’. /
	connectId
’’/ 8
)
’’8 9
;
’’9 :
}
÷÷ 
private
ÿÿ 
async
ÿÿ 
Task
ÿÿ 4
&InitializeProtocolWithoutIdentityAsync
ÿÿ =
(
ÿÿ= >)
ApplicationInstanceSettings
ŸŸ #)
applicationInstanceSettings
ŸŸ$ ?
,
ŸŸ? @
uint
⁄⁄ 
	connectId
⁄⁄ 
)
⁄⁄ 
{
€€ 
await
‹‹ 
stateManager
‹‹ 
.
‹‹ (
TransitionToAnonymousAsync
‹‹ 5
(
‹‹5 6
)
‹‹6 7
.
‹‹7 8
ConfigureAwait
‹‹8 F
(
‹‹F G
false
‹‹G L
)
‹‹L M
;
‹‹M N
if
ﬁﬁ 

(
ﬁﬁ )
applicationInstanceSettings
ﬁﬁ '
.
ﬁﬁ' (

Membership
ﬁﬁ( 2
!=
ﬁﬁ3 5
null
ﬁﬁ6 :
)
ﬁﬁ: ;
{
ﬂﬂ 	
await
‡‡ .
 applicationSecureStorageProvider
‡‡ 2
.
‡‡2 3+
SetApplicationMembershipAsync
‡‡3 P
(
‡‡P Q
null
‡‡Q U
)
‡‡U V
.
‡‡V W
ConfigureAwait
‡‡W e
(
‡‡e f
false
‡‡f k
)
‡‡k l
;
‡‡l m)
applicationInstanceSettings
‚‚ '
.
‚‚' (

Membership
‚‚( 2
=
‚‚3 4
null
‚‚5 9
;
‚‚9 :
}
„„ 	
networkProvider
ÂÂ 
.
ÂÂ ,
InitiateEcliptixProtocolSystem
ÂÂ 6
(
ÂÂ6 7)
applicationInstanceSettings
ÂÂ7 R
,
ÂÂR S
	connectId
ÂÂT ]
)
ÂÂ] ^
;
ÂÂ^ _
}
ÊÊ 
private
ÏÏ 
async
ÏÏ 
Task
ÏÏ 
<
ÏÏ 
Result
ÏÏ 
<
ÏÏ 
bool
ÏÏ "
,
ÏÏ" #
NetworkFailure
ÏÏ$ 2
>
ÏÏ2 3
>
ÏÏ3 4)
TryRestoreSessionStateAsync
ÏÏ5 P
(
ÏÏP Q
uint
ÌÌ 
	connectId
ÌÌ 
,
ÌÌ )
ApplicationInstanceSettings
ÓÓ #)
applicationInstanceSettings
ÓÓ$ ?
)
ÓÓ? @
{
ÔÔ 
byte
 
[
 
]
 
?
 
membershipId
 
=
 )
applicationInstanceSettings
 :
.
: ;

Membership
; E
?
E F
.
F G
UniqueIdentifier
G W
?
W X
.
X Y
ToByteArray
Y d
(
d e
)
e f
;
f g
if
ÒÒ 

(
ÒÒ 
membershipId
ÒÒ 
==
ÒÒ 
null
ÒÒ  
)
ÒÒ  !
{
ÚÚ 	
return
ÛÛ 
Result
ÛÛ 
<
ÛÛ 
bool
ÛÛ 
,
ÛÛ 
NetworkFailure
ÛÛ  .
>
ÛÛ. /
.
ÛÛ/ 0
Ok
ÛÛ0 2
(
ÛÛ2 3
false
ÛÛ3 8
)
ÛÛ8 9
;
ÛÛ9 :
}
ÙÙ 	
Result
ˆˆ 
<
ˆˆ 
byte
ˆˆ 
[
ˆˆ 
]
ˆˆ 
,
ˆˆ "
SecureStorageFailure
ˆˆ +
>
ˆˆ+ ,

loadResult
ˆˆ- 7
=
ˆˆ8 9
await
˜˜ (
secureProtocolStateStorage
˜˜ ,
.
˜˜, -
LoadStateAsync
˜˜- ;
(
˜˜; <
	connectId
˜˜< E
.
˜˜E F
ToString
˜˜F N
(
˜˜N O
)
˜˜O P
,
˜˜P Q
membershipId
˜˜R ^
)
˜˜^ _
.
˜˜_ `
ConfigureAwait
˜˜` n
(
˜˜n o
false
˜˜o t
)
˜˜t u
;
˜˜u v
if
˘˘ 

(
˘˘ 

loadResult
˘˘ 
.
˘˘ 
IsErr
˘˘ 
)
˘˘ 
{
˙˙ 	
return
˚˚ 
Result
˚˚ 
<
˚˚ 
bool
˚˚ 
,
˚˚ 
NetworkFailure
˚˚  .
>
˚˚. /
.
˚˚/ 0
Ok
˚˚0 2
(
˚˚2 3
false
˚˚3 8
)
˚˚8 9
;
˚˚9 :
}
¸¸ 	
byte
˛˛ 
[
˛˛ 
]
˛˛ 

stateBytes
˛˛ 
=
˛˛ 

loadResult
˛˛ &
.
˛˛& '
Unwrap
˛˛' -
(
˛˛- .
)
˛˛. /
;
˛˛/ 0"
EcliptixSessionState
ÄÄ 
?
ÄÄ 
state
ÄÄ #
;
ÄÄ# $
try
ÅÅ 
{
ÇÇ 	
state
ÉÉ 
=
ÉÉ "
EcliptixSessionState
ÉÉ (
.
ÉÉ( )
Parser
ÉÉ) /
.
ÉÉ/ 0
	ParseFrom
ÉÉ0 9
(
ÉÉ9 :

stateBytes
ÉÉ: D
)
ÉÉD E
;
ÉÉE F
}
ÑÑ 	
catch
ÖÖ 
(
ÖÖ ,
InvalidProtocolBufferException
ÖÖ -
ex
ÖÖ. 0
)
ÖÖ0 1
{
ÜÜ 	
networkProvider
áá 
.
áá 
ClearConnection
áá +
(
áá+ ,
	connectId
áá, 5
)
áá5 6
;
áá6 7
Result
àà 
<
àà 
Unit
àà 
,
àà "
SecureStorageFailure
àà -
>
àà- .%
deleteSecureStateResult
àà/ F
=
ààG H
await
ââ (
secureProtocolStateStorage
ââ 0
.
ââ0 1
DeleteStateAsync
ââ1 A
(
ââA B
	connectId
ââB K
.
ââK L
ToString
ââL T
(
ââT U
)
ââU V
)
ââV W
.
ââW X
ConfigureAwait
ââX f
(
ââf g
false
ââg l
)
ââl m
;
ââm n
if
ää 
(
ää %
deleteSecureStateResult
ää '
.
ää' (
IsErr
ää( -
)
ää- .
{
ãã 
Log
åå 
.
åå 
Warning
åå 
(
åå 
ex
åå 
,
åå 
$str
çç w
,
ççw x
	connectId
éé 
,
éé %
deleteSecureStateResult
éé 6
.
éé6 7
	UnwrapErr
éé7 @
(
éé@ A
)
ééA B
.
ééB C
Message
ééC J
)
ééJ K
;
ééK L
}
èè 
return
ëë 
Result
ëë 
<
ëë 
bool
ëë 
,
ëë 
NetworkFailure
ëë  .
>
ëë. /
.
ëë/ 0
Ok
ëë0 2
(
ëë2 3
false
ëë3 8
)
ëë8 9
;
ëë9 :
}
íí 	
string
îî  
membershipIdString
îî !
=
îî" #%
SecureByteStringInterop
îî$ ;
.
îî; <"
WithByteStringAsSpan
îî< P
(
îîP Q)
applicationInstanceSettings
ïï '
.
ïï' (

Membership
ïï( 2
!
ïï2 3
.
ïï3 4
UniqueIdentifier
ïï4 D
!
ïïD E
,
ïïE F
span
ññ 
=>
ññ 
new
ññ 
Guid
ññ 
(
ññ 
span
ññ !
.
ññ! "
ToArray
ññ" )
(
ññ) *
)
ññ* +
)
ññ+ ,
.
ññ, -
ToString
ññ- 5
(
ññ5 6
)
ññ6 7
)
ññ7 8
;
ññ8 9
bool
òò  
hasRevocationProof
òò 
=
òò  !
await
òò" '
LogoutService
òò( 5
.
òò5 6%
HasRevocationProofAsync
òò6 M
(
òòM N.
 applicationSecureStorageProvider
ôô ,
,
ôô, - 
membershipIdString
öö 
)
öö 
.
öö  
ConfigureAwait
öö  .
(
öö. /
false
öö/ 4
)
öö4 5
;
öö5 6
if
úú 

(
úú  
hasRevocationProof
úú 
)
úú 
{
ùù 	
networkProvider
ûû 
.
ûû 
ClearConnection
ûû +
(
ûû+ ,
	connectId
ûû, 5
)
ûû5 6
;
ûû6 7
await
üü (
secureProtocolStateStorage
üü ,
.
üü, -
DeleteStateAsync
üü- =
(
üü= >
	connectId
üü> G
.
üüG H
ToString
üüH P
(
üüP Q
)
üüQ R
)
üüR S
.
üüS T
ConfigureAwait
üüT b
(
üüb c
false
üüc h
)
üüh i
;
üüi j
return
°° 
Result
°° 
<
°° 
bool
°° 
,
°° 
NetworkFailure
°°  .
>
°°. /
.
°°/ 0
Ok
°°0 2
(
°°2 3
false
°°3 8
)
°°8 9
;
°°9 :
}
¢¢ 	
Result
§§ 
<
§§ 
bool
§§ 
,
§§ 
NetworkFailure
§§ #
>
§§# $
restoreResult
§§% 2
=
§§3 4
await
•• 
networkProvider
•• !
.
••! "(
RestoreSecrecyChannelAsync
••" <
(
••< =
state
••= B
,
••B C)
applicationInstanceSettings
••D _
)
••_ `
.
••` a
ConfigureAwait
••a o
(
••o p
false
••p u
)
••u v
;
••v w
if
ßß 

(
ßß 
restoreResult
ßß 
.
ßß 
IsErr
ßß 
)
ßß  
{
®® 	
networkProvider
©© 
.
©© 
ClearConnection
©© +
(
©©+ ,
	connectId
©©, 5
)
©©5 6
;
©©6 7
await
™™ (
secureProtocolStateStorage
™™ ,
.
™™, -
DeleteStateAsync
™™- =
(
™™= >
	connectId
™™> G
.
™™G H
ToString
™™H P
(
™™P Q
)
™™Q R
)
™™R S
.
™™S T
ConfigureAwait
™™T b
(
™™b c
false
™™c h
)
™™h i
;
™™i j
return
¨¨ 
Result
¨¨ 
<
¨¨ 
bool
¨¨ 
,
¨¨ 
NetworkFailure
¨¨  .
>
¨¨. /
.
¨¨/ 0
Ok
¨¨0 2
(
¨¨2 3
false
¨¨3 8
)
¨¨8 9
;
¨¨9 :
}
≠≠ 	
if
ØØ 

(
ØØ 
restoreResult
ØØ 
.
ØØ 
Unwrap
ØØ  
(
ØØ  !
)
ØØ! "
)
ØØ" #
{
∞∞ 	
return
±± 
Result
±± 
<
±± 
bool
±± 
,
±± 
NetworkFailure
±±  .
>
±±. /
.
±±/ 0
Ok
±±0 2
(
±±2 3
true
±±3 7
)
±±7 8
;
±±8 9
}
≤≤ 	
networkProvider
¥¥ 
.
¥¥ 
ClearConnection
¥¥ '
(
¥¥' (
	connectId
¥¥( 1
)
¥¥1 2
;
¥¥2 3
await
µµ (
secureProtocolStateStorage
µµ (
.
µµ( )
DeleteStateAsync
µµ) 9
(
µµ9 :
	connectId
µµ: C
.
µµC D
ToString
µµD L
(
µµL M
)
µµM N
)
µµN O
.
µµO P
ConfigureAwait
µµP ^
(
µµ^ _
false
µµ_ d
)
µµd e
;
µµe f
return
∑∑ 
Result
∑∑ 
<
∑∑ 
bool
∑∑ 
,
∑∑ 
NetworkFailure
∑∑ *
>
∑∑* +
.
∑∑+ ,
Ok
∑∑, .
(
∑∑. /
false
∑∑/ 4
)
∑∑4 5
;
∑∑5 6
}
∏∏ 
private
ææ 
async
ææ 
Task
ææ 
<
ææ 
Option
ææ 
<
ææ &
SodiumSecureMemoryHandle
ææ 6
>
ææ6 7
>
ææ7 8.
 TryLoadMasterKeyFromStorageAsync
ææ9 Y
(
ææY Z
string
ææZ `
membershipId
ææa m
)
ææm n
{
øø 
Result
¿¿ 
<
¿¿ &
SodiumSecureMemoryHandle
¿¿ '
,
¿¿' (#
AuthenticationFailure
¿¿) >
>
¿¿> ?

loadResult
¿¿@ J
=
¿¿K L
await
¡¡ 
identityService
¡¡ !
.
¡¡! "&
LoadMasterKeyHandleAsync
¡¡" :
(
¡¡: ;
membershipId
¡¡; G
)
¡¡G H
.
¡¡H I
ConfigureAwait
¡¡I W
(
¡¡W X
false
¡¡X ]
)
¡¡] ^
;
¡¡^ _
if
√√ 

(
√√ 

loadResult
√√ 
.
√√ 
IsErr
√√ 
)
√√ 
{
ƒƒ 	
return
≈≈ 
Option
≈≈ 
<
≈≈ &
SodiumSecureMemoryHandle
≈≈ 2
>
≈≈2 3
.
≈≈3 4
None
≈≈4 8
;
≈≈8 9
}
∆∆ 	&
SodiumSecureMemoryHandle
»»  
loadedHandle
»»! -
=
»». /

loadResult
»»0 :
.
»»: ;
Unwrap
»»; A
(
»»A B
)
»»B C
;
»»C D
Result
   
<
   
byte
   
[
   
]
   
,
   
Ecliptix
   
.
    
	Utilities
    )
.
  ) *
Failures
  * 2
.
  2 3
Sodium
  3 9
.
  9 :
SodiumFailure
  : G
>
  G H

readResult
  I S
=
  T U
loadedHandle
ÀÀ 
.
ÀÀ 
	ReadBytes
ÀÀ "
(
ÀÀ" #
loadedHandle
ÀÀ# /
.
ÀÀ/ 0
Length
ÀÀ0 6
)
ÀÀ6 7
;
ÀÀ7 8
if
ÃÃ 

(
ÃÃ 
!
ÃÃ 

readResult
ÃÃ 
.
ÃÃ 
IsOk
ÃÃ 
)
ÃÃ 
{
ÕÕ 	
return
ŒŒ 
Option
ŒŒ 
<
ŒŒ &
SodiumSecureMemoryHandle
ŒŒ 2
>
ŒŒ2 3
.
ŒŒ3 4
Some
ŒŒ4 8
(
ŒŒ8 9
loadedHandle
ŒŒ9 E
)
ŒŒE F
;
ŒŒF G
}
œœ 	
byte
—— 
[
—— 
]
—— 
masterKeyBytes
—— 
=
—— 

readResult
——  *
.
——* +
Unwrap
——+ 1
(
——1 2
)
——2 3
;
——3 4%
CryptographicOperations
““ 
.
““  

ZeroMemory
““  *
(
““* +
masterKeyBytes
““+ 9
)
““9 :
;
““: ;
return
‘‘ 
Option
‘‘ 
<
‘‘ &
SodiumSecureMemoryHandle
‘‘ .
>
‘‘. /
.
‘‘/ 0
Some
‘‘0 4
(
‘‘4 5
loadedHandle
‘‘5 A
)
‘‘A B
;
‘‘B C
}
’’ 
private
◊◊ 
async
◊◊ 
Task
◊◊ 
<
◊◊ 
Option
◊◊ 
<
◊◊ &
SodiumSecureMemoryHandle
◊◊ 6
>
◊◊6 7
>
◊◊7 8*
TryReconstructMasterKeyAsync
◊◊9 U
(
◊◊U V
string
ÿÿ 
membershipId
ÿÿ 
,
ÿÿ )
ApplicationInstanceSettings
ŸŸ #)
applicationInstanceSettings
ŸŸ$ ?
)
ŸŸ? @
{
⁄⁄ 
Option
€€ 
<
€€ &
SodiumSecureMemoryHandle
€€ '
>
€€' (
storageHandle
€€) 6
=
€€7 8
await
‹‹ .
 TryLoadMasterKeyFromStorageAsync
‹‹ 2
(
‹‹2 3
membershipId
‹‹3 ?
)
‹‹? @
.
‹‹@ A
ConfigureAwait
‹‹A O
(
‹‹O P
false
‹‹P U
)
‹‹U V
;
‹‹V W
if
ﬁﬁ 

(
ﬁﬁ 
storageHandle
ﬁﬁ 
.
ﬁﬁ 
IsSome
ﬁﬁ  
)
ﬁﬁ  !
{
ﬂﬂ 	
return
‡‡ 
storageHandle
‡‡  
;
‡‡  !
}
·· 	
await
„„ /
!CleanupCorruptedIdentityDataAsync
„„ /
(
„„/ 0
membershipId
„„0 <
,
„„< =)
applicationInstanceSettings
„„> Y
)
„„Y Z
.
„„Z [
ConfigureAwait
„„[ i
(
„„i j
false
„„j o
)
„„o p
;
„„p q
return
ÂÂ 
Option
ÂÂ 
<
ÂÂ &
SodiumSecureMemoryHandle
ÂÂ .
>
ÂÂ. /
.
ÂÂ/ 0
None
ÂÂ0 4
;
ÂÂ4 5
}
ÊÊ 
private
ÏÏ 
async
ÏÏ 
Task
ÏÏ 
<
ÏÏ 
Result
ÏÏ 
<
ÏÏ 
Unit
ÏÏ "
,
ÏÏ" #
NetworkFailure
ÏÏ$ 2
>
ÏÏ2 3
>
ÏÏ3 4!
RegisterDeviceAsync
ÏÏ5 H
(
ÏÏH I
uint
ÏÏI M
	connectId
ÏÏN W
,
ÏÏW X)
ApplicationInstanceSettings
ÌÌ #
settings
ÌÌ$ ,
)
ÌÌ, -
{
ÓÓ 
	AppDevice
ÔÔ 
	appDevice
ÔÔ 
=
ÔÔ 
new
ÔÔ !
(
ÔÔ! "
)
ÔÔ" #
{
 	
AppInstanceId
ÒÒ 
=
ÒÒ 
settings
ÒÒ $
.
ÒÒ$ %
AppInstanceId
ÒÒ% 2
,
ÒÒ2 3
DeviceId
ÚÚ 
=
ÚÚ 
settings
ÚÚ 
.
ÚÚ  
DeviceId
ÚÚ  (
,
ÚÚ( )

DeviceType
ÛÛ 
=
ÛÛ 
	AppDevice
ÛÛ "
.
ÛÛ" #
Types
ÛÛ# (
.
ÛÛ( )

DeviceType
ÛÛ) 3
.
ÛÛ3 4
Desktop
ÛÛ4 ;
}
ÙÙ 	
;
ÙÙ	 

return
ˆˆ 
await
ˆˆ 
networkProvider
ˆˆ $
.
ˆˆ$ %&
ExecuteUnaryRequestAsync
ˆˆ% =
(
ˆˆ= >
	connectId
˜˜ 
,
˜˜ 
RpcServiceType
¯¯ 
.
¯¯ 
RegisterAppDevice
¯¯ ,
,
¯¯, -%
SecureByteStringInterop
˘˘ #
.
˘˘# $"
WithByteStringAsSpan
˘˘$ 8
(
˘˘8 9
	appDevice
˘˘9 B
.
˘˘B C
ToByteString
˘˘C O
(
˘˘O P
)
˘˘P Q
,
˘˘Q R
span
˙˙ 
=>
˙˙ 
span
˙˙ 
.
˙˙ 
ToArray
˙˙ $
(
˙˙$ %
)
˙˙% &
)
˙˙& '
,
˙˙' (
decryptedPayload
˚˚ 
=>
˚˚ 
{
¸¸ (
DeviceRegistrationResponse
˝˝ *
reply
˝˝+ 0
=
˝˝1 2
Helpers
˛˛ 
.
˛˛ 
ParseFromBytes
˛˛ *
<
˛˛* +(
DeviceRegistrationResponse
˛˛+ E
>
˛˛E F
(
˛˛F G
decryptedPayload
˛˛G W
)
˛˛W X
;
˛˛X Y
settings
ÄÄ 
.
ÄÄ 
ServerPublicKey
ÄÄ (
=
ÄÄ) *%
SecureByteStringInterop
ÄÄ+ B
.
ÄÄB C"
WithByteStringAsSpan
ÄÄC W
(
ÄÄW X
reply
ÄÄX ]
.
ÄÄ] ^
ServerPublicKey
ÄÄ^ m
,
ÄÄm n

ByteString
ÅÅ 
.
ÅÅ 
CopyFrom
ÅÅ '
)
ÅÅ' (
;
ÅÅ( )
return
ÉÉ 
Task
ÉÉ 
.
ÉÉ 

FromResult
ÉÉ &
(
ÉÉ& '
Result
ÉÉ' -
<
ÉÉ- .
Unit
ÉÉ. 2
,
ÉÉ2 3
NetworkFailure
ÉÉ4 B
>
ÉÉB C
.
ÉÉC D
Ok
ÉÉD F
(
ÉÉF G
Unit
ÉÉG K
.
ÉÉK L
Value
ÉÉL Q
)
ÉÉQ R
)
ÉÉR S
;
ÉÉS T
}
ÑÑ 
,
ÑÑ 
false
ÑÑ 
,
ÑÑ 
CancellationToken
ÑÑ '
.
ÑÑ' (
None
ÑÑ( ,
)
ÑÑ, -
.
ÑÑ- .
ConfigureAwait
ÑÑ. <
(
ÑÑ< =
false
ÑÑ= B
)
ÑÑB C
;
ÑÑC D
}
ÖÖ 
private
ãã 
async
ãã 
Task
ãã /
!CleanupCorruptedIdentityDataAsync
ãã 8
(
ãã8 9
string
åå 
membershipId
åå 
,
åå )
ApplicationInstanceSettings
çç #)
applicationInstanceSettings
çç$ ?
)
çç? @
{
éé 
try
èè 
{
êê 	
uint
ëë 
	connectId
ëë 
=
ëë 
NetworkProvider
ëë ,
.
ëë, -$
ComputeUniqueConnectId
ëë- C
(
ëëC D)
applicationInstanceSettings
íí +
,
íí+ , 
PubKeyExchangeType
ìì "
.
ìì" #(
DataCenterEphemeralConnect
ìì# =
)
ìì= >
;
ìì> ?
Result
ïï 
<
ïï 
Unit
ïï 
,
ïï 
	Exception
ïï "
>
ïï" #
cleanupResult
ïï$ 1
=
ïï2 3
await
ññ !
stateCleanupService
ññ )
.
ññ) *1
#CleanupMembershipStateWithKeysAsync
ññ* M
(
ññM N
membershipId
ññN Z
,
ññZ [
	connectId
ññ\ e
)
ññe f
.
óó 
ConfigureAwait
óó #
(
óó# $
false
óó$ )
)
óó) *
;
óó* +
if
ôô 
(
ôô 
cleanupResult
ôô 
.
ôô 
IsErr
ôô #
)
ôô# $
{
öö 
return
õõ 
;
õõ 
}
úú 
await
ûû 
stateManager
ûû 
.
ûû (
TransitionToAnonymousAsync
ûû 9
(
ûû9 :
)
ûû: ;
.
ûû; <
ConfigureAwait
ûû< J
(
ûûJ K
false
ûûK P
)
ûûP Q
;
ûûQ R
}
üü 	
catch
†† 
(
†† 
	Exception
†† 
ex
†† 
)
†† 
{
°° 	
Log
¢¢ 
.
¢¢ 
Error
¢¢ 
(
¢¢ 
ex
¢¢ 
,
¢¢ 
$str
¢¢ u
,
¢¢u v
membershipId
££ 
)
££ 
;
££ 
}
§§ 	
}
•• 
}®® õ
á/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Common/InternalServiceApiFailureType.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Common! '
;' (
public 
enum )
InternalServiceApiFailureType )
{ "
SecureStoreKeyNotFound 
, #
SecureStoreAccessDenied 
, 
ApiRequestFailed 
} î
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/SignInResult.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
;/ 0
public 
sealed 
record 
SignInResult !
(! "
Ecliptix 
. 
Protobuf 
. 

Membership  
.  !

Membership! +
?+ ,

Membership- 7
,7 8
Protobuf 
. 
Account 
. 
Account 
? 
ActiveAccount +
=, -
null. 2
)2 3
;3 4¸
É/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Common/InternalServiceApiFailure.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Common! '
;' (
public 
class %
InternalServiceApiFailure &
{ 
private %
InternalServiceApiFailure %
(% &)
InternalServiceApiFailureType& C
typeD H
,H I
stringJ P
messageQ X
,X Y
	Exception 
? 
innerException !
=" #
null$ (
)( )
{		 
Type

 
=

 
type

 
;

 
Message 
= 
message 
; 
InnerException 
= 
innerException '
;' (
} 
public 
)
InternalServiceApiFailureType (
Type) -
{. /
get0 3
;3 4
}5 6
public 

string 
Message 
{ 
get 
;  
}! "
public 

	Exception 
? 
InnerException $
{% &
get' *
;* +
}, -
public 

static %
InternalServiceApiFailure +#
SecureStoreAccessDenied, C
(C D
stringD J
detailsK R
,R S
	ExceptionT ]
?] ^
inner_ d
=e f
nullg k
)k l
{ 
return 
new %
InternalServiceApiFailure ,
(, -)
InternalServiceApiFailureType- J
.J K#
SecureStoreAccessDeniedK b
,b c
detailsd k
,k l
innerm r
)r s
;s t
} 
public 

static %
InternalServiceApiFailure +"
SecureStoreKeyNotFound, B
(B C
stringC I
detailsJ Q
,Q R
	ExceptionS \
?\ ]
inner^ c
=d e
nullf j
)j k
{ 
return 
new %
InternalServiceApiFailure ,
(, -)
InternalServiceApiFailureType- J
.J K"
SecureStoreKeyNotFoundK a
,a b
detailsc j
,j k
innerl q
)q r
;r s
} 
public 

static %
InternalServiceApiFailure +
ApiRequestFailed, <
(< =
string= C
detailsD K
,K L
	ExceptionM V
?V W
innerX ]
=^ _
null` d
)d e
{ 
return 
new %
InternalServiceApiFailure ,
(, -)
InternalServiceApiFailureType- J
.J K
ApiRequestFailedK [
,[ \
details] d
,d e
innerf k
)k l
;l m
}   
}!! À9
Ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/SensitiveBytes.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
;/ 0
internal 
sealed	 
class 
SensitiveBytes $
:% &
IDisposable' 2
{		 
private

 $
SodiumSecureMemoryHandle

 $
?

$ %
_handle

& -
;

- .
private 
int 
_length 
; 
private 
bool 
	_disposed 
; 
private 
SensitiveBytes 
( $
SodiumSecureMemoryHandle 3
handle4 :
,: ;
int< ?
length@ F
)F G
{ 
_handle 
= 
handle 
; 
_length 
= 
length 
; 
} 
public 

int 
Length 
{ 
get 
{ 	
EnsureNotDisposed 
( 
) 
;  
return 
_length 
; 
} 	
} 
public 

static 
Result 
< 
SensitiveBytes '
,' (
SodiumFailure) 6
>6 7
From8 <
(< =
ReadOnlySpan= I
<I J
byteJ N
>N O
sourceP V
)V W
{ 
if 

( 
source 
. 
IsEmpty 
) 
{   	
Result!! 
<!! $
SodiumSecureMemoryHandle!! +
,!!+ ,
SodiumFailure!!- :
>!!: ;
emptyResult!!< G
=!!H I$
SodiumSecureMemoryHandle"" (
.""( )
Allocate"") 1
(""1 2
$num""2 3
)""3 4
;""4 5
if$$ 
($$ 
emptyResult$$ 
.$$ 
IsErr$$ !
)$$! "
{%% 
return&& 
Result&& 
<&& 
SensitiveBytes&& ,
,&&, -
SodiumFailure&&. ;
>&&; <
.&&< =
Err&&= @
(&&@ A
emptyResult&&A L
.&&L M
	UnwrapErr&&M V
(&&V W
)&&W X
)&&X Y
;&&Y Z
}'' 
return)) 
Result)) 
<)) 
SensitiveBytes)) (
,))( )
SodiumFailure))* 7
>))7 8
.))8 9
Ok))9 ;
()); <
new** 
SensitiveBytes** "
(**" #
emptyResult**# .
.**. /
Unwrap**/ 5
(**5 6
)**6 7
,**7 8
$num**9 :
)**: ;
)**; <
;**< =
}++ 	
Result-- 
<-- $
SodiumSecureMemoryHandle-- '
,--' (
SodiumFailure--) 6
>--6 7
allocResult--8 C
=--D E$
SodiumSecureMemoryHandle.. $
...$ %
Allocate..% -
(..- .
source... 4
...4 5
Length..5 ;
)..; <
;..< =
if00 

(00 
allocResult00 
.00 
IsErr00 
)00 
{11 	
return22 
Result22 
<22 
SensitiveBytes22 (
,22( )
SodiumFailure22* 7
>227 8
.228 9
Err229 <
(22< =
allocResult22= H
.22H I
	UnwrapErr22I R
(22R S
)22S T
)22T U
;22U V
}33 	$
SodiumSecureMemoryHandle55  
handle55! '
=55( )
allocResult55* 5
.555 6
Unwrap556 <
(55< =
)55= >
;55> ?
Result77 
<77 
Unit77 
,77 
SodiumFailure77 "
>77" #
writeResult77$ /
=770 1
handle772 8
.778 9
Write779 >
(77> ?
source77? E
)77E F
;77F G
if88 

(88 
writeResult88 
.88 
IsErr88 
)88 
{99 	
handle:: 
.:: 
Dispose:: 
(:: 
):: 
;:: 
return;; 
Result;; 
<;; 
SensitiveBytes;; (
,;;( )
SodiumFailure;;* 7
>;;7 8
.;;8 9
Err;;9 <
(;;< =
writeResult;;= H
.;;H I
	UnwrapErr;;I R
(;;R S
);;S T
);;T U
;;;U V
}<< 	
return>> 
Result>> 
<>> 
SensitiveBytes>> $
,>>$ %
SodiumFailure>>& 3
>>>3 4
.>>4 5
Ok>>5 7
(>>7 8
new?? 
SensitiveBytes?? 
(?? 
handle?? %
,??% &
source??' -
.??- .
Length??. 4
)??4 5
)??5 6
;??6 7
}@@ 
publicBB 

ResultBB 
<BB 
TResultBB 
,BB 
SodiumFailureBB (
>BB( )
WithReadAccessBB* 8
<BB8 9
TResultBB9 @
>BB@ A
(BBA B
FuncCC 
<CC 
ReadOnlySpanCC 
<CC 
byteCC 
>CC 
,CC  
ResultCC! '
<CC' (
TResultCC( /
,CC/ 0
SodiumFailureCC1 >
>CC> ?
>CC? @
	operationCCA J
)CCJ K
{DD 
EnsureNotDisposedEE 
(EE 
)EE 
;EE 
ifGG 

(GG 
_handleGG 
==GG 
nullGG 
)GG 
{HH 	
returnII 
ResultII 
<II 
TResultII !
,II! "
SodiumFailureII# 0
>II0 1
.II1 2
ErrII2 5
(II5 6
SodiumFailureJJ 
.JJ 
NullPointerJJ )
(JJ) *
$strJJ* I
)JJI J
)JJJ K
;JJK L
}KK 	
returnMM 
_handleMM 
.MM 
WithReadAccessMM %
(MM% &
	operationMM& /
)MM/ 0
;MM0 1
}NN 
publicPP 

voidPP 
DisposePP 
(PP 
)PP 
{QQ 
ifRR 

(RR 
	_disposedRR 
)RR 
{SS 	
returnTT 
;TT 
}UU 	
_handleWW 
?WW 
.WW 
DisposeWW 
(WW 
)WW 
;WW 
_handleXX 
=XX 
nullXX 
;XX 
_lengthYY 
=YY 
$numYY 
;YY 
	_disposedZZ 
=ZZ 
trueZZ 
;ZZ 
}[[ 
private]] 
void]] 
EnsureNotDisposed]] "
(]]" #
)]]# $
{^^ 
if__ 

(__ 
	_disposed__ 
)__ 
{`` 	
throwaa 
newaa #
ObjectDisposedExceptionaa -
(aa- .
nameofaa. 4
(aa4 5
SensitiveBytesaa5 C
)aaC D
)aaD E
;aaE F
}bb 	
}cc 
}dd ¿–
Ç/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/SecureTextBuffer.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Services

  
.

  !
Authentication

! /
;

/ 0
public 
sealed 
class 
SecureTextBuffer $
:% &
IDisposable' 2
{ 
private $
SodiumSecureMemoryHandle $
_secureHandle% 2
=3 4$
SodiumSecureMemoryHandle5 M
.M N
AllocateN V
(V W
$numW X
)X Y
.Y Z
UnwrapZ `
(` a
)a b
;b c
private 
bool 
_isDisposed 
; 
public 

int 
Length 
{ 
get 
; 
private $
set% (
;( )
}* +
public 

void 
Insert 
( 
int 
index  
,  !
string" (
text) -
)- .
{ 
if 

( 
string 
. 
IsNullOrEmpty  
(  !
text! %
)% &
)& '
{ 	
return 
; 
} 	
ModifyState 
( 
index 
, 
$num 
, 
text "
)" #
;# $
} 
public 

void 
Remove 
( 
int 
index  
,  !
int" %
count& +
)+ ,
{ 
if 

( 
count 
<= 
$num 
) 
{   	
return!! 
;!! 
}"" 	
ModifyState$$ 
($$ 
index$$ 
,$$ 
count$$  
,$$  !
string$$" (
.$$( )
Empty$$) .
)$$. /
;$$/ 0
}%% 
public'' 

void'' 
WithSecureBytes'' 
(''  
Action''  &
<''& '
ReadOnlySpan''' 3
<''3 4
byte''4 8
>''8 9
>''9 :
action''; A
)''A B
{(( 
if)) 

()) 
_isDisposed)) 
))) 
{** 	
throw++ 
new++ #
ObjectDisposedException++ -
(++- .
nameof++. 4
(++4 5
SecureTextBuffer++5 E
)++E F
)++F G
;++G H
},, 	
if.. 

(.. 
_secureHandle.. 
... 
	IsInvalid.. #
||..$ &
_secureHandle..' 4
...4 5
Length..5 ;
==..< >
$num..? @
)..@ A
{// 	
action00 
(00 
ReadOnlySpan00 
<00  
byte00  $
>00$ %
.00% &
Empty00& +
)00+ ,
;00, -
return11 
;11 
}22 	
using44 
SecurePooledArray44 
<44  
byte44  $
>44$ %
rentedBytes44& 1
=442 3
SecureArrayPool444 C
.44C D
Rent44D H
<44H I
byte44I M
>44M N
(44N O
_secureHandle44O \
.44\ ]
Length44] c
)44c d
;44d e
Span55 
<55 
byte55 
>55 
span55 
=55 
rentedBytes55 %
.55% &
AsSpan55& ,
(55, -
)55- .
;55. /
_secureHandle77 
.77 
Read77 
(77 
span77 
)77  
.77  !
Unwrap77! '
(77' (
)77( )
;77) *
action99 
(99 
span99 
)99 
;99 
}:: 
private<< 
void<< 
ModifyState<< 
(<< 
int<<  
	charIndex<<! *
,<<* +
int<<, /
removeCharCount<<0 ?
,<<? @
string<<A G
insertChars<<H S
)<<S T
{== 
if>> 

(>> 
_isDisposed>> 
)>> 
{?? 	
throw@@ 
new@@ #
ObjectDisposedException@@ -
(@@- .
nameof@@. 4
(@@4 5
SecureTextBuffer@@5 E
)@@E F
)@@F G
;@@G H
}AA 	$
SodiumSecureMemoryHandleCC  
?CC  !
	newHandleCC" +
=CC, -
nullCC. 2
;CC2 3
boolDD 
successDD 
=DD 
falseDD 
;DD 
byteEE 
[EE 
]EE 
?EE 
insertBytesEE 
=EE 
nullEE "
;EE" #
tryGG 
{HH 	
insertBytesII 
=II 
PrepareInsertBytesII ,
(II, -
insertCharsII- 8
)II8 9
;II9 :
ifJJ 
(JJ 
insertBytesJJ 
==JJ 
nullJJ #
)JJ# $
{KK 
returnLL 
;LL 
}MM 
intOO 
oldByteLengthOO 
=OO 
_secureHandleOO  -
.OO- .
LengthOO. 4
;OO4 5
intPP #
currentTextElementCountPP '
=PP( )&
GetCurrentTextElementCountPP* D
(PPD E
oldByteLengthPPE R
)PPR S
;PPS T
	charIndexRR 
=RR 
MathRR 
.RR 
ClampRR "
(RR" #
	charIndexRR# ,
,RR, -
$numRR. /
,RR/ 0#
currentTextElementCountRR1 H
)RRH I
;RRI J
removeCharCountSS 
=SS 
MathSS "
.SS" #
ClampSS# (
(SS( )
removeCharCountSS) 8
,SS8 9
$numSS: ;
,SS; <#
currentTextElementCountSS= T
-SSU V
	charIndexSSW `
)SS` a
;SSa b
ByteIndexRangeUU 
	byteRangeUU $
=UU% & 
CalculateByteIndicesUU' ;
(UU; <
oldByteLengthUU< I
,UUI J
	charIndexUUK T
,UUT U
removeCharCountUUV e
)UUe f
;UUf g
intVV 
removedByteCountVV  
=VV! "
	byteRangeVV# ,
.VV, -
EndVV- 0
-VV1 2
	byteRangeVV3 <
.VV< =
StartVV= B
;VVB C
intWW 
newByteLengthWW 
=WW 
oldByteLengthWW  -
-WW. /
removedByteCountWW0 @
+WWA B
insertBytesWWC N
.WWN O
LengthWWO U
;WWU V
	newHandleYY 
=YY 
AssembleNewBufferYY )
(YY) *
oldByteLengthYY* 7
,YY7 8
	byteRangeYY9 B
.YYB C
StartYYC H
,YYH I
	byteRangeYYJ S
.YYS T
EndYYT W
,YYW X
insertBytesYYY d
,YYd e
newByteLengthYYf s
)YYs t
;YYt u!
UpdateHandleAndLength[[ !
([[! "
	newHandle[[" +
,[[+ ,#
currentTextElementCount[[- D
,[[D E
removeCharCount[[F U
,[[U V
insertBytes[[W b
)[[b c
;[[c d
success\\ 
=\\ 
true\\ 
;\\ 
}]] 	
finally^^ 
{__ 	
CleanupInsertBytes`` 
(`` 
insertBytes`` *
)``* +
;``+ ,
ifaa 
(aa 
!aa 
successaa 
)aa 
{bb 
	newHandlecc 
?cc 
.cc 
Disposecc "
(cc" #
)cc# $
;cc$ %
}dd 
}ee 	
}ff 
privatehh 
statichh 
bytehh 
[hh 
]hh 
?hh 
PrepareInsertByteshh -
(hh- .
stringhh. 4
insertCharshh5 @
)hh@ A
{ii 
ifjj 

(jj 
stringjj 
.jj 
IsNullOrEmptyjj  
(jj  !
insertCharsjj! ,
)jj, -
)jj- .
{kk 	
returnll 
[ll 
]ll 
;ll 
}mm 	
Resultoo 
<oo 
SecureStringHandleroo "
,oo" #
SodiumFailureoo$ 1
>oo1 2
handlerResultoo3 @
=ooA B
SecureStringHandlerooC V
.ooV W

FromStringooW a
(ooa b
insertCharsoob m
)oom n
;oon o
ifpp 

(pp 
handlerResultpp 
.pp 
IsErrpp 
)pp  
{qq 	
returnrr 
nullrr 
;rr 
}ss 	
usinguu 
SecureStringHandleruu !
insertHandleruu" /
=uu0 1
handlerResultuu2 ?
.uu? @
Unwrapuu@ F
(uuF G
)uuG H
;uuH I
usingvv 
SecurePooledArrayvv 
<vv  
bytevv  $
>vv$ %
	tempBytesvv& /
=vv0 1
SecureArrayPoolvv2 A
.vvA B
RentvvB F
<vvF G
bytevvG K
>vvK L
(vvL M
insertHandlervvM Z
.vvZ [

ByteLengthvv[ e
)vve f
;vvf g
Resultxx 
<xx 
Unitxx 
,xx 
SodiumFailurexx "
>xx" #

readResultxx$ .
=xx/ 0
insertHandlerxx1 >
.xx> ?
UseBytesxx? G
(xxG H
bytesxxH M
=>xxN P
{yy 	
byteszz 
.zz 
CopyTozz 
(zz 
	tempByteszz "
.zz" #
AsSpanzz# )
(zz) *
)zz* +
)zz+ ,
;zz, -
return{{ 
Unit{{ 
.{{ 
Value{{ 
;{{ 
}|| 	
)||	 

;||
 
if~~ 

(~~ 

readResult~~ 
.~~ 
IsErr~~ 
)~~ 
{ 	
return
ÄÄ 
null
ÄÄ 
;
ÄÄ 
}
ÅÅ 	
byte
ÉÉ 
[
ÉÉ 
]
ÉÉ 
insertBytes
ÉÉ 
=
ÉÉ 
new
ÉÉ  
byte
ÉÉ! %
[
ÉÉ% &
insertHandler
ÉÉ& 3
.
ÉÉ3 4

ByteLength
ÉÉ4 >
]
ÉÉ> ?
;
ÉÉ? @
	tempBytes
ÑÑ 
.
ÑÑ 
AsSpan
ÑÑ 
(
ÑÑ 
)
ÑÑ 
[
ÑÑ 
..
ÑÑ 
insertHandler
ÑÑ *
.
ÑÑ* +

ByteLength
ÑÑ+ 5
]
ÑÑ5 6
.
ÑÑ6 7
CopyTo
ÑÑ7 =
(
ÑÑ= >
insertBytes
ÑÑ> I
)
ÑÑI J
;
ÑÑJ K
return
ÖÖ 
insertBytes
ÖÖ 
;
ÖÖ 
}
ÜÜ 
private
àà 
int
àà (
GetCurrentTextElementCount
àà *
(
àà* +
int
àà+ .

byteLength
àà/ 9
)
àà9 :
{
ââ 
if
ää 

(
ää 

byteLength
ää 
==
ää 
$num
ää 
)
ää 
{
ãã 	
return
åå 
$num
åå 
;
åå 
}
çç 	
using
èè 
SecurePooledArray
èè 
<
èè  
byte
èè  $
>
èè$ %
oldBytes
èè& .
=
èè/ 0
SecureArrayPool
èè1 @
.
èè@ A
Rent
èèA E
<
èèE F
byte
èèF J
>
èèJ K
(
èèK L

byteLength
èèL V
)
èèV W
;
èèW X
_secureHandle
êê 
.
êê 
Read
êê 
(
êê 
oldBytes
êê #
.
êê# $
AsSpan
êê$ *
(
êê* +
)
êê+ ,
)
êê, -
.
êê- .
Unwrap
êê. 4
(
êê4 5
)
êê5 6
;
êê6 7
string
ëë 
currentText
ëë 
=
ëë 
Encoding
ëë %
.
ëë% &
UTF8
ëë& *
.
ëë* +
	GetString
ëë+ 4
(
ëë4 5
oldBytes
ëë5 =
.
ëë= >
AsSpan
ëë> D
(
ëëD E
)
ëëE F
)
ëëF G
;
ëëG H
return
íí !
GetTextElementCount
íí "
(
íí" #
currentText
íí# .
)
íí. /
;
íí/ 0
}
ìì 
private
ïï 
readonly
ïï 
record
ïï 
struct
ïï "
ByteIndexRange
ïï# 1
(
ïï1 2
int
ïï2 5
Start
ïï6 ;
,
ïï; <
int
ïï= @
End
ïïA D
)
ïïD E
;
ïïE F
private
óó 
ByteIndexRange
óó "
CalculateByteIndices
óó /
(
óó/ 0
int
óó0 3
oldByteLength
óó4 A
,
óóA B
int
óóC F
	charIndex
óóG P
,
óóP Q
int
óóR U
removeCharCount
óóV e
)
óóe f
{
òò 
if
ôô 

(
ôô 
oldByteLength
ôô 
==
ôô 
$num
ôô 
||
ôô !
(
ôô" #
	charIndex
ôô# ,
==
ôô- /
$num
ôô0 1
&&
ôô2 4
removeCharCount
ôô5 D
==
ôôE G
$num
ôôH I
)
ôôI J
)
ôôJ K
{
öö 	
return
õõ 
new
õõ 
ByteIndexRange
õõ %
(
õõ% &
$num
õõ& '
,
õõ' (
oldByteLength
õõ) 6
)
õõ6 7
;
õõ7 8
}
úú 	
using
ûû 
SecurePooledArray
ûû 
<
ûû  
byte
ûû  $
>
ûû$ %
oldBytes
ûû& .
=
ûû/ 0
SecureArrayPool
ûû1 @
.
ûû@ A
Rent
ûûA E
<
ûûE F
byte
ûûF J
>
ûûJ K
(
ûûK L
oldByteLength
ûûL Y
)
ûûY Z
;
ûûZ [
_secureHandle
üü 
.
üü 
Read
üü 
(
üü 
oldBytes
üü #
.
üü# $
AsSpan
üü$ *
(
üü* +
)
üü+ ,
)
üü, -
.
üü- .
Unwrap
üü. 4
(
üü4 5
)
üü5 6
;
üü6 7
string
†† 
currentText
†† 
=
†† 
Encoding
†† %
.
††% &
UTF8
††& *
.
††* +
	GetString
††+ 4
(
††4 5
oldBytes
††5 =
.
††= >
AsSpan
††> D
(
††D E
)
††E F
)
††F G
;
††G H
int
¢¢ 
startByteIndex
¢¢ 
=
¢¢ .
 GetByteIndexFromTextElementIndex
¢¢ =
(
¢¢= >
currentText
¢¢> I
,
¢¢I J
	charIndex
¢¢K T
)
¢¢T U
;
¢¢U V
int
££ 
endByteIndex
££ 
=
££ .
 GetByteIndexFromTextElementIndex
££ ;
(
££; <
currentText
££< G
,
££G H
	charIndex
££I R
+
££S T
removeCharCount
££U d
)
££d e
;
££e f
return
•• 
new
•• 
ByteIndexRange
•• !
(
••! "
startByteIndex
••" 0
,
••0 1
endByteIndex
••2 >
)
••> ?
;
••? @
}
¶¶ 
private
®® &
SodiumSecureMemoryHandle
®® $
AssembleNewBuffer
®®% 6
(
®®6 7
int
®®7 :
oldByteLength
®®; H
,
®®H I
int
®®J M
startByteIndex
®®N \
,
®®\ ]
int
®®^ a
endByteIndex
®®b n
,
®®n o
byte
®®p t
[
®®t u
]
®®u v
insertBytes®®w Ç
,®®Ç É
int®®Ñ á
newByteLength®®à ï
)®®ï ñ
{
©© 
if
™™ 

(
™™ 
newByteLength
™™ 
==
™™ 
$num
™™ 
)
™™ 
{
´´ 	
return
¨¨ &
SodiumSecureMemoryHandle
¨¨ +
.
¨¨+ ,
Allocate
¨¨, 4
(
¨¨4 5
$num
¨¨5 6
)
¨¨6 7
.
¨¨7 8
Unwrap
¨¨8 >
(
¨¨> ?
)
¨¨? @
;
¨¨@ A
}
≠≠ 	
using
ØØ 
SecurePooledArray
ØØ 
<
ØØ  
byte
ØØ  $
>
ØØ$ %
newBytes
ØØ& .
=
ØØ/ 0
SecureArrayPool
ØØ1 @
.
ØØ@ A
Rent
ØØA E
<
ØØE F
byte
ØØF J
>
ØØJ K
(
ØØK L
newByteLength
ØØL Y
)
ØØY Z
;
ØØZ [
Span
∞∞ 
<
∞∞ 
byte
∞∞ 
>
∞∞ 
newSpan
∞∞ 
=
∞∞ 
newBytes
∞∞ %
.
∞∞% &
AsSpan
∞∞& ,
(
∞∞, -
)
∞∞- .
;
∞∞. /
if
≤≤ 

(
≤≤ 
oldByteLength
≤≤ 
>
≤≤ 
$num
≤≤ 
)
≤≤ 
{
≥≥ 	 
CopyBufferSegments
¥¥ 
(
¥¥ 
oldByteLength
¥¥ ,
,
¥¥, -
startByteIndex
¥¥. <
,
¥¥< =
endByteIndex
¥¥> J
,
¥¥J K
insertBytes
¥¥L W
,
¥¥W X
newSpan
¥¥Y `
)
¥¥` a
;
¥¥a b
}
µµ 	
else
∂∂ 
{
∑∑ 	
insertBytes
∏∏ 
.
∏∏ 
CopyTo
∏∏ 
(
∏∏ 
newSpan
∏∏ &
)
∏∏& '
;
∏∏' (
}
ππ 	&
SodiumSecureMemoryHandle
ªª  
	newHandle
ªª! *
=
ªª+ ,&
SodiumSecureMemoryHandle
ªª- E
.
ªªE F
Allocate
ªªF N
(
ªªN O
newByteLength
ªªO \
)
ªª\ ]
.
ªª] ^
Unwrap
ªª^ d
(
ªªd e
)
ªªe f
;
ªªf g
	newHandle
ºº 
.
ºº 
Write
ºº 
(
ºº 
newSpan
ºº 
)
ºº  
.
ºº  !
Unwrap
ºº! '
(
ºº' (
)
ºº( )
;
ºº) *
return
ΩΩ 
	newHandle
ΩΩ 
;
ΩΩ 
}
ææ 
private
¿¿ 
void
¿¿  
CopyBufferSegments
¿¿ #
(
¿¿# $
int
¿¿$ '
oldByteLength
¿¿( 5
,
¿¿5 6
int
¿¿7 :
startByteIndex
¿¿; I
,
¿¿I J
int
¿¿K N
endByteIndex
¿¿O [
,
¿¿[ \
byte
¿¿] a
[
¿¿a b
]
¿¿b c
insertBytes
¿¿d o
,
¿¿o p
Span
¿¿q u
<
¿¿u v
byte
¿¿v z
>
¿¿z {
newSpan¿¿| É
)¿¿É Ñ
{
¡¡ 
using
¬¬ 
SecurePooledArray
¬¬ 
<
¬¬  
byte
¬¬  $
>
¬¬$ %
oldBytesForCopy
¬¬& 5
=
¬¬6 7
SecureArrayPool
¬¬8 G
.
¬¬G H
Rent
¬¬H L
<
¬¬L M
byte
¬¬M Q
>
¬¬Q R
(
¬¬R S
oldByteLength
¬¬S `
)
¬¬` a
;
¬¬a b
_secureHandle
√√ 
.
√√ 
Read
√√ 
(
√√ 
oldBytesForCopy
√√ *
.
√√* +
AsSpan
√√+ 1
(
√√1 2
)
√√2 3
)
√√3 4
.
√√4 5
Unwrap
√√5 ;
(
√√; <
)
√√< =
;
√√= >
Span
ƒƒ 
<
ƒƒ 
byte
ƒƒ 
>
ƒƒ 
oldSpan
ƒƒ 
=
ƒƒ 
oldBytesForCopy
ƒƒ ,
.
ƒƒ, -
AsSpan
ƒƒ- 3
(
ƒƒ3 4
)
ƒƒ4 5
;
ƒƒ5 6
oldSpan
∆∆ 
[
∆∆ 
..
∆∆ 
startByteIndex
∆∆  
]
∆∆  !
.
∆∆! "
CopyTo
∆∆" (
(
∆∆( )
newSpan
∆∆) 0
)
∆∆0 1
;
∆∆1 2
insertBytes
«« 
.
«« 
CopyTo
«« 
(
«« 
newSpan
«« "
[
««" #
startByteIndex
««# 1
..
««1 3
]
««3 4
)
««4 5
;
««5 6
oldSpan
»» 
[
»» 
endByteIndex
»» 
..
»» 
]
»» 
.
»»  
CopyTo
»»  &
(
»»& '
newSpan
»»' .
[
»». /
(
»»/ 0
startByteIndex
»»0 >
+
»»? @
insertBytes
»»A L
.
»»L M
Length
»»M S
)
»»S T
..
»»T V
]
»»V W
)
»»W X
;
»»X Y
}
…… 
private
ÀÀ 
void
ÀÀ #
UpdateHandleAndLength
ÀÀ &
(
ÀÀ& '&
SodiumSecureMemoryHandle
ÀÀ' ?
	newHandle
ÀÀ@ I
,
ÀÀI J
int
ÀÀK N%
currentTextElementCount
ÀÀO f
,
ÀÀf g
int
ÀÀh k
removeCharCount
ÀÀl {
,
ÀÀ{ |
byteÀÀ} Å
[ÀÀÅ Ç
]ÀÀÇ É
insertBytesÀÀÑ è
)ÀÀè ê
{
ÃÃ 
_secureHandle
ÕÕ 
.
ÕÕ 
Dispose
ÕÕ 
(
ÕÕ 
)
ÕÕ 
;
ÕÕ  
_secureHandle
ŒŒ 
=
ŒŒ 
	newHandle
ŒŒ !
;
ŒŒ! "
string
œœ 

insertText
œœ 
=
œœ 
insertBytes
œœ '
.
œœ' (
Length
œœ( .
>
œœ/ 0
$num
œœ1 2
?
œœ3 4
Encoding
œœ5 =
.
œœ= >
UTF8
œœ> B
.
œœB C
	GetString
œœC L
(
œœL M
insertBytes
œœM X
)
œœX Y
:
œœZ [
string
œœ\ b
.
œœb c
Empty
œœc h
;
œœh i
Length
–– 
=
–– %
currentTextElementCount
–– (
-
––) *
removeCharCount
––+ :
+
––; <!
GetTextElementCount
––= P
(
––P Q

insertText
––Q [
)
––[ \
;
––\ ]
}
—— 
private
”” 
static
”” 
void
””  
CleanupInsertBytes
”” *
(
””* +
byte
””+ /
[
””/ 0
]
””0 1
?
””1 2
insertBytes
””3 >
)
””> ?
{
‘‘ 
if
’’ 

(
’’ 
insertBytes
’’ 
!=
’’ 
null
’’ 
&&
’’  "
insertBytes
’’# .
.
’’. /
Length
’’/ 5
>
’’6 7
$num
’’8 9
)
’’9 :
{
÷÷ 	%
CryptographicOperations
◊◊ #
.
◊◊# $

ZeroMemory
◊◊$ .
(
◊◊. /
insertBytes
◊◊/ :
)
◊◊: ;
;
◊◊; <
}
ÿÿ 	
}
ŸŸ 
private
€€ 
static
€€ 
int
€€ .
 GetByteIndexFromTextElementIndex
€€ 7
(
€€7 8
string
€€8 >
text
€€? C
,
€€C D
int
€€E H
textElementIndex
€€I Y
)
€€Y Z
{
‹‹ 
if
›› 

(
›› 
textElementIndex
›› 
==
›› 
$num
››  !
||
››" $
string
››% +
.
››+ ,
IsNullOrEmpty
››, 9
(
››9 :
text
››: >
)
››> ?
)
››? @
{
ﬁﬁ 	
return
ﬂﬂ 
$num
ﬂﬂ 
;
ﬂﬂ 
}
‡‡ 	
try
‚‚ 
{
„„ 	

StringInfo
‰‰ 

stringInfo
‰‰ !
=
‰‰" #
new
‰‰$ '
(
‰‰' (
text
‰‰( ,
)
‰‰, -
;
‰‰- .
int
ÂÂ 
textElementCount
ÂÂ  
=
ÂÂ! "

stringInfo
ÂÂ# -
.
ÂÂ- ."
LengthInTextElements
ÂÂ. B
;
ÂÂB C
if
ÁÁ 
(
ÁÁ 
textElementIndex
ÁÁ  
>=
ÁÁ! #
textElementCount
ÁÁ$ 4
)
ÁÁ4 5
{
ËË 
return
ÈÈ 
Encoding
ÈÈ 
.
ÈÈ  
UTF8
ÈÈ  $
.
ÈÈ$ %
GetByteCount
ÈÈ% 1
(
ÈÈ1 2
text
ÈÈ2 6
)
ÈÈ6 7
;
ÈÈ7 8
}
ÍÍ 
string
ÏÏ 
	substring
ÏÏ 
=
ÏÏ 

stringInfo
ÏÏ )
.
ÏÏ) *%
SubstringByTextElements
ÏÏ* A
(
ÏÏA B
$num
ÏÏB C
,
ÏÏC D
textElementIndex
ÏÏE U
)
ÏÏU V
;
ÏÏV W
return
ÌÌ 
Encoding
ÌÌ 
.
ÌÌ 
UTF8
ÌÌ  
.
ÌÌ  !
GetByteCount
ÌÌ! -
(
ÌÌ- .
	substring
ÌÌ. 7
)
ÌÌ7 8
;
ÌÌ8 9
}
ÓÓ 	
catch
ÔÔ 
(
ÔÔ 
	Exception
ÔÔ 
ex
ÔÔ 
)
ÔÔ 
{
 	
Serilog
ÒÒ 
.
ÒÒ 
Log
ÒÒ 
.
ÒÒ 
Warning
ÒÒ 
(
ÒÒ  
ex
ÒÒ  "
,
ÒÒ" #
$strÒÒ$ î
,ÒÒî ï
textElementIndex
ÚÚ  
)
ÚÚ  !
;
ÚÚ! "
return
ÛÛ 
Math
ÛÛ 
.
ÛÛ 
Min
ÛÛ 
(
ÛÛ 
textElementIndex
ÛÛ ,
,
ÛÛ, -
Encoding
ÛÛ. 6
.
ÛÛ6 7
UTF8
ÛÛ7 ;
.
ÛÛ; <
GetByteCount
ÛÛ< H
(
ÛÛH I
text
ÛÛI M
)
ÛÛM N
)
ÛÛN O
;
ÛÛO P
}
ÙÙ 	
}
ıı 
private
˜˜ 
static
˜˜ 
int
˜˜ !
GetTextElementCount
˜˜ *
(
˜˜* +
string
˜˜+ 1
text
˜˜2 6
)
˜˜6 7
{
¯¯ 
if
˘˘ 

(
˘˘ 
string
˘˘ 
.
˘˘ 
IsNullOrEmpty
˘˘  
(
˘˘  !
text
˘˘! %
)
˘˘% &
)
˘˘& '
{
˙˙ 	
return
˚˚ 
$num
˚˚ 
;
˚˚ 
}
¸¸ 	
try
˛˛ 
{
ˇˇ 	

StringInfo
ÄÄ 

stringInfo
ÄÄ !
=
ÄÄ" #
new
ÄÄ$ '
(
ÄÄ' (
text
ÄÄ( ,
)
ÄÄ, -
;
ÄÄ- .
return
ÅÅ 

stringInfo
ÅÅ 
.
ÅÅ "
LengthInTextElements
ÅÅ 2
;
ÅÅ2 3
}
ÇÇ 	
catch
ÉÉ 
(
ÉÉ 
	Exception
ÉÉ 
ex
ÉÉ 
)
ÉÉ 
{
ÑÑ 	
Serilog
ÖÖ 
.
ÖÖ 
Log
ÖÖ 
.
ÖÖ 
Warning
ÖÖ 
(
ÖÖ  
ex
ÖÖ  "
,
ÖÖ" #
$strÖÖ$ Ä
,ÖÖÄ Å
text
ÜÜ 
.
ÜÜ 
Length
ÜÜ 
)
ÜÜ 
;
ÜÜ 
return
áá 
text
áá 
.
áá 
Length
áá 
;
áá 
}
àà 	
}
ââ 
public
ãã 

void
ãã 
Dispose
ãã 
(
ãã 
)
ãã 
{
åå 
if
çç 

(
çç 
_isDisposed
çç 
)
çç 
{
éé 	
return
èè 
;
èè 
}
êê 	
_secureHandle
íí 
?
íí 
.
íí 
Dispose
íí 
(
íí 
)
íí  
;
íí  !
_isDisposed
ìì 
=
ìì 
true
ìì 
;
ìì 
}
îî 
}ïï Œú
ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/SecureKeyRecoveryService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
;/ 0
internal 
sealed	 
class $
SecureKeyRecoveryService .
(. /
NetworkProvider 
networkProvider #
,# $&
IOpaqueRegistrationService 
registrationService 2
,2 3 
ILocalizationService 
localizationService ,
,, -$
IServerPublicKeyProvider #
serverPublicKeyProvider 4
,4 5-
!IApplicationSecureStorageProvider %,
 applicationSecureStorageProvider& F
)F G
: %
ISecureKeyRecoveryService 
,  
IDisposable! ,
{ 
private 
readonly 
Lock 
_opaqueClientLock +
=, -
new. 1
(1 2
)2 3
;3 4
private 
Option 
< 
OpaqueClient 
>  
_opaqueClient! .
=/ 0
Option1 7
<7 8
OpaqueClient8 D
>D E
.E F
NoneF J
;J K
private   
byte   
[   
]   
?   "
_cachedServerPublicKey   *
;  * +
private!! 
bool!! 
	_disposed!! 
;!! 
public## 

async## 
Task## 
<## 
Result## 
<## 

ByteString## '
,##' (
string##) /
>##/ 0
>##0 1*
ValidateMobileForRecoveryAsync##2 P
(##P Q
string$$ 
mobileNumber$$ 
,$$ 
uint%% 
	connectId%% 
,%% 
CancellationToken&& 
cancellationToken&& +
=&&, -
default&&. 5
)&&5 6
{'' 
Result(( 
<(( (
ValidateMobileNumberResponse(( +
,((+ ,
string((- 3
>((3 4
result((5 ;
=((< =
await)) 
registrationService)) %
.** %
ValidateMobileNumberAsync** *
(*** +
mobileNumber**+ 7
,**7 8
	connectId**9 B
,**B C
cancellationToken**D U
)**U V
.++ 
ConfigureAwait++ 
(++  
false++  %
)++% &
;++& '
if-- 

(-- 
result-- 
.-- 
IsErr-- 
)-- 
{.. 	
return// 
Result// 
<// 

ByteString// $
,//$ %
string//& ,
>//, -
.//- .
Err//. 1
(//1 2
result//2 8
.//8 9
	UnwrapErr//9 B
(//B C
)//C D
)//D E
;//E F
}00 	(
ValidateMobileNumberResponse22 $
response22% -
=22. /
result220 6
.226 7
Unwrap227 =
(22= >
)22> ?
;22? @
return33 
Result33 
<33 

ByteString33  
,33  !
string33" (
>33( )
.33) *
Ok33* ,
(33, -
response33- 5
.335 6"
MobileNumberIdentifier336 L
)33L M
;33M N
}44 
public66 

Task66 
<66 
Result66 
<66 
Unit66 
,66 
string66 #
>66# $
>66$ %*
InitiateSecureKeyResetOtpAsync66& D
(66D E

ByteString77 "
mobileNumberIdentifier77 )
,77) *
Action88 
<88 
uint88 
,88 
Guid88 
,88 '
VerificationCountdownUpdate88 6
.886 7
Types887 <
.88< =!
CountdownUpdateStatus88= R
,88R S
string88T Z
?88Z [
>88[ \
?88\ ]
onCountdownUpdate88^ o
=88p q
null88r v
,88v w
CancellationToken99 
cancellationToken99 +
=99, -
default99. 5
)995 6
=>997 9
registrationService:: 
.:: (
InitiateOtpVerificationAsync:: 8
(::8 9"
mobileNumberIdentifier;; "
,;;" #
VerificationPurpose<< 
.<<  
SecureKeyRecovery<<  1
,<<1 2
onCountdownUpdate== 
,== 
cancellationToken>> 
)>> 
;>> 
public@@ 

Task@@ 
<@@ 
Result@@ 
<@@ 
Unit@@ 
,@@ 
string@@ #
>@@# $
>@@$ %(
ResendSecureKeyResetOtpAsync@@& B
(@@B C
GuidAA 
sessionIdentifierAA 
,AA 

ByteStringBB "
mobileNumberIdentifierBB )
,BB) *
ActionCC 
<CC 
uintCC 
,CC 
GuidCC 
,CC '
VerificationCountdownUpdateCC 6
.CC6 7
TypesCC7 <
.CC< =!
CountdownUpdateStatusCC= R
,CCR S
stringCCT Z
?CCZ [
>CC[ \
?CC\ ]
onCountdownUpdateCC^ o
=CCp q
nullCCr v
,CCv w
CancellationTokenDD 
cancellationTokenDD +
=DD, -
defaultDD. 5
)DD5 6
=>DD7 9
registrationServiceEE 
.EE &
ResendOtpVerificationAsyncEE 6
(EE6 7
sessionIdentifierFF 
,FF "
mobileNumberIdentifierGG "
,GG" #
onCountdownUpdateHH 
,HH 
cancellationTokenII 
)II 
;II 
publicKK 

TaskKK 
<KK 
ResultKK 
<KK 
ProtobufKK 
.KK  

MembershipKK  *
.KK* +

MembershipKK+ 5
,KK5 6
stringKK7 =
>KK= >
>KK> ?(
VerifySecureKeyResetOtpAsyncKK@ \
(KK\ ]
GuidLL 
sessionIdentifierLL 
,LL 
stringMM 
otpCodeMM 
,MM 
uintNN 
	connectIdNN 
,NN 
CancellationTokenOO 
cancellationTokenOO +
=OO, -
defaultOO. 5
)OO5 6
=>OO7 9
registrationServicePP 
.PP 
VerifyOtpAsyncPP *
(PP* +
sessionIdentifierPP+ <
,PP< =
otpCodePP> E
,PPE F
	connectIdPPG P
,PPP Q
cancellationTokenQQ 
)QQ 
;QQ 
publicSS 

asyncSS 
TaskSS 
<SS 
ResultSS 
<SS 
UnitSS !
,SS! "
stringSS# )
>SS) *
>SS* +'
CompleteSecureKeyResetAsyncSS, G
(SSG H

ByteStringTT  
membershipIdentifierTT '
,TT' (
SecureTextBufferUU 
newSecureKeyUU %
,UU% &
uintVV 
	connectIdVV 
,VV 
CancellationTokenWW 
cancellationTokenWW +
=WW, -
defaultWW. 5
)WW5 6
{XX 
ifYY 

(YY  
membershipIdentifierYY  
.YY  !
IsEmptyYY! (
)YY( )
{ZZ 	
return[[ 
Result[[ 
<[[ 
Unit[[ 
,[[ 
string[[  &
>[[& '
.[[' (
Err[[( +
([[+ ,
localizationService\\ #
[\\# $#
AuthenticationConstants\\$ ;
.\\; <.
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY\\< ^
]\\^ _
)\\_ `
;\\` a
}]] 	
if__ 

(__ 
newSecureKey__ 
.__ 
Length__ 
==__  "
$num__# $
)__$ %
{`` 	
returnaa 
Resultaa 
<aa 
Unitaa 
,aa 
stringaa  &
>aa& '
.aa' (
Erraa( +
(aa+ ,
localizationServiceaa, ?
[aa? @#
AuthenticationConstantsaa@ W
.aaW X#
SECURE_KEY_REQUIRED_KEYaaX o
]aao p
)aap q
;aaq r
}bb 	
RegistrationResultdd 
?dd 
registrationResultdd .
=dd/ 0
nulldd1 5
;dd5 6
tryff 
{gg 	
OpaqueClienthh 
opaqueClienthh %
=hh& '#
GetOrCreateOpaqueClienthh( ?
(hh? @
)hh@ A
;hhA B
Resultjj 
<jj 
RegistrationResultjj %
,jj% &
stringjj' -
>jj- .
requestResultjj/ <
=jj= >*
CreateSecureKeyRecoveryRequestkk .
(kk. /
opaqueClientkk/ ;
,kk; <
newSecureKeykk= I
)kkI J
;kkJ K
ifmm 
(mm 
requestResultmm 
.mm 
IsErrmm #
)mm# $
{nn 
returnoo 
Resultoo 
<oo 
Unitoo "
,oo" #
stringoo$ *
>oo* +
.oo+ ,
Erroo, /
(oo/ 0
requestResultoo0 =
.oo= >
	UnwrapErroo> G
(ooG H
)ooH I
)ooI J
;ooJ K
}pp 
registrationResultrr 
=rr  
requestResultrr! .
.rr. /
Unwraprr/ 5
(rr5 6
)rr6 7
;rr7 8
Resulttt 
<tt /
#OpaqueRecoverySecureKeyInitResponsett 6
,tt6 7
stringtt8 >
>tt> ?

initResulttt@ J
=ttK L
awaituu *
InitiateSecureKeyRecoveryAsyncuu 4
(uu4 5 
membershipIdentifieruu5 I
,uuI J
registrationResultuuK ]
.uu] ^
GetRequestCopyuu^ l
(uul m
)uum n
,uun o
	connectIdvv 
,vv 
cancellationTokenvv 0
)vv0 1
.vv1 2
ConfigureAwaitvv2 @
(vv@ A
falsevvA F
)vvF G
;vvG H
ifxx 
(xx 

initResultxx 
.xx 
IsErrxx  
)xx  !
{yy 
returnzz 
Resultzz 
<zz 
Unitzz "
,zz" #
stringzz$ *
>zz* +
.zz+ ,
Errzz, /
(zz/ 0

initResultzz0 :
.zz: ;
	UnwrapErrzz; D
(zzD E
)zzE F
)zzF G
;zzG H
}{{ /
#OpaqueRecoverySecureKeyInitResponse}} /
initResponse}}0 <
=}}= >

initResult}}? I
.}}I J
Unwrap}}J P
(}}P Q
)}}Q R
;}}R S
Result 
< 
Unit 
, 
string 
>  
processResult! .
=/ 0
await
ÄÄ 2
$ProcessSecureKeyRecoveryInitResponse
ÄÄ :
(
ÄÄ: ;
initResponse
ÄÄ; G
)
ÄÄG H
.
ÄÄH I
ConfigureAwait
ÄÄI W
(
ÄÄW X
false
ÄÄX ]
)
ÄÄ] ^
;
ÄÄ^ _
if
ÇÇ 
(
ÇÇ 
processResult
ÇÇ 
.
ÇÇ 
IsErr
ÇÇ #
)
ÇÇ# $
{
ÉÉ 
return
ÑÑ 
processResult
ÑÑ $
;
ÑÑ$ %
}
ÖÖ 
return
áá 
await
áá ,
FinalizeSecureKeyRecoveryAsync
áá 7
(
áá7 8
opaqueClient
áá8 D
,
ááD E
initResponse
ááF R
,
ááR S 
registrationResult
ááT f
,
ááf g"
membershipIdentifier
àà $
,
àà$ %
	connectId
àà& /
,
àà/ 0
cancellationToken
àà1 B
)
ààB C
.
ààC D
ConfigureAwait
ààD R
(
ààR S
false
ààS X
)
ààX Y
;
ààY Z
}
ââ 	
catch
ää 
(
ää 
	Exception
ää 
ex
ää 
)
ää 
{
ãã 	
return
åå 
Result
åå 
<
åå 
Unit
åå 
,
åå 
string
åå  &
>
åå& '
.
åå' (
Err
åå( +
(
åå+ ,
ex
åå, .
.
åå. /
Message
åå/ 6
)
åå6 7
;
åå7 8
}
çç 	
finally
éé 
{
èè 	 
registrationResult
êê 
?
êê 
.
êê  
Dispose
êê  '
(
êê' (
)
êê( )
;
êê) *
}
ëë 	
}
íí 
public
îî 

Task
îî 
<
îî 
Result
îî 
<
îî 
Unit
îî 
,
îî 
string
îî #
>
îî# $
>
îî$ %/
!CleanupSecureKeyResetSessionAsync
îî& G
(
îîG H
Guid
îîH L
sessionIdentifier
îîM ^
)
îî^ _
=>
îî` b!
registrationService
ïï 
.
ïï -
CleanupVerificationSessionAsync
ïï ;
(
ïï; <
sessionIdentifier
ïï< M
)
ïïM N
;
ïïN O
private
óó 
static
óó 
void
óó *
CleanupSensitiveRecoveryData
óó 4
(
óó4 5
byte
òò 
[
òò 
]
òò 
?
òò 
secureKeyCopy
òò 
,
òò 
byte
ôô 
[
ôô 
]
ôô 
?
ôô $
serverRecoveryResponse
ôô &
,
ôô& '
byte
öö 
[
öö 
]
öö 
?
öö 
recoveryRecord
öö 
,
öö 
byte
õõ 
[
õõ 
]
õõ 
?
õõ 
	masterKey
õõ 
)
õõ 
{
úú 
if
ùù 

(
ùù 
secureKeyCopy
ùù 
is
ùù 
{
ùù 
Length
ùù %
:
ùù% &
>
ùù' (
$num
ùù) *
}
ùù+ ,
)
ùù, -
{
ûû 	%
CryptographicOperations
üü #
.
üü# $

ZeroMemory
üü$ .
(
üü. /
secureKeyCopy
üü/ <
)
üü< =
;
üü= >
}
†† 	
if
¢¢ 

(
¢¢ $
serverRecoveryResponse
¢¢ "
is
¢¢# %
{
¢¢& '
Length
¢¢( .
:
¢¢. /
>
¢¢0 1
$num
¢¢2 3
}
¢¢4 5
)
¢¢5 6
{
££ 	%
CryptographicOperations
§§ #
.
§§# $

ZeroMemory
§§$ .
(
§§. /$
serverRecoveryResponse
§§/ E
)
§§E F
;
§§F G
}
•• 	
if
ßß 

(
ßß 
recoveryRecord
ßß 
is
ßß 
{
ßß 
Length
ßß  &
:
ßß& '
>
ßß( )
$num
ßß* +
}
ßß, -
)
ßß- .
{
®® 	%
CryptographicOperations
©© #
.
©©# $

ZeroMemory
©©$ .
(
©©. /
recoveryRecord
©©/ =
)
©©= >
;
©©> ?
}
™™ 	
if
¨¨ 

(
¨¨ 
	masterKey
¨¨ 
is
¨¨ 
{
¨¨ 
Length
¨¨ !
:
¨¨! "
>
¨¨# $
$num
¨¨% &
}
¨¨' (
)
¨¨( )
{
≠≠ 	%
CryptographicOperations
ÆÆ #
.
ÆÆ# $

ZeroMemory
ÆÆ$ .
(
ÆÆ. /
	masterKey
ÆÆ/ 8
)
ÆÆ8 9
;
ÆÆ9 :
}
ØØ 	
}
∞∞ 
private
≤≤ 
Result
≤≤ 
<
≤≤  
RegistrationResult
≤≤ %
,
≤≤% &
string
≤≤' -
>
≤≤- .,
CreateSecureKeyRecoveryRequest
≤≤/ M
(
≤≤M N
OpaqueClient
≥≥ 
opaqueClient
≥≥ !
,
≥≥! "
SecureTextBuffer
¥¥ 
newSecureKey
¥¥ %
)
¥¥% &
{
µµ 
try
∂∂ 
{
∑∑ 	 
RegistrationResult
∏∏ 
?
∏∏  
registrationResult
∏∏  2
=
∏∏3 4
null
∏∏5 9
;
∏∏9 :
newSecureKey
∫∫ 
.
∫∫ 
WithSecureBytes
∫∫ (
(
∫∫( )
secureKeyBytes
∫∫) 7
=>
∫∫8 :
{
ªª 
byte
ºº 
[
ºº 
]
ºº 
secureKeyCopy
ºº $
=
ºº% &
secureKeyBytes
ºº' 5
.
ºº5 6
ToArray
ºº6 =
(
ºº= >
)
ºº> ?
;
ºº? @
try
ΩΩ 
{
ææ  
registrationResult
øø &
=
øø' (
opaqueClient
øø) 5
.
øø5 6'
CreateRegistrationRequest
øø6 O
(
øøO P
secureKeyCopy
øøP ]
)
øø] ^
;
øø^ _
}
¿¿ 
finally
¡¡ 
{
¬¬ %
CryptographicOperations
√√ +
.
√√+ ,

ZeroMemory
√√, 6
(
√√6 7
secureKeyCopy
√√7 D
)
√√D E
;
√√E F
}
ƒƒ 
}
≈≈ 
)
≈≈ 
;
≈≈ 
if
«« 
(
««  
registrationResult
«« "
is
««# %
null
««& *
)
««* +
{
»» 
throw
…… 
new
…… '
InvalidOperationException
…… 3
(
……3 4
$str
……4 ]
)
……] ^
;
……^ _
}
   
return
ÃÃ 
Result
ÃÃ 
<
ÃÃ  
RegistrationResult
ÃÃ ,
,
ÃÃ, -
string
ÃÃ. 4
>
ÃÃ4 5
.
ÃÃ5 6
Ok
ÃÃ6 8
(
ÃÃ8 9 
registrationResult
ÃÃ9 K
)
ÃÃK L
;
ÃÃL M
}
ÕÕ 	
catch
ŒŒ 
(
ŒŒ 
	Exception
ŒŒ 
ex
ŒŒ 
)
ŒŒ 
{
œœ 	
return
–– 
Result
–– 
<
––  
RegistrationResult
–– ,
,
––, -
string
––. 4
>
––4 5
.
––5 6
Err
––6 9
(
––9 :
$"
—— 
{
—— !
localizationService
—— &
[
——& '%
AuthenticationConstants
——' >
.
——> ?%
REGISTRATION_FAILED_KEY
——? V
]
——V W
}
——W X
$str
——X Z
{
——Z [
ex
——[ ]
.
——] ^
Message
——^ e
}
——e f
"
——f g
)
——g h
;
——h i
}
““ 	
}
”” 
private
’’ 
async
’’ 
Task
’’ 
<
’’ 
Result
’’ 
<
’’ 
Unit
’’ "
,
’’" #
string
’’$ *
>
’’* +
>
’’+ ,2
$ProcessSecureKeyRecoveryInitResponse
’’- Q
(
’’Q R1
#OpaqueRecoverySecureKeyInitResponse
÷÷ +
initResponse
÷÷, 8
)
÷÷8 9
{
◊◊ 
if
ÿÿ 

(
ÿÿ 
initResponse
ÿÿ 
.
ÿÿ 
Result
ÿÿ 
!=
ÿÿ  "1
#OpaqueRecoverySecureKeyInitResponse
ÿÿ# F
.
ÿÿF G
Types
ÿÿG L
.
ÿÿL M
RecoveryResult
ÿÿM [
.
ÿÿ[ \
	Succeeded
ÿÿ\ e
)
ÿÿe f
{
ŸŸ 	
string
⁄⁄ 
errorMessage
⁄⁄ 
=
⁄⁄  !
initResponse
⁄⁄" .
.
⁄⁄. /
Result
⁄⁄/ 5
switch
⁄⁄6 <
{
€€ 1
#OpaqueRecoverySecureKeyInitResponse
‹‹ 3
.
‹‹3 4
Types
‹‹4 9
.
‹‹9 :
RecoveryResult
‹‹: H
.
‹‹H I 
InvalidCredentials
‹‹I [
=>
‹‹\ ^!
localizationService
›› '
[
››' (%
AuthenticationConstants
››( ?
.
››? @%
INVALID_CREDENTIALS_KEY
››@ W
]
››W X
,
››X Y
_
ﬁﬁ 
=>
ﬁﬁ !
localizationService
ﬁﬁ (
[
ﬁﬁ( )%
AuthenticationConstants
ﬁﬁ) @
.
ﬁﬁ@ A%
REGISTRATION_FAILED_KEY
ﬁﬁA X
]
ﬁﬁX Y
}
ﬂﬂ 
;
ﬂﬂ 
return
‡‡ 
Result
‡‡ 
<
‡‡ 
Unit
‡‡ 
,
‡‡ 
string
‡‡  &
>
‡‡& '
.
‡‡' (
Err
‡‡( +
(
‡‡+ ,
errorMessage
‡‡, 8
)
‡‡8 9
;
‡‡9 :
}
·· 	
if
„„ 

(
„„ 
initResponse
„„ 
.
„„ 

Membership
„„ #
?
„„# $
.
„„$ %%
AccountUniqueIdentifier
„„% <
!=
„„= ?
null
„„@ D
&&
„„E G
initResponse
‰‰ 
.
‰‰ 

Membership
‰‰ #
.
‰‰# $%
AccountUniqueIdentifier
‰‰$ ;
.
‰‰; <
Length
‰‰< B
>
‰‰C D
$num
‰‰E F
)
‰‰F G
{
ÂÂ 	
await
ÊÊ .
 applicationSecureStorageProvider
ÊÊ 2
.
ÁÁ &
SetCurrentAccountIdAsync
ÁÁ )
(
ÁÁ) *
initResponse
ÁÁ* 6
.
ÁÁ6 7

Membership
ÁÁ7 A
.
ÁÁA B%
AccountUniqueIdentifier
ÁÁB Y
)
ÁÁY Z
.
ËË 
ConfigureAwait
ËË 
(
ËË  
false
ËË  %
)
ËË% &
;
ËË& '
}
ÈÈ 	
return
ÎÎ 
Result
ÎÎ 
<
ÎÎ 
Unit
ÎÎ 
,
ÎÎ 
string
ÎÎ "
>
ÎÎ" #
.
ÎÎ# $
Ok
ÎÎ$ &
(
ÎÎ& '
Unit
ÎÎ' +
.
ÎÎ+ ,
Value
ÎÎ, 1
)
ÎÎ1 2
;
ÎÎ2 3
}
ÏÏ 
private
ÓÓ 
async
ÓÓ 
Task
ÓÓ 
<
ÓÓ 
Result
ÓÓ 
<
ÓÓ 
Unit
ÓÓ "
,
ÓÓ" #
string
ÓÓ$ *
>
ÓÓ* +
>
ÓÓ+ ,,
FinalizeSecureKeyRecoveryAsync
ÓÓ- K
(
ÓÓK L
OpaqueClient
ÔÔ 
opaqueClient
ÔÔ !
,
ÔÔ! "1
#OpaqueRecoverySecureKeyInitResponse
 +
initResponse
, 8
,
8 9 
RegistrationResult
ÒÒ  
registrationResult
ÒÒ -
,
ÒÒ- .

ByteString
ÚÚ "
membershipIdentifier
ÚÚ '
,
ÚÚ' (
uint
ÛÛ 
	connectId
ÛÛ 
,
ÛÛ 
CancellationToken
ÙÙ 
cancellationToken
ÙÙ +
)
ÙÙ+ ,
{
ıı 
byte
ˆˆ 
[
ˆˆ 
]
ˆˆ 
?
ˆˆ $
serverRecoveryResponse
ˆˆ &
=
ˆˆ' (
null
ˆˆ) -
;
ˆˆ- .
byte
˜˜ 
[
˜˜ 
]
˜˜ 
?
˜˜ 
recoveryRecord
˜˜ 
=
˜˜  
null
˜˜! %
;
˜˜% &
byte
¯¯ 
[
¯¯ 
]
¯¯ 
?
¯¯ 
	masterKey
¯¯ 
=
¯¯ 
null
¯¯  
;
¯¯  !
try
˙˙ 
{
˚˚ 	$
serverRecoveryResponse
¸¸ "
=
¸¸# $%
SecureByteStringInterop
˝˝ '
.
˝˝' ("
WithByteStringAsSpan
˝˝( <
(
˝˝< =
initResponse
˝˝= I
.
˝˝I J
PeerOprf
˝˝J R
,
˝˝R S
span
˝˝T X
=>
˝˝Y [
span
˝˝\ `
.
˝˝` a
ToArray
˝˝a h
(
˝˝h i
)
˝˝i j
)
˝˝j k
;
˝˝k l
(
ˇˇ 
byte
ˇˇ 
[
ˇˇ 
]
ˇˇ 
record
ˇˇ 
,
ˇˇ 
byte
ˇˇ  
[
ˇˇ  !
]
ˇˇ! " 
generatedMasterKey
ˇˇ# 5
)
ˇˇ5 6
=
ˇˇ7 8
opaqueClient
ÄÄ 
.
ÄÄ "
FinalizeRegistration
ÄÄ 1
(
ÄÄ1 2$
serverRecoveryResponse
ÄÄ2 H
,
ÄÄH I 
registrationResult
ÄÄJ \
)
ÄÄ\ ]
;
ÄÄ] ^
recoveryRecord
ÅÅ 
=
ÅÅ 
record
ÅÅ #
;
ÅÅ# $
	masterKey
ÇÇ 
=
ÇÇ  
generatedMasterKey
ÇÇ *
;
ÇÇ* +4
&OpaqueRecoverySecretKeyCompleteRequest
ÑÑ 2
completeRequest
ÑÑ3 B
=
ÑÑC D
new
ÑÑE H
(
ÑÑH I
)
ÑÑI J
{
ÖÖ  
PeerRecoveryRecord
ÜÜ "
=
ÜÜ# $

ByteString
ÜÜ% /
.
ÜÜ/ 0
CopyFrom
ÜÜ0 8
(
ÜÜ8 9
recoveryRecord
ÜÜ9 G
)
ÜÜG H
,
ÜÜH I"
MembershipIdentifier
áá $
=
áá% &"
membershipIdentifier
áá' ;
,
áá; <
	MasterKey
àà 
=
àà 

ByteString
àà &
.
àà& '
CopyFrom
àà' /
(
àà/ 0
	masterKey
àà0 9
)
àà9 :
}
ââ 
;
ââ "
TaskCompletionSource
ãã  
<
ãã  !5
'OpaqueRecoverySecretKeyCompleteResponse
ãã! H
>
ããH I
responseSource
ããJ X
=
ããY Z
new
ãã[ ^
(
ãã^ _
)
ãã_ `
;
ãã` a
Result
çç 
<
çç 
Unit
çç 
,
çç 
NetworkFailure
çç '
>
çç' (
networkResult
çç) 6
=
çç7 8
await
çç9 >
networkProvider
çç? N
.
ççN O&
ExecuteUnaryRequestAsync
ççO g
(
ççg h
	connectId
éé 
,
éé 
RpcServiceType
èè 
.
èè '
RecoverySecretKeyComplete
èè 8
,
èè8 9%
SecureByteStringInterop
êê '
.
êê' ("
WithByteStringAsSpan
êê( <
(
êê< =
completeRequest
êê= L
.
êêL M
ToByteString
êêM Y
(
êêY Z
)
êêZ [
,
êê[ \
span
êê] a
=>
êêb d
span
êêe i
.
êêi j
ToArray
êêj q
(
êêq r
)
êêr s
)
êês t
,
êêt u
payload
ëë 
=>
ëë 
{
íí 5
'OpaqueRecoverySecretKeyCompleteResponse
ìì ;
response
ìì< D
=
ììE F
Helpers
îî 
.
îî  
ParseFromBytes
îî  .
<
îî. /5
'OpaqueRecoverySecretKeyCompleteResponse
îî/ V
>
îîV W
(
îîW X
payload
îîX _
)
îî_ `
;
îî` a
responseSource
ïï "
.
ïï" #
TrySetResult
ïï# /
(
ïï/ 0
response
ïï0 8
)
ïï8 9
;
ïï9 :
return
óó 
Task
óó 
.
óó  

FromResult
óó  *
(
óó* +
Result
óó+ 1
<
óó1 2
Unit
óó2 6
,
óó6 7
NetworkFailure
óó8 F
>
óóF G
.
óóG H
Ok
óóH J
(
óóJ K
Unit
óóK O
.
óóO P
Value
óóP U
)
óóU V
)
óóV W
;
óóW X
}
òò 
,
òò 
true
òò 
,
òò 
cancellationToken
òò *
)
òò* +
.
òò+ ,
ConfigureAwait
òò, :
(
òò: ;
false
òò; @
)
òò@ A
;
òòA B
if
öö 
(
öö 
networkResult
öö 
.
öö 
IsErr
öö #
)
öö# $
{
õõ 
return
úú 
Result
úú 
<
úú 
Unit
úú "
,
úú" #
string
úú$ *
>
úú* +
.
úú+ ,
Err
úú, /
(
úú/ 0
networkResult
úú0 =
.
úú= >
	UnwrapErr
úú> G
(
úúG H
)
úúH I
.
úúI J
Message
úúJ Q
)
úúQ R
;
úúR S
}
ùù 
await
üü 
responseSource
üü  
.
üü  !
Task
üü! %
.
üü% &
ConfigureAwait
üü& 4
(
üü4 5
false
üü5 :
)
üü: ;
;
üü; <
return
†† 
Result
†† 
<
†† 
Unit
†† 
,
†† 
string
††  &
>
††& '
.
††' (
Ok
††( *
(
††* +
Unit
††+ /
.
††/ 0
Value
††0 5
)
††5 6
;
††6 7
}
°° 	
finally
¢¢ 
{
££ 	*
CleanupSensitiveRecoveryData
§§ (
(
§§( )
null
§§) -
,
§§- .$
serverRecoveryResponse
§§/ E
,
§§E F
recoveryRecord
§§G U
,
§§U V
	masterKey
§§W `
)
§§` a
;
§§a b
}
•• 	
}
¶¶ 
public
®® 

void
®® 
Dispose
®® 
(
®® 
)
®® 
{
©© 
if
™™ 

(
™™ 
	_disposed
™™ 
)
™™ 
{
´´ 	
return
¨¨ 
;
¨¨ 
}
≠≠ 	
lock
ØØ 
(
ØØ 
_opaqueClientLock
ØØ 
)
ØØ  
{
∞∞ 	
_opaqueClient
±± 
.
±± 
Do
±± 
(
±± 
client
±± #
=>
±±$ &
client
±±' -
.
±±- .
Dispose
±±. 5
(
±±5 6
)
±±6 7
)
±±7 8
;
±±8 9
_opaqueClient
≤≤ 
=
≤≤ 
Option
≤≤ "
<
≤≤" #
OpaqueClient
≤≤# /
>
≤≤/ 0
.
≤≤0 1
None
≤≤1 5
;
≤≤5 6
}
≥≥ 	
	_disposed
µµ 
=
µµ 
true
µµ 
;
µµ 
}
∂∂ 
private
∏∏ 
OpaqueClient
∏∏ %
GetOrCreateOpaqueClient
∏∏ 0
(
∏∏0 1
)
∏∏1 2
{
ππ 
byte
∫∫ 
[
∫∫ 
]
∫∫ 
serverPublicKey
∫∫ 
=
∫∫  %
serverPublicKeyProvider
∫∫! 8
.
∫∫8 9 
GetServerPublicKey
∫∫9 K
(
∫∫K L
)
∫∫L M
;
∫∫M N
lock
ºº 
(
ºº 
_opaqueClientLock
ºº 
)
ºº  
{
ΩΩ 	
if
ææ 
(
ææ 
_opaqueClient
ææ 
.
ææ 
IsSome
ææ $
&&
ææ% '$
_cachedServerPublicKey
ææ( >
!=
ææ? A
null
ææB F
&&
ææG I%
CryptographicOperations
øø '
.
øø' (
FixedTimeEquals
øø( 7
(
øø7 8
serverPublicKey
øø8 G
,
øøG H$
_cachedServerPublicKey
øøI _
)
øø_ `
)
øø` a
{
¿¿ 
return
¡¡ 
_opaqueClient
¡¡ $
.
¡¡$ %
Value
¡¡% *
!
¡¡* +
;
¡¡+ ,
}
¬¬ 
_opaqueClient
ƒƒ 
.
ƒƒ 
Do
ƒƒ 
(
ƒƒ 
client
ƒƒ #
=>
ƒƒ$ &
client
ƒƒ' -
.
ƒƒ- .
Dispose
ƒƒ. 5
(
ƒƒ5 6
)
ƒƒ6 7
)
ƒƒ7 8
;
ƒƒ8 9
OpaqueClient
≈≈ 
	newClient
≈≈ "
=
≈≈# $
new
≈≈% (
(
≈≈( )
serverPublicKey
≈≈) 8
)
≈≈8 9
;
≈≈9 :
_opaqueClient
∆∆ 
=
∆∆ 
Option
∆∆ "
<
∆∆" #
OpaqueClient
∆∆# /
>
∆∆/ 0
.
∆∆0 1
Some
∆∆1 5
(
∆∆5 6
	newClient
∆∆6 ?
)
∆∆? @
;
∆∆@ A$
_cachedServerPublicKey
«« "
=
««# $
(
««% &
byte
««& *
[
««* +
]
««+ ,
)
««, -
serverPublicKey
««- <
.
««< =
Clone
««= B
(
««B C
)
««C D
;
««D E
return
…… 
	newClient
…… 
;
…… 
}
   	
}
ÀÀ 
private
ÕÕ 
async
ÕÕ 
Task
ÕÕ 
<
ÕÕ 
Result
ÕÕ 
<
ÕÕ 1
#OpaqueRecoverySecureKeyInitResponse
ÕÕ A
,
ÕÕA B
string
ÕÕC I
>
ÕÕI J
>
ÕÕJ K,
InitiateSecureKeyRecoveryAsync
ÕÕL j
(
ÕÕj k

ByteString
ŒŒ "
membershipIdentifier
ŒŒ '
,
ŒŒ' (
byte
œœ 
[
œœ 
]
œœ 
recoveryRequest
œœ 
,
œœ 
uint
–– 
	connectId
–– 
,
–– 
CancellationToken
—— 
cancellationToken
—— +
)
——+ ,
{
““ 
if
”” 

(
”” "
membershipIdentifier
””  
.
””  !
IsEmpty
””! (
)
””( )
{
‘‘ 	
return
’’ 
Result
’’ 
<
’’ 1
#OpaqueRecoverySecureKeyInitResponse
’’ =
,
’’= >
string
’’? E
>
’’E F
.
’’F G
Err
’’G J
(
’’J K!
localizationService
÷÷ #
[
÷÷# $%
AuthenticationConstants
÷÷$ ;
.
÷÷; <0
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY
÷÷< ^
]
÷÷^ _
)
÷÷_ `
;
÷÷` a
}
◊◊ 	
try
ŸŸ 
{
⁄⁄ 	0
"OpaqueRecoverySecureKeyInitRequest
€€ .
request
€€/ 6
=
€€7 8
new
€€9 <
(
€€< =
)
€€= >
{
‹‹ 
PeerOprf
›› 
=
›› 

ByteString
›› %
.
››% &
CopyFrom
››& .
(
››. /
recoveryRequest
››/ >
)
››> ?
,
››? @"
MembershipIdentifier
ﬁﬁ $
=
ﬁﬁ% &"
membershipIdentifier
ﬁﬁ' ;
}
ﬂﬂ 
;
ﬂﬂ "
TaskCompletionSource
··  
<
··  !1
#OpaqueRecoverySecureKeyInitResponse
··! D
>
··D E
responseSource
··F T
=
··U V
new
··W Z
(
··Z [
)
··[ \
;
··\ ]
Result
„„ 
<
„„ 
Unit
„„ 
,
„„ 
NetworkFailure
„„ '
>
„„' (
networkResult
„„) 6
=
„„7 8
await
„„9 >
networkProvider
„„? N
.
„„N O&
ExecuteUnaryRequestAsync
„„O g
(
„„g h
	connectId
‰‰ 
,
‰‰ 
RpcServiceType
ÂÂ 
.
ÂÂ #
RecoverySecretKeyInit
ÂÂ 4
,
ÂÂ4 5%
SecureByteStringInterop
ÊÊ '
.
ÊÊ' ("
WithByteStringAsSpan
ÊÊ( <
(
ÊÊ< =
request
ÊÊ= D
.
ÊÊD E
ToByteString
ÊÊE Q
(
ÊÊQ R
)
ÊÊR S
,
ÊÊS T
span
ÊÊU Y
=>
ÊÊZ \
span
ÊÊ] a
.
ÊÊa b
ToArray
ÊÊb i
(
ÊÊi j
)
ÊÊj k
)
ÊÊk l
,
ÊÊl m
payload
ÊÊn u
=>
ÊÊv x
{
ÁÁ 1
#OpaqueRecoverySecureKeyInitResponse
ËË 7
response
ËË8 @
=
ËËA B
Helpers
ÈÈ 
.
ÈÈ  
ParseFromBytes
ÈÈ  .
<
ÈÈ. /1
#OpaqueRecoverySecureKeyInitResponse
ÈÈ/ R
>
ÈÈR S
(
ÈÈS T
payload
ÈÈT [
)
ÈÈ[ \
;
ÈÈ\ ]
responseSource
ÍÍ "
.
ÍÍ" #
TrySetResult
ÍÍ# /
(
ÍÍ/ 0
response
ÍÍ0 8
)
ÍÍ8 9
;
ÍÍ9 :
return
ÏÏ 
Task
ÏÏ 
.
ÏÏ  

FromResult
ÏÏ  *
(
ÏÏ* +
Result
ÏÏ+ 1
<
ÏÏ1 2
Unit
ÏÏ2 6
,
ÏÏ6 7
NetworkFailure
ÏÏ8 F
>
ÏÏF G
.
ÏÏG H
Ok
ÏÏH J
(
ÏÏJ K
Unit
ÏÏK O
.
ÏÏO P
Value
ÏÏP U
)
ÏÏU V
)
ÏÏV W
;
ÏÏW X
}
ÌÌ 
,
ÌÌ 
true
ÌÌ 
,
ÌÌ 
cancellationToken
ÌÌ *
)
ÌÌ* +
.
ÌÌ+ ,
ConfigureAwait
ÌÌ, :
(
ÌÌ: ;
false
ÌÌ; @
)
ÌÌ@ A
;
ÌÌA B
if
ÔÔ 
(
ÔÔ 
networkResult
ÔÔ 
.
ÔÔ 
IsErr
ÔÔ #
)
ÔÔ# $
{
 
return
ÒÒ 
Result
ÒÒ 
<
ÒÒ 1
#OpaqueRecoverySecureKeyInitResponse
ÒÒ A
,
ÒÒA B
string
ÒÒC I
>
ÒÒI J
.
ÒÒJ K
Err
ÒÒK N
(
ÒÒN O
networkResult
ÒÒO \
.
ÒÒ\ ]
	UnwrapErr
ÒÒ] f
(
ÒÒf g
)
ÒÒg h
.
ÒÒh i
Message
ÒÒi p
)
ÒÒp q
;
ÒÒq r
}
ÚÚ 1
#OpaqueRecoverySecureKeyInitResponse
ÙÙ /
initResponse
ÙÙ0 <
=
ÙÙ= >
await
ÙÙ? D
responseSource
ÙÙE S
.
ÙÙS T
Task
ÙÙT X
.
ÙÙX Y
ConfigureAwait
ÙÙY g
(
ÙÙg h
false
ÙÙh m
)
ÙÙm n
;
ÙÙn o
return
ıı 
Result
ıı 
<
ıı 1
#OpaqueRecoverySecureKeyInitResponse
ıı =
,
ıı= >
string
ıı? E
>
ııE F
.
ııF G
Ok
ııG I
(
ııI J
initResponse
ııJ V
)
ııV W
;
ııW X
}
ˆˆ 	
catch
˜˜ 
(
˜˜ 
	Exception
˜˜ 
ex
˜˜ 
)
˜˜ 
{
¯¯ 	
return
˘˘ 
Result
˘˘ 
<
˘˘ 1
#OpaqueRecoverySecureKeyInitResponse
˘˘ =
,
˘˘= >
string
˘˘? E
>
˘˘E F
.
˘˘F G
Err
˘˘G J
(
˘˘J K
ex
˘˘K M
.
˘˘M N
Message
˘˘N U
)
˘˘U V
;
˘˘V W
}
˙˙ 	
}
˚˚ 
}¸¸ ô’
ã/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/OpaqueRegistrationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
;/ 0
internal 
sealed	 
class %
OpaqueRegistrationService /
(/ 0
NetworkProvider   
networkProvider   #
,  # $ 
ILocalizationService!! 
localizationService!! ,
,!!, -$
IServerPublicKeyProvider"" #
serverPublicKeyProvider"" 4
,""4 5-
!IApplicationSecureStorageProvider## %,
 applicationSecureStorageProvider##& F
)##F G
:$$ &
IOpaqueRegistrationService$$  
,$$  !
IDisposable$$" -
{%% 
private&& 
readonly&&  
ConcurrentDictionary&& )
<&&) *
Guid&&* .
,&&. /
uint&&0 4
>&&4 5
_activeStreams&&6 D
=&&E F
new&&G J
(&&J K
)&&K L
;&&L M
private'' 
readonly''  
ConcurrentDictionary'' )
<'') *
Guid''* .
,''. /
VerificationPurpose''0 C
>''C D"
_activeSessionPurposes''E [
=''\ ]
new''^ a
(''a b
)''b c
;''c d
private)) 
readonly))  
ConcurrentDictionary)) )
<))) *

ByteString))* 4
,))4 5
RegistrationResult))6 H
>))H I$
_opaqueRegistrationState))J b
=))c d
new))e h
())h i
)))i j
;))j k
private++ 
readonly++ 
Lock++ 
_opaqueClientLock++ +
=++, -
new++. 1
(++1 2
)++2 3
;++3 4
private,, 
Option,, 
<,, 
OpaqueClient,, 
>,,  
_opaqueClient,,! .
=,,/ 0
Option,,1 7
<,,7 8
OpaqueClient,,8 D
>,,D E
.,,E F
None,,F J
;,,J K
public.. 

async.. 
Task.. 
<.. 
Result.. 
<.. (
ValidateMobileNumberResponse.. 9
,..9 :
string..; A
>..A B
>..B C%
ValidateMobileNumberAsync..D ]
(..] ^
string// 
mobileNumber// 
,// 
uint00 
	connectId00 
,00 
CancellationToken11 
cancellationToken11 +
=11, -
default11. 5
)115 6
{22 
if33 

(33 
string33 
.33 
IsNullOrEmpty33  
(33  !
mobileNumber33! -
)33- .
)33. /
{44 	
return55 
Result55 
<55 (
ValidateMobileNumberResponse55 6
,556 7
string558 >
>55> ?
.55? @
Err55@ C
(55C D
localizationService66 #
[66# $#
AuthenticationConstants66$ ;
.66; <&
MOBILE_NUMBER_REQUIRED_KEY66< V
]66V W
)66W X
;66X Y
}77 	'
ValidateMobileNumberRequest99 #
request99$ +
=99, -
new99. 1
(991 2
)992 3
{:: 	
MobileNumber;; 
=;; 
mobileNumber;; '
}<< 	
;<<	 
 
TaskCompletionSource>> 
<>> (
ValidateMobileNumberResponse>> 9
>>>9 :
responseSource>>; I
=>>J K
new>>L O
(>>O P
)>>P Q
;>>Q R
Result@@ 
<@@ 
Unit@@ 
,@@ 
NetworkFailure@@ #
>@@# $
networkResult@@% 2
=@@3 4
await@@5 :
networkProvider@@; J
.@@J K$
ExecuteUnaryRequestAsync@@K c
(@@c d
	connectIdAA 
,AA 
RpcServiceTypeBB 
.BB  
ValidateMobileNumberBB /
,BB/ 0#
SecureByteStringInteropCC #
.CC# $ 
WithByteStringAsSpanCC$ 8
(CC8 9
requestCC9 @
.CC@ A
ToByteStringCCA M
(CCM N
)CCN O
,CCO P
spanCCQ U
=>CCV X
spanCCY ]
.CC] ^
ToArrayCC^ e
(CCe f
)CCf g
)CCg h
,CCh i
payloadCCj q
=>CCr t
{DD (
ValidateMobileNumberResponseEE ,
responseEE- 5
=EE6 7
HelpersEE8 ?
.EE? @
ParseFromBytesEE@ N
<EEN O(
ValidateMobileNumberResponseEEO k
>EEk l
(EEl m
payloadEEm t
)EEt u
;EEu v
responseSourceFF 
.FF 
TrySetResultFF +
(FF+ ,
responseFF, 4
)FF4 5
;FF5 6
returnHH 
TaskHH 
.HH 

FromResultHH &
(HH& '
ResultHH' -
<HH- .
UnitHH. 2
,HH2 3
NetworkFailureHH4 B
>HHB C
.HHC D
OkHHD F
(HHF G
UnitHHG K
.HHK L
ValueHHL Q
)HHQ R
)HHR S
;HHS T
}II 
,II 
trueII 
,II 
cancellationTokenII &
)II& '
.II' (
ConfigureAwaitII( 6
(II6 7
falseII7 <
)II< =
;II= >
ifKK 

(KK 
networkResultKK 
.KK 
IsErrKK 
)KK  
{LL 	
returnMM 
ResultMM 
<MM (
ValidateMobileNumberResponseMM 6
,MM6 7
stringMM8 >
>MM> ?
.MM? @
ErrMM@ C
(MMC D
networkResultMMD Q
.MMQ R
	UnwrapErrMMR [
(MM[ \
)MM\ ]
.MM] ^
MessageMM^ e
)MMe f
;MMf g
}NN 	(
ValidateMobileNumberResponsePP $

identifierPP% /
=PP0 1
awaitPP2 7
responseSourcePP8 F
.PPF G
TaskPPG K
.PPK L
ConfigureAwaitPPL Z
(PPZ [
falsePP[ `
)PP` a
;PPa b
returnQQ 
ResultQQ 
<QQ (
ValidateMobileNumberResponseQQ 2
,QQ2 3
stringQQ4 :
>QQ: ;
.QQ; <
OkQQ< >
(QQ> ?

identifierQQ? I
)QQI J
;QQJ K
}RR 
publicTT 

asyncTT 
TaskTT 
<TT 
ResultTT 
<TT 1
%CheckMobileNumberAvailabilityResponseTT B
,TTB C
stringTTD J
>TTJ K
>TTK L.
"CheckMobileNumberAvailabilityAsyncUU *
(UU* +

ByteStringVV "
mobileNumberIdentifierVV -
,VV- .
uintWW 
	connectIdWW 
,WW 
CancellationTokenXX 
cancellationTokenXX /
=XX0 1
defaultXX2 9
)XX9 :
{YY 
ifZZ 

(ZZ "
mobileNumberIdentifierZZ "
.ZZ" #
IsEmptyZZ# *
)ZZ* +
{[[ 	
return\\ 
Result\\ 
<\\ 1
%CheckMobileNumberAvailabilityResponse\\ ?
,\\? @
string\\A G
>\\G H
.\\H I
Err\\I L
(\\L M
localizationService]] #
[]]# $#
AuthenticationConstants]]$ ;
.]]; <1
%MOBILE_NUMBER_IDENTIFIER_REQUIRED_KEY]]< a
]]]a b
)]]b c
;]]c d
}^^ 	0
$CheckMobileNumberAvailabilityRequest`` ,
request``- 4
=``5 6
new``7 :
(``: ;
)``; <
{aa 	
MobileNumberIdbb 
=bb "
mobileNumberIdentifierbb 3
}cc 	
;cc	 
 
TaskCompletionSourceee 
<ee 1
%CheckMobileNumberAvailabilityResponseee B
>eeB C
responseSourceeeD R
=eeS T
neweeU X
(eeX Y
)eeY Z
;eeZ [
Resultgg 
<gg 
Unitgg 
,gg 
NetworkFailuregg #
>gg# $
networkResultgg% 2
=gg3 4
awaitgg5 :
networkProvidergg; J
.ggJ K$
ExecuteUnaryRequestAsyncggK c
(ggc d
	connectIdhh 
,hh 
RpcServiceTypeii 
.ii )
CheckMobileNumberAvailabilityii 8
,ii8 9#
SecureByteStringInteropjj #
.jj# $ 
WithByteStringAsSpanjj$ 8
(jj8 9
requestjj9 @
.jj@ A
ToByteStringjjA M
(jjM N
)jjN O
,jjO P
spanjjQ U
=>jjV X
spanjjY ]
.jj] ^
ToArrayjj^ e
(jje f
)jjf g
)jjg h
,jjh i
payloadjjj q
=>jjr t
{kk 1
%CheckMobileNumberAvailabilityResponsell 5
responsell6 >
=ll? @
Helpersmm 
.mm 
ParseFromBytesmm *
<mm* +1
%CheckMobileNumberAvailabilityResponsemm+ P
>mmP Q
(mmQ R
payloadmmR Y
)mmY Z
;mmZ [
responseSourcenn 
.nn 
TrySetResultnn +
(nn+ ,
responsenn, 4
)nn4 5
;nn5 6
returnoo 
Taskoo 
.oo 

FromResultoo &
(oo& '
Resultoo' -
<oo- .
Unitoo. 2
,oo2 3
NetworkFailureoo4 B
>ooB C
.ooC D
OkooD F
(ooF G
UnitooG K
.ooK L
ValueooL Q
)ooQ R
)ooR S
;ooS T
}pp 
,pp 
truepp 
,pp 
cancellationTokenpp &
)pp& '
.pp' (
ConfigureAwaitpp( 6
(pp6 7
falsepp7 <
)pp< =
;pp= >
ifrr 

(rr 
networkResultrr 
.rr 
IsErrrr 
)rr  
{ss 	
returntt 
Resulttt 
<tt 1
%CheckMobileNumberAvailabilityResponsett ?
,tt? @
stringttA G
>ttG H
.ttH I
ErrttI L
(ttL M
networkResultttM Z
.ttZ [
	UnwrapErrtt[ d
(ttd e
)tte f
.ttf g
Messagettg n
)ttn o
;tto p
}uu 	1
%CheckMobileNumberAvailabilityResponseww -
statusResponseww. <
=ww= >
awaitww? D
responseSourcewwE S
.wwS T
TaskwwT X
.wwX Y
ConfigureAwaitwwY g
(wwg h
falsewwh m
)wwm n
;wwn o
returnxx 
Resultxx 
<xx 1
%CheckMobileNumberAvailabilityResponsexx ;
,xx; <
stringxx= C
>xxC D
.xxD E
OkxxE G
(xxG H
statusResponsexxH V
)xxV W
;xxW X
}yy 
public{{ 

async{{ 
Task{{ 
<{{ 
Result{{ 
<{{ 
Unit{{ !
,{{! "
string{{# )
>{{) *
>{{* +(
InitiateOtpVerificationAsync{{, H
({{H I

ByteString|| "
mobileNumberIdentifier|| )
,||) *
VerificationPurpose}} 
purpose}} #
=}}$ %
VerificationPurpose}}& 9
.}}9 :
Registration}}: F
,}}F G
Action~~ 
<~~ 
uint~~ 
,~~ 
Guid~~ 
,~~ '
VerificationCountdownUpdate~~ 6
.~~6 7
Types~~7 <
.~~< =!
CountdownUpdateStatus~~= R
,~~R S
string~~T Z
?~~Z [
>~~[ \
?~~\ ]
onCountdownUpdate~~^ o
=~~p q
null~~r v
,~~v w
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
{
ÄÄ 
if
ÅÅ 

(
ÅÅ $
mobileNumberIdentifier
ÅÅ "
.
ÅÅ" #
IsEmpty
ÅÅ# *
)
ÅÅ* +
{
ÇÇ 	
return
ÉÉ 
Result
ÉÉ 
<
ÉÉ 
Unit
ÉÉ 
,
ÉÉ 
string
ÉÉ  &
>
ÉÉ& '
.
ÉÉ' (
Err
ÉÉ( +
(
ÉÉ+ ,!
localizationService
ÑÑ #
[
ÑÑ# $%
AuthenticationConstants
ÑÑ$ ;
.
ÑÑ; <3
%MOBILE_NUMBER_IDENTIFIER_REQUIRED_KEY
ÑÑ< a
]
ÑÑa b
)
ÑÑb c
;
ÑÑc d
}
ÖÖ 	
Result
áá 
<
áá 
uint
áá 
,
áá 
NetworkFailure
áá #
>
áá# $
protocolResult
áá% 3
=
áá4 5
await
àà 
networkProvider
àà !
.
àà! "(
EnsureProtocolForTypeAsync
àà" <
(
àà< = 
PubKeyExchangeType
ââ "
.
ââ" #
ServerStreaming
ââ# 2
)
ââ2 3
.
ââ3 4
ConfigureAwait
ââ4 B
(
ââB C
false
ââC H
)
ââH I
;
ââI J
if
ãã 

(
ãã 
protocolResult
ãã 
.
ãã 
IsErr
ãã  
)
ãã  !
{
åå 	
return
çç 
Result
çç 
<
çç 
Unit
çç 
,
çç 
string
çç  &
>
çç& '
.
çç' (
Err
çç( +
(
çç+ ,
$"
éé 
{
éé %
AuthenticationConstants
éé *
.
éé* +)
VERIFICATION_FAILURE_PREFIX
éé+ F
}
ééF G
{
ééG H
protocolResult
ééH V
.
ééV W
	UnwrapErr
ééW `
(
éé` a
)
ééa b
.
ééb c
Message
ééc j
}
ééj k
"
éék l
)
éél m
;
éém n
}
èè 	
uint
ëë 
streamConnectId
ëë 
=
ëë 
protocolResult
ëë -
.
ëë- .
Unwrap
ëë. 4
(
ëë4 5
)
ëë5 6
;
ëë6 7)
InitiateVerificationRequest
ìì #
request
ìì$ +
=
ìì, -
new
ìì. 1
(
ìì1 2
)
ìì2 3
{
îî 	$
MobileNumberIdentifier
ïï "
=
ïï# $$
mobileNumberIdentifier
ïï% ;
,
ïï; <
Purpose
ññ 
=
ññ 
purpose
ññ 
,
ññ 
Type
óó 
=
óó )
InitiateVerificationRequest
óó .
.
óó. /
Types
óó/ 4
.
óó4 5
Type
óó5 9
.
óó9 :
SendOtp
óó: A
}
òò 	
;
òò	 

Result
öö 
<
öö 
Unit
öö 
,
öö 
NetworkFailure
öö #
>
öö# $
streamResult
öö% 1
=
öö2 3
await
öö4 9
networkProvider
öö: I
.
ööI J.
 ExecuteReceiveStreamRequestAsync
ööJ j
(
ööj k
streamConnectId
õõ 
,
õõ 
RpcServiceType
úú 
.
úú "
InitiateVerification
úú /
,
úú/ 0%
SecureByteStringInterop
ùù #
.
ùù# $"
WithByteStringAsSpan
ùù$ 8
(
ùù8 9
request
ùù9 @
.
ùù@ A
ToByteString
ùùA M
(
ùùM N
)
ùùN O
,
ùùO P
span
ùùQ U
=>
ùùV X
span
ùùY ]
.
ùù] ^
ToArray
ùù^ e
(
ùùe f
)
ùùf g
)
ùùg h
,
ùùh i
payload
ûû 
=>
ûû .
 HandleVerificationStreamResponse
ûû 7
(
ûû7 8
payload
ûû8 ?
,
ûû? @
streamConnectId
ûûA P
,
ûûP Q
onCountdownUpdate
ûûR c
,
ûûc d
purpose
ûûe l
)
ûûl m
,
ûûm n
true
üü 
,
üü 
cancellationToken
üü #
)
üü# $
.
üü$ %
ConfigureAwait
üü% 3
(
üü3 4
false
üü4 9
)
üü9 :
;
üü: ;
if
°° 

(
°° 
!
°° 
streamResult
°° 
.
°° 
IsErr
°° 
)
°°  
{
¢¢ 	
return
££ 
Result
££ 
<
££ 
Unit
££ 
,
££ 
string
££  &
>
££& '
.
££' (
Ok
££( *
(
££* +
Unit
££+ /
.
££/ 0
Value
££0 5
)
££5 6
;
££6 7
}
§§ 	
NetworkFailure
¶¶ 
failure
¶¶ 
=
¶¶  
streamResult
¶¶! -
.
¶¶- .
	UnwrapErr
¶¶. 7
(
¶¶7 8
)
¶¶8 9
;
¶¶9 :-
HandleVerificationStreamFailure
ßß '
(
ßß' (
failure
ßß( /
,
ßß/ 0
onCountdownUpdate
ßß1 B
)
ßßB C
;
ßßC D
return
®® 
Result
®® 
<
®® 
Unit
®® 
,
®® 
string
®® "
>
®®" #
.
®®# $
Err
®®$ '
(
®®' (&
GetNetworkFailureMessage
®®( @
(
®®@ A
failure
®®A H
)
®®H I
)
®®I J
;
®®J K
}
©© 
public
´´ 

async
´´ 
Task
´´ 
<
´´ 
Result
´´ 
<
´´ 
Unit
´´ !
,
´´! "
string
´´# )
>
´´) *
>
´´* +(
ResendOtpVerificationAsync
´´, F
(
´´F G
Guid
¨¨ 
sessionIdentifier
¨¨ 
,
¨¨ 

ByteString
≠≠ $
mobileNumberIdentifier
≠≠ )
,
≠≠) *
Action
ÆÆ 
<
ÆÆ 
uint
ÆÆ 
,
ÆÆ 
Guid
ÆÆ 
,
ÆÆ )
VerificationCountdownUpdate
ÆÆ 6
.
ÆÆ6 7
Types
ÆÆ7 <
.
ÆÆ< =#
CountdownUpdateStatus
ÆÆ= R
,
ÆÆR S
string
ÆÆT Z
?
ÆÆZ [
>
ÆÆ[ \
?
ÆÆ\ ]
onCountdownUpdate
ÆÆ^ o
=
ÆÆp q
null
ÆÆr v
,
ÆÆv w
CancellationToken
ØØ 
cancellationToken
ØØ +
=
ØØ, -
default
ØØ. 5
)
ØØ5 6
{
∞∞ 
if
±± 

(
±± 
sessionIdentifier
±± 
==
±±  %
AuthenticationConstants
±±! 8
.
±±8 9
	EmptyGuid
±±9 B
)
±±B C
{
≤≤ 	
return
≥≥ 
Result
≥≥ 
<
≥≥ 
Unit
≥≥ 
,
≥≥ 
string
≥≥  &
>
≥≥& '
.
≥≥' (
Err
≥≥( +
(
≥≥+ ,!
localizationService
¥¥ #
[
¥¥# $%
AuthenticationConstants
¥¥$ ;
.
¥¥; <-
SESSION_IDENTIFIER_REQUIRED_KEY
¥¥< [
]
¥¥[ \
)
¥¥\ ]
;
¥¥] ^
}
µµ 	
if
∑∑ 

(
∑∑ $
mobileNumberIdentifier
∑∑ "
.
∑∑" #
IsEmpty
∑∑# *
)
∑∑* +
{
∏∏ 	
return
ππ 
Result
ππ 
<
ππ 
Unit
ππ 
,
ππ 
string
ππ  &
>
ππ& '
.
ππ' (
Err
ππ( +
(
ππ+ ,!
localizationService
∫∫ #
[
∫∫# $%
AuthenticationConstants
∫∫$ ;
.
∫∫; <3
%MOBILE_NUMBER_IDENTIFIER_REQUIRED_KEY
∫∫< a
]
∫∫a b
)
∫∫b c
;
∫∫c d
}
ªª 	
if
ΩΩ 

(
ΩΩ 
!
ΩΩ 
_activeStreams
ΩΩ 
.
ΩΩ 
TryGetValue
ΩΩ '
(
ΩΩ' (
sessionIdentifier
ΩΩ( 9
,
ΩΩ9 :
out
ΩΩ; >
uint
ΩΩ? C
streamConnectId
ΩΩD S
)
ΩΩS T
)
ΩΩT U
{
ææ 	
return
øø 
Result
øø 
<
øø 
Unit
øø 
,
øø 
string
øø  &
>
øø& '
.
øø' (
Err
øø( +
(
øø+ ,!
localizationService
øø, ?
[
øø? @%
AuthenticationConstants
øø@ W
.
øøW X.
 VERIFICATION_SESSION_EXPIRED_KEY
øøX x
]
øøx y
)
øøy z
;
øøz {
}
¿¿ 	!
VerificationPurpose
¬¬ 
purpose
¬¬ #
=
¬¬$ %$
_activeSessionPurposes
√√ "
.
√√" #
GetValueOrDefault
√√# 4
(
√√4 5
sessionIdentifier
√√5 F
,
√√F G!
VerificationPurpose
√√H [
.
√√[ \
Registration
√√\ h
)
√√h i
;
√√i j)
InitiateVerificationRequest
≈≈ #
request
≈≈$ +
=
≈≈, -
new
≈≈. 1
(
≈≈1 2
)
≈≈2 3
{
∆∆ 	$
MobileNumberIdentifier
«« "
=
««# $$
mobileNumberIdentifier
««% ;
,
««; <
Purpose
»» 
=
»» 
purpose
»» 
,
»» 
Type
…… 
=
…… )
InitiateVerificationRequest
…… .
.
……. /
Types
……/ 4
.
……4 5
Type
……5 9
.
……9 :
	ResendOtp
……: C
}
   	
;
  	 

Result
ÃÃ 
<
ÃÃ 
Unit
ÃÃ 
,
ÃÃ 
NetworkFailure
ÃÃ #
>
ÃÃ# $
result
ÃÃ% +
=
ÃÃ, -
await
ÃÃ. 3
networkProvider
ÃÃ4 C
.
ÃÃC D.
 ExecuteReceiveStreamRequestAsync
ÃÃD d
(
ÃÃd e
streamConnectId
ÕÕ 
,
ÕÕ 
RpcServiceType
ŒŒ 
.
ŒŒ "
InitiateVerification
ŒŒ /
,
ŒŒ/ 0%
SecureByteStringInterop
œœ #
.
œœ# $"
WithByteStringAsSpan
œœ$ 8
(
œœ8 9
request
œœ9 @
.
œœ@ A
ToByteString
œœA M
(
œœM N
)
œœN O
,
œœO P
span
œœQ U
=>
œœV X
span
œœY ]
.
œœ] ^
ToArray
œœ^ e
(
œœe f
)
œœf g
)
œœg h
,
œœh i
payload
–– 
=>
–– .
 HandleVerificationStreamResponse
–– 7
(
––7 8
payload
––8 ?
,
––? @
streamConnectId
––A P
,
––P Q
onCountdownUpdate
––R c
,
––c d
purpose
––e l
)
––l m
,
––m n
true
—— 
,
—— 
cancellationToken
—— #
)
——# $
.
——$ %
ConfigureAwait
——% 3
(
——3 4
false
——4 9
)
——9 :
;
——: ;
if
”” 

(
”” 
!
”” 
result
”” 
.
”” 
IsErr
”” 
)
”” 
{
‘‘ 	
return
’’ 
Result
’’ 
<
’’ 
Unit
’’ 
,
’’ 
string
’’  &
>
’’& '
.
’’' (
Ok
’’( *
(
’’* +
Unit
’’+ /
.
’’/ 0
Value
’’0 5
)
’’5 6
;
’’6 7
}
÷÷ 	
NetworkFailure
ÿÿ 
failure
ÿÿ 
=
ÿÿ  
result
ÿÿ! '
.
ÿÿ' (
	UnwrapErr
ÿÿ( 1
(
ÿÿ1 2
)
ÿÿ2 3
;
ÿÿ3 4-
HandleVerificationStreamFailure
ŸŸ '
(
ŸŸ' (
failure
ŸŸ( /
,
ŸŸ/ 0
onCountdownUpdate
ŸŸ1 B
)
ŸŸB C
;
ŸŸC D
return
⁄⁄ 
Result
⁄⁄ 
<
⁄⁄ 
Unit
⁄⁄ 
,
⁄⁄ 
string
⁄⁄ "
>
⁄⁄" #
.
⁄⁄# $
Err
⁄⁄$ '
(
⁄⁄' (&
GetNetworkFailureMessage
⁄⁄( @
(
⁄⁄@ A
failure
⁄⁄A H
)
⁄⁄H I
)
⁄⁄I J
;
⁄⁄J K
}
€€ 
public
›› 

async
›› 
Task
›› 
<
›› 
Result
›› 
<
›› 
Protobuf
›› %
.
››% &

Membership
››& 0
.
››0 1

Membership
››1 ;
,
››; <
string
››= C
>
››C D
>
››D E
VerifyOtpAsync
››F T
(
››T U
Guid
ﬁﬁ 
sessionIdentifier
ﬁﬁ 
,
ﬁﬁ 
string
ﬂﬂ 
otpCode
ﬂﬂ 
,
ﬂﬂ 
uint
‡‡ 
	connectId
‡‡ 
,
‡‡ 
CancellationToken
·· 
cancellationToken
·· +
=
··, -
default
··. 5
)
··5 6
{
‚‚ 
if
„„ 

(
„„ 
string
„„ 
.
„„ 
IsNullOrEmpty
„„  
(
„„  !
otpCode
„„! (
)
„„( )
||
„„* ,
otpCode
„„- 4
.
„„4 5
Length
„„5 ;
!=
„„< >
$num
„„? @
)
„„@ A
{
‰‰ 	
return
ÂÂ 
Result
ÂÂ 
<
ÂÂ 
Protobuf
ÂÂ "
.
ÂÂ" #

Membership
ÂÂ# -
.
ÂÂ- .

Membership
ÂÂ. 8
,
ÂÂ8 9
string
ÂÂ: @
>
ÂÂ@ A
.
ÂÂA B
Err
ÂÂB E
(
ÂÂE F!
localizationService
ÊÊ #
[
ÊÊ# $%
AuthenticationConstants
ÊÊ$ ;
.
ÊÊ; <"
INVALID_OTP_CODE_KEY
ÊÊ< P
]
ÊÊP Q
)
ÊÊQ R
;
ÊÊR S
}
ÁÁ 	
if
ÈÈ 

(
ÈÈ 
!
ÈÈ 
_activeStreams
ÈÈ 
.
ÈÈ 
TryGetValue
ÈÈ '
(
ÈÈ' (
sessionIdentifier
ÈÈ( 9
,
ÈÈ9 :
out
ÈÈ; >
uint
ÈÈ? C
activeStreamId
ÈÈD R
)
ÈÈR S
)
ÈÈS T
{
ÍÍ 	
return
ÎÎ 
Result
ÎÎ 
<
ÎÎ 
Protobuf
ÎÎ "
.
ÎÎ" #

Membership
ÎÎ# -
.
ÎÎ- .

Membership
ÎÎ. 8
,
ÎÎ8 9
string
ÎÎ: @
>
ÎÎ@ A
.
ÎÎA B
Err
ÎÎB E
(
ÎÎE F!
localizationService
ÏÏ #
[
ÏÏ# $%
AuthenticationConstants
ÏÏ$ ;
.
ÏÏ; <0
"NO_ACTIVE_VERIFICATION_SESSION_KEY
ÏÏ< ^
]
ÏÏ^ _
)
ÏÏ_ `
;
ÏÏ` a
}
ÌÌ 	!
VerificationPurpose
ÔÔ 
purpose
ÔÔ #
=
ÔÔ$ %$
_activeSessionPurposes
 "
.
" #
GetValueOrDefault
# 4
(
4 5
sessionIdentifier
5 F
,
F G!
VerificationPurpose
H [
.
[ \
Registration
\ h
)
h i
;
i j
VerifyCodeRequest
ÚÚ 
request
ÚÚ !
=
ÚÚ" #
new
ÚÚ$ '
(
ÚÚ' (
)
ÚÚ( )
{
ÛÛ 	
Code
ÙÙ 
=
ÙÙ 
otpCode
ÙÙ 
,
ÙÙ 
Purpose
ıı 
=
ıı 
purpose
ıı 
,
ıı 
StreamConnectId
ˆˆ 
=
ˆˆ 
activeStreamId
ˆˆ ,
}
˜˜ 	
;
˜˜	 
"
TaskCompletionSource
˘˘ 
<
˘˘ 
Result
˘˘ #
<
˘˘# $
Protobuf
˘˘$ ,
.
˘˘, -

Membership
˘˘- 7
.
˘˘7 8

Membership
˘˘8 B
,
˘˘B C
string
˘˘D J
>
˘˘J K
>
˘˘K L
responseSource
˘˘M [
=
˘˘\ ]
new
˘˘^ a
(
˘˘a b
)
˘˘b c
;
˘˘c d
Result
˚˚ 
<
˚˚ 
Unit
˚˚ 
,
˚˚ 
NetworkFailure
˚˚ #
>
˚˚# $
networkResult
˚˚% 2
=
˚˚3 4
await
˚˚5 :
networkProvider
˚˚; J
.
˚˚J K&
ExecuteUnaryRequestAsync
˚˚K c
(
˚˚c d
	connectId
¸¸ 
,
¸¸ 
RpcServiceType
˝˝ 
.
˝˝ 
	VerifyOtp
˝˝ $
,
˝˝$ %%
SecureByteStringInterop
˛˛ #
.
˛˛# $"
WithByteStringAsSpan
˛˛$ 8
(
˛˛8 9
request
˛˛9 @
.
˛˛@ A
ToByteString
˛˛A M
(
˛˛M N
)
˛˛N O
,
˛˛O P
span
˛˛Q U
=>
˛˛V X
span
˛˛Y ]
.
˛˛] ^
ToArray
˛˛^ e
(
˛˛e f
)
˛˛f g
)
˛˛g h
,
˛˛h i
payload
˛˛j q
=>
˛˛r t
{
ˇˇ  
VerifyCodeResponse
ÄÄ "
response
ÄÄ# +
=
ÄÄ, -
Helpers
ÄÄ. 5
.
ÄÄ5 6
ParseFromBytes
ÄÄ6 D
<
ÄÄD E 
VerifyCodeResponse
ÄÄE W
>
ÄÄW X
(
ÄÄX Y
payload
ÄÄY `
)
ÄÄ` a
;
ÄÄa b
if
ÇÇ 
(
ÇÇ 
response
ÇÇ 
.
ÇÇ 
Result
ÇÇ #
==
ÇÇ$ & 
VerificationResult
ÇÇ' 9
.
ÇÇ9 :
	Succeeded
ÇÇ: C
)
ÇÇC D
{
ÉÉ 
responseSource
ÑÑ "
.
ÑÑ" #
TrySetResult
ÑÑ# /
(
ÑÑ/ 0
Result
ÑÑ0 6
<
ÑÑ6 7
Protobuf
ÑÑ7 ?
.
ÑÑ? @

Membership
ÑÑ@ J
.
ÑÑJ K

Membership
ÑÑK U
,
ÑÑU V
string
ÑÑW ]
>
ÑÑ] ^
.
ÑÑ^ _
Ok
ÑÑ_ a
(
ÑÑa b
response
ÑÑb j
.
ÑÑj k

Membership
ÑÑk u
)
ÑÑu v
)
ÑÑv w
;
ÑÑw x
}
ÖÖ 
else
ÜÜ 
{
áá 
responseSource
àà "
.
àà" #
TrySetResult
àà# /
(
àà/ 0
Result
àà0 6
<
àà6 7
Protobuf
àà7 ?
.
àà? @

Membership
àà@ J
.
ààJ K

Membership
ààK U
,
ààU V
string
ààW ]
>
àà] ^
.
àà^ _
Err
àà_ b
(
ààb c!
localizationService
ââ +
[
ââ+ ,%
AuthenticationConstants
ââ, C
.
ââC D"
INVALID_OTP_CODE_KEY
ââD X
]
ââX Y
)
ââY Z
)
ââZ [
;
ââ[ \
}
ää 
return
åå 
Task
åå 
.
åå 

FromResult
åå &
(
åå& '
Result
åå' -
<
åå- .
Unit
åå. 2
,
åå2 3
NetworkFailure
åå4 B
>
ååB C
.
ååC D
Ok
ååD F
(
ååF G
Unit
ååG K
.
ååK L
Value
ååL Q
)
ååQ R
)
ååR S
;
ååS T
}
çç 
,
çç 
true
çç 
,
çç 
cancellationToken
çç &
)
çç& '
.
çç' (
ConfigureAwait
çç( 6
(
çç6 7
false
çç7 <
)
çç< =
;
çç= >
if
èè 

(
èè 
networkResult
èè 
.
èè 
IsErr
èè 
)
èè  
{
êê 	
return
ëë 
Result
ëë 
<
ëë 
Protobuf
ëë "
.
ëë" #

Membership
ëë# -
.
ëë- .

Membership
ëë. 8
,
ëë8 9
string
ëë: @
>
ëë@ A
.
ëëA B
Err
ëëB E
(
ëëE F
networkResult
ëëF S
.
ëëS T
	UnwrapErr
ëëT ]
(
ëë] ^
)
ëë^ _
.
ëë_ `
Message
ëë` g
)
ëëg h
;
ëëh i
}
íí 	
return
îî 
await
îî 
responseSource
îî #
.
îî# $
Task
îî$ (
.
îî( )
ConfigureAwait
îî) 7
(
îî7 8
false
îî8 =
)
îî= >
;
îî> ?
}
ïï 
public
óó 

async
óó 
Task
óó 
<
óó 
Result
óó 
<
óó 
Unit
óó !
,
óó! "
string
óó# )
>
óó) *
>
óó* +'
CompleteRegistrationAsync
óó, E
(
óóE F

ByteString
óóF P"
membershipIdentifier
óóQ e
,
óóe f
SecureTextBuffer
òò 
	secureKey
òò "
,
òò" #
uint
òò$ (
	connectId
òò) 2
,
òò2 3
CancellationToken
òò4 E
cancellationToken
òòF W
=
òòX Y
default
òòZ a
)
òòa b
{
ôô 
if
öö 

(
öö "
membershipIdentifier
öö  
.
öö  !
IsEmpty
öö! (
)
öö( )
{
õõ 	
return
úú 
Result
úú 
<
úú 
Unit
úú 
,
úú 
string
úú  &
>
úú& '
.
úú' (
Err
úú( +
(
úú+ ,!
localizationService
ùù #
[
ùù# $%
AuthenticationConstants
ùù$ ;
.
ùù; <0
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY
ùù< ^
]
ùù^ _
)
ùù_ `
;
ùù` a
}
ûû 	
if
†† 

(
†† 
	secureKey
†† 
.
†† 
Length
†† 
==
†† 
$num
††  !
)
††! "
{
°° 	
return
¢¢ 
Result
¢¢ 
<
¢¢ 
Unit
¢¢ 
,
¢¢ 
string
¢¢  &
>
¢¢& '
.
¢¢' (
Err
¢¢( +
(
¢¢+ ,!
localizationService
¢¢, ?
[
¢¢? @%
AuthenticationConstants
¢¢@ W
.
¢¢W X%
SECURE_KEY_REQUIRED_KEY
¢¢X o
]
¢¢o p
)
¢¢p q
;
¢¢q r
}
££ 	
SensitiveBytes
•• 
?
•• 
secureKeyBytes
•• &
=
••' (
null
••) -
;
••- .
Result
¶¶ 
<
¶¶ 
SensitiveBytes
¶¶ 
,
¶¶ 
SodiumFailure
¶¶ ,
>
¶¶, -
?
¶¶- .
createResult
¶¶/ ;
=
¶¶< =
null
¶¶> B
;
¶¶B C
try
®® 
{
©© 	
	secureKey
™™ 
.
™™ 
WithSecureBytes
™™ %
(
™™% &
secureKeySpan
™™& 3
=>
™™4 6
{
™™7 8
createResult
™™9 E
=
™™F G
SensitiveBytes
™™H V
.
™™V W
From
™™W [
(
™™[ \
secureKeySpan
™™\ i
)
™™i j
;
™™j k
}
™™l m
)
™™m n
;
™™n o
if
¨¨ 
(
¨¨ 
createResult
¨¨ 
==
¨¨ 
null
¨¨  $
||
¨¨% '
createResult
¨¨( 4
.
¨¨4 5
Value
¨¨5 :
.
¨¨: ;
IsErr
¨¨; @
)
¨¨@ A
{
≠≠ 
string
ÆÆ 
errorMessage
ÆÆ #
=
ÆÆ$ %
createResult
ÆÆ& 2
?
ÆÆ2 3
.
ÆÆ3 4
IsErr
ÆÆ4 9
is
ÆÆ: <
true
ÆÆ= A
?
ØØ 
$"
ØØ 
$str
ØØ <
{
ØØ< =
createResult
ØØ= I
.
ØØI J
Value
ØØJ O
.
ØØO P
	UnwrapErr
ØØP Y
(
ØØY Z
)
ØØZ [
.
ØØ[ \
Message
ØØ\ c
}
ØØc d
"
ØØd e
:
∞∞ !
localizationService
∞∞ )
[
∞∞) *%
AuthenticationConstants
∞∞* A
.
∞∞A B%
SECURE_KEY_REQUIRED_KEY
∞∞B Y
]
∞∞Y Z
;
∞∞Z [
return
±± 
Result
±± 
<
±± 
Unit
±± "
,
±±" #
string
±±$ *
>
±±* +
.
±±+ ,
Err
±±, /
(
±±/ 0
errorMessage
±±0 <
)
±±< =
;
±±= >
}
≤≤ 
secureKeyBytes
¥¥ 
=
¥¥ 
createResult
¥¥ )
.
¥¥) *
Value
¥¥* /
.
¥¥/ 0
Unwrap
¥¥0 6
(
¥¥6 7
)
¥¥7 8
;
¥¥8 9
if
∂∂ 
(
∂∂ 
secureKeyBytes
∂∂ 
.
∂∂ 
Length
∂∂ %
==
∂∂& (
$num
∂∂) *
)
∂∂* +
{
∑∑ 
return
∏∏ 
Result
∏∏ 
<
∏∏ 
Unit
∏∏ "
,
∏∏" #
string
∏∏$ *
>
∏∏* +
.
∏∏+ ,
Err
∏∏, /
(
∏∏/ 0!
localizationService
∏∏0 C
[
∏∏C D%
AuthenticationConstants
∏∏D [
.
∏∏[ \%
SECURE_KEY_REQUIRED_KEY
∏∏\ s
]
∏∏s t
)
∏∏t u
;
∏∏u v
}
ππ 
const
ªª 
int
ªª 
MAX_FLOW_ATTEMPTS
ªª '
=
ªª( )
$num
ªª* +
;
ªª+ ,
return
ΩΩ 
await
ΩΩ 

RetryAsync
ΩΩ #
(
ΩΩ# $
MAX_FLOW_ATTEMPTS
ææ %
,
ææ% &
(
øø 
attempt
øø 
,
øø &
attemptCancellationToken
øø 6
)
øø6 7
=>
øø8 :5
'ExecuteCompleteRegistrationAttemptAsync
¿¿ ?
(
¿¿? @"
membershipIdentifier
¡¡ 0
,
¡¡0 1
secureKeyBytes
¬¬ *
!
¬¬* +
,
¬¬+ ,
	connectId
√√ %
,
√√% &
attempt
ƒƒ #
,
ƒƒ# $&
attemptCancellationToken
≈≈ 4
)
≈≈4 5
,
≈≈5 6
cancellationToken
∆∆ %
)
∆∆% &
.
«« 
ConfigureAwait
«« 
(
««  
false
««  %
)
««% &
;
««& '
}
»» 	
finally
…… 
{
   	
secureKeyBytes
ÀÀ 
?
ÀÀ 
.
ÀÀ 
Dispose
ÀÀ #
(
ÀÀ# $
)
ÀÀ$ %
;
ÀÀ% &
}
ÃÃ 	
}
ÕÕ 
public
œœ 

async
œœ 
Task
œœ 
<
œœ 
Result
œœ 
<
œœ 
Unit
œœ !
,
œœ! "
string
œœ# )
>
œœ) *
>
œœ* +-
CleanupVerificationSessionAsync
œœ, K
(
œœK L
Guid
œœL P
sessionIdentifier
œœQ b
)
œœb c
{
–– 
if
—— 

(
—— 
sessionIdentifier
—— 
==
——  %
AuthenticationConstants
——! 8
.
——8 9
	EmptyGuid
——9 B
)
——B C
{
““ 	
return
”” 
Result
”” 
<
”” 
Unit
”” 
,
”” 
string
””  &
>
””& '
.
””' (
Err
””( +
(
””+ ,!
localizationService
””, ?
[
””? @%
AuthenticationConstants
””@ W
.
””W X-
SESSION_IDENTIFIER_REQUIRED_KEY
””X w
]
””w x
)
””x y
;
””y z
}
‘‘ 	
return
÷÷ 
await
÷÷  
CleanupStreamAsync
÷÷ '
(
÷÷' (
sessionIdentifier
÷÷( 9
)
÷÷9 :
.
÷÷: ;
ConfigureAwait
÷÷; I
(
÷÷I J
false
÷÷J O
)
÷÷O P
;
÷÷P Q
}
◊◊ 
public
ŸŸ 

void
ŸŸ 
Dispose
ŸŸ 
(
ŸŸ 
)
ŸŸ 
{
⁄⁄ 
lock
€€ 
(
€€ 
_opaqueClientLock
€€ 
)
€€  
{
‹‹ 	
_opaqueClient
›› 
.
›› 
Do
›› 
(
›› 
client
›› #
=>
››$ &
client
››' -
.
››- .
Dispose
››. 5
(
››5 6
)
››6 7
)
››7 8
;
››8 9
_opaqueClient
ﬁﬁ 
=
ﬁﬁ 
Option
ﬁﬁ "
<
ﬁﬁ" #
OpaqueClient
ﬁﬁ# /
>
ﬁﬁ/ 0
.
ﬁﬁ0 1
None
ﬁﬁ1 5
;
ﬁﬁ5 6
}
ﬂﬂ 	
}
‡‡ 
private
‚‚ 
static
‚‚ '
RegistrationAttemptResult
‚‚ ,"
CreateAttemptSuccess
‚‚- A
(
‚‚A B
RpcRequestContext
‚‚B S
context
‚‚T [
)
‚‚[ \
=>
‚‚] _
new
„„ 
(
„„ 
Result
„„ 
<
„„ 
Unit
„„ 
,
„„ 
string
„„ 
>
„„  
.
„„  !
Ok
„„! #
(
„„# $
Unit
„„$ (
.
„„( )
Value
„„) .
)
„„. /
,
„„/ 0
false
„„1 6
,
„„6 7
context
„„8 ?
.
„„? @
CORRELATION_ID
„„@ N
,
„„N O
context
„„P W
.
„„W X
IdempotencyKey
„„X f
,
„„f g
string
„„h n
.
„„n o
Empty
„„o t
)
„„t u
;
„„u v
private
ÂÂ 
static
ÂÂ '
RegistrationAttemptResult
ÂÂ ,"
CreateAttemptFailure
ÂÂ- A
(
ÂÂA B
string
ÂÂB H
error
ÂÂI N
,
ÂÂN O
bool
ÂÂP T
isTransient
ÂÂU `
,
ÂÂ` a
RpcRequestContext
ÊÊ 
context
ÊÊ !
)
ÊÊ! "
=>
ÊÊ# %
new
ÁÁ 
(
ÁÁ 
Result
ÁÁ 
<
ÁÁ 
Unit
ÁÁ 
,
ÁÁ 
string
ÁÁ 
>
ÁÁ  
.
ÁÁ  !
Err
ÁÁ! $
(
ÁÁ$ %
error
ÁÁ% *
)
ÁÁ* +
,
ÁÁ+ ,
isTransient
ÁÁ- 8
,
ÁÁ8 9
context
ÁÁ: A
.
ÁÁA B
CORRELATION_ID
ÁÁB P
,
ÁÁP Q
context
ÁÁR Y
.
ÁÁY Z
IdempotencyKey
ÁÁZ h
,
ÁÁh i
error
ÁÁj o
)
ÁÁo p
;
ÁÁp q
private
ÈÈ 
static
ÈÈ 
bool
ÈÈ "
IsTransientRpcStatus
ÈÈ ,
(
ÈÈ, -

StatusCode
ÈÈ- 7

statusCode
ÈÈ8 B
)
ÈÈB C
=>
ÈÈD F

statusCode
ÍÍ 
is
ÍÍ 

StatusCode
ÍÍ  
.
ÍÍ  !
Unavailable
ÍÍ! ,
or
ÍÍ- /

StatusCode
ÍÍ0 :
.
ÍÍ: ;
DeadlineExceeded
ÍÍ; K
or
ÍÍL N

StatusCode
ÍÍO Y
.
ÍÍY Z
	Cancelled
ÍÍZ c
;
ÍÍc d
private
ÏÏ 
static
ÏÏ 
bool
ÏÏ "
IsTransientException
ÏÏ ,
(
ÏÏ, -
	Exception
ÏÏ- 6
	exception
ÏÏ7 @
)
ÏÏ@ A
=>
ÏÏB D
	exception
ÌÌ 
switch
ÌÌ 
{
ÓÓ 	
RpcException
ÔÔ 
rpcException
ÔÔ %
when
ÔÔ& *"
IsTransientRpcStatus
ÔÔ+ ?
(
ÔÔ? @
rpcException
ÔÔ@ L
.
ÔÔL M

StatusCode
ÔÔM W
)
ÔÔW X
=>
ÔÔY [
true
ÔÔ\ `
,
ÔÔ` a
IOException
 
=>
 
true
 
,
  
SocketException
ÒÒ 
=>
ÒÒ 
true
ÒÒ #
,
ÒÒ# $
TimeoutException
ÚÚ 
=>
ÚÚ 
true
ÚÚ  $
,
ÚÚ$ %
_
ÛÛ 
=>
ÛÛ 
false
ÛÛ 
}
ÙÙ 	
;
ÙÙ	 

private
ˆˆ 
static
ˆˆ 
bool
ˆˆ ,
IsTransientRegistrationFailure
ˆˆ 6
(
ˆˆ6 7
NetworkFailure
ˆˆ7 E
failure
ˆˆF M
)
ˆˆM N
{
˜˜ 
return
¯¯ 
failure
¯¯ 
.
¯¯ 
FailureType
¯¯ "
is
¯¯# % 
NetworkFailureType
¯¯& 8
.
¯¯8 9%
DataCenterNotResponding
¯¯9 P
or
˘˘  
NetworkFailureType
˘˘ !
.
˘˘! " 
DataCenterShutdown
˘˘" 4
or
˙˙  
NetworkFailureType
˙˙ !
.
˙˙! " 
OperationCancelled
˙˙" 4
;
˙˙4 5
}
˚˚ 
private
˝˝ 
static
˝˝ 
string
˝˝ &
GetNetworkFailureMessage
˝˝ 2
(
˝˝2 3
NetworkFailure
˝˝3 A
failure
˝˝B I
)
˝˝I J
=>
˝˝K M
failure
˛˛ 
.
˛˛ 
	UserError
˛˛ 
?
˛˛ 
.
˛˛ 
Message
˛˛ "
??
˛˛# %
failure
˛˛& -
.
˛˛- .
Message
˛˛. 5
;
˛˛5 6
private
ÄÄ 
static
ÄÄ 
void
ÄÄ -
HandleVerificationStreamFailure
ÄÄ 7
(
ÄÄ7 8
NetworkFailure
ÅÅ 
failure
ÅÅ 
,
ÅÅ 
Action
ÇÇ 
<
ÇÇ 
uint
ÇÇ 
,
ÇÇ 
Guid
ÇÇ 
,
ÇÇ )
VerificationCountdownUpdate
ÇÇ 6
.
ÇÇ6 7
Types
ÇÇ7 <
.
ÇÇ< =#
CountdownUpdateStatus
ÇÇ= R
,
ÇÇR S
string
ÇÇT Z
?
ÇÇZ [
>
ÇÇ[ \
?
ÇÇ\ ]
onCountdownUpdate
ÇÇ^ o
)
ÇÇo p
{
ÉÉ 
if
ÑÑ 

(
ÑÑ *
IsVerificationSessionMissing
ÑÑ (
(
ÑÑ( )
failure
ÑÑ) 0
)
ÑÑ0 1
)
ÑÑ1 2
{
ÖÖ 	
RxApp
ÜÜ 
.
ÜÜ !
MainThreadScheduler
ÜÜ %
.
ÜÜ% &
Schedule
ÜÜ& .
(
ÜÜ. /
(
ÜÜ/ 0
)
ÜÜ0 1
=>
ÜÜ2 4
onCountdownUpdate
áá !
?
áá! "
.
áá" #
Invoke
áá# )
(
áá) *
$num
áá* +
,
áá+ ,
Guid
áá- 1
.
áá1 2
Empty
áá2 7
,
áá7 8)
VerificationCountdownUpdate
àà /
.
àà/ 0
Types
àà0 5
.
àà5 6#
CountdownUpdateStatus
àà6 K
.
ààK L
NotFound
ààL T
,
ààT U%
AuthenticationConstants
ââ +
.
ââ+ ,
ErrorMessages
ââ, 9
.
ââ9 :(
SESSION_EXPIRED_START_OVER
ââ: T
)
ââT U
)
ââU V
;
ââV W
}
ää 	
if
åå 

(
åå 
failure
åå 
.
åå 
FailureType
åå 
is
åå  " 
NetworkFailureType
åå# 5
.
åå5 6%
DataCenterNotResponding
åå6 M
or
çç  
NetworkFailureType
çç !
.
çç! " 
DataCenterShutdown
çç" 4
)
çç4 5
{
éé 	
string
èè 
errorMessage
èè 
=
èè  !&
GetNetworkFailureMessage
èè" :
(
èè: ;
failure
èè; B
)
èèB C
;
èèC D
RxApp
êê 
.
êê !
MainThreadScheduler
êê %
.
êê% &
Schedule
êê& .
(
êê. /
(
êê/ 0
)
êê0 1
=>
êê2 4
onCountdownUpdate
ëë !
?
ëë! "
.
ëë" #
Invoke
ëë# )
(
ëë) *
$num
ëë* +
,
ëë+ ,
Guid
ëë- 1
.
ëë1 2
Empty
ëë2 7
,
ëë7 8)
VerificationCountdownUpdate
íí /
.
íí/ 0
Types
íí0 5
.
íí5 6#
CountdownUpdateStatus
íí6 K
.
ííK L
ServerUnavailable
ííL ]
,
íí] ^
errorMessage
ìì  
)
ìì  !
)
ìì! "
;
ìì" #
}
îî 	
}
ïï 
private
óó 
static
óó 
bool
óó *
IsVerificationSessionMissing
óó 4
(
óó4 5
NetworkFailure
óó5 C
failure
óóD K
)
óóK L
{
òò 
if
ôô 

(
ôô 
failure
ôô 
.
ôô 
	UserError
ôô 
is
ôô  
not
ôô! $
{
ôô% &
}
ôô' (
	userError
ôô) 2
)
ôô2 3
{
öö 	
return
õõ 
false
õõ 
;
õõ 
}
úú 	
if
ûû 

(
ûû 
!
ûû 
string
ûû 
.
ûû  
IsNullOrWhiteSpace
ûû &
(
ûû& '
	userError
ûû' 0
.
ûû0 1
	I_18N_KEY
ûû1 :
)
ûû: ;
&&
ûû< >
(
üü 
string
üü 
.
üü 
Equals
üü 
(
üü 
	userError
üü $
.
üü$ %
	I_18N_KEY
üü% .
,
üü. /%
AuthenticationConstants
üü0 G
.
üüG H#
SESSION_NOT_FOUND_KEY
üüH ]
,
üü] ^
StringComparison
†† !
.
††! "
OrdinalIgnoreCase
††" 3
)
††3 4
||
††5 7
string
°° 
.
°° 
Equals
°° 
(
°° 
	userError
°° $
.
°°$ %
	I_18N_KEY
°°% .
,
°°. /%
AuthenticationConstants
°°0 G
.
°°G H.
 VERIFICATION_SESSION_EXPIRED_KEY
°°H h
,
°°h i
StringComparison
¢¢ !
.
¢¢! "
OrdinalIgnoreCase
¢¢" 3
)
¢¢3 4
)
¢¢4 5
)
¢¢5 6
{
££ 	
return
§§ 
true
§§ 
;
§§ 
}
•• 	
return
ßß 
	userError
ßß 
.
ßß 

ERROR_CODE
ßß #
==
ßß$ &
	ErrorCode
ßß' 0
.
ßß0 1
	NOT_FOUND
ßß1 :
;
ßß: ;
}
®® 
private
™™ 
readonly
™™ 
record
™™ 
struct
™™ "'
RegistrationAttemptResult
™™# <
(
™™< =
Result
´´ 
<
´´ 
Unit
´´ 
,
´´ 
string
´´ 
>
´´ 
Outcome
´´ $
,
´´$ %
bool
¨¨ 
IsTransient
¨¨ 
,
¨¨ 
string
≠≠ 
CORRELATION_ID
≠≠ 
,
≠≠ 
string
ÆÆ 
IdempotencyKey
ÆÆ 
,
ÆÆ 
string
ØØ 
FailureMessage
ØØ 
)
ØØ 
;
ØØ 
private
±± 
Result
±± 
<
±± 
byte
±± 
[
±± 
]
±± 
,
±± '
RegistrationAttemptResult
±± 4
>
±±4 5#
ValidateSecureKeyCopy
±±6 K
(
±±K L
byte
≤≤ 
[
≤≤ 
]
≤≤ 
?
≤≤ 
secureKeyCopy
≤≤ 
,
≤≤ 
RpcRequestContext
≥≥ 
requestContext
≥≥ (
)
≥≥( )
{
¥¥ 
if
µµ 

(
µµ 
secureKeyCopy
µµ 
==
µµ 
null
µµ !
||
µµ" $
secureKeyCopy
µµ% 2
.
µµ2 3
Length
µµ3 9
==
µµ: <
$num
µµ= >
)
µµ> ?
{
∂∂ 	
return
∑∑ 
Result
∑∑ 
<
∑∑ 
byte
∑∑ 
[
∑∑ 
]
∑∑  
,
∑∑  !'
RegistrationAttemptResult
∑∑" ;
>
∑∑; <
.
∑∑< =
Err
∑∑= @
(
∑∑@ A"
CreateAttemptFailure
∏∏ $
(
∏∏$ %!
localizationService
ππ '
[
ππ' (%
AuthenticationConstants
ππ( ?
.
ππ? @%
SECURE_KEY_REQUIRED_KEY
ππ@ W
]
ππW X
,
ππX Y
false
∫∫ 
,
∫∫ 
requestContext
ªª "
)
ªª" #
)
ªª# $
;
ªª$ %
}
ºº 	
return
ææ 
Result
ææ 
<
ææ 
byte
ææ 
[
ææ 
]
ææ 
,
ææ '
RegistrationAttemptResult
ææ 7
>
ææ7 8
.
ææ8 9
Ok
ææ9 ;
(
ææ; <
secureKeyCopy
ææ< I
)
ææI J
;
ææJ K
}
øø 
private
¡¡ 
Result
¡¡ 
<
¡¡  
RegistrationResult
¡¡ %
,
¡¡% &'
RegistrationAttemptResult
¡¡' @
>
¡¡@ A-
CreateAndTrackRegistrationState
¡¡B a
(
¡¡a b
OpaqueClient
¬¬ 
opaqueClient
¬¬ !
,
¬¬! "
byte
√√ 
[
√√ 
]
√√ 
secureKeyCopy
√√ 
,
√√ 

ByteString
ƒƒ "
membershipIdentifier
ƒƒ '
,
ƒƒ' (
RpcRequestContext
≈≈ 
requestContext
≈≈ (
)
≈≈( )
{
∆∆  
RegistrationResult
««  
registrationResult
«« -
=
««. /
opaqueClient
««0 <
.
««< ='
CreateRegistrationRequest
««= V
(
««V W
secureKeyCopy
««W d
)
««d e
;
««e f
if
…… 

(
…… &
_opaqueRegistrationState
…… $
.
……$ %
TryAdd
……% +
(
……+ ,"
membershipIdentifier
……, @
,
……@ A 
registrationResult
……B T
)
……T U
)
……U V
{
   	
return
ÀÀ 
Result
ÀÀ 
<
ÀÀ  
RegistrationResult
ÀÀ ,
,
ÀÀ, -'
RegistrationAttemptResult
ÀÀ. G
>
ÀÀG H
.
ÀÀH I
Ok
ÀÀI K
(
ÀÀK L 
registrationResult
ÀÀL ^
)
ÀÀ^ _
;
ÀÀ_ `
}
ÃÃ 	 
registrationResult
ŒŒ 
.
ŒŒ 
Dispose
ŒŒ "
(
ŒŒ" #
)
ŒŒ# $
;
ŒŒ$ %
return
œœ 
Result
œœ 
<
œœ  
RegistrationResult
œœ (
,
œœ( )'
RegistrationAttemptResult
œœ* C
>
œœC D
.
œœD E
Err
œœE H
(
œœH I"
CreateAttemptFailure
––  
(
––  !!
localizationService
—— #
[
——# $%
AuthenticationConstants
——$ ;
.
——; <%
REGISTRATION_FAILED_KEY
——< S
]
——S T
,
——T U
true
““ 
,
““ 
requestContext
”” 
)
”” 
)
””  
;
””  !
}
‘‘ 
private
÷÷ 
Result
÷÷ 
<
÷÷ 
Unit
÷÷ 
,
÷÷ '
RegistrationAttemptResult
÷÷ 2
>
÷÷2 3+
ProcessInitializationResponse
÷÷4 Q
(
÷÷Q R,
OpaqueRegistrationInitResponse
◊◊ &
initResponse
◊◊' 3
,
◊◊3 4 
RegistrationResult
ÿÿ 
registrationState
ÿÿ ,
,
ÿÿ, -
RpcRequestContext
ŸŸ 
requestContext
ŸŸ (
)
ŸŸ( )
{
⁄⁄ 
if
€€ 

(
€€ 
initResponse
€€ 
.
€€ 
Result
€€ 
==
€€  ",
OpaqueRegistrationInitResponse
€€# A
.
€€A B
Types
€€B G
.
€€G H
UpdateResult
€€H T
.
€€T U
	Succeeded
€€U ^
)
€€^ _
{
‹‹ 	
return
›› 
Result
›› 
<
›› 
Unit
›› 
,
›› '
RegistrationAttemptResult
››  9
>
››9 :
.
››: ;
Ok
››; =
(
››= >
Unit
››> B
.
››B C
Value
››C H
)
››H I
;
››I J
}
ﬁﬁ 	
registrationState
‡‡ 
.
‡‡ 
Dispose
‡‡ !
(
‡‡! "
)
‡‡" #
;
‡‡# $
string
‚‚ 
errorMessage
‚‚ 
=
‚‚ 
initResponse
‚‚ *
.
‚‚* +
Result
‚‚+ 1
switch
‚‚2 8
{
„„ 	,
OpaqueRegistrationInitResponse
‰‰ *
.
‰‰* +
Types
‰‰+ 0
.
‰‰0 1
UpdateResult
‰‰1 =
.
‰‰= > 
InvalidCredentials
‰‰> P
=>
‰‰Q S!
localizationService
ÂÂ #
[
ÂÂ# $%
AuthenticationConstants
ÂÂ$ ;
.
ÂÂ; <%
INVALID_CREDENTIALS_KEY
ÂÂ< S
]
ÂÂS T
,
ÂÂT U
_
ÊÊ 
=>
ÊÊ !
localizationService
ÊÊ $
[
ÊÊ$ %%
AuthenticationConstants
ÊÊ% <
.
ÊÊ< =%
REGISTRATION_FAILED_KEY
ÊÊ= T
]
ÊÊT U
}
ÁÁ 	
;
ÁÁ	 

return
ÈÈ 
Result
ÈÈ 
<
ÈÈ 
Unit
ÈÈ 
,
ÈÈ '
RegistrationAttemptResult
ÈÈ 5
>
ÈÈ5 6
.
ÈÈ6 7
Err
ÈÈ7 :
(
ÈÈ: ;"
CreateAttemptFailure
ÍÍ  
(
ÍÍ  !
errorMessage
ÍÍ! -
,
ÍÍ- .
false
ÍÍ/ 4
,
ÍÍ4 5
requestContext
ÍÍ6 D
)
ÍÍD E
)
ÍÍE F
;
ÍÍF G
}
ÎÎ 
private
ÌÌ 
static
ÌÌ 
void
ÌÌ .
 CleanupSensitiveRegistrationData
ÌÌ 8
(
ÌÌ8 9
byte
ÓÓ 
[
ÓÓ 
]
ÓÓ 
?
ÓÓ 
secureKeyCopy
ÓÓ 
,
ÓÓ 
byte
ÔÔ 
[
ÔÔ 
]
ÔÔ 
?
ÔÔ (
serverRegistrationResponse
ÔÔ *
,
ÔÔ* +
byte
 
[
 
]
 
?
  
registrationRecord
 "
,
" #
byte
ÒÒ 
[
ÒÒ 
]
ÒÒ 
?
ÒÒ 
	masterKey
ÒÒ 
)
ÒÒ 
{
ÚÚ 
if
ÛÛ 

(
ÛÛ 
secureKeyCopy
ÛÛ 
is
ÛÛ 
{
ÛÛ 
Length
ÛÛ %
:
ÛÛ% &
>
ÛÛ' (
$num
ÛÛ) *
}
ÛÛ+ ,
)
ÛÛ, -
{
ÙÙ 	%
CryptographicOperations
ıı #
.
ıı# $

ZeroMemory
ıı$ .
(
ıı. /
secureKeyCopy
ıı/ <
)
ıı< =
;
ıı= >
}
ˆˆ 	
if
¯¯ 

(
¯¯ (
serverRegistrationResponse
¯¯ &
is
¯¯' )
{
¯¯* +
Length
¯¯, 2
:
¯¯2 3
>
¯¯4 5
$num
¯¯6 7
}
¯¯8 9
)
¯¯9 :
{
˘˘ 	%
CryptographicOperations
˙˙ #
.
˙˙# $

ZeroMemory
˙˙$ .
(
˙˙. /(
serverRegistrationResponse
˙˙/ I
)
˙˙I J
;
˙˙J K
}
˚˚ 	
if
˝˝ 

(
˝˝  
registrationRecord
˝˝ 
is
˝˝ !
{
˝˝" #
Length
˝˝$ *
:
˝˝* +
>
˝˝, -
$num
˝˝. /
}
˝˝0 1
)
˝˝1 2
{
˛˛ 	%
CryptographicOperations
ˇˇ #
.
ˇˇ# $

ZeroMemory
ˇˇ$ .
(
ˇˇ. / 
registrationRecord
ˇˇ/ A
)
ˇˇA B
;
ˇˇB C
}
ÄÄ 	
if
ÇÇ 

(
ÇÇ 
	masterKey
ÇÇ 
is
ÇÇ 
{
ÇÇ 
Length
ÇÇ !
:
ÇÇ! "
>
ÇÇ# $
$num
ÇÇ% &
}
ÇÇ' (
)
ÇÇ( )
{
ÉÉ 	%
CryptographicOperations
ÑÑ #
.
ÑÑ# $

ZeroMemory
ÑÑ$ .
(
ÑÑ. /
	masterKey
ÑÑ/ 8
)
ÑÑ8 9
;
ÑÑ9 :
}
ÖÖ 	
}
ÜÜ 
private
àà 
async
àà 
Task
àà 
<
àà 
Result
àà 
<
àà '
RegistrationAttemptResult
àà 7
,
àà7 8'
RegistrationAttemptResult
àà9 R
>
ààR S
>
ààS T2
$FinalizeAndCompleteRegistrationAsync
ââ ,
(
ââ, -
OpaqueClient
ää 
opaqueClient
ää %
,
ää% &,
OpaqueRegistrationInitResponse
ãã *
initResponse
ãã+ 7
,
ãã7 8 
RegistrationResult
åå '
trackedRegistrationResult
åå 8
,
åå8 9

ByteString
çç "
membershipIdentifier
çç +
,
çç+ ,
uint
éé 
	connectId
éé 
,
éé 
RpcRequestContext
èè 
requestContext
èè ,
,
èè, -
CancellationToken
êê 
cancellationToken
êê /
)
êê/ 0
{
ëë 
byte
íí 
[
íí 
]
íí 
?
íí (
serverRegistrationResponse
íí *
=
íí+ ,
new
íí- 0
byte
íí1 5
[
íí5 6
initResponse
íí6 B
.
ííB C
PeerOprf
ííC K
.
ííK L
Length
ííL R
]
ííR S
;
ííS T
byte
ìì 
[
ìì 
]
ìì 
?
ìì  
registrationRecord
ìì "
=
ìì# $
null
ìì% )
;
ìì) *
byte
îî 
[
îî 
]
îî 
?
îî 
	masterKey
îî 
=
îî 
null
îî  
;
îî  !
try
ññ 
{
óó 	
initResponse
òò 
.
òò 
PeerOprf
òò !
.
òò! "
Span
òò" &
.
òò& '
CopyTo
òò' -
(
òò- .(
serverRegistrationResponse
òò. H
)
òòH I
;
òòI J
(
öö 
byte
öö 
[
öö 
]
öö 
record
öö 
,
öö 
byte
öö  
[
öö  !
]
öö! " 
generatedMasterKey
öö# 5
)
öö5 6
=
öö7 8
opaqueClient
õõ 
.
õõ "
FinalizeRegistration
õõ 1
(
õõ1 2(
serverRegistrationResponse
õõ2 L
,
õõL M'
trackedRegistrationResult
õõN g
)
õõg h
;
õõh i 
registrationRecord
úú 
=
úú  
record
úú! '
;
úú' (
	masterKey
ùù 
=
ùù  
generatedMasterKey
ùù *
;
ùù* +/
!OpaqueRegistrationCompleteRequest
üü -
completeRequest
üü. =
=
üü> ?
new
üü@ C
(
üüC D
)
üüD E
{
†† $
PeerRegistrationRecord
°° &
=
°°' (

ByteString
°°) 3
.
°°3 4
CopyFrom
°°4 <
(
°°< = 
registrationRecord
°°= O
)
°°O P
,
°°P Q"
MembershipIdentifier
¢¢ $
=
¢¢% &"
membershipIdentifier
¢¢' ;
,
¢¢; <
	MasterKey
££ 
=
££ 

ByteString
££ &
.
££& '
CopyFrom
££' /
(
££/ 0
	masterKey
££0 9
)
££9 :
}
§§ 
;
§§ "
TaskCompletionSource
¶¶  
<
¶¶  !0
"OpaqueRegistrationCompleteResponse
¶¶! C
>
¶¶C D
responseSource
¶¶E S
=
¶¶T U
new
ßß 
(
ßß !
TaskCreationOptions
ßß '
.
ßß' (,
RunContinuationsAsynchronously
ßß( F
)
ßßF G
;
ßßG H
Result
©© 
<
©© 
Unit
©© 
,
©© 
NetworkFailure
©© '
>
©©' (
networkResult
©©) 6
=
©©7 8
await
©©9 >
networkProvider
©©? N
.
©©N O&
ExecuteUnaryRequestAsync
©©O g
(
©©g h
	connectId
™™ 
,
™™ 
RpcServiceType
´´ "
.
´´" #"
RegistrationComplete
´´# 7
,
´´7 8%
SecureByteStringInterop
¨¨ +
.
¨¨+ ,"
WithByteStringAsSpan
¨¨, @
(
¨¨@ A
completeRequest
¨¨A P
.
¨¨P Q
ToByteString
¨¨Q ]
(
¨¨] ^
)
¨¨^ _
,
¨¨_ `
span
≠≠ 
=>
≠≠ 
span
≠≠  $
.
≠≠$ %
ToArray
≠≠% ,
(
≠≠, -
)
≠≠- .
)
≠≠. /
,
≠≠/ 0
payload
ÆÆ 
=>
ÆÆ 
{
ØØ 0
"OpaqueRegistrationCompleteResponse
∞∞ :
response
∞∞; C
=
∞∞D E
Helpers
±± #
.
±±# $
ParseFromBytes
±±$ 2
<
±±2 30
"OpaqueRegistrationCompleteResponse
±±3 U
>
±±U V
(
±±V W
payload
±±W ^
)
±±^ _
;
±±_ `
responseSource
≤≤ &
.
≤≤& '
TrySetResult
≤≤' 3
(
≤≤3 4
response
≤≤4 <
)
≤≤< =
;
≤≤= >
return
¥¥ 
Task
¥¥ #
.
¥¥# $

FromResult
¥¥$ .
(
¥¥. /
Result
¥¥/ 5
<
¥¥5 6
Unit
¥¥6 :
,
¥¥: ;
NetworkFailure
¥¥< J
>
¥¥J K
.
¥¥K L
Ok
¥¥L N
(
¥¥N O
Unit
¥¥O S
.
¥¥S T
Value
¥¥T Y
)
¥¥Y Z
)
¥¥Z [
;
¥¥[ \
}
µµ 
,
µµ 
true
∂∂ 
,
∂∂ 
cancellationToken
∑∑ %
,
∑∑% &
requestContext
∏∏ "
:
∏∏" #
requestContext
∏∏$ 2
)
∏∏2 3
.
ππ 
ConfigureAwait
ππ 
(
ππ  
false
ππ  %
)
ππ% &
;
ππ& '
if
ªª 
(
ªª 
networkResult
ªª 
.
ªª 
IsErr
ªª #
)
ªª# $
{
ºº 
return
ΩΩ 
Result
ΩΩ 
<
ΩΩ '
RegistrationAttemptResult
ΩΩ 7
,
ΩΩ7 8'
RegistrationAttemptResult
ΩΩ9 R
>
ΩΩR S
.
ΩΩS T
Err
ΩΩT W
(
ΩΩW X"
CreateAttemptFailure
ææ (
(
ææ( )"
FormatNetworkFailure
øø ,
(
øø, -
networkResult
øø- :
.
øø: ;
	UnwrapErr
øø; D
(
øøD E
)
øøE F
)
øøF G
,
øøG H,
IsTransientRegistrationFailure
¿¿ 6
(
¿¿6 7
networkResult
¿¿7 D
.
¿¿D E
	UnwrapErr
¿¿E N
(
¿¿N O
)
¿¿O P
)
¿¿P Q
,
¿¿Q R
requestContext
¡¡ &
)
¡¡& '
)
¡¡' (
;
¡¡( )
}
¬¬ 0
"OpaqueRegistrationCompleteResponse
ƒƒ .
completeResponse
ƒƒ/ ?
=
ƒƒ@ A
await
≈≈ 
responseSource
≈≈ $
.
≈≈$ %
Task
≈≈% )
.
≈≈) *
ConfigureAwait
≈≈* 8
(
≈≈8 9
false
≈≈9 >
)
≈≈> ?
;
≈≈? @
if
«« 
(
«« 
completeResponse
««  
.
««  !
Result
««! '
!=
««( *0
"OpaqueRegistrationCompleteResponse
««+ M
.
««M N
Types
««N S
.
««S T 
RegistrationResult
««T f
.
««f g
	Succeeded
««g p
)
««p q
{
»» 
return
…… 
Result
…… 
<
…… '
RegistrationAttemptResult
…… 7
,
……7 8'
RegistrationAttemptResult
……9 R
>
……R S
.
……S T
Err
……T W
(
……W X"
CreateAttemptFailure
   (
(
  ( )!
localizationService
ÀÀ +
[
ÀÀ+ ,%
AuthenticationConstants
ÀÀ, C
.
ÀÀC D%
REGISTRATION_FAILED_KEY
ÀÀD [
]
ÀÀ[ \
,
ÀÀ\ ]
false
ÃÃ 
,
ÃÃ 
requestContext
ÕÕ &
)
ÕÕ& '
)
ÕÕ' (
;
ÕÕ( )
}
ŒŒ 
if
–– 
(
–– 
completeResponse
––  
.
––  !
ActiveAccount
––! .
?
––. /
.
––/ 0
UniqueIdentifier
––0 @
!=
––A C
null
––D H
)
––H I
{
—— 
await
““ .
 applicationSecureStorageProvider
““ 6
.
”” &
SetCurrentAccountIdAsync
”” -
(
””- .
completeResponse
””. >
.
””> ?
ActiveAccount
””? L
.
””L M
UniqueIdentifier
””M ]
)
””] ^
.
‘‘ 
ConfigureAwait
‘‘ #
(
‘‘# $
false
‘‘$ )
)
‘‘) *
;
‘‘* +
}
’’ 
return
◊◊ 
Result
◊◊ 
<
◊◊ '
RegistrationAttemptResult
◊◊ 3
,
◊◊3 4'
RegistrationAttemptResult
◊◊5 N
>
◊◊N O
.
◊◊O P
Ok
◊◊P R
(
◊◊R S"
CreateAttemptSuccess
ÿÿ $
(
ÿÿ$ %
requestContext
ÿÿ% 3
)
ÿÿ3 4
)
ÿÿ4 5
;
ÿÿ5 6
}
ŸŸ 	
finally
⁄⁄ 
{
€€ 	.
 CleanupSensitiveRegistrationData
‹‹ ,
(
‹‹, -
null
‹‹- 1
,
‹‹1 2(
serverRegistrationResponse
‹‹3 M
,
‹‹M N 
registrationRecord
‹‹O a
,
‹‹a b
	masterKey
‹‹c l
)
‹‹l m
;
‹‹m n
}
›› 	
}
ﬁﬁ 
private
‡‡ 
async
‡‡ 
Task
‡‡ 
<
‡‡ '
RegistrationAttemptResult
‡‡ 0
>
‡‡0 15
'ExecuteCompleteRegistrationAttemptAsync
‡‡2 Y
(
‡‡Y Z

ByteString
·· "
membershipIdentifier
·· '
,
··' (
SensitiveBytes
‚‚ 
	secureKey
‚‚  
,
‚‚  !
uint
„„ 
	connectId
„„ 
,
„„ 
int
‰‰ 
attempt
‰‰ 
,
‰‰ 
CancellationToken
ÂÂ 
cancellationToken
ÂÂ +
)
ÂÂ+ ,
{
ÊÊ 
RpcRequestContext
ÁÁ 
requestContext
ÁÁ (
=
ÁÁ) *
RpcRequestContext
ÁÁ+ <
.
ÁÁ< =
	CreateNew
ÁÁ= F
(
ÁÁF G
attempt
ÁÁG N
)
ÁÁN O
;
ÁÁO P
bool
ËË 
allowReinit
ËË 
=
ËË 
true
ËË 
;
ËË  
while
ÍÍ 
(
ÍÍ 
true
ÍÍ 
)
ÍÍ 
{
ÎÎ 	
cancellationToken
ÏÏ 
.
ÏÏ *
ThrowIfCancellationRequested
ÏÏ :
(
ÏÏ: ;
)
ÏÏ; <
;
ÏÏ< =
using
ÓÓ 
OpaqueClient
ÓÓ 
opaqueClient
ÓÓ +
=
ÓÓ, -
new
ÓÓ. 1
(
ÓÓ1 2%
serverPublicKeyProvider
ÓÓ2 I
.
ÓÓI J 
GetServerPublicKey
ÓÓJ \
(
ÓÓ\ ]
)
ÓÓ] ^
)
ÓÓ^ _
;
ÓÓ_ `'
RegistrationAttemptResult
 %
result
& ,
=
- .
await
/ 4.
 TryExecuteRegistrationCycleAsync
5 U
(
U V
opaqueClient
ÒÒ 
,
ÒÒ "
membershipIdentifier
ÚÚ $
,
ÚÚ$ %
	secureKey
ÛÛ 
,
ÛÛ 
	connectId
ÙÙ 
,
ÙÙ 
requestContext
ıı 
,
ıı 
attempt
ˆˆ 
,
ˆˆ 
cancellationToken
˜˜ !
)
˜˜! "
.
˜˜" #
ConfigureAwait
˜˜# 1
(
˜˜1 2
false
˜˜2 7
)
˜˜7 8
;
˜˜8 9
if
˘˘ 
(
˘˘ 
result
˘˘ 
.
˘˘ 
Outcome
˘˘ 
.
˘˘ 
IsOk
˘˘ #
||
˘˘$ &
!
˘˘' (
allowReinit
˘˘( 3
||
˘˘4 6
!
˘˘7 8
result
˘˘8 >
.
˘˘> ?
IsTransient
˘˘? J
)
˘˘J K
{
˙˙ 
return
˚˚ 
result
˚˚ 
;
˚˚ 
}
¸¸ 
allowReinit
˛˛ 
=
˛˛ 
false
˛˛ 
;
˛˛  
requestContext
ˇˇ 
.
ˇˇ !
MarkReinitAttempted
ˇˇ .
(
ˇˇ. /
)
ˇˇ/ 0
;
ˇˇ0 1
Serilog
ÄÄ 
.
ÄÄ 
Log
ÄÄ 
.
ÄÄ 
Information
ÄÄ #
(
ÄÄ# $
$strÅÅ £
,ÅÅ£ §
requestContext
ÇÇ 
.
ÇÇ 
CORRELATION_ID
ÇÇ -
,
ÇÇ- .
requestContext
ÉÉ 
.
ÉÉ 
IdempotencyKey
ÉÉ -
)
ÉÉ- .
;
ÉÉ. /
}
ÑÑ 	
}
ÖÖ 
private
áá 
async
áá 
Task
áá 
<
áá '
RegistrationAttemptResult
áá 0
>
áá0 1.
 TryExecuteRegistrationCycleAsync
áá2 R
(
ááR S
OpaqueClient
àà 
opaqueClient
àà !
,
àà! "

ByteString
ââ "
membershipIdentifier
ââ '
,
ââ' (
SensitiveBytes
ää 
	secureKey
ää  
,
ää  !
uint
ãã 
	connectId
ãã 
,
ãã 
RpcRequestContext
åå 
requestContext
åå (
,
åå( )
int
çç 
attempt
çç 
,
çç 
CancellationToken
éé 
cancellationToken
éé +
)
éé+ ,
{
èè 
byte
êê 
[
êê 
]
êê 
?
êê 
secureKeyCopy
êê 
=
êê 
null
êê  $
;
êê$ % 
RegistrationResult
ëë 
?
ëë  
registrationResult
ëë .
=
ëë/ 0
null
ëë1 5
;
ëë5 6 
RegistrationResult
íí 
?
íí '
trackedRegistrationResult
íí 5
=
íí6 7
null
íí8 <
;
íí< =
try
îî 
{
ïï 	
Result
ññ 
<
ññ (
SecureKeyPreparationResult
ññ -
,
ññ- .'
RegistrationAttemptResult
ññ/ H
>
ññH I
prepareResult
ññJ W
=
ññX Y-
PrepareSecureKeyForRegistration
óó /
(
óó/ 0
	secureKey
óó0 9
,
óó9 :
requestContext
óó; I
)
óóI J
;
óóJ K
if
ôô 
(
ôô 
prepareResult
ôô 
.
ôô 
IsErr
ôô #
)
ôô# $
{
öö 
return
õõ 
prepareResult
õõ $
.
õõ$ %
	UnwrapErr
õõ% .
(
õõ. /
)
õõ/ 0
;
õõ0 1
}
úú 
secureKeyCopy
ûû 
=
ûû 
prepareResult
ûû )
.
ûû) *
Unwrap
ûû* 0
(
ûû0 1
)
ûû1 2
.
ûû2 3
SecureKeyCopy
ûû3 @
;
ûû@ A
Result
†† 
<
††  
RegistrationResult
†† %
,
††% &'
RegistrationAttemptResult
††' @
>
††@ A
stateResult
††B M
=
††N O-
CreateAndTrackRegistrationState
°° /
(
°°/ 0
opaqueClient
°°0 <
,
°°< =
secureKeyCopy
°°> K
,
°°K L"
membershipIdentifier
°°M a
,
°°a b
requestContext
°°c q
)
°°q r
;
°°r s
if
££ 
(
££ 
stateResult
££ 
.
££ 
IsErr
££ !
)
££! "
{
§§ 
return
•• 
stateResult
•• "
.
••" #
	UnwrapErr
••# ,
(
••, -
)
••- .
;
••. /
}
¶¶  
registrationResult
®® 
=
®®  
stateResult
®®! ,
.
®®, -
Unwrap
®®- 3
(
®®3 4
)
®®4 5
;
®®5 6'
RegistrationAttemptResult
™™ %
attemptResult
™™& 3
=
™™4 5
await
™™6 ;.
 ExecuteRegistrationWorkflowAsync
™™< \
(
™™\ ]
opaqueClient
´´ 
,
´´ "
membershipIdentifier
¨¨ $
,
¨¨$ % 
registrationResult
≠≠ "
,
≠≠" #
	connectId
ÆÆ 
,
ÆÆ 
requestContext
ØØ 
,
ØØ 
cancellationToken
∞∞ !
)
∞∞! "
.
∞∞" #
ConfigureAwait
∞∞# 1
(
∞∞1 2
false
∞∞2 7
)
∞∞7 8
;
∞∞8 9
if
≤≤ 
(
≤≤ 
attemptResult
≤≤ 
.
≤≤ 
Outcome
≤≤ %
.
≤≤% &
IsOk
≤≤& *
)
≤≤* +
{
≥≥ '
trackedRegistrationResult
¥¥ )
=
¥¥* + 
registrationResult
¥¥, >
;
¥¥> ? 
registrationResult
µµ "
=
µµ# $
null
µµ% )
;
µµ) *(
CleanupTrackedRegistration
∂∂ *
(
∂∂* +"
membershipIdentifier
∂∂+ ?
,
∂∂? @
ref
∂∂A D'
trackedRegistrationResult
∂∂E ^
)
∂∂^ _
;
∂∂_ `
}
∑∑ 
return
ππ 
attemptResult
ππ  
;
ππ  !
}
∫∫ 	
catch
ªª 
(
ªª 
	Exception
ªª 
ex
ªª 
)
ªª 
when
ªª !
(
ªª" #
ex
ªª# %
is
ªª& ((
OperationCanceledException
ªª) C
&&
ªªD F
cancellationToken
ªªG X
.
ªªX Y%
IsCancellationRequested
ªªY p
)
ªªp q
{
ºº 	
throw
ΩΩ 
;
ΩΩ 
}
ææ 	
catch
øø 
(
øø 
	Exception
øø 
ex
øø 
)
øø 
{
¿¿ 	)
HandleRegistrationException
¡¡ '
(
¡¡' (
ex
¡¡( *
,
¡¡* +"
membershipIdentifier
¡¡, @
,
¡¡@ A
attempt
¡¡B I
,
¡¡I J
requestContext
¡¡K Y
,
¡¡Y Z
ref
¡¡[ ^'
trackedRegistrationResult
¡¡_ x
,
¡¡x y
ref
¡¡z }!
registrationResult¡¡~ ê
)¡¡ê ë
;¡¡ë í
return
¬¬ "
CreateAttemptFailure
¬¬ '
(
¬¬' (
$"
√√ 
{
√√ %
AuthenticationConstants
√√ *
.
√√* +)
REGISTRATION_FAILURE_PREFIX
√√+ F
}
√√F G
{
√√G H
ex
√√H J
.
√√J K
Message
√√K R
}
√√R S
"
√√S T
,
√√T U"
IsTransientException
ƒƒ $
(
ƒƒ$ %
ex
ƒƒ% '
)
ƒƒ' (
,
ƒƒ( )
requestContext
≈≈ 
)
≈≈ 
;
≈≈  
}
∆∆ 	
finally
«« 
{
»» 	 
registrationResult
…… 
?
…… 
.
……  
Dispose
……  '
(
……' (
)
……( )
;
……) *'
trackedRegistrationResult
   %
?
  % &
.
  & '
Dispose
  ' .
(
  . /
)
  / 0
;
  0 1.
 CleanupSensitiveRegistrationData
ÀÀ ,
(
ÀÀ, -
secureKeyCopy
ÀÀ- :
,
ÀÀ: ;
null
ÀÀ< @
,
ÀÀ@ A
null
ÀÀB F
,
ÀÀF G
null
ÀÀH L
)
ÀÀL M
;
ÀÀM N
}
ÃÃ 	
}
ÕÕ 
private
œœ 
Result
œœ 
<
œœ (
SecureKeyPreparationResult
œœ -
,
œœ- .'
RegistrationAttemptResult
œœ/ H
>
œœH I-
PrepareSecureKeyForRegistration
œœJ i
(
œœi j
SensitiveBytes
–– 
	secureKey
––  
,
––  !
RpcRequestContext
—— 
requestContext
—— (
)
——( )
{
““ 
byte
”” 
[
”” 
]
”” 
?
”” 
secureKeyCopy
”” 
=
”” 
null
””  $
;
””$ %
Result
’’ 
<
’’ 
Unit
’’ 
,
’’ 
SodiumFailure
’’ "
>
’’" #!
readSecureKeyResult
’’$ 7
=
’’8 9
	secureKey
’’: C
.
’’C D
WithReadAccess
’’D R
(
’’R S
span
’’S W
=>
’’X Z
{
÷÷ 	
secureKeyCopy
◊◊ 
=
◊◊ 
span
◊◊  
.
◊◊  !
ToArray
◊◊! (
(
◊◊( )
)
◊◊) *
;
◊◊* +
return
ÿÿ 
Result
ÿÿ 
<
ÿÿ 
Unit
ÿÿ 
,
ÿÿ 
SodiumFailure
ÿÿ  -
>
ÿÿ- .
.
ÿÿ. /
Ok
ÿÿ/ 1
(
ÿÿ1 2
Unit
ÿÿ2 6
.
ÿÿ6 7
Value
ÿÿ7 <
)
ÿÿ< =
;
ÿÿ= >
}
ŸŸ 	
)
ŸŸ	 

;
ŸŸ
 
if
€€ 

(
€€ !
readSecureKeyResult
€€ 
.
€€  
IsErr
€€  %
)
€€% &
{
‹‹ 	
return
›› 
Result
›› 
<
›› (
SecureKeyPreparationResult
›› 4
,
››4 5'
RegistrationAttemptResult
››6 O
>
››O P
.
››P Q
Err
››Q T
(
››T U"
CreateAttemptFailure
ﬁﬁ $
(
ﬁﬁ$ %
$"
ﬂﬂ 
$str
ﬂﬂ 1
{
ﬂﬂ1 2!
readSecureKeyResult
ﬂﬂ2 E
.
ﬂﬂE F
	UnwrapErr
ﬂﬂF O
(
ﬂﬂO P
)
ﬂﬂP Q
.
ﬂﬂQ R
Message
ﬂﬂR Y
}
ﬂﬂY Z
"
ﬂﬂZ [
,
ﬂﬂ[ \
false
‡‡ 
,
‡‡ 
requestContext
·· "
)
··" #
)
··# $
;
··$ %
}
‚‚ 	
Result
‰‰ 
<
‰‰ 
byte
‰‰ 
[
‰‰ 
]
‰‰ 
,
‰‰ '
RegistrationAttemptResult
‰‰ 0
>
‰‰0 1
validationResult
‰‰2 B
=
‰‰C D#
ValidateSecureKeyCopy
‰‰E Z
(
‰‰Z [
secureKeyCopy
‰‰[ h
,
‰‰h i
requestContext
‰‰j x
)
‰‰x y
;
‰‰y z
if
ÊÊ 

(
ÊÊ 
validationResult
ÊÊ 
.
ÊÊ 
IsErr
ÊÊ "
)
ÊÊ" #
{
ÁÁ 	
return
ËË 
Result
ËË 
<
ËË (
SecureKeyPreparationResult
ËË 4
,
ËË4 5'
RegistrationAttemptResult
ËË6 O
>
ËËO P
.
ËËP Q
Err
ËËQ T
(
ËËT U
validationResult
ËËU e
.
ËËe f
	UnwrapErr
ËËf o
(
ËËo p
)
ËËp q
)
ËËq r
;
ËËr s
}
ÈÈ 	
return
ÎÎ 
Result
ÎÎ 
<
ÎÎ (
SecureKeyPreparationResult
ÎÎ 0
,
ÎÎ0 1'
RegistrationAttemptResult
ÎÎ2 K
>
ÎÎK L
.
ÎÎL M
Ok
ÎÎM O
(
ÎÎO P
new
ÏÏ (
SecureKeyPreparationResult
ÏÏ *
(
ÏÏ* +
secureKeyCopy
ÏÏ+ 8
!
ÏÏ8 9
)
ÏÏ9 :
)
ÏÏ: ;
;
ÏÏ; <
}
ÌÌ 
private
ÔÔ 
readonly
ÔÔ 
record
ÔÔ 
struct
ÔÔ "(
SecureKeyPreparationResult
ÔÔ# =
(
ÔÔ= >
byte
ÔÔ> B
[
ÔÔB C
]
ÔÔC D
SecureKeyCopy
ÔÔE R
)
ÔÔR S
;
ÔÔS T
private
ÒÒ 
async
ÒÒ 
Task
ÒÒ 
<
ÒÒ '
RegistrationAttemptResult
ÒÒ 0
>
ÒÒ0 1.
 ExecuteRegistrationWorkflowAsync
ÒÒ2 R
(
ÒÒR S
OpaqueClient
ÚÚ 
opaqueClient
ÚÚ !
,
ÚÚ! "

ByteString
ÛÛ "
membershipIdentifier
ÛÛ '
,
ÛÛ' ( 
RegistrationResult
ÙÙ 
registrationState
ÙÙ ,
,
ÙÙ, -
uint
ıı 
	connectId
ıı 
,
ıı 
RpcRequestContext
ˆˆ 
requestContext
ˆˆ (
,
ˆˆ( )
CancellationToken
˜˜ 
cancellationToken
˜˜ +
)
˜˜+ ,
{
¯¯ 
Result
˘˘ 
<
˘˘ ,
OpaqueRegistrationInitResponse
˘˘ -
,
˘˘- .
NetworkFailure
˘˘/ =
>
˘˘= >

initResult
˘˘? I
=
˘˘J K
await
˙˙ -
InitiateOpaqueRegistrationAsync
˙˙ 1
(
˙˙1 2"
membershipIdentifier
˚˚ (
,
˚˚( )
registrationState
¸¸ %
.
¸¸% &
GetRequestCopy
¸¸& 4
(
¸¸4 5
)
¸¸5 6
,
¸¸6 7
	connectId
˝˝ 
,
˝˝ 
requestContext
˛˛ "
,
˛˛" #
cancellationToken
ˇˇ %
)
ˇˇ% &
.
ÄÄ 
ConfigureAwait
ÄÄ 
(
ÄÄ  
false
ÄÄ  %
)
ÄÄ% &
;
ÄÄ& '
if
ÇÇ 

(
ÇÇ 

initResult
ÇÇ 
.
ÇÇ 
IsErr
ÇÇ 
)
ÇÇ 
{
ÉÉ 	
NetworkFailure
ÑÑ 
failure
ÑÑ "
=
ÑÑ# $

initResult
ÑÑ% /
.
ÑÑ/ 0
	UnwrapErr
ÑÑ0 9
(
ÑÑ9 :
)
ÑÑ: ;
;
ÑÑ; <
registrationState
ÖÖ 
.
ÖÖ 
Dispose
ÖÖ %
(
ÖÖ% &
)
ÖÖ& '
;
ÖÖ' (
return
ÜÜ "
CreateAttemptFailure
ÜÜ '
(
ÜÜ' ("
FormatNetworkFailure
áá $
(
áá$ %
failure
áá% ,
)
áá, -
,
áá- .,
IsTransientRegistrationFailure
àà .
(
àà. /
failure
àà/ 6
)
àà6 7
,
àà7 8
requestContext
ââ 
)
ââ 
;
ââ  
}
ää 	,
OpaqueRegistrationInitResponse
åå &
initResponse
åå' 3
=
åå4 5

initResult
åå6 @
.
åå@ A
Unwrap
ååA G
(
ååG H
)
ååH I
;
ååI J
Result
éé 
<
éé 
Unit
éé 
,
éé '
RegistrationAttemptResult
éé .
>
éé. /
initProcessing
éé0 >
=
éé? @+
ProcessInitializationResponse
èè )
(
èè) *
initResponse
èè* 6
,
èè6 7
registrationState
èè8 I
,
èèI J
requestContext
èèK Y
)
èèY Z
;
èèZ [
if
ëë 

(
ëë 
initProcessing
ëë 
.
ëë 
IsErr
ëë  
)
ëë  !
{
íí 	
return
ìì 
initProcessing
ìì !
.
ìì! "
	UnwrapErr
ìì" +
(
ìì+ ,
)
ìì, -
;
ìì- .
}
îî 	
Result
ññ 
<
ññ '
RegistrationAttemptResult
ññ (
,
ññ( )'
RegistrationAttemptResult
ññ* C
>
ññC D
finalizeResult
ññE S
=
ññT U
await
óó 2
$FinalizeAndCompleteRegistrationAsync
óó 6
(
óó6 7
opaqueClient
òò 
,
òò 
initResponse
ôô 
,
ôô 
registrationState
öö !
,
öö! ""
membershipIdentifier
õõ $
,
õõ$ %
	connectId
úú 
,
úú 
requestContext
ùù 
,
ùù 
cancellationToken
ûû !
)
ûû! "
.
ûû" #
ConfigureAwait
ûû# 1
(
ûû1 2
false
ûû2 7
)
ûû7 8
;
ûû8 9
return
†† 
finalizeResult
†† 
.
†† 
IsOk
†† "
?
††# $
finalizeResult
††% 3
.
††3 4
Unwrap
††4 :
(
††: ;
)
††; <
:
††= >
finalizeResult
††? M
.
††M N
	UnwrapErr
††N W
(
††W X
)
††X Y
;
††Y Z
}
°° 
private
££ 
void
££ (
CleanupTrackedRegistration
££ +
(
££+ ,

ByteString
££, 6"
membershipIdentifier
££7 K
,
££K L
ref
££M P 
RegistrationResult
££Q c
?
££c d
trackedResult
££e r
)
££r s
{
§§ 
if
•• 

(
•• &
_opaqueRegistrationState
•• $
.
••$ %
	TryRemove
••% .
(
••. /"
membershipIdentifier
••/ C
,
••C D
out
••E H 
RegistrationResult
••I [
?
••[ \
completedResult
••] l
)
••l m
)
••m n
{
¶¶ 	
completedResult
ßß 
.
ßß 
Dispose
ßß #
(
ßß# $
)
ßß$ %
;
ßß% &
}
®® 	
trackedResult
©© 
=
©© 
null
©© 
;
©© 
}
™™ 
private
¨¨ 
void
¨¨ )
HandleRegistrationException
¨¨ ,
(
¨¨, -
	Exception
≠≠ 
ex
≠≠ 
,
≠≠ 

ByteString
ÆÆ "
membershipIdentifier
ÆÆ '
,
ÆÆ' (
int
ØØ 
attempt
ØØ 
,
ØØ 
RpcRequestContext
∞∞ 
requestContext
∞∞ (
,
∞∞( )
ref
±±  
RegistrationResult
±± 
?
±± 
trackedResult
±±  -
,
±±- .
ref
≤≤  
RegistrationResult
≤≤ 
?
≤≤  
registrationResult
≤≤  2
)
≤≤2 3
{
≥≥ 
if
¥¥ 

(
¥¥ 
trackedResult
¥¥ 
!=
¥¥ 
null
¥¥ !
&&
¥¥" $&
_opaqueRegistrationState
µµ $
.
µµ$ %
	TryRemove
µµ% .
(
µµ. /"
membershipIdentifier
µµ/ C
,
µµC D
out
µµE H 
RegistrationResult
µµI [
?
µµ[ \
cachedResult
µµ] i
)
µµi j
)
µµj k
{
∂∂ 	
cachedResult
∑∑ 
.
∑∑ 
Dispose
∑∑  
(
∑∑  !
)
∑∑! "
;
∑∑" #
trackedResult
∏∏ 
=
∏∏ 
null
∏∏  
;
∏∏  !
}
ππ 	 
registrationResult
ªª 
?
ªª 
.
ªª 
Dispose
ªª #
(
ªª# $
)
ªª$ %
;
ªª% & 
registrationResult
ºº 
=
ºº 
null
ºº !
;
ºº! "
bool
ææ 
isTransient
ææ 
=
ææ "
IsTransientException
ææ /
(
ææ/ 0
ex
ææ0 2
)
ææ2 3
;
ææ3 4
if
¿¿ 

(
¿¿ 
isTransient
¿¿ 
)
¿¿ 
{
¡¡ 	
Serilog
¬¬ 
.
¬¬ 
Log
¬¬ 
.
¬¬ 
Warning
¬¬ 
(
¬¬  
ex
¬¬  "
,
¬¬" #
$str√√ ¡
,√√¡ ¬
attempt
ƒƒ 
,
ƒƒ 
requestContext
≈≈ 
.
≈≈ 
CORRELATION_ID
≈≈ -
,
≈≈- .
requestContext
∆∆ 
.
∆∆ 
IdempotencyKey
∆∆ -
)
∆∆- .
;
∆∆. /
}
«« 	
else
»» 
{
…… 	
Serilog
   
.
   
Log
   
.
   
Error
   
(
   
ex
    
,
    !
$strÀÀ ù
,ÀÀù û
requestContext
ÃÃ 
.
ÃÃ 
CORRELATION_ID
ÃÃ -
,
ÃÃ- .
requestContext
ÕÕ 
.
ÕÕ 
IdempotencyKey
ÕÕ -
)
ÕÕ- .
;
ÕÕ. /
}
ŒŒ 	
}
œœ 
private
—— 
static
—— 
async
—— 
Task
—— 
<
—— 
Result
—— $
<
——$ %
Unit
——% )
,
——) *
string
——+ 1
>
——1 2
>
——2 3

RetryAsync
——4 >
(
——> ?
int
““ 
maxAttempts
““ 
,
““ 
Func
”” 
<
”” 
int
”” 
,
”” 
CancellationToken
”” #
,
””# $
Task
””% )
<
””) *'
RegistrationAttemptResult
””* C
>
””C D
>
””D E
attemptFactory
””F T
,
””T U
CancellationToken
‘‘ 
cancellationToken
‘‘ +
)
‘‘+ ,
{
’’ '
RegistrationAttemptResult
÷÷ !

lastResult
÷÷" ,
=
÷÷- .
default
÷÷/ 6
;
÷÷6 7
for
ÿÿ 
(
ÿÿ 
int
ÿÿ 
attempt
ÿÿ 
=
ÿÿ 
$num
ÿÿ 
;
ÿÿ 
attempt
ÿÿ %
<=
ÿÿ& (
maxAttempts
ÿÿ) 4
;
ÿÿ4 5
attempt
ÿÿ6 =
++
ÿÿ= ?
)
ÿÿ? @
{
ŸŸ 	
cancellationToken
⁄⁄ 
.
⁄⁄ *
ThrowIfCancellationRequested
⁄⁄ :
(
⁄⁄: ;
)
⁄⁄; <
;
⁄⁄< ='
RegistrationAttemptResult
‹‹ %
attemptResult
‹‹& 3
=
‹‹4 5
await
›› 
attemptFactory
›› $
(
››$ %
attempt
››% ,
,
››, -
cancellationToken
››. ?
)
››? @
.
››@ A
ConfigureAwait
››A O
(
››O P
false
››P U
)
››U V
;
››V W
if
ﬂﬂ 
(
ﬂﬂ 
attemptResult
ﬂﬂ 
.
ﬂﬂ 
Outcome
ﬂﬂ %
.
ﬂﬂ% &
IsOk
ﬂﬂ& *
)
ﬂﬂ* +
{
‡‡ 
return
·· 
attemptResult
·· $
.
··$ %
Outcome
··% ,
;
··, -
}
‚‚ 

lastResult
‰‰ 
=
‰‰ 
attemptResult
‰‰ &
;
‰‰& '
if
ÊÊ 
(
ÊÊ 
!
ÊÊ 
attemptResult
ÊÊ 
.
ÊÊ 
IsTransient
ÊÊ *
||
ÊÊ+ -
attempt
ÊÊ. 5
==
ÊÊ6 8
maxAttempts
ÊÊ9 D
)
ÊÊD E
{
ÁÁ 
return
ËË 
attemptResult
ËË $
.
ËË$ %
Outcome
ËË% ,
;
ËË, -
}
ÈÈ 
Serilog
ÎÎ 
.
ÎÎ 
Log
ÎÎ 
.
ÎÎ 
Warning
ÎÎ 
(
ÎÎ  
$strÏÏ ÿ
,ÏÏÿ Ÿ
attempt
ÌÌ 
+
ÌÌ 
$num
ÌÌ 
,
ÌÌ 
maxAttempts
ÓÓ 
,
ÓÓ 
attemptResult
ÔÔ 
.
ÔÔ 
CORRELATION_ID
ÔÔ ,
,
ÔÔ, -
attemptResult
 
.
 
IdempotencyKey
 ,
,
, -
attemptResult
ÒÒ 
.
ÒÒ 
FailureMessage
ÒÒ ,
)
ÒÒ, -
;
ÒÒ- .
}
ÚÚ 	
return
ÙÙ 

lastResult
ÙÙ 
.
ÙÙ 
Outcome
ÙÙ !
;
ÙÙ! "
}
ıı 
private
˜˜ 
static
˜˜ 
string
˜˜ "
FormatNetworkFailure
˜˜ .
(
˜˜. /
NetworkFailure
˜˜/ =
failure
˜˜> E
)
˜˜E F
=>
˜˜G I
$"
¯¯ 

{
¯¯
 %
AuthenticationConstants
¯¯ "
.
¯¯" #)
REGISTRATION_FAILURE_PREFIX
¯¯# >
}
¯¯> ?
{
¯¯? @
(
¯¯@ A
failure
¯¯A H
.
¯¯H I
	UserError
¯¯I R
?
¯¯R S
.
¯¯S T
Message
¯¯T [
??
¯¯\ ^
failure
¯¯_ f
.
¯¯f g
Message
¯¯g n
)
¯¯n o
}
¯¯o p
"
¯¯p q
;
¯¯q r
private
˙˙ 
async
˙˙ 
Task
˙˙ 
<
˙˙ 
Result
˙˙ 
<
˙˙ ,
OpaqueRegistrationInitResponse
˙˙ <
,
˙˙< =
NetworkFailure
˙˙> L
>
˙˙L M
>
˙˙M N-
InitiateOpaqueRegistrationAsync
˙˙O n
(
˙˙n o

ByteString
˚˚ "
membershipIdentifier
˚˚ '
,
˚˚' (
byte
¸¸ 
[
¸¸ 
]
¸¸ !
registrationRequest
¸¸ "
,
¸¸" #
uint
˝˝ 
	connectId
˝˝ 
,
˝˝ 
RpcRequestContext
˛˛ 
requestContext
˛˛ (
,
˛˛( )
CancellationToken
ˇˇ 
cancellationToken
ˇˇ +
)
ˇˇ+ ,
{
ÄÄ 
if
ÅÅ 

(
ÅÅ "
membershipIdentifier
ÅÅ  
.
ÅÅ  !
IsEmpty
ÅÅ! (
)
ÅÅ( )
{
ÇÇ 	
return
ÉÉ 
Result
ÉÉ 
<
ÉÉ ,
OpaqueRegistrationInitResponse
ÉÉ 8
,
ÉÉ8 9
NetworkFailure
ÉÉ: H
>
ÉÉH I
.
ÉÉI J
Err
ÉÉJ M
(
ÉÉM N
NetworkFailure
ÑÑ 
.
ÑÑ  
InvalidRequestType
ÑÑ 1
(
ÑÑ1 2!
localizationService
ÖÖ '
[
ÖÖ' (%
AuthenticationConstants
ÖÖ( ?
.
ÖÖ? @0
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY
ÖÖ@ b
]
ÖÖb c
)
ÖÖc d
)
ÖÖd e
;
ÖÖe f
}
ÜÜ 	+
OpaqueRegistrationInitRequest
àà %
request
àà& -
=
àà. /
new
àà0 3
(
àà3 4
)
àà4 5
{
ââ 	
PeerOprf
ää 
=
ää 

ByteString
ää !
.
ää! "
CopyFrom
ää" *
(
ää* +!
registrationRequest
ää+ >
)
ää> ?
,
ää? @"
MembershipIdentifier
ãã  
=
ãã! ""
membershipIdentifier
ãã# 7
}
åå 	
;
åå	 
"
TaskCompletionSource
éé 
<
éé ,
OpaqueRegistrationInitResponse
éé ;
>
éé; <
responseSource
éé= K
=
ééL M
new
ééN Q
(
ééQ R
)
ééR S
;
ééS T
Result
êê 
<
êê 
Unit
êê 
,
êê 
NetworkFailure
êê #
>
êê# $
networkResult
êê% 2
=
êê3 4
await
êê5 :
networkProvider
êê; J
.
êêJ K&
ExecuteUnaryRequestAsync
êêK c
(
êêc d
	connectId
ëë 
,
ëë 
RpcServiceType
íí 
.
íí 
RegistrationInit
íí +
,
íí+ ,%
SecureByteStringInterop
ìì #
.
ìì# $"
WithByteStringAsSpan
ìì$ 8
(
ìì8 9
request
ìì9 @
.
ìì@ A
ToByteString
ììA M
(
ììM N
)
ììN O
,
ììO P
span
ììQ U
=>
ììV X
span
ììY ]
.
ìì] ^
ToArray
ìì^ e
(
ììe f
)
ììf g
)
ììg h
,
ììh i
payload
ììj q
=>
ììr t
{
îî ,
OpaqueRegistrationInitResponse
ïï .
response
ïï/ 7
=
ïï8 9
Helpers
ññ 
.
ññ 
ParseFromBytes
ññ *
<
ññ* +,
OpaqueRegistrationInitResponse
ññ+ I
>
ññI J
(
ññJ K
payload
ññK R
)
ññR S
;
ññS T
responseSource
óó 
.
óó 
TrySetResult
óó +
(
óó+ ,
response
óó, 4
)
óó4 5
;
óó5 6
return
ôô 
Task
ôô 
.
ôô 

FromResult
ôô &
(
ôô& '
Result
ôô' -
<
ôô- .
Unit
ôô. 2
,
ôô2 3
NetworkFailure
ôô4 B
>
ôôB C
.
ôôC D
Ok
ôôD F
(
ôôF G
Unit
ôôG K
.
ôôK L
Value
ôôL Q
)
ôôQ R
)
ôôR S
;
ôôS T
}
öö 
,
öö 
true
öö 
,
öö 
cancellationToken
öö &
,
öö& '
requestContext
öö( 6
:
öö6 7
requestContext
öö8 F
)
ööF G
.
ööG H
ConfigureAwait
ööH V
(
ööV W
false
ööW \
)
öö\ ]
;
öö] ^
if
úú 

(
úú 
networkResult
úú 
.
úú 
IsErr
úú 
)
úú  
{
ùù 	
return
ûû 
Result
ûû 
<
ûû ,
OpaqueRegistrationInitResponse
ûû 8
,
ûû8 9
NetworkFailure
ûû: H
>
ûûH I
.
ûûI J
Err
ûûJ M
(
ûûM N
networkResult
ûûN [
.
ûû[ \
	UnwrapErr
ûû\ e
(
ûûe f
)
ûûf g
)
ûûg h
;
ûûh i
}
üü 	,
OpaqueRegistrationInitResponse
°° &
initResponse
°°' 3
=
°°4 5
await
°°6 ;
responseSource
°°< J
.
°°J K
Task
°°K O
.
°°O P
ConfigureAwait
°°P ^
(
°°^ _
false
°°_ d
)
°°d e
;
°°e f
return
¢¢ 
Result
¢¢ 
<
¢¢ ,
OpaqueRegistrationInitResponse
¢¢ 4
,
¢¢4 5
NetworkFailure
¢¢6 D
>
¢¢D E
.
¢¢E F
Ok
¢¢F H
(
¢¢H I
initResponse
¢¢I U
)
¢¢U V
;
¢¢V W
}
££ 
private
•• 
void
•• '
ProcessVerificationUpdate
•• *
(
••* +)
VerificationCountdownUpdate
¶¶ #)
verificationCountdownUpdate
¶¶$ ?
,
¶¶? @
Guid
ßß $
verificationIdentifier
ßß #
,
ßß# $
uint
®® 
streamConnectId
®® 
,
®® !
VerificationPurpose
©© 
purpose
©© #
,
©©# $
Action
™™ 
<
™™ 
uint
™™ 
,
™™ 
Guid
™™ 
,
™™ )
VerificationCountdownUpdate
™™ 6
.
™™6 7
Types
™™7 <
.
™™< =#
CountdownUpdateStatus
™™= R
,
™™R S
string
™™T Z
?
™™Z [
>
™™[ \
?
™™\ ]
onCountdownUpdate
™™^ o
)
™™o p
{
´´ 
if
¨¨ 

(
¨¨ -
ShouldCleanupVerificationStream
¨¨ +
(
¨¨+ ,)
verificationCountdownUpdate
¨¨, G
.
¨¨G H
Status
¨¨H N
)
¨¨N O
)
¨¨O P
{
≠≠ 	
if
ÆÆ 
(
ÆÆ $
verificationIdentifier
ÆÆ &
!=
ÆÆ' )
Guid
ÆÆ* .
.
ÆÆ. /
Empty
ÆÆ/ 4
)
ÆÆ4 5
{
ØØ (
ScheduleStreamCleanupAsync
∞∞ *
(
∞∞* +$
verificationIdentifier
∞∞+ A
)
∞∞A B
;
∞∞B C
}
±± 
}
≤≤ 	
if
¥¥ 

(
¥¥ $
verificationIdentifier
¥¥ "
!=
¥¥# %
Guid
¥¥& *
.
¥¥* +
Empty
¥¥+ 0
)
¥¥0 1
{
µµ 	
_activeStreams
∂∂ 
.
∂∂ 
TryAdd
∂∂ !
(
∂∂! "$
verificationIdentifier
∂∂" 8
,
∂∂8 9
streamConnectId
∂∂: I
)
∂∂I J
;
∂∂J K$
_activeSessionPurposes
∑∑ "
.
∑∑" #
TryAdd
∑∑# )
(
∑∑) *$
verificationIdentifier
∑∑* @
,
∑∑@ A
purpose
∑∑B I
)
∑∑I J
;
∑∑J K
}
∏∏ 	
RxApp
∫∫ 
.
∫∫ !
MainThreadScheduler
∫∫ !
.
∫∫! "
Schedule
∫∫" *
(
∫∫* +
(
∫∫+ ,
)
∫∫, -
=>
∫∫. 0
onCountdownUpdate
ªª 
?
ªª 
.
ªª 
Invoke
ªª %
(
ªª% &)
verificationCountdownUpdate
ºº +
.
ºº+ ,
SecondsRemaining
ºº, <
,
ºº< =$
verificationIdentifier
ΩΩ &
,
ΩΩ& ')
verificationCountdownUpdate
ææ +
.
ææ+ ,
Status
ææ, 2
,
ææ2 3)
verificationCountdownUpdate
øø +
.
øø+ ,
Message
øø, 3
)
øø3 4
)
øø4 5
;
øø5 6
}
¿¿ 
private
¬¬ 
static
¬¬ 
bool
¬¬ -
ShouldCleanupVerificationStream
¬¬ 7
(
¬¬7 8)
VerificationCountdownUpdate
¬¬8 S
.
¬¬S T
Types
¬¬T Y
.
¬¬Y Z#
CountdownUpdateStatus
¬¬Z o
status
¬¬p v
)
¬¬v w
=>
¬¬x z
status
√√ 
is
√√ )
VerificationCountdownUpdate
√√ -
.
√√- .
Types
√√. 3
.
√√3 4#
CountdownUpdateStatus
√√4 I
.
√√I J
Failed
√√J P
or
ƒƒ )
VerificationCountdownUpdate
ƒƒ *
.
ƒƒ* +
Types
ƒƒ+ 0
.
ƒƒ0 1#
CountdownUpdateStatus
ƒƒ1 F
.
ƒƒF G 
MaxAttemptsReached
ƒƒG Y
or
≈≈ )
VerificationCountdownUpdate
≈≈ *
.
≈≈* +
Types
≈≈+ 0
.
≈≈0 1#
CountdownUpdateStatus
≈≈1 F
.
≈≈F G
NotFound
≈≈G O
;
≈≈O P
private
«« 
void
«« (
ScheduleStreamCleanupAsync
«« +
(
««+ ,
Guid
««, 0$
verificationIdentifier
««1 G
)
««G H
{
»» 
_
…… 	
=
……
 
Task
…… 
.
…… 
Run
…… 
(
…… 
async
…… 
(
…… 
)
…… 
=>
……  
{
   	
try
ÀÀ 
{
ÃÃ 
Result
ÕÕ 
<
ÕÕ 
Unit
ÕÕ 
,
ÕÕ 
string
ÕÕ #
>
ÕÕ# $
cleanupResult
ÕÕ% 2
=
ÕÕ3 4
await
ŒŒ  
CleanupStreamAsync
ŒŒ ,
(
ŒŒ, -$
verificationIdentifier
ŒŒ- C
)
ŒŒC D
.
ŒŒD E
ConfigureAwait
ŒŒE S
(
ŒŒS T
false
ŒŒT Y
)
ŒŒY Z
;
ŒŒZ [
if
œœ 
(
œœ 
cleanupResult
œœ !
.
œœ! "
IsErr
œœ" '
)
œœ' (
{
–– 
Serilog
—— 
.
—— 
Log
—— 
.
——  
Warning
——  '
(
——' (
$str““ é
,““é è$
verificationIdentifier
”” .
,
””. /
cleanupResult
””0 =
.
””= >
	UnwrapErr
””> G
(
””G H
)
””H I
)
””I J
;
””J K
}
‘‘ 
}
’’ 
catch
÷÷ 
(
÷÷ 
	Exception
÷÷ 
ex
÷÷ 
)
÷÷  
{
◊◊ 
Serilog
ÿÿ 
.
ÿÿ 
Log
ÿÿ 
.
ÿÿ 
Error
ÿÿ !
(
ÿÿ! "
ex
ÿÿ" $
,
ÿÿ$ %
$strÿÿ& Ü
,ÿÿÜ á$
verificationIdentifier
ŸŸ *
)
ŸŸ* +
;
ŸŸ+ ,
}
⁄⁄ 
}
€€ 	
,
€€	 

CancellationToken
€€ 
.
€€ 
None
€€ !
)
€€! "
.
€€" #
ContinueWith
€€# /
(
€€/ 0
task
‹‹ 
=>
‹‹ 
{
›› 
if
ﬁﬁ 
(
ﬁﬁ 
task
ﬁﬁ 
.
ﬁﬁ 
	IsFaulted
ﬁﬁ "
&&
ﬁﬁ# %
task
ﬁﬁ& *
.
ﬁﬁ* +
	Exception
ﬁﬁ+ 4
!=
ﬁﬁ5 7
null
ﬁﬁ8 <
)
ﬁﬁ< =
{
ﬂﬂ 
Serilog
‡‡ 
.
‡‡ 
Log
‡‡ 
.
‡‡  
Error
‡‡  %
(
‡‡% &
task
‡‡& *
.
‡‡* +
	Exception
‡‡+ 4
,
‡‡4 5
$str
‡‡6 r
)
‡‡r s
;
‡‡s t
}
·· 
}
‚‚ 
,
‚‚ 
TaskScheduler
„„ 
.
„„ 
Default
„„ !
)
„„! "
;
„„" #
}
‰‰ 
private
ÊÊ 
Task
ÊÊ 
<
ÊÊ 
Result
ÊÊ 
<
ÊÊ 
Unit
ÊÊ 
,
ÊÊ 
NetworkFailure
ÊÊ ,
>
ÊÊ, -
>
ÊÊ- ..
 HandleVerificationStreamResponse
ÊÊ/ O
(
ÊÊO P
byte
ÁÁ 
[
ÁÁ 
]
ÁÁ 
payload
ÁÁ 
,
ÁÁ 
uint
ËË 
streamConnectId
ËË 
,
ËË 
Action
ÈÈ 
<
ÈÈ 
uint
ÈÈ 
,
ÈÈ 
Guid
ÈÈ 
,
ÈÈ )
VerificationCountdownUpdate
ÈÈ 6
.
ÈÈ6 7
Types
ÈÈ7 <
.
ÈÈ< =#
CountdownUpdateStatus
ÈÈ= R
,
ÈÈR S
string
ÈÈT Z
?
ÈÈZ [
>
ÈÈ[ \
?
ÈÈ\ ]
onCountdownUpdate
ÈÈ^ o
,
ÈÈo p!
VerificationPurpose
ÍÍ 
purpose
ÍÍ #
=
ÍÍ$ %!
VerificationPurpose
ÍÍ& 9
.
ÍÍ9 :
Registration
ÍÍ: F
)
ÍÍF G
{
ÎÎ )
VerificationCountdownUpdate
ÏÏ #)
verificationCountdownUpdate
ÏÏ$ ?
=
ÏÏ@ A
Helpers
ÌÌ 
.
ÌÌ 
ParseFromBytes
ÌÌ "
<
ÌÌ" #)
VerificationCountdownUpdate
ÌÌ# >
>
ÌÌ> ?
(
ÌÌ? @
payload
ÌÌ@ G
)
ÌÌG H
;
ÌÌH I
if
ÔÔ 

(
ÔÔ )
verificationCountdownUpdate
ÔÔ '
.
ÔÔ' (
SessionIdentifier
ÔÔ( 9
==
ÔÔ: <
null
ÔÔ= A
||
ÔÔB D)
verificationCountdownUpdate
 '
.
' (
SessionIdentifier
( 9
.
9 :
IsEmpty
: A
)
A B
{
ÒÒ 	
RxApp
ÚÚ 
.
ÚÚ !
MainThreadScheduler
ÚÚ %
.
ÚÚ% &
Schedule
ÚÚ& .
(
ÚÚ. /
(
ÚÚ/ 0
)
ÚÚ0 1
=>
ÚÚ2 4
onCountdownUpdate
ÛÛ !
?
ÛÛ! "
.
ÛÛ" #
Invoke
ÛÛ# )
(
ÛÛ) *
$num
ÛÛ* +
,
ÛÛ+ ,
Guid
ÛÛ- 1
.
ÛÛ1 2
Empty
ÛÛ2 7
,
ÛÛ7 8)
VerificationCountdownUpdate
ÙÙ /
.
ÙÙ/ 0
Types
ÙÙ0 5
.
ÙÙ5 6#
CountdownUpdateStatus
ÙÙ6 K
.
ÙÙK L
Failed
ÙÙL R
,
ÙÙR S)
verificationCountdownUpdate
ıı /
.
ıı/ 0
Message
ıı0 7
)
ıı7 8
)
ıı8 9
;
ıı9 :
return
ˆˆ 
Task
ˆˆ 
.
ˆˆ 

FromResult
ˆˆ "
(
ˆˆ" #
Result
ˆˆ# )
<
ˆˆ) *
Unit
ˆˆ* .
,
ˆˆ. /
NetworkFailure
ˆˆ0 >
>
ˆˆ> ?
.
ˆˆ? @
Ok
ˆˆ@ B
(
ˆˆB C
Unit
ˆˆC G
.
ˆˆG H
Value
ˆˆH M
)
ˆˆM N
)
ˆˆN O
;
ˆˆO P
}
˜˜ 	
try
˘˘ 
{
˙˙ 	
Guid
˚˚ $
verificationIdentifier
˚˚ '
=
˚˚( )
Helpers
˚˚* 1
.
˚˚1 2"
FromByteStringToGuid
˚˚2 F
(
˚˚F G)
verificationCountdownUpdate
˚˚G b
.
˚˚b c
SessionIdentifier
˚˚c t
)
˚˚t u
;
˚˚u v'
ProcessVerificationUpdate
¸¸ %
(
¸¸% &)
verificationCountdownUpdate
¸¸& A
,
¸¸A B$
verificationIdentifier
¸¸C Y
,
¸¸Y Z
streamConnectId
¸¸[ j
,
¸¸j k
purpose
¸¸l s
,
¸¸s t
onCountdownUpdate
˝˝ !
)
˝˝! "
;
˝˝" #
return
˛˛ 
Task
˛˛ 
.
˛˛ 

FromResult
˛˛ "
(
˛˛" #
Result
˛˛# )
<
˛˛) *
Unit
˛˛* .
,
˛˛. /
NetworkFailure
˛˛0 >
>
˛˛> ?
.
˛˛? @
Ok
˛˛@ B
(
˛˛B C
Unit
˛˛C G
.
˛˛G H
Value
˛˛H M
)
˛˛M N
)
˛˛N O
;
˛˛O P
}
ˇˇ 	
catch
ÄÄ 
(
ÄÄ 
	Exception
ÄÄ 
ex
ÄÄ 
)
ÄÄ 
{
ÅÅ 	
return
ÇÇ 
Task
ÇÇ 
.
ÇÇ 

FromResult
ÇÇ "
(
ÇÇ" #
Result
ÇÇ# )
<
ÇÇ) *
Unit
ÇÇ* .
,
ÇÇ. /
NetworkFailure
ÇÇ0 >
>
ÇÇ> ?
.
ÇÇ? @
Err
ÇÇ@ C
(
ÇÇC D
NetworkFailure
ÉÉ 
.
ÉÉ %
DataCenterNotResponding
ÉÉ 6
(
ÉÉ6 7
$"
ÑÑ 
{
ÑÑ %
AuthenticationConstants
ÑÑ .
.
ÑÑ. /$
NETWORK_FAILURE_PREFIX
ÑÑ/ E
}
ÑÑE F
{
ÑÑF G
ex
ÑÑG I
.
ÑÑI J
Message
ÑÑJ Q
}
ÑÑQ R
"
ÑÑR S
)
ÑÑS T
)
ÑÑT U
)
ÑÑU V
;
ÑÑV W
}
ÖÖ 	
}
ÜÜ 
private
àà 
async
àà 
Task
àà 
<
àà 
Result
àà 
<
àà 
Unit
àà "
,
àà" #
string
àà$ *
>
àà* +
>
àà+ , 
CleanupStreamAsync
àà- ?
(
àà? @
Guid
àà@ D
sessionIdentifier
ààE V
)
ààV W
{
ââ $
_activeSessionPurposes
ää 
.
ää 
	TryRemove
ää (
(
ää( )
sessionIdentifier
ää) :
,
ää: ;
out
ää< ?
_
ää@ A
)
ääA B
;
ääB C
if
åå 

(
åå 
_activeStreams
åå 
.
åå 
	TryRemove
åå $
(
åå$ %
sessionIdentifier
åå% 6
,
åå6 7
out
åå8 ;
uint
åå< @
streamConnectId
ååA P
)
ååP Q
)
ååQ R
{
çç 	
Result
éé 
<
éé 
Unit
éé 
,
éé 
NetworkFailure
éé '
>
éé' (
cleanupResult
éé) 6
=
éé7 8
await
èè 
networkProvider
èè %
.
èè% &(
CleanupStreamProtocolAsync
èè& @
(
èè@ A
streamConnectId
èèA P
)
èèP Q
.
èèQ R
ConfigureAwait
èèR `
(
èè` a
false
èèa f
)
èèf g
;
èèg h
if
ëë 
(
ëë 
!
ëë 
cleanupResult
ëë 
.
ëë 
IsErr
ëë $
)
ëë$ %
{
íí 
return
ìì 
Result
ìì 
<
ìì 
Unit
ìì "
,
ìì" #
string
ìì$ *
>
ìì* +
.
ìì+ ,
Ok
ìì, .
(
ìì. /
Unit
ìì/ 3
.
ìì3 4
Value
ìì4 9
)
ìì9 :
;
ìì: ;
}
îî 
return
ññ 
Result
ññ 
<
ññ 
Unit
ññ 
,
ññ 
string
ññ  &
>
ññ& '
.
ññ' (
Err
ññ( +
(
ññ+ ,
cleanupResult
ññ, 9
.
ññ9 :
	UnwrapErr
ññ: C
(
ññC D
)
ññD E
.
ññE F
Message
ññF M
)
ññM N
;
ññN O
}
óó 	
return
ôô 
Result
ôô 
<
ôô 
Unit
ôô 
,
ôô 
string
ôô "
>
ôô" #
.
ôô# $
Ok
ôô$ &
(
ôô& '
Unit
ôô' +
.
ôô+ ,
Value
ôô, 1
)
ôô1 2
;
ôô2 3
}
öö 
}õõ ¨Ω
ç/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/OpaqueAuthenticationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
;/ 0
internal 
sealed	 
class '
OpaqueAuthenticationService 1
(1 2
NetworkProvider 
networkProvider #
,# $ 
ILocalizationService 
localizationService ,
,, -
IIdentityService 
identityService $
,$ %-
!IApplicationSecureStorageProvider %,
 applicationSecureStorageProvider& F
,F G$
IServerPublicKeyProvider   #
serverPublicKeyProvider   4
)  4 5
:!! "
IAuthenticationService!! 
,!! 
IDisposable!! )
{"" 
private## 
const## 
int## "
MAX_ALLOWED_ZERO_BYTES## ,
=##- .
$num##/ 1
;##1 2
private$$ 
const$$ 
int$$ %
MAX_SIGN_IN_FLOW_ATTEMPTS$$ /
=$$0 1
$num$$2 3
;$$3 4
private&& 
static&& 
readonly&& 

Dictionary&& &
<&&& '
OpaqueResult&&' 3
,&&3 4
string&&5 ;
>&&; <
OpaqueErrorMessages&&= P
=&&Q R
new&&S V
(&&V W
)&&W X
{'' 
{(( 	
OpaqueResult((
 
.(( 
INVALID_INPUT(( $
,(($ %#
AuthenticationConstants((& =
.((= >#
INVALID_CREDENTIALS_KEY((> U
}((V W
,((W X
{)) 	
OpaqueResult))
 
.)) 
CRYPTO_ERROR)) #
,))# $#
AuthenticationConstants))% <
.))< ='
COMMON_UNEXPECTED_ERROR_KEY))= X
}))Y Z
,))Z [
{** 	
OpaqueResult**
 
.** 
MEMORY_ERROR** #
,**# $#
AuthenticationConstants**% <
.**< ='
COMMON_UNEXPECTED_ERROR_KEY**= X
}**Y Z
,**Z [
{++ 	
OpaqueResult++
 
.++ 
VALIDATION_ERROR++ '
,++' (#
AuthenticationConstants++) @
.++@ A#
INVALID_CREDENTIALS_KEY++A X
}++Y Z
,++Z [
{,, 	
OpaqueResult,,
 
.,,  
AUTHENTICATION_ERROR,, +
,,,+ ,#
AuthenticationConstants,,- D
.,,D E#
INVALID_CREDENTIALS_KEY,,E \
},,] ^
,,,^ _
{-- 	
OpaqueResult--
 
.-- 
INVALID_PUBLIC_KEY-- )
,--) *#
AuthenticationConstants--+ B
.--B C'
COMMON_UNEXPECTED_ERROR_KEY--C ^
}--_ `
,--` a
}.. 
;.. 
private00 
readonly00 
Lock00 
_opaqueClientLock00 +
=00, -
new00. 1
(001 2
)002 3
;003 4
private11 
Option11 
<11 
OpaqueClient11 
>11  
_opaqueClient11! .
=11/ 0
Option111 7
<117 8
OpaqueClient118 D
>11D E
.11E F
None11F J
;11J K
private33 
sealed33 
record33 
SignInFlowResult33 *
(33* +$
SodiumSecureMemoryHandle44  
MasterKeyHandle44! 0
,440 1

ByteString55  
MembershipIdentifier55 '
,55' (
Guid66 
MembershipId66 
)66 
:66 
IDisposable66 (
{77 
public88 
void88 
Dispose88 
(88 
)88 
{99 	
MasterKeyHandle:: 
.:: 
Dispose:: #
(::# $
)::$ %
;::% &
};; 	
}<< 
public>> 

async>> 
Task>> 
<>> 
Result>> 
<>> 
Unit>> !
,>>! "!
AuthenticationFailure>># 8
>>>8 9
>>>9 :
SignInAsync>>; F
(>>F G
string>>G M
mobileNumber>>N Z
,>>Z [
SecureTextBuffer?? 
	secureKey?? "
,??" #
uint@@ 
	connectId@@ 
,@@ 
CancellationToken@@ )
cancellationToken@@* ;
=@@< =
default@@> E
)@@E F
{AA 
ifBB 

(BB 
stringBB 
.BB 
IsNullOrEmptyBB  
(BB  !
mobileNumberBB! -
)BB- .
)BB. /
{CC 	
stringDD 
mobileRequiredErrorDD &
=DD' (
localizationServiceDD) <
[DD< =#
AuthenticationConstantsDD= T
.DDT U&
MOBILE_NUMBER_REQUIRED_KEYDDU o
]DDo p
;DDp q
returnEE 
ResultEE 
<EE 
UnitEE 
,EE !
AuthenticationFailureEE  5
>EE5 6
.EE6 7
ErrEE7 :
(EE: ;!
AuthenticationFailureFF %
.FF% & 
MobileNumberRequiredFF& :
(FF: ;
mobileRequiredErrorFF; N
)FFN O
)FFO P
;FFP Q
}GG 	
SensitiveBytesII 
?II 
secureKeyBytesII &
=II' (
nullII) -
;II- .
ResultJJ 
<JJ 
SensitiveBytesJJ 
,JJ 
SodiumFailureJJ ,
>JJ, -
?JJ- .
createResultJJ/ ;
=JJ< =
nullJJ> B
;JJB C
tryLL 
{MM 	
	secureKeyNN 
.NN 
WithSecureBytesNN %
(NN% &
secureKeySpanNN& 3
=>NN4 6
{NN7 8
createResultNN9 E
=NNF G
SensitiveBytesNNH V
.NNV W
FromNNW [
(NN[ \
secureKeySpanNN\ i
)NNi j
;NNj k
}NNl m
)NNm n
;NNn o
ifPP 
(PP 
createResultPP 
==PP 
nullPP  $
||PP% '
createResultPP( 4
.PP4 5
ValuePP5 :
.PP: ;
IsErrPP; @
)PP@ A
{QQ 
stringRR 
errorMessageRR #
=RR$ %
createResultRR& 2
?RR2 3
.RR3 4
IsErrRR4 9
isRR: <
trueRR= A
?SS 
$"SS 
$strSS <
{SS< =
createResultSS= I
.SSI J
ValueSSJ O
.SSO P
	UnwrapErrSSP Y
(SSY Z
)SSZ [
.SS[ \
MessageSS\ c
}SSc d
"SSd e
:TT 
localizationServiceTT )
[TT) *#
AuthenticationConstantsTT* A
.TTA B#
SECURE_KEY_REQUIRED_KEYTTB Y
]TTY Z
;TTZ [
returnUU 
ResultUU 
<UU 
UnitUU "
,UU" #!
AuthenticationFailureUU$ 9
>UU9 :
.UU: ;
ErrUU; >
(UU> ?!
AuthenticationFailureUU? T
.UUT U
SecureKeyRequiredUUU f
(UUf g
errorMessageUUg s
)UUs t
)UUt u
;UUu v
}VV 
secureKeyBytesXX 
=XX 
createResultXX )
.XX) *
ValueXX* /
.XX/ 0
UnwrapXX0 6
(XX6 7
)XX7 8
;XX8 9
ifZZ 
(ZZ 
secureKeyBytesZZ 
.ZZ 
LengthZZ %
!=ZZ& (
$numZZ) *
)ZZ* +
{[[ 
Result\\ 
<\\ 
SignInFlowResult\\ '
,\\' (!
AuthenticationFailure\\) >
>\\> ?
signInResult\\@ L
=\\M N
await]] "
ExecuteSignInFlowAsync]] 0
(]]0 1
mobileNumber]]1 =
,]]= >
secureKeyBytes]]? M
,]]M N
	connectId]]O X
,]]X Y
cancellationToken]]Z k
)]]k l
.^^ 
ConfigureAwait^^ '
(^^' (
false^^( -
)^^- .
;^^. /
if`` 
(`` 
signInResult``  
.``  !
IsErr``! &
)``& '
{aa 
returnbb 
Resultbb !
<bb! "
Unitbb" &
,bb& '!
AuthenticationFailurebb( =
>bb= >
.bb> ?
Errbb? B
(bbB C
signInResultbbC O
.bbO P
	UnwrapErrbbP Y
(bbY Z
)bbZ [
)bb[ \
;bb\ ]
}cc 
usingee 
SignInFlowResultee &

flowResultee' 1
=ee2 3
signInResultee4 @
.ee@ A
UnwrapeeA G
(eeG H
)eeH I
;eeI J
returnff 
awaitff 7
+RecreateAuthenticatedProtocolWithRetryAsyncff H
(ffH I

flowResultffI S
,ffS T
	connectIdffU ^
,ff^ _
cancellationTokenff` q
)ffq r
.gg 
ConfigureAwaitgg #
(gg# $
falsegg$ )
)gg) *
;gg* +
}hh 
stringjj 
requiredErrorjj  
=jj! "
localizationServicejj# 6
[jj6 7#
AuthenticationConstantsjj7 N
.jjN O#
SECURE_KEY_REQUIRED_KEYjjO f
]jjf g
;jjg h
returnkk 
Resultkk 
<kk 
Unitkk 
,kk !
AuthenticationFailurekk  5
>kk5 6
.kk6 7
Errkk7 :
(kk: ;!
AuthenticationFailurekk; P
.kkP Q
SecureKeyRequiredkkQ b
(kkb c
requiredErrorkkc p
)kkp q
)kkq r
;kkr s
}ll 	
finallymm 
{nn 	
secureKeyBytesoo 
?oo 
.oo 
Disposeoo #
(oo# $
)oo$ %
;oo% &
}pp 	
}qq 
privatess 
asyncss 
Taskss 
<ss 
Resultss 
<ss 
Unitss "
,ss" #!
AuthenticationFailuress$ 9
>ss9 :
>ss: ;7
+RecreateAuthenticatedProtocolWithRetryAsyncss< g
(ssg h
SignInFlowResulttt 
signInFlowResulttt )
,tt) *
uintuu 
	connectIduu 
,uu 
CancellationTokenvv 
cancellationTokenvv +
)vv+ ,
{ww 
constxx 
intxx *
MAX_PROTOCOL_RECREATE_ATTEMPTSxx 0
=xx1 2
$numxx3 4
;xx4 5!
AuthenticationFailureyy 
?yy 
	lastErroryy (
=yy) *
nullyy+ /
;yy/ 0
try{{ 
{|| 	
for}} 
(}} 
int}} 
attempt}} 
=}} 
$num}}  
;}}  !
attempt}}" )
<=}}* ,*
MAX_PROTOCOL_RECREATE_ATTEMPTS}}- K
;}}K L
attempt}}M T
++}}T V
)}}V W
{~~ 
cancellationToken !
.! "(
ThrowIfCancellationRequested" >
(> ?
)? @
;@ A
Result
ÅÅ 
<
ÅÅ 
Unit
ÅÅ 
,
ÅÅ #
AuthenticationFailure
ÅÅ 2
>
ÅÅ2 3
protocolResult
ÅÅ4 B
=
ÅÅC D
await
ÅÅE J0
"RecreateAuthenticatedProtocolAsync
ÅÅK m
(
ÅÅm n
signInFlowResult
ÇÇ $
.
ÇÇ$ %
MasterKeyHandle
ÇÇ% 4
,
ÇÇ4 5
signInFlowResult
ÉÉ $
.
ÉÉ$ %"
MembershipIdentifier
ÉÉ% 9
,
ÉÉ9 :
	connectId
ÑÑ 
,
ÑÑ 
signInFlowResult
ÖÖ $
.
ÖÖ$ %
MembershipId
ÖÖ% 1
)
ÖÖ1 2
.
ÖÖ2 3
ConfigureAwait
ÖÖ3 A
(
ÖÖA B
false
ÖÖB G
)
ÖÖG H
;
ÖÖH I
if
áá 
(
áá 
protocolResult
áá "
.
áá" #
IsOk
áá# '
)
áá' (
{
àà 
return
ââ 
Result
ââ !
<
ââ! "
Unit
ââ" &
,
ââ& '#
AuthenticationFailure
ââ( =
>
ââ= >
.
ââ> ?
Ok
ââ? A
(
ââA B
Unit
ââB F
.
ââF G
Value
ââG L
)
ââL M
;
ââM N
}
ää 
	lastError
åå 
=
åå 
protocolResult
åå *
.
åå* +
	UnwrapErr
åå+ 4
(
åå4 5
)
åå5 6
;
åå6 7
bool
éé 
isRetryableError
éé %
=
éé& '
	lastError
éé( 1
.
éé1 2
FailureType
éé2 =
==
éé> @'
AuthenticationFailureType
ééA Z
.
ééZ ["
NetworkRequestFailed
éé[ o
;
ééo p
if
êê 
(
êê 
!
êê 
isRetryableError
êê %
||
êê& (
attempt
êê) 0
>=
êê1 3,
MAX_PROTOCOL_RECREATE_ATTEMPTS
êê4 R
)
êêR S
{
ëë 
networkProvider
íí #
.
íí# $

ExitOutage
íí$ .
(
íí. /
)
íí/ 0
;
íí0 1
return
ìì 
Result
ìì !
<
ìì! "
Unit
ìì" &
,
ìì& '#
AuthenticationFailure
ìì( =
>
ìì= >
.
ìì> ?
Err
ìì? B
(
ììB C
	lastError
ììC L
)
ììL M
;
ììM N
}
îî 
Serilog
ññ 
.
ññ 
Log
ññ 
.
ññ 
Warning
ññ #
(
ññ# $
$stróó £
,óó£ §
attempt
òò 
+
òò 
$num
òò 
,
òò  ,
MAX_PROTOCOL_RECREATE_ATTEMPTS
òò! ?
,
òò? @
signInFlowResult
òòA Q
.
òòQ R
MembershipId
òòR ^
)
òò^ _
;
òò_ `
networkProvider
öö 
.
öö  &
ClearExhaustedOperations
öö  8
(
öö8 9
)
öö9 :
;
öö: ;
}
õõ 
networkProvider
üü 
.
üü 

ExitOutage
üü &
(
üü& '
)
üü' (
;
üü( )
return
†† 
Result
†† 
<
†† 
Unit
†† 
,
†† #
AuthenticationFailure
††  5
>
††5 6
.
††6 7
Err
††7 :
(
††: ;
	lastError
°° 
??
°° #
AuthenticationFailure
°° 2
.
°°2 3"
NetworkRequestFailed
°°3 G
(
°°G H
$str
°°H k
)
°°k l
)
°°l m
;
°°m n
}
¢¢ 	
finally
££ 
{
§§ 	
signInFlowResult
•• 
.
•• 
Dispose
•• $
(
••$ %
)
••% &
;
••& '
}
¶¶ 	
}
ßß 
public
©© 

void
©© 
Dispose
©© 
(
©© 
)
©© 
{
™™ 
lock
´´ 
(
´´ 
_opaqueClientLock
´´ 
)
´´  
{
¨¨ 	
_opaqueClient
≠≠ 
.
≠≠ 
Do
≠≠ 
(
≠≠ 
client
≠≠ #
=>
≠≠$ &
client
≠≠' -
.
≠≠- .
Dispose
≠≠. 5
(
≠≠5 6
)
≠≠6 7
)
≠≠7 8
;
≠≠8 9
_opaqueClient
ÆÆ 
=
ÆÆ 
Option
ÆÆ "
<
ÆÆ" #
OpaqueClient
ÆÆ# /
>
ÆÆ/ 0
.
ÆÆ0 1
None
ÆÆ1 5
;
ÆÆ5 6
}
ØØ 	
}
∞∞ 
private
≤≤ 
static
≤≤ 
bool
≤≤ (
IsInvalidCredentialFailure
≤≤ 2
(
≤≤2 3
NetworkFailure
≤≤3 A
failure
≤≤B I
)
≤≤I J
{
≥≥ 
if
¥¥ 

(
¥¥ 
failure
¥¥ 
.
¥¥ 
	UserError
¥¥ 
is
¥¥  
null
¥¥! %
)
¥¥% &
{
µµ 	
return
∂∂ 
false
∂∂ 
;
∂∂ 
}
∑∑ 	
return
ππ 
!
ππ 
string
ππ 
.
ππ  
IsNullOrWhiteSpace
ππ )
(
ππ) *
failure
ππ* 1
.
ππ1 2
	UserError
ππ2 ;
.
ππ; <
	I_18N_KEY
ππ< E
)
ππE F
&&
ππG I
string
∫∫ 
.
∫∫ 
Equals
∫∫ 
(
∫∫ 
failure
∫∫ $
.
∫∫$ %
	UserError
∫∫% .
.
∫∫. /
	I_18N_KEY
∫∫/ 8
,
∫∫8 9%
AuthenticationConstants
∫∫: Q
.
∫∫Q R%
INVALID_CREDENTIALS_KEY
∫∫R i
,
∫∫i j
StringComparison
ªª #
.
ªª# $
OrdinalIgnoreCase
ªª$ 5
)
ªª5 6
;
ªª6 7
}
ºº 
private
ææ 
static
ææ 
Result
ææ 
<
ææ 
Unit
ææ 
,
ææ 
ValidationFailure
ææ  1
>
ææ1 2"
ValidateInitResponse
ææ3 G
(
ææG H&
OpaqueSignInInitResponse
ææH `
initResponse
ææa m
)
ææm n
{
øø 
return
¿¿ 
initResponse
¿¿ 
.
¿¿ 
Result
¿¿ "
switch
¿¿# )
{
¡¡ 	&
OpaqueSignInInitResponse
¬¬ $
.
¬¬$ %
Types
¬¬% *
.
¬¬* +
SignInResult
¬¬+ 7
.
¬¬7 8 
InvalidCredentials
¬¬8 J
=>
¬¬K M
Result
¬¬N T
<
¬¬T U
Unit
¬¬U Y
,
¬¬Y Z
ValidationFailure
¬¬[ l
>
¬¬l m
.
¬¬m n
Err
¬¬n q
(
¬¬q r
ValidationFailure
√√ !
.
√√! "
SignInFailed
√√" .
(
√√. /
initResponse
√√/ ;
.
√√; <
Message
√√< C
)
√√C D
)
√√D E
,
√√E F&
OpaqueSignInInitResponse
ƒƒ $
.
ƒƒ$ %
Types
ƒƒ% *
.
ƒƒ* +
SignInResult
ƒƒ+ 7
.
ƒƒ7 8"
LoginAttemptExceeded
ƒƒ8 L
=>
ƒƒM O
Result
ƒƒP V
<
ƒƒV W
Unit
ƒƒW [
,
ƒƒ[ \
ValidationFailure
ƒƒ] n
>
ƒƒn o
.
ƒƒo p
Err
ƒƒp s
(
ƒƒs t
ValidationFailure
≈≈ !
.
≈≈! ""
LoginAttemptExceeded
≈≈" 6
(
≈≈6 7
initResponse
≈≈7 C
.
≈≈C D
Message
≈≈D K
)
≈≈K L
)
≈≈L M
,
≈≈M N
_
∆∆ 
when
∆∆ 
!
∆∆ 
string
∆∆ 
.
∆∆ 
IsNullOrEmpty
∆∆ (
(
∆∆( )
initResponse
∆∆) 5
.
∆∆5 6
Message
∆∆6 =
)
∆∆= >
=>
∆∆? A
Result
«« 
<
«« 
Unit
«« 
,
«« 
ValidationFailure
«« .
>
««. /
.
««/ 0
Err
««0 3
(
««3 4
ValidationFailure
»» %
.
»»% &
SignInFailed
»»& 2
(
»»2 3
initResponse
»»3 ?
.
»»? @
Message
»»@ G
)
»»G H
)
»»H I
,
»»I J
_
   
=>
   
Result
   
<
   
Unit
   
,
   
ValidationFailure
   /
>
  / 0
.
  0 1
Ok
  1 3
(
  3 4
Unit
  4 8
.
  8 9
Value
  9 >
)
  > ?
}
ÀÀ 	
;
ÀÀ	 

}
ÃÃ 
private
ŒŒ 
static
ŒŒ 
bool
ŒŒ *
ValidateMembershipIdentifier
ŒŒ 4
(
ŒŒ4 5

ByteString
ŒŒ5 ?

identifier
ŒŒ@ J
)
ŒŒJ K
{
œœ 
if
–– 

(
–– 

identifier
–– 
.
–– 
Length
–– 
!=
––  $
CryptographicConstants
––! 7
.
––7 8
GUID_BYTE_LENGTH
––8 H
)
––H I
{
—— 	
return
““ 
false
““ 
;
““ 
}
”” 	
ReadOnlySpan
’’ 
<
’’ 
byte
’’ 
>
’’ 
span
’’ 
=
’’  !

identifier
’’" ,
.
’’, -
Span
’’- 1
;
’’1 2
int
◊◊ 
	zeroCount
◊◊ 
=
◊◊ 
$num
◊◊ 
;
◊◊ 
bool
ÿÿ 

hasNonZero
ÿÿ 
=
ÿÿ 
false
ÿÿ 
;
ÿÿ  
for
⁄⁄ 
(
⁄⁄ 
int
⁄⁄ 
i
⁄⁄ 
=
⁄⁄ 
$num
⁄⁄ 
;
⁄⁄ 
i
⁄⁄ 
<
⁄⁄ 
span
⁄⁄  
.
⁄⁄  !
Length
⁄⁄! '
;
⁄⁄' (
i
⁄⁄) *
++
⁄⁄* ,
)
⁄⁄, -
{
€€ 	
if
‹‹ 
(
‹‹ 
span
‹‹ 
[
‹‹ 
i
‹‹ 
]
‹‹ 
==
‹‹ 
$num
‹‹ 
)
‹‹ 
{
›› 
	zeroCount
ﬁﬁ 
++
ﬁﬁ 
;
ﬁﬁ 
}
ﬂﬂ 
else
‡‡ 
{
·· 

hasNonZero
‚‚ 
=
‚‚ 
true
‚‚ !
;
‚‚! "
}
„„ 
}
‰‰ 	
return
ÊÊ 

hasNonZero
ÊÊ 
&&
ÊÊ 
	zeroCount
ÊÊ &
<=
ÊÊ' )$
MAX_ALLOWED_ZERO_BYTES
ÊÊ* @
;
ÊÊ@ A
}
ÁÁ 
private
ÈÈ 
async
ÈÈ 
Task
ÈÈ 
<
ÈÈ 
Result
ÈÈ 
<
ÈÈ 
SignInFlowResult
ÈÈ .
,
ÈÈ. /#
AuthenticationFailure
ÈÈ0 E
>
ÈÈE F
>
ÈÈF G$
ExecuteSignInFlowAsync
ÈÈH ^
(
ÈÈ^ _
string
ÈÈ_ e
mobileNumber
ÈÈf r
,
ÈÈr s
SensitiveBytes
ÍÍ 
	secureKey
ÍÍ  
,
ÍÍ  !
uint
ÎÎ 
	connectId
ÎÎ 
,
ÎÎ 
CancellationToken
ÎÎ )
cancellationToken
ÎÎ* ;
)
ÎÎ; <
{
ÏÏ #
AuthenticationFailure
ÌÌ 
?
ÌÌ 
	lastError
ÌÌ (
=
ÌÌ) *
null
ÌÌ+ /
;
ÌÌ/ 0
for
ÔÔ 
(
ÔÔ 
int
ÔÔ 
attempt
ÔÔ 
=
ÔÔ 
$num
ÔÔ 
;
ÔÔ 
attempt
ÔÔ %
<=
ÔÔ& ('
MAX_SIGN_IN_FLOW_ATTEMPTS
ÔÔ) B
;
ÔÔB C
attempt
ÔÔD K
++
ÔÔK M
)
ÔÔM N
{
 	
Result
ÒÒ 
<
ÒÒ 
SignInFlowResult
ÒÒ #
,
ÒÒ# $#
AuthenticationFailure
ÒÒ% :
>
ÒÒ: ;
attemptResult
ÒÒ< I
=
ÒÒJ K
await
ÚÚ -
ExecuteSingleSignInAttemptAsync
ÚÚ 5
(
ÚÚ5 6
mobileNumber
ÚÚ6 B
,
ÚÚB C
	secureKey
ÚÚD M
,
ÚÚM N
	connectId
ÚÚO X
,
ÚÚX Y
cancellationToken
ÚÚZ k
)
ÚÚk l
.
ÛÛ 
ConfigureAwait
ÛÛ #
(
ÛÛ# $
false
ÛÛ$ )
)
ÛÛ) *
;
ÛÛ* +
if
ıı 
(
ıı 
attemptResult
ıı 
.
ıı 
IsOk
ıı "
)
ıı" #
{
ˆˆ 
networkProvider
˜˜ 
.
˜˜  

ExitOutage
˜˜  *
(
˜˜* +
)
˜˜+ ,
;
˜˜, -
return
¯¯ 
attemptResult
¯¯ $
;
¯¯$ %
}
˘˘ 
	lastError
˚˚ 
=
˚˚ 
attemptResult
˚˚ %
.
˚˚% &
	UnwrapErr
˚˚& /
(
˚˚/ 0
)
˚˚0 1
;
˚˚1 2
if
˝˝ 
(
˝˝ 
!
˝˝ &
ShouldRetrySignInAttempt
˝˝ )
(
˝˝) *
	lastError
˝˝* 3
,
˝˝3 4
attempt
˝˝5 <
)
˝˝< =
)
˝˝= >
{
˛˛ 
networkProvider
ˇˇ 
.
ˇˇ  

ExitOutage
ˇˇ  *
(
ˇˇ* +
)
ˇˇ+ ,
;
ˇˇ, -
return
ÄÄ 
Result
ÄÄ 
<
ÄÄ 
SignInFlowResult
ÄÄ .
,
ÄÄ. /#
AuthenticationFailure
ÄÄ0 E
>
ÄÄE F
.
ÄÄF G
Err
ÄÄG J
(
ÄÄJ K
	lastError
ÄÄK T
)
ÄÄT U
;
ÄÄU V
}
ÅÅ 
Serilog
ÉÉ 
.
ÉÉ 
Log
ÉÉ 
.
ÉÉ 
Warning
ÉÉ 
(
ÉÉ  
$str
ÑÑ r
,
ÑÑr s
attempt
ÖÖ 
+
ÖÖ 
$num
ÖÖ 
,
ÖÖ '
MAX_SIGN_IN_FLOW_ATTEMPTS
ÖÖ 6
)
ÖÖ6 7
;
ÖÖ7 8
networkProvider
áá 
.
áá &
ClearExhaustedOperations
áá 4
(
áá4 5
)
áá5 6
;
áá6 7
}
àà 	
networkProvider
ää 
.
ää 

ExitOutage
ää "
(
ää" #
)
ää# $
;
ää$ %
return
ãã 
Result
ãã 
<
ãã 
SignInFlowResult
ãã &
,
ãã& '#
AuthenticationFailure
ãã( =
>
ãã= >
.
ãã> ?
Err
ãã? B
(
ããB C
	lastError
ããC L
??
ããM O#
AuthenticationFailure
åå !
.
åå! "
UnexpectedError
åå" 1
(
åå1 2
$str
åå2 G
)
ååG H
)
ååH I
;
ååI J
}
çç 
private
èè 
async
èè 
Task
èè 
<
èè 
Result
èè 
<
èè 
SignInFlowResult
èè .
,
èè. /#
AuthenticationFailure
èè0 E
>
èèE F
>
èèF G-
ExecuteSingleSignInAttemptAsync
èèH g
(
èèg h
string
êê 
mobileNumber
êê 
,
êê 
SensitiveBytes
ëë 
	secureKey
ëë  
,
ëë  !
uint
íí 
	connectId
íí 
,
íí 
CancellationToken
ìì 
cancellationToken
ìì +
)
ìì+ ,
{
îî 
RpcRequestContext
ïï 
requestContext
ïï (
=
ïï) *
RpcRequestContext
ïï+ <
.
ïï< =
	CreateNew
ïï= F
(
ïïF G
)
ïïG H
;
ïïH I
bool
ññ 
allowReinit
ññ 
=
ññ 
true
ññ 
;
ññ  
while
òò 
(
òò 
true
òò 
)
òò 
{
ôô 	
Result
öö 
<
öö 
SignInFlowResult
öö #
,
öö# $#
AuthenticationFailure
öö% :
>
öö: ;
result
öö< B
=
ööC D
await
õõ .
 PerformOpaqueSignInExchangeAsync
õõ 6
(
õõ6 7
mobileNumber
õõ7 C
,
õõC D
	secureKey
õõE N
,
õõN O
	connectId
õõP Y
,
õõY Z
requestContext
õõ[ i
,
õõi j
cancellationToken
úú %
)
úú% &
.
úú& '
ConfigureAwait
úú' 5
(
úú5 6
false
úú6 ;
)
úú; <
;
úú< =
if
ûû 
(
ûû 
result
ûû 
.
ûû 
IsOk
ûû 
)
ûû 
{
üü 
return
†† 
result
†† 
;
†† 
}
°° #
AuthenticationFailure
££ !
failure
££" )
=
££* +
result
££, 2
.
££2 3
	UnwrapErr
££3 <
(
££< =
)
££= >
;
££> ?
if
•• 
(
•• !
ShouldAttemptReinit
•• #
(
••# $
failure
••$ +
,
••+ ,
allowReinit
••- 8
)
••8 9
)
••9 :
{
¶¶ 
allowReinit
ßß 
=
ßß 
false
ßß #
;
ßß# $
requestContext
®® 
.
®® !
MarkReinitAttempted
®® 2
(
®®2 3
)
®®3 4
;
®®4 5
continue
©© 
;
©© 
}
™™ 
return
¨¨ 
Result
¨¨ 
<
¨¨ 
SignInFlowResult
¨¨ *
,
¨¨* +#
AuthenticationFailure
¨¨, A
>
¨¨A B
.
¨¨B C
Err
¨¨C F
(
¨¨F G
failure
¨¨G N
)
¨¨N O
;
¨¨O P
}
≠≠ 	
}
ÆÆ 
private
∞∞ 
async
∞∞ 
Task
∞∞ 
<
∞∞ 
Result
∞∞ 
<
∞∞ 
SignInFlowResult
∞∞ .
,
∞∞. /#
AuthenticationFailure
∞∞0 E
>
∞∞E F
>
∞∞F G.
 PerformOpaqueSignInExchangeAsync
∞∞H h
(
∞∞h i
string
±± 
mobileNumber
±± 
,
±± 
SensitiveBytes
≤≤ 
	secureKey
≤≤  
,
≤≤  !
uint
≥≥ 
	connectId
≥≥ 
,
≥≥ 
RpcRequestContext
¥¥ 
requestContext
¥¥ (
,
¥¥( )
CancellationToken
µµ 
cancellationToken
µµ +
)
µµ+ ,
{
∂∂ 
cancellationToken
∑∑ 
.
∑∑ *
ThrowIfCancellationRequested
∑∑ 6
(
∑∑6 7
)
∑∑7 8
;
∑∑8 9
using
ππ 
OpaqueClient
ππ 
opaqueClient
ππ '
=
ππ( )
new
ππ* -
(
ππ- .%
serverPublicKeyProvider
ππ. E
.
ππE F 
GetServerPublicKey
ππF X
(
ππX Y
)
ππY Z
)
ππZ [
;
ππ[ \!
OpaqueSignInContext
ªª 
signInContext
ªª )
=
ªª* +
new
ªª, /
(
ªª/ 0
)
ªª0 1
;
ªª1 2
try
ΩΩ 
{
ææ 	
Result
øø 
<
øø 
byte
øø 
[
øø 
]
øø 
,
øø #
AuthenticationFailure
øø 0
>
øø0 1
secureKeyResult
øø2 A
=
øøB C&
ValidateAndCopySecureKey
øøD \
(
øø\ ]
	secureKey
øø] f
)
øøf g
;
øøg h
if
¿¿ 
(
¿¿ 
secureKeyResult
¿¿ 
.
¿¿  
IsErr
¿¿  %
)
¿¿% &
{
¡¡ 
return
¬¬ 
Result
¬¬ 
<
¬¬ 
SignInFlowResult
¬¬ .
,
¬¬. /#
AuthenticationFailure
¬¬0 E
>
¬¬E F
.
¬¬F G
Err
¬¬G J
(
¬¬J K
secureKeyResult
¬¬K Z
.
¬¬Z [
	UnwrapErr
¬¬[ d
(
¬¬d e
)
¬¬e f
)
¬¬f g
;
¬¬g h
}
√√ 
signInContext
≈≈ 
.
≈≈ 
SecureKeyCopy
≈≈ '
=
≈≈( )
secureKeyResult
≈≈* 9
.
≈≈9 :
Unwrap
≈≈: @
(
≈≈@ A
)
≈≈A B
;
≈≈B C
Result
«« 
<
«« 
SignInFlowResult
«« #
,
««# $#
AuthenticationFailure
««% :
>
««: ;
result
««< B
=
««C D
await
««E J+
ExecuteOpaqueSignInStepsAsync
««K h
(
««h i
opaqueClient
»» 
,
»» 
mobileNumber
…… 
,
…… 
signInContext
   
,
   
	connectId
ÀÀ 
,
ÀÀ 
requestContext
ÃÃ 
,
ÃÃ 
cancellationToken
ÕÕ !
)
ÕÕ! "
.
ÕÕ" #
ConfigureAwait
ÕÕ# 1
(
ÕÕ1 2
false
ÕÕ2 7
)
ÕÕ7 8
;
ÕÕ8 9
return
œœ 
result
œœ 
;
œœ 
}
–– 	
finally
—— 
{
““ 	"
CleanupSignInContext
””  
(
””  !
signInContext
””! .
)
””. /
;
””/ 0
}
‘‘ 	
}
’’ 
private
◊◊ 
async
◊◊ 
Task
◊◊ 
<
◊◊ 
Result
◊◊ 
<
◊◊ 
SignInFlowResult
◊◊ .
,
◊◊. /#
AuthenticationFailure
◊◊0 E
>
◊◊E F
>
◊◊F G+
ExecuteOpaqueSignInStepsAsync
◊◊H e
(
◊◊e f
OpaqueClient
ÿÿ 
opaqueClient
ÿÿ !
,
ÿÿ! "
string
ŸŸ 
mobileNumber
ŸŸ 
,
ŸŸ !
OpaqueSignInContext
⁄⁄ 
signInContext
⁄⁄ )
,
⁄⁄) *
uint
€€ 
	connectId
€€ 
,
€€ 
RpcRequestContext
‹‹ 
requestContext
‹‹ (
,
‹‹( )
CancellationToken
›› 
cancellationToken
›› +
)
››+ ,
{
ﬁﬁ 
using
ﬂﬂ 
KeyExchangeResult
ﬂﬂ 
	ke1Result
ﬂﬂ  )
=
ﬂﬂ* +
opaqueClient
ﬂﬂ, 8
.
ﬂﬂ8 9
GenerateKE1
ﬂﬂ9 D
(
ﬂﬂD E
signInContext
ﬂﬂE R
.
ﬂﬂR S
SecureKeyCopy
ﬂﬂS `
!
ﬂﬂ` a
)
ﬂﬂa b
;
ﬂﬂb c
Result
·· 
<
·· &
OpaqueSignInInitResponse
·· '
,
··' (#
AuthenticationFailure
··) >
>
··> ?

initResult
··@ J
=
··K L
await
‚‚ )
PerformSignInInitPhaseAsync
‚‚ -
(
‚‚- .
mobileNumber
‚‚. :
,
‚‚: ;
	ke1Result
‚‚< E
,
‚‚E F
	connectId
‚‚G P
,
‚‚P Q
requestContext
‚‚R `
,
‚‚` a
cancellationToken
‚‚b s
)
‚‚s t
.
„„ 
ConfigureAwait
„„ 
(
„„  
false
„„  %
)
„„% &
;
„„& '
if
ÂÂ 

(
ÂÂ 

initResult
ÂÂ 
.
ÂÂ 
IsErr
ÂÂ 
)
ÂÂ 
{
ÊÊ 	
return
ÁÁ 
Result
ÁÁ 
<
ÁÁ 
SignInFlowResult
ÁÁ *
,
ÁÁ* +#
AuthenticationFailure
ÁÁ, A
>
ÁÁA B
.
ÁÁB C
Err
ÁÁC F
(
ÁÁF G

initResult
ÁÁG Q
.
ÁÁQ R
	UnwrapErr
ÁÁR [
(
ÁÁ[ \
)
ÁÁ\ ]
)
ÁÁ] ^
;
ÁÁ^ _
}
ËË 	&
OpaqueSignInInitResponse
ÍÍ  
initResponse
ÍÍ! -
=
ÍÍ. /

initResult
ÍÍ0 :
.
ÍÍ: ;
Unwrap
ÍÍ; A
(
ÍÍA B
)
ÍÍB C
;
ÍÍC D
signInContext
ÎÎ 
.
ÎÎ 
Ke2Data
ÎÎ 
=
ÎÎ 
initResponse
ÎÎ  ,
.
ÎÎ, -
ServerStateToken
ÎÎ- =
.
ÎÎ= >
ToByteArray
ÎÎ> I
(
ÎÎI J
)
ÎÎJ K
;
ÎÎK L
Result
ÌÌ 
<
ÌÌ  
OpaqueExchangeData
ÌÌ !
,
ÌÌ! "#
AuthenticationFailure
ÌÌ# 8
>
ÌÌ8 9
exchangeResult
ÌÌ: H
=
ÌÌI J'
CompleteOpaqueKeyExchange
ÓÓ %
(
ÓÓ% &
opaqueClient
ÓÓ& 2
,
ÓÓ2 3
signInContext
ÓÓ4 A
.
ÓÓA B
Ke2Data
ÓÓB I
,
ÓÓI J
	ke1Result
ÓÓK T
)
ÓÓT U
;
ÓÓU V
if
 

(
 
exchangeResult
 
.
 
IsErr
  
)
  !
{
ÒÒ 	
return
ÚÚ 
Result
ÚÚ 
<
ÚÚ 
SignInFlowResult
ÚÚ *
,
ÚÚ* +#
AuthenticationFailure
ÚÚ, A
>
ÚÚA B
.
ÚÚB C
Err
ÚÚC F
(
ÚÚF G
exchangeResult
ÚÚG U
.
ÚÚU V
	UnwrapErr
ÚÚV _
(
ÚÚ_ `
)
ÚÚ` a
)
ÚÚa b
;
ÚÚb c
}
ÛÛ 	 
OpaqueExchangeData
ıı 
exchangeData
ıı '
=
ıı( )
exchangeResult
ıı* 8
.
ıı8 9
Unwrap
ıı9 ?
(
ıı? @
)
ıı@ A
;
ııA B
signInContext
ˆˆ 
.
ˆˆ 
Ke3Data
ˆˆ 
=
ˆˆ 
exchangeData
ˆˆ  ,
.
ˆˆ, -
Ke3Data
ˆˆ- 4
;
ˆˆ4 5
signInContext
˜˜ 
.
˜˜ 
MasterKeyHandle
˜˜ %
=
˜˜& '
exchangeData
˜˜( 4
.
˜˜4 5
MasterKeyHandle
˜˜5 D
;
˜˜D E
Result
˘˘ 
<
˘˘ 
SignInFlowResult
˘˘ 
,
˘˘  #
AuthenticationFailure
˘˘! 6
>
˘˘6 7
finalizeResult
˘˘8 F
=
˘˘G H
await
˙˙ -
PerformSignInFinalizePhaseAsync
˙˙ 1
(
˙˙1 2
mobileNumber
˚˚ 
,
˚˚ 
signInContext
¸¸ 
.
¸¸ 
Ke3Data
¸¸ %
,
¸¸% &
signInContext
˝˝ 
.
˝˝ 
MasterKeyHandle
˝˝ -
,
˝˝- .
	connectId
˛˛ 
,
˛˛ 
requestContext
ˇˇ 
,
ˇˇ 
cancellationToken
ÄÄ !
)
ÄÄ! "
.
ÄÄ" #
ConfigureAwait
ÄÄ# 1
(
ÄÄ1 2
false
ÄÄ2 7
)
ÄÄ7 8
;
ÄÄ8 9
if
ÇÇ 

(
ÇÇ 
finalizeResult
ÇÇ 
.
ÇÇ 
IsOk
ÇÇ 
)
ÇÇ  
{
ÉÉ 	
signInContext
ÑÑ 
.
ÑÑ "
OwnershipTransferred
ÑÑ .
=
ÑÑ/ 0
true
ÑÑ1 5
;
ÑÑ5 6
}
ÖÖ 	
return
áá 
finalizeResult
áá 
;
áá 
}
àà 
private
ää 
void
ää "
CleanupSignInContext
ää %
(
ää% &!
OpaqueSignInContext
ää& 9
context
ää: A
)
ääA B
{
ãã 
if
åå 

(
åå 
context
åå 
.
åå 
MasterKeyHandle
åå #
!=
åå$ &
null
åå' +
&&
åå, .
!
åå/ 0
context
åå0 7
.
åå7 8"
OwnershipTransferred
åå8 L
)
ååL M
{
çç 	
context
éé 
.
éé 
MasterKeyHandle
éé #
.
éé# $
Dispose
éé$ +
(
éé+ ,
)
éé, -
;
éé- .
}
èè 	
SecureCleanup
êê 
(
êê 
context
êê 
.
êê 
SecureKeyCopy
êê +
,
êê+ ,
context
êê- 4
.
êê4 5
Ke2Data
êê5 <
,
êê< =
context
êê> E
.
êêE F
Ke3Data
êêF M
)
êêM N
;
êêN O
}
ëë 
private
ìì 
sealed
ìì 
class
ìì !
OpaqueSignInContext
ìì ,
{
îî 
public
ïï 
byte
ïï 
[
ïï 
]
ïï 
?
ïï 
SecureKeyCopy
ïï $
{
ïï% &
get
ïï' *
;
ïï* +
set
ïï, /
;
ïï/ 0
}
ïï1 2
public
ññ 
byte
ññ 
[
ññ 
]
ññ 
?
ññ 
Ke2Data
ññ 
{
ññ  
get
ññ! $
;
ññ$ %
set
ññ& )
;
ññ) *
}
ññ+ ,
public
óó 
byte
óó 
[
óó 
]
óó 
?
óó 
Ke3Data
óó 
{
óó  
get
óó! $
;
óó$ %
set
óó& )
;
óó) *
}
óó+ ,
public
òò &
SodiumSecureMemoryHandle
òò '
?
òò' (
MasterKeyHandle
òò) 8
{
òò9 :
get
òò; >
;
òò> ?
set
òò@ C
;
òòC D
}
òòE F
public
ôô 
bool
ôô "
OwnershipTransferred
ôô (
{
ôô) *
get
ôô+ .
;
ôô. /
set
ôô0 3
;
ôô3 4
}
ôô5 6
}
öö 
private
úú 
async
úú 
Task
úú 
<
úú 
Result
úú 
<
úú &
OpaqueSignInInitResponse
úú 6
,
úú6 7#
AuthenticationFailure
úú8 M
>
úúM N
>
úúN O)
PerformSignInInitPhaseAsync
úúP k
(
úúk l
string
ùù 
mobileNumber
ùù 
,
ùù 
KeyExchangeResult
ûû 
	ke1Result
ûû #
,
ûû# $
uint
üü 
	connectId
üü 
,
üü 
RpcRequestContext
†† 
requestContext
†† (
,
††( )
CancellationToken
°° 
cancellationToken
°° +
)
°°+ ,
{
¢¢ %
OpaqueSignInInitRequest
££ 
initRequest
££  +
=
££, -
new
££. 1
(
££1 2
)
££2 3
{
§§ 	
MobileNumber
•• 
=
•• 
mobileNumber
•• '
,
••' (
PeerOprf
¶¶ 
=
¶¶ 

ByteString
¶¶ !
.
¶¶! "
CopyFrom
¶¶" *
(
¶¶* +
	ke1Result
¶¶+ 4
.
¶¶4 5$
GetKeyExchangeDataCopy
¶¶5 K
(
¶¶K L
)
¶¶L M
)
¶¶M N
,
¶¶N O
}
ßß 	
;
ßß	 

Result
©© 
<
©© &
OpaqueSignInInitResponse
©© '
,
©©' (
NetworkFailure
©©) 7
>
©©7 8

initResult
©©9 C
=
©©D E
await
™™ "
SendInitRequestAsync
™™ &
(
™™& '
initRequest
™™' 2
,
™™2 3
	connectId
™™4 =
,
™™= >
requestContext
™™? M
,
™™M N
cancellationToken
™™O `
)
™™` a
.
´´ 
ConfigureAwait
´´ 
(
´´  
false
´´  %
)
´´% &
;
´´& '
if
≠≠ 

(
≠≠ 

initResult
≠≠ 
.
≠≠ 
IsErr
≠≠ 
)
≠≠ 
{
ÆÆ 	
return
ØØ 
Result
ØØ 
<
ØØ &
OpaqueSignInInitResponse
ØØ 2
,
ØØ2 3#
AuthenticationFailure
ØØ4 I
>
ØØI J
.
ØØJ K
Err
ØØK N
(
ØØN O
MapNetworkFailure
∞∞ !
(
∞∞! "

initResult
∞∞" ,
.
∞∞, -
	UnwrapErr
∞∞- 6
(
∞∞6 7
)
∞∞7 8
)
∞∞8 9
)
∞∞9 :
;
∞∞: ;
}
±± 	&
OpaqueSignInInitResponse
≥≥  
initResponse
≥≥! -
=
≥≥. /

initResult
≥≥0 :
.
≥≥: ;
Unwrap
≥≥; A
(
≥≥A B
)
≥≥B C
;
≥≥C D
Result
µµ 
<
µµ 
Unit
µµ 
,
µµ 
ValidationFailure
µµ &
>
µµ& '
validationResult
µµ( 8
=
µµ9 :"
ValidateInitResponse
µµ; O
(
µµO P
initResponse
µµP \
)
µµ\ ]
;
µµ] ^
if
∂∂ 

(
∂∂ 
validationResult
∂∂ 
.
∂∂ 
IsErr
∂∂ "
)
∂∂" #
{
∑∑ 	
return
∏∏ 
Result
∏∏ 
<
∏∏ &
OpaqueSignInInitResponse
∏∏ 2
,
∏∏2 3#
AuthenticationFailure
∏∏4 I
>
∏∏I J
.
∏∏J K
Err
∏∏K N
(
∏∏N O"
MapValidationFailure
ππ $
(
ππ$ %
validationResult
ππ% 5
.
ππ5 6
	UnwrapErr
ππ6 ?
(
ππ? @
)
ππ@ A
)
ππA B
)
ππB C
;
ππC D
}
∫∫ 	
return
ºº 
Result
ºº 
<
ºº &
OpaqueSignInInitResponse
ºº .
,
ºº. /#
AuthenticationFailure
ºº0 E
>
ººE F
.
ººF G
Ok
ººG I
(
ººI J
initResponse
ººJ V
)
ººV W
;
ººW X
}
ΩΩ 
private
øø 
Result
øø 
<
øø  
OpaqueExchangeData
øø %
,
øø% &#
AuthenticationFailure
øø' <
>
øø< ='
CompleteOpaqueKeyExchange
øø> W
(
øøW X
OpaqueClient
¿¿ 
opaqueClient
¿¿ !
,
¿¿! "
byte
¡¡ 
[
¡¡ 
]
¡¡ 
ke2Data
¡¡ 
,
¡¡ 
KeyExchangeResult
¬¬ 
	ke1Result
¬¬ #
)
¬¬# $
{
√√ 
Result
ƒƒ 
<
ƒƒ 
byte
ƒƒ 
[
ƒƒ 
]
ƒƒ 
,
ƒƒ #
AuthenticationFailure
ƒƒ ,
>
ƒƒ, -
	ke3Result
ƒƒ. 7
=
ƒƒ8 9&
PerformOpaqueKe3Exchange
ƒƒ: R
(
ƒƒR S
opaqueClient
ƒƒS _
,
ƒƒ_ `
ke2Data
ƒƒa h
,
ƒƒh i
	ke1Result
ƒƒj s
)
ƒƒs t
;
ƒƒt u
if
≈≈ 

(
≈≈ 
	ke3Result
≈≈ 
.
≈≈ 
IsErr
≈≈ 
)
≈≈ 
{
∆∆ 	
return
«« 
Result
«« 
<
««  
OpaqueExchangeData
«« ,
,
««, -#
AuthenticationFailure
««. C
>
««C D
.
««D E
Err
««E H
(
««H I
	ke3Result
««I R
.
««R S
	UnwrapErr
««S \
(
««\ ]
)
««] ^
)
««^ _
;
««_ `
}
»» 	
byte
   
[
   
]
   
ke3Data
   
=
   
	ke3Result
   "
.
  " #
Unwrap
  # )
(
  ) *
)
  * +
;
  + ,
Result
ÃÃ 
<
ÃÃ &
SodiumSecureMemoryHandle
ÃÃ '
,
ÃÃ' (#
AuthenticationFailure
ÃÃ) >
>
ÃÃ> ?
masterKeyResult
ÃÃ@ O
=
ÃÃP Q(
ExtractMasterKeyFromOpaque
ÕÕ &
(
ÕÕ& '
opaqueClient
ÕÕ' 3
,
ÕÕ3 4
	ke1Result
ÕÕ5 >
)
ÕÕ> ?
;
ÕÕ? @
if
œœ 

(
œœ 
masterKeyResult
œœ 
.
œœ 
IsErr
œœ !
)
œœ! "
{
–– 	
return
—— 
Result
—— 
<
——  
OpaqueExchangeData
—— ,
,
——, -#
AuthenticationFailure
——. C
>
——C D
.
——D E
Err
——E H
(
——H I
masterKeyResult
——I X
.
——X Y
	UnwrapErr
——Y b
(
——b c
)
——c d
)
——d e
;
——e f
}
““ 	&
SodiumSecureMemoryHandle
‘‘  
masterKeyHandle
‘‘! 0
=
‘‘1 2
masterKeyResult
‘‘3 B
.
‘‘B C
Unwrap
‘‘C I
(
‘‘I J
)
‘‘J K
;
‘‘K L
return
÷÷ 
Result
÷÷ 
<
÷÷  
OpaqueExchangeData
÷÷ (
,
÷÷( )#
AuthenticationFailure
÷÷* ?
>
÷÷? @
.
÷÷@ A
Ok
÷÷A C
(
÷÷C D
new
◊◊  
OpaqueExchangeData
◊◊ "
(
◊◊" #
ke3Data
◊◊# *
,
◊◊* +
masterKeyHandle
◊◊, ;
)
◊◊; <
)
◊◊< =
;
◊◊= >
}
ÿÿ 
private
⁄⁄ 
async
⁄⁄ 
Task
⁄⁄ 
<
⁄⁄ 
Result
⁄⁄ 
<
⁄⁄ 
SignInFlowResult
⁄⁄ .
,
⁄⁄. /#
AuthenticationFailure
⁄⁄0 E
>
⁄⁄E F
>
⁄⁄F G-
PerformSignInFinalizePhaseAsync
⁄⁄H g
(
⁄⁄g h
string
€€ 
mobileNumber
€€ 
,
€€ 
byte
‹‹ 
[
‹‹ 
]
‹‹ 
ke3Data
‹‹ 
,
‹‹ &
SodiumSecureMemoryHandle
››  
masterKeyHandle
››! 0
,
››0 1
uint
ﬁﬁ 
	connectId
ﬁﬁ 
,
ﬁﬁ 
RpcRequestContext
ﬂﬂ 
requestContext
ﬂﬂ (
,
ﬂﬂ( )
CancellationToken
‡‡ 
cancellationToken
‡‡ +
)
‡‡+ ,
{
·· )
OpaqueSignInFinalizeRequest
‚‚ #
finalizeRequest
‚‚$ 3
=
‚‚4 5
new
‚‚6 9
(
‚‚9 :
)
‚‚: ;
{
„„ 	
MobileNumber
‰‰ 
=
‰‰ 
mobileNumber
‰‰ '
,
‰‰' (
	ClientMac
ÂÂ 
=
ÂÂ 

ByteString
ÂÂ "
.
ÂÂ" #
CopyFrom
ÂÂ# +
(
ÂÂ+ ,
ke3Data
ÂÂ, 3
)
ÂÂ3 4
,
ÂÂ4 5
}
ÊÊ 	
;
ÊÊ	 

Result
ËË 
<
ËË 
SignInResult
ËË 
,
ËË 
NetworkFailure
ËË +
>
ËË+ ,
finalResult
ËË- 8
=
ËË9 :
await
ÈÈ /
!SendFinalizeRequestAndVerifyAsync
ÈÈ 3
(
ÈÈ3 4
finalizeRequest
ÈÈ4 C
,
ÈÈC D
	connectId
ÈÈE N
,
ÈÈN O
requestContext
ÈÈP ^
,
ÈÈ^ _
cancellationToken
ÈÈ` q
)
ÈÈq r
.
ÍÍ 
ConfigureAwait
ÍÍ 
(
ÍÍ  
false
ÍÍ  %
)
ÍÍ% &
;
ÍÍ& '
if
ÏÏ 

(
ÏÏ 
finalResult
ÏÏ 
.
ÏÏ 
IsErr
ÏÏ 
)
ÏÏ 
{
ÌÌ 	
return
ÓÓ 
Result
ÓÓ 
<
ÓÓ 
SignInFlowResult
ÓÓ *
,
ÓÓ* +#
AuthenticationFailure
ÓÓ, A
>
ÓÓA B
.
ÓÓB C
Err
ÓÓC F
(
ÓÓF G
MapNetworkFailure
ÔÔ !
(
ÔÔ! "
finalResult
ÔÔ" -
.
ÔÔ- .
	UnwrapErr
ÔÔ. 7
(
ÔÔ7 8
)
ÔÔ8 9
)
ÔÔ9 :
)
ÔÔ: ;
;
ÔÔ; <
}
 	
SignInResult
ÚÚ 
signInResult
ÚÚ !
=
ÚÚ" #
finalResult
ÚÚ$ /
.
ÚÚ/ 0
Unwrap
ÚÚ0 6
(
ÚÚ6 7
)
ÚÚ7 8
;
ÚÚ8 9
return
ÙÙ 
await
ÙÙ &
ProcessSignInResultAsync
ÙÙ -
(
ÙÙ- .
masterKeyHandle
ÙÙ. =
,
ÙÙ= >
signInResult
ÙÙ? K
)
ÙÙK L
.
ÙÙL M
ConfigureAwait
ÙÙM [
(
ÙÙ[ \
false
ÙÙ\ a
)
ÙÙa b
;
ÙÙb c
}
ıı 
private
˜˜ 
async
˜˜ 
Task
˜˜ 
<
˜˜ 
Result
˜˜ 
<
˜˜ 
SignInFlowResult
˜˜ .
,
˜˜. /#
AuthenticationFailure
˜˜0 E
>
˜˜E F
>
˜˜F G&
ProcessSignInResultAsync
˜˜H `
(
˜˜` a&
SodiumSecureMemoryHandle
¯¯  
masterKeyHandle
¯¯! 0
,
¯¯0 1
SignInResult
˘˘ 
signInResult
˘˘ !
)
˘˘! "
{
˙˙ 
if
˚˚ 

(
˚˚ 
signInResult
˚˚ 
.
˚˚ 

Membership
˚˚ #
==
˚˚$ &
null
˚˚' +
)
˚˚+ ,
{
¸¸ 	
return
˝˝ 
Result
˝˝ 
<
˝˝ 
SignInFlowResult
˝˝ *
,
˝˝* +#
AuthenticationFailure
˝˝, A
>
˝˝A B
.
˝˝B C
Ok
˝˝C E
(
˝˝E F
new
˛˛ 
SignInFlowResult
˛˛ $
(
˛˛$ %
masterKeyHandle
˛˛% 4
,
˛˛4 5

ByteString
˛˛6 @
.
˛˛@ A
Empty
˛˛A F
,
˛˛F G
Guid
˛˛H L
.
˛˛L M
Empty
˛˛M R
)
˛˛R S
)
˛˛S T
;
˛˛T U
}
ˇˇ 	

ByteString
ÅÅ "
membershipIdentifier
ÅÅ '
=
ÅÅ( )
signInResult
ÅÅ* 6
.
ÅÅ6 7

Membership
ÅÅ7 A
.
ÅÅA B
UniqueIdentifier
ÅÅB R
;
ÅÅR S
Result
ÉÉ 
<
ÉÉ &
SodiumSecureMemoryHandle
ÉÉ '
,
ÉÉ' (#
AuthenticationFailure
ÉÉ) >
>
ÉÉ> ?'
masterKeyValidationResult
ÉÉ@ Y
=
ÉÉZ [*
DeriveMasterKeyForMembership
ÑÑ (
(
ÑÑ( )
masterKeyHandle
ÑÑ) 8
,
ÑÑ8 9"
membershipIdentifier
ÑÑ: N
)
ÑÑN O
;
ÑÑO P
if
ÜÜ 

(
ÜÜ '
masterKeyValidationResult
ÜÜ %
.
ÜÜ% &
IsErr
ÜÜ& +
)
ÜÜ+ ,
{
áá 	
return
àà 
Result
àà 
<
àà 
SignInFlowResult
àà *
,
àà* +#
AuthenticationFailure
àà, A
>
ààA B
.
ààB C
Err
ààC F
(
ààF G'
masterKeyValidationResult
ààG `
.
àà` a
	UnwrapErr
ààa j
(
ààj k
)
ààk l
)
ààl m
;
ààm n
}
ââ 	
Result
ãã 
<
ãã 
Unit
ãã 
,
ãã #
AuthenticationFailure
ãã *
>
ãã* +
storeResult
ãã, 7
=
ãã8 9
await
åå -
StoreIdentityAndMembershipAsync
åå 1
(
åå1 2
masterKeyHandle
åå2 A
,
ååA B
signInResult
ååC O
)
ååO P
.
ååP Q
ConfigureAwait
ååQ _
(
åå_ `
false
åå` e
)
ååe f
;
ååf g
if
éé 

(
éé 
storeResult
éé 
.
éé 
IsErr
éé 
)
éé 
{
èè 	
return
êê 
Result
êê 
<
êê 
SignInFlowResult
êê *
,
êê* +#
AuthenticationFailure
êê, A
>
êêA B
.
êêB C
Err
êêC F
(
êêF G
storeResult
êêG R
.
êêR S
	UnwrapErr
êêS \
(
êê\ ]
)
êê] ^
)
êê^ _
;
êê_ `
}
ëë 	
Guid
ìì 
membershipId
ìì 
=
ìì 
Helpers
ìì #
.
ìì# $"
FromByteStringToGuid
ìì$ 8
(
ìì8 9"
membershipIdentifier
ìì9 M
)
ììM N
;
ììN O
SignInFlowResult
îî 

flowResult
îî #
=
îî$ %
new
îî& )
(
îî) *
masterKeyHandle
îî* 9
,
îî9 :"
membershipIdentifier
îî; O
,
îîO P
membershipId
îîQ ]
)
îî] ^
;
îî^ _
return
ññ 
Result
ññ 
<
ññ 
SignInFlowResult
ññ &
,
ññ& '#
AuthenticationFailure
ññ( =
>
ññ= >
.
ññ> ?
Ok
ññ? A
(
ññA B

flowResult
ññB L
)
ññL M
;
ññM N
}
óó 
private
ôô 
static
ôô 
bool
ôô &
ShouldRetrySignInAttempt
ôô 0
(
ôô0 1#
AuthenticationFailure
ôô1 F
failure
ôôG N
,
ôôN O
int
ôôP S
attempt
ôôT [
)
ôô[ \
{
öö 
bool
õõ 
isRetryableError
õõ 
=
õõ 
failure
õõ  '
.
õõ' (
FailureType
õõ( 3
==
õõ4 6'
AuthenticationFailureType
õõ7 P
.
õõP Q"
NetworkRequestFailed
õõQ e
;
õõe f
return
úú 
isRetryableError
úú 
&&
úú  "
attempt
úú# *
<
úú+ ,'
MAX_SIGN_IN_FLOW_ATTEMPTS
úú- F
;
úúF G
}
ùù 
private
üü 
static
üü 
bool
üü !
ShouldAttemptReinit
üü +
(
üü+ ,#
AuthenticationFailure
üü, A
failure
üüB I
,
üüI J
bool
üüK O
allowReinit
üüP [
)
üü[ \
{
†† 
if
°° 

(
°° 
!
°° 
allowReinit
°° 
)
°° 
{
¢¢ 	
return
££ 
false
££ 
;
££ 
}
§§ 	
return
¶¶ 
failure
¶¶ 
.
¶¶ 
FailureType
¶¶ "
==
¶¶# %'
AuthenticationFailureType
¶¶& ?
.
¶¶? @"
NetworkRequestFailed
¶¶@ T
;
¶¶T U
}
ßß 
private
©© 
static
©© #
AuthenticationFailure
©© ("
MapValidationFailure
©©) =
(
©©= >
ValidationFailure
©©> O

validation
©©P Z
)
©©Z [
{
™™ 
return
´´ 

validation
´´ 
.
´´ 
FailureType
´´ %
switch
´´& ,
{
¨¨ 	#
ValidationFailureType
≠≠ !
.
≠≠! "
SignInFailed
≠≠" .
=>
≠≠/ 1#
AuthenticationFailure
≠≠2 G
.
≠≠G H 
InvalidCredentials
≠≠H Z
(
≠≠Z [

validation
≠≠[ e
.
≠≠e f
Message
≠≠f m
)
≠≠m n
,
≠≠n o#
ValidationFailureType
ÆÆ !
.
ÆÆ! ""
LoginAttemptExceeded
ÆÆ" 6
=>
ÆÆ7 9#
AuthenticationFailure
ÆÆ: O
.
ÆÆO P"
LoginAttemptExceeded
ÆÆP d
(
ÆÆd e

validation
ÆÆe o
.
ÆÆo p
Message
ÆÆp w
)
ÆÆw x
,
ÆÆx y
_
ØØ 
=>
ØØ #
AuthenticationFailure
ØØ &
.
ØØ& '
UnexpectedError
ØØ' 6
(
ØØ6 7

validation
ØØ7 A
.
ØØA B
Message
ØØB I
)
ØØI J
}
∞∞ 	
;
∞∞	 

}
±± 
private
≥≥ 
readonly
≥≥ 
record
≥≥ 
struct
≥≥ " 
OpaqueExchangeData
≥≥# 5
(
≥≥5 6
byte
≥≥6 :
[
≥≥: ;
]
≥≥; <
Ke3Data
≥≥= D
,
≥≥D E&
SodiumSecureMemoryHandle
≥≥F ^
MasterKeyHandle
≥≥_ n
)
≥≥n o
;
≥≥o p
private
µµ 
string
µµ #
GetOpaqueErrorMessage
µµ (
(
µµ( )
OpaqueResult
µµ) 5
error
µµ6 ;
)
µµ; <
{
∂∂ 
return
∑∑ !
OpaqueErrorMessages
∑∑ "
.
∑∑" #
TryGetValue
∑∑# .
(
∑∑. /
error
∑∑/ 4
,
∑∑4 5
out
∑∑6 9
string
∑∑: @
?
∑∑@ A
key
∑∑B E
)
∑∑E F
?
∏∏ !
localizationService
∏∏ !
[
∏∏! "
key
∏∏" %
]
∏∏% &
:
ππ !
localizationService
ππ !
[
ππ! "%
AuthenticationConstants
ππ" 9
.
ππ9 :)
COMMON_UNEXPECTED_ERROR_KEY
ππ: U
]
ππU V
;
ππV W
}
∫∫ 
private
ºº 
async
ºº 
Task
ºº 
<
ºº 
Result
ºº 
<
ºº &
OpaqueSignInInitResponse
ºº 6
,
ºº6 7
NetworkFailure
ºº8 F
>
ººF G
>
ººG H"
SendInitRequestAsync
ººI ]
(
ºº] ^%
OpaqueSignInInitRequest
ΩΩ 
initRequest
ΩΩ  +
,
ΩΩ+ ,
uint
ææ 
	connectId
ææ 
,
ææ 
RpcRequestContext
øø 
requestContext
øø (
,
øø( )
CancellationToken
¿¿ 
cancellationToken
¿¿ +
)
¿¿+ ,
{
¡¡ "
TaskCompletionSource
¬¬ 
<
¬¬ &
OpaqueSignInInitResponse
¬¬ 5
>
¬¬5 6&
responseCompletionSource
¬¬7 O
=
¬¬P Q
new
¬¬R U
(
¬¬U V
)
¬¬V W
;
¬¬W X
Result
ƒƒ 
<
ƒƒ 
Unit
ƒƒ 
,
ƒƒ 
NetworkFailure
ƒƒ #
>
ƒƒ# $
networkResult
ƒƒ% 2
=
ƒƒ3 4
await
ƒƒ5 :
networkProvider
ƒƒ; J
.
ƒƒJ K&
ExecuteUnaryRequestAsync
ƒƒK c
(
ƒƒc d
	connectId
≈≈ 
,
≈≈ 
RpcServiceType
∆∆ 
.
∆∆ 
SignInInitRequest
∆∆ ,
,
∆∆, -%
SecureByteStringInterop
«« #
.
««# $"
WithByteStringAsSpan
««$ 8
(
««8 9
initRequest
««9 D
.
««D E
ToByteString
««E Q
(
««Q R
)
««R S
,
««S T
span
««U Y
=>
««Z \
span
««] a
.
««a b
ToArray
««b i
(
««i j
)
««j k
)
««k l
,
««l m!
initResponsePayload
»» 
=>
»»  "
{
…… &
OpaqueSignInInitResponse
   (
response
  ) 1
=
  2 3
Helpers
ÀÀ 
.
ÀÀ 
ParseFromBytes
ÀÀ *
<
ÀÀ* +&
OpaqueSignInInitResponse
ÀÀ+ C
>
ÀÀC D
(
ÀÀD E!
initResponsePayload
ÀÀE X
)
ÀÀX Y
;
ÀÀY Z&
responseCompletionSource
ÃÃ (
.
ÃÃ( )
TrySetResult
ÃÃ) 5
(
ÃÃ5 6
response
ÃÃ6 >
)
ÃÃ> ?
;
ÃÃ? @
return
ÕÕ 
Task
ÕÕ 
.
ÕÕ 

FromResult
ÕÕ &
(
ÕÕ& '
Result
ÕÕ' -
<
ÕÕ- .
Unit
ÕÕ. 2
,
ÕÕ2 3
NetworkFailure
ÕÕ4 B
>
ÕÕB C
.
ÕÕC D
Ok
ÕÕD F
(
ÕÕF G
Unit
ÕÕG K
.
ÕÕK L
Value
ÕÕL Q
)
ÕÕQ R
)
ÕÕR S
;
ÕÕS T
}
ŒŒ 
,
ŒŒ 
false
ŒŒ 
,
ŒŒ 
cancellationToken
ŒŒ '
,
ŒŒ' (
waitForRecovery
ŒŒ) 8
:
ŒŒ8 9
false
ŒŒ: ?
,
ŒŒ? @
requestContext
ŒŒA O
)
œœ 	
.
œœ	 

ConfigureAwait
œœ
 
(
œœ 
false
œœ 
)
œœ 
;
œœ  
if
—— 

(
—— 
networkResult
—— 
.
—— 
IsErr
—— 
)
——  
{
““ 	
return
”” 
Result
”” 
<
”” &
OpaqueSignInInitResponse
”” 2
,
””2 3
NetworkFailure
””4 B
>
””B C
.
””C D
Err
””D G
(
””G H
networkResult
””H U
.
””U V
	UnwrapErr
””V _
(
””_ `
)
””` a
)
””a b
;
””b c
}
‘‘ 	&
OpaqueSignInInitResponse
÷÷  
response
÷÷! )
=
÷÷* +
await
÷÷, 1&
responseCompletionSource
÷÷2 J
.
÷÷J K
Task
÷÷K O
.
÷÷O P
ConfigureAwait
÷÷P ^
(
÷÷^ _
false
÷÷_ d
)
÷÷d e
;
÷÷e f
return
◊◊ 
Result
◊◊ 
<
◊◊ &
OpaqueSignInInitResponse
◊◊ .
,
◊◊. /
NetworkFailure
◊◊0 >
>
◊◊> ?
.
◊◊? @
Ok
◊◊@ B
(
◊◊B C
response
◊◊C K
)
◊◊K L
;
◊◊L M
}
ÿÿ 
private
⁄⁄ 
async
⁄⁄ 
Task
⁄⁄ 
<
⁄⁄ 
Result
⁄⁄ 
<
⁄⁄ 
SignInResult
⁄⁄ *
,
⁄⁄* +
NetworkFailure
⁄⁄, :
>
⁄⁄: ;
>
⁄⁄; </
!SendFinalizeRequestAndVerifyAsync
⁄⁄= ^
(
⁄⁄^ _)
OpaqueSignInFinalizeRequest
€€ #
finalizeRequest
€€$ 3
,
€€3 4
uint
‹‹ 
	connectId
‹‹ 
,
‹‹ 
RpcRequestContext
›› 
requestContext
›› (
,
››( )
CancellationToken
ﬁﬁ 
cancellationToken
ﬁﬁ +
)
ﬁﬁ+ ,
{
ﬂﬂ "
TaskCompletionSource
‡‡ 
<
‡‡ *
OpaqueSignInFinalizeResponse
‡‡ 9
>
‡‡9 :&
responseCompletionSource
‡‡; S
=
‡‡T U
new
‡‡V Y
(
‡‡Y Z
)
‡‡Z [
;
‡‡[ \
Result
‚‚ 
<
‚‚ 
Unit
‚‚ 
,
‚‚ 
NetworkFailure
‚‚ #
>
‚‚# $
networkResult
‚‚% 2
=
‚‚3 4
await
‚‚5 :
networkProvider
‚‚; J
.
‚‚J K&
ExecuteUnaryRequestAsync
‚‚K c
(
‚‚c d
	connectId
„„ 
,
„„ 
RpcServiceType
‰‰ 
.
‰‰ #
SignInCompleteRequest
‰‰ 0
,
‰‰0 1%
SecureByteStringInterop
ÂÂ #
.
ÂÂ# $"
WithByteStringAsSpan
ÂÂ$ 8
(
ÂÂ8 9
finalizeRequest
ÂÂ9 H
.
ÂÂH I
ToByteString
ÂÂI U
(
ÂÂU V
)
ÂÂV W
,
ÂÂW X
span
ÂÂY ]
=>
ÂÂ^ `
span
ÂÂa e
.
ÂÂe f
ToArray
ÂÂf m
(
ÂÂm n
)
ÂÂn o
)
ÂÂo p
,
ÂÂp q%
finalizeResponsePayload
ÊÊ #
=>
ÊÊ$ &
{
ÁÁ *
OpaqueSignInFinalizeResponse
ËË ,
response
ËË- 5
=
ËË6 7
Helpers
ÈÈ 
.
ÈÈ 
ParseFromBytes
ÈÈ *
<
ÈÈ* +*
OpaqueSignInFinalizeResponse
ÈÈ+ G
>
ÈÈG H
(
ÈÈH I%
finalizeResponsePayload
ÈÈI `
)
ÈÈ` a
;
ÈÈa b&
responseCompletionSource
ÍÍ (
.
ÍÍ( )
TrySetResult
ÍÍ) 5
(
ÍÍ5 6
response
ÍÍ6 >
)
ÍÍ> ?
;
ÍÍ? @
return
ÏÏ 
Task
ÏÏ 
.
ÏÏ 

FromResult
ÏÏ &
(
ÏÏ& '
Result
ÏÏ' -
<
ÏÏ- .
Unit
ÏÏ. 2
,
ÏÏ2 3
NetworkFailure
ÏÏ4 B
>
ÏÏB C
.
ÏÏC D
Ok
ÏÏD F
(
ÏÏF G
Unit
ÏÏG K
.
ÏÏK L
Value
ÏÏL Q
)
ÏÏQ R
)
ÏÏR S
;
ÏÏS T
}
ÌÌ 
,
ÌÌ 
false
ÌÌ 
,
ÌÌ 
cancellationToken
ÌÌ '
,
ÌÌ' (
waitForRecovery
ÌÌ) 8
:
ÌÌ8 9
false
ÌÌ: ?
,
ÌÌ? @
requestContext
ÌÌA O
)
ÓÓ 	
.
ÓÓ	 

ConfigureAwait
ÓÓ
 
(
ÓÓ 
false
ÓÓ 
)
ÓÓ 
;
ÓÓ  
if
 

(
 
networkResult
 
.
 
IsErr
 
)
  
{
ÒÒ 	
return
ÚÚ 
Result
ÚÚ 
<
ÚÚ 
SignInResult
ÚÚ &
,
ÚÚ& '
NetworkFailure
ÚÚ( 6
>
ÚÚ6 7
.
ÚÚ7 8
Err
ÚÚ8 ;
(
ÚÚ; <
networkResult
ÚÚ< I
.
ÚÚI J
	UnwrapErr
ÚÚJ S
(
ÚÚS T
)
ÚÚT U
)
ÚÚU V
;
ÚÚV W
}
ÛÛ 	*
OpaqueSignInFinalizeResponse
ıı $
capturedResponse
ıı% 5
=
ıı6 7
await
ıı8 =&
responseCompletionSource
ıı> V
.
ııV W
Task
ııW [
.
ıı[ \
ConfigureAwait
ıı\ j
(
ııj k
false
ıık p
)
ııp q
;
ııq r
if
˜˜ 

(
˜˜ 
capturedResponse
˜˜ 
.
˜˜ 
Result
˜˜ #
==
˜˜$ &*
OpaqueSignInFinalizeResponse
˜˜' C
.
˜˜C D
Types
˜˜D I
.
˜˜I J
SignInResult
˜˜J V
.
˜˜V W 
InvalidCredentials
˜˜W i
)
˜˜i j
{
¯¯ 	
string
˘˘ 
message
˘˘ 
=
˘˘ 
capturedResponse
˘˘ -
.
˘˘- .

HasMessage
˘˘. 8
?
˙˙ 
capturedResponse
˙˙ "
.
˙˙" #
Message
˙˙# *
:
˚˚ !
localizationService
˚˚ %
[
˚˚% &%
AuthenticationConstants
˚˚& =
.
˚˚= >%
INVALID_CREDENTIALS_KEY
˚˚> U
]
˚˚U V
;
˚˚V W
return
¸¸ 
Result
¸¸ 
<
¸¸ 
SignInResult
¸¸ &
,
¸¸& '
NetworkFailure
¸¸( 6
>
¸¸6 7
.
¸¸7 8
Err
¸¸8 ;
(
¸¸; <
NetworkFailure
˝˝ 
.
˝˝  
InvalidRequestType
˝˝ 1
(
˝˝1 2
message
˝˝2 9
)
˝˝9 :
)
˝˝: ;
;
˝˝; <
}
˛˛ 	
SignInResult
ÄÄ 
result
ÄÄ 
=
ÄÄ 
new
ÄÄ !
(
ÄÄ! "
capturedResponse
ÄÄ" 2
.
ÄÄ2 3

Membership
ÄÄ3 =
,
ÄÄ= >
capturedResponse
ÄÄ? O
.
ÄÄO P
ActiveAccount
ÄÄP ]
)
ÄÄ] ^
;
ÄÄ^ _
return
ÅÅ 
Result
ÅÅ 
<
ÅÅ 
SignInResult
ÅÅ "
,
ÅÅ" #
NetworkFailure
ÅÅ$ 2
>
ÅÅ2 3
.
ÅÅ3 4
Ok
ÅÅ4 6
(
ÅÅ6 7
result
ÅÅ7 =
)
ÅÅ= >
;
ÅÅ> ?
}
ÇÇ 
private
ÑÑ 
Result
ÑÑ 
<
ÑÑ 
byte
ÑÑ 
[
ÑÑ 
]
ÑÑ 
,
ÑÑ #
AuthenticationFailure
ÑÑ 0
>
ÑÑ0 1&
ValidateAndCopySecureKey
ÑÑ2 J
(
ÑÑJ K
SensitiveBytes
ÑÑK Y
	secureKey
ÑÑZ c
)
ÑÑc d
{
ÖÖ 
byte
ÜÜ 
[
ÜÜ 
]
ÜÜ 
?
ÜÜ 
secureKeyCopy
ÜÜ 
=
ÜÜ 
null
ÜÜ  $
;
ÜÜ$ %
Result
àà 
<
àà 
Unit
àà 
,
àà 
SodiumFailure
àà "
>
àà" #

readResult
àà$ .
=
àà/ 0
	secureKey
àà1 :
.
àà: ;
WithReadAccess
àà; I
(
ààI J
span
ààJ N
=>
ààO Q
{
ââ 	
secureKeyCopy
ää 
=
ää 
span
ää  
.
ää  !
ToArray
ää! (
(
ää( )
)
ää) *
;
ää* +
return
ãã 
Result
ãã 
<
ãã 
Unit
ãã 
,
ãã 
SodiumFailure
ãã  -
>
ãã- .
.
ãã. /
Ok
ãã/ 1
(
ãã1 2
Unit
ãã2 6
.
ãã6 7
Value
ãã7 <
)
ãã< =
;
ãã= >
}
åå 	
)
åå	 

;
åå
 
if
éé 

(
éé 

readResult
éé 
.
éé 
IsErr
éé 
)
éé 
{
èè 	
return
êê 
Result
êê 
<
êê 
byte
êê 
[
êê 
]
êê  
,
êê  !#
AuthenticationFailure
êê" 7
>
êê7 8
.
êê8 9
Err
êê9 <
(
êê< =#
AuthenticationFailure
ëë %
.
ëë% &
UnexpectedError
ëë& 5
(
ëë5 6
$"
ëë6 8
$str
ëë8 S
{
ëëS T

readResult
ëëT ^
.
ëë^ _
	UnwrapErr
ëë_ h
(
ëëh i
)
ëëi j
.
ëëj k
Message
ëëk r
}
ëër s
"
ëës t
)
ëët u
)
ëëu v
;
ëëv w
}
íí 	
if
îî 

(
îî 
secureKeyCopy
îî 
!=
îî 
null
îî !
&&
îî" $
secureKeyCopy
îî% 2
.
îî2 3
Length
îî3 9
!=
îî: <
$num
îî= >
)
îî> ?
{
ïï 	
return
ññ 
Result
ññ 
<
ññ 
byte
ññ 
[
ññ 
]
ññ  
,
ññ  !#
AuthenticationFailure
ññ" 7
>
ññ7 8
.
ññ8 9
Ok
ññ9 ;
(
ññ; <
secureKeyCopy
ññ< I
)
ññI J
;
ññJ K
}
óó 	
string
ôô 
requiredError
ôô 
=
ôô !
localizationService
ôô 2
[
ôô2 3%
AuthenticationConstants
ôô3 J
.
ôôJ K%
SECURE_KEY_REQUIRED_KEY
ôôK b
]
ôôb c
;
ôôc d
return
öö 
Result
öö 
<
öö 
byte
öö 
[
öö 
]
öö 
,
öö #
AuthenticationFailure
öö 3
>
öö3 4
.
öö4 5
Err
öö5 8
(
öö8 9#
AuthenticationFailure
õõ !
.
õõ! "
SecureKeyRequired
õõ" 3
(
õõ3 4
requiredError
õõ4 A
)
õõA B
)
õõB C
;
õõC D
}
úú 
private
ûû 
Result
ûû 
<
ûû 
byte
ûû 
[
ûû 
]
ûû 
,
ûû #
AuthenticationFailure
ûû 0
>
ûû0 1&
PerformOpaqueKe3Exchange
ûû2 J
(
ûûJ K
OpaqueClient
üü 
opaqueClient
üü !
,
üü! "
byte
†† 
[
†† 
]
†† 
ke2Data
†† 
,
†† 
KeyExchangeResult
°° 
	ke1Result
°° #
)
°°# $
{
¢¢ 
Result
££ 
<
££ 
byte
££ 
[
££ 
]
££ 
,
££ 
OpaqueResult
££ #
>
££# $
ke3DataResult
££% 2
=
££3 4
opaqueClient
££5 A
.
££A B
GenerateKe3
££B M
(
££M N
ke2Data
££N U
,
££U V
	ke1Result
££W `
)
££` a
;
££a b
if
•• 

(
•• 
!
•• 
ke3DataResult
•• 
.
•• 
IsErr
••  
)
••  !
{
¶¶ 	
return
ßß 
Result
ßß 
<
ßß 
byte
ßß 
[
ßß 
]
ßß  
,
ßß  !#
AuthenticationFailure
ßß" 7
>
ßß7 8
.
ßß8 9
Ok
ßß9 ;
(
ßß; <
ke3DataResult
ßß< I
.
ßßI J
Unwrap
ßßJ P
(
ßßP Q
)
ßßQ R
)
ßßR S
;
ßßS T
}
®® 	
string
™™ 
errorMessage
™™ 
=
™™ #
GetOpaqueErrorMessage
™™ 3
(
™™3 4
ke3DataResult
™™4 A
.
™™A B
	UnwrapErr
™™B K
(
™™K L
)
™™L M
)
™™M N
;
™™N O
return
´´ 
Result
´´ 
<
´´ 
byte
´´ 
[
´´ 
]
´´ 
,
´´ #
AuthenticationFailure
´´ 3
>
´´3 4
.
´´4 5
Err
´´5 8
(
´´8 9#
AuthenticationFailure
¨¨ !
.
¨¨! " 
InvalidCredentials
¨¨" 4
(
¨¨4 5
errorMessage
¨¨5 A
)
¨¨A B
)
¨¨B C
;
¨¨C D
}
≠≠ 
private
ØØ 
static
ØØ 
Result
ØØ 
<
ØØ &
SodiumSecureMemoryHandle
ØØ 2
,
ØØ2 3#
AuthenticationFailure
ØØ4 I
>
ØØI J(
ExtractMasterKeyFromOpaque
ØØK e
(
ØØe f
OpaqueClient
∞∞ 
opaqueClient
∞∞ !
,
∞∞! "
KeyExchangeResult
±± 
	ke1Result
±± #
)
±±# $
{
≤≤ 
(
≥≥ 	
byte
≥≥	 
[
≥≥ 
]
≥≥ 
sessionKeyBytes
≥≥ 
,
≥≥  
byte
≥≥! %
[
≥≥% &
]
≥≥& '
masterKeyBytes
≥≥( 6
)
≥≥6 7
=
≥≥8 9
opaqueClient
≥≥: F
.
≥≥F G!
DeriveBaseMasterKey
≥≥G Z
(
≥≥Z [
	ke1Result
≥≥[ d
)
≥≥d e
;
≥≥e f
try
µµ 
{
∂∂ 	
Result
∑∑ 
<
∑∑ &
SodiumSecureMemoryHandle
∑∑ +
,
∑∑+ ,
SodiumFailure
∑∑- :
>
∑∑: ;#
masterKeyHandleResult
∑∑< Q
=
∑∑R S&
SodiumSecureMemoryHandle
∏∏ (
.
∏∏( )
Allocate
∏∏) 1
(
∏∏1 2
masterKeyBytes
∏∏2 @
.
∏∏@ A
Length
∏∏A G
)
∏∏G H
;
∏∏H I
if
ππ 
(
ππ #
masterKeyHandleResult
ππ %
.
ππ% &
IsErr
ππ& +
)
ππ+ ,
{
∫∫ 
return
ªª 
Result
ªª 
<
ªª &
SodiumSecureMemoryHandle
ªª 6
,
ªª6 7#
AuthenticationFailure
ªª8 M
>
ªªM N
.
ªªN O
Err
ªªO R
(
ªªR S#
AuthenticationFailure
ºº )
.
ºº) *-
SECURE_MEMORY_ALLOCATION_FAILED
ºº* I
(
ººI J#
masterKeyHandleResult
ººJ _
.
ºº_ `
	UnwrapErr
ºº` i
(
ººi j
)
ººj k
.
ººk l
Message
ººl s
)
ººs t
)
ººt u
;
ººu v
}
ΩΩ &
SodiumSecureMemoryHandle
øø $
masterKeyHandle
øø% 4
=
øø5 6#
masterKeyHandleResult
øø7 L
.
øøL M
Unwrap
øøM S
(
øøS T
)
øøT U
;
øøU V
Result
¿¿ 
<
¿¿ 
Unit
¿¿ 
,
¿¿ 
SodiumFailure
¿¿ &
>
¿¿& '
writeResult
¿¿( 3
=
¿¿4 5
masterKeyHandle
¿¿6 E
.
¿¿E F
Write
¿¿F K
(
¿¿K L
masterKeyBytes
¿¿L Z
)
¿¿Z [
;
¿¿[ \
if
¬¬ 
(
¬¬ 
!
¬¬ 
writeResult
¬¬ 
.
¬¬ 
IsErr
¬¬ "
)
¬¬" #
{
√√ 
return
ƒƒ 
Result
ƒƒ 
<
ƒƒ &
SodiumSecureMemoryHandle
ƒƒ 6
,
ƒƒ6 7#
AuthenticationFailure
ƒƒ8 M
>
ƒƒM N
.
ƒƒN O
Ok
ƒƒO Q
(
ƒƒQ R
masterKeyHandle
ƒƒR a
)
ƒƒa b
;
ƒƒb c
}
≈≈ 
masterKeyHandle
«« 
.
«« 
Dispose
«« #
(
««# $
)
««$ %
;
««% &
return
»» 
Result
»» 
<
»» &
SodiumSecureMemoryHandle
»» 2
,
»»2 3#
AuthenticationFailure
»»4 I
>
»»I J
.
»»J K
Err
»»K N
(
»»N O#
AuthenticationFailure
…… %
.
……% &(
SECURE_MEMORY_WRITE_FAILED
……& @
(
……@ A
writeResult
……A L
.
……L M
	UnwrapErr
……M V
(
……V W
)
……W X
.
……X Y
Message
……Y `
)
……` a
)
……a b
;
……b c
}
   	
finally
ÀÀ 
{
ÃÃ 	%
CryptographicOperations
ÕÕ #
.
ÕÕ# $

ZeroMemory
ÕÕ$ .
(
ÕÕ. /
sessionKeyBytes
ÕÕ/ >
)
ÕÕ> ?
;
ÕÕ? @%
CryptographicOperations
ŒŒ #
.
ŒŒ# $

ZeroMemory
ŒŒ$ .
(
ŒŒ. /
masterKeyBytes
ŒŒ/ =
)
ŒŒ= >
;
ŒŒ> ?
}
œœ 	
}
–– 
private
““ 
async
““ 
Task
““ 
<
““ 
Result
““ 
<
““ 
Unit
““ "
,
““" ##
AuthenticationFailure
““$ 9
>
““9 :
>
““: ;0
"RecreateAuthenticatedProtocolAsync
““< ^
(
““^ _&
SodiumSecureMemoryHandle
””  
masterKeyHandle
””! 0
,
””0 1

ByteString
‘‘ "
membershipIdentifier
‘‘ '
,
‘‘' (
uint
’’ 
	connectId
’’ 
,
’’ 
Guid
÷÷ 
membershipId
÷÷ 
)
÷÷ 
{
◊◊ 
Result
ÿÿ 
<
ÿÿ 
Unit
ÿÿ 
,
ÿÿ 
NetworkFailure
ÿÿ #
>
ÿÿ# $$
recreateProtocolResult
ÿÿ% ;
=
ÿÿ< =
await
ŸŸ 
networkProvider
ŸŸ !
.
ŸŸ! "0
"RecreateProtocolWithMasterKeyAsync
ŸŸ" D
(
ŸŸD E
masterKeyHandle
⁄⁄ 
,
⁄⁄  "
membershipIdentifier
⁄⁄! 5
,
⁄⁄5 6
	connectId
⁄⁄7 @
)
⁄⁄@ A
.
⁄⁄A B
ConfigureAwait
⁄⁄B P
(
⁄⁄P Q
false
⁄⁄Q V
)
⁄⁄V W
;
⁄⁄W X
if
‹‹ 

(
‹‹ $
recreateProtocolResult
‹‹ "
.
‹‹" #
IsErr
‹‹# (
)
‹‹( )
{
›› 	
NetworkFailure
ﬁﬁ 
networkFailure
ﬁﬁ )
=
ﬁﬁ* +$
recreateProtocolResult
ﬁﬁ, B
.
ﬁﬁB C
	UnwrapErr
ﬁﬁC L
(
ﬁﬁL M
)
ﬁﬁM N
;
ﬁﬁN O
if
‡‡ 
(
‡‡ 
networkFailure
‡‡ 
.
‡‡ 
FailureType
‡‡ *
==
‡‡+ - 
NetworkFailureType
‡‡. @
.
‡‡@ A+
CriticalAuthenticationFailure
‡‡A ^
)
‡‡^ _
{
·· 
Serilog
‚‚ 
.
‚‚ 
Log
‚‚ 
.
‚‚ 
Error
‚‚ !
(
‚‚! "
$str„„ ´
,„„´ ¨
membershipId
‰‰  
,
‰‰  !
networkFailure
‰‰" 0
.
‰‰0 1
Message
‰‰1 8
)
‰‰8 9
;
‰‰9 :
return
ÂÂ 
Result
ÂÂ 
<
ÂÂ 
Unit
ÂÂ "
,
ÂÂ" ##
AuthenticationFailure
ÂÂ$ 9
>
ÂÂ9 :
.
ÂÂ: ;
Err
ÂÂ; >
(
ÂÂ> ?#
AuthenticationFailure
ÊÊ )
.
ÊÊ) *)
CriticalAuthenticationError
ÊÊ* E
(
ÊÊE F
$"
ÁÁ 
$str
ÁÁ 1
{
ÁÁ1 2
networkFailure
ÁÁ2 @
.
ÁÁ@ A
Message
ÁÁA H
}
ÁÁH I
"
ÁÁI J
)
ÁÁJ K
)
ÁÁK L
;
ÁÁL M
}
ËË 
Serilog
ÍÍ 
.
ÍÍ 
Log
ÍÍ 
.
ÍÍ 
Error
ÍÍ 
(
ÍÍ 
$strÎÎ É
,ÎÎÉ Ñ
membershipId
ÏÏ 
,
ÏÏ 
networkFailure
ÏÏ ,
.
ÏÏ, -
Message
ÏÏ- 4
)
ÏÏ4 5
;
ÏÏ5 6
return
ÌÌ 
Result
ÌÌ 
<
ÌÌ 
Unit
ÌÌ 
,
ÌÌ #
AuthenticationFailure
ÌÌ  5
>
ÌÌ5 6
.
ÌÌ6 7
Err
ÌÌ7 :
(
ÌÌ: ;#
AuthenticationFailure
ÓÓ %
.
ÓÓ% &"
NetworkRequestFailed
ÓÓ& :
(
ÓÓ: ;
$"
ÔÔ 
$str
ÔÔ B
{
ÔÔB C
networkFailure
ÔÔC Q
.
ÔÔQ R
Message
ÔÔR Y
}
ÔÔY Z
"
ÔÔZ [
)
ÔÔ[ \
)
ÔÔ\ ]
;
ÔÔ] ^
}
 	
return
ÚÚ 
Result
ÚÚ 
<
ÚÚ 
Unit
ÚÚ 
,
ÚÚ #
AuthenticationFailure
ÚÚ 1
>
ÚÚ1 2
.
ÚÚ2 3
Ok
ÚÚ3 5
(
ÚÚ5 6
Unit
ÚÚ6 :
.
ÚÚ: ;
Value
ÚÚ; @
)
ÚÚ@ A
;
ÚÚA B
}
ÛÛ 
private
ıı 
Result
ıı 
<
ıı &
SodiumSecureMemoryHandle
ıı +
,
ıı+ ,#
AuthenticationFailure
ıı- B
>
ııB C*
DeriveMasterKeyForMembership
ııD `
(
ıı` a&
SodiumSecureMemoryHandle
ˆˆ  
masterKeyHandle
ˆˆ! 0
,
ˆˆ0 1

ByteString
˜˜ "
membershipIdentifier
˜˜ '
)
˜˜' (
{
¯¯ 
Guid
˘˘ 
membershipId
˘˘ 
=
˘˘ 
Helpers
˘˘ #
.
˘˘# $"
FromByteStringToGuid
˘˘$ 8
(
˘˘8 9"
membershipIdentifier
˘˘9 M
)
˘˘M N
;
˘˘N O
if
˚˚ 

(
˚˚ 
!
˚˚ *
ValidateMembershipIdentifier
˚˚ )
(
˚˚) *"
membershipIdentifier
˚˚* >
)
˚˚> ?
)
˚˚? @
{
¸¸ 	
Serilog
˝˝ 
.
˝˝ 
Log
˝˝ 
.
˝˝ 
Error
˝˝ 
(
˝˝ 
$str
˛˛ `
,
˛˛` a
membershipId
ˇˇ 
)
ˇˇ 
;
ˇˇ 
return
ÄÄ 
Result
ÄÄ 
<
ÄÄ &
SodiumSecureMemoryHandle
ÄÄ 2
,
ÄÄ2 3#
AuthenticationFailure
ÄÄ4 I
>
ÄÄI J
.
ÄÄJ K
Err
ÄÄK N
(
ÄÄN O#
AuthenticationFailure
ÅÅ %
.
ÅÅ% &)
InvalidMembershipIdentifier
ÅÅ& A
(
ÅÅA B!
localizationService
ÇÇ '
[
ÇÇ' (%
AuthenticationConstants
ÇÇ( ?
.
ÇÇ? @%
INVALID_CREDENTIALS_KEY
ÇÇ@ W
]
ÇÇW X
)
ÇÇX Y
)
ÇÇY Z
;
ÇÇZ [
}
ÉÉ 	
Result
ÖÖ 
<
ÖÖ 
byte
ÖÖ 
[
ÖÖ 
]
ÖÖ 
,
ÖÖ 
SodiumFailure
ÖÖ $
>
ÖÖ$ %"
masterKeyBytesResult
ÖÖ& :
=
ÖÖ; <
masterKeyHandle
ÜÜ 
.
ÜÜ 
	ReadBytes
ÜÜ %
(
ÜÜ% &
masterKeyHandle
ÜÜ& 5
.
ÜÜ5 6
Length
ÜÜ6 <
)
ÜÜ< =
;
ÜÜ= >
if
áá 

(
áá 
!
áá "
masterKeyBytesResult
áá !
.
áá! "
IsOk
áá" &
)
áá& '
{
àà 	
return
ââ 
Result
ââ 
<
ââ &
SodiumSecureMemoryHandle
ââ 2
,
ââ2 3#
AuthenticationFailure
ââ4 I
>
ââI J
.
ââJ K
Ok
ââK M
(
ââM N
masterKeyHandle
ââN ]
)
ââ] ^
;
ââ^ _
}
ää 	
byte
åå 
[
åå 
]
åå  
masterKeyBytesTemp
åå !
=
åå" #"
masterKeyBytesResult
åå$ 8
.
åå8 9
Unwrap
åå9 ?
(
åå? @
)
åå@ A
;
ååA B%
CryptographicOperations
çç 
.
çç  

ZeroMemory
çç  *
(
çç* + 
masterKeyBytesTemp
çç+ =
)
çç= >
;
çç> ?
return
èè 
Result
èè 
<
èè &
SodiumSecureMemoryHandle
èè .
,
èè. /#
AuthenticationFailure
èè0 E
>
èèE F
.
èèF G
Ok
èèG I
(
èèI J
masterKeyHandle
èèJ Y
)
èèY Z
;
èèZ [
}
êê 
private
íí 
async
íí 
Task
íí 
<
íí 
Result
íí 
<
íí 
Unit
íí "
,
íí" ##
AuthenticationFailure
íí$ 9
>
íí9 :
>
íí: ;-
StoreIdentityAndMembershipAsync
íí< [
(
íí[ \&
SodiumSecureMemoryHandle
ìì  
masterKeyHandle
ìì! 0
,
ìì0 1
SignInResult
îî 
signInResult
îî !
)
îî! "
{
ïï 

ByteString
ññ "
membershipIdentifier
ññ '
=
ññ( )
signInResult
ññ* 6
.
ññ6 7

Membership
ññ7 A
!
ññA B
.
ññB C
UniqueIdentifier
ññC S
;
ññS T
Guid
óó 
membershipId
óó 
=
óó 
Helpers
óó #
.
óó# $"
FromByteStringToGuid
óó$ 8
(
óó8 9"
membershipIdentifier
óó9 M
)
óóM N
;
óóN O
Result
ôô 
<
ôô 
Unit
ôô 
,
ôô #
AuthenticationFailure
ôô *
>
ôô* +
storeResult
ôô, 7
=
ôô8 9
await
ôô: ?
identityService
ôô@ O
.
öö  
StoreIdentityAsync
öö 
(
öö  
masterKeyHandle
öö  /
,
öö/ 0
membershipId
öö1 =
.
öö= >
ToString
öö> F
(
ööF G
)
ööG H
)
ööH I
.
ööI J
ConfigureAwait
ööJ X
(
ööX Y
false
ööY ^
)
öö^ _
;
öö_ `
if
úú 

(
úú 
storeResult
úú 
.
úú 
IsErr
úú 
)
úú 
{
ùù 	
Serilog
ûû 
.
ûû 
Log
ûû 
.
ûû 
Error
ûû 
(
ûû 
$str
üü ~
,
üü~ 
membershipId
†† 
,
†† 
storeResult
†† )
.
††) *
	UnwrapErr
††* 3
(
††3 4
)
††4 5
.
††5 6
Message
††6 =
)
††= >
;
††> ?
return
°° 
Result
°° 
<
°° 
Unit
°° 
,
°° #
AuthenticationFailure
°°  5
>
°°5 6
.
°°6 7
Err
°°7 :
(
°°: ;
storeResult
°°; F
.
°°F G
	UnwrapErr
°°G P
(
°°P Q
)
°°Q R
)
°°R S
;
°°S T
}
¢¢ 	
await
§§ .
 applicationSecureStorageProvider
§§ .
.
•• +
SetApplicationMembershipAsync
•• *
(
••* +
signInResult
••+ 7
.
••7 8

Membership
••8 B
)
••B C
.
¶¶ 
ConfigureAwait
¶¶ 
(
¶¶ 
false
¶¶ !
)
¶¶! "
;
¶¶" #

ByteString
®® 
?
®® 
accountIdToStore
®® $
=
®®% &
null
®®' +
;
®®+ ,
if
©© 

(
©© 
signInResult
©© 
.
©© 
ActiveAccount
©© &
!=
©©' )
null
©©* .
&&
©©/ 1
signInResult
©©2 >
.
©©> ?
ActiveAccount
©©? L
.
©©L M
UniqueIdentifier
©©M ]
!=
©©^ `
null
©©a e
)
©©e f
{
™™ 	
accountIdToStore
´´ 
=
´´ 
signInResult
´´ +
.
´´+ ,
ActiveAccount
´´, 9
.
´´9 :
UniqueIdentifier
´´: J
;
´´J K
}
¨¨ 	
else
≠≠ 
if
≠≠ 
(
≠≠ 
signInResult
≠≠ 
.
≠≠ 

Membership
≠≠ (
?
≠≠( )
.
≠≠) *%
AccountUniqueIdentifier
≠≠* A
!=
≠≠B D
null
≠≠E I
&&
≠≠J L
signInResult
ÆÆ 
.
ÆÆ 

Membership
ÆÆ (
.
ÆÆ( )%
AccountUniqueIdentifier
ÆÆ) @
.
ÆÆ@ A
Length
ÆÆA G
>
ÆÆH I
$num
ÆÆJ K
)
ÆÆK L
{
ØØ 	
accountIdToStore
∞∞ 
=
∞∞ 
signInResult
∞∞ +
.
∞∞+ ,

Membership
∞∞, 6
.
∞∞6 7%
AccountUniqueIdentifier
∞∞7 N
;
∞∞N O
}
±± 	
if
≥≥ 

(
≥≥ 
accountIdToStore
≥≥ 
==
≥≥ 
null
≥≥  $
)
≥≥$ %
{
¥¥ 	
return
µµ 
Result
µµ 
<
µµ 
Unit
µµ 
,
µµ #
AuthenticationFailure
µµ  5
>
µµ5 6
.
µµ6 7
Ok
µµ7 9
(
µµ9 :
Unit
µµ: >
.
µµ> ?
Value
µµ? D
)
µµD E
;
µµE F
}
∂∂ 	
await
∏∏ .
 applicationSecureStorageProvider
∏∏ .
.
ππ &
SetCurrentAccountIdAsync
ππ %
(
ππ% &
accountIdToStore
ππ& 6
)
ππ6 7
.
∫∫ 
ConfigureAwait
∫∫ 
(
∫∫ 
false
∫∫ !
)
∫∫! "
;
∫∫" #
return
ºº 
Result
ºº 
<
ºº 
Unit
ºº 
,
ºº #
AuthenticationFailure
ºº 1
>
ºº1 2
.
ºº2 3
Ok
ºº3 5
(
ºº5 6
Unit
ºº6 :
.
ºº: ;
Value
ºº; @
)
ºº@ A
;
ººA B
}
ΩΩ 
private
øø 
static
øø 
void
øø 
SecureCleanup
øø %
(
øø% &
params
øø& ,
byte
øø- 1
[
øø1 2
]
øø2 3
?
øø3 4
[
øø4 5
]
øø5 6
buffers
øø7 >
)
øø> ?
{
¿¿ 
foreach
¡¡ 
(
¡¡ 
byte
¡¡ 
[
¡¡ 
]
¡¡ 
?
¡¡ 
buffer
¡¡ 
in
¡¡  "
buffers
¡¡# *
)
¡¡* +
{
¬¬ 	
if
√√ 
(
√√ 
buffer
√√ 
is
√√ 
{
√√ 
Length
√√ "
:
√√" #
>
√√$ %
$num
√√& '
}
√√( )
)
√√) *
{
ƒƒ %
CryptographicOperations
≈≈ '
.
≈≈' (

ZeroMemory
≈≈( 2
(
≈≈2 3
buffer
≈≈3 9
)
≈≈9 :
;
≈≈: ;
}
∆∆ 
}
«« 	
}
»» 
private
   
static
   #
AuthenticationFailure
   (
MapNetworkFailure
  ) :
(
  : ;
NetworkFailure
  ; I
failure
  J Q
)
  Q R
{
ÀÀ 
string
ÃÃ 
message
ÃÃ 
=
ÃÃ 
failure
ÃÃ  
.
ÃÃ  !
	UserError
ÃÃ! *
?
ÃÃ* +
.
ÃÃ+ ,
Message
ÃÃ, 3
??
ÃÃ4 6
failure
ÃÃ7 >
.
ÃÃ> ?
Message
ÃÃ? F
;
ÃÃF G
return
ŒŒ 
failure
ŒŒ 
.
ŒŒ 
FailureType
ŒŒ "
switch
ŒŒ# )
{
œœ 	 
NetworkFailureType
–– 
.
–– +
CriticalAuthenticationFailure
–– <
=>
––= ?#
AuthenticationFailure
—— %
.
——% &)
CriticalAuthenticationError
——& A
(
——A B
message
——B I
)
——I J
,
——J K 
NetworkFailureType
““ 
.
““  
InvalidRequestType
““ 1
when
““2 6(
IsInvalidCredentialFailure
““7 Q
(
““Q R
failure
““R Y
)
““Y Z
=>
““[ ]#
AuthenticationFailure
”” %
.
””% & 
InvalidCredentials
””& 8
(
””8 9
message
””9 @
)
””@ A
,
””A B
_
‘‘ 
=>
‘‘ #
AuthenticationFailure
‘‘ &
.
‘‘& '"
NetworkRequestFailed
‘‘' ;
(
‘‘; <
message
‘‘< C
)
‘‘C D
}
’’ 	
;
’’	 

}
÷÷ 
}◊◊ ¨¿
Å/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/IdentityService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
;/ 0
internal 
sealed	 
class 
IdentityService %
:& '
IIdentityService( 8
{ 
private 
readonly '
ISecureProtocolStateStorage 0
_storage1 9
;9 :
private 
readonly %
IPlatformSecurityProvider .
_platformProvider/ @
;@ A
private 
readonly 
Lazy 
< 
bool 
> &
_hardwareSecurityAvailable  :
;: ;
public 

IdentityService 
( '
ISecureProtocolStateStorage 6
storage7 >
,> ?%
IPlatformSecurityProvider@ Y
platformProviderZ j
)j k
{ 
_storage 
= 
storage 
; 
_platformProvider 
= 
platformProvider ,
;, -&
_hardwareSecurityAvailable "
=# $
new% (
Lazy) -
<- .
bool. 2
>2 3
(3 4
(4 5
)5 6
=>7 9
_platformProvider: K
.K L'
IsHardwareSecurityAvailableL g
(g h
)h i
)i j
;j k
} 
public 

async 
Task 
< 
bool 
> "
HasStoredIdentityAsync 2
(2 3
string3 9
membershipId: F
)F G
{ 
IdentityContext 
context 
=  !
new" %
(% &
membershipId& 2
)2 3
;3 4
Result   
<   
byte   
[   
]   
,    
SecureStorageFailure   +
>  + ,
result  - 3
=  4 5
await!! 
_storage!! 
.!! 
LoadStateAsync!! )
(!!) *
context!!* 1
.!!1 2
STORAGE_KEY!!2 =
,!!= >
context!!? F
.!!F G
MembershipBytes!!G V
)!!V W
.!!W X
ConfigureAwait!!X f
(!!f g
false!!g l
)!!l m
;!!m n
bool"" 
exists"" 
="" 
result"" 
."" 
IsOk"" !
;""! "
return$$ 
exists$$ 
;$$ 
}%% 
public'' 

async'' 
Task'' 
<'' 
Result'' 
<'' 
Unit'' !
,''! "!
AuthenticationFailure''# 8
>''8 9
>''9 :
StoreIdentityAsync''; M
(''M N$
SodiumSecureMemoryHandle''N f
masterKeyHandle''g v
,''v w
string''x ~
membershipId	'' ã
)
''ã å
{(( 
IdentityContext)) 
context)) 
=))  !
new))" %
())% &
membershipId))& 2
)))2 3
;))3 4
try++ 
{,, 	
Result-- 
<-- 
byte-- 
[-- 
]-- 
,-- 
SodiumFailure-- (
>--( )

readResult--* 4
=--5 6
masterKeyHandle--7 F
.--F G
	ReadBytes--G P
(--P Q
masterKeyHandle--Q `
.--` a
Length--a g
)--g h
;--h i
if.. 
(.. 

readResult.. 
... 
IsErr..  
)..  !
{// 
return00 
Result00 
<00 
Unit00 "
,00" #!
AuthenticationFailure00$ 9
>009 :
.00: ;
Err00; >
(00> ?!
AuthenticationFailure11 )
.11) *!
IdentityStorageFailed11* ?
(11? @
$"11@ B
$str11B i
{11i j

readResult11j t
.11t u
	UnwrapErr11u ~
(11~ 
)	11 Ä
.
11Ä Å
Message
11Å à
}
11à â
"
11â ä
)
11ä ã
)
11ã å
;
11å ç
}22 
byte44 
[44 
]44 "
originalMasterKeyBytes44 )
=44* +

readResult44, 6
.446 7
Unwrap447 =
(44= >
)44> ?
;44? @
await66 &
StoreIdentityInternalAsync66 ,
(66, -
masterKeyHandle66- <
,66< =
context66> E
)66E F
.66F G
ConfigureAwait66G U
(66U V
false66V [
)66[ \
;66\ ]
Result88 
<88 $
SodiumSecureMemoryHandle88 +
,88+ ,!
AuthenticationFailure88- B
>88B C

loadResult88D N
=88O P
await88Q V
LoadMasterKeyAsync88W i
(88i j
context88j q
)88q r
.88r s
ConfigureAwait	88s Å
(
88Å Ç
false
88Ç á
)
88á à
;
88à â
if:: 
(:: 

loadResult:: 
.:: 
IsErr::  
)::  !
{;; 
Log<< 
.<< 
Error<< 
(<< 
$str	<< í
,
<<í ì
context== 
.== 
MembershipId== (
,==( )

loadResult==* 4
.==4 5
	UnwrapErr==5 >
(==> ?
)==? @
.==@ A
Message==A H
)==H I
;==I J
return>> 
Result>> 
<>> 
Unit>> "
,>>" #!
AuthenticationFailure>>$ 9
>>>9 :
.>>: ;
Err>>; >
(>>> ?!
AuthenticationFailure?? )
.??) *!
IdentityStorageFailed??* ?
(??? @
$"??@ B
$str??B z
{??z {

loadResult	??{ Ö
.
??Ö Ü
	UnwrapErr
??Ü è
(
??è ê
)
??ê ë
.
??ë í
Message
??í ô
}
??ô ö
"
??ö õ
)
??õ ú
)
??ú ù
;
??ù û
}@@ 
usingBB $
SodiumSecureMemoryHandleBB *
loadedKeyHandleBB+ :
=BB; <

loadResultBB= G
.BBG H
UnwrapBBH N
(BBN O
)BBO P
;BBP Q
ResultCC 
<CC 
byteCC 
[CC 
]CC 
,CC 
SodiumFailureCC (
>CC( )
loadedReadResultCC* :
=CC; <
loadedKeyHandleCC= L
.CCL M
	ReadBytesCCM V
(CCV W
loadedKeyHandleCCW f
.CCf g
LengthCCg m
)CCm n
;CCn o
ifEE 
(EE 
loadedReadResultEE  
.EE  !
IsErrEE! &
)EE& '
{FF 
LogGG 
.GG 
ErrorGG 
(GG 
$str	GG à
,
GGà â
contextHH 
.HH 
MembershipIdHH (
,HH( )
loadedReadResultHH* :
.HH: ;
	UnwrapErrHH; D
(HHD E
)HHE F
.HHF G
MessageHHG N
)HHN O
;HHO P
returnII 
ResultII 
<II 
UnitII "
,II" #!
AuthenticationFailureII$ 9
>II9 :
.II: ;
ErrII; >
(II> ?!
AuthenticationFailureJJ )
.JJ) *!
IdentityStorageFailedJJ* ?
(JJ? @
$"JJ@ B
$strJJB z
{JJz {
loadedReadResult	JJ{ ã
.
JJã å
	UnwrapErr
JJå ï
(
JJï ñ
)
JJñ ó
.
JJó ò
Message
JJò ü
}
JJü †
"
JJ† °
)
JJ° ¢
)
JJ¢ £
;
JJ£ §
}KK 
byteMM 
[MM 
]MM  
loadedMasterKeyBytesMM '
=MM( )
loadedReadResultMM* :
.MM: ;
UnwrapMM; A
(MMA B
)MMB C
;MMC D
ifOO 
(OO 
!OO #
CryptographicOperationsOO (
.OO( )
FixedTimeEqualsOO) 8
(OO8 9"
originalMasterKeyBytesOO9 O
,OOO P 
loadedMasterKeyBytesOOQ e
)OOe f
)OOf g
{PP 
LogQQ 
.QQ 
ErrorQQ 
(QQ 
$strQQ z
,QQz {
contextRR 
.RR 
MembershipIdRR (
)RR( )
;RR) *#
CryptographicOperationsTT '
.TT' (

ZeroMemoryTT( 2
(TT2 3 
loadedMasterKeyBytesTT3 G
)TTG H
;TTH I
returnUU 
ResultUU 
<UU 
UnitUU "
,UU" #!
AuthenticationFailureUU$ 9
>UU9 :
.UU: ;
ErrUU; >
(UU> ?!
AuthenticationFailureVV )
.VV) *!
IdentityStorageFailedVV* ?
(VV? @
$strVV@ `
)VV` a
)VVa b
;VVb c
}WW #
CryptographicOperationsYY #
.YY# $

ZeroMemoryYY$ .
(YY. / 
loadedMasterKeyBytesYY/ C
)YYC D
;YYD E
returnZZ 
ResultZZ 
<ZZ 
UnitZZ 
,ZZ !
AuthenticationFailureZZ  5
>ZZ5 6
.ZZ6 7
OkZZ7 9
(ZZ9 :
UnitZZ: >
.ZZ> ?
ValueZZ? D
)ZZD E
;ZZE F
}[[ 	
catch\\ 
(\\ 
	Exception\\ 
ex\\ 
)\\ 
{]] 	
Log^^ 
.^^ 
Error^^ 
(^^ 
ex^^ 
,^^ 
$str	^^ à
,
^^à â
context__ 
.__ 
MembershipId__ $
)__$ %
;__% &
return`` 
Result`` 
<`` 
Unit`` 
,`` !
AuthenticationFailure``  5
>``5 6
.``6 7
Err``7 :
(``: ;!
AuthenticationFailureaa %
.aa% &!
IdentityStorageFailedaa& ;
(aa; <
$"aa< >
$straa> a
{aaa b
exaab d
.aad e
Messageaae l
}aal m
"aam n
,aan o
exaap r
)aar s
)aas t
;aat u
}bb 	
}cc 
publicee 

asyncee 
Taskee 
<ee 
Resultee 
<ee $
SodiumSecureMemoryHandleee 5
,ee5 6!
AuthenticationFailureee7 L
>eeL M
>eeM N$
LoadMasterKeyHandleAsynceeO g
(eeg h
stringeeh n
membershipIdeeo {
)ee{ |
{ff 
returngg 
awaitgg 
LoadMasterKeyAsyncgg '
(gg' (
newgg( +
IdentityContextgg, ;
(gg; <
membershipIdgg< H
)ggH I
)ggI J
.ggJ K
ConfigureAwaitggK Y
(ggY Z
falseggZ _
)gg_ `
;gg` a
}hh 
publicjj 

asyncjj 
Taskjj 
<jj 
Resultjj 
<jj 
Unitjj !
,jj! "!
AuthenticationFailurejj# 8
>jj8 9
>jj9 :
ClearAllCacheAsyncjj; M
(jjM N
stringjjN T
membershipIdjjU a
)jja b
{kk 
IdentityContextll 
contextll 
=ll  !
newll" %
(ll% &
membershipIdll& 2
)ll2 3
;ll3 4
trynn 
{oo 	
Resultpp 
<pp 
Unitpp 
,pp  
SecureStorageFailurepp -
>pp- .
deleteStorageResultpp/ B
=ppC D
awaitqq 
_storageqq 
.qq 
DeleteStateAsyncqq /
(qq/ 0
contextqq0 7
.qq7 8
STORAGE_KEYqq8 C
)qqC D
.qqD E
ConfigureAwaitqqE S
(qqS T
falseqqT Y
)qqY Z
;qqZ [
ifss 
(ss 
deleteStorageResultss #
.ss# $
IsErrss$ )
)ss) *
{tt 
returnuu 
Resultuu 
<uu 
Unituu "
,uu" #!
AuthenticationFailureuu$ 9
>uu9 :
.uu: ;
Erruu; >
(uu> ?!
AuthenticationFailurevv )
.vv) *!
IdentityStorageFailedvv* ?
(vv? @
$"vv@ B
$strvvB l
{vvl m 
deleteStorageResult	vvm Ä
.
vvÄ Å
	UnwrapErr
vvÅ ä
(
vvä ã
)
vvã å
.
vvå ç
Message
vvç î
}
vvî ï
"
vvï ñ
)
vvñ ó
)
vvó ò
;
vvò ô
}ww 
ifyy 
(yy '
IsHardwareSecurityAvailableyy +
(yy+ ,
)yy, -
)yy- .
{zz 
await{{ 
_platformProvider{{ '
.{{' (&
DeleteKeyFromKeychainAsync{{( B
({{B C
context{{C J
.{{J K
KeychainKey{{K V
){{V W
.{{W X
ConfigureAwait{{X f
({{f g
false{{g l
){{l m
;{{m n
}|| 
return~~ 
Result~~ 
<~~ 
Unit~~ 
,~~ !
AuthenticationFailure~~  5
>~~5 6
.~~6 7
Ok~~7 9
(~~9 :
Unit~~: >
.~~> ?
Value~~? D
)~~D E
;~~E F
} 	
catch
ÄÄ 
(
ÄÄ 
	Exception
ÄÄ 
ex
ÄÄ 
)
ÄÄ 
{
ÅÅ 	
return
ÇÇ 
Result
ÇÇ 
<
ÇÇ 
Unit
ÇÇ 
,
ÇÇ #
AuthenticationFailure
ÇÇ  5
>
ÇÇ5 6
.
ÇÇ6 7
Err
ÇÇ7 :
(
ÇÇ: ;#
AuthenticationFailure
ÉÉ %
.
ÉÉ% &#
IdentityStorageFailed
ÉÉ& ;
(
ÉÉ; <
$"
ÉÉ< >
$str
ÉÉ> ^
{
ÉÉ^ _
ex
ÉÉ_ a
.
ÉÉa b
Message
ÉÉb i
}
ÉÉi j
"
ÉÉj k
,
ÉÉk l
ex
ÉÉm o
)
ÉÉo p
)
ÉÉp q
;
ÉÉq r
}
ÑÑ 	
}
ÖÖ 
private
áá 
async
áá 
Task
áá (
StoreIdentityInternalAsync
áá 1
(
áá1 2&
SodiumSecureMemoryHandle
áá2 J
masterKeyHandle
ááK Z
,
ááZ [
IdentityContext
áá\ k
context
áál s
)
áás t
{
àà 
byte
ââ 
[
ââ 
]
ââ 
?
ââ 
wrappingKey
ââ 
=
ââ 
null
ââ "
;
ââ" #
string
ää 

storageKey
ää 
=
ää 
context
ää #
.
ää# $
STORAGE_KEY
ää$ /
;
ää/ 0
bool
ãã 
hardwareAvailable
ãã 
=
ãã  )
IsHardwareSecurityAvailable
ãã! <
(
ãã< =
)
ãã= >
;
ãã> ?
try
çç 
{
éé 	
(
èè 
byte
èè 
[
èè 
]
èè 
protectedKey
èè  
,
èè  !
byte
èè" &
[
èè& '
]
èè' (
?
èè( )!
returnedWrappingKey
èè* =
)
èè= >
=
èè? @
await
èèA F 
WrapMasterKeyAsync
èèG Y
(
èèY Z
masterKeyHandle
èèZ i
)
èèi j
.
èèj k
ConfigureAwait
èèk y
(
èèy z
false
èèz 
)èè Ä
;èèÄ Å
wrappingKey
êê 
=
êê !
returnedWrappingKey
êê -
;
êê- .
Result
ëë 
<
ëë 
Unit
ëë 
,
ëë "
SecureStorageFailure
ëë -
>
ëë- .

saveResult
ëë/ 9
=
ëë: ;
await
íí 
_storage
íí 
.
íí 
SaveStateAsync
íí -
(
íí- .
protectedKey
íí. :
,
íí: ;

storageKey
íí< F
,
ííF G
context
ííH O
.
ííO P
MembershipBytes
ííP _
)
íí_ `
.
íí` a
ConfigureAwait
íía o
(
íío p
false
ííp u
)
ííu v
;
íív w
if
îî 
(
îî 

saveResult
îî 
.
îî 
IsErr
îî  
)
îî  !
{
ïï 
Log
ññ 
.
ññ 
Error
ññ 
(
ññ 
$strññ ®
,ññ® ©
context
óó 
.
óó 
MembershipId
óó (
,
óó( )

storageKey
óó* 4
,
óó4 5

saveResult
óó6 @
.
óó@ A
	UnwrapErr
óóA J
(
óóJ K
)
óóK L
.
óóL M
Message
óóM T
)
óóT U
;
óóU V
throw
òò 
new
òò '
InvalidOperationException
òò 3
(
òò3 4
$"
òò4 6
$str
òò6 \
{
òò\ ]

saveResult
òò] g
.
òòg h
	UnwrapErr
òòh q
(
òòq r
)
òòr s
.
òòs t
Message
òòt {
}
òò{ |
"
òò| }
)
òò} ~
;
òò~ 
}
ôô 
if
õõ 
(
õõ 
hardwareAvailable
õõ !
&&
õõ" $
wrappingKey
õõ% 0
!=
õõ1 3
null
õõ4 8
)
õõ8 9
{
úú 
string
ùù 
keychainKey
ùù "
=
ùù# $
context
ùù% ,
.
ùù, -
KeychainKey
ùù- 8
;
ùù8 9
await
ûû 
_platformProvider
ûû '
.
ûû' (%
StoreKeyInKeychainAsync
ûû( ?
(
ûû? @
keychainKey
ûû@ K
,
ûûK L
wrappingKey
ûûM X
)
ûûX Y
.
ûûY Z
ConfigureAwait
ûûZ h
(
ûûh i
false
ûûi n
)
ûûn o
;
ûûo p
}
üü 
}
†† 	
finally
°° 
{
¢¢ 	
if
££ 
(
££ 
wrappingKey
££ 
!=
££ 
null
££ #
)
££# $
{
§§ %
CryptographicOperations
•• '
.
••' (

ZeroMemory
••( 2
(
••2 3
wrappingKey
••3 >
)
••> ?
;
••? @
}
¶¶ 
}
ßß 	
}
®® 
private
™™ 
async
™™ 
Task
™™ 
<
™™ 
Result
™™ 
<
™™ &
SodiumSecureMemoryHandle
™™ 6
,
™™6 7#
AuthenticationFailure
™™8 M
>
™™M N
>
™™N O 
LoadMasterKeyAsync
™™P b
(
™™b c
IdentityContext
™™c r
context
™™s z
)
™™z {
{
´´ 
string
¨¨ 

storageKey
¨¨ 
=
¨¨ 
context
¨¨ #
.
¨¨# $
STORAGE_KEY
¨¨$ /
;
¨¨/ 0
try
ÆÆ 
{
ØØ 	
Result
∞∞ 
<
∞∞ 
byte
∞∞ 
[
∞∞ 
]
∞∞ 
,
∞∞ "
SecureStorageFailure
∞∞ /
>
∞∞/ 0
result
∞∞1 7
=
∞∞8 9
await
±± 
_storage
±± 
.
±± 
LoadStateAsync
±± -
(
±±- .

storageKey
±±. 8
,
±±8 9
context
±±: A
.
±±A B
MembershipBytes
±±B Q
)
±±Q R
.
±±R S
ConfigureAwait
±±S a
(
±±a b
false
±±b g
)
±±g h
;
±±h i
if
≥≥ 
(
≥≥ 
result
≥≥ 
.
≥≥ 
IsErr
≥≥ 
)
≥≥ 
{
¥¥ 
Log
µµ 
.
µµ 
Error
µµ 
(
µµ 
$strµµ ü
,µµü †
context
∂∂ 
.
∂∂ 
MembershipId
∂∂ (
,
∂∂( )

storageKey
∂∂* 4
,
∂∂4 5
result
∂∂6 <
.
∂∂< =
	UnwrapErr
∂∂= F
(
∂∂F G
)
∂∂G H
.
∂∂H I
Message
∂∂I P
)
∂∂P Q
;
∂∂Q R
return
∏∏ 
Result
∏∏ 
<
∏∏ &
SodiumSecureMemoryHandle
∏∏ 6
,
∏∏6 7#
AuthenticationFailure
∏∏8 M
>
∏∏M N
.
∏∏N O
Err
∏∏O R
(
∏∏R S#
AuthenticationFailure
ππ )
.
ππ) *#
IdentityStorageFailed
ππ* ?
(
ππ? @
$"
ππ@ B
$str
ππB `
{
ππ` a
result
ππa g
.
ππg h
	UnwrapErr
ππh q
(
ππq r
)
ππr s
.
ππs t
Message
ππt {
}
ππ{ |
"
ππ| }
)
ππ} ~
)
ππ~ 
;ππ Ä
}
∫∫ 
byte
ºº 
[
ºº 
]
ºº 
protectedKey
ºº 
=
ºº  !
result
ºº" (
.
ºº( )
Unwrap
ºº) /
(
ºº/ 0
)
ºº0 1
;
ºº1 2
Result
ΩΩ 
<
ΩΩ &
SodiumSecureMemoryHandle
ΩΩ +
,
ΩΩ+ ,#
AuthenticationFailure
ΩΩ- B
>
ΩΩB C
unwrapResult
ΩΩD P
=
ΩΩQ R
await
ΩΩS X"
UnwrapMasterKeyAsync
ΩΩY m
(
ΩΩm n
protectedKey
ΩΩn z
,
ΩΩz {
contextΩΩ| É
)ΩΩÉ Ñ
.ΩΩÑ Ö
ConfigureAwaitΩΩÖ ì
(ΩΩì î
falseΩΩî ô
)ΩΩô ö
;ΩΩö õ
return
øø 
unwrapResult
øø 
;
øø  
}
¿¿ 	
catch
¡¡ 
(
¡¡ 
	Exception
¡¡ 
ex
¡¡ 
)
¡¡ 
{
¬¬ 	
Log
√√ 
.
√√ 
Error
√√ 
(
√√ 
ex
√√ 
,
√√ 
$str√√ ì
,√√ì î
context
ƒƒ 
.
ƒƒ 
MembershipId
ƒƒ $
,
ƒƒ$ %

storageKey
ƒƒ& 0
)
ƒƒ0 1
;
ƒƒ1 2
return
∆∆ 
Result
∆∆ 
<
∆∆ &
SodiumSecureMemoryHandle
∆∆ 2
,
∆∆2 3#
AuthenticationFailure
∆∆4 I
>
∆∆I J
.
∆∆J K
Err
∆∆K N
(
∆∆N O#
AuthenticationFailure
«« %
.
««% &#
IdentityStorageFailed
««& ;
(
««; <
$"
««< >
$str
««> Y
{
««Y Z
ex
««Z \
.
««\ ]
Message
««] d
}
««d e
"
««e f
,
««f g
ex
««h j
)
««j k
)
««k l
;
««l m
}
»» 	
}
…… 
private
ÀÀ 
async
ÀÀ 
Task
ÀÀ 
<
ÀÀ 
(
ÀÀ 
byte
ÀÀ 
[
ÀÀ 
]
ÀÀ 
wrappedData
ÀÀ *
,
ÀÀ* +
byte
ÀÀ, 0
[
ÀÀ0 1
]
ÀÀ1 2
?
ÀÀ2 3
wrappingKey
ÀÀ4 ?
)
ÀÀ? @
>
ÀÀ@ A 
WrapMasterKeyAsync
ÀÀB T
(
ÀÀT U&
SodiumSecureMemoryHandle
ÀÀU m
masterKeyHandle
ÀÀn }
)
ÀÀ} ~
{
ÃÃ 
byte
ÕÕ 
[
ÕÕ 
]
ÕÕ 
?
ÕÕ 
masterKeyBytes
ÕÕ 
=
ÕÕ  
null
ÕÕ! %
;
ÕÕ% &
bool
ŒŒ '
hardwareSecurityAvailable
ŒŒ &
=
ŒŒ' ()
IsHardwareSecurityAvailable
ŒŒ) D
(
ŒŒD E
)
ŒŒE F
;
ŒŒF G
try
–– 
{
—— 	
Result
““ 
<
““ 
byte
““ 
[
““ 
]
““ 
,
““ 
SodiumFailure
““ (
>
““( )

readResult
““* 4
=
““5 6
masterKeyHandle
”” 
.
””  
	ReadBytes
””  )
(
””) *
masterKeyHandle
””* 9
.
””9 :
Length
””: @
)
””@ A
;
””A B
if
‘‘ 
(
‘‘ 

readResult
‘‘ 
.
‘‘ 
IsErr
‘‘  
)
‘‘  !
{
’’ 
throw
÷÷ 
new
÷÷ '
InvalidOperationException
÷÷ 3
(
÷÷3 4
$"
÷÷4 6
$str
÷÷6 Q
{
÷÷Q R

readResult
÷÷R \
.
÷÷\ ]
	UnwrapErr
÷÷] f
(
÷÷f g
)
÷÷g h
.
÷÷h i
Message
÷÷i p
}
÷÷p q
"
÷÷q r
)
÷÷r s
;
÷÷s t
}
◊◊ 
masterKeyBytes
ŸŸ 
=
ŸŸ 

readResult
ŸŸ '
.
ŸŸ' (
Unwrap
ŸŸ( .
(
ŸŸ. /
)
ŸŸ/ 0
;
ŸŸ0 1
if
€€ 
(
€€ 
!
€€ '
hardwareSecurityAvailable
€€ *
)
€€* +
{
‹‹ 
return
›› 
(
›› 
masterKeyBytes
›› &
.
››& '
AsSpan
››' -
(
››- .
)
››. /
.
››/ 0
ToArray
››0 7
(
››7 8
)
››8 9
,
››9 :
null
››; ?
)
››? @
;
››@ A
}
ﬁﬁ 
byte
‡‡ 
[
‡‡ 
]
‡‡ 
?
‡‡ 
encryptedKey
‡‡  
=
‡‡! "
null
‡‡# '
;
‡‡' (
try
·· 
{
‚‚ 
byte
„„ 
[
„„ 
]
„„ 
wrappingKey
„„ "
=
„„# $
await
„„% *&
GenerateWrappingKeyAsync
„„+ C
(
„„C D
)
„„D E
.
„„E F
ConfigureAwait
„„F T
(
„„T U
false
„„U Z
)
„„Z [
;
„„[ \
using
ÂÂ 
Aes
ÂÂ 
aes
ÂÂ 
=
ÂÂ 
Aes
ÂÂ  #
.
ÂÂ# $
Create
ÂÂ$ *
(
ÂÂ* +
)
ÂÂ+ ,
;
ÂÂ, -
aes
ÊÊ 
.
ÊÊ 
Key
ÊÊ 
=
ÊÊ 
wrappingKey
ÊÊ %
;
ÊÊ% &
aes
ÁÁ 
.
ÁÁ 

GenerateIV
ÁÁ 
(
ÁÁ 
)
ÁÁ  
;
ÁÁ  !
encryptedKey
ÈÈ 
=
ÈÈ 
aes
ÈÈ "
.
ÈÈ" #

EncryptCbc
ÈÈ# -
(
ÈÈ- .
masterKeyBytes
ÈÈ. <
,
ÈÈ< =
aes
ÈÈ> A
.
ÈÈA B
IV
ÈÈB D
)
ÈÈD E
;
ÈÈE F
byte
ÎÎ 
[
ÎÎ 
]
ÎÎ 
wrappedData
ÎÎ "
=
ÎÎ# $
new
ÎÎ% (
byte
ÎÎ) -
[
ÎÎ- .
aes
ÎÎ. 1
.
ÎÎ1 2
IV
ÎÎ2 4
.
ÎÎ4 5
Length
ÎÎ5 ;
+
ÎÎ< =
encryptedKey
ÎÎ> J
.
ÎÎJ K
Length
ÎÎK Q
]
ÎÎQ R
;
ÎÎR S
aes
ÏÏ 
.
ÏÏ 
IV
ÏÏ 
.
ÏÏ 
CopyTo
ÏÏ 
(
ÏÏ 
wrappedData
ÏÏ )
,
ÏÏ) *
$num
ÏÏ+ ,
)
ÏÏ, -
;
ÏÏ- .
encryptedKey
ÌÌ 
.
ÌÌ 
CopyTo
ÌÌ #
(
ÌÌ# $
wrappedData
ÌÌ$ /
,
ÌÌ/ 0
aes
ÌÌ1 4
.
ÌÌ4 5
IV
ÌÌ5 7
.
ÌÌ7 8
Length
ÌÌ8 >
)
ÌÌ> ?
;
ÌÌ? @
return
ÔÔ 
(
ÔÔ 
wrappedData
ÔÔ #
,
ÔÔ# $
wrappingKey
ÔÔ% 0
)
ÔÔ0 1
;
ÔÔ1 2
}
 
finally
ÒÒ 
{
ÚÚ 
if
ÛÛ 
(
ÛÛ 
encryptedKey
ÛÛ  
!=
ÛÛ! #
null
ÛÛ$ (
)
ÛÛ( )
{
ÙÙ %
CryptographicOperations
ıı +
.
ıı+ ,

ZeroMemory
ıı, 6
(
ıı6 7
encryptedKey
ıı7 C
)
ııC D
;
ııD E
}
ˆˆ 
}
˜˜ 
}
¯¯ 	
catch
˘˘ 
(
˘˘ 
	Exception
˘˘ 
ex
˘˘ 
)
˘˘ 
{
˙˙ 	
if
˚˚ 
(
˚˚ 
masterKeyBytes
˚˚ 
==
˚˚ !
null
˚˚" &
)
˚˚& '
{
¸¸ 
throw
˝˝ 
;
˝˝ 
}
˛˛ 
Log
ÄÄ 
.
ÄÄ 
Warning
ÄÄ 
(
ÄÄ 
ex
ÄÄ 
,
ÄÄ 
$strÄÄ à
)ÄÄà â
;ÄÄâ ä
return
ÅÅ 
(
ÅÅ 
masterKeyBytes
ÅÅ "
.
ÅÅ" #
AsSpan
ÅÅ# )
(
ÅÅ) *
)
ÅÅ* +
.
ÅÅ+ ,
ToArray
ÅÅ, 3
(
ÅÅ3 4
)
ÅÅ4 5
,
ÅÅ5 6
null
ÅÅ7 ;
)
ÅÅ; <
;
ÅÅ< =
}
ÇÇ 	
finally
ÉÉ 
{
ÑÑ 	
if
ÖÖ 
(
ÖÖ 
masterKeyBytes
ÖÖ 
!=
ÖÖ !
null
ÖÖ" &
)
ÖÖ& '
{
ÜÜ %
CryptographicOperations
áá '
.
áá' (

ZeroMemory
áá( 2
(
áá2 3
masterKeyBytes
áá3 A
)
ááA B
;
ááB C
}
àà 
}
ââ 	
}
ää 
private
åå 
async
åå 
Task
åå 
<
åå 
Result
åå 
<
åå &
SodiumSecureMemoryHandle
åå 6
,
åå6 7#
AuthenticationFailure
åå8 M
>
ååM N
>
ååN O"
UnwrapMasterKeyAsync
ååP d
(
ååd e
byte
ååe i
[
ååi j
]
ååj k
protectedKey
åål x
,
ååx y
IdentityContextååz â
contextååä ë
)ååë í
{
çç 
byte
éé 
[
éé 
]
éé 
?
éé 
masterKeyBytes
éé 
=
éé  
null
éé! %
;
éé% &
byte
èè 
[
èè 
]
èè 
?
èè 
wrappingKey
èè 
=
èè 
null
èè "
;
èè" #
byte
êê 
[
êê 
]
êê 
?
êê 
encryptedKey
êê 
=
êê 
null
êê #
;
êê# $
byte
ëë 
[
ëë 
]
ëë 
?
ëë 
iv
ëë 
=
ëë 
null
ëë 
;
ëë 
bool
íí '
hardwareSecurityAvailable
íí &
=
íí' ()
IsHardwareSecurityAvailable
íí) D
(
ííD E
)
ííE F
;
ííF G
try
îî 
{
ïï 	
if
ññ 
(
ññ 
!
ññ '
hardwareSecurityAvailable
ññ *
)
ññ* +
{
óó 
masterKeyBytes
òò 
=
òò  
protectedKey
òò! -
.
òò- .
AsSpan
òò. 4
(
òò4 5
)
òò5 6
.
òò6 7
ToArray
òò7 >
(
òò> ?
)
òò? @
;
òò@ A
}
ôô 
else
öö 
{
õõ 
string
úú 
keychainKey
úú "
=
úú# $
context
úú% ,
.
úú, -
KeychainKey
úú- 8
;
úú8 9
wrappingKey
ùù 
=
ùù 
await
ùù #
_platformProvider
ùù$ 5
.
ùù5 6%
GetKeyFromKeychainAsync
ùù6 M
(
ùùM N
keychainKey
ùùN Y
)
ùùY Z
.
ùùZ [
ConfigureAwait
ùù[ i
(
ùùi j
false
ùùj o
)
ùùo p
;
ùùp q
if
üü 
(
üü 
wrappingKey
üü 
==
üü  "
null
üü# '
)
üü' (
{
†† 
Log
°° 
.
°° 
Warning
°° 
(
°°  
$str°°  û
,°°û ü
keychainKey
¢¢ #
)
¢¢# $
;
¢¢$ %
masterKeyBytes
££ "
=
££# $
protectedKey
££% 1
.
££1 2
AsSpan
££2 8
(
££8 9
)
££9 :
.
££: ;
ToArray
££; B
(
££B C
)
££C D
;
££D E
}
§§ 
else
•• 
{
¶¶ 
using
ßß 
Aes
ßß 
aes
ßß !
=
ßß" #
Aes
ßß$ '
.
ßß' (
Create
ßß( .
(
ßß. /
)
ßß/ 0
;
ßß0 1
aes
®® 
.
®® 
Key
®® 
=
®® 
wrappingKey
®® )
;
®®) *
ReadOnlySpan
™™  
<
™™  !
byte
™™! %
>
™™% &
protectedSpan
™™' 4
=
™™5 6
protectedKey
™™7 C
.
™™C D
AsSpan
™™D J
(
™™J K
)
™™K L
;
™™L M
iv
´´ 
=
´´ 
protectedSpan
´´ &
[
´´& '
..
´´' )$
SecureStorageConstants
´´) ?
.
´´? @
Identity
´´@ H
.
´´H I
AES_IV_SIZE
´´I T
]
´´T U
.
´´U V
ToArray
´´V ]
(
´´] ^
)
´´^ _
;
´´_ `
encryptedKey
¨¨  
=
¨¨! "
protectedSpan
¨¨# 0
[
¨¨0 1$
SecureStorageConstants
¨¨1 G
.
¨¨G H
Identity
¨¨H P
.
¨¨P Q
AES_IV_SIZE
¨¨Q \
..
¨¨\ ^
]
¨¨^ _
.
¨¨_ `
ToArray
¨¨` g
(
¨¨g h
)
¨¨h i
;
¨¨i j
aes
ÆÆ 
.
ÆÆ 
IV
ÆÆ 
=
ÆÆ 
iv
ÆÆ 
;
ÆÆ  
masterKeyBytes
ØØ "
=
ØØ# $
aes
ØØ% (
.
ØØ( )

DecryptCbc
ØØ) 3
(
ØØ3 4
encryptedKey
ØØ4 @
,
ØØ@ A
iv
ØØB D
)
ØØD E
;
ØØE F
}
∞∞ 
}
±± 
Result
≥≥ 
<
≥≥ &
SodiumSecureMemoryHandle
≥≥ +
,
≥≥+ ,
SodiumFailure
≥≥- :
>
≥≥: ;
allocResult
≥≥< G
=
≥≥H I&
SodiumSecureMemoryHandle
¥¥ (
.
¥¥( )
Allocate
¥¥) 1
(
¥¥1 2
masterKeyBytes
¥¥2 @
.
¥¥@ A
Length
¥¥A G
)
¥¥G H
;
¥¥H I
if
µµ 
(
µµ 
allocResult
µµ 
.
µµ 
IsErr
µµ !
)
µµ! "
{
∂∂ 
return
∑∑ 
Result
∑∑ 
<
∑∑ &
SodiumSecureMemoryHandle
∑∑ 6
,
∑∑6 7#
AuthenticationFailure
∑∑8 M
>
∑∑M N
.
∑∑N O
Err
∑∑O R
(
∑∑R S#
AuthenticationFailure
∏∏ )
.
∏∏) *-
SECURE_MEMORY_ALLOCATION_FAILED
∏∏* I
(
∏∏I J
$"
∏∏J L
$str
∏∏L n
{
∏∏n o
allocResult
∏∏o z
.
∏∏z {
	UnwrapErr∏∏{ Ñ
(∏∏Ñ Ö
)∏∏Ö Ü
.∏∏Ü á
Message∏∏á é
}∏∏é è
"∏∏è ê
)∏∏ê ë
)∏∏ë í
;∏∏í ì
}
ππ &
SodiumSecureMemoryHandle
ªª $
handle
ªª% +
=
ªª, -
allocResult
ªª. 9
.
ªª9 :
Unwrap
ªª: @
(
ªª@ A
)
ªªA B
;
ªªB C
Result
ºº 
<
ºº 
Unit
ºº 
,
ºº 
SodiumFailure
ºº &
>
ºº& '
writeResult
ºº( 3
=
ºº4 5
handle
ºº6 <
.
ºº< =
Write
ºº= B
(
ººB C
masterKeyBytes
ººC Q
)
ººQ R
;
ººR S
if
ΩΩ 
(
ΩΩ 
writeResult
ΩΩ 
.
ΩΩ 
IsErr
ΩΩ !
)
ΩΩ! "
{
ææ 
handle
øø 
.
øø 
Dispose
øø 
(
øø 
)
øø  
;
øø  !
return
¿¿ 
Result
¿¿ 
<
¿¿ &
SodiumSecureMemoryHandle
¿¿ 6
,
¿¿6 7#
AuthenticationFailure
¿¿8 M
>
¿¿M N
.
¿¿N O
Err
¿¿O R
(
¿¿R S#
AuthenticationFailure
¡¡ )
.
¡¡) *(
SECURE_MEMORY_WRITE_FAILED
¡¡* D
(
¡¡D E
$"
¡¡E G
$str
¡¡G i
{
¡¡i j
writeResult
¡¡j u
.
¡¡u v
	UnwrapErr
¡¡v 
(¡¡ Ä
)¡¡Ä Å
.¡¡Å Ç
Message¡¡Ç â
}¡¡â ä
"¡¡ä ã
)¡¡ã å
)¡¡å ç
;¡¡ç é
}
¬¬ 
return
ƒƒ 
Result
ƒƒ 
<
ƒƒ &
SodiumSecureMemoryHandle
ƒƒ 2
,
ƒƒ2 3#
AuthenticationFailure
ƒƒ4 I
>
ƒƒI J
.
ƒƒJ K
Ok
ƒƒK M
(
ƒƒM N
handle
ƒƒN T
)
ƒƒT U
;
ƒƒU V
}
≈≈ 	
catch
∆∆ 
(
∆∆ 
	Exception
∆∆ 
ex
∆∆ 
)
∆∆ 
{
«« 	
return
»» 
Result
»» 
<
»» &
SodiumSecureMemoryHandle
»» 2
,
»»2 3#
AuthenticationFailure
»»4 I
>
»»I J
.
»»J K
Err
»»K N
(
»»N O#
AuthenticationFailure
…… %
.
……% &#
IdentityStorageFailed
……& ;
(
……; <
$"
……< >
$str
……> [
{
……[ \
ex
……\ ^
.
……^ _
Message
……_ f
}
……f g
"
……g h
,
……h i
ex
……j l
)
……l m
)
……m n
;
……n o
}
   	
finally
ÀÀ 
{
ÃÃ 	
if
ÕÕ 
(
ÕÕ 
masterKeyBytes
ÕÕ 
!=
ÕÕ !
null
ÕÕ" &
)
ÕÕ& '
{
ŒŒ %
CryptographicOperations
œœ '
.
œœ' (

ZeroMemory
œœ( 2
(
œœ2 3
masterKeyBytes
œœ3 A
)
œœA B
;
œœB C
}
–– 
if
““ 
(
““ 
wrappingKey
““ 
!=
““ 
null
““ #
)
““# $
{
”” %
CryptographicOperations
‘‘ '
.
‘‘' (

ZeroMemory
‘‘( 2
(
‘‘2 3
wrappingKey
‘‘3 >
)
‘‘> ?
;
‘‘? @
}
’’ 
if
◊◊ 
(
◊◊ 
encryptedKey
◊◊ 
!=
◊◊ 
null
◊◊  $
)
◊◊$ %
{
ÿÿ %
CryptographicOperations
ŸŸ '
.
ŸŸ' (

ZeroMemory
ŸŸ( 2
(
ŸŸ2 3
encryptedKey
ŸŸ3 ?
)
ŸŸ? @
;
ŸŸ@ A
}
⁄⁄ 
if
‹‹ 
(
‹‹ 
iv
‹‹ 
!=
‹‹ 
null
‹‹ 
)
‹‹ 
{
›› %
CryptographicOperations
ﬁﬁ '
.
ﬁﬁ' (

ZeroMemory
ﬁﬁ( 2
(
ﬁﬁ2 3
iv
ﬁﬁ3 5
)
ﬁﬁ5 6
;
ﬁﬁ6 7
}
ﬂﬂ 
}
‡‡ 	
}
·· 
private
„„ 
async
„„ 
Task
„„ 
<
„„ 
byte
„„ 
[
„„ 
]
„„ 
>
„„ &
GenerateWrappingKeyAsync
„„ 7
(
„„7 8
)
„„8 9
{
‰‰ 
return
ÂÂ 
await
ÂÂ 
_platformProvider
ÂÂ &
.
ÂÂ& ''
GenerateSecureRandomAsync
ÂÂ' @
(
ÂÂ@ A$
SecureStorageConstants
ÂÂA W
.
ÂÂW X
Identity
ÂÂX `
.
ÂÂ` a
AES_KEY_SIZE
ÂÂa m
)
ÂÂm n
.
ÂÂn o
ConfigureAwait
ÂÂo }
(
ÂÂ} ~
falseÂÂ~ É
)ÂÂÉ Ñ
;ÂÂÑ Ö
}
ÊÊ 
private
ËË 
bool
ËË )
IsHardwareSecurityAvailable
ËË ,
(
ËË, -
)
ËË- .
=>
ËË/ 1(
_hardwareSecurityAvailable
ËË2 L
.
ËËL M
Value
ËËM R
;
ËËR S
private
ÍÍ 
sealed
ÍÍ 
class
ÍÍ 
IdentityContext
ÍÍ (
(
ÍÍ( )
string
ÍÍ) /
membershipId
ÍÍ0 <
)
ÍÍ< =
{
ÎÎ 
private
ÏÏ 
byte
ÏÏ 
[
ÏÏ 
]
ÏÏ 
?
ÏÏ 
_membershipBytes
ÏÏ (
;
ÏÏ( )
public
ÓÓ 
string
ÓÓ 
MembershipId
ÓÓ "
{
ÓÓ# $
get
ÓÓ% (
;
ÓÓ( )
}
ÓÓ* +
=
ÓÓ, -
membershipId
ÓÓ. :
;
ÓÓ: ;
public
ÔÔ 
string
ÔÔ 
STORAGE_KEY
ÔÔ !
{
ÔÔ" #
get
ÔÔ$ '
;
ÔÔ' (
}
ÔÔ) *
=
ÔÔ+ ,$
GetMasterKeyStorageKey
ÔÔ- C
(
ÔÔC D
membershipId
ÔÔD P
)
ÔÔP Q
;
ÔÔQ R
public
 
string
 
KeychainKey
 !
{
" #
get
$ '
;
' (
}
) *
=
+ , 
GetKeychainWrapKey
- ?
(
? @
membershipId
@ L
)
L M
;
M N
public
ÚÚ 
byte
ÚÚ 
[
ÚÚ 
]
ÚÚ 
MembershipBytes
ÚÚ %
=>
ÚÚ& (
_membershipBytes
ÚÚ) 9
??=
ÚÚ: =
Guid
ÚÚ> B
.
ÚÚB C
Parse
ÚÚC H
(
ÚÚH I
MembershipId
ÚÚI U
)
ÚÚU V
.
ÚÚV W
ToByteArray
ÚÚW b
(
ÚÚb c
)
ÚÚc d
;
ÚÚd e
private
ÙÙ 
static
ÙÙ 
string
ÙÙ $
GetMasterKeyStorageKey
ÙÙ 4
(
ÙÙ4 5
string
ÙÙ5 ;
membershipId
ÙÙ< H
)
ÙÙH I
=>
ÙÙJ L
string
ıı 
.
ıı 
Concat
ıı 
(
ıı $
SecureStorageConstants
ıı 0
.
ıı0 1
Identity
ıı1 9
.
ıı9 :'
MASTER_KEY_STORAGE_PREFIX
ıı: S
,
ııS T
membershipId
ııU a
)
ııa b
;
ııb c
private
˜˜ 
static
˜˜ 
string
˜˜  
GetKeychainWrapKey
˜˜ 0
(
˜˜0 1
string
˜˜1 7
membershipId
˜˜8 D
)
˜˜D E
=>
˜˜F H
string
¯¯ 
.
¯¯ 
Concat
¯¯ 
(
¯¯ $
SecureStorageConstants
¯¯ 0
.
¯¯0 1
Identity
¯¯1 9
.
¯¯9 :&
KEYCHAIN_WRAP_KEY_PREFIX
¯¯: R
,
¯¯R S
membershipId
¯¯T `
)
¯¯` a
;
¯¯a b
}
˘˘ 
}˙˙ ﬁL
ì/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/Constants/AuthenticationConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
./ 0
	Constants0 9
;9 :
public 
static 
class #
AuthenticationConstants +
{ 
public 

const 
string &
MOBILE_NUMBER_REQUIRED_KEY 2
=3 4
$str5 ]
;] ^
public 

const 
string 1
%MOBILE_NUMBER_IDENTIFIER_REQUIRED_KEY =
=> ?
$str@ r
;r s
public		 

const		 
string		 *
DEVICE_IDENTIFIER_REQUIRED_KEY		 6
=		7 8
$str		9 e
;		e f
public

 

const

 
string

 +
SESSION_IDENTIFIER_REQUIRED_KEY

 7
=

8 9
$str

: g
;

g h
public 

const 
string .
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY :
=; <
$str= m
;m n
public 

const 
string #
SECURE_KEY_REQUIRED_KEY /
=0 1
$str2 W
;W X
public 

const 
string #
INVALID_CREDENTIALS_KEY /
=0 1
$str2 a
;a b
public 

const 
string 0
$VERIFY_SECURE_KEY_DOES_NOT_MATCH_KEY <
== >
$str? n
;n o
public 

const 
string '
COMMON_UNEXPECTED_ERROR_KEY 3
=4 5
$str6 N
;N O
public 

const 
string +
SECURE_KEY_STRENGTH_INVALID_KEY 7
=8 9
$str: f
;f g
public 

const 
string -
!SECURE_KEY_STRENGTH_VERY_WEAK_KEY 9
=: ;
$str< i
;i j
public 

const 
string (
SECURE_KEY_STRENGTH_WEAK_KEY 4
=5 6
$str7 `
;` a
public 

const 
string (
SECURE_KEY_STRENGTH_GOOD_KEY 4
=5 6
$str7 `
;` a
public 

const 
string *
SECURE_KEY_STRENGTH_STRONG_KEY 6
=7 8
$str9 d
;d e
public 

const 
string /
#SECURE_KEY_STRENGTH_VERY_STRONG_KEY ;
=< =
$str> m
;m n
public 

const 
string "
NETWORK_FAILURE_PREFIX .
=/ 0
$str1 M
;M N
public 

const 
string '
VERIFICATION_FAILURE_PREFIX 3
=4 5
$str6 M
;M N
public 

const 
string '
REGISTRATION_FAILURE_PREFIX 3
=4 5
$str6 M
;M N
public 

const 
string  
INVALID_OTP_CODE_KEY ,
=- .
$str/ R
;R S
public 

const 
string #
REGISTRATION_FAILED_KEY /
=0 1
$str2 M
;M N
public 

const 
string '
NO_VERIFICATION_SESSION_KEY 3
=4 5
$str6 T
;T U
public 

const 
string ,
 VERIFICATION_SESSION_EXPIRED_KEY 8
=9 :
$str; _
;_ `
public   

const   
string   .
"NO_ACTIVE_VERIFICATION_SESSION_KEY   :
=  ; <
$str  = a
;  a b
public!! 

const!! 
string!! $
MAX_ATTEMPTS_REACHED_KEY!! 0
=!!1 2
$str!!3 Z
;!!Z [
public"" 

const"" 
string"" !
SESSION_NOT_FOUND_KEY"" -
="". /
$str""0 T
;""T U
public## 

const## 
string## &
REDIRECTING_IN_SECONDS_KEY## 2
=##3 4
$str##5 ]
;##] ^
public$$ 

const$$ 
string$$ "
NAVIGATION_FAILURE_KEY$$ .
=$$/ 0
$str$$1 Y
;$$Y Z
public'' 

const'' 
string'' &
ACCOUNT_ALREADY_EXISTS_KEY'' 2
=''3 4
$str''5 k
;''k l
public(( 

const(( 
string((  
TIMEOUT_EXCEEDED_KEY(( ,
=((- .
$str((/ V
;((V W
public** 

const** 
string** "
INITIAL_REMAINING_TIME** .
=**/ 0
$str**1 8
;**8 9
public++ 

const++ 
string++ "
EXPIRED_REMAINING_TIME++ .
=++/ 0
$str++1 8
;++8 9
public-- 

static-- 
readonly-- 
Guid-- 
	EmptyGuid--  )
=--* +
Guid--, 0
.--0 1
Empty--1 6
;--6 7
public// 

static// 
class// 
ErrorMessages// %
{00 
public11 
const11 
string11 
SESSION_NOT_FOUND11 -
=11. /
$str110 C
;11C D
public22 
const22 
string22 

START_OVER22 &
=22' (
$str22) 5
;225 6
public33 
const33 
string33 &
SESSION_EXPIRED_START_OVER33 6
=337 8
$str339 ^
;33^ _
}44 
public66 

static66 
class66 
Timeouts66  
{77 
public88 
static88 
readonly88 
TimeSpan88 '
CleanupTimeout88( 6
=887 8
TimeSpan889 A
.88A B
FromSeconds88B M
(88M N
$num88N O
)88O P
;88P Q
}99 
public;; 

static;; 
class;; %
SecureKeyConfirmationKeys;; 1
{<< 
public== 
const== 
string== 
REGISTRATION_TITLE== .
===/ 0
$str==1 d
;==d e
public>> 
const>> 
string>> $
REGISTRATION_DESCRIPTION>> 4
=>>5 6
$str>>7 p
;>>p q
public?? 
const?? 
string?? 
REGISTRATION_BUTTON?? /
=??0 1
$str??2 f
;??f g
publicAA 
constAA 
stringAA 
RECOVERY_TITLEAA *
=AA+ ,
$strAA- [
;AA[ \
publicBB 
constBB 
stringBB  
RECOVERY_DESCRIPTIONBB 0
=BB1 2
$strBB3 g
;BBg h
publicCC 
constCC 
stringCC 
RECOVERY_BUTTONCC +
=CC, -
$strCC. ]
;CC] ^
publicEE 
constEE 
stringEE "
SECURE_KEY_PLACEHOLDEREE 2
=EE3 4
$strEE5 y
;EEy z
publicFF 
constFF 
stringFF 
SECURE_KEY_HINTFF +
=FF, -
$strFF. k
;FFk l
publicGG 
constGG 
stringGG )
VERIFY_SECURE_KEY_PLACEHOLDERGG 9
=GG: ;
$str	GG< á
;
GGá à
publicHH 
constHH 
stringHH "
VERIFY_SECURE_KEY_HINTHH 2
=HH3 4
$strHH5 y
;HHy z
publicJJ 
constJJ 
stringJJ +
RECOVERY_SECURE_KEY_PLACEHOLDERJJ ;
=JJ< =
$strJJ> ~
;JJ~ 
publicKK 
constKK 
stringKK $
RECOVERY_SECURE_KEY_HINTKK 4
=KK5 6
$strKK7 p
;KKp q
publicLL 
constLL 
stringLL 2
&RECOVERY_VERIFY_SECURE_KEY_PLACEHOLDERLL B
=LLC D
$str	LLE â
;
LLâ ä
publicMM 
constMM 
stringMM +
RECOVERY_VERIFY_SECURE_KEY_HINTMM ;
=MM< =
$strMM> {
;MM{ |
}NN 
publicPP 

staticPP 
classPP "
MobileVerificationKeysPP .
{QQ 
publicRR 
constRR 
stringRR 
REGISTRATION_TITLERR .
=RR/ 0
$strRR1 a
;RRa b
publicSS 
constSS 
stringSS $
REGISTRATION_DESCRIPTIONSS 4
=SS5 6
$strSS7 m
;SSm n
publicTT 
constTT 
stringTT 
REGISTRATION_HINTTT -
=TT. /
$strTT0 _
;TT_ `
publicUU 
constUU 
stringUU "
REGISTRATION_WATERMARKUU 2
=UU3 4
$strUU5 i
;UUi j
publicVV 
constVV 
stringVV 
REGISTRATION_BUTTONVV /
=VV0 1
$strVV2 c
;VVc d
publicXX 
constXX 
stringXX 
RECOVERY_TITLEXX *
=XX+ ,
$strXX- h
;XXh i
publicYY 
constYY 
stringYY  
RECOVERY_DESCRIPTIONYY 0
=YY1 2
$strYY3 t
;YYt u
publicZZ 
constZZ 
stringZZ 
RECOVERY_HINTZZ )
=ZZ* +
$strZZ, f
;ZZf g
public[[ 
const[[ 
string[[ 
RECOVERY_WATERMARK[[ .
=[[/ 0
$str[[1 p
;[[p q
public\\ 
const\\ 
string\\ 
RECOVERY_BUTTON\\ +
=\\, -
$str\\. j
;\\j k
}]] 
}`` »
ë/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Security/IServerPublicKeyProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Security. 6
;6 7
public 
	interface $
IServerPublicKeyProvider )
{ 
byte 
[ 	
]	 

GetServerPublicKey 
( 
) 
;  
} Ó
â/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Network/IUnaryRpcServices.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Network. 5
;5 6
public

 
	interface

 
IUnaryRpcServices

 "
{ 
Task 
< 	
Result	 
< 
RpcFlow 
, 
NetworkFailure '
>' (
>( )
InvokeRequestAsync* <
(< =
ServiceRequest 
request 
,  
IConnectivityService 
connectivityService 0
,0 1
CancellationToken 
token 
)  
;  !
} ›
í/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Network/ISecrecyChannelRpcServices.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Services

  
.

  !
Abstractions

! -
.

- .
Network

. 5
;

5 6
public 
	interface &
ISecrecyChannelRpcServices +
{ 
Task 
< 	
Result	 
< 
SecureEnvelope 
, 
NetworkFailure  .
>. /
>/ 01
%EstablishAppDeviceSecrecyChannelAsync1 V
(V W 
IConnectivityService 
connectivityService 0
,0 1
SecureEnvelope 
request 
, 
PubKeyExchangeType 
? 
EXCHANGE_TYPE )
=* +
null, 0
,0 1
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< "
RestoreChannelResponse &
,& '
NetworkFailure( 6
>6 7
>7 8/
#RestoreAppDeviceSecrecyChannelAsync9 \
(\ ] 
IConnectivityService 
connectivityService 0
,0 1!
RestoreChannelRequest 
request %
,% &
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
SecureEnvelope 
, 
NetworkFailure  .
>. /
>/ 04
(AuthenticatedEstablishSecureChannelAsync1 Y
(Y Z 
IConnectivityService 
connectivityService 0
,0 1)
AuthenticatedEstablishRequest %
request& -
,- .
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
} §
ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Network/IRpcServiceManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Network. 5
;5 6
public 
	interface 
IRpcServiceManager #
{ 
Task 
< 	
Result	 
< 
SecureEnvelope 
, 
NetworkFailure  .
>. /
>/ 0(
EstablishSecrecyChannelAsync1 M
(M N 
IConnectivityService 
connectivityService 0
,0 1
SecureEnvelope 
envelope 
,  
PubKeyExchangeType 
? 
EXCHANGE_TYPE )
=* +
null, 0
,0 1
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< "
RestoreChannelResponse &
,& '
NetworkFailure( 6
>6 7
>7 8&
RestoreSecrecyChannelAsync9 S
(S T 
IConnectivityService 
connectivityService 0
,0 1!
RestoreChannelRequest 
request %
,% &
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
SecureEnvelope 
, 
NetworkFailure  .
>. /
>/ 04
(EstablishAuthenticatedSecureChannelAsync1 Y
(Y Z 
IConnectivityService 
connectivityService 0
,0 1)
AuthenticatedEstablishRequest %
request& -
,- .
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
RpcFlow 
, 
NetworkFailure '
>' (
>( )%
InvokeServiceRequestAsync* C
(C D
ServiceRequestD R
requestS Z
,Z [
CancellationToken\ m
tokenn s
)s t
;t u
}   ®
Ü/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Network/IRetryStrategy.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Network. 5
;5 6
public

 
	interface

 
IRetryStrategy

 
:

  !
IDisposable

" -
{ 
Task 
< 	
Result	 
< 
	TResponse 
, 
NetworkFailure )
>) *
>* +$
ExecuteRpcOperationAsync, D
<D E
	TResponseE N
>N O
(O P
Func 
< 
int 
, 
CancellationToken #
,# $
Task% )
<) *
Result* 0
<0 1
	TResponse1 :
,: ;
NetworkFailure< J
>J K
>K L
>L M
	operationN W
,W X
string 
operationName 
, 
uint 
	connectId 
, 
RpcServiceType 
? 
serviceType #
=$ %
null& *
,* +
int 
? 

maxRetries 
= 
null 
, 
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
	TResponse 
, 
NetworkFailure )
>) *
>* +/
#ExecuteManualRetryRpcOperationAsync, O
<O P
	TResponseP Y
>Y Z
(Z [
Func 
< 
int 
, 
CancellationToken #
,# $
Task% )
<) *
Result* 0
<0 1
	TResponse1 :
,: ;
NetworkFailure< J
>J K
>K L
>L M
	operationN W
,W X
string 
operationName 
, 
uint 
	connectId 
, 
RpcServiceType 
? 
serviceType #
=$ %
null& *
,* +
int 
? 

maxRetries 
= 
null 
, 
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
void !
MarkConnectionHealthy	 
( 
uint #
	connectId$ -
)- .
;. /
void $
ClearExhaustedOperations	 !
(! "
)" #
;# $
} ‹
å/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Network/IRetryPolicyProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Network. 5
;5 6
public 
	interface  
IRetryPolicyProvider %
{ 
RetryBehavior 
GetRetryBehavior "
(" #
RpcServiceType# 1
serviceType2 =
)= >
;> ?
} ®
ë/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Network/IReceiveStreamRpcServices.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Network. 5
;5 6
public		 
	interface		 %
IReceiveStreamRpcServices		 *
{

 
Task 
< 	
Result	 
< 
RpcFlow 
, 
NetworkFailure '
>' (
>( )
ProcessRequest* 8
(8 9
ServiceRequest9 G
requestH O
,O P
CancellationTokenQ b
tokenc h
)h i
;i j
} æ
â/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Membership/ILogoutService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .

Membership. 8
;8 9
public		 
	interface		 
ILogoutService		 
{

 
Task 
< 	
Result	 
< 
Unit 
, 
LogoutFailure #
># $
>$ %
LogoutAsync& 1
(1 2
LogoutReason2 >
reason? E
,E F
CancellationTokenG X
cancellationTokenY j
=k l
defaultm t
)t u
;u v
} ¢
é/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/External/IIpGeolocationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
External. 6
;6 7
public		 
	interface		 !
IIpGeolocationService		 &
{

 
Task 
< 	
Result	 
< 
	IpCountry 
, %
InternalServiceApiFailure 4
>4 5
>5 6
GetIpCountryAsync7 H
(H I
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
} Ô
â/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Core/IStateCleanupService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Core. 2
;2 3
public 
	interface  
IStateCleanupService %
{ 
Task		 
<		 	
Result			 
<		 
Unit		 
,		 
	Exception		 
>		  
>		  !'
CleanupMembershipStateAsync		" =
(		= >
string		> D
membershipId		E Q
,		Q R
uint		S W
	connectId		X a
)		a b
;		b c
Task

 
<

 	
Result

	 
<

 
Unit

 
,

 
	Exception

 
>

  
>

  !/
#CleanupMembershipStateWithKeysAsync

" E
(

E F
string

F L
membershipId

M Y
,

Y Z
uint

[ _
	connectId

` i
)

i j
;

j k
} »
â/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Core/ILocalizationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Core. 2
;2 3
public 
	interface  
ILocalizationService %
:& '"
INotifyPropertyChanged( >
{ 
string		 

this		 
[		 
string		 
key		 
]		 
{		 
get		 !
;		! "
}		# $
void

 

SetCulture

	 
(

 
string

 
?

 
cultureName

 '
,

' (
Action

) /
?

/ 0
onCultureChanged

1 A
=

B C
null

D H
)

H I
;

I J
string 

	GetString 
( 
string 
key 
,  
params! '
object( .
[. /
]/ 0
args1 5
)5 6
;6 7
CultureInfo 
CurrentCultureInfo "
{# $
get% (
;( )
}* +
string 

CurrentCultureName 
{ 
get  #
;# $
}% &
event 	
Action
 
? 
LanguageChanged !
;! "
} —

ç/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Core/IApplicationStateManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Core. 2
;2 3
public 
enum 
ApplicationState 
{ 
INITIALIZING		 
,		 
	Anonymous

 
,

 
Authenticated 
} 
public 
	interface $
IApplicationStateManager )
{ 
ApplicationState 
CurrentState !
{" #
get$ '
;' (
}) *
IObservable 
< 
ApplicationState  
>  !
StateChanges" .
{/ 0
get1 4
;4 5
}6 7
Option 

<
 
string 
> 
CurrentMembershipId &
{' (
get) ,
;, -
}. /
Task &
TransitionToAnonymousAsync	 #
(# $
)$ %
;% &
Task *
TransitionToAuthenticatedAsync	 '
(' (
string( .
membershipId/ ;
); <
;< =
} ”
á/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Core/IApplicationRouter.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Core. 2
;2 3
public 
	interface 
IApplicationRouter #
{ 
Task )
NavigateToAuthenticationAsync	 &
(& '
)' (
;( )
Task

 
NavigateToMainAsync

	 
(

 
)

 
;

 
Task %
TransitionFromSplashAsync	 "
(" #
Window# )
splashWindow* 6
,6 7
bool8 <
isAuthenticated= L
)L M
;M N
} ì
å/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Core/IApplicationInitializer.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Core. 2
;2 3
public 
	interface #
IApplicationInitializer (
{ 
Task 
< 	
bool	 
> 
InitializeAsync 
( !
DefaultSystemSettings 4!
defaultSystemSettings5 J
)J K
;K L
}		 ≠
ò/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Authentication/ISecureKeyRecoveryService.cs
	namespace		 	
Ecliptix		
 
.		 
Core		 
.		 
Services		  
.		  !
Abstractions		! -
.		- .
Authentication		. <
;		< =
public 
	interface %
ISecureKeyRecoveryService *
{ 
Task 
< 	
Result	 
< 

ByteString 
, 
string "
>" #
># $*
ValidateMobileForRecoveryAsync% C
(C D
stringD J
mobileNumberK W
,W X
uint 
	connectId 
, 
CancellationToken )
cancellationToken* ;
=< =
default> E
)E F
;F G
Task 
< 	
Result	 
< 
Unit 
, 
string 
> 
> *
InitiateSecureKeyResetOtpAsync =
(= >

ByteString> H"
mobileNumberIdentifierI _
,_ `
Action 
< 
uint 
, 
Guid 
, '
VerificationCountdownUpdate 6
.6 7
Types7 <
.< =!
CountdownUpdateStatus= R
,R S
stringT Z
?Z [
>[ \
?\ ]
onCountdownUpdate^ o
=p q
nullr v
,v w
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
Unit 
, 
string 
> 
> (
ResendSecureKeyResetOtpAsync ;
(; <
Guid< @
sessionIdentifierA R
,R S

ByteStringT ^"
mobileNumberIdentifier_ u
,u v
Action 
< 
uint 
, 
Guid 
, '
VerificationCountdownUpdate 6
.6 7
Types7 <
.< =!
CountdownUpdateStatus= R
,R S
stringT Z
?Z [
>[ \
?\ ]
onCountdownUpdate^ o
=p q
nullr v
,v w
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
Protobuf 
. 

Membership #
.# $

Membership$ .
,. /
string0 6
>6 7
>7 8(
VerifySecureKeyResetOtpAsync9 U
(U V
GuidV Z
sessionIdentifier[ l
,l m
stringn t
otpCodeu |
,| }
uint 
	connectId 
, 
CancellationToken )
cancellationToken* ;
=< =
default> E
)E F
;F G
Task 
< 	
Result	 
< 
Unit 
, 
string 
> 
> '
CompleteSecureKeyResetAsync :
(: ;

ByteString; E 
membershipIdentifierF Z
,Z [
SecureTextBuffer\ l
newSecureKeym y
,y z
uint 
	connectId 
, 
CancellationToken )
cancellationToken* ;
=< =
default> E
)E F
;F G
Task 
< 	
Result	 
< 
Unit 
, 
string 
> 
> -
!CleanupSecureKeyResetSessionAsync @
(@ A
GuidA E
sessionIdentifierF W
)W X
;X Y
} ª$
ô/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Authentication/IOpaqueRegistrationService.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Services

  
.

  !
Abstractions

! -
.

- .
Authentication

. <
;

< =
public 
	interface &
IOpaqueRegistrationService +
{ 
Task 
< 	
Result	 
< (
ValidateMobileNumberResponse ,
,, -
string. 4
>4 5
>5 6%
ValidateMobileNumberAsync7 P
(P Q
stringQ W
mobileNumberX d
,d e
uint 
	connectId 
, 
CancellationToken )
cancellationToken* ;
=< =
default> E
)E F
;F G
Task 
< 	
Result	 
< 1
%CheckMobileNumberAvailabilityResponse 5
,5 6
string7 =
>= >
>> ?.
"CheckMobileNumberAvailabilityAsync@ b
(b c

ByteString "
mobileNumberIdentifier )
,) *
uint 
	connectId 
, 
CancellationToken )
cancellationToken* ;
=< =
default> E
)E F
;F G
Task 
< 	
Result	 
< 
Unit 
, 
string 
> 
> (
InitiateOtpVerificationAsync ;
(; <

ByteString "
mobileNumberIdentifier )
,) *
VerificationPurpose 
purpose #
=$ %
VerificationPurpose& 9
.9 :
Registration: F
,F G
Action 
< 
uint 
, 
Guid 
, '
VerificationCountdownUpdate 6
.6 7
Types7 <
.< =!
CountdownUpdateStatus= R
,R S
stringT Z
?Z [
>[ \
?\ ]
onCountdownUpdate^ o
=p q
nullr v
,v w
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
Unit 
, 
string 
> 
> &
ResendOtpVerificationAsync 9
(9 :
Guid: >
sessionIdentifier? P
,P Q

ByteStringR \"
mobileNumberIdentifier] s
,s t
Action 
< 
uint 
, 
Guid 
, '
VerificationCountdownUpdate 6
.6 7
Types7 <
.< =!
CountdownUpdateStatus= R
,R S
stringT Z
?Z [
>[ \
?\ ]
onCountdownUpdate^ o
=p q
nullr v
,v w
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
Protobuf 
. 

Membership #
.# $

Membership$ .
,. /
string0 6
>6 7
>7 8
VerifyOtpAsync9 G
(G H
GuidH L
sessionIdentifierM ^
,^ _
string` f
otpCodeg n
,n o
uint   
	connectId   
,   
CancellationToken   )
cancellationToken  * ;
=  < =
default  > E
)  E F
;  F G
Task"" 
<"" 	
Result""	 
<"" 
Unit"" 
,"" 
string"" 
>"" 
>"" %
CompleteRegistrationAsync"" 8
(""8 9

ByteString""9 C 
membershipIdentifier""D X
,""X Y
SecureTextBuffer""Z j
	secureKey""k t
,""t u
uint## 
	connectId## 
,## 
CancellationToken## )
cancellationToken##* ;
=##< =
default##> E
)##E F
;##F G
Task%% 
<%% 	
Result%%	 
<%% 
Unit%% 
,%% 
string%% 
>%% 
>%% +
CleanupVerificationSessionAsync%% >
(%%> ?
Guid%%? C
sessionIdentifier%%D U
)%%U V
;%%V W
}&& ÿ
è/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Authentication/IIdentityService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Authentication. <
;< =
public 
	interface 
IIdentityService !
{		 
Task

 
<

 	
bool

	 
>

 "
HasStoredIdentityAsync

 %
(

% &
string

& ,
membershipId

- 9
)

9 :
;

: ;
Task 
< 	
Result	 
< 
Unit 
, !
AuthenticationFailure +
>+ ,
>, -
ClearAllCacheAsync. @
(@ A
stringA G
membershipIdH T
)T U
;U V
Task 
< 	
Result	 
< 
Unit 
, !
AuthenticationFailure +
>+ ,
>, -
StoreIdentityAsync. @
(@ A$
SodiumSecureMemoryHandleA Y
masterKeyHandleZ i
,i j
stringk q
membershipIdr ~
)~ 
;	 Ä
Task 
< 	
Result	 
< $
SodiumSecureMemoryHandle (
,( )!
AuthenticationFailure* ?
>? @
>@ A$
LoadMasterKeyHandleAsyncB Z
(Z [
string[ a
membershipIdb n
)n o
;o p
} Û
x/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Models/Membership/LogoutReason.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Models 
. 

Membership )
;) *
public 
enum 
LogoutReason 
{ 
UserInitiated 
, 
SESSION_EXPIRED 
, 
SessionTimeout 
, 
DeviceRemoved 
, 
SecurityViolation		 
,		 
AccountDeactivated

 
,

 
SecureKeyChanged 
, 
ForceLogout 
, 
SystemMaintenance 
} ™
î/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Serialization/EcliptixJsonSerializerContext.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Serialization' 4
;4 5
[ '
JsonSourceGenerationOptions 
(  
PropertyNamingPolicy 
= !
JsonKnownNamingPolicy 0
.0 1
	CamelCase1 :
,: ;
WriteIndented		 
=		 
false		 
,		 
GenerationMode

 
=

 $
JsonSourceGenerationMode

 -
.

- .
Metadata

. 6
|

7 8$
JsonSourceGenerationMode

9 Q
.

Q R
Serialization

R _
,

_ `"
DefaultIgnoreCondition 
= 
JsonIgnoreCondition 0
.0 1
WhenWritingNull1 @
,@ A"
UseStringEnumConverter 
= 
true !
)! "
]" #
[ 
JsonSerializable 
( 
typeof 
( 
	BuildInfo "
)" #
)# $
]$ %
[ 
JsonSerializable 
( 
typeof 
( !
DefaultSystemSettings .
). /
)/ 0
]0 1
public 
partial 
class )
EcliptixJsonSerializerContext 2
:3 4!
JsonSerializerContext5 J
{ 
public 

static !
JsonSerializerOptions '
DefaultOptions( 6
=>7 9
new: =
(= >
)> ?
{  
PropertyNamingPolicy 
= 
JsonNamingPolicy /
./ 0
	CamelCase0 9
,9 :
WriteIndented 
= 
false 
, "
DefaultIgnoreCondition 
=  
JsonIgnoreCondition! 4
.4 5
WhenWritingNull5 D
,D E
TypeInfoResolver 
= 
Default "
} 
; 
} åÃ
î/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Storage/SecureProtocolStateStorage.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Storage0 7
;7 8
public 
sealed 
class &
SecureProtocolStateStorage .
:/ 0'
ISecureProtocolStateStorage1 L
,L M
IDisposableN Y
{ 
private 
const 
string 
KeychainPrefix '
=( )
$str* 9
;9 :
private 
static 
readonly 
Encoding $
Utf8% )
=* +
Encoding, 4
.4 5
UTF85 9
;9 :
private 
static 
readonly 
Encoding $
Ascii% *
=+ ,
Encoding- 5
.5 6
ASCII6 ;
;; <
private 
static 
readonly 
byte  
[  !
]! "
MagicHeaderBytes# 3
=4 5
Ascii6 ;
.; <
GetBytes< D
(D E"
SecureStorageConstantsE [
.[ \
Header\ b
.b c
MAGIC_HEADERc o
)o p
;p q
private 
static 
readonly 
char  
[  !
]! " 
InvalidFileNameChars# 7
=8 9
Path: >
.> ?#
GetInvalidFileNameChars? V
(V W
)W X
;X Y
private 
static 
readonly 
HashSet #
<# $
char$ (
>( )'
InvalidFileNameCharacterSet* E
=F G
newH K
(K L 
InvalidFileNameCharsL `
)` a
;a b
private 
readonly %
IPlatformSecurityProvider .
_platformProvider/ @
;@ A
private 
readonly 
string 
_storageDirectory -
;- .
private 
readonly 
byte 
[ 
] 
	_deviceId %
;% &
private!! 
byte!! 
[!! 
]!! 
?!! 
_cachedHmacKey!! "
;!!" #
private"" 
bool"" 
	_disposed"" 
;"" 
public$$ 
&
SecureProtocolStateStorage$$ %
($$% &%
IPlatformSecurityProvider$$& ?
platformProvider$$@ P
,$$P Q
string$$R X
storageDirectory$$Y i
,$$i j
byte%% 
[%% 
]%% 
deviceId%% 
)%% 
{&& 
_platformProvider'' 
='' 
platformProvider'' ,
;'', -
_storageDirectory(( 
=(( 
storageDirectory(( ,
;((, -
	_deviceId)) 
=)) 
deviceId)) 
;)) '
EnsureSecureDirectoryExists++ #
(++# $
)++$ %
;++% &
},, 
public.. 

async.. 
Task.. 
<.. 
Result.. 
<.. 
Unit.. !
,..! " 
SecureStorageFailure..# 7
>..7 8
>..8 9
SaveStateAsync..: H
(..H I
byte// 
[// 
]// 
protocolState// 
,// 
string00 
	connectId00 
,00 
byte11 
[11 
]11 
membershipId11 
)11 
{22 
if33 

(33 
!33  
TryEnsureNotDisposed33 !
(33! "
out33" % 
SecureStorageFailure33& :
?33: ;
failure33< C
)33C D
)33D E
{44 	
return55 
Result55 
<55 
Unit55 
,55  
SecureStorageFailure55  4
>554 5
.555 6
Err556 9
(559 :
failure55: A
!55A B
)55B C
;55C D
}66 	
string88 
storagePath88 
=88 
GetStorageFilePath88 /
(88/ 0
	connectId880 9
)889 :
;88: ;
string99 
keychainKey99 
=99 
BuildKeychainKey99 -
(99- .
	connectId99. 7
)997 8
;998 9
byte;; 
[;; 
];; 
?;; 
encryptionKey;; 
=;; 
null;;  $
;;;$ %
byte<< 
[<< 
]<< 
?<< 
salt<< 
=<< 
null<< 
;<< 
byte== 
[== 
]== 
?== 
nonce== 
=== 
null== 
;== 
byte>> 
[>> 
]>> 
?>> 
tag>> 
=>> 
null>> 
;>> 
byte?? 
[?? 
]?? 
??? 

ciphertext?? 
=?? 
null?? !
;??! "
byte@@ 
[@@ 
]@@ 
?@@ 
containerBytes@@ 
=@@  
null@@! %
;@@% &
byteAA 
[AA 
]AA 
?AA 
protectedContainerAA "
=AA# $
nullAA% )
;AA) *
byteBB 
[BB 
]BB 
?BB 
associatedDataBB 
=BB  
nullBB! %
;BB% &
tryDD 
{EE 	
(FF 
encryptionKeyFF 
,FF 
saltFF  
)FF  !
=FF" #
awaitFF$ )
DeriveKeyAsyncFF* 8
(FF8 9
membershipIdFF9 E
)FFE F
.FFF G
ConfigureAwaitFFG U
(FFU V
falseFFV [
)FF[ \
;FF\ ]
nonceGG 
=GG 
awaitGG 
_platformProviderGG +
.GG+ ,%
GenerateSecureRandomAsyncGG, E
(GGE F"
SecureStorageConstantsGGF \
.GG\ ]

EncryptionGG] g
.GGg h

NONCE_SIZEGGh r
)GGr s
.HH 
ConfigureAwaitHH 
(HH  
falseHH  %
)HH% &
;HH& '
associatedDataJJ 
=JJ  
CreateAssociatedDataJJ 1
(JJ1 2
	connectIdJJ2 ;
,JJ; <
	_deviceIdJJ= F
)JJF G
;JJG H
(LL 

ciphertextLL 
,LL 
tagLL 
)LL 
=LL 
EncryptStateLL  ,
(LL, -
protocolStateLL- :
,LL: ;
encryptionKeyLL< I
,LLI J
nonceLLK P
,LLP Q
associatedDataLLR `
)LL` a
;LLa b
containerBytesNN 
=NN 
SerializeContainerNN /
(NN/ 0
newNN0 3
SecureContainerNN4 C
(NNC D
saltNND H
,NNH I
nonceNNJ O
,NNO P
tagNNQ T
,NNT U

ciphertextNNV `
,NN` a
associatedDataNNb p
)NNp q
)NNq r
;NNr s
protectedContainerOO 
=OO  
awaitOO! &$
AddTamperProtectionAsyncOO' ?
(OO? @
containerBytesOO@ N
)OON O
.OOO P
ConfigureAwaitOOP ^
(OO^ _
falseOO_ d
)OOd e
;OOe f
awaitQQ  
WriteSecureFileAsyncQQ &
(QQ& '
protectedContainerQQ' 9
,QQ9 :
storagePathQQ; F
)QQF G
.QQG H
ConfigureAwaitQQH V
(QQV W
falseQQW \
)QQ\ ]
;QQ] ^
awaitSS 
_platformProviderSS #
.SS# $#
StoreKeyInKeychainAsyncSS$ ;
(SS; <
keychainKeySS< G
,SSG H
encryptionKeySSI V
)SSV W
.SSW X
ConfigureAwaitSSX f
(SSf g
falseSSg l
)SSl m
;SSm n
returnUU 
ResultUU 
<UU 
UnitUU 
,UU  
SecureStorageFailureUU  4
>UU4 5
.UU5 6
OkUU6 8
(UU8 9
UnitUU9 =
.UU= >
ValueUU> C
)UUC D
;UUD E
}VV 	
catchWW 
(WW 
	ExceptionWW 
exWW 
)WW 
whenWW !
(WW" #
exWW# %
isWW& (
notWW) , 
OutOfMemoryExceptionWW- A
)WWA B
{XX 	
awaitYY "
CleanupFailedSaveAsyncYY (
(YY( )
storagePathYY) 4
,YY4 5
keychainKeyYY6 A
)YYA B
.YYB C
ConfigureAwaitYYC Q
(YYQ R
falseYYR W
)YYW X
;YYX Y
return[[ 
Result[[ 
<[[ 
Unit[[ 
,[[  
SecureStorageFailure[[  4
>[[4 5
.[[5 6
Err[[6 9
([[9 :
new\\  
SecureStorageFailure\\ (
(\\( )
string]] 
.]] 
Format]] !
(]]! "$
ApplicationErrorMessages]]" :
.]]: ;&
SecureProtocolStateStorage]]; U
.]]U V
SAVE_FAILED]]V a
,]]a b
ex]]c e
.]]e f
Message]]f m
)]]m n
)]]n o
)]]o p
;]]p q
}^^ 	
finally__ 
{`` 	

ZeroBufferaa 
(aa 
encryptionKeyaa $
)aa$ %
;aa% &

ZeroBufferbb 
(bb 
saltbb 
)bb 
;bb 

ZeroBuffercc 
(cc 
noncecc 
)cc 
;cc 

ZeroBufferdd 
(dd 
tagdd 
)dd 
;dd 

ZeroBufferee 
(ee 

ciphertextee !
)ee! "
;ee" #

ZeroBufferff 
(ff 
containerBytesff %
)ff% &
;ff& '

ZeroBuffergg 
(gg 
protectedContainergg )
)gg) *
;gg* +

ZeroBufferhh 
(hh 
associatedDatahh %
)hh% &
;hh& '

ZeroBufferii 
(ii 
protocolStateii $
)ii$ %
;ii% &
}jj 	
}kk 
publicmm 

asyncmm 
Taskmm 
<mm 
Resultmm 
<mm 
bytemm !
[mm! "
]mm" #
,mm# $ 
SecureStorageFailuremm% 9
>mm9 :
>mm: ;
LoadStateAsyncmm< J
(mmJ K
stringmmK Q
	connectIdmmR [
,mm[ \
bytemm] a
[mma b
]mmb c
membershipIdmmd p
)mmp q
{nn 
ifoo 

(oo 
!oo  
TryEnsureNotDisposedoo !
(oo! "
outoo" % 
SecureStorageFailureoo& :
?oo: ;
failureoo< C
)ooC D
)ooD E
{pp 	
returnqq 
Resultqq 
<qq 
byteqq 
[qq 
]qq  
,qq  ! 
SecureStorageFailureqq" 6
>qq6 7
.qq7 8
Errqq8 ;
(qq; <
failureqq< C
!qqC D
)qqD E
;qqE F
}rr 	
stringtt 
storagePathtt 
=tt 
GetStorageFilePathtt /
(tt/ 0
	connectIdtt0 9
)tt9 :
;tt: ;
stringuu 
keychainKeyuu 
=uu 
BuildKeychainKeyuu -
(uu- .
	connectIduu. 7
)uu7 8
;uu8 9
byteww 
[ww 
]ww 
?ww 
protectedContainerww "
=ww# $
nullww% )
;ww) *
bytexx 
[xx 
]xx 
?xx 
containerBytesxx 
=xx  
nullxx! %
;xx% &
SecureContaineryy 
	containeryy !
=yy" #
defaultyy$ +
;yy+ ,
boolzz  
containerInitializedzz !
=zz" #
falsezz$ )
;zz) *
byte{{ 
[{{ 
]{{ 
?{{ 
encryptionKey{{ 
={{ 
null{{  $
;{{$ %
byte|| 
[|| 
]|| 
?|| "
expectedAssociatedData|| &
=||' (
null||) -
;||- .
try~~ 
{ 	
Option
ÄÄ 
<
ÄÄ 
byte
ÄÄ 
[
ÄÄ 
]
ÄÄ 
>
ÄÄ &
protectedContainerOption
ÄÄ 3
=
ÄÄ4 5
await
ÄÄ6 ;!
ReadSecureFileAsync
ÄÄ< O
(
ÄÄO P
storagePath
ÄÄP [
)
ÄÄ[ \
.
ÄÄ\ ]
ConfigureAwait
ÄÄ] k
(
ÄÄk l
false
ÄÄl q
)
ÄÄq r
;
ÄÄr s
if
ÅÅ 
(
ÅÅ 
!
ÅÅ &
protectedContainerOption
ÅÅ )
.
ÅÅ) *
IsSome
ÅÅ* 0
)
ÅÅ0 1
{
ÇÇ 
return
ÉÉ 
Result
ÉÉ 
<
ÉÉ 
byte
ÉÉ "
[
ÉÉ" #
]
ÉÉ# $
,
ÉÉ$ %"
SecureStorageFailure
ÉÉ& :
>
ÉÉ: ;
.
ÉÉ; <
Err
ÉÉ< ?
(
ÉÉ? @
new
ÑÑ "
SecureStorageFailure
ÑÑ ,
(
ÑÑ, -&
ApplicationErrorMessages
ÑÑ- E
.
ÑÑE F(
SecureProtocolStateStorage
ÑÑF `
.
ÑÑ` a"
STATE_FILE_NOT_FOUND
ÑÑa u
)
ÑÑu v
)
ÑÑv w
;
ÑÑw x
}
ÖÖ  
protectedContainer
áá 
=
áá  &
protectedContainerOption
áá! 9
.
áá9 :
Value
áá: ?
!
áá? @
;
áá@ A
Result
ââ 
<
ââ 
byte
ââ 
[
ââ 
]
ââ 
,
ââ "
SecureStorageFailure
ââ /
>
ââ/ 0
verifiedResult
ââ1 ?
=
ââ@ A
await
ää )
VerifyTamperProtectionAsync
ää 1
(
ää1 2 
protectedContainer
ää2 D
)
ääD E
.
ääE F
ConfigureAwait
ääF T
(
ääT U
false
ääU Z
)
ääZ [
;
ää[ \
if
åå 
(
åå 
verifiedResult
åå 
.
åå 
IsErr
åå $
)
åå$ %
{
çç 
return
éé 
Result
éé 
<
éé 
byte
éé "
[
éé" #
]
éé# $
,
éé$ %"
SecureStorageFailure
éé& :
>
éé: ;
.
éé; <
Err
éé< ?
(
éé? @
verifiedResult
éé@ N
.
ééN O
	UnwrapErr
ééO X
(
ééX Y
)
ééY Z
)
ééZ [
;
éé[ \
}
èè 
containerBytes
ëë 
=
ëë 
verifiedResult
ëë +
.
ëë+ ,
Unwrap
ëë, 2
(
ëë2 3
)
ëë3 4
;
ëë4 5
	container
íí 
=
íí "
ParseSecureContainer
íí ,
(
íí, -
containerBytes
íí- ;
)
íí; <
;
íí< ="
containerInitialized
ìì  
=
ìì! "
true
ìì# '
;
ìì' ($
expectedAssociatedData
ïï "
=
ïï# $"
CreateAssociatedData
ïï% 9
(
ïï9 :
	connectId
ïï: C
,
ïïC D
	_deviceId
ïïE N
)
ïïN O
;
ïïO P
if
ññ 
(
ññ 
!
ññ %
CryptographicOperations
ññ (
.
ññ( )
FixedTimeEquals
ññ) 8
(
ññ8 9
	container
ññ9 B
.
ññB C
AssociatedData
ññC Q
,
ññQ R$
expectedAssociatedData
ññS i
)
ññi j
)
ññj k
{
óó 
return
òò 
Result
òò 
<
òò 
byte
òò "
[
òò" #
]
òò# $
,
òò$ %"
SecureStorageFailure
òò& :
>
òò: ;
.
òò; <
Err
òò< ?
(
òò? @
new
ôô "
SecureStorageFailure
ôô ,
(
ôô, -&
ApplicationErrorMessages
öö 0
.
öö0 1(
SecureProtocolStateStorage
öö1 K
.
ööK L&
ASSOCIATED_DATA_MISMATCH
ööL d
)
ööd e
)
ööe f
;
ööf g
}
õõ 
Option
ùù 
<
ùù 
byte
ùù 
[
ùù 
]
ùù 
>
ùù 
storedKeyOption
ùù *
=
ùù+ ,
await
ùù- 2"
TryGetStoredKeyAsync
ùù3 G
(
ùùG H
keychainKey
ùùH S
)
ùùS T
.
ùùT U
ConfigureAwait
ùùU c
(
ùùc d
false
ùùd i
)
ùùi j
;
ùùj k
bool
ûû 

derivedKey
ûû 
=
ûû 
!
ûû 
storedKeyOption
ûû .
.
ûû. /
IsSome
ûû/ 5
;
ûû5 6
if
üü 
(
üü 
storedKeyOption
üü 
.
üü  
IsSome
üü  &
)
üü& '
{
†† 
encryptionKey
°° 
=
°° 
storedKeyOption
°°  /
.
°°/ 0
Value
°°0 5
!
°°5 6
;
°°6 7
}
¢¢ 
else
££ 
{
§§ 
(
•• 
encryptionKey
•• 
,
•• 
_
••  !
)
••! "
=
••# $
await
••% *$
DeriveKeyWithSaltAsync
••+ A
(
••A B
membershipId
••B N
,
••N O
	container
••P Y
.
••Y Z
Salt
••Z ^
)
••^ _
.
••_ `
ConfigureAwait
••` n
(
••n o
false
••o t
)
••t u
;
••u v
}
¶¶ 
byte
®® 
[
®® 
]
®® 
	plaintext
®® 
=
®® 
DecryptState
©© 
(
©© 
	container
©© &
.
©©& '

Ciphertext
©©' 1
,
©©1 2
encryptionKey
©©3 @
,
©©@ A
	container
©©B K
.
©©K L
Nonce
©©L Q
,
©©Q R
	container
©©S \
.
©©\ ]
Tag
©©] `
,
©©` a
	container
™™ 
.
™™ 
AssociatedData
™™ ,
)
™™, -
;
™™- .
if
¨¨ 
(
¨¨ 

derivedKey
¨¨ 
)
¨¨ 
{
≠≠ 
await
ÆÆ 
_platformProvider
ÆÆ '
.
ÆÆ' (%
StoreKeyInKeychainAsync
ÆÆ( ?
(
ÆÆ? @
keychainKey
ÆÆ@ K
,
ÆÆK L
encryptionKey
ÆÆM Z
!
ÆÆZ [
)
ÆÆ[ \
.
ÆÆ\ ]
ConfigureAwait
ÆÆ] k
(
ÆÆk l
false
ÆÆl q
)
ÆÆq r
;
ÆÆr s
}
ØØ 
return
±± 
Result
±± 
<
±± 
byte
±± 
[
±± 
]
±±  
,
±±  !"
SecureStorageFailure
±±" 6
>
±±6 7
.
±±7 8
Ok
±±8 :
(
±±: ;
	plaintext
±±; D
)
±±D E
;
±±E F
}
≤≤ 	
catch
≥≥ 
(
≥≥ 
	Exception
≥≥ 
ex
≥≥ 
)
≥≥ 
when
≥≥ !
(
≥≥" #
ex
≥≥# %
is
≥≥& (
not
≥≥) ,"
OutOfMemoryException
≥≥- A
)
≥≥A B
{
¥¥ 	
return
µµ 
Result
µµ 
<
µµ 
byte
µµ 
[
µµ 
]
µµ  
,
µµ  !"
SecureStorageFailure
µµ" 6
>
µµ6 7
.
µµ7 8
Err
µµ8 ;
(
µµ; <
new
∂∂ "
SecureStorageFailure
∂∂ (
(
∂∂( )
string
∑∑ 
.
∑∑ 
Format
∑∑ !
(
∑∑! "&
ApplicationErrorMessages
∑∑" :
.
∑∑: ;(
SecureProtocolStateStorage
∑∑; U
.
∑∑U V
LOAD_FAILED
∑∑V a
,
∑∑a b
ex
∑∑c e
.
∑∑e f
Message
∑∑f m
)
∑∑m n
)
∑∑n o
)
∑∑o p
;
∑∑p q
}
∏∏ 	
finally
ππ 
{
∫∫ 	

ZeroBuffer
ªª 
(
ªª  
protectedContainer
ªª )
)
ªª) *
;
ªª* +

ZeroBuffer
ºº 
(
ºº 
containerBytes
ºº %
)
ºº% &
;
ºº& '

ZeroBuffer
ΩΩ 
(
ΩΩ $
expectedAssociatedData
ΩΩ -
)
ΩΩ- .
;
ΩΩ. /
if
øø 
(
øø "
containerInitialized
øø $
)
øø$ %
{
¿¿ 

ZeroBuffer
¡¡ 
(
¡¡ 
	container
¡¡ $
.
¡¡$ %
Salt
¡¡% )
)
¡¡) *
;
¡¡* +

ZeroBuffer
¬¬ 
(
¬¬ 
	container
¬¬ $
.
¬¬$ %
Nonce
¬¬% *
)
¬¬* +
;
¬¬+ ,

ZeroBuffer
√√ 
(
√√ 
	container
√√ $
.
√√$ %
Tag
√√% (
)
√√( )
;
√√) *

ZeroBuffer
ƒƒ 
(
ƒƒ 
	container
ƒƒ $
.
ƒƒ$ %

Ciphertext
ƒƒ% /
)
ƒƒ/ 0
;
ƒƒ0 1

ZeroBuffer
≈≈ 
(
≈≈ 
	container
≈≈ $
.
≈≈$ %
AssociatedData
≈≈% 3
)
≈≈3 4
;
≈≈4 5
}
∆∆ 

ZeroBuffer
»» 
(
»» 
encryptionKey
»» $
)
»»$ %
;
»»% &
}
…… 	
}
   
public
ÃÃ 

async
ÃÃ 
Task
ÃÃ 
<
ÃÃ 
Result
ÃÃ 
<
ÃÃ 
Unit
ÃÃ !
,
ÃÃ! ""
SecureStorageFailure
ÃÃ# 7
>
ÃÃ7 8
>
ÃÃ8 9
DeleteStateAsync
ÃÃ: J
(
ÃÃJ K
string
ÃÃK Q
key
ÃÃR U
)
ÃÃU V
{
ÕÕ 
if
ŒŒ 

(
ŒŒ 
!
ŒŒ "
TryEnsureNotDisposed
ŒŒ !
(
ŒŒ! "
out
ŒŒ" %"
SecureStorageFailure
ŒŒ& :
?
ŒŒ: ;
failure
ŒŒ< C
)
ŒŒC D
)
ŒŒD E
{
œœ 	
return
–– 
Result
–– 
<
–– 
Unit
–– 
,
–– "
SecureStorageFailure
––  4
>
––4 5
.
––5 6
Err
––6 9
(
––9 :
failure
––: A
!
––A B
)
––B C
;
––C D
}
—— 	
string
”” 
storagePath
”” 
=
””  
GetStorageFilePath
”” /
(
””/ 0
key
””0 3
)
””3 4
;
””4 5
string
‘‘ 
keychainKey
‘‘ 
=
‘‘ 
BuildKeychainKey
‘‘ -
(
‘‘- .
key
‘‘. 1
)
‘‘1 2
;
‘‘2 3
try
÷÷ 
{
◊◊ 	
await
ÿÿ %
DeleteFileIfExistsAsync
ÿÿ )
(
ÿÿ) *
storagePath
ÿÿ* 5
)
ÿÿ5 6
.
ÿÿ6 7
ConfigureAwait
ÿÿ7 E
(
ÿÿE F
false
ÿÿF K
)
ÿÿK L
;
ÿÿL M
await
ŸŸ 
_platformProvider
ŸŸ #
.
ŸŸ# $(
DeleteKeyFromKeychainAsync
ŸŸ$ >
(
ŸŸ> ?
keychainKey
ŸŸ? J
)
ŸŸJ K
.
ŸŸK L
ConfigureAwait
ŸŸL Z
(
ŸŸZ [
false
ŸŸ[ `
)
ŸŸ` a
;
ŸŸa b
return
€€ 
Result
€€ 
<
€€ 
Unit
€€ 
,
€€ "
SecureStorageFailure
€€  4
>
€€4 5
.
€€5 6
Ok
€€6 8
(
€€8 9
Unit
€€9 =
.
€€= >
Value
€€> C
)
€€C D
;
€€D E
}
‹‹ 	
catch
›› 
(
›› 
	Exception
›› 
ex
›› 
)
›› 
when
›› !
(
››" #
ex
››# %
is
››& (
not
››) ,"
OutOfMemoryException
››- A
)
››A B
{
ﬁﬁ 	
return
ﬂﬂ 
Result
ﬂﬂ 
<
ﬂﬂ 
Unit
ﬂﬂ 
,
ﬂﬂ "
SecureStorageFailure
ﬂﬂ  4
>
ﬂﬂ4 5
.
ﬂﬂ5 6
Err
ﬂﬂ6 9
(
ﬂﬂ9 :
new
‡‡ "
SecureStorageFailure
‡‡ (
(
‡‡( )
string
·· 
.
·· 
Format
·· !
(
··! "&
ApplicationErrorMessages
··" :
.
··: ;(
SecureProtocolStateStorage
··; U
.
··U V
DELETE_FAILED
··V c
,
··c d
ex
··e g
.
··g h
Message
··h o
)
··o p
)
··p q
)
··q r
;
··r s
}
‚‚ 	
}
„„ 
public
ÂÂ 

void
ÂÂ 
Dispose
ÂÂ 
(
ÂÂ 
)
ÂÂ 
{
ÊÊ 
if
ÁÁ 

(
ÁÁ 
	_disposed
ÁÁ 
)
ÁÁ 
{
ËË 	
return
ÈÈ 
;
ÈÈ 
}
ÍÍ 	
byte
ÏÏ 
[
ÏÏ 
]
ÏÏ 
?
ÏÏ 
cachedHmacKey
ÏÏ 
=
ÏÏ 
Interlocked
ÏÏ  +
.
ÏÏ+ ,
Exchange
ÏÏ, 4
(
ÏÏ4 5
ref
ÏÏ5 8
_cachedHmacKey
ÏÏ9 G
,
ÏÏG H
null
ÏÏI M
)
ÏÏM N
;
ÏÏN O
if
ÌÌ 

(
ÌÌ 
cachedHmacKey
ÌÌ 
!=
ÌÌ 
null
ÌÌ !
)
ÌÌ! "
{
ÓÓ 	

ZeroBuffer
ÔÔ 
(
ÔÔ 
cachedHmacKey
ÔÔ $
)
ÔÔ$ %
;
ÔÔ% &
}
 	
	_disposed
ÚÚ 
=
ÚÚ 
true
ÚÚ 
;
ÚÚ 
}
ÛÛ 
private
ıı 
static
ıı 
string
ıı 
BuildKeychainKey
ıı *
(
ıı* +
string
ıı+ 1
	connectId
ıı2 ;
)
ıı; <
=>
ıı= ?
$"
ıı@ B
{
ııB C
KeychainPrefix
ııC Q
}
ııQ R
{
ııR S
	connectId
ııS \
}
ıı\ ]
"
ıı] ^
;
ıı^ _
private
˜˜ 
string
˜˜  
GetStorageFilePath
˜˜ %
(
˜˜% &
string
˜˜& ,
	connectId
˜˜- 6
)
˜˜6 7
{
¯¯ 
string
˘˘ 
sanitizedKey
˘˘ 
=
˘˘ 
SanitizeFilename
˘˘ .
(
˘˘. /
	connectId
˘˘/ 8
)
˘˘8 9
;
˘˘9 :
return
˙˙ 
Path
˙˙ 
.
˙˙ 
Combine
˙˙ 
(
˙˙ 
_storageDirectory
˙˙ -
,
˙˙- .
$"
˙˙/ 1
{
˙˙1 2
sanitizedKey
˙˙2 >
}
˙˙> ?
$str
˙˙? H
"
˙˙H I
)
˙˙I J
;
˙˙J K
}
˚˚ 
private
˝˝ 
static
˝˝ 
string
˝˝ 
SanitizeFilename
˝˝ *
(
˝˝* +
string
˝˝+ 1
key
˝˝2 5
)
˝˝5 6
{
˛˛ 
if
ˇˇ 

(
ˇˇ 
string
ˇˇ 
.
ˇˇ 
IsNullOrEmpty
ˇˇ  
(
ˇˇ  !
key
ˇˇ! $
)
ˇˇ$ %
)
ˇˇ% &
{
ÄÄ 	
return
ÅÅ 
$str
ÅÅ 
;
ÅÅ 
}
ÇÇ 	
if
ÑÑ 

(
ÑÑ 
key
ÑÑ 
.
ÑÑ 

IndexOfAny
ÑÑ 
(
ÑÑ "
InvalidFileNameChars
ÑÑ /
)
ÑÑ/ 0
<
ÑÑ1 2
$num
ÑÑ3 4
)
ÑÑ4 5
{
ÖÖ 	
return
ÜÜ 
key
ÜÜ 
;
ÜÜ 
}
áá 	
char
ââ 
[
ââ 
]
ââ 

characters
ââ 
=
ââ 
key
ââ 
.
ââ  
ToCharArray
ââ  +
(
ââ+ ,
)
ââ, -
;
ââ- .
for
ää 
(
ää 
int
ää 
i
ää 
=
ää 
$num
ää 
;
ää 
i
ää 
<
ää 

characters
ää &
.
ää& '
Length
ää' -
;
ää- .
i
ää/ 0
++
ää0 2
)
ää2 3
{
ãã 	
if
åå 
(
åå )
InvalidFileNameCharacterSet
åå +
.
åå+ ,
Contains
åå, 4
(
åå4 5

characters
åå5 ?
[
åå? @
i
åå@ A
]
ååA B
)
ååB C
)
ååC D
{
çç 

characters
éé 
[
éé 
i
éé 
]
éé 
=
éé 
$char
éé  #
;
éé# $
}
èè 
}
êê 	
return
íí 
new
íí 
string
íí 
(
íí 

characters
íí $
)
íí$ %
;
íí% &
}
ìì 
private
ïï 
static
ïï 
byte
ïï 
[
ïï 
]
ïï "
CreateAssociatedData
ïï .
(
ïï. /
string
ïï/ 5
	connectId
ïï6 ?
,
ïï? @
byte
ïïA E
[
ïïE F
]
ïïF G
deviceId
ïïH P
)
ïïP Q
{
ññ 
byte
óó 
[
óó 
]
óó 
connectIdBytes
óó 
=
óó 
Utf8
óó  $
.
óó$ %
GetBytes
óó% -
(
óó- .
	connectId
óó. 7
)
óó7 8
;
óó8 9
byte
òò 
[
òò 
]
òò 
associatedData
òò 
=
òò 
new
òò  #
byte
òò$ (
[
òò( )
sizeof
òò) /
(
òò/ 0
int
òò0 3
)
òò3 4
+
òò5 6
connectIdBytes
òò7 E
.
òòE F
Length
òòF L
+
òòM N
deviceId
òòO W
.
òòW X
Length
òòX ^
]
òò^ _
;
òò_ `
BinaryPrimitives
öö 
.
öö $
WriteInt32LittleEndian
öö /
(
öö/ 0
associatedData
öö0 >
.
öö> ?
AsSpan
öö? E
(
ööE F
$num
ööF G
,
ööG H
sizeof
ööI O
(
ööO P
int
ööP S
)
ööS T
)
ööT U
,
ööU V$
SecureStorageConstants
õõ "
.
õõ" #
Header
õõ# )
.
õõ) *
CURRENT_VERSION
õõ* 9
)
õõ9 :
;
õõ: ;
connectIdBytes
úú 
.
úú 
CopyTo
úú 
(
úú 
associatedData
úú ,
.
úú, -
AsSpan
úú- 3
(
úú3 4
sizeof
úú4 :
(
úú: ;
int
úú; >
)
úú> ?
)
úú? @
)
úú@ A
;
úúA B
deviceId
ùù 
.
ùù 
CopyTo
ùù 
(
ùù 
associatedData
ùù &
.
ùù& '
AsSpan
ùù' -
(
ùù- .
sizeof
ùù. 4
(
ùù4 5
int
ùù5 8
)
ùù8 9
+
ùù: ;
connectIdBytes
ùù< J
.
ùùJ K
Length
ùùK Q
)
ùùQ R
)
ùùR S
;
ùùS T
return
üü 
associatedData
üü 
;
üü 
}
†† 
private
¢¢ 
static
¢¢ 
(
¢¢ 
byte
¢¢ 
[
¢¢ 
]
¢¢ 

Ciphertext
¢¢ %
,
¢¢% &
byte
¢¢' +
[
¢¢+ ,
]
¢¢, -
Tag
¢¢. 1
)
¢¢1 2
EncryptState
¢¢3 ?
(
¢¢? @
byte
££ 
[
££ 
]
££ 
	plaintext
££ 
,
££ 
byte
§§ 
[
§§ 
]
§§ 
key
§§ 
,
§§ 
byte
•• 
[
•• 
]
•• 
nonce
•• 
,
•• 
byte
¶¶ 
[
¶¶ 
]
¶¶ 
associatedData
¶¶ 
)
¶¶ 
{
ßß 
using
®® 
AesGcm
®® 
aesGcm
®® 
=
®® 
new
®® !
(
®®! "
key
®®" %
,
®®% &$
SecureStorageConstants
®®' =
.
®®= >

Encryption
®®> H
.
®®H I
TAG_SIZE
®®I Q
)
®®Q R
;
®®R S
byte
©© 
[
©© 
]
©© 

ciphertext
©© 
=
©© 
new
©© 
byte
©©  $
[
©©$ %
	plaintext
©©% .
.
©©. /
Length
©©/ 5
]
©©5 6
;
©©6 7
byte
™™ 
[
™™ 
]
™™ 
tag
™™ 
=
™™ 
new
™™ 
byte
™™ 
[
™™ $
SecureStorageConstants
™™ 4
.
™™4 5

Encryption
™™5 ?
.
™™? @
TAG_SIZE
™™@ H
]
™™H I
;
™™I J
aesGcm
¨¨ 
.
¨¨ 
Encrypt
¨¨ 
(
¨¨ 
nonce
¨¨ 
,
¨¨ 
	plaintext
¨¨ '
,
¨¨' (

ciphertext
¨¨) 3
,
¨¨3 4
tag
¨¨5 8
,
¨¨8 9
associatedData
¨¨: H
)
¨¨H I
;
¨¨I J
return
ÆÆ 
(
ÆÆ 

ciphertext
ÆÆ 
,
ÆÆ 
tag
ÆÆ 
)
ÆÆ  
;
ÆÆ  !
}
ØØ 
private
±± 
static
±± 
byte
±± 
[
±± 
]
±± 
DecryptState
±± &
(
±±& '
byte
≤≤ 
[
≤≤ 
]
≤≤ 

ciphertext
≤≤ 
,
≤≤ 
byte
≥≥ 
[
≥≥ 
]
≥≥ 
key
≥≥ 
,
≥≥ 
byte
¥¥ 
[
¥¥ 
]
¥¥ 
nonce
¥¥ 
,
¥¥ 
byte
µµ 
[
µµ 
]
µµ 
tag
µµ 
,
µµ 
byte
∂∂ 
[
∂∂ 
]
∂∂ 
associatedData
∂∂ 
)
∂∂ 
{
∑∑ 
using
∏∏ 
AesGcm
∏∏ 
aesGcm
∏∏ 
=
∏∏ 
new
∏∏ !
(
∏∏! "
key
∏∏" %
,
∏∏% &$
SecureStorageConstants
∏∏' =
.
∏∏= >

Encryption
∏∏> H
.
∏∏H I
TAG_SIZE
∏∏I Q
)
∏∏Q R
;
∏∏R S
byte
ππ 
[
ππ 
]
ππ 
	plaintext
ππ 
=
ππ 
new
ππ 
byte
ππ #
[
ππ# $

ciphertext
ππ$ .
.
ππ. /
Length
ππ/ 5
]
ππ5 6
;
ππ6 7
aesGcm
ªª 
.
ªª 
Decrypt
ªª 
(
ªª 
nonce
ªª 
,
ªª 

ciphertext
ªª (
,
ªª( )
tag
ªª* -
,
ªª- .
	plaintext
ªª/ 8
,
ªª8 9
associatedData
ªª: H
)
ªªH I
;
ªªI J
return
ΩΩ 
	plaintext
ΩΩ 
;
ΩΩ 
}
ææ 
private
¿¿ 
static
¿¿ 
byte
¿¿ 
[
¿¿ 
]
¿¿  
SerializeContainer
¿¿ ,
(
¿¿, -
SecureContainer
¿¿- <
	container
¿¿= F
)
¿¿F G
{
¡¡ 
int
¬¬ 
	totalSize
¬¬ 
=
¬¬ 
MagicHeaderBytes
¬¬ (
.
¬¬( )
Length
¬¬) /
+
¬¬0 1
sizeof
¬¬2 8
(
¬¬8 9
int
¬¬9 <
)
¬¬< =
+
¬¬> ?
SegmentSize
√√ #
(
√√# $
	container
√√$ -
.
√√- .
Salt
√√. 2
.
√√2 3
Length
√√3 9
)
√√9 :
+
√√; <
SegmentSize
ƒƒ #
(
ƒƒ# $
	container
ƒƒ$ -
.
ƒƒ- .
Nonce
ƒƒ. 3
.
ƒƒ3 4
Length
ƒƒ4 :
)
ƒƒ: ;
+
ƒƒ< =
SegmentSize
≈≈ #
(
≈≈# $
	container
≈≈$ -
.
≈≈- .
Tag
≈≈. 1
.
≈≈1 2
Length
≈≈2 8
)
≈≈8 9
+
≈≈: ;
SegmentSize
∆∆ #
(
∆∆# $
	container
∆∆$ -
.
∆∆- .
AssociatedData
∆∆. <
.
∆∆< =
Length
∆∆= C
)
∆∆C D
+
∆∆E F
SegmentSize
«« #
(
««# $
	container
««$ -
.
««- .

Ciphertext
««. 8
.
««8 9
Length
««9 ?
)
««? @
;
««@ A
byte
…… 
[
…… 
]
…… 
buffer
…… 
=
…… 
new
…… 
byte
……  
[
……  !
	totalSize
……! *
]
……* +
;
……+ ,
Span
   
<
   
byte
   
>
   
	writeSpan
   
=
   
buffer
   %
.
  % &
AsSpan
  & ,
(
  , -
)
  - .
;
  . /
MagicHeaderBytes
ÃÃ 
.
ÃÃ 
CopyTo
ÃÃ 
(
ÃÃ  
	writeSpan
ÃÃ  )
)
ÃÃ) *
;
ÃÃ* +
	writeSpan
ÕÕ 
=
ÕÕ 
	writeSpan
ÕÕ 
[
ÕÕ 
MagicHeaderBytes
ÕÕ .
.
ÕÕ. /
Length
ÕÕ/ 5
..
ÕÕ5 7
]
ÕÕ7 8
;
ÕÕ8 9
BinaryPrimitives
œœ 
.
œœ $
WriteInt32LittleEndian
œœ /
(
œœ/ 0
	writeSpan
œœ0 9
,
œœ9 :$
SecureStorageConstants
œœ; Q
.
œœQ R
Header
œœR X
.
œœX Y
CURRENT_VERSION
œœY h
)
œœh i
;
œœi j
	writeSpan
–– 
=
–– 
	writeSpan
–– 
[
–– 
sizeof
–– $
(
––$ %
int
––% (
)
––( )
..
––) +
]
––+ ,
;
––, -
WriteSegment
““ 
(
““ 
	container
““ 
.
““ 
Salt
““ #
,
““# $
ref
““% (
	writeSpan
““) 2
)
““2 3
;
““3 4
WriteSegment
”” 
(
”” 
	container
”” 
.
”” 
Nonce
”” $
,
””$ %
ref
””& )
	writeSpan
””* 3
)
””3 4
;
””4 5
WriteSegment
‘‘ 
(
‘‘ 
	container
‘‘ 
.
‘‘ 
Tag
‘‘ "
,
‘‘" #
ref
‘‘$ '
	writeSpan
‘‘( 1
)
‘‘1 2
;
‘‘2 3
WriteSegment
’’ 
(
’’ 
	container
’’ 
.
’’ 
AssociatedData
’’ -
,
’’- .
ref
’’/ 2
	writeSpan
’’3 <
)
’’< =
;
’’= >
WriteSegment
÷÷ 
(
÷÷ 
	container
÷÷ 
.
÷÷ 

Ciphertext
÷÷ )
,
÷÷) *
ref
÷÷+ .
	writeSpan
÷÷/ 8
)
÷÷8 9
;
÷÷9 :
return
ÿÿ 
buffer
ÿÿ 
;
ÿÿ 
}
ŸŸ 
private
€€ 
static
€€ 
SecureContainer
€€ ""
ParseSecureContainer
€€# 7
(
€€7 8
byte
€€8 <
[
€€< =
]
€€= >
containerBytes
€€? M
)
€€M N
{
‹‹ 
ReadOnlySpan
›› 
<
›› 
byte
›› 
>
›› 
readSpan
›› #
=
››$ %
containerBytes
››& 4
.
››4 5
AsSpan
››5 ;
(
››; <
)
››< =
;
››= >
if
ﬂﬂ 

(
ﬂﬂ 
readSpan
ﬂﬂ 
.
ﬂﬂ 
Length
ﬂﬂ 
<
ﬂﬂ 
MagicHeaderBytes
ﬂﬂ .
.
ﬂﬂ. /
Length
ﬂﬂ/ 5
+
ﬂﬂ6 7
sizeof
ﬂﬂ8 >
(
ﬂﬂ> ?
int
ﬂﬂ? B
)
ﬂﬂB C
)
ﬂﬂC D
{
‡‡ 	
throw
·· 
new
·· '
InvalidOperationException
·· /
(
··/ 0&
ApplicationErrorMessages
‚‚ (
.
‚‚( )(
SecureProtocolStateStorage
‚‚) C
.
‚‚C D&
INVALID_CONTAINER_FORMAT
‚‚D \
)
‚‚\ ]
;
‚‚] ^
}
„„ 	
if
ÂÂ 

(
ÂÂ 
!
ÂÂ 
readSpan
ÂÂ 
[
ÂÂ 
..
ÂÂ 
MagicHeaderBytes
ÂÂ (
.
ÂÂ( )
Length
ÂÂ) /
]
ÂÂ/ 0
.
ÂÂ0 1
SequenceEqual
ÂÂ1 >
(
ÂÂ> ?
MagicHeaderBytes
ÂÂ? O
)
ÂÂO P
)
ÂÂP Q
{
ÊÊ 	
throw
ÁÁ 
new
ÁÁ '
InvalidOperationException
ÁÁ /
(
ÁÁ/ 0&
ApplicationErrorMessages
ËË (
.
ËË( )(
SecureProtocolStateStorage
ËË) C
.
ËËC D&
INVALID_CONTAINER_FORMAT
ËËD \
)
ËË\ ]
;
ËË] ^
}
ÈÈ 	
readSpan
ÎÎ 
=
ÎÎ 
readSpan
ÎÎ 
[
ÎÎ 
MagicHeaderBytes
ÎÎ ,
.
ÎÎ, -
Length
ÎÎ- 3
..
ÎÎ3 5
]
ÎÎ5 6
;
ÎÎ6 7
int
ÌÌ 
version
ÌÌ 
=
ÌÌ 
BinaryPrimitives
ÌÌ &
.
ÌÌ& '#
ReadInt32LittleEndian
ÌÌ' <
(
ÌÌ< =
readSpan
ÌÌ= E
)
ÌÌE F
;
ÌÌF G
if
ÓÓ 

(
ÓÓ 
version
ÓÓ 
!=
ÓÓ $
SecureStorageConstants
ÓÓ -
.
ÓÓ- .
Header
ÓÓ. 4
.
ÓÓ4 5
CURRENT_VERSION
ÓÓ5 D
)
ÓÓD E
{
ÔÔ 	
throw
 
new
 '
InvalidOperationException
 /
(
/ 0
string
ÒÒ 
.
ÒÒ 
Format
ÒÒ 
(
ÒÒ &
ApplicationErrorMessages
ÒÒ 6
.
ÒÒ6 7(
SecureProtocolStateStorage
ÒÒ7 Q
.
ÒÒQ R!
UNSUPPORTED_VERSION
ÒÒR e
,
ÒÒe f
version
ÒÒg n
)
ÒÒn o
)
ÒÒo p
;
ÒÒp q
}
ÚÚ 	
readSpan
ÙÙ 
=
ÙÙ 
readSpan
ÙÙ 
[
ÙÙ 
sizeof
ÙÙ "
(
ÙÙ" #
int
ÙÙ# &
)
ÙÙ& '
..
ÙÙ' )
]
ÙÙ) *
;
ÙÙ* +
byte
ˆˆ 
[
ˆˆ 
]
ˆˆ 
salt
ˆˆ 
=
ˆˆ 
ReadSegment
ˆˆ !
(
ˆˆ! "
ref
ˆˆ" %
readSpan
ˆˆ& .
)
ˆˆ. /
;
ˆˆ/ 0
byte
˜˜ 
[
˜˜ 
]
˜˜ 
nonce
˜˜ 
=
˜˜ 
ReadSegment
˜˜ "
(
˜˜" #
ref
˜˜# &
readSpan
˜˜' /
)
˜˜/ 0
;
˜˜0 1
byte
¯¯ 
[
¯¯ 
]
¯¯ 
tag
¯¯ 
=
¯¯ 
ReadSegment
¯¯  
(
¯¯  !
ref
¯¯! $
readSpan
¯¯% -
)
¯¯- .
;
¯¯. /
byte
˘˘ 
[
˘˘ 
]
˘˘ 
associatedData
˘˘ 
=
˘˘ 
ReadSegment
˘˘  +
(
˘˘+ ,
ref
˘˘, /
readSpan
˘˘0 8
)
˘˘8 9
;
˘˘9 :
byte
˙˙ 
[
˙˙ 
]
˙˙ 

ciphertext
˙˙ 
=
˙˙ 
ReadSegment
˙˙ '
(
˙˙' (
ref
˙˙( +
readSpan
˙˙, 4
)
˙˙4 5
;
˙˙5 6
if
¸¸ 

(
¸¸ 
!
¸¸ 
readSpan
¸¸ 
.
¸¸ 
IsEmpty
¸¸ 
)
¸¸ 
{
˝˝ 	
throw
˛˛ 
new
˛˛ '
InvalidOperationException
˛˛ /
(
˛˛/ 0&
ApplicationErrorMessages
ˇˇ (
.
ˇˇ( )(
SecureProtocolStateStorage
ˇˇ) C
.
ˇˇC D&
INVALID_CONTAINER_FORMAT
ˇˇD \
)
ˇˇ\ ]
;
ˇˇ] ^
}
ÄÄ 	
return
ÇÇ 
new
ÇÇ 
SecureContainer
ÇÇ "
(
ÇÇ" #
salt
ÇÇ# '
,
ÇÇ' (
nonce
ÇÇ) .
,
ÇÇ. /
tag
ÇÇ0 3
,
ÇÇ3 4

ciphertext
ÇÇ5 ?
,
ÇÇ? @
associatedData
ÇÇA O
)
ÇÇO P
;
ÇÇP Q
}
ÉÉ 
private
ÖÖ 
async
ÖÖ 
Task
ÖÖ 
<
ÖÖ 
byte
ÖÖ 
[
ÖÖ 
]
ÖÖ 
>
ÖÖ &
AddTamperProtectionAsync
ÖÖ 7
(
ÖÖ7 8
byte
ÖÖ8 <
[
ÖÖ< =
]
ÖÖ= >
data
ÖÖ? C
)
ÖÖC D
{
ÜÜ 
byte
áá 
[
áá 
]
áá 
hmacKey
áá 
=
áá 
await
áá 
GetHmacKeyAsync
áá .
(
áá. /
)
áá/ 0
.
áá0 1
ConfigureAwait
áá1 ?
(
áá? @
false
áá@ E
)
ááE F
;
ááF G
using
àà 

HMACSHA512
àà 
hmac
àà 
=
àà 
new
àà  #
(
àà# $
hmacKey
àà$ +
)
àà+ ,
;
àà, -
byte
ââ 
[
ââ 
]
ââ 
mac
ââ 
=
ââ 
hmac
ââ 
.
ââ 
ComputeHash
ââ %
(
ââ% &
data
ââ& *
)
ââ* +
;
ââ+ ,
byte
ãã 
[
ãã 
]
ãã 
result
ãã 
=
ãã 
new
ãã 
byte
ãã  
[
ãã  !
data
ãã! %
.
ãã% &
Length
ãã& ,
+
ãã- .
mac
ãã/ 2
.
ãã2 3
Length
ãã3 9
]
ãã9 :
;
ãã: ;
Buffer
åå 
.
åå 
	BlockCopy
åå 
(
åå 
data
åå 
,
åå 
$num
åå  
,
åå  !
result
åå" (
,
åå( )
$num
åå* +
,
åå+ ,
data
åå- 1
.
åå1 2
Length
åå2 8
)
åå8 9
;
åå9 :
Buffer
çç 
.
çç 
	BlockCopy
çç 
(
çç 
mac
çç 
,
çç 
$num
çç 
,
çç  
result
çç! '
,
çç' (
data
çç) -
.
çç- .
Length
çç. 4
,
çç4 5
mac
çç6 9
.
çç9 :
Length
çç: @
)
çç@ A
;
ççA B

ZeroBuffer
èè 
(
èè 
mac
èè 
)
èè 
;
èè 
return
êê 
result
êê 
;
êê 
}
ëë 
private
ìì 
async
ìì 
Task
ìì 
<
ìì 
Result
ìì 
<
ìì 
byte
ìì "
[
ìì" #
]
ìì# $
,
ìì$ %"
SecureStorageFailure
ìì& :
>
ìì: ;
>
ìì; <)
VerifyTamperProtectionAsync
ìì= X
(
ììX Y
byte
ììY ]
[
ìì] ^
]
ìì^ _
protectedData
ìì` m
)
ììm n
{
îî 
if
ïï 

(
ïï 
protectedData
ïï 
.
ïï 
Length
ïï  
<
ïï! "$
SecureStorageConstants
ïï# 9
.
ïï9 :

Encryption
ïï: D
.
ïïD E
HMAC_SHA_512_SIZE
ïïE V
)
ïïV W
{
ññ 	
return
óó 
Result
óó 
<
óó 
byte
óó 
[
óó 
]
óó  
,
óó  !"
SecureStorageFailure
óó" 6
>
óó6 7
.
óó7 8
Err
óó8 ;
(
óó; <
new
òò "
SecureStorageFailure
òò (
(
òò( )&
ApplicationErrorMessages
ôô ,
.
ôô, -(
SecureProtocolStateStorage
ôô- G
.
ôôG H%
TAMPERED_STATE_DETECTED
ôôH _
)
ôô_ `
)
ôô` a
;
ôôa b
}
öö 	
int
úú 
macSize
úú 
=
úú $
SecureStorageConstants
úú ,
.
úú, -

Encryption
úú- 7
.
úú7 8
HMAC_SHA_512_SIZE
úú8 I
;
úúI J
int
ùù 

dataLength
ùù 
=
ùù 
protectedData
ùù &
.
ùù& '
Length
ùù' -
-
ùù. /
macSize
ùù0 7
;
ùù7 8
byte
üü 
[
üü 
]
üü 
data
üü 
=
üü 
new
üü 
byte
üü 
[
üü 

dataLength
üü )
]
üü) *
;
üü* +
byte
†† 
[
†† 
]
†† 
mac
†† 
=
†† 
new
†† 
byte
†† 
[
†† 
macSize
†† %
]
††% &
;
††& '
Buffer
¢¢ 
.
¢¢ 
	BlockCopy
¢¢ 
(
¢¢ 
protectedData
¢¢ &
,
¢¢& '
$num
¢¢( )
,
¢¢) *
data
¢¢+ /
,
¢¢/ 0
$num
¢¢1 2
,
¢¢2 3

dataLength
¢¢4 >
)
¢¢> ?
;
¢¢? @
Buffer
££ 
.
££ 
	BlockCopy
££ 
(
££ 
protectedData
££ &
,
££& '

dataLength
££( 2
,
££2 3
mac
££4 7
,
££7 8
$num
££9 :
,
££: ;
macSize
££< C
)
££C D
;
££D E
byte
•• 
[
•• 
]
•• 
hmacKey
•• 
=
•• 
await
•• 
GetHmacKeyAsync
•• .
(
••. /
)
••/ 0
.
••0 1
ConfigureAwait
••1 ?
(
••? @
false
••@ E
)
••E F
;
••F G
using
¶¶ 

HMACSHA512
¶¶ 
hmac
¶¶ 
=
¶¶ 
new
¶¶  #
(
¶¶# $
hmacKey
¶¶$ +
)
¶¶+ ,
;
¶¶, -
byte
ßß 
[
ßß 
]
ßß 
expectedMac
ßß 
=
ßß 
hmac
ßß !
.
ßß! "
ComputeHash
ßß" -
(
ßß- .
data
ßß. 2
)
ßß2 3
;
ßß3 4
bool
©© 
matches
©© 
=
©© %
CryptographicOperations
©© .
.
©©. /
FixedTimeEquals
©©/ >
(
©©> ?
mac
©©? B
,
©©B C
expectedMac
©©D O
)
©©O P
;
©©P Q

ZeroBuffer
´´ 
(
´´ 
mac
´´ 
)
´´ 
;
´´ 

ZeroBuffer
¨¨ 
(
¨¨ 
expectedMac
¨¨ 
)
¨¨ 
;
¨¨  
if
ÆÆ 

(
ÆÆ 
matches
ÆÆ 
)
ÆÆ 
{
ØØ 	
return
∞∞ 
Result
∞∞ 
<
∞∞ 
byte
∞∞ 
[
∞∞ 
]
∞∞  
,
∞∞  !"
SecureStorageFailure
∞∞" 6
>
∞∞6 7
.
∞∞7 8
Ok
∞∞8 :
(
∞∞: ;
data
∞∞; ?
)
∞∞? @
;
∞∞@ A
}
±± 	

ZeroBuffer
≥≥ 
(
≥≥ 
data
≥≥ 
)
≥≥ 
;
≥≥ 
return
¥¥ 
Result
¥¥ 
<
¥¥ 
byte
¥¥ 
[
¥¥ 
]
¥¥ 
,
¥¥ "
SecureStorageFailure
¥¥ 2
>
¥¥2 3
.
¥¥3 4
Err
¥¥4 7
(
¥¥7 8
new
µµ "
SecureStorageFailure
µµ $
(
µµ$ %&
ApplicationErrorMessages
∂∂ (
.
∂∂( )(
SecureProtocolStateStorage
∂∂) C
.
∂∂C D%
TAMPERED_STATE_DETECTED
∂∂D [
)
∂∂[ \
)
∂∂\ ]
;
∂∂] ^
}
∑∑ 
private
ππ 
async
ππ 
Task
ππ 
<
ππ 
byte
ππ 
[
ππ 
]
ππ 
>
ππ 
GetHmacKeyAsync
ππ .
(
ππ. /
)
ππ/ 0
{
∫∫ 
byte
ªª 
[
ªª 
]
ªª 
?
ªª 
cached
ªª 
=
ªª 
Volatile
ªª !
.
ªª! "
Read
ªª" &
(
ªª& '
ref
ªª' *
_cachedHmacKey
ªª+ 9
)
ªª9 :
;
ªª: ;
if
ºº 

(
ºº 
cached
ºº 
!=
ºº 
null
ºº 
)
ºº 
{
ΩΩ 	
return
ææ 
cached
ææ 
;
ææ 
}
øø 	
byte
¡¡ 
[
¡¡ 
]
¡¡ 
newKey
¡¡ 
=
¡¡ 
await
¡¡ 
_platformProvider
¡¡ /
.
¡¡/ 0%
GetOrCreateHmacKeyAsync
¡¡0 G
(
¡¡G H
)
¡¡H I
.
¡¡I J
ConfigureAwait
¡¡J X
(
¡¡X Y
false
¡¡Y ^
)
¡¡^ _
;
¡¡_ `
byte
¬¬ 
[
¬¬ 
]
¬¬ 
?
¬¬ 
existing
¬¬ 
=
¬¬ 
Interlocked
¬¬ &
.
¬¬& '
CompareExchange
¬¬' 6
(
¬¬6 7
ref
¬¬7 :
_cachedHmacKey
¬¬; I
,
¬¬I J
newKey
¬¬K Q
,
¬¬Q R
null
¬¬S W
)
¬¬W X
;
¬¬X Y
if
ƒƒ 

(
ƒƒ 
existing
ƒƒ 
!=
ƒƒ 
null
ƒƒ 
)
ƒƒ 
{
≈≈ 	

ZeroBuffer
∆∆ 
(
∆∆ 
newKey
∆∆ 
)
∆∆ 
;
∆∆ 
return
«« 
existing
«« 
;
«« 
}
»» 	
return
   
newKey
   
;
   
}
ÀÀ 
private
ÕÕ 
async
ÕÕ 
Task
ÕÕ 
<
ÕÕ 
Option
ÕÕ 
<
ÕÕ 
byte
ÕÕ "
[
ÕÕ" #
]
ÕÕ# $
>
ÕÕ$ %
>
ÕÕ% &!
ReadSecureFileAsync
ÕÕ' :
(
ÕÕ: ;
string
ÕÕ; A
filePath
ÕÕB J
)
ÕÕJ K
{
ŒŒ 
return
œœ 
File
œœ 
.
œœ 
Exists
œœ 
(
œœ 
filePath
œœ #
)
œœ# $
?
–– 
Option
–– 
<
–– 
byte
–– 
[
–– 
]
–– 
>
–– 
.
–– 
Some
–– !
(
––! "
await
––" '
File
––( ,
.
––, -
ReadAllBytesAsync
––- >
(
––> ?
filePath
––? G
)
––G H
.
––H I
ConfigureAwait
––I W
(
––W X
false
––X ]
)
––] ^
)
––^ _
:
—— 
Option
—— 
<
—— 
byte
—— 
[
—— 
]
—— 
>
—— 
.
—— 
None
—— !
;
——! "
}
““ 
private
‘‘ 
static
‘‘ 
async
‘‘ 
Task
‘‘ "
WriteSecureFileAsync
‘‘ 2
(
‘‘2 3
byte
‘‘3 7
[
‘‘7 8
]
‘‘8 9
data
‘‘: >
,
‘‘> ?
string
‘‘@ F
filePath
‘‘G O
)
‘‘O P
{
’’ 
string
÷÷ 
?
÷÷ 
	directory
÷÷ 
=
÷÷ 
Path
÷÷  
.
÷÷  !
GetDirectoryName
÷÷! 1
(
÷÷1 2
filePath
÷÷2 :
)
÷÷: ;
;
÷÷; <
if
◊◊ 

(
◊◊ 
!
◊◊ 
string
◊◊ 
.
◊◊ 
IsNullOrEmpty
◊◊ !
(
◊◊! "
	directory
◊◊" +
)
◊◊+ ,
)
◊◊, -
{
ÿÿ 	
DirectoryInfo
ŸŸ 
directoryInfo
ŸŸ '
=
ŸŸ( )
	Directory
ŸŸ* 3
.
ŸŸ3 4
CreateDirectory
ŸŸ4 C
(
ŸŸC D
	directory
ŸŸD M
)
ŸŸM N
;
ŸŸN O
if
€€ 
(
€€ 
!
€€  
RuntimeInformation
€€ #
.
€€# $
IsOSPlatform
€€$ 0
(
€€0 1

OSPlatform
€€1 ;
.
€€; <
Windows
€€< C
)
€€C D
)
€€D E
{
‹‹ 
File
›› 
.
›› 
SetUnixFileMode
›› $
(
››$ %
directoryInfo
››% 2
.
››2 3
FullName
››3 ;
,
››; <
UnixFileMode
ﬁﬁ  
.
ﬁﬁ  !
UserRead
ﬁﬁ! )
|
ﬁﬁ* +
UnixFileMode
ﬁﬁ, 8
.
ﬁﬁ8 9
	UserWrite
ﬁﬁ9 B
|
ﬁﬁC D
UnixFileMode
ﬁﬁE Q
.
ﬁﬁQ R
UserExecute
ﬁﬁR ]
)
ﬁﬁ] ^
;
ﬁﬁ^ _
}
ﬂﬂ 
}
‡‡ 	
string
‚‚ 
tempPath
‚‚ 
=
‚‚ 
$"
‚‚ 
{
‚‚ 
filePath
‚‚ %
}
‚‚% &
$str
‚‚& +
{
‚‚+ ,
Guid
‚‚, 0
.
‚‚0 1
NewGuid
‚‚1 8
(
‚‚8 9
)
‚‚9 :
:
‚‚: ;
$str
‚‚; <
}
‚‚< =
"
‚‚= >
;
‚‚> ?
try
‰‰ 
{
ÂÂ 	
await
ÊÊ 
File
ÊÊ 
.
ÊÊ  
WriteAllBytesAsync
ÊÊ )
(
ÊÊ) *
tempPath
ÊÊ* 2
,
ÊÊ2 3
data
ÊÊ4 8
)
ÊÊ8 9
.
ÊÊ9 :
ConfigureAwait
ÊÊ: H
(
ÊÊH I
false
ÊÊI N
)
ÊÊN O
;
ÊÊO P
if
ËË 
(
ËË 
!
ËË  
RuntimeInformation
ËË #
.
ËË# $
IsOSPlatform
ËË$ 0
(
ËË0 1

OSPlatform
ËË1 ;
.
ËË; <
Windows
ËË< C
)
ËËC D
)
ËËD E
{
ÈÈ 
File
ÍÍ 
.
ÍÍ 
SetUnixFileMode
ÍÍ $
(
ÍÍ$ %
tempPath
ÍÍ% -
,
ÍÍ- .
UnixFileMode
ÍÍ/ ;
.
ÍÍ; <
UserRead
ÍÍ< D
|
ÍÍE F
UnixFileMode
ÍÍG S
.
ÍÍS T
	UserWrite
ÍÍT ]
)
ÍÍ] ^
;
ÍÍ^ _
}
ÎÎ 
File
ÌÌ 
.
ÌÌ 
Move
ÌÌ 
(
ÌÌ 
tempPath
ÌÌ 
,
ÌÌ 
filePath
ÌÌ  (
,
ÌÌ( )
	overwrite
ÌÌ* 3
:
ÌÌ3 4
true
ÌÌ5 9
)
ÌÌ9 :
;
ÌÌ: ;
}
ÓÓ 	
catch
ÔÔ 
{
 	
if
ÒÒ 
(
ÒÒ 
!
ÒÒ 
File
ÒÒ 
.
ÒÒ 
Exists
ÒÒ 
(
ÒÒ 
tempPath
ÒÒ %
)
ÒÒ% &
)
ÒÒ& '
{
ÚÚ 
throw
ÛÛ 
;
ÛÛ 
}
ÙÙ 
try
ˆˆ 
{
˜˜ 
File
¯¯ 
.
¯¯ 
Delete
¯¯ 
(
¯¯ 
tempPath
¯¯ $
)
¯¯$ %
;
¯¯% &
}
˘˘ 
catch
˙˙ 
{
˚˚ 
}
˝˝ 
throw
ˇˇ 
;
ˇˇ 
}
ÄÄ 	
}
ÅÅ 
private
ÉÉ 
static
ÉÉ 
async
ÉÉ 
Task
ÉÉ %
DeleteFileIfExistsAsync
ÉÉ 5
(
ÉÉ5 6
string
ÉÉ6 <
filePath
ÉÉ= E
,
ÉÉE F
int
ÉÉG J

maxRetries
ÉÉK U
=
ÉÉV W
$num
ÉÉX Y
)
ÉÉY Z
{
ÑÑ 
if
ÖÖ 

(
ÖÖ 
!
ÖÖ 
File
ÖÖ 
.
ÖÖ 
Exists
ÖÖ 
(
ÖÖ 
filePath
ÖÖ !
)
ÖÖ! "
)
ÖÖ" #
{
ÜÜ 	
return
áá 
;
áá 
}
àà 	
for
ää 
(
ää 
int
ää 
attempt
ää 
=
ää 
$num
ää 
;
ää 
attempt
ää %
<=
ää& (

maxRetries
ää) 3
;
ää3 4
attempt
ää5 <
++
ää< >
)
ää> ?
{
ãã 	
try
åå 
{
çç 
FileAttributes
éé 

attributes
éé )
=
éé* +
File
éé, 0
.
éé0 1
GetAttributes
éé1 >
(
éé> ?
filePath
éé? G
)
ééG H
;
ééH I
if
èè 
(
èè 

attributes
èè 
.
èè 
HasFlag
èè &
(
èè& '
FileAttributes
èè' 5
.
èè5 6
ReadOnly
èè6 >
)
èè> ?
)
èè? @
{
êê 
File
ëë 
.
ëë 
SetAttributes
ëë &
(
ëë& '
filePath
ëë' /
,
ëë/ 0

attributes
ëë1 ;
&
ëë< =
~
ëë> ?
FileAttributes
ëë? M
.
ëëM N
ReadOnly
ëëN V
)
ëëV W
;
ëëW X
}
íí 
File
îî 
.
îî 
Delete
îî 
(
îî 
filePath
îî $
)
îî$ %
;
îî% &
return
ïï 
;
ïï 
}
ññ 
catch
óó 
(
óó 
IOException
óó 
)
óó 
when
óó  $
(
óó% &
attempt
óó& -
<
óó. /

maxRetries
óó0 :
)
óó: ;
{
òò 
await
ôô 
Task
ôô 
.
ôô 
Delay
ôô  
(
ôô  !

RetryDelay
ôô! +
(
ôô+ ,
attempt
ôô, 3
)
ôô3 4
)
ôô4 5
.
ôô5 6
ConfigureAwait
ôô6 D
(
ôôD E
false
ôôE J
)
ôôJ K
;
ôôK L
}
öö 
catch
õõ 
(
õõ )
UnauthorizedAccessException
õõ .
)
õõ. /
when
õõ0 4
(
õõ5 6
attempt
õõ6 =
<
õõ> ?

maxRetries
õõ@ J
)
õõJ K
{
úú 
await
ùù 
Task
ùù 
.
ùù 
Delay
ùù  
(
ùù  !

RetryDelay
ùù! +
(
ùù+ ,
attempt
ùù, 3
)
ùù3 4
)
ùù4 5
.
ùù5 6
ConfigureAwait
ùù6 D
(
ùùD E
false
ùùE J
)
ùùJ K
;
ùùK L
}
ûû 
}
üü 	
if
°° 

(
°° 
!
°° 
File
°° 
.
°° 
Exists
°° 
(
°° 
filePath
°° !
)
°°! "
)
°°" #
{
¢¢ 	
return
££ 
;
££ 
}
§§ 	
FileAttributes
¶¶ 
finalAttributes
¶¶ &
=
¶¶' (
File
¶¶) -
.
¶¶- .
GetAttributes
¶¶. ;
(
¶¶; <
filePath
¶¶< D
)
¶¶D E
;
¶¶E F
if
ßß 

(
ßß 
finalAttributes
ßß 
.
ßß 
HasFlag
ßß #
(
ßß# $
FileAttributes
ßß$ 2
.
ßß2 3
ReadOnly
ßß3 ;
)
ßß; <
)
ßß< =
{
®® 	
File
©© 
.
©© 
SetAttributes
©© 
(
©© 
filePath
©© '
,
©©' (
finalAttributes
©©) 8
&
©©9 :
~
©©; <
FileAttributes
©©< J
.
©©J K
ReadOnly
©©K S
)
©©S T
;
©©T U
}
™™ 	
File
¨¨ 
.
¨¨ 
Delete
¨¨ 
(
¨¨ 
filePath
¨¨ 
)
¨¨ 
;
¨¨ 
}
≠≠ 
private
ØØ 
async
ØØ 
Task
ØØ 
<
ØØ 
Option
ØØ 
<
ØØ 
byte
ØØ "
[
ØØ" #
]
ØØ# $
>
ØØ$ %
>
ØØ% &"
TryGetStoredKeyAsync
ØØ' ;
(
ØØ; <
string
ØØ< B
keychainKey
ØØC N
)
ØØN O
{
∞∞ 
byte
±± 
[
±± 
]
±± 
?
±± 
key
±± 
=
±± 
await
±± 
_platformProvider
±± -
.
±±- .%
GetKeyFromKeychainAsync
±±. E
(
±±E F
keychainKey
±±F Q
)
±±Q R
.
±±R S
ConfigureAwait
±±S a
(
±±a b
false
±±b g
)
±±g h
;
±±h i
return
≤≤ 
Option
≤≤ 
<
≤≤ 
byte
≤≤ 
[
≤≤ 
]
≤≤ 
>
≤≤ 
.
≤≤ 
From
≤≤ "
(
≤≤" #
key
≤≤# &
)
≤≤& '
;
≤≤' (
}
≥≥ 
private
µµ 
async
µµ 
Task
µµ $
CleanupFailedSaveAsync
µµ -
(
µµ- .
string
µµ. 4
storagePath
µµ5 @
,
µµ@ A
string
µµB H
keychainKey
µµI T
)
µµT U
{
∂∂ 
try
∑∑ 
{
∏∏ 	
await
ππ %
DeleteFileIfExistsAsync
ππ )
(
ππ) *
storagePath
ππ* 5
)
ππ5 6
.
ππ6 7
ConfigureAwait
ππ7 E
(
ππE F
false
ππF K
)
ππK L
;
ππL M
}
∫∫ 	
catch
ªª 
{
ºº 	
}
ææ 	
try
¿¿ 
{
¡¡ 	
await
¬¬ 
_platformProvider
¬¬ #
.
¬¬# $(
DeleteKeyFromKeychainAsync
¬¬$ >
(
¬¬> ?
keychainKey
¬¬? J
)
¬¬J K
.
¬¬K L
ConfigureAwait
¬¬L Z
(
¬¬Z [
false
¬¬[ `
)
¬¬` a
;
¬¬a b
}
√√ 	
catch
ƒƒ 
{
≈≈ 	
}
«« 	
}
»» 
private
   
async
   
Task
   
<
   
(
   
byte
   
[
   
]
   
Key
   "
,
  " #
byte
  $ (
[
  ( )
]
  ) *
Salt
  + /
)
  / 0
>
  0 1
DeriveKeyAsync
  2 @
(
  @ A
byte
  A E
[
  E F
]
  F G
membershipId
  H T
)
  T U
{
ÀÀ 
byte
ÃÃ 
[
ÃÃ 
]
ÃÃ 
salt
ÃÃ 
=
ÃÃ 
await
ÃÃ 
_platformProvider
ÃÃ -
.
ÃÃ- .'
GenerateSecureRandomAsync
ÃÃ. G
(
ÃÃG H$
SecureStorageConstants
ÃÃH ^
.
ÃÃ^ _

Encryption
ÃÃ_ i
.
ÃÃi j
	SALT_SIZE
ÃÃj s
)
ÃÃs t
.
ÕÕ 
ConfigureAwait
ÕÕ 
(
ÕÕ 
false
ÕÕ !
)
ÕÕ! "
;
ÕÕ" #
(
œœ 	
byte
œœ	 
[
œœ 
]
œœ 
key
œœ 
,
œœ 
byte
œœ 
[
œœ 
]
œœ 
_
œœ 
)
œœ 
=
œœ  
await
œœ! &$
DeriveKeyWithSaltAsync
œœ' =
(
œœ= >
membershipId
œœ> J
,
œœJ K
salt
œœL P
)
œœP Q
.
œœQ R
ConfigureAwait
œœR `
(
œœ` a
false
œœa f
)
œœf g
;
œœg h
return
–– 
(
–– 
key
–– 
,
–– 
salt
–– 
)
–– 
;
–– 
}
—— 
private
”” 
async
”” 
Task
”” 
<
”” 
(
”” 
byte
”” 
[
”” 
]
”” 
Key
”” "
,
””" #
byte
””$ (
[
””( )
]
””) *
Salt
””+ /
)
””/ 0
>
””0 1$
DeriveKeyWithSaltAsync
””2 H
(
””H I
byte
””I M
[
””M N
]
””N O
membershipId
””P \
,
””\ ]
byte
””^ b
[
””b c
]
””c d
salt
””e i
)
””i j
{
‘‘ 
using
’’ 
Argon2id
’’ 
argon2
’’ 
=
’’ 
new
’’  #
(
’’# $
membershipId
’’$ 0
)
’’0 1
{
÷÷ 	
Salt
◊◊ 
=
◊◊ 
salt
◊◊ 
,
◊◊ !
DegreeOfParallelism
ÿÿ 
=
ÿÿ  !$
SecureStorageConstants
ÿÿ" 8
.
ÿÿ8 9
Argon2
ÿÿ9 ?
.
ÿÿ? @
PARALLELISM
ÿÿ@ K
,
ÿÿK L

Iterations
ŸŸ 
=
ŸŸ $
SecureStorageConstants
ŸŸ /
.
ŸŸ/ 0
Argon2
ŸŸ0 6
.
ŸŸ6 7

ITERATIONS
ŸŸ7 A
,
ŸŸA B

MemorySize
⁄⁄ 
=
⁄⁄ $
SecureStorageConstants
⁄⁄ /
.
⁄⁄/ 0
Argon2
⁄⁄0 6
.
⁄⁄6 7
MEMORY_SIZE
⁄⁄7 B
,
⁄⁄B C
AssociatedData
€€ 
=
€€ 
	_deviceId
€€ &
}
‹‹ 	
;
‹‹	 

byte
ﬁﬁ 
[
ﬁﬁ 
]
ﬁﬁ 
key
ﬁﬁ 
=
ﬁﬁ 
await
ﬁﬁ 
argon2
ﬁﬁ !
.
ﬁﬁ! "
GetBytesAsync
ﬁﬁ" /
(
ﬁﬁ/ 0$
SecureStorageConstants
ﬁﬁ0 F
.
ﬁﬁF G

Encryption
ﬁﬁG Q
.
ﬁﬁQ R
KEY_SIZE
ﬁﬁR Z
)
ﬁﬁZ [
.
ﬁﬁ[ \
ConfigureAwait
ﬁﬁ\ j
(
ﬁﬁj k
false
ﬁﬁk p
)
ﬁﬁp q
;
ﬁﬁq r
return
ﬂﬂ 
(
ﬂﬂ 
key
ﬂﬂ 
,
ﬂﬂ 
salt
ﬂﬂ 
)
ﬂﬂ 
;
ﬂﬂ 
}
‡‡ 
private
‚‚ 
void
‚‚ )
EnsureSecureDirectoryExists
‚‚ ,
(
‚‚, -
)
‚‚- .
{
„„ 
DirectoryInfo
‰‰ 
	directory
‰‰ 
=
‰‰  !
	Directory
‰‰" +
.
‰‰+ ,
CreateDirectory
‰‰, ;
(
‰‰; <
_storageDirectory
‰‰< M
)
‰‰M N
;
‰‰N O
if
ÊÊ 

(
ÊÊ 
!
ÊÊ  
RuntimeInformation
ÊÊ 
.
ÊÊ  
IsOSPlatform
ÊÊ  ,
(
ÊÊ, -

OSPlatform
ÊÊ- 7
.
ÊÊ7 8
Windows
ÊÊ8 ?
)
ÊÊ? @
)
ÊÊ@ A
{
ÁÁ 	
File
ËË 
.
ËË 
SetUnixFileMode
ËË  
(
ËË  !
	directory
ËË! *
.
ËË* +
FullName
ËË+ 3
,
ËË3 4
UnixFileMode
ÈÈ 
.
ÈÈ 
UserRead
ÈÈ %
|
ÈÈ& '
UnixFileMode
ÈÈ( 4
.
ÈÈ4 5
	UserWrite
ÈÈ5 >
|
ÈÈ? @
UnixFileMode
ÈÈA M
.
ÈÈM N
UserExecute
ÈÈN Y
)
ÈÈY Z
;
ÈÈZ [
}
ÍÍ 	
}
ÎÎ 
private
ÌÌ 
bool
ÌÌ "
TryEnsureNotDisposed
ÌÌ %
(
ÌÌ% &
out
ÌÌ& )"
SecureStorageFailure
ÌÌ* >
?
ÌÌ> ?
failure
ÌÌ@ G
)
ÌÌG H
{
ÓÓ 
if
ÔÔ 

(
ÔÔ 
	_disposed
ÔÔ 
)
ÔÔ 
{
 	
failure
ÒÒ 
=
ÒÒ 
new
ÒÒ "
SecureStorageFailure
ÒÒ .
(
ÒÒ. /&
ApplicationErrorMessages
ÒÒ/ G
.
ÒÒG H(
SecureProtocolStateStorage
ÒÒH b
.
ÒÒb c
STORAGE_DISPOSED
ÒÒc s
)
ÒÒs t
;
ÒÒt u
return
ÚÚ 
false
ÚÚ 
;
ÚÚ 
}
ÛÛ 	
failure
ıı 
=
ıı 
null
ıı 
;
ıı 
return
ˆˆ 
true
ˆˆ 
;
ˆˆ 
}
˜˜ 
private
˘˘ 
static
˘˘ 
void
˘˘ 
WriteSegment
˘˘ $
(
˘˘$ %
ReadOnlySpan
˘˘% 1
<
˘˘1 2
byte
˘˘2 6
>
˘˘6 7
value
˘˘8 =
,
˘˘= >
ref
˘˘? B
Span
˘˘C G
<
˘˘G H
byte
˘˘H L
>
˘˘L M
destination
˘˘N Y
)
˘˘Y Z
{
˙˙ 
BinaryPrimitives
˚˚ 
.
˚˚ $
WriteInt32LittleEndian
˚˚ /
(
˚˚/ 0
destination
˚˚0 ;
,
˚˚; <
value
˚˚= B
.
˚˚B C
Length
˚˚C I
)
˚˚I J
;
˚˚J K
destination
¸¸ 
=
¸¸ 
destination
¸¸ !
[
¸¸! "
sizeof
¸¸" (
(
¸¸( )
int
¸¸) ,
)
¸¸, -
..
¸¸- /
]
¸¸/ 0
;
¸¸0 1
value
˛˛ 
.
˛˛ 
CopyTo
˛˛ 
(
˛˛ 
destination
˛˛  
)
˛˛  !
;
˛˛! "
destination
ˇˇ 
=
ˇˇ 
destination
ˇˇ !
[
ˇˇ! "
value
ˇˇ" '
.
ˇˇ' (
Length
ˇˇ( .
..
ˇˇ. 0
]
ˇˇ0 1
;
ˇˇ1 2
}
ÄÄ 
private
ÇÇ 
static
ÇÇ 
byte
ÇÇ 
[
ÇÇ 
]
ÇÇ 
ReadSegment
ÇÇ %
(
ÇÇ% &
ref
ÇÇ& )
ReadOnlySpan
ÇÇ* 6
<
ÇÇ6 7
byte
ÇÇ7 ;
>
ÇÇ; <
source
ÇÇ= C
)
ÇÇC D
{
ÉÉ 
if
ÑÑ 

(
ÑÑ 
source
ÑÑ 
.
ÑÑ 
Length
ÑÑ 
<
ÑÑ 
sizeof
ÑÑ "
(
ÑÑ" #
int
ÑÑ# &
)
ÑÑ& '
)
ÑÑ' (
{
ÖÖ 	
throw
ÜÜ 
new
ÜÜ '
InvalidOperationException
ÜÜ /
(
ÜÜ/ 0&
ApplicationErrorMessages
áá (
.
áá( )(
SecureProtocolStateStorage
áá) C
.
ááC D&
INVALID_CONTAINER_FORMAT
ááD \
)
áá\ ]
;
áá] ^
}
àà 	
int
ää 
length
ää 
=
ää 
BinaryPrimitives
ää %
.
ää% &#
ReadInt32LittleEndian
ää& ;
(
ää; <
source
ää< B
)
ääB C
;
ääC D
if
ãã 

(
ãã 
length
ãã 
<
ãã 
$num
ãã 
)
ãã 
{
åå 	
throw
çç 
new
çç '
InvalidOperationException
çç /
(
çç/ 0&
ApplicationErrorMessages
éé (
.
éé( )(
SecureProtocolStateStorage
éé) C
.
ééC D&
INVALID_CONTAINER_FORMAT
ééD \
)
éé\ ]
;
éé] ^
}
èè 	
source
ëë 
=
ëë 
source
ëë 
[
ëë 
sizeof
ëë 
(
ëë 
int
ëë "
)
ëë" #
..
ëë# %
]
ëë% &
;
ëë& '
if
íí 

(
íí 
source
íí 
.
íí 
Length
íí 
<
íí 
length
íí "
)
íí" #
{
ìì 	
throw
îî 
new
îî '
InvalidOperationException
îî /
(
îî/ 0&
ApplicationErrorMessages
ïï (
.
ïï( )(
SecureProtocolStateStorage
ïï) C
.
ïïC D&
INVALID_CONTAINER_FORMAT
ïïD \
)
ïï\ ]
;
ïï] ^
}
ññ 	
byte
òò 
[
òò 
]
òò 
result
òò 
=
òò 
source
òò 
[
òò 
..
òò !
length
òò! '
]
òò' (
.
òò( )
ToArray
òò) 0
(
òò0 1
)
òò1 2
;
òò2 3
source
ôô 
=
ôô 
source
ôô 
[
ôô 
length
ôô 
..
ôô  
]
ôô  !
;
ôô! "
return
öö 
result
öö 
;
öö 
}
õõ 
private
ùù 
static
ùù 
int
ùù 
SegmentSize
ùù "
(
ùù" #
int
ùù# &
payloadLength
ùù' 4
)
ùù4 5
=>
ùù6 8
sizeof
ùù9 ?
(
ùù? @
int
ùù@ C
)
ùùC D
+
ùùE F
payloadLength
ùùG T
;
ùùT U
private
üü 
static
üü 
TimeSpan
üü 

RetryDelay
üü &
(
üü& '
int
üü' *
attempt
üü+ 2
)
üü2 3
=>
üü4 6
TimeSpan
üü7 ?
.
üü? @
FromMilliseconds
üü@ P
(
üüP Q
$num
üüQ T
*
üüU V
(
üüW X
attempt
üüX _
+
üü` a
$num
üüb c
)
üüc d
)
üüd e
;
üüe f
private
°° 
static
°° 
void
°° 

ZeroBuffer
°° "
(
°°" #
byte
°°# '
[
°°' (
]
°°( )
?
°°) *
buffer
°°+ 1
)
°°1 2
{
¢¢ 
if
££ 

(
££ 
buffer
££ 
is
££ 
null
££ 
)
££ 
{
§§ 	
return
•• 
;
•• 
}
¶¶ 	%
CryptographicOperations
®® 
.
®®  

ZeroMemory
®®  *
(
®®* +
buffer
®®+ 1
)
®®1 2
;
®®2 3
}
©© 
private
´´ 
readonly
´´ 
record
´´ 
struct
´´ "
SecureContainer
´´# 2
(
´´2 3
byte
¨¨ 
[
¨¨ 
]
¨¨ 
Salt
¨¨ 
,
¨¨ 
byte
≠≠ 
[
≠≠ 
]
≠≠ 
Nonce
≠≠ 
,
≠≠ 
byte
ÆÆ 
[
ÆÆ 
]
ÆÆ 
Tag
ÆÆ 
,
ÆÆ 
byte
ØØ 
[
ØØ 
]
ØØ 

Ciphertext
ØØ 
,
ØØ 
byte
∞∞ 
[
∞∞ 
]
∞∞ 
AssociatedData
∞∞ 
)
∞∞ 
;
∞∞ 
}±± 
public≥≥ 
record
≥≥ "
SecureStorageFailure
≥≥ "
(
≥≥" #
string
≥≥# )
Message
≥≥* 1
)
≥≥1 2
:
≥≥3 4
FailureBase
≥≥5 @
(
≥≥@ A
Message
≥≥A H
)
≥≥H I
{¥¥ 
public
µµ 

override
µµ 
object
µµ 
ToStructuredLog
µµ *
(
µµ* +
)
µµ+ ,
=>
µµ- /
new
µµ0 3
{
µµ4 5
Message
µµ6 =
,
µµ= >
Type
µµ? C
=
µµD E
$str
µµF \
}
µµ] ^
;
µµ^ _
public
∑∑ 

override
∑∑ !
GrpcErrorDescriptor
∑∑ '
ToGrpcDescriptor
∑∑( 8
(
∑∑8 9
)
∑∑9 :
=>
∑∑; =
new
∏∏ 
(
∏∏ 
	ErrorCode
∏∏ 
.
∏∏ 
INTERNAL_ERROR
∏∏ $
,
∏∏$ %

StatusCode
∏∏& 0
.
∏∏0 1
Internal
∏∏1 9
,
∏∏9 :
ErrorI18nKeys
∏∏; H
.
∏∏H I
INTERNAL
∏∏I Q
)
∏∏Q R
;
∏∏R S
}ππ ⁄
ï/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Authentication/IAuthenticationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Authentication. <
;< =
public		 
	interface		 "
IAuthenticationService		 '
{

 
Task 
< 	
Result	 
< 
Unit 
, !
AuthenticationFailure +
>+ ,
>, -
SignInAsync. 9
(9 :
string: @
mobileNumberA M
,M N
SecureTextBufferO _
	secureKey` i
,i j
uintk o
	connectIdp y
,y z
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
} åÂ
ò/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Platform/CrossPlatformSecurityProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Platform0 8
;8 9
internal 
sealed	 
class )
CrossPlatformSecurityProvider 3
:4 5%
IPlatformSecurityProvider6 O
{ 
private 
const 
int 
AES_KEY_SIZE "
=# $
$num% '
;' (
private 
const 
int 
AES_IV_SIZE !
=" #
$num$ &
;& '
private 
const 
int 
HMAC_KEY_SIZE #
=$ %
$num& (
;( )
private 
const 
int 
PBKDF_2_ITERATIONS (
=) *
$num+ 1
;1 2
private 
const 
int !
SECURE_OVERWRITE_SIZE +
=, -
$num. 2
;2 3
private 
const 
string 
MACHINE_KEY_SALT )
=* +
$str, @
;@ A
private 
const 
string 
HMAC_KEY_IDENTIFIER ,
=- .
$str/ B
;B C
private 
const 
string  
MACHINE_KEY_FILENAME -
=. /
$str0 >
;> ?
private 
const 
string 
KEYCHAIN_FOLDER (
=) *
$str+ 6
;6 7
private 
const 
string 
TPM_REGISTRY_PATH *
=+ ,
$str- V
;V W
private 
const 
string !
LINUX_MACHINE_ID_PATH .
=/ 0
$str1 B
;B C
private 
const 
string 
LINUX_TPM_PATH '
=( )
$str* 5
;5 6
private 
const 
string 
LINUX_TPMRM_PATH )
=* +
$str, 9
;9 :
private   
const   
string   
MACOS_UUID_PATTERN   +
=  , -
$str  . T
;  T U
private"" 
readonly"" 
string"" 
_keychainPath"" )
;"") *
private## 
readonly## 
Lock## 
_lockObject## %
=##& '
new##( +
(##+ ,
)##, -
;##- .
private%% 
byte%% 
[%% 
]%% 
?%% 
_cachedMachineKey%% %
;%%% &
private&& 
byte&& 
[&& 
]&& 
?&& 
_cachedHmacKey&& "
;&&" #
public(( 
)
CrossPlatformSecurityProvider(( (
(((( )
string(() /
appDataPath((0 ;
)((; <
{)) 
_keychainPath** 
=** 
Path** 
.** 
Combine** $
(**$ %
appDataPath**% 0
,**0 1
KEYCHAIN_FOLDER**2 A
)**A B
;**B C
InitializeKeychain++ 
(++ 
)++ 
;++ 
},, 
private.. 
void.. 
InitializeKeychain.. #
(..# $
)..$ %
{// 
if00 

(00 
	Directory00 
.00 
Exists00 
(00 
_keychainPath00 *
)00* +
)00+ ,
{11 	
return22 
;22 
}33 	
	Directory55 
.55 
CreateDirectory55 !
(55! "
_keychainPath55" /
)55/ 0
;550 1
if77 

(77 
!77 
RuntimeInformation77 
.77  
IsOSPlatform77  ,
(77, -

OSPlatform77- 7
.777 8
Windows778 ?
)77? @
)77@ A
{88 	
File99 
.99 
SetUnixFileMode99  
(99  !
_keychainPath99! .
,99. /
UnixFileMode:: 
.:: 
UserRead:: %
|::& '
UnixFileMode::( 4
.::4 5
	UserWrite::5 >
|::? @
UnixFileMode::A M
.::M N
UserExecute::N Y
)::Y Z
;::Z [
};; 	
}<< 
public>> 

async>> 
Task>> 
<>> 
byte>> 
[>> 
]>> 
>>> %
GenerateSecureRandomAsync>> 7
(>>7 8
int>>8 ;
length>>< B
)>>B C
{?? 
return@@ 
await@@ 
Task@@ 
.@@ 
Run@@ 
(@@ 
(@@ 
)@@  
=>@@! #
{AA 	
tryBB 
{CC 
byteDD 
[DD 
]DD 
bytesDD 
=DD !
RandomNumberGeneratorDD 4
.DD4 5
GetBytesDD5 =
(DD= >
lengthDD> D
)DDD E
;DDE F
ifFF 
(FF 
RuntimeInformationFF &
.FF& '
IsOSPlatformFF' 3
(FF3 4

OSPlatformFF4 >
.FF> ?
LinuxFF? D
)FFD E
)FFE F
{GG (
TryEnhanceWithHardwareRandomHH 0
(HH0 1
bytesHH1 6
)HH6 7
;HH7 8
}II 
returnKK 
bytesKK 
;KK 
}LL 
catchMM 
(MM 
	ExceptionMM 
)MM 
{NN 
returnOO !
RandomNumberGeneratorOO ,
.OO, -
GetBytesOO- 5
(OO5 6
lengthOO6 <
)OO< =
;OO= >
}PP 
}QQ 	
)QQ	 

;QQ
 
}RR 
publicTT 

asyncTT 
TaskTT #
StoreKeyInKeychainAsyncTT -
(TT- .
stringTT. 4

identifierTT5 ?
,TT? @
byteTTA E
[TTE F
]TTF G
keyTTH K
)TTK L
{UU 
awaitVV 
TaskVV 
.VV 
RunVV 
(VV 
(VV 
)VV 
=>VV 
{WW 	
lockXX 
(XX 
_lockObjectXX 
)XX 
{YY 
tryZZ 
{[[ 
Result\\ 
<\\ 
Unit\\ 
,\\   
SecureStorageFailure\\! 5
>\\5 6
result\\7 =
=\\> ?
GetPlatformStore\\@ P
(\\P Q

identifier\\Q [
,\\[ \
key\\] `
)\\` a
;\\a b
if]] 
(]] 
result]] 
.]] 
IsErr]] $
)]]$ %
{^^  
StoreInEncryptedFile__ ,
(__, -

identifier__- 7
,__7 8
key__9 <
)__< =
;__= >
}`` 
}aa 
catchbb 
(bb 
	Exceptionbb  
)bb  !
{cc  
StoreInEncryptedFiledd (
(dd( )

identifierdd) 3
,dd3 4
keydd5 8
)dd8 9
;dd9 :
}ee 
}ff 
}gg 	
)gg	 

;gg
 
}hh 
privatejj 
Resultjj 
<jj 
Unitjj 
,jj  
SecureStorageFailurejj -
>jj- .
GetPlatformStorejj/ ?
(jj? @
stringjj@ F

identifierjjG Q
,jjQ R
bytejjS W
[jjW X
]jjX Y
keyjjZ ]
)jj] ^
{kk 
ifll 

(ll 
RuntimeInformationll 
.ll 
IsOSPlatformll +
(ll+ ,

OSPlatformll, 6
.ll6 7
Windowsll7 >
)ll> ?
)ll? @
{mm 	
returnnn +
StoreInWindowsCredentialManagernn 2
(nn2 3

identifiernn3 =
,nn= >
keynn? B
)nnB C
;nnC D
}oo 	
ifqq 

(qq 
RuntimeInformationqq 
.qq 
IsOSPlatformqq +
(qq+ ,

OSPlatformqq, 6
.qq6 7
OSXqq7 :
)qq: ;
)qq; <
{rr 	
returnss  
StoreInMacOsKeychainss '
(ss' (

identifierss( 2
,ss2 3
keyss4 7
)ss7 8
;ss8 9
}tt 	
returnvv 
RuntimeInformationvv !
.vv! "
IsOSPlatformvv" .
(vv. /

OSPlatformvv/ 9
.vv9 :
Linuxvv: ?
)vv? @
?ww %
StoreInLinuxSecretServiceww '
(ww' (

identifierww( 2
,ww2 3
keyww4 7
)ww7 8
:xx  
StoreInEncryptedFilexx "
(xx" #

identifierxx# -
,xx- .
keyxx/ 2
)xx2 3
;xx3 4
}yy 
public{{ 

async{{ 
Task{{ 
<{{ 
byte{{ 
[{{ 
]{{ 
?{{ 
>{{ #
GetKeyFromKeychainAsync{{ 6
({{6 7
string{{7 =

identifier{{> H
){{H I
{|| 
return}} 
await}} 
Task}} 
.}} 
Run}} 
(}} 
(}} 
)}}  
=>}}! #
{~~ 	
lock 
( 
_lockObject 
) 
{
ÄÄ 
try
ÅÅ 
{
ÇÇ 
Result
ÉÉ 
<
ÉÉ 
byte
ÉÉ 
[
ÉÉ  
]
ÉÉ  !
,
ÉÉ! ""
SecureStorageFailure
ÉÉ# 7
>
ÉÉ7 8
result
ÉÉ9 ?
=
ÉÉ@ A!
GetPlatformRetrieve
ÉÉB U
(
ÉÉU V

identifier
ÉÉV `
)
ÉÉ` a
;
ÉÉa b
if
ÑÑ 
(
ÑÑ 
!
ÑÑ 
result
ÑÑ 
.
ÑÑ  
IsErr
ÑÑ  %
)
ÑÑ% &
{
ÖÖ 
return
ÜÜ 
result
ÜÜ %
.
ÜÜ% &
IsOk
ÜÜ& *
?
ÜÜ+ ,
result
ÜÜ- 3
.
ÜÜ3 4
Unwrap
ÜÜ4 :
(
ÜÜ: ;
)
ÜÜ; <
:
ÜÜ= >
null
ÜÜ? C
;
ÜÜC D
}
áá 
Result
ââ 
<
ââ 
byte
ââ 
[
ââ  
]
ââ  !
,
ââ! ""
SecureStorageFailure
ââ# 7
>
ââ7 8

fileResult
ââ9 C
=
ââD E"
GetFromEncryptedFile
ââF Z
(
ââZ [

identifier
ââ[ e
)
ââe f
;
ââf g
return
ää 

fileResult
ää %
.
ää% &
IsOk
ää& *
?
ää+ ,

fileResult
ää- 7
.
ää7 8
Unwrap
ää8 >
(
ää> ?
)
ää? @
:
ääA B
null
ääC G
;
ääG H
}
ãã 
catch
åå 
(
åå 
	Exception
åå  
)
åå  !
{
çç 
Result
éé 
<
éé 
byte
éé 
[
éé  
]
éé  !
,
éé! ""
SecureStorageFailure
éé# 7
>
éé7 8

fileResult
éé9 C
=
ééD E"
GetFromEncryptedFile
ééF Z
(
ééZ [

identifier
éé[ e
)
éée f
;
ééf g
return
èè 

fileResult
èè %
.
èè% &
IsOk
èè& *
?
èè+ ,

fileResult
èè- 7
.
èè7 8
Unwrap
èè8 >
(
èè> ?
)
èè? @
:
èèA B
null
èèC G
;
èèG H
}
êê 
}
ëë 
}
íí 	
)
íí	 

;
íí
 
}
ìì 
private
ïï 
Result
ïï 
<
ïï 
byte
ïï 
[
ïï 
]
ïï 
,
ïï "
SecureStorageFailure
ïï /
>
ïï/ 0!
GetPlatformRetrieve
ïï1 D
(
ïïD E
string
ïïE K

identifier
ïïL V
)
ïïV W
{
ññ 
if
óó 

(
óó  
RuntimeInformation
óó 
.
óó 
IsOSPlatform
óó +
(
óó+ ,

OSPlatform
óó, 6
.
óó6 7
Windows
óó7 >
)
óó> ?
)
óó? @
{
òò 	
return
ôô -
GetFromWindowsCredentialManager
ôô 2
(
ôô2 3

identifier
ôô3 =
)
ôô= >
;
ôô> ?
}
öö 	
if
úú 

(
úú  
RuntimeInformation
úú 
.
úú 
IsOSPlatform
úú +
(
úú+ ,

OSPlatform
úú, 6
.
úú6 7
OSX
úú7 :
)
úú: ;
)
úú; <
{
ùù 	
return
ûû "
GetFromMacOsKeychain
ûû '
(
ûû' (

identifier
ûû( 2
)
ûû2 3
;
ûû3 4
}
üü 	
return
°°  
RuntimeInformation
°° !
.
°°! "
IsOSPlatform
°°" .
(
°°. /

OSPlatform
°°/ 9
.
°°9 :
Linux
°°: ?
)
°°? @
?
¢¢ '
GetFromLinuxSecretService
¢¢ '
(
¢¢' (

identifier
¢¢( 2
)
¢¢2 3
:
££ "
GetFromEncryptedFile
££ "
(
££" #

identifier
££# -
)
££- .
;
££. /
}
§§ 
public
¶¶ 

async
¶¶ 
Task
¶¶ (
DeleteKeyFromKeychainAsync
¶¶ 0
(
¶¶0 1
string
¶¶1 7

identifier
¶¶8 B
)
¶¶B C
{
ßß 
await
®® 
Task
®® 
.
®® 
Run
®® 
(
®® 
(
®® 
)
®® 
=>
®® 
{
©© 	
lock
™™ 
(
™™ 
_lockObject
™™ 
)
™™ 
{
´´ 
string
¨¨ 
keyFile
¨¨ 
=
¨¨  
GetKeyFilePath
¨¨! /
(
¨¨/ 0

identifier
¨¨0 :
)
¨¨: ;
;
¨¨; <
try
≠≠ 
{
ÆÆ 
if
ØØ 
(
ØØ 
!
ØØ 
File
ØØ 
.
ØØ 
Exists
ØØ $
(
ØØ$ %
keyFile
ØØ% ,
)
ØØ, -
)
ØØ- .
{
∞∞ 
return
±± 
;
±± 
}
≤≤ 
byte
µµ 
[
µµ 
]
µµ 

randomData
µµ %
=
µµ& '#
RandomNumberGenerator
µµ( =
.
µµ= >
GetBytes
µµ> F
(
µµF G#
SECURE_OVERWRITE_SIZE
µµG \
)
µµ\ ]
;
µµ] ^
using
∑∑ 
(
∑∑ 

FileStream
∑∑ %
fs
∑∑& (
=
∑∑) *
File
∑∑+ /
.
∑∑/ 0
	OpenWrite
∑∑0 9
(
∑∑9 :
keyFile
∑∑: A
)
∑∑A B
)
∑∑B C
{
∏∏ 
fs
ππ 
.
ππ 
Write
ππ  
(
ππ  !

randomData
ππ! +
,
ππ+ ,
$num
ππ- .
,
ππ. /

randomData
ππ0 :
.
ππ: ;
Length
ππ; A
)
ππA B
;
ππB C
fs
∫∫ 
.
∫∫ 
Flush
∫∫  
(
∫∫  !
true
∫∫! %
)
∫∫% &
;
∫∫& '
}
ªª 
File
ΩΩ 
.
ΩΩ 
Delete
ΩΩ 
(
ΩΩ  
keyFile
ΩΩ  '
)
ΩΩ' (
;
ΩΩ( )
}
ææ 
catch
øø 
(
øø 
	Exception
øø  
ex
øø! #
)
øø# $
{
¿¿ 
Log
¡¡ 
.
¡¡ 
Debug
¡¡ 
(
¡¡ 
ex
¡¡  
,
¡¡  !
$str
¡¡" o
,
¡¡o p
keyFile
¬¬ 
)
¬¬  
;
¬¬  !
}
√√ 
}
ƒƒ 
}
≈≈ 	
)
≈≈	 

;
≈≈
 
}
∆∆ 
public
»» 

async
»» 
Task
»» 
<
»» 
byte
»» 
[
»» 
]
»» 
>
»» %
GetOrCreateHmacKeyAsync
»» 5
(
»»5 6
)
»»6 7
{
…… 
if
   

(
   
_cachedHmacKey
   
!=
   
null
   "
)
  " #
{
ÀÀ 	
return
ÃÃ 
_cachedHmacKey
ÃÃ !
;
ÃÃ! "
}
ÕÕ 	
byte
œœ 
[
œœ 
]
œœ 
?
œœ 
hmacKey
œœ 
=
œœ 
await
œœ %
GetKeyFromKeychainAsync
œœ  7
(
œœ7 8!
HMAC_KEY_IDENTIFIER
œœ8 K
)
œœK L
;
œœL M
if
—— 

(
—— 
hmacKey
—— 
==
—— 
null
—— 
)
—— 
{
““ 	
byte
”” 
[
”” 
]
”” 
newKey
”” 
=
”” 
await
”” !'
GenerateSecureRandomAsync
””" ;
(
””; <
HMAC_KEY_SIZE
””< I
)
””I J
;
””J K
await
‘‘ %
StoreKeyInKeychainAsync
‘‘ )
(
‘‘) *!
HMAC_KEY_IDENTIFIER
‘‘* =
,
‘‘= >
newKey
‘‘? E
)
‘‘E F
;
‘‘F G
_cachedHmacKey
÷÷ 
=
÷÷ 
newKey
÷÷ #
;
÷÷# $
return
◊◊ 
newKey
◊◊ 
;
◊◊ 
}
ÿÿ 	
_cachedHmacKey
⁄⁄ 
=
⁄⁄ 
hmacKey
⁄⁄  
;
⁄⁄  !
return
€€ 
hmacKey
€€ 
;
€€ 
}
‹‹ 
public
ﬁﬁ 

bool
ﬁﬁ )
IsHardwareSecurityAvailable
ﬁﬁ +
(
ﬁﬁ+ ,
)
ﬁﬁ, -
{
ﬂﬂ 
if
‡‡ 

(
‡‡  
RuntimeInformation
‡‡ 
.
‡‡ 
IsOSPlatform
‡‡ +
(
‡‡+ ,

OSPlatform
‡‡, 6
.
‡‡6 7
Windows
‡‡7 >
)
‡‡> ?
)
‡‡? @
{
·· 	
return
‚‚ 
CheckWindowsTpm
‚‚ "
(
‚‚" #
)
‚‚# $
;
‚‚$ %
}
„„ 	
if
ÂÂ 

(
ÂÂ  
RuntimeInformation
ÂÂ 
.
ÂÂ 
IsOSPlatform
ÂÂ +
(
ÂÂ+ ,

OSPlatform
ÂÂ, 6
.
ÂÂ6 7
OSX
ÂÂ7 :
)
ÂÂ: ;
)
ÂÂ; <
{
ÊÊ 	
return
ÁÁ %
CheckMacOsSecureEnclave
ÁÁ *
(
ÁÁ* +
)
ÁÁ+ ,
;
ÁÁ, -
}
ËË 	
if
ÍÍ 

(
ÍÍ  
RuntimeInformation
ÍÍ 
.
ÍÍ 
IsOSPlatform
ÍÍ +
(
ÍÍ+ ,

OSPlatform
ÍÍ, 6
.
ÍÍ6 7
Linux
ÍÍ7 <
)
ÍÍ< =
)
ÍÍ= >
{
ÎÎ 	
return
ÏÏ 
CheckLinuxTpm
ÏÏ  
(
ÏÏ  !
)
ÏÏ! "
;
ÏÏ" #
}
ÌÌ 	
return
ÔÔ 
false
ÔÔ 
;
ÔÔ 
}
 
public
ÚÚ 

async
ÚÚ 
Task
ÚÚ 
<
ÚÚ 
Option
ÚÚ 
<
ÚÚ 
byte
ÚÚ !
[
ÚÚ! "
]
ÚÚ" #
>
ÚÚ# $
>
ÚÚ$ %"
HardwareEncryptAsync
ÚÚ& :
(
ÚÚ: ;
byte
ÚÚ; ?
[
ÚÚ? @
]
ÚÚ@ A
data
ÚÚB F
)
ÚÚF G
{
ÛÛ 
byte
ÙÙ 
[
ÙÙ 
]
ÙÙ 
key
ÙÙ 
=
ÙÙ 
await
ÙÙ %
GetOrCreateHmacKeyAsync
ÙÙ 2
(
ÙÙ2 3
)
ÙÙ3 4
;
ÙÙ4 5
try
ˆˆ 
{
˜˜ 	
using
¯¯ 
Aes
¯¯ 
aes
¯¯ 
=
¯¯ 
Aes
¯¯ 
.
¯¯  
Create
¯¯  &
(
¯¯& '
)
¯¯' (
;
¯¯( )
Span
˘˘ 
<
˘˘ 
byte
˘˘ 
>
˘˘ 
keySpan
˘˘ 
=
˘˘  
key
˘˘! $
.
˘˘$ %
AsSpan
˘˘% +
(
˘˘+ ,
$num
˘˘, -
,
˘˘- .
AES_KEY_SIZE
˘˘/ ;
)
˘˘; <
;
˘˘< =
aes
˙˙ 
.
˙˙ 
Key
˙˙ 
=
˙˙ 
keySpan
˙˙ 
.
˙˙ 
ToArray
˙˙ %
(
˙˙% &
)
˙˙& '
;
˙˙' (
aes
˚˚ 
.
˚˚ 

GenerateIV
˚˚ 
(
˚˚ 
)
˚˚ 
;
˚˚ 
using
˝˝ 
MemoryStream
˝˝ 
ms
˝˝ !
=
˝˝" #
new
˝˝$ '
(
˝˝' (
)
˝˝( )
;
˝˝) *
await
˛˛ 
ms
˛˛ 
.
˛˛ 

WriteAsync
˛˛ 
(
˛˛  
aes
˛˛  #
.
˛˛# $
IV
˛˛$ &
.
˛˛& '
AsMemory
˛˛' /
(
˛˛/ 0
$num
˛˛0 1
,
˛˛1 2
AES_IV_SIZE
˛˛3 >
)
˛˛> ?
)
˛˛? @
;
˛˛@ A
await
ÄÄ 
using
ÄÄ 
(
ÄÄ 
CryptoStream
ÄÄ %
cryptoStream
ÄÄ& 2
=
ÄÄ3 4
new
ÄÄ5 8
(
ÄÄ8 9
ms
ÄÄ9 ;
,
ÄÄ; <
aes
ÄÄ= @
.
ÄÄ@ A
CreateEncryptor
ÄÄA P
(
ÄÄP Q
)
ÄÄQ R
,
ÄÄR S
CryptoStreamMode
ÄÄT d
.
ÄÄd e
Write
ÄÄe j
)
ÄÄj k
)
ÄÄk l
{
ÅÅ 
await
ÇÇ 
cryptoStream
ÇÇ "
.
ÇÇ" #

WriteAsync
ÇÇ# -
(
ÇÇ- .
data
ÇÇ. 2
)
ÇÇ2 3
;
ÇÇ3 4
await
ÉÉ 
cryptoStream
ÉÉ "
.
ÉÉ" #"
FlushFinalBlockAsync
ÉÉ# 7
(
ÉÉ7 8
)
ÉÉ8 9
;
ÉÉ9 :
}
ÑÑ 
return
ÜÜ 
Option
ÜÜ 
<
ÜÜ 
byte
ÜÜ 
[
ÜÜ 
]
ÜÜ  
>
ÜÜ  !
.
ÜÜ! "
Some
ÜÜ" &
(
ÜÜ& '
ms
ÜÜ' )
.
ÜÜ) *
ToArray
ÜÜ* 1
(
ÜÜ1 2
)
ÜÜ2 3
)
ÜÜ3 4
;
ÜÜ4 5
}
áá 	
catch
àà 
(
àà 
	Exception
àà 
ex
àà 
)
àà 
{
ââ 	
Log
ää 
.
ää 
Error
ää 
(
ää 
ex
ää 
,
ää 
$str
ää 6
)
ää6 7
;
ää7 8
return
ãã 
Option
ãã 
<
ãã 
byte
ãã 
[
ãã 
]
ãã  
>
ãã  !
.
ãã! "
None
ãã" &
;
ãã& '
}
åå 	
}
çç 
public
èè 

async
èè 
Task
èè 
<
èè 
Option
èè 
<
èè 
byte
èè !
[
èè! "
]
èè" #
>
èè# $
>
èè$ %"
HardwareDecryptAsync
èè& :
(
èè: ;
byte
èè; ?
[
èè? @
]
èè@ A
data
èèB F
)
èèF G
{
êê 
if
ëë 

(
ëë 
data
ëë 
.
ëë 
Length
ëë 
<
ëë 
AES_IV_SIZE
ëë %
)
ëë% &
{
íí 	
Log
ìì 
.
ìì 
Error
ìì 
(
ìì 
$strìì Ö
,ììÖ Ü
data
îî 
.
îî 
Length
îî 
,
îî 
AES_IV_SIZE
îî (
)
îî( )
;
îî) *
return
ïï 
Option
ïï 
<
ïï 
byte
ïï 
[
ïï 
]
ïï  
>
ïï  !
.
ïï! "
None
ïï" &
;
ïï& '
}
ññ 	
byte
òò 
[
òò 
]
òò 
key
òò 
=
òò 
await
òò %
GetOrCreateHmacKeyAsync
òò 2
(
òò2 3
)
òò3 4
;
òò4 5
try
öö 
{
õõ 	
using
úú 
Aes
úú 
aes
úú 
=
úú 
Aes
úú 
.
úú  
Create
úú  &
(
úú& '
)
úú' (
;
úú( )
Span
ùù 
<
ùù 
byte
ùù 
>
ùù 
keySpan
ùù 
=
ùù  
key
ùù! $
.
ùù$ %
AsSpan
ùù% +
(
ùù+ ,
$num
ùù, -
,
ùù- .
AES_KEY_SIZE
ùù/ ;
)
ùù; <
;
ùù< =
aes
ûû 
.
ûû 
Key
ûû 
=
ûû 
keySpan
ûû 
.
ûû 
ToArray
ûû %
(
ûû% &
)
ûû& '
;
ûû' (
byte
†† 
[
†† 
]
†† 
iv
†† 
=
†† 
new
†† 
byte
††  
[
††  !
AES_IV_SIZE
††! ,
]
††, -
;
††- .
Array
°° 
.
°° 
Copy
°° 
(
°° 
data
°° 
,
°° 
$num
°° 
,
°° 
iv
°°  "
,
°°" #
$num
°°$ %
,
°°% &
AES_IV_SIZE
°°' 2
)
°°2 3
;
°°3 4
aes
¢¢ 
.
¢¢ 
IV
¢¢ 
=
¢¢ 
iv
¢¢ 
;
¢¢ 
using
§§ 
MemoryStream
§§ 
ms
§§ !
=
§§" #
new
§§$ '
(
§§' (
data
§§( ,
,
§§, -
AES_IV_SIZE
§§. 9
,
§§9 :
data
§§; ?
.
§§? @
Length
§§@ F
-
§§G H
AES_IV_SIZE
§§I T
)
§§T U
;
§§U V
await
•• 
using
•• 
CryptoStream
•• $
cs
••% '
=
••( )
new
••* -
(
••- .
ms
••. 0
,
••0 1
aes
••2 5
.
••5 6
CreateDecryptor
••6 E
(
••E F
)
••F G
,
••G H
CryptoStreamMode
••I Y
.
••Y Z
Read
••Z ^
)
••^ _
;
••_ `
using
¶¶ 
MemoryStream
¶¶ 
result
¶¶ %
=
¶¶& '
new
¶¶( +
(
¶¶+ ,
)
¶¶, -
;
¶¶- .
await
®® 
cs
®® 
.
®® 
CopyToAsync
®®  
(
®®  !
result
®®! '
)
®®' (
;
®®( )
return
©© 
Option
©© 
<
©© 
byte
©© 
[
©© 
]
©©  
>
©©  !
.
©©! "
Some
©©" &
(
©©& '
result
©©' -
.
©©- .
ToArray
©©. 5
(
©©5 6
)
©©6 7
)
©©7 8
;
©©8 9
}
™™ 	
catch
´´ 
(
´´ 
	Exception
´´ 
ex
´´ 
)
´´ 
{
¨¨ 	
Log
≠≠ 
.
≠≠ 
Error
≠≠ 
(
≠≠ 
ex
≠≠ 
,
≠≠ 
$str
≠≠ X
,
≠≠X Y
ex
≠≠Z \
.
≠≠\ ]
Message
≠≠] d
)
≠≠d e
;
≠≠e f
return
ÆÆ 
Option
ÆÆ 
<
ÆÆ 
byte
ÆÆ 
[
ÆÆ 
]
ÆÆ  
>
ÆÆ  !
.
ÆÆ! "
None
ÆÆ" &
;
ÆÆ& '
}
ØØ 	
}
∞∞ 
private
≤≤ 
Result
≤≤ 
<
≤≤ 
Unit
≤≤ 
,
≤≤ "
SecureStorageFailure
≤≤ -
>
≤≤- .-
StoreInWindowsCredentialManager
≤≤/ N
(
≤≤N O
string
≤≤O U

identifier
≤≤V `
,
≤≤` a
byte
≤≤b f
[
≤≤f g
]
≤≤g h
key
≤≤i l
)
≤≤l m
=>
≤≤n p"
StoreInEncryptedFile
≥≥ 
(
≥≥ 

identifier
≥≥ '
,
≥≥' (
key
≥≥) ,
)
≥≥, -
;
≥≥- .
private
µµ 
Result
µµ 
<
µµ 
byte
µµ 
[
µµ 
]
µµ 
,
µµ "
SecureStorageFailure
µµ /
>
µµ/ 0-
GetFromWindowsCredentialManager
µµ1 P
(
µµP Q
string
µµQ W

identifier
µµX b
)
µµb c
=>
µµd f"
GetFromEncryptedFile
∂∂ 
(
∂∂ 

identifier
∂∂ '
)
∂∂' (
;
∂∂( )
private
∏∏ 
Result
∏∏ 
<
∏∏ 
Unit
∏∏ 
,
∏∏ "
SecureStorageFailure
∏∏ -
>
∏∏- ."
StoreInMacOsKeychain
∏∏/ C
(
∏∏C D
string
∏∏D J

identifier
∏∏K U
,
∏∏U V
byte
∏∏W [
[
∏∏[ \
]
∏∏\ ]
key
∏∏^ a
)
∏∏a b
=>
∏∏c e"
StoreInEncryptedFile
ππ 
(
ππ 

identifier
ππ '
,
ππ' (
key
ππ) ,
)
ππ, -
;
ππ- .
private
ªª 
Result
ªª 
<
ªª 
byte
ªª 
[
ªª 
]
ªª 
,
ªª "
SecureStorageFailure
ªª /
>
ªª/ 0"
GetFromMacOsKeychain
ªª1 E
(
ªªE F
string
ªªF L

identifier
ªªM W
)
ªªW X
=>
ªªY ["
GetFromEncryptedFile
ºº 
(
ºº 

identifier
ºº '
)
ºº' (
;
ºº( )
private
ææ 
Result
ææ 
<
ææ 
Unit
ææ 
,
ææ "
SecureStorageFailure
ææ -
>
ææ- .'
StoreInLinuxSecretService
ææ/ H
(
ææH I
string
ææI O

identifier
ææP Z
,
ææZ [
byte
ææ\ `
[
ææ` a
]
ææa b
key
ææc f
)
ææf g
=>
ææh j"
StoreInEncryptedFile
øø 
(
øø 

identifier
øø '
,
øø' (
key
øø) ,
)
øø, -
;
øø- .
private
¡¡ 
Result
¡¡ 
<
¡¡ 
byte
¡¡ 
[
¡¡ 
]
¡¡ 
,
¡¡ "
SecureStorageFailure
¡¡ /
>
¡¡/ 0'
GetFromLinuxSecretService
¡¡1 J
(
¡¡J K
string
¡¡K Q

identifier
¡¡R \
)
¡¡\ ]
=>
¡¡^ `"
GetFromEncryptedFile
¬¬ 
(
¬¬ 

identifier
¬¬ '
)
¬¬' (
;
¬¬( )
private
ƒƒ 
Result
ƒƒ 
<
ƒƒ 
Unit
ƒƒ 
,
ƒƒ "
SecureStorageFailure
ƒƒ -
>
ƒƒ- ."
StoreInEncryptedFile
ƒƒ/ C
(
ƒƒC D
string
ƒƒD J

identifier
ƒƒK U
,
ƒƒU V
byte
ƒƒW [
[
ƒƒ[ \
]
ƒƒ\ ]
key
ƒƒ^ a
)
ƒƒa b
{
≈≈ 
try
∆∆ 
{
«« 	
string
»» 
keyFile
»» 
=
»» 
GetKeyFilePath
»» +
(
»»+ ,

identifier
»», 6
)
»»6 7
;
»»7 8
Option
…… 
<
…… 
byte
…… 
[
…… 
]
…… 
>
…… 
machineKeyOpt
…… (
=
……) *
GetMachineKey
……+ 8
(
……8 9
)
……9 :
;
……: ;
if
   
(
   
!
   
machineKeyOpt
   
.
   
IsSome
   %
)
  % &
{
ÀÀ 
return
ÃÃ 
Result
ÃÃ 
<
ÃÃ 
Unit
ÃÃ "
,
ÃÃ" #"
SecureStorageFailure
ÃÃ$ 8
>
ÃÃ8 9
.
ÃÃ9 :
Err
ÃÃ: =
(
ÃÃ= >
new
ÕÕ "
SecureStorageFailure
ÕÕ ,
(
ÕÕ, -
$str
ÕÕ- H
)
ÕÕH I
)
ÕÕI J
;
ÕÕJ K
}
ŒŒ 
byte
œœ 
[
œœ 
]
œœ 

machineKey
œœ 
=
œœ 
machineKeyOpt
œœ  -
.
œœ- .
Value
œœ. 3
!
œœ3 4
;
œœ4 5
using
—— 
Aes
—— 
aes
—— 
=
—— 
Aes
—— 
.
——  
Create
——  &
(
——& '
)
——' (
;
——( )
aes
““ 
.
““ 
Key
““ 
=
““ 

machineKey
““  
;
““  !
aes
”” 
.
”” 

GenerateIV
”” 
(
”” 
)
”” 
;
”” 
byte
’’ 
[
’’ 
]
’’ 
buffer
’’ 
=
’’ 
	ArrayPool
’’ %
<
’’% &
byte
’’& *
>
’’* +
.
’’+ ,
Shared
’’, 2
.
’’2 3
Rent
’’3 7
(
’’7 8
AES_IV_SIZE
’’8 C
+
’’D E
key
’’F I
.
’’I J
Length
’’J P
+
’’Q R
$num
’’S U
)
’’U V
;
’’V W
try
÷÷ 
{
◊◊ 
aes
ÿÿ 
.
ÿÿ 
IV
ÿÿ 
.
ÿÿ 
CopyTo
ÿÿ 
(
ÿÿ 
buffer
ÿÿ $
,
ÿÿ$ %
$num
ÿÿ& '
)
ÿÿ' (
;
ÿÿ( )
using
⁄⁄ 
ICryptoTransform
⁄⁄ &
	encryptor
⁄⁄' 0
=
⁄⁄1 2
aes
⁄⁄3 6
.
⁄⁄6 7
CreateEncryptor
⁄⁄7 F
(
⁄⁄F G
)
⁄⁄G H
;
⁄⁄H I
int
€€ 
encryptedLength
€€ #
=
€€$ %
	encryptor
€€& /
.
€€/ 0
TransformBlock
€€0 >
(
€€> ?
key
€€? B
,
€€B C
$num
€€D E
,
€€E F
key
€€G J
.
€€J K
Length
€€K Q
,
€€Q R
buffer
€€S Y
,
€€Y Z
AES_IV_SIZE
€€[ f
)
€€f g
;
€€g h
byte
‹‹ 
[
‹‹ 
]
‹‹ 

finalBlock
‹‹ !
=
‹‹" #
	encryptor
‹‹$ -
.
‹‹- .!
TransformFinalBlock
‹‹. A
(
‹‹A B
key
‹‹B E
,
‹‹E F
$num
‹‹G H
,
‹‹H I
$num
‹‹J K
)
‹‹K L
;
‹‹L M
if
ﬁﬁ 
(
ﬁﬁ 

finalBlock
ﬁﬁ 
.
ﬁﬁ 
Length
ﬁﬁ %
>
ﬁﬁ& '
$num
ﬁﬁ( )
)
ﬁﬁ) *
{
ﬂﬂ 

finalBlock
‡‡ 
.
‡‡ 
CopyTo
‡‡ %
(
‡‡% &
buffer
‡‡& ,
,
‡‡, -
AES_IV_SIZE
‡‡. 9
+
‡‡: ;
encryptedLength
‡‡< K
)
‡‡K L
;
‡‡L M
encryptedLength
·· #
+=
··$ &

finalBlock
··' 1
.
··1 2
Length
··2 8
;
··8 9
}
‚‚ 
using
‰‰ 

FileStream
‰‰  
fs
‰‰! #
=
‰‰$ %
File
‰‰& *
.
‰‰* +
Create
‰‰+ 1
(
‰‰1 2
keyFile
‰‰2 9
)
‰‰9 :
;
‰‰: ;
fs
ÂÂ 
.
ÂÂ 
Write
ÂÂ 
(
ÂÂ 
buffer
ÂÂ 
,
ÂÂ  
$num
ÂÂ! "
,
ÂÂ" #
AES_IV_SIZE
ÂÂ$ /
+
ÂÂ0 1
encryptedLength
ÂÂ2 A
)
ÂÂA B
;
ÂÂB C
if
ÁÁ 
(
ÁÁ 
!
ÁÁ  
RuntimeInformation
ÁÁ '
.
ÁÁ' (
IsOSPlatform
ÁÁ( 4
(
ÁÁ4 5

OSPlatform
ÁÁ5 ?
.
ÁÁ? @
Windows
ÁÁ@ G
)
ÁÁG H
)
ÁÁH I
{
ËË 
File
ÈÈ 
.
ÈÈ 
SetUnixFileMode
ÈÈ (
(
ÈÈ( )
keyFile
ÈÈ) 0
,
ÈÈ0 1
UnixFileMode
ÈÈ2 >
.
ÈÈ> ?
UserRead
ÈÈ? G
|
ÈÈH I
UnixFileMode
ÈÈJ V
.
ÈÈV W
	UserWrite
ÈÈW `
)
ÈÈ` a
;
ÈÈa b
}
ÍÍ 
return
ÏÏ 
Result
ÏÏ 
<
ÏÏ 
Unit
ÏÏ "
,
ÏÏ" #"
SecureStorageFailure
ÏÏ$ 8
>
ÏÏ8 9
.
ÏÏ9 :
Ok
ÏÏ: <
(
ÏÏ< =
Unit
ÏÏ= A
.
ÏÏA B
Value
ÏÏB G
)
ÏÏG H
;
ÏÏH I
}
ÌÌ 
finally
ÓÓ 
{
ÔÔ 
	ArrayPool
 
<
 
byte
 
>
 
.
  
Shared
  &
.
& '
Return
' -
(
- .
buffer
. 4
,
4 5

clearArray
6 @
:
@ A
true
B F
)
F G
;
G H
}
ÒÒ 
}
ÚÚ 	
catch
ÛÛ 
(
ÛÛ 
	Exception
ÛÛ 
ex
ÛÛ 
)
ÛÛ 
{
ÙÙ 	
return
ıı 
Result
ıı 
<
ıı 
Unit
ıı 
,
ıı "
SecureStorageFailure
ıı  4
>
ıı4 5
.
ıı5 6
Err
ıı6 9
(
ıı9 :
new
ˆˆ "
SecureStorageFailure
ˆˆ (
(
ˆˆ( )
$"
ˆˆ) +
$str
ˆˆ+ K
{
ˆˆK L
ex
ˆˆL N
.
ˆˆN O
Message
ˆˆO V
}
ˆˆV W
"
ˆˆW X
)
ˆˆX Y
)
ˆˆY Z
;
ˆˆZ [
}
˜˜ 	
}
¯¯ 
private
˙˙ 
Result
˙˙ 
<
˙˙ 
byte
˙˙ 
[
˙˙ 
]
˙˙ 
,
˙˙ "
SecureStorageFailure
˙˙ /
>
˙˙/ 0"
GetFromEncryptedFile
˙˙1 E
(
˙˙E F
string
˙˙F L

identifier
˙˙M W
)
˙˙W X
{
˚˚ 
string
¸¸ 
keyFile
¸¸ 
=
¸¸ 
GetKeyFilePath
¸¸ '
(
¸¸' (

identifier
¸¸( 2
)
¸¸2 3
;
¸¸3 4
if
˝˝ 

(
˝˝ 
!
˝˝ 
File
˝˝ 
.
˝˝ 
Exists
˝˝ 
(
˝˝ 
keyFile
˝˝  
)
˝˝  !
)
˝˝! "
{
˛˛ 	
Log
ˇˇ 
.
ˇˇ 
Debug
ˇˇ 
(
ˇˇ 
$str
ˇˇ b
,
ˇˇb c

identifier
ÄÄ 
,
ÄÄ 
keyFile
ÄÄ #
)
ÄÄ# $
;
ÄÄ$ %
return
ÅÅ 
Result
ÅÅ 
<
ÅÅ 
byte
ÅÅ 
[
ÅÅ 
]
ÅÅ  
,
ÅÅ  !"
SecureStorageFailure
ÅÅ" 6
>
ÅÅ6 7
.
ÅÅ7 8
Err
ÅÅ8 ;
(
ÅÅ; <
new
ÇÇ "
SecureStorageFailure
ÇÇ (
(
ÇÇ( )
$str
ÇÇ) =
)
ÇÇ= >
)
ÇÇ> ?
;
ÇÇ? @
}
ÉÉ 	
try
ÖÖ 
{
ÜÜ 	
byte
áá 
[
áá 
]
áá 
	encrypted
áá 
=
áá 
File
áá #
.
áá# $
ReadAllBytes
áá$ 0
(
áá0 1
keyFile
áá1 8
)
áá8 9
;
áá9 :
if
àà 
(
àà 
	encrypted
àà 
.
àà 
Length
àà  
<
àà! "
AES_IV_SIZE
àà# .
)
àà. /
{
ââ 
Log
ää 
.
ää 
Error
ää 
(
ää 
$strãã ë
,ããë í

identifier
åå 
,
åå 
	encrypted
åå  )
.
åå) *
Length
åå* 0
,
åå0 1
AES_IV_SIZE
åå2 =
)
åå= >
;
åå> ?
return
çç 
Result
çç 
<
çç 
byte
çç "
[
çç" #
]
çç# $
,
çç$ %"
SecureStorageFailure
çç& :
>
çç: ;
.
çç; <
Err
çç< ?
(
çç? @
new
éé "
SecureStorageFailure
éé ,
(
éé, -
$str
éé- L
)
ééL M
)
ééM N
;
ééN O
}
èè 
Option
ëë 
<
ëë 
byte
ëë 
[
ëë 
]
ëë 
>
ëë 
machineKeyOpt
ëë (
=
ëë) *
GetMachineKey
ëë+ 8
(
ëë8 9
)
ëë9 :
;
ëë: ;
if
íí 
(
íí 
!
íí 
machineKeyOpt
íí 
.
íí 
IsSome
íí %
)
íí% &
{
ìì 
return
îî 
Result
îî 
<
îî 
byte
îî "
[
îî" #
]
îî# $
,
îî$ %"
SecureStorageFailure
îî& :
>
îî: ;
.
îî; <
Err
îî< ?
(
îî? @
new
ïï "
SecureStorageFailure
ïï ,
(
ïï, -
$str
ïï- H
)
ïïH I
)
ïïI J
;
ïïJ K
}
ññ 
byte
óó 
[
óó 
]
óó 

machineKey
óó 
=
óó 
machineKeyOpt
óó  -
.
óó- .
Value
óó. 3
!
óó3 4
;
óó4 5
using
ôô 
Aes
ôô 
aes
ôô 
=
ôô 
Aes
ôô 
.
ôô  
Create
ôô  &
(
ôô& '
)
ôô' (
;
ôô( )
aes
öö 
.
öö 
Key
öö 
=
öö 

machineKey
öö  
;
öö  !
Span
úú 
<
úú 
byte
úú 
>
úú 
iv
úú 
=
úú 
	encrypted
úú %
.
úú% &
AsSpan
úú& ,
(
úú, -
$num
úú- .
,
úú. /
AES_IV_SIZE
úú0 ;
)
úú; <
;
úú< =
aes
ùù 
.
ùù 
IV
ùù 
=
ùù 
iv
ùù 
.
ùù 
ToArray
ùù 
(
ùù  
)
ùù  !
;
ùù! "
using
üü 
ICryptoTransform
üü "
	decryptor
üü# ,
=
üü- .
aes
üü/ 2
.
üü2 3
CreateDecryptor
üü3 B
(
üüB C
)
üüC D
;
üüD E
byte
†† 
[
†† 
]
†† 
	decrypted
†† 
=
†† 
	decryptor
†† (
.
††( )!
TransformFinalBlock
††) <
(
††< =
	encrypted
††= F
,
††F G
AES_IV_SIZE
††H S
,
††S T
	encrypted
††U ^
.
††^ _
Length
††_ e
-
††f g
AES_IV_SIZE
††h s
)
††s t
;
††t u
return
¢¢ 
Result
¢¢ 
<
¢¢ 
byte
¢¢ 
[
¢¢ 
]
¢¢  
,
¢¢  !"
SecureStorageFailure
¢¢" 6
>
¢¢6 7
.
¢¢7 8
Ok
¢¢8 :
(
¢¢: ;
	decrypted
¢¢; D
)
¢¢D E
;
¢¢E F
}
££ 	
catch
§§ 
(
§§ $
CryptographicException
§§ %
)
§§% &
{
•• 	
try
¶¶ 
{
ßß 
File
®® 
.
®® 
Delete
®® 
(
®® 
keyFile
®® #
)
®®# $
;
®®$ %
}
©© 
catch
™™ 
(
™™ 
	Exception
™™ 
deleteEx
™™ %
)
™™% &
{
´´ 
Log
¨¨ 
.
¨¨ 
Error
¨¨ 
(
¨¨ 
deleteEx
¨¨ "
,
¨¨" #
$str≠≠ é
,≠≠é è

identifier
ÆÆ 
,
ÆÆ 
keyFile
ÆÆ  '
,
ÆÆ' (
deleteEx
ÆÆ) 1
.
ÆÆ1 2
Message
ÆÆ2 9
)
ÆÆ9 :
;
ÆÆ: ;
}
ØØ 
return
±± 
Result
±± 
<
±± 
byte
±± 
[
±± 
]
±±  
,
±±  !"
SecureStorageFailure
±±" 6
>
±±6 7
.
±±7 8
Err
±±8 ;
(
±±; <
new
≤≤ "
SecureStorageFailure
≤≤ (
(
≤≤( )
$str
≤≤) U
)
≤≤U V
)
≤≤V W
;
≤≤W X
}
≥≥ 	
catch
¥¥ 
(
¥¥ 
	Exception
¥¥ 
ex
¥¥ 
)
¥¥ 
{
µµ 	
Log
∂∂ 
.
∂∂ 
Error
∂∂ 
(
∂∂ 
ex
∂∂ 
,
∂∂ 
$str
∑∑ }
,
∑∑} ~

identifier
∏∏ 
,
∏∏ 
keyFile
∏∏ #
,
∏∏# $
ex
∏∏% '
.
∏∏' (
Message
∏∏( /
)
∏∏/ 0
;
∏∏0 1
return
ππ 
Result
ππ 
<
ππ 
byte
ππ 
[
ππ 
]
ππ  
,
ππ  !"
SecureStorageFailure
ππ" 6
>
ππ6 7
.
ππ7 8
Err
ππ8 ;
(
ππ; <
new
∫∫ "
SecureStorageFailure
∫∫ (
(
∫∫( )
$"
∫∫) +
$str
∫∫+ J
{
∫∫J K
ex
∫∫K M
.
∫∫M N
Message
∫∫N U
}
∫∫U V
"
∫∫V W
)
∫∫W X
)
∫∫X Y
;
∫∫Y Z
}
ªª 	
}
ºº 
private
ææ 
string
ææ 
GetKeyFilePath
ææ !
(
ææ! "
string
ææ" (

identifier
ææ) 3
)
ææ3 4
{
øø 
ReadOnlySpan
¿¿ 
<
¿¿ 
byte
¿¿ 
>
¿¿ 
identifierBytes
¿¿ *
=
¿¿+ ,
Encoding
¿¿- 5
.
¿¿5 6
UTF8
¿¿6 :
.
¿¿: ;
GetBytes
¿¿; C
(
¿¿C D

identifier
¿¿D N
)
¿¿N O
;
¿¿O P
Span
¡¡ 
<
¡¡ 
byte
¡¡ 
>
¡¡ 

hashBuffer
¡¡ 
=
¡¡ 

stackalloc
¡¡  *
byte
¡¡+ /
[
¡¡/ 0
$num
¡¡0 2
]
¡¡2 3
;
¡¡3 4
SHA256
¬¬ 
.
¬¬ 
HashData
¬¬ 
(
¬¬ 
identifierBytes
¬¬ '
,
¬¬' (

hashBuffer
¬¬) 3
)
¬¬3 4
;
¬¬4 5
string
ƒƒ 
safeIdentifier
ƒƒ 
=
ƒƒ 
Convert
ƒƒ  '
.
ƒƒ' (
ToBase64String
ƒƒ( 6
(
ƒƒ6 7

hashBuffer
ƒƒ7 A
)
ƒƒA B
.
≈≈ 
Replace
≈≈ 
(
≈≈ 
$char
≈≈ 
,
≈≈ 
$char
≈≈ 
)
≈≈ 
.
∆∆ 
Replace
∆∆ 
(
∆∆ 
$char
∆∆ 
,
∆∆ 
$char
∆∆ 
)
∆∆ 
;
∆∆ 
return
»» 
Path
»» 
.
»» 
Combine
»» 
(
»» 
_keychainPath
»» )
,
»») *
$"
»»+ -
{
»»- .
safeIdentifier
»». <
}
»»< =
$str
»»= A
"
»»A B
)
»»B C
;
»»C D
}
…… 
private
ÀÀ 
Option
ÀÀ 
<
ÀÀ 
byte
ÀÀ 
[
ÀÀ 
]
ÀÀ 
>
ÀÀ 
GetMachineKey
ÀÀ (
(
ÀÀ( )
)
ÀÀ) *
{
ÃÃ 
if
ÕÕ 

(
ÕÕ 
_cachedMachineKey
ÕÕ 
!=
ÕÕ  
null
ÕÕ! %
)
ÕÕ% &
{
ŒŒ 	
return
œœ 
Option
œœ 
<
œœ 
byte
œœ 
[
œœ 
]
œœ  
>
œœ  !
.
œœ! "
Some
œœ" &
(
œœ& '
_cachedMachineKey
œœ' 8
)
œœ8 9
;
œœ9 :
}
–– 	
string
““ 
machineKeyFile
““ 
=
““ 
Path
““  $
.
““$ %
Combine
““% ,
(
““, -
_keychainPath
““- :
,
““: ;"
MACHINE_KEY_FILENAME
““< P
)
““P Q
;
““Q R
string
”” 
	machineId
”” 
=
”” $
BuildMachineIdentifier
”” 1
(
””1 2
)
””2 3
;
””3 4
if
’’ 

(
’’ 
File
’’ 
.
’’ 
Exists
’’ 
(
’’ 
machineKeyFile
’’ &
)
’’& '
)
’’' (
{
÷÷ 	
try
◊◊ 
{
ÿÿ 
_cachedMachineKey
ŸŸ !
=
ŸŸ" #
File
ŸŸ$ (
.
ŸŸ( )
ReadAllBytes
ŸŸ) 5
(
ŸŸ5 6
machineKeyFile
ŸŸ6 D
)
ŸŸD E
;
ŸŸE F
if
⁄⁄ 
(
⁄⁄ 
_cachedMachineKey
⁄⁄ %
.
⁄⁄% &
Length
⁄⁄& ,
!=
⁄⁄- /
AES_KEY_SIZE
⁄⁄0 <
)
⁄⁄< =
{
€€ 
_cachedMachineKey
‹‹ %
=
‹‹& '
null
‹‹( ,
;
‹‹, -
return
›› 
Option
›› !
<
››! "
byte
››" &
[
››& '
]
››' (
>
››( )
.
››) *
None
››* .
;
››. /
}
ﬁﬁ 
byte
‡‡ 
[
‡‡ 
]
‡‡ 

derivedKey
‡‡ !
=
‡‡" #$
DeriveKeyFromMachineId
‡‡$ :
(
‡‡: ;
	machineId
‡‡; D
)
‡‡D E
;
‡‡E F
if
‚‚ 
(
‚‚ 
!
‚‚ %
CryptographicOperations
‚‚ ,
.
‚‚, -
FixedTimeEquals
‚‚- <
(
‚‚< =

derivedKey
‚‚= G
,
‚‚G H
_cachedMachineKey
‚‚I Z
)
‚‚Z [
)
‚‚[ \
{
„„ %
CryptographicOperations
‰‰ +
.
‰‰+ ,

ZeroMemory
‰‰, 6
(
‰‰6 7

derivedKey
‰‰7 A
)
‰‰A B
;
‰‰B C
_cachedMachineKey
ÂÂ %
=
ÂÂ& '
null
ÂÂ( ,
;
ÂÂ, -
return
ÊÊ 
Option
ÊÊ !
<
ÊÊ! "
byte
ÊÊ" &
[
ÊÊ& '
]
ÊÊ' (
>
ÊÊ( )
.
ÊÊ) *
None
ÊÊ* .
;
ÊÊ. /
}
ÁÁ %
CryptographicOperations
ÈÈ '
.
ÈÈ' (

ZeroMemory
ÈÈ( 2
(
ÈÈ2 3

derivedKey
ÈÈ3 =
)
ÈÈ= >
;
ÈÈ> ?
return
ÍÍ 
Option
ÍÍ 
<
ÍÍ 
byte
ÍÍ "
[
ÍÍ" #
]
ÍÍ# $
>
ÍÍ$ %
.
ÍÍ% &
Some
ÍÍ& *
(
ÍÍ* +
_cachedMachineKey
ÍÍ+ <
)
ÍÍ< =
;
ÍÍ= >
}
ÎÎ 
catch
ÏÏ 
(
ÏÏ 
	Exception
ÏÏ 
ex
ÏÏ 
)
ÏÏ  
{
ÌÌ 
Log
ÓÓ 
.
ÓÓ 
Error
ÓÓ 
(
ÓÓ 
ex
ÓÓ 
,
ÓÓ 
$str
ÓÓ e
,
ÓÓe f
ex
ÔÔ 
.
ÔÔ 
Message
ÔÔ 
)
ÔÔ 
;
ÔÔ  
_cachedMachineKey
 !
=
" #
null
$ (
;
( )
return
ÒÒ 
Option
ÒÒ 
<
ÒÒ 
byte
ÒÒ "
[
ÒÒ" #
]
ÒÒ# $
>
ÒÒ$ %
.
ÒÒ% &
None
ÒÒ& *
;
ÒÒ* +
}
ÚÚ 
}
ÛÛ 	
_cachedMachineKey
ıı 
=
ıı $
DeriveKeyFromMachineId
ıı 2
(
ıı2 3
	machineId
ıı3 <
)
ıı< =
;
ıı= >
try
˜˜ 
{
¯¯ 	
File
˘˘ 
.
˘˘ 
WriteAllBytes
˘˘ 
(
˘˘ 
machineKeyFile
˘˘ -
,
˘˘- .
_cachedMachineKey
˘˘/ @
)
˘˘@ A
;
˘˘A B
if
˙˙ 
(
˙˙ 
!
˙˙  
RuntimeInformation
˙˙ #
.
˙˙# $
IsOSPlatform
˙˙$ 0
(
˙˙0 1

OSPlatform
˙˙1 ;
.
˙˙; <
Windows
˙˙< C
)
˙˙C D
)
˙˙D E
{
˚˚ 
File
¸¸ 
.
¸¸ 
SetUnixFileMode
¸¸ $
(
¸¸$ %
machineKeyFile
¸¸% 3
,
¸¸3 4
UnixFileMode
¸¸5 A
.
¸¸A B
UserRead
¸¸B J
|
¸¸K L
UnixFileMode
¸¸M Y
.
¸¸Y Z
	UserWrite
¸¸Z c
)
¸¸c d
;
¸¸d e
}
˝˝ 
}
˛˛ 	
catch
ˇˇ 
(
ˇˇ 
	Exception
ˇˇ 
ex
ˇˇ 
)
ˇˇ 
{
ÄÄ 	
Log
ÅÅ 
.
ÅÅ 
Error
ÅÅ 
(
ÅÅ 
ex
ÅÅ 
,
ÅÅ 
$str
ÅÅ Y
,
ÅÅY Z
ex
ÇÇ 
.
ÇÇ 
Message
ÇÇ 
)
ÇÇ 
;
ÇÇ 
}
ÉÉ 	
return
ÖÖ 
Option
ÖÖ 
<
ÖÖ 
byte
ÖÖ 
[
ÖÖ 
]
ÖÖ 
>
ÖÖ 
.
ÖÖ 
Some
ÖÖ "
(
ÖÖ" #
_cachedMachineKey
ÖÖ# 4
)
ÖÖ4 5
;
ÖÖ5 6
}
ÜÜ 
private
àà 
static
àà 
void
àà *
TryEnhanceWithHardwareRandom
àà 4
(
àà4 5
Span
àà5 9
<
àà9 :
byte
àà: >
>
àà> ?
bytes
àà@ E
)
ààE F
{
ââ 
try
ää 
{
ãã 	
using
åå 

FileStream
åå 
hwRandom
åå %
=
åå& '
File
åå( ,
.
åå, -
OpenRead
åå- 5
(
åå5 6
$str
åå6 C
)
ååC D
;
ååD E
int
çç 
	bytesRead
çç 
=
çç 
hwRandom
çç $
.
çç$ %
Read
çç% )
(
çç) *
bytes
çç* /
)
çç/ 0
;
çç0 1
if
éé 
(
éé 
	bytesRead
éé 
>=
éé 
bytes
éé "
.
éé" #
Length
éé# )
)
éé) *
{
èè 
return
êê 
;
êê 
}
ëë 
Span
ìì 
<
ìì 
byte
ìì 
>
ìì 

tempBuffer
ìì !
=
ìì" #

stackalloc
ìì$ .
byte
ìì/ 3
[
ìì3 4
bytes
ìì4 9
.
ìì9 :
Length
ìì: @
]
ìì@ A
;
ììA B#
RandomNumberGenerator
îî !
.
îî! "
Fill
îî" &
(
îî& '

tempBuffer
îî' 1
)
îî1 2
;
îî2 3
for
ïï 
(
ïï 
int
ïï 
i
ïï 
=
ïï 
$num
ïï 
;
ïï 
i
ïï 
<
ïï 
bytes
ïï  %
.
ïï% &
Length
ïï& ,
;
ïï, -
i
ïï. /
++
ïï/ 1
)
ïï1 2
{
ññ 
bytes
óó 
[
óó 
i
óó 
]
óó 
^=
óó 

tempBuffer
óó &
[
óó& '
i
óó' (
]
óó( )
;
óó) *
}
òò 
}
ôô 	
catch
öö 
(
öö 
	Exception
öö 
)
öö 
{
õõ 	
}
ùù 	
}
ûû 
private
†† 
static
†† 
string
†† $
BuildMachineIdentifier
†† 0
(
††0 1
)
††1 2
{
°° 
StringBuilder
¢¢ 
	machineId
¢¢ 
=
¢¢  !
new
¢¢" %
(
¢¢% &
Environment
¢¢& 1
.
¢¢1 2
MachineName
¢¢2 =
)
¢¢= >
;
¢¢> ?
	machineId
££ 
.
££ 
Append
££ 
(
££ 
Environment
££ $
.
££$ %
ProcessorCount
££% 3
)
££3 4
;
££4 5
if
•• 

(
••  
RuntimeInformation
•• 
.
•• 
IsOSPlatform
•• +
(
••+ ,

OSPlatform
••, 6
.
••6 7
Linux
••7 <
)
••< =
)
••= >
{
¶¶ 	%
TryAppendLinuxMachineId
ßß #
(
ßß# $
	machineId
ßß$ -
)
ßß- .
;
ßß. /
}
®® 	
else
©© 
if
©© 
(
©©  
RuntimeInformation
©© #
.
©©# $
IsOSPlatform
©©$ 0
(
©©0 1

OSPlatform
©©1 ;
.
©©; <
OSX
©©< ?
)
©©? @
)
©©@ A
{
™™ 	 
TryAppendMacOsuuid
´´ 
(
´´ 
	machineId
´´ (
)
´´( )
;
´´) *
}
¨¨ 	
return
ÆÆ 
	machineId
ÆÆ 
.
ÆÆ 
ToString
ÆÆ !
(
ÆÆ! "
)
ÆÆ" #
;
ÆÆ# $
}
ØØ 
private
±± 
static
±± 
void
±± %
TryAppendLinuxMachineId
±± /
(
±±/ 0
StringBuilder
±±0 =
	machineId
±±> G
)
±±G H
{
≤≤ 
try
≥≥ 
{
¥¥ 	
string
µµ 
id
µµ 
=
µµ 
File
µµ 
.
µµ 
ReadAllText
µµ (
(
µµ( )#
LINUX_MACHINE_ID_PATH
µµ) >
)
µµ> ?
.
µµ? @
Trim
µµ@ D
(
µµD E
)
µµE F
;
µµF G
	machineId
∂∂ 
.
∂∂ 
Append
∂∂ 
(
∂∂ 
id
∂∂ 
)
∂∂  
;
∂∂  !
}
∑∑ 	
catch
∏∏ 
{
ππ 	
	machineId
∫∫ 
.
∫∫ 
Append
∫∫ 
(
∫∫ 
$str
∫∫ *
)
∫∫* +
;
∫∫+ ,
}
ªª 	
}
ºº 
private
ææ 
static
ææ 
void
ææ  
TryAppendMacOsuuid
ææ *
(
ææ* +
StringBuilder
ææ+ 8
	machineId
ææ9 B
)
ææB C
{
øø 
try
¿¿ 
{
¡¡ 	
using
¬¬ 
System
¬¬ 
.
¬¬ 
Diagnostics
¬¬ $
.
¬¬$ %
Process
¬¬% ,
process
¬¬- 4
=
¬¬5 6
new
¬¬7 :
(
¬¬: ;
)
¬¬; <
{
√√ 
	StartInfo
ƒƒ 
=
ƒƒ 
new
ƒƒ 
System
ƒƒ  &
.
ƒƒ& '
Diagnostics
ƒƒ' 2
.
ƒƒ2 3
ProcessStartInfo
ƒƒ3 C
{
≈≈ 
FileName
∆∆ 
=
∆∆ 
$str
∆∆ &
,
∆∆& '
	Arguments
«« 
=
«« 
$str
««  @
,
««@ A$
RedirectStandardOutput
»» *
=
»»+ ,
true
»»- 1
,
»»1 2
UseShellExecute
…… #
=
……$ %
false
……& +
,
……+ ,
CreateNoWindow
   "
=
  # $
true
  % )
}
ÀÀ 
}
ÃÃ 
;
ÃÃ 
process
ŒŒ 
.
ŒŒ 
Start
ŒŒ 
(
ŒŒ 
)
ŒŒ 
;
ŒŒ 
string
œœ 
output
œœ 
=
œœ 
process
œœ #
.
œœ# $
StandardOutput
œœ$ 2
.
œœ2 3
	ReadToEnd
œœ3 <
(
œœ< =
)
œœ= >
;
œœ> ?
process
–– 
.
–– 
WaitForExit
–– 
(
––  
)
––  !
;
––! "
Match
““ 
match
““ 
=
““ 
Regex
““ 
.
““  
Match
““  %
(
““% &
output
““& ,
,
““, - 
MACOS_UUID_PATTERN
““. @
)
““@ A
;
““A B
	machineId
”” 
.
”” 
Append
”” 
(
”” 
match
”” "
.
””" #
Success
””# *
?
””+ ,
match
””- 2
.
””2 3
Groups
””3 9
[
””9 :
$num
””: ;
]
””; <
.
””< =
Value
””= B
:
””C D
$str
””E M
)
””M N
;
””N O
}
‘‘ 	
catch
’’ 
{
÷÷ 	
	machineId
◊◊ 
.
◊◊ 
Append
◊◊ 
(
◊◊ 
$str
◊◊ &
)
◊◊& '
;
◊◊' (
}
ÿÿ 	
}
ŸŸ 
private
€€ 
static
€€ 
byte
€€ 
[
€€ 
]
€€ $
DeriveKeyFromMachineId
€€ 0
(
€€0 1
string
€€1 7
	machineId
€€8 A
)
€€A B
{
‹‹ 
ReadOnlySpan
›› 
<
›› 
byte
›› 
>
›› 
salt
›› 
=
››  !
SHA256
››" (
.
››( )
HashData
››) 1
(
››1 2
Encoding
››2 :
.
››: ;
UTF8
››; ?
.
››? @
GetBytes
››@ H
(
››H I
MACHINE_KEY_SALT
››I Y
)
››Y Z
)
››Z [
;
››[ \
using
ﬂﬂ  
Rfc2898DeriveBytes
ﬂﬂ  
pbkdf2
ﬂﬂ! '
=
ﬂﬂ( )
new
ﬂﬂ* -
(
ﬂﬂ- .
	machineId
‡‡ 
,
‡‡ 
salt
·· 
.
·· 
ToArray
·· 
(
·· 
)
·· 
,
··  
PBKDF_2_ITERATIONS
‚‚ 
,
‚‚ 
HashAlgorithmName
„„ 
.
„„ 
SHA256
„„ $
)
„„$ %
;
„„% &
return
ÂÂ 
pbkdf2
ÂÂ 
.
ÂÂ 
GetBytes
ÂÂ 
(
ÂÂ 
AES_KEY_SIZE
ÂÂ +
)
ÂÂ+ ,
;
ÂÂ, -
}
ÊÊ 
private
ËË 
static
ËË 
bool
ËË 
CheckLinuxTpm
ËË %
(
ËË% &
)
ËË& '
=>
ËË( *
File
ÈÈ 
.
ÈÈ 
Exists
ÈÈ 
(
ÈÈ 
LINUX_TPM_PATH
ÈÈ "
)
ÈÈ" #
||
ÈÈ$ &
File
ÈÈ' +
.
ÈÈ+ ,
Exists
ÈÈ, 2
(
ÈÈ2 3
LINUX_TPMRM_PATH
ÈÈ3 C
)
ÈÈC D
;
ÈÈD E
private
ÎÎ 
static
ÎÎ 
bool
ÎÎ 
CheckWindowsTpm
ÎÎ '
(
ÎÎ' (
)
ÎÎ( )
{
ÏÏ 
if
ÌÌ 

(
ÌÌ 
!
ÌÌ  
RuntimeInformation
ÌÌ 
.
ÌÌ  
IsOSPlatform
ÌÌ  ,
(
ÌÌ, -

OSPlatform
ÌÌ- 7
.
ÌÌ7 8
Windows
ÌÌ8 ?
)
ÌÌ? @
)
ÌÌ@ A
{
ÓÓ 	
return
ÔÔ 
false
ÔÔ 
;
ÔÔ 
}
 	
try
ÚÚ 
{
ÛÛ 	
using
ÙÙ 
	Microsoft
ÙÙ 
.
ÙÙ 
Win32
ÙÙ !
.
ÙÙ! "
RegistryKey
ÙÙ" -
?
ÙÙ- .
key
ÙÙ/ 2
=
ÙÙ3 4
	Microsoft
ıı 
.
ıı 
Win32
ıı 
.
ıı  
Registry
ıı  (
.
ıı( )
LocalMachine
ıı) 5
.
ıı5 6

OpenSubKey
ıı6 @
(
ıı@ A
TPM_REGISTRY_PATH
ııA R
)
ııR S
;
ııS T
return
ˆˆ 
key
ˆˆ 
!=
ˆˆ 
null
ˆˆ 
;
ˆˆ 
}
˜˜ 	
catch
¯¯ 
{
˘˘ 	
return
˙˙ 
false
˙˙ 
;
˙˙ 
}
˚˚ 	
}
¸¸ 
private
˛˛ 
static
˛˛ 
bool
˛˛ %
CheckMacOsSecureEnclave
˛˛ /
(
˛˛/ 0
)
˛˛0 1
{
ˇˇ 
try
ÄÄ 
{
ÅÅ 	
using
ÇÇ 
System
ÇÇ 
.
ÇÇ 
Diagnostics
ÇÇ $
.
ÇÇ$ %
Process
ÇÇ% ,
process
ÇÇ- 4
=
ÇÇ5 6
new
ÇÇ7 :
(
ÇÇ: ;
)
ÇÇ; <
;
ÇÇ< =
process
ÉÉ 
.
ÉÉ 
	StartInfo
ÉÉ 
=
ÉÉ 
new
ÉÉ  #
System
ÉÉ$ *
.
ÉÉ* +
Diagnostics
ÉÉ+ 6
.
ÉÉ6 7
ProcessStartInfo
ÉÉ7 G
{
ÑÑ 
FileName
ÖÖ 
=
ÖÖ 
$str
ÖÖ #
,
ÖÖ# $
	Arguments
ÜÜ 
=
ÜÜ 
$str
ÜÜ 2
,
ÜÜ2 3$
RedirectStandardOutput
áá &
=
áá' (
true
áá) -
,
áá- .
UseShellExecute
àà 
=
àà  !
false
àà" '
,
àà' (
CreateNoWindow
ââ 
=
ââ  
true
ââ! %
}
ää 
;
ää 
process
åå 
.
åå 
Start
åå 
(
åå 
)
åå 
;
åå 
string
çç 
output
çç 
=
çç 
process
çç #
.
çç# $
StandardOutput
çç$ 2
.
çç2 3
	ReadToEnd
çç3 <
(
çç< =
)
çç= >
;
çç> ?
process
éé 
.
éé 
WaitForExit
éé 
(
éé  
)
éé  !
;
éé! "
return
êê 
output
êê 
.
êê 
Trim
êê 
(
êê 
)
êê  
==
êê! #
$str
êê$ '
;
êê' (
}
ëë 	
catch
íí 
{
ìì 	
return
îî 
false
îî 
;
îî 
}
ïï 	
}
ññ 
}óó î
ï/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/KeySplitting/IHardenedKeyDerivation.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
KeySplitting0 <
;< =
public 
	interface "
IHardenedKeyDerivation '
{		 
Task

 
<

 	
Result

	 
<

 $
SodiumSecureMemoryHandle

 (
,

( )
KeySplittingFailure

* =
>

= >
>

> ?.
"DeriveEnhancedMasterKeyHandleAsync

@ b
(

b c$
SodiumSecureMemoryHandle  
baseKeyHandle! .
,. /
string 
context 
,  
KeyDerivationOptions 
options $
)$ %
;% &
} 
public 
class  
KeyDerivationOptions !
{ 
public 

int 
MEMORY_SIZE 
{ 
get  
;  !
set" %
;% &
}' (
=) *
$num+ 1
;1 2
public 

int 

ITERATIONS 
{ 
get 
;  
set! $
;$ %
}& '
=( )
$num* +
;+ ,
public 

int 
DegreeOfParallelism "
{# $
get% (
;( )
set* -
;- .
}/ 0
=1 2
$num3 4
;4 5
public 

bool 
UseHardwareEntropy "
{# $
get% (
;( )
set* -
;- .
}/ 0
=1 2
true3 7
;7 8
public 

int 
OutputLength 
{ 
get !
;! "
set# &
;& '
}( )
=* +
$num, .
;. /
} é“
î/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/KeySplitting/HardenedKeyDerivation.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
KeySplitting0 <
;< =
public 
sealed 
class !
HardenedKeyDerivation )
() *%
IPlatformSecurityProvider* C$
platformSecurityProviderD \
)\ ]
:^ _"
IHardenedKeyDerivation` v
{ 
private 
async 
Task 
< 
Result 
< 
byte "
[" #
]# $
,$ %
KeySplittingFailure& 9
>9 :
>: ;"
DeriveEnhancedKeyAsync< R
(R S
byte 
[ 
] 
baseKey 
, 
string 
context 
,  
KeyDerivationOptions 
options $
)$ %
{ 
try 
{ 	
byte 
[ 
] 
salt 
= 
GenerateContextSalt -
(- .
context. 5
)5 6
;6 7
Result 
< 
byte 
[ 
] 
, 
KeySplittingFailure .
>. /
stretchedResult0 ?
=@ A
await 
StretchKeyAsync %
(% &
baseKey& -
,- .
salt/ 3
,3 4
options5 <
.< =
OutputLength= I
,I J
optionsK R
)R S
;S T
if 
( 
stretchedResult 
.  
IsErr  %
)% &
{ 
return 
stretchedResult &
;& '
}   
byte"" 
["" 
]"" 
stretchedKey"" 
=""  !
stretchedResult""" 1
.""1 2
Unwrap""2 8
(""8 9
)""9 :
;"": ;
byte## 
[## 
]## 
expandedKey## 
=##  
await##! &"
ExpandKeyWithHkdfAsync##' =
(##= >
stretchedKey##> J
,##J K
context##L S
,##S T
options##U \
.##\ ]
OutputLength##] i
)##i j
;##j k
if%% 
(%% 
options%% 
.%% 
UseHardwareEntropy%% *
&&%%+ -$
platformSecurityProvider%%. F
.%%F G'
IsHardwareSecurityAvailable%%G b
(%%b c
)%%c d
)%%d e
{&& 
byte'' 
['' 
]'' 
?'' 
	hwEntropy'' !
=''" #
null''$ (
;''( )
try(( 
{)) 
	hwEntropy** 
=** 
await**  %$
platformSecurityProvider**& >
.**> ?%
GenerateSecureRandomAsync**? X
(**X Y
options**Y `
.**` a
OutputLength**a m
)**m n
;**n o
for++ 
(++ 
int++ 
i++ 
=++  
$num++! "
;++" #
i++$ %
<++& '
expandedKey++( 3
.++3 4
Length++4 :
&&++; =
i++> ?
<++@ A
	hwEntropy++B K
.++K L
Length++L R
;++R S
i++T U
++++U W
)++W X
{,, 
expandedKey-- #
[--# $
i--$ %
]--% &
^=--' )
	hwEntropy--* 3
[--3 4
i--4 5
]--5 6
;--6 7
}.. 
}// 
finally00 
{11 
if22 
(22 
	hwEntropy22 !
!=22" $
null22% )
)22) *
{33 #
CryptographicOperations44 /
.44/ 0

ZeroMemory440 :
(44: ;
	hwEntropy44; D
)44D E
;44E F
}55 
}66 
}77 
byte99 
[99 
]99 
finalKey99 
=99 
await99 #&
ApplyAdditionalRoundsAsync99$ >
(99> ?
expandedKey99? J
)99J K
;99K L#
CryptographicOperations;; #
.;;# $

ZeroMemory;;$ .
(;;. /
stretchedKey;;/ ;
);;; <
;;;< =#
CryptographicOperations<< #
.<<# $

ZeroMemory<<$ .
(<<. /
expandedKey<</ :
)<<: ;
;<<; <
return>> 
Result>> 
<>> 
byte>> 
[>> 
]>>  
,>>  !
KeySplittingFailure>>" 5
>>>5 6
.>>6 7
Ok>>7 9
(>>9 :
finalKey>>: B
)>>B C
;>>C D
}?? 	
catch@@ 
(@@ 
	Exception@@ 
ex@@ 
)@@ 
{AA 	
returnBB 
ResultBB 
<BB 
byteBB 
[BB 
]BB  
,BB  !
KeySplittingFailureBB" 5
>BB5 6
.BB6 7
ErrBB7 :
(BB: ;
KeySplittingFailureBB; N
.BBN O
KeyDerivationFailedBBO b
(BBb c
exBBc e
.BBe f
MessageBBf m
,BBm n
exBBo q
)BBq r
)BBr s
;BBs t
}CC 	
}DD 
privateFF 
asyncFF 
TaskFF 
<FF 
ResultFF 
<FF 
byteFF "
[FF" #
]FF# $
,FF$ %
KeySplittingFailureFF& 9
>FF9 :
>FF: ;
StretchKeyAsyncFF< K
(FFK L
byteGG 
[GG 
]GG 
inputGG 
,GG 
byteHH 
[HH 
]HH 
saltHH 
,HH 
intII 
outputLengthII 
,II  
KeyDerivationOptionsJJ 
optionsJJ $
)JJ$ %
{KK 
tryLL 
{MM 	
returnNN 
awaitNN 
TaskNN 
.NN 
RunNN !
(NN! "
(NN" #
)NN# $
=>NN% '
{OO 
usingPP 
Argon2idPP 
argon2PP %
=PP& '
newPP( +
(PP+ ,
inputPP, 1
)PP1 2
{QQ 
SaltRR 
=RR 
saltRR 
,RR  
DegreeOfParallelismSS '
=SS( )
optionsSS* 1
.SS1 2
DegreeOfParallelismSS2 E
,SSE F

IterationsTT 
=TT  
optionsTT! (
.TT( )

ITERATIONSTT) 3
,TT3 4

MemorySizeUU 
=UU  
optionsUU! (
.UU( )
MEMORY_SIZEUU) 4
}VV 
;VV 
byteXX 
[XX 
]XX 
hashXX 
=XX 
argon2XX $
.XX$ %
GetBytesXX% -
(XX- .
outputLengthXX. :
)XX: ;
;XX; <
returnYY 
ResultYY 
<YY 
byteYY "
[YY" #
]YY# $
,YY$ %
KeySplittingFailureYY& 9
>YY9 :
.YY: ;
OkYY; =
(YY= >
hashYY> B
)YYB C
;YYC D
}ZZ 
)ZZ 
;ZZ 
}[[ 	
catch\\ 
(\\ 
	Exception\\ 
ex\\ 
)\\ 
{]] 	
return^^ 
Result^^ 
<^^ 
byte^^ 
[^^ 
]^^  
,^^  !
KeySplittingFailure^^" 5
>^^5 6
.^^6 7
Err^^7 :
(^^: ;
KeySplittingFailure^^; N
.^^N O
KeyDerivationFailed^^O b
(^^b c
ex^^c e
.^^e f
Message^^f m
,^^m n
ex^^o q
)^^q r
)^^r s
;^^s t
}__ 	
}`` 
privatebb 
staticbb 
bytebb 
[bb 
]bb 
GenerateContextSaltbb -
(bb- .
stringbb. 4
contextbb5 <
)bb< =
{cc 
stringdd 
	saltInputdd 
=dd 
$"dd 
{dd 
StorageKeyConstantsdd 1
.dd1 2
SessionContextdd2 @
.dd@ A
SESSION_KEY_PREFIXddA S
}ddS T
$strddT U
{ddU V
contextddV ]
}dd] ^
"dd^ _
;dd_ `
byteee 
[ee 
]ee 
	saltBytesee 
=ee 
SHA256ee !
.ee! "
HashDataee" *
(ee* +
Encodingee+ 3
.ee3 4
UTF8ee4 8
.ee8 9
GetBytesee9 A
(eeA B
	saltInputeeB K
)eeK L
)eeL M
;eeM N
returnff 
	saltBytesff 
;ff 
}gg 
privateii 
staticii 
asyncii 
Taskii 
<ii 
byteii "
[ii" #
]ii# $
>ii$ %"
ExpandKeyWithHkdfAsyncii& <
(ii< =
byteii= A
[iiA B
]iiB C
keyiiD G
,iiG H
stringiiI O
contextiiP W
,iiW X
intiiY \
outputLengthii] i
)iii j
{jj 
returnkk 
awaitkk 
Taskkk 
.kk 
Runkk 
(kk 
(kk 
)kk  
=>kk! #
{ll 	
Spanmm 
<mm 
bytemm 
>mm 

infoBuffermm !
=mm" #

stackallocmm$ .
bytemm/ 3
[mm3 4"
CryptographicConstantsmm4 J
.mmJ K
BuffermmK Q
.mmQ R
MAX_INFO_SIZEmmR _
]mm_ `
;mm` a
intnn 

infoLengthnn 
=nn 
Encodingnn %
.nn% &
UTF8nn& *
.nn* +
GetBytesnn+ 3
(nn3 4
$"nn4 6
{nn6 7
StorageKeyConstantsnn7 J
.nnJ K
SessionContextnnK Y
.nnY Z
SESSION_KEY_PREFIXnnZ l
}nnl m
$strnnm n
{nnn o
contextnno v
}nnv w
"nnw x
,nnx y

infoBuffer	nnz Ñ
)
nnÑ Ö
;
nnÖ Ü
ReadOnlySpanoo 
<oo 
byteoo 
>oo 
infooo #
=oo$ %

infoBufferoo& 0
[oo0 1
..oo1 3

infoLengthoo3 =
]oo= >
;oo> ?
byteqq 
[qq 
]qq 
saltqq 
=qq 
SHA256qq  
.qq  !
HashDataqq! )
(qq) *
Encodingqq* 2
.qq2 3
UTF8qq3 7
.qq7 8
GetBytesqq8 @
(qq@ A
contextqqA H
)qqH I
)qqI J
;qqJ K
bytess 
[ss 
]ss 
pseudoRandomKeyss "
;ss" #
usingtt 
(tt 

HMACSHA512tt 
hmactt "
=tt# $
newtt% (
(tt( )
salttt) -
)tt- .
)tt. /
{uu 
pseudoRandomKeyvv 
=vv  !
hmacvv" &
.vv& '
ComputeHashvv' 2
(vv2 3
keyvv3 6
)vv6 7
;vv7 8
}ww 
byteyy 
[yy 
]yy 
expandedKeyyy 
=yy  
newyy! $
byteyy% )
[yy) *
outputLengthyy* 6
]yy6 7
;yy7 8
intzz 
bytesGeneratedzz 
=zz  
$numzz! "
;zz" #
using|| 

HMACSHA512|| 

expandHmac|| '
=||( )
new||* -
(||- .
pseudoRandomKey||. =
)||= >
;||> ?
byte}} 
[}} 
]}} 
previousBlock}}  
=}}! "
[}}# $
]}}$ %
;}}% &
int 
maxDataToHashSize !
=" #"
CryptographicConstants$ :
.: ;
Buffer; A
.A B#
MAX_PREVIOUS_BLOCK_SIZEB Y
+Z ["
CryptographicConstants\ r
.r s
Buffers y
.y z
MAX_INFO_SIZE	z á
+
à â
$num
ä ã
;
ã å
byte
ÄÄ 
[
ÄÄ 
]
ÄÄ 
dataToHashBuffer
ÄÄ #
=
ÄÄ$ %
	ArrayPool
ÄÄ& /
<
ÄÄ/ 0
byte
ÄÄ0 4
>
ÄÄ4 5
.
ÄÄ5 6
Shared
ÄÄ6 <
.
ÄÄ< =
Rent
ÄÄ= A
(
ÄÄA B
maxDataToHashSize
ÄÄB S
)
ÄÄS T
;
ÄÄT U
try
ÇÇ 
{
ÉÉ 
for
ÑÑ 
(
ÑÑ 
int
ÑÑ 
i
ÑÑ 
=
ÑÑ 
$num
ÑÑ 
;
ÑÑ 
bytesGenerated
ÑÑ  .
<
ÑÑ/ 0
outputLength
ÑÑ1 =
;
ÑÑ= >
i
ÑÑ? @
++
ÑÑ@ B
)
ÑÑB C
{
ÖÖ 
int
ÜÜ 
offset
ÜÜ 
=
ÜÜ  
$num
ÜÜ! "
;
ÜÜ" #
previousBlock
áá !
.
áá! "
CopyTo
áá" (
(
áá( )
dataToHashBuffer
áá) 9
,
áá9 :
offset
áá; A
)
ááA B
;
ááB C
offset
àà 
+=
àà 
previousBlock
àà +
.
àà+ ,
Length
àà, 2
;
àà2 3
info
ââ 
.
ââ 
CopyTo
ââ 
(
ââ  
dataToHashBuffer
ââ  0
.
ââ0 1
AsSpan
ââ1 7
(
ââ7 8
offset
ââ8 >
)
ââ> ?
)
ââ? @
;
ââ@ A
offset
ää 
+=
ää 
info
ää "
.
ää" #
Length
ää# )
;
ää) *
dataToHashBuffer
ãã $
[
ãã$ %
offset
ãã% +
]
ãã+ ,
=
ãã- .
(
ãã/ 0
byte
ãã0 4
)
ãã4 5
i
ãã5 6
;
ãã6 7
offset
åå 
++
åå 
;
åå 
byte
éé 
[
éé 
]
éé 
currentBlock
éé '
=
éé( )

expandHmac
éé* 4
.
éé4 5
ComputeHash
éé5 @
(
éé@ A
dataToHashBuffer
ééA Q
,
ééQ R
$num
ééS T
,
ééT U
offset
ééV \
)
éé\ ]
;
éé] ^
int
êê 
bytesToCopy
êê #
=
êê$ %
Math
êê& *
.
êê* +
Min
êê+ .
(
êê. /
currentBlock
êê/ ;
.
êê; <
Length
êê< B
,
êêB C
outputLength
êêD P
-
êêQ R
bytesGenerated
êêS a
)
êêa b
;
êêb c
Array
ëë 
.
ëë 
Copy
ëë 
(
ëë 
currentBlock
ëë +
,
ëë+ ,
$num
ëë- .
,
ëë. /
expandedKey
ëë0 ;
,
ëë; <
bytesGenerated
ëë= K
,
ëëK L
bytesToCopy
ëëM X
)
ëëX Y
;
ëëY Z
bytesGenerated
ìì "
+=
ìì# %
bytesToCopy
ìì& 1
;
ìì1 2
previousBlock
îî !
=
îî" #
currentBlock
îî$ 0
;
îî0 1
}
ïï 
}
ññ 
finally
óó 
{
òò 
	ArrayPool
ôô 
<
ôô 
byte
ôô 
>
ôô 
.
ôô  
Shared
ôô  &
.
ôô& '
Return
ôô' -
(
ôô- .
dataToHashBuffer
ôô. >
,
ôô> ?

clearArray
ôô@ J
:
ôôJ K
true
ôôL P
)
ôôP Q
;
ôôQ R
}
öö %
CryptographicOperations
úú #
.
úú# $

ZeroMemory
úú$ .
(
úú. /
pseudoRandomKey
úú/ >
)
úú> ?
;
úú? @
return
ùù 
expandedKey
ùù 
;
ùù 
}
ûû 	
)
ûû	 

;
ûû
 
}
üü 
private
°° 
static
°° 
async
°° 
Task
°° 
<
°° 
byte
°° "
[
°°" #
]
°°# $
>
°°$ %(
ApplyAdditionalRoundsAsync
°°& @
(
°°@ A
byte
°°A E
[
°°E F
]
°°F G
key
°°H K
)
°°K L
{
¢¢ 
return
££ 
await
££ 
Task
££ 
.
££ 
Run
££ 
(
££ 
(
££ 
)
££  
=>
££! #
{
§§ 	
byte
•• 
[
•• 
]
•• 
result
•• 
=
•• 
(
•• 
byte
•• !
[
••! "
]
••" #
)
••# $
key
••$ '
.
••' (
Clone
••( -
(
••- .
)
••. /
;
••/ 0
Span
ßß 
<
ßß 
byte
ßß 
>
ßß 
roundBuffer
ßß "
=
ßß# $

stackalloc
ßß% /
byte
ßß0 4
[
ßß4 5$
CryptographicConstants
ßß5 K
.
ßßK L
Buffer
ßßL R
.
ßßR S
MAX_ROUND_SIZE
ßßS a
]
ßßa b
;
ßßb c
for
©© 
(
©© 
int
©© 
round
©© 
=
©© 
$num
©© 
;
©© 
round
©©  %
<
©©& '$
CryptographicConstants
©©( >
.
©©> ?
KeyDerivation
©©? L
.
©©L M%
ADDITIONAL_ROUNDS_COUNT
©©M d
;
©©d e
round
©©f k
++
©©k m
)
©©m n
{
™™ 
using
´´ 

HMACSHA512
´´  
hmac
´´! %
=
´´& '
new
´´( +
(
´´+ ,
result
´´, 2
)
´´2 3
;
´´3 4
int
¨¨ 
roundInputLength
¨¨ $
=
¨¨% &
Encoding
¨¨' /
.
¨¨/ 0
UTF8
¨¨0 4
.
¨¨4 5
GetBytes
¨¨5 =
(
¨¨= >
string
¨¨> D
.
¨¨D E
Format
¨¨E K
(
¨¨K L$
CryptographicConstants
¨¨L b
.
¨¨b c
KeyDerivation
¨¨c p
.
¨¨p q
ROUND_KEY_FORMAT¨¨q Å
,¨¨Å Ç
round¨¨É à
)¨¨à â
,¨¨â ä
roundBuffer¨¨ã ñ
)¨¨ñ ó
;¨¨ó ò
byte
≠≠ 
[
≠≠ 
]
≠≠ 
roundKey
≠≠ 
=
≠≠  !
hmac
≠≠" &
.
≠≠& '
ComputeHash
≠≠' 2
(
≠≠2 3
roundBuffer
≠≠3 >
[
≠≠> ?
..
≠≠? A
roundInputLength
≠≠A Q
]
≠≠Q R
.
≠≠R S
ToArray
≠≠S Z
(
≠≠Z [
)
≠≠[ \
)
≠≠\ ]
;
≠≠] ^
for
ØØ 
(
ØØ 
int
ØØ 
i
ØØ 
=
ØØ 
$num
ØØ 
;
ØØ 
i
ØØ  !
<
ØØ" #
result
ØØ$ *
.
ØØ* +
Length
ØØ+ 1
&&
ØØ2 4
i
ØØ5 6
<
ØØ7 8
roundKey
ØØ9 A
.
ØØA B
Length
ØØB H
;
ØØH I
i
ØØJ K
++
ØØK M
)
ØØM N
{
∞∞ 
result
±± 
[
±± 
i
±± 
]
±± 
^=
±±  
roundKey
±±! )
[
±±) *
i
±±* +
]
±±+ ,
;
±±, -
}
≤≤ 
byte
¥¥ 
[
¥¥ 
]
¥¥ 
temp
¥¥ 
=
¥¥ 
SHA512
¥¥ $
.
¥¥$ %
HashData
¥¥% -
(
¥¥- .
result
¥¥. 4
)
¥¥4 5
;
¥¥5 6
Array
µµ 
.
µµ 
Copy
µµ 
(
µµ 
temp
µµ 
,
µµ  
result
µµ! '
,
µµ' (
Math
µµ) -
.
µµ- .
Min
µµ. 1
(
µµ1 2
temp
µµ2 6
.
µµ6 7
Length
µµ7 =
,
µµ= >
result
µµ? E
.
µµE F
Length
µµF L
)
µµL M
)
µµM N
;
µµN O
}
∂∂ 
return
∏∏ 
result
∏∏ 
;
∏∏ 
}
ππ 	
)
ππ	 

;
ππ
 
}
∫∫ 
public
ºº 

async
ºº 
Task
ºº 
<
ºº 
Result
ºº 
<
ºº &
SodiumSecureMemoryHandle
ºº 5
,
ºº5 6!
KeySplittingFailure
ºº7 J
>
ººJ K
>
ººK L0
"DeriveEnhancedMasterKeyHandleAsync
ººM o
(
ººo p&
SodiumSecureMemoryHandle
ΩΩ  
baseKeyHandle
ΩΩ! .
,
ΩΩ. /
string
ææ 
context
ææ 
,
ææ "
KeyDerivationOptions
øø 
options
øø $
)
øø$ %
{
¿¿ 
byte
¡¡ 
[
¡¡ 
]
¡¡ 
?
¡¡ 
baseKeyBytes
¡¡ 
=
¡¡ 
null
¡¡ #
;
¡¡# $
try
√√ 
{
ƒƒ 	
Result
≈≈ 
<
≈≈ 
byte
≈≈ 
[
≈≈ 
]
≈≈ 
,
≈≈ 
SodiumFailure
≈≈ (
>
≈≈( )

readResult
≈≈* 4
=
≈≈5 6
baseKeyHandle
∆∆ 
.
∆∆ 
	ReadBytes
∆∆ '
(
∆∆' (
baseKeyHandle
∆∆( 5
.
∆∆5 6
Length
∆∆6 <
)
∆∆< =
;
∆∆= >
if
«« 
(
«« 

readResult
«« 
.
«« 
IsErr
««  
)
««  !
{
»» 
return
…… 
Result
…… 
<
…… &
SodiumSecureMemoryHandle
…… 6
,
……6 7!
KeySplittingFailure
……8 K
>
……K L
.
……L M
Err
……M P
(
……P Q!
KeySplittingFailure
   '
.
  ' (
MemoryReadFailed
  ( 8
(
  8 9

readResult
  9 C
.
  C D
	UnwrapErr
  D M
(
  M N
)
  N O
.
  O P
Message
  P W
)
  W X
)
  X Y
;
  Y Z
}
ÀÀ 
baseKeyBytes
ÕÕ 
=
ÕÕ 

readResult
ÕÕ %
.
ÕÕ% &
Unwrap
ÕÕ& ,
(
ÕÕ, -
)
ÕÕ- .
;
ÕÕ. /
Result
œœ 
<
œœ 
byte
œœ 
[
œœ 
]
œœ 
,
œœ !
KeySplittingFailure
œœ .
>
œœ. /
deriveResult
œœ0 <
=
œœ= >
await
–– $
DeriveEnhancedKeyAsync
–– ,
(
––, -
baseKeyBytes
––- 9
,
––9 :
context
––; B
,
––B C
options
––D K
)
––K L
;
––L M
if
—— 
(
—— 
deriveResult
—— 
.
—— 
IsErr
—— "
)
——" #
{
““ 
return
”” 
Result
”” 
<
”” &
SodiumSecureMemoryHandle
”” 6
,
””6 7!
KeySplittingFailure
””8 K
>
””K L
.
””L M
Err
””M P
(
””P Q
deriveResult
””Q ]
.
””] ^
	UnwrapErr
””^ g
(
””g h
)
””h i
)
””i j
;
””j k
}
‘‘ 
byte
÷÷ 
[
÷÷ 
]
÷÷ 

derivedKey
÷÷ 
=
÷÷ 
deriveResult
÷÷  ,
.
÷÷, -
Unwrap
÷÷- 3
(
÷÷3 4
)
÷÷4 5
;
÷÷5 6
try
ÿÿ 
{
ŸŸ 
Result
⁄⁄ 
<
⁄⁄ &
SodiumSecureMemoryHandle
⁄⁄ /
,
⁄⁄/ 0
SodiumFailure
⁄⁄1 >
>
⁄⁄> ?
allocateResult
⁄⁄@ N
=
⁄⁄O P&
SodiumSecureMemoryHandle
€€ ,
.
€€, -
Allocate
€€- 5
(
€€5 6

derivedKey
€€6 @
.
€€@ A
Length
€€A G
)
€€G H
;
€€H I
if
‹‹ 
(
‹‹ 
allocateResult
‹‹ "
.
‹‹" #
IsErr
‹‹# (
)
‹‹( )
{
›› 
return
ﬁﬁ 
Result
ﬁﬁ !
<
ﬁﬁ! "&
SodiumSecureMemoryHandle
ﬁﬁ" :
,
ﬁﬁ: ;!
KeySplittingFailure
ﬁﬁ< O
>
ﬁﬁO P
.
ﬁﬁP Q
Err
ﬁﬁQ T
(
ﬁﬁT U!
KeySplittingFailure
ﬂﬂ +
.
ﬂﬂ+ ,
ALLOCATION_FAILED
ﬂﬂ, =
(
ﬂﬂ= >
allocateResult
ﬂﬂ> L
.
ﬂﬂL M
	UnwrapErr
ﬂﬂM V
(
ﬂﬂV W
)
ﬂﬂW X
.
ﬂﬂX Y
Message
ﬂﬂY `
)
ﬂﬂ` a
)
ﬂﬂa b
;
ﬂﬂb c
}
‡‡ &
SodiumSecureMemoryHandle
‚‚ (
handle
‚‚) /
=
‚‚0 1
allocateResult
‚‚2 @
.
‚‚@ A
Unwrap
‚‚A G
(
‚‚G H
)
‚‚H I
;
‚‚I J
Result
‰‰ 
<
‰‰ 
Unit
‰‰ 
,
‰‰ 
SodiumFailure
‰‰ *
>
‰‰* +
writeResult
‰‰, 7
=
‰‰8 9
handle
‰‰: @
.
‰‰@ A
Write
‰‰A F
(
‰‰F G

derivedKey
‰‰G Q
)
‰‰Q R
;
‰‰R S
if
ÂÂ 
(
ÂÂ 
writeResult
ÂÂ 
.
ÂÂ  
IsErr
ÂÂ  %
)
ÂÂ% &
{
ÊÊ 
handle
ÁÁ 
.
ÁÁ 
Dispose
ÁÁ "
(
ÁÁ" #
)
ÁÁ# $
;
ÁÁ$ %
return
ËË 
Result
ËË !
<
ËË! "&
SodiumSecureMemoryHandle
ËË" :
,
ËË: ;!
KeySplittingFailure
ËË< O
>
ËËO P
.
ËËP Q
Err
ËËQ T
(
ËËT U!
KeySplittingFailure
ÈÈ +
.
ÈÈ+ ,
MemoryWriteFailed
ÈÈ, =
(
ÈÈ= >
writeResult
ÈÈ> I
.
ÈÈI J
	UnwrapErr
ÈÈJ S
(
ÈÈS T
)
ÈÈT U
.
ÈÈU V
Message
ÈÈV ]
)
ÈÈ] ^
)
ÈÈ^ _
;
ÈÈ_ `
}
ÍÍ 
return
ÏÏ 
Result
ÏÏ 
<
ÏÏ &
SodiumSecureMemoryHandle
ÏÏ 6
,
ÏÏ6 7!
KeySplittingFailure
ÏÏ8 K
>
ÏÏK L
.
ÏÏL M
Ok
ÏÏM O
(
ÏÏO P
handle
ÏÏP V
)
ÏÏV W
;
ÏÏW X
}
ÌÌ 
finally
ÓÓ 
{
ÔÔ %
CryptographicOperations
 '
.
' (

ZeroMemory
( 2
(
2 3

derivedKey
3 =
)
= >
;
> ?
}
ÒÒ 
}
ÚÚ 	
catch
ÛÛ 
(
ÛÛ 
	Exception
ÛÛ 
ex
ÛÛ 
)
ÛÛ 
{
ÙÙ 	
return
ıı 
Result
ıı 
<
ıı &
SodiumSecureMemoryHandle
ıı 2
,
ıı2 3!
KeySplittingFailure
ıı4 G
>
ııG H
.
ııH I
Err
ııI L
(
ııL M!
KeySplittingFailure
ˆˆ #
.
ˆˆ# $!
KeyDerivationFailed
ˆˆ$ 7
(
ˆˆ7 8
ex
ˆˆ8 :
.
ˆˆ: ;
Message
ˆˆ; B
,
ˆˆB C
ex
ˆˆD F
)
ˆˆF G
)
ˆˆG H
;
ˆˆH I
}
˜˜ 	
finally
¯¯ 
{
˘˘ 	
if
˙˙ 
(
˙˙ 
baseKeyBytes
˙˙ 
!=
˙˙ 
null
˙˙  $
)
˙˙$ %
{
˚˚ %
CryptographicOperations
¸¸ '
.
¸¸' (

ZeroMemory
¸¸( 2
(
¸¸2 3
baseKeyBytes
¸¸3 ?
)
¸¸? @
;
¸¸@ A
}
˝˝ 
}
˛˛ 	
}
ˇˇ 
}ÄÄ ˜
ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Crypto/RsaChunkEncryptor.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Crypto0 6
;6 7
public

 
sealed

 
class

 
RsaChunkEncryptor

 %
:

& '
IRsaChunkEncryptor

( :
{ 
private 
const 
int 
RSA_MAX_CHUNK_SIZE (
=) *
$num+ .
;. /
private 
const 
int $
RSA_ENCRYPTED_CHUNK_SIZE .
=/ 0
$num1 4
;4 5
public 

Result 
< 
byte 
[ 
] 
, 
NetworkFailure (
>( )
EncryptInChunks* 9
(9 :%
CertificatePinningService !%
certificatePinningService" ;
,; <
byte 
[ 
] 
originalData 
) 
{ !
ArgumentNullException 
. 
ThrowIfNull )
() *%
certificatePinningService* C
)C D
;D E!
ArgumentNullException 
. 
ThrowIfNull )
() *
originalData* 6
)6 7
;7 8
int 

chunkCount 
= 
( 
originalData &
.& '
Length' -
+. /
RSA_MAX_CHUNK_SIZE0 B
-C D
$numE F
)F G
/H I
RSA_MAX_CHUNK_SIZEJ \
;\ ]
int 
estimatedSize 
= 

chunkCount &
*' ($
RSA_ENCRYPTED_CHUNK_SIZE) A
;A B
byte 
[ 
] 
rentedBuffer 
= 
	ArrayPool '
<' (
byte( ,
>, -
.- .
Shared. 4
.4 5
Rent5 9
(9 :
estimatedSize: G
)G H
;H I
try 
{ 	
int 
currentOffset 
= 
$num  !
;! "
for 
( 
int 
offset 
= 
$num 
;  
offset! '
<( )
originalData* 6
.6 7
Length7 =
;= >
offset? E
+=F H
RSA_MAX_CHUNK_SIZEI [
)[ \
{ 
int   
	chunkSize   
=   
Math    $
.  $ %
Min  % (
(  ( )
RSA_MAX_CHUNK_SIZE  ) ;
,  ; <
originalData  = I
.  I J
Length  J P
-  Q R
offset  S Y
)  Y Z
;  Z [
Memory!! 
<!! 
byte!! 
>!! 
chunk!! "
=!!# $
originalData!!% 1
.!!1 2
AsMemory!!2 :
(!!: ;
offset!!; A
,!!A B
	chunkSize!!C L
)!!L M
;!!M N-
!CertificatePinningByteArrayResult## 1
chunkResult##2 =
=##> ?%
certificatePinningService$$ -
.$$- .
Encrypt$$. 5
($$5 6
chunk$$6 ;
)$$; <
;$$< =
if&& 
(&& 
chunkResult&& 
.&&  
ERROR&&  %
!=&&& (
null&&) -
)&&- .
{'' 
return(( 
Result(( !
<((! "
byte((" &
[((& '
]((' (
,((( )
NetworkFailure((* 8
>((8 9
.((9 :
Err((: =
(((= >
NetworkFailure)) &
.))& '
RsaEncryption))' 4
())4 5
$"))5 7
$str))7 N
{))N O
chunkResult))O Z
.))Z [
ERROR))[ `
.))` a
Message))a h
}))h i
"))i j
)))j k
)))k l
;))l m
}** 
if,, 
(,, 
chunkResult,, 
.,,  
Value,,  %
==,,& (
null,,) -
),,- .
{-- 
continue.. 
;.. 
}// 
int11 
encryptedLength11 #
=11$ %
chunkResult11& 1
.111 2
Value112 7
.117 8
Length118 >
;11> ?
if22 
(22 
currentOffset22 !
+22" #
encryptedLength22$ 3
>224 5
rentedBuffer226 B
.22B C
Length22C I
)22I J
{33 
byte44 
[44 
]44 
	newBuffer44 $
=44% &
	ArrayPool44' 0
<440 1
byte441 5
>445 6
.446 7
Shared447 =
.44= >
Rent44> B
(44B C
currentOffset44C P
+44Q R
encryptedLength44S b
)44b c
;44c d
Array55 
.55 
Copy55 
(55 
rentedBuffer55 +
,55+ ,
$num55- .
,55. /
	newBuffer550 9
,559 :
$num55; <
,55< =
currentOffset55> K
)55K L
;55L M
	ArrayPool66 
<66 
byte66 "
>66" #
.66# $
Shared66$ *
.66* +
Return66+ 1
(661 2
rentedBuffer662 >
)66> ?
;66? @
rentedBuffer77  
=77! "
	newBuffer77# ,
;77, -
}88 
Array:: 
.:: 
Copy:: 
(:: 
chunkResult:: &
.::& '
Value::' ,
,::, -
$num::. /
,::/ 0
rentedBuffer::1 =
,::= >
currentOffset::? L
,::L M
encryptedLength::N ]
)::] ^
;::^ _
currentOffset;; 
+=;;  
encryptedLength;;! 0
;;;0 1
}<< 
byte>> 
[>> 
]>> 
result>> 
=>> 
new>> 
byte>>  $
[>>$ %
currentOffset>>% 2
]>>2 3
;>>3 4
Array?? 
.?? 
Copy?? 
(?? 
rentedBuffer?? #
,??# $
$num??% &
,??& '
result??( .
,??. /
$num??0 1
,??1 2
currentOffset??3 @
)??@ A
;??A B
return@@ 
Result@@ 
<@@ 
byte@@ 
[@@ 
]@@  
,@@  !
NetworkFailure@@" 0
>@@0 1
.@@1 2
Ok@@2 4
(@@4 5
result@@5 ;
)@@; <
;@@< =
}AA 	
catchBB 
(BB "
CryptographicExceptionBB %
exBB& (
)BB( )
{CC 	
returnDD 
ResultDD 
<DD 
byteDD 
[DD 
]DD  
,DD  !
NetworkFailureDD" 0
>DD0 1
.DD1 2
ErrDD2 5
(DD5 6
NetworkFailureEE 
.EE 
RsaEncryptionEE ,
(EE, -
$"EE- /
$strEE/ D
{EED E
exEEE G
.EEG H
MessageEEH O
}EEO P
"EEP Q
)EEQ R
)EER S
;EES T
}FF 	
catchGG 
(GG  
OutOfMemoryExceptionGG #
exGG$ &
)GG& '
{HH 	
returnII 
ResultII 
<II 
byteII 
[II 
]II  
,II  !
NetworkFailureII" 0
>II0 1
.II1 2
ErrII2 5
(II5 6
NetworkFailureJJ 
.JJ 
RsaEncryptionJJ ,
(JJ, -
$"JJ- /
$strJJ/ N
{JJN O
exJJO Q
.JJQ R
MessageJJR Y
}JJY Z
"JJZ [
)JJ[ \
)JJ\ ]
;JJ] ^
}KK 	
catchLL 
(LL 
ArgumentExceptionLL  
exLL! #
)LL# $
{MM 	
returnNN 
ResultNN 
<NN 
byteNN 
[NN 
]NN  
,NN  !
NetworkFailureNN" 0
>NN0 1
.NN1 2
ErrNN2 5
(NN5 6
NetworkFailureOO 
.OO 
RsaEncryptionOO ,
(OO, -
$"OO- /
$strOO/ N
{OON O
exOOO Q
.OOQ R
MessageOOR Y
}OOY Z
"OOZ [
)OO[ \
)OO\ ]
;OO] ^
}PP 	
catchQQ 
(QQ 
	ExceptionQQ 
exQQ 
)QQ 
{RR 	
returnSS 
ResultSS 
<SS 
byteSS 
[SS 
]SS  
,SS  !
NetworkFailureSS" 0
>SS0 1
.SS1 2
ErrSS2 5
(SS5 6
NetworkFailureTT 
.TT 
RsaEncryptionTT ,
(TT, -
$"TT- /
$strTT/ B
{TTB C
exTTC E
.TTE F
MessageTTF M
}TTM N
"TTN O
)TTO P
)TTP Q
;TTQ R
}UU 	
finallyVV 
{WW 	
	ArrayPoolXX 
<XX 
byteXX 
>XX 
.XX 
SharedXX "
.XX" #
ReturnXX# )
(XX) *
rentedBufferXX* 6
)XX6 7
;XX7 8
}YY 	
}ZZ 
public\\ 

Result\\ 
<\\ 
byte\\ 
[\\ 
]\\ 
,\\ 
NetworkFailure\\ (
>\\( )
DecryptInChunks\\* 9
(\\9 :%
CertificatePinningService]] !%
certificatePinningService]]" ;
,]]; <
byte^^ 
[^^ 
]^^ !
combinedEncryptedData^^ $
)^^$ %
{__ !
ArgumentNullException`` 
.`` 
ThrowIfNull`` )
(``) *%
certificatePinningService``* C
)``C D
;``D E!
ArgumentNullExceptionaa 
.aa 
ThrowIfNullaa )
(aa) *!
combinedEncryptedDataaa* ?
)aa? @
;aa@ A
intcc 

chunkCountcc 
=cc 
(cc !
combinedEncryptedDatacc /
.cc/ 0
Lengthcc0 6
+cc7 8$
RSA_ENCRYPTED_CHUNK_SIZEcc9 Q
-ccR S
$numccT U
)ccU V
/ccW X$
RSA_ENCRYPTED_CHUNK_SIZEccY q
;ccq r
intdd 
estimatedSizedd 
=dd 

chunkCountdd &
*dd' (
RSA_MAX_CHUNK_SIZEdd) ;
;dd; <
byteee 
[ee 
]ee 
rentedBufferee 
=ee 
	ArrayPoolee '
<ee' (
byteee( ,
>ee, -
.ee- .
Sharedee. 4
.ee4 5
Rentee5 9
(ee9 :
estimatedSizeee: G
)eeG H
;eeH I
trygg 
{hh 	
intii 
currentOffsetii 
=ii 
$numii  !
;ii! "
forkk 
(kk 
intkk 
offsetkk 
=kk 
$numkk 
;kk  
offsetkk! '
<kk( )!
combinedEncryptedDatakk* ?
.kk? @
Lengthkk@ F
;kkF G
offsetkkH N
+=kkO Q$
RSA_ENCRYPTED_CHUNK_SIZEkkR j
)kkj k
{ll 
intmm 
	chunkSizemm 
=mm 
Mathmm  $
.mm$ %
Minmm% (
(mm( )$
RSA_ENCRYPTED_CHUNK_SIZEmm) A
,mmA B!
combinedEncryptedDatammC X
.mmX Y
LengthmmY _
-mm` a
offsetmmb h
)mmh i
;mmi j
Memorynn 
<nn 
bytenn 
>nn 
encryptedChunknn +
=nn, -!
combinedEncryptedDatann. C
.nnC D
AsMemorynnD L
(nnL M
offsetnnM S
,nnS T
	chunkSizennU ^
)nn^ _
;nn_ `-
!CertificatePinningByteArrayResultpp 1
chunkDecryptResultpp2 D
=ppE F%
certificatePinningServiceqq -
.qq- .
Decryptqq. 5
(qq5 6
encryptedChunkqq6 D
)qqD E
;qqE F
ifss 
(ss 
!ss 
chunkDecryptResultss '
.ss' (
	IsSuccessss( 1
)ss1 2
{tt 
returnuu 
Resultuu !
<uu! "
byteuu" &
[uu& '
]uu' (
,uu( )
NetworkFailureuu* 8
>uu8 9
.uu9 :
Erruu: =
(uu= >
NetworkFailurevv &
.vv& '#
DataCenterNotRespondingvv' >
(vv> ?
$"ww 
$strww ?
{ww? @
(ww@ A
offsetwwA G
/wwH I$
RSA_ENCRYPTED_CHUNK_SIZEwwJ b
)wwb c
+wwd e
$numwwf g
}wwg h
$strwwh j
{wwj k
chunkDecryptResultwwk }
.ww} ~
ERROR	ww~ É
?
wwÉ Ñ
.
wwÑ Ö
Message
wwÖ å
}
wwå ç
"
wwç é
)
wwé è
)
wwè ê
;
wwê ë
}xx 
ifzz 
(zz 
chunkDecryptResultzz &
.zz& '
Valuezz' ,
==zz- /
nullzz0 4
)zz4 5
{{{ 
continue|| 
;|| 
}}} 
int 
decryptedLength #
=$ %
chunkDecryptResult& 8
.8 9
Value9 >
.> ?
Length? E
;E F
if
ÄÄ 
(
ÄÄ 
currentOffset
ÄÄ !
+
ÄÄ" #
decryptedLength
ÄÄ$ 3
>
ÄÄ4 5
rentedBuffer
ÄÄ6 B
.
ÄÄB C
Length
ÄÄC I
)
ÄÄI J
{
ÅÅ 
byte
ÇÇ 
[
ÇÇ 
]
ÇÇ 
	newBuffer
ÇÇ $
=
ÇÇ% &
	ArrayPool
ÇÇ' 0
<
ÇÇ0 1
byte
ÇÇ1 5
>
ÇÇ5 6
.
ÇÇ6 7
Shared
ÇÇ7 =
.
ÇÇ= >
Rent
ÇÇ> B
(
ÇÇB C
currentOffset
ÇÇC P
+
ÇÇQ R
decryptedLength
ÇÇS b
)
ÇÇb c
;
ÇÇc d
Array
ÉÉ 
.
ÉÉ 
Copy
ÉÉ 
(
ÉÉ 
rentedBuffer
ÉÉ +
,
ÉÉ+ ,
$num
ÉÉ- .
,
ÉÉ. /
	newBuffer
ÉÉ0 9
,
ÉÉ9 :
$num
ÉÉ; <
,
ÉÉ< =
currentOffset
ÉÉ> K
)
ÉÉK L
;
ÉÉL M
	ArrayPool
ÑÑ 
<
ÑÑ 
byte
ÑÑ "
>
ÑÑ" #
.
ÑÑ# $
Shared
ÑÑ$ *
.
ÑÑ* +
Return
ÑÑ+ 1
(
ÑÑ1 2
rentedBuffer
ÑÑ2 >
)
ÑÑ> ?
;
ÑÑ? @
rentedBuffer
ÖÖ  
=
ÖÖ! "
	newBuffer
ÖÖ# ,
;
ÖÖ, -
}
ÜÜ 
Array
àà 
.
àà 
Copy
àà 
(
àà  
chunkDecryptResult
àà -
.
àà- .
Value
àà. 3
,
àà3 4
$num
àà5 6
,
àà6 7
rentedBuffer
àà8 D
,
ààD E
currentOffset
ààF S
,
ààS T
decryptedLength
ààU d
)
ààd e
;
ààe f
currentOffset
ââ 
+=
ââ  
decryptedLength
ââ! 0
;
ââ0 1
}
ää 
byte
åå 
[
åå 
]
åå 
result
åå 
=
åå 
new
åå 
byte
åå  $
[
åå$ %
currentOffset
åå% 2
]
åå2 3
;
åå3 4
Array
çç 
.
çç 
Copy
çç 
(
çç 
rentedBuffer
çç #
,
çç# $
$num
çç% &
,
çç& '
result
çç( .
,
çç. /
$num
çç0 1
,
çç1 2
currentOffset
çç3 @
)
çç@ A
;
ççA B
return
éé 
Result
éé 
<
éé 
byte
éé 
[
éé 
]
éé  
,
éé  !
NetworkFailure
éé" 0
>
éé0 1
.
éé1 2
Ok
éé2 4
(
éé4 5
result
éé5 ;
)
éé; <
;
éé< =
}
èè 	
finally
êê 
{
ëë 	
	ArrayPool
íí 
<
íí 
byte
íí 
>
íí 
.
íí 
Shared
íí "
.
íí" #
Return
íí# )
(
íí) *
rentedBuffer
íí* 6
)
íí6 7
;
íí7 8
}
ìì 	
}
îî 
}ïï Û
ã/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Crypto/RatchetStateHasher.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Crypto0 6
;6 7
internal		 
static			 
class		 
RatchetStateHasher		 (
{

 
public 

static 
byte 
[ 
] %
ComputeRatchetFingerprint 2
(2 3
RatchetState3 ?
ratchetState@ L
,L M
uintN R
	connectIdS \
)\ ]
{ !
ArgumentNullException 
. 
ThrowIfNull )
() *
ratchetState* 6
)6 7
;7 8
using 
MemoryStream 
memoryStream '
=( )
new* -
MemoryStream. :
(: ;
); <
;< =
using 
BinaryWriter 
writer !
=" #
new$ '
BinaryWriter( 4
(4 5
memoryStream5 A
)A B
;B C
writer 
. 
Write 
( 
	connectId 
) 
;  
byte 
[ 
] 
ratchetBytes 
= 
ratchetState *
.* +
ToByteArray+ 6
(6 7
)7 8
;8 9
writer 
. 
Write 
( 
ratchetBytes !
)! "
;" #
byte 
[ 
] 
data 
= 
memoryStream "
." #
ToArray# *
(* +
)+ ,
;, -
byte 
[ 
] 
hash 
= 
SHA256 
. 
HashData %
(% &
data& *
)* +
;+ ,
return 
hash 
; 
} 
} ƒ	
ã/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Crypto/IRsaChunkEncryptor.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Crypto0 6
;6 7
public 
	interface 
IRsaChunkEncryptor #
{ 
Result		 

<		
 
byte		 
[		 
]		 
,		 
NetworkFailure		 !
>		! "
EncryptInChunks		# 2
(		2 3%
CertificatePinningService

 !%
certificatePinningService

" ;
,

; <
byte 
[ 
] 
originalData 
) 
; 
Result 

<
 
byte 
[ 
] 
, 
NetworkFailure !
>! "
DecryptInChunks# 2
(2 3%
CertificatePinningService !%
certificatePinningService" ;
,; <
byte 
[ 
] !
combinedEncryptedData $
)$ %
;% &
} Œ
ö/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Abstractions/ISecureProtocolStateStorage.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Abstractions0 <
;< =
public 
	interface '
ISecureProtocolStateStorage ,
{ 
Task		 
<		 	
Result			 
<		 
Unit		 
,		  
SecureStorageFailure		 *
>		* +
>		+ ,
SaveStateAsync		- ;
(		; <
byte		< @
[		@ A
]		A B
protocolState		C P
,		P Q
string		R X
	connectId		Y b
,		b c
byte		d h
[		h i
]		i j
membershipId		k w
)		w x
;		x y
Task 
< 	
Result	 
< 
byte 
[ 
] 
,  
SecureStorageFailure ,
>, -
>- .
LoadStateAsync/ =
(= >
string> D
	connectIdE N
,N O
byteP T
[T U
]U V
membershipIdW c
)c d
;d e
Task 
< 	
Result	 
< 
Unit 
,  
SecureStorageFailure *
>* +
>+ ,
DeleteStateAsync- =
(= >
string> D
keyE H
)H I
;I J
} Ú
ò/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Abstractions/IPlatformSecurityProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Abstractions0 <
;< =
public 
	interface %
IPlatformSecurityProvider *
{ 
Task 
< 	
byte	 
[ 
] 
> %
GenerateSecureRandomAsync *
(* +
int+ .
length/ 5
)5 6
;6 7
Task

 #
StoreKeyInKeychainAsync

	  
(

  !
string

! '

identifier

( 2
,

2 3
byte

4 8
[

8 9
]

9 :
key

; >
)

> ?
;

? @
Task 
< 	
byte	 
[ 
] 
? 
> #
GetKeyFromKeychainAsync )
() *
string* 0

identifier1 ;
); <
;< =
Task &
DeleteKeyFromKeychainAsync	 #
(# $
string$ *

identifier+ 5
)5 6
;6 7
Task 
< 	
byte	 
[ 
] 
> #
GetOrCreateHmacKeyAsync (
(( )
)) *
;* +
bool '
IsHardwareSecurityAvailable	 $
($ %
)% &
;& '
Task 
< 	
Option	 
< 
byte 
[ 
] 
> 
>  
HardwareEncryptAsync -
(- .
byte. 2
[2 3
]3 4
data5 9
)9 :
;: ;
Task 
< 	
Option	 
< 
byte 
[ 
] 
> 
>  
HardwareDecryptAsync -
(- .
byte. 2
[2 3
]3 4
data5 9
)9 :
;: ;
} ¢K
é/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Transport/RpcMetaDataProvider.cs
	namespace		 	
Ecliptix		
 
.		 
Core		 
.		 
Infrastructure		 &
.		& '
Network		' .
.		. /
	Transport		/ 8
;		8 9
internal 
sealed	 
class 
RpcMetaDataProvider )
:* + 
IRpcMetaDataProvider, @
{ 
public 

Guid 
AppInstanceId 
{ 
get  #
;# $
private% ,
set- 0
;0 1
}2 3
public 

Guid 
DeviceId 
{ 
get 
; 
private  '
set( +
;+ ,
}- .
public 

string 
? 
CULTURE 
{ 
get  
;  !
private" )
set* -
;- .
}/ 0
public 

string 
LocalIpAddress  
{! "
get# &
;& '
}( )
public 

string 
? 
PublicIpAddress "
{# $
get% (
;( )
}* +
public 

string 
Platform 
{ 
get  
;  !
}" #
public 

RpcMetaDataProvider 
( 
)  
{ 
LocalIpAddress 
=  
DetectLocalIpAddress -
(- .
). /
;/ 0
PublicIpAddress 
= !
DetectPublicIpAddress /
(/ 0
)0 1
;1 2
Platform 
= 
DetectPlatform !
(! "
)" #
;# $
} 
public 

void 

SetAppInfo 
( 
Guid 
appInstanceId  -
,- .
Guid/ 3
deviceId4 <
,< =
string> D
?D E
cultureF M
)M N
{ 
AppInstanceId 
= 
appInstanceId %
;% &
DeviceId 
= 
deviceId 
; 
CULTURE 
= 
culture 
; 
}   
public"" 

void"" 

SetCulture"" 
("" 
string"" !
?""! "
culture""# *
)""* +
{## 
CULTURE$$ 
=$$ 
culture$$ 
;$$ 
}%% 
private'' 
static'' 
string''  
DetectLocalIpAddress'' .
(''. /
)''/ 0
{(( 
try)) 
{** 	
string++ 
localIp++ 
=++ 
NetworkInterface++ -
.++- .#
GetAllNetworkInterfaces++. E
(++E F
)++F G
.,, 
Where,, 
(,, 
x,, 
=>,, 
x,, 
.,, 
OperationalStatus,, /
==,,0 2
OperationalStatus,,3 D
.,,D E
Up,,E G
&&,,H J
!,,K L
x,,L M
.,,M N
IsReceiveOnly,,N [
),,[ \
.-- 

SelectMany-- 
(-- 
x-- 
=>--  
x--! "
.--" #
GetIPProperties--# 2
(--2 3
)--3 4
.--4 5
UnicastAddresses--5 E
)--E F
... 
Where.. 
(.. 
x.. 
=>.. 
x.. 
... 
Address.. %
...% &
AddressFamily..& 3
==..4 6
AddressFamily..7 D
...D E
InterNetwork..E Q
&&..R T
!..U V
	IPAddress..V _
..._ `

IsLoopback..` j
(..j k
x..k l
...l m
Address..m t
)..t u
)..u v
.// 
Select// 
(// 
x// 
=>// 
x// 
.// 
Address// &
.//& '
ToString//' /
(/// 0
)//0 1
)//1 2
.00 
FirstOrDefault00 
(00  
)00  !
??00" $
$str00% 0
;000 1
return22 
localIp22 
;22 
}33 	
catch44 
{55 	
return66 
$str66 
;66 
}77 	
}88 
private:: 
static:: 
string:: 
?:: !
DetectPublicIpAddress:: 0
(::0 1
)::1 2
{;; 
try<< 
{== 	
using>> 
	UdpClient>> 
client>> "
=>># $
new>>% (
(>>( )
)>>) *
;>>* +
client?? 
.?? 
Connect?? 
(?? 
$str?? $
,??$ %
$num??& (
)??( )
;??) *

IPEndPoint@@ 
?@@ 
endpoint@@  
=@@! "
client@@# )
.@@) *
Client@@* 0
.@@0 1
LocalEndPoint@@1 >
as@@? A

IPEndPoint@@B L
;@@L M
returnAA 
endpointAA 
?AA 
.AA 
AddressAA $
.AA$ %
ToStringAA% -
(AA- .
)AA. /
??AA0 2 
DetectLocalIpAddressAA3 G
(AAG H
)AAH I
;AAI J
}BB 	
catchCC 
{DD 	
returnEE  
DetectLocalIpAddressEE '
(EE' (
)EE( )
;EE) *
}FF 	
}GG 
privateII 
staticII 
stringII 
DetectPlatformII (
(II( )
)II) *
{JJ 
stringKK 
osKK 
=KK 
GetOperatingSystemKK &
(KK& '
)KK' (
;KK( )
stringLL 
archLL 
=LL 
GetArchitectureLL %
(LL% &
)LL& '
;LL' (
stringMM 
runtimeMM 
=MM 
GetRuntimeVersionMM *
(MM* +
)MM+ ,
;MM, -
returnNN 
$"NN 
{NN 
osNN 
}NN 
$strNN 
{NN 
archNN 
}NN 
$strNN #
{NN# $
runtimeNN$ +
}NN+ ,
$strNN, -
"NN- .
;NN. /
}OO 
privateQQ 
staticQQ 
stringQQ 
GetOperatingSystemQQ ,
(QQ, -
)QQ- .
{RR 
ifSS 

(SS 
RuntimeInformationSS 
.SS 
IsOSPlatformSS +
(SS+ ,

OSPlatformSS, 6
.SS6 7
OSXSS7 :
)SS: ;
)SS; <
{TT 	
returnUU 
$strUU 
;UU 
}VV 	
ifXX 

(XX 
RuntimeInformationXX 
.XX 
IsOSPlatformXX +
(XX+ ,

OSPlatformXX, 6
.XX6 7
WindowsXX7 >
)XX> ?
)XX? @
{YY 	
returnZZ 
$strZZ 
;ZZ 
}[[ 	
if]] 

(]] 
RuntimeInformation]] 
.]] 
IsOSPlatform]] +
(]]+ ,

OSPlatform]], 6
.]]6 7
Linux]]7 <
)]]< =
)]]= >
{^^ 	
return__ 
$str__ 
;__ 
}`` 	
returnbb 
$strbb 
;bb 
}cc 
privateee 
staticee 
stringee 
GetArchitectureee )
(ee) *
)ee* +
{ff 
Architecturegg 
processArchgg  
=gg! "
RuntimeInformationgg# 5
.gg5 6
ProcessArchitecturegg6 I
;ggI J
returnhh 
processArchhh 
switchhh !
{ii 	
Architecturejj 
.jj 
Arm64jj 
=>jj !
$strjj" )
,jj) *
Architecturekk 
.kk 
X64kk 
=>kk 
$strkk  %
,kk% &
Architecturell 
.ll 
X86ll 
=>ll 
$strll  %
,ll% &
Architecturemm 
.mm 
Armmm 
=>mm 
$strmm  '
,mm' (
_nn 
=>nn 
processArchnn 
.nn 
ToStringnn %
(nn% &
)nn& '
}oo 	
;oo	 

}pp 
privaterr 
staticrr 
stringrr 
GetRuntimeVersionrr +
(rr+ ,
)rr, -
{ss 
stringtt  
frameworkDescriptiontt #
=tt$ %
RuntimeInformationtt& 8
.tt8 9 
FrameworkDescriptiontt9 M
;ttM N
intuu 

startIndexuu 
=uu  
frameworkDescriptionuu -
.uu- .
IndexOfuu. 5
(uu5 6
$charuu6 9
)uu9 :
;uu: ;
ifvv 

(vv 

startIndexvv 
>=vv 
$numvv 
&&vv 

startIndexvv )
<vv* + 
frameworkDescriptionvv, @
.vv@ A
LengthvvA G
-vvH I
$numvvJ K
)vvK L
{ww 	
returnxx  
frameworkDescriptionxx '
[xx' (
(xx( )

startIndexxx) 3
+xx4 5
$numxx6 7
)xx7 8
..xx8 :
]xx: ;
;xx; <
}yy 	
returnzz  
frameworkDescriptionzz #
;zz# $
}{{ 
}|| £T
ß/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Transport/Grpc/Interceptors/RequestMetaDataInterceptor.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
	Transport/ 8
.8 9
Grpc9 =
.= >
Interceptors> J
;J K
public		 
sealed		 
class		 &
RequestMetaDataInterceptor		 .
(		. / 
IRpcMetaDataProvider		/ C
rpcMetaDataProvider		D W
)		W X
:		Y Z
Interceptor		[ f
{

 
public 

override $
AsyncServerStreamingCall ,
<, -
	TResponse- 6
>6 7$
AsyncServerStreamingCall8 P
<P Q
TRequestQ Y
,Y Z
	TResponse[ d
>d e
(e f
TRequest 
request 
, $
ClientInterceptorContext  
<  !
TRequest! )
,) *
	TResponse+ 4
>4 5
context6 =
,= >0
$AsyncServerStreamingCallContinuation ,
<, -
TRequest- 5
,5 6
	TResponse7 @
>@ A
continuationB N
)N O
{ 
Metadata 
headers 
= 
context "
." #
Options# *
.* +
Headers+ 2
??3 5
[6 7
]7 8
;8 9
string 
? 
culture 
= 
rpcMetaDataProvider -
.- .
CULTURE. 5
;5 6
Serilog 
. 
Log 
. 
Information 
(  
$str  i
,i j
culturek r
)r s
;s t
PubKeyExchangeType 
EXCHANGE_TYPE (
=) *$
GetExchangeTypeForMethod+ C
(C D
contextD K
.K L
MethodL R
,R S
headersT [
)[ \
;\ ]
if 

( 
Serilog 
. 
Log 
. 
	IsEnabled !
(! "
Serilog" )
.) *
Events* 0
.0 1
LogEventLevel1 >
.> ?
Debug? D
)D E
)E F
{ 	
Serilog 
. 
Log 
. 
Debug 
( 
$str	 Ç
,
Ç É
EXCHANGE_TYPE 
, 
context &
.& '
Method' -
.- .
Name. 2
)2 3
;3 4
} 	
Metadata 
newMetadata 
= 
GrpcMetadataHandler 2
.2 3
GenerateMetadata3 C
(C D
rpcMetaDataProvider 
.  
AppInstanceId  -
.- .
ToString. 6
(6 7
)7 8
,8 9
rpcMetaDataProvider 
.  
DeviceId  (
.( )
ToString) 1
(1 2
)2 3
,3 4
culture 
, 
EXCHANGE_TYPE 
, 
rpcMetaDataProvider   
.    
LocalIpAddress    .
,  . /
rpcMetaDataProvider!! 
.!!  
PublicIpAddress!!  /
,!!/ 0
rpcMetaDataProvider"" 
.""  
Platform""  (
)""( )
;"") *
foreach## 
(## 
Metadata## 
.## 
Entry## 
entry##  %
in##& (
newMetadata##) 4
)##4 5
{$$ 	
headers%% 
.%% 
Add%% 
(%% 
entry%% 
)%% 
;%% 
}&& 	
CallOptions(( 

newOptions(( 
=((  
context((! (
.((( )
Options(() 0
.((0 1
WithHeaders((1 <
(((< =
headers((= D
)((D E
;((E F$
ClientInterceptorContext))  
<))  !
TRequest))! )
,))) *
	TResponse))+ 4
>))4 5

newContext))6 @
=))A B
new))C F
())F G
context** 
.** 
Method** 
,** 
context++ 
.++ 
Host++ 
,++ 

newOptions,, 
),, 
;,, 
return.. 
continuation.. 
(.. 
request.. #
,..# $

newContext..% /
)../ 0
;..0 1
}// 
public11 

override11 
AsyncUnaryCall11 "
<11" #
	TResponse11# ,
>11, -
AsyncUnaryCall11. <
<11< =
TRequest11= E
,11E F
	TResponse11G P
>11P Q
(11Q R
TRequest22 
request22 
,22 $
ClientInterceptorContext33  
<33  !
TRequest33! )
,33) *
	TResponse33+ 4
>334 5
context336 =
,33= >&
AsyncUnaryCallContinuation44 "
<44" #
TRequest44# +
,44+ ,
	TResponse44- 6
>446 7
continuation448 D
)44D E
{55 
Metadata66 
headers66 
=66 
context66 "
.66" #
Options66# *
.66* +
Headers66+ 2
??663 5
[666 7
]667 8
;668 9
string77 
?77 
culture77 
=77 
rpcMetaDataProvider77 -
.77- .
CULTURE77. 5
;775 6
Serilog88 
.88 
Log88 
.88 
Information88 
(88  
$str88  i
,88i j
culture88k r
)88r s
;88s t
PubKeyExchangeType:: 
EXCHANGE_TYPE:: (
=::) *$
GetExchangeTypeForMethod::+ C
(::C D
context::D K
.::K L
Method::L R
,::R S
headers::T [
)::[ \
;::\ ]
if;; 

(;; 
Serilog;; 
.;; 
Log;; 
.;; 
	IsEnabled;; !
(;;! "
Serilog;;" )
.;;) *
Events;;* 0
.;;0 1
LogEventLevel;;1 >
.;;> ?
Debug;;? D
);;D E
);;E F
{<< 	
Serilog== 
.== 
Log== 
.== 
Debug== 
(== 
$str== ~
,==~ 
EXCHANGE_TYPE>> 
,>> 
context>> &
.>>& '
Method>>' -
.>>- .
Name>>. 2
)>>2 3
;>>3 4
}?? 	
MetadataAA 
newMetadataAA 
=AA 
GrpcMetadataHandlerAA 2
.AA2 3
GenerateMetadataAA3 C
(AAC D
rpcMetaDataProviderBB 
.BB  
AppInstanceIdBB  -
.BB- .
ToStringBB. 6
(BB6 7
)BB7 8
,BB8 9
rpcMetaDataProviderCC 
.CC  
DeviceIdCC  (
.CC( )
ToStringCC) 1
(CC1 2
)CC2 3
,CC3 4
cultureDD 
,DD 
EXCHANGE_TYPEEE 
,EE 
rpcMetaDataProviderFF 
.FF  
LocalIpAddressFF  .
,FF. /
rpcMetaDataProviderGG 
.GG  
PublicIpAddressGG  /
,GG/ 0
rpcMetaDataProviderHH 
.HH  
PlatformHH  (
)HH( )
;HH) *
foreachII 
(II 
MetadataII 
.II 
EntryII 
entryII  %
inII& (
newMetadataII) 4
)II4 5
{JJ 	
headersKK 
.KK 
AddKK 
(KK 
entryKK 
)KK 
;KK 
}LL 	
CallOptionsNN 

newOptionsNN 
=NN  
contextNN! (
.NN( )
OptionsNN) 0
.NN0 1
WithHeadersNN1 <
(NN< =
headersNN= D
)NND E
;NNE F$
ClientInterceptorContextOO  
<OO  !
TRequestOO! )
,OO) *
	TResponseOO+ 4
>OO4 5

newContextOO6 @
=OOA B
newOOC F
(OOF G
contextPP 
.PP 
MethodPP 
,PP 
contextQQ 
.QQ 
HostQQ 
,QQ 

newOptionsRR 
)RR 
;RR 
returnTT 
continuationTT 
(TT 
requestTT #
,TT# $

newContextTT% /
)TT/ 0
;TT0 1
}UU 
privateWW 
staticWW 
PubKeyExchangeTypeWW %$
GetExchangeTypeForMethodWW& >
<WW> ?
TRequestWW? G
,WWG H
	TResponseWWI R
>WWR S
(WWS T
MethodWWT Z
<WWZ [
TRequestWW[ c
,WWc d
	TResponseWWe n
>WWn o
methodWWp v
,WWv w
Metadata	WWx Ä
?
WWÄ Å
headers
WWÇ â
=
WWä ã
null
WWå ê
)
WWê ë
{XX 
ifYY 

(YY 
headersYY 
!=YY 
nullYY 
)YY 
{ZZ 	
string[[ 
?[[ 
exchangeTypeHeader[[ &
=[[' (
headers[[) 0
.[[0 1
GetValue[[1 9
([[9 :
$str[[: I
)[[I J
;[[J K
if\\ 
(\\ 
!\\ 
string\\ 
.\\ 
IsNullOrEmpty\\ %
(\\% &
exchangeTypeHeader\\& 8
)\\8 9
&&\\: <
Enum]] 
.]] 
TryParse]] 
(]] 
exchangeTypeHeader]] 0
,]]0 1
true]]2 6
,]]6 7
out]]8 ;
PubKeyExchangeType]]< N
headerExchangeType]]O a
)]]a b
&&]]c e
Enum^^ 
.^^ 
	IsDefined^^ 
(^^ 
typeof^^ %
(^^% &
PubKeyExchangeType^^& 8
)^^8 9
,^^9 :
headerExchangeType^^; M
)^^M N
)^^N O
{__ 
return`` 
headerExchangeType`` )
;``) *
}aa 
}bb 	
returndd 
methoddd 
.dd 
Namedd 
switchdd !
{ee 	
$strff "
=>ff# %
PubKeyExchangeTypeff& 8
.ff8 9
ServerStreamingff9 H
,ffH I
_gg 
=>gg 
PubKeyExchangeTypegg #
.gg# $&
DataCenterEphemeralConnectgg$ >
}hh 	
;hh	 

}ii 
}jj õf
†/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Transport/Grpc/Interceptors/GrpcMetadataHandler.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Infrastructure

 &
.

& '
Network

' .
.

. /
	Transport

/ 8
.

8 9
Grpc

9 =
.

= >
Interceptors

> J
;

J K
public 
static 
class 
GrpcMetadataHandler '
{ 
private 
const 
string 
REQUEST_ID_KEY '
=( )
$str* 6
;6 7
private 
const 
string 
DATE_TIME_KEY &
=' (
$str) 7
;7 8
private 
const 
string  
LOCAL_IP_ADDRESS_KEY -
=. /
$str0 B
;B C
private 
const 
string !
PUBLIC_IP_ADDRESS_KEY .
=/ 0
$str1 D
;D E
private 
const 
string 

LOCALE_KEY #
=$ %
$str& ,
;, -
private 
const 
string 
LINK_ID_KEY $
=% &
$str' 3
;3 4
private 
const 
string '
APPLICATION_INSTANCE_ID_KEY 4
=5 6
$str7 O
;O P
private 
const 
string 
APP_DEVICE_ID &
=' (
$str) 7
;7 8
private 
const 
string 
PLATFORM_KEY %
=& '
$str( 2
;2 3
private 
const 
string )
KEY_EXCHANGE_CONTEXT_TYPE_KEY 6
=7 8
$str9 O
;O P
private 
const 
string +
KEY_EXCHANGE_CONTEXT_TYPE_VALUE 8
=9 :
$str; R
;R S
private 
const 
string !
CONNECTION_CONTEXT_ID .
=/ 0
$str1 ?
;? @
private 
const 
string  
OPERATION_CONTEXT_ID -
=. /
$str0 >
;> ?
public 

static 
Metadata 
GenerateMetadata +
(+ ,
string 
appInstanceId 
, 
string 
appDeviceId 
, 
string 
? 
culture 
, 
PubKeyExchangeType   
EXCHANGE_TYPE   (
=  ) *
PubKeyExchangeType  + =
.  = >&
DataCenterEphemeralConnect  > X
,  X Y
string!! 
?!! 
localIpAddress!! 
=!!  
null!!! %
,!!% &
string"" 
?"" 
publicIpAddress"" 
=""  !
null""" &
,""& '
string## 
?## 
platform## 
=## 
null## 
,##  
Guid$$ 
_$$ 
=$$ 
default$$ 
)$$ 
{%% 
Metadata&& 
metadata&& 
=&& 
new&& 
(&&  
)&&  !
{'' 	
{(( 
REQUEST_ID_KEY(( 
,(( 
Guid(( "
.((" #
NewGuid((# *
(((* +
)((+ ,
.((, -
ToString((- 5
(((5 6
)((6 7
}((8 9
,((9 :
{)) 
DATE_TIME_KEY)) 
,)) 
DateTimeOffset)) +
.))+ ,
UtcNow)), 2
.))2 3
ToString))3 ;
()); <
$str))< ?
)))? @
}))A B
,))B C
{**  
LOCAL_IP_ADDRESS_KEY** "
,**" #
localIpAddress**$ 2
??**3 5
GetLocalIpAddress**6 G
(**G H
)**H I
}**J K
,**K L
{++ !
PUBLIC_IP_ADDRESS_KEY++ #
,++# $
publicIpAddress++% 4
??++5 7
GetPublicIpAddress++8 J
(++J K
)++K L
}++M N
,++N O
{,, 

LOCALE_KEY,, 
,,, 
culture,, !
??,," $
$str,,% ,
},,- .
,,,. /
{-- 
LINK_ID_KEY-- 
,-- 
GenerateLinkId-- )
(--) *
)--* +
}--, -
,--- .
{.. '
APPLICATION_INSTANCE_ID_KEY.. )
,..) *
appInstanceId..+ 8
}..9 :
,..: ;
{// 
APP_DEVICE_ID// 
,// 
appDeviceId// (
}//) *
,//* +
{00 
PLATFORM_KEY00 
,00 
platform00 $
??00% '
GetPlatform00( 3
(003 4
)004 5
}006 7
,007 8
{11 )
KEY_EXCHANGE_CONTEXT_TYPE_KEY11 +
,11+ ,+
KEY_EXCHANGE_CONTEXT_TYPE_VALUE11- L
}11M N
,11N O
{22 !
CONNECTION_CONTEXT_ID22 #
,22# $
EXCHANGE_TYPE22% 2
.222 3
ToString223 ;
(22; <
)22< =
}22> ?
,22? @
{33  
OPERATION_CONTEXT_ID33 "
,33" #
string33$ *
.33* +
Empty33+ 0
}331 2
}44 	
;44	 

return66 
metadata66 
;66 
}77 
private99 
static99 
string99 
GetLocalIpAddress99 +
(99+ ,
)99, -
{:: 
try;; 
{<< 	
string== 
localIp== 
=== 
NetworkInterface== -
.==- .#
GetAllNetworkInterfaces==. E
(==E F
)==F G
.>> 
Where>> 
(>> 
x>> 
=>>> 
x>> 
.>> 
OperationalStatus>> /
==>>0 2
OperationalStatus>>3 D
.>>D E
Up>>E G
&&>>H J
!>>K L
x>>L M
.>>M N
IsReceiveOnly>>N [
)>>[ \
.?? 

SelectMany?? 
(?? 
x?? 
=>??  
x??! "
.??" #
GetIPProperties??# 2
(??2 3
)??3 4
.??4 5
UnicastAddresses??5 E
)??E F
.@@ 
Where@@ 
(@@ 
x@@ 
=>@@ 
x@@ 
.@@ 
Address@@ %
.@@% &
AddressFamily@@& 3
==@@4 6
AddressFamily@@7 D
.@@D E
InterNetwork@@E Q
&&@@R T
!@@U V
	IPAddress@@V _
.@@_ `

IsLoopback@@` j
(@@j k
x@@k l
.@@l m
Address@@m t
)@@t u
)@@u v
.AA 
SelectAA 
(AA 
xAA 
=>AA 
xAA 
.AA 
AddressAA &
.AA& '
ToStringAA' /
(AA/ 0
)AA0 1
)AA1 2
.BB 
FirstOrDefaultBB 
(BB  
)BB  !
??BB" $
$strBB% 0
;BB0 1
returnDD 
localIpDD 
;DD 
}EE 	
catchFF 
{GG 	
returnHH 
$strHH 
;HH 
}II 	
}JJ 
privateLL 
staticLL 
stringLL 
GetPublicIpAddressLL ,
(LL, -
)LL- .
{MM 
tryNN 
{OO 	
usingPP 
	UdpClientPP 
clientPP "
=PP# $
newPP% (
(PP( )
)PP) *
;PP* +
clientQQ 
.QQ 
ConnectQQ 
(QQ 
$strQQ $
,QQ$ %
$numQQ& (
)QQ( )
;QQ) *

IPEndPointRR 
?RR 
endpointRR  
=RR! "
clientRR# )
.RR) *
ClientRR* 0
.RR0 1
LocalEndPointRR1 >
asRR? A

IPEndPointRRB L
;RRL M
returnSS 
endpointSS 
?SS 
.SS 
AddressSS $
.SS$ %
ToStringSS% -
(SS- .
)SS. /
??SS0 2
GetLocalIpAddressSS3 D
(SSD E
)SSE F
;SSF G
}TT 	
catchUU 
{VV 	
returnWW 
GetLocalIpAddressWW $
(WW$ %
)WW% &
;WW& '
}XX 	
}YY 
private[[ 
static[[ 
string[[ 
GenerateLinkId[[ (
([[( )
)[[) *
{\\ 
return]] 
$"]] 
$str]] 
{]] 
Guid]] 
.]] 
NewGuid]] #
(]]# $
)]]$ %
:]]% &
$str]]& '
}]]' (
"]]( )
[]]) *
..]]* ,
$num]], .
]]]. /
;]]/ 0
}^^ 
private`` 
static`` 
string`` 
GetPlatform`` %
(``% &
)``& '
{aa 
stringbb 
osbb 
=bb 
GetOperatingSystembb &
(bb& '
)bb' (
;bb( )
stringcc 
archcc 
=cc 
GetArchitecturecc %
(cc% &
)cc& '
;cc' (
stringdd 
runtimedd 
=dd 
GetRuntimeVersiondd *
(dd* +
)dd+ ,
;dd, -
returnee 
$"ee 
{ee 
osee 
}ee 
$stree 
{ee 
archee 
}ee 
$stree #
{ee# $
runtimeee$ +
}ee+ ,
$stree, -
"ee- .
;ee. /
}ff 
privatehh 
statichh 
stringhh 
GetOperatingSystemhh ,
(hh, -
)hh- .
{ii 
ifjj 

(jj 
RuntimeInformationjj 
.jj 
IsOSPlatformjj +
(jj+ ,

OSPlatformjj, 6
.jj6 7
OSXjj7 :
)jj: ;
)jj; <
{kk 	
returnll 
$strll 
;ll 
}mm 	
ifoo 

(oo 
RuntimeInformationoo 
.oo 
IsOSPlatformoo +
(oo+ ,

OSPlatformoo, 6
.oo6 7
Windowsoo7 >
)oo> ?
)oo? @
{pp 	
returnqq 
$strqq 
;qq 
}rr 	
iftt 

(tt 
RuntimeInformationtt 
.tt 
IsOSPlatformtt +
(tt+ ,

OSPlatformtt, 6
.tt6 7
Linuxtt7 <
)tt< =
)tt= >
{uu 	
returnvv 
$strvv 
;vv 
}ww 	
returnyy 
$stryy 
;yy 
}zz 
private|| 
static|| 
string|| 
GetArchitecture|| )
(||) *
)||* +
{}} 
Architecture~~ 
processArch~~  
=~~! "
RuntimeInformation~~# 5
.~~5 6
ProcessArchitecture~~6 I
;~~I J
return 
processArch 
switch !
{
ÄÄ 	
Architecture
ÅÅ 
.
ÅÅ 
Arm64
ÅÅ 
=>
ÅÅ !
$str
ÅÅ" )
,
ÅÅ) *
Architecture
ÇÇ 
.
ÇÇ 
X64
ÇÇ 
=>
ÇÇ 
$str
ÇÇ  %
,
ÇÇ% &
Architecture
ÉÉ 
.
ÉÉ 
X86
ÉÉ 
=>
ÉÉ 
$str
ÉÉ  %
,
ÉÉ% &
Architecture
ÑÑ 
.
ÑÑ 
Arm
ÑÑ 
=>
ÑÑ 
$str
ÑÑ  '
,
ÑÑ' (
_
ÖÖ 
=>
ÖÖ 
processArch
ÖÖ 
.
ÖÖ 
ToString
ÖÖ %
(
ÖÖ% &
)
ÖÖ& '
}
ÜÜ 	
;
ÜÜ	 

}
áá 
private
ââ 
static
ââ 
string
ââ 
GetRuntimeVersion
ââ +
(
ââ+ ,
)
ââ, -
{
ää 
string
ãã "
frameworkDescription
ãã #
=
ãã$ % 
RuntimeInformation
ãã& 8
.
ãã8 9"
FrameworkDescription
ãã9 M
;
ããM N
int
åå 

startIndex
åå 
=
åå "
frameworkDescription
åå -
.
åå- .
IndexOf
åå. 5
(
åå5 6
$char
åå6 9
)
åå9 :
;
åå: ;
if
çç 

(
çç 

startIndex
çç 
>=
çç 
$num
çç 
&&
çç 

startIndex
çç )
<
çç* +"
frameworkDescription
çç, @
.
çç@ A
Length
ççA G
-
ççH I
$num
ççJ K
)
ççK L
{
éé 	
return
èè "
frameworkDescription
èè '
[
èè' (
(
èè( )

startIndex
èè) 3
+
èè4 5
$num
èè6 7
)
èè7 8
..
èè8 :
]
èè: ;
;
èè; <
}
êê 	
return
ëë "
frameworkDescription
ëë #
;
ëë# $
}
íí 
}ìì ì
õ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Transport/Grpc/GrpcClientServiceExtensions.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Infrastructure

 &
.

& '
Network

' .
.

. /
	Transport

/ 8
.

8 9
Grpc

9 =
;

= >
public 
static 
class '
GrpcClientServiceExtensions /
{ 
public 

static 
void $
AddConfiguredGrpcClients /
(/ 0
this0 4
IServiceCollection5 G
servicesH P
)P Q
{ 
services 
. 
AddGrpcClient 
< 
DeviceService ,
., -
DeviceServiceClient- @
>@ A
(A B
ConfigureClientB Q
)Q R
. 
AddInterceptor 
< &
RequestMetaDataInterceptor 6
>6 7
(7 8
)8 9
;9 :
services 
. 
AddGrpcClient 
< 
MembershipServices 1
.1 2$
MembershipServicesClient2 J
>J K
(K L
ConfigureClientL [
)[ \
. 
AddInterceptor 
< &
RequestMetaDataInterceptor 6
>6 7
(7 8
)8 9
;9 :
services 
. 
AddGrpcClient 
< $
AuthVerificationServices 7
.7 8*
AuthVerificationServicesClient8 V
>V W
(W X
ConfigureClientX g
)g h
. 
AddInterceptor 
< &
RequestMetaDataInterceptor 6
>6 7
(7 8
)8 9
;9 :
} 
private 
static 
void 
ConfigureClient '
(' (
IServiceProvider( 8
serviceProvider9 H
,H I$
GrpcClientFactoryOptionsJ b
optionsc j
)j k
{ !
DefaultSystemSettings 
settings &
=' (
serviceProvider) 8
.8 9
GetRequiredService9 K
<K L
IOptionsL T
<T U!
DefaultSystemSettingsU j
>j k
>k l
(l m
)m n
.n o
Valueo t
;t u
string 
endpoint 
= 
settings "
." #)
DATA_CENTER_CONNECTION_STRING# @
;@ A
if   

(   
string   
.   
IsNullOrEmpty    
(    !
endpoint  ! )
)  ) *
)  * +
{!! 	
throw"" 
new"" %
InvalidOperationException"" /
(""/ 0
$str""0 g
)""g h
;""h i
}## 	
options%% 
.%% 
Address%% 
=%% 
new%% 
Uri%% !
(%%! "
endpoint%%" *
)%%* +
;%%+ ,
}&& 
}(( àß
è/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Core/Providers/NetworkProvider.cs
	namespace$$ 	
Ecliptix$$
 
.$$ 
Core$$ 
.$$ 
Infrastructure$$ &
.$$& '
Network$$' .
.$$. /
Core$$/ 3
.$$3 4
	Providers$$4 =
;$$= >
public&& 
sealed&& 
record&& '
NetworkProviderDependencies&& 0
(&&0 1
IRpcServiceManager'' 
RpcServiceManager'' (
,''( )-
!IApplicationSecureStorageProvider(( %,
 ApplicationSecureStorageProvider((& F
,((F G'
ISecureProtocolStateStorage)) &
SecureProtocolStateStorage))  :
,)): ; 
IRpcMetaDataProvider** 
RpcMetaDataProvider** ,
)**, -
;**- .
public,, 
sealed,, 
record,, #
NetworkProviderServices,, ,
(,,, - 
IConnectivityService-- 
ConnectivityService-- ,
,--, -
IRetryStrategy.. 
RetryStrategy..  
,..  !"
IPendingRequestManager// !
PendingRequestManager// 0
)//0 1
;//1 2
public11 
sealed11 
record11 #
NetworkProviderSecurity11 ,
(11, --
!ICertificatePinningServiceFactory22 %,
 CertificatePinningServiceFactory22& F
,22F G
IRsaChunkEncryptor33 
RsaChunkEncryptor33 (
,33( ) 
IRetryPolicyProvider44 
RetryPolicyProvider44 ,
)44, -
;44- .
public66 
sealed66 
class66 
NetworkProvider66 #
:66$ %
INetworkProvider66& 6
,666 7
IDisposable668 C
,66C D!
IProtocolEventHandler66E Z
{77 
private88 
readonly88 
IRpcServiceManager88 '
rpcServiceManager88( 9
;889 :
private99 
readonly99 -
!IApplicationSecureStorageProvider99 6,
 applicationSecureStorageProvider997 W
;99W X
private:: 
readonly:: '
ISecureProtocolStateStorage:: 0&
secureProtocolStateStorage::1 K
;::K L
private;; 
readonly;;  
IRpcMetaDataProvider;; )
rpcMetaDataProvider;;* =
;;;= >
private<< 
readonly<<  
IConnectivityService<< )
connectivityService<<* =
;<<= >
private== 
readonly== 
IRetryStrategy== #
retryStrategy==$ 1
;==1 2
private>> 
readonly>> "
IPendingRequestManager>> +!
pendingRequestManager>>, A
;>>A B
private?? 
readonly?? -
!ICertificatePinningServiceFactory?? 6,
 certificatePinningServiceFactory??7 W
;??W X
private@@ 
readonly@@ 
IRsaChunkEncryptor@@ '
rsaChunkEncryptor@@( 9
;@@9 :
privateAA 
readonlyAA  
IRetryPolicyProviderAA )
retryPolicyProviderAA* =
;AA= >
publicCC 

NetworkProviderCC 
(CC '
NetworkProviderDependenciesDD #
dependenciesDD$ 0
,DD0 1#
NetworkProviderServicesEE 
servicesEE  (
,EE( )#
NetworkProviderSecurityFF 
securityFF  (
)FF( )
{GG 
rpcServiceManagerHH 
=HH 
dependenciesHH (
.HH( )
RpcServiceManagerHH) :
;HH: ;,
 applicationSecureStorageProviderII (
=II) *
dependenciesII+ 7
.II7 8,
 ApplicationSecureStorageProviderII8 X
;IIX Y&
secureProtocolStateStorageJJ "
=JJ# $
dependenciesJJ% 1
.JJ1 2&
SecureProtocolStateStorageJJ2 L
;JJL M
rpcMetaDataProviderKK 
=KK 
dependenciesKK *
.KK* +
RpcMetaDataProviderKK+ >
;KK> ?
connectivityServiceLL 
=LL 
servicesLL &
.LL& '
ConnectivityServiceLL' :
;LL: ;
retryStrategyMM 
=MM 
servicesMM  
.MM  !
RetryStrategyMM! .
;MM. /!
pendingRequestManagerNN 
=NN 
servicesNN  (
.NN( )!
PendingRequestManagerNN) >
;NN> ?,
 certificatePinningServiceFactoryOO (
=OO) *
securityOO+ 3
.OO3 4,
 CertificatePinningServiceFactoryOO4 T
;OOT U
rsaChunkEncryptorPP 
=PP 
securityPP $
.PP$ %
RsaChunkEncryptorPP% 6
;PP6 7
retryPolicyProviderQQ 
=QQ 
securityQQ &
.QQ& '
RetryPolicyProviderQQ' :
;QQ: ;
}RR 
privateSS 
staticSS  
TaskCompletionSourceSS '
<SS' (
boolSS( ,
>SS, -
CreateOutageTcsSS. =
(SS= >
)SS> ?
=>SS@ B
newTT 
(TT 
TaskCreationOptionsTT 
.TT  *
RunContinuationsAsynchronouslyTT  >
)TT> ?
;TT? @
privateVV 
readonlyVV  
ConcurrentDictionaryVV )
<VV) *
uintVV* .
,VV. /"
EcliptixProtocolSystemVV0 F
>VVF G
_connectionsVVH T
=VVU V
newVVW Z
(VVZ [
)VV[ \
;VV\ ]
privateWW 
readonlyWW  
ConcurrentDictionaryWW )
<WW) *
uintWW* .
,WW. /#
CancellationTokenSourceWW0 G
>WWG H
_activeStreamsWWI W
=WWX Y
newWWZ ]
(WW] ^
)WW^ _
;WW_ `
privateXX 
readonlyXX  
ConcurrentDictionaryXX )
<XX) *
stringXX* 0
,XX0 1#
CancellationTokenSourceXX2 I
>XXI J
_pendingRequestsXXK [
=XX\ ]
newXX^ a
(XXa b
)XXb c
;XXc d
privateYY 
readonlyYY 
LockYY 
_cancellationLockYY +
=YY, -
newYY. 1
(YY1 2
)YY2 3
;YY3 4
privateZZ 
readonlyZZ #
CancellationTokenSourceZZ ,&
_shutdownCancellationTokenZZ- G
=ZZH I
newZZJ M
(ZZM N
)ZZN O
;ZZO P
private[[ 
readonly[[  
ConcurrentDictionary[[ )
<[[) *
uint[[* .
,[[. /
SemaphoreSlim[[0 =
>[[= >
_channelGates[[? L
=[[M N
new[[O R
([[R S
)[[S T
;[[T U
private\\ 
readonly\\ 
SemaphoreSlim\\ "%
_retryPendingRequestsGate\\# <
=\\= >
new\\? B
(\\B C
$num\\C D
,\\D E
$num\\F G
)\\G H
;\\H I
private]] 
readonly]] 
Lock]] 
_outageLock]] %
=]]& '
new]]( +
(]]+ ,
)]], -
;]]- .
private^^ 
readonly^^ 
Lock^^ 
_disposeLock^^ &
=^^' (
new^^) ,
(^^, -
)^^- .
;^^. /
private__ 
readonly__ 
Lock__ "
_appInstanceSetterLock__ 0
=__1 2
new__3 6
(__6 7
)__7 8
;__8 9
privateaa #
CancellationTokenSourceaa #
?aa# $"
_connectionRecoveryCtsaa% ;
;aa; <
privatebb 
Optionbb 
<bb '
ApplicationInstanceSettingsbb .
>bb. /(
_applicationInstanceSettingsbb0 L
=bbM N
OptionbbO U
<bbU V'
ApplicationInstanceSettingsbbV q
>bbq r
.bbr s
Nonebbs w
;bbw x
privatecc 
intcc 
_outageStatecc 
;cc 
privatedd  
TaskCompletionSourcedd  
<dd  !
booldd! %
>dd% &#
_outageCompletionSourcedd' >
=dd? @
CreateOutageTcsddA P
(ddP Q
)ddQ R
;ddR S
privateee 
volatileee 
boolee 
	_disposedee #
;ee# $
publicgg 
'
ApplicationInstanceSettingsgg &'
ApplicationInstanceSettingsgg' B
{hh 
getii 
{jj 	
ifkk 
(kk 
!kk (
_applicationInstanceSettingskk -
.kk- .
IsSomekk. 4
)kk4 5
{ll 
throwmm 
newmm %
InvalidOperationExceptionmm 3
(mm3 4
$strnn v
)nnv w
;nnw x
}oo 
returnqq (
_applicationInstanceSettingsqq /
.qq/ 0
Valueqq0 5
!qq5 6
;qq6 7
}rr 	
}ss 
privateuu 
asyncuu 
Taskuu 
<uu 
Resultuu 
<uu 
Optionuu $
<uu$ % 
EcliptixSessionStateuu% 9
>uu9 :
,uu: ;
NetworkFailureuu< J
>uuJ K
>uuK L0
$EstablishSecrecyChannelInternalAsyncuuM q
(uuq r
uintvv 
	connectIdvv 
,vv 
PubKeyExchangeTypeww 
EXCHANGE_TYPEww (
,ww( )
intxx 
?xx 

maxRetriesxx 
=xx 
nullxx 
,xx 
boolyy 
	saveStateyy 
=yy 
trueyy 
,yy 
CancellationTokenzz 
cancellationTokenzz +
=zz, -
defaultzz. 5
,zz5 6
bool{{ %
enablePendingRegistration{{ &
={{' (
true{{) -
){{- .
{|| 
if}} 

(}} 
EXCHANGE_TYPE}} 
==}} 
PubKeyExchangeType}} /
.}}/ 0&
DataCenterEphemeralConnect}}0 J
)}}J K
{~~ 	
Avalonia 
. 
	Threading 
. 

Dispatcher )
.) *
UIThread* 2
.2 3
Post3 7
(7 8
(8 9
)9 :
=>; =
{
ÄÄ !
connectivityService
ÅÅ #
.
ÅÅ# $
PublishAsync
ÅÅ$ 0
(
ÅÅ0 1 
ConnectivityIntent
ÅÅ1 C
.
ÅÅC D

Connecting
ÅÅD N
(
ÅÅN O
	connectId
ÅÅO X
)
ÅÅX Y
)
ÅÅY Z
.
ÅÅZ [
ContinueWith
ÅÅ[ g
(
ÅÅg h
task
ÇÇ 
=>
ÇÇ 
{
ÉÉ 
if
ÑÑ 
(
ÑÑ 
task
ÑÑ  
.
ÑÑ  !
	IsFaulted
ÑÑ! *
&&
ÑÑ+ -
task
ÑÑ. 2
.
ÑÑ2 3
	Exception
ÑÑ3 <
!=
ÑÑ= ?
null
ÑÑ@ D
)
ÑÑD E
{
ÖÖ 
Log
ÜÜ 
.
ÜÜ  
Error
ÜÜ  %
(
ÜÜ% &
task
ÜÜ& *
.
ÜÜ* +
	Exception
ÜÜ+ 4
,
ÜÜ4 5
$str
ÜÜ6 z
)
ÜÜz {
;
ÜÜ{ |
}
áá 
}
àà 
,
àà 
TaskScheduler
ââ !
.
ââ! "
Default
ââ" )
)
ââ) *
;
ââ* +
}
ää 
)
ää 
;
ää 
}
ãã 	
if
çç 

(
çç 
!
çç 
_connections
çç 
.
çç 
TryGetValue
çç %
(
çç% &
	connectId
çç& /
,
çç/ 0
out
çç1 4$
EcliptixProtocolSystem
çç5 K
?
ççK L
protocolSystem
ççM [
)
çç[ \
)
çç\ ]
{
éé 	
return
èè 
Result
èè 
<
èè 
Option
èè  
<
èè  !"
EcliptixSessionState
èè! 5
>
èè5 6
,
èè6 7
NetworkFailure
èè8 F
>
èèF G
.
èèG H
Err
èèH K
(
èèK L
NetworkFailure
êê 
.
êê %
DataCenterNotResponding
êê 6
(
êê6 7
$str
êê7 j
)
êêj k
)
êêk l
;
êêl m
}
ëë 	
Result
ìì 
<
ìì 
PubKeyExchange
ìì 
,
ìì %
EcliptixProtocolFailure
ìì 6
>
ìì6 7#
pubKeyExchangeRequest
ìì8 M
=
ììN O
protocolSystem
îî 
.
îî +
BeginDataCenterPubKeyExchange
îî 8
(
îî8 9
	connectId
îî9 B
,
îîB C
EXCHANGE_TYPE
îîD Q
)
îîQ R
;
îîR S
if
ññ 

(
ññ #
pubKeyExchangeRequest
ññ !
.
ññ! "
IsErr
ññ" '
)
ññ' (
{
óó 	
return
òò 
Result
òò 
<
òò 
Option
òò  
<
òò  !"
EcliptixSessionState
òò! 5
>
òò5 6
,
òò6 7
NetworkFailure
òò8 F
>
òòF G
.
òòG H
Err
òòH K
(
òòK L#
pubKeyExchangeRequest
ôô %
.
ôô% &
	UnwrapErr
ôô& /
(
ôô/ 0
)
ôô0 1
.
ôô1 2
ToNetworkFailure
ôô2 B
(
ôôB C
)
ôôC D
)
ôôD E
;
ôôE F
}
öö 	
EnvelopeMetadata
úú 
metadata
úú !
=
úú" #
EnvelopeBuilder
úú$ 3
.
úú3 4$
CreateEnvelopeMetadata
úú4 J
(
úúJ K
	requestId
ùù 
:
ùù 
	connectId
ùù  
,
ùù  !
nonce
ûû 
:
ûû 

ByteString
ûû 
.
ûû 
Empty
ûû #
,
ûû# $
ratchetIndex
üü 
:
üü 
$num
üü 
,
üü 
envelopeType
†† 
:
†† 
EnvelopeType
†† &
.
††& '
Request
††' .
)
°° 	
;
°°	 

Option
££ 
<
££ '
CertificatePinningService
££ (
>
££( )'
certificatePinningService
££* C
=
££D E
await
§§ .
 certificatePinningServiceFactory
§§ 2
.
§§2 3)
GetOrInitializeServiceAsync
§§3 N
(
§§N O
)
§§O P
;
§§P Q
if
¶¶ 

(
¶¶ 
!
¶¶ '
certificatePinningService
¶¶ &
.
¶¶& '
IsSome
¶¶' -
)
¶¶- .
{
ßß 	
return
®® 
Result
®® 
<
®® 
Option
®®  
<
®®  !"
EcliptixSessionState
®®! 5
>
®®5 6
,
®®6 7
NetworkFailure
®®8 F
>
®®F G
.
®®G H
Err
®®H K
(
®®K L
NetworkFailure
©© 
.
©© 
RsaEncryption
©© ,
(
©©, -
$str
©©- _
)
©©_ `
)
©©` a
;
©©a b
}
™™ 	
byte
¨¨ 
[
¨¨ 
]
¨¨ 
originalData
¨¨ 
=
¨¨ #
pubKeyExchangeRequest
¨¨ 3
.
¨¨3 4
Unwrap
¨¨4 :
(
¨¨: ;
)
¨¨; <
.
¨¨< =
ToByteArray
¨¨= H
(
¨¨H I
)
¨¨I J
;
¨¨J K
Result
ÆÆ 
<
ÆÆ 
byte
ÆÆ 
[
ÆÆ 
]
ÆÆ 
,
ÆÆ 
NetworkFailure
ÆÆ %
>
ÆÆ% &
encryptResult
ÆÆ' 4
=
ÆÆ5 6
rsaChunkEncryptor
ØØ 
.
ØØ 
EncryptInChunks
ØØ -
(
ØØ- .'
certificatePinningService
ØØ. G
.
ØØG H
Value
ØØH M
!
ØØM N
,
ØØN O
originalData
ØØP \
)
ØØ\ ]
;
ØØ] ^
if
∞∞ 

(
∞∞ 
encryptResult
∞∞ 
.
∞∞ 
IsErr
∞∞ 
)
∞∞  
{
±± 	
return
≤≤ 
Result
≤≤ 
<
≤≤ 
Option
≤≤  
<
≤≤  !"
EcliptixSessionState
≤≤! 5
>
≤≤5 6
,
≤≤6 7
NetworkFailure
≤≤8 F
>
≤≤F G
.
≤≤G H
Err
≤≤H K
(
≤≤K L
encryptResult
≤≤L Y
.
≤≤Y Z
	UnwrapErr
≤≤Z c
(
≤≤c d
)
≤≤d e
)
≤≤e f
;
≤≤f g
}
≥≥ 	
byte
µµ 
[
µµ 
]
µµ &
combinedEncryptedPayload
µµ '
=
µµ( )
encryptResult
µµ* 7
.
µµ7 8
Unwrap
µµ8 >
(
µµ> ?
)
µµ? @
;
µµ@ A
SecureEnvelope
∑∑ 
envelope
∑∑ 
=
∑∑  !
EnvelopeBuilder
∑∑" 1
.
∑∑1 2"
CreateSecureEnvelope
∑∑2 F
(
∑∑F G
metadata
∏∏ 
,
∏∏ 

ByteString
ππ 
.
ππ 
CopyFrom
ππ 
(
ππ  &
combinedEncryptedPayload
ππ  8
)
ππ8 9
)
∫∫ 	
;
∫∫	 

CancellationToken
ºº 

finalToken
ºº $
=
ºº% &
cancellationToken
ºº' 8
==
ºº9 ;
CancellationToken
ºº< M
.
ººM N
None
ººN R
?
ΩΩ (
GetConnectionRecoveryToken
ΩΩ (
(
ΩΩ( )
)
ΩΩ) *
:
ææ 
cancellationToken
ææ 
;
ææ  
Result
¿¿ 
<
¿¿ 
SecureEnvelope
¿¿ 
,
¿¿ 
NetworkFailure
¿¿ -
>
¿¿- .4
&establishAppDeviceSecrecyChannelResult
¿¿/ U
;
¿¿U V
if
¡¡ 

(
¡¡ 

maxRetries
¡¡ 
.
¡¡ 
HasValue
¡¡ 
)
¡¡  
{
¬¬ 	4
&establishAppDeviceSecrecyChannelResult
√√ 2
=
√√3 4
await
√√5 :
retryStrategy
√√; H
.
√√H I&
ExecuteRpcOperationAsync
√√I a
(
√√a b
(
ƒƒ 
_
ƒƒ 
,
ƒƒ 
ct
ƒƒ 
)
ƒƒ 
=>
ƒƒ 
rpcServiceManager
ƒƒ ,
.
ƒƒ, -*
EstablishSecrecyChannelAsync
ƒƒ- I
(
ƒƒI J!
connectivityService
ƒƒJ ]
,
ƒƒ] ^
envelope
ƒƒ_ g
,
ƒƒg h
EXCHANGE_TYPE
≈≈ !
,
≈≈! "
cancellationToken
∆∆ %
:
∆∆% &
ct
∆∆' )
)
∆∆) *
,
∆∆* +
$str
«« )
,
««) *
	connectId
»» 
,
»» 
serviceType
…… 
:
…… 
RpcServiceType
…… +
.
……+ ,%
EstablishSecrecyChannel
……, C
,
……C D

maxRetries
   
:
   

maxRetries
   &
.
  & '
Value
  ' ,
,
  , -
cancellationToken
ÀÀ !
:
ÀÀ! "

finalToken
ÀÀ# -
)
ÀÀ- .
.
ÀÀ. /
ConfigureAwait
ÀÀ/ =
(
ÀÀ= >
false
ÀÀ> C
)
ÀÀC D
;
ÀÀD E
}
ÃÃ 	
else
ÕÕ 
{
ŒŒ 	4
&establishAppDeviceSecrecyChannelResult
œœ 2
=
œœ3 4
await
œœ5 :
retryStrategy
œœ; H
.
œœH I&
ExecuteRpcOperationAsync
œœI a
(
œœa b
(
–– 
_
–– 
,
–– 
ct
–– 
)
–– 
=>
–– 
rpcServiceManager
–– ,
.
––, -*
EstablishSecrecyChannelAsync
––- I
(
––I J!
connectivityService
––J ]
,
––] ^
envelope
––_ g
,
––g h
EXCHANGE_TYPE
—— !
,
——! "
cancellationToken
““ %
:
““% &
ct
““' )
)
““) *
,
““* +
$str
”” )
,
””) *
	connectId
‘‘ 
,
‘‘ 
serviceType
’’ 
:
’’ 
RpcServiceType
’’ +
.
’’+ ,%
EstablishSecrecyChannel
’’, C
,
’’C D
cancellationToken
÷÷ !
:
÷÷! "

finalToken
÷÷# -
)
÷÷- .
.
÷÷. /
ConfigureAwait
÷÷/ =
(
÷÷= >
false
÷÷> C
)
÷÷C D
;
÷÷D E
}
◊◊ 	
if
ŸŸ 

(
ŸŸ 4
&establishAppDeviceSecrecyChannelResult
ŸŸ 2
.
ŸŸ2 3
IsErr
ŸŸ3 8
)
ŸŸ8 9
{
⁄⁄ 	
NetworkFailure
€€ 
failure
€€ "
=
€€# $4
&establishAppDeviceSecrecyChannelResult
€€% K
.
€€K L
	UnwrapErr
€€L U
(
€€U V
)
€€V W
;
€€W X
if
‹‹ 
(
‹‹ '
enablePendingRegistration
‹‹ )
&&
‹‹* ,,
ShouldQueueSecrecyChannelRetry
‹‹- K
(
‹‹K L
failure
‹‹L S
)
‹‹S T
)
‹‹T U
{
›› /
!QueueSecrecyChannelEstablishRetry
ﬁﬁ 1
(
ﬁﬁ1 2
	connectId
ﬁﬁ2 ;
,
ﬁﬁ; <
EXCHANGE_TYPE
ﬁﬁ= J
,
ﬁﬁJ K

maxRetries
ﬁﬁL V
,
ﬁﬁV W
	saveState
ﬁﬁX a
)
ﬁﬁa b
;
ﬁﬁb c
}
ﬂﬂ 
return
·· 
Result
·· 
<
·· 
Option
··  
<
··  !"
EcliptixSessionState
··! 5
>
··5 6
,
··6 7
NetworkFailure
··8 F
>
··F G
.
··G H
Err
··H K
(
··K L
failure
··L S
)
··S T
;
··T U
}
‚‚ 	
SecureEnvelope
‰‰ 
responseEnvelope
‰‰ '
=
‰‰( )4
&establishAppDeviceSecrecyChannelResult
‰‰* P
.
‰‰P Q
Unwrap
‰‰Q W
(
‰‰W X
)
‰‰X Y
;
‰‰Y Z
if
ÊÊ 

(
ÊÊ 
EXCHANGE_TYPE
ÊÊ 
==
ÊÊ  
PubKeyExchangeType
ÊÊ /
.
ÊÊ/ 0(
DataCenterEphemeralConnect
ÊÊ0 J
)
ÊÊJ K
{
ÁÁ 	*
CertificatePinningBoolResult
ËË (*
certificatePinningBoolResult
ËË) E
=
ËËF G'
certificatePinningService
ÈÈ )
.
ÈÈ) *
Value
ÈÈ* /
!
ÈÈ/ 0
.
ÈÈ0 1#
VerifyServerSignature
ÈÈ1 F
(
ÈÈF G
responseEnvelope
ÍÍ $
.
ÍÍ$ %
EncryptedPayload
ÍÍ% 5
.
ÍÍ5 6
Memory
ÍÍ6 <
,
ÍÍ< =
responseEnvelope
ÎÎ $
.
ÎÎ$ %
AuthenticationTag
ÎÎ% 6
.
ÎÎ6 7
Memory
ÎÎ7 =
)
ÎÎ= >
;
ÎÎ> ?
if
ÌÌ 
(
ÌÌ 
!
ÌÌ *
certificatePinningBoolResult
ÌÌ -
.
ÌÌ- .
	IsSuccess
ÌÌ. 7
)
ÌÌ7 8
{
ÓÓ 
return
ÔÔ 
Result
ÔÔ 
<
ÔÔ 
Option
ÔÔ $
<
ÔÔ$ %"
EcliptixSessionState
ÔÔ% 9
>
ÔÔ9 :
,
ÔÔ: ;
NetworkFailure
ÔÔ< J
>
ÔÔJ K
.
ÔÔK L
Err
ÔÔL O
(
ÔÔO P
NetworkFailure
 "
.
" #
RsaEncryption
# 0
(
0 1
$"
ÒÒ 
$str
ÒÒ @
{
ÒÒ@ A*
certificatePinningBoolResult
ÒÒA ]
.
ÒÒ] ^
ERROR
ÒÒ^ c
?
ÒÒc d
.
ÒÒd e
Message
ÒÒe l
}
ÒÒl m
"
ÒÒm n
)
ÒÒn o
)
ÒÒo p
;
ÒÒp q
}
ÚÚ 
}
ÛÛ 	
byte
ıı 
[
ıı 
]
ıı '
combinedEncryptedResponse
ıı (
=
ıı) *
responseEnvelope
ıı+ ;
.
ıı; <
EncryptedPayload
ıı< L
.
ııL M
ToByteArray
ııM X
(
ııX Y
)
ııY Z
;
ııZ [
Result
˜˜ 
<
˜˜ 
byte
˜˜ 
[
˜˜ 
]
˜˜ 
,
˜˜ 
NetworkFailure
˜˜ %
>
˜˜% &
decryptResult
˜˜' 4
=
˜˜5 6
rsaChunkEncryptor
¯¯ 
.
¯¯ 
DecryptInChunks
¯¯ -
(
¯¯- .'
certificatePinningService
¯¯. G
.
¯¯G H
Value
¯¯H M
!
¯¯M N
,
¯¯N O'
combinedEncryptedResponse
¯¯P i
)
¯¯i j
;
¯¯j k
if
˘˘ 

(
˘˘ 
decryptResult
˘˘ 
.
˘˘ 
IsErr
˘˘ 
)
˘˘  
{
˙˙ 	
return
˚˚ 
Result
˚˚ 
<
˚˚ 
Option
˚˚  
<
˚˚  !"
EcliptixSessionState
˚˚! 5
>
˚˚5 6
,
˚˚6 7
NetworkFailure
˚˚8 F
>
˚˚F G
.
˚˚G H
Err
˚˚H K
(
˚˚K L
decryptResult
˚˚L Y
.
˚˚Y Z
	UnwrapErr
˚˚Z c
(
˚˚c d
)
˚˚d e
)
˚˚e f
;
˚˚f g
}
¸¸ 	
PubKeyExchange
˛˛  
peerPubKeyExchange
˛˛ )
=
˛˛* +
PubKeyExchange
˛˛, :
.
˛˛: ;
Parser
˛˛; A
.
˛˛A B
	ParseFrom
˛˛B K
(
˛˛K L
decryptResult
˛˛L Y
.
˛˛Y Z
Unwrap
˛˛Z `
(
˛˛` a
)
˛˛a b
)
˛˛b c
;
˛˛c d
Result
ÄÄ 
<
ÄÄ 
Unit
ÄÄ 
,
ÄÄ %
EcliptixProtocolFailure
ÄÄ ,
>
ÄÄ, -
completeResult
ÄÄ. <
=
ÄÄ= >
protocolSystem
ÅÅ 
.
ÅÅ .
 CompleteDataCenterPubKeyExchange
ÅÅ ;
(
ÅÅ; < 
peerPubKeyExchange
ÅÅ< N
)
ÅÅN O
;
ÅÅO P
if
ÇÇ 

(
ÇÇ 
completeResult
ÇÇ 
.
ÇÇ 
IsErr
ÇÇ  
)
ÇÇ  !
{
ÉÉ 	
return
ÑÑ 
Result
ÑÑ 
<
ÑÑ 
Option
ÑÑ  
<
ÑÑ  !"
EcliptixSessionState
ÑÑ! 5
>
ÑÑ5 6
,
ÑÑ6 7
NetworkFailure
ÑÑ8 F
>
ÑÑF G
.
ÑÑG H
Err
ÑÑH K
(
ÑÑK L
completeResult
ÖÖ 
.
ÖÖ 
	UnwrapErr
ÖÖ (
(
ÖÖ( )
)
ÖÖ) *
.
ÖÖ* +
ToNetworkFailure
ÖÖ+ ;
(
ÖÖ; <
)
ÖÖ< =
)
ÖÖ= >
;
ÖÖ> ?
}
ÜÜ 	
if
àà 

(
àà 
!
àà 
	saveState
àà 
||
àà 
EXCHANGE_TYPE
àà '
!=
àà( * 
PubKeyExchangeType
àà+ =
.
àà= >(
DataCenterEphemeralConnect
àà> X
)
ààX Y
{
ââ 	
return
ää 
Result
ää 
<
ää 
Option
ää  
<
ää  !"
EcliptixSessionState
ää! 5
>
ää5 6
,
ää6 7
NetworkFailure
ää8 F
>
ääF G
.
ääG H
Ok
ääH J
(
ääJ K
Option
ääK Q
<
ääQ R"
EcliptixSessionState
ääR f
>
ääf g
.
ääg h
None
ääh l
)
ääl m
;
ääm n
}
ãã 	(
EcliptixSystemIdentityKeys
çç "
idKeys
çç# )
=
çç* +
protocolSystem
çç, :
.
çç: ;
GetIdentityKeys
çç; J
(
ççJ K
)
ççK L
;
ççL M(
EcliptixProtocolConnection
éé "
?
éé" #

connection
éé$ .
=
éé/ 0
protocolSystem
éé1 ?
.
éé? @
GetConnection
éé@ M
(
ééM N
)
ééN O
;
ééO P
if
èè 

(
èè 

connection
èè 
==
èè 
null
èè 
)
èè 
{
êê 	
return
ëë 
Result
ëë 
<
ëë 
Option
ëë  
<
ëë  !"
EcliptixSessionState
ëë! 5
>
ëë5 6
,
ëë6 7
NetworkFailure
ëë8 F
>
ëëF G
.
ëëG H
Err
ëëH K
(
ëëK L
new
íí 
NetworkFailure
íí "
(
íí" # 
NetworkFailureType
íí# 5
.
íí5 6%
DataCenterNotResponding
íí6 M
,
ííM N
$str
ìì >
)
ìì> ?
)
ìì? @
;
ìì@ A
}
îî 	
Result
ññ 
<
ññ "
EcliptixSessionState
ññ #
,
ññ# $%
EcliptixProtocolFailure
ññ% <
>
ññ< =/
!ecliptixSecrecyChannelStateResult
ññ> _
=
ññ` a
idKeys
óó 
.
óó 
ToProtoState
óó 
(
óó  
)
óó  !
.
òò 
AndThen
òò 
(
òò 
identityKeysProto
òò *
=>
òò+ -

connection
òò. 8
.
òò8 9
ToProtoState
òò9 E
(
òòE F
)
òòF G
.
ôô 
Map
ôô 
(
ôô 
ratchetStateProto
ôô *
=>
ôô+ -
new
ôô. 1"
EcliptixSessionState
ôô2 F
{
öö 
	ConnectId
õõ !
=
õõ" #
	connectId
õõ$ -
,
õõ- .
IdentityKeys
úú $
=
úú% &
identityKeysProto
úú' 8
,
úú8 9"
PeerHandshakeMessage
ùù ,
=
ùù- . 
peerPubKeyExchange
ùù/ A
,
ùùA B
RatchetState
ûû $
=
ûû% &
ratchetStateProto
ûû' 8
}
üü 
)
üü 
)
†† 
;
†† 
Result
¢¢ 
<
¢¢ 
Option
¢¢ 
<
¢¢ "
EcliptixSessionState
¢¢ *
>
¢¢* +
,
¢¢+ ,
NetworkFailure
¢¢- ;
>
¢¢; <
mappedResult
¢¢= I
=
¢¢J K/
!ecliptixSecrecyChannelStateResult
££ -
.
££- .
ToNetworkFailure
££. >
(
££> ?
)
££? @
.
££@ A
Map
££A D
(
££D E
Option
££E K
<
££K L"
EcliptixSessionState
££L `
>
££` a
.
££a b
Some
££b f
)
££f g
;
££g h
if
•• 

(
•• '
enablePendingRegistration
•• %
&&
••& (
mappedResult
••) 5
.
••5 6
IsOk
••6 :
)
••: ;
{
¶¶ 	#
pendingRequestManager
ßß !
.
ßß! ""
RemovePendingRequest
ßß" 6
(
ßß6 7+
BuildSecrecyChannelPendingKey
ßß7 T
(
ßßT U
	connectId
ßßU ^
,
ßß^ _
EXCHANGE_TYPE
ßß` m
)
ßßm n
)
ßßn o
;
ßßo p

ExitOutage
®® 
(
®® 
)
®® 
;
®® 
}
©© 	
return
´´ 
mappedResult
´´ 
;
´´ 
}
¨¨ 
public
ÆÆ 

void
ÆÆ 

SetCountry
ÆÆ 
(
ÆÆ 
string
ÆÆ !
country
ÆÆ" )
)
ÆÆ) *
{
ØØ 
lock
∞∞ 
(
∞∞ $
_appInstanceSetterLock
∞∞ $
)
∞∞$ %
{
±± 	
if
≤≤ 
(
≤≤ *
_applicationInstanceSettings
≤≤ ,
.
≤≤, -
IsSome
≤≤- 3
)
≤≤3 4
{
≥≥ )
ApplicationInstanceSettings
¥¥ +
current
¥¥, 3
=
¥¥4 5*
_applicationInstanceSettings
¥¥6 R
.
¥¥R S
Value
¥¥S X
!
¥¥X Y
;
¥¥Y Z)
ApplicationInstanceSettings
µµ +
updated
µµ, 3
=
µµ4 5
current
µµ6 =
.
µµ= >
Clone
µµ> C
(
µµC D
)
µµD E
;
µµE F
updated
∂∂ 
.
∂∂ 
Country
∂∂ 
=
∂∂  !
country
∂∂" )
;
∂∂) **
_applicationInstanceSettings
∑∑ ,
=
∑∑- .
Option
∑∑/ 5
<
∑∑5 6)
ApplicationInstanceSettings
∑∑6 Q
>
∑∑Q R
.
∑∑R S
Some
∑∑S W
(
∑∑W X
updated
∑∑X _
)
∑∑_ `
;
∑∑` a
}
∏∏ 
}
ππ 	
}
∫∫ 
public
ºº 

uint
ºº $
ComputeUniqueConnectId
ºº &
(
ºº& ' 
PubKeyExchangeType
ºº' 9 
pubKeyExchangeType
ºº: L
)
ººL M
=>
ººN P$
ComputeUniqueConnectId
ΩΩ 
(
ΩΩ *
_applicationInstanceSettings
ΩΩ ;
.
ΩΩ; <
Value
ΩΩ< A
!
ΩΩA B
,
ΩΩB C 
pubKeyExchangeType
ΩΩD V
)
ΩΩV W
;
ΩΩW X
public
øø 

void
øø ,
InitiateEcliptixProtocolSystem
øø .
(
øø. /)
ApplicationInstanceSettings
øø/ J)
applicationInstanceSettings
øøK f
,
øøf g
uint
øøh l
	connectId
øøm v
)
øøv w
{
¿¿ *
_applicationInstanceSettings
¡¡ $
=
¡¡% &
Option
¡¡' -
<
¡¡- .)
ApplicationInstanceSettings
¡¡. I
>
¡¡I J
.
¡¡J K
Some
¡¡K O
(
¡¡O P)
applicationInstanceSettings
¡¡P k
)
¡¡k l
;
¡¡l m(
EcliptixSystemIdentityKeys
√√ "
identityKeys
√√# /
=
√√0 1(
EcliptixSystemIdentityKeys
ƒƒ &
.
ƒƒ& '
Create
ƒƒ' -
(
ƒƒ- .
NetworkConstants
ƒƒ. >
.
ƒƒ> ?
Protocol
ƒƒ? G
.
ƒƒG H(
DEFAULT_ONE_TIME_KEY_COUNT
ƒƒH b
)
ƒƒb c
.
ƒƒc d
Unwrap
ƒƒd j
(
ƒƒj k
)
ƒƒk l
;
ƒƒl m0
"DetermineExchangeTypeFromConnectId
∆∆ *
(
∆∆* +)
applicationInstanceSettings
∆∆+ F
,
∆∆F G
	connectId
∆∆H Q
)
∆∆Q R
;
∆∆R S$
EcliptixProtocolSystem
»» 
protocolSystem
»» -
=
»». /
new
»»0 3
(
»»3 4
identityKeys
»»4 @
)
»»@ A
;
»»A B
protocolSystem
   
.
   
SetEventHandler
   &
(
  & '
this
  ' +
)
  + ,
;
  , -
_connections
ÃÃ 
.
ÃÃ 
TryAdd
ÃÃ 
(
ÃÃ 
	connectId
ÃÃ %
,
ÃÃ% &
protocolSystem
ÃÃ' 5
)
ÃÃ5 6
;
ÃÃ6 7
Guid
ŒŒ 
appInstanceId
ŒŒ 
=
ŒŒ 
Helpers
ŒŒ $
.
ŒŒ$ %"
FromByteStringToGuid
ŒŒ% 9
(
ŒŒ9 :)
applicationInstanceSettings
ŒŒ: U
.
ŒŒU V
AppInstanceId
ŒŒV c
)
ŒŒc d
;
ŒŒd e
Guid
œœ 
deviceId
œœ 
=
œœ 
Helpers
œœ 
.
œœ  "
FromByteStringToGuid
œœ  4
(
œœ4 5)
applicationInstanceSettings
œœ5 P
.
œœP Q
DeviceId
œœQ Y
)
œœY Z
;
œœZ [
string
–– 
?
–– 
culture
–– 
=
–– 
string
––  
.
––  !
IsNullOrEmpty
––! .
(
––. /)
applicationInstanceSettings
––/ J
.
––J K
Culture
––K R
)
––R S
?
—— )
AppCultureSettingsConstants
—— )
.
——) *"
DEFAULT_CULTURE_CODE
——* >
:
““ )
applicationInstanceSettings
““ )
.
““) *
Culture
““* 1
;
““1 2!
rpcMetaDataProvider
‘‘ 
.
‘‘ 

SetAppInfo
‘‘ &
(
‘‘& '
appInstanceId
‘‘' 4
,
‘‘4 5
deviceId
‘‘6 >
,
‘‘> ?
culture
‘‘@ G
)
‘‘G H
;
‘‘H I
}
’’ 
public
◊◊ 

void
◊◊ 
ClearConnection
◊◊ 
(
◊◊  
uint
◊◊  $
	connectId
◊◊% .
)
◊◊. /
{
ÿÿ 
if
ŸŸ 

(
ŸŸ 
!
ŸŸ 
_connections
ŸŸ 
.
ŸŸ 
	TryRemove
ŸŸ #
(
ŸŸ# $
	connectId
ŸŸ$ -
,
ŸŸ- .
out
ŸŸ/ 2$
EcliptixProtocolSystem
ŸŸ3 I
?
ŸŸI J
system
ŸŸK Q
)
ŸŸQ R
)
ŸŸR S
{
⁄⁄ 	
return
€€ 
;
€€ 
}
‹‹ 	
system
ﬁﬁ 
.
ﬁﬁ 
Dispose
ﬁﬁ 
(
ﬁﬁ 
)
ﬁﬁ 
;
ﬁﬁ 
}
ﬂﬂ 
public
·· 

void
·· &
ClearExhaustedOperations
·· (
(
··( )
)
··) *
{
‚‚ 
retryStrategy
„„ 
.
„„ &
ClearExhaustedOperations
„„ .
(
„„. /
)
„„/ 0
;
„„0 1
}
‰‰ 
public
ÊÊ 

bool
ÊÊ 
HasConnection
ÊÊ 
(
ÊÊ 
uint
ÊÊ "
	connectId
ÊÊ# ,
)
ÊÊ, -
=>
ÊÊ. 0
_connections
ÊÊ1 =
.
ÊÊ= >
ContainsKey
ÊÊ> I
(
ÊÊI J
	connectId
ÊÊJ S
)
ÊÊS T
;
ÊÊT U
public
ËË 

async
ËË 
Task
ËË 
<
ËË 
Result
ËË 
<
ËË 
Unit
ËË !
,
ËË! "
NetworkFailure
ËË# 1
>
ËË1 2
>
ËË2 3&
ExecuteUnaryRequestAsync
ËË4 L
(
ËËL M
uint
ÈÈ 
	connectId
ÈÈ 
,
ÈÈ 
RpcServiceType
ÍÍ 
serviceType
ÍÍ "
,
ÍÍ" #
byte
ÎÎ 
[
ÎÎ 
]
ÎÎ 
plainBuffer
ÎÎ 
,
ÎÎ 
Func
ÏÏ 
<
ÏÏ 
byte
ÏÏ 
[
ÏÏ 
]
ÏÏ 
,
ÏÏ 
Task
ÏÏ 
<
ÏÏ 
Result
ÏÏ  
<
ÏÏ  !
Unit
ÏÏ! %
,
ÏÏ% &
NetworkFailure
ÏÏ' 5
>
ÏÏ5 6
>
ÏÏ6 7
>
ÏÏ7 8
onCompleted
ÏÏ9 D
,
ÏÏD E
bool
ÌÌ 
allowDuplicates
ÌÌ 
=
ÌÌ 
false
ÌÌ $
,
ÌÌ$ %
CancellationToken
ÓÓ 
token
ÓÓ 
=
ÓÓ  !
default
ÓÓ" )
,
ÓÓ) *
bool
ÔÔ 
waitForRecovery
ÔÔ 
=
ÔÔ 
true
ÔÔ #
,
ÔÔ# $
RpcRequestContext
 
?
 
requestContext
 )
=
* +
null
, 0
)
0 1
{
ÒÒ 
return
ÚÚ 
await
ÚÚ 0
"ExecuteServiceRequestInternalAsync
ÚÚ 7
(
ÚÚ7 8
	connectId
ÛÛ 
,
ÛÛ 
serviceType
ÛÛ "
,
ÛÛ" #
plainBuffer
ÛÛ$ /
,
ÛÛ/ 0
ServiceFlowType
ÛÛ1 @
.
ÛÛ@ A
Single
ÛÛA G
,
ÛÛG H
onCompleted
ÙÙ 
,
ÙÙ 
allowDuplicates
ÙÙ (
,
ÙÙ( )
token
ÙÙ* /
,
ÙÙ/ 0
waitForRecovery
ÙÙ1 @
,
ÙÙ@ A
requestContext
ÙÙB P
)
ÙÙP Q
.
ÙÙQ R
ConfigureAwait
ÙÙR `
(
ÙÙ` a
false
ÙÙa f
)
ÙÙf g
;
ÙÙg h
}
ıı 
public
˜˜ 

async
˜˜ 
Task
˜˜ 
<
˜˜ 
Result
˜˜ 
<
˜˜ 
Unit
˜˜ !
,
˜˜! "
NetworkFailure
˜˜# 1
>
˜˜1 2
>
˜˜2 3.
 ExecuteReceiveStreamRequestAsync
˜˜4 T
(
˜˜T U
uint
¯¯ 
	connectId
¯¯ 
,
¯¯ 
RpcServiceType
˘˘ 
serviceType
˘˘ "
,
˘˘" #
byte
˙˙ 
[
˙˙ 
]
˙˙ 
plainBuffer
˙˙ 
,
˙˙ 
Func
˚˚ 
<
˚˚ 
byte
˚˚ 
[
˚˚ 
]
˚˚ 
,
˚˚ 
Task
˚˚ 
<
˚˚ 
Result
˚˚  
<
˚˚  !
Unit
˚˚! %
,
˚˚% &
NetworkFailure
˚˚' 5
>
˚˚5 6
>
˚˚6 7
>
˚˚7 8
onStreamItem
˚˚9 E
,
˚˚E F
bool
¸¸ 
allowDuplicates
¸¸ 
=
¸¸ 
false
¸¸ $
,
¸¸$ %
CancellationToken
˝˝ 
token
˝˝ 
=
˝˝  !
default
˝˝" )
)
˝˝) *
{
˛˛ 
return
ˇˇ 
await
ˇˇ 0
"ExecuteServiceRequestInternalAsync
ˇˇ 7
(
ˇˇ7 8
	connectId
ÄÄ 
,
ÄÄ 
serviceType
ÄÄ "
,
ÄÄ" #
plainBuffer
ÄÄ$ /
,
ÄÄ/ 0
ServiceFlowType
ÄÄ1 @
.
ÄÄ@ A
ReceiveStream
ÄÄA N
,
ÄÄN O
onStreamItem
ÅÅ 
,
ÅÅ 
allowDuplicates
ÅÅ )
,
ÅÅ) *
token
ÅÅ+ 0
)
ÅÅ0 1
.
ÅÅ1 2
ConfigureAwait
ÅÅ2 @
(
ÅÅ@ A
false
ÅÅA F
)
ÅÅF G
;
ÅÅG H
}
ÇÇ 
private
ÑÑ 
async
ÑÑ 
Task
ÑÑ 
<
ÑÑ 
Result
ÑÑ 
<
ÑÑ 
Unit
ÑÑ "
,
ÑÑ" #
NetworkFailure
ÑÑ$ 2
>
ÑÑ2 3
>
ÑÑ3 40
"ExecuteServiceRequestInternalAsync
ÑÑ5 W
(
ÑÑW X
uint
ÖÖ 
	connectId
ÖÖ 
,
ÖÖ 
RpcServiceType
ÜÜ 
serviceType
ÜÜ "
,
ÜÜ" #
byte
áá 
[
áá 
]
áá 
plainBuffer
áá 
,
áá 
ServiceFlowType
àà 
flowType
àà  
,
àà  !
Func
ââ 
<
ââ 
byte
ââ 
[
ââ 
]
ââ 
,
ââ 
Task
ââ 
<
ââ 
Result
ââ  
<
ââ  !
Unit
ââ! %
,
ââ% &
NetworkFailure
ââ' 5
>
ââ5 6
>
ââ6 7
>
ââ7 8
onCompleted
ââ9 D
,
ââD E
bool
ää $
allowDuplicateRequests
ää #
=
ää$ %
false
ää& +
,
ää+ ,
CancellationToken
ãã 
cancellationToken
ãã +
=
ãã, -
default
ãã. 5
,
ãã5 6
bool
åå 
waitForRecovery
åå 
=
åå 
true
åå #
,
åå# $
RpcRequestContext
çç 
?
çç 
requestContext
çç )
=
çç* +
null
çç, 0
)
çç0 1
{
éé 
RpcRequestContext
èè 
effectiveContext
èè *
=
èè+ ,
requestContext
èè- ;
??
èè< >
RpcRequestContext
èè? P
.
èèP Q
	CreateNew
èèQ Z
(
èèZ [
)
èè[ \
;
èè\ ]
RetryBehavior
êê 
retryBehavior
êê #
=
êê$ %!
retryPolicyProvider
êê& 9
.
êê9 :
GetRetryBehavior
êê: J
(
êêJ K
serviceType
êêK V
)
êêV W
;
êêW X
string
íí 

requestKey
íí 
;
íí 
if
ìì 

(
ìì 
serviceType
ìì 
is
ìì 
RpcServiceType
ìì )
.
ìì) *
SignInInitRequest
ìì* ;
or
ìì< >
RpcServiceType
ìì? M
.
ììM N#
SignInCompleteRequest
ììN c
)
ììc d
{
îî 	

requestKey
ïï 
=
ïï 
$"
ïï 
{
ïï 
	connectId
ïï %
}
ïï% &
$str
ïï& '
{
ïï' (
serviceType
ïï( 3
}
ïï3 4
$str
ïï4 C
"
ïïC D
;
ïïD E
}
ññ 	
else
óó 
{
òò 	
int
ôô 
bytesToHash
ôô 
=
ôô 
Math
ôô "
.
ôô" #
Min
ôô# &
(
ôô& '
plainBuffer
ôô' 2
.
ôô2 3
Length
ôô3 9
,
ôô9 :
NetworkConstants
ôô; K
.
ôôK L
Protocol
ôôL T
.
ôôT U+
REQUEST_KEY_HEX_PREFIX_LENGTH
ôôU r
/
ôôs t
$num
ôôu v
)
ôôv w
;
ôôw x
Span
öö 
<
öö 
char
öö 
>
öö 
	hexBuffer
öö  
=
öö! "

stackalloc
öö# -
char
öö. 2
[
öö2 3
NetworkConstants
öö3 C
.
ööC D
Protocol
ööD L
.
ööL M+
REQUEST_KEY_HEX_PREFIX_LENGTH
ööM j
]
ööj k
;
öök l
bool
õõ 
success
õõ 
=
õõ 
Convert
õõ "
.
õõ" #
TryToHexString
õõ# 1
(
õõ1 2
plainBuffer
õõ2 =
.
õõ= >
AsSpan
õõ> D
(
õõD E
$num
õõE F
,
õõF G
bytesToHash
õõH S
)
õõS T
,
õõT U
	hexBuffer
õõV _
,
õõ_ `
out
õõa d
int
õõe h
charsWritten
õõi u
)
õõu v
;
õõv w

requestKey
úú 
=
úú 
success
úú  
?
ùù 
$"
ùù 
{
ùù 
	connectId
ùù 
}
ùù 
$str
ùù  
{
ùù  !
serviceType
ùù! ,
}
ùù, -
$str
ùù- .
{
ùù. /
	hexBuffer
ùù/ 8
[
ùù8 9
..
ùù9 ;
charsWritten
ùù; G
]
ùùG H
.
ùùH I
ToString
ùùI Q
(
ùùQ R
)
ùùR S
}
ùùS T
"
ùùT U
:
ûû 
$"
ûû 
{
ûû 
	connectId
ûû 
}
ûû 
$str
ûû  
{
ûû  !
serviceType
ûû! ,
}
ûû, -
$str
ûû- 6
"
ûû6 7
;
ûû7 8
}
üü 	
bool
°° #
shouldAllowDuplicates
°° "
=
°°# $$
allowDuplicateRequests
°°% ;
||
°°< >(
CanServiceTypeBeDuplicated
°°? Y
(
°°Y Z
serviceType
°°Z e
)
°°e f
;
°°f g%
CancellationTokenSource
¢¢ %
cancellationTokenSource
¢¢  7
=
¢¢8 9
new
¢¢: =
(
¢¢= >
)
¢¢> ?
;
¢¢? @
if
££ 

(
££ 
!
££ #
shouldAllowDuplicates
££ "
&&
££# %
!
££& '
_pendingRequests
££' 7
.
££7 8
TryAdd
££8 >
(
££> ?

requestKey
££? I
,
££I J%
cancellationTokenSource
££K b
)
££b c
)
££c d
{
§§ 	%
cancellationTokenSource
•• #
.
••# $
Dispose
••$ +
(
••+ ,
)
••, -
;
••- .
return
¶¶ 
Result
¶¶ 
<
¶¶ 
Unit
¶¶ 
,
¶¶ 
NetworkFailure
¶¶  .
>
¶¶. /
.
¶¶/ 0
Err
¶¶0 3
(
¶¶3 4
NetworkFailure
ßß 
.
ßß  
InvalidRequestType
ßß 1
(
ßß1 2
$str
ßß2 N
)
ßßN O
)
ßßO P
;
ßßP Q
}
®® 	+
CancellationTokenRegistration
™™ %
tokenRegistration
™™& 7
=
™™8 9
default
™™: A
;
™™A B
if
´´ 

(
´´ 
cancellationToken
´´ 
.
´´ 
CanBeCanceled
´´ +
)
´´+ ,
{
¨¨ 	
tokenRegistration
≠≠ 
=
≠≠ 
cancellationToken
≠≠  1
.
≠≠1 2
Register
≠≠2 :
(
≠≠: ;
(
≠≠; <
)
≠≠< =
=>
≠≠> @
{
ÆÆ 
try
ØØ 
{
∞∞ 
if
±± 
(
±± 
!
±± %
cancellationTokenSource
±± 0
.
±±0 1%
IsCancellationRequested
±±1 H
)
±±H I
{
≤≤ %
cancellationTokenSource
≥≥ /
.
≥≥/ 0
Cancel
≥≥0 6
(
≥≥6 7
)
≥≥7 8
;
≥≥8 9
}
¥¥ 
}
µµ 
catch
∂∂ 
(
∂∂ %
ObjectDisposedException
∂∂ .
)
∂∂. /
{
∑∑ 
}
ππ 
}
∫∫ 
)
∫∫ 
;
∫∫ 
}
ªª 	%
CancellationTokenSource
ΩΩ +
linkedCancellationTokenSource
ΩΩ  =
=
ΩΩ> ?%
CancellationTokenSource
ææ #
.
ææ# $%
CreateLinkedTokenSource
ææ$ ;
(
ææ; <
cancellationToken
ææ< M
,
ææM N%
cancellationTokenSource
ææO f
.
ææf g
Token
ææg l
)
ææl m
;
ææm n
CancellationToken
øø 
operationToken
øø (
=
øø) *+
linkedCancellationTokenSource
øø+ H
.
øøH I
Token
øøI N
;
øøN O
bool
¡¡  
disposedRequestCts
¡¡ 
=
¡¡  !
false
¡¡" '
;
¡¡' (
try
¬¬ 
{
√√ 	
await
ƒƒ (
WaitForOutageRecoveryAsync
ƒƒ ,
(
ƒƒ, -
operationToken
ƒƒ- ;
,
ƒƒ; <
waitForRecovery
ƒƒ= L
)
ƒƒL M
.
ƒƒM N
ConfigureAwait
ƒƒN \
(
ƒƒ\ ]
false
ƒƒ] b
)
ƒƒb c
;
ƒƒc d
operationToken
∆∆ 
.
∆∆ *
ThrowIfCancellationRequested
∆∆ 7
(
∆∆7 8
)
∆∆8 9
;
∆∆9 :
if
»» 
(
»» 
!
»» 
_connections
»» 
.
»» 
TryGetValue
»» )
(
»») *
	connectId
»»* 3
,
»»3 4
out
»»5 8$
EcliptixProtocolSystem
»»9 O
?
»»O P
protocolSystem
»»Q _
)
»»_ `
)
»»` a
{
…… 
NetworkFailure
   !
noConnectionFailure
   2
=
  3 4
NetworkFailure
  5 C
.
  C D%
DataCenterNotResponding
  D [
(
  [ \
$str
ÀÀ G
)
ÀÀG H
;
ÀÀH I
_
ÃÃ 
=
ÃÃ !
connectivityService
ÃÃ '
.
ÃÃ' (
PublishAsync
ÃÃ( 4
(
ÃÃ4 5 
ConnectivityIntent
ÕÕ &
.
ÕÕ& '
ServerShutdown
ÕÕ' 5
(
ÕÕ5 6!
noConnectionFailure
ÕÕ6 I
)
ÕÕI J
)
ÕÕJ K
.
ÕÕK L
ContinueWith
ÕÕL X
(
ÕÕX Y
task
ŒŒ 
=>
ŒŒ 
{
œœ 
if
–– 
(
–– 
task
––  
.
––  !
	IsFaulted
––! *
&&
––+ -
task
––. 2
.
––2 3
	Exception
––3 <
!=
––= ?
null
––@ D
)
––D E
{
—— 
Log
““ 
.
““  
Error
““  %
(
““% &
task
““& *
.
““* +
	Exception
““+ 4
,
““4 5
$str
““6 
)““ Ä
;““Ä Å
}
”” 
}
‘‘ 
,
‘‘ 
TaskScheduler
’’ !
.
’’! "
Default
’’" )
)
’’) *
;
’’* +
return
÷÷ 
Result
÷÷ 
<
÷÷ 
Unit
÷÷ "
,
÷÷" #
NetworkFailure
÷÷$ 2
>
÷÷2 3
.
÷÷3 4
Err
÷÷4 7
(
÷÷7 8!
noConnectionFailure
÷÷8 K
)
÷÷K L
;
÷÷L M
}
◊◊ 
uint
ŸŸ  
logicalOperationId
ŸŸ #
=
ŸŸ$ %(
GenerateLogicalOperationId
ŸŸ& @
(
ŸŸ@ A
	connectId
ŸŸA J
,
ŸŸJ K
serviceType
ŸŸL W
,
ŸŸW X
plainBuffer
ŸŸY d
)
ŸŸd e
;
ŸŸe f
try
€€ 
{
‹‹ 
Result
›› 
<
›› 
Unit
›› 
,
›› 
NetworkFailure
›› +
>
››+ ,
networkResult
››- :
=
››; <
flowType
››= E
switch
››F L
{
ﬁﬁ 
ServiceFlowType
ﬂﬂ #
.
ﬂﬂ# $
Single
ﬂﬂ$ *
=>
ﬂﬂ+ -
await
ﬂﬂ. 3#
SendUnaryRequestAsync
ﬂﬂ4 I
(
ﬂﬂI J
protocolSystem
ﬂﬂJ X
,
ﬂﬂX Y 
logicalOperationId
ﬂﬂZ l
,
ﬂﬂl m
serviceType
‡‡ '
,
‡‡' (
plainBuffer
‡‡) 4
,
‡‡4 5
flowType
‡‡6 >
,
‡‡> ?
onCompleted
‡‡@ K
,
‡‡K L
	connectId
‡‡M V
,
‡‡V W
retryBehavior
‡‡X e
,
‡‡e f
operationToken
‡‡g u
)
‡‡u v
.
·· 
ConfigureAwait
·· '
(
··' (
false
··( -
)
··- .
,
··. /
ServiceFlowType
‚‚ #
.
‚‚# $
ReceiveStream
‚‚$ 1
=>
‚‚2 4
await
‚‚5 :+
SendReceiveStreamRequestAsync
‚‚; X
(
‚‚X Y
protocolSystem
‚‚Y g
,
‚‚g h 
logicalOperationId
„„ *
,
„„* +
serviceType
‰‰ #
,
‰‰# $
plainBuffer
‰‰% 0
,
‰‰0 1
flowType
‰‰2 :
,
‰‰: ;
effectiveContext
‰‰< L
,
‰‰L M
onCompleted
‰‰N Y
,
‰‰Y Z
retryBehavior
‰‰[ h
,
‰‰h i
	connectId
‰‰j s
,
‰‰s t
operationToken
ÂÂ &
)
ÂÂ& '
.
ÂÂ' (
ConfigureAwait
ÂÂ( 6
(
ÂÂ6 7
false
ÂÂ7 <
)
ÂÂ< =
,
ÂÂ= >
ServiceFlowType
ÊÊ #
.
ÊÊ# $

SendStream
ÊÊ$ .
=>
ÊÊ/ 1
await
ÊÊ2 7(
SendSendStreamRequestAsync
ÊÊ8 R
(
ÊÊR S
protocolSystem
ÊÊS a
,
ÊÊa b 
logicalOperationId
ÊÊc u
,
ÊÊu v
serviceType
ÁÁ '
,
ÁÁ' (
plainBuffer
ÁÁ) 4
,
ÁÁ4 5
flowType
ÁÁ6 >
,
ÁÁ> ?
effectiveContext
ÁÁ@ P
,
ÁÁP Q
operationToken
ÁÁR `
)
ÁÁ` a
.
ËË 
ConfigureAwait
ËË '
(
ËË' (
false
ËË( -
)
ËË- .
,
ËË. /
ServiceFlowType
ÈÈ #
.
ÈÈ# $!
BidirectionalStream
ÈÈ$ 7
=>
ÈÈ8 :
await
ÈÈ; @1
#SendBidirectionalStreamRequestAsync
ÈÈA d
(
ÈÈd e
protocolSystem
ÈÈe s
,
ÈÈs t 
logicalOperationId
ÍÍ .
,
ÍÍ. /
serviceType
ÍÍ0 ;
,
ÍÍ; <
plainBuffer
ÍÍ= H
,
ÍÍH I
flowType
ÍÍJ R
,
ÍÍR S
effectiveContext
ÍÍT d
,
ÍÍd e
operationToken
ÍÍf t
)
ÍÍt u
.
ÎÎ 
ConfigureAwait
ÎÎ '
(
ÎÎ' (
false
ÎÎ( -
)
ÎÎ- .
,
ÎÎ. /
_
ÏÏ 
=>
ÏÏ 
Result
ÏÏ 
<
ÏÏ  
Unit
ÏÏ  $
,
ÏÏ$ %
NetworkFailure
ÏÏ& 4
>
ÏÏ4 5
.
ÏÏ5 6
Err
ÏÏ6 9
(
ÏÏ9 :
NetworkFailure
ÌÌ &
.
ÌÌ& ' 
InvalidRequestType
ÌÌ' 9
(
ÌÌ9 :
$"
ÌÌ: <
$str
ÌÌ< S
{
ÌÌS T
flowType
ÌÌT \
}
ÌÌ\ ]
"
ÌÌ] ^
)
ÌÌ^ _
)
ÌÌ_ `
}
ÓÓ 
;
ÓÓ 
if
 
(
 
networkResult
 !
.
! "
IsOk
" &
&&
' )
Volatile
* 2
.
2 3
Read
3 7
(
7 8
ref
8 ;
_outageState
< H
)
H I
==
J L
$num
M N
)
N O
{
ÒÒ 

ExitOutage
ÚÚ 
(
ÚÚ 
)
ÚÚ  
;
ÚÚ  !
}
ÛÛ 
return
ıı 
networkResult
ıı $
;
ıı$ %
}
ˆˆ 
catch
˜˜ 
(
˜˜ (
OperationCanceledException
˜˜ -
)
˜˜- .
when
˜˜/ 3
(
˜˜4 5
cancellationToken
˜˜5 F
.
˜˜F G%
IsCancellationRequested
˜˜G ^
)
˜˜^ _
{
¯¯ 
return
˘˘ 
Result
˘˘ 
<
˘˘ 
Unit
˘˘ "
,
˘˘" #
NetworkFailure
˘˘$ 2
>
˘˘2 3
.
˘˘3 4
Err
˘˘4 7
(
˘˘7 8
NetworkFailure
˙˙ "
.
˙˙" # 
OperationCancelled
˙˙# 5
(
˙˙5 6
$str
˙˙6 S
)
˙˙S T
)
˙˙T U
;
˙˙U V
}
˚˚ 
catch
¸¸ 
(
¸¸ (
OperationCanceledException
¸¸ -
)
¸¸- .
when
¸¸/ 3
(
¸¸4 5
flowType
¸¸5 =
==
¸¸> @
ServiceFlowType
¸¸A P
.
¸¸P Q
ReceiveStream
¸¸Q ^
)
¸¸^ _
{
˝˝ 
return
˛˛ 
Result
˛˛ 
<
˛˛ 
Unit
˛˛ "
,
˛˛" #
NetworkFailure
˛˛$ 2
>
˛˛2 3
.
˛˛3 4
Ok
˛˛4 6
(
˛˛6 7
Unit
˛˛7 ;
.
˛˛; <
Value
˛˛< A
)
˛˛A B
;
˛˛B C
}
ˇˇ 
catch
ÄÄ 
(
ÄÄ (
OperationCanceledException
ÄÄ -
)
ÄÄ- .
{
ÅÅ 
return
ÇÇ 
Result
ÇÇ 
<
ÇÇ 
Unit
ÇÇ "
,
ÇÇ" #
NetworkFailure
ÇÇ$ 2
>
ÇÇ2 3
.
ÇÇ3 4
Err
ÇÇ4 7
(
ÇÇ7 8
NetworkFailure
ÉÉ "
.
ÉÉ" #%
DataCenterNotResponding
ÉÉ# :
(
ÉÉ: ;
$str
ÑÑ X
)
ÑÑX Y
)
ÑÑY Z
;
ÑÑZ [
}
ÖÖ 
catch
ÜÜ 
(
ÜÜ 
	Exception
ÜÜ 
ex
ÜÜ 
)
ÜÜ  
{
áá 
return
ää 
Result
ää 
<
ää 
Unit
ää "
,
ää" #
NetworkFailure
ää$ 2
>
ää2 3
.
ää3 4
Err
ää4 7
(
ää7 8
NetworkFailure
ää8 F
.
ääF G%
DataCenterNotResponding
ääG ^
(
ää^ _
ex
ää_ a
.
ääa b
Message
ääb i
)
ääi j
)
ääj k
;
ääk l
}
ãã 
}
åå 	
finally
çç 
{
éé 	
tokenRegistration
èè 
.
èè 
Dispose
èè %
(
èè% &
)
èè& '
;
èè' (
if
ëë 
(
ëë 
!
ëë #
shouldAllowDuplicates
ëë &
&&
ëë' )
_pendingRequests
íí  
.
íí  !
	TryRemove
íí! *
(
íí* +

requestKey
íí+ 5
,
íí5 6
out
íí7 :%
CancellationTokenSource
íí; R
?
ííR S!
pendingCancellation
ííT g
)
ííg h
)
ííh i
{
ìì !
pendingCancellation
îî #
.
îî# $
Dispose
îî$ +
(
îî+ ,
)
îî, -
;
îî- . 
disposedRequestCts
ïï "
=
ïï# $
true
ïï% )
;
ïï) *
}
ññ +
linkedCancellationTokenSource
òò )
.
òò) *
Dispose
òò* 1
(
òò1 2
)
òò2 3
;
òò3 4
if
öö 
(
öö 
!
öö  
disposedRequestCts
öö #
)
öö# $
{
õõ %
cancellationTokenSource
úú '
.
úú' (
Dispose
úú( /
(
úú/ 0
)
úú0 1
;
úú1 2
}
ùù 
}
ûû 	
}
üü 
private
°° 
async
°° 
Task
°° /
!RetryPendingRequestsAfterRecovery
°° 8
(
°°8 9
)
°°9 :
{
¢¢ 
bool
££ 
acquired
££ 
=
££ 
false
££ 
;
££ 
try
§§ 
{
•• 	
await
¶¶ '
_retryPendingRequestsGate
¶¶ +
.
¶¶+ ,
	WaitAsync
¶¶, 5
(
¶¶5 6(
_shutdownCancellationToken
¶¶6 P
.
¶¶P Q
Token
¶¶Q V
)
¶¶V W
.
¶¶W X
ConfigureAwait
¶¶X f
(
¶¶f g
false
¶¶g l
)
¶¶l m
;
¶¶m n
acquired
ßß 
=
ßß 
true
ßß 
;
ßß 
await
®® #
pendingRequestManager
®® '
.
®®' (*
RetryAllPendingRequestsAsync
®®( D
(
®®D E
)
®®E F
.
®®F G
ConfigureAwait
®®G U
(
®®U V
false
®®V [
)
®®[ \
;
®®\ ]
}
©© 	
catch
™™ 
(
™™ (
OperationCanceledException
™™ )
)
™™) *
when
™™+ /
(
™™0 1(
_shutdownCancellationToken
™™1 K
.
™™K L%
IsCancellationRequested
™™L c
)
™™c d
{
´´ 	
}
¨¨ 	
finally
≠≠ 
{
ÆÆ 	
if
ØØ 
(
ØØ 
acquired
ØØ 
)
ØØ 
{
∞∞ '
_retryPendingRequestsGate
±± )
.
±±) *
Release
±±* 1
(
±±1 2
)
±±2 3
;
±±3 4
}
≤≤ 
}
≥≥ 	
}
¥¥ 
public
∂∂ 

enum
∂∂ 
RestoreRetryMode
∂∂  
{
∑∑ 
	AutoRetry
∏∏ 
,
∏∏ 
ManualRetry
ππ 
,
ππ 
DirectNoRetry
∫∫ 
}
ªª 
public
ΩΩ 

async
ΩΩ 
Task
ΩΩ 
<
ΩΩ 
Result
ΩΩ 
<
ΩΩ 
bool
ΩΩ !
,
ΩΩ! "
NetworkFailure
ΩΩ# 1
>
ΩΩ1 2
>
ΩΩ2 3(
RestoreSecrecyChannelAsync
ΩΩ4 N
(
ΩΩN O"
EcliptixSessionState
ææ )
ecliptixSecrecyChannelState
ææ 8
,
ææ8 9)
ApplicationInstanceSettings
øø #)
applicationInstanceSettings
øø$ ?
,
øø? @
RestoreRetryMode
¿¿ 
	retryMode
¿¿ "
=
¿¿# $
RestoreRetryMode
¿¿% 5
.
¿¿5 6
	AutoRetry
¿¿6 ?
,
¿¿? @
bool
¡¡ '
enablePendingRegistration
¡¡ &
=
¡¡' (
true
¡¡) -
,
¡¡- .
CancellationToken
¬¬ 
cancellationToken
¬¬ +
=
¬¬, -
default
¬¬. 5
)
¬¬5 6
{
√√ 
if
ƒƒ 

(
ƒƒ 
!
ƒƒ *
_applicationInstanceSettings
ƒƒ )
.
ƒƒ) *
IsSome
ƒƒ* 0
)
ƒƒ0 1
{
≈≈ 	*
_applicationInstanceSettings
∆∆ (
=
∆∆) *
Option
∆∆+ 1
<
∆∆1 2)
ApplicationInstanceSettings
∆∆2 M
>
∆∆M N
.
∆∆N O
Some
∆∆O S
(
∆∆S T)
applicationInstanceSettings
∆∆T o
)
∆∆o p
;
∆∆p q
}
«« 	
string
…… 
?
…… 
culture
…… 
=
…… 
string
……  
.
……  !
IsNullOrEmpty
……! .
(
……. /)
applicationInstanceSettings
……/ J
.
……J K
Culture
……K R
)
……R S
?
   )
AppCultureSettingsConstants
   )
.
  ) *"
DEFAULT_CULTURE_CODE
  * >
:
ÀÀ )
applicationInstanceSettings
ÀÀ )
.
ÀÀ) *
Culture
ÀÀ* 1
;
ÀÀ1 2!
rpcMetaDataProvider
ÕÕ 
.
ÕÕ 

SetAppInfo
ÕÕ &
(
ÕÕ& '
Helpers
ŒŒ 
.
ŒŒ "
FromByteStringToGuid
ŒŒ (
(
ŒŒ( ))
applicationInstanceSettings
ŒŒ) D
.
ŒŒD E
AppInstanceId
ŒŒE R
)
ŒŒR S
,
ŒŒS T
Helpers
œœ 
.
œœ "
FromByteStringToGuid
œœ (
(
œœ( ))
applicationInstanceSettings
œœ) D
.
œœD E
DeviceId
œœE M
)
œœM N
,
œœN O
culture
–– 
)
–– 
;
–– #
RestoreChannelRequest
““ 
request
““ %
=
““& '
new
““( +
(
““+ ,
)
““, -
;
““- .
Result
‘‘ 
<
‘‘ $
RestoreChannelResponse
‘‘ %
,
‘‘% &
NetworkFailure
‘‘' 5
>
‘‘5 64
&restoreAppDeviceSecrecyChannelResponse
‘‘7 ]
;
‘‘] ^
switch
÷÷ 
(
÷÷ 
	retryMode
÷÷ 
)
÷÷ 
{
◊◊ 	
case
ÿÿ 
RestoreRetryMode
ÿÿ !
.
ÿÿ! "
	AutoRetry
ÿÿ" +
:
ÿÿ+ ,
{
ŸŸ 2
$BeginSecrecyChannelEstablishRecovery
⁄⁄ 8
(
⁄⁄8 9
)
⁄⁄9 :
;
⁄⁄: ;
CancellationToken
€€ %
recoveryToken
€€& 3
=
€€4 5(
GetConnectionRecoveryToken
€€6 P
(
€€P Q
)
€€Q R
;
€€R S
using
‹‹ %
CancellationTokenSource
‹‹ 1-
combinedCancellationTokenSource
‹‹2 Q
=
‹‹R S
cancellationToken
›› )
.
››) *
CanBeCanceled
››* 7
?
ﬁﬁ %
CancellationTokenSource
ﬁﬁ 5
.
ﬁﬁ5 6%
CreateLinkedTokenSource
ﬁﬁ6 M
(
ﬁﬁM N
recoveryToken
ﬁﬁN [
,
ﬁﬁ[ \
cancellationToken
ﬁﬁ] n
)
ﬁﬁn o
:
ﬂﬂ %
CancellationTokenSource
ﬂﬂ 5
.
ﬂﬂ5 6%
CreateLinkedTokenSource
ﬂﬂ6 M
(
ﬂﬂM N
recoveryToken
ﬂﬂN [
)
ﬂﬂ[ \
;
ﬂﬂ\ ]4
&restoreAppDeviceSecrecyChannelResponse
·· :
=
··; <
await
··= B
retryStrategy
··C P
.
··P Q&
ExecuteRpcOperationAsync
··Q i
(
··i j
(
‚‚ 
_
‚‚ 
,
‚‚ 
ct
‚‚ 
)
‚‚ 
=>
‚‚  "
rpcServiceManager
‚‚# 4
.
‚‚4 5(
RestoreSecrecyChannelAsync
‚‚5 O
(
‚‚O P!
connectivityService
‚‚P c
,
‚‚c d
request
„„ #
,
„„# $
cancellationToken
‰‰ -
:
‰‰- .
ct
‰‰/ 1
)
‰‰1 2
,
‰‰2 3
$str
ÂÂ /
,
ÂÂ/ 0)
ecliptixSecrecyChannelState
ÊÊ 3
.
ÊÊ3 4
	ConnectId
ÊÊ4 =
,
ÊÊ= >
serviceType
ÁÁ #
:
ÁÁ# $
RpcServiceType
ÁÁ% 3
.
ÁÁ3 4#
RestoreSecrecyChannel
ÁÁ4 I
,
ÁÁI J
cancellationToken
ËË )
:
ËË) *-
combinedCancellationTokenSource
ËË+ J
.
ËËJ K
Token
ËËK P
)
ËËP Q
.
ËËQ R
ConfigureAwait
ËËR `
(
ËË` a
false
ËËa f
)
ËËf g
;
ËËg h
break
ÈÈ 
;
ÈÈ 
}
ÍÍ 
case
ÎÎ 
RestoreRetryMode
ÎÎ !
.
ÎÎ! "
ManualRetry
ÎÎ" -
:
ÎÎ- .
{
ÏÏ 2
$BeginSecrecyChannelEstablishRecovery
ÌÌ 8
(
ÌÌ8 9
)
ÌÌ9 :
;
ÌÌ: ;
CancellationToken
ÓÓ %
recoveryToken
ÓÓ& 3
=
ÓÓ4 5(
GetConnectionRecoveryToken
ÓÓ6 P
(
ÓÓP Q
)
ÓÓQ R
;
ÓÓR S
using
ÔÔ %
CancellationTokenSource
ÔÔ 1
combinedCts
ÔÔ2 =
=
ÔÔ> ?
cancellationToken
 )
.
) *
CanBeCanceled
* 7
?
ÒÒ %
CancellationTokenSource
ÒÒ 5
.
ÒÒ5 6%
CreateLinkedTokenSource
ÒÒ6 M
(
ÒÒM N
recoveryToken
ÒÒN [
,
ÒÒ[ \
cancellationToken
ÒÒ] n
)
ÒÒn o
:
ÚÚ %
CancellationTokenSource
ÚÚ 5
.
ÚÚ5 6%
CreateLinkedTokenSource
ÚÚ6 M
(
ÚÚM N
recoveryToken
ÚÚN [
)
ÚÚ[ \
;
ÚÚ\ ]4
&restoreAppDeviceSecrecyChannelResponse
ÙÙ :
=
ÙÙ; <
await
ÙÙ= B
retryStrategy
ÙÙC P
.
ÙÙP Q1
#ExecuteManualRetryRpcOperationAsync
ÙÙQ t
(
ÙÙt u
(
ıı 
_
ıı 
,
ıı 
ct
ıı 
)
ıı 
=>
ıı  "
rpcServiceManager
ıı# 4
.
ıı4 5(
RestoreSecrecyChannelAsync
ıı5 O
(
ııO P!
connectivityService
ııP c
,
ııc d
request
ˆˆ #
,
ˆˆ# $
cancellationToken
˜˜ -
:
˜˜- .
ct
˜˜/ 1
)
˜˜1 2
,
˜˜2 3
$str
¯¯ /
,
¯¯/ 0)
ecliptixSecrecyChannelState
˘˘ 3
.
˘˘3 4
	ConnectId
˘˘4 =
,
˘˘= >
cancellationToken
˙˙ )
:
˙˙) *
combinedCts
˙˙+ 6
.
˙˙6 7
Token
˙˙7 <
)
˙˙< =
.
˙˙= >
ConfigureAwait
˙˙> L
(
˙˙L M
false
˙˙M R
)
˙˙R S
;
˙˙S T
break
˚˚ 
;
˚˚ 
}
¸¸ 
case
˝˝ 
RestoreRetryMode
˝˝ !
.
˝˝! "
DirectNoRetry
˝˝" /
:
˝˝/ 0
try
˛˛ 
{
ˇˇ 4
&restoreAppDeviceSecrecyChannelResponse
ÄÄ :
=
ÄÄ; <
await
ÅÅ 
rpcServiceManager
ÅÅ /
.
ÅÅ/ 0(
RestoreSecrecyChannelAsync
ÅÅ0 J
(
ÅÅJ K!
connectivityService
ÅÅK ^
,
ÅÅ^ _
request
ÇÇ #
,
ÇÇ# $
cancellationToken
ÉÉ -
:
ÉÉ- .
cancellationToken
ÉÉ/ @
)
ÉÉ@ A
.
ÉÉA B
ConfigureAwait
ÉÉB P
(
ÉÉP Q
false
ÉÉQ V
)
ÉÉV W
;
ÉÉW X
}
ÑÑ 
catch
ÖÖ 
(
ÖÖ 
	Exception
ÖÖ  
ex
ÖÖ! #
)
ÖÖ# $
{
ÜÜ 
return
áá 
Result
áá !
<
áá! "
bool
áá" &
,
áá& '
NetworkFailure
áá( 6
>
áá6 7
.
áá7 8
Err
áá8 ;
(
áá; <
NetworkFailure
áá< J
.
ááJ K%
DataCenterNotResponding
ááK b
(
ááb c
ex
áác e
.
ááe f
Message
ááf m
)
áám n
)
áán o
;
ááo p
}
àà 
break
ää 
;
ää 
default
ãã 
:
ãã 
return
åå 
Result
åå 
<
åå 
bool
åå "
,
åå" #
NetworkFailure
åå$ 2
>
åå2 3
.
åå3 4
Err
åå4 7
(
åå7 8
NetworkFailure
çç "
.
çç" # 
InvalidRequestType
çç# 5
(
çç5 6
$"
çç6 8
$str
çç8 L
{
ççL M
	retryMode
ççM V
}
ççV W
"
ççW X
)
ççX Y
)
ççY Z
;
ççZ [
}
éé 	
if
êê 

(
êê 4
&restoreAppDeviceSecrecyChannelResponse
êê 2
.
êê2 3
IsErr
êê3 8
)
êê8 9
{
ëë 	
NetworkFailure
íí 
failure
íí "
=
íí# $4
&restoreAppDeviceSecrecyChannelResponse
íí% K
.
ííK L
	UnwrapErr
ííL U
(
ííU V
)
ííV W
;
ííW X
if
îî 
(
îî '
enablePendingRegistration
îî )
&&
îî* ,,
ShouldQueueSecrecyChannelRetry
îî- K
(
îîK L
failure
îîL S
)
îîS T
)
îîT U
{
ïï -
QueueSecrecyChannelRestoreRetry
ññ /
(
ññ/ 0)
ecliptixSecrecyChannelState
ññ0 K
,
ññK L)
applicationInstanceSettings
ññM h
,
ññh i
	retryMode
ññj s
)
ññs t
;
ññt u
}
óó 
return
ôô 
Result
ôô 
<
ôô 
bool
ôô 
,
ôô 
NetworkFailure
ôô  .
>
ôô. /
.
ôô/ 0
Err
ôô0 3
(
ôô3 4
failure
ôô4 ;
)
ôô; <
;
ôô< =
}
öö 	$
RestoreChannelResponse
úú 
response
úú '
=
úú( )4
&restoreAppDeviceSecrecyChannelResponse
úú* P
.
úúP Q
Unwrap
úúQ W
(
úúW X
)
úúX Y
;
úúY Z
switch
ûû 
(
ûû 
response
ûû 
.
ûû 
Status
ûû 
)
ûû  
{
üü 	
case
†† $
RestoreChannelResponse
†† '
.
††' (
Types
††( -
.
††- .
Status
††. 4
.
††4 5
SessionRestored
††5 D
:
††D E
{
°° 
Result
¢¢ 
<
¢¢ 
Unit
¢¢ 
,
¢¢  %
EcliptixProtocolFailure
¢¢! 8
>
¢¢8 9

syncResult
££ "
=
££# $ 
SyncSecrecyChannel
££% 7
(
££7 8)
ecliptixSecrecyChannelState
££8 S
,
££S T
response
££U ]
)
££] ^
;
££^ _
if
•• 
(
•• 

syncResult
•• "
.
••" #
IsErr
••# (
)
••( )
{
¶¶ %
EcliptixProtocolFailure
ßß /
error
ßß0 5
=
ßß6 7

syncResult
ßß8 B
.
ßßB C
	UnwrapErr
ßßC L
(
ßßL M
)
ßßM N
;
ßßN O
return
®® 
error
®® $
.
®®$ %
Message
®®% ,
.
®®, -
Contains
®®- 5
(
®®5 6
$str
®®6 Q
)
®®Q R
?
©© 
Result
©© $
<
©©$ %
bool
©©% )
,
©©) *
NetworkFailure
©©+ 9
>
©©9 :
.
©©: ;
Ok
©©; =
(
©©= >
false
©©> C
)
©©C D
:
™™ 
Result
™™ $
<
™™$ %
bool
™™% )
,
™™) *
NetworkFailure
™™+ 9
>
™™9 :
.
™™: ;
Err
™™; >
(
™™> ?
error
™™? D
.
™™D E
ToNetworkFailure
™™E U
(
™™U V
)
™™V W
)
™™W X
;
™™X Y
}
´´ 
if
≠≠ 
(
≠≠ '
enablePendingRegistration
≠≠ 1
)
≠≠1 2
{
ÆÆ #
pendingRequestManager
ØØ -
.
ØØ- ."
RemovePendingRequest
ØØ. B
(
ØØB C+
BuildSecrecyChannelRestoreKey
∞∞ 9
(
∞∞9 :)
ecliptixSecrecyChannelState
∞∞: U
.
∞∞U V
	ConnectId
∞∞V _
)
∞∞_ `
)
∞∞` a
;
∞∞a b
}
±± 

ExitOutage
≥≥ 
(
≥≥ 
)
≥≥  
;
≥≥  !
return
µµ 
Result
µµ !
<
µµ! "
bool
µµ" &
,
µµ& '
NetworkFailure
µµ( 6
>
µµ6 7
.
µµ7 8
Ok
µµ8 :
(
µµ: ;
true
µµ; ?
)
µµ? @
;
µµ@ A
}
∂∂ 
case
∑∑ $
RestoreChannelResponse
∑∑ '
.
∑∑' (
Types
∑∑( -
.
∑∑- .
Status
∑∑. 4
.
∑∑4 5
SessionNotFound
∑∑5 D
:
∑∑D E
{
∏∏ 
Result
ππ 
<
ππ "
EcliptixSessionState
ππ /
,
ππ/ 0
NetworkFailure
ππ1 ?
>
ππ? @
establishResult
ππA P
=
ππQ R
await
∫∫ *
EstablishSecrecyChannelAsync
∫∫ :
(
∫∫: ;)
ecliptixSecrecyChannelState
∫∫; V
.
∫∫V W
	ConnectId
∫∫W `
)
∫∫` a
;
∫∫a b
if
ªª 
(
ªª 
establishResult
ªª '
.
ªª' (
IsErr
ªª( -
)
ªª- .
{
ºº 
Log
ΩΩ 
.
ΩΩ 
Warning
ΩΩ #
(
ΩΩ# $
$str
ΩΩ$ }
,
ΩΩ} ~
establishResult
ææ +
.
ææ+ ,
	UnwrapErr
ææ, 5
(
ææ5 6
)
ææ6 7
.
ææ7 8
Message
ææ8 ?
)
ææ? @
;
ææ@ A
}
øø 
break
¿¿ 
;
¿¿ 
}
¡¡ 
default
¬¬ 
:
¬¬ 
throw
√√ 
new
√√ )
ArgumentOutOfRangeException
√√ 5
(
√√5 6
)
√√6 7
;
√√7 8
}
ƒƒ 	
return
∆∆ 
Result
∆∆ 
<
∆∆ 
bool
∆∆ 
,
∆∆ 
NetworkFailure
∆∆ *
>
∆∆* +
.
∆∆+ ,
Ok
∆∆, .
(
∆∆. /
false
∆∆/ 4
)
∆∆4 5
;
∆∆5 6
}
«« 
public
…… 

async
…… 
Task
…… 
<
…… 
Result
…… 
<
…… "
EcliptixSessionState
…… 1
,
……1 2
NetworkFailure
……3 A
>
……A B
>
……B C*
EstablishSecrecyChannelAsync
……D `
(
……` a
uint
   
	connectId
   
)
   
{
ÀÀ 
Result
ÃÃ 
<
ÃÃ 
Option
ÃÃ 
<
ÃÃ "
EcliptixSessionState
ÃÃ *
>
ÃÃ* +
,
ÃÃ+ ,
NetworkFailure
ÃÃ- ;
>
ÃÃ; <
result
ÃÃ= C
=
ÃÃD E
await
ÕÕ 2
$EstablishSecrecyChannelInternalAsync
ÕÕ 6
(
ÕÕ6 7
	connectId
ŒŒ 
,
ŒŒ  
PubKeyExchangeType
œœ "
.
œœ" #(
DataCenterEphemeralConnect
œœ# =
,
œœ= >
	saveState
–– 
:
–– 
true
–– 
)
––  
.
––  !
ConfigureAwait
––! /
(
––/ 0
false
––0 5
)
––5 6
;
––6 7
if
““ 

(
““ 
result
““ 
.
““ 
IsErr
““ 
)
““ 
{
”” 	
return
‘‘ 
Result
‘‘ 
<
‘‘ "
EcliptixSessionState
‘‘ .
,
‘‘. /
NetworkFailure
‘‘0 >
>
‘‘> ?
.
‘‘? @
Err
‘‘@ C
(
‘‘C D
result
‘‘D J
.
‘‘J K
	UnwrapErr
‘‘K T
(
‘‘T U
)
‘‘U V
)
‘‘V W
;
‘‘W X
}
’’ 	
Option
◊◊ 
<
◊◊ "
EcliptixSessionState
◊◊ #
>
◊◊# $
stateOption
◊◊% 0
=
◊◊1 2
result
◊◊3 9
.
◊◊9 :
Unwrap
◊◊: @
(
◊◊@ A
)
◊◊A B
;
◊◊B C
if
ÿÿ 

(
ÿÿ 
!
ÿÿ 
stateOption
ÿÿ 
.
ÿÿ 
IsSome
ÿÿ 
)
ÿÿ  
{
ŸŸ 	
return
⁄⁄ 
Result
⁄⁄ 
<
⁄⁄ "
EcliptixSessionState
⁄⁄ .
,
⁄⁄. /
NetworkFailure
⁄⁄0 >
>
⁄⁄> ?
.
⁄⁄? @
Err
⁄⁄@ C
(
⁄⁄C D
NetworkFailure
€€ 
.
€€ %
DataCenterNotResponding
€€ 6
(
€€6 7
$str
€€7 W
)
€€W X
)
€€X Y
;
€€Y Z
}
‹‹ 	
return
ﬁﬁ 
Result
ﬁﬁ 
<
ﬁﬁ "
EcliptixSessionState
ﬁﬁ *
,
ﬁﬁ* +
NetworkFailure
ﬁﬁ, :
>
ﬁﬁ: ;
.
ﬁﬁ; <
Ok
ﬁﬁ< >
(
ﬁﬁ> ?
stateOption
ﬁﬁ? J
.
ﬁﬁJ K
Value
ﬁﬁK P
!
ﬁﬁP Q
)
ﬁﬁQ R
;
ﬁﬁR S
}
ﬂﬂ 
public
·· 

async
·· 
Task
·· 
<
·· 
Result
·· 
<
·· 
uint
·· !
,
··! "
NetworkFailure
··# 1
>
··1 2
>
··2 3(
EnsureProtocolForTypeAsync
··4 N
(
··N O 
PubKeyExchangeType
‚‚ 
EXCHANGE_TYPE
‚‚ (
)
‚‚( )
{
„„ 
if
‰‰ 

(
‰‰ 
!
‰‰ *
_applicationInstanceSettings
‰‰ )
.
‰‰) *
IsSome
‰‰* 0
)
‰‰0 1
{
ÂÂ 	
return
ÊÊ 
Result
ÊÊ 
<
ÊÊ 
uint
ÊÊ 
,
ÊÊ 
NetworkFailure
ÊÊ  .
>
ÊÊ. /
.
ÊÊ/ 0
Err
ÊÊ0 3
(
ÊÊ3 4
NetworkFailure
ÁÁ 
.
ÁÁ  
InvalidRequestType
ÁÁ 1
(
ÁÁ1 2
$str
ÁÁ2 O
)
ÁÁO P
)
ÁÁP Q
;
ÁÁQ R
}
ËË 	)
ApplicationInstanceSettings
ÍÍ #
appSettings
ÍÍ$ /
=
ÍÍ0 1*
_applicationInstanceSettings
ÍÍ2 N
.
ÍÍN O
Value
ÍÍO T
!
ÍÍT U
;
ÍÍU V
uint
ÎÎ 
	connectId
ÎÎ 
=
ÎÎ $
ComputeUniqueConnectId
ÎÎ /
(
ÎÎ/ 0
appSettings
ÎÎ0 ;
,
ÎÎ; <
EXCHANGE_TYPE
ÎÎ= J
)
ÎÎJ K
;
ÎÎK L
if
ÌÌ 

(
ÌÌ 
_connections
ÌÌ 
.
ÌÌ 
	TryRemove
ÌÌ "
(
ÌÌ" #
	connectId
ÌÌ# ,
,
ÌÌ, -
out
ÌÌ. 1$
EcliptixProtocolSystem
ÌÌ2 H
?
ÌÌH I 
existingConnection
ÌÌJ \
)
ÌÌ\ ]
)
ÌÌ] ^
{
ÓÓ 	 
existingConnection
ÔÔ 
.
ÔÔ 
Dispose
ÔÔ &
(
ÔÔ& '
)
ÔÔ' (
;
ÔÔ( )
}
 	3
%InitiateEcliptixProtocolSystemForType
ÚÚ -
(
ÚÚ- .
	connectId
ÚÚ. 7
)
ÚÚ7 8
;
ÚÚ8 9
Result
ÙÙ 
<
ÙÙ 
Option
ÙÙ 
<
ÙÙ "
EcliptixSessionState
ÙÙ *
>
ÙÙ* +
,
ÙÙ+ ,
NetworkFailure
ÙÙ- ;
>
ÙÙ; <#
establishOptionResult
ÙÙ= R
=
ÙÙS T
await
ıı 1
#EstablishSecrecyChannelForTypeAsync
ıı 5
(
ıı5 6
	connectId
ıı6 ?
,
ıı? @
EXCHANGE_TYPE
ııA N
)
ııN O
.
ııO P
ConfigureAwait
ııP ^
(
ıı^ _
false
ıı_ d
)
ııd e
;
ııe f
if
˜˜ 

(
˜˜ 
!
˜˜ #
establishOptionResult
˜˜ "
.
˜˜" #
IsErr
˜˜# (
)
˜˜( )
{
¯¯ 	
return
˘˘ 
Result
˘˘ 
<
˘˘ 
uint
˘˘ 
,
˘˘ 
NetworkFailure
˘˘  .
>
˘˘. /
.
˘˘/ 0
Ok
˘˘0 2
(
˘˘2 3
	connectId
˘˘3 <
)
˘˘< =
;
˘˘= >
}
˙˙ 	
_connections
¸¸ 
.
¸¸ 
	TryRemove
¸¸ 
(
¸¸ 
	connectId
¸¸ (
,
¸¸( )
out
¸¸* -
_
¸¸. /
)
¸¸/ 0
;
¸¸0 1
return
˝˝ 
Result
˝˝ 
<
˝˝ 
uint
˝˝ 
,
˝˝ 
NetworkFailure
˝˝ *
>
˝˝* +
.
˝˝+ ,
Err
˝˝, /
(
˝˝/ 0#
establishOptionResult
˝˝0 E
.
˝˝E F
	UnwrapErr
˝˝F O
(
˝˝O P
)
˝˝P Q
)
˝˝Q R
;
˝˝R S
}
˛˛ 
private
ÄÄ 
void
ÄÄ +
CancelOperationsForConnection
ÄÄ .
(
ÄÄ. /
uint
ÄÄ/ 3
	connectId
ÄÄ4 =
)
ÄÄ= >
{
ÅÅ 
string
ÇÇ 
connectIdPrefix
ÇÇ 
=
ÇÇ  
$"
ÇÇ! #
{
ÇÇ# $
	connectId
ÇÇ$ -
}
ÇÇ- .
$str
ÇÇ. /
"
ÇÇ/ 0
;
ÇÇ0 1
foreach
ÑÑ 
(
ÑÑ 
KeyValuePair
ÑÑ 
<
ÑÑ 
string
ÑÑ $
,
ÑÑ$ %%
CancellationTokenSource
ÑÑ& =
>
ÑÑ= >
kvp
ÑÑ? B
in
ÑÑC E
_pendingRequests
ÑÑF V
)
ÑÑV W
{
ÖÖ 	
if
ÜÜ 
(
ÜÜ 
!
ÜÜ 
kvp
ÜÜ 
.
ÜÜ 
Key
ÜÜ 
.
ÜÜ 

StartsWith
ÜÜ #
(
ÜÜ# $
connectIdPrefix
ÜÜ$ 3
)
ÜÜ3 4
)
ÜÜ4 5
{
áá 
continue
àà 
;
àà 
}
ââ 
if
ãã 
(
ãã 
!
ãã 
_pendingRequests
ãã !
.
ãã! "
	TryRemove
ãã" +
(
ãã+ ,
kvp
ãã, /
.
ãã/ 0
Key
ãã0 3
,
ãã3 4
out
ãã5 8%
CancellationTokenSource
ãã9 P
?
ããP Q
operationCts
ããR ^
)
ãã^ _
)
ãã_ `
{
åå 
continue
çç 
;
çç 
}
éé 
try
êê 
{
ëë 
operationCts
íí 
.
íí 
Cancel
íí #
(
íí# $
)
íí$ %
;
íí% &
operationCts
ìì 
.
ìì 
Dispose
ìì $
(
ìì$ %
)
ìì% &
;
ìì& '
}
îî 
catch
ïï 
(
ïï %
ObjectDisposedException
ïï *
)
ïï* +
{
ññ 
}
òò 
}
ôô 	
}
öö 
public
úú 

async
úú 
Task
úú 
<
úú 
Result
úú 
<
úú 
Unit
úú !
,
úú! "
NetworkFailure
úú# 1
>
úú1 2
>
úú2 3(
CleanupStreamProtocolAsync
úú4 N
(
úúN O
uint
úúO S
	connectId
úúT ]
)
úú] ^
{
ùù +
CancelOperationsForConnection
ûû %
(
ûû% &
	connectId
ûû& /
)
ûû/ 0
;
ûû0 1
if
†† 

(
†† 
_activeStreams
†† 
.
†† 
	TryRemove
†† $
(
††$ %
	connectId
††% .
,
††. /
out
††0 3%
CancellationTokenSource
††4 K
?
††K L%
cancellationTokenSource
††M d
)
††d e
)
††e f
{
°° 	
await
¢¢ %
cancellationTokenSource
¢¢ )
.
¢¢) *
CancelAsync
¢¢* 5
(
¢¢5 6
)
¢¢6 7
.
¢¢7 8
ConfigureAwait
¢¢8 F
(
¢¢F G
false
¢¢G L
)
¢¢L M
;
¢¢M N%
cancellationTokenSource
££ #
.
££# $
Dispose
££$ +
(
££+ ,
)
££, -
;
££- .
}
§§ 	
if
¶¶ 

(
¶¶ 
!
¶¶ 
_connections
¶¶ 
.
¶¶ 
	TryRemove
¶¶ #
(
¶¶# $
	connectId
¶¶$ -
,
¶¶- .
out
¶¶/ 2$
EcliptixProtocolSystem
¶¶3 I
?
¶¶I J
protocolSystem
¶¶K Y
)
¶¶Y Z
)
¶¶Z [
{
ßß 	
return
®® 
Result
®® 
<
®® 
Unit
®® 
,
®® 
NetworkFailure
®®  .
>
®®. /
.
®®/ 0
Ok
®®0 2
(
®®2 3
Unit
®®3 7
.
®®7 8
Value
®®8 =
)
®®= >
;
®®> ?
}
©© 	
protocolSystem
´´ 
.
´´ 
Dispose
´´ 
(
´´ 
)
´´  
;
´´  !
return
≠≠ 
Result
≠≠ 
<
≠≠ 
Unit
≠≠ 
,
≠≠ 
NetworkFailure
≠≠ *
>
≠≠* +
.
≠≠+ ,
Ok
≠≠, .
(
≠≠. /
Unit
≠≠/ 3
.
≠≠3 4
Value
≠≠4 9
)
≠≠9 :
;
≠≠: ;
}
ÆÆ 
private
∞∞ 
static
∞∞ 
RatchetConfig
∞∞  -
GetRatchetConfigForExchangeType
∞∞! @
(
∞∞@ A 
PubKeyExchangeType
∞∞A S
EXCHANGE_TYPE
∞∞T a
)
∞∞a b
{
±± 
RatchetConfig
≤≤ 
config
≤≤ 
=
≤≤ 
EXCHANGE_TYPE
≤≤ ,
switch
≤≤- 3
{
≥≥ 	 
PubKeyExchangeType
¥¥ 
.
¥¥ 
ServerStreaming
¥¥ .
=>
¥¥/ 1
new
¥¥2 5
RatchetConfig
¥¥6 C
{
µµ %
DhRatchetEveryNMessages
∂∂ '
=
∂∂( )
$num
∂∂* ,
,
∂∂, -
MaxChainAge
∑∑ 
=
∑∑ 
TimeSpan
∑∑ &
.
∑∑& '
FromMinutes
∑∑' 2
(
∑∑2 3
$num
∑∑3 4
)
∑∑4 5
,
∑∑5 6'
MaxMessagesWithoutRatchet
∏∏ )
=
∏∏* +
$num
∏∏, /
}
ππ 
,
ππ 
_
∫∫ 
=>
∫∫ 
RatchetConfig
∫∫ 
.
∫∫ 
Default
∫∫ &
}
ªª 	
;
ªª	 

return
ΩΩ 
config
ΩΩ 
;
ΩΩ 
}
ææ 
private
¿¿ 
static
¿¿  
PubKeyExchangeType
¿¿ %0
"DetermineExchangeTypeFromConnectId
¿¿& H
(
¿¿H I)
ApplicationInstanceSettings
¡¡ #)
applicationInstanceSettings
¡¡$ ?
,
¡¡? @
uint
¡¡A E
	connectId
¡¡F O
)
¡¡O P
{
¬¬  
PubKeyExchangeType
√√ 
[
√√ 
]
√√ 

knownTypes
√√ '
=
√√( )
[
ƒƒ 	 
PubKeyExchangeType
≈≈ 
.
≈≈ (
DataCenterEphemeralConnect
≈≈ 9
,
≈≈9 : 
PubKeyExchangeType
∆∆ 
.
∆∆ 
ServerStreaming
∆∆ .
]
«« 	
;
««	 

foreach
…… 
(
……  
PubKeyExchangeType
…… #
EXCHANGE_TYPE
……$ 1
in
……2 4

knownTypes
……5 ?
)
……? @
{
   	
uint
ÀÀ 
computedConnectId
ÀÀ "
=
ÀÀ# $$
ComputeUniqueConnectId
ÀÀ% ;
(
ÀÀ; <)
applicationInstanceSettings
ÀÀ< W
,
ÀÀW X
EXCHANGE_TYPE
ÀÀY f
)
ÀÀf g
;
ÀÀg h
if
ÃÃ 
(
ÃÃ 
computedConnectId
ÃÃ !
!=
ÃÃ" $
	connectId
ÃÃ% .
)
ÃÃ. /
{
ÕÕ 
continue
ŒŒ 
;
ŒŒ 
}
œœ 
return
—— 
EXCHANGE_TYPE
——  
;
——  !
}
““ 	
return
‘‘  
PubKeyExchangeType
‘‘ !
.
‘‘! "(
DataCenterEphemeralConnect
‘‘" <
;
‘‘< =
}
’’ 
private
◊◊ 
void
◊◊ 3
%InitiateEcliptixProtocolSystemForType
◊◊ 6
(
◊◊6 7
uint
◊◊7 ;
	connectId
◊◊< E
)
ÿÿ 
{
ŸŸ (
EcliptixSystemIdentityKeys
⁄⁄ "
identityKeys
⁄⁄# /
=
⁄⁄0 1(
EcliptixSystemIdentityKeys
€€ &
.
€€& '
Create
€€' -
(
€€- .
NetworkConstants
€€. >
.
€€> ?
Protocol
€€? G
.
€€G H(
DEFAULT_ONE_TIME_KEY_COUNT
€€H b
)
€€b c
.
€€c d
Unwrap
€€d j
(
€€j k
)
€€k l
;
€€l m$
EcliptixProtocolSystem
›› 
protocolSystem
›› -
=
››. /
new
››0 3
(
››3 4
identityKeys
››4 @
)
››@ A
;
››A B
protocolSystem
ﬁﬁ 
.
ﬁﬁ 
SetEventHandler
ﬁﬁ &
(
ﬁﬁ& '
this
ﬁﬁ' +
)
ﬁﬁ+ ,
;
ﬁﬁ, -
_connections
‡‡ 
.
‡‡ 
TryAdd
‡‡ 
(
‡‡ 
	connectId
‡‡ %
,
‡‡% &
protocolSystem
‡‡' 5
)
‡‡5 6
;
‡‡6 7
}
·· 
private
„„ 
async
„„ 
Task
„„ 
<
„„ 
Result
„„ 
<
„„ 
Option
„„ $
<
„„$ %"
EcliptixSessionState
„„% 9
>
„„9 :
,
„„: ;
NetworkFailure
„„< J
>
„„J K
>
„„K L1
#EstablishSecrecyChannelForTypeAsync
„„M p
(
„„p q
uint
‰‰ 
	connectId
‰‰ 
,
‰‰  
PubKeyExchangeType
ÂÂ 
EXCHANGE_TYPE
ÂÂ (
)
ÂÂ( )
{
ÊÊ 
return
ÁÁ 
await
ÁÁ 2
$EstablishSecrecyChannelInternalAsync
ÁÁ 9
(
ÁÁ9 :
	connectId
ËË 
,
ËË 
EXCHANGE_TYPE
ÈÈ 
,
ÈÈ 

maxRetries
ÍÍ 
:
ÍÍ 
$num
ÍÍ 
,
ÍÍ 
	saveState
ÎÎ 
:
ÎÎ 
EXCHANGE_TYPE
ÎÎ $
==
ÎÎ% ' 
PubKeyExchangeType
ÎÎ( :
.
ÎÎ: ;(
DataCenterEphemeralConnect
ÎÎ; U
)
ÎÎU V
.
ÎÎV W
ConfigureAwait
ÎÎW e
(
ÎÎe f
false
ÎÎf k
)
ÎÎk l
;
ÎÎl m
}
ÏÏ 
private
ÓÓ 
Result
ÓÓ 
<
ÓÓ 
Unit
ÓÓ 
,
ÓÓ %
EcliptixProtocolFailure
ÓÓ 0
>
ÓÓ0 1 
SyncSecrecyChannel
ÓÓ2 D
(
ÓÓD E"
EcliptixSessionState
ÔÔ 
currentState
ÔÔ )
,
ÔÔ) *$
RestoreChannelResponse
 %
peerSecrecyChannelState
 6
)
6 7
{
ÒÒ 
Result
ÚÚ 
<
ÚÚ $
EcliptixProtocolSystem
ÚÚ %
,
ÚÚ% &%
EcliptixProtocolFailure
ÚÚ' >
>
ÚÚ> ?
systemResult
ÚÚ@ L
=
ÚÚM N%
RecreateSystemFromState
ÚÚO f
(
ÚÚf g
currentState
ÚÚg s
)
ÚÚs t
;
ÚÚt u
if
ÛÛ 

(
ÛÛ 
systemResult
ÛÛ 
.
ÛÛ 
IsErr
ÛÛ 
)
ÛÛ 
{
ÙÙ 	
return
ıı 
Result
ıı 
<
ıı 
Unit
ıı 
,
ıı %
EcliptixProtocolFailure
ıı  7
>
ıı7 8
.
ıı8 9
Err
ıı9 <
(
ıı< =
systemResult
ıı= I
.
ııI J
	UnwrapErr
ııJ S
(
ııS T
)
ııT U
)
ııU V
;
ııV W
}
ˆˆ 	$
EcliptixProtocolSystem
¯¯ 
system
¯¯ %
=
¯¯& '
systemResult
¯¯( 4
.
¯¯4 5
Unwrap
¯¯5 ;
(
¯¯; <
)
¯¯< =
;
¯¯= >
system
˙˙ 
.
˙˙ 
SetEventHandler
˙˙ 
(
˙˙ 
this
˙˙ #
)
˙˙# $
;
˙˙$ %(
EcliptixProtocolConnection
¸¸ "
?
¸¸" #

connection
¸¸$ .
=
¸¸/ 0
system
¸¸1 7
.
¸¸7 8
GetConnection
¸¸8 E
(
¸¸E F
)
¸¸F G
;
¸¸G H
if
˝˝ 

(
˝˝ 

connection
˝˝ 
==
˝˝ 
null
˝˝ 
)
˝˝ 
{
˛˛ 	
return
ˇˇ 
Result
ˇˇ 
<
ˇˇ 
Unit
ˇˇ 
,
ˇˇ %
EcliptixProtocolFailure
ˇˇ  7
>
ˇˇ7 8
.
ˇˇ8 9
Err
ˇˇ9 <
(
ˇˇ< =%
EcliptixProtocolFailure
ÄÄ '
.
ÄÄ' (
Generic
ÄÄ( /
(
ÄÄ/ 0
$str
ÄÄ0 L
)
ÄÄL M
)
ÄÄM N
;
ÄÄN O
}
ÅÅ 	
Result
ÉÉ 
<
ÉÉ 
Unit
ÉÉ 
,
ÉÉ %
EcliptixProtocolFailure
ÉÉ ,
>
ÉÉ, -

syncResult
ÉÉ. 8
=
ÉÉ9 :

connection
ÉÉ; E
.
ÉÉE F!
SyncWithRemoteState
ÉÉF Y
(
ÉÉY Z%
peerSecrecyChannelState
ÑÑ #
.
ÑÑ# $ 
SendingChainLength
ÑÑ$ 6
,
ÑÑ6 7%
peerSecrecyChannelState
ÖÖ #
.
ÖÖ# $"
ReceivingChainLength
ÖÖ$ 8
)
ÜÜ 	
;
ÜÜ	 

if
àà 

(
àà 

syncResult
àà 
.
àà 
IsErr
àà 
)
àà 
{
ââ 	
system
ää 
.
ää 
Dispose
ää 
(
ää 
)
ää 
;
ää 
return
ãã 
Result
ãã 
<
ãã 
Unit
ãã 
,
ãã %
EcliptixProtocolFailure
ãã  7
>
ãã7 8
.
ãã8 9
Err
ãã9 <
(
ãã< =

syncResult
ãã= G
.
ããG H
	UnwrapErr
ããH Q
(
ããQ R
)
ããR S
)
ããS T
;
ããT U
}
åå 	
_
éé 	
=
éé
 

connection
éé 
.
éé 
ToProtoState
éé #
(
éé# $
)
éé$ %
;
éé% &
_connections
êê 
.
êê 
TryAdd
êê 
(
êê 
currentState
êê (
.
êê( )
	ConnectId
êê) 2
,
êê2 3
system
êê4 :
)
êê: ;
;
êê; <
return
ëë 
Result
ëë 
<
ëë 
Unit
ëë 
,
ëë %
EcliptixProtocolFailure
ëë 3
>
ëë3 4
.
ëë4 5
Ok
ëë5 7
(
ëë7 8
Unit
ëë8 <
.
ëë< =
Value
ëë= B
)
ëëB C
;
ëëC D
}
íí 
private
îî 
Result
îî 
<
îî $
EcliptixProtocolSystem
îî )
,
îî) *%
EcliptixProtocolFailure
îî+ B
>
îîB C%
RecreateSystemFromState
îîD [
(
îî[ \"
EcliptixSessionState
ïï 
state
ïï "
)
ïï" #
{
ññ 
Result
óó 
<
óó (
EcliptixSystemIdentityKeys
óó )
,
óó) *%
EcliptixProtocolFailure
óó+ B
>
óóB C
idKeysResult
óóD P
=
óóQ R(
EcliptixSystemIdentityKeys
òò &
.
òò& '
FromProtoState
òò' 5
(
òò5 6
state
òò6 ;
.
òò; <
IdentityKeys
òò< H
)
òòH I
;
òòI J
if
ôô 

(
ôô 
idKeysResult
ôô 
.
ôô 
IsErr
ôô 
)
ôô 
{
öö 	
return
õõ 
Result
õõ 
<
õõ $
EcliptixProtocolSystem
õõ 0
,
õõ0 1%
EcliptixProtocolFailure
õõ2 I
>
õõI J
.
õõJ K
Err
õõK N
(
õõN O
idKeysResult
õõO [
.
õõ[ \
	UnwrapErr
õõ\ e
(
õõe f
)
õõf g
)
õõg h
;
õõh i
}
úú 	 
PubKeyExchangeType
ûû 
EXCHANGE_TYPE
ûû (
=
ûû) **
_applicationInstanceSettings
ûû+ G
.
ûûG H
IsSome
ûûH N
?
üü 0
"DetermineExchangeTypeFromConnectId
üü 0
(
üü0 1*
_applicationInstanceSettings
üü1 M
.
üüM N
Value
üüN S
!
üüS T
,
üüT U
state
üüV [
.
üü[ \
	ConnectId
üü\ e
)
üüe f
:
††  
PubKeyExchangeType
††  
.
††  !(
DataCenterEphemeralConnect
††! ;
;
††; <
RatchetConfig
¢¢ 
config
¢¢ 
=
¢¢ -
GetRatchetConfigForExchangeType
¢¢ >
(
¢¢> ?
EXCHANGE_TYPE
¢¢? L
)
¢¢L M
;
¢¢M N
Result
§§ 
<
§§ (
EcliptixProtocolConnection
§§ )
,
§§) *%
EcliptixProtocolFailure
§§+ B
>
§§B C

connResult
§§D N
=
§§O P(
EcliptixProtocolConnection
•• &
.
••& '
FromProtoState
••' 5
(
••5 6
state
••6 ;
.
••; <
	ConnectId
••< E
,
••E F
state
••G L
.
••L M
RatchetState
••M Y
,
••Y Z
config
••[ a
,
••a b
EXCHANGE_TYPE
••c p
)
••p q
;
••q r
if
ßß 

(
ßß 

connResult
ßß 
.
ßß 
IsErr
ßß 
)
ßß 
{
®® 	
idKeysResult
©© 
.
©© 
Unwrap
©© 
(
©©  
)
©©  !
.
©©! "
Dispose
©©" )
(
©©) *
)
©©* +
;
©©+ ,
return
™™ 
Result
™™ 
<
™™ $
EcliptixProtocolSystem
™™ 0
,
™™0 1%
EcliptixProtocolFailure
™™2 I
>
™™I J
.
™™J K
Err
™™K N
(
™™N O

connResult
™™O Y
.
™™Y Z
	UnwrapErr
™™Z c
(
™™c d
)
™™d e
)
™™e f
;
™™f g
}
´´ 	
return
≠≠ $
EcliptixProtocolSystem
≠≠ %
.
≠≠% &

CreateFrom
≠≠& 0
(
≠≠0 1
idKeysResult
≠≠1 =
.
≠≠= >
Unwrap
≠≠> D
(
≠≠D E
)
≠≠E F
,
≠≠F G

connResult
≠≠H R
.
≠≠R S
Unwrap
≠≠S Y
(
≠≠Y Z
)
≠≠Z [
)
≠≠[ \
;
≠≠\ ]
}
ÆÆ 
private
∞∞ 
static
∞∞ 
uint
∞∞ (
GenerateLogicalOperationId
∞∞ 2
(
∞∞2 3
uint
∞∞3 7
	connectId
∞∞8 A
,
∞∞A B
RpcServiceType
∞∞C Q
serviceType
∞∞R ]
,
∞∞] ^
byte
∞∞_ c
[
∞∞c d
]
∞∞d e
plainBuffer
∞∞f q
)
∞∞q r
{
±± 
Span
≤≤ 
<
≤≤ 
byte
≤≤ 
>
≤≤ 

hashBuffer
≤≤ 
=
≤≤ 

stackalloc
≤≤  *
byte
≤≤+ /
[
≤≤/ 0
NetworkConstants
≤≤0 @
.
≤≤@ A
Cryptography
≤≤A M
.
≤≤M N
SHA_256_HASH_SIZE
≤≤N _
]
≤≤_ `
;
≤≤` a
switch
¥¥ 
(
¥¥ 
serviceType
¥¥ 
.
¥¥ 
ToString
¥¥ $
(
¥¥$ %
)
¥¥% &
)
¥¥& '
{
µµ 	
case
∂∂ 
$str
∂∂ *
or
∂∂+ -
$str
∂∂. K
:
∂∂K L
{
∑∑ 
Span
∏∏ 
<
∏∏ 
byte
∏∏ 
>
∏∏ 
semanticBuffer
∏∏ -
=
∏∏. /

stackalloc
∏∏0 :
byte
∏∏; ?
[
∏∏? @
$num
∏∏@ C
]
∏∏C D
;
∏∏D E
int
ππ 
written
ππ 
=
ππ  !
System
ππ" (
.
ππ( )
Text
ππ) -
.
ππ- .
Encoding
ππ. 6
.
ππ6 7
UTF8
ππ7 ;
.
ππ; <
GetBytes
ππ< D
(
ππD E
$"
ππE G
$str
ππG S
{
ππS T
	connectId
ππT ]
}
ππ] ^
"
ππ^ _
,
ππ_ `
semanticBuffer
ππa o
)
ππo p
;
ππp q
SHA256
∫∫ 
.
∫∫ 
HashData
∫∫ #
(
∫∫# $
semanticBuffer
∫∫$ 2
[
∫∫2 3
..
∫∫3 5
written
∫∫5 <
]
∫∫< =
,
∫∫= >

hashBuffer
∫∫? I
)
∫∫I J
;
∫∫J K
break
ªª 
;
ªª 
}
ºº 
case
ΩΩ 
$str
ΩΩ *
or
ΩΩ+ -
$str
ΩΩ. K
:
ΩΩK L
{
ææ 
Span
øø 
<
øø 
byte
øø 
>
øø 
semanticBuffer
øø -
=
øø. /

stackalloc
øø0 :
byte
øø; ?
[
øø? @
$num
øø@ C
]
øøC D
;
øøD E
int
¿¿ 
written
¿¿ 
=
¿¿  !
System
¿¿" (
.
¿¿( )
Text
¿¿) -
.
¿¿- .
Encoding
¿¿. 6
.
¿¿6 7
UTF8
¿¿7 ;
.
¿¿; <
GetBytes
¿¿< D
(
¿¿D E
$"
¿¿E G
$str
¿¿G S
{
¿¿S T
	connectId
¿¿T ]
}
¿¿] ^
"
¿¿^ _
,
¿¿_ `
semanticBuffer
¿¿a o
)
¿¿o p
;
¿¿p q
SHA256
¡¡ 
.
¡¡ 
HashData
¡¡ #
(
¡¡# $
semanticBuffer
¡¡$ 2
[
¡¡2 3
..
¡¡3 5
written
¡¡5 <
]
¡¡< =
,
¡¡= >

hashBuffer
¡¡? I
)
¡¡I J
;
¡¡J K
break
¬¬ 
;
¬¬ 
}
√√ 
case
ƒƒ 
$str
ƒƒ '
:
ƒƒ' (
{
≈≈ 
Span
∆∆ 
<
∆∆ 
byte
∆∆ 
>
∆∆ 
payloadHash
∆∆ *
=
∆∆+ ,

stackalloc
∆∆- 7
byte
∆∆8 <
[
∆∆< =
NetworkConstants
∆∆= M
.
∆∆M N
Cryptography
∆∆N Z
.
∆∆Z [
SHA_256_HASH_SIZE
∆∆[ l
]
∆∆l m
;
∆∆m n
SHA256
«« 
.
«« 
HashData
«« #
(
««# $
plainBuffer
««$ /
,
««/ 0
payloadHash
««1 <
)
««< =
;
««= >
string
…… 
semantic
…… #
=
……$ %
$"
   
$str
   !
{
  ! "
serviceType
  " -
}
  - .
$str
  . /
{
  / 0
	connectId
  0 9
}
  9 :
$str
  : ;
{
  ; <
DateTime
  < D
.
  D E
UtcNow
  E K
.
  K L
Ticks
  L Q
}
  Q R
$str
  R S
{
  S T
Convert
  T [
.
  [ \
ToHexString
  \ g
(
  g h
payloadHash
  h s
)
  s t
}
  t u
"
  u v
;
  v w
Span
ÀÀ 
<
ÀÀ 
byte
ÀÀ 
>
ÀÀ 
semanticBuffer
ÀÀ -
=
ÀÀ. /

stackalloc
ÀÀ0 :
byte
ÀÀ; ?
[
ÀÀ? @
System
ÀÀ@ F
.
ÀÀF G
Text
ÀÀG K
.
ÀÀK L
Encoding
ÀÀL T
.
ÀÀT U
UTF8
ÀÀU Y
.
ÀÀY Z
GetByteCount
ÀÀZ f
(
ÀÀf g
semantic
ÀÀg o
)
ÀÀo p
]
ÀÀp q
;
ÀÀq r
int
ÃÃ 
written
ÃÃ 
=
ÃÃ  !
System
ÃÃ" (
.
ÃÃ( )
Text
ÃÃ) -
.
ÃÃ- .
Encoding
ÃÃ. 6
.
ÃÃ6 7
UTF8
ÃÃ7 ;
.
ÃÃ; <
GetBytes
ÃÃ< D
(
ÃÃD E
semantic
ÃÃE M
,
ÃÃM N
semanticBuffer
ÃÃO ]
)
ÃÃ] ^
;
ÃÃ^ _
SHA256
ÕÕ 
.
ÕÕ 
HashData
ÕÕ #
(
ÕÕ# $
semanticBuffer
ÕÕ$ 2
[
ÕÕ2 3
..
ÕÕ3 5
written
ÕÕ5 <
]
ÕÕ< =
,
ÕÕ= >

hashBuffer
ÕÕ? I
)
ÕÕI J
;
ÕÕJ K
break
ŒŒ 
;
ŒŒ 
}
œœ 
default
–– 
:
–– 
{
—— 
Span
““ 
<
““ 
byte
““ 
>
““ 
payloadHash
““ *
=
““+ ,

stackalloc
““- 7
byte
““8 <
[
““< =
NetworkConstants
““= M
.
““M N
Cryptography
““N Z
.
““Z [
SHA_256_HASH_SIZE
““[ l
]
““l m
;
““m n
SHA256
”” 
.
”” 
HashData
”” #
(
””# $
plainBuffer
””$ /
,
””/ 0
payloadHash
””1 <
)
””< =
;
””= >
string
’’ 
semantic
’’ #
=
’’$ %
$"
’’& (
$str
’’( -
{
’’- .
serviceType
’’. 9
}
’’9 :
$str
’’: ;
{
’’; <
	connectId
’’< E
}
’’E F
$str
’’F G
{
’’G H
Convert
’’H O
.
’’O P
ToHexString
’’P [
(
’’[ \
payloadHash
’’\ g
)
’’g h
}
’’h i
"
’’i j
;
’’j k
Span
÷÷ 
<
÷÷ 
byte
÷÷ 
>
÷÷ 
semanticBuffer
÷÷ -
=
÷÷. /

stackalloc
÷÷0 :
byte
÷÷; ?
[
÷÷? @
System
÷÷@ F
.
÷÷F G
Text
÷÷G K
.
÷÷K L
Encoding
÷÷L T
.
÷÷T U
UTF8
÷÷U Y
.
÷÷Y Z
GetByteCount
÷÷Z f
(
÷÷f g
semantic
÷÷g o
)
÷÷o p
]
÷÷p q
;
÷÷q r
int
◊◊ 
written
◊◊ 
=
◊◊  !
System
◊◊" (
.
◊◊( )
Text
◊◊) -
.
◊◊- .
Encoding
◊◊. 6
.
◊◊6 7
UTF8
◊◊7 ;
.
◊◊; <
GetBytes
◊◊< D
(
◊◊D E
semantic
◊◊E M
,
◊◊M N
semanticBuffer
◊◊O ]
)
◊◊] ^
;
◊◊^ _
SHA256
ÿÿ 
.
ÿÿ 
HashData
ÿÿ #
(
ÿÿ# $
semanticBuffer
ÿÿ$ 2
[
ÿÿ2 3
..
ÿÿ3 5
written
ÿÿ5 <
]
ÿÿ< =
,
ÿÿ= >

hashBuffer
ÿÿ? I
)
ÿÿI J
;
ÿÿJ K
break
ŸŸ 
;
ŸŸ 
}
⁄⁄ 
}
€€ 	
const
›› 
int
›› 
HASH_LENGTH
›› 
=
›› 
NetworkConstants
››  0
.
››0 1
Cryptography
››1 =
.
››= >
SHA_256_HASH_SIZE
››> O
;
››O P
uint
ﬂﬂ 
rawId
ﬂﬂ 
=
ﬂﬂ 
BitConverter
ﬂﬂ !
.
ﬂﬂ! "
ToUInt32
ﬂﬂ" *
(
ﬂﬂ* +

hashBuffer
ﬂﬂ+ 5
[
ﬂﬂ5 6
..
ﬂﬂ6 8
HASH_LENGTH
ﬂﬂ8 C
]
ﬂﬂC D
)
ﬂﬂD E
;
ﬂﬂE F
uint
‡‡ 
finalId
‡‡ 
=
‡‡ 
Math
‡‡ 
.
‡‡ 
Max
‡‡ 
(
‡‡  
rawId
‡‡  %
%
‡‡& '
(
‡‡( )
uint
‡‡) -
.
‡‡- .
MaxValue
‡‡. 6
-
‡‡7 8
NetworkConstants
‡‡9 I
.
‡‡I J
Protocol
‡‡J R
.
‡‡R S)
OPERATION_ID_RESERVED_RANGE
‡‡S n
)
‡‡n o
,
‡‡o p
NetworkConstants
·· 
.
·· 
Protocol
·· %
.
··% &$
OPERATION_ID_MIN_VALUE
··& <
)
··< =
;
··= >
return
„„ 
finalId
„„ 
;
„„ 
}
‰‰ 
private
ÊÊ 
static
ÊÊ 
Result
ÊÊ 
<
ÊÊ 
SecureEnvelope
ÊÊ (
,
ÊÊ( )
NetworkFailure
ÊÊ* 8
>
ÊÊ8 9
EncryptPayload
ÊÊ: H
(
ÊÊH I$
EcliptixProtocolSystem
ÁÁ 
protocolSystem
ÁÁ -
,
ÁÁ- .
byte
ËË 
[
ËË 
]
ËË 
plainBuffer
ËË 
)
ËË 
{
ÈÈ 
Result
ÍÍ 
<
ÍÍ 
SecureEnvelope
ÍÍ 
,
ÍÍ %
EcliptixProtocolFailure
ÍÍ 6
>
ÍÍ6 7
outboundPayload
ÍÍ8 G
=
ÍÍH I
protocolSystem
ÎÎ 
.
ÎÎ %
ProduceOutboundEnvelope
ÎÎ 2
(
ÎÎ2 3
plainBuffer
ÎÎ3 >
)
ÎÎ> ?
;
ÎÎ? @
if
ÌÌ 

(
ÌÌ 
outboundPayload
ÌÌ 
.
ÌÌ 
IsErr
ÌÌ !
)
ÌÌ! "
{
ÓÓ 	
return
ÔÔ 
Result
ÔÔ 
<
ÔÔ 
SecureEnvelope
ÔÔ (
,
ÔÔ( )
NetworkFailure
ÔÔ* 8
>
ÔÔ8 9
.
ÔÔ9 :
Err
ÔÔ: =
(
ÔÔ= >
outboundPayload
 
.
  
	UnwrapErr
  )
(
) *
)
* +
.
+ ,
ToNetworkFailure
, <
(
< =
)
= >
)
> ?
;
? @
}
ÒÒ 	
SecureEnvelope
ÛÛ 
cipherPayload
ÛÛ $
=
ÛÛ% &
outboundPayload
ÛÛ' 6
.
ÛÛ6 7
Unwrap
ÛÛ7 =
(
ÛÛ= >
)
ÛÛ> ?
;
ÛÛ? @
return
ıı 
Result
ıı 
<
ıı 
SecureEnvelope
ıı $
,
ıı$ %
NetworkFailure
ıı& 4
>
ıı4 5
.
ıı5 6
Ok
ıı6 8
(
ıı8 9
cipherPayload
ıı9 F
)
ııF G
;
ııG H
}
ˆˆ 
private
¯¯ 
static
¯¯ 
Result
¯¯ 
<
¯¯ 
ServiceRequest
¯¯ (
,
¯¯( )
NetworkFailure
¯¯* 8
>
¯¯8 9 
BuildRequestWithId
¯¯: L
(
¯¯L M$
EcliptixProtocolSystem
˘˘ 
protocolSystem
˘˘ -
,
˘˘- .
uint
˙˙  
logicalOperationId
˙˙ 
,
˙˙  
RpcServiceType
˚˚ 
serviceType
˚˚ "
,
˚˚" #
byte
¸¸ 
[
¸¸ 
]
¸¸ 
plainBuffer
¸¸ 
,
¸¸ 
ServiceFlowType
˝˝ 
flowType
˝˝  
,
˝˝  !
RpcRequestContext
˛˛ 
requestContext
˛˛ (
)
˛˛( )
{
ˇˇ 
Result
ÄÄ 
<
ÄÄ 
SecureEnvelope
ÄÄ 
,
ÄÄ 
NetworkFailure
ÄÄ -
>
ÄÄ- .
encryptResult
ÄÄ/ <
=
ÄÄ= >
EncryptPayload
ÄÄ? M
(
ÄÄM N
protocolSystem
ÄÄN \
,
ÄÄ\ ]
plainBuffer
ÄÄ^ i
)
ÄÄi j
;
ÄÄj k
if
ÇÇ 

(
ÇÇ 
encryptResult
ÇÇ 
.
ÇÇ 
IsErr
ÇÇ 
)
ÇÇ  
{
ÉÉ 	
return
ÑÑ 
Result
ÑÑ 
<
ÑÑ 
ServiceRequest
ÑÑ (
,
ÑÑ( )
NetworkFailure
ÑÑ* 8
>
ÑÑ8 9
.
ÑÑ9 :
Err
ÑÑ: =
(
ÑÑ= >
encryptResult
ÑÑ> K
.
ÑÑK L
	UnwrapErr
ÑÑL U
(
ÑÑU V
)
ÑÑV W
)
ÑÑW X
;
ÑÑX Y
}
ÖÖ 	
SecureEnvelope
áá 
cipherPayload
áá $
=
áá% &
encryptResult
áá' 4
.
áá4 5
Unwrap
áá5 ;
(
áá; <
)
áá< =
;
áá= >
return
ââ 
Result
ââ 
<
ââ 
ServiceRequest
ââ $
,
ââ$ %
NetworkFailure
ââ& 4
>
ââ4 5
.
ââ5 6
Ok
ââ6 8
(
ââ8 9
ServiceRequest
ää 
.
ää 
New
ää 
(
ää  
logicalOperationId
ää 1
,
ää1 2
flowType
ää3 ;
,
ää; <
serviceType
ää= H
,
ääH I
cipherPayload
ääJ W
,
ääW X
[
ääY Z
]
ääZ [
,
ää[ \
requestContext
ää] k
)
ääk l
)
ääl m
;
ääm n
}
ãã 
private
çç 
async
çç 
Task
çç 
<
çç 
Result
çç 
<
çç 
Unit
çç "
,
çç" #
NetworkFailure
çç$ 2
>
çç2 3
>
çç3 4#
SendUnaryRequestAsync
çç5 J
(
ççJ K$
EcliptixProtocolSystem
éé 
protocolSystem
éé -
,
éé- .
uint
èè  
logicalOperationId
èè 
,
èè  
RpcServiceType
êê 
serviceType
êê "
,
êê" #
byte
ëë 
[
ëë 
]
ëë 
plainBuffer
ëë 
,
ëë 
ServiceFlowType
íí 
flowType
íí  
,
íí  !
Func
ìì 
<
ìì 
byte
ìì 
[
ìì 
]
ìì 
,
ìì 
Task
ìì 
<
ìì 
Result
ìì  
<
ìì  !
Unit
ìì! %
,
ìì% &
NetworkFailure
ìì' 5
>
ìì5 6
>
ìì6 7
>
ìì7 8
onCompleted
ìì9 D
,
ììD E
uint
îî 
	connectId
îî 
,
îî 
RetryBehavior
ïï 
retryBehavior
ïï #
,
ïï# $
CancellationToken
ññ 
token
ññ 
)
ññ  
{
óó 
bool
òò 
shouldUseRetry
òò 
=
òò 
retryBehavior
òò +
.
òò+ ,
ShouldRetry
òò, 7
;
òò7 8
Result
öö 
<
öö 
RpcFlow
öö 
,
öö 
NetworkFailure
öö &
>
öö& '
invokeResult
öö( 4
;
öö4 5
RpcRequestContext
õõ 
?
õõ  
lastRequestContext
õõ -
=
õõ. /
null
õõ0 4
;
õõ4 5
if
ùù 

(
ùù 
shouldUseRetry
ùù 
)
ùù 
{
ûû 	
Result
üü 
<
üü 
SecureEnvelope
üü !
,
üü! "
NetworkFailure
üü# 1
>
üü1 2
encryptResult
üü3 @
=
üüA B
EncryptPayload
†† 
(
†† 
protocolSystem
†† -
,
††- .
plainBuffer
††/ :
)
††: ;
;
††; <
if
¢¢ 
(
¢¢ 
encryptResult
¢¢ 
.
¢¢ 
IsErr
¢¢ #
)
¢¢# $
{
££ 
return
§§ 
Result
§§ 
<
§§ 
Unit
§§ "
,
§§" #
NetworkFailure
§§$ 2
>
§§2 3
.
§§3 4
Err
§§4 7
(
§§7 8
encryptResult
§§8 E
.
§§E F
	UnwrapErr
§§F O
(
§§O P
)
§§P Q
)
§§Q R
;
§§R S
}
•• 
SecureEnvelope
ßß 
encryptedPayload
ßß +
=
ßß, -
encryptResult
ßß. ;
.
ßß; <
Unwrap
ßß< B
(
ßßB C
)
ßßC D
;
ßßD E
string
®® "
stableIdempotencyKey
®® '
=
®®( )
Guid
®®* .
.
®®. /
NewGuid
®®/ 6
(
®®6 7
)
®®7 8
.
®®8 9
ToString
®®9 A
(
®®A B
$str
®®B E
)
®®E F
;
®®F G
invokeResult
™™ 
=
™™ 
await
™™  
retryStrategy
™™! .
.
™™. /&
ExecuteRpcOperationAsync
™™/ G
(
™™G H
(
´´ 
attempt
´´ 
,
´´ 
ct
´´ 
)
´´ 
=>
´´  
{
¨¨ 
RpcRequestContext
≠≠ %
attemptContext
≠≠& 4
=
≠≠5 6
RpcRequestContext
ÆÆ )
.
ÆÆ) *$
CreateNewWithStableKey
ÆÆ* @
(
ÆÆ@ A"
stableIdempotencyKey
ÆÆA U
,
ÆÆU V
attempt
ÆÆW ^
)
ÆÆ^ _
;
ÆÆ_ ` 
lastRequestContext
ØØ &
=
ØØ' (
attemptContext
ØØ) 7
;
ØØ7 8
ServiceRequest
±± "
request
±±# *
=
±±+ ,
ServiceRequest
±±- ;
.
±±; <
New
±±< ?
(
±±? @ 
logicalOperationId
≤≤ *
,
≤≤* +
flowType
≥≥  
,
≥≥  !
serviceType
¥¥ #
,
¥¥# $
encryptedPayload
µµ (
,
µµ( )
[
∂∂ 
]
∂∂ 
,
∂∂ 
attemptContext
∑∑ &
)
∑∑& '
;
∑∑' (
return
ππ 
rpcServiceManager
ππ ,
.
ππ, -'
InvokeServiceRequestAsync
ππ- F
(
ππF G
request
ππG N
,
ππN O
ct
ππP R
)
ππR S
;
ππS T
}
∫∫ 
,
∫∫ 
$"
ªª 
$str
ªª 
{
ªª  
serviceType
ªª  +
}
ªª+ ,
"
ªª, -
,
ªª- .
	connectId
ºº 
,
ºº 
serviceType
ΩΩ 
:
ΩΩ 
serviceType
ΩΩ (
,
ΩΩ( )

maxRetries
ææ 
:
ææ 
Math
ææ  
.
ææ  !
Max
ææ! $
(
ææ$ %
$num
ææ% &
,
ææ& '
retryBehavior
ææ( 5
.
ææ5 6
MAX_ATTEMPTS
ææ6 B
-
ææC D
$num
ææE F
)
ææF G
,
ææG H
cancellationToken
øø !
:
øø! "
token
øø# (
)
øø( )
.
øø) *
ConfigureAwait
øø* 8
(
øø8 9
false
øø9 >
)
øø> ?
;
øø? @
}
¿¿ 	
else
¡¡ 
{
¬¬ 	
RpcRequestContext
√√ "
singleAttemptContext
√√ 2
=
√√3 4
RpcRequestContext
√√5 F
.
√√F G
	CreateNew
√√G P
(
√√P Q
)
√√Q R
;
√√R S 
lastRequestContext
ƒƒ 
=
ƒƒ  "
singleAttemptContext
ƒƒ! 5
;
ƒƒ5 6
Result
∆∆ 
<
∆∆ 
ServiceRequest
∆∆ !
,
∆∆! "
NetworkFailure
∆∆# 1
>
∆∆1 2"
serviceRequestResult
∆∆3 G
=
∆∆H I 
BuildRequestWithId
∆∆J \
(
∆∆\ ]
protocolSystem
«« 
,
««  
logicalOperationId
««  2
,
««2 3
serviceType
««4 ?
,
««? @
plainBuffer
««A L
,
««L M
flowType
««N V
,
««V W"
singleAttemptContext
««X l
)
««l m
;
««m n
if
…… 
(
…… "
serviceRequestResult
…… $
.
……$ %
IsErr
……% *
)
……* +
{
   
return
ÀÀ 
Result
ÀÀ 
<
ÀÀ 
Unit
ÀÀ "
,
ÀÀ" #
NetworkFailure
ÀÀ$ 2
>
ÀÀ2 3
.
ÀÀ3 4
Err
ÀÀ4 7
(
ÀÀ7 8"
serviceRequestResult
ÀÀ8 L
.
ÀÀL M
	UnwrapErr
ÀÀM V
(
ÀÀV W
)
ÀÀW X
)
ÀÀX Y
;
ÀÀY Z
}
ÃÃ 
ServiceRequest
ŒŒ 
request
ŒŒ "
=
ŒŒ# $"
serviceRequestResult
ŒŒ% 9
.
ŒŒ9 :
Unwrap
ŒŒ: @
(
ŒŒ@ A
)
ŒŒA B
;
ŒŒB C
invokeResult
œœ 
=
œœ 
await
œœ  
rpcServiceManager
œœ! 2
.
œœ2 3'
InvokeServiceRequestAsync
œœ3 L
(
œœL M
request
œœM T
,
œœT U
token
œœV [
)
œœ[ \
.
œœ\ ]
ConfigureAwait
œœ] k
(
œœk l
false
œœl q
)
œœq r
;
œœr s
}
–– 	
if
““ 

(
““ 
invokeResult
““ 
.
““ 
IsErr
““ 
)
““ 
{
”” 	
NetworkFailure
‘‘ 
failure
‘‘ "
=
‘‘# $
AttachCorrelation
‘‘% 6
(
‘‘6 7
invokeResult
‘‘7 C
.
‘‘C D
	UnwrapErr
‘‘D M
(
‘‘M N
)
‘‘N O
,
‘‘O P 
lastRequestContext
‘‘Q c
)
‘‘c d
;
‘‘d e
failure
’’ 
=
’’ !
ApplyReinitIfNeeded
’’ )
(
’’) *
failure
’’* 1
,
’’1 2
serviceType
’’3 >
,
’’> ?
retryBehavior
’’@ M
)
’’M N
;
’’N O
return
÷÷ 
Result
÷÷ 
<
÷÷ 
Unit
÷÷ 
,
÷÷ 
NetworkFailure
÷÷  .
>
÷÷. /
.
÷÷/ 0
Err
÷÷0 3
(
÷÷3 4
failure
÷÷4 ;
)
÷÷; <
;
÷÷< =
}
◊◊ 	
RpcFlow
ŸŸ 
flow
ŸŸ 
=
ŸŸ 
invokeResult
ŸŸ #
.
ŸŸ# $
Unwrap
ŸŸ$ *
(
ŸŸ* +
)
ŸŸ+ ,
;
ŸŸ, -
if
⁄⁄ 

(
⁄⁄ 
flow
⁄⁄ 
is
⁄⁄ 
not
⁄⁄ 
RpcFlow
⁄⁄ 
.
⁄⁄  

SingleCall
⁄⁄  *

singleCall
⁄⁄+ 5
)
⁄⁄5 6
{
€€ 	
return
‹‹ 
Result
‹‹ 
<
‹‹ 
Unit
‹‹ 
,
‹‹ 
NetworkFailure
‹‹  .
>
‹‹. /
.
‹‹/ 0
Err
‹‹0 3
(
‹‹3 4
NetworkFailure
›› 
.
››  
InvalidRequestType
›› 1
(
››1 2
$"
››2 4
$str
››4 Z
{
››Z [
flow
››[ _
.
››_ `
GetType
››` g
(
››g h
)
››h i
.
››i j
Name
››j n
}
››n o
"
››o p
)
››p q
)
››q r
;
››r s
}
ﬁﬁ 	
Result
‡‡ 
<
‡‡ 
SecureEnvelope
‡‡ 
,
‡‡ 
NetworkFailure
‡‡ -
>
‡‡- .

callResult
‡‡/ 9
=
‡‡: ;
await
‡‡< A

singleCall
‡‡B L
.
‡‡L M
Result
‡‡M S
.
‡‡S T
ConfigureAwait
‡‡T b
(
‡‡b c
false
‡‡c h
)
‡‡h i
;
‡‡i j
if
·· 

(
·· 

callResult
·· 
.
·· 
IsErr
·· 
)
·· 
{
‚‚ 	
NetworkFailure
„„ 
failure
„„ "
=
„„# $
AttachCorrelation
„„% 6
(
„„6 7

callResult
„„7 A
.
„„A B
	UnwrapErr
„„B K
(
„„K L
)
„„L M
,
„„M N 
lastRequestContext
„„O a
)
„„a b
;
„„b c
failure
‰‰ 
=
‰‰ !
ApplyReinitIfNeeded
‰‰ )
(
‰‰) *
failure
‰‰* 1
,
‰‰1 2
serviceType
‰‰3 >
,
‰‰> ?
retryBehavior
‰‰@ M
)
‰‰M N
;
‰‰N O
return
ÂÂ 
Result
ÂÂ 
<
ÂÂ 
Unit
ÂÂ 
,
ÂÂ 
NetworkFailure
ÂÂ  .
>
ÂÂ. /
.
ÂÂ/ 0
Err
ÂÂ0 3
(
ÂÂ3 4
failure
ÂÂ4 ;
)
ÂÂ; <
;
ÂÂ< =
}
ÊÊ 	
SecureEnvelope
ËË 
inboundPayload
ËË %
=
ËË& '

callResult
ËË( 2
.
ËË2 3
Unwrap
ËË3 9
(
ËË9 :
)
ËË: ;
;
ËË; <
Result
ÍÍ 
<
ÍÍ 
byte
ÍÍ 
[
ÍÍ 
]
ÍÍ 
,
ÍÍ %
EcliptixProtocolFailure
ÍÍ .
>
ÍÍ. /
decryptedData
ÍÍ0 =
=
ÍÍ> ?
protocolSystem
ÎÎ 
.
ÎÎ $
ProcessInboundEnvelope
ÎÎ 1
(
ÎÎ1 2
inboundPayload
ÎÎ2 @
)
ÎÎ@ A
;
ÎÎA B
if
ÏÏ 

(
ÏÏ 
decryptedData
ÏÏ 
.
ÏÏ 
IsErr
ÏÏ 
)
ÏÏ  
{
ÌÌ 	
Log
ÓÓ 
.
ÓÓ 
Error
ÓÓ 
(
ÓÓ 
$str
ÓÓ P
,
ÓÓP Q
decryptedData
ÓÓR _
.
ÓÓ_ `
	UnwrapErr
ÓÓ` i
(
ÓÓi j
)
ÓÓj k
.
ÓÓk l
Message
ÓÓl s
)
ÓÓs t
;
ÓÓt u
NetworkFailure
ÔÔ 
decryptFailure
ÔÔ )
=
ÔÔ* +
decryptedData
ÔÔ, 9
.
ÔÔ9 :
	UnwrapErr
ÔÔ: C
(
ÔÔC D
)
ÔÔD E
.
ÔÔE F
ToNetworkFailure
ÔÔF V
(
ÔÔV W
)
ÔÔW X
;
ÔÔX Y
decryptFailure
 
=
 !
ApplyReinitIfNeeded
 0
(
0 1
decryptFailure
1 ?
,
? @
serviceType
A L
,
L M
retryBehavior
N [
)
[ \
;
\ ]
return
ÒÒ 
Result
ÒÒ 
<
ÒÒ 
Unit
ÒÒ 
,
ÒÒ 
NetworkFailure
ÒÒ  .
>
ÒÒ. /
.
ÒÒ/ 0
Err
ÒÒ0 3
(
ÒÒ3 4
decryptFailure
ÒÒ4 B
)
ÒÒB C
;
ÒÒC D
}
ÚÚ 	
await
ÙÙ 
onCompleted
ÙÙ 
(
ÙÙ 
decryptedData
ÙÙ '
.
ÙÙ' (
Unwrap
ÙÙ( .
(
ÙÙ. /
)
ÙÙ/ 0
)
ÙÙ0 1
.
ÙÙ1 2
ConfigureAwait
ÙÙ2 @
(
ÙÙ@ A
false
ÙÙA F
)
ÙÙF G
;
ÙÙG H
return
ıı 
Result
ıı 
<
ıı 
Unit
ıı 
,
ıı 
NetworkFailure
ıı *
>
ıı* +
.
ıı+ ,
Ok
ıı, .
(
ıı. /
Unit
ıı/ 3
.
ıı3 4
Value
ıı4 9
)
ıı9 :
;
ıı: ;
}
ˆˆ 
private
¯¯ 
static
¯¯ 
NetworkFailure
¯¯ !
AttachCorrelation
¯¯" 3
(
¯¯3 4
NetworkFailure
¯¯4 B
failure
¯¯C J
,
¯¯J K
RpcRequestContext
¯¯L ]
?
¯¯] ^
context
¯¯_ f
)
¯¯f g
{
˘˘ 
if
˙˙ 

(
˙˙ 
context
˙˙ 
==
˙˙ 
null
˙˙ 
)
˙˙ 
{
˚˚ 	
return
¸¸ 
failure
¸¸ 
;
¸¸ 
}
˝˝ 	
if
ˇˇ 

(
ˇˇ 
failure
ˇˇ 
.
ˇˇ 
	UserError
ˇˇ 
is
ˇˇ  
{
ˇˇ! "
}
ˇˇ# $
	userError
ˇˇ% .
&&
ˇˇ/ 1
string
ˇˇ2 8
.
ˇˇ8 9 
IsNullOrWhiteSpace
ˇˇ9 K
(
ˇˇK L
	userError
ˇˇL U
.
ˇˇU V
CORRELATION_ID
ˇˇV d
)
ˇˇd e
)
ˇˇe f
{
Ä	Ä	 	
return
Å	Å	 
failure
Å	Å	 
with
Å	Å	 
{
Å	Å	  !
	UserError
Å	Å	" +
=
Å	Å	, -
	userError
Å	Å	. 7
with
Å	Å	8 <
{
Å	Å	= >
CORRELATION_ID
Å	Å	? M
=
Å	Å	N O
context
Å	Å	P W
.
Å	Å	W X
CORRELATION_ID
Å	Å	X f
}
Å	Å	g h
}
Å	Å	i j
;
Å	Å	j k
}
Ç	Ç	 	
return
Ñ	Ñ	 
failure
Ñ	Ñ	 
;
Ñ	Ñ	 
}
Ö	Ö	 
private
á	á	 
static
á	á	 
bool
á	á	 !
IsCompleteOperation
á	á	 +
(
á	á	+ ,
RpcServiceType
á	á	, :
serviceType
á	á	; F
)
á	á	F G
{
à	à	 
return
â	â	 
serviceType
â	â	 
is
â	â	 
RpcServiceType
ä	ä	 
.
ä	ä	 "
RegistrationComplete
ä	ä	 /
or
ä	ä	0 2
RpcServiceType
ã	ã	 
.
ã	ã	 '
RecoverySecretKeyComplete
ã	ã	 4
or
ã	ã	5 7
RpcServiceType
å	å	 
.
å	å	 #
SignInCompleteRequest
å	å	 0
;
å	å	0 1
}
ç	ç	 
private
è	è	 
static
è	è	 
bool
è	è	 #
ShouldReinitOnFailure
è	è	 -
(
è	è	- .
NetworkFailure
è	è	. <
failure
è	è	= D
)
è	è	D E
{
ê	ê	 
return
ë	ë	 
failure
ë	ë	 
.
ë	ë	 
FailureType
ë	ë	 "
is
ë	ë	# % 
NetworkFailureType
í	í	 
.
í	í	 %
DataCenterNotResponding
í	í	 6
or
í	í	7 9 
NetworkFailureType
ì	ì	 
.
ì	ì	  
DataCenterShutdown
ì	ì	 1
or
ì	ì	2 4 
NetworkFailureType
î	î	 
.
î	î	 #
ProtocolStateMismatch
î	î	 4
;
î	î	4 5
}
ï	ï	 
private
ó	ó	 
static
ó	ó	 
NetworkFailure
ó	ó	 !!
ApplyReinitIfNeeded
ó	ó	" 5
(
ó	ó	5 6
NetworkFailure
ò	ò	 
failure
ò	ò	 
,
ò	ò	 
RpcServiceType
ô	ô	 
serviceType
ô	ô	 "
,
ô	ô	" #
RetryBehavior
ö	ö	 
retryBehavior
ö	ö	 #
)
ö	ö	# $
{
õ	õ	 
if
ú	ú	 

(
ú	ú	 !
IsCompleteOperation
ú	ú	 
(
ú	ú	  
serviceType
ú	ú	  +
)
ú	ú	+ ,
&&
ú	ú	- /
retryBehavior
ù	ù	 
.
ù	ù	 %
ReinitOnCompleteFailure
ù	ù	 1
&&
ù	ù	2 4#
ShouldReinitOnFailure
û	û	 !
(
û	û	! "
failure
û	û	" )
)
û	û	) *
)
û	û	* +
{
ü	ü	 	
return
†	†	 
failure
†	†	 
with
†	†	 
{
†	†	  !
RequiresReinit
†	†	" 0
=
†	†	1 2
true
†	†	3 7
}
†	†	8 9
;
†	†	9 :
}
°	°	 	
return
£	£	 
failure
£	£	 
;
£	£	 
}
§	§	 
private
¶	¶	 
async
¶	¶	 
Task
¶	¶	 
<
¶	¶	 
Result
¶	¶	 
<
¶	¶	 
Unit
¶	¶	 "
,
¶	¶	" #
NetworkFailure
¶	¶	$ 2
>
¶	¶	2 3
>
¶	¶	3 4+
SendReceiveStreamRequestAsync
¶	¶	5 R
(
¶	¶	R S$
EcliptixProtocolSystem
ß	ß	 
protocolSystem
ß	ß	 -
,
ß	ß	- .
uint
®	®	  
logicalOperationId
®	®	 
,
®	®	  
RpcServiceType
©	©	 
serviceType
©	©	 "
,
©	©	" #
byte
™	™	 
[
™	™	 
]
™	™	 
plainBuffer
™	™	 
,
™	™	 
ServiceFlowType
´	´	 
flowType
´	´	  
,
´	´	  !
RpcRequestContext
¨	¨	 
requestContext
¨	¨	 (
,
¨	¨	( )
Func
≠	≠	 
<
≠	≠	 
byte
≠	≠	 
[
≠	≠	 
]
≠	≠	 
,
≠	≠	 
Task
≠	≠	 
<
≠	≠	 
Result
≠	≠	  
<
≠	≠	  !
Unit
≠	≠	! %
,
≠	≠	% &
NetworkFailure
≠	≠	' 5
>
≠	≠	5 6
>
≠	≠	6 7
>
≠	≠	7 8
onStreamItem
≠	≠	9 E
,
≠	≠	E F
RetryBehavior
Æ	Æ	 
retryBehavior
Æ	Æ	 #
,
Æ	Æ	# $
uint
Ø	Ø	 
	connectId
Ø	Ø	 
,
Ø	Ø	 
CancellationToken
∞	∞	 
token
∞	∞	 
)
∞	∞	  
{
±	±	 
if
≤	≤	 

(
≤	≤	 
retryBehavior
≤	≤	 
.
≤	≤	 
ShouldRetry
≤	≤	 %
)
≤	≤	% &
{
≥	≥	 	
Result
¥	¥	 
<
¥	¥	 
SecureEnvelope
¥	¥	 !
,
¥	¥	! "
NetworkFailure
¥	¥	# 1
>
¥	¥	1 2
encryptResult
¥	¥	3 @
=
¥	¥	A B
EncryptPayload
µ	µ	 
(
µ	µ	 
protocolSystem
µ	µ	 -
,
µ	µ	- .
plainBuffer
µ	µ	/ :
)
µ	µ	: ;
;
µ	µ	; <
if
∑	∑	 
(
∑	∑	 
encryptResult
∑	∑	 
.
∑	∑	 
IsErr
∑	∑	 #
)
∑	∑	# $
{
∏	∏	 
return
π	π	 
Result
π	π	 
<
π	π	 
Unit
π	π	 "
,
π	π	" #
NetworkFailure
π	π	$ 2
>
π	π	2 3
.
π	π	3 4
Err
π	π	4 7
(
π	π	7 8
encryptResult
π	π	8 E
.
π	π	E F
	UnwrapErr
π	π	F O
(
π	π	O P
)
π	π	P Q
)
π	π	Q R
;
π	π	R S
}
∫	∫	 
SecureEnvelope
º	º	 
encryptedPayload
º	º	 +
=
º	º	, -
encryptResult
º	º	. ;
.
º	º	; <
Unwrap
º	º	< B
(
º	º	B C
)
º	º	C D
;
º	º	D E
string
Ω	Ω	 "
stableIdempotencyKey
Ω	Ω	 '
=
Ω	Ω	( )
requestContext
Ω	Ω	* 8
.
Ω	Ω	8 9
IdempotencyKey
Ω	Ω	9 G
;
Ω	Ω	G H
return
ø	ø	 
await
ø	ø	 
retryStrategy
ø	ø	 &
.
ø	ø	& '&
ExecuteRpcOperationAsync
ø	ø	' ?
(
ø	ø	? @
async
¿	¿	 
(
¿	¿	 
attempt
¿	¿	 
,
¿	¿	 
ct
¿	¿	  "
)
¿	¿	" #
=>
¿	¿	$ &
{
¡	¡	 
RpcRequestContext
¬	¬	 %
attemptContext
¬	¬	& 4
=
¬	¬	5 6
RpcRequestContext
√	√	 )
.
√	√	) *$
CreateNewWithStableKey
√	√	* @
(
√	√	@ A"
stableIdempotencyKey
√	√	A U
,
√	√	U V
attempt
√	√	W ^
)
√	√	^ _
;
√	√	_ `
ServiceRequest
≈	≈	 "
request
≈	≈	# *
=
≈	≈	+ ,
ServiceRequest
≈	≈	- ;
.
≈	≈	; <
New
≈	≈	< ?
(
≈	≈	? @ 
logicalOperationId
∆	∆	 *
,
∆	∆	* +
flowType
«	«	  
,
«	«	  !
serviceType
»	»	 #
,
»	»	# $
encryptedPayload
…	…	 (
,
…	…	( )
[
 	 	 
]
 	 	 
,
 	 	 
attemptContext
À	À	 &
)
À	À	& '
;
À	À	' (
Result
Õ	Õ	 
<
Õ	Õ	 
Unit
Õ	Õ	 
,
Õ	Õ	  
NetworkFailure
Õ	Õ	! /
>
Õ	Õ	/ 0
processResult
Õ	Õ	1 >
=
Õ	Õ	? @
await
Õ	Õ	A F&
ProcessStreamWithRequest
Õ	Õ	G _
(
Õ	Õ	_ `
protocolSystem
Œ	Œ	 &
,
Œ	Œ	& '
request
Œ	Œ	( /
,
Œ	Œ	/ 0
onStreamItem
Œ	Œ	1 =
,
Œ	Œ	= >
	connectId
Œ	Œ	? H
,
Œ	Œ	H I
ct
Œ	Œ	J L
)
Œ	Œ	L M
.
Œ	Œ	M N
ConfigureAwait
Œ	Œ	N \
(
Œ	Œ	\ ]
false
Œ	Œ	] b
)
Œ	Œ	b c
;
Œ	Œ	c d
return
–	–	 
processResult
–	–	 (
;
–	–	( )
}
—	—	 
,
—	—	 
$"
“	“	 
$str
“	“	  
{
“	“	  !
serviceType
“	“	! ,
}
“	“	, -
"
“	“	- .
,
“	“	. /
	connectId
”	”	 
,
”	”	 
serviceType
‘	‘	 
:
‘	‘	 
serviceType
‘	‘	 (
,
‘	‘	( )

maxRetries
’	’	 
:
’	’	 
Math
’	’	  
.
’	’	  !
Max
’	’	! $
(
’	’	$ %
$num
’	’	% &
,
’	’	& '
retryBehavior
’	’	( 5
.
’	’	5 6
MAX_ATTEMPTS
’	’	6 B
-
’	’	C D
$num
’	’	E F
)
’	’	F G
,
’	’	G H
cancellationToken
÷	÷	 !
:
÷	÷	! "
token
÷	÷	# (
)
÷	÷	( )
.
÷	÷	) *
ConfigureAwait
÷	÷	* 8
(
÷	÷	8 9
false
÷	÷	9 >
)
÷	÷	> ?
;
÷	÷	? @
}
◊	◊	 	
Result
Ÿ	Ÿ	 
<
Ÿ	Ÿ	 
ServiceRequest
Ÿ	Ÿ	 
,
Ÿ	Ÿ	 
NetworkFailure
Ÿ	Ÿ	 -
>
Ÿ	Ÿ	- ."
serviceRequestResult
Ÿ	Ÿ	/ C
=
Ÿ	Ÿ	D E 
BuildRequestWithId
Ÿ	Ÿ	F X
(
Ÿ	Ÿ	X Y
protocolSystem
⁄	⁄	 
,
⁄	⁄	  
logicalOperationId
⁄	⁄	 .
,
⁄	⁄	. /
serviceType
⁄	⁄	0 ;
,
⁄	⁄	; <
plainBuffer
⁄	⁄	= H
,
⁄	⁄	H I
flowType
⁄	⁄	J R
,
⁄	⁄	R S
requestContext
⁄	⁄	T b
)
⁄	⁄	b c
;
⁄	⁄	c d
if
‹	‹	 

(
‹	‹	 "
serviceRequestResult
‹	‹	  
.
‹	‹	  !
IsErr
‹	‹	! &
)
‹	‹	& '
{
›	›	 	
return
ﬁ	ﬁ	 
Result
ﬁ	ﬁ	 
<
ﬁ	ﬁ	 
Unit
ﬁ	ﬁ	 
,
ﬁ	ﬁ	 
NetworkFailure
ﬁ	ﬁ	  .
>
ﬁ	ﬁ	. /
.
ﬁ	ﬁ	/ 0
Err
ﬁ	ﬁ	0 3
(
ﬁ	ﬁ	3 4"
serviceRequestResult
ﬁ	ﬁ	4 H
.
ﬁ	ﬁ	H I
	UnwrapErr
ﬁ	ﬁ	I R
(
ﬁ	ﬁ	R S
)
ﬁ	ﬁ	S T
)
ﬁ	ﬁ	T U
;
ﬁ	ﬁ	U V
}
ﬂ	ﬂ	 	
ServiceRequest
·	·	 
request
·	·	 
=
·	·	  "
serviceRequestResult
·	·	! 5
.
·	·	5 6
Unwrap
·	·	6 <
(
·	·	< =
)
·	·	= >
;
·	·	> ?
return
‚	‚	 
await
‚	‚	 &
ProcessStreamWithRequest
‚	‚	 -
(
‚	‚	- .
protocolSystem
‚	‚	. <
,
‚	‚	< =
request
‚	‚	> E
,
‚	‚	E F
onStreamItem
‚	‚	G S
,
‚	‚	S T
	connectId
‚	‚	U ^
,
‚	‚	^ _
token
‚	‚	` e
)
‚	‚	e f
.
„	„	 
ConfigureAwait
„	„	 
(
„	„	 
false
„	„	 !
)
„	„	! "
;
„	„	" #
}
‰	‰	 
private
Ê	Ê	 
async
Ê	Ê	 
Task
Ê	Ê	 
<
Ê	Ê	 
Result
Ê	Ê	 
<
Ê	Ê	 
Unit
Ê	Ê	 "
,
Ê	Ê	" #
NetworkFailure
Ê	Ê	$ 2
>
Ê	Ê	2 3
>
Ê	Ê	3 4&
ProcessStreamWithRequest
Ê	Ê	5 M
(
Ê	Ê	M N$
EcliptixProtocolSystem
Á	Á	 
protocolSystem
Á	Á	 -
,
Á	Á	- .
ServiceRequest
Ë	Ë	 
request
Ë	Ë	 
,
Ë	Ë	 
Func
È	È	 
<
È	È	 
byte
È	È	 
[
È	È	 
]
È	È	 
,
È	È	 
Task
È	È	 
<
È	È	 
Result
È	È	  
<
È	È	  !
Unit
È	È	! %
,
È	È	% &
NetworkFailure
È	È	' 5
>
È	È	5 6
>
È	È	6 7
>
È	È	7 8
onStreamItem
È	È	9 E
,
È	È	E F
uint
Í	Í	 
	connectId
Í	Í	 
,
Í	Í	 
CancellationToken
Î	Î	 
token
Î	Î	 
)
Î	Î	  
{
Ï	Ï	 
if
Ì	Ì	 

(
Ì	Ì	 
	connectId
Ì	Ì	 
==
Ì	Ì	 
$num
Ì	Ì	 
)
Ì	Ì	 
{
Ó	Ó	 	
return
Ô	Ô	 
await
Ô	Ô	 #
ProcessStreamDirectly
Ô	Ô	 .
(
Ô	Ô	. /
protocolSystem
Ô	Ô	/ =
,
Ô	Ô	= >
request
Ô	Ô	? F
,
Ô	Ô	F G
onStreamItem
Ô	Ô	H T
,
Ô	Ô	T U
token
Ô	Ô	V [
)
Ô	Ô	[ \
.
Ô	Ô	\ ]
ConfigureAwait
Ô	Ô	] k
(
Ô	Ô	k l
false
Ô	Ô	l q
)
Ô	Ô	q r
;
Ô	Ô	r s
}
		 	
using
Ú	Ú	 %
CancellationTokenSource
Ú	Ú	 %
linkedTokenSource
Ú	Ú	& 7
=
Ú	Ú	8 9%
CancellationTokenSource
Ú	Ú	: Q
.
Ú	Ú	Q R%
CreateLinkedTokenSource
Ú	Ú	R i
(
Ú	Ú	i j
token
Ú	Ú	j o
)
Ú	Ú	o p
;
Ú	Ú	p q
_activeStreams
Û	Û	 
.
Û	Û	 
TryAdd
Û	Û	 
(
Û	Û	 
	connectId
Û	Û	 '
,
Û	Û	' (
linkedTokenSource
Û	Û	) :
)
Û	Û	: ;
;
Û	Û	; <
Result
ı	ı	 
<
ı	ı	 
RpcFlow
ı	ı	 
,
ı	ı	 
NetworkFailure
ı	ı	 &
>
ı	ı	& '
invokeResult
ı	ı	( 4
=
ı	ı	5 6
await
ˆ	ˆ	 
rpcServiceManager
ˆ	ˆ	 #
.
ˆ	ˆ	# $'
InvokeServiceRequestAsync
ˆ	ˆ	$ =
(
ˆ	ˆ	= >
request
ˆ	ˆ	> E
,
ˆ	ˆ	E F
linkedTokenSource
ˆ	ˆ	G X
.
ˆ	ˆ	X Y
Token
ˆ	ˆ	Y ^
)
ˆ	ˆ	^ _
.
ˆ	ˆ	_ `
ConfigureAwait
ˆ	ˆ	` n
(
ˆ	ˆ	n o
false
ˆ	ˆ	o t
)
ˆ	ˆ	t u
;
ˆ	ˆ	u v
if
¯	¯	 

(
¯	¯	 
invokeResult
¯	¯	 
.
¯	¯	 
IsErr
¯	¯	 
)
¯	¯	 
{
˘	˘	 	
return
˙	˙	 
Result
˙	˙	 
<
˙	˙	 
Unit
˙	˙	 
,
˙	˙	 
NetworkFailure
˙	˙	  .
>
˙	˙	. /
.
˙	˙	/ 0
Err
˙	˙	0 3
(
˙	˙	3 4
invokeResult
˙	˙	4 @
.
˙	˙	@ A
	UnwrapErr
˙	˙	A J
(
˙	˙	J K
)
˙	˙	K L
)
˙	˙	L M
;
˙	˙	M N
}
˚	˚	 	
Result
˝	˝	 
<
˝	˝	 
RpcFlow
˝	˝	 
.
˝	˝	 
InboundStream
˝	˝	 $
,
˝	˝	$ %
NetworkFailure
˝	˝	& 4
>
˝	˝	4 5
streamResult
˝	˝	6 B
=
˝	˝	C D 
ValidateStreamFlow
˝	˝	E W
(
˝	˝	W X
invokeResult
˝	˝	X d
.
˝	˝	d e
Unwrap
˝	˝	e k
(
˝	˝	k l
)
˝	˝	l m
)
˝	˝	m n
;
˝	˝	n o
if
˛	˛	 

(
˛	˛	 
streamResult
˛	˛	 
.
˛	˛	 
IsErr
˛	˛	 
)
˛	˛	 
{
ˇ	ˇ	 	
return
Ä
Ä
 
Result
Ä
Ä
 
<
Ä
Ä
 
Unit
Ä
Ä
 
,
Ä
Ä
 
NetworkFailure
Ä
Ä
  .
>
Ä
Ä
. /
.
Ä
Ä
/ 0
Err
Ä
Ä
0 3
(
Ä
Ä
3 4
streamResult
Ä
Ä
4 @
.
Ä
Ä
@ A
	UnwrapErr
Ä
Ä
A J
(
Ä
Ä
J K
)
Ä
Ä
K L
)
Ä
Ä
L M
;
Ä
Ä
M N
}
Å
Å
 	
RpcFlow
É
É
 
.
É
É
 
InboundStream
É
É
 
inboundStream
É
É
 +
=
É
É
, -
streamResult
É
É
. :
.
É
É
: ;
Unwrap
É
É
; A
(
É
É
A B
)
É
É
B C
;
É
É
C D
try
Ö
Ö
 
{
Ü
Ü
 	
await
á
á
 
foreach
á
á
 
(
á
á
 
Result
á
á
 !
<
á
á
! "
SecureEnvelope
á
á
" 0
,
á
á
0 1
NetworkFailure
á
á
2 @
>
á
á
@ A

streamItem
á
á
B L
in
á
á
M O
inboundStream
à
à
 (
.
à
à
( )
Stream
à
à
) /
.
à
à
/ 0
WithCancellation
à
à
0 @
(
à
à
@ A
linkedTokenSource
à
à
A R
.
à
à
R S
Token
à
à
S X
)
à
à
X Y
)
à
à
Y Z
{
â
â
 
if
ä
ä
 
(
ä
ä
 

streamItem
ä
ä
 
.
ä
ä
 
IsErr
ä
ä
 $
)
ä
ä
$ %
{
ã
ã
 
NetworkFailure
å
å
 "
failure
å
å
# *
=
å
å
+ ,

streamItem
å
å
- 7
.
å
å
7 8
	UnwrapErr
å
å
8 A
(
å
å
A B
)
å
å
B C
;
å
å
C D
NotifyStreamError
ç
ç
 %
(
ç
ç
% &
failure
ç
ç
& -
,
ç
ç
- .
	connectId
ç
ç
/ 8
)
ç
ç
8 9
;
ç
ç
9 :
return
é
é
 
Result
é
é
 !
<
é
é
! "
Unit
é
é
" &
,
é
é
& '
NetworkFailure
é
é
( 6
>
é
é
6 7
.
é
é
7 8
Err
é
é
8 ;
(
é
é
; <
failure
é
é
< C
)
é
é
C D
;
é
é
D E
}
è
è
 
SecureEnvelope
ë
ë
 
streamPayload
ë
ë
 ,
=
ë
ë
- .

streamItem
ë
ë
/ 9
.
ë
ë
9 :
Unwrap
ë
ë
: @
(
ë
ë
@ A
)
ë
ë
A B
;
ë
ë
B C
Result
í
í
 
<
í
í
 
byte
í
í
 
[
í
í
 
]
í
í
 
,
í
í
 
NetworkFailure
í
í
 -
>
í
í
- .
processResult
í
í
/ <
=
í
í
= >
await
ì
ì
 $
ProcessStreamItemAsync
ì
ì
 0
(
ì
ì
0 1
streamPayload
ì
ì
1 >
,
ì
ì
> ?
protocolSystem
ì
ì
@ N
,
ì
ì
N O
onStreamItem
ì
ì
P \
)
ì
ì
\ ]
.
ì
ì
] ^
ConfigureAwait
ì
ì
^ l
(
ì
ì
l m
false
ì
ì
m r
)
ì
ì
r s
;
ì
ì
s t
if
ï
ï
 
(
ï
ï
 
processResult
ï
ï
 !
.
ï
ï
! "
IsErr
ï
ï
" '
)
ï
ï
' (
{
ñ
ñ
 
continue
ó
ó
 
;
ó
ó
 
}
ò
ò
 
}
ô
ô
 
}
ö
ö
 	
catch
õ
õ
 
(
õ
õ
 (
OperationCanceledException
õ
õ
 )
)
õ
õ
) *
when
õ
õ
+ /
(
õ
õ
0 1
linkedTokenSource
õ
õ
1 B
.
õ
õ
B C
Token
õ
õ
C H
.
õ
õ
H I%
IsCancellationRequested
õ
õ
I `
)
õ
õ
` a
{
ú
ú
 	
}
ù
ù
 	
finally
û
û
 
{
ü
ü
 	!
CleanupActiveStream
†
†
 
(
†
†
  
	connectId
†
†
  )
)
†
†
) *
;
†
†
* +
}
°
°
 	!
NotifyStreamSuccess
£
£
 
(
£
£
 
	connectId
£
£
 %
)
£
£
% &
;
£
£
& '
return
•
•
 
Result
•
•
 
<
•
•
 
Unit
•
•
 
,
•
•
 
NetworkFailure
•
•
 *
>
•
•
* +
.
•
•
+ ,
Ok
•
•
, .
(
•
•
. /
Unit
•
•
/ 3
.
•
•
3 4
Value
•
•
4 9
)
•
•
9 :
;
•
•
: ;
}
¶
¶
 
private
®
®
 
static
®
®
 
Result
®
®
 
<
®
®
 
RpcFlow
®
®
 !
.
®
®
! "
InboundStream
®
®
" /
,
®
®
/ 0
NetworkFailure
®
®
1 ?
>
®
®
? @ 
ValidateStreamFlow
®
®
A S
(
®
®
S T
RpcFlow
®
®
T [
flow
®
®
\ `
)
®
®
` a
{
©
©
 
if
™
™
 

(
™
™
 
flow
™
™
 
is
™
™
 
not
™
™
 
RpcFlow
™
™
 
.
™
™
  
InboundStream
™
™
  -
inboundStream
™
™
. ;
)
™
™
; <
{
´
´
 	
return
¨
¨
 
Result
¨
¨
 
<
¨
¨
 
RpcFlow
¨
¨
 !
.
¨
¨
! "
InboundStream
¨
¨
" /
,
¨
¨
/ 0
NetworkFailure
¨
¨
1 ?
>
¨
¨
? @
.
¨
¨
@ A
Err
¨
¨
A D
(
¨
¨
D E
NetworkFailure
≠
≠
 
.
≠
≠
  
InvalidRequestType
≠
≠
 1
(
≠
≠
1 2
$"
≠
≠
2 4
$str
≠
≠
4 ]
{
≠
≠
] ^
flow
≠
≠
^ b
.
≠
≠
b c
GetType
≠
≠
c j
(
≠
≠
j k
)
≠
≠
k l
.
≠
≠
l m
Name
≠
≠
m q
}
≠
≠
q r
"
≠
≠
r s
)
≠
≠
s t
)
≠
≠
t u
;
≠
≠
u v
}
Æ
Æ
 	
return
∞
∞
 
Result
∞
∞
 
<
∞
∞
 
RpcFlow
∞
∞
 
.
∞
∞
 
InboundStream
∞
∞
 +
,
∞
∞
+ ,
NetworkFailure
∞
∞
- ;
>
∞
∞
; <
.
∞
∞
< =
Ok
∞
∞
= ?
(
∞
∞
? @
inboundStream
∞
∞
@ M
)
∞
∞
M N
;
∞
∞
N O
}
±
±
 
private
≥
≥
 
void
≥
≥
 
NotifyStreamError
≥
≥
 "
(
≥
≥
" #
NetworkFailure
≥
≥
# 1
failure
≥
≥
2 9
,
≥
≥
9 :
uint
≥
≥
; ?
	connectId
≥
≥
@ I
)
≥
≥
I J
{
¥
¥
 
Avalonia
µ
µ
 
.
µ
µ
 
	Threading
µ
µ
 
.
µ
µ
 

Dispatcher
µ
µ
 %
.
µ
µ
% &
UIThread
µ
µ
& .
.
µ
µ
. /
Post
µ
µ
/ 3
(
µ
µ
3 4
(
µ
µ
4 5
)
µ
µ
5 6
=>
µ
µ
7 9
{
∂
∂
 	
_
∑
∑
 
=
∑
∑
 !
connectivityService
∑
∑
 #
.
∑
∑
# $
PublishAsync
∑
∑
$ 0
(
∑
∑
0 1 
ConnectivityIntent
∏
∏
 "
.
∏
∏
" #
Disconnected
∏
∏
# /
(
∏
∏
/ 0
failure
∏
∏
0 7
,
∏
∏
7 8
	connectId
∏
∏
9 B
)
∏
∏
B C
)
∏
∏
C D
.
∏
∏
D E
ContinueWith
∏
∏
E Q
(
∏
∏
Q R
task
π
π
 
=>
π
π
 
{
∫
∫
 
if
ª
ª
 
(
ª
ª
 
task
ª
ª
 
.
ª
ª
 
	IsFaulted
ª
ª
 &
&&
ª
ª
' )
task
ª
ª
* .
.
ª
ª
. /
	Exception
ª
ª
/ 8
!=
ª
ª
9 ;
null
ª
ª
< @
)
ª
ª
@ A
{
º
º
 
Log
Ω
Ω
 
.
Ω
Ω
 
Error
Ω
Ω
 !
(
Ω
Ω
! "
task
Ω
Ω
" &
.
Ω
Ω
& '
	Exception
Ω
Ω
' 0
,
Ω
Ω
0 1
$str
Ω
Ω
2 x
)
Ω
Ω
x y
;
Ω
Ω
y z
}
æ
æ
 
}
ø
ø
 
,
ø
ø
 
TaskScheduler
¿
¿
 
.
¿
¿
 
Default
¿
¿
 %
)
¿
¿
% &
;
¿
¿
& '
}
¡
¡
 	
)
¡
¡
	 

;
¡
¡

 
}
¬
¬
 
private
ƒ
ƒ
 
static
ƒ
ƒ
 
async
ƒ
ƒ
 
Task
ƒ
ƒ
 
<
ƒ
ƒ
 
Result
ƒ
ƒ
 $
<
ƒ
ƒ
$ %
byte
ƒ
ƒ
% )
[
ƒ
ƒ
) *
]
ƒ
ƒ
* +
,
ƒ
ƒ
+ ,
NetworkFailure
ƒ
ƒ
- ;
>
ƒ
ƒ
; <
>
ƒ
ƒ
< =$
ProcessStreamItemAsync
ƒ
ƒ
> T
(
ƒ
ƒ
T U
SecureEnvelope
≈
≈
 
envelope
≈
≈
 
,
≈
≈
  $
EcliptixProtocolSystem
∆
∆
 
protocolSystem
∆
∆
 -
,
∆
∆
- .
Func
«
«
 
<
«
«
 
byte
«
«
 
[
«
«
 
]
«
«
 
,
«
«
 
Task
«
«
 
<
«
«
 
Result
«
«
  
<
«
«
  !
Unit
«
«
! %
,
«
«
% &
NetworkFailure
«
«
' 5
>
«
«
5 6
>
«
«
6 7
>
«
«
7 8
onStreamItem
«
«
9 E
)
«
«
E F
{
»
»
 
Result
…
…
 
<
…
…
 
byte
…
…
 
[
…
…
 
]
…
…
 
,
…
…
 %
EcliptixProtocolFailure
…
…
 .
>
…
…
. /
decryptResult
…
…
0 =
=
…
…
> ?
protocolSystem
 
 
 
.
 
 
 $
ProcessInboundEnvelope
 
 
 1
(
 
 
1 2
envelope
 
 
2 :
)
 
 
: ;
;
 
 
; <
if
Ã
Ã
 

(
Ã
Ã
 
decryptResult
Ã
Ã
 
.
Ã
Ã
 
IsErr
Ã
Ã
 
)
Ã
Ã
  
{
Õ
Õ
 	
return
Œ
Œ
 
Result
Œ
Œ
 
<
Œ
Œ
 
byte
Œ
Œ
 
[
Œ
Œ
 
]
Œ
Œ
  
,
Œ
Œ
  !
NetworkFailure
Œ
Œ
" 0
>
Œ
Œ
0 1
.
Œ
Œ
1 2
Err
Œ
Œ
2 5
(
Œ
Œ
5 6
NetworkFailure
œ
œ
 
.
œ
œ
  
InvalidRequestType
œ
œ
 1
(
œ
œ
1 2
$str
œ
œ
2 Q
)
œ
œ
Q R
)
œ
œ
R S
;
œ
œ
S T
}
–
–
 	
byte
“
“
 
[
“
“
 
]
“
“
 
decryptedData
“
“
 
=
“
“
 
decryptResult
“
“
 ,
.
“
“
, -
Unwrap
“
“
- 3
(
“
“
3 4
)
“
“
4 5
;
“
“
5 6
Result
”
”
 
<
”
”
 
Unit
”
”
 
,
”
”
 
NetworkFailure
”
”
 #
>
”
”
# $

itemResult
”
”
% /
=
”
”
0 1
await
”
”
2 7
onStreamItem
”
”
8 D
(
”
”
D E
decryptedData
”
”
E R
)
”
”
R S
.
”
”
S T
ConfigureAwait
”
”
T b
(
”
”
b c
false
”
”
c h
)
”
”
h i
;
”
”
i j
if
’
’
 

(
’
’
 

itemResult
’
’
 
.
’
’
 
IsErr
’
’
 
)
’
’
 
{
÷
÷
 	
return
◊
◊
 
Result
◊
◊
 
<
◊
◊
 
byte
◊
◊
 
[
◊
◊
 
]
◊
◊
  
,
◊
◊
  !
NetworkFailure
◊
◊
" 0
>
◊
◊
0 1
.
◊
◊
1 2
Err
◊
◊
2 5
(
◊
◊
5 6

itemResult
◊
◊
6 @
.
◊
◊
@ A
	UnwrapErr
◊
◊
A J
(
◊
◊
J K
)
◊
◊
K L
)
◊
◊
L M
;
◊
◊
M N
}
ÿ
ÿ
 	
return
⁄
⁄
 
Result
⁄
⁄
 
<
⁄
⁄
 
byte
⁄
⁄
 
[
⁄
⁄
 
]
⁄
⁄
 
,
⁄
⁄
 
NetworkFailure
⁄
⁄
 ,
>
⁄
⁄
, -
.
⁄
⁄
- .
Ok
⁄
⁄
. 0
(
⁄
⁄
0 1
decryptedData
⁄
⁄
1 >
)
⁄
⁄
> ?
;
⁄
⁄
? @
}
€
€
 
private
›
›
 
void
›
›
 !
CleanupActiveStream
›
›
 $
(
›
›
$ %
uint
›
›
% )
	connectId
›
›
* 3
)
›
›
3 4
{
ﬁ
ﬁ
 
_activeStreams
ﬂ
ﬂ
 
.
ﬂ
ﬂ
 
	TryRemove
ﬂ
ﬂ
  
(
ﬂ
ﬂ
  !
	connectId
ﬂ
ﬂ
! *
,
ﬂ
ﬂ
* +
out
ﬂ
ﬂ
, /
_
ﬂ
ﬂ
0 1
)
ﬂ
ﬂ
1 2
;
ﬂ
ﬂ
2 3
}
‡
‡
 
private
‚
‚
 
void
‚
‚
 !
NotifyStreamSuccess
‚
‚
 $
(
‚
‚
$ %
uint
‚
‚
% )
	connectId
‚
‚
* 3
)
‚
‚
3 4
{
„
„
 
bool
‰
‰
 
exitedOutage
‰
‰
 
=
‰
‰
 
Interlocked
‰
‰
 '
.
‰
‰
' (
CompareExchange
‰
‰
( 7
(
‰
‰
7 8
ref
‰
‰
8 ;
_outageState
‰
‰
< H
,
‰
‰
H I
$num
‰
‰
J K
,
‰
‰
K L
$num
‰
‰
M N
)
‰
‰
N O
==
‰
‰
P R
$num
‰
‰
S T
;
‰
‰
T U
if
Ê
Ê
 

(
Ê
Ê
 
!
Ê
Ê
 
exitedOutage
Ê
Ê
 
)
Ê
Ê
 
{
Á
Á
 	
return
Ë
Ë
 
;
Ë
Ë
 
}
È
È
 	
lock
Î
Î
 
(
Î
Î
 
_outageLock
Î
Î
 
)
Î
Î
 
{
Ï
Ï
 	
if
Ì
Ì
 
(
Ì
Ì
 
!
Ì
Ì
 %
_outageCompletionSource
Ì
Ì
 (
.
Ì
Ì
( )
Task
Ì
Ì
) -
.
Ì
Ì
- .
IsCompleted
Ì
Ì
. 9
)
Ì
Ì
9 :
{
Ó
Ó
 %
_outageCompletionSource
Ô
Ô
 '
.
Ô
Ô
' (
TrySetResult
Ô
Ô
( 4
(
Ô
Ô
4 5
true
Ô
Ô
5 9
)
Ô
Ô
9 :
;
Ô
Ô
: ;
}


 
}
Ò
Ò
 	
Avalonia
Û
Û
 
.
Û
Û
 
	Threading
Û
Û
 
.
Û
Û
 

Dispatcher
Û
Û
 %
.
Û
Û
% &
UIThread
Û
Û
& .
.
Û
Û
. /
Post
Û
Û
/ 3
(
Û
Û
3 4
(
Û
Û
4 5
)
Û
Û
5 6
=>
Û
Û
7 9
{
Ù
Ù
 	
_
ı
ı
 
=
ı
ı
 !
connectivityService
ı
ı
 #
.
ı
ı
# $
PublishAsync
ı
ı
$ 0
(
ı
ı
0 1 
ConnectivityIntent
ˆ
ˆ
 "
.
ˆ
ˆ
" #
	Connected
ˆ
ˆ
# ,
(
ˆ
ˆ
, -
	connectId
ˆ
ˆ
- 6
)
ˆ
ˆ
6 7
)
ˆ
ˆ
7 8
.
ˆ
ˆ
8 9
ContinueWith
ˆ
ˆ
9 E
(
ˆ
ˆ
E F
task
˜
˜
 
=>
˜
˜
 
{
¯
¯
 
if
˘
˘
 
(
˘
˘
 
task
˘
˘
 
.
˘
˘
 
	IsFaulted
˘
˘
 &
&&
˘
˘
' )
task
˘
˘
* .
.
˘
˘
. /
	Exception
˘
˘
/ 8
!=
˘
˘
9 ;
null
˘
˘
< @
)
˘
˘
@ A
{
˙
˙
 
Log
˚
˚
 
.
˚
˚
 
Error
˚
˚
 !
(
˚
˚
! "
task
˚
˚
" &
.
˚
˚
& '
	Exception
˚
˚
' 0
,
˚
˚
0 1
$str
˚
˚
2 u
)
˚
˚
u v
;
˚
˚
v w
}
¸
¸
 
}
˝
˝
 
,
˝
˝
 
TaskScheduler
˛
˛
 
.
˛
˛
 
Default
˛
˛
 %
)
˛
˛
% &
;
˛
˛
& '
}
ˇ
ˇ
 	
)
ˇ
ˇ
	 

;
ˇ
ˇ

 
}
ÄÄ 
private
ÇÇ 
async
ÇÇ 
Task
ÇÇ 
<
ÇÇ 
Result
ÇÇ 
<
ÇÇ 
Unit
ÇÇ "
,
ÇÇ" #
NetworkFailure
ÇÇ$ 2
>
ÇÇ2 3
>
ÇÇ3 4#
ProcessStreamDirectly
ÇÇ5 J
(
ÇÇJ K$
EcliptixProtocolSystem
ÉÉ 
protocolSystem
ÉÉ -
,
ÉÉ- .
ServiceRequest
ÑÑ 
request
ÑÑ 
,
ÑÑ 
Func
ÖÖ 
<
ÖÖ 
byte
ÖÖ 
[
ÖÖ 
]
ÖÖ 
,
ÖÖ 
Task
ÖÖ 
<
ÖÖ 
Result
ÖÖ  
<
ÖÖ  !
Unit
ÖÖ! %
,
ÖÖ% &
NetworkFailure
ÖÖ' 5
>
ÖÖ5 6
>
ÖÖ6 7
>
ÖÖ7 8
onStreamItem
ÖÖ9 E
,
ÖÖE F
CancellationToken
ÜÜ 
token
ÜÜ 
)
ÜÜ  
{
áá 
Result
àà 
<
àà 
RpcFlow
àà 
,
àà 
NetworkFailure
àà &
>
àà& '
invokeResult
àà( 4
=
àà5 6
await
ââ 
rpcServiceManager
ââ #
.
ââ# $'
InvokeServiceRequestAsync
ââ$ =
(
ââ= >
request
ââ> E
,
ââE F
token
ââG L
)
ââL M
.
ââM N
ConfigureAwait
ââN \
(
ââ\ ]
false
ââ] b
)
ââb c
;
ââc d
if
ãã 

(
ãã 
invokeResult
ãã 
.
ãã 
IsErr
ãã 
)
ãã 
{
åå 	
return
çç 
Result
çç 
<
çç 
Unit
çç 
,
çç 
NetworkFailure
çç  .
>
çç. /
.
çç/ 0
Err
çç0 3
(
çç3 4
invokeResult
çç4 @
.
çç@ A
	UnwrapErr
ççA J
(
ççJ K
)
ççK L
)
ççL M
;
ççM N
}
éé 	
RpcFlow
êê 
flow
êê 
=
êê 
invokeResult
êê #
.
êê# $
Unwrap
êê$ *
(
êê* +
)
êê+ ,
;
êê, -
if
ëë 

(
ëë 
flow
ëë 
is
ëë 
not
ëë 
RpcFlow
ëë 
.
ëë  
InboundStream
ëë  -
inboundStream
ëë. ;
)
ëë; <
{
íí 	
return
ìì 
Result
ìì 
<
ìì 
Unit
ìì 
,
ìì 
NetworkFailure
ìì  .
>
ìì. /
.
ìì/ 0
Err
ìì0 3
(
ìì3 4
NetworkFailure
îî 
.
îî  
InvalidRequestType
îî 1
(
îî1 2
$"
îî2 4
$str
îî4 ]
{
îî] ^
flow
îî^ b
.
îîb c
GetType
îîc j
(
îîj k
)
îîk l
.
îîl m
Name
îîm q
}
îîq r
"
îîr s
)
îîs t
)
îît u
;
îîu v
}
ïï 	
await
óó 
foreach
óó 
(
óó 
Result
óó 
<
óó 
SecureEnvelope
óó ,
,
óó, -
NetworkFailure
óó. <
>
óó< =

streamItem
óó> H
in
óóI K
inboundStream
òò $
.
òò$ %
Stream
òò% +
.
òò+ ,
WithCancellation
òò, <
(
òò< =
token
òò= B
)
òòB C
)
òòC D
{
ôô 	
if
öö 
(
öö 

streamItem
öö 
.
öö 
IsErr
öö  
)
öö  !
{
õõ 
continue
úú 
;
úú 
}
ùù 
SecureEnvelope
üü 
streamPayload
üü (
=
üü) *

streamItem
üü+ 5
.
üü5 6
Unwrap
üü6 <
(
üü< =
)
üü= >
;
üü> ?
Result
†† 
<
†† 
byte
†† 
[
†† 
]
†† 
,
†† %
EcliptixProtocolFailure
†† 2
>
††2 3!
streamDecryptedData
††4 G
=
††H I
protocolSystem
°° 
.
°° $
ProcessInboundEnvelope
°° 5
(
°°5 6
streamPayload
°°6 C
)
°°C D
;
°°D E
if
¢¢ 
(
¢¢ !
streamDecryptedData
¢¢ #
.
¢¢# $
IsErr
¢¢$ )
)
¢¢) *
{
££ 
continue
§§ 
;
§§ 
}
•• 
await
ßß 
onStreamItem
ßß 
(
ßß !
streamDecryptedData
ßß 2
.
ßß2 3
Unwrap
ßß3 9
(
ßß9 :
)
ßß: ;
)
ßß; <
.
ßß< =
ConfigureAwait
ßß= K
(
ßßK L
false
ßßL Q
)
ßßQ R
;
ßßR S
}
®® 	
return
™™ 
Result
™™ 
<
™™ 
Unit
™™ 
,
™™ 
NetworkFailure
™™ *
>
™™* +
.
™™+ ,
Ok
™™, .
(
™™. /
Unit
™™/ 3
.
™™3 4
Value
™™4 9
)
™™9 :
;
™™: ;
}
´´ 
private
≠≠ 
async
≠≠ 
Task
≠≠ 
<
≠≠ 
Result
≠≠ 
<
≠≠ 
Unit
≠≠ "
,
≠≠" #
NetworkFailure
≠≠$ 2
>
≠≠2 3
>
≠≠3 4(
SendSendStreamRequestAsync
≠≠5 O
(
≠≠O P$
EcliptixProtocolSystem
ÆÆ 
protocolSystem
ÆÆ -
,
ÆÆ- .
uint
ØØ  
logicalOperationId
ØØ 
,
ØØ  
RpcServiceType
∞∞ 
serviceType
∞∞ "
,
∞∞" #
byte
±± 
[
±± 
]
±± 
plainBuffer
±± 
,
±± 
ServiceFlowType
≤≤ 
flowType
≤≤  
,
≤≤  !
RpcRequestContext
≥≥ 
requestContext
≥≥ (
,
≥≥( )
CancellationToken
¥¥ 
token
¥¥ 
)
¥¥  
{
µµ 
Result
∂∂ 
<
∂∂ 
ServiceRequest
∂∂ 
,
∂∂ 
NetworkFailure
∂∂ -
>
∂∂- ."
serviceRequestResult
∂∂/ C
=
∂∂D E 
BuildRequestWithId
∂∂F X
(
∂∂X Y
protocolSystem
∑∑ 
,
∑∑  
logicalOperationId
∑∑ .
,
∑∑. /
serviceType
∑∑0 ;
,
∑∑; <
plainBuffer
∑∑= H
,
∑∑H I
flowType
∑∑J R
,
∑∑R S
requestContext
∑∑T b
)
∑∑b c
;
∑∑c d
if
ππ 

(
ππ "
serviceRequestResult
ππ  
.
ππ  !
IsErr
ππ! &
)
ππ& '
{
∫∫ 	
return
ªª 
Result
ªª 
<
ªª 
Unit
ªª 
,
ªª 
NetworkFailure
ªª  .
>
ªª. /
.
ªª/ 0
Err
ªª0 3
(
ªª3 4"
serviceRequestResult
ªª4 H
.
ªªH I
	UnwrapErr
ªªI R
(
ªªR S
)
ªªS T
)
ªªT U
;
ªªU V
}
ºº 	
ServiceRequest
ææ 
request
ææ 
=
ææ  "
serviceRequestResult
ææ! 5
.
ææ5 6
Unwrap
ææ6 <
(
ææ< =
)
ææ= >
;
ææ> ?
Result
¿¿ 
<
¿¿ 
RpcFlow
¿¿ 
,
¿¿ 
NetworkFailure
¿¿ &
>
¿¿& '
invokeResult
¿¿( 4
=
¿¿5 6
await
¡¡ 
rpcServiceManager
¡¡ #
.
¡¡# $'
InvokeServiceRequestAsync
¡¡$ =
(
¡¡= >
request
¡¡> E
,
¡¡E F
token
¡¡G L
)
¡¡L M
.
¡¡M N
ConfigureAwait
¡¡N \
(
¡¡\ ]
false
¡¡] b
)
¡¡b c
;
¡¡c d
if
√√ 

(
√√ 
invokeResult
√√ 
.
√√ 
IsErr
√√ 
)
√√ 
{
ƒƒ 	
return
≈≈ 
Result
≈≈ 
<
≈≈ 
Unit
≈≈ 
,
≈≈ 
NetworkFailure
≈≈  .
>
≈≈. /
.
≈≈/ 0
Err
≈≈0 3
(
≈≈3 4
invokeResult
≈≈4 @
.
≈≈@ A
	UnwrapErr
≈≈A J
(
≈≈J K
)
≈≈K L
)
≈≈L M
;
≈≈M N
}
∆∆ 	
RpcFlow
»» 
flow
»» 
=
»» 
invokeResult
»» #
.
»»# $
Unwrap
»»$ *
(
»»* +
)
»»+ ,
;
»», -
if
…… 

(
…… 
flow
…… 
is
…… 
not
…… 
RpcFlow
…… 
.
……  
OutboundSink
……  ,
)
……, -
{
   	
return
ÀÀ 
Result
ÀÀ 
<
ÀÀ 
Unit
ÀÀ 
,
ÀÀ 
NetworkFailure
ÀÀ  .
>
ÀÀ. /
.
ÀÀ/ 0
Err
ÀÀ0 3
(
ÀÀ3 4
NetworkFailure
ÃÃ 
.
ÃÃ  
InvalidRequestType
ÃÃ 1
(
ÃÃ1 2
$"
ÃÃ2 4
$str
ÃÃ4 \
{
ÃÃ\ ]
flow
ÃÃ] a
.
ÃÃa b
GetType
ÃÃb i
(
ÃÃi j
)
ÃÃj k
.
ÃÃk l
Name
ÃÃl p
}
ÃÃp q
"
ÃÃq r
)
ÃÃr s
)
ÃÃs t
;
ÃÃt u
}
ÕÕ 	
return
œœ 
Result
œœ 
<
œœ 
Unit
œœ 
,
œœ 
NetworkFailure
œœ *
>
œœ* +
.
œœ+ ,
Err
œœ, /
(
œœ/ 0
NetworkFailure
–– 
.
––  
InvalidRequestType
–– -
(
––- .
$str
––. W
)
––W X
)
––X Y
;
––Y Z
}
—— 
private
”” 
async
”” 
Task
”” 
<
”” 
Result
”” 
<
”” 
Unit
”” "
,
””" #
NetworkFailure
””$ 2
>
””2 3
>
””3 41
#SendBidirectionalStreamRequestAsync
””5 X
(
””X Y$
EcliptixProtocolSystem
‘‘ 
protocolSystem
‘‘ -
,
‘‘- .
uint
’’  
logicalOperationId
’’ 
,
’’  
RpcServiceType
÷÷ 
serviceType
÷÷ "
,
÷÷" #
byte
◊◊ 
[
◊◊ 
]
◊◊ 
plainBuffer
◊◊ 
,
◊◊ 
ServiceFlowType
ÿÿ 
flowType
ÿÿ  
,
ÿÿ  !
RpcRequestContext
ŸŸ 
requestContext
ŸŸ (
,
ŸŸ( )
CancellationToken
⁄⁄ 
token
⁄⁄ 
)
⁄⁄  
{
€€ 
Result
‹‹ 
<
‹‹ 
ServiceRequest
‹‹ 
,
‹‹ 
NetworkFailure
‹‹ -
>
‹‹- ."
serviceRequestResult
‹‹/ C
=
‹‹D E 
BuildRequestWithId
‹‹F X
(
‹‹X Y
protocolSystem
›› 
,
››  
logicalOperationId
›› .
,
››. /
serviceType
››0 ;
,
››; <
plainBuffer
››= H
,
››H I
flowType
››J R
,
››R S
requestContext
››T b
)
››b c
;
››c d
if
ﬂﬂ 

(
ﬂﬂ "
serviceRequestResult
ﬂﬂ  
.
ﬂﬂ  !
IsErr
ﬂﬂ! &
)
ﬂﬂ& '
{
‡‡ 	
return
·· 
Result
·· 
<
·· 
Unit
·· 
,
·· 
NetworkFailure
··  .
>
··. /
.
··/ 0
Err
··0 3
(
··3 4"
serviceRequestResult
··4 H
.
··H I
	UnwrapErr
··I R
(
··R S
)
··S T
)
··T U
;
··U V
}
‚‚ 	
ServiceRequest
‰‰ 
request
‰‰ 
=
‰‰  "
serviceRequestResult
‰‰! 5
.
‰‰5 6
Unwrap
‰‰6 <
(
‰‰< =
)
‰‰= >
;
‰‰> ?
Result
ÊÊ 
<
ÊÊ 
RpcFlow
ÊÊ 
,
ÊÊ 
NetworkFailure
ÊÊ &
>
ÊÊ& '
invokeResult
ÊÊ( 4
=
ÊÊ5 6
await
ÁÁ 
rpcServiceManager
ÁÁ #
.
ÁÁ# $'
InvokeServiceRequestAsync
ÁÁ$ =
(
ÁÁ= >
request
ÁÁ> E
,
ÁÁE F
token
ÁÁG L
)
ÁÁL M
.
ÁÁM N
ConfigureAwait
ÁÁN \
(
ÁÁ\ ]
false
ÁÁ] b
)
ÁÁb c
;
ÁÁc d
if
ÈÈ 

(
ÈÈ 
invokeResult
ÈÈ 
.
ÈÈ 
IsErr
ÈÈ 
)
ÈÈ 
{
ÍÍ 	
return
ÎÎ 
Result
ÎÎ 
<
ÎÎ 
Unit
ÎÎ 
,
ÎÎ 
NetworkFailure
ÎÎ  .
>
ÎÎ. /
.
ÎÎ/ 0
Err
ÎÎ0 3
(
ÎÎ3 4
invokeResult
ÎÎ4 @
.
ÎÎ@ A
	UnwrapErr
ÎÎA J
(
ÎÎJ K
)
ÎÎK L
)
ÎÎL M
;
ÎÎM N
}
ÏÏ 	
RpcFlow
ÓÓ 
flow
ÓÓ 
=
ÓÓ 
invokeResult
ÓÓ #
.
ÓÓ# $
Unwrap
ÓÓ$ *
(
ÓÓ* +
)
ÓÓ+ ,
;
ÓÓ, -
if
ÔÔ 

(
ÔÔ 
flow
ÔÔ 
is
ÔÔ 
not
ÔÔ 
RpcFlow
ÔÔ 
.
ÔÔ  !
BidirectionalStream
ÔÔ  3
)
ÔÔ3 4
{
 	
return
ÒÒ 
Result
ÒÒ 
<
ÒÒ 
Unit
ÒÒ 
,
ÒÒ 
NetworkFailure
ÒÒ  .
>
ÒÒ. /
.
ÒÒ/ 0
Err
ÒÒ0 3
(
ÒÒ3 4
NetworkFailure
ÚÚ 
.
ÚÚ  
InvalidRequestType
ÚÚ 1
(
ÚÚ1 2
$"
ÛÛ 
$str
ÛÛ E
{
ÛÛE F
flow
ÛÛF J
.
ÛÛJ K
GetType
ÛÛK R
(
ÛÛR S
)
ÛÛS T
.
ÛÛT U
Name
ÛÛU Y
}
ÛÛY Z
"
ÛÛZ [
)
ÛÛ[ \
)
ÛÛ\ ]
;
ÛÛ] ^
}
ÙÙ 	
return
ˆˆ 
Result
ˆˆ 
<
ˆˆ 
Unit
ˆˆ 
,
ˆˆ 
NetworkFailure
ˆˆ *
>
ˆˆ* +
.
ˆˆ+ ,
Err
ˆˆ, /
(
ˆˆ/ 0
NetworkFailure
˜˜ 
.
˜˜  
InvalidRequestType
˜˜ -
(
˜˜- .
$str
˜˜. ^
)
˜˜^ _
)
˜˜_ `
;
˜˜` a
}
¯¯ 
private
˙˙ 
async
˙˙ 
Task
˙˙ (
WaitForOutageRecoveryAsync
˙˙ 1
(
˙˙1 2
CancellationToken
˙˙2 C
token
˙˙D I
,
˙˙I J
bool
˙˙K O
waitForRecovery
˙˙P _
=
˙˙` a
true
˙˙b f
)
˙˙f g
{
˚˚ 
if
¸¸ 

(
¸¸ 
Volatile
¸¸ 
.
¸¸ 
Read
¸¸ 
(
¸¸ 
ref
¸¸ 
_outageState
¸¸ *
)
¸¸* +
==
¸¸, .
$num
¸¸/ 0
)
¸¸0 1
{
˝˝ 	
return
˛˛ 
;
˛˛ 
}
ˇˇ 	
if
ÅÅ 

(
ÅÅ 
!
ÅÅ 
waitForRecovery
ÅÅ 
)
ÅÅ 
{
ÇÇ 	
return
ÉÉ 
;
ÉÉ 
}
ÑÑ 	
Task
ÜÜ 
waitTask
ÜÜ 
;
ÜÜ 
lock
áá 
(
áá 
_outageLock
áá 
)
áá 
{
àà 	
waitTask
ââ 
=
ââ %
_outageCompletionSource
ââ .
.
ââ. /
Task
ââ/ 3
;
ââ3 4
}
ää 	
using
åå %
CancellationTokenSource
åå %
cts
åå& )
=
åå* +%
CancellationTokenSource
çç #
.
çç# $%
CreateLinkedTokenSource
çç$ ;
(
çç; <
token
çç< A
,
ççA B(
_shutdownCancellationToken
ççC ]
.
çç] ^
Token
çç^ c
)
ççc d
;
ççd e
cts
éé 
.
éé 
CancelAfter
éé 
(
éé 
NetworkConstants
éé (
.
éé( )
Timeouts
éé) 1
.
éé1 2#
OutageRecoveryTimeout
éé2 G
)
ééG H
;
ééH I
try
êê 
{
ëë 	
await
íí 
waitTask
íí 
.
íí 
	WaitAsync
íí $
(
íí$ %
cts
íí% (
.
íí( )
Token
íí) .
)
íí. /
.
íí/ 0
ConfigureAwait
íí0 >
(
íí> ?
false
íí? D
)
ííD E
;
ííE F
}
ìì 	
catch
îî 
(
îî (
OperationCanceledException
îî )
)
îî) *
when
îî+ /
(
îî0 1(
_shutdownCancellationToken
îî1 K
.
îîK L
Token
îîL Q
.
îîQ R%
IsCancellationRequested
îîR i
)
îîi j
{
ïï 	
throw
ññ 
new
ññ %
ObjectDisposedException
ññ -
(
ññ- .
nameof
ññ. 4
(
ññ4 5
NetworkProvider
ññ5 D
)
ññD E
,
ññE F
$str
ññG b
)
ññb c
;
ññc d
}
óó 	
catch
òò 
(
òò (
OperationCanceledException
òò )
)
òò) *
when
òò+ /
(
òò0 1
token
òò1 6
.
òò6 7%
IsCancellationRequested
òò7 N
)
òòN O
{
ôô 	
throw
öö 
;
öö 
}
õõ 	
catch
úú 
(
úú (
OperationCanceledException
úú )
)
úú) *
{
ùù 	
throw
ûû 
new
ûû 
TimeoutException
ûû &
(
ûû& '
$str
üü f
)
üüf g
;
üüg h
}
†† 	
}
°° 
internal
££ 
void
££ 

ExitOutage
££ 
(
££ 
)
££ 
{
§§ 
if
•• 

(
•• 
Interlocked
•• 
.
•• 
Exchange
••  
(
••  !
ref
••! $
_outageState
••% 1
,
••1 2
$num
••3 4
)
••4 5
==
••6 8
$num
••9 :
)
••: ;
{
¶¶ 	
return
ßß 
;
ßß 
}
®® 	+
CancelConnectionRecoveryToken
™™ %
(
™™% &
)
™™& '
;
™™' (
lock
¨¨ 
(
¨¨ 
_outageLock
¨¨ 
)
¨¨ 
{
≠≠ 	
if
ÆÆ 
(
ÆÆ 
!
ÆÆ %
_outageCompletionSource
ÆÆ (
.
ÆÆ( )
Task
ÆÆ) -
.
ÆÆ- .
IsCompleted
ÆÆ. 9
)
ÆÆ9 :
{
ØØ %
_outageCompletionSource
∞∞ '
.
∞∞' (
TrySetResult
∞∞( 4
(
∞∞4 5
true
∞∞5 9
)
∞∞9 :
;
∞∞: ;
}
±± 
}
≤≤ 	
Avalonia
¥¥ 
.
¥¥ 
	Threading
¥¥ 
.
¥¥ 

Dispatcher
¥¥ %
.
¥¥% &
UIThread
¥¥& .
.
¥¥. /
Post
¥¥/ 3
(
¥¥3 4
(
¥¥4 5
)
¥¥5 6
=>
¥¥7 9
{
µµ 	!
connectivityService
∂∂ 
.
∂∂  
PublishAsync
∂∂  ,
(
∂∂, - 
ConnectivityIntent
∑∑ "
.
∑∑" #
	Connected
∑∑# ,
(
∑∑, -
)
∑∑- .
)
∑∑. /
.
∑∑/ 0
ContinueWith
∑∑0 <
(
∑∑< =
task
∏∏ 
=>
∏∏ 
{
ππ 
if
∫∫ 
(
∫∫ 
task
∫∫ 
.
∫∫ 
	IsFaulted
∫∫ &
&&
∫∫' )
task
∫∫* .
.
∫∫. /
	Exception
∫∫/ 8
!=
∫∫9 ;
null
∫∫< @
)
∫∫@ A
{
ªª 
Log
ºº 
.
ºº 
Error
ºº !
(
ºº! "
task
ºº" &
.
ºº& '
	Exception
ºº' 0
,
ºº0 1
$str
ºº2 u
)
ººu v
;
ººv w
}
ΩΩ 
}
ææ 
,
ææ 
TaskScheduler
øø 
.
øø 
Default
øø %
)
øø% &
;
øø& '
}
¿¿ 	
)
¿¿	 

;
¿¿
 
}
¡¡ 
private
√√ 
CancellationToken
√√ (
GetConnectionRecoveryToken
√√ 8
(
√√8 9
)
√√9 :
=>
√√; =+
EnsureConnectionRecoveryToken
√√> [
(
√√[ \
)
√√\ ]
;
√√] ^
private
≈≈ 
CancellationToken
≈≈ +
EnsureConnectionRecoveryToken
≈≈ ;
(
≈≈; <
)
≈≈< =
{
∆∆ 
lock
«« 
(
«« 
_cancellationLock
«« 
)
««  
{
»» 	
if
…… 
(
…… $
_connectionRecoveryCts
…… &
==
……' )
null
……* .
||
……/ 1$
_connectionRecoveryCts
……2 H
.
……H I%
IsCancellationRequested
……I `
)
……` a
{
   $
_connectionRecoveryCts
ÀÀ &
?
ÀÀ& '
.
ÀÀ' (
Dispose
ÀÀ( /
(
ÀÀ/ 0
)
ÀÀ0 1
;
ÀÀ1 2
if
ÕÕ 
(
ÕÕ (
_shutdownCancellationToken
ÕÕ .
.
ÕÕ. /%
IsCancellationRequested
ÕÕ/ F
)
ÕÕF G
{
ŒŒ 
return
œœ (
_shutdownCancellationToken
œœ 5
.
œœ5 6
Token
œœ6 ;
;
œœ; <
}
–– $
_connectionRecoveryCts
““ &
=
““' (%
CancellationTokenSource
”” +
.
””+ ,%
CreateLinkedTokenSource
””, C
(
””C D(
_shutdownCancellationToken
””D ^
.
””^ _
Token
””_ d
)
””d e
;
””e f
}
‘‘ 
return
÷÷ $
_connectionRecoveryCts
÷÷ )
.
÷÷) *
Token
÷÷* /
;
÷÷/ 0
}
◊◊ 	
}
ÿÿ 
internal
⁄⁄ 
void
⁄⁄ 2
$BeginSecrecyChannelEstablishRecovery
⁄⁄ 6
(
⁄⁄6 7
)
⁄⁄7 8
{
€€ 
if
‹‹ 

(
‹‹ 
	_disposed
‹‹ 
||
‹‹ (
_shutdownCancellationToken
‹‹ 3
.
‹‹3 4%
IsCancellationRequested
‹‹4 K
)
‹‹K L
{
›› 	
return
ﬁﬁ 
;
ﬁﬁ 
}
ﬂﬂ 	
bool
·· 
enteredOutage
·· 
=
·· 
Interlocked
·· (
.
··( )
CompareExchange
··) 8
(
··8 9
ref
··9 <
_outageState
··= I
,
··I J
$num
··K L
,
··L M
$num
··N O
)
··O P
==
··Q S
$num
··T U
;
··U V
if
‚‚ 

(
‚‚ 
enteredOutage
‚‚ 
)
‚‚ 
{
„„ 	
lock
‰‰ 
(
‰‰ 
_outageLock
‰‰ 
)
‰‰ 
{
ÂÂ 
if
ÊÊ 
(
ÊÊ %
_outageCompletionSource
ÊÊ +
.
ÊÊ+ ,
Task
ÊÊ, 0
.
ÊÊ0 1
IsCompleted
ÊÊ1 <
)
ÊÊ< =
{
ÁÁ %
_outageCompletionSource
ËË +
=
ËË, -
CreateOutageTcs
ËË. =
(
ËË= >
)
ËË> ?
;
ËË? @
}
ÈÈ 
}
ÍÍ !
connectivityService
ÏÏ 
.
ÏÏ  
PublishAsync
ÏÏ  ,
(
ÏÏ, - 
ConnectivityIntent
ÌÌ "
.
ÌÌ" #

Recovering
ÌÌ# -
(
ÌÌ- .
NetworkFailure
ÓÓ "
.
ÓÓ" #%
DataCenterNotResponding
ÓÓ# :
(
ÓÓ: ;
$str
ÓÓ; W
)
ÓÓW X
)
ÓÓX Y
)
ÓÓY Z
.
ÓÓZ [
ContinueWith
ÓÓ[ g
(
ÓÓg h
task
ÔÔ 
=>
ÔÔ 
{
 
if
ÒÒ 
(
ÒÒ 
task
ÒÒ 
.
ÒÒ 
	IsFaulted
ÒÒ &
&&
ÒÒ' )
task
ÒÒ* .
.
ÒÒ. /
	Exception
ÒÒ/ 8
!=
ÒÒ9 ;
null
ÒÒ< @
)
ÒÒ@ A
{
ÚÚ 
Log
ÛÛ 
.
ÛÛ 
Error
ÛÛ !
(
ÛÛ! "
task
ÛÛ" &
.
ÛÛ& '
	Exception
ÛÛ' 0
,
ÛÛ0 1
$str
ÛÛ2 v
)
ÛÛv w
;
ÛÛw x
}
ÙÙ 
}
ıı 
,
ıı 
TaskScheduler
ˆˆ 
.
ˆˆ 
Default
ˆˆ %
)
ˆˆ% &
;
ˆˆ& '
}
˜˜ 	+
EnsureConnectionRecoveryToken
˘˘ %
(
˘˘% &
)
˘˘& '
;
˘˘' (
}
˙˙ 
private
¸¸ 
void
¸¸ +
CancelConnectionRecoveryToken
¸¸ .
(
¸¸. /
)
¸¸/ 0
{
˝˝ 
lock
˛˛ 
(
˛˛ 
_cancellationLock
˛˛ 
)
˛˛  
{
ˇˇ 	
if
ÄÄ 
(
ÄÄ $
_connectionRecoveryCts
ÄÄ &
==
ÄÄ' )
null
ÄÄ* .
)
ÄÄ. /
{
ÅÅ 
return
ÇÇ 
;
ÇÇ 
}
ÉÉ 
try
ÖÖ 
{
ÜÜ 
if
áá 
(
áá 
!
áá $
_connectionRecoveryCts
áá +
.
áá+ ,%
IsCancellationRequested
áá, C
)
ááC D
{
àà $
_connectionRecoveryCts
ââ *
.
ââ* +
Cancel
ââ+ 1
(
ââ1 2
)
ââ2 3
;
ââ3 4
}
ää 
}
ãã 
catch
åå 
(
åå %
ObjectDisposedException
åå *
)
åå* +
{
çç 
}
èè 
finally
êê 
{
ëë $
_connectionRecoveryCts
íí &
.
íí& '
Dispose
íí' .
(
íí. /
)
íí/ 0
;
íí0 1$
_connectionRecoveryCts
ìì &
=
ìì' (
null
ìì) -
;
ìì- .
}
îî 
}
ïï 	
}
ññ 
private
òò 
async
òò 
Task
òò 
<
òò 
T
òò 
>
òò 
WithChannelGate
òò )
<
òò) *
T
òò* +
>
òò+ ,
(
òò, -
uint
òò- 1
	connectId
òò2 ;
,
òò; <
Func
òò= A
<
òòA B
Task
òòB F
<
òòF G
T
òòG H
>
òòH I
>
òòI J
action
òòK Q
)
òòQ R
{
ôô 
SemaphoreSlim
öö 
gate
öö 
=
öö 
_channelGates
öö *
.
öö* +
GetOrAdd
öö+ 3
(
öö3 4
	connectId
öö4 =
,
öö= >
_
öö? @
=>
ööA C
new
ööD G
SemaphoreSlim
ööH U
(
ööU V
$num
ööV W
,
ööW X
$num
ööY Z
)
ööZ [
)
öö[ \
;
öö\ ]
bool
õõ 
acquired
õõ 
=
õõ 
false
õõ 
;
õõ 
try
úú 
{
ùù 	
await
ûû 
gate
ûû 
.
ûû 
	WaitAsync
ûû  
(
ûû  !(
_shutdownCancellationToken
ûû! ;
.
ûû; <
Token
ûû< A
)
ûûA B
.
ûûB C
ConfigureAwait
ûûC Q
(
ûûQ R
false
ûûR W
)
ûûW X
;
ûûX Y
acquired
üü 
=
üü 
true
üü 
;
üü 
return
†† 
await
†† 
action
†† 
(
††  
)
††  !
.
††! "
ConfigureAwait
††" 0
(
††0 1
false
††1 6
)
††6 7
;
††7 8
}
°° 	
catch
¢¢ 
(
¢¢ (
OperationCanceledException
¢¢ )
)
¢¢) *
when
¢¢+ /
(
¢¢0 1(
_shutdownCancellationToken
¢¢1 K
.
¢¢K L%
IsCancellationRequested
¢¢L c
)
¢¢c d
{
££ 	
throw
§§ 
new
§§ %
ObjectDisposedException
§§ -
(
§§- .
nameof
§§. 4
(
§§4 5
NetworkProvider
§§5 D
)
§§D E
,
§§E F
$str
§§G b
)
§§b c
;
§§c d
}
•• 	
finally
¶¶ 
{
ßß 	
if
®® 
(
®® 
acquired
®® 
)
®® 
{
©© 
gate
™™ 
.
™™ 
Release
™™ 
(
™™ 
)
™™ 
;
™™ 
}
´´ 
}
¨¨ 	
}
≠≠ 
private
ØØ 
static
ØØ 
bool
ØØ (
CanServiceTypeBeDuplicated
ØØ 2
(
ØØ2 3
RpcServiceType
ØØ3 A
serviceType
ØØB M
)
ØØM N
{
∞∞ 
return
±± 
serviceType
±± 
switch
±± !
{
≤≤ 	
RpcServiceType
≥≥ 
.
≥≥ "
InitiateVerification
≥≥ /
=>
≥≥0 2
true
≥≥3 7
,
≥≥7 8
RpcServiceType
¥¥ 
.
¥¥ "
ValidateMobileNumber
¥¥ /
=>
¥¥0 2
true
¥¥3 7
,
¥¥7 8
_
µµ 
=>
µµ 
false
µµ 
}
∂∂ 	
;
∂∂	 

}
∑∑ 
private
ππ 
void
ππ .
 PersistProtocolStateInBackground
ππ 1
(
ππ1 2
uint
ππ2 6
	connectId
ππ7 @
)
ππ@ A
{
∫∫ 
Task
ªª 
.
ªª 
Run
ªª 
(
ªª 
async
ªª 
(
ªª 
)
ªª 
=>
ªª 
{
ºº 	
try
ΩΩ 
{
ææ 
await
øø *
TryPersistProtocolStateAsync
øø 2
(
øø2 3
	connectId
øø3 <
)
øø< =
.
øø= >
ConfigureAwait
øø> L
(
øøL M
false
øøM R
)
øøR S
;
øøS T
}
¿¿ 
catch
¡¡ 
(
¡¡ 
	Exception
¡¡ 
ex
¡¡ 
)
¡¡  
{
¬¬ 
if
√√ 
(
√√ 
!
√√ 
	_disposed
√√ 
)
√√ 
{
ƒƒ 
Log
≈≈ 
.
≈≈ 
Error
≈≈ 
(
≈≈ 
ex
≈≈  
,
≈≈  !
$str
≈≈" k
)
≈≈k l
;
≈≈l m
}
∆∆ 
}
«« 
}
»» 	
,
»»	 
(
_shutdownCancellationToken
»» %
.
»»% &
Token
»»& +
)
»»+ ,
.
»», -
ContinueWith
»»- 9
(
»»9 :
task
…… 
=>
…… 
{
   
if
ÀÀ 
(
ÀÀ 
task
ÀÀ 
.
ÀÀ 
	IsFaulted
ÀÀ "
&&
ÀÀ# %
task
ÀÀ& *
.
ÀÀ* +
	Exception
ÀÀ+ 4
!=
ÀÀ5 7
null
ÀÀ8 <
)
ÀÀ< =
{
ÃÃ 
Log
ÕÕ 
.
ÕÕ 
Error
ÕÕ 
(
ÕÕ 
task
ÕÕ "
.
ÕÕ" #
	Exception
ÕÕ# ,
,
ÕÕ, -
$str
ÕÕ. t
)
ÕÕt u
;
ÕÕu v
}
ŒŒ 
}
œœ 
,
œœ 
TaskScheduler
–– 
.
–– 
Default
–– !
)
––! "
;
––" #
}
—— 
private
”” 
async
”” 
Task
”” *
TryPersistProtocolStateAsync
”” 3
(
””3 4
uint
””4 8
	connectId
””9 B
)
””B C
{
‘‘ 
if
’’ 

(
’’ 
	_disposed
’’ 
||
’’ (
_shutdownCancellationToken
’’ 3
.
’’3 4%
IsCancellationRequested
’’4 K
)
’’K L
{
÷÷ 	
return
◊◊ 
;
◊◊ 
}
ÿÿ 	
if
⁄⁄ 

(
⁄⁄ 
!
⁄⁄ 
_connections
⁄⁄ 
.
⁄⁄ 
TryGetValue
⁄⁄ %
(
⁄⁄% &
	connectId
⁄⁄& /
,
⁄⁄/ 0
out
⁄⁄1 4$
EcliptixProtocolSystem
⁄⁄5 K
?
⁄⁄K L
protocolSystem
⁄⁄M [
)
⁄⁄[ \
)
⁄⁄\ ]
{
€€ 	
return
‹‹ 
;
‹‹ 
}
›› 	(
EcliptixProtocolConnection
ﬂﬂ "
?
ﬂﬂ" #

connection
ﬂﬂ$ .
=
ﬂﬂ/ 0
protocolSystem
ﬂﬂ1 ?
.
ﬂﬂ? @
GetConnection
ﬂﬂ@ M
(
ﬂﬂM N
)
ﬂﬂN O
;
ﬂﬂO P
if
‡‡ 

(
‡‡ 

connection
‡‡ 
==
‡‡ 
null
‡‡ 
||
‡‡ !

connection
‡‡" ,
.
‡‡, -
ExchangeType
‡‡- 9
==
‡‡: < 
PubKeyExchangeType
‡‡= O
.
‡‡O P
ServerStreaming
‡‡P _
)
‡‡_ `
{
·· 	
return
‚‚ 
;
‚‚ 
}
„„ 	
Option
ÂÂ 
<
ÂÂ "
EcliptixSessionState
ÂÂ #
>
ÂÂ# $ 
sessionStateOption
ÂÂ% 7
=
ÂÂ8 9
BuildSessionState
ÂÂ: K
(
ÂÂK L
	connectId
ÂÂL U
,
ÂÂU V
protocolSystem
ÂÂW e
,
ÂÂe f

connection
ÂÂg q
)
ÂÂq r
;
ÂÂr s
if
ÊÊ 

(
ÊÊ  
sessionStateOption
ÊÊ 
.
ÊÊ 
IsSome
ÊÊ %
)
ÊÊ% &
{
ÁÁ 	
await
ËË &
PersistSessionStateAsync
ËË *
(
ËË* + 
sessionStateOption
ËË+ =
.
ËË= >
Value
ËË> C
!
ËËC D
,
ËËD E
	connectId
ËËF O
)
ËËO P
.
ËËP Q
ConfigureAwait
ËËQ _
(
ËË_ `
false
ËË` e
)
ËËe f
;
ËËf g
}
ÈÈ 	
}
ÍÍ 
private
ÏÏ 
static
ÏÏ 
Option
ÏÏ 
<
ÏÏ "
EcliptixSessionState
ÏÏ .
>
ÏÏ. /
BuildSessionState
ÏÏ0 A
(
ÏÏA B
uint
ÏÏB F
	connectId
ÏÏG P
,
ÏÏP Q$
EcliptixProtocolSystem
ÏÏR h
protocolSystem
ÏÏi w
,
ÏÏw x)
EcliptixProtocolConnectionÏÏy ì

connectionÏÏî û
)ÏÏû ü
{
ÌÌ (
EcliptixSystemIdentityKeys
ÓÓ "
idKeys
ÓÓ# )
=
ÓÓ* +
protocolSystem
ÓÓ, :
.
ÓÓ: ;
GetIdentityKeys
ÓÓ; J
(
ÓÓJ K
)
ÓÓK L
;
ÓÓL M
Result
ÔÔ 
<
ÔÔ 
IdentityKeysState
ÔÔ  
,
ÔÔ  !%
EcliptixProtocolFailure
ÔÔ" 9
>
ÔÔ9 :
idKeysStateResult
ÔÔ; L
=
ÔÔM N
idKeys
ÔÔO U
.
ÔÔU V
ToProtoState
ÔÔV b
(
ÔÔb c
)
ÔÔc d
;
ÔÔd e
Result
 
<
 
RatchetState
 
,
 %
EcliptixProtocolFailure
 4
>
4 5 
ratchetStateResult
6 H
=
I J

connection
K U
.
U V
ToProtoState
V b
(
b c
)
c d
;
d e
if
ÚÚ 

(
ÚÚ 
!
ÚÚ 
idKeysStateResult
ÚÚ 
.
ÚÚ 
IsOk
ÚÚ #
||
ÚÚ$ &
!
ÚÚ' ( 
ratchetStateResult
ÚÚ( :
.
ÚÚ: ;
IsOk
ÚÚ; ?
)
ÚÚ? @
{
ÛÛ 	
return
ÙÙ 
Option
ÙÙ 
<
ÙÙ "
EcliptixSessionState
ÙÙ .
>
ÙÙ. /
.
ÙÙ/ 0
None
ÙÙ0 4
;
ÙÙ4 5
}
ıı 	"
EcliptixSessionState
˜˜ 
state
˜˜ "
=
˜˜# $
new
˜˜% (
(
˜˜( )
)
˜˜) *
{
¯¯ 	
	ConnectId
˘˘ 
=
˘˘ 
	connectId
˘˘ !
,
˘˘! "
IdentityKeys
˙˙ 
=
˙˙ 
idKeysStateResult
˙˙ ,
.
˙˙, -
Unwrap
˙˙- 3
(
˙˙3 4
)
˙˙4 5
,
˙˙5 6
RatchetState
˚˚ 
=
˚˚  
ratchetStateResult
˚˚ -
.
˚˚- .
Unwrap
˚˚. 4
(
˚˚4 5
)
˚˚5 6
}
¸¸ 	
;
¸¸	 

return
˛˛ 
Option
˛˛ 
<
˛˛ "
EcliptixSessionState
˛˛ *
>
˛˛* +
.
˛˛+ ,
Some
˛˛, 0
(
˛˛0 1
state
˛˛1 6
)
˛˛6 7
;
˛˛7 8
}
ˇˇ 
public
ÅÅ 

void
ÅÅ $
OnProtocolStateChanged
ÅÅ &
(
ÅÅ& '
uint
ÅÅ' +
	connectId
ÅÅ, 5
)
ÅÅ5 6
=>
ÅÅ7 9.
 PersistProtocolStateInBackground
ÇÇ (
(
ÇÇ( )
	connectId
ÇÇ) 2
)
ÇÇ2 3
;
ÇÇ3 4
public
ÑÑ 

static
ÑÑ 
uint
ÑÑ $
ComputeUniqueConnectId
ÑÑ -
(
ÑÑ- .)
ApplicationInstanceSettings
ÑÑ. I
?
ÑÑI J)
applicationInstanceSettings
ÑÑK f
,
ÑÑf g 
PubKeyExchangeType
ÖÖ  
pubKeyExchangeType
ÖÖ -
)
ÖÖ- .
{
ÜÜ 
if
áá 

(
áá )
applicationInstanceSettings
áá '
==
áá( *
null
áá+ /
)
áá/ 0
{
àà 	
throw
ââ 
new
ââ '
InvalidOperationException
ââ /
(
ââ/ 0
$str
ââ0 q
)
ââq r
;
ââr s
}
ää 	
if
åå 

(
åå )
applicationInstanceSettings
åå '
.
åå' (
AppInstanceId
åå( 5
==
åå6 8
null
åå9 =
||
åå> @)
applicationInstanceSettings
ååA \
.
åå\ ]
AppInstanceId
åå] j
.
ååj k
IsEmpty
ååk r
)
åår s
{
çç 	
throw
éé 
new
éé '
InvalidOperationException
éé /
(
éé/ 0
$str
éé0 l
)
éél m
;
éém n
}
èè 	
if
ëë 

(
ëë )
applicationInstanceSettings
ëë '
.
ëë' (
DeviceId
ëë( 0
==
ëë1 3
null
ëë4 8
||
ëë9 ;)
applicationInstanceSettings
ëë< W
.
ëëW X
DeviceId
ëëX `
.
ëë` a
IsEmpty
ëëa h
)
ëëh i
{
íí 	
throw
ìì 
new
ìì '
InvalidOperationException
ìì /
(
ìì/ 0
$str
ìì0 g
)
ììg h
;
ììh i
}
îî 	
Guid
ññ 
appInstanceGuid
ññ 
=
ññ 
Helpers
ññ &
.
ññ& '"
FromByteStringToGuid
ññ' ;
(
ññ; <)
applicationInstanceSettings
ññ< W
.
ññW X
AppInstanceId
ññX e
)
ññe f
;
ññf g
Guid
óó 

deviceGuid
óó 
=
óó 
Helpers
óó !
.
óó! ""
FromByteStringToGuid
óó" 6
(
óó6 7)
applicationInstanceSettings
óó7 R
.
óóR S
DeviceId
óóS [
)
óó[ \
;
óó\ ]
string
ôô !
appInstanceIdString
ôô "
=
ôô# $
appInstanceGuid
ôô% 4
.
ôô4 5
ToString
ôô5 =
(
ôô= >
)
ôô> ?
;
ôô? @
string
öö 
deviceIdString
öö 
=
öö 

deviceGuid
öö  *
.
öö* +
ToString
öö+ 3
(
öö3 4
)
öö4 5
;
öö5 6
uint
úú 
	connectId
úú 
=
úú 
Helpers
úú  
.
úú  !$
ComputeUniqueConnectId
úú! 7
(
úú7 8!
appInstanceIdString
ùù 
,
ùù  
deviceIdString
ûû 
,
ûû  
pubKeyExchangeType
ûû .
)
ûû. /
;
ûû/ 0
return
†† 
	connectId
†† 
;
†† 
}
°° 
public
££ 

void
££ 
Dispose
££ 
(
££ 
)
££ 
{
§§ 
if
•• 

(
•• 
	_disposed
•• 
)
•• 
{
¶¶ 	
return
ßß 
;
ßß 
}
®® 	
lock
™™ 
(
™™ 
_disposeLock
™™ 
)
™™ 
{
´´ 	
if
¨¨ 
(
¨¨ 
	_disposed
¨¨ 
)
¨¨ 
{
≠≠ 
return
ÆÆ 
;
ÆÆ 
}
ØØ 
	_disposed
±± 
=
±± 
true
±± 
;
±± 
try
≥≥ 
{
¥¥ (
_shutdownCancellationToken
µµ *
.
µµ* +
Cancel
µµ+ 1
(
µµ1 2
)
µµ2 3
;
µµ3 4
foreach
∑∑ 
(
∑∑ 
KeyValuePair
∑∑ %
<
∑∑% &
string
∑∑& ,
,
∑∑, -%
CancellationTokenSource
∑∑. E
>
∑∑E F
kv
∑∑G I
in
∑∑J L
_pendingRequests
∑∑M ]
.
∑∑] ^
ToArray
∑∑^ e
(
∑∑e f
)
∑∑f g
)
∑∑g h
{
∏∏ 
if
ππ 
(
ππ 
!
ππ 
_pendingRequests
ππ )
.
ππ) *
	TryRemove
ππ* 3
(
ππ3 4
kv
ππ4 6
.
ππ6 7
Key
ππ7 :
,
ππ: ;
out
ππ< ?%
CancellationTokenSource
ππ@ W
?
ππW X
cts
ππY \
)
ππ\ ]
)
ππ] ^
{
∫∫ 
continue
ªª  
;
ªª  !
}
ºº 
try
ææ 
{
øø 
cts
¿¿ 
.
¿¿ 
Cancel
¿¿ "
(
¿¿" #
)
¿¿# $
;
¿¿$ %
cts
¡¡ 
.
¡¡ 
Dispose
¡¡ #
(
¡¡# $
)
¡¡$ %
;
¡¡% &
}
¬¬ 
catch
√√ 
(
√√ %
ObjectDisposedException
√√ 2
)
√√2 3
{
ƒƒ 
}
∆∆ 
}
«« 
foreach
…… 
(
…… 
KeyValuePair
…… %
<
……% &
uint
……& *
,
……* +%
CancellationTokenSource
……, C
>
……C D
kv
……E G
in
……H J
_activeStreams
……K Y
.
……Y Z
ToArray
……Z a
(
……a b
)
……b c
)
……c d
{
   
if
ÀÀ 
(
ÀÀ 
!
ÀÀ 
_activeStreams
ÀÀ '
.
ÀÀ' (
	TryRemove
ÀÀ( 1
(
ÀÀ1 2
kv
ÀÀ2 4
.
ÀÀ4 5
Key
ÀÀ5 8
,
ÀÀ8 9
out
ÀÀ: =%
CancellationTokenSource
ÀÀ> U
?
ÀÀU V
	streamCts
ÀÀW `
)
ÀÀ` a
)
ÀÀa b
{
ÃÃ 
continue
ÕÕ  
;
ÕÕ  !
}
ŒŒ 
try
–– 
{
—— 
	streamCts
““ !
.
““! "
Cancel
““" (
(
““( )
)
““) *
;
““* +
	streamCts
”” !
.
””! "
Dispose
””" )
(
””) *
)
””* +
;
””+ ,
}
‘‘ 
catch
’’ 
(
’’ %
ObjectDisposedException
’’ 2
)
’’2 3
{
÷÷ 
}
ÿÿ 
}
ŸŸ 
lock
€€ 
(
€€ 
_outageLock
€€ !
)
€€! "
{
‹‹ %
_outageCompletionSource
›› +
.
››+ ,
TrySetException
››, ;
(
››; <
new
››< ?(
OperationCanceledException
››@ Z
(
››Z [
$str
››[ s
)
››s t
)
››t u
;
››u v
}
ﬁﬁ 
List
‡‡ 
<
‡‡ 
KeyValuePair
‡‡ !
<
‡‡! "
uint
‡‡" &
,
‡‡& '$
EcliptixProtocolSystem
‡‡( >
>
‡‡> ?
>
‡‡? @"
connectionsToDispose
‡‡A U
=
‡‡V W
new
‡‡X [
(
‡‡[ \
_connections
‡‡\ h
)
‡‡h i
;
‡‡i j
_connections
·· 
.
·· 
Clear
·· "
(
··" #
)
··# $
;
··$ %
foreach
„„ 
(
„„ 
KeyValuePair
„„ %
<
„„% &
uint
„„& *
,
„„* +$
EcliptixProtocolSystem
„„, B
>
„„B C

connection
„„D N
in
„„O Q"
connectionsToDispose
„„R f
)
„„f g
{
‰‰ 
try
ÂÂ 
{
ÊÊ 

connection
ÁÁ "
.
ÁÁ" #
Value
ÁÁ# (
.
ÁÁ( )
Dispose
ÁÁ) 0
(
ÁÁ0 1
)
ÁÁ1 2
;
ÁÁ2 3
}
ËË 
catch
ÈÈ 
{
ÍÍ 
}
ÏÏ 
}
ÌÌ 
lock
ÔÔ 
(
ÔÔ 
_cancellationLock
ÔÔ '
)
ÔÔ' (
{
 $
_connectionRecoveryCts
ÒÒ *
?
ÒÒ* +
.
ÒÒ+ ,
Dispose
ÒÒ, 3
(
ÒÒ3 4
)
ÒÒ4 5
;
ÒÒ5 6$
_connectionRecoveryCts
ÚÚ *
=
ÚÚ+ ,
null
ÚÚ- 1
;
ÚÚ1 2
}
ÛÛ 
foreach
ıı 
(
ıı 
SemaphoreSlim
ıı &
gate
ıı' +
in
ıı, .
_channelGates
ıı/ <
.
ıı< =
Values
ıı= C
)
ııC D
{
ˆˆ 
gate
˜˜ 
.
˜˜ 
Dispose
˜˜  
(
˜˜  !
)
˜˜! "
;
˜˜" #
}
¯¯ 
_channelGates
˙˙ 
.
˙˙ 
Clear
˙˙ #
(
˙˙# $
)
˙˙$ %
;
˙˙% &'
_retryPendingRequestsGate
¸¸ )
.
¸¸) *
Dispose
¸¸* 1
(
¸¸1 2
)
¸¸2 3
;
¸¸3 4(
_shutdownCancellationToken
˛˛ *
.
˛˛* +
Dispose
˛˛+ 2
(
˛˛2 3
)
˛˛3 4
;
˛˛4 5
}
ˇˇ 
catch
ÄÄ 
(
ÄÄ 
	Exception
ÄÄ 
ex
ÄÄ 
)
ÄÄ  
{
ÅÅ 
Log
ÉÉ 
.
ÉÉ 
Warning
ÉÉ 
(
ÉÉ 
ex
ÉÉ 
,
ÉÉ 
$str
ÉÉ  X
)
ÉÉX Y
;
ÉÉY Z
}
ÑÑ 
}
ÖÖ 	
}
ÜÜ 
public
àà 

async
àà 
Task
àà 
<
àà 
Result
àà 
<
àà 
Unit
àà !
,
àà! "
NetworkFailure
àà# 1
>
àà1 2
>
àà2 3'
ForceFreshConnectionAsync
àà4 M
(
ààM N
)
ààN O
{
ââ 
retryStrategy
ää 
.
ää &
ClearExhaustedOperations
ää .
(
ää. /
)
ää/ 0
;
ää0 1
Result
åå 
<
åå 
Unit
åå 
,
åå 
NetworkFailure
åå #
>
åå# $
immediateResult
åå% 4
=
åå5 6
await
åå7 <+
PerformImmediateRecoveryLogic
åå= Z
(
ååZ [
)
åå[ \
.
åå\ ]
ConfigureAwait
åå] k
(
ååk l
false
åål q
)
ååq r
;
åår s
if
éé 

(
éé 
immediateResult
éé 
.
éé 
IsOk
éé  
)
éé  !
{
èè 	
return
êê 
immediateResult
êê "
;
êê" #
}
ëë 	
Result
ìì 
<
ìì 
Unit
ìì 
,
ìì 
NetworkFailure
ìì #
>
ìì# $
result
ìì% +
=
ìì, -
await
ìì. 39
+PerformAdvancedRecoveryWithManualRetryAsync
ìì4 _
(
ìì_ `
)
ìì` a
.
ììa b
ConfigureAwait
ììb p
(
ììp q
false
ììq v
)
ììv w
;
ììw x
return
ïï 
result
ïï 
;
ïï 
}
ññ 
private
òò 
async
òò 
Task
òò 
<
òò 
Result
òò 
<
òò 
Unit
òò "
,
òò" #
NetworkFailure
òò$ 2
>
òò2 3
>
òò3 49
+PerformAdvancedRecoveryWithManualRetryAsync
òò5 `
(
òò` a
)
òòa b
{
ôô 
return
öö 
await
öö 6
(PerformRecoveryWithStateRestorationAsync
öö =
(
öö= >
RestoreRetryMode
õõ 
.
õõ 
ManualRetry
õõ (
,
õõ( )
$str
úú -
)
úú- .
.
úú. /
ConfigureAwait
úú/ =
(
úú= >
false
úú> C
)
úúC D
;
úúD E
}
ùù 
private
üü 
async
üü 
Task
üü 
<
üü 
Result
üü 
<
üü 
Unit
üü "
,
üü" #
NetworkFailure
üü$ 2
>
üü2 3
>
üü3 4+
PerformImmediateRecoveryLogic
üü5 R
(
üüR S
)
üüS T
{
†† 
return
°° 
await
°° 6
(PerformRecoveryWithStateRestorationAsync
°° =
(
°°= >
RestoreRetryMode
¢¢ 
.
¢¢ 
DirectNoRetry
¢¢ *
,
¢¢* +
NetworkConstants
££ 
.
££ 
ErrorMessages
££ *
.
££* +)
SESSION_NOT_FOUND_ON_SERVER
££+ F
,
££F G 
failOnMissingState
§§ 
:
§§ 
true
§§  $
)
§§$ %
.
§§% &
ConfigureAwait
§§& 4
(
§§4 5
false
§§5 :
)
§§: ;
;
§§; <
}
•• 
private
ßß 
async
ßß 
Task
ßß 
<
ßß 
Result
ßß 
<
ßß 
Unit
ßß "
,
ßß" #
NetworkFailure
ßß$ 2
>
ßß2 3
>
ßß3 46
(PerformRecoveryWithStateRestorationAsync
ßß5 ]
(
ßß] ^
RestoreRetryMode
®® 
	retryMode
®® "
,
®®" #
string
©© 
failureMessage
©© 
,
©© 
bool
™™  
failOnMissingState
™™ 
=
™™  !
false
™™" '
)
™™' (
{
´´ 
Result
¨¨ 
<
¨¨ 
(
¨¨ 
uint
¨¨ 
	connectId
¨¨ 
,
¨¨ 
byte
¨¨  $
[
¨¨$ %
]
¨¨% &
membershipId
¨¨' 3
)
¨¨3 4
,
¨¨4 5
NetworkFailure
¨¨6 D
>
¨¨D E!
prerequisitesResult
¨¨F Y
=
¨¨Z [+
ValidateRecoveryPrerequisites
¨¨\ y
(
¨¨y z
)
¨¨z {
;
¨¨{ |
if
≠≠ 

(
≠≠ !
prerequisitesResult
≠≠ 
.
≠≠  
IsErr
≠≠  %
)
≠≠% &
{
ÆÆ 	
return
ØØ 
Result
ØØ 
<
ØØ 
Unit
ØØ 
,
ØØ 
NetworkFailure
ØØ  .
>
ØØ. /
.
ØØ/ 0
Err
ØØ0 3
(
ØØ3 4!
prerequisitesResult
ØØ4 G
.
ØØG H
	UnwrapErr
ØØH Q
(
ØØQ R
)
ØØR S
)
ØØS T
;
ØØT U
}
∞∞ 	
(
≤≤ 	
uint
≤≤	 
	connectId
≤≤ 
,
≤≤ 
byte
≤≤ 
[
≤≤ 
]
≤≤ 
membershipId
≤≤  ,
)
≤≤, -
=
≤≤. /!
prerequisitesResult
≤≤0 C
.
≤≤C D
Unwrap
≤≤D J
(
≤≤J K
)
≤≤K L
;
≤≤L M
_connections
≥≥ 
.
≥≥ 
	TryRemove
≥≥ 
(
≥≥ 
	connectId
≥≥ (
,
≥≥( )
out
≥≥* -
_
≥≥. /
)
≥≥/ 0
;
≥≥0 1
Result
µµ 
<
µµ "
EcliptixSessionState
µµ #
,
µµ# $
NetworkFailure
µµ% 3
>
µµ3 4
stateResult
µµ5 @
=
µµA B
await
∂∂ %
LoadAndParseStoredState
∂∂ )
(
∂∂) *
	connectId
∂∂* 3
,
∂∂3 4
membershipId
∂∂5 A
,
∂∂A B 
failOnMissingState
∂∂C U
,
∂∂U V
failureMessage
∂∂W e
)
∂∂e f
.
∂∂f g
ConfigureAwait
∂∂g u
(
∂∂u v
false
∂∂v {
)
∂∂{ |
;
∂∂| }
if
∏∏ 

(
∏∏ 
stateResult
∏∏ 
.
∏∏ 
IsErr
∏∏ 
)
∏∏ 
{
ππ 	
return
∫∫ 
Result
∫∫ 
<
∫∫ 
Unit
∫∫ 
,
∫∫ 
NetworkFailure
∫∫  .
>
∫∫. /
.
∫∫/ 0
Err
∫∫0 3
(
∫∫3 4
stateResult
∫∫4 ?
.
∫∫? @
	UnwrapErr
∫∫@ I
(
∫∫I J
)
∫∫J K
)
∫∫K L
;
∫∫L M
}
ªª 	
bool
ΩΩ "
restorationSucceeded
ΩΩ !
;
ΩΩ! "
try
ææ 
{
øø 	"
EcliptixSessionState
¿¿  
state
¿¿! &
=
¿¿' (
stateResult
¿¿) 4
.
¿¿4 5
Unwrap
¿¿5 ;
(
¿¿; <
)
¿¿< =
;
¿¿= >
Result
¡¡ 
<
¡¡ 
bool
¡¡ 
,
¡¡ 
NetworkFailure
¡¡ '
>
¡¡' (
restoreResult
¡¡) 6
=
¡¡7 8
await
¬¬ (
RestoreSecrecyChannelAsync
¬¬ 0
(
¬¬0 1
state
¬¬1 6
,
¬¬6 7*
_applicationInstanceSettings
¬¬8 T
.
¬¬T U
Value
¬¬U Z
!
¬¬Z [
,
¬¬[ \
	retryMode
¬¬] f
)
¬¬f g
.
√√ 
ConfigureAwait
√√ #
(
√√# $
false
√√$ )
)
√√) *
;
√√* +"
restorationSucceeded
≈≈  
=
≈≈! "
restoreResult
≈≈# 0
.
≈≈0 1
IsOk
≈≈1 5
&&
≈≈6 8
restoreResult
≈≈9 F
.
≈≈F G
Unwrap
≈≈G M
(
≈≈M N
)
≈≈N O
;
≈≈O P
if
«« 
(
«« "
restorationSucceeded
«« $
)
««$ %
{
»» '
PublishConnectionRestored
…… )
(
……) *
	connectId
……* 3
)
……3 4
;
……4 5
}
   
}
ÀÀ 	
catch
ÃÃ 
(
ÃÃ 
	Exception
ÃÃ 
ex
ÃÃ 
)
ÃÃ 
{
ÕÕ 	
if
ŒŒ 
(
ŒŒ 
	retryMode
ŒŒ 
==
ŒŒ 
RestoreRetryMode
ŒŒ -
.
ŒŒ- .
DirectNoRetry
ŒŒ. ;
)
ŒŒ; <
{
œœ 
return
–– 
Result
–– 
<
–– 
Unit
–– "
,
––" #
NetworkFailure
––$ 2
>
––2 3
.
––3 4
Err
––4 7
(
––7 8
NetworkFailure
—— "
.
——" #%
DataCenterNotResponding
——# :
(
——: ;
$"
——; =
$str
——= [
{
——[ \
ex
——\ ^
.
——^ _
Message
——_ f
}
——f g
"
——g h
)
——h i
)
——i j
;
——j k
}
““ "
restorationSucceeded
‘‘  
=
‘‘! "
false
‘‘# (
;
‘‘( )
}
’’ 	
if
◊◊ 

(
◊◊ 
!
◊◊ "
restorationSucceeded
◊◊ !
)
◊◊! "
{
ÿÿ 	
return
ŸŸ 
Result
ŸŸ 
<
ŸŸ 
Unit
ŸŸ 
,
ŸŸ 
NetworkFailure
ŸŸ  .
>
ŸŸ. /
.
ŸŸ/ 0
Err
ŸŸ0 3
(
ŸŸ3 4
NetworkFailure
⁄⁄ 
.
⁄⁄ %
DataCenterNotResponding
⁄⁄ 6
(
⁄⁄6 7
failureMessage
⁄⁄7 E
)
⁄⁄E F
)
⁄⁄F G
;
⁄⁄G H
}
€€ 	

ExitOutage
›› 
(
›› 
)
›› 
;
›› +
ResetRetryStrategyAfterOutage
ﬁﬁ %
(
ﬁﬁ% &
)
ﬁﬁ& '
;
ﬁﬁ' (
await
ﬂﬂ /
!RetryPendingRequestsAfterRecovery
ﬂﬂ /
(
ﬂﬂ/ 0
)
ﬂﬂ0 1
.
ﬂﬂ1 2
ConfigureAwait
ﬂﬂ2 @
(
ﬂﬂ@ A
false
ﬂﬂA F
)
ﬂﬂF G
;
ﬂﬂG H
return
·· 
Result
·· 
<
·· 
Unit
·· 
,
·· 
NetworkFailure
·· *
>
··* +
.
··+ ,
Ok
··, .
(
··. /
Unit
··/ 3
.
··3 4
Value
··4 9
)
··9 :
;
··: ;
}
‚‚ 
private
‰‰ 
Result
‰‰ 
<
‰‰ 
(
‰‰ 
uint
‰‰ 
	connectId
‰‰ "
,
‰‰" #
byte
‰‰$ (
[
‰‰( )
]
‰‰) *
membershipId
‰‰+ 7
)
‰‰7 8
,
‰‰8 9
NetworkFailure
‰‰: H
>
‰‰H I+
ValidateRecoveryPrerequisites
‰‰J g
(
‰‰g h
)
‰‰h i
{
ÂÂ 
if
ÊÊ 

(
ÊÊ 
!
ÊÊ *
_applicationInstanceSettings
ÊÊ )
.
ÊÊ) *
IsSome
ÊÊ* 0
)
ÊÊ0 1
{
ÁÁ 	
return
ËË 
Result
ËË 
<
ËË 
(
ËË 
uint
ËË 
,
ËË  
byte
ËË! %
[
ËË% &
]
ËË& '
)
ËË' (
,
ËË( )
NetworkFailure
ËË* 8
>
ËË8 9
.
ËË9 :
Err
ËË: =
(
ËË= >
NetworkFailure
ÈÈ 
.
ÈÈ  
InvalidRequestType
ÈÈ 1
(
ÈÈ1 2
$str
ÈÈ2 _
)
ÈÈ_ `
)
ÈÈ` a
;
ÈÈa b
}
ÍÍ 	
uint
ÏÏ 
	connectId
ÏÏ 
=
ÏÏ $
ComputeUniqueConnectId
ÏÏ /
(
ÏÏ/ 0*
_applicationInstanceSettings
ÏÏ0 L
.
ÏÏL M
Value
ÏÏM R
!
ÏÏR S
,
ÏÏS T 
PubKeyExchangeType
ÌÌ 
.
ÌÌ (
DataCenterEphemeralConnect
ÌÌ 9
)
ÌÌ9 :
;
ÌÌ: ;
byte
ÔÔ 
[
ÔÔ 
]
ÔÔ 
?
ÔÔ 
membershipId
ÔÔ 
=
ÔÔ "
GetMembershipIdBytes
ÔÔ 3
(
ÔÔ3 4
)
ÔÔ4 5
;
ÔÔ5 6
if
 

(
 
membershipId
 
==
 
null
  
)
  !
{
ÒÒ 	
Log
ÚÚ 
.
ÚÚ 
Warning
ÚÚ 
(
ÚÚ 
$str
ÚÚ w
,
ÚÚw x
	connectId
ÛÛ 
)
ÛÛ 
;
ÛÛ 
return
ÙÙ 
Result
ÙÙ 
<
ÙÙ 
(
ÙÙ 
uint
ÙÙ 
,
ÙÙ  
byte
ÙÙ! %
[
ÙÙ% &
]
ÙÙ& '
)
ÙÙ' (
,
ÙÙ( )
NetworkFailure
ÙÙ* 8
>
ÙÙ8 9
.
ÙÙ9 :
Err
ÙÙ: =
(
ÙÙ= >
NetworkFailure
ıı 
.
ıı %
DataCenterNotResponding
ıı 6
(
ıı6 7
$str
ıı7 i
)
ııi j
)
ııj k
;
ıık l
}
ˆˆ 	
return
¯¯ 
Result
¯¯ 
<
¯¯ 
(
¯¯ 
uint
¯¯ 
,
¯¯ 
byte
¯¯ !
[
¯¯! "
]
¯¯" #
)
¯¯# $
,
¯¯$ %
NetworkFailure
¯¯& 4
>
¯¯4 5
.
¯¯5 6
Ok
¯¯6 8
(
¯¯8 9
(
¯¯9 :
	connectId
¯¯: C
,
¯¯C D
membershipId
¯¯E Q
)
¯¯Q R
)
¯¯R S
;
¯¯S T
}
˘˘ 
private
˚˚ 
async
˚˚ 
Task
˚˚ 
<
˚˚ 
Result
˚˚ 
<
˚˚ "
EcliptixSessionState
˚˚ 2
,
˚˚2 3
NetworkFailure
˚˚4 B
>
˚˚B C
>
˚˚C D%
LoadAndParseStoredState
˚˚E \
(
˚˚\ ]
uint
¸¸ 
	connectId
¸¸ 
,
¸¸ 
byte
˝˝ 
[
˝˝ 
]
˝˝ 
membershipId
˝˝ 
,
˝˝ 
bool
˛˛  
failOnMissingState
˛˛ 
,
˛˛  
string
ˇˇ 
failureMessage
ˇˇ 
)
ˇˇ 
{
ÄÄ 
Result
ÅÅ 
<
ÅÅ 
byte
ÅÅ 
[
ÅÅ 
]
ÅÅ 
,
ÅÅ "
SecureStorageFailure
ÅÅ +
>
ÅÅ+ ,
stateResult
ÅÅ- 8
=
ÅÅ9 :
await
ÇÇ (
secureProtocolStateStorage
ÇÇ ,
.
ÇÇ, -
LoadStateAsync
ÇÇ- ;
(
ÇÇ; <
	connectId
ÇÇ< E
.
ÇÇE F
ToString
ÇÇF N
(
ÇÇN O
)
ÇÇO P
,
ÇÇP Q
membershipId
ÇÇR ^
)
ÇÇ^ _
.
ÇÇ_ `
ConfigureAwait
ÇÇ` n
(
ÇÇn o
false
ÇÇo t
)
ÇÇt u
;
ÇÇu v
if
ÑÑ 

(
ÑÑ 
stateResult
ÑÑ 
.
ÑÑ 
IsErr
ÑÑ 
)
ÑÑ 
{
ÖÖ 	
return
ÜÜ 
Result
ÜÜ 
<
ÜÜ "
EcliptixSessionState
ÜÜ .
,
ÜÜ. /
NetworkFailure
ÜÜ0 >
>
ÜÜ> ?
.
ÜÜ? @
Err
ÜÜ@ C
(
ÜÜC D 
failOnMissingState
ÜÜD V
?
áá 
NetworkFailure
áá  
.
áá  !%
DataCenterNotResponding
áá! 8
(
áá8 9
$str
áá9 a
)
ááa b
:
àà 
NetworkFailure
àà  
.
àà  !%
DataCenterNotResponding
àà! 8
(
àà8 9
failureMessage
àà9 G
)
ààG H
)
ààH I
;
ààI J
}
ââ 	
try
ãã 
{
åå 	
byte
çç 
[
çç 
]
çç 

stateBytes
çç 
=
çç 
stateResult
çç  +
.
çç+ ,
Unwrap
çç, 2
(
çç2 3
)
çç3 4
;
çç4 5"
EcliptixSessionState
éé  
state
éé! &
=
éé' ("
EcliptixSessionState
éé) =
.
éé= >
Parser
éé> D
.
ééD E
	ParseFrom
ééE N
(
ééN O

stateBytes
ééO Y
)
ééY Z
;
ééZ [
return
èè 
Result
èè 
<
èè "
EcliptixSessionState
èè .
,
èè. /
NetworkFailure
èè0 >
>
èè> ?
.
èè? @
Ok
èè@ B
(
èèB C
state
èèC H
)
èèH I
;
èèI J
}
êê 	
catch
ëë 
(
ëë 
	Exception
ëë 
ex
ëë 
)
ëë 
{
íí 	
return
ìì 
Result
ìì 
<
ìì "
EcliptixSessionState
ìì .
,
ìì. /
NetworkFailure
ìì0 >
>
ìì> ?
.
ìì? @
Err
ìì@ C
(
ììC D
NetworkFailure
îî 
.
îî %
DataCenterNotResponding
îî 6
(
îî6 7
$"
îî7 9
$str
îî9 W
{
îîW X
ex
îîX Z
.
îîZ [
Message
îî[ b
}
îîb c
"
îîc d
)
îîd e
)
îîe f
;
îîf g
}
ïï 	
}
ññ 
private
òò 
void
òò '
PublishConnectionRestored
òò *
(
òò* +
uint
òò+ /
	connectId
òò0 9
)
òò9 :
{
ôô 
Avalonia
öö 
.
öö 
	Threading
öö 
.
öö 

Dispatcher
öö %
.
öö% &
UIThread
öö& .
.
öö. /
Post
öö/ 3
(
öö3 4
(
öö4 5
)
öö5 6
=>
öö7 9
{
õõ 	
_
úú 
=
úú !
connectivityService
úú #
.
úú# $
PublishAsync
úú$ 0
(
úú0 1 
ConnectivityIntent
ùù "
.
ùù" #
	Connected
ùù# ,
(
ùù, -
	connectId
ùù- 6
)
ùù6 7
)
ùù7 8
.
ùù8 9
ContinueWith
ùù9 E
(
ùùE F
task
ûû 
=>
ûû 
{
üü 
if
†† 
(
†† 
task
†† 
.
†† 
	IsFaulted
†† &
&&
††' )
task
††* .
.
††. /
	Exception
††/ 8
!=
††9 ;
null
††< @
)
††@ A
{
°° 
Log
¢¢ 
.
¢¢ 
Error
¢¢ !
(
¢¢! "
task
¢¢" &
.
¢¢& '
	Exception
¢¢' 0
,
¢¢0 1
$str¢¢2 á
)¢¢á à
;¢¢à â
}
££ 
}
§§ 
,
§§ 
TaskScheduler
•• 
.
•• 
Default
•• %
)
••% &
;
••& '
}
¶¶ 	
)
¶¶	 

;
¶¶
 
}
ßß 
private
©© 
void
©© +
ResetRetryStrategyAfterOutage
©© .
(
©©. /
)
©©/ 0
{
™™ 
foreach
´´ 
(
´´ 
KeyValuePair
´´ 
<
´´ 
uint
´´ "
,
´´" #$
EcliptixProtocolSystem
´´$ :
>
´´: ;

connection
´´< F
in
´´G I
_connections
´´J V
)
´´V W
{
¨¨ 	
retryStrategy
≠≠ 
.
≠≠ #
MarkConnectionHealthy
≠≠ /
(
≠≠/ 0

connection
≠≠0 :
.
≠≠: ;
Key
≠≠; >
)
≠≠> ?
;
≠≠? @
}
ÆÆ 	
}
ØØ 
private
±± 
static
±± 
string
±± +
BuildSecrecyChannelPendingKey
±± 7
(
±±7 8
uint
±±8 <
	connectId
±±= F
,
±±F G 
PubKeyExchangeType
±±H Z
EXCHANGE_TYPE
±±[ h
)
±±h i
=>
±±j l
$"
≤≤ 

$str
≤≤
 
{
≤≤ 
	connectId
≤≤ $
}
≤≤$ %
$str
≤≤% &
{
≤≤& '
EXCHANGE_TYPE
≤≤' 4
}
≤≤4 5
"
≤≤5 6
;
≤≤6 7
private
¥¥ 
static
¥¥ 
string
¥¥ +
BuildSecrecyChannelRestoreKey
¥¥ 7
(
¥¥7 8
uint
¥¥8 <
	connectId
¥¥= F
)
¥¥F G
=>
¥¥H J
$"
µµ 

$str
µµ
 "
{
µµ" #
	connectId
µµ# ,
}
µµ, -
"
µµ- .
;
µµ. /
private
∑∑ 
static
∑∑ 
bool
∑∑ ,
ShouldQueueSecrecyChannelRetry
∑∑ 6
(
∑∑6 7
NetworkFailure
∑∑7 E
failure
∑∑F M
)
∑∑M N
{
∏∏ 
return
ππ 
failure
ππ 
.
ππ 
FailureType
ππ "
is
ππ# % 
NetworkFailureType
ππ& 8
.
ππ8 9%
DataCenterNotResponding
ππ9 P
or
∫∫  
NetworkFailureType
∫∫ !
.
∫∫! " 
DataCenterShutdown
∫∫" 4
or
ªª  
NetworkFailureType
ªª !
.
ªª! "#
ProtocolStateMismatch
ªª" 7
or
ºº  
NetworkFailureType
ºº !
.
ºº! ""
RsaEncryptionFailure
ºº" 6
;
ºº6 7
}
ΩΩ 
private
øø 
void
øø /
!QueueSecrecyChannelEstablishRetry
øø 2
(
øø2 3
uint
øø3 7
	connectId
øø8 A
,
øøA B 
PubKeyExchangeType
øøC U
EXCHANGE_TYPE
øøV c
,
øøc d
int
øøe h
?
øøh i

maxRetries
øøj t
,
øøt u
bool
¿¿ 
	saveState
¿¿ 
)
¿¿ 
{
¡¡ 
if
¬¬ 

(
¬¬ 
	_disposed
¬¬ 
)
¬¬ 
{
√√ 	
return
ƒƒ 
;
ƒƒ 
}
≈≈ 	2
$BeginSecrecyChannelEstablishRecovery
«« ,
(
««, -
)
««- .
;
««. /
string
…… 

pendingKey
…… 
=
…… +
BuildSecrecyChannelPendingKey
…… 9
(
……9 :
	connectId
……: C
,
……C D
EXCHANGE_TYPE
……E R
)
……R S
;
……S T#
pendingRequestManager
ÀÀ 
.
ÀÀ $
RegisterPendingRequest
ÀÀ 4
(
ÀÀ4 5

pendingKey
ÀÀ5 ?
,
ÀÀ? @
async
ÀÀA F
ct
ÀÀG I
=>
ÀÀJ L
{
ÃÃ 	
CancellationToken
ÕÕ 
recoveryToken
ÕÕ +
=
ÕÕ, -(
GetConnectionRecoveryToken
ÕÕ. H
(
ÕÕH I
)
ÕÕI J
;
ÕÕJ K
using
ŒŒ %
CancellationTokenSource
ŒŒ )
	linkedCts
ŒŒ* 3
=
ŒŒ4 5%
CancellationTokenSource
œœ '
.
œœ' (%
CreateLinkedTokenSource
œœ( ?
(
œœ? @
ct
œœ@ B
,
œœB C
recoveryToken
œœD Q
)
œœQ R
;
œœR S
await
—— 2
$EstablishSecrecyChannelInternalAsync
—— 6
(
——6 7
	connectId
““ 
,
““ 
EXCHANGE_TYPE
”” !
,
””! "

maxRetries
‘‘ 
,
‘‘ 
	saveState
’’ 
,
’’ 
cancellationToken
÷÷ %
:
÷÷% &
	linkedCts
÷÷' 0
.
÷÷0 1
Token
÷÷1 6
,
÷÷6 7'
enablePendingRegistration
◊◊ -
:
◊◊- .
false
◊◊/ 4
)
◊◊4 5
.
ÿÿ 
ConfigureAwait
ÿÿ 
(
ÿÿ  
false
ÿÿ  %
)
ÿÿ% &
;
ÿÿ& '
}
ŸŸ 	
)
ŸŸ	 

;
ŸŸ
 
}
⁄⁄ 
private
‹‹ 
void
‹‹ -
QueueSecrecyChannelRestoreRetry
‹‹ 0
(
‹‹0 1"
EcliptixSessionState
›› 
sessionState
›› )
,
››) *)
ApplicationInstanceSettings
ﬁﬁ #)
applicationInstanceSettings
ﬁﬁ$ ?
,
ﬁﬁ? @
RestoreRetryMode
ﬂﬂ 
	retryMode
ﬂﬂ "
)
ﬂﬂ" #
{
‡‡ 
if
·· 

(
·· 
	_disposed
·· 
)
·· 
{
‚‚ 	
return
„„ 
;
„„ 
}
‰‰ 	2
$BeginSecrecyChannelEstablishRecovery
ÊÊ ,
(
ÊÊ, -
)
ÊÊ- .
;
ÊÊ. /
string
ËË 

pendingKey
ËË 
=
ËË +
BuildSecrecyChannelRestoreKey
ËË 9
(
ËË9 :
sessionState
ËË: F
.
ËËF G
	ConnectId
ËËG P
)
ËËP Q
;
ËËQ R#
pendingRequestManager
ÍÍ 
.
ÍÍ $
RegisterPendingRequest
ÍÍ 4
(
ÍÍ4 5

pendingKey
ÍÍ5 ?
,
ÍÍ? @
async
ÍÍA F
ct
ÍÍG I
=>
ÍÍJ L
{
ÎÎ 	
CancellationToken
ÏÏ 
recoveryToken
ÏÏ +
=
ÏÏ, -(
GetConnectionRecoveryToken
ÏÏ. H
(
ÏÏH I
)
ÏÏI J
;
ÏÏJ K
using
ÌÌ %
CancellationTokenSource
ÌÌ )
	linkedCts
ÌÌ* 3
=
ÌÌ4 5%
CancellationTokenSource
ÓÓ '
.
ÓÓ' (%
CreateLinkedTokenSource
ÓÓ( ?
(
ÓÓ? @
ct
ÓÓ@ B
,
ÓÓB C
recoveryToken
ÓÓD Q
)
ÓÓQ R
;
ÓÓR S
await
 (
RestoreSecrecyChannelAsync
 ,
(
, -
sessionState
ÒÒ  
,
ÒÒ  !)
applicationInstanceSettings
ÚÚ /
,
ÚÚ/ 0
	retryMode
ÛÛ 
,
ÛÛ '
enablePendingRegistration
ÙÙ -
:
ÙÙ- .
false
ÙÙ/ 4
,
ÙÙ4 5
cancellationToken
ıı %
:
ıı% &
	linkedCts
ıı' 0
.
ıı0 1
Token
ıı1 6
)
ıı6 7
.
ˆˆ 
ConfigureAwait
ˆˆ 
(
ˆˆ  
false
ˆˆ  %
)
ˆˆ% &
;
ˆˆ& '
}
˜˜ 	
)
˜˜	 

;
˜˜
 
}
¯¯ 
private
˙˙ 
byte
˙˙ 
[
˙˙ 
]
˙˙ 
?
˙˙ "
GetMembershipIdBytes
˙˙ (
(
˙˙( )
)
˙˙) *
{
˚˚ 
if
¸¸ 

(
¸¸ 
!
¸¸ *
_applicationInstanceSettings
¸¸ )
.
¸¸) *
IsSome
¸¸* 0
)
¸¸0 1
{
˝˝ 	
return
˛˛ 
null
˛˛ 
;
˛˛ 
}
ˇˇ 	)
ApplicationInstanceSettings
ÅÅ #
settings
ÅÅ$ ,
=
ÅÅ- .*
_applicationInstanceSettings
ÅÅ/ K
.
ÅÅK L
Value
ÅÅL Q
!
ÅÅQ R
;
ÅÅR S
return
ÉÉ 
settings
ÉÉ 
.
ÉÉ 

Membership
ÉÉ "
?
ÉÉ" #
.
ÉÉ# $
UniqueIdentifier
ÉÉ$ 4
.
ÉÉ4 5
ToByteArray
ÉÉ5 @
(
ÉÉ@ A
)
ÉÉA B
;
ÉÉB C
}
ÑÑ 
private
ÜÜ 
async
ÜÜ 
Task
ÜÜ &
PersistSessionStateAsync
ÜÜ /
(
ÜÜ/ 0"
EcliptixSessionState
ÜÜ0 D
state
ÜÜE J
,
ÜÜJ K
uint
ÜÜL P
	connectId
ÜÜQ Z
,
ÜÜZ [
byte
áá 
[
áá 
]
áá 
?
áá "
membershipIdOverride
áá $
=
áá% &
null
áá' +
)
áá+ ,
{
àà 
byte
ââ 
[
ââ 
]
ââ 
?
ââ 
membershipId
ââ 
=
ââ "
membershipIdOverride
ââ 3
??
ââ4 6"
GetMembershipIdBytes
ââ7 K
(
ââK L
)
ââL M
;
ââM N
if
ää 

(
ää 
membershipId
ää 
==
ää 
null
ää  
)
ää  !
{
ãã 	
Log
åå 
.
åå 
Warning
åå 
(
åå 
$str
åå s
,
åås t
	connectId
çç 
)
çç 
;
çç 
return
éé 
;
éé 
}
èè 	
Result
ëë 
<
ëë 
Unit
ëë 
,
ëë "
SecureStorageFailure
ëë )
>
ëë) *

saveResult
ëë+ 5
=
ëë6 7
await
ëë8 =%
SecureByteStringInterop
ëë> U
.
ëëU V"
WithByteStringAsSpan
ëëV j
(
ëëj k
state
íí 
.
íí 
ToByteString
íí "
(
íí" #
)
íí# $
,
íí$ %
span
ìì 
=>
ìì (
secureProtocolStateStorage
ìì 2
.
ìì2 3
SaveStateAsync
ìì3 A
(
ììA B
span
ììB F
.
ììF G
ToArray
ììG N
(
ììN O
)
ììO P
,
ììP Q
	connectId
ììR [
.
ìì[ \
ToString
ìì\ d
(
ììd e
)
ììe f
,
ììf g
membershipId
ììh t
)
ììt u
)
ììu v
.
îî 
ConfigureAwait
îî 
(
îî 
false
îî !
)
îî! "
;
îî" #
if
ññ 

(
ññ 

saveResult
ññ 
.
ññ 
IsErr
ññ 
)
ññ 
{
óó 	
Log
òò 
.
òò 
Warning
òò 
(
òò 
$str
òò u
,
òòu v
	connectId
ôô 
,
ôô 

saveResult
ôô %
.
ôô% &
	UnwrapErr
ôô& /
(
ôô/ 0
)
ôô0 1
.
ôô1 2
Message
ôô2 9
)
ôô9 :
;
ôô: ;
}
öö 	
string
úú 
timestampKey
úú 
=
úú 
$"
úú  
{
úú  !
	connectId
úú! *
}
úú* +
$str
úú+ 5
"
úú5 6
;
úú6 7
await
ùù .
 applicationSecureStorageProvider
ùù .
.
ùù. /

StoreAsync
ùù/ 9
(
ùù9 :
timestampKey
ùù: F
,
ùùF G
BitConverter
ûû 
.
ûû 
GetBytes
ûû !
(
ûû! "
DateTime
ûû" *
.
ûû* +
UtcNow
ûû+ 1
.
ûû1 2
ToBinary
ûû2 :
(
ûû: ;
)
ûû; <
)
ûû< =
)
ûû= >
.
ûû> ?
ConfigureAwait
ûû? M
(
ûûM N
false
ûûN S
)
ûûS T
;
ûûT U
}
üü 
public
°° 

bool
°° !
IsConnectionHealthy
°° #
(
°°# $
uint
°°$ (
	connectId
°°) 2
)
°°2 3
{
¢¢ 
if
££ 

(
££ 
!
££ 
_connections
££ 
.
££ 
TryGetValue
££ %
(
££% &
	connectId
££& /
,
££/ 0
out
££1 4$
EcliptixProtocolSystem
££5 K
?
££K L
protocolSystem
££M [
)
££[ \
)
££\ ]
{
§§ 	
return
•• 
false
•• 
;
•• 
}
¶¶ 	(
EcliptixProtocolConnection
®® "
?
®®" #

connection
®®$ .
=
®®/ 0
protocolSystem
®®1 ?
.
®®? @
GetConnection
®®@ M
(
®®M N
)
®®N O
;
®®O P
if
©© 

(
©© 

connection
©© 
==
©© 
null
©© 
)
©© 
{
™™ 	
return
´´ 
false
´´ 
;
´´ 
}
¨¨ 	
Result
ÆÆ 
<
ÆÆ "
LocalPublicKeyBundle
ÆÆ #
,
ÆÆ# $%
EcliptixProtocolFailure
ÆÆ% <
>
ÆÆ< =
peerBundleResult
ÆÆ> N
=
ÆÆO P

connection
ÆÆQ [
.
ÆÆ[ \
GetPeerBundle
ÆÆ\ i
(
ÆÆi j
)
ÆÆj k
;
ÆÆk l
return
ØØ 
peerBundleResult
ØØ 
.
ØØ  
IsOk
ØØ  $
;
ØØ$ %
}
∞∞ 
public
≤≤ 

async
≤≤ 
Task
≤≤ 
<
≤≤ 
Result
≤≤ 
<
≤≤ 
bool
≤≤ !
,
≤≤! "
NetworkFailure
≤≤# 1
>
≤≤1 2
>
≤≤2 3'
TryRestoreConnectionAsync
≤≤4 M
(
≤≤M N
uint
≤≤N R
	connectId
≤≤S \
)
≤≤\ ]
{
≥≥ 
return
¥¥ 
await
¥¥ 
WithChannelGate
¥¥ $
(
¥¥$ %
	connectId
¥¥% .
,
¥¥. /
async
¥¥0 5
(
¥¥6 7
)
¥¥7 8
=>
¥¥9 ;
{
µµ 	
try
∂∂ 
{
∑∑ 
byte
∏∏ 
[
∏∏ 
]
∏∏ 
?
∏∏ 
membershipId
∏∏ $
=
∏∏% &"
GetMembershipIdBytes
∏∏' ;
(
∏∏; <
)
∏∏< =
;
∏∏= >
if
ππ 
(
ππ 
membershipId
ππ  
==
ππ! #
null
ππ$ (
)
ππ( )
{
∫∫ 
if
ªª 
(
ªª 
_connections
ªª $
.
ªª$ %
	TryRemove
ªª% .
(
ªª. /
	connectId
ªª/ 8
,
ªª8 9
out
ªª: =$
EcliptixProtocolSystem
ªª> T
?
ªªT U
	oldSystem
ªªV _
)
ªª_ `
)
ªª` a
{
ºº 
	oldSystem
ΩΩ !
.
ΩΩ! "
Dispose
ΩΩ" )
(
ΩΩ) *
)
ΩΩ* +
;
ΩΩ+ ,
}
ææ 
Result
¿¿ 
<
¿¿ 
Option
¿¿ !
<
¿¿! ""
EcliptixSessionState
¿¿" 6
>
¿¿6 7
,
¿¿7 8
NetworkFailure
¿¿9 G
>
¿¿G H
reEstablishResult
¿¿I Z
=
¿¿[ \
await
¡¡ 2
$EstablishSecrecyChannelInternalAsync
¡¡ B
(
¡¡B C
	connectId
¬¬ %
,
¬¬% & 
PubKeyExchangeType
√√ .
.
√√. /(
DataCenterEphemeralConnect
√√/ I
,
√√I J
	saveState
ƒƒ %
:
ƒƒ% &
false
ƒƒ' ,
,
ƒƒ, -'
enablePendingRegistration
≈≈ 5
:
≈≈5 6
false
≈≈7 <
)
≈≈< =
.
≈≈= >
ConfigureAwait
≈≈> L
(
≈≈L M
false
≈≈M R
)
≈≈R S
;
≈≈S T
return
«« 
reEstablishResult
«« ,
.
««, -
IsOk
««- 1
?
»» 
Result
»»  
<
»»  !
bool
»»! %
,
»»% &
NetworkFailure
»»' 5
>
»»5 6
.
»»6 7
Ok
»»7 9
(
»»9 :
true
»»: >
)
»»> ?
:
…… 
Result
……  
<
……  !
bool
……! %
,
……% &
NetworkFailure
……' 5
>
……5 6
.
……6 7
Ok
……7 9
(
……9 :
false
……: ?
)
……? @
;
……@ A
}
   
Result
ÃÃ 
<
ÃÃ 
byte
ÃÃ 
[
ÃÃ 
]
ÃÃ 
,
ÃÃ "
SecureStorageFailure
ÃÃ 3
>
ÃÃ3 4
stateResult
ÃÃ5 @
=
ÃÃA B
await
ÕÕ (
secureProtocolStateStorage
ÕÕ 4
.
ÕÕ4 5
LoadStateAsync
ÕÕ5 C
(
ÕÕC D
	connectId
ÕÕD M
.
ÕÕM N
ToString
ÕÕN V
(
ÕÕV W
)
ÕÕW X
,
ÕÕX Y
membershipId
ÕÕZ f
)
ÕÕf g
.
ŒŒ 
ConfigureAwait
ŒŒ '
(
ŒŒ' (
false
ŒŒ( -
)
ŒŒ- .
;
ŒŒ. /
if
œœ 
(
œœ 
stateResult
œœ 
.
œœ  
IsErr
œœ  %
)
œœ% &
{
–– 
return
—— 
Result
—— !
<
——! "
bool
——" &
,
——& '
NetworkFailure
——( 6
>
——6 7
.
——7 8
Ok
——8 :
(
——: ;
false
——; @
)
——@ A
;
——A B
}
““ 
byte
‘‘ 
[
‘‘ 
]
‘‘ 

stateBytes
‘‘ !
=
‘‘" #
stateResult
‘‘$ /
.
‘‘/ 0
Unwrap
‘‘0 6
(
‘‘6 7
)
‘‘7 8
;
‘‘8 9"
EcliptixSessionState
’’ $
state
’’% *
=
’’+ ,"
EcliptixSessionState
’’- A
.
’’A B
Parser
’’B H
.
’’H I
	ParseFrom
’’I R
(
’’R S

stateBytes
’’S ]
)
’’] ^
;
’’^ _
Result
÷÷ 
<
÷÷ 
bool
÷÷ 
,
÷÷ 
NetworkFailure
÷÷ +
>
÷÷+ ,
restoreResult
÷÷- :
=
÷÷; <
await
◊◊ (
RestoreSecrecyChannelAsync
◊◊ 4
(
◊◊4 5
state
◊◊5 :
,
◊◊: ;*
_applicationInstanceSettings
◊◊< X
.
◊◊X Y
Value
◊◊Y ^
!
◊◊^ _
)
◊◊_ `
.
◊◊` a
ConfigureAwait
◊◊a o
(
◊◊o p
false
◊◊p u
)
◊◊u v
;
◊◊v w
return
ŸŸ 
restoreResult
ŸŸ $
;
ŸŸ$ %
}
⁄⁄ 
catch
€€ 
(
€€ 
	Exception
€€ 
)
€€ 
{
‹‹ 
return
›› 
Result
›› 
<
›› 
bool
›› "
,
››" #
NetworkFailure
››$ 2
>
››2 3
.
››3 4
Ok
››4 6
(
››6 7
false
››7 <
)
››< =
;
››= >
}
ﬁﬁ 
}
ﬂﬂ 	
)
ﬂﬂ	 

;
ﬂﬂ
 
}
‡‡ 
public
‚‚ 

async
‚‚ 
Task
‚‚ 
<
‚‚ 
Result
‚‚ 
<
‚‚ 
Unit
‚‚ !
,
‚‚! "
NetworkFailure
‚‚# 1
>
‚‚1 2
>
‚‚2 30
"RecreateProtocolWithMasterKeyAsync
‚‚4 V
(
‚‚V W&
SodiumSecureMemoryHandle
„„  
masterKeyHandle
„„! 0
,
„„0 1

ByteString
‰‰ "
membershipIdentifier
‰‰ '
,
‰‰' (
uint
ÂÂ 
	connectId
ÂÂ 
)
ÂÂ 
{
ÊÊ 
RetryBehavior
ÁÁ 
retryBehavior
ÁÁ #
=
ÁÁ$ %!
retryPolicyProvider
ËË 
.
ËË  
GetRetryBehavior
ËË  0
(
ËË0 1
RpcServiceType
ËË1 ?
.
ËË? @1
#EstablishAuthenticatedSecureChannel
ËË@ c
)
ËËc d
;
ËËd e
Result
ÈÈ 
<
ÈÈ 
Unit
ÈÈ 
,
ÈÈ 
NetworkFailure
ÈÈ #
>
ÈÈ# $
networkResult
ÈÈ% 2
=
ÈÈ3 4
await
ÈÈ5 :
retryStrategy
ÈÈ; H
.
ÈÈH I&
ExecuteRpcOperationAsync
ÈÈI a
(
ÈÈa b
async
ÍÍ 
(
ÍÍ 
_
ÍÍ 
,
ÍÍ 
_
ÍÍ 
)
ÍÍ 
=>
ÍÍ 
await
ÍÍ !8
*RecreateProtocolWithMasterKeyAsyncInternal
ÍÍ" L
(
ÍÍL M
masterKeyHandle
ÎÎ 
,
ÎÎ  "
membershipIdentifier
ÏÏ $
,
ÏÏ$ %
	connectId
ÌÌ 
)
ÌÌ 
.
ÌÌ 
ConfigureAwait
ÌÌ )
(
ÌÌ) *
false
ÌÌ* /
)
ÌÌ/ 0
,
ÌÌ0 1
$str
ÓÓ +
,
ÓÓ+ ,
	connectId
ÔÔ 
,
ÔÔ 
serviceType
 
:
 
RpcServiceType
 '
.
' (1
#EstablishAuthenticatedSecureChannel
( K
,
K L

maxRetries
ÒÒ 
:
ÒÒ 
retryBehavior
ÒÒ %
.
ÒÒ% &
MAX_ATTEMPTS
ÒÒ& 2
-
ÒÒ3 4
$num
ÒÒ5 6
,
ÒÒ6 7
cancellationToken
ÚÚ 
:
ÚÚ 
CancellationToken
ÚÚ 0
.
ÚÚ0 1
None
ÚÚ1 5
)
ÚÚ5 6
.
ÚÚ6 7
ConfigureAwait
ÚÚ7 E
(
ÚÚE F
false
ÚÚF K
)
ÚÚK L
;
ÚÚL M
if
ÙÙ 

(
ÙÙ 
networkResult
ÙÙ 
.
ÙÙ 
IsOk
ÙÙ 
&&
ÙÙ !
Volatile
ÙÙ" *
.
ÙÙ* +
Read
ÙÙ+ /
(
ÙÙ/ 0
ref
ÙÙ0 3
_outageState
ÙÙ4 @
)
ÙÙ@ A
==
ÙÙB D
$num
ÙÙE F
)
ÙÙF G
{
ıı 	

ExitOutage
ˆˆ 
(
ˆˆ 
)
ˆˆ 
;
ˆˆ 
}
˜˜ 	
return
˘˘ 
networkResult
˘˘ 
;
˘˘ 
}
˙˙ 
private
¸¸ 
async
¸¸ 
Task
¸¸ 
<
¸¸ 
Result
¸¸ 
<
¸¸ 
Unit
¸¸ "
,
¸¸" #
NetworkFailure
¸¸$ 2
>
¸¸2 3
>
¸¸3 48
*RecreateProtocolWithMasterKeyAsyncInternal
¸¸5 _
(
¸¸_ `&
SodiumSecureMemoryHandle
˝˝  
masterKeyHandle
˝˝! 0
,
˝˝0 1

ByteString
˛˛ "
membershipIdentifier
˛˛ '
,
˛˛' (
uint
ˇˇ 
	connectId
ˇˇ 
)
ˇˇ 
{
ÄÄ 
byte
ÅÅ 
[
ÅÅ 
]
ÅÅ 
?
ÅÅ 
masterKeyBytes
ÅÅ 
=
ÅÅ  
null
ÅÅ! %
;
ÅÅ% &
byte
ÇÇ 
[
ÇÇ 
]
ÇÇ 
?
ÇÇ 
rootKeyBytes
ÇÇ 
=
ÇÇ 
null
ÇÇ #
;
ÇÇ# $
try
ÑÑ 
{
ÖÖ 	
Result
ÜÜ 
<
ÜÜ 
byte
ÜÜ 
[
ÜÜ 
]
ÜÜ 
,
ÜÜ 
SodiumFailure
ÜÜ (
>
ÜÜ( )

readResult
ÜÜ* 4
=
ÜÜ5 6
masterKeyHandle
ÜÜ7 F
.
ÜÜF G
	ReadBytes
ÜÜG P
(
ÜÜP Q
masterKeyHandle
ÜÜQ `
.
ÜÜ` a
Length
ÜÜa g
)
ÜÜg h
;
ÜÜh i
if
áá 
(
áá 

readResult
áá 
.
áá 
IsErr
áá  
)
áá  !
{
àà 
return
ââ 
Result
ââ 
<
ââ 
Unit
ââ "
,
ââ" #
NetworkFailure
ââ$ 2
>
ââ2 3
.
ââ3 4
Err
ââ4 7
(
ââ7 8
NetworkFailure
ää "
.
ää" #%
DataCenterNotResponding
ää# :
(
ää: ;
$"
ãã 
$str
ãã 5
{
ãã5 6

readResult
ãã6 @
.
ãã@ A
	UnwrapErr
ããA J
(
ããJ K
)
ããK L
.
ããL M
Message
ããM T
}
ããT U
"
ããU V
)
ããV W
)
ããW X
;
ããX Y
}
åå 
masterKeyBytes
éé 
=
éé 

readResult
éé '
.
éé' (
Unwrap
éé( .
(
éé. /
)
éé/ 0
;
éé0 1
string
èè 
membershipId
èè 
=
èè  !
Helpers
èè" )
.
èè) *"
FromByteStringToGuid
èè* >
(
èè> ?"
membershipIdentifier
èè? S
)
èèS T
.
èèT U
ToString
èèU ]
(
èè] ^
)
èè^ _
;
èè_ `
rootKeyBytes
ëë 
=
ëë 
new
ëë 
byte
ëë #
[
ëë# $$
CryptographicConstants
ëë$ :
.
ëë: ;
AES_KEY_SIZE
ëë; G
]
ëëG H
;
ëëH I
HKDF
íí 
.
íí 
	DeriveKey
íí 
(
íí 
HashAlgorithmName
ìì !
.
ìì! "
SHA256
ìì" (
,
ìì( )
ikm
îî 
:
îî 
masterKeyBytes
îî #
,
îî# $
output
ïï 
:
ïï 
rootKeyBytes
ïï $
,
ïï$ %
salt
ññ 
:
ññ 
null
ññ 
,
ññ 
info
óó 
:
óó 
$str
óó 4
.
óó4 5
ToArray
óó5 <
(
óó< =
)
óó= >
)
òò 
;
òò 
Result
öö 
<
öö (
EcliptixSystemIdentityKeys
öö -
,
öö- .%
EcliptixProtocolFailure
öö/ F
>
ööF G 
identityKeysResult
ööH Z
=
öö[ \(
EcliptixSystemIdentityKeys
õõ *
.
õõ* +!
CreateFromMasterKey
õõ+ >
(
õõ> ?
masterKeyBytes
õõ? M
,
õõM N
membershipId
õõO [
,
õõ[ \
NetworkConstants
úú $
.
úú$ %
Protocol
úú% -
.
úú- .(
DEFAULT_ONE_TIME_KEY_COUNT
úú. H
)
úúH I
;
úúI J
if
ûû 
(
ûû  
identityKeysResult
ûû "
.
ûû" #
IsErr
ûû# (
)
ûû( )
{
üü 
return
†† 
Result
†† 
<
†† 
Unit
†† "
,
††" #
NetworkFailure
††$ 2
>
††2 3
.
††3 4
Err
††4 7
(
††7 8 
identityKeysResult
°° &
.
°°& '
	UnwrapErr
°°' 0
(
°°0 1
)
°°1 2
.
°°2 3
ToNetworkFailure
°°3 C
(
°°C D
)
°°D E
)
°°E F
;
°°F G
}
¢¢ (
EcliptixSystemIdentityKeys
§§ &
identityKeys
§§' 3
=
§§4 5 
identityKeysResult
§§6 H
.
§§H I
Unwrap
§§I O
(
§§O P
)
§§P Q
;
§§Q R
if
¶¶ 
(
¶¶ 
_connections
¶¶ 
.
¶¶ 
	TryRemove
¶¶ &
(
¶¶& '
	connectId
¶¶' 0
,
¶¶0 1
out
¶¶2 5$
EcliptixProtocolSystem
¶¶6 L
?
¶¶L M
oldProtocol
¶¶N Y
)
¶¶Y Z
)
¶¶Z [
{
ßß +
CancelOperationsForConnection
®® -
(
®®- .
	connectId
®®. 7
)
®®7 8
;
®®8 9
oldProtocol
©© 
.
©© 
Dispose
©© #
(
©©# $
)
©©$ %
;
©©% &
}
™™ 
const
¨¨  
PubKeyExchangeType
¨¨ $
EXCHANGE_TYPE
¨¨% 2
=
¨¨3 4 
PubKeyExchangeType
¨¨5 G
.
¨¨G H(
DataCenterEphemeralConnect
¨¨H b
;
¨¨b c$
EcliptixProtocolSystem
≠≠ "
?
≠≠" #
newProtocol
≠≠$ /
=
≠≠0 1
new
≠≠2 5
(
≠≠5 6
identityKeys
≠≠6 B
)
≠≠B C
;
≠≠C D
try
ØØ 
{
∞∞ 
newProtocol
±± 
.
±± 
SetEventHandler
±± +
(
±±+ ,
this
±±, 0
)
±±0 1
;
±±1 2
Result
≥≥ 
<
≥≥ 
PubKeyExchange
≥≥ %
,
≥≥% &%
EcliptixProtocolFailure
≥≥' >
>
≥≥> ?"
clientExchangeResult
≥≥@ T
=
≥≥U V
newProtocol
¥¥ 
.
¥¥  +
BeginDataCenterPubKeyExchange
¥¥  =
(
¥¥= >
	connectId
¥¥> G
,
¥¥G H
EXCHANGE_TYPE
¥¥I V
)
¥¥V W
;
¥¥W X
if
∂∂ 
(
∂∂ "
clientExchangeResult
∂∂ (
.
∂∂( )
IsErr
∂∂) .
)
∂∂. /
{
∑∑ 
await
∏∏ .
 CleanupFailedAuthenticationAsync
∏∏ :
(
∏∏: ;
	connectId
∏∏; D
)
∏∏D E
.
∏∏E F
ConfigureAwait
∏∏F T
(
∏∏T U
false
∏∏U Z
)
∏∏Z [
;
∏∏[ \
return
ππ 
Result
ππ !
<
ππ! "
Unit
ππ" &
,
ππ& '
NetworkFailure
ππ( 6
>
ππ6 7
.
ππ7 8
Err
ππ8 ;
(
ππ; <"
clientExchangeResult
∫∫ ,
.
∫∫, -
	UnwrapErr
∫∫- 6
(
∫∫6 7
)
∫∫7 8
.
∫∫8 9
ToNetworkFailure
∫∫9 I
(
∫∫I J
)
∫∫J K
)
∫∫K L
;
∫∫L M
}
ªª 
PubKeyExchange
ΩΩ 
clientExchange
ΩΩ -
=
ΩΩ. /"
clientExchangeResult
ΩΩ0 D
.
ΩΩD E
Unwrap
ΩΩE K
(
ΩΩK L
)
ΩΩL M
;
ΩΩM N+
AuthenticatedEstablishRequest
øø -"
authenticatedRequest
øø. B
=
øøC D
new
øøE H
(
øøH I
)
øøI J
{
¿¿  
MembershipUniqueId
¡¡ &
=
¡¡' ("
membershipIdentifier
¡¡) =
,
¡¡= >"
ClientPubKeyExchange
¬¬ (
=
¬¬) *
clientExchange
¬¬+ 9
}
√√ 
;
√√ 
Result
≈≈ 
<
≈≈ 
SecureEnvelope
≈≈ %
,
≈≈% &
NetworkFailure
≈≈' 5
>
≈≈5 6"
serverResponseResult
≈≈7 K
=
≈≈L M
await
∆∆ 
rpcServiceManager
∆∆ +
.
∆∆+ ,6
(EstablishAuthenticatedSecureChannelAsync
∆∆, T
(
∆∆T U!
connectivityService
«« +
,
««+ ,"
authenticatedRequest
««- A
)
««A B
.
««B C
ConfigureAwait
««C Q
(
««Q R
false
««R W
)
««W X
;
««X Y
if
…… 
(
…… "
serverResponseResult
…… (
.
……( )
IsErr
……) .
)
……. /
{
   
NetworkFailure
ÀÀ "
failure
ÀÀ# *
=
ÀÀ+ ,"
serverResponseResult
ÀÀ- A
.
ÀÀA B
	UnwrapErr
ÀÀB K
(
ÀÀK L
)
ÀÀL M
;
ÀÀM N
await
ÃÃ .
 CleanupFailedAuthenticationAsync
ÃÃ :
(
ÃÃ: ;
	connectId
ÃÃ; D
)
ÃÃD E
.
ÃÃE F
ConfigureAwait
ÃÃF T
(
ÃÃT U
false
ÃÃU Z
)
ÃÃZ [
;
ÃÃ[ \
return
ÕÕ 
Result
ÕÕ !
<
ÕÕ! "
Unit
ÕÕ" &
,
ÕÕ& '
NetworkFailure
ÕÕ( 6
>
ÕÕ6 7
.
ÕÕ7 8
Err
ÕÕ8 ;
(
ÕÕ; <
failure
ÕÕ< C
)
ÕÕC D
;
ÕÕD E
}
ŒŒ 
SecureEnvelope
–– 
responseEnvelope
–– /
=
––0 1"
serverResponseResult
––2 F
.
––F G
Unwrap
––G M
(
––M N
)
––N O
;
––O P
Option
““ 
<
““ '
CertificatePinningService
““ 0
>
““0 1'
certificatePinningService
““2 K
=
““L M
await
”” .
 certificatePinningServiceFactory
”” :
.
””: ;)
GetOrInitializeServiceAsync
””; V
(
””V W
)
””W X
;
””X Y
if
’’ 
(
’’ 
!
’’ '
certificatePinningService
’’ .
.
’’. /
IsSome
’’/ 5
)
’’5 6
{
÷÷ 
await
◊◊ .
 CleanupFailedAuthenticationAsync
◊◊ :
(
◊◊: ;
	connectId
◊◊; D
)
◊◊D E
.
◊◊E F
ConfigureAwait
◊◊F T
(
◊◊T U
false
◊◊U Z
)
◊◊Z [
;
◊◊[ \
return
ÿÿ 
Result
ÿÿ !
<
ÿÿ! "
Unit
ÿÿ" &
,
ÿÿ& '
NetworkFailure
ÿÿ( 6
>
ÿÿ6 7
.
ÿÿ7 8
Err
ÿÿ8 ;
(
ÿÿ; <
NetworkFailure
ŸŸ &
.
ŸŸ& '
RsaEncryption
ŸŸ' 4
(
ŸŸ4 5
$str
ŸŸ5 g
)
ŸŸg h
)
ŸŸh i
;
ŸŸi j
}
⁄⁄ 
byte
‹‹ 
[
‹‹ 
]
‹‹ '
combinedEncryptedResponse
‹‹ 0
=
‹‹1 2
responseEnvelope
‹‹3 C
.
‹‹C D
EncryptedPayload
‹‹D T
.
‹‹T U
ToByteArray
‹‹U `
(
‹‹` a
)
‹‹a b
;
‹‹b c
Result
›› 
<
›› 
byte
›› 
[
›› 
]
›› 
,
›› 
NetworkFailure
›› -
>
››- .
decryptResult
››/ <
=
››= >
rsaChunkEncryptor
ﬁﬁ %
.
ﬁﬁ% &
DecryptInChunks
ﬁﬁ& 5
(
ﬁﬁ5 6'
certificatePinningService
ﬁﬁ6 O
.
ﬁﬁO P
Value
ﬁﬁP U
!
ﬁﬁU V
,
ﬁﬁV W'
combinedEncryptedResponse
ﬁﬁX q
)
ﬁﬁq r
;
ﬁﬁr s
if
‡‡ 
(
‡‡ 
decryptResult
‡‡ !
.
‡‡! "
IsErr
‡‡" '
)
‡‡' (
{
·· 
await
‚‚ .
 CleanupFailedAuthenticationAsync
‚‚ :
(
‚‚: ;
	connectId
‚‚; D
)
‚‚D E
.
‚‚E F
ConfigureAwait
‚‚F T
(
‚‚T U
false
‚‚U Z
)
‚‚Z [
;
‚‚[ \
return
„„ 
Result
„„ !
<
„„! "
Unit
„„" &
,
„„& '
NetworkFailure
„„( 6
>
„„6 7
.
„„7 8
Err
„„8 ;
(
„„; <
decryptResult
„„< I
.
„„I J
	UnwrapErr
„„J S
(
„„S T
)
„„T U
)
„„U V
;
„„V W
}
‰‰ 
PubKeyExchange
ÊÊ 
serverExchange
ÊÊ -
=
ÊÊ. /
PubKeyExchange
ÊÊ0 >
.
ÊÊ> ?
Parser
ÊÊ? E
.
ÊÊE F
	ParseFrom
ÊÊF O
(
ÊÊO P
decryptResult
ÊÊP ]
.
ÊÊ] ^
Unwrap
ÊÊ^ d
(
ÊÊd e
)
ÊÊe f
)
ÊÊf g
;
ÊÊg h
Result
ËË 
<
ËË 
Unit
ËË 
,
ËË %
EcliptixProtocolFailure
ËË 4
>
ËË4 5
completeResult
ËË6 D
=
ËËE F
newProtocol
ÈÈ 
.
ÈÈ  1
#CompleteAuthenticatedPubKeyExchange
ÈÈ  C
(
ÈÈC D
serverExchange
ÈÈD R
,
ÈÈR S
rootKeyBytes
ÈÈT `
)
ÈÈ` a
;
ÈÈa b
if
ÎÎ 
(
ÎÎ 
completeResult
ÎÎ "
.
ÎÎ" #
IsErr
ÎÎ# (
)
ÎÎ( )
{
ÏÏ 
await
ÌÌ .
 CleanupFailedAuthenticationAsync
ÌÌ :
(
ÌÌ: ;
	connectId
ÌÌ; D
)
ÌÌD E
.
ÌÌE F
ConfigureAwait
ÌÌF T
(
ÌÌT U
false
ÌÌU Z
)
ÌÌZ [
;
ÌÌ[ \
return
ÓÓ 
Result
ÓÓ !
<
ÓÓ! "
Unit
ÓÓ" &
,
ÓÓ& '
NetworkFailure
ÓÓ( 6
>
ÓÓ6 7
.
ÓÓ7 8
Err
ÓÓ8 ;
(
ÓÓ; <
completeResult
ÔÔ &
.
ÔÔ& '
	UnwrapErr
ÔÔ' 0
(
ÔÔ0 1
)
ÔÔ1 2
.
ÔÔ2 3
ToNetworkFailure
ÔÔ3 C
(
ÔÔC D
)
ÔÔD E
)
ÔÔE F
;
ÔÔF G
}
 
_connections
ÚÚ 
.
ÚÚ 
TryAdd
ÚÚ #
(
ÚÚ# $
	connectId
ÚÚ$ -
,
ÚÚ- .
newProtocol
ÚÚ/ :
)
ÚÚ: ;
;
ÚÚ; <(
EcliptixProtocolConnection
ÙÙ *
?
ÙÙ* +

connection
ÙÙ, 6
=
ÙÙ7 8
newProtocol
ÙÙ9 D
.
ÙÙD E
GetConnection
ÙÙE R
(
ÙÙR S
)
ÙÙS T
;
ÙÙT U
if
ıı 
(
ıı 

connection
ıı 
!=
ıı !
null
ıı" &
)
ıı& '
{
ˆˆ 
Result
˜˜ 
<
˜˜ "
EcliptixSessionState
˜˜ /
,
˜˜/ 0%
EcliptixProtocolFailure
˜˜1 H
>
˜˜H I 
sessionStateResult
˜˜J \
=
˜˜] ^
identityKeys
¯¯ $
.
¯¯$ %
ToProtoState
¯¯% 1
(
¯¯1 2
)
¯¯2 3
.
˘˘ 
AndThen
˘˘ $
(
˘˘$ %
identityKeysProto
˘˘% 6
=>
˘˘7 9

connection
˘˘: D
.
˘˘D E
ToProtoState
˘˘E Q
(
˘˘Q R
)
˘˘R S
.
˙˙  !
Map
˙˙! $
(
˙˙$ %
ratchetStateProto
˙˙% 6
=>
˙˙7 9
new
˙˙: ="
EcliptixSessionState
˙˙> R
{
˚˚  !
	ConnectId
¸¸$ -
=
¸¸. /
	connectId
¸¸0 9
,
¸¸9 :
IdentityKeys
˝˝$ 0
=
˝˝1 2
identityKeysProto
˝˝3 D
,
˝˝D E"
PeerHandshakeMessage
˛˛$ 8
=
˛˛9 :
serverExchange
˛˛; I
,
˛˛I J
RatchetState
ˇˇ$ 0
=
ˇˇ1 2
ratchetStateProto
ˇˇ3 D
}
ÄÄ  !
)
ÄÄ! "
)
ÅÅ 
;
ÅÅ 
if
ÉÉ 
(
ÉÉ  
sessionStateResult
ÉÉ *
.
ÉÉ* +
IsOk
ÉÉ+ /
)
ÉÉ/ 0
{
ÑÑ "
EcliptixSessionState
ÖÖ ,
sessionState
ÖÖ- 9
=
ÖÖ: ; 
sessionStateResult
ÖÖ< N
.
ÖÖN O
Unwrap
ÖÖO U
(
ÖÖU V
)
ÖÖV W
;
ÖÖW X
await
áá &
PersistSessionStateAsync
áá 6
(
áá6 7
sessionState
áá7 C
,
ááC D
	connectId
ááE N
,
ááN O"
membershipIdentifier
ááP d
.
áád e
ToByteArray
ááe p
(
ááp q
)
ááq r
)
áár s
.
àà 
ConfigureAwait
àà +
(
àà+ ,
false
àà, 1
)
àà1 2
;
àà2 3
}
ââ 
}
ää 
newProtocol
åå 
=
åå 
null
åå "
;
åå" #
return
çç 
Result
çç 
<
çç 
Unit
çç "
,
çç" #
NetworkFailure
çç$ 2
>
çç2 3
.
çç3 4
Ok
çç4 6
(
çç6 7
Unit
çç7 ;
.
çç; <
Value
çç< A
)
ççA B
;
ççB C
}
éé 
finally
èè 
{
êê 
newProtocol
ëë 
?
ëë 
.
ëë 
Dispose
ëë $
(
ëë$ %
)
ëë% &
;
ëë& '
}
íí 
}
ìì 	
catch
îî 
(
îî 
	Exception
îî 
ex
îî 
)
îî 
{
ïï 	
return
ññ 
Result
ññ 
<
ññ 
Unit
ññ 
,
ññ 
NetworkFailure
ññ  .
>
ññ. /
.
ññ/ 0
Err
ññ0 3
(
ññ3 4
NetworkFailure
óó 
.
óó %
DataCenterNotResponding
óó 6
(
óó6 7
$"
óó7 9
$str
óó9 V
{
óóV W
ex
óóW Y
.
óóY Z
Message
óóZ a
}
óóa b
"
óób c
)
óóc d
)
óód e
;
óóe f
}
òò 	
finally
ôô 
{
öö 	
if
õõ 
(
õõ 
masterKeyBytes
õõ 
!=
õõ !
null
õõ" &
)
õõ& '
{
úú %
CryptographicOperations
ùù '
.
ùù' (

ZeroMemory
ùù( 2
(
ùù2 3
masterKeyBytes
ùù3 A
)
ùùA B
;
ùùB C
}
ûû 
if
†† 
(
†† 
rootKeyBytes
†† 
!=
†† 
null
††  $
)
††$ %
{
°° %
CryptographicOperations
¢¢ '
.
¢¢' (

ZeroMemory
¢¢( 2
(
¢¢2 3
rootKeyBytes
¢¢3 ?
)
¢¢? @
;
¢¢@ A
}
££ 
}
§§ 	
}
•• 
private
ßß 
async
ßß 
Task
ßß .
 CleanupFailedAuthenticationAsync
ßß 7
(
ßß7 8
uint
ßß8 <
	connectId
ßß= F
)
ßßF G
{
®® 
Result
©© 
<
©© 
Unit
©© 
,
©© "
SecureStorageFailure
©© )
>
©©) *
deleteResult
©©+ 7
=
©©8 9
await
™™ (
secureProtocolStateStorage
™™ ,
.
™™, -
DeleteStateAsync
™™- =
(
™™= >
	connectId
™™> G
.
™™G H
ToString
™™H P
(
™™P Q
)
™™Q R
)
™™R S
.
™™S T
ConfigureAwait
™™T b
(
™™b c
false
™™c h
)
™™h i
;
™™i j
if
¨¨ 

(
¨¨ 
deleteResult
¨¨ 
.
¨¨ 
IsErr
¨¨ 
)
¨¨ 
{
≠≠ 	
Log
ÆÆ 
.
ÆÆ 
Warning
ÆÆ 
(
ÆÆ 
$strØØ ç
,ØØç é
	connectId
∞∞ 
,
∞∞ 
deleteResult
∞∞ '
.
∞∞' (
	UnwrapErr
∞∞( 1
(
∞∞1 2
)
∞∞2 3
.
∞∞3 4
Message
∞∞4 ;
)
∞∞; <
;
∞∞< =
}
±± 	
}
≤≤ 
}≥≥ ö
ê/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Core/Constants/NetworkConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Core/ 3
.3 4
	Constants4 =
;= >
public 
static 
class 
NetworkConstants $
{ 
public 

static 
class 
Protocol  
{ 
public		 
const		 
int		 &
DEFAULT_ONE_TIME_KEY_COUNT		 3
=		4 5
$num		6 7
;		7 8
public

 
const

 
uint

 "
OPERATION_ID_MIN_VALUE

 0
=

1 2
$num

3 5
;

5 6
public 
const 
uint '
OPERATION_ID_RESERVED_RANGE 5
=6 7
$num8 :
;: ;
public 
const 
int )
REQUEST_KEY_HEX_PREFIX_LENGTH 6
=7 8
$num9 ;
;; <
} 
public 

static 
class 
Cryptography $
{ 
public 
const 
int 
SHA_256_HASH_SIZE *
=+ ,
$num- /
;/ 0
} 
public 

static 
class 
Timeouts  
{ 
public 
static 
readonly 
TimeSpan '!
OutageRecoveryTimeout( =
=> ?
TimeSpan@ H
.H I
FromSecondsI T
(T U
$numU V
)V W
;W X
} 
public 

static 
class 
ErrorMessages %
{ 
public 
const 
string '
SESSION_NOT_FOUND_ON_SERVER 7
=8 9
$str: W
;W X
} 
} ù

ï/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Core/Constants/GrpcErrorMetadataKeys.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Core/ 3
.3 4
	Constants4 =
;= >
public 
static 
class !
GrpcErrorMetadataKeys )
{ 
public 

const 
string 

ERROR_CODE "
=# $
$str% 1
;1 2
public 

const 
string 
	I_18N_KEY !
=" #
$str$ .
;. /
public 

const 
string 
LOCALE 
=  
$str! )
;) *
public 

const 
string 
CORRELATION_ID &
=' (
$str) 9
;9 :
public		 

const		 
string		 
	RETRYABLE		 !
=		" #
$str		$ /
;		/ 0
public

 

const

 
string

 $
RETRY_AFTER_MILLISECONDS

 0
=

1 2
$str

3 C
;

C D
} “
¶/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Core/Connectivity/InternetConnectivityObserverOptions.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Core/ 3
.3 4
Connectivity4 @
;@ A
public 
record /
#InternetConnectivityObserverOptions 1
{ 
public 

static /
#InternetConnectivityObserverOptions 5
Default6 =
{> ?
get@ C
;C D
}E F
=G H
newI L
(L M
)M N
;N O
public

 

IReadOnlyList

 
<

 
string

 
>

  
	ProbeUrls

! *
{

+ ,
get

- 0
;

0 1
init

2 6
;

6 7
}

8 9
=

: ;
[

< =
$str -
,- .
$str -
] 
; 
public 

TimeSpan 
PollingInterval #
{$ %
get& )
;) *
init+ /
;/ 0
}1 2
=3 4
TimeSpan5 =
.= >
FromSeconds> I
(I J
$numJ K
)K L
;L M
public 

TimeSpan 
ProbeTimeout  
{! "
get# &
;& '
init( ,
;, -
}. /
=0 1
TimeSpan2 :
.: ;
FromSeconds; F
(F G
$numG H
)H I
;I J
public 

int 
FailureThreshold 
{  !
get" %
;% &
init' +
;+ ,
}- .
=/ 0
$num1 2
;2 3
public 

int 
SuccessThreshold 
{  !
get" %
;% &
init' +
;+ ,
}- .
=/ 0
$num1 2
;2 3
} æi
ü/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Core/Connectivity/InternetConnectivityObserver.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Core/ 3
.3 4
Connectivity4 @
;@ A
internal 
sealed	 
class (
InternetConnectivityObserver 2
:3 4)
IInternetConnectivityObserver5 R
{ 
public 

const 
string 
HTTP_CLIENT_NAME (
=) *
$str+ L
;L M
private 
const 
int &
NETWORK_CHANGE_THROTTLE_MS 0
=1 2
$num3 6
;6 7
private 
const 
int #
FAILURE_POLLING_SECONDS -
=. /
$num0 1
;1 2
private 
readonly 
IHttpClientFactory '
_httpClientFactory( :
;: ;
private 
readonly 
IObservable  
<  !
bool! %
>% &#
_connectivityObservable' >
;> ?
private 
readonly 
CompositeDisposable (
_disposables) 5
=6 7
new8 ;
(; <
)< =
;= >
private 
readonly #
CancellationTokenSource ,$
_cancellationTokenSource- E
=F G
newH K
(K L
)L M
;M N
private 
readonly 
Subject 
< 
Unit !
>! "
_manualProbeTrigger# 6
=7 8
new9 <
(< =
)= >
;> ?
private 
readonly /
#InternetConnectivityObserverOptions 8
_options9 A
;A B
public 
(
InternetConnectivityObserver '
(' (
IHttpClientFactory 
httpClientFactory ,
,, -

IScheduler 
uiScheduler 
, /
#InternetConnectivityObserverOptions   +
currentOptions  , :
)  : ;
{!! 
if"" 

("" 
currentOptions"" 
=="" 
null"" "
)""" #
{## 	
throw$$ 
new$$ !
ArgumentNullException$$ +
($$+ ,
nameof$$, 2
($$2 3
currentOptions$$3 A
)$$A B
)$$B C
;$$C D
}%% 	
if'' 

('' 
currentOptions'' 
.'' 
	ProbeUrls'' $
==''% '
null''( ,
||''- /
!''0 1
currentOptions''1 ?
.''? @
	ProbeUrls''@ I
.''I J
Any''J M
(''M N
)''N O
)''O P
{(( 	
throw)) 
new)) 
ArgumentException)) '
())' (
$str))( K
,))K L
nameof))M S
())S T
currentOptions))T b
)))b c
)))c d
;))d e
}** 	
_httpClientFactory,, 
=,, 
httpClientFactory,, .
;,,. /
_options-- 
=-- 
currentOptions-- !
;--! "
BehaviorSubject// 
<// 
TimeSpan//  
>//  !"
pollingIntervalSubject//" 8
=//9 :
new//; >
(//> ?
currentOptions//? M
.//M N
PollingInterval//N ]
)//] ^
;//^ _
IObservable11 
<11 
Unit11 
>11 #
networkChangeObservable11 1
=112 3

Observable114 >
.22 
	FromEvent22 
<22 -
!NetworkAddressChangedEventHandler22 8
,228 9
EventPattern22: F
<22F G
	EventArgs22G P
>22P Q
>22Q R
(22R S
handler33 
=>33 
(33 
sender33 "
,33" #
e33$ %
)33% &
=>33' )
handler33* 1
(331 2
new332 5
EventPattern336 B
<33B C
	EventArgs33C L
>33L M
(33M N
sender33N T
,33T U
e33V W
)33W X
)33X Y
,33Y Z
h44 
=>44 
NetworkChange44 "
.44" #!
NetworkAddressChanged44# 8
+=449 ;
new44< ?-
!NetworkAddressChangedEventHandler44@ a
(44a b
(44b c
s44c d
,44d e
e44f g
)44g h
=>44i k
h44l m
(44m n
s44n o
,44o p
e44q r
)44r s
)44s t
,44t u
h55 
=>55 
NetworkChange55 "
.55" #!
NetworkAddressChanged55# 8
-=559 ;
new55< ?-
!NetworkAddressChangedEventHandler55@ a
(55a b
(55b c
s55c d
,55d e
e55f g
)55g h
=>55i k
h55l m
(55m n
s55n o
,55o p
e55q r
)55r s
)55s t
)55t u
.66 
Throttle66 
(66 
TimeSpan66 
.66 
FromMilliseconds66 /
(66/ 0&
NETWORK_CHANGE_THROTTLE_MS660 J
)66J K
)66K L
.77 
Select77 
(77 
_77 
=>77 
Unit77 
.77 
Default77 %
)77% &
;77& '
IObservable99 
<99 
bool99 
>99 
probeObservable99 )
=99* +"
pollingIntervalSubject99, B
.::  
DistinctUntilChanged:: !
(::! "
)::" #
.;; 
Select;; 
(;; 
interval;; 
=>;; 

Observable;;  *
.;;* +
Timer;;+ 0
(;;0 1
TimeSpan;;1 9
.;;9 :
Zero;;: >
,;;> ?
interval;;@ H
,;;H I
	Scheduler;;J S
.;;S T
Default;;T [
);;[ \
);;\ ]
.<< 
Switch<< 
(<< 
)<< 
.== 
Select== 
(== 
_== 
=>== 
Unit== 
.== 
Default== %
)==% &
.>> 
Merge>> 
(>> 
_manualProbeTrigger>> &
)>>& '
.?? 
Merge?? 
(?? #
networkChangeObservable?? *
)??* +
.@@ 

SelectMany@@ 
(@@ 
_@@ 
=>@@ "
ProbeConnectivityAsync@@ 3
(@@3 4
_options@@4 <
,@@< =$
_cancellationTokenSource@@> V
.@@V W
Token@@W \
)@@\ ]
)@@] ^
;@@^ _#
_connectivityObservableBB 
=BB  !
probeObservableBB" 1
.CC 
ScanCC 
(CC 
seedDD 
:DD 
(DD 
countDD 
:DD 
$numDD 
,DD  
stateDD! &
:DD& '
trueDD( ,
)DD, -
,DD- .
accumulatorEE 
:EE 
(EE 
accEE !
,EE! "
	isSuccessEE# ,
)EE, -
=>EE. 0
accFF 
.FF 
stateFF 
==FF  
	isSuccessFF! *
?GG 
(GG 
accGG 
.GG 
countGG $
+GG% &
$numGG' (
,GG( )
accGG* -
.GG- .
stateGG. 3
)GG3 4
:HH 
(HH 
$numHH 
,HH 
	isSuccessHH '
)HH' (
)HH( )
.II 
DoII 
(II 
accII 
=>II 
{JJ 
TimeSpanKK 
currentIntervalKK (
=KK) *"
pollingIntervalSubjectKK+ A
.KKA B
ValueKKB G
;KKG H
TimeSpanLL 
desiredIntervalLL (
=LL) *
!LL+ ,
accLL, /
.LL/ 0
stateLL0 5
?MM 
TimeSpanMM 
.MM 
FromSecondsMM *
(MM* +#
FAILURE_POLLING_SECONDSMM+ B
)MMB C
:NN 
currentOptionsNN $
.NN$ %
PollingIntervalNN% 4
;NN4 5
ifPP 
(PP 
currentIntervalPP #
!=PP$ &
desiredIntervalPP' 6
)PP6 7
{QQ "
pollingIntervalSubjectRR *
.RR* +
OnNextRR+ 1
(RR1 2
desiredIntervalRR2 A
)RRA B
;RRB C
}SS 
}TT 
)TT 
.UU 
WhereUU 
(UU 
accUU 
=>UU 
{VV 
(WW 
intWW 
countWW 
,WW 
boolWW  
stateWW! &
)WW& '
=WW( )
accWW* -
;WW- .
intXX 
	thresholdXX 
=XX 
stateXX  %
?XX& '
currentOptionsXX( 6
.XX6 7
SuccessThresholdXX7 G
:XXH I
currentOptionsXXJ X
.XXX Y
FailureThresholdXXY i
;XXi j
returnYY 
countYY 
>=YY 
	thresholdYY  )
;YY) *
}ZZ 
)ZZ 
.[[ 
Select[[ 
([[ 
acc[[ 
=>[[ 
acc[[ 
.[[ 
state[[ $
)[[$ %
.\\  
DistinctUntilChanged\\ !
(\\! "
)\\" #
.]] 
	ObserveOn]] 
(]] 
uiScheduler]] "
)]]" #
.^^ 
Replay^^ 
(^^ 
$num^^ 
)^^ 
.__ 
RefCount__ 
(__ 
)__ 
;__ 
}`` 
privatebb 
asyncbb 
Taskbb 
<bb 
boolbb 
>bb "
ProbeConnectivityAsyncbb 3
(bb3 4/
#InternetConnectivityObserverOptionscc +
optionscc, 3
,cc3 4
CancellationTokendd 
ctdd 
)dd 
{ee 

HttpClientff 

httpClientff 
=ff 
_httpClientFactoryff  2
.ff2 3
CreateClientff3 ?
(ff? @
HTTP_CLIENT_NAMEff@ P
)ffP Q
;ffQ R
foreachhh 
(hh 
stringhh 
urlhh 
inhh 
optionshh &
.hh& '
	ProbeUrlshh' 0
)hh0 1
{ii 	
ifjj 
(jj 
ctjj 
.jj #
IsCancellationRequestedjj *
)jj* +
{kk 
returnll 
falsell 
;ll 
}mm 
tryoo 
{pp 
usingqq #
CancellationTokenSourceqq -
	linkedCtsqq. 7
=qq8 9#
CancellationTokenSourceqq: Q
.qqQ R#
CreateLinkedTokenSourceqqR i
(qqi j
ctqqj l
)qql m
;qqm n
	linkedCtsrr 
.rr 
CancelAfterrr %
(rr% &
optionsrr& -
.rr- .
ProbeTimeoutrr. :
)rr: ;
;rr; <
usingtt 
HttpRequestMessagett (
requesttt) 0
=tt1 2
newtt3 6
(tt6 7

HttpMethodtt7 A
.ttA B
HeadttB F
,ttF G
urlttH K
)ttK L
;ttL M
HttpResponseMessageuu #
responseuu$ ,
=uu- .
awaituu/ 4

httpClientuu5 ?
.uu? @
	SendAsyncuu@ I
(uuI J
requestuuJ Q
,uuQ R 
HttpCompletionOptionvv (
.vv( )
ResponseHeadersReadvv) <
,vv< =
	linkedCtsvv> G
.vvG H
TokenvvH M
)vvM N
;vvN O
ifxx 
(xx 
responsexx 
.xx 
IsSuccessStatusCodexx 0
)xx0 1
{yy 
returnzz 
truezz 
;zz  
}{{ 
}|| 
catch}} 
(}} 
	Exception}} 
)}} 
{~~ 
}
ÄÄ 
}
ÅÅ 	
return
ÉÉ 
false
ÉÉ 
;
ÉÉ 
}
ÑÑ 
public
ÜÜ 

IDisposable
ÜÜ 
	Subscribe
ÜÜ  
(
ÜÜ  !
	IObserver
ÜÜ! *
<
ÜÜ* +
bool
ÜÜ+ /
>
ÜÜ/ 0
observer
ÜÜ1 9
)
ÜÜ9 :
=>
ÜÜ; =%
_connectivityObservable
áá 
.
áá  
	Subscribe
áá  )
(
áá) *
observer
áá* 2
)
áá2 3
;
áá3 4
public
ââ 

void
ââ 
Dispose
ââ 
(
ââ 
)
ââ 
{
ää 
if
ãã 

(
ãã 
!
ãã &
_cancellationTokenSource
ãã %
.
ãã% &%
IsCancellationRequested
ãã& =
)
ãã= >
{
åå 	&
_cancellationTokenSource
çç $
.
çç$ %
Cancel
çç% +
(
çç+ ,
)
çç, -
;
çç- .
}
éé 	&
_cancellationTokenSource
êê  
.
êê  !
Dispose
êê! (
(
êê( )
)
êê) *
;
êê* +!
_manualProbeTrigger
ëë 
.
ëë 
Dispose
ëë #
(
ëë# $
)
ëë$ %
;
ëë% &
_disposables
íí 
.
íí 
Dispose
íí 
(
íí 
)
íí 
;
íí 
}
ìì 
}îî Í
ù/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Core/Connectivity/InternetConnectivityBridge.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Core/ 3
.3 4
Connectivity4 @
;@ A
internal 
sealed	 
class &
InternetConnectivityBridge 0
:1 2
IDisposable3 >
{		 
private

 
readonly

  
IConnectivityService

 ) 
_connectivityService

* >
;

> ?
private 
readonly 
IDisposable  
_subscription! .
;. /
private 
bool 
	_disposed 
; 
public 
&
InternetConnectivityBridge %
(% &)
IInternetConnectivityObserver % 
connectivityObserver& :
,: ; 
IConnectivityService 
connectivityService 0
)0 1
{  
_connectivityService 
= 
connectivityService 2
;2 3
_subscription 
=  
connectivityObserver ,
., -
	Subscribe- 6
(6 7
async7 <
isOnline= E
=>F H
{ 	
if 
( 
	_disposed 
) 
{ 
return 
; 
} 
ConnectivityIntent 
intent %
=& '
isOnline( 0
? 
ConnectivityIntent $
.$ %
InternetRecovered% 6
(6 7
)7 8
: 
ConnectivityIntent $
.$ %
InternetLost% 1
(1 2
)2 3
;3 4
await  
_connectivityService &
.& '
PublishAsync' 3
(3 4
intent4 :
): ;
.; <
ConfigureAwait< J
(J K
falseK P
)P Q
;Q R
}   	
)  	 

;  
 
}!! 
public## 

void## 
Dispose## 
(## 
)## 
{$$ 
if%% 

(%% 
	_disposed%% 
)%% 
{&& 	
return'' 
;'' 
}(( 	
	_disposed** 
=** 
true** 
;** 
_subscription++ 
.++ 
Dispose++ 
(++ 
)++ 
;++  
},, 
}-- ©
ú/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Abstractions/Transport/IRpcMetaDataProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Abstractions/ ;
.; <
	Transport< E
;E F
public 
	interface  
IRpcMetaDataProvider %
{ 
Guid 
AppInstanceId	 
{ 
get 
; 
} 
Guid 
DeviceId	 
{ 
get 
; 
} 
string		 

?		
 
CULTURE		 
{		 
get		 
;		 
}		 
string

 

LocalIpAddress

 
{

 
get

 
;

  
}

! "
string 

?
 
PublicIpAddress 
{ 
get !
;! "
}# $
string 

Platform 
{ 
get 
; 
} 
void 

SetAppInfo	 
( 
Guid 
appInstanceId &
,& '
Guid( ,
deviceId- 5
,5 6
string7 =
?= >
culture? F
)F G
;G H
void 

SetCulture	 
( 
string 
? 
culture #
)# $
;$ %
} Ñ
ï/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Abstractions/Transport/IOutboundSink.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Abstractions/ ;
.; <
	Transport< E
;E F
public 
	interface 
IOutboundSink 
{		 
Task

 
<

 	
Result

	 
<

 
Unit

 
,

 
NetworkFailure

 $
>

$ %
>

% &
	SendAsync

' 0
(

0 1
SecureEnvelope

1 ?
envelope

@ H
)

H I
;

I J
} ˙
†/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Abstractions/Core/IInternetConnectivityObserver.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Abstractions/ ;
.; <
Core< @
;@ A
public 
	interface )
IInternetConnectivityObserver .
:/ 0
IObservable1 <
<< =
bool= A
>A B
,B C
IDisposableD O
;O PÂ
ú/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Data/SecureStorage/Configuration/SecureStoreOptions.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Data' +
.+ ,
SecureStorage, 9
.9 :
Configuration: G
;G H
public 
sealed 
class 
SecureStoreOptions &
{ 
public 

string  
ENCRYPTED_STATE_PATH &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
=5 6
$str7 Y
;Y Z
} ò
ò/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Abstractions/Transport/INetworkProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Abstractions/ ;
.; <
	Transport< E
;E F
public 
	interface 
INetworkProvider !
{ 
uint "
ComputeUniqueConnectId	 
(  
PubKeyExchangeType  2
pubKeyExchangeType3 E
)E F
;F G
} £ò
ú/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Data/SecureStorage/ApplicationSecureStorageProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Data' +
.+ ,
SecureStorage, 9
;9 :
internal 
sealed	 
class ,
 ApplicationSecureStorageProvider 6
:7 8-
!IApplicationSecureStorageProvider9 Z
{ 
private 
const 
string 
SETTINGS_KEY %
=& '
$str( E
;E F
private 
readonly 
IDataProtector #

_protector$ .
;. /
private 
readonly 
string 
_storagePath (
;( )
private 
bool 
	_disposed 
; 
public   
,
 ApplicationSecureStorageProvider   +
(  + ,
IOptions!! 
<!! 
SecureStoreOptions!! #
>!!# $
options!!% ,
,!!, -#
IDataProtectionProvider"" "
dataProtectionProvider""  6
)""6 7
{## 
SecureStoreOptions$$ 
opts$$ 
=$$  !
options$$" )
.$$) *
Value$$* /
;$$/ 0
_storagePath&& 
=&& 
opts&& 
.&&  
ENCRYPTED_STATE_PATH&& 0
;&&0 1

_protector'' 
='' "
dataProtectionProvider'' +
.''+ ,
CreateProtector'', ;
(''; <
$str''< W
)''W X
;''X Y&
InitializeStorageDirectory)) "
())" #
)))# $
;))$ %
}** 
public,, 

async,, 
Task,, 
<,, 
Result,, 
<,, 
Unit,, !
,,,! "%
InternalServiceApiFailure,,# <
>,,< =
>,,= >.
"SetApplicationSettingsCultureAsync,,? a
(,,a b
string,,b h
?,,h i
cultureName,,j u
),,u v
{-- 
Result.. 
<.. '
ApplicationInstanceSettings.. *
,..* +%
InternalServiceApiFailure.., E
>..E F
settingsResult..G U
=..V W
await// /
#GetApplicationInstanceSettingsAsync// 5
(//5 6
)//6 7
;//7 8
if00 

(00 
settingsResult00 
.00 
IsErr00  
)00  !
{11 	
return22 
Result22 
<22 
Unit22 
,22 %
InternalServiceApiFailure22  9
>229 :
.22: ;
Err22; >
(22> ?
settingsResult22? M
.22M N
	UnwrapErr22N W
(22W X
)22X Y
)22Y Z
;22Z [
}33 	'
ApplicationInstanceSettings55 #
settings55$ ,
=55- .
settingsResult55/ =
.55= >
Unwrap55> D
(55D E
)55E F
;55F G
settings66 
.66 
Culture66 
=66 
cultureName66 &
;66& '
return88 
await88 #
SecureByteStringInterop88 ,
.88, - 
WithByteStringAsSpan88- A
(88A B
settings88B J
.88J K
ToByteString88K W
(88W X
)88X Y
,88Y Z
span99 
=>99 

StoreAsync99 
(99 
SETTINGS_KEY99 +
,99+ ,
span99- 1
.991 2
ToArray992 9
(999 :
)99: ;
)99; <
)99< =
;99= >
}:: 
public<< 

async<< 
Task<< 
<<< 
Result<< 
<<< 
Unit<< !
,<<! "%
InternalServiceApiFailure<<# <
><<< =
><<= >'
SetApplicationInstanceAsync<<? Z
(<<Z [
bool<<[ _
isNewInstance<<` m
)<<m n
{== 
Result>> 
<>> '
ApplicationInstanceSettings>> *
,>>* +%
InternalServiceApiFailure>>, E
>>>E F
settingsResult>>G U
=>>V W
await?? /
#GetApplicationInstanceSettingsAsync?? 5
(??5 6
)??6 7
;??7 8
if@@ 

(@@ 
settingsResult@@ 
.@@ 
IsErr@@  
)@@  !
{AA 	
returnBB 
ResultBB 
<BB 
UnitBB 
,BB %
InternalServiceApiFailureBB  9
>BB9 :
.BB: ;
ErrBB; >
(BB> ?
settingsResultBB? M
.BBM N
	UnwrapErrBBN W
(BBW X
)BBX Y
)BBY Z
;BBZ [
}CC 	'
ApplicationInstanceSettingsEE #
settingsEE$ ,
=EE- .
settingsResultEE/ =
.EE= >
UnwrapEE> D
(EED E
)EEE F
;EEF G
settingsFF 
.FF 
IsNewInstanceFF 
=FF  
isNewInstanceFF! .
;FF. /
returnGG 
awaitGG #
SecureByteStringInteropGG ,
.GG, - 
WithByteStringAsSpanGG- A
(GGA B
settingsGGB J
.GGJ K
ToByteStringGGK W
(GGW X
)GGX Y
,GGY Z
spanHH 
=>HH 

StoreAsyncHH 
(HH 
SETTINGS_KEYHH +
,HH+ ,
spanHH- 1
.HH1 2
ToArrayHH2 9
(HH9 :
)HH: ;
)HH; <
)HH< =
;HH= >
}II 
publicKK 

asyncKK 
TaskKK 
<KK 
ResultKK 
<KK 
UnitKK !
,KK! "%
InternalServiceApiFailureKK# <
>KK< =
>KK= >(
SetApplicationIpCountryAsyncKK? [
(KK[ \
	IpCountryKK\ e
	ipCountryKKf o
)KKo p
{LL 
ResultMM 
<MM '
ApplicationInstanceSettingsMM *
,MM* +%
InternalServiceApiFailureMM, E
>MME F
settingsResultMMG U
=MMV W
awaitNN /
#GetApplicationInstanceSettingsAsyncNN 5
(NN5 6
)NN6 7
;NN7 8
ifOO 

(OO 
settingsResultOO 
.OO 
IsErrOO  
)OO  !
{PP 	
returnQQ 
ResultQQ 
<QQ 
UnitQQ 
,QQ %
InternalServiceApiFailureQQ  9
>QQ9 :
.QQ: ;
ErrQQ; >
(QQ> ?
settingsResultQQ? M
.QQM N
	UnwrapErrQQN W
(QQW X
)QQX Y
)QQY Z
;QQZ [
}RR 	'
ApplicationInstanceSettingsTT #
settingsTT$ ,
=TT- .
settingsResultTT/ =
.TT= >
UnwrapTT> D
(TTD E
)TTE F
;TTF G
settingsUU 
.UU 
CountryUU 
=UU 
	ipCountryUU $
.UU$ %
CountryUU% ,
;UU, -
returnWW 
awaitWW #
SecureByteStringInteropWW ,
.WW, - 
WithByteStringAsSpanWW- A
(WWA B
settingsWWB J
.WWJ K
ToByteStringWWK W
(WWW X
)WWX Y
,WWY Z
spanXX 
=>XX 

StoreAsyncXX 
(XX 
SETTINGS_KEYXX +
,XX+ ,
spanXX- 1
.XX1 2
ToArrayXX2 9
(XX9 :
)XX: ;
)XX; <
)XX< =
;XX= >
}YY 
public[[ 

async[[ 
Task[[ 
<[[ 
Result[[ 
<[[ 
Unit[[ !
,[[! "%
InternalServiceApiFailure[[# <
>[[< =
>[[= >)
SetApplicationMembershipAsync[[? \
([[\ ]

Membership[[] g
?[[g h

membership[[i s
)[[s t
{\\ 
Result]] 
<]] '
ApplicationInstanceSettings]] *
,]]* +%
InternalServiceApiFailure]], E
>]]E F
settingsResult]]G U
=]]V W
await^^ /
#GetApplicationInstanceSettingsAsync^^ 5
(^^5 6
)^^6 7
;^^7 8
if__ 

(__ 
settingsResult__ 
.__ 
IsErr__  
)__  !
{`` 	
returnaa 
Resultaa 
<aa 
Unitaa 
,aa %
InternalServiceApiFailureaa  9
>aa9 :
.aa: ;
Erraa; >
(aa> ?
settingsResultaa? M
.aaM N
	UnwrapErraaN W
(aaW X
)aaX Y
)aaY Z
;aaZ [
}bb 	'
ApplicationInstanceSettingsdd #
settingsdd$ ,
=dd- .
settingsResultdd/ =
.dd= >
Unwrapdd> D
(ddD E
)ddE F
;ddF G
settingsee 
.ee 

Membershipee 
=ee 

membershipee (
;ee( )
returngg 
awaitgg #
SecureByteStringInteropgg ,
.gg, - 
WithByteStringAsSpangg- A
(ggA B
settingsggB J
.ggJ K
ToByteStringggK W
(ggW X
)ggX Y
,ggY Z
spanhh 
=>hh 

StoreAsynchh 
(hh 
SETTINGS_KEYhh +
,hh+ ,
spanhh- 1
.hh1 2
ToArrayhh2 9
(hh9 :
)hh: ;
)hh; <
)hh< =
;hh= >
}ii 
publickk 

asynckk 
Taskkk 
<kk 
Resultkk 
<kk 
Unitkk !
,kk! "%
InternalServiceApiFailurekk# <
>kk< =
>kk= >$
SetCurrentAccountIdAsynckk? W
(kkW X

ByteStringkkX b
?kkb c
	accountIdkkd m
)kkm n
{ll 
Resultmm 
<mm '
ApplicationInstanceSettingsmm *
,mm* +%
InternalServiceApiFailuremm, E
>mmE F
settingsResultmmG U
=mmV W
awaitnn /
#GetApplicationInstanceSettingsAsyncnn 5
(nn5 6
)nn6 7
;nn7 8
ifoo 

(oo 
settingsResultoo 
.oo 
IsErroo  
)oo  !
{pp 	
returnqq 
Resultqq 
<qq 
Unitqq 
,qq %
InternalServiceApiFailureqq  9
>qq9 :
.qq: ;
Errqq; >
(qq> ?
settingsResultqq? M
.qqM N
	UnwrapErrqqN W
(qqW X
)qqX Y
)qqY Z
;qqZ [
}rr 	'
ApplicationInstanceSettingstt #
settingstt$ ,
=tt- .
settingsResulttt/ =
.tt= >
Unwraptt> D
(ttD E
)ttE F
;ttF G
settingsuu 
.uu 
CurrentAccountIduu !
=uu" #
	accountIduu$ -
??uu. 0

ByteStringuu1 ;
.uu; <
Emptyuu< A
;uuA B
returnww 
awaitww #
SecureByteStringInteropww ,
.ww, - 
WithByteStringAsSpanww- A
(wwA B
settingswwB J
.wwJ K
ToByteStringwwK W
(wwW X
)wwX Y
,wwY Z
spanxx 
=>xx 

StoreAsyncxx 
(xx 
SETTINGS_KEYxx +
,xx+ ,
spanxx- 1
.xx1 2
ToArrayxx2 9
(xx9 :
)xx: ;
)xx; <
)xx< =
;xx= >
}yy 
public{{ 

async{{ 
Task{{ 
<{{ 
Result{{ 
<{{ '
ApplicationInstanceSettings{{ 8
,{{8 9%
InternalServiceApiFailure{{: S
>{{S T
>{{T U/
#GetApplicationInstanceSettingsAsync|| +
(||+ ,
)||, -
{}} 
Result~~ 
<~~ 
Option~~ 
<~~ 
byte~~ 
[~~ 
]~~ 
>~~ 
,~~ %
InternalServiceApiFailure~~ 8
>~~8 9
	getResult~~: C
=~~D E
await~~F K
TryGetByKeyAsync~~L \
(~~\ ]
SETTINGS_KEY~~] i
)~~i j
;~~j k
if 

( 
	getResult 
. 
IsErr 
) 
{
ÄÄ 	
return
ÅÅ 
Result
ÅÅ 
<
ÅÅ )
ApplicationInstanceSettings
ÅÅ 5
,
ÅÅ5 6'
InternalServiceApiFailure
ÅÅ7 P
>
ÅÅP Q
.
ÅÅQ R
Err
ÅÅR U
(
ÅÅU V
	getResult
ÅÅV _
.
ÅÅ_ `
	UnwrapErr
ÅÅ` i
(
ÅÅi j
)
ÅÅj k
)
ÅÅk l
;
ÅÅl m
}
ÇÇ 	
Option
ÑÑ 
<
ÑÑ 
byte
ÑÑ 
[
ÑÑ 
]
ÑÑ 
>
ÑÑ 
	maybeData
ÑÑ  
=
ÑÑ! "
	getResult
ÑÑ# ,
.
ÑÑ, -
Unwrap
ÑÑ- 3
(
ÑÑ3 4
)
ÑÑ4 5
;
ÑÑ5 6
if
ÖÖ 

(
ÖÖ 
!
ÖÖ 
	maybeData
ÖÖ 
.
ÖÖ 
IsSome
ÖÖ 
)
ÖÖ 
{
ÜÜ 	
return
áá 
Result
áá 
<
áá )
ApplicationInstanceSettings
áá 5
,
áá5 6'
InternalServiceApiFailure
áá7 P
>
ááP Q
.
ááQ R
Err
ááR U
(
ááU V'
InternalServiceApiFailure
àà )
.
àà) *$
SecureStoreKeyNotFound
àà* @
(
àà@ A&
ApplicationErrorMessages
ààA Y
.
ààY Z#
SecureStorageProvider
ààZ o
.
ââ ,
APPLICATION_SETTINGS_NOT_FOUND
ââ 3
)
ââ3 4
)
ââ4 5
;
ââ5 6
}
ää 	
try
åå 
{
çç 	)
ApplicationInstanceSettings
éé '
settings
éé( 0
=
éé1 2)
ApplicationInstanceSettings
éé3 N
.
ééN O
Parser
ééO U
.
ééU V
	ParseFrom
ééV _
(
éé_ `
	maybeData
éé` i
.
ééi j
Value
ééj o
)
ééo p
;
éép q
return
èè 
Result
èè 
<
èè )
ApplicationInstanceSettings
èè 5
,
èè5 6'
InternalServiceApiFailure
èè7 P
>
èèP Q
.
èèQ R
Ok
èèR T
(
èèT U
settings
èèU ]
)
èè] ^
;
èè^ _
}
êê 	
catch
ëë 
(
ëë ,
InvalidProtocolBufferException
ëë -
ex
ëë. 0
)
ëë0 1
{
íí 	
return
ìì 
Result
ìì 
<
ìì )
ApplicationInstanceSettings
ìì 5
,
ìì5 6'
InternalServiceApiFailure
ìì7 P
>
ììP Q
.
ììQ R
Err
ììR U
(
ììU V'
InternalServiceApiFailure
îî )
.
îî) *%
SecureStoreAccessDenied
îî* A
(
îîA B&
ApplicationErrorMessages
ïï ,
.
ïï, -#
SecureStorageProvider
ïï- B
.
ïïB C#
CORRUPT_SETTINGS_DATA
ïïC X
,
ïïX Y
ex
ïïZ \
)
ïï\ ]
)
ïï] ^
;
ïï^ _
}
ññ 	
}
óó 
public
ôô 

async
ôô 
Task
ôô 
<
ôô 
Result
ôô 
<
ôô $
InstanceSettingsResult
ôô 3
,
ôô3 4'
InternalServiceApiFailure
ôô5 N
>
ôôN O
>
ôôO P2
$InitApplicationInstanceSettingsAsync
ôôQ u
(
ôôu v
string
öö 
?
öö 
defaultCulture
öö 
)
öö 
{
õõ 
Result
úú 
<
úú 
Option
úú 
<
úú 
byte
úú 
[
úú 
]
úú 
>
úú 
,
úú '
InternalServiceApiFailure
úú 8
>
úú8 9
	getResult
úú: C
=
úúD E
await
úúF K
TryGetByKeyAsync
úúL \
(
úú\ ]
SETTINGS_KEY
úú] i
)
úúi j
;
úúj k
if
ùù 

(
ùù 
	getResult
ùù 
.
ùù 
IsErr
ùù 
)
ùù 
{
ûû 	'
InternalServiceApiFailure
üü %
failure
üü& -
=
üü. /
	getResult
üü0 9
.
üü9 :
	UnwrapErr
üü: C
(
üüC D
)
üüD E
;
üüE F
Log
†† 
.
†† 
Warning
†† 
(
†† 
$str
†† q
,
††q r
failure
°° 
.
°° 
Message
°° 
)
°°  
;
°°  !
return
¢¢ 
await
¢¢ ,
CreateAndStoreNewSettingsAsync
¢¢ 7
(
¢¢7 8
defaultCulture
¢¢8 F
)
¢¢F G
;
¢¢G H
}
££ 	
Option
•• 
<
•• 
byte
•• 
[
•• 
]
•• 
>
•• 
	maybeData
••  
=
••! "
	getResult
••# ,
.
••, -
Unwrap
••- 3
(
••3 4
)
••4 5
;
••5 6
if
¶¶ 

(
¶¶ 
	maybeData
¶¶ 
.
¶¶ 
IsSome
¶¶ 
)
¶¶ 
{
ßß 	
try
®® 
{
©© )
ApplicationInstanceSettings
™™ +
settings
™™, 4
=
™™5 6)
ApplicationInstanceSettings
™™7 R
.
™™R S
Parser
™™S Y
.
™™Y Z
	ParseFrom
™™Z c
(
™™c d
	maybeData
™™d m
.
™™m n
Value
™™n s
)
™™s t
;
™™t u
return
´´ 
Result
´´ 
<
´´ $
InstanceSettingsResult
´´ 4
,
´´4 5'
InternalServiceApiFailure
´´6 O
>
´´O P
.
´´P Q
Ok
´´Q S
(
´´S T
new
¨¨ $
InstanceSettingsResult
¨¨ .
(
¨¨. /
settings
¨¨/ 7
,
¨¨7 8
false
¨¨9 >
)
¨¨> ?
)
¨¨? @
;
¨¨@ A
}
≠≠ 
catch
ÆÆ 
(
ÆÆ ,
InvalidProtocolBufferException
ÆÆ 1
ex
ÆÆ2 4
)
ÆÆ4 5
{
ØØ 
Log
∞∞ 
.
∞∞ 
Warning
∞∞ 
(
∞∞ 
ex
∞∞ 
,
∞∞ 
$str
±± o
,
±±o p
ex
≤≤ 
.
≤≤ 
Message
≤≤ 
)
≤≤ 
;
≤≤  
return
≥≥ 
await
≥≥ ,
CreateAndStoreNewSettingsAsync
≥≥ ;
(
≥≥; <
defaultCulture
≥≥< J
)
≥≥J K
;
≥≥K L
}
¥¥ 
}
µµ 	
return
∑∑ 
await
∑∑ ,
CreateAndStoreNewSettingsAsync
∑∑ 3
(
∑∑3 4
defaultCulture
∑∑4 B
)
∑∑B C
;
∑∑C D
}
∏∏ 
private
∫∫ 
async
∫∫ 
Task
∫∫ 
<
∫∫ 
Result
∫∫ 
<
∫∫ $
InstanceSettingsResult
∫∫ 4
,
∫∫4 5'
InternalServiceApiFailure
∫∫6 O
>
∫∫O P
>
∫∫P Q,
CreateAndStoreNewSettingsAsync
∫∫R p
(
∫∫p q
string
ªª 
?
ªª 
defaultCulture
ªª 
)
ªª 
{
ºº )
ApplicationInstanceSettings
ΩΩ #
newSettings
ΩΩ$ /
=
ΩΩ0 1
new
ΩΩ2 5
(
ΩΩ5 6
)
ΩΩ6 7
{
ææ 	
AppInstanceId
øø 
=
øø 
Helpers
øø #
.
øø# $
GuidToByteString
øø$ 4
(
øø4 5
Guid
øø5 9
.
øø9 :
NewGuid
øø: A
(
øøA B
)
øøB C
)
øøC D
,
øøD E
DeviceId
¿¿ 
=
¿¿ 
Helpers
¿¿ 
.
¿¿ 
GuidToByteString
¿¿ /
(
¿¿/ 0
Guid
¿¿0 4
.
¿¿4 5
NewGuid
¿¿5 <
(
¿¿< =
)
¿¿= >
)
¿¿> ?
,
¿¿? @
Culture
¡¡ 
=
¡¡ 
defaultCulture
¡¡ $
}
¬¬ 	
;
¬¬	 

Result
ƒƒ 
<
ƒƒ 
Unit
ƒƒ 
,
ƒƒ '
InternalServiceApiFailure
ƒƒ .
>
ƒƒ. /
storeResult
ƒƒ0 ;
=
ƒƒ< =
await
ƒƒ> C%
SecureByteStringInterop
ƒƒD [
.
ƒƒ[ \"
WithByteStringAsSpan
ƒƒ\ p
(
ƒƒp q
newSettings
≈≈ 
.
≈≈ 
ToByteString
≈≈ $
(
≈≈$ %
)
≈≈% &
,
≈≈& '
span
∆∆ 
=>
∆∆ 

StoreAsync
∆∆ 
(
∆∆ 
SETTINGS_KEY
∆∆ +
,
∆∆+ ,
span
∆∆- 1
.
∆∆1 2
ToArray
∆∆2 9
(
∆∆9 :
)
∆∆: ;
)
∆∆; <
)
∆∆< =
;
∆∆= >
if
»» 

(
»» 
storeResult
»» 
.
»» 
IsErr
»» 
)
»» 
{
…… 	
Log
   
.
   
Warning
   
(
   
$str
ÀÀ q
,
ÀÀq r
storeResult
ÃÃ 
.
ÃÃ 
	UnwrapErr
ÃÃ %
(
ÃÃ% &
)
ÃÃ& '
.
ÃÃ' (
Message
ÃÃ( /
)
ÃÃ/ 0
;
ÃÃ0 1
}
ÕÕ 	
return
œœ 
Result
œœ 
<
œœ $
InstanceSettingsResult
œœ ,
,
œœ, -'
InternalServiceApiFailure
œœ. G
>
œœG H
.
œœH I
Ok
œœI K
(
œœK L
new
–– $
InstanceSettingsResult
–– &
(
––& '
newSettings
––' 2
,
––2 3
true
––4 8
)
––8 9
)
––9 :
;
––: ;
}
—— 
public
”” 

async
”” 
Task
”” 
<
”” 
Result
”” 
<
”” 
Unit
”” !
,
””! "'
InternalServiceApiFailure
””# <
>
””< =
>
””= >

StoreAsync
””? I
(
””I J
string
””J P
key
””Q T
,
””T U
byte
””V Z
[
””Z [
]
””[ \
data
””] a
)
””a b
{
‘‘ 
try
’’ 
{
÷÷ 	
string
◊◊ 
filePath
◊◊ 
=
◊◊ 
GetHashedFilePath
◊◊ /
(
◊◊/ 0
key
◊◊0 3
)
◊◊3 4
;
◊◊4 5
byte
ÿÿ 
[
ÿÿ 
]
ÿÿ 
protectedData
ÿÿ  
=
ÿÿ! "

_protector
ÿÿ# -
.
ÿÿ- .
Protect
ÿÿ. 5
(
ÿÿ5 6
data
ÿÿ6 :
)
ÿÿ: ;
;
ÿÿ; <
await
ŸŸ 
File
ŸŸ 
.
ŸŸ  
WriteAllBytesAsync
ŸŸ )
(
ŸŸ) *
filePath
ŸŸ* 2
,
ŸŸ2 3
protectedData
ŸŸ4 A
)
ŸŸA B
;
ŸŸB C&
SetSecureFilePermissions
⁄⁄ $
(
⁄⁄$ %
filePath
⁄⁄% -
)
⁄⁄- .
;
⁄⁄. /
return
€€ 
Result
€€ 
<
€€ 
Unit
€€ 
,
€€ '
InternalServiceApiFailure
€€  9
>
€€9 :
.
€€: ;
Ok
€€; =
(
€€= >
Unit
€€> B
.
€€B C
Value
€€C H
)
€€H I
;
€€I J
}
‹‹ 	
catch
›› 
(
›› $
CryptographicException
›› %
ex
››& (
)
››( )
{
ﬁﬁ 	
return
ﬂﬂ 
Result
ﬂﬂ 
<
ﬂﬂ 
Unit
ﬂﬂ 
,
ﬂﬂ '
InternalServiceApiFailure
ﬂﬂ  9
>
ﬂﬂ9 :
.
ﬂﬂ: ;
Err
ﬂﬂ; >
(
ﬂﬂ> ?'
InternalServiceApiFailure
‡‡ )
.
‡‡) *%
SecureStoreAccessDenied
‡‡* A
(
‡‡A B&
ApplicationErrorMessages
·· ,
.
··, -#
SecureStorageProvider
··- B
.
··B C$
FAILED_TO_ENCRYPT_DATA
··C Y
,
··Y Z
ex
··[ ]
)
··] ^
)
··^ _
;
··_ `
}
‚‚ 	
catch
„„ 
(
„„ 
IOException
„„ 
ex
„„ 
)
„„ 
{
‰‰ 	
return
ÂÂ 
Result
ÂÂ 
<
ÂÂ 
Unit
ÂÂ 
,
ÂÂ '
InternalServiceApiFailure
ÂÂ  9
>
ÂÂ9 :
.
ÂÂ: ;
Err
ÂÂ; >
(
ÂÂ> ?'
InternalServiceApiFailure
ÊÊ )
.
ÊÊ) *%
SecureStoreAccessDenied
ÊÊ* A
(
ÊÊA B&
ApplicationErrorMessages
ÁÁ ,
.
ÁÁ, -#
SecureStorageProvider
ÁÁ- B
.
ÁÁB C(
FAILED_TO_WRITE_TO_STORAGE
ÁÁC ]
,
ÁÁ] ^
ex
ÁÁ_ a
)
ÁÁa b
)
ÁÁb c
;
ÁÁc d
}
ËË 	
}
ÈÈ 
public
ÎÎ 

async
ÎÎ 
Task
ÎÎ 
<
ÎÎ 
Result
ÎÎ 
<
ÎÎ 
Option
ÎÎ #
<
ÎÎ# $
byte
ÎÎ$ (
[
ÎÎ( )
]
ÎÎ) *
>
ÎÎ* +
,
ÎÎ+ ,'
InternalServiceApiFailure
ÎÎ- F
>
ÎÎF G
>
ÎÎG H
TryGetByKeyAsync
ÎÎI Y
(
ÎÎY Z
string
ÎÎZ `
key
ÎÎa d
)
ÎÎd e
{
ÏÏ 
string
ÌÌ 
filePath
ÌÌ 
=
ÌÌ 
GetHashedFilePath
ÌÌ +
(
ÌÌ+ ,
key
ÌÌ, /
)
ÌÌ/ 0
;
ÌÌ0 1
if
ÓÓ 

(
ÓÓ 
!
ÓÓ 
File
ÓÓ 
.
ÓÓ 
Exists
ÓÓ 
(
ÓÓ 
filePath
ÓÓ !
)
ÓÓ! "
)
ÓÓ" #
{
ÔÔ 	
return
 
Result
 
<
 
Option
  
<
  !
byte
! %
[
% &
]
& '
>
' (
,
( )'
InternalServiceApiFailure
* C
>
C D
.
D E
Ok
E G
(
G H
Option
H N
<
N O
byte
O S
[
S T
]
T U
>
U V
.
V W
None
W [
)
[ \
;
\ ]
}
ÒÒ 	
try
ÛÛ 
{
ÙÙ 	
byte
ıı 
[
ıı 
]
ıı 
protectedData
ıı  
=
ıı! "
await
ıı# (
File
ıı) -
.
ıı- .
ReadAllBytesAsync
ıı. ?
(
ıı? @
filePath
ıı@ H
)
ııH I
;
ııI J
if
ˆˆ 
(
ˆˆ 
protectedData
ˆˆ 
.
ˆˆ 
Length
ˆˆ $
==
ˆˆ% '
$num
ˆˆ( )
)
ˆˆ) *
{
˜˜ 
return
¯¯ 
Result
¯¯ 
<
¯¯ 
Option
¯¯ $
<
¯¯$ %
byte
¯¯% )
[
¯¯) *
]
¯¯* +
>
¯¯+ ,
,
¯¯, -'
InternalServiceApiFailure
¯¯. G
>
¯¯G H
.
¯¯H I
Ok
¯¯I K
(
¯¯K L
Option
¯¯L R
<
¯¯R S
byte
¯¯S W
[
¯¯W X
]
¯¯X Y
>
¯¯Y Z
.
¯¯Z [
None
¯¯[ _
)
¯¯_ `
;
¯¯` a
}
˘˘ 
byte
˚˚ 
[
˚˚ 
]
˚˚ 
data
˚˚ 
=
˚˚ 

_protector
˚˚ $
.
˚˚$ %
	Unprotect
˚˚% .
(
˚˚. /
protectedData
˚˚/ <
)
˚˚< =
;
˚˚= >
return
¸¸ 
Result
¸¸ 
<
¸¸ 
Option
¸¸  
<
¸¸  !
byte
¸¸! %
[
¸¸% &
]
¸¸& '
>
¸¸' (
,
¸¸( )'
InternalServiceApiFailure
¸¸* C
>
¸¸C D
.
¸¸D E
Ok
¸¸E G
(
¸¸G H
Option
¸¸H N
<
¸¸N O
byte
¸¸O S
[
¸¸S T
]
¸¸T U
>
¸¸U V
.
¸¸V W
Some
¸¸W [
(
¸¸[ \
data
¸¸\ `
)
¸¸` a
)
¸¸a b
;
¸¸b c
}
˝˝ 	
catch
˛˛ 
(
˛˛ $
CryptographicException
˛˛ %
ex
˛˛& (
)
˛˛( )
{
ˇˇ 	
return
ÄÄ 
Result
ÄÄ 
<
ÄÄ 
Option
ÄÄ  
<
ÄÄ  !
byte
ÄÄ! %
[
ÄÄ% &
]
ÄÄ& '
>
ÄÄ' (
,
ÄÄ( )'
InternalServiceApiFailure
ÄÄ* C
>
ÄÄC D
.
ÄÄD E
Err
ÄÄE H
(
ÄÄH I'
InternalServiceApiFailure
ÅÅ )
.
ÅÅ) *%
SecureStoreAccessDenied
ÅÅ* A
(
ÅÅA B&
ApplicationErrorMessages
ÇÇ ,
.
ÇÇ, -#
SecureStorageProvider
ÇÇ- B
.
ÇÇB C$
FAILED_TO_DECRYPT_DATA
ÇÇC Y
,
ÇÇY Z
ex
ÇÇ[ ]
)
ÇÇ] ^
)
ÇÇ^ _
;
ÇÇ_ `
}
ÉÉ 	
catch
ÑÑ 
(
ÑÑ 
IOException
ÑÑ 
ex
ÑÑ 
)
ÑÑ 
{
ÖÖ 	
return
ÜÜ 
Result
ÜÜ 
<
ÜÜ 
Option
ÜÜ  
<
ÜÜ  !
byte
ÜÜ! %
[
ÜÜ% &
]
ÜÜ& '
>
ÜÜ' (
,
ÜÜ( )'
InternalServiceApiFailure
ÜÜ* C
>
ÜÜC D
.
ÜÜD E
Err
ÜÜE H
(
ÜÜH I'
InternalServiceApiFailure
áá )
.
áá) *%
SecureStoreAccessDenied
áá* A
(
ááA B&
ApplicationErrorMessages
àà ,
.
àà, -#
SecureStorageProvider
àà- B
.
ààB C&
FAILED_TO_ACCESS_STORAGE
ààC [
,
àà[ \
ex
àà] _
)
àà_ `
)
àà` a
;
ààa b
}
ââ 	
}
ää 
public
åå 

Result
åå 
<
åå 
Unit
åå 
,
åå '
InternalServiceApiFailure
åå 1
>
åå1 2
Delete
åå3 9
(
åå9 :
string
åå: @
key
ååA D
)
ååD E
{
çç 
if
éé 

(
éé 
string
éé 
.
éé 
IsNullOrEmpty
éé  
(
éé  !
key
éé! $
)
éé$ %
)
éé% &
{
èè 	
throw
êê 
new
êê #
ArgumentNullException
êê +
(
êê+ ,
nameof
êê, 2
(
êê2 3
key
êê3 6
)
êê6 7
)
êê7 8
;
êê8 9
}
ëë 	
try
ìì 
{
îî 	
string
ïï 
filePath
ïï 
=
ïï 
GetHashedFilePath
ïï /
(
ïï/ 0
key
ïï0 3
)
ïï3 4
;
ïï4 5
if
ññ 
(
ññ 
File
ññ 
.
ññ 
Exists
ññ 
(
ññ 
filePath
ññ $
)
ññ$ %
)
ññ% &
{
óó 
File
òò 
.
òò 
Delete
òò 
(
òò 
filePath
òò $
)
òò$ %
;
òò% &
}
ôô 
return
õõ 
Result
õõ 
<
õõ 
Unit
õõ 
,
õõ '
InternalServiceApiFailure
õõ  9
>
õõ9 :
.
õõ: ;
Ok
õõ; =
(
õõ= >
Unit
õõ> B
.
õõB C
Value
õõC H
)
õõH I
;
õõI J
}
úú 	
catch
ùù 
(
ùù 
IOException
ùù 
ex
ùù 
)
ùù 
{
ûû 	
return
üü 
Result
üü 
<
üü 
Unit
üü 
,
üü '
InternalServiceApiFailure
üü  9
>
üü9 :
.
üü: ;
Err
üü; >
(
üü> ?'
InternalServiceApiFailure
†† )
.
††) *%
SecureStoreAccessDenied
††* A
(
††A B&
ApplicationErrorMessages
°° ,
.
°°, -#
SecureStorageProvider
°°- B
.
°°B C+
FAILED_TO_DELETE_FROM_STORAGE
°°C `
,
°°` a
ex
°°b d
)
°°d e
)
°°e f
;
°°f g
}
¢¢ 	
}
££ 
private
•• 
string
•• 
GetHashedFilePath
•• $
(
••$ %
string
••% +
key
••, /
)
••/ 0
{
¶¶ 
byte
ßß 
[
ßß 
]
ßß 
	hashBytes
ßß 
=
ßß 
SHA256
ßß !
.
ßß! "
HashData
ßß" *
(
ßß* +
Encoding
ßß+ 3
.
ßß3 4
UTF8
ßß4 8
.
ßß8 9
GetBytes
ßß9 A
(
ßßA B
key
ßßB E
)
ßßE F
)
ßßF G
;
ßßG H
string
®® 
safeFilename
®® 
=
®® 
Convert
®® %
.
®®% &
ToHexString
®®& 1
(
®®1 2
	hashBytes
®®2 ;
)
®®; <
;
®®< =
return
©© 
Path
©© 
.
©© 
Combine
©© 
(
©© 
_storagePath
©© (
,
©©( )
$"
©©* ,
{
©©, -
safeFilename
©©- 9
}
©©9 :
$str
©©: >
"
©©> ?
)
©©? @
;
©©@ A
}
™™ 
private
¨¨ 
void
¨¨ (
InitializeStorageDirectory
¨¨ +
(
¨¨+ ,
)
¨¨, -
{
≠≠ 
try
ÆÆ 
{
ØØ 	
if
∞∞ 
(
∞∞ 
!
∞∞ 
	Directory
∞∞ 
.
∞∞ 
Exists
∞∞ !
(
∞∞! "
_storagePath
∞∞" .
)
∞∞. /
)
∞∞/ 0
{
±± 
	Directory
≤≤ 
.
≤≤ 
CreateDirectory
≤≤ )
(
≤≤) *
_storagePath
≤≤* 6
)
≤≤6 7
;
≤≤7 8
if
¥¥ 
(
¥¥  
RuntimeInformation
¥¥ &
.
¥¥& '
IsOSPlatform
¥¥' 3
(
¥¥3 4

OSPlatform
¥¥4 >
.
¥¥> ?
Linux
¥¥? D
)
¥¥D E
||
¥¥F H 
RuntimeInformation
µµ &
.
µµ& '
IsOSPlatform
µµ' 3
(
µµ3 4

OSPlatform
µµ4 >
.
µµ> ?
OSX
µµ? B
)
µµB C
)
µµC D
{
∂∂ 
File
∑∑ 
.
∑∑ 
SetUnixFileMode
∑∑ (
(
∑∑( )
_storagePath
∑∑) 5
,
∑∑5 6
UnixFileMode
∏∏ $
.
∏∏$ %
UserRead
∏∏% -
|
∏∏. /
UnixFileMode
∏∏0 <
.
∏∏< =
	UserWrite
∏∏= F
|
∏∏G H
UnixFileMode
∏∏I U
.
∏∏U V
UserExecute
∏∏V a
)
∏∏a b
;
∏∏b c
}
ππ 
}
∫∫ 
}
ªª 	
catch
ºº 
(
ºº 
IOException
ºº 
ex
ºº 
)
ºº 
{
ΩΩ 	
throw
ææ 
new
ææ '
InvalidOperationException
ææ /
(
ææ/ 0
string
øø 
.
øø 
Format
øø 
(
øø &
ApplicationErrorMessages
øø 6
.
øø6 7#
SecureStorageProvider
øø7 L
.
øøL M6
(SECURE_STORAGE_DIRECTORY_CREATION_FAILED
øøM u
,
øøu v
_storagePath
¿¿  
)
¿¿  !
,
¿¿! "
ex
¿¿# %
)
¿¿% &
;
¿¿& '
}
¡¡ 	
}
¬¬ 
private
ƒƒ 
static
ƒƒ 
void
ƒƒ &
SetSecureFilePermissions
ƒƒ 0
(
ƒƒ0 1
string
ƒƒ1 7
filePath
ƒƒ8 @
)
ƒƒ@ A
{
≈≈ 
if
∆∆ 

(
∆∆ 
!
∆∆  
RuntimeInformation
∆∆ 
.
∆∆  
IsOSPlatform
∆∆  ,
(
∆∆, -

OSPlatform
∆∆- 7
.
∆∆7 8
Linux
∆∆8 =
)
∆∆= >
&&
∆∆? A
!
∆∆B C 
RuntimeInformation
∆∆C U
.
∆∆U V
IsOSPlatform
∆∆V b
(
∆∆b c

OSPlatform
∆∆c m
.
∆∆m n
OSX
∆∆n q
)
∆∆q r
)
∆∆r s
{
«« 	
return
»» 
;
»» 
}
…… 	
File
ÀÀ 
.
ÀÀ 
SetUnixFileMode
ÀÀ 
(
ÀÀ 
filePath
ÀÀ %
,
ÀÀ% &
UnixFileMode
ÀÀ' 3
.
ÀÀ3 4
UserRead
ÀÀ4 <
|
ÀÀ= >
UnixFileMode
ÀÀ? K
.
ÀÀK L
	UserWrite
ÀÀL U
)
ÀÀU V
;
ÀÀV W
}
ÃÃ 
public
ŒŒ 

	ValueTask
ŒŒ 
DisposeAsync
ŒŒ !
(
ŒŒ! "
)
ŒŒ" #
{
œœ 
if
–– 

(
–– 
!
–– 
	_disposed
–– 
)
–– 
{
—— 	
	_disposed
““ 
=
““ 
true
““ 
;
““ 
}
”” 	
return
’’ 
	ValueTask
’’ 
.
’’ 
CompletedTask
’’ &
;
’’& '
}
÷÷ 
}◊◊ ›=
â/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Data/PendingLogoutRequestStorage.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Infrastructure

 &
.

& '
Data

' +
;

+ ,
internal 
sealed	 
class '
PendingLogoutRequestStorage 1
(1 2-
!IApplicationSecureStorageProvider2 S
storageProviderT c
)c d
{ 
private 
const 
string 
STORAGE_KEY $
=% &
$str' 6
;6 7
public 

async 
Task 
< 
Result 
< 
Unit !
,! "
LogoutFailure# 0
>0 1
>1 2#
StorePendingLogoutAsync3 J
(J K
LogoutRequestK X
requestY `
)` a
{ 
try 
{ 	
byte 
[ 
] 
requestData 
=  
request! (
.( )
ToByteArray) 4
(4 5
)5 6
;6 7
Result 
< 
Unit 
, %
InternalServiceApiFailure 2
>2 3
storeResult4 ?
=@ A
await 
storageProvider %
.% &

StoreAsync& 0
(0 1
STORAGE_KEY1 <
,< =
requestData> I
)I J
.J K
ConfigureAwaitK Y
(Y Z
falseZ _
)_ `
;` a
if 
( 
storeResult 
. 
IsErr !
)! "
{ 
return 
Result 
< 
Unit "
," #
LogoutFailure$ 1
>1 2
.2 3
Err3 6
(6 7
LogoutFailure !
.! "
UnexpectedError" 1
(1 2
$"2 4
$str4 D
{D E
storeResultE P
.P Q
	UnwrapErrQ Z
(Z [
)[ \
.\ ]
Message] d
}d e
"e f
)f g
)g h
;h i
} 
return 
Result 
< 
Unit 
, 
LogoutFailure  -
>- .
.. /
Ok/ 1
(1 2
Unit2 6
.6 7
Value7 <
)< =
;= >
}   	
catch!! 
(!! 
	Exception!! 
ex!! 
)!! 
{"" 	
return## 
Result## 
<## 
Unit## 
,## 
LogoutFailure##  -
>##- .
.##. /
Err##/ 2
(##2 3
LogoutFailure$$ 
.$$ 
UnexpectedError$$ -
($$- .
$"$$. 0
$str$$0 B
{$$B C
ex$$C E
.$$E F
Message$$F M
}$$M N
"$$N O
,$$O P
ex$$Q S
)$$S T
)$$T U
;$$U V
}%% 	
}&& 
public(( 

async(( 
Task(( 
<(( 
Result(( 
<(( 
Option(( #
<((# $
LogoutRequest(($ 1
>((1 2
,((2 3
LogoutFailure((4 A
>((A B
>((B C!
GetPendingLogoutAsync((D Y
(((Y Z
)((Z [
{)) 
try** 
{++ 	
Result,, 
<,, 
Option,, 
<,, 
byte,, 
[,, 
],,  
>,,  !
,,,! "%
InternalServiceApiFailure,,# <
>,,< =
	getResult,,> G
=,,H I
await-- 
storageProvider-- %
.--% &
TryGetByKeyAsync--& 6
(--6 7
STORAGE_KEY--7 B
)--B C
.--C D
ConfigureAwait--D R
(--R S
false--S X
)--X Y
;--Y Z
if// 
(// 
	getResult// 
.// 
IsErr// 
)//  
{00 
return11 
Result11 
<11 
Option11 $
<11$ %
LogoutRequest11% 2
>112 3
,113 4
LogoutFailure115 B
>11B C
.11C D
Err11D G
(11G H
LogoutFailure22 !
.22! "
UnexpectedError22" 1
(221 2
$"222 4
$str224 K
{22K L
	getResult22L U
.22U V
	UnwrapErr22V _
(22_ `
)22` a
.22a b
Message22b i
}22i j
"22j k
)22k l
)22l m
;22m n
}33 
Option55 
<55 
byte55 
[55 
]55 
>55 

dataOption55 %
=55& '
	getResult55( 1
.551 2
Unwrap552 8
(558 9
)559 :
;55: ;
if66 
(66 
!66 

dataOption66 
.66 
IsSome66 "
)66" #
{77 
return88 
Result88 
<88 
Option88 $
<88$ %
LogoutRequest88% 2
>882 3
,883 4
LogoutFailure885 B
>88B C
.88C D
Ok88D F
(88F G
Option88G M
<88M N
LogoutRequest88N [
>88[ \
.88\ ]
None88] a
)88a b
;88b c
}99 
LogoutRequest;; 
request;; !
=;;" #
LogoutRequest;;$ 1
.;;1 2
Parser;;2 8
.;;8 9
	ParseFrom;;9 B
(;;B C

dataOption;;C M
.;;M N
Value;;N S
);;S T
;;;T U
return<< 
Result<< 
<<< 
Option<<  
<<<  !
LogoutRequest<<! .
><<. /
,<</ 0
LogoutFailure<<1 >
><<> ?
.<<? @
Ok<<@ B
(<<B C
Option<<C I
<<<I J
LogoutRequest<<J W
><<W X
.<<X Y
Some<<Y ]
(<<] ^
request<<^ e
)<<e f
)<<f g
;<<g h
}== 	
catch>> 
(>> *
InvalidProtocolBufferException>> -
ex>>. 0
)>>0 1
{?? 	
ClearPendingLogout@@ 
(@@ 
)@@  
;@@  !
returnAA 
ResultAA 
<AA 
OptionAA  
<AA  !
LogoutRequestAA! .
>AA. /
,AA/ 0
LogoutFailureAA1 >
>AA> ?
.AA? @
ErrAA@ C
(AAC D
LogoutFailureBB 
.BB 
UnexpectedErrorBB -
(BB- .
$"BB. 0
$strBB0 P
{BBP Q
exBBQ S
.BBS T
MessageBBT [
}BB[ \
"BB\ ]
,BB] ^
exBB_ a
)BBa b
)BBb c
;BBc d
}CC 	
catchDD 
(DD 
	ExceptionDD 
exDD 
)DD 
{EE 	
returnFF 
ResultFF 
<FF 
OptionFF  
<FF  !
LogoutRequestFF! .
>FF. /
,FF/ 0
LogoutFailureFF1 >
>FF> ?
.FF? @
ErrFF@ C
(FFC D
LogoutFailureGG 
.GG 
UnexpectedErrorGG -
(GG- .
$"GG. 0
$strGG0 B
{GGB C
exGGC E
.GGE F
MessageGGF M
}GGM N
"GGN O
,GGO P
exGGQ S
)GGS T
)GGT U
;GGU V
}HH 	
}II 
publicKK 

voidKK 
ClearPendingLogoutKK "
(KK" #
)KK# $
=>KK% '
storageProviderKK( 7
.KK7 8
DeleteKK8 >
(KK> ?
STORAGE_KEYKK? J
)KKJ K
;KKK L
}LL —
ú/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Data/Abstractions/IApplicationSecureStorageProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Data' +
.+ ,
Abstractions, 8
;8 9
public 
	interface -
!IApplicationSecureStorageProvider 2
:3 4
IAsyncDisposable5 E
{ 
Task 
< 	
Result	 
< 
Unit 
, %
InternalServiceApiFailure /
>/ 0
>0 1.
"SetApplicationSettingsCultureAsync2 T
(T U
stringU [
?[ \
cultureName] h
)h i
;i j
Task 
< 	
Result	 
< 
Unit 
, %
InternalServiceApiFailure /
>/ 0
>0 1'
SetApplicationInstanceAsync2 M
(M N
boolN R
isNewInstanceS `
)` a
;a b
Task 
< 	
Result	 
< 
Unit 
, %
InternalServiceApiFailure /
>/ 0
>0 1(
SetApplicationIpCountryAsync2 N
(N O
	IpCountryO X
	ipCountryY b
)b c
;c d
Task 
< 	
Result	 
< 
Unit 
, %
InternalServiceApiFailure /
>/ 0
>0 1)
SetApplicationMembershipAsync2 O
(O P

MembershipP Z
?Z [

membership\ f
)f g
;g h
Task 
< 	
Result	 
< 
Unit 
, %
InternalServiceApiFailure /
>/ 0
>0 1$
SetCurrentAccountIdAsync2 J
(J K

ByteStringK U
?U V
	accountIdW `
)` a
;a b
Task 
< 	
Result	 
< '
ApplicationInstanceSettings +
,+ ,%
InternalServiceApiFailure- F
>F G
>G H/
#GetApplicationInstanceSettingsAsyncI l
(l m
)m n
;n o
Task 
< 	
Result	 
< "
InstanceSettingsResult &
,& '%
InternalServiceApiFailure( A
>A B
>B C0
$InitApplicationInstanceSettingsAsyncD h
(h i
string 
? 
defaultCulture 
) 
;  
Task 
< 	
Result	 
< 
Unit 
, %
InternalServiceApiFailure /
>/ 0
>0 1

StoreAsync2 <
(< =
string= C
keyD G
,G H
byteI M
[M N
]N O
dataP T
)T U
;U V
Task 
< 	
Result	 
< 
Option 
< 
byte 
[ 
] 
> 
, %
InternalServiceApiFailure  9
>9 :
>: ;
TryGetByKeyAsync< L
(L M
stringM S
keyT W
)W X
;X Y
Result 

<
 
Unit 
, %
InternalServiceApiFailure *
>* +
Delete, 2
(2 3
string3 9
key: =
)= >
;> ?
} ¬6
Ç/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Splash/Views/SplashWindow.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Splash! '
.' (
Views( -
;- .
public 
partial 
class 
SplashWindow !
:" #
ReactiveWindow$ 2
<2 3!
SplashWindowViewModel3 H
>H I
{ 
private 
const 
string 
CONNECTED_CLASS (
=) *
$str+ 6
;6 7
private 
const 
string 
CONNECTING_CLASS )
=* +
$str, 8
;8 9
private 
const 
string 
DISCONNECTED_CLASS +
=, -
$str. <
;< =
private 
const 
string 
RESTORE_CLASS &
=' (
$str) 2
;2 3
private 
const 
string 
DEFAULT_CLASS &
=' (
$str) 2
;2 3
private 
static 
readonly 
FrozenDictionary ,
<, -
ConnectivityStatus- ?
,? @
stringA G
>G H
StatusClassMapI W
=X Y
new 

Dictionary 
< 
ConnectivityStatus )
,) *
string+ 1
>1 2
{ 	
[ 
ConnectivityStatus 
.  
	Connected  )
]) *
=+ ,
CONNECTED_CLASS- <
,< =
[ 
ConnectivityStatus 
.  

Connecting  *
]* +
=, -
CONNECTING_CLASS. >
,> ?
[ 
ConnectivityStatus 
.  

Recovering  *
]* +
=, -
RESTORE_CLASS. ;
,; <
[ 
ConnectivityStatus 
.  
Disconnected  ,
], -
=. /
DISCONNECTED_CLASS0 B
,B C
[ 
ConnectivityStatus 
.  
Unavailable  +
]+ ,
=- .
DISCONNECTED_CLASS/ A
,A B
[ 
ConnectivityStatus 
.  
RetriesExhausted  0
]0 1
=2 3
DISCONNECTED_CLASS4 F
,F G
[ 
ConnectivityStatus 
.  
ShuttingDown  ,
], -
=. /
DISCONNECTED_CLASS0 B
}   	
.  	 

ToFrozenDictionary  
 
(   
)   
;   
private"" 
ConnectivityStatus"" &
_currentConnectivityStatus"" 9
="": ;
ConnectivityStatus""< N
.""N O
Disconnected""O [
;""[ \
public$$ 

SplashWindow$$ 
($$ 
)$$ 
{%% 
InitializeComponent&& 
(&& 
)&& 
;&& $
SetupPrecompiledBindings''  
(''  !
)''! "
;''" #
}(( 
private** 
void** $
SetupPrecompiledBindings** )
(**) *
)*** +
{++ 
this,, 
.,, 
WhenActivated,, 
(,, 
disposables,, &
=>,,' )
{-- 	
this.. 
... 
WhenAnyValue.. 
(.. 
x.. 
=>..  "
x..# $
...$ %
DataContext..% 0
)..0 1
.// 
Where// 
(// 
dc// 
=>// 
dc// 
!=//  "
null//# '
)//' (
.00 
Select00 
(00 
dc00 
=>00 
dc00  
!00  !
)00! "
.11 
OfType11 
<11 !
SplashWindowViewModel11 -
>11- .
(11. /
)11/ 0
.22 

SelectMany22 
(22 
vm22 
=>22 !
vm22" $
.22$ %
WhenAnyValue22% 1
(221 2
x222 3
=>224 6
x227 8
.228 9
ConnectivityStatus229 K
)22K L
)22L M
.33  
DistinctUntilChanged33 %
(33% &
)33& '
.44 
	ObserveOn44 
(44 
RxApp44  
.44  !
MainThreadScheduler44! 4
)444 5
.55 
	Subscribe55 
(55 
UpdateWindowClass55 ,
)55, -
.66 
DisposeWith66 
(66 
disposables66 (
)66( )
;66) *
}77 	
)77	 

;77
 
}88 
private:: 
void:: 
UpdateWindowClass:: "
(::" #
ConnectivityStatus::# 5
status::6 <
)::< =
{;; 
if<< 

(<< &
_currentConnectivityStatus<< &
==<<' )
status<<* 0
)<<0 1
{== 	
return>> 
;>> 
}?? 	
ifAA 

(AA &
_currentConnectivityStatusAA &
!=AA' )
ConnectivityStatusAA* <
.AA< =
DisconnectedAA= I
)AAI J
{BB 	
stringCC 
oldClassCC 
=CC !
GetClassForStatusFastCC 3
(CC3 4&
_currentConnectivityStatusCC4 N
)CCN O
;CCO P
ClassesDD 
.DD 
RemoveDD 
(DD 
oldClassDD #
)DD# $
;DD$ %
}EE 	
stringGG 
newClassGG 
=GG !
GetClassForStatusFastGG /
(GG/ 0
statusGG0 6
)GG6 7
;GG7 8
ClassesHH 
.HH 
AddHH 
(HH 
newClassHH 
)HH 
;HH &
_currentConnectivityStatusII "
=II# $
statusII% +
;II+ ,
}JJ 
privateLL 
staticLL 
stringLL !
GetClassForStatusFastLL /
(LL/ 0
ConnectivityStatusLL0 B
statusLLC I
)LLI J
=>LLK M
StatusClassMapMM 
.MM 
GetValueOrDefaultMM (
(MM( )
statusMM) /
,MM/ 0
DEFAULT_CLASSMM1 >
)MM> ?
;MM? @
	protectedOO 
overrideOO 
voidOO 

OnUnloadedOO &
(OO& '
RoutedEventArgsOO' 6
eOO7 8
)OO8 9
{PP &
_currentConnectivityStatusQQ "
=QQ# $
ConnectivityStatusQQ% 7
.QQ7 8
DisconnectedQQ8 D
;QQD E
baseRR 
.RR 

OnUnloadedRR 
(RR 
eRR 
)RR 
;RR 
}SS 
}TT Û"
ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Splash/ViewModels/SplashWindowViewModel.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Features

  
.

  !
Splash

! '
.

' (

ViewModels

( 2
;

2 3
public 
sealed 
class !
SplashWindowViewModel )
:* +
Core, 0
.0 1
MVVM1 5
.5 6
ViewModelBase6 C
{ 
private  
ConnectivitySnapshot  
_connectivity! .
=/ 0 
ConnectivitySnapshot1 E
.E F
InitialF M
withN R
{S T
StatusU [
=\ ]
ConnectivityStatus^ p
.p q

Connectingq {
}| }
;} ~
private 
bool 
_isShuttingDown  
;  !
public 
 
ConnectivitySnapshot 
Connectivity  ,
{ 
get 
=> 
_connectivity 
; 
private 
set 
{ 	
this 
.  
RaiseAndSetIfChanged %
(% &
ref& )
_connectivity* 7
,7 8
value9 >
)> ?
;? @
this 
.  
RaisePropertyChanged %
(% &
nameof& ,
(, -
ConnectivityStatus- ?
)? @
)@ A
;A B
} 	
} 
public 

ConnectivityStatus 
ConnectivityStatus 0
=>1 3
Connectivity4 @
.@ A
StatusA G
;G H
public 
 
TaskCompletionSource 
<  
bool  $
>$ %
IsSubscribed& 2
{3 4
get5 8
;8 9
}: ;
=< =
new> A
(A B
)B C
;C D
public 
!
SplashWindowViewModel  
(  ! 
IConnectivityService   
connectivityService   0
,  0 1 
ILocalizationService!! 
localizationService!! 0
,!!0 1
NetworkProvider"" 
networkProvider"" '
)""' (
:## 	
base##
 
(## 
networkProvider## 
,## 
localizationService##  3
)##3 4
{$$ *
SetupPrecompiledNetworkBinding%% &
(%%& '
connectivityService%%' :
)%%: ;
;%%; <
}&& 
public(( 

Task(( #
PrepareForShutdownAsync(( '
(((' (
)((( )
{)) 
_isShuttingDown** 
=** 
true** 
;** 
return++ 
Task++ 
.++ 
CompletedTask++ !
;++! "
},, 
private.. 
void.. *
SetupPrecompiledNetworkBinding.. /
(../ 0 
IConnectivityService..0 D
connectivityService..E X
)..X Y
{// %
ProcessConnectivityChange00 !
(00! "
connectivityService00" 5
.005 6
CurrentSnapshot006 E
)00E F
;00F G
IDisposable22 
subscription22  
=22! "
connectivityService22# 6
.226 7
ConnectivityStream227 I
.22I J
	Subscribe22J S
(22S T%
ProcessConnectivityChange22T m
)22m n
;22n o
this44 
.44 
WhenActivated44 
(44 
disposables44 &
=>44' )
{55 	
subscription66 
.66 
DisposeWith66 $
(66$ %
disposables66% 0
)660 1
;661 2
IsSubscribed77 
.77 
TrySetResult77 %
(77% &
true77& *
)77* +
;77+ ,
}88 	
)88	 

;88
 
}99 
private;; 
void;; %
ProcessConnectivityChange;; *
(;;* + 
ConnectivitySnapshot;;+ ?
snapshot;;@ H
);;H I
{<< 
if== 

(== 
_isShuttingDown== 
)== 
{>> 	
return?? 
;?? 
}@@ 	
ConnectivityBB 
=BB 
snapshotBB 
;BB  
}CC 
}DD ø
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Main/Views/MasterView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Main! %
.% &
Views& +
;+ ,
public 
partial 
class 

MasterView 
:  !
UserControl" -
{ 
public 


MasterView 
( 
) 
{		 
AvaloniaXamlLoader

 
.

 
Load

 
(

  
this

  $
)

$ %
;

% &
} 
} ı
ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Main/Views/Components/WelcomeView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Main! %
.% &
Views& +
.+ ,

Components, 6
;6 7
public 
partial 
class 
WelcomeView  
:! "
UserControl# .
{ 
public 

WelcomeView 
( 
) 
{		 
AvaloniaXamlLoader

 
.

 
Load

 
(

  
this

  $
)

$ %
;

% &
} 
} öH
Ç/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Main/ViewModels/MasterViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Main! %
.% &

ViewModels& 0
;0 1
public 
sealed 
class 
MasterViewModel #
:$ %
Core& *
.* +
MVVM+ /
./ 0
ViewModelBase0 =
{ 
private 
readonly 
ILogoutService #
_logoutService$ 2
;2 3
private 
readonly 
CompositeDisposable (
_disposables) 5
=6 7
new8 ;
(; <
)< =
;= >
private #
CancellationTokenSource #
?# $*
_logoutCancellationTokenSource% C
;C D
private 
bool 
_isDisposed 
; 
[  
ObservableAsProperty 
] 
public !
bool" &
IsBusy' -
{. /
get0 3
;3 4
}5 6
public!! 
-
!ConnectivityNotificationViewModel!! ,$
ConnectivityNotification!!- E
{!!F G
get!!H K
;!!K L
}!!M N
public## 

ReactiveCommand## 
<## 
SystemU## "
,##" #
Result##$ *
<##* +
Unit##+ /
,##/ 0
LogoutFailure##1 >
>##> ?
>##? @
LogoutCommand##A N
{##O P
get##Q T
;##T U
}##V W
public%% 

MasterViewModel%% 
(%% 
NetworkProvider&& 
networkProvider&& '
,&&' ( 
ILocalizationService'' 
localizationService'' 0
,''0 1
ILogoutService(( 
logoutService(( $
,(($ %
MainWindowViewModel)) 
mainWindowViewModel)) /
)))/ 0
:** 	
base**
 
(** 
networkProvider** 
,** 
localizationService**  3
,**3 4
null**5 9
)**9 :
{++ 
_logoutService,, 
=,, 
logoutService,, &
;,,& '$
ConnectivityNotification--  
=--! "
mainWindowViewModel--# 6
.--6 7$
ConnectivityNotification--7 O
;--O P
IObservable// 
<// 
bool// 
>// 
	canLogout// #
=//$ %
this//& *
.//* +
WhenAnyValue//+ 7
(//7 8
x//8 9
=>//: <
x//= >
.//> ?
IsBusy//? E
,//E F
isBusy//G M
=>//N P
!//Q R
isBusy//R X
)//X Y
;//Y Z
LogoutCommand11 
=11 
ReactiveCommand11 '
.11' (
CreateFromTask11( 6
(116 7
async22 
(22 
)22 
=>22 
{33 !
CancelLogoutOperation44 %
(44% &
)44& '
;44' (#
CancellationTokenSource66 '
operationCts66( 4
=665 6
new667 :
(66: ;
)66; <
;66< =*
_logoutCancellationTokenSource77 .
=77/ 0
operationCts771 =
;77= >
try99 
{:: 
Result;; 
<;; 
Unit;; 
,;;  
LogoutFailure;;! .
>;;. /
result;;0 6
=;;7 8
await;;9 >
_logoutService;;? M
.;;M N
LogoutAsync;;N Y
(;;Y Z
LogoutReason<< $
.<<$ %
UserInitiated<<% 2
,<<2 3
operationCts== $
.==$ %
Token==% *
)==* +
.==+ ,
ConfigureAwait==, :
(==: ;
false==; @
)==@ A
;==A B
return>> 
result>> !
;>>! "
}?? 
catch@@ 
(@@ 
TimeoutException@@ '
ex@@( *
)@@* +
{AA 
returnBB 
ResultBB !
<BB! "
UnitBB" &
,BB& '
LogoutFailureBB( 5
>BB5 6
.BB6 7
ErrBB7 :
(BB: ;
LogoutFailureCC %
.CC% & 
NetworkRequestFailedCC& :
(CC: ;
$strCC; m
,CCm n
exCCo q
)CCq r
)CCr s
;CCs t
}DD 
catchEE 
(EE &
OperationCanceledExceptionEE 1
exEE2 4
)EE4 5
{FF 
returnGG 
ResultGG !
<GG! "
UnitGG" &
,GG& '
LogoutFailureGG( 5
>GG5 6
.GG6 7
ErrGG7 :
(GG: ;
LogoutFailureHH %
.HH% & 
NetworkRequestFailedHH& :
(HH: ;
$strHH; N
,HHN O
exHHP R
)HHR S
)HHS T
;HHT U
}II 
catchJJ 
(JJ 
	ExceptionJJ  
exJJ! #
)JJ# $
{KK 
returnLL 
ResultLL !
<LL! "
UnitLL" &
,LL& '
LogoutFailureLL( 5
>LL5 6
.LL6 7
ErrLL7 :
(LL: ;
LogoutFailureMM %
.MM% & 
NetworkRequestFailedMM& :
(MM: ;
$strMM; f
,MMf g
exMMh j
)MMj k
)MMk l
;MMl m
}NN 
finallyOO 
{PP 
ifQQ 
(QQ 
ReferenceEqualsQQ '
(QQ' (*
_logoutCancellationTokenSourceQQ( F
,QQF G
operationCtsQQH T
)QQT U
)QQU V
{RR *
_logoutCancellationTokenSourceSS 6
=SS7 8
nullSS9 =
;SS= >
}TT 
operationCtsVV  
.VV  !
DisposeVV! (
(VV( )
)VV) *
;VV* +
}WW 
}XX 
,XX 
	canLogoutYY 
)YY 
;YY 
LogoutCommand[[ 
.[[ 
IsExecuting[[ !
.[[! "
ToPropertyEx[[" .
([[. /
this[[/ 3
,[[3 4
x[[5 6
=>[[7 9
x[[: ;
.[[; <
IsBusy[[< B
)[[B C
.[[C D
DisposeWith[[D O
([[O P
_disposables[[P \
)[[\ ]
;[[] ^
LogoutCommand]] 
.^^ 
Where^^ 
(^^ 
result^^ 
=>^^ 
result^^ #
.^^# $
IsErr^^$ )
)^^) *
.__ 
Select__ 
(__ 
result__ 
=>__ 
result__ $
.__$ %
	UnwrapErr__% .
(__. /
)__/ 0
)__0 1
.`` 
	Subscribe`` 
(`` 
error`` 
=>`` 
{aa 
Logbb 
.bb 
Errorbb 
(bb 
$strbb 4
,bb4 5
errorbb6 ;
.bb; <
Messagebb< C
)bbC D
;bbD E
}cc 
)cc 
.dd 
DisposeWithdd 
(dd 
_disposablesdd %
)dd% &
;dd& '
}ff 
	protectedhh 
overridehh 
voidhh 
Disposehh #
(hh# $
boolhh$ (
	disposinghh) 2
)hh2 3
{ii 
ifjj 

(jj 
_isDisposedjj 
)jj 
{kk 	
returnll 
;ll 
}mm 	
ifoo 

(oo 
	disposingoo 
)oo 
{pp 	!
CancelLogoutOperationqq !
(qq! "
)qq" #
;qq# $
LogoutCommandrr 
?rr 
.rr 
Disposerr "
(rr" #
)rr# $
;rr$ %
_disposablesss 
.ss 
Disposess  
(ss  !
)ss! "
;ss" #
}tt 	
basevv 
.vv 
Disposevv 
(vv 
	disposingvv 
)vv 
;vv  
_isDisposedww 
=ww 
trueww 
;ww 
}xx 
privatezz 
voidzz !
CancelLogoutOperationzz &
(zz& '
)zz' (
{{{ #
CancellationTokenSource|| 
?||  
logoutSource||! -
=||. /
Interlocked||0 ;
.||; <
Exchange||< D
(||D E
ref||E H*
_logoutCancellationTokenSource||I g
,||g h
null||i m
)||m n
;||n o
if}} 

(}} 
logoutSource}} 
==}} 
null}}  
)}}  !
{~~ 	
return 
; 
}
ÄÄ 	
try
ÇÇ 
{
ÉÉ 	
logoutSource
ÑÑ 
.
ÑÑ 
Cancel
ÑÑ 
(
ÑÑ  
)
ÑÑ  !
;
ÑÑ! "
}
ÖÖ 	
catch
ÜÜ 
(
ÜÜ %
ObjectDisposedException
ÜÜ &
)
ÜÜ& '
{
áá 	
}
ââ 	
finally
ää 
{
ãã 	
logoutSource
åå 
.
åå 
Dispose
åå  
(
åå  !
)
åå! "
;
åå" #
}
çç 	
}
éé 
}èè Â
r/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Main/MainModule.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Main! %
;% &
public		 
record		 
MainModuleManifest		  
(		  !
)		! "
:		# $
ModuleManifest		% 3
(		3 4
Priority

 
:

 
$num

 
,

 
LoadingStrategy 
: !
ModuleLoadingStrategy *
.* +
Lazy+ /
,/ 0
Dependencies 
: 
[ 
] 
) 
; 
public 
class 

MainModule 
: 

ModuleBase $
<$ %
MainModuleManifest% 7
>7 8
{ 
public 

override 
ModuleIdentifier $
Id% '
=>( *
ModuleIdentifier+ ;
.; <
Main< @
;@ A
public 

override 
MainModuleManifest &
Manifest' /
{0 1
get2 5
;5 6
}7 8
=9 :
new; >
(> ?
)? @
;@ A
public 

override 
async 
Task %
SetupMessageHandlersAsync 8
(8 9
IModuleMessageBus9 J

messageBusK U
)U V
{ 
await 

messageBus 
. 
PublishAsync %
(% &
new& )"
ModuleInitializedEvent* @
{ 	

ModuleName 
= 
Id 
. 
ToName "
(" #
)# $
} 	
)	 

;
 
Log 
. 
Information 
( 
$str F
)F G
;G H
} 
} «
ë/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/Welcome/WelcomeView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Views0 5
.5 6
Welcome6 =
;= >
public 
partial 
class 
WelcomeView  
:! "
ReactiveUserControl# 6
<6 7
WelcomeViewModel7 G
>G H
{ 
public		 

WelcomeView		 
(		 
)		 
{

 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
} ÛG
è/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/SignIn/SignInView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Views0 5
.5 6
SignIn6 <
;< =
public 
partial 
class 

SignInView 
:  !
ReactiveUserControl" 5
<5 6
SignInViewModel6 E
>E F
{ 
private 
const 
string ,
 SECURE_KEY_TEXT_BOX_CONTROL_NAME 9
=: ;
$str< N
;N O
private 
bool 
_handlersAttached "
;" #
public 


SignInView 
( 
) 
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
	protected 
override 
void "
OnAttachedToVisualTree 2
(2 3)
VisualTreeAttachmentEventArgs3 P
eQ R
)R S
{ 
base 
. "
OnAttachedToVisualTree #
(# $
e$ %
)% &
;& '
SetupEventHandlers 
( 
) 
; 
} 
	protected 
override 
void $
OnDetachedFromVisualTree 4
(4 5)
VisualTreeAttachmentEventArgs5 R
eS T
)T U
{ 
base   
.   $
OnDetachedFromVisualTree   %
(  % &
e  & '
)  ' (
;  ( )!
TeardownEventHandlers!! 
(!! 
)!! 
;!!  
}"" 
private$$ 
void$$ 
SetupEventHandlers$$ #
($$# $
)$$$ %
{%% 
if&& 

(&& 
_handlersAttached&& 
)&& 
{'' 	
return(( 
;(( 
})) 	
if++ 

(++ 
this++ 
.++ 
FindControl++ 
<++ 
HintedTextBox++ *
>++* +
(+++ ,,
 SECURE_KEY_TEXT_BOX_CONTROL_NAME++, L
)++L M
is++N P
{++Q R
}++S T
secureKeyBox++U a
)++a b
{,, 	
secureKeyBox-- 
.-- $
SecureKeyCharactersAdded-- 1
+=--2 4&
OnSecureKeyCharactersAdded--5 O
;--O P
secureKeyBox.. 
... &
SecureKeyCharactersRemoved.. 3
+=..4 6(
OnSecureKeyCharactersRemoved..7 S
;..S T
secureKeyBox// 
.// 
KeyDown//  
+=//! #!
OnSecureKeyBoxKeyDown//$ 9
;//9 :
secureKeyBox00 
.00 
CharacterRejected00 *
+=00+ -
OnCharacterRejected00. A
;00A B
_handlersAttached11 
=11 
true11  $
;11$ %
}22 	
}33 
private55 
void55 !
TeardownEventHandlers55 &
(55& '
)55' (
{66 
if77 

(77 
!77 
_handlersAttached77 
)77 
{88 	
return99 
;99 
}:: 	
if<< 

(<< 
this<< 
.<< 
FindControl<< 
<<< 
HintedTextBox<< *
><<* +
(<<+ ,,
 SECURE_KEY_TEXT_BOX_CONTROL_NAME<<, L
)<<L M
is<<N P
{<<Q R
}<<S T
secureKeyBox<<U a
)<<a b
{== 	
secureKeyBox>> 
.>> $
SecureKeyCharactersAdded>> 1
-=>>2 4&
OnSecureKeyCharactersAdded>>5 O
;>>O P
secureKeyBox?? 
.?? &
SecureKeyCharactersRemoved?? 3
-=??4 6(
OnSecureKeyCharactersRemoved??7 S
;??S T
secureKeyBox@@ 
.@@ 
KeyDown@@  
-=@@! #!
OnSecureKeyBoxKeyDown@@$ 9
;@@9 :
secureKeyBoxAA 
.AA 
CharacterRejectedAA *
-=AA+ -
OnCharacterRejectedAA. A
;AAA B
}BB 	
_handlersAttachedDD 
=DD 
falseDD !
;DD! "
}EE 
privateGG 
voidGG 
OnCharacterRejectedGG $
(GG$ %
objectGG% +
?GG+ ,
senderGG- 3
,GG3 4&
CharacterRejectedEventArgsGG5 O
eGGP Q
)GGQ R
{HH 
ifII 

(II 
DataContextII 
isII 
notII 
SignInViewModelII .
vmII/ 1
||II2 4
senderII5 ;
isII< >
notII? B
HintedTextBoxIIC P
tbIIQ S
)IIS T
{JJ 	
returnKK 
;KK 
}LL 	
stringNN 
localizedMessageNN 
=NN  !
vmNN" $
.NN$ %&
GetLocalizedWarningMessageNN% ?
(NN? @
eNN@ A
.NNA B
WarningTypeNNB M
)NNM N
;NNN O
tbOO 

.OO
 
WarningTextOO 
=OO 
localizedMessageOO )
;OO) *
tbPP 

.PP
 

HasWarningPP 
=PP 
truePP 
;PP 
}QQ 
privateTT 
voidTT &
OnSecureKeyCharactersAddedTT +
(TT+ ,
objectTT, 2
?TT2 3
senderTT4 :
,TT: ;-
!SecureKeyCharactersAddedEventArgsTT< ]
eTT^ _
)TT_ `
{UU 
ifVV 

(VV 
DataContextVV 
isVV 
notVV 
SignInViewModelVV .
vmVV/ 1
||VV2 4
senderVV5 ;
isVV< >
notVV? B
HintedTextBoxVVC P
tbVVQ S
)VVS T
{WW 	
returnXX 
;XX 
}YY 	
vm[[ 

.[[
  
InsertSecureKeyChars[[ 
([[  
e[[  !
.[[! "
Index[[" '
,[[' (
e[[) *
.[[* +

Characters[[+ 5
)[[5 6
;[[6 7
tb\\ 

.\\
 
SyncSecureKeyState\\ 
(\\ 
vm\\  
.\\  !"
CurrentSecureKeyLength\\! 7
)\\7 8
;\\8 9
}]] 
private__ 
void__ (
OnSecureKeyCharactersRemoved__ -
(__- .
object__. 4
?__4 5
sender__6 <
,__< =/
#SecureKeyCharactersRemovedEventArgs__> a
e__b c
)__c d
{`` 
ifaa 

(aa 
DataContextaa 
isaa 
notaa 
SignInViewModelaa .
vmaa/ 1
||aa2 4
senderaa5 ;
isaa< >
notaa? B
HintedTextBoxaaC P
tbaaQ S
)aaS T
{bb 	
returncc 
;cc 
}dd 	
vmff 

.ff
  
RemoveSecureKeyCharsff 
(ff  
eff  !
.ff! "
Indexff" '
,ff' (
eff) *
.ff* +
Countff+ 0
)ff0 1
;ff1 2
tbgg 

.gg
 
SyncSecureKeyStategg 
(gg 
vmgg  
.gg  !"
CurrentSecureKeyLengthgg! 7
)gg7 8
;gg8 9
}hh 
privatejj 
voidjj !
OnSecureKeyBoxKeyDownjj &
(jj& '
objectjj' -
?jj- .
senderjj/ 5
,jj5 6
KeyEventArgsjj7 C
ejjD E
)jjE F
{kk 
ifll 

(ll 
ell 
.ll 
Keyll 
!=ll 
Keyll 
.ll 
Enterll 
&&ll !
ell" #
.ll# $
Keyll$ '
!=ll( *
Keyll+ .
.ll. /
Returnll/ 5
)ll5 6
{mm 	
returnnn 
;nn 
}oo 	
ifqq 

(qq 
DataContextqq 
isqq 
notqq 
SignInViewModelqq .
vmqq/ 1
)qq1 2
{rr 	
returnss 
;ss 
}tt 	
vmvv 

.vv
 $
HandleEnterKeyPressAsyncvv #
(vv# $
)vv$ %
.vv% &
ContinueWithvv& 2
(vv2 3
taskww 
=>ww 
{xx 
ifyy 
(yy 
taskyy 
.yy 
	IsFaultedyy "
&&yy# %
taskyy& *
.yy* +
	Exceptionyy+ 4
!=yy5 7
nullyy8 <
)yy< =
{zz 
Serilog{{ 
.{{ 
Log{{ 
.{{  
Error{{  %
({{% &
task{{& *
.{{* +
	Exception{{+ 4
,{{4 5
$str{{6 u
){{u v
;{{v w
}|| 
}}} 
,}} 
TaskScheduler~~ 
.~~ 
Default~~ !
)~~! "
;~~" #
e 	
.	 

Handled
 
= 
true 
; 
}
ÄÄ 
}ÅÅ à*
§/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/Registration/VerificationCodeEntryView.axaml.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Features

  
.

  !
Authentication

! /
.

/ 0
Views

0 5
.

5 6
Registration

6 B
;

B C
public 
partial 
class %
VerificationCodeEntryView .
:/ 0
ReactiveUserControl1 D
<D E
VerifyOtpViewModelE W
>W X
{ 
private 
bool 
_handlersAttached "
;" #
public 
%
VerificationCodeEntryView $
($ %
)% &
{ 
InitializeComponent 
( 
) 
; 
} 
private 
void 
InitializeComponent $
($ %
)% &
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
	protected 
override 
void "
OnAttachedToVisualTree 2
(2 3)
VisualTreeAttachmentEventArgs3 P
eQ R
)R S
{ 
base 
. "
OnAttachedToVisualTree #
(# $
e$ %
)% &
;& '
SetupEventHandlers 
( 
) 
; 
} 
	protected   
override   
void   $
OnDetachedFromVisualTree   4
(  4 5)
VisualTreeAttachmentEventArgs  5 R
e  S T
)  T U
{!! 
base"" 
."" $
OnDetachedFromVisualTree"" %
(""% &
e""& '
)""' (
;""( )!
TeardownEventHandlers## 
(## 
)## 
;##  
}$$ 
private&& 
void&& 
SetupEventHandlers&& #
(&&# $
)&&$ %
{'' 
if(( 

((( 
_handlersAttached(( 
)(( 
{)) 	
return** 
;** 
}++ 	
if-- 

(-- 
this-- 
.-- 
FindControl-- 
<-- 
SegmentedTextBox-- -
>--- .
(--. /
$str--/ A
)--A B
is--C E
{--F G
}--H I
segmentedTextBox--J Z
)--Z [
{.. 	
segmentedTextBox// 
.// 
KeyDown// $
+=//% '%
OnSegmentedTextBoxKeyDown//( A
;//A B
_handlersAttached00 
=00 
true00  $
;00$ %
}11 	
}22 
private44 
void44 !
TeardownEventHandlers44 &
(44& '
)44' (
{55 
if66 

(66 
!66 
_handlersAttached66 
)66 
{77 	
return88 
;88 
}99 	
if;; 

(;; 
this;; 
.;; 
FindControl;; 
<;; 
SegmentedTextBox;; -
>;;- .
(;;. /
$str;;/ A
);;A B
is;;C E
{;;F G
};;H I
segmentedTextBox;;J Z
);;Z [
{<< 	
segmentedTextBox== 
.== 
KeyDown== $
-===% '%
OnSegmentedTextBoxKeyDown==( A
;==A B
}>> 	
_handlersAttached?? 
=?? 
false?? !
;??! "
}@@ 
privateBB 
voidBB %
OnSegmentedTextBoxKeyDownBB *
(BB* +
objectBB+ 1
?BB1 2
senderBB3 9
,BB9 :
KeyEventArgsBB; G
eBBH I
)BBI J
{CC 
ifDD 

(DD 
eDD 
.DD 
KeyDD 
!=DD 
KeyDD 
.DD 
EnterDD 
&&DD !
eDD" #
.DD# $
KeyDD$ '
!=DD( *
KeyDD+ .
.DD. /
ReturnDD/ 5
)DD5 6
{EE 	
returnFF 
;FF 
}GG 	
ifII 

(II 
DataContextII 
isII 
notII 
VerifyOtpViewModelII 1
vmII2 4
)II4 5
{JJ 	
returnKK 
;KK 
}LL 	
vmNN 

.NN
 $
HandleEnterKeyPressAsyncNN #
(NN# $
)NN$ %
.NN% &
ContinueWithNN& 2
(NN2 3
taskOO 
=>OO 
{PP 
ifQQ 
(QQ 
taskQQ 
.QQ 
	IsFaultedQQ "
&&QQ# %
taskQQ& *
.QQ* +
	ExceptionQQ+ 4
!=QQ5 7
nullQQ8 <
)QQ< =
{RR 
SerilogSS 
.SS 
LogSS 
.SS  
ErrorSS  %
(SS% &
taskSS& *
.SS* +
	ExceptionSS+ 4
,SS4 5
$str	SS6 Ü
)
SSÜ á
;
SSá à
}TT 
}UU 
,UU 
TaskSchedulerVV 
.VV 
DefaultVV !
)VV! "
;VV" #
eWW 	
.WW	 

HandledWW
 
=WW 
trueWW 
;WW 
}XX 
}YY Ôi
§/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/Registration/SecureKeyConfirmationView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Views0 5
.5 6
Registration6 B
;B C
public 
partial 
class %
SecureKeyConfirmationView .
:/ 0
ReactiveUserControl1 D
<D E&
SecureKeyVerifierViewModelE _
>_ `
{ 
private 
bool 
_handlersAttached "
;" #
public 
%
SecureKeyConfirmationView $
($ %
)% &
{ 
InitializeComponent 
( 
) 
; 
} 
private 
void 
InitializeComponent $
($ %
)% &
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
	protected 
override 
void "
OnAttachedToVisualTree 2
(2 3)
VisualTreeAttachmentEventArgs3 P
eQ R
)R S
{ 
base 
. "
OnAttachedToVisualTree #
(# $
e$ %
)% &
;& '
SetupEventHandlers 
( 
) 
; 
} 
	protected!! 
override!! 
void!! $
OnDetachedFromVisualTree!! 4
(!!4 5)
VisualTreeAttachmentEventArgs!!5 R
e!!S T
)!!T U
{"" 
base## 
.## $
OnDetachedFromVisualTree## %
(##% &
e##& '
)##' (
;##( )!
TeardownEventHandlers$$ 
($$ 
)$$ 
;$$  
}%% 
private'' 
void'' 
SetupEventHandlers'' #
(''# $
)''$ %
{(( 
if)) 

()) 
_handlersAttached)) 
))) 
{** 	
return++ 
;++ 
},, 	
if.. 

(.. 
this.. 
... 
FindControl.. 
<.. 
HintedTextBox.. *
>..* +
(..+ ,
$str.., >
)..> ?
is..@ B
HintedTextBox..C P
secureKeyBox..Q ]
)..] ^
{// 	
secureKeyBox00 
.00 $
SecureKeyCharactersAdded00 1
+=002 4&
OnSecureKeyCharactersAdded005 O
;00O P
secureKeyBox11 
.11 &
SecureKeyCharactersRemoved11 3
+=114 6(
OnSecureKeyCharactersRemoved117 S
;11S T
secureKeyBox22 
.22 
KeyDown22  
+=22! #%
OnSecureKeyTextBoxKeyDown22$ =
;22= >
secureKeyBox33 
.33 
CharacterRejected33 *
+=33+ -
OnCharacterRejected33. A
;33A B
}44 	
if55 

(55 
this55 
.55 
FindControl55 
<55 
HintedTextBox55 *
>55* +
(55+ ,
$str55, D
)55D E
is55F H
HintedTextBox55I V
verifySecureKeyBox55W i
)55i j
{66 	
verifySecureKeyBox77 
.77 $
SecureKeyCharactersAdded77 7
+=778 :,
 OnVerifySecureKeyCharactersAdded77; [
;77[ \
verifySecureKeyBox88 
.88 &
SecureKeyCharactersRemoved88 9
+=88: <.
"OnVerifySecureKeyCharactersRemoved88= _
;88_ `
verifySecureKeyBox99 
.99 
KeyDown99 &
+=99' )%
OnSecureKeyTextBoxKeyDown99* C
;99C D
verifySecureKeyBox:: 
.:: 
CharacterRejected:: 0
+=::1 3
OnCharacterRejected::4 G
;::G H
};; 	
_handlersAttached<< 
=<< 
true<<  
;<<  !
}== 
private?? 
void?? !
TeardownEventHandlers?? &
(??& '
)??' (
{@@ 
ifAA 

(AA 
!AA 
_handlersAttachedAA 
)AA 
{BB 	
returnCC 
;CC 
}DD 	
ifFF 

(FF 
thisFF 
.FF 
FindControlFF 
<FF 
HintedTextBoxFF *
>FF* +
(FF+ ,
$strFF, >
)FF> ?
isFF@ B
HintedTextBoxFFC P
secureKeyBoxFFQ ]
)FF] ^
{GG 	
secureKeyBoxHH 
.HH $
SecureKeyCharactersAddedHH 1
-=HH2 4&
OnSecureKeyCharactersAddedHH5 O
;HHO P
secureKeyBoxII 
.II &
SecureKeyCharactersRemovedII 3
-=II4 6(
OnSecureKeyCharactersRemovedII7 S
;IIS T
secureKeyBoxJJ 
.JJ 
KeyDownJJ  
-=JJ! #%
OnSecureKeyTextBoxKeyDownJJ$ =
;JJ= >
secureKeyBoxKK 
.KK 
CharacterRejectedKK *
-=KK+ -
OnCharacterRejectedKK. A
;KKA B
}LL 	
ifMM 

(MM 
thisMM 
.MM 
FindControlMM 
<MM 
HintedTextBoxMM *
>MM* +
(MM+ ,
$strMM, D
)MMD E
isMMF H
HintedTextBoxMMI V
verifySecureKeyBoxMMW i
)MMi j
{NN 	
verifySecureKeyBoxOO 
.OO $
SecureKeyCharactersAddedOO 7
-=OO8 :,
 OnVerifySecureKeyCharactersAddedOO; [
;OO[ \
verifySecureKeyBoxPP 
.PP &
SecureKeyCharactersRemovedPP 9
-=PP: <.
"OnVerifySecureKeyCharactersRemovedPP= _
;PP_ `
verifySecureKeyBoxQQ 
.QQ 
KeyDownQQ &
-=QQ' )%
OnSecureKeyTextBoxKeyDownQQ* C
;QQC D
verifySecureKeyBoxRR 
.RR 
CharacterRejectedRR 0
-=RR1 3
OnCharacterRejectedRR4 G
;RRG H
}SS 	
_handlersAttachedTT 
=TT 
falseTT !
;TT! "
}UU 
privateWW 
voidWW &
OnSecureKeyCharactersAddedWW +
(WW+ ,
objectWW, 2
?WW2 3
senderWW4 :
,WW: ;-
!SecureKeyCharactersAddedEventArgsWW< ]
eWW^ _
)WW_ `
{XX 
ifYY 

(YY 
DataContextYY 
isYY 
notYY &
SecureKeyVerifierViewModelYY 9
vmYY: <
||YY= ?
senderYY@ F
isYYG I
notYYJ M
HintedTextBoxYYN [
tbYY\ ^
)YY^ _
{ZZ 	
return[[ 
;[[ 
}\\ 	
vm^^ 

.^^
  
InsertSecureKeyChars^^ 
(^^  
e^^  !
.^^! "
Index^^" '
,^^' (
e^^) *
.^^* +

Characters^^+ 5
)^^5 6
;^^6 7
tb__ 

.__
 
SyncSecureKeyState__ 
(__ 
vm__  
.__  !"
CurrentSecureKeyLength__! 7
)__7 8
;__8 9
}`` 
privatebb 
voidbb (
OnSecureKeyCharactersRemovedbb -
(bb- .
objectbb. 4
?bb4 5
senderbb6 <
,bb< =/
#SecureKeyCharactersRemovedEventArgsbb> a
ebbb c
)bbc d
{cc 
ifdd 

(dd 
DataContextdd 
isdd 
notdd &
SecureKeyVerifierViewModeldd 9
vmdd: <
||dd= ?
senderdd@ F
isddG I
notddJ M
HintedTextBoxddN [
tbdd\ ^
)dd^ _
{ee 	
returnff 
;ff 
}gg 	
vmii 

.ii
  
RemoveSecureKeyCharsii 
(ii  
eii  !
.ii! "
Indexii" '
,ii' (
eii) *
.ii* +
Countii+ 0
)ii0 1
;ii1 2
tbjj 

.jj
 
SyncSecureKeyStatejj 
(jj 
vmjj  
.jj  !"
CurrentSecureKeyLengthjj! 7
)jj7 8
;jj8 9
}kk 
privatemm 
voidmm ,
 OnVerifySecureKeyCharactersAddedmm 1
(mm1 2
objectmm2 8
?mm8 9
sendermm: @
,mm@ A-
!SecureKeyCharactersAddedEventArgsmmB c
emmd e
)mme f
{nn 
ifoo 

(oo 
DataContextoo 
isoo 
notoo &
SecureKeyVerifierViewModeloo 9
vmoo: <
||oo= ?
senderoo@ F
isooG I
notooJ M
HintedTextBoxooN [
tboo\ ^
)oo^ _
{pp 	
returnqq 
;qq 
}rr 	
vmtt 

.tt
 &
InsertVerifySecureKeyCharstt %
(tt% &
ett& '
.tt' (
Indextt( -
,tt- .
ett/ 0
.tt0 1

Characterstt1 ;
)tt; <
;tt< =
tbuu 

.uu
 
SyncSecureKeyStateuu 
(uu 
vmuu  
.uu  !(
CurrentVerifySecureKeyLengthuu! =
)uu= >
;uu> ?
}vv 
privatexx 
voidxx .
"OnVerifySecureKeyCharactersRemovedxx 3
(xx3 4
objectxx4 :
?xx: ;
senderxx< B
,xxB C/
#SecureKeyCharactersRemovedEventArgsxxD g
exxh i
)xxi j
{yy 
ifzz 

(zz 
DataContextzz 
iszz 
notzz &
SecureKeyVerifierViewModelzz 9
vmzz: <
||zz= ?
senderzz@ F
iszzG I
notzzJ M
HintedTextBoxzzN [
tbzz\ ^
)zz^ _
{{{ 	
return|| 
;|| 
}}} 	
vm 

.
 &
RemoveVerifySecureKeyChars %
(% &
e& '
.' (
Index( -
,- .
e/ 0
.0 1
Count1 6
)6 7
;7 8
tb
ÄÄ 

.
ÄÄ
  
SyncSecureKeyState
ÄÄ 
(
ÄÄ 
vm
ÄÄ  
.
ÄÄ  !*
CurrentVerifySecureKeyLength
ÄÄ! =
)
ÄÄ= >
;
ÄÄ> ?
}
ÅÅ 
private
ÉÉ 
void
ÉÉ '
OnSecureKeyTextBoxKeyDown
ÉÉ *
(
ÉÉ* +
object
ÉÉ+ 1
?
ÉÉ1 2
sender
ÉÉ3 9
,
ÉÉ9 :
KeyEventArgs
ÉÉ; G
e
ÉÉH I
)
ÉÉI J
{
ÑÑ 
if
ÖÖ 

(
ÖÖ 
e
ÖÖ 
.
ÖÖ 
Key
ÖÖ 
!=
ÖÖ 
Key
ÖÖ 
.
ÖÖ 
Enter
ÖÖ 
&&
ÖÖ !
e
ÖÖ" #
.
ÖÖ# $
Key
ÖÖ$ '
!=
ÖÖ( *
Key
ÖÖ+ .
.
ÖÖ. /
Return
ÖÖ/ 5
)
ÖÖ5 6
{
ÜÜ 	
return
áá 
;
áá 
}
àà 	
if
ää 

(
ää 
DataContext
ää 
is
ää 
not
ää (
SecureKeyVerifierViewModel
ää 9
vm
ää: <
)
ää< =
{
ãã 	
return
åå 
;
åå 
}
çç 	
vm
èè 

.
èè
 &
HandleEnterKeyPressAsync
èè #
(
èè# $
)
èè$ %
.
èè% &
ContinueWith
èè& 2
(
èè2 3
task
êê 
=>
êê 
{
ëë 
if
íí 
(
íí 
task
íí 
.
íí 
	IsFaulted
íí "
&&
íí# %
task
íí& *
.
íí* +
	Exception
íí+ 4
!=
íí5 7
null
íí8 <
)
íí< =
{
ìì 
Serilog
îî 
.
îî 
Log
îî 
.
îî  
Error
îî  %
(
îî% &
task
îî& *
.
îî* +
	Exception
îî+ 4
,
îî4 5
$strîî6 Ü
)îîÜ á
;îîá à
}
ïï 
}
ññ 
,
ññ 
TaskScheduler
óó 
.
óó 
Default
óó !
)
óó! "
;
óó" #
e
òò 	
.
òò	 

Handled
òò
 
=
òò 
true
òò 
;
òò 
}
ôô 
private
õõ 
void
õõ !
OnCharacterRejected
õõ $
(
õõ$ %
object
õõ% +
?
õõ+ ,
sender
õõ- 3
,
õõ3 4(
CharacterRejectedEventArgs
õõ5 O
e
õõP Q
)
õõQ R
{
úú 
if
ùù 

(
ùù 
DataContext
ùù 
is
ùù 
not
ùù (
SecureKeyVerifierViewModel
ùù 9
vm
ùù: <
||
ùù= ?
sender
ùù@ F
is
ùùG I
not
ùùJ M
HintedTextBox
ùùN [
tb
ùù\ ^
)
ùù^ _
{
ûû 	
return
üü 
;
üü 
}
†† 	
string
¢¢ 
localizedMessage
¢¢ 
=
¢¢  !
vm
¢¢" $
.
¢¢$ %(
GetLocalizedWarningMessage
¢¢% ?
(
¢¢? @
e
¢¢@ A
.
¢¢A B
WarningType
¢¢B M
)
¢¢M N
;
¢¢N O
tb
££ 

.
££
 
WarningText
££ 
=
££ 
localizedMessage
££ )
;
££) *
tb
§§ 

.
§§
 

HasWarning
§§ 
=
§§ 
true
§§ 
;
§§ 
}
•• 
}¶¶ ´
ò/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/Registration/PassPhaseView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Views0 5
.5 6
Registration6 B
;B C
public 
partial 
class 
PassPhaseView "
:# $
ReactiveUserControl% 8
<8 9
PassPhaseViewModel9 K
>K L
{ 
public		 

PassPhaseView		 
(		 
)		 
{

 
InitializeComponent 
( 
) 
; 
} 
private 
void 
InitializeComponent $
($ %
)% &
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
} º+
°/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/Registration/MobileVerificationView.axaml.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Features

  
.

  !
Authentication

! /
.

/ 0
Views

0 5
.

5 6
Registration

6 B
;

B C
public 
partial 
class "
MobileVerificationView +
:, -
ReactiveUserControl. A
<A B'
MobileVerificationViewModelB ]
>] ^
{ 
private 
const 
string (
MOBILE_TEXT_BOX_CONTROL_NAME 5
=6 7
$str8 G
;G H
private 
bool 
_handlersAttached "
;" #
public 
"
MobileVerificationView !
(! "
)" #
{ 
InitializeComponent 
( 
) 
; 
} 
private 
void 
InitializeComponent $
($ %
)% &
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
	protected 
override 
void "
OnAttachedToVisualTree 2
(2 3)
VisualTreeAttachmentEventArgs3 P
eQ R
)R S
{ 
base 
. "
OnAttachedToVisualTree #
(# $
e$ %
)% &
;& '
SetupEventHandlers 
( 
) 
; 
} 
	protected!! 
override!! 
void!! $
OnDetachedFromVisualTree!! 4
(!!4 5)
VisualTreeAttachmentEventArgs!!5 R
e!!S T
)!!T U
{"" 
base## 
.## $
OnDetachedFromVisualTree## %
(##% &
e##& '
)##' (
;##( )!
TeardownEventHandlers$$ 
($$ 
)$$ 
;$$  
}%% 
private'' 
void'' 
SetupEventHandlers'' #
(''# $
)''$ %
{(( 
if)) 

()) 
_handlersAttached)) 
))) 
{** 	
return++ 
;++ 
},, 	
if.. 

(.. 
this.. 
... 
FindControl.. 
<.. 
HintedTextBox.. *
>..* +
(..+ ,(
MOBILE_TEXT_BOX_CONTROL_NAME.., H
)..H I
is..J L
{..M N
}..O P
mobileTextBox..Q ^
)..^ _
{// 	
mobileTextBox00 
.00 
KeyDown00 !
+=00" $"
OnMobileTextBoxKeyDown00% ;
;00; <
_handlersAttached11 
=11 
true11  $
;11$ %
}22 	
}33 
private55 
void55 !
TeardownEventHandlers55 &
(55& '
)55' (
{66 
if77 

(77 
!77 
_handlersAttached77 
)77 
{88 	
return99 
;99 
}:: 	
if<< 

(<< 
this<< 
.<< 
FindControl<< 
<<< 
HintedTextBox<< *
><<* +
(<<+ ,(
MOBILE_TEXT_BOX_CONTROL_NAME<<, H
)<<H I
is<<J L
{<<M N
}<<O P
mobileTextBox<<Q ^
)<<^ _
{== 	
mobileTextBox>> 
.>> 
KeyDown>> !
-=>>" $"
OnMobileTextBoxKeyDown>>% ;
;>>; <
}?? 	
_handlersAttachedAA 
=AA 
falseAA !
;AA! "
}BB 
privateDD 
voidDD "
OnMobileTextBoxKeyDownDD '
(DD' (
objectDD( .
?DD. /
senderDD0 6
,DD6 7
KeyEventArgsDD8 D
eDDE F
)DDF G
{EE 
ifFF 

(FF 
eFF 
.FF 
KeyFF 
!=FF 
KeyFF 
.FF 
EnterFF 
&&FF !
eFF" #
.FF# $
KeyFF$ '
!=FF( *
KeyFF+ .
.FF. /
ReturnFF/ 5
)FF5 6
{GG 	
returnHH 
;HH 
}II 	
ifKK 

(KK 
DataContextKK 
isKK 
notKK '
MobileVerificationViewModelKK :
vmKK; =
)KK= >
{LL 	
returnMM 
;MM 
}NN 	
vmPP 

.PP
 $
HandleEnterKeyPressAsyncPP #
(PP# $
)PP$ %
.PP% &
ContinueWithPP& 2
(PP2 3
taskQQ 
=>QQ 
{RR 
ifSS 
(SS 
taskSS 
.SS 
	IsFaultedSS "
&&SS# %
taskSS& *
.SS* +
	ExceptionSS+ 4
!=SS5 7
nullSS8 <
)SS< =
{TT 
SerilogUU 
.UU 
LogUU 
.UU  
ErrorUU  %
(UU% &
taskUU& *
.UU* +
	ExceptionUU+ 4
,UU4 5
$str	UU6 Ç
)
UUÇ É
;
UUÉ Ñ
}VV 
}WW 
,WW 
TaskSchedulerXX 
.XX 
DefaultXX !
)XX! "
;XX" #
eYY 	
.YY	 

HandledYY
 
=YY 
trueYY 
;YY 
}ZZ 
}[[ ﬂ
ñ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/Hosts/AuthenticationView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Views0 5
.5 6
Hosts6 ;
;; <
public 
partial 
class 
AuthenticationView '
:( )
ReactiveUserControl* =
<= >#
AuthenticationViewModel> U
>U V
{ 
public		 

AuthenticationView		 
(		 
)		 
{

 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
} ï=
ï/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/Welcome/WelcomeViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0

ViewModels0 :
.: ;
Welcome; B
;B C
public 
sealed 
class 
WelcomeViewModel $
:% &
Core' +
.+ ,
MVVM, 0
.0 1
ViewModelBase1 >
,> ?
IRoutableViewModel@ R
,R S
IResettableT _
{ 
private 
const 
string 
CREATE_ACCOUNT_KEY +
=, -
$str. =
;= >
private 
const 
string 
SIGN_IN_KEY $
=% &
$str' /
;/ 0
private 
static 
readonly 
FrozenDictionary ,
<, -
string- 3
,3 4
MembershipViewType5 G
>G H
NavigationCacheI X
=Y Z
new 

Dictionary 
< 
string 
, 
MembershipViewType 1
>1 2
{ 	
[ 
CREATE_ACCOUNT_KEY 
]  
=! "
MembershipViewType# 5
.5 6"
MobileVerificationView6 L
,L M
[ 
SIGN_IN_KEY 
] 
= 
MembershipViewType .
.. /

SignInView/ 9
} 	
.	 

ToFrozenDictionary
 
( 
) 
; 
private 
readonly 
CompositeDisposable (
_disposables) 5
=6 7
new8 ;
(; <
)< =
;= >
private 
bool 
_isDisposed 
; 
public 

WelcomeViewModel 
( 
IScreen #

hostScreen$ .
,. / 
ILocalizationService0 D
localizationServiceE X
,X Y
NetworkProviderZ i
networkProviderj y
)y z
: 	
base
 
( 
networkProvider 
, 
localizationService  3
)3 4
{   

HostScreen!! 
=!! 

hostScreen!! 
;!!  %
NavToCreateAccountCommand## !
=##" #
ReactiveCommand##$ 3
.##3 4 
CreateFromObservable##4 H
(##H I
(##I J
)##J K
=>##L N
{$$ 	#
AuthenticationViewModel%% #

hostWindow%%$ .
=%%/ 0
(%%1 2#
AuthenticationViewModel%%2 I
)%%I J

HostScreen%%J T
;%%T U
(&& 
(&& #
AuthenticationViewModel&& %
)&&% &

HostScreen&&& 0
)&&0 1
.&&1 2
CurrentFlowContext&&2 D
=&&E F%
AuthenticationFlowContext&&G `
.&&` a
Registration&&a m
;&&m n
MembershipViewType'' 
viewType'' '
=''( )
NavigationCache''* 9
[''9 :
CREATE_ACCOUNT_KEY'': L
]''L M
;''M N
return(( 

hostWindow(( 
.(( 
Navigate(( &
.((& '
Execute((' .
(((. /
viewType((/ 7
)((7 8
;((8 9
})) 	
)))	 

;))
 
NavToSignInCommand++ 
=++ 
ReactiveCommand++ ,
.++, - 
CreateFromObservable++- A
(++A B
(++B C
)++C D
=>++E G
{,, 	#
AuthenticationViewModel-- #

hostWindow--$ .
=--/ 0
(--1 2#
AuthenticationViewModel--2 I
)--I J

HostScreen--J T
;--T U
(.. 
(.. #
AuthenticationViewModel.. %
)..% &

HostScreen..& 0
)..0 1
...1 2
CurrentFlowContext..2 D
=..E F%
AuthenticationFlowContext..G `
...` a
SecureKeyRecovery..a r
;..r s
MembershipViewType// 
viewType// '
=//( )
NavigationCache//* 9
[//9 :
SIGN_IN_KEY//: E
]//E F
;//F G
return00 

hostWindow00 
.00 
Navigate00 &
.00& '
Execute00' .
(00. /
viewType00/ 7
)007 8
;008 9
}11 	
)11	 

;11
 %
NavToCreateAccountCommand33 !
.33! "
IsExecuting33" -
.33- .
ToPropertyEx33. :
(33: ;
this33; ?
,33? @
x33A B
=>33C E
x33F G
.33G H
IsCreateAccountBusy33H [
)33[ \
.33\ ]
DisposeWith33] h
(33h i
_disposables33i u
)33u v
;33v w
NavToSignInCommand44 
.44 
IsExecuting44 &
.44& '
ToPropertyEx44' 3
(443 4
this444 8
,448 9
x44: ;
=>44< >
x44? @
.44@ A
IsSignInBusy44A M
)44M N
.44N O
DisposeWith44O Z
(44Z [
_disposables44[ g
)44g h
;44h i
_disposables66 
.66 
Add66 
(66 %
NavToCreateAccountCommand66 2
)662 3
;663 4
_disposables77 
.77 
Add77 
(77 
NavToSignInCommand77 +
)77+ ,
;77, -
}88 
public:: 

string:: 
UrlPathSegment::  
=>::! #
$str::$ .
;::. /
public<< 

IScreen<< 

HostScreen<< 
{<< 
get<<  #
;<<# $
}<<% &
public>> 

ReactiveCommand>> 
<>> 
Unit>> 
,>>  
IRoutableViewModel>>! 3
>>>3 4%
NavToCreateAccountCommand>>5 N
{>>O P
get>>Q T
;>>T U
}>>V W
public@@ 

ReactiveCommand@@ 
<@@ 
Unit@@ 
,@@  
IRoutableViewModel@@! 3
>@@3 4
NavToSignInCommand@@5 G
{@@H I
get@@J M
;@@M N
}@@O P
[BB  
ObservableAsPropertyBB 
]BB 
publicCC 

boolCC 
IsCreateAccountBusyCC #
{CC$ %
getCC& )
;CC) *
}CC+ ,
[EE  
ObservableAsPropertyEE 
]EE 
publicFF 

boolFF 
IsSignInBusyFF 
{FF 
getFF "
;FF" #
}FF$ %
publicHH 

voidHH 

ResetStateHH 
(HH 
)HH 
{II 
}JJ 
	protectedLL 
overrideLL 
voidLL 
DisposeLL #
(LL# $
boolLL$ (
	disposingLL) 2
)LL2 3
{MM 
ifNN 

(NN 
_isDisposedNN 
)NN 
{OO 	
basePP 
.PP 
DisposePP 
(PP 
	disposingPP "
)PP" #
;PP# $
returnQQ 
;QQ 
}RR 	
ifTT 

(TT 
	disposingTT 
)TT 
{UU 	
_disposablesVV 
.VV 
DisposeVV  
(VV  !
)VV! "
;VV" #
}WW 	
_isDisposedYY 
=YY 
trueYY 
;YY 
baseZZ 
.ZZ 
DisposeZZ 
(ZZ 
	disposingZZ 
)ZZ 
;ZZ  
}[[ 
}\\ πÌ
ì/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/SignIn/SignInViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0

ViewModels0 :
.: ;
SignIn; A
;A B
public 
sealed 
class 
SignInViewModel #
:$ %
Core& *
.* +
MVVM+ /
./ 0
ViewModelBase0 =
,= >
IRoutableViewModel? Q
,Q R
IResettableS ^
,^ _
IDisposable` k
{ 
private   
readonly   "
IAuthenticationService   +
_authService  , 8
;  8 9
private!! 
readonly!! 
SecureTextBuffer!! %
_secureKeyBuffer!!& 6
=!!7 8
new!!9 <
(!!< =
)!!= >
;!!> ?
private"" 
readonly"" 
CompositeDisposable"" (
_disposables"") 5
=""6 7
new""8 ;
(""; <
)""< =
;""= >
private## 
readonly## 
Subject## 
<## 
string## #
>### $
_signInErrorSubject##% 8
=##9 :
new##; >
(##> ?
)##? @
;##@ A
private$$ 
readonly$$ #
AuthenticationViewModel$$ ,
_hostWindowModel$$- =
;$$= >
private&& #
CancellationTokenSource&& #
?&&# $*
_signInCancellationTokenSource&&% C
;&&C D
private'' 
bool'' '
_hasMobileNumberBeenTouched'' ,
;'', -
private(( 
bool(( $
_hasSecureKeyBeenTouched(( )
;(() *
private)) 
bool)) 
_isDisposed)) 
;)) 
public++ 

SignInViewModel++ 
(++  
IConnectivityService,, 
connectivityService,, 0
,,,0 1
NetworkProvider-- 
networkProvider-- '
,--' ( 
ILocalizationService.. 
localizationService.. 0
,..0 1"
IAuthenticationService// 
authService// *
,//* +
IScreen00 

hostScreen00 
)00 
:00 
base00 "
(00" #
networkProvider00# 2
,002 3
localizationService004 G
,00G H
connectivityService00I \
)00\ ]
{11 

HostScreen22 
=22 

hostScreen22 
;22  
_authService33 
=33 
authService33 "
;33" #
_hostWindowModel44 
=44 
(44 #
AuthenticationViewModel44 3
)443 4

hostScreen444 >
;44> ?
IObservable66 
<66 
bool66 
>66  
isFormLogicallyValid66 .
=66/ 0
SetupValidation661 @
(66@ A
)66A B
;66B C
SetupCommands77 
(77  
isFormLogicallyValid77 *
)77* +
;77+ ,
SetupSubscriptions88 
(88 
)88 
;88 
}99 
public;; 

string;; 
UrlPathSegment;;  
=>;;! #
$str;;$ .
;;;. /
public== 

IScreen== 

HostScreen== 
{== 
get==  #
;==# $
}==% &
[?? 
Reactive?? 
]?? 
public?? 
string?? 
MobileNumber?? )
{??* +
get??, /
;??/ 0
set??1 4
;??4 5
}??6 7
=??8 9
string??: @
.??@ A
Empty??A F
;??F G
[AA  
ObservableAsPropertyAA 
]AA 
publicAA !
boolAA" &
IsBusyAA' -
{AA. /
getAA0 3
;AA3 4
}AA5 6
[CC 
ReactiveCC 
]CC 
publicCC 
stringCC 
?CC 
MobileNumberErrorCC /
{CC0 1
getCC2 5
;CC5 6
setCC7 :
;CC: ;
}CC< =
[EE 
ReactiveEE 
]EE 
publicEE 
boolEE  
HasMobileNumberErrorEE /
{EE0 1
getEE2 5
;EE5 6
setEE7 :
;EE: ;
}EE< =
[GG 
ReactiveGG 
]GG 
publicGG 
stringGG 
?GG 
SecureKeyErrorGG ,
{GG- .
getGG/ 2
;GG2 3
setGG4 7
;GG7 8
}GG9 :
[II 
ReactiveII 
]II 
publicII 
boolII 
HasSecureKeyErrorII ,
{II- .
getII/ 2
;II2 3
setII4 7
;II7 8
}II9 :
[KK 
ReactiveKK 
]KK 
publicKK 
stringKK 
?KK 
ServerErrorKK )
{KK* +
getKK, /
;KK/ 0
setKK1 4
;KK4 5
}KK6 7
[MM 
ReactiveMM 
]MM 
publicMM 
boolMM 
HasServerErrorMM )
{MM* +
getMM, /
;MM/ 0
setMM1 4
;MM4 5
}MM6 7
publicOO 

intOO "
CurrentSecureKeyLengthOO %
=>OO& (
_secureKeyBufferOO) 9
.OO9 :
LengthOO: @
;OO@ A
publicQQ 

ReactiveCommandQQ 
<QQ 
SystemUQQ "
,QQ" #
ResultQQ$ *
<QQ* +
UnitQQ+ /
,QQ/ 0!
AuthenticationFailureQQ1 F
>QQF G
>QQG H
?QQH I
SignInCommandQQJ W
{QQX Y
getQQZ ]
;QQ] ^
privateQQ_ f
setQQg j
;QQj k
}QQl m
publicSS 

ReactiveCommandSS 
<SS 
SystemUSS "
,SS" #
SystemUSS$ +
>SS+ ,
?SS, -"
AccountRecoveryCommandSS. D
{SSE F
getSSG J
;SSJ K
privateSSL S
setSST W
;SSW X
}SSY Z
publicUU 

voidUU  
InsertSecureKeyCharsUU $
(UU$ %
intUU% (
indexUU) .
,UU. /
stringUU0 6
charsUU7 <
)UU< =
{VV 
ifWW 

(WW 
!WW $
_hasSecureKeyBeenTouchedWW %
)WW% &
{XX 	$
_hasSecureKeyBeenTouchedYY $
=YY% &
trueYY' +
;YY+ ,
}ZZ 	
_secureKeyBuffer\\ 
.\\ 
Insert\\ 
(\\  
index\\  %
,\\% &
chars\\' ,
)\\, -
;\\- .
this]] 
.]]  
RaisePropertyChanged]] !
(]]! "
nameof]]" (
(]]( )"
CurrentSecureKeyLength]]) ?
)]]? @
)]]@ A
;]]A B
}^^ 
public`` 

void``  
RemoveSecureKeyChars`` $
(``$ %
int``% (
index``) .
,``. /
int``0 3
count``4 9
)``9 :
{aa 
ifbb 

(bb 
!bb $
_hasSecureKeyBeenTouchedbb %
)bb% &
{cc 	$
_hasSecureKeyBeenToucheddd $
=dd% &
truedd' +
;dd+ ,
}ee 	
_secureKeyBuffergg 
.gg 
Removegg 
(gg  
indexgg  %
,gg% &
countgg' ,
)gg, -
;gg- .
thishh 
.hh  
RaisePropertyChangedhh !
(hh! "
nameofhh" (
(hh( )"
CurrentSecureKeyLengthhh) ?
)hh? @
)hh@ A
;hhA B
}ii 
publickk 

asynckk 
Taskkk $
HandleEnterKeyPressAsynckk .
(kk. /
)kk/ 0
{ll 
trymm 
{nn 	
ifoo 
(oo 
awaitoo 
SignInCommandoo #
!oo# $
.oo$ %

CanExecuteoo% /
.oo/ 0
FirstOrDefaultAsyncoo0 C
(ooC D
)ooD E
)ooE F
{pp 
SignInCommandqq 
.qq 
Executeqq %
(qq% &
)qq& '
.qq' (
	Subscribeqq( 1
(qq1 2
)qq2 3
.qq3 4
DisposeWithqq4 ?
(qq? @
_disposablesqq@ L
)qqL M
;qqM N
}rr 
}ss 	
catchtt 
(tt 
	Exceptiontt 
extt 
)tt 
{uu 	
Logvv 
.vv 
Errorvv 
(vv 
exvv 
,vv 
$strvv L
)vvL M
;vvM N
}ww 	
}xx 
publiczz 

voidzz 

ResetStatezz 
(zz 
)zz 
{{{ 
if|| 

(|| 
_isDisposed|| 
)|| 
{}} 	
return~~ 
;~~ 
} 	)
_hasMobileNumberBeenTouched
ÅÅ #
=
ÅÅ$ %
false
ÅÅ& +
;
ÅÅ+ ,&
_hasSecureKeyBeenTouched
ÇÇ  
=
ÇÇ! "
false
ÇÇ# (
;
ÇÇ( )
MobileNumber
ÑÑ 
=
ÑÑ 
string
ÑÑ 
.
ÑÑ 
Empty
ÑÑ #
;
ÑÑ# $
_secureKeyBuffer
ÖÖ 
.
ÖÖ 
Remove
ÖÖ 
(
ÖÖ  
$num
ÖÖ  !
,
ÖÖ! "
_secureKeyBuffer
ÖÖ# 3
.
ÖÖ3 4
Length
ÖÖ4 :
)
ÖÖ: ;
;
ÖÖ; <#
CancelSignInOperation
áá 
(
áá 
)
áá 
;
áá  !
_signInErrorSubject
àà 
.
àà 
OnNext
àà "
(
àà" #
string
àà# )
.
àà) *
Empty
àà* /
)
àà/ 0
;
àà0 1
MobileNumberError
ää 
=
ää 
string
ää "
.
ää" #
Empty
ää# (
;
ää( )"
HasMobileNumberError
ãã 
=
ãã 
false
ãã $
;
ãã$ %
SecureKeyError
åå 
=
åå 
string
åå 
.
åå  
Empty
åå  %
;
åå% &
HasSecureKeyError
çç 
=
çç 
false
çç !
;
çç! "
ServerError
éé 
=
éé 
string
éé 
.
éé 
Empty
éé "
;
éé" #
HasServerError
èè 
=
èè 
false
èè 
;
èè 
}
êê 
public
íí 

new
íí 
void
íí 
Dispose
íí 
(
íí 
)
íí 
{
ìì 
Dispose
îî 
(
îî 
true
îî 
)
îî 
;
îî 
}
ïï 
	protected
óó 
override
óó 
void
óó 
Dispose
óó #
(
óó# $
bool
óó$ (
	disposing
óó) 2
)
óó2 3
{
òò 
if
ôô 

(
ôô 
_isDisposed
ôô 
)
ôô 
{
öö 	
return
õõ 
;
õõ 
}
úú 	
if
ûû 

(
ûû 
	disposing
ûû 
)
ûû 
{
üü 	#
CancelSignInOperation
†† !
(
††! "
)
††" #
;
††# $
SignInCommand
¢¢ 
?
¢¢ 
.
¢¢ 
Dispose
¢¢ "
(
¢¢" #
)
¢¢# $
;
¢¢$ %$
AccountRecoveryCommand
££ "
?
££" #
.
££# $
Dispose
££$ +
(
££+ ,
)
££, -
;
££- .
_secureKeyBuffer
•• 
.
•• 
Dispose
•• $
(
••$ %
)
••% &
;
••& '!
_signInErrorSubject
¶¶ 
.
¶¶  
Dispose
¶¶  '
(
¶¶' (
)
¶¶( )
;
¶¶) *
_disposables
ßß 
.
ßß 
Dispose
ßß  
(
ßß  !
)
ßß! "
;
ßß" #
MobileNumber
©© 
=
©© 
string
©© !
.
©©! "
Empty
©©" '
;
©©' ()
_hasMobileNumberBeenTouched
™™ '
=
™™( )
false
™™* /
;
™™/ 0&
_hasSecureKeyBeenTouched
´´ $
=
´´% &
false
´´' ,
;
´´, -
}
¨¨ 	
base
ÆÆ 
.
ÆÆ 
Dispose
ÆÆ 
(
ÆÆ 
	disposing
ÆÆ 
)
ÆÆ 
;
ÆÆ  
_isDisposed
ØØ 
=
ØØ 
true
ØØ 
;
ØØ 
}
∞∞ 
private
≤≤ 
IObservable
≤≤ 
<
≤≤ 
bool
≤≤ 
>
≤≤ 
SetupValidation
≤≤ -
(
≤≤- .
)
≤≤. /
{
≥≥ 
IObservable
¥¥ 
<
¥¥ 
SystemU
¥¥ 
>
¥¥ 
languageTrigger
¥¥ ,
=
¥¥- .
LanguageChanged
¥¥/ >
;
¥¥> ?
IObservable
∂∂ 
<
∂∂ 
SystemU
∂∂ 
>
∂∂ 
mobileTrigger
∂∂ *
=
∂∂+ ,
this
∂∂- 1
.
∑∑ 
WhenAnyValue
∑∑ 
(
∑∑ 
x
∑∑ 
=>
∑∑ 
x
∑∑  
.
∑∑  !
MobileNumber
∑∑! -
)
∑∑- .
.
∏∏ 
Select
∏∏ 
(
∏∏ 
_
∏∏ 
=>
∏∏ 
SystemU
∏∏  
.
∏∏  !
Default
∏∏! (
)
∏∏( )
;
∏∏) *
IObservable
∫∫ 
<
∫∫ 
SystemU
∫∫ 
>
∫∫ 
secureKeyTrigger
∫∫ -
=
∫∫. /
this
∫∫0 4
.
ªª 
WhenAnyValue
ªª 
(
ªª 
x
ªª 
=>
ªª 
x
ªª  
.
ªª  !$
CurrentSecureKeyLength
ªª! 7
)
ªª7 8
.
ºº 
Select
ºº 
(
ºº 
_
ºº 
=>
ºº 
SystemU
ºº  
.
ºº  !
Default
ºº! (
)
ºº( )
;
ºº) *
IObservable
ææ 
<
ææ 
SystemU
ææ 
>
ææ 
validationTrigger
ææ .
=
ææ/ 0
mobileTrigger
øø 
.
¿¿ 
Merge
¿¿ 
(
¿¿ 
secureKeyTrigger
¿¿ '
)
¿¿' (
.
¡¡ 
Merge
¡¡ 
(
¡¡ 
languageTrigger
¡¡ &
)
¡¡& '
;
¡¡' (
IObservable
√√ 
<
√√ 
string
√√ 
>
√√ 
mobileValidation
√√ ,
=
√√- .
validationTrigger
√√/ @
.
ƒƒ 
Select
ƒƒ 
(
ƒƒ 
_
ƒƒ 
=>
ƒƒ #
MobileNumberValidator
ƒƒ .
.
ƒƒ. /
Validate
ƒƒ/ 7
(
ƒƒ7 8
MobileNumber
ƒƒ8 D
,
ƒƒD E!
LocalizationService
ƒƒF Y
)
ƒƒY Z
)
ƒƒZ [
.
≈≈ 
Replay
≈≈ 
(
≈≈ 
$num
≈≈ 
)
≈≈ 
.
∆∆ 
RefCount
∆∆ 
(
∆∆ 
)
∆∆ 
;
∆∆ 
IObservable
»» 
<
»» 
string
»» 
>
»» 
mobileErrorStream
»» -
=
»». /
this
»»0 4
.
»»4 5
WhenAnyValue
»»5 A
(
»»A B
x
»»B C
=>
»»D F
x
»»G H
.
»»H I
MobileNumber
»»I U
)
»»U V
.
…… 
CombineLatest
…… 
(
…… 
mobileValidation
…… +
,
……+ ,
(
……- .
mobile
……. 4
,
……4 5
error
……6 ;
)
……; <
=>
……= ?
{
   
if
ÀÀ 
(
ÀÀ 
!
ÀÀ )
_hasMobileNumberBeenTouched
ÀÀ 0
&&
ÀÀ1 3
!
ÀÀ4 5
string
ÀÀ5 ;
.
ÀÀ; < 
IsNullOrWhiteSpace
ÀÀ< N
(
ÀÀN O
mobile
ÀÀO U
)
ÀÀU V
)
ÀÀV W
{
ÃÃ )
_hasMobileNumberBeenTouched
ÕÕ /
=
ÕÕ0 1
true
ÕÕ2 6
;
ÕÕ6 7
}
ŒŒ 
return
–– 
!
–– )
_hasMobileNumberBeenTouched
–– 3
?
––4 5
string
––6 <
.
––< =
Empty
––= B
:
––C D
error
––E J
;
––J K
}
—— 
)
—— 
.
““ 
Replay
““ 
(
““ 
$num
““ 
)
““ 
.
”” 
RefCount
”” 
(
”” 
)
”” 
;
”” 
mobileErrorStream
’’ 
.
÷÷ "
DistinctUntilChanged
÷÷ !
(
÷÷! "
)
÷÷" #
.
◊◊ 
	Subscribe
◊◊ 
(
◊◊ 
error
◊◊ 
=>
◊◊ 
MobileNumberError
◊◊  1
=
◊◊2 3
error
◊◊4 9
)
◊◊9 :
.
ÿÿ 
DisposeWith
ÿÿ 
(
ÿÿ 
_disposables
ÿÿ %
)
ÿÿ% &
;
ÿÿ& '
this
⁄⁄ 
.
⁄⁄ 
WhenAnyValue
⁄⁄ 
(
⁄⁄ 
x
⁄⁄ 
=>
⁄⁄ 
x
⁄⁄  
.
⁄⁄  !
MobileNumberError
⁄⁄! 2
)
⁄⁄2 3
.
€€ 
Select
€€ 
(
€€ 
e
€€ 
=>
€€ 
!
€€ 
string
€€  
.
€€  !
IsNullOrEmpty
€€! .
(
€€. /
e
€€/ 0
)
€€0 1
)
€€1 2
.
‹‹ 
	Subscribe
‹‹ 
(
‹‹ 
flag
‹‹ 
=>
‹‹ "
HasMobileNumberError
‹‹ 3
=
‹‹4 5
flag
‹‹6 :
)
‹‹: ;
.
›› 
DisposeWith
›› 
(
›› 
_disposables
›› %
)
››% &
;
››& '
IObservable
ﬂﬂ 
<
ﬂﬂ 
string
ﬂﬂ 
>
ﬂﬂ !
secureKeyValidation
ﬂﬂ /
=
ﬂﬂ0 1
validationTrigger
ﬂﬂ2 C
.
‡‡ 
Select
‡‡ 
(
‡‡ 
_
‡‡ 
=>
‡‡ 
ValidateSecureKey
‡‡ *
(
‡‡* +
)
‡‡+ ,
)
‡‡, -
.
·· 
Replay
·· 
(
·· 
$num
·· 
)
·· 
.
‚‚ 
RefCount
‚‚ 
(
‚‚ 
)
‚‚ 
;
‚‚ 
IObservable
‰‰ 
<
‰‰ 
string
‰‰ 
>
‰‰ #
keyDisplayErrorStream
‰‰ 1
=
‰‰2 3!
secureKeyValidation
‰‰4 G
.
ÂÂ 
Select
ÂÂ 
(
ÂÂ 
error
ÂÂ 
=>
ÂÂ &
_hasSecureKeyBeenTouched
ÂÂ 5
?
ÂÂ6 7
error
ÂÂ8 =
:
ÂÂ> ?
string
ÂÂ@ F
.
ÂÂF G
Empty
ÂÂG L
)
ÂÂL M
.
ÊÊ 
Replay
ÊÊ 
(
ÊÊ 
$num
ÊÊ 
)
ÊÊ 
.
ÁÁ 
RefCount
ÁÁ 
(
ÁÁ 
)
ÁÁ 
;
ÁÁ #
keyDisplayErrorStream
ÈÈ 
.
ÍÍ "
DistinctUntilChanged
ÍÍ !
(
ÍÍ! "
)
ÍÍ" #
.
ÎÎ 
	Subscribe
ÎÎ 
(
ÎÎ 
error
ÎÎ 
=>
ÎÎ 
SecureKeyError
ÎÎ  .
=
ÎÎ/ 0
error
ÎÎ1 6
)
ÎÎ6 7
.
ÏÏ 
DisposeWith
ÏÏ 
(
ÏÏ 
_disposables
ÏÏ %
)
ÏÏ% &
;
ÏÏ& '
this
ÓÓ 
.
ÓÓ 
WhenAnyValue
ÓÓ 
(
ÓÓ 
x
ÓÓ 
=>
ÓÓ 
x
ÓÓ  
.
ÓÓ  !
SecureKeyError
ÓÓ! /
)
ÓÓ/ 0
.
ÔÔ 
Select
ÔÔ 
(
ÔÔ 
e
ÔÔ 
=>
ÔÔ 
!
ÔÔ 
string
ÔÔ  
.
ÔÔ  !
IsNullOrEmpty
ÔÔ! .
(
ÔÔ. /
e
ÔÔ/ 0
)
ÔÔ0 1
)
ÔÔ1 2
.
 
	Subscribe
 
(
 
flag
 
=>
 
HasSecureKeyError
 0
=
1 2
flag
3 7
)
7 8
.
ÒÒ 
DisposeWith
ÒÒ 
(
ÒÒ 
_disposables
ÒÒ %
)
ÒÒ% &
;
ÒÒ& '!
_signInErrorSubject
ÛÛ 
.
ÙÙ "
DistinctUntilChanged
ÙÙ !
(
ÙÙ! "
)
ÙÙ" #
.
ıı 
	Subscribe
ıı 
(
ıı 
err
ıı 
=>
ıı 
ServerError
ıı )
=
ıı* +
err
ıı, /
)
ıı/ 0
.
ˆˆ 
DisposeWith
ˆˆ 
(
ˆˆ 
_disposables
ˆˆ %
)
ˆˆ% &
;
ˆˆ& '
this
¯¯ 
.
¯¯ 
WhenAnyValue
¯¯ 
(
¯¯ 
x
¯¯ 
=>
¯¯ 
x
¯¯  
.
¯¯  !
ServerError
¯¯! ,
)
¯¯, -
.
˘˘ 
Select
˘˘ 
(
˘˘ 
e
˘˘ 
=>
˘˘ 
!
˘˘ 
string
˘˘  
.
˘˘  !
IsNullOrEmpty
˘˘! .
(
˘˘. /
e
˘˘/ 0
)
˘˘0 1
)
˘˘1 2
.
˙˙ 
	Subscribe
˙˙ 
(
˙˙ 
flag
˙˙ 
=>
˙˙ 
HasServerError
˙˙ -
=
˙˙. /
flag
˙˙0 4
)
˙˙4 5
.
˚˚ 
DisposeWith
˚˚ 
(
˚˚ 
_disposables
˚˚ %
)
˚˚% &
;
˚˚& '
IObservable
˝˝ 
<
˝˝ 
bool
˝˝ 
>
˝˝ $
isMobileLogicallyValid
˝˝ 0
=
˝˝1 2
mobileValidation
˝˝3 C
.
˛˛ 
Select
˛˛ 
(
˛˛ 
string
˛˛ 
.
˛˛ 
IsNullOrEmpty
˛˛ (
)
˛˛( )
;
˛˛) *
IObservable
ÄÄ 
<
ÄÄ 
bool
ÄÄ 
>
ÄÄ !
isKeyLogicallyValid
ÄÄ -
=
ÄÄ. /!
secureKeyValidation
ÄÄ0 C
.
ÅÅ 
Select
ÅÅ 
(
ÅÅ 
string
ÅÅ 
.
ÅÅ 
IsNullOrEmpty
ÅÅ (
)
ÅÅ( )
;
ÅÅ) *
IObservable
ÉÉ 
<
ÉÉ 
bool
ÉÉ 
>
ÉÉ "
isFormLogicallyValid
ÉÉ .
=
ÉÉ/ 0$
isMobileLogicallyValid
ÉÉ1 G
.
ÑÑ 
CombineLatest
ÑÑ 
(
ÑÑ !
isKeyLogicallyValid
ÑÑ .
,
ÑÑ. /
(
ÑÑ0 1
isMobileValid
ÑÑ1 >
,
ÑÑ> ?

isKeyValid
ÑÑ@ J
)
ÑÑJ K
=>
ÑÑL N
isMobileValid
ÑÑO \
&&
ÑÑ] _

isKeyValid
ÑÑ` j
)
ÑÑj k
.
ÖÖ "
DistinctUntilChanged
ÖÖ !
(
ÖÖ! "
)
ÖÖ" #
;
ÖÖ# $
return
áá "
isFormLogicallyValid
áá #
;
áá# $
}
àà 
private
ää 
void
ää 
SetupCommands
ää 
(
ää 
IObservable
ää *
<
ää* +
bool
ää+ /
>
ää/ 0"
isFormLogicallyValid
ää1 E
)
ääE F
{
ãã 
IObservable
åå 
<
åå 
bool
åå 
>
åå 
	canSignIn
åå #
=
åå$ %
this
åå& *
.
åå* +
WhenAnyValue
åå+ 7
(
åå7 8
x
åå8 9
=>
åå: <
x
åå= >
.
åå> ?
IsBusy
åå? E
,
ååE F
x
ååG H
=>
ååI K
x
ååL M
.
ååM N
IsInNetworkOutage
ååN _
,
åå_ `
(
çç 
isBusy
çç 
,
çç 

isInOutage
çç #
)
çç# $
=>
çç% '
!
çç( )
isBusy
çç) /
&&
çç0 2
!
çç3 4

isInOutage
çç4 >
)
çç> ?
.
éé 
CombineLatest
éé 
(
éé "
isFormLogicallyValid
éé /
,
éé/ 0
(
éé1 2

canExecute
éé2 <
,
éé< =
isValid
éé> E
)
ééE F
=>
ééG I

canExecute
ééJ T
&&
ééU W
isValid
ééX _
)
éé_ `
;
éé` a
SignInCommand
êê 
=
êê 
ReactiveCommand
êê '
.
êê' (
CreateFromTask
êê( 6
(
êê6 7
async
ëë 
(
ëë 
)
ëë 
=>
ëë 
{
íí %
CancellationTokenSource
ìì '
cts
ìì( +
=
ìì, -'
RecreateCancellationToken
ìì. G
(
ììG H
ref
ììH K,
_signInCancellationTokenSource
ììL j
)
ììj k
;
ììk l
uint
ïï 
	connectId
ïï 
=
ïï  
ComputeConnectId
ïï! 1
(
ïï1 2 
PubKeyExchangeType
ïï2 D
.
ïïD E(
DataCenterEphemeralConnect
ïïE _
)
ïï_ `
;
ïï` a
CancellationToken
ññ !
cancellationToken
ññ" 3
=
ññ4 5
cts
ññ6 9
.
ññ9 :
Token
ññ: ?
;
ññ? @
Result
óó 
<
óó 
Unit
óó 
,
óó #
AuthenticationFailure
óó 2
>
óó2 3
result
óó4 :
=
óó; <
await
òò 
_authService
òò &
.
òò& '
SignInAsync
òò' 2
(
òò2 3
MobileNumber
òò3 ?
,
òò? @
_secureKeyBuffer
òòA Q
,
òòQ R
	connectId
òòS \
,
òò\ ]
cancellationToken
òò^ o
)
òòo p
;
òòp q
return
ôô 
result
ôô 
;
ôô 
}
öö 
,
öö 
	canSignIn
õõ 
)
õõ 
;
õõ 
SignInCommand
ùù 
.
ùù 
IsExecuting
ùù !
.
ùù! "
ToPropertyEx
ùù" .
(
ùù. /
this
ùù/ 3
,
ùù3 4
x
ùù5 6
=>
ùù7 9
x
ùù: ;
.
ùù; <
IsBusy
ùù< B
)
ùùB C
;
ùùC D$
AccountRecoveryCommand
üü 
=
üü  
ReactiveCommand
üü! 0
.
üü0 1
Create
üü1 7
(
üü7 8
(
üü8 9
)
üü9 :
=>
üü; =
{
†† 	
(
°° 
(
°° %
AuthenticationViewModel
°° %
)
°°% &

HostScreen
°°& 0
)
°°0 1
.
°°1 2(
StartSecureKeyRecoveryFlow
°°2 L
(
°°L M
)
°°M N
;
°°N O
}
¢¢ 	
)
¢¢	 

;
¢¢
 
}
££ 
private
•• 
void
••  
SetupSubscriptions
•• #
(
••# $
)
••$ %
{
¶¶ 
SignInCommand
ßß 
?
ßß 
.
®® 
Where
®® 
(
®® 
result
®® 
=>
®® 
result
®® #
.
®®# $
IsErr
®®$ )
)
®®) *
.
©© 
Select
©© 
(
©© 
result
©© 
=>
©© 
result
©© $
.
©©$ %
	UnwrapErr
©©% .
(
©©. /
)
©©/ 0
)
©©0 1
.
™™ 
	Subscribe
™™ 
(
™™ 
error
™™ 
=>
™™ 
{
´´ &
_hasSecureKeyBeenTouched
¨¨ (
=
¨¨) *
true
¨¨+ /
;
¨¨/ 0!
_signInErrorSubject
≠≠ #
.
≠≠# $
OnNext
≠≠$ *
(
≠≠* +
error
≠≠+ 0
.
≠≠0 1
Message
≠≠1 8
)
≠≠8 9
;
≠≠9 :
if
ÆÆ 
(
ÆÆ 

HostScreen
ÆÆ 
is
ÆÆ !%
AuthenticationViewModel
ÆÆ" 9

hostWindow
ÆÆ: D
)
ÆÆD E
{
ØØ )
ShowServerErrorNotification
∞∞ /
(
∞∞/ 0

hostWindow
∞∞0 :
,
∞∞: ;
error
∞∞< A
.
∞∞A B
Message
∞∞B I
)
∞∞I J
;
∞∞J K
}
±± 
}
≤≤ 
)
≤≤ 
.
≥≥ 
DisposeWith
≥≥ 
(
≥≥ 
_disposables
≥≥ %
)
≥≥% &
;
≥≥& '
SignInCommand
µµ 
?
µµ 
.
∂∂ 
Where
∂∂ 
(
∂∂ 
result
∂∂ 
=>
∂∂ 
result
∂∂ #
.
∂∂# $
IsOk
∂∂$ (
)
∂∂( )
.
∑∑ 
	Subscribe
∑∑ 
(
∑∑ 
result
∑∑ 
=>
∑∑  
{
∏∏ !
_signInErrorSubject
ππ #
.
ππ# $
OnNext
ππ$ *
(
ππ* +
string
ππ+ 1
.
ππ1 2
Empty
ππ2 7
)
ππ7 8
;
ππ8 9
_hostWindowModel
ªª  
.
ªª  !'
SwitchToMainWindowCommand
ªª! :
.
ªª: ;
Execute
ªª; B
(
ªªB C
)
ªªC D
.
ªªD E
	Subscribe
ªªE N
(
ªªN O
_
ºº 
=>
ºº 
{
ºº 
}
ºº 
,
ºº 
ex
ΩΩ 
=>
ΩΩ 
{
ΩΩ 
Log
ΩΩ 
.
ΩΩ  
Error
ΩΩ  %
(
ΩΩ% &
ex
ΩΩ& (
,
ΩΩ( )
$str
ΩΩ* O
)
ΩΩO P
;
ΩΩP Q
}
ΩΩR S
)
ææ 
;
ææ 
}
øø 
)
øø 
.
¿¿ 
DisposeWith
¿¿ 
(
¿¿ 
_disposables
¿¿ %
)
¿¿% &
;
¿¿& '
}
¡¡ 
private
√√ 
string
√√ 
ValidateSecureKey
√√ $
(
√√$ %
)
√√% &
=>
√√' )
_secureKeyBuffer
ƒƒ 
.
ƒƒ 
Length
ƒƒ 
==
ƒƒ  "
$num
ƒƒ# $
?
≈≈ !
LocalizationService
≈≈ !
[
≈≈! ")
SecureKeyValidatorConstants
≈≈" =
.
≈≈= >
LocalizationKeys
≈≈> N
.
≈≈N O
REQUIRED
≈≈O W
]
≈≈W X
:
∆∆ 
string
∆∆ 
.
∆∆ 
Empty
∆∆ 
;
∆∆ 
private
»» 
void
»» #
CancelSignInOperation
»» &
(
»»& '
)
»»' (
{
…… %
CancellationTokenSource
   
?
     
cancellationSource
  ! 3
=
  4 5
Interlocked
  6 A
.
  A B
Exchange
  B J
(
  J K
ref
ÀÀ ,
_signInCancellationTokenSource
ÀÀ .
,
ÀÀ. /
null
ÃÃ 
)
ÃÃ 
;
ÃÃ 
if
ŒŒ 

(
ŒŒ  
cancellationSource
ŒŒ 
!=
ŒŒ !
null
ŒŒ" &
)
ŒŒ& '
{
œœ 	
try
–– 
{
——  
cancellationSource
““ "
.
““" #
Cancel
““# )
(
““) *
)
““* +
;
““+ ,
}
”” 
catch
‘‘ 
(
‘‘ %
ObjectDisposedException
‘‘ *
)
‘‘* +
{
’’ 
}
◊◊ 
finally
ÿÿ 
{
ŸŸ  
cancellationSource
⁄⁄ "
.
⁄⁄" #
Dispose
⁄⁄# *
(
⁄⁄* +
)
⁄⁄+ ,
;
⁄⁄, -
}
€€ 
}
‹‹ 	
}
›› 
}ﬁﬁ ‹Ö
ú/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/Registration/VerifyOtpViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0

ViewModels0 :
.: ;
Registration; G
;G H
public 
sealed 
class 
VerifyOtpViewModel &
:' (
Core) -
.- .
MVVM. 2
.2 3
ViewModelBase3 @
,@ A
IRoutableViewModelB T
,T U
IResettableV a
{ 
private 
readonly 

ByteString #
_mobileNumberIdentifier  7
;7 8
private   
readonly   -
!IApplicationSecureStorageProvider   6-
!_applicationSecureStorageProvider  7 X
;  X Y
private!! 
readonly!! &
IOpaqueRegistrationService!! / 
_registrationService!!0 D
;!!D E
private"" 
readonly"" %
ISecureKeyRecoveryService"" .
?"". /%
_secureKeyRecoveryService""0 I
;""I J
private## 
readonly##  
ILocalizationService## ) 
_localizationService##* >
;##> ?
private$$ 
readonly$$ %
AuthenticationFlowContext$$ .
_flowContext$$/ ;
;$$; <
private%% 
readonly%% 
Lock%% 
_sessionLock%% &
=%%' (
new%%) ,
(%%, -
)%%- .
;%%. /
private&& 
readonly&& 
CompositeDisposable&& (
_disposables&&) 5
=&&6 7
new&&8 ;
(&&; <
)&&< =
;&&= >
private(( 
Guid(( *
_verificationSessionIdentifier(( /
=((0 1
Guid((2 6
.((6 7
Empty((7 <
;((< =
private)) 
IDisposable)) 
?)) 
_autoRedirectTimer)) +
;))+ ,
private** 
IDisposable** 
?** 
_cooldownTimer** '
;**' (
private++ #
CancellationTokenSource++ #
?++# $$
_cancellationTokenSource++% =
;++= >
private,, 
volatile,, 
bool,, 
_isDisposed,, %
;,,% &
public.. 

VerifyOtpViewModel.. 
(..  
IConnectivityService// 
connectivityService// 0
,//0 1
NetworkProvider00 
networkProvider00 '
,00' ( 
ILocalizationService11 
localizationService11 0
,110 1
IScreen22 

hostScreen22 
,22 

ByteString33 "
mobileNumberIdentifier33 )
,33) *-
!IApplicationSecureStorageProvider44 ),
 applicationSecureStorageProvider44* J
,44J K&
IOpaqueRegistrationService55 "
registrationService55# 6
,556 7%
AuthenticationFlowContext66 !
flowContext66" -
=66. /%
AuthenticationFlowContext660 I
.66I J
Registration66J V
,66V W%
ISecureKeyRecoveryService77 !
?77! "$
secureKeyRecoveryService77# ;
=77< =
null77> B
)77B C
:77D E
base77F J
(77J K
networkProvider77K Z
,77Z [
localizationService88 
,88 
connectivityService88 0
)880 1
{99 #
_mobileNumberIdentifier:: 
=::  !"
mobileNumberIdentifier::" 8
;::8 9-
!_applicationSecureStorageProvider;; )
=;;* +,
 applicationSecureStorageProvider;;, L
;;;L M 
_registrationService<< 
=<< 
registrationService<< 2
;<<2 3%
_secureKeyRecoveryService== !
===" #$
secureKeyRecoveryService==$ <
;==< =
_flowContext>> 
=>> 
flowContext>> "
;>>" # 
_localizationService?? 
=?? 
localizationService?? 2
;??2 3
ifAA 

(AA 
flowContextAA 
==AA %
AuthenticationFlowContextAA 4
.AA4 5
SecureKeyRecoveryAA5 F
&&AAG I$
secureKeyRecoveryServiceAAJ b
==AAc e
nullAAf j
)AAj k
{BB 	
throwCC 
newCC !
ArgumentNullExceptionCC +
(CC+ ,
nameofCC, 2
(CC2 3$
secureKeyRecoveryServiceCC3 K
)CCK L
,CCL M
$strDD `
)DD` a
;DDa b
}EE 	
LogGG 
.GG 
InformationGG 
(GG 
$strGG U
,GGU V
flowContextGGW b
)GGb c
;GGc d

HostScreenII 
=II 

hostScreenII 
;II  &
NavToSecureKeyConfirmationKK "
=KK# $
ReactiveCommandKK% 4
.KK4 5 
CreateFromObservableKK5 I
(KKI J
(KKJ K
)KKK L
=>KKM O
{LL 	#
AuthenticationViewModelMM #

hostWindowMM$ .
=MM/ 0
(MM1 2#
AuthenticationViewModelMM2 I
)MMI J

HostScreenMMJ T
;MMT U
returnNN 

hostWindowNN 
.NN 
NavigateNN &
.NN& '
ExecuteNN' .
(NN. /
MembershipViewTypeNN/ A
.NNA B%
SecureKeyConfirmationViewNNB [
)NN[ \
;NN\ ]
}OO 	
)OO	 

;OO
 
IObservableQQ 
<QQ 
boolQQ 
>QQ 
	canVerifyQQ #
=QQ$ %
thisQQ& *
.QQ* +
WhenAnyValueQQ+ 7
(QQ7 8
xRR 
=>RR 
xRR 
.RR 
VerificationCodeRR #
,RR# $
xSS 
=>SS 
xSS 
.SS 
RemainingTimeSS  
,SS  !
xTT 
=>TT 
xTT 
.TT 
IsInNetworkOutageTT $
,TT$ %
(UU 
codeUU 
,UU 
timeUU 
,UU 

isInOutageUU #
)UU# $
=>UU% '
codeUU( ,
.UU, -
LengthUU- 3
==UU4 6
$numUU7 8
&&UU9 ;
codeUU< @
.UU@ A
AllUUA D
(UUD E
charUUE I
.UUI J
IsDigitUUJ Q
)UUQ R
&&UUS U
timeVV( ,
!=VV- /#
AuthenticationConstantsVV0 G
.VVG H"
EXPIRED_REMAINING_TIMEVVH ^
&&VV_ a
!VVb c

isInOutageVVc m
)WW 	
;WW	 
'
SendVerificationCodeCommandXX #
=XX$ %
ReactiveCommandXX& 5
.XX5 6
CreateFromTaskXX6 D
(XXD E 
SendVerificationCodeXXE Y
,XXY Z
	canVerifyXX[ d
)XXd e
;XXe f'
SendVerificationCodeCommandZZ #
.ZZ# $
ThrownExceptionsZZ$ 4
.[[ 
	Subscribe[[ 
([[ 
ex[[ 
=>[[ 
{\\ 
Log]] 
.]] 
Error]] 
(]] 
ex]] 
,]] 
$str]] e
)]]e f
;]]f g
if^^ 
(^^ 
_isDisposed^^ 
)^^  
{__ 
return`` 
;`` 
}aa 
ErrorMessagecc 
=cc 
excc !
.cc! "
Messagecc" )
;cc) *
HasErrordd 
=dd 
truedd 
;dd  
}ee 
)ee 
.ff 
DisposeWithff 
(ff 
_disposablesff %
)ff% &
;ff& '
IObservablehh 
<hh 
boolhh 
>hh 
	canResendhh #
=hh$ %
thishh& *
.hh* +
WhenAnyValuehh+ 7
(hh7 8
xii 
=>ii 
xii 
.ii 
SecondsRemainingii '
,ii' (
xjj 
=>jj 
xjj 
.jj 
HasValidSessionjj &
,jj& '
xkk 
=>kk 
xkk 
.kk 
CurrentStatuskk $
,kk$ %
xll 
=>ll 
xll 
.ll !
CooldownBufferSecondsll ,
,ll, -
xmm 
=>mm 
xmm 
.mm 
IsInNetworkOutagemm (
)mm( )
.nn 
Selectnn 
(nn 
tuplenn 
=>nn !
CanResendVerificationnn 2
(nn2 3
tuplenn3 8
.nn8 9
Item1nn9 >
,nn> ?
tuplenn@ E
.nnE F
Item2nnF K
,nnK L
tuplennM R
.nnR S
Item3nnS X
,nnX Y
tuplennZ _
.nn_ `
Item4nn` e
,nne f
tuplenng l
.nnl m
Item5nnm r
)nnr s
)nns t
.oo  
DistinctUntilChangedoo !
(oo! "
)oo" #
.pp 
Catchpp 
<pp 
boolpp 
,pp 
	Exceptionpp "
>pp" #
(pp# $
_pp$ %
=>pp& (

Observablepp) 3
.pp3 4
Returnpp4 :
(pp: ;
falsepp; @
)pp@ A
)ppA B
;ppB C-
!ResendSendVerificationCodeCommandqq )
=qq* +
ReactiveCommandqq, ;
.qq; <
CreateFromTaskqq< J
(qqJ K"
ReSendVerificationCodeqqK a
,qqa b
	canResendqqc l
)qql m
;qqm n-
!ResendSendVerificationCodeCommandss )
.ss) *
ThrownExceptionsss* :
.tt 
	Subscribett 
(tt 
extt 
=>tt 
{uu 
Logvv 
.vv 
Errorvv 
(vv 
exvv 
,vv 
$strvv e
)vve f
;vvf g
ifww 
(ww 
!ww 
_isDisposedww  
)ww  !
{xx 
ErrorMessageyy  
=yy! "
exyy# %
.yy% &
Messageyy& -
;yy- .
HasErrorzz 
=zz 
truezz #
;zz# $
}{{ 
}|| 
)|| 
.}} 
DisposeWith}} 
(}} 
_disposables}} %
)}}% &
;}}& ''
SendVerificationCodeCommand #
.# $
IsExecuting$ /
.
ÄÄ 
ToPropertyEx
ÄÄ 
(
ÄÄ 
this
ÄÄ 
,
ÄÄ 
x
ÄÄ  !
=>
ÄÄ" $
x
ÄÄ% &
.
ÄÄ& '
IsBusy
ÄÄ' -
)
ÄÄ- .
.
ÅÅ 
DisposeWith
ÅÅ 
(
ÅÅ 
_disposables
ÅÅ %
)
ÅÅ% &
;
ÅÅ& '/
!ResendSendVerificationCodeCommand
ÉÉ )
.
ÉÉ) *
IsExecuting
ÉÉ* 5
.
ÑÑ 
ToPropertyEx
ÑÑ 
(
ÑÑ 
this
ÑÑ 
,
ÑÑ 
x
ÑÑ  !
=>
ÑÑ" $
x
ÑÑ% &
.
ÑÑ& '
IsResending
ÑÑ' 2
)
ÑÑ2 3
.
ÖÖ 
DisposeWith
ÖÖ 
(
ÖÖ 
_disposables
ÖÖ %
)
ÖÖ% &
;
ÖÖ& '
this
áá 
.
áá 
WhenActivated
áá 
(
áá 
disposables
áá &
=>
áá' )
{
àà 	
OnViewLoaded
ââ 
(
ââ 
)
ââ 
.
ââ 
	Subscribe
ââ $
(
ââ$ %
)
ââ% &
.
ââ& '
DisposeWith
ââ' 2
(
ââ2 3
disposables
ââ3 >
)
ââ> ?
.
ââ? @
DisposeWith
ââ@ K
(
ââK L
_disposables
ââL X
)
ââX Y
;
ââY Z
this
ãã 
.
ãã 
WhenAnyValue
ãã 
(
ãã 
x
ãã 
=>
ãã  "
x
ãã# $
.
ãã$ %
ErrorMessage
ãã% 1
)
ãã1 2
.
åå "
DistinctUntilChanged
åå %
(
åå% &
)
åå& '
.
çç 
	Subscribe
çç 
(
çç 
err
çç 
=>
éé 
{
èè 
HasError
êê 
=
êê 
!
êê  
string
êê  &
.
êê& '
IsNullOrEmpty
êê' 4
(
êê4 5
err
êê5 8
)
êê8 9
;
êê9 :
if
ëë 
(
ëë 
!
ëë 
string
ëë 
.
ëë  
IsNullOrEmpty
ëë  -
(
ëë- .
err
ëë. 1
)
ëë1 2
&&
ëë3 5

HostScreen
ëë6 @
is
ëëA C%
AuthenticationViewModel
ëëD [

hostWindow
ëë\ f
)
ëëf g
{
íí )
ShowServerErrorNotification
ìì 3
(
ìì3 4

hostWindow
ìì4 >
,
ìì> ?
err
ìì@ C
)
ììC D
;
ììD E
}
îî 
}
ïï 
)
ïï 
.
ññ 
DisposeWith
ññ 
(
ññ 
disposables
ññ (
)
ññ( )
.
ññ) *
DisposeWith
ññ* 5
(
ññ5 6
_disposables
ññ6 B
)
ññB C
;
ññC D
this
òò 
.
òò 
WhenAnyValue
òò 
(
òò 
x
òò 
=>
òò  "
x
òò# $
.
òò$ %
SecondsRemaining
òò% 5
)
òò5 6
.
ôô 
Select
ôô 
(
ôô !
FormatRemainingTime
ôô +
)
ôô+ ,
.
öö 
	Subscribe
öö 
(
öö 
rt
öö 
=>
öö  
RemainingTime
öö! .
=
öö/ 0
rt
öö1 3
)
öö3 4
.
õõ 
DisposeWith
õõ 
(
õõ 
disposables
õõ (
)
õõ( )
.
õõ) *
DisposeWith
õõ* 5
(
õõ5 6
_disposables
õõ6 B
)
õõB C
;
õõC D
}
úú 	
)
úú	 

;
úú
 
}
ùù 
public
üü 

string
üü 
?
üü 
UrlPathSegment
üü !
{
üü" #
get
üü$ '
;
üü' (
}
üü) *
=
üü+ ,
$str
üü- G
;
üüG H
public
°° 

IScreen
°° 

HostScreen
°° 
{
°° 
get
°°  #
;
°°# $
}
°°% &
public
££ 

new
££  
ViewModelActivator
££ !
	Activator
££" +
{
££, -
get
££. 1
;
££1 2
}
££3 4
=
££5 6
new
££7 :
(
££: ;
)
££; <
;
££< =
public
•• 

ReactiveCommand
•• 
<
•• 
Unit
•• 
,
••  
Unit
••! %
>
••% &)
SendVerificationCodeCommand
••' B
{
••C D
get
••E H
;
••H I
}
••J K
public
ßß 

ReactiveCommand
ßß 
<
ßß 
Unit
ßß 
,
ßß  
Unit
ßß! %
>
ßß% &/
!ResendSendVerificationCodeCommand
ßß' H
{
ßßI J
get
ßßK N
;
ßßN O
}
ßßP Q
public
©© 

ReactiveCommand
©© 
<
©© 
Unit
©© 
,
©©   
IRoutableViewModel
©©! 3
>
©©3 4(
NavToSecureKeyConfirmation
©©5 O
{
©©P Q
get
©©R U
;
©©U V
}
©©W X
[
´´ 
Reactive
´´ 
]
´´ 
public
´´ 
string
´´ 
VerificationCode
´´ -
{
´´. /
get
´´0 3
;
´´3 4
set
´´5 8
;
´´8 9
}
´´: ;
=
´´< =
string
´´> D
.
´´D E
Empty
´´E J
;
´´J K
[
≠≠ 
Reactive
≠≠ 
]
≠≠ 
public
≠≠ 
string
≠≠ 
ErrorMessage
≠≠ )
{
≠≠* +
get
≠≠, /
;
≠≠/ 0
private
≠≠1 8
set
≠≠9 <
;
≠≠< =
}
≠≠> ?
=
≠≠@ A
string
≠≠B H
.
≠≠H I
Empty
≠≠I N
;
≠≠N O
[
ØØ 
Reactive
ØØ 
]
ØØ 
public
ØØ 
string
ØØ 
RemainingTime
ØØ *
{
ØØ+ ,
get
ØØ- 0
;
ØØ0 1
private
ØØ2 9
set
ØØ: =
;
ØØ= >
}
ØØ? @
=
ØØA B%
AuthenticationConstants
ØØC Z
.
ØØZ [$
INITIAL_REMAINING_TIME
ØØ[ q
;
ØØq r
[
±± 
Reactive
±± 
]
±± 
private
±± 
uint
±± 
SecondsRemaining
±± ,
{
±±- .
get
±±/ 2
;
±±2 3
set
±±4 7
;
±±7 8
}
±±9 :
[
≥≥ 
Reactive
≥≥ 
]
≥≥ 
public
≥≥ 
bool
≥≥ 
HasError
≥≥ #
{
≥≥$ %
get
≥≥& )
;
≥≥) *
private
≥≥+ 2
set
≥≥3 6
;
≥≥6 7
}
≥≥8 9
[
µµ 
Reactive
µµ 
]
µµ 
private
µµ 
uint
µµ #
CooldownBufferSeconds
µµ 1
{
µµ2 3
get
µµ4 7
;
µµ7 8
set
µµ9 <
;
µµ< =
}
µµ> ?
[
∑∑ 
Reactive
∑∑ 
]
∑∑ 
private
∏∏ )
VerificationCountdownUpdate
∏∏ '
.
∏∏' (
Types
∏∏( -
.
∏∏- .#
CountdownUpdateStatus
∏∏. C
CurrentStatus
∏∏D Q
{
∏∏R S
get
∏∏T W
;
∏∏W X
set
∏∏Y \
;
∏∏\ ]
}
∏∏^ _
=
∏∏` a)
VerificationCountdownUpdate
ππ #
.
ππ# $
Types
ππ$ )
.
ππ) *#
CountdownUpdateStatus
ππ* ?
.
ππ? @
Active
ππ@ F
;
ππF G
[
ªª 
Reactive
ªª 
]
ªª 
private
ªª 
bool
ªª "
IsMaxAttemptsReached
ªª 0
{
ªª1 2
get
ªª3 6
;
ªª6 7
set
ªª8 ;
;
ªª; <
}
ªª= >
[
ΩΩ 
Reactive
ΩΩ 
]
ΩΩ 
private
ΩΩ 
bool
ΩΩ 
HasValidSession
ΩΩ +
{
ΩΩ, -
get
ΩΩ. 1
;
ΩΩ1 2
set
ΩΩ3 6
;
ΩΩ6 7
}
ΩΩ8 9
[
øø "
ObservableAsProperty
øø 
]
øø 
public
øø !
bool
øø" &
IsBusy
øø' -
{
øø. /
get
øø0 3
;
øø3 4
}
øø5 6
[
¡¡ "
ObservableAsProperty
¡¡ 
]
¡¡ 
public
¡¡ !
bool
¡¡" &
IsResending
¡¡' 2
{
¡¡3 4
get
¡¡5 8
;
¡¡8 9
}
¡¡: ;
private
√√ 
Guid
√√ 
?
√√ +
VerificationSessionIdentifier
√√ /
{
ƒƒ 
get
≈≈ 
{
∆∆ 	
lock
«« 
(
«« 
_sessionLock
«« 
)
«« 
{
»» 
return
…… ,
_verificationSessionIdentifier
…… 5
==
……6 8
Guid
……9 =
.
……= >
Empty
……> C
?
……D E
null
……F J
:
……K L,
_verificationSessionIdentifier
……M k
;
……k l
}
   
}
ÀÀ 	
}
ÃÃ 
public
ŒŒ 

async
ŒŒ 
Task
ŒŒ &
HandleEnterKeyPressAsync
ŒŒ .
(
ŒŒ. /
)
ŒŒ/ 0
{
œœ 
if
–– 

(
–– 
_isDisposed
–– 
)
–– 
{
—— 	
return
““ 
;
““ 
}
”” 	
if
’’ 

(
’’ 
await
’’ )
SendVerificationCodeCommand
’’ -
.
’’- .

CanExecute
’’. 8
.
’’8 9!
FirstOrDefaultAsync
’’9 L
(
’’L M
)
’’M N
)
’’N O
{
÷÷ 	)
SendVerificationCodeCommand
◊◊ '
.
◊◊' (
Execute
◊◊( /
(
◊◊/ 0
)
◊◊0 1
.
◊◊1 2
	Subscribe
◊◊2 ;
(
◊◊; <
)
◊◊< =
.
◊◊= >
DisposeWith
◊◊> I
(
◊◊I J
_disposables
◊◊J V
)
◊◊V W
;
◊◊W X
}
ÿÿ 	
}
ŸŸ 
public
€€ 

void
€€ 

ResetState
€€ 
(
€€ 
)
€€ 
{
‹‹ 
if
›› 

(
›› 
_isDisposed
›› 
)
›› 
{
ﬁﬁ 	
return
ﬂﬂ 
;
ﬂﬂ 
}
‡‡ 	%
CancellationTokenSource
‚‚ 
?
‚‚  %
cancellationTokenSource
‚‚! 8
=
‚‚9 :
Interlocked
‚‚; F
.
‚‚F G
Exchange
‚‚G O
(
‚‚O P
ref
‚‚P S&
_cancellationTokenSource
‚‚T l
,
‚‚l m
null
‚‚n r
)
‚‚r s
;
‚‚s t%
cancellationTokenSource
„„ 
?
„„  
.
„„  !
Cancel
„„! '
(
„„' (
)
„„( )
;
„„) *%
cancellationTokenSource
‰‰ 
?
‰‰  
.
‰‰  !
Dispose
‰‰! (
(
‰‰( )
)
‰‰) *
;
‰‰* +
Task
ÊÊ 
.
ÊÊ 
Run
ÊÊ 
(
ÊÊ 
async
ÊÊ 
(
ÊÊ 
)
ÊÊ 
=>
ÊÊ 
{
ÁÁ 	
try
ËË 
{
ÈÈ 
await
ÍÍ 
ResetUiState
ÍÍ "
(
ÍÍ" #
)
ÍÍ# $
;
ÍÍ$ %
await
ÎÎ !
CleanupSessionAsync
ÎÎ )
(
ÎÎ) *
)
ÎÎ* +
;
ÎÎ+ ,
}
ÏÏ 
catch
ÌÌ 
(
ÌÌ 
	Exception
ÌÌ 
ex
ÌÌ 
)
ÌÌ  
{
ÓÓ 
Log
ÔÔ 
.
ÔÔ 
Error
ÔÔ 
(
ÔÔ 
ex
ÔÔ 
,
ÔÔ 
$str
ÔÔ S
)
ÔÔS T
;
ÔÔT U
}
 
}
ÒÒ 	
)
ÒÒ	 

.
ÒÒ
 
ContinueWith
ÒÒ 
(
ÒÒ 
task
ÚÚ 
=>
ÚÚ 
{
ÛÛ 
if
ÙÙ 
(
ÙÙ 
task
ÙÙ 
is
ÙÙ 
{
ÙÙ 
	IsFaulted
ÙÙ '
:
ÙÙ' (
true
ÙÙ) -
,
ÙÙ- .
	Exception
ÙÙ/ 8
:
ÙÙ8 9
not
ÙÙ: =
null
ÙÙ> B
}
ÙÙC D
)
ÙÙD E
{
ıı 
Log
ˆˆ 
.
ˆˆ 
Error
ˆˆ 
(
ˆˆ 
task
ˆˆ "
.
ˆˆ" #
	Exception
ˆˆ# ,
,
ˆˆ, -
$str
ˆˆ. k
)
ˆˆk l
;
ˆˆl m
}
˜˜ 
}
¯¯ 
,
¯¯ 
TaskScheduler
˘˘ 
.
˘˘ 
Default
˘˘ !
)
˘˘! "
;
˘˘" #
}
˙˙ 
	protected
¸¸ 
override
¸¸ 
void
¸¸ 
Dispose
¸¸ #
(
¸¸# $
bool
¸¸$ (
	disposing
¸¸) 2
)
¸¸2 3
{
˝˝ 
if
˛˛ 

(
˛˛ 
	disposing
˛˛ 
&&
˛˛ 
!
˛˛ 
_isDisposed
˛˛ %
)
˛˛% &
{
ˇˇ 	
_isDisposed
ÄÄ 
=
ÄÄ 
true
ÄÄ 
;
ÄÄ &
_cancellationTokenSource
ÅÅ $
?
ÅÅ$ %
.
ÅÅ% &
Cancel
ÅÅ& ,
(
ÅÅ, -
)
ÅÅ- .
;
ÅÅ. /&
_cancellationTokenSource
ÇÇ $
?
ÇÇ$ %
.
ÇÇ% &
Dispose
ÇÇ& -
(
ÇÇ- .
)
ÇÇ. /
;
ÇÇ/ 0 
_autoRedirectTimer
ÉÉ 
?
ÉÉ 
.
ÉÉ  
Dispose
ÉÉ  '
(
ÉÉ' (
)
ÉÉ( )
;
ÉÉ) *
_cooldownTimer
ÑÑ 
?
ÑÑ 
.
ÑÑ 
Dispose
ÑÑ #
(
ÑÑ# $
)
ÑÑ$ %
;
ÑÑ% &
_disposables
ÖÖ 
.
ÖÖ 
Dispose
ÖÖ  
(
ÖÖ  !
)
ÖÖ! "
;
ÖÖ" #
}
ÜÜ 	
base
àà 
.
àà 
Dispose
àà 
(
àà 
	disposing
àà 
)
àà 
;
àà  
}
ââ 
private
ãã 
IObservable
ãã 
<
ãã 
Unit
ãã 
>
ãã 
OnViewLoaded
ãã *
(
ãã* +
)
ãã+ ,
{
åå 
return
çç 

Observable
çç 
.
çç 
	FromAsync
çç #
(
çç# $
async
çç$ )
(
çç* +
)
çç+ ,
=>
çç- /
{
éé 	
if
èè 
(
èè 
_isDisposed
èè 
)
èè 
{
êê 
return
ëë 
;
ëë 
}
íí %
CancellationTokenSource
îî #%
cancellationTokenSource
îî$ ;
=
îî< ='
RecreateCancellationToken
îî> W
(
îîW X
ref
îîX [&
_cancellationTokenSource
îî\ t
)
îît u
;
îîu v
_disposables
ïï 
.
ïï 
Add
ïï 
(
ïï %
cancellationTokenSource
ïï 4
)
ïï4 5
;
ïï5 6
Task
óó 
<
óó 
Result
óó 
<
óó 
Ecliptix
óó  
.
óó  !
	Utilities
óó! *
.
óó* +
Unit
óó+ /
,
óó/ 0
string
óó1 7
>
óó7 8
>
óó8 9
initiateTask
óó: F
=
óóG H 
CreateInitiateTask
óóI [
(
óó[ \
)
óó\ ]
;
óó] ^
Result
òò 
<
òò 
Ecliptix
òò 
.
òò 
	Utilities
òò %
.
òò% &
Unit
òò& *
,
òò* +
string
òò, 2
>
òò2 3
result
òò4 :
=
òò; <
await
òò= B
initiateTask
òòC O
;
òòO P"
HandleInitiateResult
öö  
(
öö  !
result
öö! '
)
öö' (
;
öö( )
}
õõ 	
)
õõ	 

;
õõ
 
}
úú 
private
ûû 
Task
ûû 
<
ûû 
Result
ûû 
<
ûû 
Ecliptix
ûû  
.
ûû  !
	Utilities
ûû! *
.
ûû* +
Unit
ûû+ /
,
ûû/ 0
string
ûû1 7
>
ûû7 8
>
ûû8 9 
CreateInitiateTask
ûû: L
(
ûûL M
)
ûûM N
{
üü 
CancellationToken
†† 
cancellationToken
†† +
=
††, -&
_cancellationTokenSource
††. F
?
††F G
.
††G H
Token
††H M
??
††N P
CancellationToken
††Q b
.
††b c
None
††c g
;
††g h
Action
°° 
<
°° 
uint
°° 
,
°° 
Guid
°° 
,
°° )
VerificationCountdownUpdate
°° 6
.
°°6 7
Types
°°7 <
.
°°< =#
CountdownUpdateStatus
°°= R
,
°°R S
string
°°T Z
?
°°Z [
>
°°[ \
callback
°°] e
=
°°f g%
CreateCountdownCallback
¢¢ #
(
¢¢# $
)
¢¢$ %
;
¢¢% &
return
§§ 
_flowContext
§§ 
==
§§ '
AuthenticationFlowContext
§§ 8
.
§§8 9
Registration
§§9 E
?
•• "
_registrationService
•• "
.
••" #*
InitiateOtpVerificationAsync
••# ?
(
••? @%
_mobileNumberIdentifier
••@ W
,
••W X!
VerificationPurpose
¶¶ #
.
¶¶# $
Registration
¶¶$ 0
,
¶¶0 1
callback
¶¶2 :
,
¶¶: ;
cancellationToken
¶¶< M
)
¶¶M N
:
ßß '
_secureKeyRecoveryService
ßß '
!
ßß' (
.
ßß( ),
InitiateSecureKeyResetOtpAsync
ßß) G
(
ßßG H%
_mobileNumberIdentifier
ßßH _
,
ßß_ `
callback
ßßa i
,
ßßi j
cancellationToken
®® !
)
®®! "
;
®®" #
}
©© 
private
´´ 
Action
´´ 
<
´´ 
uint
´´ 
,
´´ 
Guid
´´ 
,
´´ )
VerificationCountdownUpdate
´´ :
.
´´: ;
Types
´´; @
.
´´@ A#
CountdownUpdateStatus
´´A V
,
´´V W
string
´´X ^
?
´´^ _
>
´´_ `%
CreateCountdownCallback
¨¨ 
(
¨¨  
)
¨¨  !
{
≠≠ 
return
ÆÆ 
(
ÆÆ 
seconds
ÆÆ 
,
ÆÆ 

identifier
ÆÆ #
,
ÆÆ# $
status
ÆÆ% +
,
ÆÆ+ ,
message
ÆÆ- 4
)
ÆÆ4 5
=>
ÆÆ6 8
RxApp
ØØ 
.
ØØ !
MainThreadScheduler
ØØ %
.
ØØ% &
Schedule
ØØ& .
(
ØØ. /
(
ØØ/ 0
)
ØØ0 1
=>
ØØ2 4
{
∞∞ 
if
±± 
(
±± 
_isDisposed
±± 
)
±±  
{
≤≤ 
return
≥≥ 
;
≥≥ 
}
¥¥ 
try
∂∂ 
{
∑∑ #
HandleCountdownUpdate
∏∏ )
(
∏∏) *
seconds
∏∏* 1
,
∏∏1 2

identifier
∏∏3 =
,
∏∏= >
status
∏∏? E
,
∏∏E F
message
∏∏G N
)
∏∏N O
;
∏∏O P
}
ππ 
catch
∫∫ 
(
∫∫ %
ObjectDisposedException
∫∫ .
)
∫∫. /
{
ªª 
}
ΩΩ 
}
ææ 
)
ææ 
;
ææ 
}
øø 
private
¡¡ 
void
¡¡ "
HandleInitiateResult
¡¡ %
(
¡¡% &
Result
¡¡& ,
<
¡¡, -
Ecliptix
¡¡- 5
.
¡¡5 6
	Utilities
¡¡6 ?
.
¡¡? @
Unit
¡¡@ D
,
¡¡D E
string
¡¡F L
>
¡¡L M
result
¡¡N T
)
¡¡T U
{
¬¬ 
bool
√√ 
shouldSetError
√√ 
=
√√ 
result
√√ $
.
√√$ %
IsErr
√√% *
&&
ƒƒ  
!
ƒƒ! "
_isDisposed
ƒƒ" -
&&
≈≈  
CurrentStatus
≈≈! .
!=
≈≈/ 1)
VerificationCountdownUpdate
≈≈2 M
.
≈≈M N
Types
≈≈N S
.
≈≈S T#
CountdownUpdateStatus
≈≈T i
.
∆∆" #
ServerUnavailable
∆∆# 4
;
∆∆4 5
if
»» 

(
»» 
shouldSetError
»» 
)
»» 
{
…… 	
ErrorMessage
   
=
   
result
   !
.
  ! "
	UnwrapErr
  " +
(
  + ,
)
  , -
;
  - .
}
ÀÀ 	
}
ÃÃ 
private
ŒŒ 
async
ŒŒ 
Task
ŒŒ "
SendVerificationCode
ŒŒ +
(
ŒŒ+ ,
)
ŒŒ, -
{
œœ 
if
–– 

(
–– 
_isDisposed
–– 
)
–– 
{
—— 	
return
““ 
;
““ 
}
”” 	
ErrorMessage
’’ 
=
’’ 
string
’’ 
.
’’ 
Empty
’’ #
;
’’# $
if
◊◊ 

(
◊◊ 
!
◊◊ 
HasValidSession
◊◊ 
)
◊◊ 
{
ÿÿ 	"
HandleNoValidSession
ŸŸ  
(
ŸŸ  !
)
ŸŸ! "
;
ŸŸ" #
return
⁄⁄ 
;
⁄⁄ 
}
€€ 	
uint
›› 
	connectId
›› 
=
›› 
ComputeConnectId
›› )
(
››) * 
PubKeyExchangeType
››* <
.
››< =(
DataCenterEphemeralConnect
››= W
)
››W X
;
››X Y
CancellationToken
ﬁﬁ 
operationToken
ﬁﬁ (
=
ﬁﬁ) *&
_cancellationTokenSource
ﬁﬁ+ C
?
ﬁﬁC D
.
ﬁﬁD E
Token
ﬁﬁE J
??
ﬁﬁK M
CancellationToken
ﬁﬁN _
.
ﬁﬁ_ `
None
ﬁﬁ` d
;
ﬁﬁd e
Task
‡‡ 
<
‡‡ 
Result
‡‡ 
<
‡‡ 

Membership
‡‡ 
,
‡‡ 
string
‡‡  &
>
‡‡& '
>
‡‡' (

verifyTask
‡‡) 3
=
‡‡4 5
CreateVerifyTask
‡‡6 F
(
‡‡F G
	connectId
‡‡G P
,
‡‡P Q
operationToken
‡‡R `
)
‡‡` a
;
‡‡a b
Result
·· 
<
·· 

Membership
·· 
,
·· 
string
·· !
>
··! "
result
··# )
=
··* +
await
··, 1

verifyTask
··2 <
;
··< =
if
„„ 

(
„„ 
_isDisposed
„„ 
)
„„ 
{
‰‰ 	
return
ÂÂ 
;
ÂÂ 
}
ÊÊ 	
if
ËË 

(
ËË 
result
ËË 
.
ËË 
IsOk
ËË 
)
ËË 
{
ÈÈ 	
await
ÍÍ *
HandleSuccessfulVerification
ÍÍ .
(
ÍÍ. /
result
ÍÍ/ 5
.
ÍÍ5 6
Unwrap
ÍÍ6 <
(
ÍÍ< =
)
ÍÍ= >
,
ÍÍ> ?
operationToken
ÍÍ@ N
)
ÍÍN O
;
ÍÍO P
}
ÎÎ 	
else
ÏÏ 
{
ÌÌ 	%
HandleVerificationError
ÓÓ #
(
ÓÓ# $
result
ÓÓ$ *
.
ÓÓ* +
	UnwrapErr
ÓÓ+ 4
(
ÓÓ4 5
)
ÓÓ5 6
)
ÓÓ6 7
;
ÓÓ7 8
}
ÔÔ 	
}
 
private
ÚÚ 
void
ÚÚ "
HandleNoValidSession
ÚÚ %
(
ÚÚ% &
)
ÚÚ& '
{
ÛÛ 
HasError
ÙÙ 
=
ÙÙ 
true
ÙÙ 
;
ÙÙ 
ErrorMessage
ıı 
=
ıı "
_localizationService
ıı +
[
ıı+ ,%
AuthenticationConstants
ıı, C
.
ııC D)
NO_VERIFICATION_SESSION_KEY
ııD _
]
ıı_ `
;
ıı` a
}
ˆˆ 
private
¯¯ 
Task
¯¯ 
<
¯¯ 
Result
¯¯ 
<
¯¯ 

Membership
¯¯ "
,
¯¯" #
string
¯¯$ *
>
¯¯* +
>
¯¯+ ,
CreateVerifyTask
¯¯- =
(
¯¯= >
uint
¯¯> B
	connectId
¯¯C L
,
¯¯L M
CancellationToken
¯¯N _
cancellationToken
¯¯` q
)
¯¯q r
{
˘˘ 
return
˙˙ 
_flowContext
˙˙ 
==
˙˙ '
AuthenticationFlowContext
˙˙ 8
.
˙˙8 9
Registration
˙˙9 E
?
˚˚ "
_registrationService
˚˚ "
.
˚˚" #
VerifyOtpAsync
˚˚# 1
(
˚˚1 2+
VerificationSessionIdentifier
¸¸ -
!
¸¸- .
.
¸¸. /
Value
¸¸/ 4
,
¸¸4 5
VerificationCode
˝˝  
,
˝˝  !
	connectId
˛˛ 
,
˛˛ 
cancellationToken
ˇˇ !
)
ˇˇ! "
:
ÄÄ '
_secureKeyRecoveryService
ÄÄ '
!
ÄÄ' (
.
ÄÄ( )*
VerifySecureKeyResetOtpAsync
ÄÄ) E
(
ÄÄE F+
VerificationSessionIdentifier
ÅÅ -
!
ÅÅ- .
.
ÅÅ. /
Value
ÅÅ/ 4
,
ÅÅ4 5
VerificationCode
ÇÇ  
,
ÇÇ  !
	connectId
ÉÉ 
,
ÉÉ 
cancellationToken
ÑÑ !
)
ÑÑ! "
;
ÑÑ" #
}
ÖÖ 
private
áá 
async
áá 
Task
áá *
HandleSuccessfulVerification
áá 3
(
áá3 4

Membership
áá4 >

membership
áá? I
,
ááI J
CancellationToken
ááK \
operationToken
áá] k
)
áák l
{
àà 
if
ââ 

(
ââ 

HostScreen
ââ 
is
ââ %
AuthenticationViewModel
ââ 1

hostWindow
ââ2 <
)
ââ< =
{
ää 	
await
ãã !
StoreMembershipData
ãã %
(
ãã% &

membership
ãã& 0
)
ãã0 1
;
ãã1 2 
NavigateToNextStep
åå 
(
åå 

hostWindow
åå )
)
åå) *
;
åå* +
}
çç 	
if
èè 

(
èè 
HasValidSession
èè 
)
èè 
{
êê 	
await
ëë (
CleanupVerificationSession
ëë ,
(
ëë, -
operationToken
ëë- ;
)
ëë; <
;
ëë< =
}
íí 	
}
ìì 
private
ïï 
async
ïï 
Task
ïï !
StoreMembershipData
ïï *
(
ïï* +

Membership
ïï+ 5

membership
ïï6 @
)
ïï@ A
{
ññ 
await
óó /
!_applicationSecureStorageProvider
óó /
.
óó/ 0+
SetApplicationMembershipAsync
óó0 M
(
óóM N

membership
óóN X
)
óóX Y
;
óóY Z
if
ôô 

(
ôô 

membership
ôô 
.
ôô %
AccountUniqueIdentifier
ôô .
!=
ôô/ 1
null
ôô2 6
&&
ôô7 9

membership
ôô: D
.
ôôD E%
AccountUniqueIdentifier
ôôE \
.
ôô\ ]
Length
ôô] c
>
ôôd e
$num
ôôf g
)
ôôg h
{
öö 	
await
õõ /
!_applicationSecureStorageProvider
õõ 3
.
úú &
SetCurrentAccountIdAsync
úú )
(
úú) *

membership
úú* 4
.
úú4 5%
AccountUniqueIdentifier
úú5 L
)
úúL M
.
ùù 
ConfigureAwait
ùù 
(
ùù  
false
ùù  %
)
ùù% &
;
ùù& '
Log
ûû 
.
ûû 
Information
ûû 
(
ûû 
$strüü à
,üüà â
Helpers
†† 
.
†† "
FromByteStringToGuid
†† ,
(
††, -

membership
††- 7
.
††7 8
UniqueIdentifier
††8 H
)
††H I
,
††I J
Helpers
°° 
.
°° "
FromByteStringToGuid
°° ,
(
°°, -

membership
°°- 7
.
°°7 8%
AccountUniqueIdentifier
°°8 O
)
°°O P
)
°°P Q
;
°°Q R
}
¢¢ 	
}
££ 
private
•• 
void
••  
NavigateToNextStep
•• #
(
••# $%
AuthenticationViewModel
••$ ;

hostWindow
••< F
)
••F G
{
¶¶ 

hostWindow
ßß 
.
ßß "
ClearNavigationStack
ßß '
(
ßß' (
true
ßß( ,
,
ßß, - 
MembershipViewType
ßß. @
.
ßß@ A$
MobileVerificationView
ßßA W
)
ßßW X
;
ßßX Y(
NavToSecureKeyConfirmation
®® "
.
®®" #
Execute
®®# *
(
®®* +
)
®®+ ,
.
®®, -
	Subscribe
®®- 6
(
®®6 7
)
®®7 8
.
®®8 9
DisposeWith
®®9 D
(
®®D E
_disposables
®®E Q
)
®®Q R
;
®®R S
}
©© 
private
´´ 
async
´´ 
Task
´´ (
CleanupVerificationSession
´´ 1
(
´´1 2
CancellationToken
´´2 C
cancellationToken
´´D U
)
´´U V
{
¨¨ 
if
≠≠ 

(
≠≠ 
_flowContext
≠≠ 
==
≠≠ '
AuthenticationFlowContext
≠≠ 5
.
≠≠5 6
Registration
≠≠6 B
)
≠≠B C
{
ÆÆ 	
await
ØØ "
_registrationService
ØØ &
.
ØØ& '-
CleanupVerificationSessionAsync
ØØ' F
(
ØØF G+
VerificationSessionIdentifier
ØØG d
!
ØØd e
.
ØØe f
Value
ØØf k
)
ØØk l
.
∞∞ 
	WaitAsync
∞∞ 
(
∞∞ %
AuthenticationConstants
∞∞ 2
.
∞∞2 3
Timeouts
∞∞3 ;
.
∞∞; <
CleanupTimeout
∞∞< J
,
∞∞J K
cancellationToken
∞∞L ]
)
∞∞] ^
;
∞∞^ _
}
±± 	
else
≤≤ 
if
≤≤ 
(
≤≤ '
_secureKeyRecoveryService
≤≤ *
!=
≤≤+ -
null
≤≤. 2
)
≤≤2 3
{
≥≥ 	
await
¥¥ '
_secureKeyRecoveryService
¥¥ +
.
µµ /
!CleanupSecureKeyResetSessionAsync
µµ 2
(
µµ2 3+
VerificationSessionIdentifier
µµ3 P
!
µµP Q
.
µµQ R
Value
µµR W
)
µµW X
.
∂∂ 
	WaitAsync
∂∂ 
(
∂∂ %
AuthenticationConstants
∂∂ 2
.
∂∂2 3
Timeouts
∂∂3 ;
.
∂∂; <
CleanupTimeout
∂∂< J
,
∂∂J K
cancellationToken
∂∂L ]
)
∂∂] ^
;
∂∂^ _
}
∑∑ 	
}
∏∏ 
private
∫∫ 
void
∫∫ %
HandleVerificationError
∫∫ (
(
∫∫( )
string
∫∫) /
error
∫∫0 5
)
∫∫5 6
{
ªª 
ErrorMessage
ºº 
=
ºº 
error
ºº 
;
ºº 
}
ΩΩ 
private
øø 
Task
øø $
ReSendVerificationCode
øø '
(
øø' (
)
øø( )
{
¿¿ 
if
¡¡ 

(
¡¡ 
_isDisposed
¡¡ 
)
¡¡ 
{
¬¬ 	
return
√√ 
Task
√√ 
.
√√ 
CompletedTask
√√ %
;
√√% &
}
ƒƒ 	
if
∆∆ 

(
∆∆ 
HasValidSession
∆∆ 
)
∆∆ 
{
«« 	$
ExecuteResendOperation
»» "
(
»»" #
)
»»# $
;
»»$ %
}
…… 	
else
   
{
ÀÀ 	#
HandleNoActiveSession
ÃÃ !
(
ÃÃ! "
)
ÃÃ" #
;
ÃÃ# $
}
ÕÕ 	
return
œœ 
Task
œœ 
.
œœ 
CompletedTask
œœ !
;
œœ! "
}
–– 
private
““ 
void
““ $
ExecuteResendOperation
““ '
(
““' (
)
““( )
{
”” 
ErrorMessage
‘‘ 
=
‘‘ 
string
‘‘ 
.
‘‘ 
Empty
‘‘ #
;
‘‘# $
HasError
’’ 
=
’’ 
false
’’ 
;
’’ %
CancellationTokenSource
◊◊ 
cancellationToken
◊◊  1
=
◊◊2 3(
CreateNewCancellationToken
◊◊4 N
(
◊◊N O
)
◊◊O P
;
◊◊P Q
Task
ŸŸ 
.
ŸŸ 
Run
ŸŸ 
(
ŸŸ 
async
ŸŸ 
(
ŸŸ 
)
ŸŸ 
=>
ŸŸ 
{
⁄⁄ 	
try
€€ 
{
‹‹ 
if
›› 
(
›› 
_isDisposed
›› 
||
››  "
cancellationToken
››# 4
.
››4 5
Token
››5 :
.
››: ;%
IsCancellationRequested
››; R
)
››R S
{
ﬁﬁ 
return
ﬂﬂ 
;
ﬂﬂ 
}
‡‡ 
cancellationToken
‚‚ !
.
‚‚! "
Token
‚‚" '
.
‚‚' (*
ThrowIfCancellationRequested
‚‚( D
(
‚‚D E
)
‚‚E F
;
‚‚F G
Task
‰‰ 
<
‰‰ 
Result
‰‰ 
<
‰‰ 
Ecliptix
‰‰ $
.
‰‰$ %
	Utilities
‰‰% .
.
‰‰. /
Unit
‰‰/ 3
,
‰‰3 4
string
‰‰5 ;
>
‰‰; <
>
‰‰< =

resendTask
‰‰> H
=
‰‰I J
CreateResendTask
‰‰K [
(
‰‰[ \
cancellationToken
‰‰\ m
.
‰‰m n
Token
‰‰n s
)
‰‰s t
;
‰‰t u
Result
ÂÂ 
<
ÂÂ 
Ecliptix
ÂÂ 
.
ÂÂ  
	Utilities
ÂÂ  )
.
ÂÂ) *
Unit
ÂÂ* .
,
ÂÂ. /
string
ÂÂ0 6
>
ÂÂ6 7
result
ÂÂ8 >
=
ÂÂ? @
await
ÂÂA F

resendTask
ÂÂG Q
;
ÂÂQ R
if
ÁÁ 
(
ÁÁ 
result
ÁÁ 
.
ÁÁ 
IsErr
ÁÁ  
&&
ÁÁ! #
!
ÁÁ$ %
_isDisposed
ÁÁ% 0
)
ÁÁ0 1
{
ËË 
HandleResendError
ÈÈ %
(
ÈÈ% &
result
ÈÈ& ,
.
ÈÈ, -
	UnwrapErr
ÈÈ- 6
(
ÈÈ6 7
)
ÈÈ7 8
)
ÈÈ8 9
;
ÈÈ9 :
}
ÍÍ 
}
ÎÎ 
catch
ÏÏ 
(
ÏÏ 
	Exception
ÏÏ 
ex
ÏÏ 
)
ÏÏ  
{
ÌÌ 
Log
ÓÓ 
.
ÓÓ 
Error
ÓÓ 
(
ÓÓ 
ex
ÓÓ 
,
ÓÓ 
$str
ÓÓ R
)
ÓÓR S
;
ÓÓS T
}
ÔÔ 
}
 	
,
	 

cancellationToken
 
.
 
Token
 "
)
" #
;
# $
}
ÒÒ 
private
ÛÛ %
CancellationTokenSource
ÛÛ #(
CreateNewCancellationToken
ÛÛ$ >
(
ÛÛ> ?
)
ÛÛ? @
{
ÙÙ %
CancellationTokenSource
ıı 
?
ıı  
oldCts
ıı! '
=
ıı( )&
_cancellationTokenSource
ıı* B
;
ııB C%
CancellationTokenSource
ˆˆ 
newCts
ˆˆ  &
=
ˆˆ' (
new
ˆˆ) ,
(
ˆˆ, -
)
ˆˆ- .
;
ˆˆ. /&
_cancellationTokenSource
˜˜  
=
˜˜! "
newCts
˜˜# )
;
˜˜) *
_disposables
¯¯ 
.
¯¯ 
Add
¯¯ 
(
¯¯ 
newCts
¯¯ 
)
¯¯  
;
¯¯  !
oldCts
˘˘ 
?
˘˘ 
.
˘˘ 
Dispose
˘˘ 
(
˘˘ 
)
˘˘ 
;
˘˘ 
return
˙˙ 
newCts
˙˙ 
;
˙˙ 
}
˚˚ 
private
˝˝ 
Task
˝˝ 
<
˝˝ 
Result
˝˝ 
<
˝˝ 
Ecliptix
˝˝  
.
˝˝  !
	Utilities
˝˝! *
.
˝˝* +
Unit
˝˝+ /
,
˝˝/ 0
string
˝˝1 7
>
˝˝7 8
>
˝˝8 9
CreateResendTask
˝˝: J
(
˝˝J K
CancellationToken
˝˝K \
cancellationToken
˝˝] n
)
˝˝n o
{
˛˛ 
Action
ˇˇ 
<
ˇˇ 
uint
ˇˇ 
,
ˇˇ 
Guid
ˇˇ 
,
ˇˇ )
VerificationCountdownUpdate
ˇˇ 6
.
ˇˇ6 7
Types
ˇˇ7 <
.
ˇˇ< =#
CountdownUpdateStatus
ˇˇ= R
,
ˇˇR S
string
ˇˇT Z
?
ˇˇZ [
>
ˇˇ[ \
countdownCallback
ˇˇ] n
=
ˇˇo p
(
ÄÄ 
seconds
ÄÄ 
,
ÄÄ 

identifier
ÄÄ  
,
ÄÄ  !
status
ÄÄ" (
,
ÄÄ( )
message
ÄÄ* 1
)
ÄÄ1 2
=>
ÄÄ3 5
RxApp
ÅÅ 
.
ÅÅ !
MainThreadScheduler
ÅÅ )
.
ÅÅ) *
Schedule
ÅÅ* 2
(
ÅÅ2 3
(
ÅÅ3 4
)
ÅÅ4 5
=>
ÅÅ6 8
{
ÇÇ 
if
ÉÉ 
(
ÉÉ 
!
ÉÉ 
_isDisposed
ÉÉ $
)
ÉÉ$ %
{
ÑÑ #
HandleCountdownUpdate
ÖÖ -
(
ÖÖ- .
seconds
ÖÖ. 5
,
ÖÖ5 6

identifier
ÖÖ7 A
,
ÖÖA B
status
ÖÖC I
,
ÖÖI J
message
ÖÖK R
)
ÖÖR S
;
ÖÖS T
}
ÜÜ 
}
áá 
)
áá 
;
áá 
return
ââ 
_flowContext
ââ 
==
ââ '
AuthenticationFlowContext
ââ 8
.
ââ8 9
Registration
ââ9 E
?
ää "
_registrationService
ää "
.
ää" #(
ResendOtpVerificationAsync
ää# =
(
ää= >+
VerificationSessionIdentifier
ãã -
!
ãã- .
.
ãã. /
Value
ãã/ 4
,
ãã4 5%
_mobileNumberIdentifier
åå '
,
åå' (
onCountdownUpdate
çç !
:
çç! "
countdownCallback
çç# 4
,
çç4 5
cancellationToken
éé !
:
éé! "
cancellationToken
éé# 4
)
éé4 5
:
èè '
_secureKeyRecoveryService
èè '
!
èè' (
.
èè( )*
ResendSecureKeyResetOtpAsync
èè) E
(
èèE F+
VerificationSessionIdentifier
êê -
!
êê- .
.
êê. /
Value
êê/ 4
,
êê4 5%
_mobileNumberIdentifier
ëë '
,
ëë' (
onCountdownUpdate
íí !
:
íí! "
countdownCallback
íí# 4
,
íí4 5
cancellationToken
ìì !
:
ìì! "
cancellationToken
ìì# 4
)
ìì4 5
;
ìì5 6
}
îî 
private
ññ 
void
ññ 
HandleResendError
ññ "
(
ññ" #
string
ññ# )
error
ññ* /
)
ññ/ 0
{
óó 
RxApp
òò 
.
òò !
MainThreadScheduler
òò !
.
òò! "
Schedule
òò" *
(
òò* +
(
òò+ ,
)
òò, -
=>
òò. 0
{
ôô 	
if
öö 
(
öö 
_isDisposed
öö 
)
öö 
{
õõ 
return
úú 
;
úú 
}
ùù 
if
üü 
(
üü &
IsServerUnavailableError
üü (
(
üü( )
error
üü) .
)
üü. /
)
üü/ 0
{
†† 
ErrorMessage
°° 
=
°° 
error
°° $
;
°°$ %$
StartAutoRedirectAsync
¢¢ &
(
¢¢& '
$num
¢¢' (
,
¢¢( ) 
MembershipViewType
¢¢* <
.
¢¢< =
WelcomeView
¢¢= H
,
¢¢H I
error
¢¢J O
)
¢¢O P
.
¢¢P Q
ContinueWith
¢¢Q ]
(
¢¢] ^
task
££ 
=>
££ 
{
§§ 
if
•• 
(
•• 
task
••  
is
••! #
{
••$ %
	IsFaulted
••& /
:
••/ 0
true
••1 5
,
••5 6
	Exception
••7 @
:
••@ A
not
••B E
null
••F J
}
••K L
)
••L M
{
¶¶ 
Log
ßß 
.
ßß  
Error
ßß  %
(
ßß% &
task
ßß& *
.
ßß* +
	Exception
ßß+ 4
,
ßß4 5
$str
ßß6 i
)
ßßi j
;
ßßj k
}
®® 
}
©© 
,
©© 
TaskScheduler
™™ !
.
™™! "
Default
™™" )
)
™™) *
;
™™* +
HasError
´´ 
=
´´ 
true
´´ 
;
´´  
HasValidSession
¨¨ 
=
¨¨  !
false
¨¨" '
;
¨¨' (
}
≠≠ 
else
ÆÆ 
{
ØØ 
ErrorMessage
∞∞ 
=
∞∞ 
error
∞∞ $
;
∞∞$ %
HasError
±± 
=
±± 
true
±± 
;
±±  
SecondsRemaining
≤≤  
=
≤≤! "
$num
≤≤# $
;
≤≤$ %
}
≥≥ 
}
¥¥ 	
)
¥¥	 

;
¥¥
 
}
µµ 
private
∑∑ 
void
∑∑ #
HandleNoActiveSession
∑∑ &
(
∑∑& '
)
∑∑' (
{
∏∏ 
SecondsRemaining
ππ 
=
ππ 
$num
ππ 
;
ππ 
ErrorMessage
∫∫ 
=
∫∫ "
_localizationService
∫∫ +
[
∫∫+ ,%
AuthenticationConstants
∫∫, C
.
∫∫C D0
"NO_ACTIVE_VERIFICATION_SESSION_KEY
∫∫D f
]
∫∫f g
;
∫∫g h
HasError
ªª 
=
ªª 
true
ªª 
;
ªª 
HasValidSession
ºº 
=
ºº 
false
ºº 
;
ºº  
}
ΩΩ 
private
øø 
uint
øø "
HandleResendCooldown
øø %
(
øø% &
string
øø& ,
?
øø, -
message
øø. 5
,
øø5 6
uint
øø7 ;
seconds
øø< C
)
øøC D
{
¿¿ 
if
¡¡ 

(
¡¡ 
!
¡¡ 
string
¡¡ 
.
¡¡ 
IsNullOrEmpty
¡¡ !
(
¡¡! "
message
¡¡" )
)
¡¡) *
)
¡¡* +
{
¬¬ 	
string
√√  
messageWithSeconds
√√ %
;
√√% &
if
ƒƒ 
(
ƒƒ 
seconds
ƒƒ 
>
ƒƒ 
$num
ƒƒ 
)
ƒƒ 
{
≈≈ 
string
∆∆ 
pluralSuffix
∆∆ #
=
∆∆$ %
seconds
∆∆& -
>
∆∆. /
$num
∆∆0 1
?
∆∆2 3
$str
∆∆4 7
:
∆∆8 9
$str
∆∆: <
;
∆∆< = 
messageWithSeconds
«« "
=
««# $
$"
««% '
{
««' (
message
««( /
}
««/ 0
$str
««0 2
{
««2 3
seconds
««3 :
}
««: ;
$str
««; B
{
««B C
pluralSuffix
««C O
}
««O P
$str
««P Z
"
««Z [
;
««[ \
}
»» 
else
…… 
{
    
messageWithSeconds
ÀÀ "
=
ÀÀ# $
message
ÀÀ% ,
;
ÀÀ, -
}
ÃÃ 
ErrorMessage
ŒŒ 
=
ŒŒ  
messageWithSeconds
ŒŒ -
;
ŒŒ- .
HasError
œœ 
=
œœ 
true
œœ 
;
œœ 
}
–– 	#
CooldownBufferSeconds
““ 
=
““ 
seconds
““  '
;
““' (
_cooldownTimer
‘‘ 
?
‘‘ 
.
‘‘ 
Dispose
‘‘ 
(
‘‘  
)
‘‘  !
;
‘‘! "
if
÷÷ 

(
÷÷ 
seconds
÷÷ 
>
÷÷ 
$num
÷÷ 
)
÷÷ 
{
◊◊ 	
_cooldownTimer
ÿÿ 
=
ÿÿ 

Observable
ÿÿ '
.
ÿÿ' (
Interval
ÿÿ( 0
(
ÿÿ0 1
TimeSpan
ÿÿ1 9
.
ÿÿ9 :
FromSeconds
ÿÿ: E
(
ÿÿE F
$num
ÿÿF G
)
ÿÿG H
)
ÿÿH I
.
ŸŸ 
	TakeWhile
ŸŸ 
(
ŸŸ 
_
ŸŸ 
=>
ŸŸ #
CooldownBufferSeconds
ŸŸ  5
>
ŸŸ6 7
$num
ŸŸ8 9
&&
ŸŸ: <
!
ŸŸ= >
_isDisposed
ŸŸ> I
)
ŸŸI J
.
⁄⁄ 
	ObserveOn
⁄⁄ 
(
⁄⁄ 
RxApp
⁄⁄  
.
⁄⁄  !!
MainThreadScheduler
⁄⁄! 4
)
⁄⁄4 5
.
€€ 
	Subscribe
€€ 
(
€€ 
_
€€ 
=>
€€ 
{
‹‹ 
if
›› 
(
›› #
CooldownBufferSeconds
›› -
>
››. /
$num
››0 1
)
››1 2
{
ﬁﬁ #
CooldownBufferSeconds
ﬂﬂ -
--
ﬂﬂ- /
;
ﬂﬂ/ 0
}
‡‡ 
if
‚‚ 
(
‚‚ #
CooldownBufferSeconds
‚‚ -
!=
‚‚. 0
$num
‚‚1 2
)
‚‚2 3
{
„„ 
return
‰‰ 
;
‰‰ 
}
ÂÂ 
ErrorMessage
ÁÁ  
=
ÁÁ! "
string
ÁÁ# )
.
ÁÁ) *
Empty
ÁÁ* /
;
ÁÁ/ 0
HasError
ËË 
=
ËË 
false
ËË $
;
ËË$ %
CurrentStatus
ÈÈ !
=
ÈÈ" #)
VerificationCountdownUpdate
ÈÈ$ ?
.
ÈÈ? @
Types
ÈÈ@ E
.
ÈÈE F#
CountdownUpdateStatus
ÈÈF [
.
ÈÈ[ \
Expired
ÈÈ\ c
;
ÈÈc d
_cooldownTimer
ÍÍ "
?
ÍÍ" #
.
ÍÍ# $
Dispose
ÍÍ$ +
(
ÍÍ+ ,
)
ÍÍ, -
;
ÍÍ- .
_cooldownTimer
ÎÎ "
=
ÎÎ# $
null
ÎÎ% )
;
ÎÎ) *
}
ÏÏ 
)
ÏÏ 
;
ÏÏ 
}
ÌÌ 	
return
ÔÔ 
$num
ÔÔ 
;
ÔÔ 
}
 
private
ÚÚ 
uint
ÚÚ %
HandleMaxAttemptsStatus
ÚÚ (
(
ÚÚ( )
)
ÚÚ) *
{
ÛÛ "
IsMaxAttemptsReached
ÙÙ 
=
ÙÙ 
true
ÙÙ #
;
ÙÙ# $$
StartAutoRedirectAsync
ıı 
(
ıı 
$num
ıı  
,
ıı  ! 
MembershipViewType
ıı" 4
.
ıı4 5
WelcomeView
ıı5 @
)
ıı@ A
.
ııA B
ContinueWith
ııB N
(
ııN O
task
ˆˆ 
=>
ˆˆ 
{
˜˜ 
if
¯¯ 
(
¯¯ 
task
¯¯ 
is
¯¯ 
{
¯¯ 
	IsFaulted
¯¯ '
:
¯¯' (
true
¯¯) -
,
¯¯- .
	Exception
¯¯/ 8
:
¯¯8 9
not
¯¯: =
null
¯¯> B
}
¯¯C D
)
¯¯D E
{
˘˘ 
Log
˙˙ 
.
˙˙ 
Error
˙˙ 
(
˙˙ 
task
˙˙ "
.
˙˙" #
	Exception
˙˙# ,
,
˙˙, -
$str
˙˙. n
)
˙˙n o
;
˙˙o p
}
˚˚ 
}
¸¸ 
,
¸¸ 
TaskScheduler
˝˝ 
.
˝˝ 
Default
˝˝ !
)
˝˝! "
;
˝˝" #
return
˛˛ 
$num
˛˛ 
;
˛˛ 
}
ˇˇ 
private
ÅÅ 
uint
ÅÅ "
HandleNotFoundStatus
ÅÅ %
(
ÅÅ% &
)
ÅÅ& '
{
ÇÇ 
string
ÉÉ 
message
ÉÉ 
=
ÉÉ "
_localizationService
ÉÉ -
[
ÉÉ- .%
AuthenticationConstants
ÉÉ. E
.
ÉÉE F#
SESSION_NOT_FOUND_KEY
ÉÉF [
]
ÉÉ[ \
;
ÉÉ\ ]$
StartAutoRedirectAsync
ÑÑ 
(
ÑÑ 
$num
ÑÑ  
,
ÑÑ  ! 
MembershipViewType
ÑÑ" 4
.
ÑÑ4 5
WelcomeView
ÑÑ5 @
,
ÑÑ@ A
message
ÑÑB I
)
ÑÑI J
.
ÑÑJ K
ContinueWith
ÑÑK W
(
ÑÑW X
task
ÖÖ 
=>
ÖÖ 
{
ÜÜ 
if
áá 
(
áá 
task
áá 
is
áá 
{
áá 
	IsFaulted
áá '
:
áá' (
true
áá) -
,
áá- .
	Exception
áá/ 8
:
áá8 9
not
áá: =
null
áá> B
}
ááC D
)
ááD E
{
àà 
Log
ââ 
.
ââ 
Error
ââ 
(
ââ 
task
ââ "
.
ââ" #
	Exception
ââ# ,
,
ââ, -
$str
ââ. k
)
ââk l
;
ââl m
}
ää 
}
ãã 
,
ãã 
TaskScheduler
åå 
.
åå 
Default
åå !
)
åå! "
;
åå" #
return
çç 
$num
çç 
;
çç 
}
éé 
private
êê 
uint
êê (
HandleSessionExpiredStatus
êê +
(
êê+ ,
)
êê, -
{
ëë 
string
íí 
message
íí 
=
íí "
_localizationService
íí -
[
íí- .%
AuthenticationConstants
íí. E
.
ííE F.
 VERIFICATION_SESSION_EXPIRED_KEY
ííF f
]
ííf g
;
ííg h$
StartAutoRedirectAsync
ìì 
(
ìì 
$num
ìì  
,
ìì  ! 
MembershipViewType
ìì" 4
.
ìì4 5
WelcomeView
ìì5 @
,
ìì@ A
message
ììB I
)
ììI J
.
ììJ K
ContinueWith
ììK W
(
ììW X
task
îî 
=>
îî 
{
ïï 
if
ññ 
(
ññ 
task
ññ 
is
ññ 
{
ññ 
	IsFaulted
ññ '
:
ññ' (
true
ññ) -
,
ññ- .
	Exception
ññ/ 8
:
ññ8 9
not
ññ: =
null
ññ> B
}
ññC D
)
ññD E
{
óó 
Log
òò 
.
òò 
Error
òò 
(
òò 
task
òò "
.
òò" #
	Exception
òò# ,
,
òò, -
$str
ôô [
)
ôô[ \
;
ôô\ ]
}
öö 
}
õõ 
,
õõ 
TaskScheduler
úú 
.
úú 
Default
úú !
)
úú! "
;
úú" #
return
ùù 
$num
ùù 
;
ùù 
}
ûû 
private
†† 
uint
††  
HandleFailedStatus
†† #
(
††# $
string
††$ *
?
††* +
error
††, 1
)
††1 2
{
°° 
Task
¢¢ 
redirectTask
¢¢ 
=
¢¢ 
!
¢¢ 
string
¢¢ #
.
¢¢# $
IsNullOrEmpty
¢¢$ 1
(
¢¢1 2
error
¢¢2 7
)
¢¢7 8
?
££ $
StartAutoRedirectAsync
££ $
(
££$ %
$num
££% &
,
££& ' 
MembershipViewType
££( :
.
££: ;
WelcomeView
££; F
,
££F G
error
££H M
)
££M N
:
§§ $
StartAutoRedirectAsync
§§ $
(
§§$ %
$num
§§% &
,
§§& ' 
MembershipViewType
§§( :
.
§§: ;
WelcomeView
§§; F
)
§§F G
;
§§G H
redirectTask
¶¶ 
.
¶¶ 
ContinueWith
¶¶ !
(
¶¶! "
task
ßß 
=>
ßß 
{
®® 
if
©© 
(
©© 
task
©© 
is
©© 
{
©© 
	IsFaulted
©© '
:
©©' (
true
©©) -
,
©©- .
	Exception
©©/ 8
:
©©8 9
not
©©: =
null
©©> B
}
©©C D
)
©©D E
{
™™ 
Log
´´ 
.
´´ 
Error
´´ 
(
´´ 
task
´´ "
.
´´" #
	Exception
´´# ,
,
´´, -
$str
¨¨ Y
)
¨¨Y Z
;
¨¨Z [
}
≠≠ 
}
ÆÆ 
,
ÆÆ 
TaskScheduler
ØØ 
.
ØØ 
Default
ØØ !
)
ØØ! "
;
ØØ" #
HasError
±± 
=
±± 
true
±± 
;
±± 
HasValidSession
≤≤ 
=
≤≤ 
false
≤≤ 
;
≤≤  
return
≥≥ 
$num
≥≥ 
;
≥≥ 
}
¥¥ 
private
∂∂ 
uint
∂∂ 
HandleUnavailable
∂∂ "
(
∂∂" #
string
∂∂# )
?
∂∂) *
message
∂∂+ 2
)
∂∂2 3
{
∑∑ 
string
∏∏ 
errorMessage
∏∏ 
=
∏∏ 
!
∏∏ 
string
∏∏ %
.
∏∏% &
IsNullOrEmpty
∏∏& 3
(
∏∏3 4
message
∏∏4 ;
)
∏∏; <
?
ππ 
message
ππ 
:
∫∫ "
_localizationService
∫∫ "
[
∫∫" #
$str
∫∫# =
]
∫∫= >
;
∫∫> ?$
StartAutoRedirectAsync
ºº 
(
ºº 
$num
ºº  
,
ºº  ! 
MembershipViewType
ºº" 4
.
ºº4 5
WelcomeView
ºº5 @
,
ºº@ A
errorMessage
ººB N
)
ººN O
.
ººO P
ContinueWith
ººP \
(
ºº\ ]
task
ΩΩ 
=>
ΩΩ 
{
ææ 
if
øø 
(
øø 
task
øø 
.
øø 
	IsFaulted
øø "
&&
øø# %
task
øø& *
.
øø* +
	Exception
øø+ 4
!=
øø5 7
null
øø8 <
)
øø< =
{
¿¿ 
Log
¡¡ 
.
¡¡ 
Error
¡¡ 
(
¡¡ 
task
¡¡ "
.
¡¡" #
	Exception
¡¡# ,
,
¡¡, -
$str
¡¡. j
)
¡¡j k
;
¡¡k l
}
¬¬ 
}
√√ 
,
√√ 
TaskScheduler
ƒƒ 
.
ƒƒ 
Default
ƒƒ !
)
ƒƒ! "
;
ƒƒ" #
HasError
∆∆ 
=
∆∆ 
true
∆∆ 
;
∆∆ 
HasValidSession
«« 
=
«« 
false
«« 
;
««  
Task
…… 
.
…… 
Run
…… 
(
…… 
async
…… 
(
…… 
)
…… 
=>
…… 
{
   	
try
ÀÀ 
{
ÃÃ 
await
ÕÕ (
EnsureProtocolInBackground
ÕÕ 0
(
ÕÕ0 1
)
ÕÕ1 2
;
ÕÕ2 3
}
ŒŒ 
catch
œœ 
(
œœ 
	Exception
œœ 
ex
œœ 
)
œœ  
{
–– 
Log
—— 
.
—— 
Warning
—— 
(
—— 
ex
—— 
,
—— 
$str
——  ^
)
——^ _
;
——_ `
}
““ 
}
”” 	
)
””	 

.
””
 
ContinueWith
”” 
(
”” 
task
‘‘ 
=>
‘‘ 
{
’’ 
if
÷÷ 
(
÷÷ 
task
÷÷ 
.
÷÷ 
	IsFaulted
÷÷ "
&&
÷÷# %
task
÷÷& *
.
÷÷* +
	Exception
÷÷+ 4
!=
÷÷5 7
null
÷÷8 <
)
÷÷< =
{
◊◊ 
Log
ÿÿ 
.
ÿÿ 
Error
ÿÿ 
(
ÿÿ 
task
ÿÿ "
.
ÿÿ" #
	Exception
ÿÿ# ,
,
ÿÿ, -
$str
ÿÿ. n
)
ÿÿn o
;
ÿÿo p
}
ŸŸ 
}
⁄⁄ 
,
⁄⁄ 
TaskScheduler
€€ 
.
€€ 
Default
€€ !
)
€€! "
;
€€" #
return
›› 
$num
›› 
;
›› 
}
ﬁﬁ 
private
‡‡ 
async
‡‡ 
Task
‡‡ (
EnsureProtocolInBackground
‡‡ 1
(
‡‡1 2
)
‡‡2 3
{
·· 
await
‚‚ 
NetworkProvider
‚‚ 
.
‚‚ (
EnsureProtocolForTypeAsync
‚‚ 8
(
‚‚8 9 
PubKeyExchangeType
„„ 
.
„„ (
DataCenterEphemeralConnect
„„ 9
)
„„9 :
;
„„: ;
}
‰‰ 
private
ÊÊ 
async
ÊÊ 
Task
ÊÊ $
StartAutoRedirectAsync
ÊÊ -
(
ÊÊ- .
int
ÊÊ. 1
seconds
ÊÊ2 9
,
ÊÊ9 : 
MembershipViewType
ÊÊ; M

targetView
ÊÊN X
,
ÊÊX Y
string
ÊÊZ `
localizedMessage
ÊÊa q
=
ÊÊr s
$str
ÊÊt v
)
ÊÊv w
{
ÁÁ 
if
ËË 

(
ËË 
_isDisposed
ËË 
)
ËË 
{
ÈÈ 	
return
ÍÍ 
;
ÍÍ 
}
ÎÎ 	
await
ÌÌ 

Dispatcher
ÌÌ 
.
ÌÌ 
UIThread
ÌÌ !
.
ÌÌ! "
InvokeAsync
ÌÌ" -
(
ÌÌ- .
(
ÌÌ. /
)
ÌÌ/ 0
=>
ÌÌ1 3
{
ÓÓ 	 
_autoRedirectTimer
ÔÔ 
?
ÔÔ 
.
ÔÔ  
Dispose
ÔÔ  '
(
ÔÔ' (
)
ÔÔ( )
;
ÔÔ) * 
_autoRedirectTimer
 
=
  
null
! %
;
% &
return
ÚÚ 
Task
ÚÚ 
.
ÚÚ 
CompletedTask
ÚÚ %
;
ÚÚ% &
}
ÛÛ 	
)
ÛÛ	 

;
ÛÛ
 
string
ıı 
message
ıı 
;
ıı 
if
˜˜ 

(
˜˜ 
!
˜˜ 
string
˜˜ 
.
˜˜ 
IsNullOrEmpty
˜˜ !
(
˜˜! "
localizedMessage
˜˜" 2
)
˜˜2 3
)
˜˜3 4
{
¯¯ 	
message
˘˘ 
=
˘˘ 
localizedMessage
˘˘ &
;
˘˘& '
}
˙˙ 	
else
˚˚ 
{
¸¸ 	
string
˝˝ 
key
˝˝ 
=
˝˝ "
IsMaxAttemptsReached
˝˝ -
?
˛˛ %
AuthenticationConstants
˛˛ )
.
˛˛) *&
MAX_ATTEMPTS_REACHED_KEY
˛˛* B
:
ˇˇ %
AuthenticationConstants
ˇˇ )
.
ˇˇ) *#
SESSION_NOT_FOUND_KEY
ˇˇ* ?
;
ˇˇ? @
message
ÅÅ 
=
ÅÅ "
_localizationService
ÅÅ *
.
ÅÅ* +
	GetString
ÅÅ+ 4
(
ÅÅ4 5
key
ÅÅ5 8
)
ÅÅ8 9
;
ÅÅ9 :
}
ÇÇ 	
if
ÑÑ 

(
ÑÑ 

HostScreen
ÑÑ 
is
ÑÑ %
AuthenticationViewModel
ÑÑ 1

hostWindow
ÑÑ2 <
)
ÑÑ< =
{
ÖÖ 	&
ShowRedirectNotification
ÜÜ $
(
ÜÜ$ %

hostWindow
ÜÜ% /
,
ÜÜ/ 0
message
ÜÜ1 8
,
ÜÜ8 9
seconds
ÜÜ: A
,
ÜÜA B
(
ÜÜC D
)
ÜÜD E
=>
ÜÜF H
{
áá 
if
àà 
(
àà 
!
àà 
_isDisposed
àà  
)
àà  !
{
ââ %
CleanupAndNavigateAsync
ää +
(
ää+ ,

targetView
ää, 6
)
ää6 7
.
ää7 8
ContinueWith
ää8 D
(
ääD E
task
ãã 
=>
ãã 
{
åå 
if
çç 
(
çç  
task
çç  $
is
çç% '
{
çç( )
	IsFaulted
çç* 3
:
çç3 4
true
çç5 9
,
çç9 :
	Exception
çç; D
:
ççD E
not
ççF I
null
ççJ N
}
ççO P
)
ççP Q
{
éé 
Log
èè  #
.
èè# $
Error
èè$ )
(
èè) *
task
èè* .
.
èè. /
	Exception
èè/ 8
,
èè8 9
$str
êê$ ^
)
êê^ _
;
êê_ `
}
ëë 
}
íí 
,
íí 
TaskScheduler
ìì %
.
ìì% &
Default
ìì& -
)
ìì- .
;
ìì. /
}
îî 
}
ïï 
)
ïï 
;
ïï 
}
ññ 	
}
óó 
private
ôô 
void
ôô #
HandleCountdownUpdate
ôô &
(
ôô& '
uint
ôô' +
seconds
ôô, 3
,
ôô3 4
Guid
ôô5 9

identifier
ôô: D
,
ôôD E)
VerificationCountdownUpdate
öö #
.
öö# $
Types
öö$ )
.
öö) *#
CountdownUpdateStatus
öö* ?
status
öö@ F
,
ööF G
string
ööH N
?
ööN O
message
ööP W
)
ööW X
{
õõ 
if
úú 

(
úú 
_isDisposed
úú 
)
úú 
{
ùù 	
return
ûû 
;
ûû 
}
üü 	
if
°° 

(
°° 
!
°° 0
"ValidateAndUpdateSessionIdentifier
°° /
(
°°/ 0

identifier
°°0 :
)
°°: ;
)
°°; <
{
¢¢ 	
return
££ 
;
££ 
}
§§ 	
SecondsRemaining
¶¶ 
=
¶¶ $
ProcessCountdownStatus
¶¶ 1
(
¶¶1 2
status
¶¶2 8
,
¶¶8 9
seconds
¶¶: A
,
¶¶A B
message
¶¶C J
)
¶¶J K
;
¶¶K L
CurrentStatus
ßß 
=
ßß 
status
ßß 
;
ßß 
}
®® 
private
™™ 
uint
™™ $
ProcessCountdownStatus
™™ '
(
™™' ()
VerificationCountdownUpdate
´´ #
.
´´# $
Types
´´$ )
.
´´) *#
CountdownUpdateStatus
´´* ?
status
´´@ F
,
´´F G
uint
¨¨ 
seconds
¨¨ 
,
¨¨ 
string
≠≠ 
?
≠≠ 
message
≠≠ 
)
≠≠ 
{
ÆÆ 
return
ØØ 
status
ØØ 
switch
ØØ 
{
∞∞ 	)
VerificationCountdownUpdate
±± '
.
±±' (
Types
±±( -
.
±±- .#
CountdownUpdateStatus
±±. C
.
±±C D
Active
±±D J
=>
±±K M
seconds
±±N U
,
±±U V)
VerificationCountdownUpdate
≤≤ '
.
≤≤' (
Types
≤≤( -
.
≤≤- .#
CountdownUpdateStatus
≤≤. C
.
≤≤C D
Expired
≤≤D K
=>
≤≤L N
$num
≤≤O P
,
≤≤P Q)
VerificationCountdownUpdate
≥≥ '
.
≥≥' (
Types
≥≥( -
.
≥≥- .#
CountdownUpdateStatus
≥≥. C
.
≥≥C D
ResendCooldown
≥≥D R
=>
≥≥S U"
HandleResendCooldown
≥≥V j
(
≥≥j k
message
≥≥k r
,
≥≥r s
seconds
≥≥t {
)
≥≥{ |
,
≥≥| })
VerificationCountdownUpdate
¥¥ '
.
¥¥' (
Types
¥¥( -
.
¥¥- .#
CountdownUpdateStatus
¥¥. C
.
¥¥C D
Failed
¥¥D J
=>
¥¥K M 
HandleFailedStatus
¥¥N `
(
¥¥` a
message
¥¥a h
)
¥¥h i
,
¥¥i j)
VerificationCountdownUpdate
µµ '
.
µµ' (
Types
µµ( -
.
µµ- .#
CountdownUpdateStatus
µµ. C
.
µµC D
NotFound
µµD L
=>
µµM O"
HandleNotFoundStatus
µµP d
(
µµd e
)
µµe f
,
µµf g)
VerificationCountdownUpdate
∂∂ '
.
∂∂' (
Types
∂∂( -
.
∂∂- .#
CountdownUpdateStatus
∂∂. C
.
∂∂C D 
MaxAttemptsReached
∂∂D V
=>
∂∂W Y%
HandleMaxAttemptsStatus
∂∂Z q
(
∂∂q r
)
∂∂r s
,
∂∂s t)
VerificationCountdownUpdate
∑∑ '
.
∑∑' (
Types
∑∑( -
.
∑∑- .#
CountdownUpdateStatus
∑∑. C
.
∑∑C D
SessionExpired
∑∑D R
=>
∑∑S U(
HandleSessionExpiredStatus
∑∑V p
(
∑∑p q
)
∑∑q r
,
∑∑r s)
VerificationCountdownUpdate
∏∏ '
.
∏∏' (
Types
∏∏( -
.
∏∏- .#
CountdownUpdateStatus
∏∏. C
.
∏∏C D
ServerUnavailable
∏∏D U
=>
∏∏V X
HandleUnavailable
∏∏Y j
(
∏∏j k
message
∏∏k r
)
∏∏r s
,
∏∏s t
_
ππ 
=>
ππ 
Math
ππ 
.
ππ 
Min
ππ 
(
ππ 
seconds
ππ !
,
ππ! "
SecondsRemaining
ππ# 3
)
ππ3 4
}
∫∫ 	
;
∫∫	 

}
ªª 
private
ΩΩ 
bool
ΩΩ 0
"ValidateAndUpdateSessionIdentifier
ΩΩ 3
(
ΩΩ3 4
Guid
ΩΩ4 8

identifier
ΩΩ9 C
)
ΩΩC D
{
ææ 
if
øø 

(
øø 

identifier
øø 
==
øø 
Guid
øø 
.
øø 
Empty
øø $
)
øø$ %
{
¿¿ 	
return
¡¡ 
true
¡¡ 
;
¡¡ 
}
¬¬ 	
lock
ƒƒ 
(
ƒƒ 
_sessionLock
ƒƒ 
)
ƒƒ 
{
≈≈ 	
if
∆∆ 
(
∆∆ 
_isDisposed
∆∆ 
)
∆∆ 
{
«« 
return
»» 
false
»» 
;
»» 
}
…… 
if
ÀÀ 
(
ÀÀ ,
_verificationSessionIdentifier
ÀÀ .
!=
ÀÀ/ 1
Guid
ÀÀ2 6
.
ÀÀ6 7
Empty
ÀÀ7 <
)
ÀÀ< =
{
ÃÃ 
return
ÕÕ ,
_verificationSessionIdentifier
ÕÕ 5
==
ÕÕ6 8

identifier
ÕÕ9 C
;
ÕÕC D
}
ŒŒ ,
_verificationSessionIdentifier
–– *
=
––+ ,

identifier
––- 7
;
––7 8
HasValidSession
—— 
=
—— 
true
—— "
;
——" #
return
““ 
true
““ 
;
““ 
}
‘‘ 	
}
’’ 
private
◊◊ 
async
◊◊ 
Task
◊◊ %
CleanupAndNavigateAsync
◊◊ .
(
◊◊. / 
MembershipViewType
◊◊/ A

targetView
◊◊B L
)
◊◊L M
{
ÿÿ 
if
ŸŸ 

(
ŸŸ 
_isDisposed
ŸŸ 
)
ŸŸ 
{
⁄⁄ 	
return
€€ 
;
€€ 
}
‹‹ 	
if
ﬁﬁ 

(
ﬁﬁ &
_cancellationTokenSource
ﬁﬁ $
!=
ﬁﬁ% '
null
ﬁﬁ( ,
)
ﬁﬁ, -
{
ﬂﬂ 	
await
‡‡ &
_cancellationTokenSource
‡‡ *
.
‡‡* +
CancelAsync
‡‡+ 6
(
‡‡6 7
)
‡‡7 8
;
‡‡8 9&
_cancellationTokenSource
·· $
.
··$ %
Dispose
··% ,
(
··, -
)
··- .
;
··. /&
_cancellationTokenSource
‚‚ $
=
‚‚% &
null
‚‚' +
;
‚‚+ ,
}
„„ 	
await
ÂÂ 

Dispatcher
ÂÂ 
.
ÂÂ 
UIThread
ÂÂ !
.
ÂÂ! "
InvokeAsync
ÂÂ" -
(
ÂÂ- .
(
ÂÂ. /
)
ÂÂ/ 0
=>
ÂÂ1 3
{
ÊÊ 	
if
ÁÁ 
(
ÁÁ 
!
ÁÁ 
_isDisposed
ÁÁ 
&&
ÁÁ 

HostScreen
ÁÁ  *
is
ÁÁ+ -%
AuthenticationViewModel
ÁÁ. E"
membershipHostWindow
ÁÁF Z
)
ÁÁZ [
{
ËË  
CleanupAndNavigate
ÈÈ "
(
ÈÈ" #"
membershipHostWindow
ÈÈ# 7
,
ÈÈ7 8

targetView
ÈÈ9 C
)
ÈÈC D
;
ÈÈD E
}
ÍÍ 
return
ÏÏ 
Task
ÏÏ 
.
ÏÏ 
CompletedTask
ÏÏ %
;
ÏÏ% &
}
ÌÌ 	
)
ÌÌ	 

;
ÌÌ
 
}
ÓÓ 
private
 
static
 
string
 !
FormatRemainingTime
 -
(
- .
uint
. 2
seconds
3 :
)
: ;
=>
< >
TimeSpan
? G
.
G H
FromSeconds
H S
(
S T
seconds
T [
)
[ \
.
\ ]
ToString
] e
(
e f
$str
f o
)
o p
;
p q
private
ÚÚ 
bool
ÚÚ &
IsServerUnavailableError
ÚÚ )
(
ÚÚ) *
string
ÚÚ* 0
errorMessage
ÚÚ1 =
)
ÚÚ= >
{
ÛÛ 
string
ÙÙ #
serverUnavailableText
ÙÙ $
=
ÙÙ% &"
_localizationService
ÙÙ' ;
[
ÙÙ; <
$str
ÙÙ< V
]
ÙÙV W
;
ÙÙW X
string
ıı $
serviceUnavailableText
ıı %
=
ıı& '"
_localizationService
ıı( <
[
ıı< =
ErrorI18nKeys
ıı= J
.
ııJ K!
SERVICE_UNAVAILABLE
ııK ^
]
ıı^ _
;
ıı_ `
return
˜˜ 
errorMessage
˜˜ 
.
˜˜ 
Contains
˜˜ $
(
˜˜$ %#
serverUnavailableText
˜˜% :
,
˜˜: ;
StringComparison
˜˜< L
.
˜˜L M
OrdinalIgnoreCase
˜˜M ^
)
˜˜^ _
||
˜˜` b
errorMessage
¯¯ 
.
¯¯ 
Contains
¯¯ $
(
¯¯$ %$
serviceUnavailableText
¯¯% ;
,
¯¯; <
StringComparison
¯¯= M
.
¯¯M N
OrdinalIgnoreCase
¯¯N _
)
¯¯_ `
||
¯¯a c
errorMessage
˘˘ 
.
˘˘ 
Contains
˘˘ $
(
˘˘$ %
$str
˘˘% 2
,
˘˘2 3
StringComparison
˘˘4 D
.
˘˘D E
OrdinalIgnoreCase
˘˘E V
)
˘˘V W
||
˘˘X Z
errorMessage
˙˙ 
.
˙˙ 
Contains
˙˙ $
(
˙˙$ %
$str
˙˙% 5
,
˙˙5 6
StringComparison
˙˙7 G
.
˙˙G H
OrdinalIgnoreCase
˙˙H Y
)
˙˙Y Z
;
˙˙Z [
}
˚˚ 
private
˝˝ 
async
˝˝ 
Task
˝˝ !
CleanupSessionAsync
˝˝ *
(
˝˝* +
)
˝˝+ ,
{
˛˛ 
if
ˇˇ 

(
ˇˇ 
HasValidSession
ˇˇ 
)
ˇˇ 
{
ÄÄ 	
Guid
ÅÅ 
	sessionId
ÅÅ 
=
ÅÅ +
VerificationSessionIdentifier
ÅÅ :
!
ÅÅ: ;
.
ÅÅ; <
Value
ÅÅ< A
;
ÅÅA B
if
ÉÉ 
(
ÉÉ 
_flowContext
ÉÉ 
==
ÉÉ '
AuthenticationFlowContext
ÉÉ  9
.
ÉÉ9 :
Registration
ÉÉ: F
)
ÉÉF G
{
ÑÑ 
await
ÖÖ "
_registrationService
ÖÖ *
.
ÖÖ* +-
CleanupVerificationSessionAsync
ÖÖ+ J
(
ÖÖJ K
	sessionId
ÖÖK T
)
ÖÖT U
;
ÖÖU V
}
ÜÜ 
else
áá 
if
áá 
(
áá '
_secureKeyRecoveryService
áá .
!=
áá/ 1
null
áá2 6
)
áá6 7
{
àà 
await
ââ '
_secureKeyRecoveryService
ââ /
.
ââ/ 0/
!CleanupSecureKeyResetSessionAsync
ââ0 Q
(
ââQ R
	sessionId
ââR [
)
ââ[ \
;
ââ\ ]
}
ää 
}
ãã 	
}
åå 
private
éé 
async
éé 
Task
éé 
ResetUiState
éé #
(
éé# $
)
éé$ %
{
èè 
if
êê 

(
êê 
_isDisposed
êê 
)
êê 
{
ëë 	
return
íí 
;
íí 
}
ìì 	
await
ïï 

Dispatcher
ïï 
.
ïï 
UIThread
ïï !
.
ïï! "
InvokeAsync
ïï" -
(
ïï- .
async
ïï. 3
(
ïï4 5
)
ïï5 6
=>
ïï7 9
{
ññ 	 
_autoRedirectTimer
óó 
?
óó 
.
óó  
Dispose
óó  '
(
óó' (
)
óó( )
;
óó) * 
_autoRedirectTimer
òò 
=
òò  
null
òò! %
;
òò% &
_cooldownTimer
öö 
?
öö 
.
öö 
Dispose
öö #
(
öö# $
)
öö$ %
;
öö% &
_cooldownTimer
õõ 
=
õõ 
null
õõ !
;
õõ! "
if
ùù 
(
ùù 

HostScreen
ùù 
is
ùù %
AuthenticationViewModel
ùù 5

hostWindow
ùù6 @
)
ùù@ A
{
ûû 
await
üü 

hostWindow
üü  
.
üü  !"
HideBottomSheetAsync
üü! 5
(
üü5 6
)
üü6 7
;
üü7 8
}
†† 
VerificationCode
¢¢ 
=
¢¢ 
$str
¢¢ !
;
¢¢! "
ErrorMessage
££ 
=
££ 
string
££ !
.
££! "
Empty
££" '
;
££' (
HasError
§§ 
=
§§ 
false
§§ 
;
§§ 
SecondsRemaining
•• 
=
•• 
$num
••  
;
••  !
RemainingTime
¶¶ 
=
¶¶ %
AuthenticationConstants
¶¶ 3
.
¶¶3 4$
INITIAL_REMAINING_TIME
¶¶4 J
;
¶¶J K"
IsMaxAttemptsReached
ßß  
=
ßß! "
false
ßß# (
;
ßß( )
CurrentStatus
®® 
=
®® )
VerificationCountdownUpdate
®® 7
.
®®7 8
Types
®®8 =
.
®®= >#
CountdownUpdateStatus
®®> S
.
®®S T
Active
®®T Z
;
®®Z [
lock
©© 
(
©© 
_sessionLock
©© 
)
©© 
{
™™ ,
_verificationSessionIdentifier
´´ .
=
´´/ 0
Guid
´´1 5
.
´´5 6
Empty
´´6 ;
;
´´; <
HasValidSession
¨¨ 
=
¨¨  !
false
¨¨" '
;
¨¨' (
}
≠≠ 
}
ÆÆ 	
)
ÆÆ	 

;
ÆÆ
 
}
ØØ 
private
±± 
static
±± 
bool
±± #
CanResendVerification
±± -
(
±±- .
uint
≤≤ 
secondsRemaining
≤≤ 
,
≤≤ 
bool
≥≥ 
hasValidSession
≥≥ 
,
≥≥ )
VerificationCountdownUpdate
¥¥ #
.
¥¥# $
Types
¥¥$ )
.
¥¥) *#
CountdownUpdateStatus
¥¥* ?
status
¥¥@ F
,
¥¥F G
uint
µµ #
cooldownBufferSeconds
µµ "
,
µµ" #
bool
∂∂ 
isInNetworkOutage
∂∂ 
)
∂∂ 
{
∑∑ 
if
∏∏ 

(
∏∏ 
!
∏∏ 
hasValidSession
∏∏ 
||
∏∏ 
isInNetworkOutage
∏∏  1
)
∏∏1 2
{
ππ 	
return
∫∫ 
false
∫∫ 
;
∫∫ 
}
ªª 	
if
ΩΩ 

(
ΩΩ 
status
ΩΩ 
==
ΩΩ )
VerificationCountdownUpdate
ΩΩ 1
.
ΩΩ1 2
Types
ΩΩ2 7
.
ΩΩ7 8#
CountdownUpdateStatus
ΩΩ8 M
.
ΩΩM N
ResendCooldown
ΩΩN \
)
ΩΩ\ ]
{
ææ 	
return
øø #
cooldownBufferSeconds
øø (
==
øø) +
$num
øø, -
;
øø- .
}
¿¿ 	
if
¬¬ 

(
¬¬ 
secondsRemaining
¬¬ 
!=
¬¬ 
$num
¬¬  !
)
¬¬! "
{
√√ 	
return
ƒƒ 
false
ƒƒ 
;
ƒƒ 
}
≈≈ 	
return
«« 
status
«« 
==
«« )
VerificationCountdownUpdate
«« 4
.
««4 5
Types
««5 :
.
««: ;#
CountdownUpdateStatus
««; P
.
««P Q
Expired
««Q X
;
««X Y
}
»» 
}…… Ü“
§/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/Registration/SecureKeyVerifierViewModel.cs
	namespace!! 	
Ecliptix!!
 
.!! 
Core!! 
.!! 
Features!!  
.!!  !
Authentication!!! /
.!!/ 0

ViewModels!!0 :
.!!: ;
Registration!!; G
;!!G H
public## 
sealed## 
class## &
SecureKeyVerifierViewModel## .
:##/ 0
Core##1 5
.##5 6
MVVM##6 :
.##: ;
ViewModelBase##; H
,##H I
IRoutableViewModel##J \
,##\ ]
IResettable##^ i
{$$ 
private%% 
const%% 
int%% "
VALIDATION_THROTTLE_MS%% ,
=%%- .
$num%%/ 2
;%%2 3
private'' 
readonly'' 
SecureTextBuffer'' %
_secureKeyBuffer''& 6
=''7 8
new''9 <
(''< =
)''= >
;''> ?
private(( 
readonly(( 
SecureTextBuffer(( %"
_verifySecureKeyBuffer((& <
=((= >
new((? B
(((B C
)((C D
;((D E
private)) 
readonly)) -
!IApplicationSecureStorageProvider)) 6-
!_applicationSecureStorageProvider))7 X
;))X Y
private** 
readonly** &
IOpaqueRegistrationService** / 
_registrationService**0 D
;**D E
private++ 
readonly++ "
IAuthenticationService++ +"
_authenticationService++, B
;++B C
private,, 
readonly,, %
ISecureKeyRecoveryService,, .%
_secureKeyRecoveryService,,/ H
;,,H I
private-- 
readonly-- %
AuthenticationFlowContext-- .
_flowContext--/ ;
;--; <
private// #
CancellationTokenSource// #
?//# $ 
_currentOperationCts//% 9
;//9 :
private00 
bool00 $
_hasSecureKeyBeenTouched00 )
;00) *
private11 
bool11 *
_hasVerifySecureKeyBeenTouched11 /
;11/ 0
private22 
bool22 
_isDisposed22 
;22 
public44 
&
SecureKeyVerifierViewModel44 %
(44% & 
IConnectivityService55 
connectivityService55 0
,550 1
NetworkProvider66 
networkProvider66 '
,66' ( 
ILocalizationService77 
localizationService77 0
,770 1
IScreen88 

hostScreen88 
,88 -
!IApplicationSecureStorageProvider99 ),
 applicationSecureStorageProvider99* J
,99J K&
IOpaqueRegistrationService:: "
registrationService::# 6
,::6 7"
IAuthenticationService;; !
authenticationService;; 4
,;;4 5%
ISecureKeyRecoveryService<< !$
secureKeyRecoveryService<<" :
,<<: ;%
AuthenticationFlowContext== !
flowContext==" -
)>> 
:>> 
base>> 
(>> 
networkProvider>> 
,>> 
localizationService>> 1
,>>1 2
connectivityService>>3 F
)>>F G
{?? 

HostScreen@@ 
=@@ 

hostScreen@@ 
;@@  -
!_applicationSecureStorageProviderAA )
=AA* +,
 applicationSecureStorageProviderAA, L
;AAL M 
_registrationServiceBB 
=BB 
registrationServiceBB 2
;BB2 3"
_authenticationServiceCC 
=CC  !
authenticationServiceCC! 6
;CC6 7%
_secureKeyRecoveryServiceDD !
=DD" #$
secureKeyRecoveryServiceDD$ <
;DD< =
_flowContextEE 
=EE 
flowContextEE "
;EE" #
LogGG 
.GG 
InformationGG 
(GG 
$strGG ]
,GG] ^
flowContextGG_ j
)GGj k
;GGk l
IObservableII 
<II 
boolII 
>II  
isFormLogicallyValidII .
=II/ 0
SetupValidationII1 @
(II@ A
)IIA B
;IIB C
SetupCommandsJJ 
(JJ  
isFormLogicallyValidJJ *
)JJ* +
;JJ+ ,
SetupSubscriptionsKK 
(KK 
)KK 
;KK 
}LL 
publicNN 

stringNN 
TitleNN 
=>NN 
LocalizeNN #
(NN# $
KeysNN$ (
.NN( )
REGISTRATION_TITLENN) ;
,NN; <
KeysNN= A
.NNA B
RECOVERY_TITLENNB P
)NNP Q
;NNQ R
publicOO 

stringOO 
DescriptionOO 
=>OO  
LocalizeOO! )
(OO) *
KeysOO* .
.OO. /$
REGISTRATION_DESCRIPTIONOO/ G
,OOG H
KeysOOI M
.OOM N 
RECOVERY_DESCRIPTIONOON b
)OOb c
;OOc d
publicPP 

stringPP  
SecureKeyPlaceholderPP &
=>PP' )
LocalizePP* 2
(PP2 3
KeysPP3 7
.PP7 8"
SECURE_KEY_PLACEHOLDERPP8 N
,PPN O
KeysPPP T
.PPT U+
RECOVERY_SECURE_KEY_PLACEHOLDERPPU t
)PPt u
;PPu v
publicQQ 

stringQQ 
SecureKeyHintQQ 
=>QQ  "
LocalizeQQ# +
(QQ+ ,
KeysQQ, 0
.QQ0 1
SECURE_KEY_HINTQQ1 @
,QQ@ A
KeysQQB F
.QQF G$
RECOVERY_SECURE_KEY_HINTQQG _
)QQ_ `
;QQ` a
publicSS 

stringSS &
VerifySecureKeyPlaceholderSS ,
=>SS- /
LocalizeTT 
(TT 
KeysTT 
.TT )
VERIFY_SECURE_KEY_PLACEHOLDERTT 3
,TT3 4
KeysTT5 9
.TT9 :2
&RECOVERY_VERIFY_SECURE_KEY_PLACEHOLDERTT: `
)TT` a
;TTa b
publicVV 

stringVV 
VerifySecureKeyHintVV %
=>VV& (
LocalizeVV) 1
(VV1 2
KeysVV2 6
.VV6 7"
VERIFY_SECURE_KEY_HINTVV7 M
,VVM N
KeysVVO S
.VVS T+
RECOVERY_VERIFY_SECURE_KEY_HINTVVT s
)VVs t
;VVt u
publicWW 

stringWW 

ButtonTextWW 
=>WW 
LocalizeWW  (
(WW( )
KeysWW) -
.WW- .
REGISTRATION_BUTTONWW. A
,WWA B
KeysWWC G
.WWG H
RECOVERY_BUTTONWWH W
)WWW X
;WWX Y
publicYY 

stringYY 
?YY 
UrlPathSegmentYY !
{YY" #
getYY$ '
;YY' (
}YY) *
=YY+ ,
$strYY- G
;YYG H
publicZZ 

IScreenZZ 

HostScreenZZ 
{ZZ 
getZZ  #
;ZZ# $
}ZZ% &
public\\ 

int\\ "
CurrentSecureKeyLength\\ %
=>\\& (
_secureKeyBuffer\\) 9
.\\9 :
Length\\: @
;\\@ A
public]] 

int]] (
CurrentVerifySecureKeyLength]] +
=>]], ."
_verifySecureKeyBuffer]]/ E
.]]E F
Length]]F L
;]]L M
public__ 

ReactiveCommand__ 
<__ 
SystemU__ "
,__" #
SystemU__$ +
>__+ ,
SubmitCommand__- :
{__; <
get__= @
;__@ A
private__B I
set__J M
;__M N
}__O P
=__Q R
null__S W
!__W X
;__X Y
[aa 
Reactiveaa 
]aa 
publicaa 
stringaa 
?aa 
SecureKeyErroraa ,
{aa- .
getaa/ 2
;aa2 3
privateaa4 ;
setaa< ?
;aa? @
}aaA B
[bb 
Reactivebb 
]bb 
publicbb 
boolbb 
HasSecureKeyErrorbb ,
{bb- .
getbb/ 2
;bb2 3
privatebb4 ;
setbb< ?
;bb? @
}bbA B
[cc 
Reactivecc 
]cc 
publiccc 
stringcc 
?cc  
VerifySecureKeyErrorcc 2
{cc3 4
getcc5 8
;cc8 9
privatecc: A
setccB E
;ccE F
}ccG H
[dd 
Reactivedd 
]dd 
publicdd 
booldd #
HasVerifySecureKeyErrordd 2
{dd3 4
getdd5 8
;dd8 9
privatedd: A
setddB E
;ddE F
}ddG H
[ee 
Reactiveee 
]ee 
publicee 
stringee 
?ee 
ServerErroree )
{ee* +
getee, /
;ee/ 0
privateee1 8
setee9 <
;ee< =
}ee> ?
[ff 
Reactiveff 
]ff 
publicff 
boolff 
HasServerErrorff )
{ff* +
getff, /
;ff/ 0
privateff1 8
setff9 <
;ff< =
}ff> ?
[gg  
ObservableAsPropertygg 
]gg 
publicgg !
boolgg" &
	CanSubmitgg' 0
{gg1 2
getgg3 6
;gg6 7
}gg8 9
[ii  
ObservableAsPropertyii 
]ii 
publicii !
SecureKeyStrengthii" 3$
CurrentSecureKeyStrengthii4 L
{iiM N
getiiO R
;iiR S
privateiiT [
setii\ _
;ii_ `
}iia b
[jj  
ObservableAsPropertyjj 
]jj 
publicjj !
stringjj" (
?jj( )$
SecureKeyStrengthMessagejj* B
{jjC D
getjjE H
;jjH I
privatejjJ Q
setjjR U
;jjU V
}jjW X
[kk  
ObservableAsPropertykk 
]kk 
publickk !
boolkk" &#
HasSecureKeyBeenTouchedkk' >
{kk? @
getkkA D
;kkD E
privatekkF M
setkkN Q
;kkQ R
}kkS T
[ll  
ObservableAsPropertyll 
]ll 
publicll !
boolll" &
IsBusyll' -
{ll. /
getll0 3
;ll3 4
}ll5 6
[nn 
Reactivenn 
]nn 
publicnn 
boolnn 
IsMembershipLoadingnn .
{nn/ 0
getnn1 4
;nn4 5
privatenn6 =
setnn> A
;nnA B
}nnC D
=nnE F
truennG K
;nnK L
privatepp 

ByteStringpp 
?pp 
MembershipUniqueIdpp *
{pp+ ,
getpp- 0
;pp0 1
setpp2 5
;pp5 6
}pp7 8
privaterr 
voidrr 
SetupCommandsrr 
(rr 
IObservablerr *
<rr* +
boolrr+ /
>rr/ 0 
isFormLogicallyValidrr1 E
)rrE F
{ss 
IObservablett 
<tt 
booltt 
>tt 
canExecuteSubmittt *
=tt+ ,
thistt- 1
.tt1 2
WhenAnyValuett2 >
(tt> ?
xuu 
=>uu 
xuu 
.uu 
IsBusyuu 
,uu 
xvv 
=>vv 
xvv 
.vv 
IsInNetworkOutagevv (
,vv( )
xww 
=>ww 
xww 
.ww 
IsMembershipLoadingww *
,ww* +
(xx 
isBusyxx 
,xx 

isInOutagexx #
,xx# $
isMembershipLoadingxx% 8
)xx8 9
=>xx: <
!xx= >
isBusyxx> D
&&xxE G
!xxH I

isInOutagexxI S
&&xxT V
!xxW X
isMembershipLoadingxxX k
)xxk l
.yy 
CombineLatestyy 
(yy  
isFormLogicallyValidyy /
,yy/ 0
(yy1 2

canExecuteyy2 <
,yy< =
isValidyy> E
)yyE F
=>yyG I

canExecuteyyJ T
&&yyU W
isValidyyX _
)yy_ `
;yy` a
SubmitCommand{{ 
={{ 
ReactiveCommand{{ '
.{{' (
CreateFromTask{{( 6
({{6 7
SubmitAsync{{7 B
,{{B C
canExecuteSubmit{{D T
){{T U
;{{U V
SubmitCommand|| 
.|| 
IsExecuting|| !
.||! "
ToPropertyEx||" .
(||. /
this||/ 3
,||3 4
x||5 6
=>||7 9
x||: ;
.||; <
IsBusy||< B
)||B C
;||C D
canExecuteSubmit}} 
.}} 
ToPropertyEx}} %
(}}% &
this}}& *
,}}* +
x}}, -
=>}}. 0
x}}1 2
.}}2 3
	CanSubmit}}3 <
)}}< =
;}}= >
}~~ 
private
ÄÄ 
void
ÄÄ  
SetupSubscriptions
ÄÄ #
(
ÄÄ# $
)
ÄÄ$ %
{
ÅÅ 
this
ÇÇ 
.
ÇÇ 
WhenActivated
ÇÇ 
(
ÇÇ 
disposables
ÇÇ &
=>
ÇÇ' )
{
ÉÉ 	

Observable
ÑÑ 
.
ÑÑ 
	FromAsync
ÑÑ  
(
ÑÑ  !!
LoadMembershipAsync
ÑÑ! 4
)
ÑÑ4 5
.
ÖÖ 
	Subscribe
ÖÖ 
(
ÖÖ 
result
ÜÜ 
=>
ÜÜ 
{
áá !
IsMembershipLoading
àà +
=
àà, -
false
àà. 3
;
àà3 4
if
ää 
(
ää 
!
ää 
result
ää #
.
ää# $
IsErr
ää$ )
)
ää) *
{
ãã 
return
åå "
;
åå" #
}
çç 
(
èè 
(
èè %
AuthenticationViewModel
èè 1
)
èè1 2

HostScreen
èè2 <
)
èè< =
.
èè= >"
ClearNavigationStack
èè> R
(
èèR S
)
èèS T
;
èèT U
(
êê 
(
êê %
AuthenticationViewModel
êê 1
)
êê1 2

HostScreen
êê2 <
)
êê< =
.
êê= >
Navigate
êê> F
.
êêF G
Execute
êêG N
(
êêN O 
MembershipViewType
êêO a
.
êêa b
WelcomeView
êêb m
)
êêm n
;
êên o
}
ëë 
,
ëë 
error
íí 
=>
íí 
{
ìì !
IsMembershipLoading
îî +
=
îî, -
false
îî. 3
;
îî3 4
Log
ïï 
.
ïï 
Error
ïï !
(
ïï! "
error
ïï" '
,
ïï' (
$str
ïï) e
)
ïïe f
;
ïïf g
(
ññ 
(
ññ %
AuthenticationViewModel
ññ 1
)
ññ1 2

HostScreen
ññ2 <
)
ññ< =
.
ññ= >"
ClearNavigationStack
ññ> R
(
ññR S
)
ññS T
;
ññT U
(
óó 
(
óó %
AuthenticationViewModel
óó 1
)
óó1 2

HostScreen
óó2 <
)
óó< =
.
óó= >
Navigate
óó> F
.
óóF G
Execute
óóG N
(
óóN O 
MembershipViewType
óóO a
.
óóa b
WelcomeView
óób m
)
óóm n
;
óón o
}
òò 
)
òò 
.
ôô 
DisposeWith
ôô 
(
ôô 
disposables
ôô (
)
ôô( )
;
ôô) *
this
õõ 
.
õõ 
WhenAnyValue
õõ 
(
õõ 
x
õõ 
=>
õõ  "
x
õõ# $
.
õõ$ %
ServerError
õõ% 0
)
õõ0 1
.
úú "
DistinctUntilChanged
úú %
(
úú% &
)
úú& '
.
ùù 
	Subscribe
ùù 
(
ùù 
err
ùù 
=>
ûû 
{
üü 
HasServerError
†† "
=
††# $
!
††% &
string
††& ,
.
††, -
IsNullOrEmpty
††- :
(
††: ;
err
††; >
)
††> ?
;
††? @
if
°° 
(
°° 
!
°° 
string
°° 
.
°°  
IsNullOrEmpty
°°  -
(
°°- .
err
°°. 1
)
°°1 2
&&
°°3 5

HostScreen
°°6 @
is
°°A C%
AuthenticationViewModel
°°D [

hostWindow
°°\ f
)
°°f g
{
¢¢ )
ShowServerErrorNotification
££ 3
(
££3 4

hostWindow
££4 >
,
££> ?
err
££@ C
)
££C D
;
££D E
}
§§ 
}
•• 
)
•• 
.
¶¶ 
DisposeWith
¶¶ 
(
¶¶ 
disposables
¶¶ (
)
¶¶( )
;
¶¶) *
SubmitCommand
®® 
.
©© 
Where
©© 
(
©© 
_
©© 
=>
©© 
!
©© 
IsBusy
©© #
&&
©©$ &
	CanSubmit
©©' 0
)
©©0 1
.
™™ 
	Subscribe
™™ 
(
™™ 
_
™™ 
=>
™™ 
{
´´ 
(
¨¨ 
(
¨¨ %
AuthenticationViewModel
¨¨ -
)
¨¨- .

HostScreen
¨¨. 8
)
¨¨8 9
.
¨¨9 :"
ClearNavigationStack
¨¨: N
(
¨¨N O
true
¨¨O S
)
¨¨S T
;
¨¨T U
(
≠≠ 
(
≠≠ %
AuthenticationViewModel
≠≠ -
)
≠≠- .

HostScreen
≠≠. 8
)
≠≠8 9
.
≠≠9 :
Navigate
≠≠: B
.
≠≠B C
Execute
≠≠C J
(
≠≠J K 
MembershipViewType
≠≠K ]
.
≠≠] ^

PinSetView
≠≠^ h
)
≠≠h i
;
≠≠i j
}
ÆÆ 
)
ÆÆ 
.
ØØ 
DisposeWith
ØØ 
(
ØØ 
disposables
ØØ (
)
ØØ( )
;
ØØ) *
}
∞∞ 	
)
∞∞	 

;
∞∞
 
}
±± 
public
≥≥ 

void
≥≥ "
InsertSecureKeyChars
≥≥ $
(
≥≥$ %
int
≥≥% (
index
≥≥) .
,
≥≥. /
string
≥≥0 6
chars
≥≥7 <
)
≥≥< =
{
¥¥ 
if
µµ 

(
µµ 
!
µµ &
_hasSecureKeyBeenTouched
µµ %
)
µµ% &
{
∂∂ 	&
_hasSecureKeyBeenTouched
∑∑ $
=
∑∑% &
true
∑∑' +
;
∑∑+ ,
}
∏∏ 	
_secureKeyBuffer
∫∫ 
.
∫∫ 
Insert
∫∫ 
(
∫∫  
index
∫∫  %
,
∫∫% &
chars
∫∫' ,
)
∫∫, -
;
∫∫- .
this
ªª 
.
ªª "
RaisePropertyChanged
ªª !
(
ªª! "
nameof
ªª" (
(
ªª( )$
CurrentSecureKeyLength
ªª) ?
)
ªª? @
)
ªª@ A
;
ªªA B
}
ºº 
public
ææ 

void
ææ "
RemoveSecureKeyChars
ææ $
(
ææ$ %
int
ææ% (
index
ææ) .
,
ææ. /
int
ææ0 3
count
ææ4 9
)
ææ9 :
{
øø 
if
¿¿ 

(
¿¿ 
!
¿¿ &
_hasSecureKeyBeenTouched
¿¿ %
)
¿¿% &
{
¡¡ 	&
_hasSecureKeyBeenTouched
¬¬ $
=
¬¬% &
true
¬¬' +
;
¬¬+ ,
}
√√ 	
_secureKeyBuffer
≈≈ 
.
≈≈ 
Remove
≈≈ 
(
≈≈  
index
≈≈  %
,
≈≈% &
count
≈≈' ,
)
≈≈, -
;
≈≈- .
this
∆∆ 
.
∆∆ "
RaisePropertyChanged
∆∆ !
(
∆∆! "
nameof
∆∆" (
(
∆∆( )$
CurrentSecureKeyLength
∆∆) ?
)
∆∆? @
)
∆∆@ A
;
∆∆A B
}
«« 
public
…… 

void
…… (
InsertVerifySecureKeyChars
…… *
(
……* +
int
……+ .
index
……/ 4
,
……4 5
string
……6 <
chars
……= B
)
……B C
{
   
if
ÀÀ 

(
ÀÀ 
!
ÀÀ ,
_hasVerifySecureKeyBeenTouched
ÀÀ +
)
ÀÀ+ ,
{
ÃÃ 	,
_hasVerifySecureKeyBeenTouched
ÕÕ *
=
ÕÕ+ ,
true
ÕÕ- 1
;
ÕÕ1 2
}
ŒŒ 	$
_verifySecureKeyBuffer
–– 
.
–– 
Insert
–– %
(
––% &
index
––& +
,
––+ ,
chars
––- 2
)
––2 3
;
––3 4
this
—— 
.
—— "
RaisePropertyChanged
—— !
(
——! "
nameof
——" (
(
——( )*
CurrentVerifySecureKeyLength
——) E
)
——E F
)
——F G
;
——G H
}
““ 
public
‘‘ 

void
‘‘ (
RemoveVerifySecureKeyChars
‘‘ *
(
‘‘* +
int
‘‘+ .
index
‘‘/ 4
,
‘‘4 5
int
‘‘6 9
count
‘‘: ?
)
‘‘? @
{
’’ 
if
÷÷ 

(
÷÷ 
!
÷÷ ,
_hasVerifySecureKeyBeenTouched
÷÷ +
)
÷÷+ ,
{
◊◊ 	,
_hasVerifySecureKeyBeenTouched
ÿÿ *
=
ÿÿ+ ,
true
ÿÿ- 1
;
ÿÿ1 2
}
ŸŸ 	$
_verifySecureKeyBuffer
€€ 
.
€€ 
Remove
€€ %
(
€€% &
index
€€& +
,
€€+ ,
count
€€- 2
)
€€2 3
;
€€3 4
this
‹‹ 
.
‹‹ "
RaisePropertyChanged
‹‹ !
(
‹‹! "
nameof
‹‹" (
(
‹‹( )*
CurrentVerifySecureKeyLength
‹‹) E
)
‹‹E F
)
‹‹F G
;
‹‹G H
}
›› 
public
ﬂﬂ 

async
ﬂﬂ 
Task
ﬂﬂ &
HandleEnterKeyPressAsync
ﬂﬂ .
(
ﬂﬂ. /
)
ﬂﬂ/ 0
{
‡‡ 
if
·· 

(
·· 
await
·· 
SubmitCommand
·· 
.
··  

CanExecute
··  *
.
··* +!
FirstOrDefaultAsync
··+ >
(
··> ?
)
··? @
)
··@ A
{
‚‚ 	
SubmitCommand
„„ 
.
„„ 
Execute
„„ !
(
„„! "
)
„„" #
.
„„# $
	Subscribe
„„$ -
(
„„- .
)
„„. /
;
„„/ 0
}
‰‰ 	
}
ÂÂ 
public
ÁÁ 

void
ÁÁ 

ResetState
ÁÁ 
(
ÁÁ 
)
ÁÁ 
{
ËË 
_secureKeyBuffer
ÈÈ 
.
ÈÈ 
Remove
ÈÈ 
(
ÈÈ  
$num
ÈÈ  !
,
ÈÈ! "
_secureKeyBuffer
ÈÈ# 3
.
ÈÈ3 4
Length
ÈÈ4 :
)
ÈÈ: ;
;
ÈÈ; <$
_verifySecureKeyBuffer
ÍÍ 
.
ÍÍ 
Remove
ÍÍ %
(
ÍÍ% &
$num
ÍÍ& '
,
ÍÍ' ($
_verifySecureKeyBuffer
ÍÍ) ?
.
ÍÍ? @
Length
ÍÍ@ F
)
ÍÍF G
;
ÍÍG H&
_hasSecureKeyBeenTouched
ÎÎ  
=
ÎÎ! "
false
ÎÎ# (
;
ÎÎ( ),
_hasVerifySecureKeyBeenTouched
ÏÏ &
=
ÏÏ' (
false
ÏÏ) .
;
ÏÏ. /
SecureKeyError
ÓÓ 
=
ÓÓ 
string
ÓÓ 
.
ÓÓ  
Empty
ÓÓ  %
;
ÓÓ% &
HasSecureKeyError
ÔÔ 
=
ÔÔ 
false
ÔÔ !
;
ÔÔ! ""
VerifySecureKeyError
 
=
 
string
 %
.
% &
Empty
& +
;
+ ,%
HasVerifySecureKeyError
ÒÒ 
=
ÒÒ  !
false
ÒÒ" '
;
ÒÒ' (
ServerError
ÛÛ 
=
ÛÛ 
string
ÛÛ 
.
ÛÛ 
Empty
ÛÛ "
;
ÛÛ" #
HasServerError
ÙÙ 
=
ÙÙ 
false
ÙÙ 
;
ÙÙ !
IsMembershipLoading
ˆˆ 
=
ˆˆ 
true
ˆˆ "
;
ˆˆ" # 
MembershipUniqueId
˜˜ 
=
˜˜ 
null
˜˜ !
;
˜˜! "
}
¯¯ 
private
˙˙ 
string
˙˙ 
Localize
˙˙ 
(
˙˙ 
string
˙˙ "
registrationKey
˙˙# 2
,
˙˙2 3
string
˙˙4 :
recoveryKey
˙˙; F
)
˙˙F G
=>
˙˙H J&
GetSecureKeyLocalization
˚˚  
(
˚˚  !
_flowContext
˚˚! -
,
˚˚- .
registrationKey
˚˚/ >
,
˚˚> ?
recoveryKey
˚˚@ K
)
˚˚K L
;
˚˚L M
private
˝˝ 
async
˝˝ 
Task
˝˝ 
<
˝˝ 
Result
˝˝ 
<
˝˝ 
Unit
˝˝ "
,
˝˝" #'
InternalServiceApiFailure
˝˝$ =
>
˝˝= >
>
˝˝> ?!
LoadMembershipAsync
˝˝@ S
(
˝˝S T
)
˝˝T U
{
˛˛ 
Result
ˇˇ 
<
ˇˇ )
ApplicationInstanceSettings
ˇˇ *
,
ˇˇ* +'
InternalServiceApiFailure
ˇˇ, E
>
ˇˇE F!
applicationInstance
ˇˇG Z
=
ˇˇ[ \
await
ÄÄ /
!_applicationSecureStorageProvider
ÄÄ 3
.
ÄÄ3 41
#GetApplicationInstanceSettingsAsync
ÄÄ4 W
(
ÄÄW X
)
ÄÄX Y
;
ÄÄY Z
if
ÇÇ 

(
ÇÇ !
applicationInstance
ÇÇ 
.
ÇÇ  
IsErr
ÇÇ  %
)
ÇÇ% &
{
ÉÉ 	
return
ÑÑ 
Result
ÑÑ 
<
ÑÑ 
Unit
ÑÑ 
,
ÑÑ '
InternalServiceApiFailure
ÑÑ  9
>
ÑÑ9 :
.
ÑÑ: ;
Err
ÑÑ; >
(
ÑÑ> ?!
applicationInstance
ÑÑ? R
.
ÑÑR S
	UnwrapErr
ÑÑS \
(
ÑÑ\ ]
)
ÑÑ] ^
)
ÑÑ^ _
;
ÑÑ_ `
}
ÖÖ 	)
ApplicationInstanceSettings
áá #
settings
áá$ ,
=
áá- .!
applicationInstance
áá/ B
.
ááB C
Unwrap
ááC I
(
ááI J
)
ááJ K
;
ááK L
if
ââ 

(
ââ 
settings
ââ 
.
ââ 

Membership
ââ 
==
ââ  "
null
ââ# '
)
ââ' (
{
ää 	
return
ãã 
Result
ãã 
<
ãã 
Unit
ãã 
,
ãã '
InternalServiceApiFailure
ãã  9
>
ãã9 :
.
ãã: ;
Err
ãã; >
(
ãã> ?'
InternalServiceApiFailure
åå )
.
åå) *$
SecureStoreKeyNotFound
åå* @
(
åå@ A
$str
çç h
)
ççh i
)
ççi j
;
ççj k
}
éé 	
if
êê 

(
êê 
settings
êê 
.
êê 

Membership
êê 
.
êê  
UniqueIdentifier
êê  0
==
êê1 3
null
êê4 8
||
êê9 ;
settings
êê< D
.
êêD E

Membership
êêE O
.
êêO P
UniqueIdentifier
êêP `
.
êê` a
IsEmpty
êêa h
)
êêh i
{
ëë 	
return
íí 
Result
íí 
<
íí 
Unit
íí 
,
íí '
InternalServiceApiFailure
íí  9
>
íí9 :
.
íí: ;
Err
íí; >
(
íí> ?'
InternalServiceApiFailure
ìì )
.
ìì) *$
SecureStoreKeyNotFound
ìì* @
(
ìì@ A
$str
îî o
)
îîo p
)
îîp q
;
îîq r
}
ïï 	 
MembershipUniqueId
óó 
=
óó 
settings
óó %
.
óó% &

Membership
óó& 0
.
óó0 1
UniqueIdentifier
óó1 A
;
óóA B
return
òò 
Result
òò 
<
òò 
Unit
òò 
,
òò '
InternalServiceApiFailure
òò 5
>
òò5 6
.
òò6 7
Ok
òò7 9
(
òò9 :
Unit
òò: >
.
òò> ?
Value
òò? D
)
òòD E
;
òòE F
}
ôô 
private
õõ 
IObservable
õõ 
<
õõ 
bool
õõ 
>
õõ 
SetupValidation
õõ -
(
õõ- .
)
õõ. /
{
úú 
IObservable
ùù 
<
ùù 
SystemU
ùù 
>
ùù 
languageTrigger
ùù ,
=
ùù- .
LanguageChanged
ùù/ >
;
ùù> ?
IObservable
üü 
<
üü 
SystemU
üü 
>
üü 
lengthTrigger
üü *
=
üü+ ,
this
üü- 1
.
†† 
WhenAnyValue
†† 
(
†† 
x
†† 
=>
†† 
x
††  
.
††  !$
CurrentSecureKeyLength
††! 7
,
††7 8
x
††9 :
=>
††; =
x
††> ?
.
††? @*
CurrentVerifySecureKeyLength
††@ \
)
††\ ]
.
°° 
Select
°° 
(
°° 
_
°° 
=>
°° 
SystemU
°°  
.
°°  !
Default
°°! (
)
°°( )
;
°°) *
IObservable
££ 
<
££ 
SystemU
££ 
>
££ 
validationTrigger
££ .
=
££/ 0
lengthTrigger
££1 >
.
££> ?
Merge
££? D
(
££D E
languageTrigger
££E T
)
££T U
;
££U V
IObservable
•• 
<
•• 
bool
•• 
>
•• '
isSecureKeyLogicallyValid
•• 3
=
••4 5&
SetupSecureKeyValidation
••6 N
(
••N O
validationTrigger
••O `
)
••` a
;
••a b
IObservable
¶¶ 
<
¶¶ 
bool
¶¶ 
>
¶¶ 
secureKeysMatch
¶¶ )
=
¶¶* +&
SetupVerifyKeyValidation
¶¶, D
(
¶¶D E
validationTrigger
¶¶E V
)
¶¶V W
;
¶¶W X
return
®® '
isSecureKeyLogicallyValid
®® (
.
©© 
CombineLatest
©© 
(
©© 
secureKeysMatch
©© *
,
©©* +
(
©©, -
isSecureKeyValid
©©- =
,
©©= >
areMatching
©©? J
)
©©J K
=>
©©L N
isSecureKeyValid
©©O _
&&
©©` b
areMatching
©©c n
)
©©n o
.
™™ "
DistinctUntilChanged
™™ !
(
™™! "
)
™™" #
;
™™# $
}
´´ 
private
≠≠ 
IObservable
≠≠ 
<
≠≠ 
bool
≠≠ 
>
≠≠ &
SetupSecureKeyValidation
≠≠ 6
(
≠≠6 7
IObservable
≠≠7 B
<
≠≠B C
SystemU
≠≠C J
>
≠≠J K
validationTrigger
≠≠L ]
)
≠≠] ^
{
ÆÆ 
IObservable
ØØ 
<
ØØ 
(
ØØ 
string
ØØ 
?
ØØ 
ERROR
ØØ "
,
ØØ" #
string
ØØ$ *
Recommendations
ØØ+ :
,
ØØ: ;
SecureKeyStrength
ØØ< M
Strength
ØØN V
)
ØØV W
>
ØØW X!
secureKeyValidation
ØØY l
=
ØØm n
validationTrigger
∞∞ 
.
±± 
Select
±± 
(
±± 
_
±± 
=>
±± +
ValidateSecureKeyWithStrength
±± :
(
±±: ;
)
±±; <
)
±±< =
.
≤≤ 
Replay
≤≤ 
(
≤≤ 
$num
≤≤ 
)
≤≤ 
.
≥≥ 
RefCount
≥≥ 
(
≥≥ 
)
≥≥ 
;
≥≥ !
secureKeyValidation
µµ 
.
µµ 
Select
µµ "
(
µµ" #
v
µµ# $
=>
µµ% '
v
µµ( )
.
µµ) *
Strength
µµ* 2
)
µµ2 3
.
µµ3 4
ToPropertyEx
µµ4 @
(
µµ@ A
this
µµA E
,
µµE F
x
µµG H
=>
µµI K
x
µµL M
.
µµM N&
CurrentSecureKeyStrength
µµN f
)
µµf g
;
µµg h!
secureKeyValidation
∂∂ 
.
∂∂ 
Select
∂∂ "
(
∂∂" #
v
∂∂# $
=>
∂∂% '&
_hasSecureKeyBeenTouched
∑∑ (
?
∏∏ ,
FormatSecureKeyStrengthMessage
∏∏ 4
(
∏∏4 5
v
∏∏5 6
.
∏∏6 7
Strength
∏∏7 ?
,
∏∏? @
v
∏∏A B
.
∏∏B C
ERROR
∏∏C H
,
∏∏H I
v
∏∏J K
.
∏∏K L
Recommendations
∏∏L [
)
∏∏[ \
:
ππ 
string
ππ 
.
ππ 
Empty
ππ "
)
ππ" #
.
∫∫ 
ToPropertyEx
∫∫ 
(
∫∫ 
this
∫∫ 
,
∫∫ 
x
∫∫  !
=>
∫∫" $
x
∫∫% &
.
∫∫& '&
SecureKeyStrengthMessage
∫∫' ?
)
∫∫? @
;
∫∫@ A
this
ºº 
.
ºº 
WhenAnyValue
ºº 
(
ºº 
x
ºº 
=>
ºº 
x
ºº  
.
ºº  !$
CurrentSecureKeyLength
ºº! 7
)
ºº7 8
.
ΩΩ 
Select
ΩΩ 
(
ΩΩ 
_
ΩΩ 
=>
ΩΩ &
_hasSecureKeyBeenTouched
ΩΩ 1
)
ΩΩ1 2
.
ææ 
ToPropertyEx
ææ 
(
ææ 
this
ææ 
,
ææ 
x
ææ  !
=>
ææ" $
x
ææ% &
.
ææ& '%
HasSecureKeyBeenTouched
ææ' >
)
ææ> ?
;
ææ? @
this
¿¿ 
.
¿¿ 
WhenAnyValue
¿¿ 
(
¿¿ 
x
¿¿ 
=>
¿¿ 
x
¿¿  
.
¿¿  !&
SecureKeyStrengthMessage
¿¿! 9
)
¿¿9 :
.
¡¡ 
	Subscribe
¡¡ 
(
¡¡ 
message
¡¡ 
=>
¡¡ !
SecureKeyError
¡¡" 0
=
¡¡1 2
message
¡¡3 :
)
¡¡: ;
;
¡¡; <
this
¬¬ 
.
¬¬ 
WhenAnyValue
¬¬ 
(
¬¬ 
x
¬¬ 
=>
¬¬ 
x
¬¬  
.
¬¬  !
SecureKeyError
¬¬! /
)
¬¬/ 0
.
√√ 
Select
√√ 
(
√√ 
e
√√ 
=>
√√ 
!
√√ 
string
√√  
.
√√  !
IsNullOrEmpty
√√! .
(
√√. /
e
√√/ 0
)
√√0 1
)
√√1 2
.
ƒƒ 
	Subscribe
ƒƒ 
(
ƒƒ 
flag
ƒƒ 
=>
ƒƒ 
HasSecureKeyError
ƒƒ 0
=
ƒƒ1 2
flag
ƒƒ3 7
)
ƒƒ7 8
;
ƒƒ8 9
return
∆∆ !
secureKeyValidation
∆∆ "
.
∆∆" #
Select
∆∆# )
(
∆∆) *
v
∆∆* +
=>
∆∆, .
string
∆∆/ 5
.
∆∆5 6
IsNullOrEmpty
∆∆6 C
(
∆∆C D
v
∆∆D E
.
∆∆E F
ERROR
∆∆F K
)
∆∆K L
)
∆∆L M
;
∆∆M N
}
«« 
private
…… 
IObservable
…… 
<
…… 
bool
…… 
>
…… &
SetupVerifyKeyValidation
…… 6
(
……6 7
IObservable
……7 B
<
……B C
SystemU
……C J
>
……J K
validationTrigger
……L ]
)
……] ^
{
   
IObservable
ÀÀ 
<
ÀÀ 
bool
ÀÀ 
>
ÀÀ 
secureKeysMatch
ÀÀ )
=
ÀÀ* +
validationTrigger
ÀÀ, =
.
ÃÃ 
Select
ÃÃ 
(
ÃÃ 
_
ÃÃ 
=>
ÃÃ 
DoSecureKeysMatch
ÃÃ *
(
ÃÃ* +
)
ÃÃ+ ,
)
ÃÃ, -
.
ÕÕ 
Replay
ÕÕ 
(
ÕÕ 
$num
ÕÕ 
)
ÕÕ 
.
ŒŒ 
RefCount
ŒŒ 
(
ŒŒ 
)
ŒŒ 
;
ŒŒ 
IObservable
–– 
<
–– 
string
–– 
>
–– (
verifySecureKeyErrorStream
–– 6
=
––7 8
secureKeysMatch
––9 H
.
—— 
Select
—— 
(
—— 
match
—— 
=>
—— 
{
““ 
bool
”” 
shouldShowError
”” $
=
””% &,
_hasVerifySecureKeyBeenTouched
””' E
&&
””F H
!
””I J
match
””J O
;
””O P
return
’’ 
shouldShowError
’’ &
?
÷÷ !
LocalizationService
÷÷ )
[
÷÷) *%
AuthenticationConstants
÷÷* A
.
÷÷A B2
$VERIFY_SECURE_KEY_DOES_NOT_MATCH_KEY
÷÷B f
]
÷÷f g
:
◊◊ 
string
◊◊ 
.
◊◊ 
Empty
◊◊ "
;
◊◊" #
}
ÿÿ 
)
ÿÿ 
.
ŸŸ "
DistinctUntilChanged
ŸŸ !
(
ŸŸ! "
)
ŸŸ" #
.
⁄⁄ 
Throttle
⁄⁄ 
(
⁄⁄ 
TimeSpan
⁄⁄ 
.
⁄⁄ 
FromMilliseconds
⁄⁄ /
(
⁄⁄/ 0$
VALIDATION_THROTTLE_MS
⁄⁄0 F
)
⁄⁄F G
)
⁄⁄G H
.
€€ 
	ObserveOn
€€ 
(
€€ 
RxApp
€€ 
.
€€ !
MainThreadScheduler
€€ 0
)
€€0 1
.
‹‹ 
Replay
‹‹ 
(
‹‹ 
$num
‹‹ 
)
‹‹ 
.
›› 
RefCount
›› 
(
›› 
)
›› 
;
›› (
verifySecureKeyErrorStream
ﬂﬂ "
.
‡‡ "
DistinctUntilChanged
‡‡ !
(
‡‡! "
)
‡‡" #
.
·· 
	Subscribe
·· 
(
·· 
error
·· 
=>
·· "
VerifySecureKeyError
··  4
=
··5 6
error
··7 <
)
··< =
;
··= >
this
„„ 
.
„„ 
WhenAnyValue
„„ 
(
„„ 
x
„„ 
=>
„„ 
x
„„  
.
„„  !"
VerifySecureKeyError
„„! 5
)
„„5 6
.
‰‰ 
Select
‰‰ 
(
‰‰ 
e
‰‰ 
=>
‰‰ 
!
‰‰ 
string
‰‰  
.
‰‰  !
IsNullOrEmpty
‰‰! .
(
‰‰. /
e
‰‰/ 0
)
‰‰0 1
)
‰‰1 2
.
ÂÂ 
	Subscribe
ÂÂ 
(
ÂÂ 
flag
ÂÂ 
=>
ÂÂ %
HasVerifySecureKeyError
ÂÂ 6
=
ÂÂ7 8
flag
ÂÂ9 =
)
ÂÂ= >
;
ÂÂ> ?
return
ÁÁ 
secureKeysMatch
ÁÁ 
;
ÁÁ 
}
ËË 
private
ÍÍ 
(
ÍÍ 
string
ÍÍ 
?
ÍÍ 
ERROR
ÍÍ 
,
ÍÍ 
string
ÍÍ "
Recommendations
ÍÍ# 2
,
ÍÍ2 3
SecureKeyStrength
ÍÍ4 E
Strength
ÍÍF N
)
ÍÍN O+
ValidateSecureKeyWithStrength
ÍÍP m
(
ÍÍm n
)
ÍÍn o
{
ÎÎ 
string
ÏÏ 
?
ÏÏ 
error
ÏÏ 
=
ÏÏ 
null
ÏÏ 
;
ÏÏ 
string
ÌÌ 
recommendations
ÌÌ 
=
ÌÌ  
string
ÌÌ! '
.
ÌÌ' (
Empty
ÌÌ( -
;
ÌÌ- .
SecureKeyStrength
ÓÓ 
strength
ÓÓ "
=
ÓÓ# $
SecureKeyStrength
ÓÓ% 6
.
ÓÓ6 7
Invalid
ÓÓ7 >
;
ÓÓ> ?
_secureKeyBuffer
 
.
 
WithSecureBytes
 (
(
( )
bytes
) .
=>
/ 1
{
ÒÒ 	
string
ÚÚ 
	secureKey
ÚÚ 
=
ÚÚ 
Encoding
ÚÚ '
.
ÚÚ' (
UTF8
ÚÚ( ,
.
ÚÚ, -
	GetString
ÚÚ- 6
(
ÚÚ6 7
bytes
ÚÚ7 <
)
ÚÚ< =
;
ÚÚ= >
(
ÛÛ 
error
ÛÛ 
,
ÛÛ 
List
ÛÛ 
<
ÛÛ 
string
ÛÛ 
>
ÛÛ  
recs
ÛÛ! %
)
ÛÛ% &
=
ÛÛ' ( 
SecureKeyValidator
ÛÛ) ;
.
ÛÛ; <
Validate
ÛÛ< D
(
ÛÛD E
	secureKey
ÛÛE N
,
ÛÛN O!
LocalizationService
ÛÛP c
)
ÛÛc d
;
ÛÛd e
strength
ÙÙ 
=
ÙÙ  
SecureKeyValidator
ÙÙ )
.
ÙÙ) *'
EstimateSecureKeyStrength
ÙÙ* C
(
ÙÙC D
	secureKey
ÙÙD M
,
ÙÙM N!
LocalizationService
ÙÙO b
)
ÙÙb c
;
ÙÙc d
if
ıı 
(
ıı 
recs
ıı 
.
ıı 
Count
ıı 
>
ıı 
$num
ıı 
)
ıı 
{
ˆˆ 
recommendations
˜˜ 
=
˜˜  !
recs
˜˜" &
[
˜˜& '
$num
˜˜' (
]
˜˜( )
;
˜˜) *
}
¯¯ 
}
˘˘ 	
)
˘˘	 

;
˘˘
 
return
˙˙ 
(
˙˙ 
error
˙˙ 
,
˙˙ 
recommendations
˙˙ &
,
˙˙& '
strength
˙˙( 0
)
˙˙0 1
;
˙˙1 2
}
˚˚ 
private
˝˝ 
bool
˝˝ 
DoSecureKeysMatch
˝˝ "
(
˝˝" #
)
˝˝# $
{
˛˛ 
if
ˇˇ 

(
ˇˇ 
_secureKeyBuffer
ˇˇ 
.
ˇˇ 
Length
ˇˇ #
!=
ˇˇ$ &$
_verifySecureKeyBuffer
ˇˇ' =
.
ˇˇ= >
Length
ˇˇ> D
)
ˇˇD E
{
ÄÄ 	
return
ÅÅ 
false
ÅÅ 
;
ÅÅ 
}
ÇÇ 	
if
ÑÑ 

(
ÑÑ 
_secureKeyBuffer
ÑÑ 
.
ÑÑ 
Length
ÑÑ #
==
ÑÑ$ &
$num
ÑÑ' (
)
ÑÑ( )
{
ÖÖ 	
return
ÜÜ 
true
ÜÜ 
;
ÜÜ 
}
áá 	
int
ââ 
length
ââ 
=
ââ 
_secureKeyBuffer
ââ %
.
ââ% &
Length
ââ& ,
;
ââ, -
byte
ää 
[
ää 
]
ää 
secureKeyArray
ää 
=
ää 
	ArrayPool
ää  )
<
ää) *
byte
ää* .
>
ää. /
.
ää/ 0
Shared
ää0 6
.
ää6 7
Rent
ää7 ;
(
ää; <
length
ää< B
)
ääB C
;
ääC D
byte
ãã 
[
ãã 
]
ãã 
verifyArray
ãã 
=
ãã 
	ArrayPool
ãã &
<
ãã& '
byte
ãã' +
>
ãã+ ,
.
ãã, -
Shared
ãã- 3
.
ãã3 4
Rent
ãã4 8
(
ãã8 9
length
ãã9 ?
)
ãã? @
;
ãã@ A
try
çç 
{
éé 	
_secureKeyBuffer
èè 
.
èè 
WithSecureBytes
èè ,
(
èè, -
secureKeyBytes
èè- ;
=>
èè< >
{
èè? @
secureKeyBytes
èèA O
.
èèO P
CopyTo
èèP V
(
èèV W
secureKeyArray
èèW e
.
èèe f
AsSpan
èèf l
(
èèl m
)
èèm n
)
èèn o
;
èèo p
}
èèq r
)
èèr s
;
èès t$
_verifySecureKeyBuffer
êê "
.
êê" #
WithSecureBytes
êê# 2
(
êê2 3
verifyBytes
êê3 >
=>
êê? A
{
êêB C
verifyBytes
êêD O
.
êêO P
CopyTo
êêP V
(
êêV W
verifyArray
êêW b
.
êêb c
AsSpan
êêc i
(
êêi j
)
êêj k
)
êêk l
;
êêl m
}
êên o
)
êêo p
;
êêp q
return
íí %
CryptographicOperations
íí *
.
íí* +
FixedTimeEquals
íí+ :
(
íí: ;
secureKeyArray
ìì 
.
ìì 
AsSpan
ìì %
(
ìì% &
$num
ìì& '
,
ìì' (
length
ìì) /
)
ìì/ 0
,
ìì0 1
verifyArray
îî 
.
îî 
AsSpan
îî "
(
îî" #
$num
îî# $
,
îî$ %
length
îî& ,
)
îî, -
)
îî- .
;
îî. /
}
ïï 	
finally
ññ 
{
óó 	
	ArrayPool
òò 
<
òò 
byte
òò 
>
òò 
.
òò 
Shared
òò "
.
òò" #
Return
òò# )
(
òò) *
secureKeyArray
òò* 8
,
òò8 9

clearArray
òò: D
:
òòD E
true
òòF J
)
òòJ K
;
òòK L
	ArrayPool
ôô 
<
ôô 
byte
ôô 
>
ôô 
.
ôô 
Shared
ôô "
.
ôô" #
Return
ôô# )
(
ôô) *
verifyArray
ôô* 5
,
ôô5 6

clearArray
ôô7 A
:
ôôA B
true
ôôC G
)
ôôG H
;
ôôH I
}
öö 	
}
õõ 
private
ùù 
string
ùù ,
FormatSecureKeyStrengthMessage
ùù 1
(
ùù1 2
SecureKeyStrength
ùù2 C
strength
ùùD L
,
ùùL M
string
ùùN T
?
ùùT U
error
ùùV [
,
ùù[ \
string
ùù] c
recommendations
ùùd s
)
ùùs t
{
ûû 
string
üü 
strengthText
üü 
=
üü 
strength
üü &
switch
üü' -
{
†† 	
SecureKeyStrength
°° 
.
°° 
Invalid
°° %
=>
°°& (!
LocalizationService
°°) <
[
°°< =%
AuthenticationConstants
°°= T
.
°°T U-
SECURE_KEY_STRENGTH_INVALID_KEY
°°U t
]
°°t u
,
°°u v
SecureKeyStrength
¢¢ 
.
¢¢ 
VeryWeak
¢¢ &
=>
¢¢' )!
LocalizationService
¢¢* =
[
¢¢= >%
AuthenticationConstants
¢¢> U
.
¢¢U V/
!SECURE_KEY_STRENGTH_VERY_WEAK_KEY
¢¢V w
]
¢¢w x
,
¢¢x y
SecureKeyStrength
££ 
.
££ 
Weak
££ "
=>
££# %!
LocalizationService
££& 9
[
££9 :%
AuthenticationConstants
££: Q
.
££Q R*
SECURE_KEY_STRENGTH_WEAK_KEY
££R n
]
££n o
,
££o p
SecureKeyStrength
§§ 
.
§§ 
Good
§§ "
=>
§§# %!
LocalizationService
§§& 9
[
§§9 :%
AuthenticationConstants
§§: Q
.
§§Q R*
SECURE_KEY_STRENGTH_GOOD_KEY
§§R n
]
§§n o
,
§§o p
SecureKeyStrength
•• 
.
•• 
Strong
•• $
=>
••% '!
LocalizationService
••( ;
[
••; <%
AuthenticationConstants
••< S
.
••S T,
SECURE_KEY_STRENGTH_STRONG_KEY
••T r
]
••r s
,
••s t
SecureKeyStrength
¶¶ 
.
¶¶ 

VeryStrong
¶¶ (
=>
¶¶) +!
LocalizationService
¶¶, ?
[
¶¶? @%
AuthenticationConstants
¶¶@ W
.
¶¶W X1
#SECURE_KEY_STRENGTH_VERY_STRONG_KEY
¶¶X {
]
¶¶{ |
,
¶¶| }
_
ßß 
=>
ßß !
LocalizationService
ßß $
[
ßß$ %%
AuthenticationConstants
ßß% <
.
ßß< =-
SECURE_KEY_STRENGTH_INVALID_KEY
ßß= \
]
ßß\ ]
}
®® 	
;
®®	 

string
™™ 
message
™™ 
=
™™ 
!
™™ 
string
™™  
.
™™  !
IsNullOrEmpty
™™! .
(
™™. /
error
™™/ 4
)
™™4 5
?
™™6 7
error
™™8 =
:
™™> ?
recommendations
™™@ O
;
™™O P
return
´´ 
string
´´ 
.
´´ 
IsNullOrEmpty
´´ #
(
´´# $
message
´´$ +
)
´´+ ,
?
´´- .
strengthText
´´/ ;
:
´´< =
$"
´´> @
{
´´@ A
strengthText
´´A M
}
´´M N
$str
´´N P
{
´´P Q
message
´´Q X
}
´´X Y
"
´´Y Z
;
´´Z [
}
¨¨ 
private
ÆÆ 
void
ÆÆ 
SetServerError
ÆÆ 
(
ÆÆ  
string
ÆÆ  &
?
ÆÆ& '
error
ÆÆ( -
)
ÆÆ- .
{
ØØ 
ServerError
∞∞ 
=
∞∞ 
error
∞∞ 
;
∞∞ 
HasServerError
±± 
=
±± 
!
±± 
string
±±  
.
±±  !
IsNullOrEmpty
±±! .
(
±±. /
error
±±/ 4
)
±±4 5
;
±±5 6
}
≤≤ 
private
¥¥ 
async
¥¥ 
Task
¥¥ 
<
¥¥ 
SystemU
¥¥ 
>
¥¥ 
SubmitAsync
¥¥  +
(
¥¥+ ,
)
¥¥, -
{
µµ 
if
∂∂ 

(
∂∂ 
IsBusy
∂∂ 
||
∂∂ 
!
∂∂ 
	CanSubmit
∂∂  
)
∂∂  !
{
∑∑ 	
return
∏∏ 
SystemU
∏∏ 
.
∏∏ 
Default
∏∏ "
;
∏∏" #
}
ππ 	
SetServerError
ªª 
(
ªª 
string
ªª 
.
ªª 
Empty
ªª #
)
ªª# $
;
ªª$ %
try
ΩΩ 
{
ææ 	%
CancellationTokenSource
øø #
operationCts
øø$ 0
=
øø1 2'
RecreateCancellationToken
øø3 L
(
øøL M
ref
øøM P"
_currentOperationCts
øøQ e
)
øøe f
;
øøf g
CancellationToken
¿¿ 
operationToken
¿¿ ,
=
¿¿- .
operationCts
¿¿/ ;
.
¿¿; <
Token
¿¿< A
;
¿¿A B
try
¬¬ 
{
√√ 
uint
ƒƒ 
	connectId
ƒƒ 
=
ƒƒ  
ComputeConnectId
ƒƒ! 1
(
ƒƒ1 2 
PubKeyExchangeType
ƒƒ2 D
.
ƒƒD E(
DataCenterEphemeralConnect
ƒƒE _
)
ƒƒ_ `
;
ƒƒ` a
Task
∆∆ 
<
∆∆ 
Result
∆∆ 
<
∆∆ 
Unit
∆∆  
,
∆∆  !
string
∆∆" (
>
∆∆( )
>
∆∆) *
completeTask
∆∆+ 7
=
∆∆8 9
_flowContext
∆∆: F
==
∆∆G I'
AuthenticationFlowContext
∆∆J c
.
∆∆c d
Registration
∆∆d p
?
«« '
CompleteRegistrationAsync
«« /
(
««/ 0
	connectId
««0 9
,
««9 :
operationToken
««; I
)
««I J
:
»» )
CompleteSecureKeyResetAsync
»» 1
(
»»1 2
	connectId
»»2 ;
,
»»; <
operationToken
»»= K
)
»»K L
;
»»L M
Result
   
<
   
Unit
   
,
   
string
   #
>
  # $
result
  % +
=
  , -
await
  . 3
completeTask
  4 @
;
  @ A
if
ÃÃ 
(
ÃÃ 
result
ÃÃ 
.
ÃÃ 
IsErr
ÃÃ  
)
ÃÃ  !
{
ÕÕ 
SetServerError
ŒŒ "
(
ŒŒ" #
result
ŒŒ# )
.
ŒŒ) *
	UnwrapErr
ŒŒ* 3
(
ŒŒ3 4
)
ŒŒ4 5
)
ŒŒ5 6
;
ŒŒ6 7
return
œœ 
SystemU
œœ "
.
œœ" #
Default
œœ# *
;
œœ* +
}
–– 
if
““ 
(
““ 

HostScreen
““ 
is
““ !
not
““" %%
AuthenticationViewModel
““& =
hostViewModel
““> K
)
““K L
{
”” 
return
‘‘ 
SystemU
‘‘ "
.
‘‘" #
Default
‘‘# *
;
‘‘* +
}
’’ 
Option
◊◊ 
<
◊◊ 
string
◊◊ 
>
◊◊  
mobileNumberOption
◊◊ 1
=
◊◊2 3
_flowContext
◊◊4 @
==
◊◊A C'
AuthenticationFlowContext
◊◊D ]
.
◊◊] ^
Registration
◊◊^ j
?
ÿÿ 
Option
ÿÿ 
<
ÿÿ 
string
ÿÿ #
>
ÿÿ# $
.
ÿÿ$ %
Some
ÿÿ% )
(
ÿÿ) *
hostViewModel
ÿÿ* 7
.
ÿÿ7 8&
RegistrationMobileNumber
ÿÿ8 P
!
ÿÿP Q
)
ÿÿQ R
:
ŸŸ 
Option
ŸŸ 
<
ŸŸ 
string
ŸŸ #
>
ŸŸ# $
.
ŸŸ$ %
Some
ŸŸ% )
(
ŸŸ) *
hostViewModel
ŸŸ* 7
.
ŸŸ7 8"
RecoveryMobileNumber
ŸŸ8 L
!
ŸŸL M
)
ŸŸM N
;
ŸŸN O
if
€€ 
(
€€  
mobileNumberOption
€€ &
.
€€& '
IsSome
€€' -
)
€€- .
{
‹‹ 
await
›› 
SignInAsync
›› %
(
››% & 
mobileNumberOption
››& 8
.
››8 9
Value
››9 >
!
››> ?
,
››? @
	connectId
››A J
,
››J K
operationToken
››L Z
)
››Z [
;
››[ \
}
ﬁﬁ 
return
‡‡ 
SystemU
‡‡ 
.
‡‡ 
Default
‡‡ &
;
‡‡& '
}
·· 
finally
‚‚ 
{
„„ 
if
‰‰ 
(
‰‰ "
_currentOperationCts
‰‰ (
!=
‰‰) +
null
‰‰, 0
&&
‰‰1 3
ReferenceEquals
‰‰4 C
(
‰‰C D"
_currentOperationCts
‰‰D X
,
‰‰X Y
operationCts
‰‰Z f
)
‰‰f g
)
‰‰g h
{
ÂÂ "
_currentOperationCts
ÊÊ (
=
ÊÊ) *
null
ÊÊ+ /
;
ÊÊ/ 0
}
ÁÁ 
operationCts
ÈÈ 
.
ÈÈ 
Dispose
ÈÈ $
(
ÈÈ$ %
)
ÈÈ% &
;
ÈÈ& '
}
ÍÍ 
}
ÎÎ 	
catch
ÏÏ 
(
ÏÏ (
OperationCanceledException
ÏÏ )
)
ÏÏ) *
{
ÌÌ 	
return
ÓÓ 
SystemU
ÓÓ 
.
ÓÓ 
Default
ÓÓ "
;
ÓÓ" #
}
ÔÔ 	
}
 
private
ÚÚ 
async
ÚÚ 
Task
ÚÚ 
<
ÚÚ 
Result
ÚÚ 
<
ÚÚ 
Unit
ÚÚ "
,
ÚÚ" #
string
ÚÚ$ *
>
ÚÚ* +
>
ÚÚ+ ,'
CompleteRegistrationAsync
ÚÚ- F
(
ÚÚF G
uint
ÚÚG K
	connectId
ÚÚL U
,
ÚÚU V
CancellationToken
ÛÛ 
cancellationToken
ÛÛ +
)
ÛÛ+ ,
{
ÙÙ 
if
ıı 

(
ıı  
MembershipUniqueId
ıı 
==
ıı !
null
ıı" &
)
ıı& '
{
ˆˆ 	
return
˜˜ 
Result
˜˜ 
<
˜˜ 
Unit
˜˜ 
,
˜˜ 
string
˜˜  &
>
˜˜& '
.
˜˜' (
Err
˜˜( +
(
˜˜+ ,!
LocalizationService
¯¯ #
[
¯¯# $%
AuthenticationConstants
¯¯$ ;
.
¯¯; <0
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY
¯¯< ^
]
¯¯^ _
)
¯¯_ `
;
¯¯` a
}
˘˘ 	
return
˚˚ 
await
˚˚ "
_registrationService
˚˚ )
.
˚˚) *'
CompleteRegistrationAsync
˚˚* C
(
˚˚C D 
MembershipUniqueId
¸¸ 
,
¸¸ 
_secureKeyBuffer
˝˝ 
,
˝˝ 
	connectId
˛˛ 
,
˛˛ 
cancellationToken
ˇˇ 
)
ˇˇ 
;
ˇˇ 
}
ÄÄ 
private
ÇÇ 
async
ÇÇ 
Task
ÇÇ 
<
ÇÇ 
Result
ÇÇ 
<
ÇÇ 
Unit
ÇÇ "
,
ÇÇ" #
string
ÇÇ$ *
>
ÇÇ* +
>
ÇÇ+ ,)
CompleteSecureKeyResetAsync
ÇÇ- H
(
ÇÇH I
uint
ÇÇI M
	connectId
ÇÇN W
,
ÇÇW X
CancellationToken
ÉÉ 
cancellationToken
ÉÉ +
)
ÉÉ+ ,
{
ÑÑ 
if
ÖÖ 

(
ÖÖ  
MembershipUniqueId
ÖÖ 
==
ÖÖ !
null
ÖÖ" &
)
ÖÖ& '
{
ÜÜ 	
return
áá 
Result
áá 
<
áá 
Unit
áá 
,
áá 
string
áá  &
>
áá& '
.
áá' (
Err
áá( +
(
áá+ ,!
LocalizationService
àà #
[
àà# $%
AuthenticationConstants
àà$ ;
.
àà; <0
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY
àà< ^
]
àà^ _
)
àà_ `
;
àà` a
}
ââ 	
return
ãã 
await
ãã '
_secureKeyRecoveryService
ãã .
!
ãã. /
.
ãã/ 0)
CompleteSecureKeyResetAsync
ãã0 K
(
ããK L 
MembershipUniqueId
åå 
,
åå 
_secureKeyBuffer
çç 
,
çç 
	connectId
éé 
,
éé 
cancellationToken
èè 
)
èè 
;
èè 
}
êê 
private
íí 
async
íí 
Task
íí 
SignInAsync
íí "
(
íí" #
string
íí# )
mobileNumber
íí* 6
,
íí6 7
uint
íí8 <
	connectId
íí= F
,
ííF G
CancellationToken
ííH Y
cancellationToken
ííZ k
)
íík l
{
ìì 
Result
îî 
<
îî 
Unit
îî 
,
îî #
AuthenticationFailure
îî *
>
îî* +
signInResult
îî, 8
=
îî9 :
await
îî; @$
_authenticationService
îîA W
.
îîW X
SignInAsync
îîX c
(
îîc d
mobileNumber
ïï 
,
ïï 
_secureKeyBuffer
ññ 
,
ññ 
	connectId
óó 
,
óó 
cancellationToken
òò 
)
òò 
;
òò 
if
öö 

(
öö 
signInResult
öö 
.
öö 
IsOk
öö 
&&
öö  

HostScreen
öö! +
is
öö, .%
AuthenticationViewModel
öö/ F
hostViewModel
ööG T
)
ööT U
{
õõ 	
try
úú 
{
ùù 
await
ûû 
hostViewModel
ûû #
.
ûû# $'
SwitchToMainWindowCommand
ûû$ =
.
ûû= >
Execute
ûû> E
(
ûûE F
)
ûûF G
;
ûûG H
}
üü 
catch
†† 
(
†† 
	Exception
†† 
ex
†† 
)
††  
{
°° 
Log
¢¢ 
.
¢¢ 
Error
¢¢ 
(
¢¢ 
ex
¢¢ 
,
¢¢ 
$str
¢¢ _
)
¢¢_ `
;
¢¢` a
SetServerError
££ 
(
££ 
$"
££ !
{
££! "!
LocalizationService
££" 5
[
££5 6%
AuthenticationConstants
££6 M
.
££M N$
NAVIGATION_FAILURE_KEY
££N d
]
££d e
}
££e f
"
££f g
)
££g h
;
££h i
}
§§ 
}
•• 	
else
¶¶ 
if
¶¶ 
(
¶¶ 
signInResult
¶¶ 
.
¶¶ 
IsErr
¶¶ #
)
¶¶# $
{
ßß 	#
AuthenticationFailure
®® !
failure
®®" )
=
®®* +
signInResult
®®, 8
.
®®8 9
	UnwrapErr
®®9 B
(
®®B C
)
®®C D
;
®®D E
SetServerError
©© 
(
©© 
failure
©© "
.
©©" #
Message
©©# *
)
©©* +
;
©©+ ,
}
™™ 	
}
´´ 
	protected
≠≠ 
override
≠≠ 
void
≠≠ 
Dispose
≠≠ #
(
≠≠# $
bool
≠≠$ (
	disposing
≠≠) 2
)
≠≠2 3
{
ÆÆ 
if
ØØ 

(
ØØ 
_isDisposed
ØØ 
)
ØØ 
{
∞∞ 	
return
±± 
;
±± 
}
≤≤ 	
if
¥¥ 

(
¥¥ 
	disposing
¥¥ 
)
¥¥ 
{
µµ 	$
CancelCurrentOperation
∂∂ "
(
∂∂" #
)
∂∂# $
;
∂∂$ %
_secureKeyBuffer
∑∑ 
.
∑∑ 
Dispose
∑∑ $
(
∑∑$ %
)
∑∑% &
;
∑∑& '$
_verifySecureKeyBuffer
∏∏ "
.
∏∏" #
Dispose
∏∏# *
(
∏∏* +
)
∏∏+ ,
;
∏∏, -
}
ππ 	
_isDisposed
ªª 
=
ªª 
true
ªª 
;
ªª 
base
ºº 
.
ºº 
Dispose
ºº 
(
ºº 
	disposing
ºº 
)
ºº 
;
ºº  
}
ΩΩ 
private
øø 
void
øø $
CancelCurrentOperation
øø '
(
øø' (
)
øø( )
{
¿¿ %
CancellationTokenSource
¡¡ 
?
¡¡  
operationSource
¡¡! 0
=
¡¡1 2
Interlocked
¡¡3 >
.
¡¡> ?
Exchange
¡¡? G
(
¡¡G H
ref
¬¬ "
_currentOperationCts
¬¬ $
,
¬¬$ %
null
√√ 
)
√√ 
;
√√ 
if
≈≈ 

(
≈≈ 
operationSource
≈≈ 
==
≈≈ 
null
≈≈ #
)
≈≈# $
{
∆∆ 	
return
«« 
;
«« 
}
»» 	
try
   
{
ÀÀ 	
operationSource
ÃÃ 
.
ÃÃ 
Cancel
ÃÃ "
(
ÃÃ" #
)
ÃÃ# $
;
ÃÃ$ %
}
ÕÕ 	
catch
ŒŒ 
(
ŒŒ %
ObjectDisposedException
ŒŒ &
)
ŒŒ& '
{
œœ 	
}
—— 	
finally
““ 
{
”” 	
operationSource
‘‘ 
.
‘‘ 
Dispose
‘‘ #
(
‘‘# $
)
‘‘$ %
;
‘‘% &
}
’’ 	
}
÷÷ 
}◊◊ ⁄"
ú/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/Registration/PassPhaseViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0

ViewModels0 :
.: ;
Registration; G
;G H
public 
sealed 
class 
PassPhaseViewModel &
:' (
Core) -
.- .
MVVM. 2
.2 3
ViewModelBase3 @
,@ A
IRoutableViewModelB T
,T U
IDisposableV a
,a b
IResettablec n
{ 
private 
readonly 
CompositeDisposable (
_disposables) 5
=6 7
new8 ;
(; <
)< =
;= >
private 
string 

_passPhase 
= 
string  &
.& '
Empty' ,
;, -
private 
bool 
_isDisposed 
; 
public 

PassPhaseViewModel 
(  
ILocalizationService 
localizationService 0
,0 1
IScreen 

hostScreen 
, 
NetworkProvider +
networkProvider, ;
); <
:= >
base? C
(C D
networkProviderD S
,S T
localizationServiceU h
,h i
nullj n
)n o
{ 

HostScreen 
= 

hostScreen 
;  
SubmitCommand 
= 
ReactiveCommand '
.' (
Create( .
(. /
(/ 0
)0 1
=>2 4
{5 6
}7 8
)8 9
;9 :
_disposables 
. 
Add 
( 
SubmitCommand &
)& '
;' (
} 
public 

string 
? 
UrlPathSegment !
{" #
get$ '
;' (
}) *
=+ ,
$str- :
;: ;
public 

IScreen 

HostScreen 
{ 
get  #
;# $
}% &
public!! 

ReactiveCommand!! 
<!! 
Unit!! 
,!!  
Unit!!! %
>!!% &
SubmitCommand!!' 4
{!!5 6
get!!7 :
;!!: ;
}!!< =
public## 

string## 
	PassPhase## 
{$$ 
get%% 
=>%% 

_passPhase%% 
;%% 
set&& 
=>&& 
this&& 
.&&  
RaiseAndSetIfChanged&& (
(&&( )
ref&&) ,

_passPhase&&- 7
,&&7 8
value&&9 >
)&&> ?
;&&? @
}'' 
public)) 

void)) 

ResetState)) 
()) 
))) 
{** 
if++ 

(++ 
_isDisposed++ 
)++ 
{,, 	
return-- 
;-- 
}.. 	
	PassPhase00 
=00 
string00 
.00 
Empty00  
;00  !
}11 
public33 

new33 
void33 
Dispose33 
(33 
)33 
{44 
Dispose55 
(55 
true55 
)55 
;55 
GC66 

.66
 
SuppressFinalize66 
(66 
this66  
)66  !
;66! "
}77 
	protected99 
override99 
void99 
Dispose99 #
(99# $
bool99$ (
	disposing99) 2
)992 3
{:: 
if;; 

(;; 
_isDisposed;; 
);; 
{<< 	
return== 
;== 
}>> 	
if@@ 

(@@ 
	disposing@@ 
)@@ 
{AA 	
_disposablesBB 
.BB 
DisposeBB  
(BB  !
)BB! "
;BB" #
}CC 	
baseEE 
.EE 
DisposeEE 
(EE 
	disposingEE 
)EE 
;EE  
_isDisposedFF 
=FF 
trueFF 
;FF 
}GG 
}HH ±ø
•/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/Registration/MobileVerificationViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0

ViewModels0 :
.: ;
Registration; G
;G H
public 
sealed 
class '
MobileVerificationViewModel /
:0 1
Core2 6
.6 7
MVVM7 ;
.; <
ViewModelBase< I
,I J
IRoutableViewModelK ]
,] ^
IResettable_ j
,j k
IDisposablel w
{ 
private 
readonly -
!IApplicationSecureStorageProvider 6-
!_applicationSecureStorageProvider7 X
;X Y
private 
readonly &
IOpaqueRegistrationService / 
_registrationService0 D
;D E
private 
readonly %
ISecureKeyRecoveryService .
?. /%
_secureKeyRecoveryService0 I
;I J
private   
readonly   %
AuthenticationFlowContext   .
_flowContext  / ;
;  ; <
private!! 
readonly!!  
IConnectivityService!! ) 
_connectivityService!!* >
;!!> ?
private"" 
readonly"" 
CompositeDisposable"" (
_disposables"") 5
=""6 7
new""8 ;
(""; <
)""< =
;""= >
private$$ #
CancellationTokenSource$$ #
?$$# $ 
_currentOperationCts$$% 9
;$$9 :
private%% 
bool%% '
_hasMobileNumberBeenTouched%% ,
;%%, -
private&& 
bool&& 
_isDisposed&& 
;&& 
public(( 
'
MobileVerificationViewModel(( &
(((& ' 
IConnectivityService)) 
connectivityService)) 0
,))0 1
NetworkProvider** 
networkProvider** '
,**' ( 
ILocalizationService++ 
localizationService++ 0
,++0 1
IScreen,, 

hostScreen,, 
,,, -
!IApplicationSecureStorageProvider-- ),
 applicationSecureStorageProvider--* J
,--J K&
IOpaqueRegistrationService.. "
registrationService..# 6
,..6 7%
ISecureKeyRecoveryService// !$
secureKeyRecoveryService//" :
,//: ;%
AuthenticationFlowContext00 !
flowContext00" -
)00- .
:00/ 0
base001 5
(005 6
networkProvider006 E
,00E F
localizationService00G Z
,00Z [
connectivityService11 
)11 
{22  
_registrationService33 
=33 
registrationService33 2
;332 3%
_secureKeyRecoveryService44 !
=44" #$
secureKeyRecoveryService44$ <
;44< = 
_connectivityService55 
=55 
connectivityService55 2
;552 3
_flowContext66 
=66 
flowContext66 "
;66" #

HostScreen77 
=77 

hostScreen77 
;77  -
!_applicationSecureStorageProvider88 )
=88* +,
 applicationSecureStorageProvider88, L
;88L M
IObservable:: 
<:: 
bool:: 
>::  
isFormLogicallyValid:: .
=::/ 0
SetupValidation::1 @
(::@ A
)::A B
;::B C
SetupCommands;; 
(;;  
isFormLogicallyValid;; *
);;* +
;;;+ ,
}<< 
public>> 

string>> 
?>> 
UrlPathSegment>> !
{>>" #
get>>$ '
;>>' (
}>>) *
=>>+ ,
$str>>- C
;>>C D
public?? 

IScreen?? 

HostScreen?? 
{?? 
get??  #
;??# $
}??% &
privateAA 
stringAA 
LocalizeAA 
(AA 
stringAA "
registrationKeyAA# 2
,AA2 3
stringAA4 :
recoveryKeyAA; F
)AAF G
=>AAH J$
GetSecureKeyLocalizationBB  
(BB  !
_flowContextBB! -
,BB- .
registrationKeyBB/ >
,BB> ?
recoveryKeyBB@ K
)BBK L
;BBL M
publicDD 

stringDD 
TitleDD 
=>DD 
LocalizeDD #
(DD# $
KeysDD$ (
.DD( )
REGISTRATION_TITLEDD) ;
,DD; <
KeysDD= A
.DDA B
RECOVERY_TITLEDDB P
)DDP Q
;DDQ R
publicFF 

stringFF 
DescriptionFF 
=>FF  
LocalizeFF! )
(FF) *
KeysFF* .
.FF. /$
REGISTRATION_DESCRIPTIONFF/ G
,FFG H
KeysFFI M
.FFM N 
RECOVERY_DESCRIPTIONFFN b
)FFb c
;FFc d
publicHH 

stringHH 
HintHH 
=>HH 
LocalizeHH "
(HH" #
KeysHH# '
.HH' (
REGISTRATION_HINTHH( 9
,HH9 :
KeysHH; ?
.HH? @
RECOVERY_HINTHH@ M
)HHM N
;HHN O
publicJJ 

stringJJ 
	WatermarkJJ 
=>JJ 
LocalizeJJ '
(JJ' (
KeysJJ( ,
.JJ, -"
REGISTRATION_WATERMARKJJ- C
,JJC D
KeysJJE I
.JJI J
RECOVERY_WATERMARKJJJ \
)JJ\ ]
;JJ] ^
publicLL 

stringLL 

ButtonTextLL 
=>LL 
LocalizeLL  (
(LL( )
KeysLL) -
.LL- .
REGISTRATION_BUTTONLL. A
,LLA B
KeysLLC G
.LLG H
RECOVERY_BUTTONLLH W
)LLW X
;LLX Y
publicNN 

ReactiveCommandNN 
<NN 
UnitNN 
,NN  
UnitNN! %
>NN% &
?NN& '%
VerifyMobileNumberCommandNN( A
{NNB C
getNND G
;NNG H
privateNNI P
setNNQ T
;NNT U
}NNV W
[PP 
ReactivePP 
]PP 
publicPP 
stringPP 
MobileNumberPP )
{PP* +
getPP, /
;PP/ 0
setPP1 4
;PP4 5
}PP6 7
=PP8 9
stringPP: @
.PP@ A
EmptyPPA F
;PPF G
[QQ 
ReactiveQQ 
]QQ 
publicQQ 
stringQQ 
?QQ 
MobileNumberErrorQQ /
{QQ0 1
getQQ2 5
;QQ5 6
privateQQ7 >
setQQ? B
;QQB C
}QQD E
[RR 
ReactiveRR 
]RR 
publicRR 
boolRR  
HasMobileNumberErrorRR /
{RR0 1
getRR2 5
;RR5 6
privateRR7 >
setRR? B
;RRB C
}RRD E
[TT  
ObservableAsPropertyTT 
]TT 
publicTT !
boolTT" &
IsBusyTT' -
{TT. /
getTT0 3
;TT3 4
}TT5 6
publicVV 

asyncVV 
TaskVV $
HandleEnterKeyPressAsyncVV .
(VV. /
)VV/ 0
{WW 
ifXX 

(XX 
_isDisposedXX 
)XX 
{YY 	
returnZZ 
;ZZ 
}[[ 	
if]] 

(]] %
VerifyMobileNumberCommand]] %
!=]]& (
null]]) -
&&]]. 0
await]]1 6%
VerifyMobileNumberCommand]]7 P
.]]P Q

CanExecute]]Q [
.]][ \
FirstOrDefaultAsync]]\ o
(]]o p
)]]p q
)]]q r
{^^ 	%
VerifyMobileNumberCommand__ %
.__% &
Execute__& -
(__- .
)__. /
.__/ 0
	Subscribe__0 9
(__9 :
)__: ;
.__; <
DisposeWith__< G
(__G H
_disposables__H T
)__T U
;__U V
}`` 	
}aa 
publiccc 

voidcc 

ResetStatecc 
(cc 
)cc 
{dd 
ifee 

(ee 
_isDisposedee 
)ee 
{ff 	
returngg 
;gg 
}hh 	"
CancelCurrentOperationjj 
(jj 
)jj  
;jj  !
MobileNumberkk 
=kk 
stringkk 
.kk 
Emptykk #
;kk# $'
_hasMobileNumberBeenTouchedll #
=ll$ %
falsell& +
;ll+ , 
HasMobileNumberErrormm 
=mm 
falsemm $
;mm$ %
MobileNumberErrornn 
=nn 
stringnn "
.nn" #
Emptynn# (
;nn( )
}oo 
privateqq 
IObservableqq 
<qq 
boolqq 
>qq 
SetupValidationqq -
(qq- .
)qq. /
{rr 
IObservabless 
<ss 
Unitss 
>ss 
languageTriggerss )
=ss* +
LanguageChangedss, ;
;ss; <
languageTriggeruu 
.vv 
	Subscribevv 
(vv 
_vv 
=>vv 
{ww 
thisxx 
.xx  
RaisePropertyChangedxx )
(xx) *
nameofxx* 0
(xx0 1
Titlexx1 6
)xx6 7
)xx7 8
;xx8 9
thisyy 
.yy  
RaisePropertyChangedyy )
(yy) *
nameofyy* 0
(yy0 1
Descriptionyy1 <
)yy< =
)yy= >
;yy> ?
thiszz 
.zz  
RaisePropertyChangedzz )
(zz) *
nameofzz* 0
(zz0 1
Hintzz1 5
)zz5 6
)zz6 7
;zz7 8
this{{ 
.{{  
RaisePropertyChanged{{ )
({{) *
nameof{{* 0
({{0 1
	Watermark{{1 :
){{: ;
){{; <
;{{< =
this|| 
.||  
RaisePropertyChanged|| )
(||) *
nameof||* 0
(||0 1

ButtonText||1 ;
)||; <
)||< =
;||= >
}}} 
)}} 
.~~ 
DisposeWith~~ 
(~~ 
_disposables~~ %
)~~% &
;~~& '
IObservable
ÄÄ 
<
ÄÄ 
Unit
ÄÄ 
>
ÄÄ 
mobileTrigger
ÄÄ '
=
ÄÄ( )
this
ÄÄ* .
.
ÅÅ 
WhenAnyValue
ÅÅ 
(
ÅÅ 
x
ÅÅ 
=>
ÅÅ 
x
ÅÅ  
.
ÅÅ  !
MobileNumber
ÅÅ! -
)
ÅÅ- .
.
ÇÇ 
Select
ÇÇ 
(
ÇÇ 
_
ÇÇ 
=>
ÇÇ 
Unit
ÇÇ 
.
ÇÇ 
Default
ÇÇ %
)
ÇÇ% &
;
ÇÇ& '
IObservable
ÑÑ 
<
ÑÑ 
Unit
ÑÑ 
>
ÑÑ 
validationTrigger
ÑÑ +
=
ÑÑ, -
mobileTrigger
ÖÖ 
.
ÜÜ 
Merge
ÜÜ 
(
ÜÜ 
languageTrigger
ÜÜ &
)
ÜÜ& '
;
ÜÜ' (
IObservable
àà 
<
àà 
string
àà 
>
àà 
mobileValidation
àà ,
=
àà- .
validationTrigger
àà/ @
.
ââ 
Select
ââ 
(
ââ 
_
ââ 
=>
ââ #
MobileNumberValidator
ââ .
.
ââ. /
Validate
ââ/ 7
(
ââ7 8
MobileNumber
ââ8 D
,
ââD E!
LocalizationService
ââF Y
)
ââY Z
)
ââZ [
.
ää 
Replay
ää 
(
ää 
$num
ää 
)
ää 
.
ãã 
RefCount
ãã 
(
ãã 
)
ãã 
;
ãã 
IObservable
çç 
<
çç 
string
çç 
>
çç 
mobileErrorStream
çç -
=
çç. /
this
çç0 4
.
çç4 5
WhenAnyValue
çç5 A
(
ççA B
x
ççB C
=>
ççD F
x
ççG H
.
ççH I
MobileNumber
ççI U
)
ççU V
.
éé 
CombineLatest
éé 
(
éé 
mobileValidation
éé +
,
éé+ ,
(
éé- .
mobile
éé. 4
,
éé4 5
validationError
éé6 E
)
ééE F
=>
ééG I
{
èè 
if
êê 
(
êê 
!
êê )
_hasMobileNumberBeenTouched
êê 0
&&
êê1 3
!
êê4 5
string
êê5 ;
.
êê; < 
IsNullOrWhiteSpace
êê< N
(
êêN O
mobile
êêO U
)
êêU V
)
êêV W
{
ëë )
_hasMobileNumberBeenTouched
íí /
=
íí0 1
true
íí2 6
;
íí6 7
}
ìì 
return
ïï 
!
ïï )
_hasMobileNumberBeenTouched
ïï 3
?
ïï4 5
string
ïï6 <
.
ïï< =
Empty
ïï= B
:
ïïC D
validationError
ïïE T
;
ïïT U
}
ññ 
)
ññ 
.
óó 
Replay
óó 
(
óó 
$num
óó 
)
óó 
.
òò 
RefCount
òò 
(
òò 
)
òò 
;
òò 
mobileErrorStream
öö 
.
õõ 
	Subscribe
õõ 
(
õõ 
error
õõ 
=>
õõ 
{
úú 
MobileNumberError
ùù !
=
ùù" #
error
ùù$ )
;
ùù) *"
HasMobileNumberError
ûû $
=
ûû% &
!
ûû' (
string
ûû( .
.
ûû. /
IsNullOrEmpty
ûû/ <
(
ûû< =
error
ûû= B
)
ûûB C
;
ûûC D
}
üü 
)
üü 
.
†† 
DisposeWith
†† 
(
†† 
_disposables
†† %
)
††% &
;
††& '
return
¢¢ 
mobileValidation
¢¢ 
.
££ 
Select
££ 
(
££ 
string
££ 
.
££ 
IsNullOrEmpty
££ (
)
££( )
.
§§ "
DistinctUntilChanged
§§ !
(
§§! "
)
§§" #
;
§§# $
}
•• 
private
ßß 
void
ßß 
SetupCommands
ßß 
(
ßß 
IObservable
ßß *
<
ßß* +
bool
ßß+ /
>
ßß/ 0"
isFormLogicallyValid
ßß1 E
)
ßßE F
{
®® 
IObservable
©© 
<
©© 
bool
©© 
>
©© 
	canVerify
©© #
=
©©$ %
this
©©& *
.
©©* +
WhenAnyValue
©©+ 7
(
©©7 8
x
©©8 9
=>
©©: <
x
©©= >
.
©©> ?
IsBusy
©©? E
,
©©E F
x
©©G H
=>
©©I K
x
©©L M
.
©©M N
IsInNetworkOutage
©©N _
,
©©_ `
(
™™ 
isBusy
™™ 
,
™™ 

isInOutage
™™ #
)
™™# $
=>
™™% '
!
™™( )
isBusy
™™) /
&&
™™0 2
!
™™3 4

isInOutage
™™4 >
)
™™> ?
.
´´ 
CombineLatest
´´ 
(
´´ "
isFormLogicallyValid
´´ /
,
´´/ 0
(
´´1 2

canExecute
´´2 <
,
´´< =
isValid
´´> E
)
´´E F
=>
´´G I

canExecute
´´J T
&&
´´U W
isValid
´´X _
)
´´_ `
;
´´` a'
VerifyMobileNumberCommand
≠≠ !
=
≠≠" #
ReactiveCommand
≠≠$ 3
.
≠≠3 4
CreateFromTask
≠≠4 B
(
≠≠B C&
ExecuteVerificationAsync
≠≠C [
,
≠≠[ \
	canVerify
≠≠] f
)
≠≠f g
;
≠≠g h'
VerifyMobileNumberCommand
ÆÆ !
.
ÆÆ! "
IsExecuting
ÆÆ" -
.
ØØ 
ToPropertyEx
ØØ 
(
ØØ 
this
ØØ 
,
ØØ 
x
ØØ  !
=>
ØØ" $
x
ØØ% &
.
ØØ& '
IsBusy
ØØ' -
)
ØØ- .
.
∞∞ 
DisposeWith
∞∞ 
(
∞∞ 
_disposables
∞∞ %
)
∞∞% &
;
∞∞& '
_disposables
≤≤ 
.
≤≤ 
Add
≤≤ 
(
≤≤ '
VerifyMobileNumberCommand
≤≤ 2
)
≤≤2 3
;
≤≤3 4
}
≥≥ 
private
µµ 
async
µµ 
Task
µµ 
<
µµ 
Unit
µµ 
>
µµ &
ExecuteVerificationAsync
µµ 5
(
µµ5 6
)
µµ6 7
{
∂∂ 
if
∑∑ 

(
∑∑ 
_isDisposed
∑∑ 
)
∑∑ 
{
∏∏ 	
return
ππ 
Unit
ππ 
.
ππ 
Default
ππ 
;
ππ  
}
∫∫ 	
try
ºº 
{
ΩΩ 	%
CancellationTokenSource
ææ #%
cancellationTokenSource
ææ$ ;
=
ææ< ='
RecreateCancellationToken
ææ> W
(
ææW X
ref
ææX ["
_currentOperationCts
ææ\ p
)
ææp q
;
ææq r
uint
¿¿ 
	connectId
¿¿ 
=
¿¿ 
ComputeConnectId
¿¿ -
(
¿¿- . 
PubKeyExchangeType
¿¿. @
.
¿¿@ A(
DataCenterEphemeralConnect
¿¿A [
)
¿¿[ \
;
¿¿\ ]
CancellationToken
¡¡ 
operationToken
¡¡ ,
=
¡¡- .%
cancellationTokenSource
¡¡/ F
.
¡¡F G
Token
¡¡G L
;
¡¡L M
if
√√ 
(
√√ 
_flowContext
√√ 
==
√√ '
AuthenticationFlowContext
√√  9
.
√√9 :
Registration
√√: F
)
√√F G
{
ƒƒ 
await
≈≈ *
ExecuteRegistrationFlowAsync
≈≈ 2
(
≈≈2 3
	connectId
≈≈3 <
,
≈≈< =
operationToken
≈≈> L
)
≈≈L M
;
≈≈M N
}
∆∆ 
else
«« 
{
»» 
await
…… &
ExecuteRecoveryFlowAsync
…… .
(
……. /
	connectId
……/ 8
,
……8 9
operationToken
……: H
)
……H I
;
……I J
}
   
}
ÀÀ 	
catch
ÃÃ 
(
ÃÃ (
OperationCanceledException
ÃÃ )
)
ÃÃ) *
{
ÕÕ 	
}
œœ 	
catch
–– 
(
–– 
	Exception
–– 
)
–– 
{
—— 	
if
““ 
(
““ 
!
““ 
_isDisposed
““ 
)
““ 
{
”” 
string
‘‘ 
errorMessage
‘‘ #
=
‘‘$ %!
LocalizationService
‘‘& 9
[
‘‘9 :%
AuthenticationConstants
‘‘: Q
.
‘‘Q R)
COMMON_UNEXPECTED_ERROR_KEY
‘‘R m
]
‘‘m n
;
‘‘n o
	ShowError
’’ 
(
’’ 
errorMessage
’’ &
)
’’& '
;
’’' (
}
÷÷ 
}
◊◊ 	
return
ŸŸ 
Unit
ŸŸ 
.
ŸŸ 
Default
ŸŸ 
;
ŸŸ 
}
⁄⁄ 
private
‹‹ 
async
‹‹ 
Task
‹‹ *
ExecuteRegistrationFlowAsync
‹‹ 3
(
‹‹3 4
uint
‹‹4 8
	connectId
‹‹9 B
,
‹‹B C
CancellationToken
‹‹D U
operationToken
‹‹V d
)
‹‹d e
{
›› 
Task
ﬁﬁ 
<
ﬁﬁ 
Result
ﬁﬁ 
<
ﬁﬁ *
ValidateMobileNumberResponse
ﬁﬁ 0
,
ﬁﬁ0 1
string
ﬁﬁ2 8
>
ﬁﬁ8 9
>
ﬁﬁ9 :
validationTask
ﬁﬁ; I
=
ﬁﬁJ K"
_registrationService
ﬂﬂ  
.
ﬂﬂ  !'
ValidateMobileNumberAsync
ﬂﬂ! :
(
ﬂﬂ: ;
MobileNumber
ﬂﬂ; G
,
ﬂﬂG H
	connectId
ﬂﬂI R
,
ﬂﬂR S
operationToken
ﬂﬂT b
)
ﬂﬂb c
;
ﬂﬂc d
Result
·· 
<
·· *
ValidateMobileNumberResponse
·· +
,
··+ ,
string
··- 3
>
··3 4
result
··5 ;
=
··< =
await
··> C
validationTask
··D R
;
··R S
if
„„ 

(
„„ 
_isDisposed
„„ 
)
„„ 
{
‰‰ 	
return
ÂÂ 
;
ÂÂ 
}
ÊÊ 	
if
ËË 

(
ËË 
result
ËË 
.
ËË 
IsErr
ËË 
)
ËË 
{
ÈÈ 	
	ShowError
ÍÍ 
(
ÍÍ 
result
ÍÍ 
.
ÍÍ 
	UnwrapErr
ÍÍ &
(
ÍÍ& '
)
ÍÍ' (
)
ÍÍ( )
;
ÍÍ) *
return
ÎÎ 
;
ÎÎ 
}
ÏÏ 	*
ValidateMobileNumberResponse
ÓÓ $*
validateMobileNumberResponse
ÓÓ% A
=
ÓÓB C
result
ÓÓD J
.
ÓÓJ K
Unwrap
ÓÓK Q
(
ÓÓQ R
)
ÓÓR S
;
ÓÓS T
if
 

(
 *
validateMobileNumberResponse
 (
.
( )
Result
) /
==
0 2 
VerificationResult
3 E
.
E F
InvalidMobile
F S
)
S T
{
ÒÒ 	
	ShowError
ÚÚ 
(
ÚÚ *
validateMobileNumberResponse
ÚÚ 2
.
ÚÚ2 3
Message
ÚÚ3 :
)
ÚÚ: ;
;
ÚÚ; <
return
ÛÛ 
;
ÛÛ 
}
ÙÙ 	
await
ˆˆ 0
"HandleMobileAvailabilityCheckAsync
ˆˆ 0
(
ˆˆ0 1*
validateMobileNumberResponse
ˆˆ1 M
.
ˆˆM N$
MobileNumberIdentifier
ˆˆN d
,
ˆˆd e
	connectId
ˆˆf o
,
ˆˆo p
operationToken
˜˜ 
)
˜˜ 
;
˜˜ 
}
¯¯ 
private
˙˙ 
async
˙˙ 
Task
˙˙ 0
"HandleMobileAvailabilityCheckAsync
˙˙ 9
(
˙˙9 :

ByteString
˙˙: D$
mobileNumberIdentifier
˙˙E [
,
˙˙[ \
uint
˙˙] a
	connectId
˙˙b k
,
˙˙k l
CancellationToken
˚˚ 
operationToken
˚˚ (
)
˚˚( )
{
¸¸ 
Result
˝˝ 
<
˝˝ 3
%CheckMobileNumberAvailabilityResponse
˝˝ 4
,
˝˝4 5
string
˝˝6 <
>
˝˝< =
statusResult
˝˝> J
=
˝˝K L
await
˛˛ "
_registrationService
˛˛ &
.
˛˛& '0
"CheckMobileNumberAvailabilityAsync
˛˛' I
(
˛˛I J$
mobileNumberIdentifier
˛˛J `
,
˛˛` a
	connectId
˛˛b k
,
˛˛k l
operationToken
ˇˇ 
)
ˇˇ 
;
ˇˇ  
if
ÅÅ 

(
ÅÅ 
_isDisposed
ÅÅ 
)
ÅÅ 
{
ÇÇ 	
return
ÉÉ 
;
ÉÉ 
}
ÑÑ 	
if
ÜÜ 

(
ÜÜ 
statusResult
ÜÜ 
.
ÜÜ 
IsErr
ÜÜ 
)
ÜÜ 
{
áá 	
	ShowError
àà 
(
àà 
statusResult
àà "
.
àà" #
	UnwrapErr
àà# ,
(
àà, -
)
àà- .
)
àà. /
;
àà/ 0
return
ââ 
;
ââ 
}
ää 	3
%CheckMobileNumberAvailabilityResponse
åå -
statusResponse
åå. <
=
åå= >
statusResult
åå? K
.
ååK L
Unwrap
ååL R
(
ååR S
)
ååS T
;
ååT U
await
çç +
HandleAvailabilityStatusAsync
çç +
(
çç+ ,
statusResponse
çç, :
,
çç: ;$
mobileNumberIdentifier
çç< R
)
ççR S
;
ççS T
}
éé 
private
êê 
async
êê 
Task
êê +
HandleAvailabilityStatusAsync
êê 4
(
êê4 53
%CheckMobileNumberAvailabilityResponse
êê5 Z
statusResponse
êê[ i
,
êêi j

ByteString
ëë $
mobileNumberIdentifier
ëë )
)
ëë) *
{
íí 
switch
ìì 
(
ìì 
statusResponse
ìì 
.
ìì 
Status
ìì %
)
ìì% &
{
îî 	
case
ïï &
MobileAvailabilityStatus
ïï )
.
ïï) *
	Available
ïï* 3
:
ïï3 4
await
ññ ,
NavigateToOtpVerificationAsync
ññ 4
(
ññ4 5$
mobileNumberIdentifier
ññ5 K
)
ññK L
;
ññL M
break
óó 
;
óó 
case
ôô &
MobileAvailabilityStatus
ôô )
.
ôô) *!
RegistrationExpired
ôô* =
:
ôô= >
await
öö ,
NavigateToOtpVerificationAsync
öö 4
(
öö4 5$
mobileNumberIdentifier
öö5 K
)
ööK L
;
ööL M
break
õõ 
;
õõ 
case
ùù &
MobileAvailabilityStatus
ùù )
.
ùù) *$
IncompleteRegistration
ùù* @
:
ùù@ A
await
ûû /
!HandleIncompleteRegistrationAsync
ûû 7
(
ûû7 8
statusResponse
ûû8 F
,
ûûF G$
mobileNumberIdentifier
ûûH ^
)
ûû^ _
;
ûû_ `
break
üü 
;
üü 
case
°° &
MobileAvailabilityStatus
°° )
.
°°) *
DataCorruption
°°* 8
:
°°8 9(
HandleDataCorruptionStatus
¢¢ *
(
¢¢* +
statusResponse
¢¢+ 9
)
¢¢9 :
;
¢¢: ;
break
££ 
;
££ 
case
•• &
MobileAvailabilityStatus
•• )
.
••) *
TakenActive
••* 5
:
••5 6
case
¶¶ &
MobileAvailabilityStatus
¶¶ )
.
¶¶) *
TakenInactive
¶¶* 7
:
¶¶7 8%
HandleMobileTakenStatus
ßß '
(
ßß' (
statusResponse
ßß( 6
)
ßß6 7
;
ßß7 8
break
®® 
;
®® 
default
™™ 
:
™™ $
HandleUnexpectedStatus
´´ &
(
´´& '
statusResponse
´´' 5
)
´´5 6
;
´´6 7
break
¨¨ 
;
¨¨ 
}
≠≠ 	
}
ÆÆ 
private
∞∞ 
async
∞∞ 
Task
∞∞ /
!HandleIncompleteRegistrationAsync
∞∞ 8
(
∞∞8 93
%CheckMobileNumberAvailabilityResponse
∞∞9 ^
statusResponse
∞∞_ m
,
∞∞m n

ByteString
±± $
mobileNumberIdentifier
±± )
)
±±) *
{
≤≤ 
if
≥≥ 

(
≥≥ 
statusResponse
≥≥ 
is
≥≥ 
{
¥¥ 
HasCreationStatus
µµ !
:
µµ! "
true
µµ# '
,
µµ' (
CreationStatus
µµ) 7
:
µµ7 8
Protobuf
µµ9 A
.
µµA B

Membership
µµB L
.
µµL M

Membership
µµM W
.
µµW X
Types
µµX ]
.
µµ] ^
CreationStatus
µµ^ l
.
µµl m
OtpVerified
µµm x
}
∂∂ 
)
∂∂ 
{
∑∑ 	
await
∏∏ 7
)StoreIncompleteMembershipAndNavigateAsync
∏∏ ;
(
∏∏; <
statusResponse
∏∏< J
)
∏∏J K
;
∏∏K L
}
ππ 	
else
∫∫ 
{
ªª 	
await
ºº ,
NavigateToOtpVerificationAsync
ºº 0
(
ºº0 1$
mobileNumberIdentifier
ºº1 G
)
ººG H
;
ººH I
}
ΩΩ 	
}
ææ 
private
¿¿ 
async
¿¿ 
Task
¿¿ 7
)StoreIncompleteMembershipAndNavigateAsync
¿¿ @
(
¿¿@ A3
%CheckMobileNumberAvailabilityResponse
¿¿A f
statusResponse
¿¿g u
)
¿¿u v
{
¡¡ 

Membership
¬¬ 

membership
¬¬ 
=
¬¬ 
new
¬¬  #
(
¬¬# $
)
¬¬$ %
{
√√ 	
UniqueIdentifier
ƒƒ 
=
ƒƒ 
statusResponse
ƒƒ -
.
ƒƒ- ."
ExistingMembershipId
ƒƒ. B
,
ƒƒB C
Status
≈≈ 
=
≈≈ 
statusResponse
≈≈ #
.
≈≈# $
HasActivityStatus
≈≈$ 5
?
∆∆ 
statusResponse
∆∆  
.
∆∆  !
ActivityStatus
∆∆! /
:
«« 
Protobuf
«« 
.
«« 

Membership
«« %
.
««% &

Membership
««& 0
.
««0 1
Types
««1 6
.
««6 7
ActivityStatus
««7 E
.
««E F
Active
««F L
,
««L M
CreationStatus
»» 
=
»» 
statusResponse
»» +
.
»»+ ,
CreationStatus
»», :
}
…… 	
;
……	 

if
ÀÀ 

(
ÀÀ 
statusResponse
ÀÀ 
.
ÀÀ %
AccountUniqueIdentifier
ÀÀ 2
!=
ÀÀ3 5
null
ÀÀ6 :
&&
ÀÀ; =
!
ÀÀ> ?
statusResponse
ÀÀ? M
.
ÀÀM N%
AccountUniqueIdentifier
ÀÀN e
.
ÀÀe f
IsEmpty
ÀÀf m
)
ÀÀm n
{
ÃÃ 	

membership
ÕÕ 
.
ÕÕ %
AccountUniqueIdentifier
ÕÕ .
=
ÕÕ/ 0
statusResponse
ÕÕ1 ?
.
ÕÕ? @%
AccountUniqueIdentifier
ÕÕ@ W
;
ÕÕW X
}
ŒŒ 	
await
–– /
!_applicationSecureStorageProvider
–– /
.
––/ 0+
SetApplicationMembershipAsync
––0 M
(
––M N

membership
––N X
)
––X Y
;
––Y Z
if
““ 

(
““ 
statusResponse
““ 
.
““ %
AccountUniqueIdentifier
““ 2
!=
““3 5
null
““6 :
&&
““; =
!
““> ?
statusResponse
““? M
.
““M N%
AccountUniqueIdentifier
““N e
.
““e f
IsEmpty
““f m
)
““m n
{
”” 	
await
‘‘ /
!_applicationSecureStorageProvider
‘‘ 3
.
‘‘3 4&
SetCurrentAccountIdAsync
‘‘4 L
(
‘‘L M
statusResponse
‘‘M [
.
‘‘[ \%
AccountUniqueIdentifier
‘‘\ s
)
‘‘s t
.
’’ 
ConfigureAwait
’’ 
(
’’  
false
’’  %
)
’’% &
;
’’& '
}
÷÷ 	
await
ÿÿ &
NavigateToSecureKeyAsync
ÿÿ &
(
ÿÿ& '
)
ÿÿ' (
;
ÿÿ( )
}
ŸŸ 
private
€€ 
void
€€ (
HandleDataCorruptionStatus
€€ +
(
€€+ ,3
%CheckMobileNumberAvailabilityResponse
€€, Q
statusResponse
€€R `
)
€€` a
{
‹‹ 
string
›› 
corruptionError
›› 
=
››  
!
››! "
string
››" (
.
››( )
IsNullOrEmpty
››) 6
(
››6 7
statusResponse
››7 E
.
››E F
LocalizationKey
››F U
)
››U V
?
ﬁﬁ !
LocalizationService
ﬁﬁ !
[
ﬁﬁ! "
statusResponse
ﬁﬁ" 0
.
ﬁﬁ0 1
LocalizationKey
ﬁﬁ1 @
]
ﬁﬁ@ A
:
ﬂﬂ !
LocalizationService
ﬂﬂ !
[
ﬂﬂ! "
$str
ﬂﬂ" K
]
ﬂﬂK L
;
ﬂﬂL M
	ShowError
‡‡ 
(
‡‡ 
corruptionError
‡‡ !
)
‡‡! "
;
‡‡" #
}
·· 
private
„„ 
void
„„ %
HandleMobileTakenStatus
„„ (
(
„„( )3
%CheckMobileNumberAvailabilityResponse
„„) N
statusResponse
„„O ]
)
„„] ^
{
‰‰ 
string
ÂÂ 

takenError
ÂÂ 
=
ÂÂ 
!
ÂÂ 
string
ÂÂ #
.
ÂÂ# $
IsNullOrEmpty
ÂÂ$ 1
(
ÂÂ1 2
statusResponse
ÂÂ2 @
.
ÂÂ@ A
LocalizationKey
ÂÂA P
)
ÂÂP Q
?
ÊÊ !
LocalizationService
ÊÊ !
[
ÊÊ! "
statusResponse
ÊÊ" 0
.
ÊÊ0 1
LocalizationKey
ÊÊ1 @
]
ÊÊ@ A
:
ÁÁ !
LocalizationService
ÁÁ !
[
ÁÁ! "
$str
ÁÁ" T
]
ÁÁT U
;
ÁÁU V
	ShowError
ËË 
(
ËË 

takenError
ËË 
)
ËË 
;
ËË 
}
ÈÈ 
private
ÎÎ 
void
ÎÎ $
HandleUnexpectedStatus
ÎÎ '
(
ÎÎ' (3
%CheckMobileNumberAvailabilityResponse
ÎÎ( M
statusResponse
ÎÎN \
)
ÎÎ\ ]
{
ÏÏ 
string
ÌÌ 
defaultError
ÌÌ 
=
ÌÌ 
!
ÌÌ 
string
ÌÌ %
.
ÌÌ% &
IsNullOrEmpty
ÌÌ& 3
(
ÌÌ3 4
statusResponse
ÌÌ4 B
.
ÌÌB C
LocalizationKey
ÌÌC R
)
ÌÌR S
?
ÓÓ !
LocalizationService
ÓÓ !
[
ÓÓ! "
statusResponse
ÓÓ" 0
.
ÓÓ0 1
LocalizationKey
ÓÓ1 @
]
ÓÓ@ A
:
ÔÔ !
LocalizationService
ÔÔ !
[
ÔÔ! "
$str
ÔÔ" T
]
ÔÔT U
;
ÔÔU V
	ShowError
 
(
 
defaultError
 
)
 
;
  
}
ÒÒ 
private
ÛÛ 
async
ÛÛ 
Task
ÛÛ &
ExecuteRecoveryFlowAsync
ÛÛ /
(
ÛÛ/ 0
uint
ÛÛ0 4
	connectId
ÛÛ5 >
,
ÛÛ> ?
CancellationToken
ÛÛ@ Q
operationToken
ÛÛR `
)
ÛÛ` a
{
ÙÙ 
Task
ıı 
<
ıı 
Result
ıı 
<
ıı 

ByteString
ıı 
,
ıı 
string
ıı  &
>
ıı& '
>
ıı' ($
recoveryValidationTask
ıı) ?
=
ıı@ A'
_secureKeyRecoveryService
ˆˆ %
!
ˆˆ% &
.
ˆˆ& ',
ValidateMobileForRecoveryAsync
ˆˆ' E
(
ˆˆE F
MobileNumber
ˆˆF R
,
ˆˆR S
	connectId
ˆˆT ]
,
ˆˆ] ^
operationToken
ˆˆ_ m
)
ˆˆm n
;
ˆˆn o
Result
¯¯ 
<
¯¯ 

ByteString
¯¯ 
,
¯¯ 
string
¯¯ !
>
¯¯! "
result
¯¯# )
=
¯¯* +
await
¯¯, 1$
recoveryValidationTask
¯¯2 H
;
¯¯H I
if
˙˙ 

(
˙˙ 
_isDisposed
˙˙ 
)
˙˙ 
{
˚˚ 	
return
¸¸ 
;
¸¸ 
}
˝˝ 	
if
ˇˇ 

(
ˇˇ 
result
ˇˇ 
.
ˇˇ 
IsErr
ˇˇ 
)
ˇˇ 
{
ÄÄ 	
	ShowError
ÅÅ 
(
ÅÅ 
result
ÅÅ 
.
ÅÅ 
	UnwrapErr
ÅÅ &
(
ÅÅ& '
)
ÅÅ' (
)
ÅÅ( )
;
ÅÅ) *
return
ÇÇ 
;
ÇÇ 
}
ÉÉ 	

ByteString
ÖÖ $
mobileNumberIdentifier
ÖÖ )
=
ÖÖ* +
result
ÖÖ, 2
.
ÖÖ2 3
Unwrap
ÖÖ3 9
(
ÖÖ9 :
)
ÖÖ: ;
;
ÖÖ; < 
VerifyOtpViewModel
áá 
vm
áá 
=
áá 
new
áá  #
(
áá# $"
_connectivityService
áá$ 8
,
áá8 9
NetworkProvider
áá: I
,
ááI J!
LocalizationService
ááK ^
,
áá^ _

HostScreen
áá` j
,
ááj k$
mobileNumberIdentifier
àà "
,
àà" #/
!_applicationSecureStorageProvider
àà$ E
,
ààE F"
_registrationService
ààG [
,
àà[ \
_flowContext
ââ 
,
ââ '
_secureKeyRecoveryService
ââ 3
)
ââ3 4
;
ââ4 5
if
ãã 

(
ãã 

HostScreen
ãã 
is
ãã %
AuthenticationViewModel
ãã 1

hostWindow
ãã2 <
)
ãã< =
{
åå 	

hostWindow
çç 
.
çç "
RecoveryMobileNumber
çç +
=
çç, -
MobileNumber
çç. :
;
çç: ;

hostWindow
éé 
.
éé !
NavigateToViewModel
éé *
(
éé* +
vm
éé+ -
)
éé- .
;
éé. /
}
èè 	
}
êê 
private
íí 
void
íí 
	ShowError
íí 
(
íí 
string
íí !
errorMessage
íí" .
)
íí. /
{
ìì 
if
îî 

(
îî 

HostScreen
îî 
is
îî %
AuthenticationViewModel
îî 1

hostWindow
îî2 <
&&
îî= ?
!
ïï 
string
ïï 
.
ïï 
IsNullOrEmpty
ïï !
(
ïï! "
errorMessage
ïï" .
)
ïï. /
)
ïï/ 0
{
ññ 	)
ShowServerErrorNotification
óó '
(
óó' (

hostWindow
óó( 2
,
óó2 3
errorMessage
óó4 @
)
óó@ A
;
óóA B
}
òò 	
}
ôô 
private
õõ 
Task
õõ ,
NavigateToOtpVerificationAsync
õõ /
(
õõ/ 0

ByteString
õõ0 :$
mobileNumberIdentifier
õõ; Q
)
õõQ R
{
úú 
if
ùù 

(
ùù 
_isDisposed
ùù 
)
ùù 
{
ûû 	
return
üü 
Task
üü 
.
üü 
CompletedTask
üü %
;
üü% &
}
†† 	 
VerifyOtpViewModel
¢¢ 
vm
¢¢ 
=
¢¢ 
new
¢¢  #
(
¢¢# $"
_connectivityService
¢¢$ 8
,
¢¢8 9
NetworkProvider
¢¢: I
,
¢¢I J!
LocalizationService
¢¢K ^
,
¢¢^ _

HostScreen
¢¢` j
,
¢¢j k$
mobileNumberIdentifier
££ "
,
££" #/
!_applicationSecureStorageProvider
££$ E
,
££E F"
_registrationService
££G [
)
££[ \
;
££\ ]
if
•• 

(
•• 

HostScreen
•• 
is
•• %
AuthenticationViewModel
•• 1

hostWindow
••2 <
)
••< =
{
¶¶ 	

hostWindow
ßß 
.
ßß &
RegistrationMobileNumber
ßß /
=
ßß0 1
MobileNumber
ßß2 >
;
ßß> ?

hostWindow
®® 
.
®® !
NavigateToViewModel
®® *
(
®®* +
vm
®®+ -
)
®®- .
;
®®. /
}
©© 	
return
´´ 
Task
´´ 
.
´´ 
CompletedTask
´´ !
;
´´! "
}
¨¨ 
private
ÆÆ 
Task
ÆÆ &
NavigateToSecureKeyAsync
ÆÆ )
(
ÆÆ) *
)
ÆÆ* +
{
ØØ 
if
∞∞ 

(
∞∞ 
_isDisposed
∞∞ 
)
∞∞ 
{
±± 	
return
≤≤ 
Task
≤≤ 
.
≤≤ 
CompletedTask
≤≤ %
;
≤≤% &
}
≥≥ 	
if
µµ 

(
µµ 

HostScreen
µµ 
is
µµ %
AuthenticationViewModel
µµ 1

hostWindow
µµ2 <
)
µµ< =
{
∂∂ 	

hostWindow
∑∑ 
.
∑∑ &
RegistrationMobileNumber
∑∑ /
=
∑∑0 1
MobileNumber
∑∑2 >
;
∑∑> ?

hostWindow
∏∏ 
.
∏∏ 
Navigate
∏∏ 
.
∏∏  
Execute
∏∏  '
(
∏∏' ( 
MembershipViewType
∏∏( :
.
∏∏: ;'
SecureKeyConfirmationView
∏∏; T
)
∏∏T U
.
∏∏U V
	Subscribe
∏∏V _
(
∏∏_ `
)
∏∏` a
;
∏∏a b
}
ππ 	
return
ªª 
Task
ªª 
.
ªª 
CompletedTask
ªª !
;
ªª! "
}
ºº 
public
ææ 

new
ææ 
void
ææ 
Dispose
ææ 
(
ææ 
)
ææ 
{
øø 
Dispose
¿¿ 
(
¿¿ 
true
¿¿ 
)
¿¿ 
;
¿¿ 
}
¡¡ 
	protected
√√ 
override
√√ 
void
√√ 
Dispose
√√ #
(
√√# $
bool
√√$ (
	disposing
√√) 2
)
√√2 3
{
ƒƒ 
if
≈≈ 

(
≈≈ 
_isDisposed
≈≈ 
)
≈≈ 
{
∆∆ 	
return
«« 
;
«« 
}
»» 	
if
   

(
   
	disposing
   
)
   
{
ÀÀ 	$
CancelCurrentOperation
ÃÃ "
(
ÃÃ" #
)
ÃÃ# $
;
ÃÃ$ %
_disposables
ÕÕ 
.
ÕÕ 
Dispose
ÕÕ  
(
ÕÕ  !
)
ÕÕ! "
;
ÕÕ" #
}
ŒŒ 	
base
–– 
.
–– 
Dispose
–– 
(
–– 
	disposing
–– 
)
–– 
;
––  
_isDisposed
—— 
=
—— 
true
—— 
;
—— 
}
““ 
private
‘‘ 
void
‘‘ $
CancelCurrentOperation
‘‘ '
(
‘‘' (
)
‘‘( )
{
’’ %
CancellationTokenSource
÷÷ 
?
÷÷  
operationSource
÷÷! 0
=
÷÷1 2
Interlocked
÷÷3 >
.
÷÷> ?
Exchange
÷÷? G
(
÷÷G H
ref
◊◊ "
_currentOperationCts
◊◊ $
,
◊◊$ %
null
ÿÿ 
)
ÿÿ 
;
ÿÿ 
if
⁄⁄ 

(
⁄⁄ 
operationSource
⁄⁄ 
!=
⁄⁄ 
null
⁄⁄ #
)
⁄⁄# $
{
€€ 	
try
‹‹ 
{
›› 
operationSource
ﬁﬁ 
.
ﬁﬁ  
Cancel
ﬁﬁ  &
(
ﬁﬁ& '
)
ﬁﬁ' (
;
ﬁﬁ( )
}
ﬂﬂ 
catch
‡‡ 
(
‡‡ %
ObjectDisposedException
‡‡ *
)
‡‡* +
{
·· 
}
„„ 
finally
‰‰ 
{
ÂÂ 
operationSource
ÊÊ 
.
ÊÊ  
Dispose
ÊÊ  '
(
ÊÊ' (
)
ÊÊ( )
;
ÊÊ) *
}
ÁÁ 
}
ËË 	
}
ÈÈ 
}ÍÍ ∞Ã
ö/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/Hosts/AuthenticationViewModel.cs
	namespace%% 	
Ecliptix%%
 
.%% 
Core%% 
.%% 
Features%%  
.%%  !
Authentication%%! /
.%%/ 0

ViewModels%%0 :
.%%: ;
Hosts%%; @
;%%@ A
public'' 
readonly'' 
struct'' /
#AuthenticationViewModelDependencies'' :
{(( 
public)) 

required))  
IConnectivityService)) (
ConnectivityService))) <
{))= >
get))? B
;))B C
init))D H
;))H I
}))J K
public** 

required** 
NetworkProvider** #
NetworkProvider**$ 3
{**4 5
get**6 9
;**9 :
init**; ?
;**? @
}**A B
public++ 

required++  
ILocalizationService++ (
LocalizationService++) <
{++= >
get++? B
;++B C
init++D H
;++H I
}++J K
public,, 

required,, -
!IApplicationSecureStorageProvider,, 5
StorageProvider,,6 E
{,,F G
get,,H K
;,,K L
init,,M Q
;,,Q R
},,S T
public-- 

required-- "
IAuthenticationService-- *!
AuthenticationService--+ @
{--A B
get--C F
;--F G
init--H L
;--L M
}--N O
public.. 

required.. &
IOpaqueRegistrationService.. .
RegistrationService../ B
{..C D
get..E H
;..H I
init..J N
;..N O
}..P Q
public// 

required// %
ISecureKeyRecoveryService// -
RecoveryService//. =
{//> ?
get//@ C
;//C D
init//E I
;//I J
}//K L
public00 

required00 %
ILanguageDetectionService00 -$
LanguageDetectionService00. F
{00G H
get00I L
;00L M
init00N R
;00R S
}00T U
public11 

required11 
IApplicationRouter11 &
Router11' -
{11. /
get110 3
;113 4
init115 9
;119 :
}11; <
public22 

required22 
MainWindowViewModel22 '
MainWindowViewModel22( ;
{22< =
get22> A
;22A B
init22C G
;22G H
}22I J
public33 

required33 !
DefaultSystemSettings33 )
Settings33* 2
{333 4
get335 8
;338 9
init33: >
;33> ?
}33@ A
}44 
public66 
readonly66 
struct66 #
ViewModelFactoryContext66 .
{77 
public88 

required88  
IConnectivityService88 (
ConnectivityService88) <
{88= >
get88? B
;88B C
init88D H
;88H I
}88J K
public99 

required99 
NetworkProvider99 #
NetworkProvider99$ 3
{994 5
get996 9
;999 :
init99; ?
;99? @
}99A B
public:: 

required::  
ILocalizationService:: (
LocalizationService::) <
{::= >
get::? B
;::B C
init::D H
;::H I
}::J K
public;; 

required;; "
IAuthenticationService;; *!
AuthenticationService;;+ @
{;;A B
get;;C F
;;;F G
init;;H L
;;;L M
};;N O
public<< 

required<< -
!IApplicationSecureStorageProvider<< 5
StorageProvider<<6 E
{<<F G
get<<H K
;<<K L
init<<M Q
;<<Q R
}<<S T
public== 

required== #
AuthenticationViewModel== +
HostViewModel==, 9
{==: ;
get==< ?
;==? @
init==A E
;==E F
}==G H
public>> 

required>> &
IOpaqueRegistrationService>> .
RegistrationService>>/ B
{>>C D
get>>E H
;>>H I
init>>J N
;>>N O
}>>P Q
public?? 

required?? %
ISecureKeyRecoveryService?? -
RecoveryService??. =
{??> ?
get??@ C
;??C D
init??E I
;??I J
}??K L
public@@ 

required@@ %
AuthenticationFlowContext@@ -
FlowContext@@. 9
{@@: ;
get@@< ?
;@@? @
init@@A E
;@@E F
}@@G H
}AA 
publicCC 
classCC #
AuthenticationViewModelCC $
:CC% &
CoreCC' +
.CC+ ,
MVVMCC, 0
.CC0 1
ViewModelBaseCC1 >
,CC> ?
IScreenCC@ G
{DD 
privateEE 
staticEE 
readonlyEE 
AppCultureSettingsEE .
LanguageConfigEE/ =
=EE> ?
AppCultureSettingsEE@ R
.EER S
DefaultEES Z
;EEZ [
privateGG 
staticGG 
readonlyGG 
FrozenDictionaryGG ,
<GG, -
MembershipViewTypeGG- ?
,GG? @
FuncGGA E
<GGE F#
ViewModelFactoryContextGGF ]
,GG] ^
IRoutableViewModelGG_ q
>GGq r
>GGr s
ViewModelFactoriesHH 
=HH 
newHH  

DictionaryHH! +
<HH+ ,
MembershipViewTypeHH, >
,HH> ?
FuncHH@ D
<HHD E#
ViewModelFactoryContextHHE \
,HH\ ]
IRoutableViewModelHH^ p
>HHp q
>HHq r
{II 	
[JJ 
MembershipViewTypeJJ 
.JJ  

SignInViewJJ  *
]JJ* +
=JJ, -
ctxJJ. 1
=>JJ2 4
newKK 
SignInViewModelKK #
(KK# $
ctxKK$ '
.KK' (
ConnectivityServiceKK( ;
,KK; <
ctxKK= @
.KK@ A
NetworkProviderKKA P
,KKP Q
ctxKKR U
.KKU V
LocalizationServiceKKV i
,KKi j
ctxLL 
.LL !
AuthenticationServiceLL -
,LL- .
ctxLL/ 2
.LL2 3
HostViewModelLL3 @
)LL@ A
,LLA B
[MM 
MembershipViewTypeMM 
.MM  
WelcomeViewMM  +
]MM+ ,
=MM- .
ctxMM/ 2
=>MM3 5
newNN 
WelcomeViewModelNN $
(NN$ %
ctxNN% (
.NN( )
HostViewModelNN) 6
,NN6 7
ctxNN8 ;
.NN; <
LocalizationServiceNN< O
,NNO P
ctxNNQ T
.NNT U
NetworkProviderNNU d
)NNd e
,NNe f
[OO 
MembershipViewTypeOO 
.OO  "
MobileVerificationViewOO  6
]OO6 7
=OO8 9
ctxOO: =
=>OO> @
newPP '
MobileVerificationViewModelPP /
(PP/ 0
ctxPP0 3
.PP3 4
ConnectivityServicePP4 G
,PPG H
ctxPPI L
.PPL M
NetworkProviderPPM \
,PP\ ]
ctxPP^ a
.PPa b
LocalizationServicePPb u
,PPu v
ctxQQ 
.QQ 
HostViewModelQQ %
,QQ% &
ctxQQ' *
.QQ* +
StorageProviderQQ+ :
,QQ: ;
ctxQQ< ?
.QQ? @
RegistrationServiceQQ@ S
,QQS T
ctxRR 
.RR 
RecoveryServiceRR '
,RR' (
ctxRR) ,
.RR, -
FlowContextRR- 8
)RR8 9
,RR9 :
[SS 
MembershipViewTypeSS 
.SS  %
SecureKeyConfirmationViewSS  9
]SS9 :
=SS; <
ctxSS= @
=>SSA C
newTT &
SecureKeyVerifierViewModelTT .
(TT. /
ctxTT/ 2
.TT2 3
ConnectivityServiceTT3 F
,TTF G
ctxTTH K
.TTK L
NetworkProviderTTL [
,TT[ \
ctxTT] `
.TT` a
LocalizationServiceTTa t
,TTt u
ctxUU 
.UU 
HostViewModelUU %
,UU% &
ctxUU' *
.UU* +
StorageProviderUU+ :
,UU: ;
ctxUU< ?
.UU? @
RegistrationServiceUU@ S
,UUS T
ctxUUU X
.UUX Y!
AuthenticationServiceUUY n
,UUn o
ctxVV 
.VV 
RecoveryServiceVV '
,VV' (
ctxVV) ,
.VV, -
FlowContextVV- 8
)VV8 9
,VV9 :
[WW 
MembershipViewTypeWW 
.WW  

PinSetViewWW  *
]WW* +
=WW, -
ctxWW. 1
=>WW2 4
newXX 
PassPhaseViewModelXX &
(XX& '
ctxXX' *
.XX* +
LocalizationServiceXX+ >
,XX> ?
ctxXX@ C
.XXC D
HostViewModelXXD Q
,XXQ R
ctxXXS V
.XXV W
NetworkProviderXXW f
)XXf g
,XXg h
}YY 	
.YY	 

ToFrozenDictionaryYY
 
(YY 
)YY 
;YY 
private[[ 
readonly[[ -
!IApplicationSecureStorageProvider[[ 6-
!_applicationSecureStorageProvider[[7 X
;[[X Y
private\\ 
readonly\\  
IConnectivityService\\ ) 
_connectivityService\\* >
;\\> ?
private]] 
readonly]] 
NetworkProvider]] $
_networkProvider]]% 5
;]]5 6
private^^ 
readonly^^ %
ILanguageDetectionService^^ .%
_languageDetectionService^^/ H
;^^H I
private__ 
readonly__  
ILocalizationService__ ) 
_localizationService__* >
;__> ?
private`` 
readonly`` 
MainWindowViewModel`` ( 
_mainWindowViewModel``) =
;``= >
privateaa 
readonlyaa "
IAuthenticationServiceaa +"
_authenticationServiceaa, B
;aaB C
privatebb 
readonlybb &
IOpaqueRegistrationServicebb /&
_opaqueRegistrationServicebb0 J
;bbJ K
privatecc 
readonlycc %
ISecureKeyRecoveryServicecc .%
_secureKeyRecoveryServicecc/ H
;ccH I
privatedd 
readonlydd !
DefaultSystemSettingsdd *
	_settingsdd+ 4
;dd4 5
privateff 
readonlyff 

Dictionarygg 
<gg 
(gg 
MembershipViewTypegg &
ViewTypegg' /
,gg/ 0%
AuthenticationFlowContextgg1 J
FlowContextggK V
)ggV W
,ggW X
WeakReferencehh 
<hh 
IRoutableViewModelhh ,
>hh, -
>hh- .
_viewModelCachehh/ >
=hh? @
newhhA D
(hhD E
)hhE F
;hhF G
privatejj 
readonlyjj 
Stackjj 
<jj 
IRoutableViewModeljj -
>jj- .
_navigationStackjj/ ?
=jj@ A
newjjB E
(jjE F
)jjF G
;jjG H
privatell 
boolll 
_canNavigateBackll !
;ll! "
privatemm 
IDisposablemm 
?mm !
_languageSubscriptionmm .
;mm. /
privatenn 
IDisposablenn 
?nn *
_bottomSheetHiddenSubscriptionnn 7
;nn7 8
privateoo 
IRoutableViewModeloo 
?oo 
_currentViewoo  ,
;oo, -
publicqq 
%
AuthenticationFlowContextqq $
CurrentFlowContextqq% 7
{qq8 9
getqq: =
;qq= >
setqq? B
;qqB C
}qqD E
=qqF G%
AuthenticationFlowContextqqH a
.qqa b
Registrationqqb n
;qqn o
publicss 
#
AuthenticationViewModelss "
(ss" #/
#AuthenticationViewModelDependenciesss# F
dependenciesssG S
)ssS T
:tt 	
basett
 
(tt 
dependenciestt 
.tt 
NetworkProvidertt +
,tt+ ,
dependenciestt- 9
.tt9 :
LocalizationServicett: M
)ttM N
{uu  
_localizationServicevv 
=vv 
dependenciesvv +
.vv+ ,
LocalizationServicevv, ?
;vv? @ 
_connectivityServiceww 
=ww 
dependenciesww +
.ww+ ,
ConnectivityServiceww, ?
;ww? @-
!_applicationSecureStorageProviderxx )
=xx* +
dependenciesxx, 8
.xx8 9
StorageProviderxx9 H
;xxH I
_networkProvideryy 
=yy 
dependenciesyy '
.yy' (
NetworkProvideryy( 7
;yy7 8"
_authenticationServicezz 
=zz  
dependencieszz! -
.zz- .!
AuthenticationServicezz. C
;zzC D&
_opaqueRegistrationService{{ "
={{# $
dependencies{{% 1
.{{1 2
RegistrationService{{2 E
;{{E F%
_secureKeyRecoveryService|| !
=||" #
dependencies||$ 0
.||0 1
RecoveryService||1 @
;||@ A%
_languageDetectionService}} !
=}}" #
dependencies}}$ 0
.}}0 1$
LanguageDetectionService}}1 I
;}}I J 
_mainWindowViewModel~~ 
=~~ 
dependencies~~ +
.~~+ ,
MainWindowViewModel~~, ?
;~~? @
	_settings 
= 
dependencies  
.  !
Settings! )
;) *#
InitializeVersionInfo
ÅÅ 
(
ÅÅ 
)
ÅÅ 
;
ÅÅ   
InitializeCommands
ÇÇ 
(
ÇÇ 
dependencies
ÇÇ '
.
ÇÇ' (
Router
ÇÇ( .
)
ÇÇ. /
;
ÇÇ/ 0%
SetupActivationBehavior
ÉÉ 
(
ÉÉ  
)
ÉÉ  !
;
ÉÉ! "
}
ÑÑ 
public
ÜÜ 
 
IRoutableViewModel
ÜÜ 
?
ÜÜ 
CurrentView
ÜÜ *
{
áá 
get
àà 
=>
àà 
_currentView
àà 
;
àà 
private
ââ 
set
ââ 
{
ää 	
this
ãã 
.
ãã "
RaiseAndSetIfChanged
ãã %
(
ãã% &
ref
ãã& )
_currentView
ãã* 6
,
ãã6 7
value
ãã8 =
)
ãã= >
;
ãã> ?
CanNavigateBack
çç 
=
çç 
_navigationStack
çç .
.
çç. /
Count
çç/ 4
>
çç5 6
$num
çç7 8
;
çç8 9
}
éé 	
}
èè 
public
ëë 

bool
ëë 
CanNavigateBack
ëë 
{
íí 
get
ìì 
=>
ìì 
_canNavigateBack
ìì 
;
ìì  
private
îî 
set
îî 
=>
îî 
this
îî 
.
îî "
RaiseAndSetIfChanged
îî 0
(
îî0 1
ref
îî1 4
_canNavigateBack
îî5 E
,
îîE F
value
îîG L
)
îîL M
;
îîM N
}
ïï 
public
óó 

RoutingState
óó 
Router
óó 
=>
óó !
new
óó" %
(
óó% &
)
óó& '
;
óó' (
public
ôô 

string
ôô 

AppVersion
ôô 
{
ôô 
get
ôô "
;
ôô" #
private
ôô$ +
set
ôô, /
;
ôô/ 0
}
ôô1 2
=
ôô3 4
string
ôô5 ;
.
ôô; <
Empty
ôô< A
;
ôôA B
public
õõ 

string
õõ 
FullVersionInfo
õõ !
{
õõ" #
get
õõ$ '
;
õõ' (
private
õõ) 0
set
õõ1 4
;
õõ4 5
}
õõ6 7
=
õõ8 9
string
õõ: @
.
õõ@ A
Empty
õõA F
;
õõF G
public
ùù 

string
ùù 
?
ùù &
RegistrationMobileNumber
ùù +
{
ùù, -
get
ùù. 1
;
ùù1 2
set
ùù3 6
;
ùù6 7
}
ùù8 9
public
üü 

string
üü 
?
üü "
RecoveryMobileNumber
üü '
{
üü( )
get
üü* -
;
üü- .
set
üü/ 2
;
üü2 3
}
üü4 5
public
°° 

ReactiveCommand
°° 
<
°°  
MembershipViewType
°° -
,
°°- . 
IRoutableViewModel
°°/ A
>
°°A B
Navigate
°°C K
{
°°L M
get
°°N Q
;
°°Q R
private
°°S Z
set
°°[ ^
;
°°^ _
}
°°` a
=
°°b c
null
°°d h
!
°°h i
;
°°i j
public
££ 

ReactiveCommand
££ 
<
££ 
Unit
££ 
,
££   
IRoutableViewModel
££! 3
?
££3 4
>
££4 5
NavigateBack
££6 B
{
££C D
get
££E H
;
££H I
private
££J Q
set
££R U
;
££U V
}
££W X
=
££Y Z
null
££[ _
!
££_ `
;
££` a
public
•• 

ReactiveCommand
•• 
<
•• 
Unit
•• 
,
••  
Unit
••! %
>
••% &'
SwitchToMainWindowCommand
••' @
{
••A B
get
••C F
;
••F G
private
••H O
set
••P S
;
••S T
}
••U V
=
••W X
null
••Y ]
!
••] ^
;
••^ _
public
ßß 

ReactiveCommand
ßß 
<
ßß 
Unit
ßß 
,
ßß  
Unit
ßß! %
>
ßß% &&
OpenPrivacyPolicyCommand
ßß' ?
{
ßß@ A
get
ßßB E
;
ßßE F
private
ßßG N
set
ßßO R
;
ßßR S
}
ßßT U
=
ßßV W
null
ßßX \
!
ßß\ ]
;
ßß] ^
public
©© 

ReactiveCommand
©© 
<
©© 
Unit
©© 
,
©©  
Unit
©©! %
>
©©% &'
OpenTermsOfServiceCommand
©©' @
{
©©A B
get
©©C F
;
©©F G
private
©©H O
set
©©P S
;
©©S T
}
©©U V
=
©©W X
null
©©Y ]
!
©©] ^
;
©©^ _
public
´´ 

ReactiveCommand
´´ 
<
´´ 
Unit
´´ 
,
´´  
Unit
´´! %
>
´´% & 
OpenSupportCommand
´´' 9
{
´´: ;
get
´´< ?
;
´´? @
private
´´A H
set
´´I L
;
´´L M
}
´´N O
=
´´P Q
null
´´R V
!
´´V W
;
´´W X
public
≠≠ 

ReactiveCommand
≠≠ 
<
≠≠ 
Unit
≠≠ 
,
≠≠  
Unit
≠≠! %
>
≠≠% &0
"CheckCountryCultureMismatchCommand
≠≠' I
{
≠≠J K
get
≠≠L O
;
≠≠O P
private
≠≠Q X
set
≠≠Y \
;
≠≠\ ]
}
≠≠^ _
=
≠≠` a
null
≠≠b f
!
≠≠f g
;
≠≠g h
public
ØØ 

void
ØØ "
ClearNavigationStack
ØØ $
(
ØØ$ %
bool
ØØ% )$
preserveInitialWelcome
ØØ* @
=
ØØA B
false
ØØC H
,
ØØH I 
MembershipViewType
ØØJ \
?
ØØ\ ]
preserveViewType
ØØ^ n
=
ØØo p
null
ØØq u
)
ØØu v
{
∞∞ 
if
±± 

(
±± 
_currentView
±± 
is
±± 
IResettable
±± '
currentResettable
±±( 9
)
±±9 :
{
≤≤ 	
currentResettable
≥≥ 
.
≥≥ 

ResetState
≥≥ (
(
≥≥( )
)
≥≥) *
;
≥≥* +
}
¥¥ 	
_navigationStack
∂∂ 
.
∂∂ 
Clear
∂∂ 
(
∂∂ 
)
∂∂  
;
∂∂  !
if
∏∏ 

(
∏∏ $
preserveInitialWelcome
∏∏ "
)
∏∏" #
{
ππ 	 
IRoutableViewModel
∫∫ 
welcomeView
∫∫ *
=
∫∫+ ,)
GetOrCreateViewModelForView
∫∫- H
(
∫∫H I 
MembershipViewType
ªª "
.
ªª" #
WelcomeView
ªª# .
,
ªª. /

resetState
ºº 
:
ºº 
true
ºº  
)
ºº  !
;
ºº! "
_navigationStack
ΩΩ 
.
ΩΩ 
Push
ΩΩ !
(
ΩΩ! "
welcomeView
ΩΩ" -
)
ΩΩ- .
;
ΩΩ. /
}
ææ 	
if
¿¿ 

(
¿¿ 
preserveViewType
¿¿ 
.
¿¿ 
HasValue
¿¿ %
)
¿¿% &
{
¡¡ 	 
IRoutableViewModel
¬¬ 
preservedView
¬¬ ,
=
¬¬- .)
GetOrCreateViewModelForView
¬¬/ J
(
¬¬J K
preserveViewType
√√  
.
√√  !
Value
√√! &
,
√√& '

resetState
ƒƒ 
:
ƒƒ 
true
ƒƒ  
)
ƒƒ  !
;
ƒƒ! "
_navigationStack
≈≈ 
.
≈≈ 
Push
≈≈ !
(
≈≈! "
preservedView
≈≈" /
)
≈≈/ 0
;
≈≈0 1
}
∆∆ 	
_currentView
»» 
=
»» 
null
»» 
;
»» 
this
…… 
.
…… "
RaisePropertyChanged
…… !
(
……! "
nameof
……" (
(
……( )
CurrentView
……) 4
)
……4 5
)
……5 6
;
……6 7
CanNavigateBack
ÀÀ 
=
ÀÀ 
_navigationStack
ÀÀ *
.
ÀÀ* +
Count
ÀÀ+ 0
>
ÀÀ1 2
$num
ÀÀ3 4
;
ÀÀ4 5
}
ÃÃ 
public
œœ 

void
œœ !
NavigateToViewModel
œœ #
(
œœ# $ 
IRoutableViewModel
œœ$ 6
	viewModel
œœ7 @
)
œœ@ A
{
–– 
if
—— 

(
—— 
_currentView
—— 
!=
—— 
null
——  
)
——  !
{
““ 	
if
”” 
(
”” 
_currentView
”” 
is
”” 
IResettable
””  +
currentResettable
””, =
)
””= >
{
‘‘ 
currentResettable
’’ !
.
’’! "

ResetState
’’" ,
(
’’, -
)
’’- .
;
’’. /
}
÷÷ 
_navigationStack
ÿÿ 
.
ÿÿ 
Push
ÿÿ !
(
ÿÿ! "
_currentView
ÿÿ" .
)
ÿÿ. /
;
ÿÿ/ 0
}
ŸŸ 	
CurrentView
€€ 
=
€€ 
	viewModel
€€ 
;
€€  
}
‹‹ 
public
ﬁﬁ 

void
ﬁﬁ (
StartSecureKeyRecoveryFlow
ﬁﬁ *
(
ﬁﬁ* +
)
ﬁﬁ+ ,
{
ﬂﬂ "
ClearNavigationStack
‡‡ 
(
‡‡ 
true
‡‡ !
)
‡‡! "
;
‡‡" # 
CurrentFlowContext
·· 
=
·· '
AuthenticationFlowContext
·· 6
.
··6 7
SecureKeyRecovery
··7 H
;
··H I
Navigate
‚‚ 
.
‚‚ 
Execute
‚‚ 
(
‚‚  
MembershipViewType
‚‚ +
.
‚‚+ ,$
MobileVerificationView
‚‚, B
)
‚‚B C
.
‚‚C D
	Subscribe
‚‚D M
(
‚‚M N
)
‚‚N O
;
‚‚O P
}
„„ 
public
ÂÂ 

async
ÂÂ 
Task
ÂÂ 
ShowBottomSheet
ÂÂ %
(
ÂÂ% &&
BottomSheetComponentType
ÂÂ& >
componentType
ÂÂ? L
,
ÂÂL M
UserControl
ÂÂN Y
redirectView
ÂÂZ f
,
ÂÂf g
bool
ÊÊ 
	showScrim
ÊÊ 
=
ÊÊ 
true
ÊÊ 
,
ÊÊ 
bool
ÊÊ #
isDismissable
ÊÊ$ 1
=
ÊÊ2 3
false
ÊÊ4 9
)
ÊÊ9 :
{
ÁÁ 
if
ËË 

(
ËË 
Application
ËË 
.
ËË 
Current
ËË 
?
ËË  
.
ËË  !!
ApplicationLifetime
ËË! 4
is
ËË5 75
'IClassicDesktopStyleApplicationLifetime
ËË8 _
)
ËË_ `
{
ÈÈ 	
await
ÍÍ 

Dispatcher
ÍÍ 
.
ÍÍ 
UIThread
ÍÍ %
.
ÍÍ% &
InvokeAsync
ÍÍ& 1
(
ÍÍ1 2
async
ÍÍ2 7
(
ÍÍ8 9
)
ÍÍ9 :
=>
ÍÍ; =
{
ÎÎ 
await
ÏÏ "
_mainWindowViewModel
ÏÏ *
.
ÏÏ* +"
ShowBottomSheetAsync
ÏÏ+ ?
(
ÏÏ? @
componentType
ÏÏ@ M
,
ÏÏM N
redirectView
ÏÏO [
,
ÏÏ[ \
	showScrim
ÌÌ 
:
ÌÌ 
	showScrim
ÌÌ (
,
ÌÌ( )
isDismissable
ÌÌ* 7
:
ÌÌ7 8
isDismissable
ÌÌ9 F
)
ÌÌF G
.
ÌÌG H
ConfigureAwait
ÌÌH V
(
ÌÌV W
false
ÌÌW \
)
ÌÌ\ ]
;
ÌÌ] ^
}
ÓÓ 
)
ÓÓ 
.
ÓÓ 
ConfigureAwait
ÓÓ 
(
ÓÓ 
false
ÓÓ #
)
ÓÓ# $
;
ÓÓ$ %
}
ÔÔ 	
else
 
{
ÒÒ 	
await
ÚÚ "
_mainWindowViewModel
ÚÚ &
.
ÚÚ& '"
ShowBottomSheetAsync
ÚÚ' ;
(
ÚÚ; <
componentType
ÚÚ< I
,
ÚÚI J
redirectView
ÚÚK W
,
ÚÚW X
	showScrim
ÛÛ 
:
ÛÛ 
	showScrim
ÛÛ $
,
ÛÛ$ %
isDismissable
ÛÛ& 3
:
ÛÛ3 4
isDismissable
ÛÛ5 B
)
ÛÛB C
.
ÛÛC D
ConfigureAwait
ÛÛD R
(
ÛÛR S
false
ÛÛS X
)
ÛÛX Y
;
ÛÛY Z
}
ÙÙ 	
}
ıı 
public
˜˜ 

async
˜˜ 
Task
˜˜ "
HideBottomSheetAsync
˜˜ *
(
˜˜* +
)
˜˜+ ,
{
¯¯ 
if
˘˘ 

(
˘˘ 
Application
˘˘ 
.
˘˘ 
Current
˘˘ 
?
˘˘  
.
˘˘  !!
ApplicationLifetime
˘˘! 4
is
˘˘5 75
'IClassicDesktopStyleApplicationLifetime
˘˘8 _
)
˘˘_ `
{
˙˙ 	
await
˚˚ 

Dispatcher
˚˚ 
.
˚˚ 
UIThread
˚˚ %
.
˚˚% &
InvokeAsync
˚˚& 1
(
˚˚1 2
async
˚˚2 7
(
˚˚8 9
)
˚˚9 :
=>
˚˚; =
{
¸¸ 
await
˝˝ "
_mainWindowViewModel
˝˝ *
.
˝˝* +"
HideBottomSheetAsync
˝˝+ ?
(
˝˝? @
)
˝˝@ A
.
˝˝A B
ConfigureAwait
˝˝B P
(
˝˝P Q
false
˝˝Q V
)
˝˝V W
;
˝˝W X
}
˛˛ 
)
˛˛ 
.
˛˛ 
ConfigureAwait
˛˛ 
(
˛˛ 
false
˛˛ #
)
˛˛# $
;
˛˛$ %
}
ˇˇ 	
else
ÄÄ 
{
ÅÅ 	
await
ÇÇ "
_mainWindowViewModel
ÇÇ &
.
ÇÇ& '"
HideBottomSheetAsync
ÇÇ' ;
(
ÇÇ; <
)
ÇÇ< =
.
ÇÇ= >
ConfigureAwait
ÇÇ> L
(
ÇÇL M
false
ÇÇM R
)
ÇÇR S
;
ÇÇS T
}
ÉÉ 	
}
ÑÑ 
	protected
ÜÜ 
override
ÜÜ 
void
ÜÜ 
Dispose
ÜÜ #
(
ÜÜ# $
bool
ÜÜ$ (
	disposing
ÜÜ) 2
)
ÜÜ2 3
{
áá 
if
àà 

(
àà 
	disposing
àà 
)
àà 
{
ââ 	'
CleanupAuthenticationFlow
ää %
(
ää% &
)
ää& '
;
ää' (
}
ãã 	
base
çç 
.
çç 
Dispose
çç 
(
çç 
	disposing
çç 
)
çç 
;
çç  
}
éé 
private
êê 
static
êê 
void
êê 
OpenUrl
êê 
(
êê  
string
êê  &
url
êê' *
)
êê* +
{
ëë 
if
íí 

(
íí 
System
íí 
.
íí 
Runtime
íí 
.
íí 
InteropServices
íí *
.
íí* + 
RuntimeInformation
íí+ =
.
íí= >
IsOSPlatform
íí> J
(
ííJ K
System
ííK Q
.
ííQ R
Runtime
ííR Y
.
ííY Z
InteropServices
ííZ i
.
ííi j

OSPlatform
ííj t
.
ìì 
Windows
ìì 
)
ìì 
)
ìì 
{
îî 	
System
ïï 
.
ïï 
Diagnostics
ïï 
.
ïï 
Process
ïï &
.
ïï& '
Start
ïï' ,
(
ïï, -
new
ññ 
System
ññ 
.
ññ 
Diagnostics
ññ &
.
ññ& '
ProcessStartInfo
ññ' 7
(
ññ7 8
url
ññ8 ;
)
ññ; <
{
ññ= >
UseShellExecute
ññ? N
=
ññO P
true
ññQ U
}
ññV W
)
ññW X
;
ññX Y
}
óó 	
else
òò 
if
òò 
(
òò 
System
òò 
.
òò 
Runtime
òò 
.
òò  
InteropServices
òò  /
.
òò/ 0 
RuntimeInformation
òò0 B
.
òòB C
IsOSPlatform
òòC O
(
òòO P
System
òòP V
.
òòV W
Runtime
òòW ^
.
òò^ _
InteropServices
òò_ n
.
ôô 

OSPlatform
ôô  
.
ôô  !
OSX
ôô! $
)
ôô$ %
)
ôô% &
{
öö 	
System
õõ 
.
õõ 
Diagnostics
õõ 
.
õõ 
Process
õõ &
.
õõ& '
Start
õõ' ,
(
õõ, -
$str
õõ- 3
,
õõ3 4
url
õõ5 8
)
õõ8 9
;
õõ9 :
}
úú 	
else
ùù 
if
ùù 
(
ùù 
System
ùù 
.
ùù 
Runtime
ùù 
.
ùù  
InteropServices
ùù  /
.
ùù/ 0 
RuntimeInformation
ùù0 B
.
ùùB C
IsOSPlatform
ùùC O
(
ùùO P
System
ùùP V
.
ùùV W
Runtime
ùùW ^
.
ùù^ _
InteropServices
ùù_ n
.
ûû 

OSPlatform
ûû  
.
ûû  !
Linux
ûû! &
)
ûû& '
)
ûû' (
{
üü 	
System
†† 
.
†† 
Diagnostics
†† 
.
†† 
Process
†† &
.
††& '
Start
††' ,
(
††, -
$str
††- 7
,
††7 8
url
††9 <
)
††< =
;
††= >
}
°° 	
else
¢¢ 
{
££ 	
Log
§§ 
.
§§ 
Warning
§§ 
(
§§ 
$str
§§ E
,
§§E F
url
§§G J
)
§§J K
;
§§K L
}
•• 	
}
¶¶ 
private
®® 
void
®® '
CleanupAuthenticationFlow
®® *
(
®®* +
)
®®+ ,
{
©© "
ClearNavigationStack
™™ 
(
™™ 
)
™™ 
;
™™ 
List
¨¨ 
<
¨¨ 
KeyValuePair
¨¨ 
<
¨¨ 
(
¨¨  
MembershipViewType
¨¨ -
viewType
¨¨. 6
,
¨¨6 7'
AuthenticationFlowContext
¨¨8 Q
actualFlowContext
¨¨R c
)
¨¨c d
,
¨¨d e
WeakReference
≠≠ 
<
≠≠  
IRoutableViewModel
≠≠ ,
>
≠≠, -
>
≠≠- .
>
≠≠. /
cachedItems
≠≠0 ;
=
≠≠< =
_viewModelCache
ÆÆ 
.
ÆÆ 
ToList
ÆÆ "
(
ÆÆ" #
)
ÆÆ# $
;
ÆÆ$ %
foreach
∞∞ 
(
∞∞ 
KeyValuePair
∞∞ 
<
∞∞ 
(
∞∞  
MembershipViewType
∞∞ 1
viewType
∞∞2 :
,
∞∞: ;'
AuthenticationFlowContext
∞∞< U
actualFlowContext
∞∞V g
)
∞∞g h
,
∞∞h i
WeakReference
±± "
<
±±" # 
IRoutableViewModel
±±# 5
>
±±5 6
>
±±6 7
item
±±8 <
in
±±= ?
cachedItems
±±@ K
)
±±K L
{
≤≤ 	
if
≥≥ 
(
≥≥ 
!
≥≥ 
item
≥≥ 
.
≥≥ 
Value
≥≥ 
.
≥≥ 
TryGetTarget
≥≥ (
(
≥≥( )
out
≥≥) , 
IRoutableViewModel
≥≥- ?
?
≥≥? @
	viewModel
≥≥A J
)
≥≥J K
)
≥≥K L
{
¥¥ 
continue
µµ 
;
µµ 
}
∂∂ 
if
∏∏ 
(
∏∏ 
	viewModel
∏∏ 
is
∏∏ 
IResettable
∏∏ (!
resettableViewModel
∏∏) <
)
∏∏< =
{
ππ !
resettableViewModel
∫∫ #
.
∫∫# $

ResetState
∫∫$ .
(
∫∫. /
)
∫∫/ 0
;
∫∫0 1
}
ªª 
if
ΩΩ 
(
ΩΩ 
	viewModel
ΩΩ 
is
ΩΩ 
IDisposable
ΩΩ (!
disposableViewModel
ΩΩ) <
)
ΩΩ< =
{
ææ !
disposableViewModel
øø #
.
øø# $
Dispose
øø$ +
(
øø+ ,
)
øø, -
;
øø- .
}
¿¿ 
}
¡¡ 	
_viewModelCache
√√ 
.
√√ 
Clear
√√ 
(
√√ 
)
√√ 
;
√√  
CurrentView
ƒƒ 
=
ƒƒ 
null
ƒƒ 
;
ƒƒ 
}
≈≈ 
private
«« 
async
«« 
Task
«« *
HandleLanguageDetectionEvent
«« 3
(
««3 4*
LanguageDetectionDialogEvent
««4 P
evt
««Q T
)
««T U
{
»» 
try
…… 
{
   	
switch
ÀÀ 
(
ÀÀ 
evt
ÀÀ 
.
ÀÀ 
Action
ÀÀ 
)
ÀÀ 
{
ÃÃ 
case
ÕÕ %
LanguageDetectionAction
ÕÕ ,
.
ÕÕ, -
Confirm
ÕÕ- 4
when
ÕÕ5 9
!
ÕÕ: ;
string
ÕÕ; A
.
ÕÕA B
IsNullOrEmpty
ÕÕB O
(
ÕÕO P
evt
ÕÕP S
.
ÕÕS T
TargetCulture
ÕÕT a
)
ÕÕa b
:
ÕÕb c'
ChangeApplicationLanguage
ŒŒ -
(
ŒŒ- .
evt
ŒŒ. 1
.
ŒŒ1 2
TargetCulture
ŒŒ2 ?
)
ŒŒ? @
;
ŒŒ@ A
break
œœ 
;
œœ 
case
—— %
LanguageDetectionAction
—— ,
.
——, -
Decline
——- 4
:
——4 5
break
““ 
;
““ 
}
”” 
await
’’ "
_mainWindowViewModel
’’ &
.
’’& '"
HideBottomSheetAsync
’’' ;
(
’’; <
)
’’< =
.
’’= >
ConfigureAwait
’’> L
(
’’L M
false
’’M R
)
’’R S
;
’’S T
}
÷÷ 	
finally
◊◊ 
{
ÿÿ 	#
_languageSubscription
ŸŸ !
?
ŸŸ! "
.
ŸŸ" #
Dispose
ŸŸ# *
(
ŸŸ* +
)
ŸŸ+ ,
;
ŸŸ, -,
_bottomSheetHiddenSubscription
⁄⁄ *
?
⁄⁄* +
.
⁄⁄+ ,
Dispose
⁄⁄, 3
(
⁄⁄3 4
)
⁄⁄4 5
;
⁄⁄5 6
}
€€ 	
}
‹‹ 
private
ﬁﬁ 
void
ﬁﬁ '
ChangeApplicationLanguage
ﬁﬁ *
(
ﬁﬁ* +
string
ﬁﬁ+ 1
targetCulture
ﬁﬁ2 ?
)
ﬁﬁ? @
{
ﬂﬂ "
_localizationService
‡‡ 
.
‡‡ 

SetCulture
‡‡ '
(
‡‡' (
targetCulture
‡‡( 5
,
‡‡5 6
(
·· 
)
·· 
=>
·· 
{
‚‚ 
Task
„„ 
.
„„ 
Run
„„ 
(
„„ 
async
„„ 
(
„„  
)
„„  !
=>
„„" $
{
‰‰ 
await
ÂÂ /
!_applicationSecureStorageProvider
ÂÂ ;
.
ÂÂ; <0
"SetApplicationSettingsCultureAsync
ÂÂ< ^
(
ÂÂ^ _
targetCulture
ÂÂ_ l
)
ÂÂl m
.
ÊÊ 
ConfigureAwait
ÊÊ '
(
ÊÊ' (
false
ÊÊ( -
)
ÊÊ- .
;
ÊÊ. /
}
ÁÁ 
)
ÁÁ 
.
ÁÁ 
ContinueWith
ÁÁ 
(
ÁÁ  
task
ËË 
=>
ËË 
{
ÈÈ 
if
ÍÍ 
(
ÍÍ 
task
ÍÍ  
is
ÍÍ! #
{
ÍÍ$ %
	IsFaulted
ÍÍ& /
:
ÍÍ/ 0
true
ÍÍ1 5
,
ÍÍ5 6
	Exception
ÍÍ7 @
:
ÍÍ@ A
not
ÍÍB E
null
ÍÍF J
}
ÍÍK L
)
ÍÍL M
{
ÎÎ 
Log
ÏÏ 
.
ÏÏ  
Error
ÏÏ  %
(
ÏÏ% &
task
ÏÏ& *
.
ÏÏ* +
	Exception
ÏÏ+ 4
,
ÏÏ4 5
$str
ÏÏ6 p
)
ÏÏp q
;
ÏÏq r
}
ÌÌ 
}
ÓÓ 
,
ÓÓ 
TaskScheduler
ÔÔ !
.
ÔÔ! "
Default
ÔÔ" )
)
ÔÔ) *
;
ÔÔ* +
}
 
)
 
;
 
}
ÒÒ 
private
ÛÛ 
Task
ÛÛ -
HandleBottomSheetDismissedEvent
ÛÛ 0
(
ÛÛ0 1$
BottomSheetHiddenEvent
ÛÛ1 G
evt
ÛÛH K
)
ÛÛK L
{
ÙÙ #
_languageSubscription
ıı 
?
ıı 
.
ıı 
Dispose
ıı &
(
ıı& '
)
ıı' (
;
ıı( ),
_bottomSheetHiddenSubscription
ˆˆ &
?
ˆˆ& '
.
ˆˆ' (
Dispose
ˆˆ( /
(
ˆˆ/ 0
)
ˆˆ0 1
;
ˆˆ1 2
return
˜˜ 
Task
˜˜ 
.
˜˜ 
CompletedTask
˜˜ !
;
˜˜! "
}
¯¯ 
private
˙˙ 
async
˙˙ 
Task
˙˙ .
 CheckCountryCultureMismatchAsync
˙˙ 7
(
˙˙7 8
)
˙˙8 9
{
˚˚ 
Result
¸¸ 
<
¸¸ )
ApplicationInstanceSettings
¸¸ *
,
¸¸* +'
InternalServiceApiFailure
¸¸, E
>
¸¸E F
appSettings
¸¸G R
=
¸¸S T
await
˝˝ /
!_applicationSecureStorageProvider
˝˝ 3
.
˝˝3 41
#GetApplicationInstanceSettingsAsync
˝˝4 W
(
˝˝W X
)
˝˝X Y
;
˝˝Y Z
if
ˇˇ 

(
ˇˇ 
appSettings
ˇˇ 
.
ˇˇ 
IsOk
ˇˇ 
)
ˇˇ 
{
ÄÄ 	)
ApplicationInstanceSettings
ÅÅ ')
applicationInstanceSettings
ÅÅ( C
=
ÅÅD E
appSettings
ÅÅF Q
.
ÅÅQ R
Unwrap
ÅÅR X
(
ÅÅX Y
)
ÅÅY Z
;
ÅÅZ [
if
ÇÇ 
(
ÇÇ 
!
ÇÇ 
string
ÇÇ 
.
ÇÇ 
IsNullOrEmpty
ÇÇ %
(
ÇÇ% &)
applicationInstanceSettings
ÇÇ& A
.
ÇÇA B
Country
ÇÇB I
)
ÇÇI J
&&
ÇÇK M)
applicationInstanceSettings
ÇÇN i
.
ÇÇi j
IsNewInstance
ÇÇj w
)
ÇÇw x
{
ÉÉ #
_languageSubscription
ÑÑ %
=
ÑÑ& ''
_languageDetectionService
ÖÖ -
.
ÖÖ- .*
OnLanguageDetectionRequested
ÖÖ. J
(
ÖÖJ K*
HandleLanguageDetectionEvent
ÖÖK g
,
ÖÖg h"
SubscriptionLifetime
ÜÜ ,
.
ÜÜ, -
Scoped
ÜÜ- 3
)
ÜÜ3 4
;
ÜÜ4 5,
_bottomSheetHiddenSubscription
áá .
=
áá/ 0"
_mainWindowViewModel
àà (
.
àà( )!
OnBottomSheetHidden
àà) <
(
àà< =-
HandleBottomSheetDismissedEvent
àà= \
,
àà\ ]"
SubscriptionLifetime
ââ ,
.
ââ, -
Scoped
ââ- 3
)
ââ3 4
;
ââ4 5
string
ãã 
currentCulture
ãã %
=
ãã& '
System
ãã( .
.
ãã. /
Globalization
ãã/ <
.
ãã< =
CultureInfo
ãã= H
.
ããH I
CurrentUICulture
ããI Y
.
ããY Z
Name
ããZ ^
;
ãã^ _
string
çç 
expectedCulture
çç &
=
çç' (
LanguageConfig
çç) 7
.
çç7 8!
GetCultureByCountry
çç8 K
(
ççK L)
applicationInstanceSettings
ççL g
.
ççg h
Country
ççh o
)
çço p
;
ççp q
if
èè 
(
èè 
!
èè 
string
èè 
.
èè 
Equals
èè "
(
èè" #
currentCulture
èè# 1
,
èè1 2
expectedCulture
èè3 B
,
èèB C
StringComparison
èèD T
.
èèT U
OrdinalIgnoreCase
èèU f
)
èèf g
)
èèg h
{
êê +
DetectLanguageDialogViewModel
ëë 1%
detectLanguageViewModel
ëë2 I
=
ëëJ K
new
ëëL O
(
ëëO P!
LocalizationService
íí +
,
íí+ ,'
_languageDetectionService
ìì 1
,
ìì1 2
_networkProvider
îî (
)
ïï 
;
ïï "
DetectLanguageDialog
óó ( 
detectLanguageView
óó) ;
=
óó< =
new
óó> A
(
óóA B
)
óóB C
{
óóD E
DataContext
óóF Q
=
óóR S%
detectLanguageViewModel
óóT k
}
óól m
;
óóm n
await
ôô "
_mainWindowViewModel
ôô .
.
ôô. /"
ShowBottomSheetAsync
ôô/ C
(
ôôC D&
BottomSheetComponentType
öö 0
.
öö0 1"
DetectedLocalization
öö1 E
,
ööE F 
detectLanguageView
õõ *
,
õõ* +
	showScrim
úú !
:
úú! "
true
úú# '
,
úú' (
isDismissable
ùù %
:
ùù% &
true
ùù' +
)
ûû 
.
ûû 
ConfigureAwait
ûû $
(
ûû$ %
false
ûû% *
)
ûû* +
;
ûû+ ,
}
üü 
}
†† 
}
°° 	
}
¢¢ 
private
§§ 
static
§§ 
readonly
§§ 
	FrozenSet
§§ %
<
§§% & 
MembershipViewType
§§& 8
>
§§8 9
FlowSpecificViews
§§: K
=
§§L M
new
§§N Q
HashSet
§§R Y
<
§§Y Z 
MembershipViewType
§§Z l
>
§§l m
{
••  
MembershipViewType
¶¶ 
.
¶¶ $
MobileVerificationView
¶¶ 1
,
¶¶1 2 
MembershipViewType
ßß 
.
ßß !
OtpVerificationView
ßß .
,
ßß. / 
MembershipViewType
®® 
.
®® '
SecureKeyConfirmationView
®® 4
,
®®4 5
}
©© 
.
©© 
ToFrozenSet
©© 
(
©© 
)
©© 
;
©© 
private
¨¨  
IRoutableViewModel
¨¨ )
GetOrCreateViewModelForView
¨¨ :
(
¨¨: ; 
MembershipViewType
¨¨; M
viewType
¨¨N V
,
¨¨V W
bool
¨¨X \

resetState
¨¨] g
=
¨¨h i
true
¨¨j n
)
¨¨n o
{
≠≠ '
AuthenticationFlowContext
ÆÆ !
flowContext
ÆÆ" -
=
ÆÆ. / 
CurrentFlowContext
ÆÆ0 B
;
ÆÆB C
bool
∞∞ $
useFlowSpecificCaching
∞∞ #
=
∞∞$ %
FlowSpecificViews
∞∞& 7
.
∞∞7 8
Contains
∞∞8 @
(
∞∞@ A
viewType
∞∞A I
)
∞∞I J
;
∞∞J K
(
≤≤ 	 
MembershipViewType
≤≤	 
viewType
≤≤ $
,
≤≤$ %'
AuthenticationFlowContext
≤≤& ?
)
≤≤? @
cacheKey
≤≤A I
=
≤≤J K$
useFlowSpecificCaching
≤≤L b
?
≥≥ 
(
≥≥ 
viewType
≥≥ 
,
≥≥ 
flowContext
≥≥ $
)
≥≥$ %
:
¥¥ 
(
¥¥ 
viewType
¥¥ 
,
¥¥ '
AuthenticationFlowContext
¥¥ 2
.
¥¥2 3
Registration
¥¥3 ?
)
¥¥? @
;
¥¥@ A
if
∂∂ 

(
∂∂ 
_viewModelCache
∂∂ 
.
∂∂ 
TryGetValue
∂∂ '
(
∂∂' (
cacheKey
∂∂( 0
,
∂∂0 1
out
∂∂2 5
WeakReference
∂∂6 C
<
∂∂C D 
IRoutableViewModel
∂∂D V
>
∂∂V W
?
∂∂W X
weakRef
∂∂Y `
)
∂∂` a
&&
∂∂b d
weakRef
∑∑ 
.
∑∑ 
TryGetTarget
∑∑  
(
∑∑  !
out
∑∑! $ 
IRoutableViewModel
∑∑% 7
?
∑∑7 8
cachedViewModel
∑∑9 H
)
∑∑H I
)
∑∑I J
{
∏∏ 	
if
ππ 
(
ππ 

resetState
ππ 
&&
ππ 
cachedViewModel
ππ -
is
ππ. 0
IResettable
ππ1 <

resettable
ππ= G
)
ππG H
{
∫∫ 

resettable
ªª 
.
ªª 

ResetState
ªª %
(
ªª% &
)
ªª& '
;
ªª' (
}
ºº 
return
ææ 
cachedViewModel
ææ "
;
ææ" #
}
øø 	
if
¡¡ 

(
¡¡ 
!
¡¡  
ViewModelFactories
¡¡ 
.
¡¡  
TryGetValue
¡¡  +
(
¡¡+ ,
viewType
¡¡, 4
,
¡¡4 5
out
¡¡6 9
Func
¡¡: >
<
¡¡> ?%
ViewModelFactoryContext
¡¡? V
,
¡¡V W 
IRoutableViewModel
¡¡X j
>
¡¡j k
?
¡¡k l
factory
¡¡m t
)
¡¡t u
)
¡¡u v
{
¬¬ 	
throw
√√ 
new
√√ '
InvalidOperationException
√√ /
(
√√/ 0
$"
√√0 2
$str
√√2 R
{
√√R S
viewType
√√S [
}
√√[ \
"
√√\ ]
)
√√] ^
;
√√^ _
}
ƒƒ 	%
ViewModelFactoryContext
∆∆ 
context
∆∆  '
=
∆∆( )
new
∆∆* -
(
∆∆- .
)
∆∆. /
{
«« 	!
ConnectivityService
»» 
=
»»  !"
_connectivityService
»»" 6
,
»»6 7
NetworkProvider
…… 
=
…… 
_networkProvider
…… .
,
……. /!
LocalizationService
   
=
    !!
LocalizationService
  " 5
,
  5 6#
AuthenticationService
ÀÀ !
=
ÀÀ" #$
_authenticationService
ÀÀ$ :
,
ÀÀ: ;
StorageProvider
ÃÃ 
=
ÃÃ /
!_applicationSecureStorageProvider
ÃÃ ?
,
ÃÃ? @
HostViewModel
ÕÕ 
=
ÕÕ 
this
ÕÕ  
,
ÕÕ  !!
RegistrationService
ŒŒ 
=
ŒŒ  !(
_opaqueRegistrationService
ŒŒ" <
,
ŒŒ< =
RecoveryService
œœ 
=
œœ '
_secureKeyRecoveryService
œœ 7
,
œœ7 8
FlowContext
–– 
=
–– 
flowContext
–– %
}
—— 	
;
——	 
 
IRoutableViewModel
”” 
newViewModel
”” '
=
””( )
factory
””* 1
(
””1 2
context
””2 9
)
””9 :
;
””: ;
_viewModelCache
’’ 
[
’’ 
cacheKey
’’  
]
’’  !
=
’’" #
new
’’$ '
WeakReference
’’( 5
<
’’5 6 
IRoutableViewModel
’’6 H
>
’’H I
(
’’I J
newViewModel
’’J V
)
’’V W
;
’’W X
if
◊◊ 

(
◊◊ 

resetState
◊◊ 
&&
◊◊ 
newViewModel
◊◊ &
is
◊◊' )
IResettable
◊◊* 5
resettableNew
◊◊6 C
)
◊◊C D
{
ÿÿ 	
resettableNew
ŸŸ 
.
ŸŸ 

ResetState
ŸŸ $
(
ŸŸ$ %
)
ŸŸ% &
;
ŸŸ& '
}
⁄⁄ 	
return
‹‹ 
newViewModel
‹‹ 
;
‹‹ 
}
›› 
private
ﬂﬂ 
void
ﬂﬂ #
InitializeVersionInfo
ﬂﬂ &
(
ﬂﬂ& '
)
ﬂﬂ' (
{
‡‡ 

AppVersion
·· 
=
·· 
VersionHelper
·· "
.
··" ##
GetApplicationVersion
··# 8
(
··8 9
)
··9 :
;
··: ;
Option
‚‚ 
<
‚‚ 
	BuildInfo
‚‚ 
>
‚‚ 
	buildInfo
‚‚ #
=
‚‚$ %
VersionHelper
‚‚& 3
.
‚‚3 4
GetBuildInfo
‚‚4 @
(
‚‚@ A
)
‚‚A B
;
‚‚B C
	buildInfo
„„ 
.
„„ 
Select
„„ 
(
„„ 
bi
„„ 
=>
„„ 
bi
„„ !
.
„„! "
BuildNumber
„„" -
)
„„- .
.
„„. /
GetValueOrDefault
„„/ @
(
„„@ A
$str
„„A N
)
„„N O
;
„„O P
FullVersionInfo
ÂÂ 
=
ÂÂ 
	buildInfo
ÂÂ #
.
ÂÂ# $
Match
ÂÂ$ )
(
ÂÂ) *
bi
ÊÊ 
=>
ÊÊ 
string
ÊÊ 
.
ÊÊ 
Concat
ÊÊ 
(
ÊÊ  
VersionHelper
ÁÁ 
.
ÁÁ 
GetDisplayVersion
ÁÁ /
(
ÁÁ/ 0
)
ÁÁ0 1
,
ÁÁ1 2
$str
ËË 
,
ËË 
bi
ËË 
.
ËË  
BuildNumber
ËË  +
,
ËË+ ,
$str
ÈÈ 
,
ÈÈ 
bi
ÈÈ  
.
ÈÈ  !
	GitCommit
ÈÈ! *
[
ÈÈ* +
..
ÈÈ+ -
$num
ÈÈ- .
]
ÈÈ. /
,
ÈÈ/ 0
$str
ÍÍ 
,
ÍÍ 
bi
ÍÍ  
.
ÍÍ  !
	GitBranch
ÍÍ! *
)
ÍÍ* +
,
ÍÍ+ ,
VersionHelper
ÎÎ 
.
ÎÎ 
GetDisplayVersion
ÎÎ +
)
ÎÎ+ ,
;
ÎÎ, -
}
ÏÏ 
private
ÓÓ 
void
ÓÓ  
InitializeCommands
ÓÓ #
(
ÓÓ# $ 
IApplicationRouter
ÓÓ$ 6
router
ÓÓ7 =
)
ÓÓ= >
{
ÔÔ 
Navigate
 
=
 
ReactiveCommand
 "
.
" #
Create
# )
<
) * 
MembershipViewType
* <
,
< = 
IRoutableViewModel
> P
>
P Q
(
Q R
ExecuteNavigate
R a
)
a b
;
b c
NavigateBack
ÒÒ 
=
ÒÒ 
ReactiveCommand
ÒÒ &
.
ÒÒ& '
Create
ÒÒ' -
(
ÒÒ- .!
ExecuteNavigateBack
ÒÒ. A
)
ÒÒA B
;
ÒÒB C0
"CheckCountryCultureMismatchCommand
ÚÚ *
=
ÚÚ+ ,
ReactiveCommand
ÚÚ- <
.
ÚÚ< =
CreateFromTask
ÚÚ= K
(
ÚÚK L
async
ÚÚL Q
(
ÚÚR S
)
ÚÚS T
=>
ÚÚU W
{
ÛÛ 	
await
ÙÙ .
 CheckCountryCultureMismatchAsync
ÙÙ 2
(
ÙÙ2 3
)
ÙÙ3 4
;
ÙÙ4 5
return
ıı 
Unit
ıı 
.
ıı 
Default
ıı 
;
ıı  
}
ˆˆ 	
)
ˆˆ	 

;
ˆˆ
 '
SwitchToMainWindowCommand
˜˜ !
=
˜˜" #
ReactiveCommand
˜˜$ 3
.
˜˜3 4
CreateFromTask
˜˜4 B
(
˜˜B C
async
˜˜C H
(
˜˜I J
)
˜˜J K
=>
˜˜L N
{
¯¯ 	
IModuleManager
˘˘ 
?
˘˘ 
moduleManager
˘˘ )
=
˘˘* +
Locator
˘˘, 3
.
˘˘3 4
Current
˘˘4 ;
.
˘˘; <

GetService
˘˘< F
<
˘˘F G
IModuleManager
˘˘G U
>
˘˘U V
(
˘˘V W
)
˘˘W X
;
˘˘X Y
if
˙˙ 
(
˙˙ 
moduleManager
˙˙ 
==
˙˙  
null
˙˙! %
)
˙˙% &
{
˚˚ 
Log
¸¸ 
.
¸¸ 
Error
¸¸ 
(
¸¸ 
$str
¸¸ J
)
¸¸J K
;
¸¸K L
return
˝˝ 
;
˝˝ 
}
˛˛ 
Option
ÄÄ 
<
ÄÄ 
IModule
ÄÄ 
>
ÄÄ 
mainModuleOption
ÄÄ ,
=
ÄÄ- .
await
ÄÄ/ 4
moduleManager
ÄÄ5 B
.
ÄÄB C
LoadModuleAsync
ÄÄC R
(
ÄÄR S
$str
ÄÄS Y
)
ÄÄY Z
;
ÄÄZ [
if
ÅÅ 
(
ÅÅ 
!
ÅÅ 
mainModuleOption
ÅÅ !
.
ÅÅ! "
IsSome
ÅÅ" (
)
ÅÅ( )
{
ÇÇ 
Log
ÉÉ 
.
ÉÉ 
Error
ÉÉ 
(
ÉÉ 
$str
ÉÉ H
)
ÉÉH I
;
ÉÉI J
return
ÑÑ 
;
ÑÑ 
}
ÖÖ '
CleanupAuthenticationFlow
áá %
(
áá% &
)
áá& '
;
áá' (
await
àà 
router
àà 
.
àà !
NavigateToMainAsync
àà ,
(
àà, -
)
àà- .
;
àà. /
}
ââ 	
)
ââ	 

;
ââ
 &
OpenPrivacyPolicyCommand
ää  
=
ää! "
ReactiveCommand
ää# 2
.
ää2 3
Create
ää3 9
(
ää9 :
(
ää: ;
)
ää; <
=>
ää= ?
OpenUrl
ää@ G
(
ääG H
	_settings
ääH Q
.
ääQ R
PrivacyPolicyUrl
ääR b
)
ääb c
)
ääc d
;
ääd e'
OpenTermsOfServiceCommand
ãã !
=
ãã" #
ReactiveCommand
ãã$ 3
.
ãã3 4
Create
ãã4 :
(
ãã: ;
(
ãã; <
)
ãã< =
=>
ãã> @
OpenUrl
ããA H
(
ããH I
	_settings
ããI R
.
ããR S
TermsOfServiceUrl
ããS d
)
ããd e
)
ããe f
;
ããf g 
OpenSupportCommand
åå 
=
åå 
ReactiveCommand
åå ,
.
åå, -
Create
åå- 3
(
åå3 4
(
åå4 5
)
åå5 6
=>
åå7 9
OpenUrl
åå: A
(
ååA B
	_settings
ååB K
.
ååK L

SupportUrl
ååL V
)
ååV W
)
ååW X
;
ååX Y
}
çç 
private
èè  
IRoutableViewModel
èè 
ExecuteNavigate
èè .
(
èè. / 
MembershipViewType
èè/ A
viewType
èèB J
)
èèJ K
{
êê  
IRoutableViewModel
ëë 
	viewModel
ëë $
=
ëë% &)
GetOrCreateViewModelForView
ëë' B
(
ëëB C
viewType
ëëC K
)
ëëK L
;
ëëL M
if
ìì 

(
ìì 
_currentView
ìì 
!=
ìì 
null
ìì  
)
ìì  !
{
îî 	
_navigationStack
ïï 
.
ïï 
Push
ïï !
(
ïï! "
_currentView
ïï" .
)
ïï. /
;
ïï/ 0
}
ññ 	
CurrentView
òò 
=
òò 
	viewModel
òò 
;
òò  
return
öö 
	viewModel
öö 
;
öö 
}
õõ 
private
ùù  
IRoutableViewModel
ùù 
?
ùù !
ExecuteNavigateBack
ùù  3
(
ùù3 4
)
ùù4 5
{
ûû 
if
üü 

(
üü 
_navigationStack
üü 
.
üü 
Count
üü "
>
üü# $
$num
üü% &
)
üü& '
{
†† 	
if
°° 
(
°° 
_currentView
°° 
is
°° 
IResettable
°°  +

resettable
°°, 6
)
°°6 7
{
¢¢ 

resettable
££ 
.
££ 

ResetState
££ %
(
££% &
)
££& '
;
££' (
}
§§  
IRoutableViewModel
¶¶ 
previousView
¶¶ +
=
¶¶, -
_navigationStack
¶¶. >
.
¶¶> ?
Pop
¶¶? B
(
¶¶B C
)
¶¶C D
;
¶¶D E
if
®® 
(
®® 
previousView
®® 
is
®® 
IResettable
®®  + 
previousResettable
®®, >
)
®®> ?
{
©©  
previousResettable
™™ "
.
™™" #

ResetState
™™# -
(
™™- .
)
™™. /
;
™™/ 0
}
´´ 
_currentView
≠≠ 
=
≠≠ 
previousView
≠≠ '
;
≠≠' (
this
ÆÆ 
.
ÆÆ "
RaisePropertyChanged
ÆÆ %
(
ÆÆ% &
nameof
ÆÆ& ,
(
ÆÆ, -
CurrentView
ÆÆ- 8
)
ÆÆ8 9
)
ÆÆ9 :
;
ÆÆ: ;
CanNavigateBack
ØØ 
=
ØØ 
_navigationStack
ØØ .
.
ØØ. /
Count
ØØ/ 4
>
ØØ5 6
$num
ØØ7 8
;
ØØ8 9
return
±± 
previousView
±± 
;
±±  
}
≤≤ 	
return
¥¥ 
null
¥¥ 
;
¥¥ 
}
µµ 
private
∑∑ 
void
∑∑ %
SetupActivationBehavior
∑∑ (
(
∑∑( )
)
∑∑) *
{
∏∏ 
this
ππ 
.
ππ 
WhenActivated
ππ 
(
ππ 
disposables
ππ &
=>
ππ' )
{
∫∫ 	"
_connectivityService
ªª  
.
ªª  !$
OnManualRetryRequested
ªª! 7
(
ªª7 8-
HandleManualRetryRequestedAsync
ªª8 W
)
ªªW X
.
ºº 
DisposeWith
ºº 
(
ºº 
disposables
ºº (
)
ºº( )
;
ºº) *

Observable
ΩΩ 
.
ΩΩ 
Timer
ΩΩ 
(
ΩΩ 
TimeSpan
ΩΩ %
.
ΩΩ% &
FromSeconds
ΩΩ& 1
(
ΩΩ1 2
$num
ΩΩ2 3
)
ΩΩ3 4
,
ΩΩ4 5
RxApp
ΩΩ6 ;
.
ΩΩ; <!
MainThreadScheduler
ΩΩ< O
)
ΩΩO P
.
ææ 

SelectMany
ææ 
(
ææ 
_
ææ 
=>
ææ  0
"CheckCountryCultureMismatchCommand
ææ! C
.
ææC D
Execute
ææD K
(
ææK L
)
ææL M
)
ææM N
.
øø 
	Subscribe
øø 
(
øø 
_
øø 
=>
øø 
{
øø  !
}
øø" #
)
øø# $
.
¿¿ 
DisposeWith
¿¿ 
(
¿¿ 
disposables
¿¿ (
)
¿¿( )
;
¿¿) *
Navigate
¡¡ 
.
¡¡ 
Execute
¡¡ 
(
¡¡  
MembershipViewType
¡¡ /
.
¡¡/ 0
WelcomeView
¡¡0 ;
)
¡¡; <
.
¬¬ 
	Subscribe
¬¬ 
(
¬¬ 
_
¬¬ 
=>
¬¬ 
{
¬¬  !
}
¬¬" #
)
¬¬# $
.
√√ 
DisposeWith
√√ 
(
√√ 
disposables
√√ (
)
√√( )
;
√√) *
}
ƒƒ 	
)
ƒƒ	 

;
ƒƒ
 
}
≈≈ 
private
«« 
async
«« 
Task
«« -
HandleManualRetryRequestedAsync
«« 6
(
««6 7'
ManualRetryRequestedEvent
««7 P
e
««Q R
)
««R S
{
»» 
Result
…… 
<
…… 
	Utilities
…… 
.
…… 
Unit
…… 
,
…… 
NetworkFailure
…… -
>
……- .
recoveryResult
……/ =
=
……> ?
await
   
_networkProvider
   "
.
  " #'
ForceFreshConnectionAsync
  # <
(
  < =
)
  = >
;
  > ?
if
ÃÃ 

(
ÃÃ 
recoveryResult
ÃÃ 
.
ÃÃ 
IsOk
ÃÃ 
)
ÃÃ  
{
ÕÕ 	 
ConnectivityIntent
ŒŒ 
intent
ŒŒ %
=
ŒŒ& ' 
ConnectivityIntent
œœ "
.
œœ" #
	Connected
œœ# ,
(
œœ, -
e
œœ- .
.
œœ. /
	ConnectId
œœ/ 8
,
œœ8 9 
ConnectivityReason
œœ: L
.
œœL M
ManualRetry
œœM X
)
œœX Y
with
–– 
{
—— 
Source
““ 
=
““  
ConnectivitySource
““ /
.
““/ 0
ManualAction
““0 <
}
”” 
;
”” 
await
‘‘ "
_connectivityService
‘‘ &
.
‘‘& '
PublishAsync
‘‘' 3
(
‘‘3 4
intent
‘‘4 :
)
‘‘: ;
;
‘‘; <
}
’’ 	
}
÷÷ 
}◊◊ ∫
ã/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Common/MembershipViewType.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Common0 6
;6 7
public 
enum 
MembershipViewType 
{ 
WelcomeView 
, 

SignInView 
, "
MobileVerificationView 
, 
OtpVerificationView 
, %
SecureKeyConfirmationView		 
,		 

PinSetView

 
} ê
í/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Common/AuthenticationFlowContext.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Common0 6
;6 7
public 
enum %
AuthenticationFlowContext %
{ 
Registration 
, 
SecureKeyRecovery 
} ø
Ü/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/AuthenticationModule.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
;/ 0
public 
record (
AuthenticationModuleManifest *
(* +
)+ ,
:- .
ModuleManifest/ =
(= >
Priority		 
:		 
$num		 
,		 
LoadingStrategy

 
:

 !
ModuleLoadingStrategy

 *
.

* +
Eager

+ 0
,

0 1
Dependencies 
: 
[ 
] 
) 
; 
public 
class  
AuthenticationModule !
:" #

ModuleBase$ .
<. /(
AuthenticationModuleManifest/ K
>K L
{ 
public 

override 
ModuleIdentifier $
Id% '
=>( *
ModuleIdentifier+ ;
.; <
Authentication< J
;J K
public 

override (
AuthenticationModuleManifest 0
Manifest1 9
{: ;
get< ?
;? @
}A B
=C D
newE H
(H I
)I J
;J K
public 

override 
async 
Task %
SetupMessageHandlersAsync 8
(8 9
IModuleMessageBus9 J

messageBusK U
)U V
{ 
await 

messageBus 
. 
PublishAsync %
(% &
new& )"
ModuleInitializedEvent* @
{ 	

ModuleName 
= 
Id 
. 
ToName "
(" #
)# $
} 	
)	 

;
 
} 
} –
y/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Utilities/DisposableAction.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Utilities &
;& '
internal 
sealed	 
class 
DisposableAction &
(& '
Action' -
action. 4
)4 5
:6 7
IDisposable8 C
{ 
private 
bool 
	_disposed 
; 
public		 

void		 
Dispose		 
(		 
)		 
{

 
if 

( 
	_disposed 
) 
{ 	
return 
; 
} 	
	_disposed 
= 
true 
; 
action 
( 
) 
; 
} 
} Ø¢
q/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/MVVM/ViewModelBase.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
MVVM !
;! "
public 
abstract 
class 
ViewModelBase #
:$ %
ReactiveObject& 4
,4 5
IDisposable6 A
,A B!
IActivatableViewModelC X
{ 
private 
bool 
_disposedValue 
;  
private &
ObservableAsPropertyHelper &
<& '
bool' +
>+ ,
?, -%
_connectivitySubscription. G
;G H
	protected 
ViewModelBase 
( 
NetworkProvider +
networkProvider, ;
,; < 
ILocalizationService 
localizationService 0
,0 1 
IConnectivityService 
? 
connectivityService 1
=2 3
null4 8
)8 9
{   
NetworkProvider!! 
=!! 
networkProvider!! )
;!!) *
LocalizationService"" 
="" 
localizationService"" 1
;""1 2
LanguageChanged$$ 
=$$ 

Observable$$ $
.$$$ %
	FromEvent$$% .
($$. /
handler%% 
=>%% 
localizationService%% .
.%%. /
LanguageChanged%%/ >
+=%%? A
handler%%B I
,%%I J
handler&& 
=>&& 
localizationService&& .
.&&. /
LanguageChanged&&/ >
-=&&? A
handler&&B I
)'' 
.(( 
	StartWith(( 
((( 
SystemU(( 
.(( 
Default(( &
)((& '
.)) 
Publish)) 
()) 
))) 
.** 
RefCount** 
(** 
)** 
;** 
if,, 

(,, 
connectivityService,, 
!=,,  "
null,,# '
),,' (
{-- 	
IObservable.. 
<.. 
bool.. 
>.. 
networkStatusStream.. 1
=..2 3
connectivityService..4 G
...G H
ConnectivityStream..H Z
.// 
Select// 
(// 
IsNetworkInOutage// )
)//) *
.00 
	StartWith00 
(00 
IsNetworkInOutage00 ,
(00, -
connectivityService00- @
.00@ A
CurrentSnapshot00A P
)00P Q
)00Q R
.11  
DistinctUntilChanged11 %
(11% &
)11& '
;11' (%
_connectivitySubscription33 %
=33& '
networkStatusStream33( ;
.33; <
ToPropertyEx33< H
(33H I
this33I M
,33M N
x33O P
=>33Q S
x33T U
.33U V
IsInNetworkOutage33V g
)33g h
;33h i
}44 	
this66 
.66 
WhenActivated66 
(66 
disposables66 &
=>66' )
{77 	
LanguageChanged88 
.99 
Do99 
(99 
_99 
=>99 
this99 
.99  
RaisePropertyChanged99 2
(992 3
string993 9
.999 :
Empty99: ?
)99? @
)99@ A
.:: 
	Subscribe:: 
(:: 
):: 
.;; 
DisposeWith;; 
(;; 
disposables;; (
);;( )
;;;) *
}<< 	
)<<	 

;<<
 
}== 
public?? 
 
ILocalizationService?? 
LocalizationService??  3
{??4 5
get??6 9
;??9 :
}??; <
public@@ 

ViewModelActivator@@ 
	Activator@@ '
{@@( )
get@@* -
;@@- .
}@@/ 0
=@@1 2
new@@3 6
(@@6 7
)@@7 8
;@@8 9
[BB  
ObservableAsPropertyBB 
]BB 
publicBB !
boolBB" &
IsInNetworkOutageBB' 8
{BB9 :
getBB; >
;BB> ?
}BB@ A
	protectedDD 
NetworkProviderDD 
NetworkProviderDD -
{DD. /
getDD0 3
;DD3 4
}DD5 6
	protectedEE 
IObservableEE 
<EE 
SystemUEE !
>EE! "
LanguageChangedEE# 2
{EE3 4
getEE5 8
;EE8 9
}EE: ;
	protectedGG 
uintGG 
ComputeConnectIdGG #
(GG# $
PubKeyExchangeTypeGG$ 6
pubKeyExchangeTypeGG7 I
)GGI J
{HH 
uintII 
	connectIdII 
=II 
NetworkProviderJJ 
.JJ "
ComputeUniqueConnectIdJJ 2
(JJ2 3
NetworkProviderJJ3 B
.JJB C'
ApplicationInstanceSettingsJJC ^
,JJ^ _
pubKeyExchangeTypeKK "
)KK" #
;KK# $
returnMM 
	connectIdMM 
;MM 
}NN 
	protectedPP 

MembershipPP 

MembershipPP #
(PP# $
)PP$ %
=>PP& (
NetworkProviderQQ 
.QQ '
ApplicationInstanceSettingsQQ 3
.QQ3 4

MembershipQQ4 >
;QQ> ?
publicSS 

stringSS &
GetLocalizedWarningMessageSS ,
(SS, - 
CharacterWarningTypeSS- A
warningTypeSSB M
)SSM N
{TT 
returnUU 
warningTypeUU 
switchUU !
{VV 	 
CharacterWarningTypeWW  
.WW  !
NonLatinLetterWW! /
=>WW0 2
LocalizationServiceWW3 F
[WWF G
$strWWG t
]WWt u
,WWu v 
CharacterWarningTypeXX  
.XX  !
InvalidCharacterXX! 1
=>XX2 4
LocalizationServiceXX5 H
[XXH I
$strYY ?
]YY? @
,YY@ A 
CharacterWarningTypeZZ  
.ZZ  !
MultipleCharactersZZ! 3
=>ZZ4 6
LocalizationServiceZZ7 J
[ZZJ K
$str[[ A
][[A B
,[[B C
_\\ 
=>\\ 
LocalizationService\\ $
[\\$ %
$str\\% T
]\\T U
}]] 	
;]]	 

}^^ 
	protected`` 
void`` '
ShowServerErrorNotification`` .
(``. /#
AuthenticationViewModel``/ F

hostWindow``G Q
,``Q R
string``S Y
errorMessage``Z f
)``f g
{aa 
ifbb 

(bb 
stringbb 
.bb 
IsNullOrEmptybb  
(bb  !
errorMessagebb! -
)bb- .
)bb. /
{cc 	
returndd 
;dd 
}ee 	%
UserRequestErrorViewModelgg !
errorViewModelgg" 0
=gg1 2
newgg3 6
(gg6 7
errorMessagegg7 C
,ggC D
LocalizationServiceggE X
)ggX Y
;ggY Z 
UserRequestErrorViewhh 
	errorViewhh &
=hh' (
newhh) ,
(hh, -
)hh- .
{hh/ 0
DataContexthh1 <
=hh= >
errorViewModelhh? M
}hhN O
;hhO P
Taskjj 
.jj 
Runjj 
(jj 
asyncjj 
(jj 
)jj 
=>jj 
{kk 	
tryll 
{mm 
awaitnn 

hostWindownn  
.nn  !
ShowBottomSheetnn! 0
(nn0 1$
BottomSheetComponentTypeoo ,
.oo, -
UserRequestErroroo- =
,oo= >
	errorViewpp 
,pp 
	showScrimqq 
:qq 
falseqq $
,qq$ %
isDismissablerr !
:rr! "
truerr# '
)rr' (
;rr( )
}ss 
catchtt 
(tt 
	Exceptiontt 
extt 
)tt  
{uu 
Serilogvv 
.vv 
Logvv 
.vv 
Errorvv !
(vv! "
exvv" $
,vv$ %
$strvv& j
)vvj k
;vvk l
}ww 
}xx 	
)xx	 

.xx
 
ContinueWithxx 
(xx 
taskyy 
=>yy 
{zz 
if{{ 
({{ 
task{{ 
.{{ 
	IsFaulted{{ "
&&{{# %
task{{& *
.{{* +
	Exception{{+ 4
!={{5 7
null{{8 <
){{< =
{|| 
Serilog}} 
.}} 
Log}} 
.}}  
Error}}  %
(}}% &
task}}& *
.}}* +
	Exception}}+ 4
,}}4 5
$str	}}6 ã
)
}}ã å
;
}}å ç
}~~ 
} 
, 
TaskScheduler
ÄÄ 
.
ÄÄ 
Default
ÄÄ !
)
ÄÄ! "
;
ÄÄ" #
}
ÅÅ 
	protected
ÉÉ 
void
ÉÉ &
ShowRedirectNotification
ÉÉ +
(
ÉÉ+ ,%
AuthenticationViewModel
ÉÉ, C

hostWindow
ÉÉD N
,
ÉÉN O
string
ÉÉP V
message
ÉÉW ^
,
ÉÉ^ _
int
ÉÉ` c
seconds
ÉÉd k
,
ÉÉk l
Action
ÑÑ 

onComplete
ÑÑ 
)
ÑÑ 
{
ÖÖ 
if
ÜÜ 

(
ÜÜ 
_disposedValue
ÜÜ 
)
ÜÜ 
{
áá 	

onComplete
àà 
(
àà 
)
àà 
;
àà 
return
ââ 
;
ââ 
}
ää 	+
RedirectNotificationViewModel
åå %
redirectViewModel
åå& 7
=
åå8 9
new
åå: =
(
åå= >
message
åå> E
,
ååE F
seconds
ååG N
,
ååN O

onComplete
ååP Z
,
ååZ [!
LocalizationService
åå\ o
)
ååo p
;
ååp q&
RedirectNotificationView
çç  
redirectView
çç! -
=
çç. /
new
çç0 3
(
çç3 4
)
çç4 5
{
çç6 7
DataContext
çç8 C
=
ççD E
redirectViewModel
ççF W
}
ççX Y
;
ççY Z
Task
èè 
.
èè 
Run
èè 
(
èè 
async
èè 
(
èè 
)
èè 
=>
èè 
{
êê 	
try
ëë 
{
íí 
if
ìì 
(
ìì 
!
ìì 
_disposedValue
ìì #
)
ìì# $
{
îî 
await
ïï 

hostWindow
ïï $
.
ïï$ %
ShowBottomSheet
ïï% 4
(
ïï4 5&
BottomSheetComponentType
ïï5 M
.
ïïM N"
RedirectNotification
ïïN b
,
ïïb c
redirectView
ïïd p
,
ïïp q
	showScrim
ññ !
:
ññ! "
true
ññ# '
,
ññ' (
isDismissable
ññ) 6
:
ññ6 7
false
ññ8 =
)
ññ= >
;
ññ> ?
}
óó 
else
òò 
{
ôô 

onComplete
öö 
(
öö 
)
öö  
;
öö  !
}
õõ 
}
úú 
catch
ùù 
(
ùù 
	Exception
ùù 
ex
ùù 
)
ùù  
{
ûû 
Serilog
üü 
.
üü 
Log
üü 
.
üü 
Error
üü !
(
üü! "
ex
üü" $
,
üü$ %
$str
üü& m
)
üüm n
;
üün o

onComplete
†† 
(
†† 
)
†† 
;
†† 
}
°° 
}
¢¢ 	
)
¢¢	 

.
¢¢
 
ContinueWith
¢¢ 
(
¢¢ 
task
££ 
=>
££ 
{
§§ 
if
•• 
(
•• 
task
•• 
.
•• 
	IsFaulted
•• "
&&
••# %
task
••& *
.
••* +
	Exception
••+ 4
!=
••5 7
null
••8 <
)
••< =
{
¶¶ 
Serilog
ßß 
.
ßß 
Log
ßß 
.
ßß  
Error
ßß  %
(
ßß% &
task
ßß& *
.
ßß* +
	Exception
ßß+ 4
,
ßß4 5
$strßß6 à
)ßßà â
;ßßâ ä

onComplete
®® 
(
®® 
)
®®  
;
®®  !
}
©© 
}
™™ 
,
™™ 
TaskScheduler
´´ 
.
´´ 
Default
´´ !
)
´´! "
;
´´" #
}
¨¨ 
	protected
ÆÆ 
static
ÆÆ 
void
ÆÆ  
CleanupAndNavigate
ÆÆ ,
(
ÆÆ, -%
AuthenticationViewModel
ÆÆ- D"
membershipHostWindow
ÆÆE Y
,
ÆÆY Z 
MembershipViewType
ÆÆ[ m

targetView
ÆÆn x
)
ÆÆx y
{
ØØ "
membershipHostWindow
∞∞ 
.
∞∞ "
ClearNavigationStack
∞∞ 1
(
∞∞1 2
)
∞∞2 3
;
∞∞3 4"
membershipHostWindow
±± 
.
±± 
Navigate
±± %
.
±±% &
Execute
±±& -
(
±±- .

targetView
±±. 8
)
±±8 9
.
±±9 :
	Subscribe
±±: C
(
±±C D
)
±±D E
;
±±E F
Task
≥≥ 
.
≥≥ 
Run
≥≥ 
(
≥≥ 
async
≥≥ 
(
≥≥ 
)
≥≥ 
=>
≥≥ 
{
¥¥ 	
try
µµ 
{
∂∂ 
await
∑∑ "
membershipHostWindow
∑∑ *
.
∑∑* +"
HideBottomSheetAsync
∑∑+ ?
(
∑∑? @
)
∑∑@ A
;
∑∑A B
}
∏∏ 
catch
ππ 
(
ππ 
	Exception
ππ 
ex
ππ 
)
ππ  
{
∫∫ 
Serilog
ªª 
.
ªª 
Log
ªª 
.
ªª 
Error
ªª !
(
ªª! "
ex
ªª" $
,
ªª$ %
$str
ªª& e
)
ªªe f
;
ªªf g
}
ºº 
}
ΩΩ 	
)
ΩΩ	 

.
ΩΩ
 
ContinueWith
ΩΩ 
(
ΩΩ 
task
ææ 
=>
ææ 
{
øø 
if
¿¿ 
(
¿¿ 
task
¿¿ 
.
¿¿ 
	IsFaulted
¿¿ "
&&
¿¿# %
task
¿¿& *
.
¿¿* +
	Exception
¿¿+ 4
!=
¿¿5 7
null
¿¿8 <
)
¿¿< =
{
¡¡ 
Serilog
¬¬ 
.
¬¬ 
Log
¬¬ 
.
¬¬  
Error
¬¬  %
(
¬¬% &
task
¬¬& *
.
¬¬* +
	Exception
¬¬+ 4
,
¬¬4 5
$str¬¬6 Ç
)¬¬Ç É
;¬¬É Ñ
}
√√ 
}
ƒƒ 
,
ƒƒ 
TaskScheduler
≈≈ 
.
≈≈ 
Default
≈≈ !
)
≈≈! "
;
≈≈" #
}
∆∆ 
	protected
»» 
string
»» &
GetSecureKeyLocalization
»» -
(
»»- .'
AuthenticationFlowContext
»». G
flowContext
»»H S
,
»»S T
string
»»U [
registrationKey
»»\ k
,
»»k l
string
»»m s
recoveryKey
»»t 
)»» Ä
=>»»Å É
flowContext»»Ñ è
switch»»ê ñ
{
…… '
AuthenticationFlowContext
   !
.
  ! "
Registration
  " .
=>
  / 1!
LocalizationService
  2 E
[
  E F
registrationKey
  F U
]
  U V
,
  V W'
AuthenticationFlowContext
ÀÀ !
.
ÀÀ! "
SecureKeyRecovery
ÀÀ" 3
=>
ÀÀ4 6!
LocalizationService
ÀÀ7 J
[
ÀÀJ K
recoveryKey
ÀÀK V
]
ÀÀV W
,
ÀÀW X
_
ÃÃ 	
=>
ÃÃ
 !
LocalizationService
ÃÃ  
[
ÃÃ  !
registrationKey
ÃÃ! 0
]
ÃÃ0 1
}
ÕÕ 
;
ÕÕ 
private
œœ 
static
œœ 
bool
œœ 
IsNetworkInOutage
œœ )
(
œœ) *"
ConnectivitySnapshot
œœ* >
snapshot
œœ? G
)
œœG H
=>
œœI K
snapshot
–– 
.
–– 
Status
–– 
is
––  
ConnectivityStatus
–– -
.
––- .
Disconnected
––. :
or
——  
ConnectivityStatus
—— !
.
——! "
ShuttingDown
——" .
or
““  
ConnectivityStatus
““ !
.
““! "

Recovering
““" ,
or
””  
ConnectivityStatus
”” !
.
””! "
RetriesExhausted
””" 2
or
‘‘  
ConnectivityStatus
‘‘ !
.
‘‘! "
Unavailable
‘‘" -
;
‘‘- .
	protected
÷÷ 
static
÷÷ %
CancellationTokenSource
÷÷ ,'
RecreateCancellationToken
÷÷- F
(
÷÷F G
ref
÷÷G J%
CancellationTokenSource
÷÷K b
?
÷÷b c
cts
÷÷d g
)
÷÷g h
{
◊◊ 
try
ÿÿ 
{
ŸŸ 	
cts
⁄⁄ 
?
⁄⁄ 
.
⁄⁄ 
Cancel
⁄⁄ 
(
⁄⁄ 
)
⁄⁄ 
;
⁄⁄ 
}
€€ 	
catch
‹‹ 
(
‹‹ %
ObjectDisposedException
‹‹ &
ex
‹‹' )
)
‹‹) *
{
›› 	
System
ﬁﬁ 
.
ﬁﬁ 
Diagnostics
ﬁﬁ 
.
ﬁﬁ 
Debug
ﬁﬁ $
.
ﬁﬁ$ %
	WriteLine
ﬁﬁ% .
(
ﬁﬁ. /
$"
ﬁﬁ/ 1
$str
ﬁﬁ1 j
{
ﬁﬁj k
ex
ﬁﬁk m
.
ﬁﬁm n
Message
ﬁﬁn u
}
ﬁﬁu v
"
ﬁﬁv w
)
ﬁﬁw x
;
ﬁﬁx y
}
ﬂﬂ 	
cts
·· 
?
·· 
.
·· 
Dispose
·· 
(
·· 
)
·· 
;
·· 
cts
‚‚ 
=
‚‚ 
new
‚‚ %
CancellationTokenSource
‚‚ )
(
‚‚) *
)
‚‚* +
;
‚‚+ ,
return
„„ 
cts
„„ 
;
„„ 
}
‰‰ 
	protected
ÊÊ 
static
ÊÊ %
CancellationTokenSource
ÊÊ ,'
RecreateCancellationToken
ÊÊ- F
(
ÊÊF G
ref
ÊÊG J
Option
ÊÊK Q
<
ÊÊQ R%
CancellationTokenSource
ÊÊR i
>
ÊÊi j
	ctsOption
ÊÊk t
)
ÊÊt u
{
ÁÁ 
	ctsOption
ËË 
.
ËË 
Do
ËË 
(
ËË 
cts
ËË 
=>
ËË 
{
ÈÈ 	
try
ÍÍ 
{
ÎÎ 
cts
ÏÏ 
.
ÏÏ 
Cancel
ÏÏ 
(
ÏÏ 
)
ÏÏ 
;
ÏÏ 
}
ÌÌ 
catch
ÓÓ 
(
ÓÓ %
ObjectDisposedException
ÓÓ *
ex
ÓÓ+ -
)
ÓÓ- .
{
ÔÔ 
System
 
.
 
Diagnostics
 "
.
" #
Debug
# (
.
( )
	WriteLine
) 2
(
2 3
$"
3 5
$str
5 w
{
w x
ex
x z
.
z {
Message{ Ç
}Ç É
"É Ñ
)Ñ Ö
;Ö Ü
}
ÒÒ 
cts
ÚÚ 
.
ÚÚ 
Dispose
ÚÚ 
(
ÚÚ 
)
ÚÚ 
;
ÚÚ 
}
ÛÛ 	
)
ÛÛ	 

;
ÛÛ
 %
CancellationTokenSource
ıı 
newCts
ıı  &
=
ıı' (
new
ıı) ,%
CancellationTokenSource
ıı- D
(
ııD E
)
ııE F
;
ııF G
	ctsOption
ˆˆ 
=
ˆˆ 
Option
ˆˆ 
<
ˆˆ %
CancellationTokenSource
ˆˆ 2
>
ˆˆ2 3
.
ˆˆ3 4
Some
ˆˆ4 8
(
ˆˆ8 9
newCts
ˆˆ9 ?
)
ˆˆ? @
;
ˆˆ@ A
return
˜˜ 
newCts
˜˜ 
;
˜˜ 
}
¯¯ 
	protected
˙˙ 
virtual
˙˙ 
void
˙˙ 
Dispose
˙˙ "
(
˙˙" #
bool
˙˙# '
	disposing
˙˙( 1
)
˙˙1 2
{
˚˚ 
if
¸¸ 

(
¸¸ 
_disposedValue
¸¸ 
)
¸¸ 
{
˝˝ 	
return
˛˛ 
;
˛˛ 
}
ˇˇ 	
if
ÅÅ 

(
ÅÅ 
	disposing
ÅÅ 
)
ÅÅ 
{
ÇÇ 	'
_connectivitySubscription
ÉÉ %
?
ÉÉ% &
.
ÉÉ& '
Dispose
ÉÉ' .
(
ÉÉ. /
)
ÉÉ/ 0
;
ÉÉ0 1'
_connectivitySubscription
ÑÑ %
=
ÑÑ& '
null
ÑÑ( ,
;
ÑÑ, -
}
ÖÖ 	
_disposedValue
áá 
=
áá 
true
áá 
;
áá 
}
àà 
public
ää 

void
ää 
Dispose
ää 
(
ää 
)
ää 
{
ãã 
Dispose
åå 
(
åå 
	disposing
åå 
:
åå 
true
åå 
)
åå  
;
åå  !
GC
çç 

.
çç
 
SuppressFinalize
çç 
(
çç 
this
çç  
)
çç  !
;
çç! "
}
éé 
}èè ·;
o/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/MVVM/ViewLocator.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
MVVM !
;! "
public

 
sealed

 
class

 
ViewLocator

 
:

  !
IViewLocator

" .
{ 
private 
readonly  
ConcurrentDictionary )
<) *
Type* .
,. /
Func0 4
<4 5
object5 ;
>; <
>< =
_viewFactories> L
=M N
newO R
(R S
)S T
;T U
public 

void 
Register 
< 

TViewModel #
,# $
TView% *
>* +
(+ ,
), -
where 

TViewModel 
: 
class  
,  !
IRoutableViewModel" 4
where 
TView 
: 
class 
, 
new  
(  !
)! "
{ 
RegisterFactory 
< 

TViewModel "
>" #
(# $
($ %
)% &
=>' )
new* -
TView. 3
(3 4
)4 5
)5 6
;6 7
} 
public 

void 
RegisterFactory 
<  

TViewModel  *
>* +
(+ ,
Func, 0
<0 1
object1 7
>7 8
factory9 @
)@ A
where 

TViewModel 
: 
class  
,  !
IRoutableViewModel" 4
{ 
_viewFactories 
[ 
typeof 
( 

TViewModel (
)( )
]) *
=+ ,
factory- 4
;4 5
} 
public 

Option 
< 
object 
> 
ResolveView %
<% &

TViewModel& 0
>0 1
(1 2

TViewModel2 <
?< =
	viewModel> G
=H I
nullJ N
)N O
where 

TViewModel 
: 
class  
,  !
IRoutableViewModel" 4
{ 
if 

( 
	viewModel 
== 
null 
) 
{ 	
return   
Option   
<   
object    
>    !
.  ! "
None  " &
;  & '
}!! 	
Type## 
viewModelType## 
=## 
typeof## #
(### $

TViewModel##$ .
)##. /
;##/ 0
if%% 

(%% 
_viewFactories%% 
.%% 
TryGetValue%% &
(%%& '
viewModelType%%' 4
,%%4 5
out%%6 9
Func%%: >
<%%> ?
object%%? E
>%%E F
?%%F G
factory%%H O
)%%O P
)%%P Q
{&& 	
object'' 
view'' 
='' 
factory'' !
(''! "
)''" #
;''# $
return(( 
Option(( 
<(( 
object((  
>((  !
.((! "
Some((" &
(((& '
view((' +
)((+ ,
;((, -
})) 	
Type++ 

actualType++ 
=++ 
	viewModel++ #
.++# $
GetType++$ +
(+++ ,
)++, -
;++- .
if,, 

(,, 

actualType,, 
!=,, 
viewModelType,, '
&&,,( *
_viewFactories,,+ 9
.,,9 :
TryGetValue,,: E
(,,E F

actualType,,F P
,,,P Q
out,,R U
factory,,V ]
),,] ^
),,^ _
{-- 	
object.. 
view.. 
=.. 
factory.. !
(..! "
).." #
;..# $
return// 
Option// 
<// 
object//  
>//  !
.//! "
Some//" &
(//& '
view//' +
)//+ ,
;//, -
}00 	
object22 
?22 

staticView22 
=22 
StaticViewMapper22 -
.22- .

CreateView22. 8
(228 9

actualType229 C
)22C D
;22D E
return33 

staticView33 
.33 
ToOption33 "
(33" #
)33# $
;33$ %
}44 
public66 

Option66 
<66 
object66 
>66 
ResolveView66 %
(66% &
object66& ,
?66, -
	viewModel66. 7
)667 8
{77 
if88 

(88 
	viewModel88 
==88 
null88 
)88 
{99 	
return:: 
Option:: 
<:: 
object::  
>::  !
.::! "
None::" &
;::& '
};; 	
Type== 
viewModelType== 
=== 
	viewModel== &
.==& '
GetType==' .
(==. /
)==/ 0
;==0 1
if?? 

(?? 
_viewFactories?? 
.?? 
TryGetValue?? &
(??& '
viewModelType??' 4
,??4 5
out??6 9
Func??: >
<??> ?
object??? E
>??E F
???F G
factory??H O
)??O P
)??P Q
{@@ 	
objectAA 
viewAA 
=AA 
factoryAA !
(AA! "
)AA" #
;AA# $
returnBB 
OptionBB 
<BB 
objectBB  
>BB  !
.BB! "
SomeBB" &
(BB& '
viewBB' +
)BB+ ,
;BB, -
}CC 	
objectEE 
?EE 

staticViewEE 
=EE 
StaticViewMapperEE -
.EE- .

CreateViewEE. 8
(EE8 9
viewModelTypeEE9 F
)EEF G
;EEG H
returnFF 

staticViewFF 
.FF 
ToOptionFF "
(FF" #
)FF# $
;FF$ %
}GG 
publicII 

boolII 
IsRegisteredII 
<II 

TViewModelII '
>II' (
(II( )
)II) *
whereII+ 0

TViewModelII1 ;
:II< =
classII> C
,IIC D
IRoutableViewModelIIE W
{JJ 
returnKK 
IsRegisteredKK 
(KK 
typeofKK "
(KK" #

TViewModelKK# -
)KK- .
)KK. /
;KK/ 0
}LL 
publicNN 

boolNN 
IsRegisteredNN 
(NN 
TypeNN !
viewModelTypeNN" /
)NN/ 0
{OO 
returnPP 
_viewFactoriesPP 
.PP 
ContainsKeyPP )
(PP) *
viewModelTypePP* 7
)PP7 8
;PP8 9
}QQ 
publicSS 

IReadOnlyDictionarySS 
<SS 
TypeSS #
,SS# $
FuncSS% )
<SS) *
objectSS* 0
>SS0 1
>SS1 2
GetRegistrationsSS3 C
(SSC D
)SSD E
{TT 
returnUU 
newUU 

DictionaryUU 
<UU 
TypeUU "
,UU" #
FuncUU$ (
<UU( )
objectUU) /
>UU/ 0
>UU0 1
(UU1 2
_viewFactoriesUU2 @
)UU@ A
;UUA B
}VV 
}WW ‚%
t/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/MVVM/StaticViewMapper.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
MVVM !
;! "
internal 
static	 
class 
StaticViewMapper &
{ 
private 
static 
readonly 
FrozenDictionary ,
<, -
Type- 1
,1 2
Lazy3 7
<7 8
Func8 <
<< =
Control= D
>D E
>E F
>F G
ViewFactoriesH U
=V W
CreateViewFactories 
( 
) 
. 
ToFrozenDictionary 0
(0 1
)1 2
;2 3
private 
static 

Dictionary 
< 
Type "
," #
Lazy$ (
<( )
Func) -
<- .
Control. 5
>5 6
>6 7
>7 8
CreateViewFactories9 L
(L M
)M N
{ 
return 
new 

Dictionary 
< 
Type "
," #
Lazy$ (
<( )
Func) -
<- .
Control. 5
>5 6
>6 7
>7 8
{ 	
[ 
typeof 
( 
SignInViewModel #
)# $
]$ %
=& '
new( +
(+ ,
(, -
)- .
=>/ 1
(2 3
)3 4
=>5 7
new8 ;

SignInView< F
(F G
)G H
)H I
,I J
[ 
typeof 
( '
MobileVerificationViewModel /
)/ 0
]0 1
=2 3
new4 7
(7 8
(8 9
)9 :
=>; =
(> ?
)? @
=>A C
newD G"
MobileVerificationViewH ^
(^ _
)_ `
)` a
,a b
[ 
typeof 
( 
VerifyOtpViewModel &
)& '
]' (
=) *
new+ .
(. /
(/ 0
)0 1
=>2 4
(5 6
)6 7
=>8 :
new; >%
VerificationCodeEntryView? X
(X Y
)Y Z
)Z [
,[ \
[ 
typeof 
( &
SecureKeyVerifierViewModel .
). /
]/ 0
=1 2
new3 6
(6 7
(7 8
)8 9
=>: <
(= >
)> ?
=>@ B
newC F%
SecureKeyConfirmationViewG `
(` a
)a b
)b c
,c d
[ 
typeof 
( 
PassPhaseViewModel &
)& '
]' (
=) *
new+ .
(. /
(/ 0
)0 1
=>2 4
(5 6
)6 7
=>8 :
new; >
PassPhaseView? L
(L M
)M N
)N O
,O P
[ 
typeof 
( 
WelcomeViewModel $
)$ %
]% &
=' (
new) ,
(, -
(- .
). /
=>0 2
(3 4
)4 5
=>6 8
new9 <
WelcomeView= H
(H I
)I J
)J K
,K L
} 	
;	 

} 
[!! 

MethodImpl!! 
(!! 
MethodImplOptions!! !
.!!! "
AggressiveInlining!!" 4
)!!4 5
]!!5 6
public"" 

static"" 
Control"" 
?"" 

CreateView"" %
(""% &
Type""& *
viewModelType""+ 8
)""8 9
{## 
if$$ 

($$ 
!$$ 
ViewFactories$$ 
.$$ 
TryGetValue$$ &
($$& '
viewModelType$$' 4
,$$4 5
out$$6 9
Lazy$$: >
<$$> ?
Func$$? C
<$$C D
Control$$D K
>$$K L
>$$L M
?$$M N
lazyFactory$$O Z
)$$Z [
)$$[ \
{%% 	
return&& 
null&& 
;&& 
}'' 	
Func)) 
<)) 
Control)) 
>)) 
factory)) 
=)) 
lazyFactory))  +
.))+ ,
Value)), 1
;))1 2
Control** 
result** 
=** 
factory**  
(**  !
)**! "
;**" #
return++ 
result++ 
;++ 
},, 
}-- û
Ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/MVVM/ReactiveUIViewLocatorAdapter.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
MVVM !
;! "
public 
class (
ReactiveUiViewLocatorAdapter )
() *
Abstractions* 6
.6 7
IViewLocator7 C
moduleViewLocatorD U
)U V
:W X
IViewLocatorY e
{ 
[		 (
UnconditionalSuppressMessage		 !
(		! "
$str		" ,
,		, -
$str		. 6
,		6 7
Justification

 
=

 
$str

 d
)

d e
]

e f
public 

IViewFor 
? 
ResolveView  
<  !
T! "
>" #
(# $
T$ %
?% &
	viewModel' 0
,0 1
string2 8
?8 9
contract: B
=C D
nullE I
)I J
{ 
if 

( 
object 
. 
Equals 
( 
	viewModel #
,# $
default% ,
(, -
T- .
). /
)/ 0
)0 1
{ 	
return 
null 
; 
} 	
Option 
< 
object 
> 

viewOption !
=" #
moduleViewLocator$ 5
.5 6
ResolveView6 A
(A B
	viewModelB K
)K L
;L M
if 

( 
! 

viewOption 
. 
IsSome 
) 
{ 	
return 
null 
; 
} 	
object 
view 
= 

viewOption  
.  !
Value! &
!& '
;' (
if 

( 
view 
is 
not 
IViewFor  
viewForInstance! 0
)0 1
{ 	
return 
null 
; 
} 	
viewForInstance   
.   
	ViewModel   !
??=  " %
	viewModel  & /
;  / 0
return!! 
viewForInstance!! 
;!! 
}"" 
}## ∂
u/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/MVVM/ModuleViewFactory.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
MVVM !
;! "
public		 
class		 
ModuleViewFactory		 
:		  
IModuleViewFactory		! 3
{

 
private 
readonly 

Dictionary 
<  
Type  $
,$ %
Func& *
<* +
Control+ 2
>2 3
>3 4

_factories5 ?
=@ A
newB E
(E F
)F G
;G H
public 

void 
RegisterView 
< 

TViewModel '
,' (
TView) .
>. /
(/ 0
)0 1
where 

TViewModel 
: 
class  
where 
TView 
: 
Control 
, 
new "
(" #
)# $
{ 
Type 
vmType 
= 
typeof 
( 

TViewModel '
)' (
;( )

_factories 
[ 
vmType 
] 
= 
( 
) 
=>  "
new# &
TView' ,
(, -
)- .
;. /
} 
public 

Option 
< 
Control 
> 

CreateView %
(% &
Type& *
viewModelType+ 8
)8 9
{ 
return 

_factories 
. 
GetValueOrDefault +
(+ ,
viewModelType, 9
)9 :
.: ;
ToOption; C
(C D
)D E
. 
Select 
( 
factory 
=> 
factory &
(& '
)' (
)( )
;) *
} 
} Ò
u/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/ModuleScope.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
internal 
sealed	 
class 
ModuleScope !
(! "
string" (

moduleName) 3
,3 4
IServiceScope5 B
serviceScopeC O
)O P
:Q R
IModuleScopeS _
{		 
private

 
long

 
	_disposed

 
;

 
public 

IServiceProvider 
ServiceProvider +
{, -
get. 1
;1 2
}3 4
=5 6
serviceScope7 C
.C D
ServiceProviderD S
;S T
public 

string 

ModuleName 
{ 
get "
;" #
}$ %
=& '

moduleName( 2
;2 3
public 

void 
Dispose 
( 
) 
{ 
if 

( 
Interlocked 
. 
CompareExchange '
(' (
ref( +
	_disposed, 5
,5 6
$num7 8
,8 9
$num: ;
); <
=== ?
$num@ A
)A B
{ 	
return 
; 
} 	
serviceScope 
. 
Dispose 
( 
) 
; 
} 
} ¬f
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/ModuleResourceManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
internal

 
sealed

	 
class

  
ModuleServiceContext

 *
(

* +
IServiceProvider

+ ;
parentProvider

< J
)

J K
{ 
public 

T 
GetParentService 
< 
T 
>  
(  !
)! "
where# (
T) *
:+ ,
notnull- 4
=>5 7
parentProvider8 F
.F G
GetRequiredServiceG Y
<Y Z
TZ [
>[ \
(\ ]
)] ^
;^ _
} 
internal 
class	 !
ModuleResourceManager $
($ %
IServiceProvider% 5
serviceProvider6 E
)E F
:G H
IDisposableI T
{ 
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
IModuleScope2 >
>> ?
_moduleScopes@ M
=N O
newP S
(S T
)T U
;U V
private 
bool 
	_disposed 
; 
public 

IModuleScope 
CreateModuleScope )
() *
string* 0

moduleName1 ;
,; <
Action= C
<C D
IServiceCollectionD V
>V W
?W X
configureServicesY j
=k l
nullm q
)q r
{ 
IServiceScope 
serviceScope "
;" #
if 

( 
configureServices 
!=  
null! %
)% &
{ 	
IServiceScope 
parentScope %
=& '
serviceProvider( 7
.7 8
CreateScope8 C
(C D
)D E
;E F
ServiceCollection 
moduleServices ,
=- .
new/ 2
(2 3
)3 4
;4 5 
ModuleServiceContext  
context! (
=) *
new+ .
(. /
parentScope/ :
.: ;
ServiceProvider; J
)J K
;K L
moduleServices 
. 
AddSingleton '
(' (
context( /
)/ 0
;0 1#
AutoForwardCoreServices   #
(  # $
moduleServices  $ 2
,  2 3
context  4 ;
)  ; <
;  < =
configureServices"" 
("" 
moduleServices"" ,
)"", -
;""- .
ServiceProvider$$ !
moduleServiceProvider$$ 1
=$$2 3
moduleServices$$4 B
.$$B C 
BuildServiceProvider$$C W
($$W X
)$$X Y
;$$Y Z
serviceScope%% 
=%% 
new%% !
CompositeServiceScope%% 4
(%%4 5!
moduleServiceProvider%%5 J
,%%J K
parentScope%%L W
)%%W X
;%%X Y
}&& 	
else'' 
{(( 	
serviceScope)) 
=)) 
serviceProvider)) *
.))* +
CreateScope))+ 6
())6 7
)))7 8
;))8 9
}** 	
ModuleScope,, 
moduleScope,, 
=,,  !
new,," %
(,,% &

moduleName,,& 0
,,,0 1
serviceScope,,2 >
),,> ?
;,,? @
if.. 

(.. 
!.. 
_moduleScopes.. 
... 
TryAdd.. !
(..! "

moduleName.." ,
,.., -
moduleScope... 9
)..9 :
)..: ;
{// 	
moduleScope00 
.00 
Dispose00 
(00  
)00  !
;00! "
throw11 
new11 %
InvalidOperationException11 /
(11/ 0
$"110 2
$str112 D
{11D E

moduleName11E O
}11O P
$str11P `
"11` a
)11a b
;11b c
}22 	
Log44 
.44 
Information44 
(44 
$str44 ?
,44? @

moduleName44A K
)44K L
;44L M
return66 
moduleScope66 
;66 
}77 
private99 
static99 
void99 #
AutoForwardCoreServices99 /
(99/ 0
IServiceCollection990 B
moduleServices99C Q
,99Q R 
ModuleServiceContext99S g
context99h o
)99o p
{:: 
moduleServices;; 
.;; 
AddSingleton;; #
(;;# $
context;;$ +
.;;+ ,
GetParentService;;, <
<;;< =
Core;;= A
.;;A B
	Messaging;;B K
.;;K L
Services;;L T
.;;T U 
IConnectivityService;;U i
>;;i j
(;;j k
);;k l
);;l m
;;;m n
moduleServices<< 
.<< 
AddSingleton<< #
(<<# $
context<<$ +
.<<+ ,
GetParentService<<, <
<<<< =
Core<<= A
.<<A B
	Messaging<<B K
.<<K L
Services<<L T
.<<T U
IBottomSheetService<<U h
><<h i
(<<i j
)<<j k
)<<k l
;<<l m
moduleServices== 
.== 
AddSingleton== #
(==# $
context==$ +
.==+ ,
GetParentService==, <
<==< =
Core=== A
.==A B
	Messaging==B K
.==K L
Services==L T
.==T U%
ILanguageDetectionService==U n
>==n o
(==o p
)==p q
)==q r
;==r s
moduleServices>> 
.>> 
AddSingleton>> #
(>># $
context>>$ +
.>>+ ,
GetParentService>>, <
<>>< =
Infrastructure>>= K
.>>K L
Network>>L S
.>>S T
Core>>T X
.>>X Y
	Providers>>Y b
.>>b c
NetworkProvider>>c r
>>>r s
(>>s t
)>>t u
)>>u v
;>>v w
moduleServices?? 
.?? 
AddSingleton?? #
(??# $
context??$ +
.??+ ,
GetParentService??, <
<??< =
Infrastructure??= K
.??K L
Network??L S
.??S T
Abstractions??T `
.??` a
Core??a e
.??e f*
IInternetConnectivityObserver	??f É
>
??É Ñ
(
??Ñ Ö
)
??Ö Ü
)
??Ü á
;
??á à
moduleServices@@ 
.@@ 
AddSingleton@@ #
(@@# $
context@@$ +
.@@+ ,
GetParentService@@, <
<@@< =
Infrastructure@@= K
.@@K L
Network@@L S
.@@S T
Abstractions@@T `
.@@` a
	Transport@@a j
.@@j k 
IRpcMetaDataProvider@@k 
>	@@ Ä
(
@@Ä Å
)
@@Å Ç
)
@@Ç É
;
@@É Ñ
moduleServicesAA 
.AA 
AddSingletonAA #
(AA# $
contextAA$ +
.AA+ ,
GetParentServiceAA, <
<AA< =
InfrastructureAA= K
.AAK L
DataAAL P
.AAP Q
AbstractionsAAQ ]
.AA] ^-
!IApplicationSecureStorageProviderAA^ 
>	AA Ä
(
AAÄ Å
)
AAÅ Ç
)
AAÇ É
;
AAÉ Ñ
moduleServicesBB 
.BB 
AddSingletonBB #
(BB# $
contextBB$ +
.BB+ ,
GetParentServiceBB, <
<BB< =
ServicesBB= E
.BBE F
AbstractionsBBF R
.BBR S
CoreBBS W
.BBW X 
ILocalizationServiceBBX l
>BBl m
(BBm n
)BBn o
)BBo p
;BBp q
moduleServicesCC 
.CC 
AddSingletonCC #
(CC# $
contextCC$ +
.CC+ ,
GetParentServiceCC, <
<CC< =
ServicesCC= E
.CCE F
AbstractionsCCF R
.CCR S
CoreCCS W
.CCW X
IApplicationRouterCCX j
>CCj k
(CCk l
)CCl m
)CCm n
;CCn o
moduleServicesDD 
.DD 
AddSingletonDD #
(DD# $
contextDD$ +
.DD+ ,
GetParentServiceDD, <
<DD< =
ServicesDD= E
.DDE F
AbstractionsDDF R
.DDR S

MembershipDDS ]
.DD] ^
ILogoutServiceDD^ l
>DDl m
(DDm n
)DDn o
)DDo p
;DDp q
moduleServicesEE 
.EE 
AddSingletonEE #
(EE# $
contextEE$ +
.EE+ ,
GetParentServiceEE, <
<EE< =
ServicesEE= E
.EEE F
AbstractionsEEF R
.EER S
AuthenticationEES a
.EEa b"
IAuthenticationServiceEEb x
>EEx y
(EEy z
)EEz {
)EE{ |
;EE| }
moduleServicesFF 
.FF 
AddSingletonFF #
(FF# $
contextFF$ +
.FF+ ,
GetParentServiceFF, <
<FF< =
ServicesFF= E
.FFE F
AbstractionsFFF R
.FFR S
AuthenticationFFS a
.FFa b&
IOpaqueRegistrationServiceFFb |
>FF| }
(FF} ~
)FF~ 
)	FF Ä
;
FFÄ Å
moduleServicesGG 
.GG 
AddSingletonGG #
(GG# $
contextGG$ +
.GG+ ,
GetParentServiceGG, <
<GG< =
ServicesGG= E
.GGE F
AbstractionsGGF R
.GGR S
AuthenticationGGS a
.GGa b%
ISecureKeyRecoveryServiceGGb {
>GG{ |
(GG| }
)GG} ~
)GG~ 
;	GG Ä
moduleServicesHH 
.HH 
AddSingletonHH #
(HH# $
contextHH$ +
.HH+ ,
GetParentServiceHH, <
<HH< =
EcliptixHH= E
.HHE F
CoreHHF J
.HHJ K
ControlsHHK S
.HHS T
CoreHHT X
.HHX Y-
!ConnectivityNotificationViewModelHHY z
>HHz {
(HH{ |
)HH| }
)HH} ~
;HH~ 
LogJJ 
.JJ 
DebugJJ 
(JJ 
$strJJ M
)JJM N
;JJN O
}KK 
publicMM 

boolMM 
RemoveModuleScopeMM !
(MM! "
stringMM" (

moduleNameMM) 3
)MM3 4
{NN 
ifOO 

(OO 
_moduleScopesOO 
.OO 
	TryRemoveOO #
(OO# $

moduleNameOO$ .
,OO. /
outOO0 3
IModuleScopeOO4 @
?OO@ A
scopeOOB G
)OOG H
)OOH I
{PP 	
scopeQQ 
.QQ 
DisposeQQ 
(QQ 
)QQ 
;QQ 
LogRR 
.RR 
InformationRR 
(RR 
$strRR C
,RRC D

moduleNameRRE O
)RRO P
;RRP Q
returnSS 
trueSS 
;SS 
}TT 	
returnVV 
falseVV 
;VV 
}WW 
publicYY 

voidYY 
DisposeYY 
(YY 
)YY 
{ZZ 
Dispose[[ 
([[ 
true[[ 
)[[ 
;[[ 
GC\\ 

.\\
 
SuppressFinalize\\ 
(\\ 
this\\  
)\\  !
;\\! "
}]] 
	protected__ 
virtual__ 
void__ 
Dispose__ "
(__" #
bool__# '
	disposing__( 1
)__1 2
{`` 
ifaa 

(aa 
	_disposedaa 
)aa 
{bb 	
returncc 
;cc 
}dd 	
ifff 

(ff 
	disposingff 
)ff 
{gg 	
foreachhh 
(hh 
KeyValuePairhh !
<hh! "
stringhh" (
,hh( )
IModuleScopehh* 6
>hh6 7
kvphh8 ;
inhh< >
_moduleScopeshh? L
)hhL M
{ii 
tryjj 
{kk 
kvpll 
.ll 
Valuell 
.ll 
Disposell %
(ll% &
)ll& '
;ll' (
}mm 
catchnn 
(nn 
	Exceptionnn  
exnn! #
)nn# $
{oo 
Logpp 
.pp 
Errorpp 
(pp 
expp  
,pp  !
$strpp" Q
,ppQ R
kvpppS V
.ppV W
KeyppW Z
)ppZ [
;pp[ \
}qq 
}rr 
_moduleScopestt 
.tt 
Cleartt 
(tt  
)tt  !
;tt! "
}uu 	
	_disposedww 
=ww 
trueww 
;ww 
}xx 
}yy ßx
w/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/ModuleManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
public 
class 
ModuleManager 
: 
IModuleManager +
{ 
private 
readonly 
IModuleCatalog #
_catalog$ ,
;, -
private 
readonly 
IServiceProvider %
_serviceProvider& 6
;6 7
private 
readonly 
IModuleMessageBus &
_messageBus' 2
;2 3
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
ModuleState2 =
>= >
_moduleStates? L
=M N
newO R
(R S
)S T
;T U
public 

ModuleManager 
( 
IModuleCatalog '
catalog( /
,/ 0
IServiceProvider1 A
serviceProviderB Q
)Q R
{ 
_catalog 
= 
catalog 
; 
_serviceProvider 
= 
serviceProvider *
;* +
_messageBus 
= 
serviceProvider %
.% &

GetService& 0
<0 1
IModuleMessageBus1 B
>B C
(C D
)D E
!E F
;F G
foreach 
( 
IModule 
module 
in  "
_catalog# +
.+ ,

GetModules, 6
(6 7
)7 8
)8 9
{ 	
_moduleStates 
[ 
module  
.  !
Id! #
.# $
ToName$ *
(* +
)+ ,
], -
=. /
ModuleState0 ;
.; <
	NotLoaded< E
;E F
} 	
} 
public   

async   
Task   
<   
Option   
<   
IModule   $
>  $ %
>  % &
LoadModuleAsync  ' 6
(  6 7
string  7 =

moduleName  > H
)  H I
{!! 
Option"" 
<"" 
IModule"" 
>"" 
moduleOption"" $
=""% &
_catalog""' /
.""/ 0
	GetModule""0 9
(""9 :

moduleName"": D
)""D E
;""E F
if## 

(## 
!## 
moduleOption## 
.## 
IsSome##  
)##  !
{$$ 	
Log%% 
.%% 
Warning%% 
(%% 
$str%% D
,%%D E

moduleName%%F P
)%%P Q
;%%Q R
return&& 
Option&& 
<&& 
IModule&& !
>&&! "
.&&" #
None&&# '
;&&' (
}'' 	
IModule)) 
module)) 
=)) 
moduleOption)) %
.))% &
Value))& +
!))+ ,
;)), -
if++ 

(++ 
!++ 
_moduleStates++ 
.++ 
TryGetValue++ &
(++& '

moduleName++' 1
,++1 2
out++3 6
ModuleState++7 B
currentState++C O
)++O P
)++P Q
{,, 	
Log-- 
.-- 
Error-- 
(-- 
$str-- C
,--C D

moduleName--E O
)--O P
;--P Q
return.. 
Option.. 
<.. 
IModule.. !
>..! "
..." #
None..# '
;..' (
}// 	
if11 

(11 
currentState11 
==11 
ModuleState11 '
.11' (
Loaded11( .
)11. /
{22 	
return33 
Option33 
<33 
IModule33 !
>33! "
.33" #
Some33# '
(33' (
module33( .
)33. /
;33/ 0
}44 	
if66 

(66 
!66 
_moduleStates66 
.66 
	TryUpdate66 $
(66$ %

moduleName66% /
,66/ 0
ModuleState661 <
.66< =
Loading66= D
,66D E
currentState66F R
)66R S
)66S T
{77 	
if88 
(88 
_moduleStates88 
.88 
TryGetValue88 )
(88) *

moduleName88* 4
,884 5
out886 9
ModuleState88: E
updatedState88F R
)88R S
&&88T V
updatedState99 
==99 
ModuleState99  +
.99+ ,
Loaded99, 2
)992 3
{:: 
return;; 
Option;; 
<;; 
IModule;; %
>;;% &
.;;& '
Some;;' +
(;;+ ,
module;;, 2
);;2 3
;;;3 4
}<< 
Log>> 
.>> 
Warning>> 
(>> 
$str>> ^
,>>^ _

moduleName>>` j
)>>j k
;>>k l
return?? 
Option?? 
<?? 
IModule?? !
>??! "
.??" #
None??# '
;??' (
}@@ 	
ifBB 

(BB 
!BB 
awaitBB 
moduleBB 
.BB 
CanLoadAsyncBB &
(BB& '
)BB' (
)BB( )
{CC 	
_moduleStatesDD 
[DD 

moduleNameDD $
]DD$ %
=DD& '
ModuleStateDD( 3
.DD3 4
FailedDD4 :
;DD: ;
LogEE 
.EE 
WarningEE 
(EE 
$strEE M
,EEM N

moduleNameEEO Y
)EEY Z
;EEZ [
returnFF 
OptionFF 
<FF 
IModuleFF !
>FF! "
.FF" #
NoneFF# '
;FF' (
}GG 	
awaitII 
moduleII 
.II 
	LoadAsyncII 
(II 
_serviceProviderII /
)II/ 0
;II0 1
_moduleStatesKK 
[KK 

moduleNameKK  
]KK  !
=KK" #
ModuleStateKK$ /
.KK/ 0
LoadedKK0 6
;KK6 7
awaitMM 
moduleMM 
.MM %
SetupMessageHandlersAsyncMM .
(MM. /
_messageBusMM/ :
)MM: ;
;MM; <
returnNN 
OptionNN 
<NN 
IModuleNN 
>NN 
.NN 
SomeNN #
(NN# $
moduleNN$ *
)NN* +
;NN+ ,
}OO 
publicQQ 

asyncQQ 
TaskQQ 
LoadModulesAsyncQQ &
(QQ& '!
ModuleLoadingStrategyQQ' <
strategyQQ= E
)QQE F
{RR 
IModuleSS 
[SS 
]SS 
modulesToLoadSS 
=SS  !
_catalogSS" *
.SS* +

GetModulesSS+ 5
(SS5 6
)SS6 7
.TT 
WhereTT 
(TT 
mTT 
=>TT 
mTT 
.TT 
ManifestTT "
.TT" #
LoadingStrategyTT# 2
==TT3 5
strategyTT6 >
&&TT? A
!TTB C
IsModuleLoadedTTC Q
(TTQ R
mTTR S
.TTS T
IdTTT V
.TTV W
ToNameTTW ]
(TT] ^
)TT^ _
)TT_ `
)TT` a
.UU 
ToArrayUU 
(UU 
)UU 
;UU 
ifWW 

(WW 
modulesToLoadWW 
.WW 
LengthWW  
==WW! #
$numWW$ %
)WW% &
{XX 	
returnYY 
;YY 
}ZZ 	
foreach\\ 
(\\ 
IModule\\ 
module\\ 
in\\  "
modulesToLoad\\# 0
)\\0 1
{]] 	
await^^ 
LoadModuleAsync^^ !
(^^! "
module^^" (
.^^( )
Id^^) +
.^^+ ,
ToName^^, 2
(^^2 3
)^^3 4
)^^4 5
;^^5 6
}__ 	
}`` 
publicbb 

asyncbb 
Taskbb !
LoadEagerModulesAsyncbb +
(bb+ ,
)bb, -
{cc 
awaitdd 
LoadModulesAsyncdd 
(dd !
ModuleLoadingStrategydd 4
.dd4 5
Eagerdd5 :
)dd: ;
;dd; <
}ee 
publicgg 

asyncgg 
Taskgg 
<gg 
IReadOnlyListgg #
<gg# $
IModulegg$ +
>gg+ ,
>gg, -
LoadAllModulesAsyncgg. A
(ggA B
)ggB C
{hh 
IModuleii 
[ii 
]ii 
unloadedModulesii !
=ii" #
_catalogii$ ,
.ii, -

GetModulesii- 7
(ii7 8
)ii8 9
.jj 
Wherejj 
(jj 
mjj 
=>jj 
!jj 
IsModuleLoadedjj '
(jj' (
mjj( )
.jj) *
Idjj* ,
.jj, -
ToNamejj- 3
(jj3 4
)jj4 5
)jj5 6
)jj6 7
.kk 
ToArraykk 
(kk 
)kk 
;kk 
ifmm 

(mm 
unloadedModulesmm 
.mm 
Lengthmm "
==mm# %
$nummm& '
)mm' (
{nn 	
returnoo 
[oo 
]oo 
;oo 
}pp 	
Listrr 
<rr 
IModulerr 
>rr 
loadedModulesrr #
=rr$ %
newrr& )
(rr) *
)rr* +
;rr+ ,
foreachss 
(ss 
IModuless 
moduless 
inss  "
unloadedModulesss# 2
)ss2 3
{tt 	
Optionuu 
<uu 
IModuleuu 
>uu 
resultuu "
=uu# $
awaituu% *
LoadModuleAsyncuu+ :
(uu: ;
moduleuu; A
.uuA B
IduuB D
.uuD E
ToNameuuE K
(uuK L
)uuL M
)uuM N
;uuN O
ifvv 
(vv 
resultvv 
.vv 
IsSomevv 
)vv 
{ww 
loadedModulesxx 
.xx 
Addxx !
(xx! "
resultxx" (
.xx( )
Valuexx) .
!xx. /
)xx/ 0
;xx0 1
}yy 
}zz 	
return|| 
loadedModules|| 
;|| 
}}} 
public 

void %
StartBackgroundPreloading )
() *
)* +
{
ÄÄ 
IModule
ÅÅ 
[
ÅÅ 
]
ÅÅ 
backgroundModules
ÅÅ #
=
ÅÅ$ %
_catalog
ÅÅ& .
.
ÅÅ. /

GetModules
ÅÅ/ 9
(
ÅÅ9 :
)
ÅÅ: ;
.
ÇÇ 
Where
ÇÇ 
(
ÇÇ 
m
ÇÇ 
=>
ÇÇ 
m
ÇÇ 
.
ÇÇ 
Manifest
ÇÇ "
.
ÇÇ" #
LoadingStrategy
ÇÇ# 2
==
ÇÇ3 5#
ModuleLoadingStrategy
ÇÇ6 K
.
ÇÇK L

Background
ÇÇL V
&&
ÇÇW Y
!
ÉÉ 
IsModuleLoaded
ÉÉ '
(
ÉÉ' (
m
ÉÉ( )
.
ÉÉ) *
Id
ÉÉ* ,
.
ÉÉ, -
ToName
ÉÉ- 3
(
ÉÉ3 4
)
ÉÉ4 5
)
ÉÉ5 6
)
ÉÉ6 7
.
ÑÑ 
ToArray
ÑÑ 
(
ÑÑ 
)
ÑÑ 
;
ÑÑ 
if
ÜÜ 

(
ÜÜ 
backgroundModules
ÜÜ 
.
ÜÜ 
Length
ÜÜ $
>
ÜÜ% &
$num
ÜÜ' (
)
ÜÜ( )
{
áá 	
Task
àà 
.
àà 
Run
àà 
(
àà 
async
àà 
(
àà 
)
àà 
=>
àà  
{
ââ 
foreach
ää 
(
ää 
IModule
ää  
module
ää! '
in
ää( *
backgroundModules
ää+ <
)
ää< =
{
ãã 
await
åå 
LoadModuleAsync
åå )
(
åå) *
module
åå* 0
.
åå0 1
Id
åå1 3
.
åå3 4
ToName
åå4 :
(
åå: ;
)
åå; <
)
åå< =
;
åå= >
}
çç 
}
éé 
)
éé 
;
éé 
}
èè 	
}
êê 
public
íí 

async
íí 
Task
íí 
UnloadModuleAsync
íí '
(
íí' (
string
íí( .

moduleName
íí/ 9
)
íí9 :
{
ìì 
Option
îî 
<
îî 
IModule
îî 
>
îî 
moduleOption
îî $
=
îî% &
_catalog
îî' /
.
îî/ 0
	GetModule
îî0 9
(
îî9 :

moduleName
îî: D
)
îîD E
;
îîE F
if
ïï 

(
ïï 
!
ïï 
moduleOption
ïï 
.
ïï 
IsSome
ïï  
||
ïï! #
!
ïï$ %
IsModuleLoaded
ïï% 3
(
ïï3 4

moduleName
ïï4 >
)
ïï> ?
)
ïï? @
{
ññ 	
return
óó 
;
óó 
}
òò 	
IModule
öö 
module
öö 
=
öö 
moduleOption
öö %
.
öö% &
Value
öö& +
!
öö+ ,
;
öö, -
_moduleStates
úú 
[
úú 

moduleName
úú  
]
úú  !
=
úú" #
ModuleState
úú$ /
.
úú/ 0
	Unloading
úú0 9
;
úú9 :
await
ûû 
module
ûû 
.
ûû 
UnloadAsync
ûû  
(
ûû  !
)
ûû! "
;
ûû" #
_moduleStates
üü 
[
üü 

moduleName
üü  
]
üü  !
=
üü" #
ModuleState
üü$ /
.
üü/ 0
Unloaded
üü0 8
;
üü8 9#
ModuleResourceManager
°° 
?
°° 
resourceManager
°° .
=
°°/ 0
_serviceProvider
°°1 A
.
°°A B

GetService
°°B L
<
°°L M#
ModuleResourceManager
°°M b
>
°°b c
(
°°c d
)
°°d e
;
°°e f
resourceManager
¢¢ 
?
¢¢ 
.
¢¢ 
RemoveModuleScope
¢¢ *
(
¢¢* +

moduleName
¢¢+ 5
)
¢¢5 6
;
¢¢6 7
}
££ 
public
•• 

bool
•• 
IsModuleLoaded
•• 
(
•• 
string
•• %

moduleName
••& 0
)
••0 1
=>
••2 4
_moduleStates
¶¶ 
.
¶¶ 
TryGetValue
¶¶ !
(
¶¶! "

moduleName
¶¶" ,
,
¶¶, -
out
¶¶. 1
ModuleState
¶¶2 =
state
¶¶> C
)
¶¶C D
&&
¶¶E G
state
¶¶H M
==
¶¶N P
ModuleState
¶¶Q \
.
¶¶\ ]
Loaded
¶¶] c
;
¶¶c d
public
®® 
!
IReadOnlyDictionary
®® 
<
®® 
string
®® %
,
®®% &
ModuleState
®®' 2
>
®®2 3
GetModuleStates
®®4 C
(
®®C D
)
®®D E
=>
®®F H
new
©© 

Dictionary
©© 
<
©© 
string
©© 
,
©© 
ModuleState
©© *
>
©©* +
(
©©+ ,
_moduleStates
©©, 9
)
©©9 :
;
©©: ;
}™™ Âà
Ç/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/ModuleDependencyResolver.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
public		 
class		 $
ModuleDependencyResolver		 %
{

 
public 

Task 
< 
IEnumerable 
< 
IModule #
># $
>$ %!
ResolveLoadOrderAsync& ;
(; <
IEnumerable< G
<G H
IModuleH O
>O P
modulesQ X
)X Y
{ 
List 
< 
IModule 
> 

moduleList  
=! "
modules# *
.* +
ToList+ 1
(1 2
)2 3
;3 4

Dictionary 
< 
string 
, 
IModule "
>" #
	moduleMap$ -
=. /

moduleList0 :
.: ;
ToDictionary; G
(G H
mH I
=>J L
mM N
.N O
IdO Q
.Q R
ToNameR X
(X Y
)Y Z
,Z [
m\ ]
=>^ `
ma b
)b c
;c d 
ValidateDependencies 
( 

moduleList '
,' (
	moduleMap) 2
)2 3
;3 4
return 
Task 
. 

FromResult 
( 
TopologicalSort .
(. /

moduleList/ 9
,9 :
	moduleMap; D
)D E
)E F
;F G
} 
public 

Task 
< 
IEnumerable 
< 
IModule #
># $
>$ %#
GetRequiredModulesAsync& =
(= >
string> D

moduleNameE O
,O P
IEnumerableQ \
<\ ]
IModule] d
>d e
availableModulesf v
)v w
{ 

Dictionary 
< 
string 
, 
IModule "
>" #
	moduleMap$ -
=. /
availableModules0 @
.@ A
ToDictionaryA M
(M N
mN O
=>P R
mS T
.T U
IdU W
.W X
ToNameX ^
(^ _
)_ `
,` a
mb c
=>d f
mg h
)h i
;i j
if 

( 
! 
	moduleMap 
. 
TryGetValue "
(" #

moduleName# -
,- .
out/ 2
IModule3 :
?: ;
targetModule< H
)H I
)I J
{ 	
throw 
new %
InvalidOperationException /
(/ 0
$"0 2
$str2 9
{9 :

moduleName: D
}D E
$strE O
"O P
)P Q
;Q R
} 	
HashSet 
< 
string 
> 
required  
=! "
new# &
(& '
)' (
;( )$
GetDependenciesRecursive  
(  !
targetModule! -
,- .
	moduleMap/ 8
,8 9
required: B
)B C
;C D
return!! 
Task!! 
.!! 

FromResult!! 
(!! 
required!! '
.!!' (
Select!!( .
(!!. /
name!!/ 3
=>!!4 6
	moduleMap!!7 @
[!!@ A
name!!A E
]!!E F
)!!F G
)!!G H
;!!H I
}"" 
private$$ 
void$$  
ValidateDependencies$$ %
($$% &
List$$& *
<$$* +
IModule$$+ 2
>$$2 3
modules$$4 ;
,$$; <

Dictionary$$= G
<$$G H
string$$H N
,$$N O
IModule$$P W
>$$W X
	moduleMap$$Y b
)$$b c
{%% 
foreach&& 
(&& 
IModule&& 
module&& 
in&&  "
modules&&# *
)&&* +
{'' 	
foreach(( 
((( 
ModuleIdentifier(( %

dependency((& 0
in((1 3
module((4 :
.((: ;
Manifest((; C
.((C D
Dependencies((D P
)((P Q
{)) 
if** 
(** 
!** 
	moduleMap** 
.** 
ContainsKey** *
(*** +

dependency**+ 5
.**5 6
ToName**6 <
(**< =
)**= >
)**> ?
)**? @
{++ 
throw,, 
new,, %
InvalidOperationException,, 7
(,,7 8
$"-- 
$str-- "
{--" #
module--# )
.--) *
Id--* ,
.--, -
ToName--- 3
(--3 4
)--4 5
}--5 6
$str--6 D
{--D E

dependency--E O
.--O P
ToName--P V
(--V W
)--W X
}--X Y
$str--Y a
{--a b

dependency--b l
.--l m
ToName--m s
(--s t
)--t u
}--u v
$str	--v â
"
--â ä
)
--ä ã
;
--ã å
}.. 
}// 
}00 	&
DetectCircularDependencies22 "
(22" #
modules22# *
,22* +
	moduleMap22, 5
)225 6
;226 7
}33 
private55 
void55 &
DetectCircularDependencies55 +
(55+ ,
List55, 0
<550 1
IModule551 8
>558 9
modules55: A
,55A B

Dictionary55C M
<55M N
string55N T
,55T U
IModule55V ]
>55] ^
	moduleMap55_ h
)55h i
{66 
HashSet77 
<77 
string77 
>77 
visited77 
=77  !
[77" #
]77# $
;77$ %
HashSet88 
<88 
string88 
>88 
recursionStack88 &
=88' (
[88) *
]88* +
;88+ ,
foreach:: 
(:: 
IModule:: 
module:: 
in::  "
modules::# *
.::* +
Where::+ 0
(::0 1
m::1 2
=>::3 5
!::6 7
visited::7 >
.::> ?
Contains::? G
(::G H
m::H I
.::I J
Id::J L
.::L M
ToName::M S
(::S T
)::T U
)::U V
)::V W
)::W X
{;; 	
if<< 
(<< !
HasCircularDependency<< %
(<<% &
module<<& ,
.<<, -
Id<<- /
.<</ 0
ToName<<0 6
(<<6 7
)<<7 8
,<<8 9
	moduleMap<<: C
,<<C D
visited<<E L
,<<L M
recursionStack<<N \
)<<\ ]
)<<] ^
{== 
throw>> 
new>> %
InvalidOperationException>> 3
(>>3 4
$">>4 6
$str>>6 i
{>>i j
module>>j p
.>>p q
Id>>q s
.>>s t
ToName>>t z
(>>z {
)>>{ |
}>>| }
$str>>} ~
">>~ 
)	>> Ä
;
>>Ä Å
}?? 
}@@ 	
}AA 
privateCC 
boolCC !
HasCircularDependencyCC &
(CC& '
stringCC' -

moduleNameCC. 8
,CC8 9

DictionaryCC: D
<CCD E
stringCCE K
,CCK L
IModuleCCM T
>CCT U
	moduleMapCCV _
,CC_ `
HashSetDD 
<DD 
stringDD 
>DD 
visitedDD 
,DD  
HashSetDD! (
<DD( )
stringDD) /
>DD/ 0
recursionStackDD1 ?
)DD? @
{EE 
visitedFF 
.FF 
AddFF 
(FF 

moduleNameFF 
)FF 
;FF  
recursionStackGG 
.GG 
AddGG 
(GG 

moduleNameGG %
)GG% &
;GG& '
ifII 

(II 
	moduleMapII 
.II 
TryGetValueII !
(II! "

moduleNameII" ,
,II, -
outII. 1
IModuleII2 9
?II9 :
moduleII; A
)IIA B
)IIB C
{JJ 	
foreachKK 
(KK 
ModuleIdentifierKK %

dependencyKK& 0
inKK1 3
moduleKK4 :
.KK: ;
ManifestKK; C
.KKC D
DependenciesKKD P
)KKP Q
{LL 
stringMM 
depNameMM 
=MM  

dependencyMM! +
.MM+ ,
ToNameMM, 2
(MM2 3
)MM3 4
;MM4 5
ifOO 
(OO 
!OO 
visitedOO 
.OO 
ContainsOO %
(OO% &
depNameOO& -
)OO- .
)OO. /
{PP 
ifQQ 
(QQ !
HasCircularDependencyQQ -
(QQ- .
depNameQQ. 5
,QQ5 6
	moduleMapQQ7 @
,QQ@ A
visitedQQB I
,QQI J
recursionStackQQK Y
)QQY Z
)QQZ [
{RR 
returnSS 
trueSS #
;SS# $
}TT 
}UU 
elseVV 
ifVV 
(VV 
recursionStackVV '
.VV' (
ContainsVV( 0
(VV0 1
depNameVV1 8
)VV8 9
)VV9 :
{WW 
returnXX 
trueXX 
;XX  
}YY 
}ZZ 
}[[ 	
recursionStack]] 
.]] 
Remove]] 
(]] 

moduleName]] (
)]]( )
;]]) *
return^^ 
false^^ 
;^^ 
}__ 
privateaa 
IEnumerableaa 
<aa 
IModuleaa 
>aa  
TopologicalSortaa! 0
(aa0 1
Listaa1 5
<aa5 6
IModuleaa6 =
>aa= >
modulesaa? F
,aaF G

DictionaryaaH R
<aaR S
stringaaS Y
,aaY Z
IModuleaa[ b
>aab c
	moduleMapaad m
)aam n
{bb 

Dictionarycc 
<cc 
stringcc 
,cc 
intcc 
>cc 
inDegreecc  (
=cc) *
modulescc+ 2
.cc2 3
ToDictionarycc3 ?
(cc? @
mcc@ A
=>ccB D
mccE F
.ccF G
IdccG I
.ccI J
ToNameccJ P
(ccP Q
)ccQ R
,ccR S
_ccT U
=>ccV X
$numccY Z
)ccZ [
;cc[ \

Dictionarydd 
<dd 
stringdd 
,dd 
HashSetdd "
<dd" #
stringdd# )
>dd) *
>dd* +

dependentsdd, 6
=dd7 8
newdd9 <
(dd< =
)dd= >
;dd> ?
foreachff 
(ff 
IModuleff 
moduleff 
inff  "
modulesff# *
)ff* +
{gg 	
stringhh 

moduleNamehh 
=hh 
modulehh  &
.hh& '
Idhh' )
.hh) *
ToNamehh* 0
(hh0 1
)hh1 2
;hh2 3

dependentsii 
[ii 

moduleNameii !
]ii! "
=ii# $
newii% (
HashSetii) 0
<ii0 1
stringii1 7
>ii7 8
(ii8 9
)ii9 :
;ii: ;
}jj 	
foreachll 
(ll 
IModulell 
modulell 
inll  "
modulesll# *
)ll* +
{mm 	
foreachnn 
(nn 
ModuleIdentifiernn %

dependencynn& 0
innn1 3
modulenn4 :
.nn: ;
Manifestnn; C
.nnC D
DependenciesnnD P
)nnP Q
{oo 
stringpp 
depNamepp 
=pp  

dependencypp! +
.pp+ ,
ToNamepp, 2
(pp2 3
)pp3 4
;pp4 5
ifqq 
(qq 

dependentsqq 
.qq 
ContainsKeyqq *
(qq* +
depNameqq+ 2
)qq2 3
)qq3 4
{rr 

dependentsss 
[ss 
depNamess &
]ss& '
.ss' (
Addss( +
(ss+ ,
moduless, 2
.ss2 3
Idss3 5
.ss5 6
ToNamess6 <
(ss< =
)ss= >
)ss> ?
;ss? @
inDegreett 
[tt 
modulett #
.tt# $
Idtt$ &
.tt& '
ToNamett' -
(tt- .
)tt. /
]tt/ 0
++tt0 2
;tt2 3
}uu 
}vv 
}ww 	
Queueyy 
<yy 
stringyy 
>yy 
queueyy 
=yy 
newyy !
(yy! "
inDegreeyy" *
.yy* +
Whereyy+ 0
(yy0 1
kvpyy1 4
=>yy5 7
kvpyy8 ;
.yy; <
Valueyy< A
==yyB D
$numyyE F
)yyF G
.yyG H
SelectyyH N
(yyN O
kvpyyO R
=>yyS U
kvpyyV Y
.yyY Z
KeyyyZ ]
)yy] ^
)yy^ _
;yy_ `
Listzz 
<zz 
IModulezz 
>zz 
resultzz 
=zz 
newzz "
(zz" #
moduleszz# *
.zz* +
Countzz+ 0
)zz0 1
;zz1 2
while|| 
(|| 
queue|| 
.|| 
Count|| 
>|| 
$num|| 
)|| 
{}} 	
string~~ 
current~~ 
=~~ 
queue~~ "
.~~" #
Dequeue~~# *
(~~* +
)~~+ ,
;~~, -
result 
. 
Add 
( 
	moduleMap  
[  !
current! (
]( )
)) *
;* +
foreach
ÅÅ 
(
ÅÅ 
string
ÅÅ 
	dependent
ÅÅ %
in
ÅÅ& (

dependents
ÅÅ) 3
[
ÅÅ3 4
current
ÅÅ4 ;
]
ÅÅ; <
)
ÅÅ< =
{
ÇÇ 
inDegree
ÉÉ 
[
ÉÉ 
	dependent
ÉÉ "
]
ÉÉ" #
--
ÉÉ# %
;
ÉÉ% &
if
ÑÑ 
(
ÑÑ 
inDegree
ÑÑ 
[
ÑÑ 
	dependent
ÑÑ &
]
ÑÑ& '
==
ÑÑ( *
$num
ÑÑ+ ,
)
ÑÑ, -
{
ÖÖ 
queue
ÜÜ 
.
ÜÜ 
Enqueue
ÜÜ !
(
ÜÜ! "
	dependent
ÜÜ" +
)
ÜÜ+ ,
;
ÜÜ, -
}
áá 
}
àà 
}
ââ 	
if
ãã 

(
ãã 
result
ãã 
.
ãã 
Count
ãã 
!=
ãã 
modules
ãã #
.
ãã# $
Count
ãã$ )
)
ãã) *
{
åå 	
throw
çç 
new
çç '
InvalidOperationException
çç /
(
çç/ 0
$str
çç0 v
)
ççv w
;
ççw x
}
éé 	
return
êê 
result
êê 
.
êê 
OrderBy
êê 
(
êê 
m
êê 
=>
êê  "
m
êê# $
.
êê$ %
Manifest
êê% -
.
êê- .
Priority
êê. 6
)
êê6 7
.
êê7 8
ThenBy
êê8 >
(
êê> ?
m
êê? @
=>
êêA C
m
êêD E
.
êêE F
Id
êêF H
.
êêH I
ToName
êêI O
(
êêO P
)
êêP Q
)
êêQ R
;
êêR S
}
ëë 
private
ìì 
void
ìì &
GetDependenciesRecursive
ìì )
(
ìì) *
IModule
ìì* 1
module
ìì2 8
,
ìì8 9

Dictionary
ìì: D
<
ììD E
string
ììE K
,
ììK L
IModule
ììM T
>
ììT U
	moduleMap
ììV _
,
ìì_ `
HashSet
ììa h
<
ììh i
string
ììi o
>
ììo p
required
ììq y
)
ììy z
{
îî 
foreach
ïï 
(
ïï 
ModuleIdentifier
ïï !

dependency
ïï" ,
in
ïï- /
module
ïï0 6
.
ïï6 7
Manifest
ïï7 ?
.
ïï? @
Dependencies
ïï@ L
)
ïïL M
{
ññ 	
string
óó 
depName
óó 
=
óó 

dependency
óó '
.
óó' (
ToName
óó( .
(
óó. /
)
óó/ 0
;
óó0 1
if
òò 
(
òò 
!
òò 
required
òò 
.
òò 
Contains
òò "
(
òò" #
depName
òò# *
)
òò* +
&&
òò, .
	moduleMap
òò/ 8
.
òò8 9
TryGetValue
òò9 D
(
òòD E
depName
òòE L
,
òòL M
out
òòN Q
IModule
òòR Y
?
òòY Z
	depModule
òò[ d
)
òòd e
)
òòe f
{
ôô 
required
öö 
.
öö 
Add
öö 
(
öö 
depName
öö $
)
öö$ %
;
öö% &&
GetDependenciesRecursive
õõ (
(
õõ( )
	depModule
õõ) 2
,
õõ2 3
	moduleMap
õõ4 =
,
õõ= >
required
õõ? G
)
õõG H
;
õõH I
}
úú 
}
ùù 	
}
ûû 
}üü …
w/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/ModuleCatalog.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
public		 
	interface		 
IModuleCatalog		 
{

 
void 
	AddModule	 
< 
TModule 
> 
( 
) 
where #
TModule$ +
:, -
class. 3
,3 4
IModule5 <
,< =
new> A
(A B
)B C
;C D
void 
	AddModule	 
( 
IModule 
module !
)! "
;" #
IReadOnlyList 
< 
IModule 
> 

GetModules %
(% &
)& '
;' (
Option 

<
 
IModule 
> 
	GetModule 
( 
string $
name% )
)) *
;* +
} 
public 
class 
ModuleCatalog 
: 
IModuleCatalog +
{ 
private 
readonly 
List 
< 
IModule !
>! "
_modules# +
=, -
[. /
]/ 0
;0 1
public 

void 
	AddModule 
< 
TModule !
>! "
(" #
)# $
where% *
TModule+ 2
:3 4
class5 :
,: ;
IModule< C
,C D
newE H
(H I
)I J
{ 
IModule 
module 
= 
new 
TModule $
($ %
)% &
;& '
	AddModule 
( 
module 
) 
; 
} 
public 

void 
	AddModule 
( 
IModule !
module" (
)( )
{ 
if 

( 
_modules 
. 
Any 
( 
m 
=> 
m 
.  
Id  "
==# %
module& ,
., -
Id- /
)/ 0
)0 1
{ 	
return   
;   
}!! 	
_modules## 
.## 
Add## 
(## 
module## 
)## 
;## 
}$$ 
public&& 

IReadOnlyList&& 
<&& 
IModule&&  
>&&  !

GetModules&&" ,
(&&, -
)&&- .
=>&&/ 1
_modules&&2 :
.&&: ;

AsReadOnly&&; E
(&&E F
)&&F G
;&&G H
public(( 

Option(( 
<(( 
IModule(( 
>(( 
	GetModule(( $
((($ %
string((% +
name((, 0
)((0 1
=>((2 4
_modules)) 
.)) 
FirstOrDefault)) 
())  
m))  !
=>))" $
string))% +
.))+ ,
Equals)), 2
())2 3
m))3 4
.))4 5
Id))5 7
.))7 8
ToName))8 >
())> ?
)))? @
,))@ A
name))B F
,))F G
StringComparison))H X
.))X Y
OrdinalIgnoreCase))Y j
)))j k
)))k l
.** 
ToOption** 
(** 
)** 
;** 
}++ ¢#
t/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/ModuleBase.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
public 
abstract 
class 

ModuleBase  
<  !
	TManifest! *
>* +
:, -
ITypedModule. :
<: ;
	TManifest; D
>D E
whereF K
	TManifestL U
:V W
IModuleManifestX g
{		 
public

 

abstract

 
ModuleIdentifier

 $
Id

% '
{

( )
get

* -
;

- .
}

/ 0
public 

abstract 
	TManifest 
Manifest &
{' (
get) ,
;, -
}. /
IModuleManifest 
IModule 
. 
Manifest $
=>% '
Manifest( 0
;0 1
public 

bool 
IsLoaded 
{ 
get 
; 
private  '
set( +
;+ ,
}- .
public 

IModuleScope 
? 
ServiceScope %
{& '
get( +
;+ ,
private- 4
set5 8
;8 9
}: ;
public 

virtual 
Task 
< 
bool 
> 
CanLoadAsync *
(* +
)+ ,
=>- /
Task0 4
.4 5

FromResult5 ?
(? @
true@ D
)D E
;E F
public 

async 
Task 
	LoadAsync 
(  
IServiceProvider  0
serviceProvider1 @
)@ A
{ 
if 

( 
IsLoaded 
) 
{ 	
return 
; 
} 	
try 
{ 	!
ModuleResourceManager !
?! "
resourceManager# 2
=3 4
serviceProvider5 D
.D E

GetServiceE O
<O P!
ModuleResourceManagerP e
>e f
(f g
)g h
;h i
if 
( 
resourceManager 
!=  "
null# '
)' (
{ 
ServiceScope 
= 
resourceManager .
.. /
CreateModuleScope/ @
(@ A
IdA C
.C D
ToNameD J
(J K
)K L
)L M
;M N
} 
await   
OnLoadAsync   
(   
)   
;    
IsLoaded"" 
="" 
true"" 
;"" 
}## 	
catch$$ 
{%% 	
ServiceScope&& 
?&& 
.&& 
Dispose&& !
(&&! "
)&&" #
;&&# $
ServiceScope'' 
='' 
null'' 
;''  
}(( 	
})) 
public++ 

async++ 
Task++ 
UnloadAsync++ !
(++! "
)++" #
{,, 
if-- 

(-- 
!-- 
IsLoaded-- 
)-- 
{.. 	
return// 
;// 
}00 	
await22 
OnUnloadAsync22 
(22 
)22 
;22 
ServiceScope44 
?44 
.44 
Dispose44 
(44 
)44 
;44  
ServiceScope55 
=55 
null55 
;55 
IsLoaded77 
=77 
false77 
;77 
}88 
public:: 

virtual:: 
Task:: %
SetupMessageHandlersAsync:: 1
(::1 2
IModuleMessageBus::2 C

messageBus::D N
)::N O
=>::P R
Task::S W
.::W X
CompletedTask::X e
;::e f
	protected<< 
virtual<< 
Task<< 
OnLoadAsync<< &
(<<& '
)<<' (
=><<) +
Task<<, 0
.<<0 1
CompletedTask<<1 >
;<<> ?
	protected>> 
virtual>> 
Task>> 
OnUnloadAsync>> (
(>>( )
)>>) *
=>>>+ -
Task>>. 2
.>>2 3
CompletedTask>>3 @
;>>@ A
}?? µ"
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/CompositeServiceScope.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
internal 
class	 !
CompositeServiceScope $
:% &
IServiceScope' 4
{ 
private 
readonly 
ServiceProvider $"
_moduleServiceProvider% ;
;; <
private		 
readonly		 
IServiceScope		 "
_parentScope		# /
;		/ 0
private

 
readonly

 $
CompositeServiceProvider

 -
_serviceProvider

. >
;

> ?
private 
bool 
	_disposed 
; 
public 
!
CompositeServiceScope  
(  !
ServiceProvider! 0!
moduleServiceProvider1 F
,F G
IServiceScopeH U
parentScopeV a
)a b
{ "
_moduleServiceProvider 
=  !
moduleServiceProvider! 6
;6 7
_parentScope 
= 
parentScope "
;" #
_serviceProvider 
= 
new $
CompositeServiceProvider 7
(7 8"
_moduleServiceProvider8 N
,N O
_parentScopeP \
.\ ]
ServiceProvider] l
)l m
;m n
} 
public 

IServiceProvider 
ServiceProvider +
=>, .
_serviceProvider/ ?
;? @
public 

void 
Dispose 
( 
) 
{ 
if 

( 
	_disposed 
) 
{ 	
return 
; 
} 	
	_disposed 
= 
true 
; 
_serviceProvider 
? 
. 
Dispose !
(! "
)" #
;# $"
_moduleServiceProvider 
? 
.  
Dispose  '
(' (
)( )
;) *
_parentScope   
?   
.   
Dispose   
(   
)   
;    
}!! 
}"" 
internal$$ 
class$$	 $
CompositeServiceProvider$$ '
:$$( )
IServiceProvider$$* :
,$$: ;
IDisposable$$< G
{%% 
private&& 
readonly&& 
IServiceProvider&& %
_moduleProvider&&& 5
;&&5 6
private'' 
readonly'' 
IServiceProvider'' %
_mainProvider''& 3
;''3 4
private(( 
bool(( 
	_disposed(( 
;(( 
public** 
$
CompositeServiceProvider** #
(**# $
IServiceProvider**$ 4
moduleProvider**5 C
,**C D
IServiceProvider**E U
mainProvider**V b
)**b c
{++ 
_moduleProvider,, 
=,, 
moduleProvider,, (
;,,( )
_mainProvider-- 
=-- 
mainProvider-- $
;--$ %
}.. 
public00 

object00 
?00 

GetService00 
(00 
Type00 "
serviceType00# .
)00. /
{11 #
ObjectDisposedException22 
.22  
ThrowIf22  '
(22' (
	_disposed22( 1
,221 2
this223 7
)227 8
;228 9
object44 
?44 
service44 
=44 
_moduleProvider44 )
.44) *

GetService44* 4
(444 5
serviceType445 @
)44@ A
;44A B
return55 
service55 
??55 
_mainProvider55 '
.55' (

GetService55( 2
(552 3
serviceType553 >
)55> ?
;55? @
}66 
public88 

void88 
Dispose88 
(88 
)88 
{99 
if:: 

(:: 
	_disposed:: 
):: 
{;; 	
return<< 
;<< 
}== 	
	_disposed?? 
=?? 
true?? 
;?? 
}@@ 
}AA è=
à/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Subscriptions/SubscriptionTypes.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Subscriptions' 4
;4 5
internal 
	interface	 
ISubscription  
{ 
int		 
Priority		 
{		 
get		 
;		 
}		 
bool

 
IsAlive

	 
{

 
get

 
;

 
}

 
bool 
IsWeak	 
{ 
get 
; 
} 
Task 
? 	
HandleAsync
 
( 
object 
message $
)$ %
;% &
} 
internal 
sealed	 
class 
StrongSubscription (
<( )
T) *
>* +
(+ ,
Func, 0
<0 1
T1 2
,2 3
bool4 8
>8 9
filter: @
,@ A
FuncB F
<F G
TG H
,H I
TaskJ N
>N O
handlerP W
,W X
intY \
priority] e
)e f
:g h
ISubscriptioni v
where 	
T
 
: 
class 
{ 
public 

int 
Priority 
{ 
get 
; 
}  
=! "
priority# +
;+ ,
public 

bool 
IsAlive 
=> 
true 
;  
public 

bool 
IsWeak 
=> 
false 
;  
public 

Task 
? 
HandleAsync 
( 
object #
message$ +
)+ ,
{ 
if 

( 
message 
is 
T 
typedMessage %
&&& (
filter) /
(/ 0
typedMessage0 <
)< =
)= >
{ 	
return 
handler 
( 
typedMessage '
)' (
;( )
} 	
return 
Task 
. 
CompletedTask !
;! "
} 
} 
internal!! 
sealed!!	 
class!! 
WeakSubscription!! &
<!!& '
T!!' (
>!!( )
(!!) *
Func!!* .
<!!. /
T!!/ 0
,!!0 1
bool!!2 6
>!!6 7
filter!!8 >
,!!> ?
Func!!@ D
<!!D E
T!!E F
,!!F G
Task!!H L
>!!L M
handler!!N U
,!!U V
int!!W Z
priority!![ c
)!!c d
:!!e f
ISubscription!!g t
where"" 	
T""
 
:"" 
class"" 
{## 
private$$ 
readonly$$ 
WeakReference$$ "
<$$" #
Func$$# '
<$$' (
T$$( )
,$$) *
Task$$+ /
>$$/ 0
>$$0 1
_handlerRef$$2 =
=$$> ?
new$$@ C
($$C D
handler$$D K
)$$K L
;$$L M
public&& 

int&& 
Priority&& 
{&& 
get&& 
;&& 
}&&  
=&&! "
priority&&# +
;&&+ ,
public'' 

bool'' 
IsWeak'' 
=>'' 
true'' 
;'' 
public(( 

bool(( 
IsAlive(( 
=>(( 
_handlerRef(( &
.((& '
TryGetTarget((' 3
(((3 4
out((4 7
_((8 9
)((9 :
;((: ;
public** 

Task** 
?** 
HandleAsync** 
(** 
object** #
message**$ +
)**+ ,
{++ 
if,, 

(,, 
message,, 
is,, 
T,, 
typedMessage,, %
&&,,& (
filter-- 
(-- 
typedMessage-- 
)--  
&&--! #
_handlerRef.. 
... 
TryGetTarget.. $
(..$ %
out..% (
Func..) -
<..- .
T... /
,../ 0
Task..1 5
>..5 6
?..6 7
handler..8 ?
)..? @
)..@ A
{// 	
return00 
handler00 
(00 
typedMessage00 '
)00' (
;00( )
}11 	
return22 
Task22 
.22 
CompletedTask22 !
;22! "
}33 
}44 
internal66 
sealed66	 
class66 
ScopedSubscription66 (
<66( )
T66) *
>66* +
(66+ ,
Func66, 0
<660 1
T661 2
,662 3
bool664 8
>668 9
filter66: @
,66@ A
Func66B F
<66F G
T66G H
,66H I
Task66J N
>66N O
handler66P W
,66W X
int66Y \
priority66] e
)66e f
:77 
ISubscription77 
,77 
IDisposable77  
where88 	
T88
 
:88 
class88 
{99 
private:: 
bool:: 
	_disposed:: 
;:: 
public<< 

int<< 
Priority<< 
{<< 
get<< 
;<< 
}<<  
=<<! "
priority<<# +
;<<+ ,
public== 

bool== 
IsAlive== 
=>== 
!== 
	_disposed== %
;==% &
public>> 

bool>> 
IsWeak>> 
=>>> 
false>> 
;>>  
public@@ 

Task@@ 
?@@ 
HandleAsync@@ 
(@@ 
object@@ #
message@@$ +
)@@+ ,
{AA 
ifBB 

(BB 
!BB 
	_disposedBB 
&&BB 
messageBB !
isBB" $
TBB% &
typedMessageBB' 3
&&BB4 6
filterBB7 =
(BB= >
typedMessageBB> J
)BBJ K
)BBK L
{CC 	
returnDD 
handlerDD 
(DD 
typedMessageDD '
)DD' (
;DD( )
}EE 	
returnFF 
TaskFF 
.FF 
CompletedTaskFF !
;FF! "
}GG 
publicII 

voidII 
DisposeII 
(II 
)II 
{JJ 
	_disposedKK 
=KK 
trueKK 
;KK 
}LL 
}MM 
publicOO 
staticOO 
classOO "
SubscriptionExtensionsOO *
{PP 
[QQ 

MethodImplQQ 
(QQ 
MethodImplOptionsQQ !
.QQ! "
AggressiveInliningQQ" 4
)QQ4 5
]QQ5 6
publicRR 

staticRR 
IDisposableRR 
DisposeWithRR )
(RR) *
thisRR* .
IDisposableRR/ :
subscriptionRR; G
,RRG H!
IDisposableCollectionRRI ^
disposablesRR_ j
)RRj k
{SS 
disposablesTT 
.TT 
AddTT 
(TT 
subscriptionTT $
)TT$ %
;TT% &
returnUU 
subscriptionUU 
;UU 
}VV 
}WW 
publicYY 
	interfaceYY !
IDisposableCollectionYY &
{ZZ 
void[[ 
Add[[	 
([[ 
IDisposable[[ 

disposable[[ #
)[[# $
;[[$ %
}\\ Î	
ã/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Services/ILanguageDetectionService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Services' /
;/ 0
public 
	interface %
ILanguageDetectionService *
{ 
Task		 &
RequestLanguageChangeAsync			 #
(		# $
string		$ *
targetCulture		+ 8
)		8 9
;		9 :
Task &
ConfirmLanguageChangeAsync	 #
(# $
string$ *
targetCulture+ 8
)8 9
;9 :
Task &
DeclineLanguageChangeAsync	 #
(# $
)$ %
;% &
IDisposable (
OnLanguageDetectionRequested ,
(, -
Func 
< (
LanguageDetectionDialogEvent )
,) *
Task+ /
>/ 0
handler1 8
,8 9 
SubscriptionLifetime 
lifetime %
=& ' 
SubscriptionLifetime( <
.< =
Weak= A
)A B
;B C
} †£
ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Subscriptions/SubscriptionManager.cs
	namespace		 	
Ecliptix		
 
.		 
Core		 
.		 
Core		 
.		 
	Messaging		 &
.		& '
Subscriptions		' 4
;		4 5
internal 
sealed	 
class 
SubscriptionManager )
:* +
IDisposable, 7
{ 
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
SubscriptionList2 B
>B C
_subscriptionsD R
=S T
newU X
(X Y
)Y Z
;Z [
private 
readonly 
Timer 
_cleanupTimer (
;( )
private 
readonly 
Lock 
_cleanupLock &
=' (
new) ,
(, -
)- .
;. /
private 
long 
_totalSubscriptions $
;$ %
private 
long $
_deadReferencesCleanedUp )
;) *
private 
volatile 
bool 
	_disposed #
;# $
public 

SubscriptionManager 
( 
)  
{ 
_cleanupTimer 
= 
new 
Timer !
(! "!
CleanupDeadReferences" 7
,7 8
null9 =
,= >
TimeSpan? G
.G H
FromSecondsH S
(S T
$numT V
)V W
,W X
TimeSpanY a
.a b
FromSecondsb m
(m n
$numn p
)p q
)q r
;r s
} 
public 

IDisposable 
	Subscribe  
<  !
T! "
>" #
(# $
Func 
< 
T 
, 
bool 
> 
filter 
, 
Func 
< 
T 
, 
Task 
> 
handler 
,  
SubscriptionLifetime 
lifetime %
,% &
int 
priority 
) 
where 
T 
: 
class  %
{ 
if 

( 
	_disposed 
) 
{   	
throw!! 
new!! #
ObjectDisposedException!! -
(!!- .
nameof!!. 4
(!!4 5
SubscriptionManager!!5 H
)!!H I
)!!I J
;!!J K
}"" 	
string$$ 
messageTypeKey$$ 
=$$ 
GetMessageTypeKey$$  1
<$$1 2
T$$2 3
>$$3 4
($$4 5
)$$5 6
;$$6 7
SubscriptionList%% 
list%% 
=%% 
_subscriptions%%  .
.%%. /
GetOrAdd%%/ 7
(%%7 8
messageTypeKey%%8 F
,%%F G
_%%H I
=>%%J L
new%%M P
SubscriptionList%%Q a
(%%a b
)%%b c
)%%c d
;%%d e
ISubscription'' 
subscription'' "
=''# $
lifetime''% -
switch''. 4
{(( 	 
SubscriptionLifetime))  
.))  !
Weak))! %
=>))& (
new))) ,
WeakSubscription))- =
<))= >
T))> ?
>))? @
())@ A
filter))A G
,))G H
handler))I P
,))P Q
priority))R Z
)))Z [
,))[ \ 
SubscriptionLifetime**  
.**  !
Strong**! '
=>**( *
new**+ .
StrongSubscription**/ A
<**A B
T**B C
>**C D
(**D E
filter**E K
,**K L
handler**M T
,**T U
priority**V ^
)**^ _
,**_ ` 
SubscriptionLifetime++  
.++  !
Scoped++! '
=>++( *
new+++ .
ScopedSubscription++/ A
<++A B
T++B C
>++C D
(++D E
filter++E K
,++K L
handler++M T
,++T U
priority++V ^
)++^ _
,++_ `
_,, 
=>,, 
throw,, 
new,, '
ArgumentOutOfRangeException,, 6
(,,6 7
nameof,,7 =
(,,= >
lifetime,,> F
),,F G
),,G H
}-- 	
;--	 

list// 
.// 
Add// 
(// 
subscription// 
)// 
;// 
Interlocked00 
.00 
	Increment00 
(00 
ref00 !
_totalSubscriptions00" 5
)005 6
;006 7
return22 
new22 
SubscriptionToken22 $
(22$ %
(22% &
)22& '
=>22( *
{33 	
list44 
.44 
Remove44 
(44 
subscription44 $
)44$ %
;44% &
Interlocked55 
.55 
	Decrement55 !
(55! "
ref55" %
_totalSubscriptions55& 9
)559 :
;55: ;
if77 
(77 
list77 
.77 
IsEmpty77 
)77 
{88 
_subscriptions99 
.99 
	TryRemove99 (
(99( )
messageTypeKey99) 7
,997 8
out999 <
_99= >
)99> ?
;99? @
}:: 
};; 	
);;	 

;;;
 
}<< 
public>> 

async>> 
Task>> 
PublishAsync>> "
<>>" #
T>># $
>>>$ %
(>>% &
T>>& '
message>>( /
,>>/ 0
CancellationToken>>1 B
_>>C D
)>>D E
where>>F K
T>>L M
:>>N O
class>>P U
{?? 
if@@ 

(@@ 
	_disposed@@ 
||@@ 
message@@  
==@@! #
null@@$ (
)@@( )
{AA 	
returnBB 
;BB 
}CC 	
stringEE 
messageTypeKeyEE 
=EE 
GetMessageTypeKeyEE  1
<EE1 2
TEE2 3
>EE3 4
(EE4 5
)EE5 6
;EE6 7
ifGG 

(GG 
!GG 
_subscriptionsGG 
.GG 
TryGetValueGG '
(GG' (
messageTypeKeyGG( 6
,GG6 7
outGG8 ;
SubscriptionListGG< L
?GGL M
listGGN R
)GGR S
)GGS T
{HH 	
returnII 
;II 
}JJ 	
ISubscriptionLL 
[LL 
]LL 
activeSubscriptionsLL +
=LL, -
listLL. 2
.LL2 3"
GetActiveSubscriptionsLL3 I
(LLI J
)LLJ K
;LLK L
ifMM 

(MM 
activeSubscriptionsMM 
.MM  
LengthMM  &
==MM' )
$numMM* +
)MM+ ,
{NN 	
returnOO 
;OO 
}PP 	
ifRR 

(RR 
activeSubscriptionsRR 
.RR  
LengthRR  &
>RR' (
$numRR) *
)RR* +
{SS 	
ArrayTT 
.TT 
SortTT 
(TT 
activeSubscriptionsTT *
,TT* +
(TT, -
xTT- .
,TT. /
yTT0 1
)TT1 2
=>TT3 5
yTT6 7
.TT7 8
PriorityTT8 @
.TT@ A
	CompareToTTA J
(TTJ K
xTTK L
.TTL M
PriorityTTM U
)TTU V
)TTV W
;TTW X
}UU 	
ListWW 
<WW 
TaskWW 
>WW 
handlerTasksWW 
=WW  !
newWW" %
(WW% &
activeSubscriptionsWW& 9
.WW9 :
LengthWW: @
)WW@ A
;WWA B
foreachYY 
(YY 
ISubscriptionYY 
subscriptionYY +
inYY, .
activeSubscriptionsYY/ B
)YYB C
{ZZ 	
try[[ 
{\\ 
Task]] 
?]] 
handlerTask]] !
=]]" #
subscription]]$ 0
.]]0 1
HandleAsync]]1 <
(]]< =
message]]= D
)]]D E
;]]E F
if^^ 
(^^ 
handlerTask^^ 
!=^^  "
null^^# '
)^^' (
{__ 
handlerTasks``  
.``  !
Add``! $
(``$ %
handlerTask``% 0
)``0 1
;``1 2
}aa 
}bb 
catchcc 
(cc 
	Exceptioncc 
)cc 
{dd 
}ff 
}gg 	
ifii 

(ii 
handlerTasksii 
.ii 
Countii 
>ii  
$numii! "
)ii" #
{jj 	
trykk 
{ll 
awaitmm 
Taskmm 
.mm 
WhenAllmm "
(mm" #
handlerTasksmm# /
)mm/ 0
;mm0 1
}nn 
catchoo 
(oo 
	Exceptionoo 
)oo 
{pp 
}rr 
}ss 	
}tt 
privatevv 
voidvv !
CleanupDeadReferencesvv &
(vv& '
objectvv' -
?vv- .
statevv/ 4
)vv4 5
{ww 
ifxx 

(xx 
	_disposedxx 
)xx 
{yy 	
returnzz 
;zz 
}{{ 	
lock}} 
(}} 
_cleanupLock}} 
)}} 
{~~ 	
if 
( 
	_disposed 
) 
{
ÄÄ 
return
ÅÅ 
;
ÅÅ 
}
ÇÇ 
int
ÑÑ 
	cleanedUp
ÑÑ 
=
ÑÑ 
$num
ÑÑ 
;
ÑÑ 
List
ÖÖ 
<
ÖÖ 
string
ÖÖ 
>
ÖÖ 

emptyLists
ÖÖ #
=
ÖÖ$ %
[
ÖÖ& '
]
ÖÖ' (
;
ÖÖ( )
foreach
áá 
(
áá 
KeyValuePair
áá !
<
áá! "
string
áá" (
,
áá( )
SubscriptionList
áá* :
>
áá: ;
kvp
áá< ?
in
áá@ B
_subscriptions
ááC Q
)
ááQ R
{
àà 
	cleanedUp
ââ 
+=
ââ 
kvp
ââ  
.
ââ  !
Value
ââ! &
.
ââ& '#
CleanupDeadReferences
ââ' <
(
ââ< =
)
ââ= >
;
ââ> ?
if
ää 
(
ää 
kvp
ää 
.
ää 
Value
ää 
.
ää 
IsEmpty
ää %
)
ää% &
{
ãã 

emptyLists
åå 
.
åå 
Add
åå "
(
åå" #
kvp
åå# &
.
åå& '
Key
åå' *
)
åå* +
;
åå+ ,
}
çç 
}
éé 
foreach
êê 
(
êê 
string
êê 
key
êê 
in
êê  "

emptyLists
êê# -
)
êê- .
{
ëë 
_subscriptions
íí 
.
íí 
	TryRemove
íí (
(
íí( )
key
íí) ,
,
íí, -
out
íí. 1
_
íí2 3
)
íí3 4
;
íí4 5
}
ìì 
Interlocked
ïï 
.
ïï 
Add
ïï 
(
ïï 
ref
ïï &
_deadReferencesCleanedUp
ïï  8
,
ïï8 9
	cleanedUp
ïï: C
)
ïïC D
;
ïïD E
}
ññ 	
}
óó 
[
ôô 

MethodImpl
ôô 
(
ôô 
MethodImplOptions
ôô !
.
ôô! " 
AggressiveInlining
ôô" 4
)
ôô4 5
]
ôô5 6
private
öö 
static
öö 
string
öö 
GetMessageTypeKey
öö +
<
öö+ ,
T
öö, -
>
öö- .
(
öö. /
)
öö/ 0
where
öö1 6
T
öö7 8
:
öö9 :
class
öö; @
{
õõ 
return
úú 
typeof
úú 
(
úú 
T
úú 
)
úú 
.
úú 
Name
úú 
;
úú 
}
ùù 
public
üü 

void
üü 
Dispose
üü 
(
üü 
)
üü 
{
†† 
if
°° 

(
°° 
!
°° 
	_disposed
°° 
)
°° 
{
¢¢ 	
	_disposed
££ 
=
££ 
true
££ 
;
££ 
_cleanupTimer
§§ 
.
§§ 
Dispose
§§ !
(
§§! "
)
§§" #
;
§§# $
foreach
¶¶ 
(
¶¶ 
SubscriptionList
¶¶ %
list
¶¶& *
in
¶¶+ -
_subscriptions
¶¶. <
.
¶¶< =
Values
¶¶= C
)
¶¶C D
{
ßß 
list
®® 
.
®® 
Dispose
®® 
(
®® 
)
®® 
;
®® 
}
©© 
_subscriptions
´´ 
.
´´ 
Clear
´´  
(
´´  !
)
´´! "
;
´´" #
}
¨¨ 	
}
≠≠ 
}ÆÆ 
internal∞∞ 
sealed
∞∞	 
class
∞∞ 
SubscriptionToken
∞∞ '
(
∞∞' (
Action
∞∞( .
disposeAction
∞∞/ <
)
∞∞< =
:
∞∞> ?
IDisposable
∞∞@ K
{±± 
private
≤≤ 
bool
≤≤ 
	_disposed
≤≤ 
;
≤≤ 
public
¥¥ 

void
¥¥ 
Dispose
¥¥ 
(
¥¥ 
)
¥¥ 
{
µµ 
if
∂∂ 

(
∂∂ 
!
∂∂ 
	_disposed
∂∂ 
)
∂∂ 
{
∑∑ 	
disposeAction
∏∏ 
(
∏∏ 
)
∏∏ 
;
∏∏ 
	_disposed
ππ 
=
ππ 
true
ππ 
;
ππ 
}
∫∫ 	
}
ªª 
}ºº 
internalææ 
sealed
ææ	 
class
ææ 
SubscriptionList
ææ &
:
ææ' (
IDisposable
ææ) 4
{øø 
private
¿¿ 
readonly
¿¿ 
List
¿¿ 
<
¿¿ 
ISubscription
¿¿ '
>
¿¿' (
_subscriptions
¿¿) 7
=
¿¿8 9
new
¿¿: =
(
¿¿= >
)
¿¿> ?
;
¿¿? @
private
¡¡ 
readonly
¡¡ "
ReaderWriterLockSlim
¡¡ )
_lock
¡¡* /
=
¡¡0 1
new
¡¡2 5
(
¡¡5 6
)
¡¡6 7
;
¡¡7 8
private
¬¬ 
bool
¬¬ 
	_disposed
¬¬ 
;
¬¬ 
public
ƒƒ 

void
ƒƒ 
Add
ƒƒ 
(
ƒƒ 
ISubscription
ƒƒ !
subscription
ƒƒ" .
)
ƒƒ. /
{
≈≈ 
_lock
∆∆ 
.
∆∆ 
EnterWriteLock
∆∆ 
(
∆∆ 
)
∆∆ 
;
∆∆ 
try
«« 
{
»» 	
if
…… 
(
…… 
!
…… 
	_disposed
…… 
)
…… 
{
   
_subscriptions
ÀÀ 
.
ÀÀ 
Add
ÀÀ "
(
ÀÀ" #
subscription
ÀÀ# /
)
ÀÀ/ 0
;
ÀÀ0 1
}
ÃÃ 
}
ÕÕ 	
finally
ŒŒ 
{
œœ 	
_lock
–– 
.
–– 
ExitWriteLock
–– 
(
––  
)
––  !
;
––! "
}
—— 	
}
““ 
public
‘‘ 

void
‘‘ 
Remove
‘‘ 
(
‘‘ 
ISubscription
‘‘ $
subscription
‘‘% 1
)
‘‘1 2
{
’’ 
_lock
÷÷ 
.
÷÷ 
EnterWriteLock
÷÷ 
(
÷÷ 
)
÷÷ 
;
÷÷ 
try
◊◊ 
{
ÿÿ 	
_subscriptions
ŸŸ 
.
ŸŸ 
Remove
ŸŸ !
(
ŸŸ! "
subscription
ŸŸ" .
)
ŸŸ. /
;
ŸŸ/ 0
}
⁄⁄ 	
finally
€€ 
{
‹‹ 	
_lock
›› 
.
›› 
ExitWriteLock
›› 
(
››  
)
››  !
;
››! "
}
ﬁﬁ 	
}
ﬂﬂ 
public
·· 

ISubscription
·· 
[
·· 
]
·· $
GetActiveSubscriptions
·· 1
(
··1 2
)
··2 3
{
‚‚ 
_lock
„„ 
.
„„ 
EnterReadLock
„„ 
(
„„ 
)
„„ 
;
„„ 
try
‰‰ 
{
ÂÂ 	
return
ÊÊ 
_subscriptions
ÊÊ !
.
ÊÊ! "
Where
ÊÊ" '
(
ÊÊ' (
s
ÊÊ( )
=>
ÊÊ* ,
s
ÊÊ- .
.
ÊÊ. /
IsAlive
ÊÊ/ 6
)
ÊÊ6 7
.
ÊÊ7 8
ToArray
ÊÊ8 ?
(
ÊÊ? @
)
ÊÊ@ A
;
ÊÊA B
}
ÁÁ 	
finally
ËË 
{
ÈÈ 	
_lock
ÍÍ 
.
ÍÍ 
ExitReadLock
ÍÍ 
(
ÍÍ 
)
ÍÍ  
;
ÍÍ  !
}
ÎÎ 	
}
ÏÏ 
public
ÓÓ 

int
ÓÓ #
CleanupDeadReferences
ÓÓ $
(
ÓÓ$ %
)
ÓÓ% &
{
ÔÔ 
_lock
 
.
 
EnterWriteLock
 
(
 
)
 
;
 
try
ÒÒ 
{
ÚÚ 	
int
ÛÛ 
initialCount
ÛÛ 
=
ÛÛ 
_subscriptions
ÛÛ -
.
ÛÛ- .
Count
ÛÛ. 3
;
ÛÛ3 4
_subscriptions
ÙÙ 
.
ÙÙ 
	RemoveAll
ÙÙ $
(
ÙÙ$ %
s
ÙÙ% &
=>
ÙÙ' )
!
ÙÙ* +
s
ÙÙ+ ,
.
ÙÙ, -
IsAlive
ÙÙ- 4
)
ÙÙ4 5
;
ÙÙ5 6
return
ıı 
initialCount
ıı 
-
ıı  !
_subscriptions
ıı" 0
.
ıı0 1
Count
ıı1 6
;
ıı6 7
}
ˆˆ 	
finally
˜˜ 
{
¯¯ 	
_lock
˘˘ 
.
˘˘ 
ExitWriteLock
˘˘ 
(
˘˘  
)
˘˘  !
;
˘˘! "
}
˙˙ 	
}
˚˚ 
public
˝˝ 

(
˝˝ 
int
˝˝ 
weak
˝˝ 
,
˝˝ 
int
˝˝ 
strong
˝˝  
)
˝˝  !#
GetSubscriptionCounts
˝˝" 7
(
˝˝7 8
)
˝˝8 9
{
˛˛ 
_lock
ˇˇ 
.
ˇˇ 
EnterReadLock
ˇˇ 
(
ˇˇ 
)
ˇˇ 
;
ˇˇ 
try
ÄÄ 
{
ÅÅ 	
int
ÇÇ 
weak
ÇÇ 
=
ÇÇ 
$num
ÇÇ 
,
ÇÇ 
strong
ÇÇ  
=
ÇÇ! "
$num
ÇÇ# $
;
ÇÇ$ %
foreach
ÉÉ 
(
ÉÉ 
ISubscription
ÉÉ "
subscription
ÉÉ# /
in
ÉÉ0 2
_subscriptions
ÉÉ3 A
)
ÉÉA B
{
ÑÑ 
if
ÖÖ 
(
ÖÖ 
subscription
ÖÖ  
.
ÖÖ  !
IsWeak
ÖÖ! '
)
ÖÖ' (
{
ÜÜ 
weak
áá 
++
áá 
;
áá 
}
àà 
else
ââ 
{
ää 
strong
ãã 
++
ãã 
;
ãã 
}
åå 
}
çç 
return
éé 
(
éé 
weak
éé 
,
éé 
strong
éé  
)
éé  !
;
éé! "
}
èè 	
finally
êê 
{
ëë 	
_lock
íí 
.
íí 
ExitReadLock
íí 
(
íí 
)
íí  
;
íí  !
}
ìì 	
}
îî 
public
ññ 

bool
ññ 
IsEmpty
ññ 
{
óó 
get
òò 
{
ôô 	
_lock
öö 
.
öö 
EnterReadLock
öö 
(
öö  
)
öö  !
;
öö! "
try
õõ 
{
úú 
return
ùù 
_subscriptions
ùù %
.
ùù% &
Count
ùù& +
==
ùù, .
$num
ùù/ 0
;
ùù0 1
}
ûû 
finally
üü 
{
†† 
_lock
°° 
.
°° 
ExitReadLock
°° "
(
°°" #
)
°°# $
;
°°$ %
}
¢¢ 
}
££ 	
}
§§ 
public
¶¶ 

void
¶¶ 
Dispose
¶¶ 
(
¶¶ 
)
¶¶ 
{
ßß 
if
®® 

(
®® 
!
®® 
	_disposed
®® 
)
®® 
{
©© 	
_lock
™™ 
.
™™ 
EnterWriteLock
™™  
(
™™  !
)
™™! "
;
™™" #
try
´´ 
{
¨¨ 
_subscriptions
≠≠ 
.
≠≠ 
Clear
≠≠ $
(
≠≠$ %
)
≠≠% &
;
≠≠& '
	_disposed
ÆÆ 
=
ÆÆ 
true
ÆÆ  
;
ÆÆ  !
}
ØØ 
finally
∞∞ 
{
±± 
_lock
≤≤ 
.
≤≤ 
ExitWriteLock
≤≤ #
(
≤≤# $
)
≤≤$ %
;
≤≤% &
_lock
≥≥ 
.
≥≥ 
Dispose
≥≥ 
(
≥≥ 
)
≥≥ 
;
≥≥  
}
¥¥ 
}
µµ 	
}
∂∂ 
}∑∑ ˛
ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Services/LanguageDetectionService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Services' /
;/ 0
internal 
sealed	 
class $
LanguageDetectionService .
(. /
IMessageBus/ :

messageBus; E
)E F
:G H%
ILanguageDetectionServiceI b
,b c
IDisposabled o
{ 
private		 
bool		 
	_disposed		 
;		 
public 

async 
Task &
RequestLanguageChangeAsync 0
(0 1
string1 7
targetCulture8 E
)E F
{ 
if 

( 
	_disposed 
) 
{ 	
return 
; 
} 	(
LanguageDetectionDialogEvent $
evt% (
=) *(
LanguageDetectionDialogEvent+ G
.G H
ConfirmH O
(O P
targetCultureP ]
)] ^
;^ _
await 

messageBus 
. 
PublishAsync %
(% &
evt& )
)) *
;* +
} 
public 

async 
Task &
ConfirmLanguageChangeAsync 0
(0 1
string1 7
targetCulture8 E
)E F
{ 
if 

( 
	_disposed 
) 
{ 	
return 
; 
} 	(
LanguageDetectionDialogEvent $
evt% (
=) *(
LanguageDetectionDialogEvent+ G
.G H
ConfirmH O
(O P
targetCultureP ]
)] ^
;^ _
await 

messageBus 
. 
PublishAsync %
(% &
evt& )
)) *
;* +
} 
public!! 

async!! 
Task!! &
DeclineLanguageChangeAsync!! 0
(!!0 1
)!!1 2
{"" 
if## 

(## 
	_disposed## 
)## 
{$$ 	
return%% 
;%% 
}&& 	(
LanguageDetectionDialogEvent(( $
evt((% (
=(() *(
LanguageDetectionDialogEvent((+ G
.((G H
Decline((H O
(((O P
)((P Q
;((Q R
await)) 

messageBus)) 
.)) 
PublishAsync)) %
())% &
evt))& )
)))) *
;))* +
}** 
public,, 

IDisposable,, (
OnLanguageDetectionRequested,, 3
(,,3 4
Func-- 
<-- (
LanguageDetectionDialogEvent-- )
,--) *
Task--+ /
>--/ 0
handler--1 8
,--8 9 
SubscriptionLifetime.. 
lifetime.. %
=..& ' 
SubscriptionLifetime..( <
...< =
Weak..= A
)..A B
{// 
return00 

messageBus00 
.00 
	Subscribe00 #
(00# $
handler00$ +
,00+ ,
lifetime00- 5
)005 6
;006 7
}11 
public33 

void33 
Dispose33 
(33 
)33 
{44 
	_disposed55 
=55 
true55 
;55 
}66 
}77 ‹
Ü/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Services/IConnectivityService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Services' /
;/ 0
public		 
	interface		  
IConnectivityService		 %
:		& '
IDisposable		( 3
{

  
ConnectivitySnapshot 
CurrentSnapshot (
{) *
get+ .
;. /
}0 1
IObservable 
<  
ConnectivitySnapshot $
>$ %
ConnectivityStream& 8
{9 :
get; >
;> ?
}@ A
Task 
PublishAsync	 
( 
ConnectivityIntent (
intent) /
,/ 0
CancellationToken1 B
cancellationTokenC T
=U V
defaultW ^
)^ _
;_ `
Task #
RequestManualRetryAsync	  
(  !
uint! %
?% &
	connectId' 0
=1 2
null3 7
)7 8
;8 9
IDisposable "
OnManualRetryRequested &
(& '
Func 
< %
ManualRetryRequestedEvent &
,& '
Task( ,
>, -
handler. 5
,5 6 
SubscriptionLifetime 
lifetime %
=& ' 
SubscriptionLifetime( <
.< =
Weak= A
)A B
;B C
} √
Ö/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Services/IBottomSheetService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Services' /
;/ 0
public 
	interface 
IBottomSheetService $
{		 
Task

 
	ShowAsync

	 
(

 $
BottomSheetComponentType

 +
componentType

, 9
,

9 :
UserControl

; F
?

F G
control

H O
=

P Q
null

R V
,

V W
bool

X \
	showScrim

] f
=

g h
true

i m
,

m n
bool

o s
isDismissable	

t Å
=


Ç É
true


Ñ à
)


à â
;


â ä
Task 
	HideAsync	 
( 
) 
; 
Task  
BottomSheetDismissed	 
( 
) 
;  
IDisposable  
OnBottomSheetChanged $
($ %
Func 
< #
BottomSheetCommandEvent $
,$ %
Task& *
>* +
handler, 3
,3 4 
SubscriptionLifetime 
lifetime %
=& ' 
SubscriptionLifetime( <
.< =
Weak= A
)A B
;B C
IDisposable 
OnBottomSheetHidden #
(# $
Func 
< "
BottomSheetHiddenEvent #
,# $
Task% )
>) *
handler+ 2
,2 3 
SubscriptionLifetime 
lifetime %
=& ' 
SubscriptionLifetime( <
.< =
Weak= A
)A B
;B C
} Ì$
Ö/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Services/ConnectivityService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Services' /
;/ 0
internal		 
sealed			 
class		 
ConnectivityService		 )
(		) *
IMessageBus		* 5

messageBus		6 @
)		@ A
:		B C 
IConnectivityService		D X
{

 
private 
readonly !
ConnectivityPublisher *"
_connectivityPublisher+ A
=B C
newD G
(G H
)H I
;I J
private 
bool 
	_disposed 
; 
public 
 
ConnectivitySnapshot 
CurrentSnapshot  /
=>0 2"
_connectivityPublisher3 I
.I J
CurrentSnapshotJ Y
;Y Z
public 

IObservable 
<  
ConnectivitySnapshot +
>+ ,
ConnectivityStream- ?
=>@ B"
_connectivityPublisherC Y
.Y Z
ConnectivityStreamZ l
;l m
public 

Task 
PublishAsync 
( 
ConnectivityIntent /
intent0 6
,6 7
CancellationToken8 I
cancellationTokenJ [
=\ ]
default^ e
)e f
{ 
return 
	_disposed 
? 
throw 
new #
ObjectDisposedException /
(/ 0
nameof0 6
(6 7
ConnectivityService7 J
)J K
)K L
: "
_connectivityPublisher $
.$ %
PublishAsync% 1
(1 2
intent2 8
,8 9
cancellationToken: K
)K L
;L M
} 
public 

Task #
RequestManualRetryAsync '
(' (
uint( ,
?, -
	connectId. 7
=8 9
null: >
)> ?
{ 
if 

( 
! 
	_disposed 
) 
{ 	%
ManualRetryRequestedEvent %
evt& )
=* +%
ManualRetryRequestedEvent, E
.E F
NewF I
(I J
	connectIdJ S
)S T
;T U
return #
PublishManualRetryAsync *
(* +
evt+ .
). /
;/ 0
} 	
throw!! 
new!! #
ObjectDisposedException!! )
(!!) *
nameof!!* 0
(!!0 1
ConnectivityService!!1 D
)!!D E
)!!E F
;!!F G
}"" 
private$$ 
async$$ 
Task$$ #
PublishManualRetryAsync$$ .
($$. /%
ManualRetryRequestedEvent$$/ H
evt$$I L
)$$L M
{%% 
await&& 

messageBus&& 
.&& 
PublishAsync&& %
(&&% &
evt&&& )
)&&) *
.&&* +
ConfigureAwait&&+ 9
(&&9 :
false&&: ?
)&&? @
;&&@ A
await'' 
PublishAsync'' 
('' 
ConnectivityIntent'' -
.''- .
ManualRetry''. 9
(''9 :
evt'': =
.''= >
	ConnectId''> G
)''G H
)''H I
.''I J
ConfigureAwait''J X
(''X Y
false''Y ^
)''^ _
;''_ `
}(( 
public** 

IDisposable** "
OnManualRetryRequested** -
(**- .
Func++ 
<++ %
ManualRetryRequestedEvent++ &
,++& '
Task++( ,
>++, -
handler++. 5
,++5 6 
SubscriptionLifetime,, 
lifetime,, %
=,,& ' 
SubscriptionLifetime,,( <
.,,< =
Weak,,= A
),,A B
=>,,C E

messageBus-- 
.-- 
	Subscribe-- 
(-- 
handler-- $
,--$ %
lifetime--& .
)--. /
;--/ 0
public// 

void// 
Dispose// 
(// 
)// 
{00 
if11 

(11 
	_disposed11 
)11 
{22 	
return33 
;33 
}44 	
	_disposed66 
=66 
true66 
;66 "
_connectivityPublisher77 
.77 
Dispose77 &
(77& '
)77' (
;77( )
}88 
}99 ºw
Ñ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Services/BottomSheetService.cs
	namespace		 	
Ecliptix		
 
.		 
Core		 
.		 
Core		 
.		 
	Messaging		 &
.		& '
Services		' /
;		/ 0
internal 
sealed	 
class 
BottomSheetService (
:) *
IBottomSheetService+ >
,> ?
IDisposable@ K
{ 
private 
readonly 
IMessageBus  
_messageBus! ,
;, -
private 
readonly 
Queue 
< 
BottomSheetRequest -
>- .
_requestQueue/ <
== >
new? B
(B C
)C D
;D E
private 
readonly 
Lock 

_queueLock $
=% &
new' *
(* +
)+ ,
;, -
private 
BottomSheetRequest 
? 
_pendingRequest  /
;/ 0
private 
bool !
_isShowingBottomSheet &
;& '
private 
bool 
_isAnimating 
; 
private 
bool 
	_disposed 
; 
public 

BottomSheetService 
( 
IMessageBus )

messageBus* 4
)4 5
{ 
_messageBus 
= 

messageBus  
;  !
Log 
. 
Debug 
( 
$str 9
)9 :
;: ;
_messageBus 
. 
	Subscribe 
< -
!BottomSheetAnimationCompleteEvent ?
>? @
(@ A
asyncA F
evtG J
=>K M
{ 	
Log 
. 
Debug 
( 
$str M
,M N
evtO R
.R S
AnimationTypeS `
)` a
;a b
await #
HandleAnimationComplete )
() *
evt* -
)- .
;. /
} 	
)	 

;
 
} 
public!! 

async!! 
Task!! 
	ShowAsync!! 
(!!  $
BottomSheetComponentType!!  8
componentType!!9 F
,!!F G
UserControl!!H S
?!!S T
control!!U \
=!!] ^
null!!_ c
,!!c d
bool!!e i
	showScrim!!j s
=!!t u
true!!v z
,!!z {
bool	!!| Ä
isDismissable
!!Å é
=
!!è ê
true
!!ë ï
)
!!ï ñ
{"" 
if## 

(## 
	_disposed## 
)## 
{$$ 	
Log%% 
.%% 
Warning%% 
(%% 
$str%% T
)%%T U
;%%U V
return&& 
;&& 
}'' 	
Log)) 
.)) 
Debug)) 
()) 
$str)) J
,))J K
componentType))L Y
)))Y Z
;))Z [
BottomSheetRequest++ 
request++ "
=++# $
new++% (
(++( )
componentType++) 6
,++6 7
control++8 ?
,++? @
	showScrim++A J
,++J K
isDismissable++L Y
)++Y Z
;++Z [
lock-- 
(-- 

_queueLock-- 
)-- 
{.. 	
_requestQueue// 
.// 
Enqueue// !
(//! "
request//" )
)//) *
;//* +
Log00 
.00 
Debug00 
(00 
$str00 U
,00U V
_requestQueue00W d
.00d e
Count00e j
)00j k
;00k l
}11 	
await33 
ProcessNextRequest33  
(33  !
)33! "
;33" #
}44 
public77 

async77 
Task77 
	HideAsync77 
(77  
)77  !
{88 
if99 

(99 
	_disposed99 
)99 
{:: 	
Log;; 
.;; 
Warning;; 
(;; 
$str;; T
);;T U
;;;U V
return<< 
;<< 
}== 	
Log?? 
.?? 
Debug?? 
(?? 
$str?? =
)??= >
;??> ?
lockAA 
(AA 

_queueLockAA 
)AA 
{BB 	
ifCC 
(CC 
!CC !
_isShowingBottomSheetCC &
||CC' )
_isAnimatingCC* 6
)CC6 7
{DD 
LogEE 
.EE 
DebugEE 
(EE 
$strEE `
)EE` a
;EEa b
returnFF 
;FF 
}GG 
_isAnimatingII 
=II 
trueII 
;II  
}JJ 	
awaitLL 
_messageBusLL 
.LL 
PublishAsyncLL &
(LL& '#
BottomSheetCommandEventLL' >
.LL> ?
HideLL? C
(LLC D
)LLD E
)LLE F
;LLF G
}MM 
publicOO 

asyncOO 
TaskOO  
BottomSheetDismissedOO *
(OO* +
)OO+ ,
{PP 
LogQQ 
.QQ 
DebugQQ 
(QQ 
$strQQ F
)QQF G
;QQG H
lockSS 
(SS 

_queueLockSS 
)SS 
{TT 	
ifUU 
(UU 
!UU !
_isShowingBottomSheetUU &
)UU& '
{VV 
returnWW 
;WW 
}XX 
}YY 	
awaitZZ 
_messageBusZZ 
.ZZ 
PublishAsyncZZ &
(ZZ& '#
BottomSheetCommandEventZZ' >
.ZZ> ?
HideZZ? C
(ZZC D
)ZZD E
)ZZE F
;ZZF G
}[[ 
private]] 
async]] 
Task]] 
ProcessNextRequest]] )
(]]) *
)]]* +
{^^ 
if__ 

(__ 
	_disposed__ 
)__ 
{`` 	
returnaa 
;aa 
}bb 	
BottomSheetRequestdd 
?dd 
requestToShowdd )
=dd* +
nulldd, 0
;dd0 1
boolee 

shouldHideee 
=ee 
falseee 
;ee  
lockgg 
(gg 

_queueLockgg 
)gg 
{hh 	
ifii 
(ii 
_isAnimatingii 
)ii 
{jj 
Logkk 
.kk 
Debugkk 
(kk 
$strkk S
)kkS T
;kkT U
returnll 
;ll 
}mm 
ifoo 
(oo 
_requestQueueoo 
.oo 
Countoo #
==oo$ &
$numoo' (
)oo( )
{pp 
Logqq 
.qq 
Debugqq 
(qq 
$strqq Q
)qqQ R
;qqR S
returnrr 
;rr 
}ss 
ifuu 
(uu !
_isShowingBottomSheetuu %
)uu% &
{vv 
_pendingRequestww 
=ww  !
_requestQueueww" /
.ww/ 0
Dequeueww0 7
(ww7 8
)ww8 9
;ww9 :
Logxx 
.xx 
Debugxx 
(xx 
$str	xx á
,
xxá à
_pendingRequestyy #
.yy# $
ComponentTypeyy$ 1
,yy1 2
_requestQueueyy3 @
.yy@ A
CountyyA F
)yyF G
;yyG H

shouldHidezz 
=zz 
truezz !
;zz! "
_isAnimating{{ 
={{ 
true{{ #
;{{# $
}|| 
else}} 
{~~ 
requestToShow 
= 
_requestQueue  -
.- .
Dequeue. 5
(5 6
)6 7
;7 8
_isAnimating
ÄÄ 
=
ÄÄ 
true
ÄÄ #
;
ÄÄ# $
Log
ÅÅ 
.
ÅÅ 
Debug
ÅÅ 
(
ÅÅ 
$str
ÅÅ o
,
ÅÅo p
requestToShow
ÇÇ !
.
ÇÇ! "
ComponentType
ÇÇ" /
,
ÇÇ/ 0
_requestQueue
ÇÇ1 >
.
ÇÇ> ?
Count
ÇÇ? D
)
ÇÇD E
;
ÇÇE F
}
ÉÉ 
}
ÑÑ 	
if
ÜÜ 

(
ÜÜ 

shouldHide
ÜÜ 
)
ÜÜ 
{
áá 	
Log
àà 
.
àà 
Debug
àà 
(
àà 
$str
àà k
)
ààk l
;
ààl m
await
ââ 
_messageBus
ââ 
.
ââ 
PublishAsync
ââ *
(
ââ* +%
BottomSheetCommandEvent
ââ+ B
.
ââB C
Hide
ââC G
(
ââG H
)
ââH I
)
ââI J
;
ââJ K
}
ää 	
else
ãã 
{
åå 	
await
çç 
_messageBus
çç 
.
çç 
PublishAsync
çç *
(
çç* +%
BottomSheetCommandEvent
çç+ B
.
ççB C
Show
ççC G
(
ççG H
requestToShow
éé 
!
éé 
.
éé 
ComponentType
éé ,
,
éé, -
requestToShow
èè 
.
èè 
Control
èè %
,
èè% &
requestToShow
êê 
.
êê 
	ShowScrim
êê '
,
êê' (
requestToShow
ëë 
.
ëë 
IsDismissable
ëë +
)
ëë+ ,
)
ëë, -
;
ëë- .
}
íí 	
}
ìì 
private
ïï 
async
ïï 
Task
ïï %
HandleAnimationComplete
ïï .
(
ïï. //
!BottomSheetAnimationCompleteEvent
ïï/ P
evt
ïïQ T
)
ïïT U
{
ññ 
if
óó 

(
óó 
	_disposed
óó 
)
óó 
{
òò 	
return
ôô 
;
ôô 
}
öö 	 
BottomSheetRequest
úú 
?
úú 
requestToShow
úú )
=
úú* +
null
úú, 0
;
úú0 1
lock
ûû 
(
ûû 

_queueLock
ûû 
)
ûû 
{
üü 	
_isAnimating
†† 
=
†† 
false
††  
;
††  !
if
¢¢ 
(
¢¢ 
evt
¢¢ 
.
¢¢ 
AnimationType
¢¢ !
==
¢¢" $
AnimationType
¢¢% 2
.
¢¢2 3
Show
¢¢3 7
)
¢¢7 8
{
££ #
_isShowingBottomSheet
§§ %
=
§§& '
true
§§( ,
;
§§, -
Log
•• 
.
•• 
Debug
•• 
(
•• 
$str
•• ~
,
••~ 
_requestQueue••Ä ç
.••ç é
Count••é ì
)••ì î
;••î ï
}
¶¶ 
else
ßß 
{
®® #
_isShowingBottomSheet
©© %
=
©©& '
false
©©( -
;
©©- .
Log
™™ 
.
™™ 
Debug
™™ 
(
™™ 
$str
™™ _
)
™™_ `
;
™™` a
if
¨¨ 
(
¨¨ 
_pendingRequest
¨¨ #
!=
¨¨$ &
null
¨¨' +
)
¨¨+ ,
{
≠≠ 
requestToShow
ÆÆ !
=
ÆÆ" #
_pendingRequest
ÆÆ$ 3
;
ÆÆ3 4
_pendingRequest
ØØ #
=
ØØ$ %
null
ØØ& *
;
ØØ* +
_isAnimating
∞∞  
=
∞∞! "
true
∞∞# '
;
∞∞' (
Log
±± 
.
±± 
Debug
±± 
(
±± 
$str
±± Z
,
±±Z [
requestToShow
±±\ i
.
±±i j
ComponentType
±±j w
)
±±w x
;
±±x y
}
≤≤ 
}
≥≥ 
}
¥¥ 	
if
∂∂ 

(
∂∂ 
requestToShow
∂∂ 
!=
∂∂ 
null
∂∂ !
)
∂∂! "
{
∑∑ 	
await
∏∏ 
_messageBus
∏∏ 
.
∏∏ 
PublishAsync
∏∏ *
(
∏∏* +%
BottomSheetCommandEvent
∏∏+ B
.
∏∏B C
Show
∏∏C G
(
∏∏G H
requestToShow
ππ 
.
ππ 
ComponentType
ππ +
,
ππ+ ,
requestToShow
∫∫ 
.
∫∫ 
Control
∫∫ %
,
∫∫% &
requestToShow
ªª 
.
ªª 
	ShowScrim
ªª '
,
ªª' (
requestToShow
ºº 
.
ºº 
IsDismissable
ºº +
)
ºº+ ,
)
ºº, -
;
ºº- .
}
ΩΩ 	
else
ææ 
{
øø 	
await
¿¿  
ProcessNextRequest
¿¿ $
(
¿¿$ %
)
¿¿% &
;
¿¿& '
}
¡¡ 	
}
¬¬ 
public
ƒƒ 

IDisposable
ƒƒ "
OnBottomSheetChanged
ƒƒ +
(
ƒƒ+ ,
Func
ƒƒ, 0
<
ƒƒ0 1%
BottomSheetCommandEvent
ƒƒ1 H
,
ƒƒH I
Task
ƒƒJ N
>
ƒƒN O
handler
ƒƒP W
,
ƒƒW X"
SubscriptionLifetime
ƒƒY m
lifetime
ƒƒn v
=
ƒƒw x#
SubscriptionLifetimeƒƒy ç
.ƒƒç é
Weakƒƒé í
)ƒƒí ì
{
≈≈ 
return
∆∆ 
_messageBus
∆∆ 
.
∆∆ 
	Subscribe
∆∆ $
(
∆∆$ %
handler
∆∆% ,
,
∆∆, -
lifetime
∆∆. 6
)
∆∆6 7
;
∆∆7 8
}
«« 
public
…… 

IDisposable
…… !
OnBottomSheetHidden
…… *
(
……* +
Func
……+ /
<
……/ 0$
BottomSheetHiddenEvent
……0 F
,
……F G
Task
……H L
>
……L M
handler
……N U
,
……U V"
SubscriptionLifetime
……W k
lifetime
……l t
=
……u v#
SubscriptionLifetime……w ã
.……ã å
Weak……å ê
)……ê ë
{
   
return
ÀÀ 
_messageBus
ÀÀ 
.
ÀÀ 
	Subscribe
ÀÀ $
(
ÀÀ$ %
handler
ÀÀ% ,
,
ÀÀ, -
lifetime
ÀÀ. 6
)
ÀÀ6 7
;
ÀÀ7 8
}
ÃÃ 
public
ŒŒ 

void
ŒŒ 
Dispose
ŒŒ 
(
ŒŒ 
)
ŒŒ 
{
œœ 
if
–– 

(
–– 
	_disposed
–– 
)
–– 
{
—— 	
return
““ 
;
““ 
}
”” 	
Log
’’ 
.
’’ 
Debug
’’ 
(
’’ 
$str
’’ ;
)
’’; <
;
’’< =
	_disposed
÷÷ 
=
÷÷ 
true
÷÷ 
;
÷÷ 
lock
ÿÿ 
(
ÿÿ 

_queueLock
ÿÿ 
)
ÿÿ 
{
ŸŸ 	
_requestQueue
⁄⁄ 
.
⁄⁄ 
Clear
⁄⁄ 
(
⁄⁄  
)
⁄⁄  !
;
⁄⁄! "
_pendingRequest
€€ 
=
€€ 
null
€€ "
;
€€" #
}
‹‹ 	
}
›› 
private
ﬂﬂ 
record
ﬂﬂ  
BottomSheetRequest
ﬂﬂ %
(
ﬂﬂ% &&
BottomSheetComponentType
‡‡  
ComponentType
‡‡! .
,
‡‡. /
UserControl
·· 
?
·· 
Control
·· 
,
·· 
bool
‚‚ 
	ShowScrim
‚‚ 
,
‚‚ 
bool
„„ 
IsDismissable
„„ 
)
„„ 
;
„„ 
}‰‰ »¶
s/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/MessageBus.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
;& '
public 
sealed 
class 

MessageBus 
:  
IMessageBus! ,
{ 
private 
readonly 
SubscriptionManager ( 
_subscriptionManager) =
;= >
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
IMessageRequest2 A
>A B
_pendingRequestsC S
=T U
newV Y
(Y Z
)Z [
;[ \
private 
readonly  
ConcurrentDictionary )
<) *
Type* .
,. /"
ReactiveSubjectWrapper0 F
>F G
_reactiveSubjectsH Y
=Z [
new\ _
(_ `
)` a
;a b
private 
readonly 
Timer  
_subjectCleanupTimer /
;/ 0
private 
long #
_totalMessagesPublished (
;( )
private 
long #
_totalRequestsProcessed (
;( )
private 
bool 
	_disposed 
; 
public 

bool 

IsDisposed 
=> 
	_disposed '
;' (
public 


MessageBus 
( 
) 
{  
_subscriptionManager 
= 
new "
SubscriptionManager# 6
(6 7
)7 8
;8 9 
_subjectCleanupTimer   
=   
new   "
Timer  # (
(  ( )!
CleanupUnusedSubjects  ) >
,  > ?
null  @ D
,  D E
TimeSpan  F N
.  N O
FromMinutes  O Z
(  Z [
$num  [ \
)  \ ]
,  ] ^
TimeSpan  _ g
.  g h
FromMinutes  h s
(  s t
$num  t u
)  u v
)  v w
;  w x
}!! 
public## 

IObservable## 
<## 
TMessage## 
>##  
GetEvent##! )
<##) *
TMessage##* 2
>##2 3
(##3 4
)##4 5
where##6 ;
TMessage##< D
:##E F
class##G L
{$$ 
if%% 

(%% 
	_disposed%% 
)%% 
{&& 	
throw'' 
new'' #
ObjectDisposedException'' -
(''- .
nameof''. 4
(''4 5

MessageBus''5 ?
)''? @
)''@ A
;''A B
}(( 	"
ReactiveSubjectWrapper** 
wrapper** &
=**' (
_reactiveSubjects**) :
.**: ;
GetOrAdd**; C
(**C D
typeof++ 
(++ 
TMessage++ 
)++ 
,++ 
_,, 
=>,, 
new,, "
ReactiveSubjectWrapper,, +
(,,+ ,
new,,, /
Subject,,0 7
<,,7 8
TMessage,,8 @
>,,@ A
(,,A B
),,B C
),,C D
),,D E
;,,E F
wrapper.. 
... 
IncrementReference.. "
(.." #
)..# $
;..$ %
IObservable00 
<00 
TMessage00 
>00 

observable00 (
=00) *
(00+ ,
(00, -
Subject00- 4
<004 5
TMessage005 =
>00= >
)00> ?
wrapper00? F
.00F G
Subject00G N
)00N O
.00O P
AsObservable00P \
(00\ ]
)00] ^
;00^ _
return22 

Observable22 
.22 
Create22  
<22  !
TMessage22! )
>22) *
(22* +
observer22+ 3
=>224 6
{33 	
IDisposable44 
subscription44 $
=44% &

observable44' 1
.441 2
	Subscribe442 ;
(44; <
observer44< D
)44D E
;44E F
return55 
new55 
CompositeDisposable55 *
(55* +
subscription55+ 7
,557 8
new559 <
DisposableAction55= M
(55M N
(55N O
)55O P
=>55Q S
wrapper55T [
.55[ \
DecrementReference55\ n
(55n o
)55o p
)55p q
)55q r
;55r s
}66 	
)66	 

;66
 
}77 
public99 

void99 
Publish99 
<99 
TMessage99  
>99  !
(99! "
TMessage99" *
message99+ 2
)992 3
where994 9
TMessage99: B
:99C D
class99E J
{:: 
if;; 

(;; 
	_disposed;; 
);; 
{<< 	
return== 
;== 
}>> 	
if@@ 

(@@ 
_reactiveSubjects@@ 
.@@ 
TryGetValue@@ )
(@@) *
typeof@@* 0
(@@0 1
TMessage@@1 9
)@@9 :
,@@: ;
out@@< ?"
ReactiveSubjectWrapper@@@ V
?@@V W
wrapper@@X _
)@@_ `
)@@` a
{AA 	
(BB 
(BB 
SubjectBB 
<BB 
TMessageBB 
>BB 
)BB  
wrapperBB  '
.BB' (
SubjectBB( /
)BB/ 0
.BB0 1
OnNextBB1 7
(BB7 8
messageBB8 ?
)BB? @
;BB@ A
}CC 	
TaskEE 
.EE 
RunEE 
(EE 
asyncEE 
(EE 
)EE 
=>EE 
{FF 	
tryGG 
{HH 
awaitII  
_subscriptionManagerII *
.II* +
PublishAsyncII+ 7
(II7 8
messageII8 ?
,II? @
CancellationTokenIIA R
.IIR S
NoneIIS W
)IIW X
;IIX Y
}JJ 
catchKK 
(KK 
	ExceptionKK 
exKK 
)KK  
{LL 
SerilogMM 
.MM 
LogMM 
.MM 
ErrorMM !
(MM! "
exMM" $
,MM$ %
$str	MM& Ü
,
MMÜ á
typeofNN 
(NN 
TMessageNN #
)NN# $
.NN$ %
NameNN% )
)NN) *
;NN* +
}OO 
}PP 	
)PP	 

.PP
 
ContinueWithPP 
(PP 
taskQQ 
=>QQ 
{RR 
ifSS 
(SS 
taskSS 
.SS 
	IsFaultedSS "
&&SS# %
taskSS& *
.SS* +
	ExceptionSS+ 4
!=SS5 7
nullSS8 <
)SS< =
{TT 
SerilogUU 
.UU 
LogUU 
.UU  
ErrorUU  %
(UU% &
taskUU& *
.UU* +
	ExceptionUU+ 4
,UU4 5
$strUU6 p
)UUp q
;UUq r
}VV 
}WW 
,WW 
TaskSchedulerXX 
.XX 
DefaultXX !
)XX! "
;XX" #
InterlockedZZ 
.ZZ 
	IncrementZZ 
(ZZ 
refZZ !#
_totalMessagesPublishedZZ" 9
)ZZ9 :
;ZZ: ;
}[[ 
public]] 

async]] 
Task]] 
PublishAsync]] "
<]]" #
TMessage]]# +
>]]+ ,
(]], -
TMessage]]- 5
message]]6 =
,]]= >
CancellationToken]]? P
cancellationToken]]Q b
=]]c d
default]]e l
)]]l m
where^^ 
TMessage^^ 
:^^ 
class^^ 
{__ 
if`` 

(`` 
_reactiveSubjects`` 
.`` 
TryGetValue`` )
(``) *
typeof``* 0
(``0 1
TMessage``1 9
)``9 :
,``: ;
out``< ?"
ReactiveSubjectWrapper``@ V
?``V W
wrapper``X _
)``_ `
)``` a
{aa 	
(bb 
(bb 
Subjectbb 
<bb 
TMessagebb 
>bb 
)bb  
wrapperbb  '
.bb' (
Subjectbb( /
)bb/ 0
.bb0 1
OnNextbb1 7
(bb7 8
messagebb8 ?
)bb? @
;bb@ A
}cc 	
awaitee  
_subscriptionManageree "
.ee" #
PublishAsyncee# /
(ee/ 0
messageee0 7
,ee7 8
cancellationTokenee9 J
)eeJ K
;eeK L
Interlockedgg 
.gg 
	Incrementgg 
(gg 
refgg !#
_totalMessagesPublishedgg" 9
)gg9 :
;gg: ;
}hh 
publicjj 

IDisposablejj 
	Subscribejj  
<jj  !
TMessagejj! )
>jj) *
(jj* +
Funckk 
<kk 
TMessagekk 
,kk 
Taskkk 
>kk 
handlerkk $
,kk$ % 
SubscriptionLifetimell 
lifetimell %
=ll& ' 
SubscriptionLifetimell( <
.ll< =
Strongll= C
)llC D
wherellE J
TMessagellK S
:llT U
classllV [
{mm 
returnnn 
	Subscribenn 
<nn 
TMessagenn !
>nn! "
(nn" #
_nn# $
=>nn% '
truenn( ,
,nn, -
handlernn. 5
,nn5 6
lifetimenn7 ?
,nn? @
$numnnA B
)nnB C
;nnC D
}oo 
privateqq 
IDisposableqq 
	Subscribeqq !
<qq! "
TMessageqq" *
>qq* +
(qq+ ,
Funcrr 
<rr 
TMessagerr 
,rr 
boolrr 
>rr 
filterrr #
,rr# $
Funcss 
<ss 
TMessagess 
,ss 
Taskss 
>ss 
handlerss $
,ss$ % 
SubscriptionLifetimett 
lifetimett %
=tt& ' 
SubscriptionLifetimett( <
.tt< =
Strongtt= C
,ttC D
intuu 
priorityuu 
=uu 
$numuu 
)uu 
whereuu 
TMessageuu  (
:uu) *
classuu+ 0
{vv 
returnww  
_subscriptionManagerww #
.ww# $
	Subscribeww$ -
(ww- .
filterww. 4
,ww4 5
handlerww6 =
,ww= >
lifetimeww? G
,wwG H
prioritywwI Q
)wwQ R
;wwR S
}xx 
publiczz 

asynczz 
Taskzz 
<zz 
	TResponsezz 
?zz  
>zz  !
RequestAsynczz" .
<zz. /
TRequestzz/ 7
,zz7 8
	TResponsezz9 B
>zzB C
(zzC D
TRequest{{ 
request{{ 
,{{ 
TimeSpan|| 
timeout|| 
=|| 
default|| "
,||" #
CancellationToken}} 
cancellationToken}} +
=}}, -
default}}. 5
)}}5 6
where~~ 
TRequest~~ 
:~~ 
class~~ 
,~~ 
IMessageRequest~~  /
where 
	TResponse 
: 
class 
,  
IMessageResponse! 1
{
ÄÄ 
if
ÅÅ 

(
ÅÅ 
timeout
ÅÅ 
==
ÅÅ 
TimeSpan
ÅÅ 
.
ÅÅ  
Zero
ÅÅ  $
)
ÅÅ$ %
{
ÇÇ 	
timeout
ÉÉ 
=
ÉÉ 
request
ÉÉ 
.
ÉÉ 
Timeout
ÉÉ %
;
ÉÉ% &
}
ÑÑ 	"
TaskCompletionSource
ÜÜ 
<
ÜÜ 
IMessageResponse
ÜÜ -
>
ÜÜ- .
tcs
ÜÜ/ 2
=
ÜÜ3 4
new
ÜÜ5 8
(
ÜÜ8 9
)
ÜÜ9 :
;
ÜÜ: ;
_pendingRequests
áá 
[
áá 
request
áá  
.
áá  !
	MessageId
áá! *
]
áá* +
=
áá, -
request
áá. 5
;
áá5 6
try
ââ 
{
ää 	
using
ãã %
CancellationTokenSource
ãã )

timeoutCts
ãã* 4
=
ãã5 6%
CancellationTokenSource
åå '
.
åå' (%
CreateLinkedTokenSource
åå( ?
(
åå? @
cancellationToken
åå@ Q
)
ååQ R
;
ååR S

timeoutCts
çç 
.
çç 
CancelAfter
çç "
(
çç" #
timeout
çç# *
)
çç* +
;
çç+ ,
IDisposable
èè "
responseSubscription
èè ,
=
èè- .
	Subscribe
èè/ 8
<
èè8 9
	TResponse
èè9 B
>
èèB C
(
èèC D
response
êê 
=>
êê 
response
êê $
.
êê$ %
CORRELATION_ID
êê% 3
==
êê4 6
request
êê7 >
.
êê> ?
	MessageId
êê? H
,
êêH I
response
ëë 
=>
ëë 
{
íí 
tcs
ìì 
.
ìì 
	SetResult
ìì !
(
ìì! "
response
ìì" *
)
ìì* +
;
ìì+ ,
return
îî 
Task
îî 
.
îî  
CompletedTask
îî  -
;
îî- .
}
ïï 
,
ïï "
SubscriptionLifetime
ññ $
.
ññ$ %
Scoped
ññ% +
)
ññ+ ,
;
ññ, -
await
òò 
PublishAsync
òò 
(
òò 
request
òò &
,
òò& '
cancellationToken
òò( 9
)
òò9 :
;
òò: ;
Task
öö 
<
öö 
IMessageResponse
öö !
>
öö! "
responseTask
öö# /
=
öö0 1
tcs
öö2 5
.
öö5 6
Task
öö6 :
;
öö: ;
Task
õõ 
timeoutTask
õõ 
=
õõ 
Task
õõ #
.
õõ# $
Delay
õõ$ )
(
õõ) *
timeout
õõ* 1
,
õõ1 2

timeoutCts
õõ3 =
.
õõ= >
Token
õõ> C
)
õõC D
;
õõD E
Task
ùù 
completedTask
ùù 
=
ùù  
await
ùù! &
Task
ùù' +
.
ùù+ ,
WhenAny
ùù, 3
(
ùù3 4
responseTask
ùù4 @
,
ùù@ A
timeoutTask
ùùB M
)
ùùM N
;
ùùN O"
responseSubscription
üü  
.
üü  !
Dispose
üü! (
(
üü( )
)
üü) *
;
üü* +
if
°° 
(
°° 
completedTask
°° 
==
°°  
timeoutTask
°°! ,
)
°°, -
{
¢¢ 
return
££ 
null
££ 
;
££ 
}
§§ 
IMessageResponse
¶¶ 
response
¶¶ %
=
¶¶& '
await
¶¶( -
responseTask
¶¶. :
;
¶¶: ;
Interlocked
ßß 
.
ßß 
	Increment
ßß !
(
ßß! "
ref
ßß" %%
_totalRequestsProcessed
ßß& =
)
ßß= >
;
ßß> ?
return
©© 
response
©© 
as
©© 
	TResponse
©© (
;
©©( )
}
™™ 	
finally
´´ 
{
¨¨ 	
_pendingRequests
≠≠ 
.
≠≠ 
	TryRemove
≠≠ &
(
≠≠& '
request
≠≠' .
.
≠≠. /
	MessageId
≠≠/ 8
,
≠≠8 9
out
≠≠: =
_
≠≠> ?
)
≠≠? @
;
≠≠@ A
}
ÆÆ 	
}
ØØ 
private
±± 
void
±± #
CleanupUnusedSubjects
±± &
(
±±& '
object
±±' -
?
±±- .
state
±±/ 4
)
±±4 5
{
≤≤ 
if
≥≥ 

(
≥≥ 
	_disposed
≥≥ 
)
≥≥ 
{
¥¥ 	
return
µµ 
;
µµ 
}
∂∂ 	
foreach
∏∏ 
(
∏∏ 
KeyValuePair
∏∏ 
<
∏∏ 
Type
∏∏ "
,
∏∏" #$
ReactiveSubjectWrapper
∏∏$ :
>
∏∏: ;
kvp
∏∏< ?
in
∏∏@ B
_reactiveSubjects
∏∏C T
.
∏∏T U
ToArray
∏∏U \
(
∏∏\ ]
)
∏∏] ^
)
∏∏^ _
{
ππ 	
if
∫∫ 
(
∫∫ 
kvp
∫∫ 
.
∫∫ 
Value
∫∫ 
.
∫∫ 
ReferenceCount
∫∫ (
==
∫∫) +
$num
∫∫, -
&&
∫∫. 0
kvp
∫∫1 4
.
∫∫4 5
Value
∫∫5 :
.
∫∫: ;
	IsExpired
∫∫; D
&&
∫∫E G
_reactiveSubjects
ªª !
.
ªª! "
	TryRemove
ªª" +
(
ªª+ ,
kvp
ªª, /
.
ªª/ 0
Key
ªª0 3
,
ªª3 4
out
ªª5 8$
ReactiveSubjectWrapper
ªª9 O
?
ªªO P
removed
ªªQ X
)
ªªX Y
)
ªªY Z
{
ºº 
removed
ΩΩ 
.
ΩΩ 
Dispose
ΩΩ 
(
ΩΩ  
)
ΩΩ  !
;
ΩΩ! "
}
ææ 
}
øø 	
}
¿¿ 
public
¬¬ 

void
¬¬ 
Dispose
¬¬ 
(
¬¬ 
)
¬¬ 
{
√√ 
if
ƒƒ 

(
ƒƒ 
!
ƒƒ 
	_disposed
ƒƒ 
)
ƒƒ 
{
≈≈ 	
	_disposed
∆∆ 
=
∆∆ 
true
∆∆ 
;
∆∆ "
_subjectCleanupTimer
»»  
?
»»  !
.
»»! "
Dispose
»»" )
(
»») *
)
»»* +
;
»»+ ,
foreach
   
(
   $
ReactiveSubjectWrapper
   +
wrapper
  , 3
in
  4 6
_reactiveSubjects
  7 H
.
  H I
Values
  I O
)
  O P
{
ÀÀ 
wrapper
ÃÃ 
.
ÃÃ 
Dispose
ÃÃ 
(
ÃÃ  
)
ÃÃ  !
;
ÃÃ! "
}
ÕÕ 
_reactiveSubjects
œœ 
.
œœ 
Clear
œœ #
(
œœ# $
)
œœ$ %
;
œœ% &"
_subscriptionManager
——  
.
——  !
Dispose
——! (
(
——( )
)
——) *
;
——* +
_pendingRequests
”” 
.
”” 
Clear
”” "
(
””" #
)
””# $
;
””$ %
}
‘‘ 	
}
’’ 
}÷÷ 
internalÿÿ 
sealed
ÿÿ	 
class
ÿÿ $
ReactiveSubjectWrapper
ÿÿ ,
(
ÿÿ, -
object
ÿÿ- 3
subject
ÿÿ4 ;
)
ÿÿ; <
:
ÿÿ= >
IDisposable
ÿÿ? J
{ŸŸ 
private
⁄⁄ 
int
⁄⁄ 
_referenceCount
⁄⁄ 
;
⁄⁄  
private
€€ 
readonly
€€ 
DateTime
€€ 

_createdAt
€€ (
=
€€) *
DateTime
€€+ 3
.
€€3 4
UtcNow
€€4 :
;
€€: ;
private
‹‹ 
bool
‹‹ 
	_disposed
‹‹ 
;
‹‹ 
public
ﬁﬁ 

object
ﬁﬁ 
Subject
ﬁﬁ 
{
ﬁﬁ 
get
ﬁﬁ 
;
ﬁﬁ  
}
ﬁﬁ! "
=
ﬁﬁ# $
subject
ﬁﬁ% ,
;
ﬁﬁ, -
public
ﬂﬂ 

int
ﬂﬂ 
ReferenceCount
ﬂﬂ 
=>
ﬂﬂ  
_referenceCount
ﬂﬂ! 0
;
ﬂﬂ0 1
public
‡‡ 

bool
‡‡ 
	IsExpired
‡‡ 
=>
‡‡ 
DateTime
‡‡ %
.
‡‡% &
UtcNow
‡‡& ,
-
‡‡- .

_createdAt
‡‡/ 9
>
‡‡: ;
TimeSpan
‡‡< D
.
‡‡D E
FromMinutes
‡‡E P
(
‡‡P Q
$num
‡‡Q R
)
‡‡R S
;
‡‡S T
public
‚‚ 

void
‚‚  
IncrementReference
‚‚ "
(
‚‚" #
)
‚‚# $
{
„„ 
if
‰‰ 

(
‰‰ 
!
‰‰ 
	_disposed
‰‰ 
)
‰‰ 
{
ÂÂ 	
Interlocked
ÊÊ 
.
ÊÊ 
	Increment
ÊÊ !
(
ÊÊ! "
ref
ÊÊ" %
_referenceCount
ÊÊ& 5
)
ÊÊ5 6
;
ÊÊ6 7
}
ÁÁ 	
}
ËË 
public
ÍÍ 

void
ÍÍ  
DecrementReference
ÍÍ "
(
ÍÍ" #
)
ÍÍ# $
{
ÎÎ 
if
ÏÏ 

(
ÏÏ 
!
ÏÏ 
	_disposed
ÏÏ 
)
ÏÏ 
{
ÌÌ 	
Interlocked
ÓÓ 
.
ÓÓ 
	Decrement
ÓÓ !
(
ÓÓ! "
ref
ÓÓ" %
_referenceCount
ÓÓ& 5
)
ÓÓ5 6
;
ÓÓ6 7
}
ÔÔ 	
}
 
public
ÚÚ 

void
ÚÚ 
Dispose
ÚÚ 
(
ÚÚ 
)
ÚÚ 
{
ÛÛ 
if
ÙÙ 

(
ÙÙ 
!
ÙÙ 
	_disposed
ÙÙ 
)
ÙÙ 
{
ıı 	
	_disposed
ˆˆ 
=
ˆˆ 
true
ˆˆ 
;
ˆˆ 
if
˜˜ 
(
˜˜ 
Subject
˜˜ 
is
˜˜ 
Subject
˜˜ "
<
˜˜" #
object
˜˜# )
>
˜˜) *
typedSubject
˜˜+ 7
)
˜˜7 8
{
¯¯ 
typedSubject
˘˘ 
.
˘˘ 
OnCompleted
˘˘ (
(
˘˘( )
)
˘˘) *
;
˘˘* +
typedSubject
˙˙ 
.
˙˙ 
Dispose
˙˙ $
(
˙˙$ %
)
˙˙% &
;
˙˙& '
}
˚˚ 
}
¸¸ 	
}
˝˝ 
}˛˛ ⁄
t/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/IMessageBus.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
;& '
public 
	interface 
IMessageBus 
: 
IDisposable *
{ 
IObservable		 
<		 
TMessage		 
>		 
GetEvent		 "
<		" #
TMessage		# +
>		+ ,
(		, -
)		- .
where		/ 4
TMessage		5 =
:		> ?
class		@ E
;		E F
Task 
PublishAsync	 
< 
TMessage 
> 
(  
TMessage  (
message) 0
,0 1
CancellationToken2 C
cancellationTokenD U
=V W
defaultX _
)_ `
wherea f
TMessageg o
:p q
classr w
;w x
IDisposable 
	Subscribe 
< 
TMessage "
>" #
(# $
Func 
< 
TMessage 
, 
Task 
> 
handler $
,$ % 
SubscriptionLifetime 
lifetime %
=& ' 
SubscriptionLifetime( <
.< =
Strong= C
)C D
whereE J
TMessageK S
:T U
classV [
;[ \
} 
public 
enum  
SubscriptionLifetime  
{ 
Strong 

,
 
Weak 
, 	
Scoped 

} 
public 
	interface 
IMessageRequest  
{ 
string 

	MessageId 
{ 
get 
; 
} 
TimeSpan 
Timeout 
{ 
get 
; 
} 
} 
public!! 
	interface!! 
IMessageResponse!! !
{"" 
string## 

?##
 
CORRELATION_ID## 
{## 
get##  
;##  !
}##" #
}$$ ÿ
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Events/NetworkEvents.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Events' -
;- .
public 
sealed 
record %
ManualRetryRequestedEvent .
{ 
public 

uint 
? 
	ConnectId 
{ 
get  
;  !
}" #
public 

DateTime 
RequestedAt 
{  !
get" %
;% &
}' (
private

 %
ManualRetryRequestedEvent

 %
(

% &
uint

& *
?

* +
	connectId

, 5
,

5 6
DateTime

7 ?
requestedAt

@ K
)

K L
{ 
	ConnectId 
= 
	connectId 
; 
RequestedAt 
= 
requestedAt !
;! "
} 
public 

static %
ManualRetryRequestedEvent +
New, /
(/ 0
uint0 4
?4 5
	connectId6 ?
=@ A
nullB F
)F G
=>H J
new 
( 
	connectId 
, 
DateTime 
.  
UtcNow  &
)& '
;' (
} Æ
à/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Events/MembershipLoggedOutEvent.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Events' -
;- .
public 
record $
MembershipLoggedOutEvent &
(& '
string' -
MembershipId. :
,: ;
string< B
ReasonC I
)I J
;J KÏ
à/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Connectivity/ConnectivityReason.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Connectivity' 3
;3 4
public 
enum 
ConnectivityReason 
{ 
None 
, 	
HandshakeStarted 
, 
HandshakeSucceeded 
, 

RpcFailure 
, 
ManualRetry		 
,		 
Backoff

 
,

 

NoInternet 
, 
InternetRecovered 
, 
ServerShutdown 
, 
RetryLimitReached 
, 
OperationCancelled 
, 
HandshakeFailed 
, 
SecurityError 
, 
Unknown 
} ¥/
Å/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Events/BottomSheetEvents.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Events' -
;- .
public 
enum $
BottomSheetComponentType $
{  
DetectedLocalization 
,  
RedirectNotification		 
,		 
UserRequestError

 
,

 
Hidden 

} 
public 
enum 
AnimationType 
{ 
Show 
, 	
Hide 
} 
public 
sealed 
record #
BottomSheetCommandEvent ,
{ 
public 

AnimationType 
AnimationType &
{' (
get) ,
;, -
}. /
public 
$
BottomSheetComponentType #
ComponentType$ 1
{2 3
get4 7
;7 8
}9 :
public 

UserControl 
? 
Control 
{  !
get" %
;% &
}' (
public 

bool 
	ShowScrim 
{ 
get 
;  
}! "
public 

bool 
IsDismissable 
{ 
get  #
;# $
}% &
public 

DateTime 
	Timestamp 
{ 
get  #
;# $
}% &
private #
BottomSheetCommandEvent #
(# $
AnimationType$ 1
animationType2 ?
,? @$
BottomSheetComponentTypeA Y
componentTypeZ g
,g h
UserControli t
?t u
controlv }
,} ~
bool	 É
	showScrim
Ñ ç
,
ç é
bool
è ì
isDismissable
î °
)
° ¢
{ 
AnimationType 
= 
animationType %
;% &
ComponentType   
=   
componentType   %
;  % &
Control!! 
=!! 
control!! 
;!! 
	ShowScrim"" 
="" 
	showScrim"" 
;"" 
IsDismissable## 
=## 
isDismissable## %
;##% &
	Timestamp$$ 
=$$ 
DateTime$$ 
.$$ 
UtcNow$$ #
;$$# $
}%% 
public'' 

static'' #
BottomSheetCommandEvent'' )
Show''* .
(''. /$
BottomSheetComponentType''/ G
componentType''H U
,''U V
UserControl''W b
?''b c
control''d k
,''k l
bool''m q
	showScrim''r {
,''{ |
bool	''} Å
isDismissable
''Ç è
)
''è ê
=>
''ë ì
new(( 
((( 
AnimationType(( 
.(( 
Show(( 
,(( 
componentType((  -
,((- .
control((/ 6
,((6 7
	showScrim((8 A
,((A B
isDismissable((C P
)((P Q
;((Q R
public** 

static** #
BottomSheetCommandEvent** )
Hide*** .
(**. /
)**/ 0
=>**1 3
new++ 
(++ 
AnimationType++ 
.++ 
Hide++ 
,++ $
BottomSheetComponentType++  8
.++8 9
Hidden++9 ?
,++? @
null++A E
,++E F
false++G L
,++L M
true++N R
)++R S
;++S T
},, 
public.. 
sealed.. 
record.. "
BottomSheetHiddenEvent.. +
{// 
public00 

bool00 
WasDismissedByUser00 "
{00# $
get00% (
;00( )
}00* +
public11 

DateTime11 
	Timestamp11 
{11 
get11  #
;11# $
}11% &
private33 "
BottomSheetHiddenEvent33 "
(33" #
bool33# '
wasDismissedByUser33( :
)33: ;
{44 
WasDismissedByUser55 
=55 
wasDismissedByUser55 /
;55/ 0
	Timestamp66 
=66 
DateTime66 
.66 
UtcNow66 #
;66# $
}77 
public99 

static99 "
BottomSheetHiddenEvent99 (
UserDismissed99) 6
(996 7
)997 8
=>999 ;
new99< ?
(99? @
true99@ D
)99D E
;99E F
}:: 
public<< 
sealed<< 
record<< -
!BottomSheetAnimationCompleteEvent<< 6
{== 
public>> 

AnimationType>> 
AnimationType>> &
{>>' (
get>>) ,
;>>, -
}>>. /
public?? 

DateTime?? 
	Timestamp?? 
{?? 
get??  #
;??# $
}??% &
privateAA -
!BottomSheetAnimationCompleteEventAA -
(AA- .
AnimationTypeAA. ;
animationTypeAA< I
)AAI J
{BB 
AnimationTypeCC 
=CC 
animationTypeCC %
;CC% &
	TimestampDD 
=DD 
DateTimeDD 
.DD 
UtcNowDD #
;DD# $
}EE 
publicGG 

staticGG -
!BottomSheetAnimationCompleteEventGG 3
ShowCompleteGG4 @
(GG@ A
)GGA B
=>GGC E
newGGF I
(GGI J
AnimationTypeGGJ W
.GGW X
ShowGGX \
)GG\ ]
;GG] ^
publicHH 

staticHH -
!BottomSheetAnimationCompleteEventHH 3
HideCompleteHH4 @
(HH@ A
)HHA B
=>HHC E
newHHF I
(HHI J
AnimationTypeHHJ W
.HHW X
HideHHX \
)HH\ ]
;HH] ^
}II ¿
à/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Connectivity/ConnectivityStatus.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Connectivity' 3
;3 4
public 
enum 
ConnectivityStatus 
{ 
	Connected 
, 

Connecting 
, 
Disconnected 
, 

Recovering 
, 
Unavailable		 
,		 
ShuttingDown

 
,

 
RetriesExhausted 
} ¬
à/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Connectivity/ConnectivitySource.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Connectivity' 3
;3 4
public 
enum 
ConnectivitySource 
{ 
System 

,
 

DataCenter 
, 
InternetProbe 
, 
ManualAction 
}		 æ
á/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Events/LanguageDetectionEvents.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Events' -
;- .
public 
enum #
LanguageDetectionAction #
{ 
Decline 
, 
Confirm 
}		 
public 
sealed 
record (
LanguageDetectionDialogEvent 1
{ 
public 
#
LanguageDetectionAction "
Action# )
{* +
get, /
;/ 0
}1 2
public 

string 
? 
TargetCulture  
{! "
get# &
;& '
}( )
public 

DateTime 
	Timestamp 
{ 
get  #
;# $
}% &
private (
LanguageDetectionDialogEvent (
(( )#
LanguageDetectionAction) @
actionA G
,G H
stringI O
?O P
targetCultureQ ^
)^ _
{ 
Action 
= 
action 
; 
TargetCulture 
= 
targetCulture %
;% &
	Timestamp 
= 
DateTime 
. 
UtcNow #
;# $
} 
public 

static (
LanguageDetectionDialogEvent .
Decline/ 6
(6 7
)7 8
=>9 ;
new 
( #
LanguageDetectionAction #
.# $
Decline$ +
,+ ,
null- 1
)1 2
;2 3
public 

static (
LanguageDetectionDialogEvent .
Confirm/ 6
(6 7
string7 =
targetCulture> K
)K L
=>M O
new 
( #
LanguageDetectionAction #
.# $
Confirm$ +
,+ ,
targetCulture- :
): ;
;; <
} é<
ã/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Connectivity/ConnectivityPublisher.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Connectivity' 3
;3 4
internal		 
sealed			 
class		 !
ConnectivityPublisher		 +
:		, -
IDisposable		. 9
{

 
private 
readonly 
BehaviorSubject $
<$ % 
ConnectivitySnapshot% 9
>9 :
_snapshotStream; J
;J K
private 
readonly 
SemaphoreSlim "
_publishGate# /
=0 1
new2 5
(5 6
$num6 7
,7 8
$num9 :
): ;
;; <
private  
ConnectivitySnapshot  
_currentSnapshot! 1
=2 3 
ConnectivitySnapshot4 H
.H I
InitialI P
;P Q
public 
!
ConnectivityPublisher  
(  !
)! "
{ 
_snapshotStream 
= 
new 
BehaviorSubject -
<- . 
ConnectivitySnapshot. B
>B C
(C D
_currentSnapshotD T
)T U
;U V
} 
public 
 
ConnectivitySnapshot 
CurrentSnapshot  /
=>0 2
_currentSnapshot3 C
;C D
public 

IObservable 
<  
ConnectivitySnapshot +
>+ ,
ConnectivityStream- ?
=>@ B
_snapshotStreamC R
;R S
public 

async 
Task 
PublishAsync "
(" #
ConnectivityIntent# 5
intent6 <
,< =
CancellationToken> O
cancellationTokenP a
=b c
defaultd k
)k l
{ 
await 
_publishGate 
. 
	WaitAsync $
($ %
cancellationToken% 6
)6 7
.7 8
ConfigureAwait8 F
(F G
falseG L
)L M
;M N
try 
{ 	
Guid 
correlation 
= 
intent %
.% &
CORRELATION_ID& 4
??5 7
Guid8 <
.< =
NewGuid= D
(D E
)E F
;F G
ConnectivityReason 
reason %
;% &
if   
(   
intent   
.   
Reason   
==    
ConnectivityReason  ! 3
.  3 4
None  4 8
)  8 9
{!! 
reason"" 
="" 
intent"" 
.""  
Failure""  '
is""( *
not""+ .
null""/ 3
?## $
ConnectivityReasonMapper## .
.##. /
FromNetworkFailure##/ A
(##A B
intent##B H
.##H I
Failure##I P
)##P Q
:$$ 
ConnectivityReason$$ (
.$$( )
Unknown$$) 0
;$$0 1
}%% 
else&& 
{'' 
reason(( 
=(( 
intent(( 
.((  
Reason((  &
;((& '
})) 
if++ 
(++ 
reason++ 
==++ 
ConnectivityReason++ ,
.++, -
None++- 1
)++1 2
{,, 
reason-- 
=-- 
ConnectivityReason-- +
.--+ ,
Unknown--, 3
;--3 4
}..  
ConnectivitySnapshot00  
next00! %
=00& '
new00( +
(00+ ,
intent11 
.11 
Status11 
,11 
reason22 
,22 
intent33 
.33 
Source33 
,33 
intent44 
.44 
Failure44 
,44 
intent55 
.55 
	ConnectId55  
,55  !
intent66 
.66 
RetryAttempt66 #
,66# $
intent77 
.77 
RetryBackoff77 #
,77# $
correlation88 
,88 
DateTime99 
.99 
UtcNow99 
)99  
;99  !
_currentSnapshot;; 
=;; 
next;; #
;;;# $
_snapshotStream<< 
.<< 
OnNext<< "
(<<" #
next<<# '
)<<' (
;<<( )
}== 	
finally>> 
{?? 	
_publishGate@@ 
.@@ 
Release@@  
(@@  !
)@@! "
;@@" #
}AA 	
}BB 
publicDD 

voidDD 
DisposeDD 
(DD 
)DD 
{EE 
_snapshotStreamFF 
.FF 
DisposeFF 
(FF  
)FF  !
;FF! "
_publishGateGG 
.GG 
DisposeGG 
(GG 
)GG 
;GG 
}HH 
privateJJ 
staticJJ 
classJJ $
ConnectivityReasonMapperJJ 1
{KK 
publicLL 
staticLL 
ConnectivityReasonLL (
FromNetworkFailureLL) ;
(LL; <
NetworkFailureLL< J
?LLJ K
failureLLL S
)LLS T
{MM 	
ifNN 
(NN 
failureNN 
isNN 
nullNN 
)NN  
{OO 
returnPP 
ConnectivityReasonPP )
.PP) *
UnknownPP* 1
;PP1 2
}QQ 
returnSS 
failureSS 
.SS 
FailureTypeSS &
switchSS' -
{TT 
NetworkFailureTypeUU "
.UU" #
DataCenterShutdownUU# 5
=>UU6 8
ConnectivityReasonUU9 K
.UUK L
ServerShutdownUUL Z
,UUZ [
NetworkFailureTypeVV "
.VV" #
OperationCancelledVV# 5
=>VV6 8
ConnectivityReasonVV9 K
.VVK L
OperationCancelledVVL ^
,VV^ _
NetworkFailureTypeWW "
.WW" #)
CriticalAuthenticationFailureWW# @
=>WWA C
ConnectivityReasonWWD V
.WWV W
SecurityErrorWWW d
,WWd e
NetworkFailureTypeXX "
.XX" #
InvalidRequestTypeXX# 5
=>XX6 8
ConnectivityReasonXX9 K
.XXK L
SecurityErrorXXL Y
,XXY Z
NetworkFailureTypeYY "
.YY" ##
EcliptixProtocolFailureYY# :
=>YY; =
ConnectivityReasonYY> P
.YYP Q
SecurityErrorYYQ ^
,YY^ _
NetworkFailureTypeZZ "
.ZZ" # 
RsaEncryptionFailureZZ# 7
=>ZZ8 :
ConnectivityReasonZZ; M
.ZZM N
SecurityErrorZZN [
,ZZ[ \
NetworkFailureType[[ "
.[[" #!
ProtocolStateMismatch[[# 8
=>[[9 ;
ConnectivityReason[[< N
.[[N O
SecurityError[[O \
,[[\ ]
NetworkFailureType\\ "
.\\" #
ConnectionFailed\\# 3
=>\\4 6
ConnectivityReason\\7 I
.\\I J
HandshakeFailed\\J Y
,\\Y Z
NetworkFailureType]] "
.]]" ##
DataCenterNotResponding]]# :
=>]]; =
ConnectivityReason]]> P
.]]P Q

RpcFailure]]Q [
,]][ \
_^^ 
=>^^ 
ConnectivityReason^^ '
.^^' (
Unknown^^( /
}__ 
;__ 
}`` 	
}aa 
}bb ‰F
à/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Connectivity/ConnectivityModels.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Connectivity' 3
;3 4
public 
readonly 
record 
struct  
ConnectivitySnapshot 2
(2 3
ConnectivityStatus 
Status 
, 
ConnectivityReason 
Reason 
, 
ConnectivitySource		 
Source		 
,		 
NetworkFailure

 
?

 
Failure

 
,

 
uint 
? 	
	ConnectId
 
, 
int 
? 
RetryAttempt	 
, 
TimeSpan 
? 
RetryBackoff 
, 
Guid 
CORRELATION_ID	 
, 
DateTime 

OccurredAt 
) 
{ 
public 

static 
readonly  
ConnectivitySnapshot /
Initial0 7
=8 9
new: =
(= >
ConnectivityStatus 
. 
	Connected $
,$ %
ConnectivityReason 
. 
None 
,  
ConnectivitySource 
. 
System !
,! "
null 
, 
null 
, 
null 
, 
null 
, 
Guid 
. 
Empty 
, 
DateTime 
. 
MinValue 
) 
; 
} 
public 
readonly 
record 
struct 
ConnectivityIntent 0
(0 1
ConnectivityStatus 
Status 
, 
ConnectivityReason 
Reason 
, 
ConnectivitySource   
Source   
,   
NetworkFailure!! 
?!! 
Failure!! 
=!! 
null!! "
,!!" #
uint"" 
?"" 	
	ConnectId""
 
="" 
null"" 
,"" 
int## 
?## 
RetryAttempt##	 
=## 
null## 
,## 
TimeSpan$$ 
?$$ 
RetryBackoff$$ 
=$$ 
null$$ !
,$$! "
Guid%% 
?%% 	
CORRELATION_ID%%
 
=%% 
null%% 
)%%  
{&& 
public'' 

static'' 
ConnectivityIntent'' $
	Connected''% .
(''. /
uint''/ 3
?''3 4
	connectId''5 >
=''? @
null''A E
,''E F
ConnectivityReason''G Y
reason''Z `
=''a b
ConnectivityReason''c u
.''u v
HandshakeSucceeded	''v à
)
''à â
=>
''ä å
new(( 
((( 
ConnectivityStatus(( 
.(( 
	Connected(( (
,((( )
reason((* 0
,((0 1
ConnectivitySource((2 D
.((D E

DataCenter((E O
,((O P
null((Q U
,((U V
	connectId((W `
)((` a
;((a b
public** 

static** 
ConnectivityIntent** $

Connecting**% /
(**/ 0
uint**0 4
?**4 5
	connectId**6 ?
=**@ A
null**B F
,**F G
ConnectivityReason**H Z
reason**[ a
=**b c
ConnectivityReason**d v
.**v w
HandshakeStarted	**w á
,
**á à 
ConnectivitySource
**â õ
source
**ú ¢
=
**£ § 
ConnectivitySource
**• ∑
.
**∑ ∏

DataCenter
**∏ ¬
)
**¬ √
=>
**ƒ ∆
new++ 
(++ 
ConnectivityStatus++ 
.++ 

Connecting++ )
,++) *
reason+++ 1
,++1 2
source++3 9
,++9 :
null++; ?
,++? @
	connectId++A J
)++J K
;++K L
public-- 

static-- 
ConnectivityIntent-- $
Disconnected--% 1
(--1 2
NetworkFailure--2 @
failure--A H
,--H I
uint--J N
?--N O
	connectId--P Y
=--Z [
null--\ `
,--` a
ConnectivityReason--b t
reason--u {
=--| }
ConnectivityReason	--~ ê
.
--ê ë

RpcFailure
--ë õ
,
--õ ú 
ConnectivitySource
--ù Ø
source
--∞ ∂
=
--∑ ∏ 
ConnectivitySource
--π À
.
--À Ã

DataCenter
--Ã ÷
)
--÷ ◊
=>
--ÿ ⁄
new.. 
(.. 
ConnectivityStatus.. 
... 
Disconnected.. +
,..+ ,
reason..- 3
,..3 4
source..5 ;
,..; <
failure..= D
,..D E
	connectId..F O
)..O P
;..P Q
public00 

static00 
ConnectivityIntent00 $

Recovering00% /
(00/ 0
NetworkFailure000 >
failure00? F
,00F G
uint00H L
?00L M
	connectId00N W
=00X Y
null00Z ^
,00^ _
int00` c
?00c d
retryAttempt00e q
=00r s
null00t x
,00x y
TimeSpan	00z Ç
?
00Ç É
backoff
00Ñ ã
=
00å ç
null
00é í
)
00í ì
=>
00î ñ
new11 
(11 
ConnectivityStatus11 
.11 

Recovering11 )
,11) *
ConnectivityReason11+ =
.11= >
Backoff11> E
,11E F
ConnectivitySource11G Y
.11Y Z
System11Z `
,11` a
failure11b i
,11i j
	connectId11k t
,11t u
retryAttempt	11v Ç
,
11Ç É
backoff
11Ñ ã
)
11ã å
;
11å ç
public33 

static33 
ConnectivityIntent33 $
RetriesExhausted33% 5
(335 6
NetworkFailure336 D
failure33E L
,33L M
uint33N R
?33R S
	connectId33T ]
=33^ _
null33` d
,33d e
int33f i
?33i j
retries33k r
=33s t
null33u y
)33y z
=>33{ }
new44 
(44 
ConnectivityStatus44 
.44 
RetriesExhausted44 /
,44/ 0
ConnectivityReason441 C
.44C D
RetryLimitReached44D U
,44U V
ConnectivitySource44W i
.44i j
System44j p
,44p q
failure44r y
,44y z
	connectId	44{ Ñ
,
44Ñ Ö
retries
44Ü ç
)
44ç é
;
44é è
public66 

static66 
ConnectivityIntent66 $
InternetLost66% 1
(661 2
)662 3
=>664 6
new77 
(77 
ConnectivityStatus77 
.77 
Unavailable77 *
,77* +
ConnectivityReason77, >
.77> ?

NoInternet77? I
,77I J
ConnectivitySource77K ]
.77] ^
InternetProbe77^ k
)77k l
;77l m
public99 

static99 
ConnectivityIntent99 $
InternetRecovered99% 6
(996 7
)997 8
=>999 ;
new:: 
(:: 
ConnectivityStatus:: 
.:: 

Connecting:: )
,::) *
ConnectivityReason::+ =
.::= >
InternetRecovered::> O
,::O P
ConnectivitySource::Q c
.::c d
InternetProbe::d q
)::q r
;::r s
public<< 

static<< 
ConnectivityIntent<< $
ManualRetry<<% 0
(<<0 1
uint<<1 5
?<<5 6
	connectId<<7 @
=<<A B
null<<C G
)<<G H
=><<I K
new== 
(== 
ConnectivityStatus== 
.== 

Connecting== )
,==) *
ConnectivityReason==+ =
.=== >
ManualRetry==> I
,==I J
ConnectivitySource==K ]
.==] ^
ManualAction==^ j
,==j k
null==l p
,==p q
	connectId==r {
)=={ |
;==| }
public?? 

static?? 
ConnectivityIntent?? $
ServerShutdown??% 3
(??3 4
NetworkFailure??4 B
failure??C J
)??J K
=>??L N
new@@ 
(@@ 
ConnectivityStatus@@ 
.@@ 
ShuttingDown@@ +
,@@+ ,
ConnectivityReason@@- ?
.@@? @
ServerShutdown@@@ N
,@@N O
ConnectivitySource@@P b
.@@b c

DataCenter@@c m
,@@m n
failure@@o v
)@@v w
;@@w x
}AA ít
|/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Controls/ModuleContentControl.cs
	namespace		 	
Ecliptix		
 
.		 
Core		 
.		 
Core		 
.		 
Controls		 %
;		% &
public 
sealed 
class  
ModuleContentControl (
:) *
ContentControl+ 9
{ 
private 
readonly 
IModuleViewFactory '
?' (
_moduleViewFactory) ;
;; <
public 

static 
readonly 
StyledProperty )
<) *
object* 0
?0 1
>1 2$
ViewModelContentProperty3 K
=L M
AvaloniaProperty 
. 
Register !
<! " 
ModuleContentControl" 6
,6 7
object8 >
?> ?
>? @
(@ A
nameofA G
(G H
ViewModelContentH X
)X Y
)Y Z
;Z [
public 

object 
? 
ViewModelContent #
{ 
get 
=> 
GetValue 
( $
ViewModelContentProperty 0
)0 1
;1 2
set 
=> 
SetValue 
( $
ViewModelContentProperty 0
,0 1
value2 7
)7 8
;8 9
} 
public 
 
ModuleContentControl 
(  
)  !
{ 
try 
{ 	
_moduleViewFactory 
=  
Locator! (
.( )
Current) 0
?0 1
.1 2

GetService2 <
<< =
IModuleViewFactory= O
>O P
(P Q
)Q R
;R S
} 	
catch 
{ 	
_moduleViewFactory   
=    
null  ! %
;  % &
}!! 	
}"" 
static$$ 
 
ModuleContentControl$$ 
($$  
)$$  !
{%% $
ViewModelContentProperty&&  
.&&  !
Changed&&! (
.&&( )
AddClassHandler&&) 8
<&&8 9 
ModuleContentControl&&9 M
>&&M N
(&&N O
(&&O P
control&&P W
,&&W X
e&&Y Z
)&&Z [
=>&&\ ^
control'' 
.'' %
OnViewModelContentChanged'' -
(''- .
e''. /
.''/ 0
NewValue''0 8
)''8 9
)''9 :
;'': ;
}(( 
private** 
void** %
OnViewModelContentChanged** *
(*** +
object**+ 1
?**1 2
newViewModel**3 ?
)**? @
{++ 
Serilog,, 
.,, 
Log,, 
.,, 
Information,, 
(,,  
$str-- f
,--f g
newViewModel.. 
?.. 
... 
GetType.. !
(..! "
).." #
...# $
Name..$ (
??..) +
$str.., 2
)..2 3
;..3 4
if// 

(// 
newViewModel// 
==// 
null//  
)//  !
{00 	
Content11 
=11 
null11 
;11 
return22 
;22 
}33 	*
TryCreateViewWithModuleFactory55 &
(55& '
newViewModel55' 3
)553 4
.66 
Or66 
(66 
(66 
)66 
=>66 )
TryCreateViewWithStaticMapper66 3
(663 4
newViewModel664 @
)66@ A
.66A B
ToOption66B J
(66J K
)66K L
)66L M
.77 
Match77 
(77 
view88 
=>88 
{99 
view:: 
.:: 
DataContext:: $
=::% &
newViewModel::' 3
;::3 4
Content;; 
=;; 
view;; "
;;;" #
Serilog<< 
.<< 
Log<< 
.<<  
Information<<  +
(<<+ ,
$str== r
,==r s
view>> 
.>> 
GetType>> $
(>>$ %
)>>% &
.>>& '
Name>>' +
,>>+ ,
newViewModel>>- 9
.>>9 :
GetType>>: A
(>>A B
)>>B C
.>>C D
Name>>D H
)>>H I
;>>I J
}?? 
,?? 
(@@ 
)@@ 
=>@@ 
{AA 
ContentBB 
=BB 
CreateFallbackViewBB 0
(BB0 1
)BB1 2
;BB2 3
SerilogCC 
.CC 
LogCC 
.CC  
WarningCC  '
(CC' (
$strCC( ~
,CC~ 
newViewModelDD $
.DD$ %
GetTypeDD% ,
(DD, -
)DD- .
.DD. /
NameDD/ 3
)DD3 4
;DD4 5
}EE 
)EE 
;EE 
}FF 
privateHH 
OptionHH 
<HH 
ControlHH 
>HH *
TryCreateViewWithModuleFactoryHH :
(HH: ;
objectHH; A
	viewModelHHB K
)HHK L
{II 
ifJJ 

(JJ 
_moduleViewFactoryJJ 
==JJ !
nullJJ" &
)JJ& '
{KK 	
returnLL 
OptionLL 
<LL 
ControlLL !
>LL! "
.LL" #
NoneLL# '
;LL' (
}MM 	
tryOO 
{PP 	
SerilogQQ 
.QQ 
LogQQ 
.QQ 
InformationQQ #
(QQ# $
$strQQ$ v
,QQv w
	viewModelRR 
.RR 
GetTypeRR !
(RR! "
)RR" #
.RR# $
FullNameRR$ ,
)RR, -
;RR- .
OptionTT 
<TT 
ControlTT 
>TT 
resultTT "
=TT# $
_moduleViewFactoryTT% 7
.TT7 8

CreateViewTT8 B
(TTB C
	viewModelTTC L
.TTL M
GetTypeTTM T
(TTT U
)TTU V
)TTV W
;TTW X
resultVV 
.VV 
MatchVV 
(VV 
viewWW 
=>WW 
SerilogWW 
.WW  
LogWW  #
.WW# $
InformationWW$ /
(WW/ 0
$strXX ^
,XX^ _
viewYY 
.YY 
GetTypeYY  
(YY  !
)YY! "
.YY" #
NameYY# '
,YY' (
	viewModelYY) 2
.YY2 3
GetTypeYY3 :
(YY: ;
)YY; <
.YY< =
NameYY= A
)YYA B
,YYB C
(ZZ 
)ZZ 
=>ZZ 
SerilogZZ 
.ZZ 
LogZZ !
.ZZ! "
DebugZZ" '
(ZZ' (
$str[[ U
,[[U V
	viewModel\\ 
.\\ 
GetType\\ %
(\\% &
)\\& '
.\\' (
Name\\( ,
)\\, -
)\\- .
;\\. /
return^^ 
result^^ 
;^^ 
}__ 	
catch`` 
(`` 
	Exception`` 
ex`` 
)`` 
{aa 	
Serilogbb 
.bb 
Logbb 
.bb 
Errorbb 
(bb 
exbb  
,bb  !
$strbb" q
,bbq r
	viewModelcc 
.cc 
GetTypecc !
(cc! "
)cc" #
.cc# $
FullNamecc$ ,
)cc, -
;cc- .
returndd 
Optiondd 
<dd 
Controldd !
>dd! "
.dd" #
Nonedd# '
;dd' (
}ee 	
}ff 
privatehh 
statichh 
Controlhh 
?hh )
TryCreateViewWithStaticMapperhh 9
(hh9 :
objecthh: @
	viewModelhhA J
)hhJ K
{ii 
Serilogjj 
.jj 
Logjj 
.jj 
Informationjj 
(jj  
$strjj  q
,jjq r
	viewModelkk 
.kk 
GetTypekk 
(kk 
)kk 
.kk  
FullNamekk  (
)kk( )
;kk) *
tryll 
{mm 	
Controlnn 
?nn 
resultnn 
=nn 
	viewModelnn '
switchnn( .
{oo 
Featurespp 
.pp 
Authenticationpp '
.pp' (

ViewModelspp( 2
.pp2 3
Hostspp3 8
.pp8 9#
AuthenticationViewModelpp9 P
=>ppQ S
newqq 
Featuresqq  
.qq  !
Authenticationqq! /
.qq/ 0
Viewsqq0 5
.qq5 6
Hostsqq6 ;
.qq; <
AuthenticationViewqq< N
(qqN O
)qqO P
,qqP Q
Featuresrr 
.rr 
Mainrr 
.rr 

ViewModelsrr (
.rr( )
MasterViewModelrr) 8
=>rr9 ;
newss 
Featuresss  
.ss  !
Mainss! %
.ss% &
Viewsss& +
.ss+ ,

MasterViewss, 6
(ss6 7
)ss7 8
,ss8 9
Featurestt 
.tt 
Authenticationtt '
.tt' (

ViewModelstt( 2
.tt2 3
SignIntt3 9
.tt9 :
SignInViewModeltt: I
=>ttJ L
StaticViewMapperttM ]
.tt] ^

CreateViewtt^ h
(tth i
typeofuu 
(uu 
Featuresuu #
.uu# $
Authenticationuu$ 2
.uu2 3

ViewModelsuu3 =
.uu= >
SignInuu> D
.uuD E
SignInViewModeluuE T
)uuT U
)uuU V
,uuV W
Featuresvv 
.vv 
Authenticationvv '
.vv' (

ViewModelsvv( 2
.vv2 3
Registrationvv3 ?
.vv? @'
MobileVerificationViewModelvv@ [
=>vv\ ^
StaticViewMapperww $
.ww$ %

CreateViewww% /
(ww/ 0
typeofxx 
(xx 
Featuresyy $
.yy$ %
Authenticationyy% 3
.yy3 4

ViewModelsyy4 >
.yy> ?
Registrationyy? K
.yyK L'
MobileVerificationViewModelyyL g
)yyg h
)yyh i
,yyi j
Featureszz 
.zz 
Authenticationzz '
.zz' (

ViewModelszz( 2
.zz2 3
Registrationzz3 ?
.zz? @
VerifyOtpViewModelzz@ R
=>zzS U
StaticViewMapper{{ $
.{{$ %

CreateView{{% /
({{/ 0
typeof|| 
(|| 
Features|| '
.||' (
Authentication||( 6
.||6 7

ViewModels||7 A
.||A B
Registration||B N
.||N O
VerifyOtpViewModel||O a
)||a b
)||b c
,||c d
Features}} 
.}} 
Authentication}} '
.}}' (

ViewModels}}( 2
.}}2 3
Registration}}3 ?
.}}? @&
SecureKeyVerifierViewModel}}@ Z
=>}}[ ]
StaticViewMapper~~ $
.~~$ %

CreateView~~% /
(~~/ 0
typeof 
( 
Features '
.' (
Authentication( 6
.6 7

ViewModels7 A
.A B
RegistrationB N
.N O(
SecureKeyVerifierViewModel
ÄÄ 6
)
ÄÄ6 7
)
ÄÄ7 8
,
ÄÄ8 9
Features
ÅÅ 
.
ÅÅ 
Authentication
ÅÅ '
.
ÅÅ' (

ViewModels
ÅÅ( 2
.
ÅÅ2 3
Registration
ÅÅ3 ?
.
ÅÅ? @ 
PassPhaseViewModel
ÅÅ@ R
=>
ÅÅS U
StaticViewMapper
ÇÇ $
.
ÇÇ$ %

CreateView
ÇÇ% /
(
ÇÇ/ 0
typeof
ÉÉ 
(
ÉÉ 
Features
ÉÉ '
.
ÉÉ' (
Authentication
ÉÉ( 6
.
ÉÉ6 7

ViewModels
ÉÉ7 A
.
ÉÉA B
Registration
ÉÉB N
.
ÉÉN O 
PassPhaseViewModel
ÉÉO a
)
ÉÉa b
)
ÉÉb c
,
ÉÉc d
Features
ÑÑ 
.
ÑÑ 
Authentication
ÑÑ '
.
ÑÑ' (

ViewModels
ÑÑ( 2
.
ÑÑ2 3
Welcome
ÑÑ3 :
.
ÑÑ: ;
WelcomeViewModel
ÑÑ; K
=>
ÑÑL N
StaticViewMapper
ÖÖ $
.
ÖÖ$ %

CreateView
ÖÖ% /
(
ÖÖ/ 0
typeof
ÜÜ 
(
ÜÜ 
Ecliptix
ÜÜ '
.
ÜÜ' (
Core
ÜÜ( ,
.
ÜÜ, -
Features
ÜÜ- 5
.
ÜÜ5 6
Authentication
ÜÜ6 D
.
ÜÜD E

ViewModels
ÜÜE O
.
ÜÜO P
Welcome
ÜÜP W
.
ÜÜW X
WelcomeViewModel
ÜÜX h
)
ÜÜh i
)
ÜÜi j
,
ÜÜj k
_
áá 
=>
áá 
null
áá 
}
àà 
;
àà 
Serilog
ââ 
.
ââ 
Log
ââ 
.
ââ 
Information
ââ #
(
ââ# $
$str
ää k
,
ääk l
	viewModel
ãã 
.
ãã 
GetType
ãã !
(
ãã! "
)
ãã" #
.
ãã# $
FullName
ãã$ ,
,
ãã, -
result
ãã. 4
?
ãã4 5
.
ãã5 6
GetType
ãã6 =
(
ãã= >
)
ãã> ?
.
ãã? @
Name
ãã@ D
??
ããE G
$str
ããH N
)
ããN O
;
ããO P
return
åå 
result
åå 
;
åå 
}
çç 	
catch
éé 
(
éé 
	Exception
éé 
ex
éé 
)
éé 
{
èè 	
Serilog
êê 
.
êê 
Log
êê 
.
êê 
Error
êê 
(
êê 
ex
êê  
,
êê  !
$str
êê" p
,
êêp q
	viewModel
ëë 
.
ëë 
GetType
ëë !
(
ëë! "
)
ëë" #
.
ëë# $
FullName
ëë$ ,
)
ëë, -
;
ëë- .
return
íí 
null
íí 
;
íí 
}
ìì 	
}
îî 
private
ññ 
static
ññ 
Control
ññ  
CreateFallbackView
ññ -
(
ññ- .
)
ññ. /
{
óó 
return
òò 
new
òò 
	TextBlock
òò 
{
ôô 	
Text
öö 
=
öö 
$str
öö ?
,
öö? @!
HorizontalAlignment
õõ 
=
õõ  !
Avalonia
õõ" *
.
õõ* +
Layout
õõ+ 1
.
õõ1 2!
HorizontalAlignment
õõ2 E
.
õõE F
Center
õõF L
,
õõL M
VerticalAlignment
úú 
=
úú 
Avalonia
úú  (
.
úú( )
Layout
úú) /
.
úú/ 0
VerticalAlignment
úú0 A
.
úúA B
Center
úúB H
}
ùù 	
;
ùù	 

}
ûû 
}üü –±
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Communication/ModuleMessageBus.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Communication *
;* +
public 
sealed 
class 
ModuleMessageBus $
:% &
IModuleMessageBus' 8
,8 9
IDisposable: E
{ 
private 
const 
int (
MAX_PROCESSING_TIMES_SAMPLES 2
=3 4
$num5 9
;9 :
private 
readonly  
ConcurrentDictionary )
<) *
Type* .
,. /
ConcurrentBag0 =
<= > 
IMessageSubscription> R
>R S
>S T
_subscriptionsU c
=d e
newf i
(i j
)j k
;k l
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1 
TaskCompletionSource2 F
<F G
IModuleMessageG U
>U V
>V W
_pendingRequestsX h
=i j
newk n
(n o
)o p
;p q
private 
readonly 
Channel 
< 
IModuleMessage +
>+ ,
_messageChannel- <
;< =
private 
readonly 
ChannelWriter "
<" #
IModuleMessage# 1
>1 2
_messageWriter3 A
;A B
private 
readonly 
Task "
_messageProcessingTask 0
;0 1
private 
readonly #
CancellationTokenSource ,$
_cancellationTokenSource- E
=F G
newH K
(K L
)L M
;M N
private 
readonly 
ConcurrentQueue $
<$ %
double% +
>+ ,
_processingTimes- =
=> ?
new@ C
(C D
)D E
;E F
private 
long 
_totalMessagesSent #
;# $
private 
long !
_totalEventsPublished &
;& '
private 
long #
_totalRequestsProcessed (
;( )
public 

ModuleMessageBus 
( 
) 
{ 
Channel 
< 
IModuleMessage 
> 
options  '
=( )
Channel* 1
.1 2
CreateUnbounded2 A
<A B
IModuleMessageB P
>P Q
(Q R
)R S
;S T
_messageChannel 
= 
options !
;! "
_messageWriter   
=   
options    
.    !
Writer  ! '
;  ' ("
_messageProcessingTask"" 
=""   
ProcessMessagesAsync""! 5
(""5 6$
_cancellationTokenSource""6 N
.""N O
Token""O T
)""T U
;""U V
}## 
public%% 

async%% 
Task%% 
PublishAsync%% "
<%%" #
T%%# $
>%%$ %
(%%% &
T%%& '
eventMessage%%( 4
,%%4 5
CancellationToken%%6 G
cancellationToken%%H Y
=%%Z [
default%%\ c
)%%c d
where&& 
T&& 
:&& 
ModuleEvent&& 
{'' 
await(( 
_messageWriter(( 
.(( 

WriteAsync(( '
(((' (
eventMessage((( 4
,((4 5
cancellationToken((6 G
)((G H
;((H I
Interlocked)) 
.)) 
	Increment)) 
()) 
ref)) !!
_totalEventsPublished))" 7
)))7 8
;))8 9
}** 
public,, 

async,, 
Task,, 
<,, 
	TResponse,, 
?,,  
>,,  !
RequestAsync,," .
<,,. /
TRequest,,/ 7
,,,7 8
	TResponse,,9 B
>,,B C
(,,C D
TRequest-- 
request-- 
,-- 
CancellationToken.. 
cancellationToken.. +
=.., -
default... 5
)..5 6
where// 
TRequest// 
:// 
ModuleRequest// &
where00 
	TResponse00 
:00 
ModuleResponse00 (
{11  
TaskCompletionSource22 
<22 
IModuleMessage22 +
>22+ ,
tcs22- 0
=221 2
new223 6
(226 7
)227 8
;228 9
_pendingRequests33 
[33 
request33  
.33  !
	MessageId33! *
]33* +
=33, -
tcs33. 1
;331 2
try55 
{66 	
await77 
_messageWriter77  
.77  !

WriteAsync77! +
(77+ ,
request77, 3
,773 4
cancellationToken775 F
)77F G
;77G H
using99 #
CancellationTokenSource99 )

timeoutCts99* 4
=995 6#
CancellationTokenSource:: '
.::' (#
CreateLinkedTokenSource::( ?
(::? @
cancellationToken::@ Q
)::Q R
;::R S

timeoutCts;; 
.;; 
CancelAfter;; "
(;;" #
request;;# *
.;;* +
Timeout;;+ 2
);;2 3
;;;3 4
Task== 
<== 
IModuleMessage== 
>==  
responseTask==! -
===. /
tcs==0 3
.==3 4
Task==4 8
;==8 9
Task>> 
timeoutTask>> 
=>> 
Task>> #
.>># $
Delay>>$ )
(>>) *
request>>* 1
.>>1 2
Timeout>>2 9
,>>9 :

timeoutCts>>; E
.>>E F
Token>>F K
)>>K L
;>>L M
Task@@ 
completedTask@@ 
=@@  
await@@! &
Task@@' +
.@@+ ,
WhenAny@@, 3
(@@3 4
responseTask@@4 @
,@@@ A
timeoutTask@@B M
)@@M N
;@@N O
ifBB 
(BB 
completedTaskBB 
==BB  
timeoutTaskBB! ,
)BB, -
{CC 
returnDD 
nullDD 
;DD 
}EE 
IModuleMessageGG 
responseGG #
=GG$ %
awaitGG& +
responseTaskGG, 8
;GG8 9
InterlockedHH 
.HH 
	IncrementHH !
(HH! "
refHH" %#
_totalRequestsProcessedHH& =
)HH= >
;HH> ?
returnJJ 
responseJJ 
asJJ 
	TResponseJJ (
;JJ( )
}KK 	
finallyLL 
{MM 	
_pendingRequestsNN 
.NN 
	TryRemoveNN &
(NN& '
requestNN' .
.NN. /
	MessageIdNN/ 8
,NN8 9
outNN: =
_NN> ?
)NN? @
;NN@ A
}OO 	
}PP 
publicRR 

asyncRR 
TaskRR 
	SendAsyncRR 
<RR  
TRR  !
>RR! "
(RR" #
TRR# $
messageRR% ,
,RR, -
CancellationTokenRR. ?
cancellationTokenRR@ Q
=RRR S
defaultRRT [
)RR[ \
whereRR] b
TRRc d
:RRe f
IModuleMessageRRg u
{SS 
awaitTT 
_messageWriterTT 
.TT 

WriteAsyncTT '
(TT' (
messageTT( /
,TT/ 0
cancellationTokenTT1 B
)TTB C
;TTC D
InterlockedUU 
.UU 
	IncrementUU 
(UU 
refUU !
_totalMessagesSentUU" 4
)UU4 5
;UU5 6
}VV 
publicXX 

IDisposableXX 
	SubscribeXX  
<XX  !
TXX! "
>XX" #
(XX# $
FuncXX$ (
<XX( )
TXX) *
,XX* +
TaskXX, 0
>XX0 1
handlerXX2 9
)XX9 :
whereXX; @
TXXA B
:XXC D
IModuleMessageXXE S
{YY 
returnZZ 
	SubscribeZZ 
(ZZ 
_ZZ 
=>ZZ 
trueZZ "
,ZZ" #
handlerZZ$ +
)ZZ+ ,
;ZZ, -
}[[ 
public]] 

IDisposable]] 
	Subscribe]]  
<]]  !
T]]! "
>]]" #
(]]# $
Func]]$ (
<]]( )
T]]) *
,]]* +
bool]], 0
>]]0 1
filter]]2 8
,]]8 9
Func]]: >
<]]> ?
T]]? @
,]]@ A
Task]]B F
>]]F G
handler]]H O
)]]O P
where]]Q V
T]]W X
:]]Y Z
IModuleMessage]][ i
{^^ 
Type__ 
messageType__ 
=__ 
typeof__ !
(__! "
T__" #
)__# $
;__$ %
MessageSubscription`` 
<`` 
T`` 
>`` 
subscription`` +
=``, -
new``. 1
(``1 2
filter``2 8
,``8 9
handler``: A
)``A B
;``B C
_subscriptionsbb 
.bb 
AddOrUpdatebb "
(bb" #
messageTypebb# .
,bb. /
_cc 
=>cc 
[cc 
subscriptioncc 
]cc 
,cc  
(dd 
_dd 
,dd 
existingdd 
)dd 
=>dd 
{ee 
existingff 
.ff 
Addff 
(ff 
subscriptionff )
)ff) *
;ff* +
returngg 
existinggg 
;gg  
}hh 
)hh 
;hh 
returnjj 
newjj 
DisposableActionjj #
(jj# $
(jj$ %
)jj% &
=>jj' )
{kk 	
ifll 
(ll 
!ll 
_subscriptionsll 
.ll  
TryGetValuell  +
(ll+ ,
messageTypell, 7
,ll7 8
outll9 <
ConcurrentBagll= J
<llJ K 
IMessageSubscriptionllK _
>ll_ `
?ll` a
subscriptionsllb o
)llo p
)llp q
{mm 
returnnn 
;nn 
}oo 
ConcurrentBagqq 
<qq  
IMessageSubscriptionqq .
>qq. /
newBagqq0 6
=qq7 8
[qq9 :
]qq: ;
;qq; <
foreachrr 
(rr  
IMessageSubscriptionrr )
subrr* -
inrr. 0
subscriptionsrr1 >
.rr> ?
Whererr? D
(rrD E
srrE F
=>rrG I
srrJ K
!=rrL N
subscriptionrrO [
)rr[ \
)rr\ ]
{ss 
newBagtt 
.tt 
Addtt 
(tt 
subtt 
)tt 
;tt  
}uu 
_subscriptionsww 
[ww 
messageTypeww &
]ww& '
=ww( )
newBagww* 0
;ww0 1
}xx 	
)xx	 

;xx
 
}yy 
public{{ 

MessageBusStats{{ 
GetStats{{ #
({{# $
){{$ %
{|| 
int}} 
activeSubscriptions}} 
=}}  !
_subscriptions}}" 0
.}}0 1
Values}}1 7
.}}7 8
Sum}}8 ;
(}}; <
bag}}< ?
=>}}@ B
bag}}C F
.}}F G
Count}}G L
)}}L M
;}}M N
double~~ 
avgProcessingTime~~  
=~~! "
$num~~# $
;~~$ %
if
ÄÄ 

(
ÄÄ 
_processingTimes
ÄÄ 
.
ÄÄ 
Count
ÄÄ "
>
ÄÄ# $
$num
ÄÄ% &
)
ÄÄ& '
{
ÅÅ 	
avgProcessingTime
ÇÇ 
=
ÇÇ 
_processingTimes
ÇÇ  0
.
ÇÇ0 1
ToArray
ÇÇ1 8
(
ÇÇ8 9
)
ÇÇ9 :
.
ÇÇ: ;
Average
ÇÇ; B
(
ÇÇB C
)
ÇÇC D
;
ÇÇD E
}
ÉÉ 	
return
ÖÖ 
new
ÖÖ 
MessageBusStats
ÖÖ "
{
ÜÜ 	!
ActiveSubscriptions
áá 
=
áá  !!
activeSubscriptions
áá" 5
,
áá5 6
TotalMessagesSent
àà 
=
àà 
Interlocked
àà  +
.
àà+ ,
Read
àà, 0
(
àà0 1
ref
àà1 4 
_totalMessagesSent
àà5 G
)
ààG H
,
ààH I"
TotalEventsPublished
ââ  
=
ââ! "
Interlocked
ââ# .
.
ââ. /
Read
ââ/ 3
(
ââ3 4
ref
ââ4 7#
_totalEventsPublished
ââ8 M
)
ââM N
,
ââN O$
TotalRequestsProcessed
ää "
=
ää# $
Interlocked
ää% 0
.
ää0 1
Read
ää1 5
(
ää5 6
ref
ää6 9%
_totalRequestsProcessed
ää: Q
)
ääQ R
,
ääR S%
AverageProcessingTimeMs
ãã #
=
ãã$ %
avgProcessingTime
ãã& 7
,
ãã7 8
PendingRequests
åå 
=
åå 
_pendingRequests
åå .
.
åå. /
Count
åå/ 4
}
çç 	
;
çç	 

}
éé 
private
êê 
async
êê 
Task
êê "
ProcessMessagesAsync
êê +
(
êê+ ,
CancellationToken
êê, =
cancellationToken
êê> O
)
êêO P
{
ëë 
await
íí 
foreach
íí 
(
íí 
IModuleMessage
íí %
message
íí& -
in
íí. 0
_messageChannel
íí1 @
.
íí@ A
Reader
ííA G
.
ííG H
ReadAllAsync
ííH T
(
ííT U
cancellationToken
ííU f
)
ííf g
)
ííg h
{
ìì 	
DateTime
îî 
	startTime
îî 
=
îî  
DateTime
îî! )
.
îî) *
UtcNow
îî* 0
;
îî0 1
try
ññ 
{
óó 
await
òò '
ProcessSingleMessageAsync
òò /
(
òò/ 0
message
òò0 7
)
òò7 8
;
òò8 9
}
ôô 
catch
öö 
(
öö 
	Exception
öö 
ex
öö 
)
öö  
{
õõ 
Serilog
úú 
.
úú 
Log
úú 
.
úú 
Error
úú !
(
úú! "
ex
úú" $
,
úú$ %
$str
úú& k
,
úúk l
message
ùù 
?
ùù 
.
ùù 
GetType
ùù $
(
ùù$ %
)
ùù% &
.
ùù& '
Name
ùù' +
??
ùù, .
$str
ùù/ 8
)
ùù8 9
;
ùù9 :
}
ûû 
finally
üü 
{
†† 
double
°° 
processingTime
°° %
=
°°& '
(
°°( )
DateTime
°°) 1
.
°°1 2
UtcNow
°°2 8
-
°°9 :
	startTime
°°; D
)
°°D E
.
°°E F
TotalMilliseconds
°°F W
;
°°W X"
RecordProcessingTime
¢¢ $
(
¢¢$ %
processingTime
¢¢% 3
)
¢¢3 4
;
¢¢4 5
}
££ 
}
§§ 	
}
•• 
private
ßß 
async
ßß 
Task
ßß '
ProcessSingleMessageAsync
ßß 0
(
ßß0 1
IModuleMessage
ßß1 ?
message
ßß@ G
)
ßßG H
{
®® 
if
©© 

(
©© 
message
©© 
is
©© 
ModuleResponse
©© %
response
©©& .
&&
©©/ 1
!
©©2 3
string
©©3 9
.
©©9 :
IsNullOrEmpty
©©: G
(
©©G H
response
©©H P
.
©©P Q
CORRELATION_ID
©©Q _
)
©©_ `
)
©©` a
{
™™ 	
if
´´ 
(
´´ 
_pendingRequests
´´  
.
´´  !
TryGetValue
´´! ,
(
´´, -
response
´´- 5
.
´´5 6
CORRELATION_ID
´´6 D
,
´´D E
out
´´F I"
TaskCompletionSource
´´J ^
<
´´^ _
IModuleMessage
´´_ m
>
´´m n
?
´´n o
tcs
´´p s
)
´´s t
)
´´t u
{
¨¨ 
tcs
≠≠ 
.
≠≠ 
	SetResult
≠≠ 
(
≠≠ 
response
≠≠ &
)
≠≠& '
;
≠≠' (
return
ÆÆ 
;
ÆÆ 
}
ØØ 
}
∞∞ 	
Type
≤≤ 
messageType
≤≤ 
=
≤≤ 
typeof
≤≤ !
(
≤≤! "
IModuleMessage
≤≤" 0
)
≤≤0 1
;
≤≤1 2
List
≥≥ 
<
≥≥ 
Task
≥≥ 
>
≥≥ 
handlerTasks
≥≥ 
=
≥≥  !
[
≥≥" #
]
≥≥# $
;
≥≥$ %
if
µµ 

(
µµ 
_subscriptions
µµ 
.
µµ 
TryGetValue
µµ &
(
µµ& '
messageType
µµ' 2
,
µµ2 3
out
µµ4 7
ConcurrentBag
µµ8 E
<
µµE F"
IMessageSubscription
µµF Z
>
µµZ [
?
µµ[ \
subscriptions
µµ] j
)
µµj k
)
µµk l
{
∂∂ 	
foreach
∑∑ 
(
∑∑ "
IMessageSubscription
∑∑ )
subscription
∑∑* 6
in
∑∑7 9
subscriptions
∑∑: G
)
∑∑G H
{
∏∏ 
try
ππ 
{
∫∫ 
Task
ªª 
handlerTask
ªª $
=
ªª% &
subscription
ªª' 3
.
ªª3 4
HandleAsync
ªª4 ?
(
ªª? @
message
ªª@ G
)
ªªG H
;
ªªH I
handlerTasks
ºº  
.
ºº  !
Add
ºº! $
(
ºº$ %
handlerTask
ºº% 0
)
ºº0 1
;
ºº1 2
}
ΩΩ 
catch
ææ 
(
ææ 
	Exception
ææ  
ex
ææ! #
)
ææ# $
{
øø 
Serilog
¿¿ 
.
¿¿ 
Log
¿¿ 
.
¿¿  
Error
¿¿  %
(
¿¿% &
ex
¿¿& (
,
¿¿( )
$str¿¿* à
,¿¿à â
messageType
¡¡ #
.
¡¡# $
Name
¡¡$ (
)
¡¡( )
;
¡¡) *
}
¬¬ 
}
√√ 
}
ƒƒ 	
if
∆∆ 

(
∆∆ 
handlerTasks
∆∆ 
.
∆∆ 
Count
∆∆ 
>
∆∆  
$num
∆∆! "
)
∆∆" #
{
«« 	
await
»» 
Task
»» 
.
»» 
WhenAll
»» 
(
»» 
handlerTasks
»» +
)
»»+ ,
;
»», -
}
…… 	
}
   
private
ÃÃ 
void
ÃÃ "
RecordProcessingTime
ÃÃ %
(
ÃÃ% &
double
ÃÃ& ,
processingTimeMs
ÃÃ- =
)
ÃÃ= >
{
ÕÕ 
_processingTimes
ŒŒ 
.
ŒŒ 
Enqueue
ŒŒ  
(
ŒŒ  !
processingTimeMs
ŒŒ! 1
)
ŒŒ1 2
;
ŒŒ2 3
while
–– 
(
–– 
_processingTimes
–– 
.
––  
Count
––  %
>
––& '*
MAX_PROCESSING_TIMES_SAMPLES
––( D
)
––D E
{
—— 	
_processingTimes
““ 
.
““ 

TryDequeue
““ '
(
““' (
out
““( +
_
““, -
)
““- .
;
““. /
}
”” 	
}
‘‘ 
public
÷÷ 

void
÷÷ 
Dispose
÷÷ 
(
÷÷ 
)
÷÷ 
{
◊◊ &
_cancellationTokenSource
ÿÿ  
.
ÿÿ  !
Cancel
ÿÿ! '
(
ÿÿ' (
)
ÿÿ( )
;
ÿÿ) *
_messageWriter
ŸŸ 
.
ŸŸ 
Complete
ŸŸ 
(
ŸŸ  
)
ŸŸ  !
;
ŸŸ! "
try
€€ 
{
‹‹ 	$
_messageProcessingTask
›› "
.
››" #
Wait
››# '
(
››' (
TimeSpan
››( 0
.
››0 1
FromSeconds
››1 <
(
››< =
$num
››= >
)
››> ?
)
››? @
;
››@ A
}
ﬁﬁ 	
catch
ﬂﬂ 
(
ﬂﬂ 
TimeoutException
ﬂﬂ 
ex
ﬂﬂ  "
)
ﬂﬂ" #
{
‡‡ 	
Serilog
·· 
.
·· 
Log
·· 
.
·· 
Warning
·· 
(
··  
ex
··  "
,
··" #
$str··$ Ç
)··Ç É
;··É Ñ
}
‚‚ 	
catch
„„ 
(
„„  
AggregateException
„„ !
ex
„„" $
)
„„$ %
when
„„& *
(
„„+ ,
ex
„„, .
.
„„. /
InnerException
„„/ =
is
„„> @(
OperationCanceledException
„„A [
)
„„[ \
{
‰‰ 	
}
ÊÊ 	
catch
ÁÁ 
(
ÁÁ 
	Exception
ÁÁ 
ex
ÁÁ 
)
ÁÁ 
{
ËË 	
Serilog
ÈÈ 
.
ÈÈ 
Log
ÈÈ 
.
ÈÈ 
Error
ÈÈ 
(
ÈÈ 
ex
ÈÈ  
,
ÈÈ  !
$str
ÈÈ" b
)
ÈÈb c
;
ÈÈc d
}
ÍÍ 	&
_cancellationTokenSource
ÏÏ  
.
ÏÏ  !
Dispose
ÏÏ! (
(
ÏÏ( )
)
ÏÏ) *
;
ÏÏ* +
}
ÌÌ 
}ÓÓ 
internal 
	interface
	 "
IMessageSubscription
 '
{ÒÒ 
Task
ÚÚ 
HandleAsync
ÚÚ	 
(
ÚÚ 
IModuleMessage
ÚÚ #
message
ÚÚ$ +
)
ÚÚ+ ,
;
ÚÚ, -
}ÛÛ 
internalıı 
sealed
ıı	 
class
ıı !
MessageSubscription
ıı )
<
ıı) *
T
ıı* +
>
ıı+ ,
(
ıı, -
Func
ıı- 1
<
ıı1 2
T
ıı2 3
,
ıı3 4
bool
ıı5 9
>
ıı9 :
filter
ıı; A
,
ııA B
Func
ııC G
<
ııG H
T
ııH I
,
ııI J
Task
ııK O
>
ııO P
handler
ııQ X
)
ııX Y
:
ııZ ["
IMessageSubscription
ıı\ p
where
ˆˆ 	
T
ˆˆ
 
:
ˆˆ 
IModuleMessage
ˆˆ 
{˜˜ 
public
¯¯ 

async
¯¯ 
Task
¯¯ 
HandleAsync
¯¯ !
(
¯¯! "
IModuleMessage
¯¯" 0
message
¯¯1 8
)
¯¯8 9
{
˘˘ 
if
˙˙ 

(
˙˙ 
message
˙˙ 
is
˙˙ 
T
˙˙ 
typedMessage
˙˙ %
&&
˙˙& (
filter
˙˙) /
(
˙˙/ 0
typedMessage
˙˙0 <
)
˙˙< =
)
˙˙= >
{
˚˚ 	
await
¸¸ 
handler
¸¸ 
(
¸¸ 
typedMessage
¸¸ &
)
¸¸& '
;
¸¸' (
}
˝˝ 	
}
˛˛ 
}ˇˇ ™
{/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Communication/CommonMessages.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Communication *
;* +
public 
record "
ModuleInitializedEvent $
:% &
ModuleEvent' 2
{ 
public 

override 
string 
MessageType &
=>' )
$str* >
;> ?
public 

string 

ModuleName 
{ 
get "
;" #
init$ (
;( )
}* +
=, -
string. 4
.4 5
Empty5 :
;: ;
} Ñ
|/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/ModuleIdentifier.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
enum 
ModuleIdentifier 
{ 
Authentication 
, 
Main 
, 	
Settings		 
,		 
}

 
public 
static 
class &
ModuleIdentifierExtensions .
{ 
public 

static 
string 
ToName 
(  
this  $
ModuleIdentifier% 5

identifier6 @
)@ A
=>B D

identifierE O
switchP V
{ 
ModuleIdentifier 
. 
Authentication '
=>( *
$str+ ;
,; <
ModuleIdentifier 
. 
Main 
=>  
$str! '
,' (
ModuleIdentifier 
. 
Settings !
=>" $
$str% /
,/ 0
_ 	
=>
 
throw 
new '
ArgumentOutOfRangeException 2
(2 3
nameof3 9
(9 :

identifier: D
)D E
,E F

identifierG Q
,Q R
$strS n
)n o
} 
; 
} ı
x/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IViewLocator.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IViewLocator 
{		 
void

 
Register

	 
<

 

TViewModel

 
,

 
TView

 #
>

# $
(

$ %
)

% &
where 

TViewModel 
: 
class  
,  !
IRoutableViewModel" 4
where 
TView 
: 
class 
, 
new  
(  !
)! "
;" #
void 
RegisterFactory	 
< 

TViewModel #
># $
($ %
Func% )
<) *
object* 0
>0 1
factory2 9
)9 :
where 

TViewModel 
: 
class  
,  !
IRoutableViewModel" 4
;4 5
Option 

<
 
object 
> 
ResolveView 
< 

TViewModel )
>) *
(* +

TViewModel+ 5
?5 6
	viewModel7 @
=A B
nullC G
)G H
where 

TViewModel 
: 
class  
,  !
IRoutableViewModel" 4
;4 5
Option 

<
 
object 
> 
ResolveView 
( 
object %
?% &
	viewModel' 0
)0 1
;1 2
bool 
IsRegistered	 
< 

TViewModel  
>  !
(! "
)" #
where$ )

TViewModel* 4
:5 6
class7 <
,< =
IRoutableViewModel> P
;P Q
bool 
IsRegistered	 
( 
Type 
viewModelType (
)( )
;) *
IReadOnlyDictionary 
< 
Type 
, 
Func "
<" #
object# )
>) *
>* +
GetRegistrations, <
(< =
)= >
;> ?
} —
w/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IResettable.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IResettable 
{ 
void 

ResetState	 
( 
) 
; 
} «
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModuleViewFactory.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModuleViewFactory #
{ 
void		 
RegisterView			 
<		 

TViewModel		  
,		  !
TView		" '
>		' (
(		( )
)		) *
where

 

TViewModel

 
:

 
class

  
where 
TView 
: 
Control 
, 
new "
(" #
)# $
;$ %
Option 

<
 
Control 
> 

CreateView 
( 
Type #
viewModelType$ 1
)1 2
;2 3
} á
x/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModuleScope.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModuleScope 
: 
IDisposable  +
{ 
IServiceProvider 
ServiceProvider $
{% &
get' *
;* +
}, -
string 


ModuleName 
{ 
get 
; 
} 
}		 Œ
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModuleMessageBus.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModuleMessageBus "
{ 
Task 
PublishAsync	 
< 
T 
> 
( 
T 
eventMessage '
,' (
CancellationToken) :
cancellationToken; L
=M N
defaultO V
)V W
where		 
T		 
:		 
ModuleEvent		 
;		 
Task 
< 	
	TResponse	 
? 
> 
RequestAsync !
<! "
TRequest" *
,* +
	TResponse, 5
>5 6
(6 7
TRequest 
request 
, 
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
where 
TRequest 
: 
ModuleRequest &
where 
	TResponse 
: 
ModuleResponse (
;( )
Task 
	SendAsync	 
< 
T 
> 
( 
T 
message 
,  
CancellationToken! 2
cancellationToken3 D
=E F
defaultG N
)N O
where 
T 
: 
IModuleMessage  
;  !
IDisposable 
	Subscribe 
< 
T 
> 
( 
Func !
<! "
T" #
,# $
Task% )
>) *
handler+ 2
)2 3
where4 9
T: ;
:< =
IModuleMessage> L
;L M
IDisposable 
	Subscribe 
< 
T 
> 
( 
Func !
<! "
T" #
,# $
bool% )
>) *
filter+ 1
,1 2
Func3 7
<7 8
T8 9
,9 :
Task; ?
>? @
handlerA H
)H I
whereJ O
TP Q
:R S
IModuleMessageT b
;b c
MessageBusStats 
GetStats 
( 
) 
; 
} 
public 
record 
MessageBusStats 
{ 
public 

int 
ActiveSubscriptions "
{# $
get% (
;( )
init* .
;. /
}0 1
public 

long 
TotalMessagesSent !
{" #
get$ '
;' (
init) -
;- .
}/ 0
public 

long  
TotalEventsPublished $
{% &
get' *
;* +
init, 0
;0 1
}2 3
public   

long   "
TotalRequestsProcessed   &
{  ' (
get  ) ,
;  , -
init  . 2
;  2 3
}  4 5
public!! 

double!! #
AverageProcessingTimeMs!! )
{!!* +
get!!, /
;!!/ 0
init!!1 5
;!!5 6
}!!7 8
public"" 

int"" 
PendingRequests"" 
{""  
get""! $
;""$ %
init""& *
;""* +
}"", -
}## ˇ
z/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModuleMessage.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModuleMessage 
{ 
string 

	MessageId 
{ 
get 
; 
} 
string		 

SourceModule		 
{		 
get		 
;		 
}		  
string 

?
 
TargetModule 
{ 
get 
; 
}  !
DateTime 
	Timestamp 
{ 
get 
; 
} 
string 

MessageType 
{ 
get 
; 
} 
string 

?
 
CORRELATION_ID 
{ 
get  
;  !
}" #
} 
public 
abstract 
record 
ModuleMessage $
:% &
IModuleMessage' 5
{ 
public 

string 
	MessageId 
{ 
get !
;! "
init# '
;' (
}) *
=+ ,
Guid- 1
.1 2
NewGuid2 9
(9 :
): ;
.; <
ToString< D
(D E
)E F
;F G
public 

string 
SourceModule 
{  
get! $
;$ %
init& *
;* +
}, -
=. /
string0 6
.6 7
Empty7 <
;< =
public 

string 
? 
TargetModule 
{  !
get" %
;% &
init' +
;+ ,
}- .
public 

DateTime 
	Timestamp 
{ 
get  #
;# $
init% )
;) *
}+ ,
=- .
DateTime/ 7
.7 8
UtcNow8 >
;> ?
public 

abstract 
string 
MessageType &
{' (
get) ,
;, -
}. /
public 

string 
? 
CORRELATION_ID !
{" #
get$ '
;' (
init) -
;- .
}/ 0
} 
public 
abstract 
record 
ModuleRequest $
:% &
ModuleMessage' 4
{ 
public 

TimeSpan 
Timeout 
{ 
get !
;! "
init# '
;' (
}) *
=+ ,
TimeSpan- 5
.5 6
FromSeconds6 A
(A B
$numB D
)D E
;E F
}   
public!! 
abstract!! 
record!! 
ModuleResponse!! %
:!!& '
ModuleMessage!!( 5
{"" 
public$$ 

bool$$ 
	IsSuccess$$ 
{$$ 
get$$ 
;$$  
init$$! %
;$$% &
}$$' (
public&& 

string&& 
?&& 
ErrorMessage&& 
{&&  !
get&&" %
;&&% &
init&&' +
;&&+ ,
}&&- .
}'' 
public(( 
abstract(( 
record(( 
ModuleEvent(( "
:((# $
ModuleMessage((% 2
{)) 
public** 


Dictionary** 
<** 
string** 
,** 
object** $
>**$ %
	EventData**& /
{**0 1
get**2 5
;**5 6
init**7 ;
;**; <
}**= >
=**? @
new**A D
(**D E
)**E F
;**F G
}++ °
{/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModuleManifest.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModuleManifest  
{ 
int 
Priority 
{ 
get 
; 
} !
ModuleLoadingStrategy 
LoadingStrategy )
{* +
get, /
;/ 0
}1 2
IReadOnlyList

 
<

 
ModuleIdentifier

 "
>

" #
Dependencies

$ 0
{

1 2
get

3 6
;

6 7
}

8 9
bool 
CanLoad	 
( 
) 
; 
} 
public 
record 
ModuleManifest 
( 
int 
Priority 
, !
ModuleLoadingStrategy 
LoadingStrategy )
,) *
IReadOnlyList 
< 
ModuleIdentifier "
>" #
Dependencies$ 0
) 
: 
IModuleManifest 
{ 
public 

virtual 
bool 
CanLoad 
(  
)  !
=>" $
true% )
;) *
} Ÿ
z/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModuleManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModuleManager 
{ 
Task 
< 	
Option	 
< 
IModule 
> 
> 
LoadModuleAsync )
() *
string* 0

moduleName1 ;
); <
;< =
Task		 !
LoadEagerModulesAsync			 
(		 
)		  
;		  !
Task

 
UnloadModuleAsync

	 
(

 
string

 !

moduleName

" ,
)

, -
;

- .
} Ω
s/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModule.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModule 
{ 
ModuleIdentifier 
Id 
{ 
get 
; 
}  
IModuleManifest		 
Manifest		 
{		 
get		 "
;		" #
}		$ %
bool

 
IsLoaded

	 
{

 
get

 
;

 
}

 
IModuleScope 
? 
ServiceScope 
{  
get! $
;$ %
}& '
Task 
< 	
bool	 
> 
CanLoadAsync 
( 
) 
; 
Task 
	LoadAsync	 
( 
IServiceProvider #
serviceProvider$ 3
)3 4
;4 5
Task 
UnloadAsync	 
( 
) 
; 
Task %
SetupMessageHandlersAsync	 "
(" #
IModuleMessageBus# 4

messageBus5 ?
)? @
;@ A
} 
public 
	interface 
ITypedModule 
< 
out !
	TManifest" +
>+ ,
:- .
IModule/ 6
where7 <
	TManifest= F
:G H
IModuleManifestI X
{ 
new 
	TManifest 
Manifest 
{ 
get  
;  !
}" #
} 
public 
enum !
ModuleLoadingStrategy !
{ 
Eager 	
,	 

Lazy 
, 	

Background 
} 
public!! 
enum!! 
ModuleState!! 
{"" 
	NotLoaded## 
,## 
Loading$$ 
,$$ 
Loaded%% 

,%%
 
Failed&& 

,&&
 
	Unloading'' 
,'' 
Unloaded(( 
})) ü
É/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/UserRequestErrorViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
;' (
public 
sealed 
class %
UserRequestErrorViewModel -
:. /
ReactiveObject0 >
,> ?!
IActivatableViewModel@ U
{ 
public		 

ViewModelActivator		 
	Activator		 '
{		( )
get		* -
;		- .
}		/ 0
=		1 2
new		3 6
(		6 7
)		7 8
;		8 9
public 
%
UserRequestErrorViewModel $
($ %
string% +
errorMessage, 8
,8 9 
ILocalizationService: N
localizationServiceO b
)b c
{ 
_ 	
=
 
localizationService 
??  "
throw# (
new) ,!
ArgumentNullException- B
(B C
nameofC I
(I J
localizationServiceJ ]
)] ^
)^ _
;_ `
ErrorMessage 
= 
string 
. 
IsNullOrWhiteSpace 0
(0 1
errorMessage1 =
)= >
? 
localizationService !
[! "
$str" :
]: ;
: 
errorMessage 
; 
} 
public 

string 
ErrorMessage 
{  
get! $
;$ %
}& '
} ã
Ñ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/UserRequestErrorView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
;' (
public 
partial 
class  
UserRequestErrorView )
:* +
ReactiveUserControl, ?
<? @)
RedirectNotificationViewModel@ ]
>] ^
{ 
public 
 
UserRequestErrorView 
(  
)  !
{		 
AvaloniaXamlLoader

 
.

 
Load

 
(

  
this

  $
)

$ %
;

% &
} 
} ˜H
á/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/RedirectNotificationViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
;' (
public 
sealed 
class )
RedirectNotificationViewModel 1
:2 3
ReactiveObject4 B
,B C
IDisposableD O
,O P!
IActivatableViewModelQ f
{ 
public 

ViewModelActivator 
	Activator '
{( )
get* -
;- .
}/ 0
=1 2
new3 6
(6 7
)7 8
;8 9
private 
readonly  
ILocalizationService ) 
_localizationService* >
;> ?
private 
string 
? &
_cachedRedirectingTemplate .
;. /
private 
bool 
	_disposed 
= 
false "
;" #
[ 
Reactive 
] 
public 
string 
Message $
{% &
get' *
;* +
set, /
;/ 0
}1 2
[ 
Reactive 
] 
public 
double 
Progress %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
=4 5
$num6 7
;7 8
[ 
Reactive 
] 
public 
string 
CountdownText *
{+ ,
get- 0
;0 1
set2 5
;5 6
}7 8
public 
)
RedirectNotificationViewModel (
(( )
string 
message 
, 
int 
totalSeconds 
, 
Action 

onComplete 
,  
ILocalizationService 
localizationService 0
)0 1
{  
_localizationService 
= 
localizationService 2
;2 3
Message   
=   
message   
;   
int!! 
remainingSeconds!! 
=!! 
totalSeconds!! +
;!!+ ,
Progress"" 
="" 
$num"" 
;"" 
CountdownText## 
=## $
GetCachedRedirectingText## 0
(##0 1
remainingSeconds##1 A
)##A B
;##B C
this%% 
.%% 
WhenActivated%% 
(%% 
disposables%% &
=>%%' )
{&& 	
	Stopwatch'' 
	stopwatch'' 
=''  !
	Stopwatch''" +
.''+ ,
StartNew'', 4
(''4 5
)''5 6
;''6 7
IObservable)) 
<)) 
Unit)) 
>)) 
languageTrigger)) -
=)). /

Observable))0 :
.)): ;
	FromEvent)); D
())D E
handler** 
=>**  
_localizationService** 3
.**3 4
LanguageChanged**4 C
+=**D F
handler**G N
,**N O
handler++ 
=>++  
_localizationService++ 3
.++3 4
LanguageChanged++4 C
-=++D F
handler++G N
)++N O
.,,  
DistinctUntilChanged,, %
(,,% &
),,& '
.-- 
Select-- 
(-- 
_-- 
=>-- 
Unit-- !
.--! "
Default--" )
)--) *
... 
	StartWith.. 
(.. 
Unit.. 
...  
Default..  '
)..' (
;..( )
languageTrigger00 
.11 
Skip11 
(11 
$num11 
)11 
.22 
	Subscribe22 
(22 
_22 
=>22 
ClearStringCache22  0
(220 1
)221 2
)222 3
.33 
DisposeWith33 
(33 
disposables33 (
)33( )
;33) *

Observable55 
.55 
Interval55 
(55  
TimeSpan55  (
.55( )
FromMilliseconds55) 9
(559 :
$num55: ;
)55; <
)55< =
.66 
	StartWith66 !
(66! "
$num66" #
)66# $
.77 
	ObserveOn77 !
(77! "
RxApp77" '
.77' (
MainThreadScheduler77( ;
)77; <
.88 
	Subscribe88 !
(88! "
_88" #
=>88$ &
{99 
double:: !
elapsed::" )
=::* +
	stopwatch::, 5
.::5 6
Elapsed::6 =
.::= >
TotalSeconds::> J
;::J K
Progress;; #
=;;$ %
Math;;& *
.;;* +
Min;;+ .
(;;. /
$num;;/ 4
,;;4 5
(;;6 7
elapsed;;7 >
/;;? @
totalSeconds;;A M
);;M N
*;;O P
$num;;Q V
);;V W
;;;W X
}<< 
)<< 
.== 
DisposeWith== #
(==# $
disposables==$ /
)==/ 0
;==0 1

Observable>> 
.>> 
Interval>> 
(>>  
TimeSpan>>  (
.>>( )
FromSeconds>>) 4
(>>4 5
$num>>5 6
)>>6 7
)>>7 8
.?? 
	StartWith?? 
(?? 
$num?? 
)?? 
.@@ 
	ObserveOn@@ 
(@@ 
RxApp@@  
.@@  !
MainThreadScheduler@@! 4
)@@4 5
.AA 
	SubscribeAA 
(AA 
_AA 
=>AA 
{BB 
doubleCC 
elapsedCC "
=CC# $
	stopwatchCC% .
.CC. /
ElapsedCC/ 6
.CC6 7
TotalSecondsCC7 C
;CCC D
intDD 
newRemainingDD $
=DD% &
MathDD' +
.DD+ ,
MaxDD, /
(DD/ 0
$numDD0 1
,DD1 2
(DD3 4
intDD4 7
)DD7 8
MathDD8 <
.DD< =
CeilingDD= D
(DDD E
totalSecondsDDE Q
-DDR S
elapsedDDT [
)DD[ \
)DD\ ]
;DD] ^
ifEE 
(EE 
newRemainingEE $
!=EE% '
remainingSecondsEE( 8
)EE8 9
{FF 
remainingSecondsGG (
=GG) *
newRemainingGG+ 7
;GG7 8
CountdownTextHH %
=HH& '$
GetCachedRedirectingTextHH( @
(HH@ A
remainingSecondsHHA Q
)HHQ R
;HHR S
}II 
}JJ 
)JJ 
.KK 
DisposeWithKK 
(KK 
disposablesKK (
)KK( )
;KK) *

ObservableLL 
.LL 
TimerLL 
(LL 
TimeSpanLL %
.LL% &
FromSecondsLL& 1
(LL1 2
totalSecondsLL2 >
)LL> ?
)LL? @
.MM 
	ObserveOnMM 
(MM 
RxAppMM  
.MM  !
MainThreadSchedulerMM! 4
)MM4 5
.NN 
	SubscribeNN 
(NN 
_NN 
=>NN 
{OO 
ProgressPP 
=PP 
$numPP $
;PP$ %
CountdownTextQQ !
=QQ" #$
GetCachedRedirectingTextQQ$ <
(QQ< =
$numQQ= >
)QQ> ?
;QQ? @

onCompleteRR 
(RR 
)RR  
;RR  !
}SS 
)SS 
.TT 
DisposeWithTT 
(TT 
disposablesTT (
)TT( )
;TT) *

DisposableUU 
.UU 
CreateUU 
(UU 
(UU 
)UU  
=>UU! #
	stopwatchUU$ -
.UU- .
StopUU. 2
(UU2 3
)UU3 4
)UU4 5
.UU5 6
DisposeWithUU6 A
(UUA B
disposablesUUB M
)UUM N
;UUN O
}WW 	
)WW	 

;WW
 
}XX 
privateZZ 
voidZZ 
ClearStringCacheZZ !
(ZZ! "
)ZZ" #
{[[ &
_cachedRedirectingTemplate\\ "
=\\# $
null\\% )
;\\) *
}]] 
private__ 
string__ $
GetCachedRedirectingText__ +
(__+ ,
int__, /
seconds__0 7
)__7 8
{`` &
_cachedRedirectingTemplateaa "
??=aa# & 
_localizationServiceaa' ;
[aa; <#
AuthenticationConstantsaa< S
.aaS T&
REDIRECTING_IN_SECONDS_KEYaaT n
]aan o
;aao p
returnbb 
stringbb 
.bb 
Formatbb 
(bb &
_cachedRedirectingTemplatebb 7
,bb7 8
secondsbb9 @
)bb@ A
;bbA B
}cc 
publicee 

voidee 
Disposeee 
(ee 
)ee 
{ff 
ifgg 

(gg 
	_disposedgg 
)gg 
{hh 	
returnii 
;ii 
}jj 	
	_disposedll 
=ll 
truell 
;ll 
}mm 
}nn ó
à/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/RedirectNotificationView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
;' (
public 
partial 
class $
RedirectNotificationView -
:. /
ReactiveUserControl0 C
<C D)
RedirectNotificationViewModelD a
>a b
{ 
public 
$
RedirectNotificationView #
(# $
)$ %
{		 
AvaloniaXamlLoader

 
.

 
Load

 
(

  
this

  $
)

$ %
;

% &
} 
} ˚B
á/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/DetectLanguageDialogViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
;' (
public 
sealed 
class )
DetectLanguageDialogViewModel 1
:2 3
ReactiveObject4 B
,B C
IDisposableD O
,O P!
IActivatableViewModelQ f
{ 
private 
readonly %
ILanguageDetectionService .%
_languageDetectionService/ H
;H I
public 

ViewModelActivator 
	Activator '
{( )
get* -
;- .
}/ 0
=1 2
new3 6
(6 7
)7 8
;8 9
private 
bool 
	_disposed 
; 
public 

string 
Title 
{ 
get 
; 
}  
public 

string 

PromptText 
{ 
get "
;" #
}$ %
public 

string 
ConfirmButtonText #
{$ %
get& )
;) *
}+ ,
public 

string 
DeclineButtonText #
{$ %
get& )
;) *
}+ ,
public 

string 
FlagPath 
{ 
get  
;  !
}" #
private 
readonly 
string 
_targetCulture *
;* +
public!! 

ReactiveCommand!! 
<!! 
Unit!! 
,!!  
Unit!!! %
>!!% &
ConfirmCommand!!' 5
{!!6 7
get!!8 ;
;!!; <
}!!= >
public"" 

ReactiveCommand"" 
<"" 
Unit"" 
,""  
Unit""! %
>""% &
DeclineCommand""' 5
{""6 7
get""8 ;
;""; <
}""= >
private$$ 
static$$ 
readonly$$ 
AppCultureSettings$$ .
LanguageConfig$$/ =
=$$> ?
AppCultureSettings$$@ R
.$$R S
Default$$S Z
;$$Z [
public'' 
)
DetectLanguageDialogViewModel'' (
(''( ) 
ILocalizationService(( 
localizationService(( 0
,((0 1%
ILanguageDetectionService)) !$
languageDetectionService))" :
,)): ;
NetworkProvider** 
networkProvider** '
)++ 	
{,, %
_languageDetectionService-- !
=--" #$
languageDetectionService--$ <
;--< =
ConfirmCommand// 
=// 
ReactiveCommand// (
.//( )
CreateFromTask//) 7
(//7 8
	OnConfirm//8 A
)//A B
;//B C
DeclineCommand00 
=00 
ReactiveCommand00 (
.00( )
CreateFromTask00) 7
(007 8
	OnDecline008 A
)00A B
;00B C
string22 
country22 
=22 
networkProvider22 (
.22( )'
ApplicationInstanceSettings22) D
.22D E
Country22E L
;22L M
if44 

(44 
string44 
.44 
IsNullOrWhiteSpace44 %
(44% &
country44& -
)44- .
)44. /
{55 	
_targetCulture66 
=66 
CultureInfo66 (
.66( )
CurrentCulture66) 7
.667 8
Name668 <
;66< =
}77 	
else88 
{99 	
_targetCulture:: 
=:: 
LanguageConfig:: +
.::+ ,
GetCultureByCountry::, ?
(::? @
country::@ G
)::G H
??::I K
CultureInfo::L W
.::W X
CurrentCulture::X f
.::f g
Name::g k
;::k l
};; 	
CultureInfo== 

targetInfo== 
;== 
try>> 
{?? 	

targetInfo@@ 
=@@ 
CultureInfo@@ $
.@@$ %
GetCultureInfo@@% 3
(@@3 4
_targetCulture@@4 B
)@@B C
;@@C D
}AA 	
catchBB 
(BB $
CultureNotFoundExceptionBB '
)BB' (
{CC 	

targetInfoDD 
=DD 
CultureInfoDD $
.DD$ %
CurrentCultureDD% 3
;DD3 4
_targetCultureEE 
=EE 

targetInfoEE '
.EE' (
NameEE( ,
;EE, -
}FF 	
stringHH 
languageNameHH 
=HH 

targetInfoHH (
.HH( )
DisplayNameHH) 4
;HH4 5
intII 
parenthesisIndexII 
=II 
languageNameII +
.II+ ,
IndexOfII, 3
(II3 4
$charII4 7
)II7 8
;II8 9
ifJJ 

(JJ 
parenthesisIndexJJ 
>JJ 
$numJJ  
)JJ  !
{KK 	
languageNameLL 
=LL 
languageNameLL '
.LL' (
	SubstringLL( 1
(LL1 2
$numLL2 3
,LL3 4
parenthesisIndexLL5 E
)LLE F
.LLF G
TrimLLG K
(LLK L
)LLL M
;LLM N
}MM 	
TitleOO 
=OO 
localizationServiceOO #
?OO# $
[OO$ %
$strOO% >
]OO> ?
??OO@ B
$strOOC W
;OOW X

PromptTextPP 
=PP 
localizationServicePP (
?PP( )
.PP) *
	GetStringPP* 3
(PP3 4
$strPP4 N
,PPN O
LanguageConfigQQ 
.QQ 
GetDisplayNameQQ -
(QQ- .
languageNameQQ. :
)QQ: ;
)QQ; <
??QQ= ?
$"QQ@ B
$strQQB L
{QQL M
languageNameQQM Y
}QQY Z
$strQQZ [
"QQ[ \
;QQ\ ]
ConfirmButtonTextRR 
=RR 
localizationServiceRR /
?RR/ 0
[RR0 1
$strRR1 S
]RRS T
??RRU W
$strRRX a
;RRa b
DeclineButtonTextSS 
=SS 
localizationServiceSS /
?SS/ 0
[SS0 1
$strSS1 S
]SSS T
??SSU W
$strSSX a
;SSa b
OptionVV 
<VV 
LanguageItemVV 
>VV 
languageItemVV )
=VV* +
LanguageConfigVV, :
.VV: ;
GetLanguageByCodeVV; L
(VVL M
_targetCultureVVM [
)VV[ \
;VV\ ]
FlagPathWW 
=WW 
languageItemWW 
.WW  
SelectWW  &
(WW& '
itemWW' +
=>WW, .
itemWW/ 3
.WW3 4
FlagImagePathWW4 A
)WWA B
.XX 
GetValueOrDefaultXX 
(XX 
$strXX W
)XXW X
;XXX Y
thisZZ 
.ZZ 
WhenActivatedZZ 
(ZZ 
disposablesZZ &
=>ZZ' )
{[[ 	
ConfirmCommand\\ 
.\\ 
DisposeWith\\ &
(\\& '
disposables\\' 2
)\\2 3
;\\3 4
DeclineCommand]] 
.]] 
DisposeWith]] &
(]]& '
disposables]]' 2
)]]2 3
;]]3 4
}^^ 	
)^^	 

;^^
 
}__ 
publicaa 

voidaa 
Disposeaa 
(aa 
)aa 
{bb 
ifcc 

(cc 
	_disposedcc 
)cc 
{dd 	
returnee 
;ee 
}ff 	
	_disposedhh 
=hh 
truehh 
;hh 
}ii 
privatekk 
asynckk 
Taskkk 
	OnConfirmkk  
(kk  !
)kk! "
{ll 
awaitmm %
_languageDetectionServicemm '
.mm' (&
ConfirmLanguageChangeAsyncmm( B
(mmB C
targetCulturemmC P
:mmP Q
_targetCulturemmR `
)mm` a
;mma b
}nn 
privatepp 
asyncpp 
Taskpp 
	OnDeclinepp  
(pp  !
)pp! "
{qq 
awaitrr %
_languageDetectionServicerr '
.rr' (&
DeclineLanguageChangeAsyncrr( B
(rrB C
)rrC D
;rrD E
}ss 
}tt ◊
Ñ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/DetectLanguageDialog.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
;' (
public		 
partial		 
class		  
DetectLanguageDialog		 )
:		* +
ReactiveUserControl		, ?
<		? @)
DetectLanguageDialogViewModel		@ ]
>		] ^
{

 
private 
static 
class 
ResourceKeys %
{ 
public 
const 
string 
BUTTON_HEIGHT )
=* +
nameof, 2
(2 3
BUTTON_HEIGHT3 @
)@ A
;A B
public 
const 
string 
TITLE_FONT_SIZE +
=, -
nameof. 4
(4 5
TITLE_FONT_SIZE5 D
)D E
;E F
public 
const 
string 
SUBTITLE_FONT_SIZE .
=/ 0
nameof1 7
(7 8
SUBTITLE_FONT_SIZE8 J
)J K
;K L
public 
const 
string &
BUTTON_TRANSITION_DURATION 6
=7 8
nameof9 ?
(? @&
BUTTON_TRANSITION_DURATION@ Z
)Z [
;[ \
} 
private 
static 
readonly 
FrozenDictionary ,
<, -
string- 3
,3 4
object5 ;
>; < 
PrecompiledResources= Q
=R S
new 

Dictionary 
< 
string 
, 
object %
>% &
{ 	
[ 
ResourceKeys 
. 
BUTTON_HEIGHT '
]' (
=) *
$num+ /
,/ 0
[ 
ResourceKeys 
. 
TITLE_FONT_SIZE )
]) *
=+ ,
$num- 1
,1 2
[ 
ResourceKeys 
. 
SUBTITLE_FONT_SIZE ,
], -
=. /
$num0 4
,4 5
[ 
ResourceKeys 
. &
BUTTON_TRANSITION_DURATION 4
]4 5
=6 7
TimeSpan8 @
.@ A
FromMillisecondsA Q
(Q R
$numR U
)U V
} 	
.	 

ToFrozenDictionary
 
( 
) 
; 
public 
 
DetectLanguageDialog 
(  
)  !
{ 
InitializeComponent 
( 
) 
; %
ApplyPrecompiledResources !
(! "
)" #
;# $
}   
private"" 
void"" 
InitializeComponent"" $
(""$ %
)""% &
{## 
AvaloniaXamlLoader$$ 
.$$ 
Load$$ 
($$  
this$$  $
)$$$ %
;$$% &
}%% 
private'' 
void'' %
ApplyPrecompiledResources'' *
(''* +
)''+ ,
{(( 
foreach)) 
()) 
()) 
string)) 
key)) 
,)) 
object)) $
value))% *
)))* +
in)), . 
PrecompiledResources))/ C
)))C D
{** 	
	Resources++ 
[++ 
key++ 
]++ 
=++ 
value++ "
;++" #
},, 	
}-- 
}// ’
ñ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/BottomSheetModal/DefaultBottomSheetVariables.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
.' (
BottomSheetModal( 8
;8 9
public 
static 
class '
DefaultBottomSheetVariables /
{ 
public 

const 
double 

MIN_HEIGHT "
=# $
$num% )
;) *
public		 

const		 
double		 

MAX_HEIGHT		 "
=		# $
$num		% *
;		* +
public

 

const

 
double

 
DEFAULT_WIDTH

 %
=

& '
$num

( -
;

- .
private 
const 
double 
CONTENT_DELAY_MS )
=* +
$num, 0
;0 1
public 

const 
double !
DEFAULT_SCRIM_OPACITY -
=. /
$num0 4
;4 5
public 

static 
readonly 
SolidColorBrush *

ScrimBrush+ 5
=6 7
new8 ;
(; <
Color< A
.A B
ParseB G
(G H
$strH Q
)Q R
)R S
;S T
public 

static 
readonly 
TimeSpan #
ContentDelay$ 0
=1 2
TimeSpan3 ;
.; <
FromMilliseconds< L
(L M
CONTENT_DELAY_MSM ]
)] ^
;^ _
public 

const 
bool 1
%DEFAULT_IS_DISMISSABLE_ON_SCRIM_CLICK ;
=< =
true> B
;B C
} ‘A
è/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/BottomSheetModal/BottomSheetViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
.' (
BottomSheetModal( 8
;8 9
public 
sealed 
class  
BottomSheetViewModel (
:) *
ReactiveObject+ 9
,9 :!
IActivatableViewModel; P
,P Q
IDisposableR ]
{ 
private 
readonly 
IBottomSheetService (
_bottomSheetService) <
;< =
private 
readonly 
IMessageBus  
_messageBus! ,
;, -
private 
bool 
	_disposed 
; 
private 
bool 

_isVisible 
; 
private 
bool &
_isDismissableOnScrimClick +
;+ ,
private 
bool 

_showScrim 
; 
private 
UserControl 
? 
_content !
;! "
public 

UserControl 
? 
Content 
{ 
get 
=> 
_content 
; 
set 
=> 
this 
.  
RaiseAndSetIfChanged (
(( )
ref) ,
_content- 5
,5 6
value7 <
)< =
;= >
} 
public   

bool   
	ShowScrim   
{!! 
get"" 
=>"" 

_showScrim"" 
;"" 
set## 
=>## 
this## 
.##  
RaiseAndSetIfChanged## (
(##( )
ref##) ,

_showScrim##- 7
,##7 8
value##9 >
)##> ?
;##? @
}$$ 
public&& 

bool&& 
	IsVisible&& 
{'' 
get(( 
=>(( 

_isVisible(( 
;(( 
set)) 
=>)) 
this)) 
.))  
RaiseAndSetIfChanged)) (
())( )
ref))) ,

_isVisible))- 7
,))7 8
value))9 >
)))> ?
;))? @
}** 
public,, 

bool,, %
IsDismissableOnScrimClick,, )
{-- 
get.. 
=>.. &
_isDismissableOnScrimClick.. )
;..) *
set// 
=>// 
this// 
.//  
RaiseAndSetIfChanged// (
(//( )
ref//) ,&
_isDismissableOnScrimClick//- G
,//G H
value//I N
)//N O
;//O P
}00 
public22 

ViewModelActivator22 
	Activator22 '
{22( )
get22* -
;22- .
}22/ 0
=221 2
new223 6
(226 7
)227 8
;228 9
public44 
 
BottomSheetViewModel44 
(44  
IBottomSheetService44  3
bottomSheetService444 F
,44F G
IMessageBus44H S

messageBus44T ^
)44^ _
{55 
_bottomSheetService66 
=66 
bottomSheetService66 0
;660 1
_messageBus77 
=77 

messageBus77  
;77  !
this99 
.99 
WhenActivated99 
(99 
disposables99 &
=>99' )
{:: 	
_messageBus;; 
.;; 
	Subscribe;; !
<;;! "#
BottomSheetCommandEvent;;" 9
>;;9 :
(;;: ;
async;;; @
evt;;A D
=>;;E G
{<< 
await== 
HandleCommand== #
(==# $
evt==$ '
)==' (
;==( )
}>> 
)>> 
.>> 
DisposeWith>> 
(>> 
disposables>> &
)>>& '
;>>' (
this@@ 
.@@ 
WhenAnyValue@@ 
(@@ 
x@@ 
=>@@  "
x@@# $
.@@$ %
	IsVisible@@% .
)@@. /
.AA 
SkipAA 
(AA 
$numAA 
)AA 
.BB 
	SubscribeBB 
(BB 
asyncBB  
	isVisibleBB! *
=>BB+ -
{CC 
UserControlDD 
?DD  
contentSnapshotDD! 0
=DD1 2
ContentDD3 :
;DD: ;
awaitFF 
TaskFF 
.FF 
DelayFF $
(FF$ %
	isVisibleFF% .
?GG )
BottomSheetAnimationConstantsGG 7
.GG7 8!
ShowAnimationDurationGG8 M
:HH )
BottomSheetAnimationConstantsHH 7
.HH7 8!
HideAnimationDurationHH8 M
)HHM N
;HHN O
awaitJJ 
_messageBusJJ %
.JJ% &
PublishAsyncJJ& 2
(JJ2 3
	isVisibleJJ3 <
?KK -
!BottomSheetAnimationCompleteEventKK ;
.KK; <
ShowCompleteKK< H
(KKH I
)KKI J
:LL -
!BottomSheetAnimationCompleteEventLL ;
.LL; <
HideCompleteLL< H
(LLH I
)LLI J
)LLJ K
;LLK L
ifNN 
(NN 
!NN 
	isVisibleNN "
)NN" #
{OO 
awaitPP 
TaskPP "
.PP" #
DelayPP# (
(PP( )
$numPP) +
)PP+ ,
;PP, -
awaitRR 

DispatcherRR (
.RR( )
UIThreadRR) 1
.RR1 2
InvokeAsyncRR2 =
(RR= >
(RR> ?
)RR? @
=>RRA C
{SS 
ifTT 
(TT  
ReferenceEqualsTT  /
(TT/ 0
ContentTT0 7
,TT7 8
contentSnapshotTT9 H
)TTH I
)TTI J
{UU 
ContentVV  '
=VV( )
nullVV* .
;VV. /
}WW 
}XX 
)XX 
;XX 
}YY 
}ZZ 
)ZZ 
.[[ 
DisposeWith[[ 
([[ 
disposables[[ (
)[[( )
;[[) *
}\\ 	
)\\	 

;\\
 
}]] 
private__ 
Task__ 
HandleCommand__ 
(__ #
BottomSheetCommandEvent__ 6
evt__7 :
)__: ;
{`` 
ifaa 

(aa 
	_disposedaa 
)aa 
{bb 	
returncc 
Taskcc 
.cc 
CompletedTaskcc %
;cc% &
}dd 	
ifff 

(ff 
evtff 
.ff 
AnimationTypeff 
==ff  
AnimationTypeff! .
.ff. /
Showff/ 3
)ff3 4
{gg 	
Contenthh 
=hh 
evthh 
.hh 
Controlhh !
;hh! "
	ShowScrimii 
=ii 
evtii 
.ii 
	ShowScrimii %
;ii% &%
IsDismissableOnScrimClickjj %
=jj& '
evtjj( +
.jj+ ,
IsDismissablejj, 9
;jj9 :
	IsVisiblekk 
=kk 
truekk 
;kk 
}ll 	
elsemm 
{nn 	
	IsVisibleoo 
=oo 
falseoo 
;oo 
}pp 	
returnrr 
Taskrr 
.rr 
CompletedTaskrr !
;rr! "
}ss 
publicuu 

voiduu  
BottomSheetDismisseduu $
(uu$ %
)uu% &
{vv 
Taskww 
.ww 
Runww 
(ww 
asyncww 
(ww 
)ww 
=>ww 
awaitww "
_bottomSheetServiceww# 6
.ww6 7 
BottomSheetDismissedww7 K
(wwK L
)wwL M
)wwM N
;wwN O
}xx 
publiczz 

voidzz 
Disposezz 
(zz 
)zz 
{{{ 
if|| 

(|| 
	_disposed|| 
)|| 
{}} 	
return~~ 
;~~ 
} 	
	_disposed
ÅÅ 
=
ÅÅ 
true
ÅÅ 
;
ÅÅ 
GC
ÇÇ 

.
ÇÇ
 
SuppressFinalize
ÇÇ 
(
ÇÇ 
this
ÇÇ  
)
ÇÇ  !
;
ÇÇ! "
}
ÉÉ 
}ÑÑ Ú¸
ì/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/BottomSheetModal/BottomSheetControl.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
.' (
BottomSheetModal( 8
;8 9
public 
sealed 
partial 
class 
BottomSheetControl .
:/ 0
ReactiveUserControl1 D
<D E 
BottomSheetViewModelE Y
>Y Z
,Z [
IDisposable\ g
{ 
public 

new 
static 
readonly 
StyledProperty -
<- .
double. 4
>4 5
MinHeightProperty6 G
=H I
AvaloniaProperty 
. 
Register !
<! "
BottomSheetControl" 4
,4 5
double6 <
>< =
(= >
nameof> D
(D E
	MinHeightE N
)N O
,O P'
DefaultBottomSheetVariablesQ l
.l m

MIN_HEIGHTm w
)w x
;x y
public 

new 
static 
readonly 
StyledProperty -
<- .
double. 4
>4 5
MaxHeightProperty6 G
=H I
AvaloniaProperty 
. 
Register !
<! "
BottomSheetControl" 4
,4 5
double6 <
>< =
(= >
nameof> D
(D E
	MaxHeightE N
)N O
,O P'
DefaultBottomSheetVariablesQ l
.l m

MAX_HEIGHTm w
)w x
;x y
public!! 

static!! 
readonly!! 
StyledProperty!! )
<!!) *
IBrush!!* 0
>!!0 1
ScrimColorProperty!!2 D
=!!E F
AvaloniaProperty"" 
."" 
Register"" !
<""! "
BottomSheetControl""" 4
,""4 5
IBrush""6 <
>""< =
(""= >
nameof""> D
(""D E

ScrimColor""E O
)""O P
,""P Q'
DefaultBottomSheetVariables## '
.##' (

ScrimBrush##( 2
)##2 3
;##3 4
public%% 

static%% 
readonly%% 
StyledProperty%% )
<%%) *
bool%%* .
>%%. /-
!IsDismissableOnScrimClickProperty%%0 Q
=%%R S
AvaloniaProperty&& 
.&& 
Register&& !
<&&! "
BottomSheetControl&&" 4
,&&4 5
bool&&6 :
>&&: ;
(&&; <
nameof&&< B
(&&B C%
IsDismissableOnScrimClick&&C \
)&&\ ]
,&&] ^'
DefaultBottomSheetVariables'' '
.''' (1
%DEFAULT_IS_DISMISSABLE_ON_SCRIM_CLICK''( M
)''M N
;''N O
public)) 

static)) 
readonly)) 
StyledProperty)) )
<))) *
IBrush))* 0
>))0 1)
DismissableScrimColorProperty))2 O
=))P Q
AvaloniaProperty** 
.** 
Register** !
<**! "
BottomSheetControl**" 4
,**4 5
IBrush**6 <
>**< =
(**= >
nameof**> D
(**D E!
DismissableScrimColor**E Z
)**Z [
,**[ \'
DefaultBottomSheetVariables++ '
.++' (

ScrimBrush++( 2
)++2 3
;++3 4
public-- 

static-- 
readonly-- 
StyledProperty-- )
<--) *
IBrush--* 0
>--0 1+
UnDismissableScrimColorProperty--2 Q
=--R S
AvaloniaProperty.. 
... 
Register.. !
<..! "
BottomSheetControl.." 4
,..4 5
IBrush..6 <
>..< =
(..= >
nameof..> D
(..D E#
UnDismissableScrimColor..E \
)..\ ]
,..] ^'
DefaultBottomSheetVariables// '
.//' (

ScrimBrush//( 2
)//2 3
;//3 4
private11 
bool11 
	_disposed11 
;11 
private22 
bool22 
_isAnimating22 
;22 
private33 
double33 
_sheetHeight33 
;33  
private55 
Border55 
?55 
_sheetBorder55  
;55  !
private66 
Border66 
?66 
_scrimBorder66  
;66  !
private77 
Grid77 
?77 
	_rootGrid77 
;77 
private88 
ContentControl88 
?88 
_contentControl88 +
;88+ ,
private:: 
	Animation:: 
?:: 
_showAnimation:: %
;::% &
private;; 
	Animation;; 
?;; 
_hideAnimation;; %
;;;% &
private<< 
	Animation<< 
?<< 
_scrimShowAnimation<< *
;<<* +
private== 
	Animation== 
?== 
_scrimHideAnimation== *
;==* +
public?? 

BottomSheetControl?? 
(?? 
)?? 
{@@ 
InitializeComponentAA 
(AA 
)AA 
;AA 
InitializeDefaultsBB 
(BB 
)BB 
;BB 
	FocusableCC 
=CC 
trueCC 
;CC 
}DD 
publicFF 

IBrushFF !
DismissableScrimColorFF '
{GG 
getHH 
=>HH 
GetValueHH 
(HH )
DismissableScrimColorPropertyHH 5
)HH5 6
;HH6 7
setII 
=>II 
SetValueII 
(II )
DismissableScrimColorPropertyII 5
,II5 6
valueII7 <
)II< =
;II= >
}JJ 
publicLL 

IBrushLL #
UnDismissableScrimColorLL )
{MM 
getNN 
=>NN 
GetValueNN 
(NN +
UnDismissableScrimColorPropertyNN 7
)NN7 8
;NN8 9
setOO 
=>OO 
SetValueOO 
(OO +
UnDismissableScrimColorPropertyOO 7
,OO7 8
valueOO9 >
)OO> ?
;OO? @
}PP 
publicRR 

newRR 
doubleRR 
	MinHeightRR 
{SS 
getTT 
=>TT 
GetValueTT 
(TT 
MinHeightPropertyTT )
)TT) *
;TT* +
setUU 
=>UU 
SetValueUU 
(UU 
MinHeightPropertyUU )
,UU) *
valueUU+ 0
)UU0 1
;UU1 2
}VV 
publicXX 

newXX 
doubleXX 
	MaxHeightXX 
{YY 
getZZ 
=>ZZ 
GetValueZZ 
(ZZ 
MaxHeightPropertyZZ )
)ZZ) *
;ZZ* +
set[[ 
=>[[ 
SetValue[[ 
([[ 
MaxHeightProperty[[ )
,[[) *
value[[+ 0
)[[0 1
;[[1 2
}\\ 
public^^ 

IBrush^^ 

ScrimColor^^ 
{__ 
get`` 
=>`` 
GetValue`` 
(`` 
ScrimColorProperty`` *
)``* +
;``+ ,
setaa 
=>aa 
SetValueaa 
(aa 
ScrimColorPropertyaa *
,aa* +
valueaa, 1
)aa1 2
;aa2 3
}bb 
publicdd 

booldd %
IsDismissableOnScrimClickdd )
{ee 
getff 
=>ff 
GetValueff 
(ff -
!IsDismissableOnScrimClickPropertyff 9
)ff9 :
;ff: ;
setgg 
=>gg 
SetValuegg 
(gg -
!IsDismissableOnScrimClickPropertygg 9
,gg9 :
valuegg; @
)gg@ A
;ggA B
}hh 
publicjj 

voidjj 
Disposejj 
(jj 
)jj 
{kk 
ifll 

(ll 
	_disposedll 
)ll 
{mm 	
returnnn 
;nn 
}oo 	
ifqq 

(qq 
	ViewModelqq 
isqq !
IActivatableViewModelqq .
activatableqq/ :
)qq: ;
{rr 	
activatabless 
.ss 
	Activatorss !
.ss! "

Deactivatess" ,
(ss, -
)ss- .
;ss. /
}tt 	
ifvv 

(vv 
	ViewModelvv 
isvv 
IDisposablevv $
disposableViewModelvv% 8
)vv8 9
{ww 	
disposableViewModelxx 
.xx  
Disposexx  '
(xx' (
)xx( )
;xx) *
}yy 	
	_disposed{{ 
={{ 
true{{ 
;{{ 
}|| 
	protected 
override 
void "
OnAttachedToVisualTree 2
(2 3)
VisualTreeAttachmentEventArgs3 P
eQ R
)R S
{
ÄÄ 
base
ÅÅ 
.
ÅÅ $
OnAttachedToVisualTree
ÅÅ #
(
ÅÅ# $
e
ÅÅ$ %
)
ÅÅ% &
;
ÅÅ& '
KeyDown
ÇÇ 
+=
ÇÇ 
	OnKeyDown
ÇÇ 
;
ÇÇ 
}
ÉÉ 
	protected
ÖÖ 
override
ÖÖ 
void
ÖÖ &
OnDetachedFromVisualTree
ÖÖ 4
(
ÖÖ4 5+
VisualTreeAttachmentEventArgs
ÖÖ5 R
e
ÖÖS T
)
ÖÖT U
{
ÜÜ 
base
áá 
.
áá &
OnDetachedFromVisualTree
áá %
(
áá% &
e
áá& '
)
áá' (
;
áá( )
KeyDown
àà 
-=
àà 
	OnKeyDown
àà 
;
àà 
Dispose
ââ 
(
ââ 
)
ââ 
;
ââ 
}
ää 
private
åå 
static
åå 
void
åå 
EnsureTransform
åå '
<
åå' (
T
åå( )
>
åå) *
(
åå* +
Visual
åå+ 1
visual
åå2 8
)
åå8 9
where
åå: ?
T
åå@ A
:
ååB C
	Transform
ååD M
,
ååM N
new
ååO R
(
ååR S
)
ååS T
{
çç 

ITransform
éé 
?
éé 
existingTransform
éé %
=
éé& '
visual
éé( .
.
éé. /
RenderTransform
éé/ >
;
éé> ?
if
èè 

(
èè 
existingTransform
èè 
is
èè  
TransformGroup
èè! /
existingGroup
èè0 =
)
èè= >
{
êê 	
if
ëë 
(
ëë 
existingGroup
ëë 
.
ëë 
Children
ëë &
.
ëë& '
OfType
ëë' -
<
ëë- .
T
ëë. /
>
ëë/ 0
(
ëë0 1
)
ëë1 2
.
ëë2 3
Any
ëë3 6
(
ëë6 7
)
ëë7 8
)
ëë8 9
{
íí 
return
ìì 
;
ìì 
}
îî 
T
ññ #
newTransformFromGroup
ññ #
=
ññ$ %
new
ññ& )
(
ññ) *
)
ññ* +
;
ññ+ ,
existingGroup
óó 
.
óó 
Children
óó "
.
óó" #
Add
óó# &
(
óó& '#
newTransformFromGroup
óó' <
)
óó< =
;
óó= >
return
òò 
;
òò 
}
ôô 	
TransformGroup
õõ 
group
õõ 
=
õõ 
new
õõ "
(
õõ" #
)
õõ# $
;
õõ$ %
if
úú 

(
úú 
existingTransform
úú 
is
úú  
	Transform
úú! *
singleTransform
úú+ :
)
úú: ;
{
ùù 	
group
ûû 
.
ûû 
Children
ûû 
.
ûû 
Add
ûû 
(
ûû 
singleTransform
ûû .
)
ûû. /
;
ûû/ 0
}
üü 	
T
°° 	
newTransform
°°
 
=
°° 
new
°° 
(
°° 
)
°° 
;
°° 
group
¢¢ 
.
¢¢ 
Children
¢¢ 
.
¢¢ 
Add
¢¢ 
(
¢¢ 
newTransform
¢¢ '
)
¢¢' (
;
¢¢( )
visual
££ 
.
££ 
RenderTransform
££ 
=
££  
group
££! &
;
££& '
}
§§ 
private
¶¶ 
void
¶¶  
InitializeDefaults
¶¶ #
(
¶¶# $
)
¶¶$ %
{
ßß 
	ViewModel
®® 
=
®® 
Locator
®® 
.
®® 
Current
®® #
.
®®# $

GetService
®®$ .
<
®®. /"
BottomSheetViewModel
®®/ C
>
®®C D
(
®®D E
)
®®E F
;
®®F G'
IsDismissableOnScrimClick
©© !
=
©©" #)
DefaultBottomSheetVariables
©©$ ?
.
©©? @3
%DEFAULT_IS_DISMISSABLE_ON_SCRIM_CLICK
©©@ e
;
©©e f
if
´´ 

(
´´ 
	ViewModel
´´ 
is
´´ #
IActivatableViewModel
´´ ."
activatableViewModel
´´/ C
)
´´C D
{
¨¨ 	"
activatableViewModel
≠≠  
.
≠≠  !
	Activator
≠≠! *
.
≠≠* +
Activate
≠≠+ 3
(
≠≠3 4
)
≠≠4 5
;
≠≠5 6
}
ÆÆ 	
}
ØØ 
private
±± 
void
±± !
InitializeComponent
±± $
(
±±$ %
)
±±% &
{
≤≤  
AvaloniaXamlLoader
≥≥ 
.
≥≥ 
Load
≥≥ 
(
≥≥  
this
≥≥  $
)
≥≥$ %
;
≥≥% & 
InitializeControls
¥¥ 
(
¥¥ 
)
¥¥ 
;
¥¥ #
SetupReactiveBindings
µµ 
(
µµ 
)
µµ 
;
µµ  
}
∂∂ 
private
∏∏ 
void
∏∏  
InitializeControls
∏∏ #
(
∏∏# $
)
∏∏$ %
{
ππ 
	_rootGrid
∫∫ 
=
∫∫ 
this
∫∫ 
.
∫∫ 
FindControl
∫∫ $
<
∫∫$ %
Grid
∫∫% )
>
∫∫) *
(
∫∫* +
$str
∫∫+ 5
)
∫∫5 6
;
∫∫6 7
_sheetBorder
ªª 
=
ªª 
this
ªª 
.
ªª 
FindControl
ªª '
<
ªª' (
Border
ªª( .
>
ªª. /
(
ªª/ 0
$str
ªª0 =
)
ªª= >
;
ªª> ?
_scrimBorder
ºº 
=
ºº 
this
ºº 
.
ºº 
FindControl
ºº '
<
ºº' (
Border
ºº( .
>
ºº. /
(
ºº/ 0
$str
ºº0 =
)
ºº= >
;
ºº> ?
_contentControl
ΩΩ 
=
ΩΩ 
this
ΩΩ 
.
ΩΩ 
FindControl
ΩΩ *
<
ΩΩ* +
ContentControl
ΩΩ+ 9
>
ΩΩ9 :
(
ΩΩ: ;
$str
ΩΩ; K
)
ΩΩK L
;
ΩΩL M
if
øø 

(
øø 
_sheetBorder
øø 
!=
øø 
null
øø  
&&
øø! #
_scrimBorder
øø$ 0
!=
øø1 3
null
øø4 8
&&
øø9 ;
	_rootGrid
øø< E
!=
øøF H
null
øøI M
)
øøM N
{
¿¿ 	
EnsureTransform
¡¡ 
<
¡¡  
TranslateTransform
¡¡ .
>
¡¡. /
(
¡¡/ 0
_sheetBorder
¡¡0 <
)
¡¡< =
;
¡¡= >
	_rootGrid
¬¬ 
.
¬¬ 
	IsVisible
¬¬ 
=
¬¬  !
false
¬¬" '
;
¬¬' (
_sheetBorder
√√ 
.
√√ 
	IsVisible
√√ "
=
√√# $
false
√√% *
;
√√* +
_scrimBorder
ƒƒ 
.
ƒƒ 
	IsVisible
ƒƒ "
=
ƒƒ# $
false
ƒƒ% *
;
ƒƒ* +
}
≈≈ 	
}
∆∆ 
private
»» 
void
»» #
SetupReactiveBindings
»» &
(
»»& '
)
»»' (
{
…… 
this
   
.
   
WhenActivated
   
(
   
disposables
   &
=>
  ' )
{
ÀÀ 	&
SetupDismissableBindings
ÃÃ $
(
ÃÃ$ %
disposables
ÃÃ% 0
)
ÃÃ0 1
;
ÃÃ1 2$
SetupScrimColorBinding
ÕÕ "
(
ÕÕ" #
disposables
ÕÕ# .
)
ÕÕ. /
;
ÕÕ/ 0$
SetupAnimationBindings
ŒŒ "
(
ŒŒ" #
disposables
ŒŒ# .
)
ŒŒ. /
;
ŒŒ/ 0
}
œœ 	
)
œœ	 

;
œœ
 
}
–– 
private
““ 
void
““ $
SetupScrimColorBinding
““ '
(
““' (!
CompositeDisposable
““( ;
disposables
““< G
)
““G H
{
”” 
this
‘‘ 
.
‘‘ 
WhenAnyValue
‘‘ 
(
‘‘ 
x
’’ 
=>
’’ 
x
’’ 
.
’’ '
IsDismissableOnScrimClick
’’ 0
,
’’0 1
x
÷÷ 
=>
÷÷ 
x
÷÷ 
.
÷÷ #
DismissableScrimColor
÷÷ ,
,
÷÷, -
x
◊◊ 
=>
◊◊ 
x
◊◊ 
.
◊◊ %
UnDismissableScrimColor
◊◊ .
)
◊◊. /
.
ÿÿ 
	Subscribe
ÿÿ 
(
ÿÿ 
tuple
ÿÿ 
=>
ÿÿ 
{
ŸŸ 
(
⁄⁄ 
bool
⁄⁄ 
isDismissable
⁄⁄ #
,
⁄⁄# $
IBrush
⁄⁄% +
dismissableColor
⁄⁄, <
,
⁄⁄< =
IBrush
⁄⁄> D 
unDismissableColor
⁄⁄E W
)
⁄⁄W X
=
⁄⁄Y Z
tuple
⁄⁄[ `
;
⁄⁄` a

ScrimColor
€€ 
=
€€ 
isDismissable
€€ *
?
€€+ ,
dismissableColor
€€- =
:
€€> ? 
unDismissableColor
€€@ R
;
€€R S
}
‹‹ 
)
‹‹ 
.
›› 
DisposeWith
›› 
(
›› 
disposables
›› $
)
››$ %
;
››% &
}
ﬁﬁ 
private
‡‡ 
void
‡‡ &
SetupDismissableBindings
‡‡ )
(
‡‡) *!
CompositeDisposable
‡‡* =
disposables
‡‡> I
)
‡‡I J
{
·· 
this
‚‚ 
.
‚‚ 
WhenAnyValue
‚‚ 
(
‚‚ 
x
‚‚ 
=>
‚‚ 
x
‚‚  
.
‚‚  !
	ViewModel
‚‚! *
)
‚‚* +
.
„„ 
WhereNotNull
„„ 
(
„„ 
)
„„ 
.
‰‰ 
Take
‰‰ 
(
‰‰ 
$num
‰‰ 
)
‰‰ 
.
ÂÂ 
	Subscribe
ÂÂ 
(
ÂÂ 
	viewModel
ÂÂ  
=>
ÂÂ! #
	viewModel
ÂÂ$ -
.
ÂÂ- .'
IsDismissableOnScrimClick
ÂÂ. G
=
ÂÂH I'
IsDismissableOnScrimClick
ÂÂJ c
)
ÂÂc d
.
ÊÊ 
DisposeWith
ÊÊ 
(
ÊÊ 
disposables
ÊÊ $
)
ÊÊ$ %
;
ÊÊ% &
this
ËË 
.
ËË 
WhenAnyValue
ËË 
(
ËË 
x
ËË 
=>
ËË 
x
ËË  
.
ËË  !
	ViewModel
ËË! *
!
ËË* +
.
ËË+ ,'
IsDismissableOnScrimClick
ËË, E
)
ËËE F
.
ÈÈ 
	Subscribe
ÈÈ 
(
ÈÈ 
isDismissable
ÈÈ $
=>
ÈÈ% ''
IsDismissableOnScrimClick
ÈÈ( A
=
ÈÈB C
isDismissable
ÈÈD Q
)
ÈÈQ R
.
ÍÍ 
DisposeWith
ÍÍ 
(
ÍÍ 
disposables
ÍÍ $
)
ÍÍ$ %
;
ÍÍ% &
}
ÎÎ 
private
ÌÌ 
void
ÌÌ $
SetupAnimationBindings
ÌÌ '
(
ÌÌ' (!
CompositeDisposable
ÌÌ( ;
disposables
ÌÌ< G
)
ÌÌG H
{
ÓÓ 
this
ÔÔ 
.
ÔÔ 
WhenAnyValue
ÔÔ 
(
ÔÔ 
x
ÔÔ 
=>
ÔÔ 
x
ÔÔ  
.
ÔÔ  !
	ViewModel
ÔÔ! *
!
ÔÔ* +
.
ÔÔ+ ,
	IsVisible
ÔÔ, 5
)
ÔÔ5 6
.
 
Skip
 
(
 
$num
 
)
 
.
ÒÒ 
	ObserveOn
ÒÒ 
(
ÒÒ 
RxApp
ÒÒ 
.
ÒÒ !
MainThreadScheduler
ÒÒ 0
)
ÒÒ0 1
.
ÚÚ 
	Subscribe
ÚÚ 
(
ÚÚ 
async
ÚÚ 
void
ÚÚ !
(
ÚÚ" #
	isVisible
ÚÚ# ,
)
ÚÚ, -
=>
ÚÚ. 0
{
ÛÛ 
try
ÙÙ 
{
ıı 
await
ˆˆ !
OnVisibilityChanged
ˆˆ -
(
ˆˆ- .
	isVisible
ˆˆ. 7
)
ˆˆ7 8
;
ˆˆ8 9
}
˜˜ 
catch
¯¯ 
(
¯¯ 
	Exception
¯¯  
e
¯¯! "
)
¯¯" #
{
˘˘ 
Log
˙˙ 
.
˙˙ 
Error
˙˙ 
(
˙˙ 
e
˙˙ 
,
˙˙  
$str
˙˙! e
,
˙˙e f
	isVisible
˙˙g p
)
˙˙p q
;
˙˙q r
}
˚˚ 
}
¸¸ 
)
¸¸ 
.
˝˝ 
DisposeWith
˝˝ 
(
˝˝ 
disposables
˝˝ $
)
˝˝$ %
;
˝˝% &
}
˛˛ 
private
ÄÄ 
IInputElement
ÄÄ 
?
ÄÄ %
_previousFocusedElement
ÄÄ 2
;
ÄÄ2 3
private
ÅÅ 
async
ÅÅ 
Task
ÅÅ !
OnVisibilityChanged
ÅÅ *
(
ÅÅ* +
bool
ÅÅ+ /
	isVisible
ÅÅ0 9
)
ÅÅ9 :
{
ÇÇ 
if
ÉÉ 

(
ÉÉ 
	_rootGrid
ÉÉ 
is
ÉÉ 
null
ÉÉ 
)
ÉÉ 
{
ÑÑ 	
return
ÖÖ 
;
ÖÖ 
}
ÜÜ 	
await
àà -
WaitForAnimationToCompleteAsync
àà -
(
àà- .
)
àà. /
;
àà/ 0
if
ää 

(
ää 
	isVisible
ää 
)
ää 
{
ãã 	
await
åå +
ShowBottomSheetWithFocusAsync
åå /
(
åå/ 0
)
åå0 1
;
åå1 2
}
çç 	
else
éé 
{
èè 	
await
êê 2
$HideBottomSheetWithFocusRestoreAsync
êê 6
(
êê6 7
)
êê7 8
;
êê8 9
}
ëë 	
}
íí 
private
îî 
async
îî 
Task
îî -
WaitForAnimationToCompleteAsync
îî 6
(
îî6 7
)
îî7 8
{
ïï 
if
ññ 

(
ññ 
!
ññ 
_isAnimating
ññ 
)
ññ 
{
óó 	
return
òò 
;
òò 
}
ôô 	
DateTime
õõ 
timeout
õõ 
=
õõ 
DateTime
õõ #
.
õõ# $
UtcNow
õõ$ *
.
õõ* +

AddSeconds
õõ+ 5
(
õõ5 6
$num
õõ6 7
)
õõ7 8
;
õõ8 9
while
úú 
(
úú 
_isAnimating
úú 
&&
úú 
DateTime
úú '
.
úú' (
UtcNow
úú( .
<
úú/ 0
timeout
úú1 8
)
úú8 9
{
ùù 	
await
ûû 
Task
ûû 
.
ûû 
Delay
ûû 
(
ûû 
$num
ûû 
)
ûû  
;
ûû  !
}
üü 	
if
°° 

(
°° 
_isAnimating
°° 
)
°° 
{
¢¢ 	
_isAnimating
££ 
=
££ 
false
££  
;
££  !
}
§§ 	
}
•• 
private
ßß 
async
ßß 
Task
ßß +
ShowBottomSheetWithFocusAsync
ßß 4
(
ßß4 5
)
ßß5 6
{
®® (
SavePreviousFocusedElement
©© "
(
©©" #
)
©©# $
;
©©$ %
UpdateSheetHeight
™™ 
(
™™ 
)
™™ 
;
™™ 
await
´´ 
ShowBottomSheet
´´ 
(
´´ 
)
´´ 
;
´´  
Focus
¨¨ 
(
¨¨ 
)
¨¨ 
;
¨¨ 
}
≠≠ 
private
ØØ 
void
ØØ (
SavePreviousFocusedElement
ØØ +
(
ØØ+ ,
)
ØØ, -
{
∞∞ 
try
±± 
{
≤≤ 	
TopLevel
≥≥ 
?
≥≥ 

visualRoot
≥≥  
=
≥≥! "
	_rootGrid
≥≥# ,
?
≥≥, -
.
≥≥- .
GetVisualRoot
≥≥. ;
(
≥≥; <
)
≥≥< =
as
≥≥> @
TopLevel
≥≥A I
;
≥≥I J%
_previousFocusedElement
¥¥ #
=
¥¥$ %

visualRoot
¥¥& 0
?
¥¥0 1
.
¥¥1 2
FocusManager
¥¥2 >
?
¥¥> ?
.
¥¥? @
GetFocusedElement
¥¥@ Q
(
¥¥Q R
)
¥¥R S
;
¥¥S T
}
µµ 	
catch
∂∂ 
(
∂∂ 
	Exception
∂∂ 
)
∂∂ 
{
∑∑ 	%
_previousFocusedElement
∏∏ #
=
∏∏$ %
null
∏∏& *
;
∏∏* +
}
ππ 	
}
∫∫ 
private
ºº 
async
ºº 
Task
ºº 2
$HideBottomSheetWithFocusRestoreAsync
ºº ;
(
ºº; <
)
ºº< =
{
ΩΩ 
await
ææ 
HideBottomSheet
ææ 
(
ææ 
)
ææ 
;
ææ  "
RestorePreviousFocus
øø 
(
øø 
)
øø 
;
øø 
}
¿¿ 
private
¬¬ 
void
¬¬ "
RestorePreviousFocus
¬¬ %
(
¬¬% &
)
¬¬& '
{
√√ 
try
ƒƒ 
{
≈≈ 	
if
∆∆ 
(
∆∆ %
_previousFocusedElement
∆∆ '
is
∆∆( *
{
∆∆+ ,
}
∆∆- .
previous
∆∆/ 7
)
∆∆7 8
{
«« 
previous
»» 
.
»» 
Focus
»» 
(
»» 
)
»»  
;
»»  !%
_previousFocusedElement
…… '
=
……( )
null
……* .
;
……. /
}
   
else
ÀÀ 
if
ÀÀ 
(
ÀÀ 
Parent
ÀÀ 
is
ÀÀ 
Control
ÀÀ &
parentControl
ÀÀ' 4
)
ÀÀ4 5
{
ÃÃ 
parentControl
ÕÕ 
.
ÕÕ 
Focus
ÕÕ #
(
ÕÕ# $
)
ÕÕ$ %
;
ÕÕ% &
}
ŒŒ 
}
œœ 	
catch
–– 
(
–– 
	Exception
–– 
)
–– 
{
—— 	#
TryFocusParentControl
““ !
(
““! "
)
““" #
;
““# $
}
”” 	
}
‘‘ 
private
÷÷ 
void
÷÷ #
TryFocusParentControl
÷÷ &
(
÷÷& '
)
÷÷' (
{
◊◊ 
if
ÿÿ 

(
ÿÿ 
Parent
ÿÿ 
is
ÿÿ 
Control
ÿÿ 
fallbackParent
ÿÿ ,
)
ÿÿ, -
{
ŸŸ 	
fallbackParent
⁄⁄ 
.
⁄⁄ 
Focus
⁄⁄  
(
⁄⁄  !
)
⁄⁄! "
;
⁄⁄" #
}
€€ 	
}
‹‹ 
private
ﬁﬁ 
void
ﬁﬁ 
UpdateSheetHeight
ﬁﬁ "
(
ﬁﬁ" #
)
ﬁﬁ# $
{
ﬂﬂ 
if
‡‡ 

(
‡‡ 
_contentControl
‡‡ 
==
‡‡ 
null
‡‡ #
||
‡‡$ &
_sheetBorder
‡‡' 3
==
‡‡4 6
null
‡‡7 ;
)
‡‡; <
{
·· 	
_sheetHeight
‚‚ 
=
‚‚ 
	MinHeight
‚‚ $
;
‚‚$ %
return
„„ 
;
„„ 
}
‰‰ 	
double
ÊÊ 

sheetWidth
ÊÊ 
=
ÊÊ 
_sheetBorder
ÊÊ (
.
ÊÊ( )
Width
ÊÊ) .
;
ÊÊ. /
if
ÁÁ 

(
ÁÁ 
double
ÁÁ 
.
ÁÁ 
IsNaN
ÁÁ 
(
ÁÁ 

sheetWidth
ÁÁ #
)
ÁÁ# $
||
ÁÁ% '

sheetWidth
ÁÁ( 2
<=
ÁÁ3 5
$num
ÁÁ6 7
)
ÁÁ7 8
{
ËË 	

sheetWidth
ÈÈ 
=
ÈÈ )
DefaultBottomSheetVariables
ÈÈ 4
.
ÈÈ4 5
DEFAULT_WIDTH
ÈÈ5 B
;
ÈÈB C
}
ÍÍ 	
	Thickness
ÏÏ 
padding
ÏÏ 
=
ÏÏ 
_sheetBorder
ÏÏ (
.
ÏÏ( )
Padding
ÏÏ) 0
;
ÏÏ0 1
	Thickness
ÌÌ 
borderThickness
ÌÌ !
=
ÌÌ" #
_sheetBorder
ÌÌ$ 0
.
ÌÌ0 1
BorderThickness
ÌÌ1 @
;
ÌÌ@ A
double
ÔÔ 
verticalExtras
ÔÔ 
=
ÔÔ 
padding
ÔÔ  '
.
ÔÔ' (
Top
ÔÔ( +
+
ÔÔ, -
padding
ÔÔ. 5
.
ÔÔ5 6
Bottom
ÔÔ6 <
+
ÔÔ= >
borderThickness
ÔÔ? N
.
ÔÔN O
Top
ÔÔO R
+
ÔÔS T
borderThickness
ÔÔU d
.
ÔÔd e
Bottom
ÔÔe k
;
ÔÔk l
double
 
horizontalExtras
 
=
  !
padding
" )
.
) *
Left
* .
+
/ 0
padding
1 8
.
8 9
Right
9 >
+
? @
borderThickness
A P
.
P Q
Left
Q U
+
V W
borderThickness
X g
.
g h
Right
h m
;
m n
double
ÚÚ 
availableWidth
ÚÚ 
=
ÚÚ 

sheetWidth
ÚÚ  *
-
ÚÚ+ ,
horizontalExtras
ÚÚ- =
;
ÚÚ= >
double
ÛÛ 
availableHeight
ÛÛ 
=
ÛÛ  
	MaxHeight
ÛÛ! *
-
ÛÛ+ ,
verticalExtras
ÛÛ- ;
;
ÛÛ; <
Size
ıı 
availableSize
ıı 
=
ıı 
new
ıı  
(
ıı  !
availableWidth
ıı! /
,
ıı/ 0
double
ıı1 7
.
ıı7 8
PositiveInfinity
ıı8 H
)
ııH I
;
ııI J
_contentControl
ˆˆ 
.
ˆˆ 
Measure
ˆˆ 
(
ˆˆ  
availableSize
ˆˆ  -
)
ˆˆ- .
;
ˆˆ. /
double
¯¯ 
contentHeight
¯¯ 
=
¯¯ 
_contentControl
¯¯ .
.
¯¯. /
DesiredSize
¯¯/ :
.
¯¯: ;
Height
¯¯; A
;
¯¯A B
if
˙˙ 

(
˙˙ 
double
˙˙ 
.
˙˙ 
IsNaN
˙˙ 
(
˙˙ 
contentHeight
˙˙ &
)
˙˙& '
||
˙˙( *
contentHeight
˙˙+ 8
<=
˙˙9 ;
$num
˙˙< =
)
˙˙= >
{
˚˚ 	
contentHeight
¸¸ 
=
¸¸ 
	MinHeight
¸¸ %
;
¸¸% &
}
˝˝ 	
double
ˇˇ 
maxContentHeight
ˇˇ 
=
ˇˇ  !
Math
ˇˇ" &
.
ˇˇ& '
Max
ˇˇ' *
(
ˇˇ* +
	MinHeight
ˇˇ+ 4
,
ˇˇ4 5
availableHeight
ˇˇ6 E
)
ˇˇE F
;
ˇˇF G
_sheetHeight
ÅÅ 
=
ÅÅ 
Math
ÅÅ 
.
ÅÅ 
Clamp
ÅÅ !
(
ÅÅ! "
contentHeight
ÅÅ" /
,
ÅÅ/ 0
	MinHeight
ÅÅ1 :
,
ÅÅ: ;
maxContentHeight
ÅÅ< L
)
ÅÅL M
;
ÅÅM N
_sheetBorder
ÇÇ 
.
ÇÇ 
Height
ÇÇ 
=
ÇÇ 
_sheetHeight
ÇÇ *
;
ÇÇ* +
}
ÉÉ 
private
ÖÖ 
async
ÖÖ 
Task
ÖÖ 
ShowBottomSheet
ÖÖ &
(
ÖÖ& '
)
ÖÖ' (
{
ÜÜ 
if
áá 

(
áá 
_sheetBorder
áá 
is
áá 
null
áá  
||
áá! #
	_rootGrid
áá$ -
is
áá. 0
null
áá1 5
)
áá5 6
{
àà 	
return
ââ 
;
ââ 
}
ää 	
UpdateSheetHeight
åå 
(
åå 
)
åå 
;
åå 
CreateAnimations
çç 
(
çç 
)
çç 
;
çç 
if
èè 

(
èè 
_showAnimation
èè 
is
èè 
null
èè "
)
èè" #
{
êê 	
return
ëë 
;
ëë 
}
íí 	
_isAnimating
îî 
=
îî 
true
îî 
;
îî 
_sheetBorder
ïï 
.
ïï 
IsHitTestVisible
ïï %
=
ïï& '
false
ïï( -
;
ïï- .
	_rootGrid
óó 
.
óó 
	IsVisible
óó 
=
óó 
true
óó "
;
óó" #
_sheetBorder
òò 
.
òò 
	IsVisible
òò 
=
òò  
true
òò! %
;
òò% &
if
öö 

(
öö 
	ViewModel
öö 
?
öö 
.
öö 
	ShowScrim
öö  
is
öö! #
true
öö$ (
&&
öö) +
_scrimBorder
öö, 8
is
öö9 ;
not
öö< ?
null
öö@ D
)
ööD E
{
õõ 	
_scrimBorder
úú 
.
úú 
	IsVisible
úú "
=
úú# $
true
úú% )
;
úú) *
}
ùù 	
try
üü 
{
†† 	
List
°° 
<
°° 
Task
°° 
>
°° 
	showTasks
°°  
=
°°! "
[
°°# $
_showAnimation
°°$ 2
.
°°2 3
RunAsync
°°3 ;
(
°°; <
_sheetBorder
°°< H
,
°°H I
CancellationToken
°°J [
.
°°[ \
None
°°\ `
)
°°` a
]
°°a b
;
°°b c
if
££ 
(
££ 
	ViewModel
££ 
?
££ 
.
££ 
	ShowScrim
££ $
is
££% '
true
££( ,
&&
££- /!
_scrimShowAnimation
££0 C
is
££D F
not
££G J
null
££K O
&&
££P R
_scrimBorder
££S _
is
££` b
not
££c f
null
££g k
)
££k l
{
§§ 
	showTasks
•• 
.
•• 
Add
•• 
(
•• !
_scrimShowAnimation
•• 1
.
••1 2
RunAsync
••2 :
(
••: ;
_scrimBorder
••; G
,
••G H
CancellationToken
••I Z
.
••Z [
None
••[ _
)
••_ `
)
••` a
;
••a b
}
¶¶ 
await
®® 
Task
®® 
.
®® 
WhenAll
®® 
(
®® 
	showTasks
®® (
)
®®( )
;
®®) *
}
©© 	
finally
™™ 
{
´´ 	
_isAnimating
¨¨ 
=
¨¨ 
false
¨¨  
;
¨¨  !
_sheetBorder
≠≠ 
.
≠≠ 
IsHitTestVisible
≠≠ )
=
≠≠* +
true
≠≠, 0
;
≠≠0 1
}
ÆÆ 	
}
ØØ 
private
±± 
async
±± 
Task
±± 
HideBottomSheet
±± &
(
±±& '
)
±±' (
{
≤≤ 
if
≥≥ 

(
≥≥ 
_hideAnimation
≥≥ 
is
≥≥ 
null
≥≥ "
||
≥≥# %
_sheetBorder
≥≥& 2
is
≥≥3 5
null
≥≥6 :
||
≥≥; =
	_rootGrid
≥≥> G
is
≥≥H J
null
≥≥K O
)
≥≥O P
{
¥¥ 	
return
µµ 
;
µµ 
}
∂∂ 	
_isAnimating
∏∏ 
=
∏∏ 
true
∏∏ 
;
∏∏ 
_sheetBorder
ππ 
.
ππ 
IsHitTestVisible
ππ %
=
ππ& '
false
ππ( -
;
ππ- .
try
ªª 
{
ºº 	
List
ΩΩ 
<
ΩΩ 
Task
ΩΩ 
>
ΩΩ 
	hideTasks
ΩΩ  
=
ΩΩ! "
[
ΩΩ# $
_hideAnimation
ΩΩ$ 2
.
ΩΩ2 3
RunAsync
ΩΩ3 ;
(
ΩΩ; <
_sheetBorder
ΩΩ< H
,
ΩΩH I
CancellationToken
ΩΩJ [
.
ΩΩ[ \
None
ΩΩ\ `
)
ΩΩ` a
]
ΩΩa b
;
ΩΩb c
if
øø 
(
øø 
	ViewModel
øø 
?
øø 
.
øø 
	ShowScrim
øø $
is
øø% '
true
øø( ,
&&
øø- /!
_scrimHideAnimation
øø0 C
is
øøD F
not
øøG J
null
øøK O
&&
øøP R
_scrimBorder
øøS _
is
øø` b
not
øøc f
null
øøg k
)
øøk l
{
¿¿ 
	hideTasks
¡¡ 
.
¡¡ 
Add
¡¡ 
(
¡¡ !
_scrimHideAnimation
¡¡ 1
.
¡¡1 2
RunAsync
¡¡2 :
(
¡¡: ;
_scrimBorder
¡¡; G
,
¡¡G H
CancellationToken
¡¡I Z
.
¡¡Z [
None
¡¡[ _
)
¡¡_ `
)
¡¡` a
;
¡¡a b
}
¬¬ 
await
ƒƒ 
Task
ƒƒ 
.
ƒƒ 
WhenAll
ƒƒ 
(
ƒƒ 
	hideTasks
ƒƒ (
)
ƒƒ( )
;
ƒƒ) *
_sheetBorder
∆∆ 
.
∆∆ 
	IsVisible
∆∆ "
=
∆∆# $
false
∆∆% *
;
∆∆* +
if
«« 
(
«« 
_scrimBorder
«« 
is
«« 
not
««  #
null
««$ (
)
««( )
{
»» 
_scrimBorder
…… 
.
…… 
	IsVisible
…… &
=
……' (
false
……) .
;
……. /
}
   
	_rootGrid
ÃÃ 
.
ÃÃ 
	IsVisible
ÃÃ 
=
ÃÃ  !
false
ÃÃ" '
;
ÃÃ' (
}
ÕÕ 	
finally
ŒŒ 
{
œœ 	
_isAnimating
–– 
=
–– 
false
––  
;
––  !
}
—— 	
}
““ 
private
‘‘ 
void
‘‘ 
CreateAnimations
‘‘ !
(
‘‘! "
)
‘‘" #
{
’’ 
double
÷÷ 
hiddenPosition
÷÷ 
=
÷÷ 
_sheetHeight
÷÷  ,
;
÷÷, -
CubicEaseInOut
ÿÿ 

showEasing
ÿÿ !
=
ÿÿ" #
new
ÿÿ$ '
(
ÿÿ' (
)
ÿÿ( )
;
ÿÿ) *
CubicEaseInOut
ŸŸ 

hideEasing
ŸŸ !
=
ŸŸ" #
new
ŸŸ$ '
(
ŸŸ' (
)
ŸŸ( )
;
ŸŸ) *
_showAnimation
€€ 
=
€€ 
new
€€ 
	Animation
€€ &
{
‹‹ 	
Duration
›› 
=
›› +
BottomSheetAnimationConstants
›› 4
.
››4 5#
ShowAnimationDuration
››5 J
,
››J K
Easing
ﬁﬁ 
=
ﬁﬁ 

showEasing
ﬁﬁ 
,
ﬁﬁ  
FillMode
ﬂﬂ 
=
ﬂﬂ 
FillMode
ﬂﬂ 
.
ﬂﬂ  
Both
ﬂﬂ  $
,
ﬂﬂ$ %
Children
‡‡ 
=
‡‡ 
{
·· 
new
‚‚ 
KeyFrame
‚‚ 
{
‚‚ 
Cue
‚‚ "
=
‚‚# $
new
‚‚% (
Cue
‚‚) ,
(
‚‚, -
$num
‚‚- 0
)
‚‚0 1
,
‚‚1 2
Setters
‚‚3 :
=
‚‚; <
{
‚‚= >
new
‚‚? B
Setter
‚‚C I
(
‚‚I J 
TranslateTransform
‚‚J \
.
‚‚\ ]
	YProperty
‚‚] f
,
‚‚f g
hiddenPosition
‚‚h v
)
‚‚v w
,
‚‚w x
new
‚‚y |
Setter‚‚} É
(‚‚É Ñ
OpacityProperty‚‚Ñ ì
,‚‚ì î
$num‚‚ï ò
)‚‚ò ô
}‚‚ö õ
}‚‚ú ù
,‚‚ù û
new
„„ 
KeyFrame
„„ 
{
„„ 
Cue
„„ "
=
„„# $
new
„„% (
Cue
„„) ,
(
„„, -
$num
„„- 0
)
„„0 1
,
„„1 2
Setters
„„3 :
=
„„; <
{
„„= >
new
„„? B
Setter
„„C I
(
„„I J 
TranslateTransform
„„J \
.
„„\ ]
	YProperty
„„] f
,
„„f g
$num
„„h k
)
„„k l
}
„„m n
}
„„o p
}
‰‰ 
}
ÂÂ 	
;
ÂÂ	 

_hideAnimation
ÁÁ 
=
ÁÁ 
new
ÁÁ 
	Animation
ÁÁ &
{
ËË 	
Duration
ÈÈ 
=
ÈÈ +
BottomSheetAnimationConstants
ÈÈ 4
.
ÈÈ4 5#
HideAnimationDuration
ÈÈ5 J
,
ÈÈJ K
Easing
ÍÍ 
=
ÍÍ 

hideEasing
ÍÍ 
,
ÍÍ  
FillMode
ÎÎ 
=
ÎÎ 
FillMode
ÎÎ 
.
ÎÎ  
Both
ÎÎ  $
,
ÎÎ$ %
Children
ÏÏ 
=
ÏÏ 
{
ÌÌ 
new
ÓÓ 
KeyFrame
ÓÓ 
{
ÓÓ 
Cue
ÓÓ "
=
ÓÓ# $
new
ÓÓ% (
Cue
ÓÓ) ,
(
ÓÓ, -
$num
ÓÓ- 0
)
ÓÓ0 1
,
ÓÓ1 2
Setters
ÓÓ3 :
=
ÓÓ; <
{
ÓÓ= >
new
ÓÓ? B
Setter
ÓÓC I
(
ÓÓI J 
TranslateTransform
ÓÓJ \
.
ÓÓ\ ]
	YProperty
ÓÓ] f
,
ÓÓf g
$num
ÓÓh k
)
ÓÓk l
,
ÓÓl m
new
ÓÓn q
Setter
ÓÓr x
(
ÓÓx y
OpacityPropertyÓÓy à
,ÓÓà â
$numÓÓä ç
)ÓÓç é
}ÓÓè ê
}ÓÓë í
,ÓÓí ì
new
ÔÔ 
KeyFrame
ÔÔ 
{
ÔÔ 
Cue
ÔÔ "
=
ÔÔ# $
new
ÔÔ% (
Cue
ÔÔ) ,
(
ÔÔ, -
$num
ÔÔ- 0
)
ÔÔ0 1
,
ÔÔ1 2
Setters
ÔÔ3 :
=
ÔÔ; <
{
ÔÔ= >
new
ÔÔ? B
Setter
ÔÔC I
(
ÔÔI J 
TranslateTransform
ÔÔJ \
.
ÔÔ\ ]
	YProperty
ÔÔ] f
,
ÔÔf g
hiddenPosition
ÔÔh v
)
ÔÔv w
,
ÔÔw x
new
ÔÔy |
SetterÔÔ} É
(ÔÔÉ Ñ
OpacityPropertyÔÔÑ ì
,ÔÔì î
$numÔÔï ò
)ÔÔò ô
}ÔÔö õ
}ÔÔú ù
}
 
}
ÒÒ 	
;
ÒÒ	 

if
ÛÛ 

(
ÛÛ 
	ViewModel
ÛÛ 
?
ÛÛ 
.
ÛÛ 
	ShowScrim
ÛÛ  
is
ÛÛ! #
not
ÛÛ$ '
true
ÛÛ( ,
)
ÛÛ, -
{
ÙÙ 	
return
ıı 
;
ıı 
}
ˆˆ 	!
_scrimShowAnimation
¯¯ 
=
¯¯ 
new
¯¯ !
	Animation
¯¯" +
{
˘˘ 	
Duration
˙˙ 
=
˙˙ +
BottomSheetAnimationConstants
˙˙ 4
.
˙˙4 5#
ShowAnimationDuration
˙˙5 J
,
˙˙J K
Easing
˚˚ 
=
˚˚ 
new
˚˚ 
CubicEaseInOut
˚˚ '
(
˚˚' (
)
˚˚( )
,
˚˚) *
FillMode
¸¸ 
=
¸¸ 
FillMode
¸¸ 
.
¸¸  
Both
¸¸  $
,
¸¸$ %
Children
˝˝ 
=
˝˝ 
{
˛˛ 
new
ˇˇ 
KeyFrame
ˇˇ 
{
ˇˇ 
Cue
ˇˇ "
=
ˇˇ# $
new
ˇˇ% (
Cue
ˇˇ) ,
(
ˇˇ, -
$num
ˇˇ- 0
)
ˇˇ0 1
,
ˇˇ1 2
Setters
ˇˇ3 :
=
ˇˇ; <
{
ˇˇ= >
new
ˇˇ? B
Setter
ˇˇC I
(
ˇˇI J
OpacityProperty
ˇˇJ Y
,
ˇˇY Z
$num
ˇˇ[ ^
)
ˇˇ^ _
}
ˇˇ` a
}
ˇˇb c
,
ˇˇc d
new
ÄÄ 
KeyFrame
ÄÄ 
{
ÄÄ 
Cue
ÄÄ "
=
ÄÄ# $
new
ÄÄ% (
Cue
ÄÄ) ,
(
ÄÄ, -
$num
ÄÄ- 0
)
ÄÄ0 1
,
ÄÄ1 2
Setters
ÄÄ3 :
=
ÄÄ; <
{
ÄÄ= >
new
ÄÄ? B
Setter
ÄÄC I
(
ÄÄI J
OpacityProperty
ÄÄJ Y
,
ÄÄY Z
$num
ÄÄ[ ^
)
ÄÄ^ _
}
ÄÄ` a
}
ÄÄb c
}
ÅÅ 
}
ÇÇ 	
;
ÇÇ	 
!
_scrimHideAnimation
ÑÑ 
=
ÑÑ 
new
ÑÑ !
	Animation
ÑÑ" +
{
ÖÖ 	
Duration
ÜÜ 
=
ÜÜ +
BottomSheetAnimationConstants
ÜÜ 4
.
ÜÜ4 5#
HideAnimationDuration
ÜÜ5 J
,
ÜÜJ K
Easing
áá 
=
áá 
new
áá 
CubicEaseInOut
áá '
(
áá' (
)
áá( )
,
áá) *
FillMode
àà 
=
àà 
FillMode
àà 
.
àà  
Both
àà  $
,
àà$ %
Children
ââ 
=
ââ 
{
ää 
new
ãã 
KeyFrame
ãã 
{
ãã 
Cue
ãã "
=
ãã# $
new
ãã% (
Cue
ãã) ,
(
ãã, -
$num
ãã- 0
)
ãã0 1
,
ãã1 2
Setters
ãã3 :
=
ãã; <
{
ãã= >
new
ãã? B
Setter
ããC I
(
ããI J
OpacityProperty
ããJ Y
,
ããY Z
$num
ãã[ ^
)
ãã^ _
}
ãã` a
}
ããb c
,
ããc d
new
åå 
KeyFrame
åå 
{
åå 
Cue
åå "
=
åå# $
new
åå% (
Cue
åå) ,
(
åå, -
$num
åå- 0
)
åå0 1
,
åå1 2
Setters
åå3 :
=
åå; <
{
åå= >
new
åå? B
Setter
ååC I
(
ååI J
OpacityProperty
ååJ Y
,
ååY Z
$num
åå[ ^
)
åå^ _
}
åå` a
}
ååb c
}
çç 
}
éé 	
;
éé	 

}
èè 
private
ëë 
async
ëë 
void
ëë #
OnScrimPointerPressed
ëë ,
(
ëë, -
object
ëë- 3
?
ëë3 4
sender
ëë5 ;
,
ëë; <%
PointerPressedEventArgs
ëë= T
e
ëëU V
)
ëëV W
{
íí 
try
ìì 
{
îî 	
if
ïï 
(
ïï 
!
ïï '
IsDismissableOnScrimClick
ïï *
||
ïï+ -
	ViewModel
ïï. 7
is
ïï8 :
null
ïï; ?
||
ïï@ B
_isAnimating
ïïC O
)
ïïO P
{
ññ 
return
óó 
;
óó 
}
òò 
	ViewModel
öö 
.
öö 
	IsVisible
öö 
=
öö  !
false
öö" '
;
öö' (
await
úú 
Task
úú 
.
úú 
Delay
úú 
(
úú +
BottomSheetAnimationConstants
úú :
.
úú: ;#
HideAnimationDuration
úú; P
)
úúP Q
;
úúQ R
	ViewModel
ûû 
.
ûû "
BottomSheetDismissed
ûû *
(
ûû* +
)
ûû+ ,
;
ûû, -
}
üü 	
catch
†† 
{
°° 	
}
££ 	
}
§§ 
private
¶¶ 
static
¶¶ 
readonly
¶¶ 
FrozenDictionary
¶¶ ,
<
¶¶, -
Key
¶¶- 0
,
¶¶0 1
Func
¶¶2 6
<
¶¶6 7 
BottomSheetControl
¶¶7 I
,
¶¶I J
bool
¶¶K O
>
¶¶O P
>
¶¶P Q
DismissKeys
¶¶R ]
=
¶¶^ _
new
ßß 

Dictionary
ßß 
<
ßß 
Key
ßß 
,
ßß 
Func
ßß  
<
ßß  ! 
BottomSheetControl
ßß! 3
,
ßß3 4
bool
ßß5 9
>
ßß9 :
>
ßß: ;
{
®® 	
{
©© 
Key
©© 
.
©© 
Enter
©© 
,
©© 
control
©©  
=>
©©! #
control
©©$ +
.
©©+ ,'
IsDismissableOnScrimClick
©©, E
}
©©F G
,
©©G H
{
™™ 
Key
™™ 
.
™™ 
Escape
™™ 
,
™™ 
control
™™ !
=>
™™" $
control
™™% ,
.
™™, -'
IsDismissableOnScrimClick
™™- F
}
™™G H
,
™™H I
{
´´ 
Key
´´ 
.
´´ 
Space
´´ 
,
´´ 
control
´´  
=>
´´! #
control
´´$ +
.
´´+ ,'
IsDismissableOnScrimClick
´´, E
}
´´F G
}
¨¨ 	
.
¨¨	 
 
ToFrozenDictionary
¨¨
 
(
¨¨ 
)
¨¨ 
;
¨¨ 
private
ÆÆ 
async
ÆÆ 
void
ÆÆ 
	OnKeyDown
ÆÆ  
(
ÆÆ  !
object
ÆÆ! '
?
ÆÆ' (
sender
ÆÆ) /
,
ÆÆ/ 0
KeyEventArgs
ÆÆ1 =
e
ÆÆ> ?
)
ÆÆ? @
{
ØØ 
if
∞∞ 

(
∞∞ 
DismissKeys
∞∞ 
.
∞∞ 
TryGetValue
∞∞ #
(
∞∞# $
e
∞∞$ %
.
∞∞% &
Key
∞∞& )
,
∞∞) *
out
∞∞+ .
Func
∞∞/ 3
<
∞∞3 4 
BottomSheetControl
∞∞4 F
,
∞∞F G
bool
∞∞H L
>
∞∞L M
?
∞∞M N
shouldDismiss
∞∞O \
)
∞∞\ ]
&&
∞∞^ `
shouldDismiss
±± 
(
±± 
this
±± 
)
±± 
&&
±±  "
	ViewModel
≤≤ 
is
≤≤ 
not
≤≤ 
null
≤≤ !
&&
≤≤" $
!
≥≥ 
_isAnimating
≥≥ 
)
≥≥ 
{
¥¥ 	
	ViewModel
µµ 
.
µµ 
	IsVisible
µµ 
=
µµ  !
false
µµ" '
;
µµ' (
await
∑∑ 
Task
∑∑ 
.
∑∑ 
Delay
∑∑ 
(
∑∑ +
BottomSheetAnimationConstants
∑∑ :
.
∑∑: ;#
HideAnimationDuration
∑∑; P
)
∑∑P Q
;
∑∑Q R
	ViewModel
ππ 
.
ππ "
BottomSheetDismissed
ππ *
(
ππ* +
)
ππ+ ,
;
ππ, -
e
∫∫ 
.
∫∫ 
Handled
∫∫ 
=
∫∫ 
true
∫∫ 
;
∫∫ 
}
ªª 	
}
ºº 
}ææ ˘
ò/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/BottomSheetModal/BottomSheetAnimationConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
.' (
BottomSheetModal( 8
;8 9
public 
static 
class )
BottomSheetAnimationConstants 1
{ 
public 

static 
readonly 
TimeSpan #!
ShowAnimationDuration$ 9
=: ;
TimeSpan< D
.D E
FromMillisecondsE U
(U V
$numV Y
)Y Z
;Z [
public 

static 
readonly 
TimeSpan #!
HideAnimationDuration$ 9
=: ;
TimeSpan< D
.D E
FromMillisecondsE U
(U V
$numV Y
)Y Z
;Z [
}		 ’e
ç/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/LanguageSelector/LanguageSelectorViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
LanguageSelector! 1
;1 2
public 
sealed 
class %
LanguageSelectorViewModel -
:. /
ReactiveObject0 >
,> ?!
IActivatableViewModel@ U
,U V
IDisposableW b
{ 
private 
readonly  
ILocalizationService ) 
_localizationService* >
;> ?
private 
readonly -
!IApplicationSecureStorageProvider 6-
!_applicationSecureStorageProvider7 X
;X Y
private 
readonly  
IRpcMetaDataProvider ) 
_rpcMetaDataProvider* >
;> ?
private 
readonly 
CompositeDisposable (
_disposables) 5
=6 7
new8 ;
(; <
)< =
;= >
private 
LanguageItem 
_selectedLanguage *
;* +
private 
bool 
	_disposed 
; 
public 

ViewModelActivator 
	Activator '
{( )
get* -
;- .
}/ 0
=1 2
new3 6
(6 7
)7 8
;8 9
private 
static 
readonly 
AppCultureSettings .
LanguageConfig/ =
=> ?
AppCultureSettings@ R
.R S
DefaultS Z
;Z [
public!! 
 
ObservableCollection!! 
<!!  
LanguageItem!!  ,
>!!, -
AvailableLanguages!!. @
{!!A B
get!!C F
;!!F G
}!!H I
=!!J K
new"" 
("" 
LanguageConfig"" 
."" 
SupportedLanguages"" -
)""- .
;"". /
public$$ 

LanguageItem$$ 
SelectedLanguage$$ (
{%% 
get&& 
=>&& 
_selectedLanguage&&  
;&&  !
set'' 
=>'' 
this'' 
.''  
RaiseAndSetIfChanged'' (
(''( )
ref'') ,
_selectedLanguage''- >
,''> ?
value''@ E
)''E F
;''F G
}(( 
public** 

ReactiveCommand** 
<** 
Unit** 
,**  
Unit**! %
>**% &!
ToggleLanguageCommand**' <
{**= >
get**? B
;**B C
}**D E
public,, 
%
LanguageSelectorViewModel,, $
(,,$ % 
ILocalizationService,,% 9
localizationService,,: M
,,,M N-
!IApplicationSecureStorageProvider-- ),
 applicationSecureStorageProvider--* J
,--J K 
IRpcMetaDataProvider.. 
rpcMetaDataProvider.. 0
)..0 1
{//  
_localizationService00 
=00 
localizationService00 2
;002 3-
!_applicationSecureStorageProvider11 )
=11* +,
 applicationSecureStorageProvider11, L
;11L M 
_rpcMetaDataProvider22 
=22 
rpcMetaDataProvider22 2
;222 3
_selectedLanguage44 
=44 
GetLanguageByCode44 -
(44- . 
_localizationService44. B
.44B C
CurrentCultureName44C U
)44U V
??44W Y
LanguageConfig55 *
.55* +
SupportedLanguages55+ =
.55= >
First55> C
(55C D
)55D E
;55E F
IObservable77 
<77 
string77 
>77 
languageChanges77 +
=77, -$
CreateLanguageObservable77. F
(77F G
)77G H
;77H I!
ToggleLanguageCommand99 
=99 
ReactiveCommand99  /
.99/ 0
Create990 6
(996 7
ToggleLanguage997 E
)99E F
;99F G
_disposables;; 
.;; 
Add;; 
(;; !
ToggleLanguageCommand;; .
);;. /
;;;/ 0!
SetupReactiveBindings== 
(== 
languageChanges== -
)==- .
;==. /
}>> 
private@@ 
static@@ 
LanguageItem@@ 
?@@  
GetLanguageByCode@@! 2
(@@2 3
string@@3 9
cultureCode@@: E
)@@E F
=>@@G I
LanguageConfigAA 
.AA 
GetLanguageByCodeAA (
(AA( )
cultureCodeAA) 4
)AA4 5
.AA5 6

ToNullableAA6 @
(AA@ A
)AAA B
;AAB C
privateCC 
staticCC 
intCC 
GetLanguageIndexCC '
(CC' (
stringCC( .
cultureCodeCC/ :
)CC: ;
=>CC< >
LanguageConfigDD 
.DD 
GetLanguageIndexDD '
(DD' (
cultureCodeDD( 3
)DD3 4
;DD4 5
privateFF 
voidFF 
ToggleLanguageFF 
(FF  
)FF  !
{GG 
intHH 
currentIndexHH 
=HH 
GetLanguageIndexHH +
(HH+ , 
_localizationServiceHH, @
.HH@ A
CurrentCultureNameHHA S
)HHS T
;HHT U
intII 
	nextIndexII 
=II 
(II 
currentIndexII %
+II& '
$numII( )
)II) *
%II+ ,
AvailableLanguagesII- ?
.II? @
CountII@ E
;IIE F 
_localizationServiceJJ 
.JJ 

SetCultureJJ '
(JJ' (
AvailableLanguagesJJ( :
[JJ: ;
	nextIndexJJ; D
]JJD E
.JJE F
CodeJJF J
)JJJ K
;JJK L
}KK 
privateMM 
IObservableMM 
<MM 
stringMM 
>MM $
CreateLanguageObservableMM  8
(MM8 9
)MM9 :
=>MM; =

ObservableNN 
.NN 
CreateNN 
<NN 
stringNN  
>NN  !
(NN! "
observerNN" *
=>NN+ -
{OO  
_localizationServicePP $
.PP$ %
LanguageChangedPP% 4
+=PP5 7
HandlerPP8 ?
;PP? @
observerQQ 
.QQ 
OnNextQQ 
(QQ   
_localizationServiceQQ  4
.QQ4 5
CurrentCultureNameQQ5 G
)QQG H
;QQH I
returnSS 

DisposableSS !
.SS! "
CreateSS" (
(SS( )
(SS) *
)SS* +
=>SS, . 
_localizationServiceSS/ C
.SSC D
LanguageChangedSSD S
-=SST V
HandlerSSW ^
)SS^ _
;SS_ `
voidUU 
HandlerUU 
(UU 
)UU 
=>UU !
observerUU" *
.UU* +
OnNextUU+ 1
(UU1 2 
_localizationServiceUU2 F
.UUF G
CurrentCultureNameUUG Y
)UUY Z
;UUZ [
}VV 
)VV 
.WW  
DistinctUntilChangedWW !
(WW! "
)WW" #
;WW# $
privateYY 
voidYY !
SetupReactiveBindingsYY &
(YY& '
IObservableYY' 2
<YY2 3
stringYY3 9
>YY9 :
languageChangesYY; J
)YYJ K
{ZZ 
this[[ 
.[[ 
WhenActivated[[ 
([[ 
disposables[[ &
=>[[' )
{\\ 	
languageChanges]] 
.^^ 
Select^^ 
(^^ 
culture^^ 
=>^^  "
GetLanguageByCode^^# 4
(^^4 5
culture^^5 <
)^^< =
??^^> @
AvailableLanguages^^A S
[^^S T
$num^^T U
]^^U V
)^^V W
.__ 
BindTo__ 
(__ 
this__ 
,__ 
x__ 
=>__  "
x__# $
.__$ %
SelectedLanguage__% 5
)__5 6
.`` 
DisposeWith`` 
(`` 
disposables`` (
)``( )
;``) *
thisbb 
.bb 
WhenAnyValuebb 
(bb 
xbb 
=>bb  "
xbb# $
.bb$ %
SelectedLanguagebb% 5
)bb5 6
.cc 
Wherecc 
(cc 
itemcc 
=>cc 
itemcc #
.cc# $
Codecc$ (
!=cc) + 
_localizationServicecc, @
.cc@ A
CurrentCultureNameccA S
)ccS T
.dd 
	Subscribedd 
(dd 
itemdd 
=>dd  "
{ee  
_localizationServiceff (
.ff( )

SetCultureff) 3
(ff3 4
itemff4 8
.ff8 9
Codeff9 =
,ff= >
(ff? @
)ff@ A
=>ffB D
HandleCultureChangeffE X
(ffX Y
itemffY ]
.ff] ^
Codeff^ b
)ffb c
)ffc d
;ffd e
}gg 
)gg 
.hh 
DisposeWithhh 
(hh 
disposableshh (
)hh( )
;hh) *
}ii 	
)ii	 

;ii
 
}jj 
privatell 
voidll 
HandleCultureChangell $
(ll$ %
stringll% +
cultureCodell, 7
)ll7 8
{mm 
_nn 	
=nn
 &
PersistCultureSettingAsyncnn &
(nn& '
cultureCodenn' 2
)nn2 3
.nn3 4
ContinueWithnn4 @
(nn@ A
taskoo 
=>oo 
{pp 
ifqq 
(qq 
taskqq 
.qq 
	IsFaultedqq "
&&qq# %
taskqq& *
.qq* +
	Exceptionqq+ 4
!=qq5 7
nullqq8 <
)qq< =
{rr 
Serilogss 
.ss 
Logss 
.ss  
Errorss  %
(ss% &
taskss& *
.ss* +
	Exceptionss+ 4
,ss4 5
$strss6 v
)ssv w
;ssw x
}tt 
}uu 
,uu 
Systemvv 
.vv 
	Threadingvv 
.vv 
Tasksvv "
.vv" #
TaskSchedulervv# 0
.vv0 1
Defaultvv1 8
)vv8 9
;vv9 : 
_rpcMetaDataProviderxx 
.xx 

SetCulturexx '
(xx' (
cultureCodexx( 3
)xx3 4
;xx4 5
}yy 
private{{ 
async{{ 
System{{ 
.{{ 
	Threading{{ "
.{{" #
Tasks{{# (
.{{( )
Task{{) -&
PersistCultureSettingAsync{{. H
({{H I
string{{I O
cultureCode{{P [
){{[ \
{|| 
try}} 
{~~ 	
Result 
< 
	Utilities 
. 
Unit !
,! "%
InternalServiceApiFailure# <
>< =
result> D
=E F
await
ÄÄ /
!_applicationSecureStorageProvider
ÄÄ 7
.
ÅÅ 0
"SetApplicationSettingsCultureAsync
ÅÅ 7
(
ÅÅ7 8
cultureCode
ÅÅ8 C
)
ÅÅC D
.
ÅÅD E
ConfigureAwait
ÅÅE S
(
ÅÅS T
false
ÅÅT Y
)
ÅÅY Z
;
ÅÅZ [
if
ÉÉ 
(
ÉÉ 
result
ÉÉ 
.
ÉÉ 
IsErr
ÉÉ 
)
ÉÉ 
{
ÑÑ 
Serilog
ÖÖ 
.
ÖÖ 
Log
ÖÖ 
.
ÖÖ 
Warning
ÖÖ #
(
ÖÖ# $
$str
ÜÜ o
,
ÜÜo p
cultureCode
áá 
,
áá  
result
áá! '
.
áá' (
	UnwrapErr
áá( 1
(
áá1 2
)
áá2 3
.
áá3 4
Message
áá4 ;
)
áá; <
;
áá< =
}
àà 
}
ââ 	
catch
ää 
(
ää 
	Exception
ää 
ex
ää 
)
ää 
{
ãã 	
Serilog
åå 
.
åå 
Log
åå 
.
åå 
Error
åå 
(
åå 
ex
åå  
,
åå  !
$str
åå" p
,
ååp q
cultureCode
çç 
)
çç 
;
çç 
}
éé 	
}
èè 
public
ëë 

void
ëë 
Dispose
ëë 
(
ëë 
)
ëë 
{
íí 
if
ìì 

(
ìì 
	_disposed
ìì 
)
ìì 
{
îî 	
return
ïï 
;
ïï 
}
ññ 	#
ToggleLanguageCommand
òò 
?
òò 
.
òò 
Dispose
òò &
(
òò& '
)
òò' (
;
òò( )
_disposables
ôô 
.
ôô 
Dispose
ôô 
(
ôô 
)
ôô 
;
ôô 
	_disposed
õõ 
=
õõ 
true
õõ 
;
õõ 
}
úú 
}ùù È
é/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/LanguageSelector/LanguageSelectorView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
LanguageSelector! 1
;1 2
public		 
partial		 
class		  
LanguageSelectorView		 )
:		* +
ReactiveUserControl		, ?
<		? @%
LanguageSelectorViewModel		@ Y
>		Y Z
{

 
public 
 
LanguageSelectorView 
(  
)  !
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
public 
 
LanguageSelectorView 
(   
ILocalizationService  4
localizationService5 H
,H I-
!IApplicationSecureStorageProvider ),
 applicationSecureStorageProvider* J
,J K 
IRpcMetaDataProviderL `
rpcMetaDataProvidera t
)t u
:v w
thisx |
(| }
)} ~
{ 
DataContext 
= 
new %
LanguageSelectorViewModel 3
(3 4
localizationService4 G
,G H,
 applicationSecureStorageProviderI i
,i j
rpcMetaDataProviderk ~
)~ 
;	 Ä
} 
} Ω
Ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/LanguageSelector/LanguageItem.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
LanguageSelector! 1
;1 2
public 
record 
LanguageItem 
( 
string !
Code" &
,& '
string( .
DisplayName/ :
,: ;
string< B
FlagImagePathC P
)P Q
;Q Rê
ê/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/EventArgs/SecureKeyCharactersRemovedEventArgs.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
	EventArgs! *
;* +
public 
class /
#SecureKeyCharactersRemovedEventArgs 0
(0 1
RoutedEvent1 <
routedEvent= H
,H I
intJ M
indexN S
,S T
intU X
countY ^
)^ _
: 
RoutedEventArgs 
( 
routedEvent !
)! "
{ 
public 

int 
Index 
{ 
get 
; 
} 
= 
index  %
;% &
public		 

int		 
Count		 
{		 
get		 
;		 
}		 
=		 
count		  %
;		% &
}

 °
é/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/EventArgs/SecureKeyCharactersAddedEventArgs.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
	EventArgs! *
;* +
public 
class -
!SecureKeyCharactersAddedEventArgs .
(. /
RoutedEvent/ :
routedEvent; F
,F G
intH K
indexL Q
,Q R
stringS Y

charactersZ d
)d e
: 
RoutedEventArgs 
( 
routedEvent !
)! "
{ 
public 

int 
Index 
{ 
get 
; 
} 
= 
index  %
;% &
public		 

string		 

Characters		 
{		 
get		 "
;		" #
}		$ %
=		& '

characters		( 2
;		2 3
}

 ı	
á/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/EventArgs/CharacterRejectedEventArgs.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
	EventArgs! *
;* +
public 
sealed 
class &
CharacterRejectedEventArgs .
(. /
char 
rejectedCharacter	 
,  
CharacterWarningType 
warningType $
,$ %
string		 

input		 
=		 
$str		 
)		 
:

 
RoutedEventArgs

 
{ 
public 

char 
RejectedCharacter !
{" #
get$ '
;' (
}) *
=+ ,
rejectedCharacter- >
;> ?
public 
 
CharacterWarningType 
WarningType  +
{, -
get. 1
;1 2
}3 4
=5 6
warningType7 B
;B C
public 

string 
Input 
{ 
get 
; 
}  
=! "
input# (
;( )
} êÁ
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Core/SegmentedTextBox.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Core! %
;% &
public 
partial 
class 
SegmentedTextBox %
:& '
UserControl( 3
{ 
public 

static 
readonly 
StyledProperty )
<) *
int* -
>- . 
SegmentCountProperty/ C
=D E
AvaloniaProperty 
. 
Register !
<! "
SegmentedTextBox" 2
,2 3
int4 7
>7 8
(8 9
nameof9 ?
(? @
SegmentCount@ L
)L M
,M N%
SegmentedTextBoxConstants %
.% &!
DEFAULT_SEGMENT_COUNT& ;
,; <
validate= E
:E F
valueG L
=>M O
valueP U
>V W
$numX Y
)Y Z
;Z [
public 

static 
readonly 
StyledProperty )
<) *
bool* .
>. /$
AllowOnlyNumbersProperty0 H
=I J
AvaloniaProperty 
. 
Register !
<! "
SegmentedTextBox" 2
,2 3
bool4 8
>8 9
(9 :
nameof: @
(@ A
AllowOnlyNumbersA Q
)Q R
)R S
;S T
public 

static 
readonly 
StyledProperty )
<) *
bool* .
>. //
#IsPointerInteractionEnabledProperty0 S
=T U
AvaloniaProperty 
. 
Register !
<! "
SegmentedTextBox" 2
,2 3
bool4 8
>8 9
(9 :
nameof: @
(@ A'
IsPointerInteractionEnabledA \
)\ ]
,] ^%
SegmentedTextBoxConstants %
.% &*
IS_POINTER_INTERACTION_ENABLED& D
)D E
;E F
public   

static   
readonly   
StyledProperty   )
<  ) *
IBrush  * 0
>  0 1%
SegmentBackgroundProperty  2 K
=  L M
AvaloniaProperty!! 
.!! 
Register!! !
<!!! "
SegmentedTextBox!!" 2
,!!2 3
IBrush!!4 :
>!!: ;
(!!; <
nameof!!< B
(!!B C
SegmentBackground!!C T
)!!T U
,!!U V
Brushes!!W ^
.!!^ _
Transparent!!_ j
)!!j k
;!!k l
public## 

static## 
readonly## 
StyledProperty## )
<##) *
IBrush##* 0
>##0 1,
 ActiveSegmentBorderColorProperty##2 R
=##S T
AvaloniaProperty$$ 
.$$ 
Register$$ !
<$$! "
SegmentedTextBox$$" 2
,$$2 3
IBrush$$4 :
>$$: ;
($$; <
nameof$$< B
($$B C$
ActiveSegmentBorderColor$$C [
)$$[ \
,$$\ ]
Brushes$$^ e
.$$e f
Blue$$f j
)$$j k
;$$k l
public&& 

static&& 
readonly&& 
StyledProperty&& )
<&&) *
string&&* 0
>&&0 1
ValueProperty&&2 ?
=&&@ A
AvaloniaProperty'' 
.'' 
Register'' !
<''! "
SegmentedTextBox''" 2
,''2 3
string''4 :
>'': ;
(''; <
nameof''< B
(''B C
Value''C H
)''H I
,''I J
$str''K M
,''M N
defaultBindingMode(( 
:(( 
Avalonia((  (
.((( )
Data(() -
.((- .
BindingMode((. 9
.((9 :
TwoWay((: @
)((@ A
;((A B
public** 

static** 
readonly** 
StyledProperty** )
<**) *
bool*** .
>**. /
IsCompleteProperty**0 B
=**C D
AvaloniaProperty++ 
.++ 
Register++ !
<++! "
SegmentedTextBox++" 2
,++2 3
bool++4 8
>++8 9
(++9 :
nameof++: @
(++@ A

IsComplete++A K
)++K L
,++L M
defaultBindingMode,, 
:,, 
Avalonia,,  (
.,,( )
Data,,) -
.,,- .
BindingMode,,. 9
.,,9 :
OneWayToSource,,: H
),,H I
;,,I J
public.. 

static.. 
readonly.. 
StyledProperty.. )
<..) *
double..* 0
>..0 1"
SegmentSpacingProperty..2 H
=..I J
AvaloniaProperty// 
.// 
Register// !
<//! "
SegmentedTextBox//" 2
,//2 3
double//4 :
>//: ;
(//; <
nameof//< B
(//B C
SegmentSpacing//C Q
)//Q R
,//R S%
SegmentedTextBoxConstants00 %
.00% &#
DEFAULT_SEGMENT_SPACING00& =
)00= >
;00> ?
public22 

static22 
readonly22 
StyledProperty22 )
<22) *
double22* 0
>220 1 
SegmentWidthProperty222 F
=22G H
AvaloniaProperty33 
.33 
Register33 !
<33! "
SegmentedTextBox33" 2
,332 3
double334 :
>33: ;
(33; <
nameof33< B
(33B C
SegmentWidth33C O
)33O P
,33P Q%
SegmentedTextBoxConstants44 %
.44% &!
DEFAULT_SEGMENT_WIDTH44& ;
)44; <
;44< =
public66 

static66 
readonly66 
StyledProperty66 )
<66) *
int66* -
>66- . 
BaseTabIndexProperty66/ C
=66D E
AvaloniaProperty77 
.77 
Register77 !
<77! "
SegmentedTextBox77" 2
,772 3
int774 7
>777 8
(778 9
nameof779 ?
(77? @
BaseTabIndex77@ L
)77L M
,77M N
int77O R
.77R S
MaxValue77S [
)77[ \
;77\ ]
private99 
static99 
readonly99 
string99 "
[99" #
]99# $
DigitStrings99% 1
=992 3
new994 7
string998 >
[99> ?
$num99? A
]99A B
;99B C
private;; 
readonly;; 
List;; 
<;; 
TextBox;; !
>;;! "
	_segments;;# ,
=;;- .
[;;/ 0
];;0 1
;;;1 2
private== 
int== 
_currentActiveIndex== #
;==# $
private>> 
bool>> 
_isInternalUpdate>> "
;>>" #
static@@ 

SegmentedTextBox@@ 
(@@ 
)@@ 
{AA 
forBB 
(BB 
intBB 
iBB 
=BB 
$numBB 
;BB 
iBB 
<BB 
$numBB 
;BB 
iBB  !
++BB! #
)BB# $
{CC 	
DigitStringsDD 
[DD 
iDD 
]DD 
=DD 
iDD 
.DD  
ToStringDD  (
(DD( )
)DD) *
;DD* +
}EE 	
}FF 
publicHH 

SegmentedTextBoxHH 
(HH 
)HH 
{II 
InitializeComponentJJ 
(JJ 
)JJ 
;JJ 
}KK 
publicMM 

intMM 
BaseTabIndexMM 
{NN 
getOO 
=>OO 
GetValueOO 
(OO  
BaseTabIndexPropertyOO ,
)OO, -
;OO- .
setPP 
=>PP 
SetValuePP 
(PP  
BaseTabIndexPropertyPP ,
,PP, -
valuePP. 3
)PP3 4
;PP4 5
}QQ 
publicSS 

doubleSS 
SegmentSpacingSS  
{TT 
getUU 
=>UU 
GetValueUU 
(UU "
SegmentSpacingPropertyUU .
)UU. /
;UU/ 0
setVV 
=>VV 
SetValueVV 
(VV "
SegmentSpacingPropertyVV .
,VV. /
valueVV0 5
)VV5 6
;VV6 7
}WW 
publicYY 

doubleYY 
SegmentWidthYY 
{ZZ 
get[[ 
=>[[ 
GetValue[[ 
([[  
SegmentWidthProperty[[ ,
)[[, -
;[[- .
set\\ 
=>\\ 
SetValue\\ 
(\\  
SegmentWidthProperty\\ ,
,\\, -
value\\. 3
)\\3 4
;\\4 5
}]] 
public__ 

string__ 
Value__ 
{`` 
getaa 
=>aa 
GetValueaa 
(aa 
ValuePropertyaa %
)aa% &
;aa& '
setbb 
=>bb 
SetValuebb 
(bb 
ValuePropertybb %
,bb% &
valuebb' ,
)bb, -
;bb- .
}cc 
publicee 

IBrushee 
SegmentBackgroundee #
{ff 
getgg 
=>gg 
GetValuegg 
(gg %
SegmentBackgroundPropertygg 1
)gg1 2
;gg2 3
sethh 
=>hh 
SetValuehh 
(hh %
SegmentBackgroundPropertyhh 1
,hh1 2
valuehh3 8
)hh8 9
;hh9 :
}ii 
publickk 

IBrushkk $
ActiveSegmentBorderColorkk *
{ll 
getmm 
=>mm 
GetValuemm 
(mm ,
 ActiveSegmentBorderColorPropertymm 8
)mm8 9
;mm9 :
setnn 
=>nn 
SetValuenn 
(nn ,
 ActiveSegmentBorderColorPropertynn 8
,nn8 9
valuenn: ?
)nn? @
;nn@ A
}oo 
publicqq 

intqq 
SegmentCountqq 
{rr 
getss 
=>ss 
GetValuess 
(ss  
SegmentCountPropertyss ,
)ss, -
;ss- .
settt 
=>tt 
SetValuett 
(tt  
SegmentCountPropertytt ,
,tt, -
valuett. 3
)tt3 4
;tt4 5
}uu 
publicww 

boolww 
AllowOnlyNumbersww  
{xx 
getyy 
=>yy 
GetValueyy 
(yy $
AllowOnlyNumbersPropertyyy 0
)yy0 1
;yy1 2
setzz 
=>zz 
SetValuezz 
(zz $
AllowOnlyNumbersPropertyzz 0
,zz0 1
valuezz2 7
)zz7 8
;zz8 9
}{{ 
public}} 

bool}} '
IsPointerInteractionEnabled}} +
{~~ 
get 
=> 
GetValue 
( /
#IsPointerInteractionEnabledProperty ;
); <
;< =
set
ÄÄ 
=>
ÄÄ 
SetValue
ÄÄ 
(
ÄÄ 1
#IsPointerInteractionEnabledProperty
ÄÄ ;
,
ÄÄ; <
value
ÄÄ= B
)
ÄÄB C
;
ÄÄC D
}
ÅÅ 
public
ÉÉ 

bool
ÉÉ 

IsComplete
ÉÉ 
{
ÑÑ 
get
ÖÖ 
=>
ÖÖ 
GetValue
ÖÖ 
(
ÖÖ  
IsCompleteProperty
ÖÖ *
)
ÖÖ* +
;
ÖÖ+ ,
private
ÜÜ 
set
ÜÜ 
=>
ÜÜ 
SetValue
ÜÜ 
(
ÜÜ   
IsCompleteProperty
ÜÜ  2
,
ÜÜ2 3
value
ÜÜ4 9
)
ÜÜ9 :
;
ÜÜ: ;
}
áá 
public
ââ 

void
ââ 
ClearAllSegments
ââ  
(
ââ  !
)
ââ! "
{
ää 
foreach
ãã 
(
ãã 
TextBox
ãã 
segment
ãã  
in
ãã! #
	_segments
ãã$ -
)
ãã- .
{
åå 	
segment
çç 
.
çç 
Text
çç 
=
çç 
string
çç !
.
çç! "
Empty
çç" '
;
çç' (
}
éé 	
SetActiveSegment
êê 
(
êê 
$num
êê 
)
êê 
;
êê 
OnSegmentChanged
ëë 
(
ëë 
)
ëë 
;
ëë 
}
íí 
	protected
îî 
override
îî 
void
îî %
OnAttachedToLogicalTree
îî 3
(
îî3 4,
LogicalTreeAttachmentEventArgs
îî4 R
e
îîS T
)
îîT U
{
ïï 
base
ññ 
.
ññ %
OnAttachedToLogicalTree
ññ $
(
ññ$ %
e
ññ% &
)
ññ& '
;
ññ' (
BuildSegments
óó 
(
óó 
)
óó 
;
óó 
}
òò 
	protected
öö 
override
öö 
void
öö '
OnDetachedFromLogicalTree
öö 5
(
öö5 6,
LogicalTreeAttachmentEventArgs
öö6 T
e
ööU V
)
ööV W
{
õõ 
base
úú 
.
úú '
OnDetachedFromLogicalTree
úú &
(
úú& '
e
úú' (
)
úú( )
;
úú) *
CleanupSegments
ùù 
(
ùù 
)
ùù 
;
ùù 
}
ûû 
	protected
†† 
override
†† 
void
†† 
OnPropertyChanged
†† -
(
††- ..
 AvaloniaPropertyChangedEventArgs
††. N
change
††O U
)
††U V
{
°° 
base
¢¢ 
.
¢¢ 
OnPropertyChanged
¢¢ 
(
¢¢ 
change
¢¢ %
)
¢¢% &
;
¢¢& '
if
§§ 

(
§§ 
change
§§ 
.
§§ 
Property
§§ 
==
§§ "
SegmentCountProperty
§§ 3
)
§§3 4
{
•• 	
BuildSegments
¶¶ 
(
¶¶ 
)
¶¶ 
;
¶¶ 
}
ßß 	
if
©© 

(
©© 
change
©© 
.
©© 
Property
©© 
==
©© 
ValueProperty
©© ,
&&
©©- /
!
©©0 1
_isInternalUpdate
©©1 B
)
©©B C
{
™™ 	
string
´´ 
newValue
´´ 
=
´´ 
change
´´ $
.
´´$ %
NewValue
´´% -
as
´´. 0
string
´´1 7
??
´´8 :
string
´´; A
.
´´A B
Empty
´´B G
;
´´G H
if
≠≠ 
(
≠≠ 
string
≠≠ 
.
≠≠ 
IsNullOrEmpty
≠≠ $
(
≠≠$ %
newValue
≠≠% -
)
≠≠- .
)
≠≠. /
{
ÆÆ 
ClearAllSegments
ØØ  
(
ØØ  !
)
ØØ! "
;
ØØ" #
}
∞∞ 
else
±± 
{
≤≤ %
UpdateSegmentsFromValue
≥≥ '
(
≥≥' (
newValue
≥≥( 0
)
≥≥0 1
;
≥≥1 2
}
¥¥ 
}
µµ 	
}
∂∂ 
private
∏∏ 
static
∏∏ 
string
∏∏ "
ValidateNumericInput
∏∏ .
(
∏∏. /
string
∏∏/ 5
input
∏∏6 ;
)
∏∏; <
{
ππ 
if
∫∫ 

(
∫∫ 
string
∫∫ 
.
∫∫ 
IsNullOrEmpty
∫∫  
(
∫∫  !
input
∫∫! &
)
∫∫& '
)
∫∫' (
{
ªª 	
return
ºº 
input
ºº 
;
ºº 
}
ΩΩ 	
char
øø 

firstDigit
øø 
=
øø 
input
øø 
.
øø  
FirstOrDefault
øø  .
(
øø. /
char
øø/ 3
.
øø3 4
IsDigit
øø4 ;
)
øø; <
;
øø< =
if
¿¿ 

(
¿¿ 

firstDigit
¿¿ 
==
¿¿ 
$num
¿¿ 
)
¿¿ 
{
¡¡ 	
return
¬¬ 
$str
¬¬ 
;
¬¬ 
}
√√ 	
int
≈≈ 

digitValue
≈≈ 
=
≈≈ 

firstDigit
≈≈ #
-
≈≈$ %
$char
≈≈& )
;
≈≈) *
return
∆∆ 

digitValue
∆∆ 
is
∆∆ 
>=
∆∆ 
$num
∆∆  !
and
∆∆" %
<=
∆∆& (
$num
∆∆) *
?
∆∆+ ,
DigitStrings
∆∆- 9
[
∆∆9 :

digitValue
∆∆: D
]
∆∆D E
:
∆∆F G

firstDigit
∆∆H R
.
∆∆R S
ToString
∆∆S [
(
∆∆[ \
)
∆∆\ ]
;
∆∆] ^
}
«« 
private
…… 
void
…… %
UpdateSegmentsFromValue
…… (
(
……( )
string
……) /
newValue
……0 8
)
……8 9
{
   
_isInternalUpdate
ÀÀ 
=
ÀÀ 
true
ÀÀ  
;
ÀÀ  !
try
ÃÃ 
{
ÕÕ 	
foreach
ŒŒ 
(
ŒŒ 
TextBox
ŒŒ 
segment
ŒŒ $
in
ŒŒ% '
	_segments
ŒŒ( 1
)
ŒŒ1 2
{
œœ 
segment
–– 
.
–– 
Text
–– 
=
–– 
string
–– %
.
––% &
Empty
––& +
;
––+ ,
}
—— 
for
”” 
(
”” 
int
”” 
i
”” 
=
”” 
$num
”” 
;
”” 
i
”” 
<
”” 
	_segments
””  )
.
””) *
Count
””* /
;
””/ 0
i
””1 2
++
””2 4
)
””4 5
{
‘‘ 
if
’’ 
(
’’ 
i
’’ 
>=
’’ 
newValue
’’ !
.
’’! "
Length
’’" (
)
’’( )
{
÷÷ 
break
◊◊ 
;
◊◊ 
}
ÿÿ 
	_segments
⁄⁄ 
[
⁄⁄ 
i
⁄⁄ 
]
⁄⁄ 
.
⁄⁄ 
Text
⁄⁄ !
=
⁄⁄" #
newValue
⁄⁄$ ,
[
⁄⁄, -
i
⁄⁄- .
]
⁄⁄. /
.
⁄⁄/ 0
ToString
⁄⁄0 8
(
⁄⁄8 9
)
⁄⁄9 :
;
⁄⁄: ;
}
€€ 
int
›› 
	nextIndex
›› 
=
›› 
Math
››  
.
››  !
Min
››! $
(
››$ %
newValue
››% -
.
››- .
Length
››. 4
,
››4 5
	_segments
››6 ?
.
››? @
Count
››@ E
-
››F G
$num
››H I
)
››I J
;
››J K
SetActiveSegment
ﬁﬁ 
(
ﬁﬁ 
	nextIndex
ﬁﬁ &
)
ﬁﬁ& '
;
ﬁﬁ' (
}
ﬂﬂ 	
finally
‡‡ 
{
·· 	
_isInternalUpdate
‚‚ 
=
‚‚ 
false
‚‚  %
;
‚‚% &
}
„„ 	
}
‰‰ 
private
ÊÊ 
string
ÊÊ "
GetConcatenatedValue
ÊÊ '
(
ÊÊ' (
)
ÊÊ( )
{
ÁÁ 
return
ËË 
string
ËË 
.
ËË 
Concat
ËË 
(
ËË 
	_segments
ËË &
.
ËË& '
Select
ËË' -
(
ËË- .
tb
ËË. 0
=>
ËË1 3
tb
ËË4 6
.
ËË6 7
Text
ËË7 ;
??
ËË< >
$str
ËË? A
)
ËËA B
)
ËËB C
;
ËËC D
}
ÈÈ 
private
ÎÎ 
void
ÎÎ 
ProcessTextInput
ÎÎ !
(
ÎÎ! "
TextBox
ÎÎ" )
textBox
ÎÎ* 1
)
ÎÎ1 2
{
ÏÏ 
if
ÌÌ 

(
ÌÌ 
AllowOnlyNumbers
ÌÌ 
)
ÌÌ 
{
ÓÓ 	
string
ÔÔ 
	inputText
ÔÔ 
=
ÔÔ 
textBox
ÔÔ &
.
ÔÔ& '
Text
ÔÔ' +
??
ÔÔ, .
string
ÔÔ/ 5
.
ÔÔ5 6
Empty
ÔÔ6 ;
;
ÔÔ; <
string
 
	validText
 
=
 "
ValidateNumericInput
 3
(
3 4
	inputText
4 =
)
= >
;
> ?
if
ÒÒ 
(
ÒÒ 
	inputText
ÒÒ 
!=
ÒÒ 
	validText
ÒÒ &
)
ÒÒ& '
{
ÚÚ 
UpdateTextBoxText
ÛÛ !
(
ÛÛ! "
textBox
ÛÛ" )
,
ÛÛ) *
	validText
ÛÛ+ 4
)
ÛÛ4 5
;
ÛÛ5 6
}
ÙÙ 
}
ıı 	
if
˜˜ 

(
˜˜ 
textBox
˜˜ 
.
˜˜ 
Text
˜˜ 
?
˜˜ 
.
˜˜ 
Length
˜˜  
==
˜˜! #
$num
˜˜$ %
&&
˜˜& (
!
˜˜) *
_isInternalUpdate
˜˜* ;
)
˜˜; <
{
¯¯ 	
MoveToNextSegment
˘˘ 
(
˘˘ 
)
˘˘ 
;
˘˘  
}
˙˙ 	
}
˚˚ 
private
˝˝ 
static
˝˝ 
void
˝˝ 
UpdateTextBoxText
˝˝ )
(
˝˝) *
TextBox
˝˝* 1
textBox
˝˝2 9
,
˝˝9 :
string
˝˝; A
newText
˝˝B I
)
˝˝I J
{
˛˛ 
int
ˇˇ 
selectionStart
ˇˇ 
=
ˇˇ 
textBox
ˇˇ $
.
ˇˇ$ %
SelectionStart
ˇˇ% 3
;
ˇˇ3 4
textBox
ÄÄ 
.
ÄÄ 
Text
ÄÄ 
=
ÄÄ 
newText
ÄÄ 
;
ÄÄ 
textBox
ÅÅ 
.
ÅÅ 
SelectionStart
ÅÅ 
=
ÅÅ  
Math
ÅÅ! %
.
ÅÅ% &
Min
ÅÅ& )
(
ÅÅ) *
selectionStart
ÅÅ* 8
,
ÅÅ8 9
newText
ÅÅ: A
.
ÅÅA B
Length
ÅÅB H
)
ÅÅH I
;
ÅÅI J
textBox
ÇÇ 
.
ÇÇ 
SelectionEnd
ÇÇ 
=
ÇÇ 
textBox
ÇÇ &
.
ÇÇ& '
SelectionStart
ÇÇ' 5
;
ÇÇ5 6
}
ÉÉ 
private
ÖÖ 
void
ÖÖ 
BuildSegments
ÖÖ 
(
ÖÖ 
)
ÖÖ  
{
ÜÜ 

StackPanel
áá 
?
áá 
segmentsPanel
áá !
=
áá" #
this
áá$ (
.
áá( )
FindControl
áá) 4
<
áá4 5

StackPanel
áá5 ?
>
áá? @
(
áá@ A
$str
ááA P
)
ááP Q
;
ááQ R
if
àà 

(
àà 
segmentsPanel
àà 
==
àà 
null
àà !
)
àà! "
{
ââ 	
return
ää 
;
ää 
}
ãã 	
	_segments
çç 
.
çç 
Clear
çç 
(
çç 
)
çç 
;
çç 
segmentsPanel
éé 
.
éé 
Children
éé 
.
éé 
Clear
éé $
(
éé$ %
)
éé% &
;
éé& '
segmentsPanel
èè 
.
èè 
Spacing
èè 
=
èè 
SegmentSpacing
èè  .
;
èè. /!
_currentActiveIndex
êê 
=
êê 
$num
êê 
;
êê  
for
íí 
(
íí 
int
íí 
i
íí 
=
íí 
$num
íí 
;
íí 
i
íí 
<
íí 
SegmentCount
íí (
;
íí( )
i
íí* +
++
íí+ -
)
íí- .
{
ìì 	
TextBox
îî 
tb
îî 
=
îî 
new
îî 
(
îî 
)
îî 
{
ïï 
TabIndex
ññ 
=
ññ 
i
ññ 
==
ññ 
$num
ññ  !
?
ññ" #
$num
ññ$ %
:
ññ& '
-
ññ( )
$num
ññ) *
,
ññ* +
Classes
óó 
=
óó 
{
óó '
SegmentedTextBoxConstants
óó 5
.
óó5 6!
SEGMENT_STYLE_CLASS
óó6 I
}
óóJ K
,
óóK L
Width
òò 
=
òò 
SegmentWidth
òò $
,
òò$ %
}
ôô 
;
ôô 
tb
õõ 
.
õõ 

AddHandler
õõ 
(
õõ 
KeyDownEvent
õõ &
,
õõ& '
Segment_KeyDown
õõ( 7
,
õõ7 8
RoutingStrategies
õõ9 J
.
õõJ K
Tunnel
õõK Q
)
õõQ R
;
õõR S
tb
úú 
.
úú 
TextChanged
úú 
+=
úú !
Segment_TextChanged
úú 1
;
úú1 2
tb
ùù 
.
ùù 
	LostFocus
ùù 
+=
ùù 
Segment_LostFocus
ùù -
;
ùù- .
tb
ûû 
.
ûû 
GotFocus
ûû 
+=
ûû 
Segment_GotFocus
ûû +
;
ûû+ ,
	_segments
üü 
.
üü 
Add
üü 
(
üü 
tb
üü 
)
üü 
;
üü 
segmentsPanel
†† 
.
†† 
Children
†† "
.
††" #
Add
††# &
(
††& '
tb
††' )
)
††) *
;
††* +
}
°° 	
UpdateTabIndexes
££ 
(
££ 
)
££ 
;
££ 
}
§§ 
private
¶¶ 
void
¶¶ 
CleanupSegments
¶¶  
(
¶¶  !
)
¶¶! "
{
ßß 
foreach
®® 
(
®® 
TextBox
®® 
segment
®®  
in
®®! #
	_segments
®®$ -
)
®®- .
{
©© 	&
UnsubscribeSegmentEvents
™™ $
(
™™$ %
segment
™™% ,
)
™™, -
;
™™- .
}
´´ 	
	_segments
≠≠ 
.
≠≠ 
Clear
≠≠ 
(
≠≠ 
)
≠≠ 
;
≠≠ 
}
ÆÆ 
private
∞∞ 
void
∞∞ &
UnsubscribeSegmentEvents
∞∞ )
(
∞∞) *
TextBox
∞∞* 1
textBox
∞∞2 9
)
∞∞9 :
{
±± 
textBox
≤≤ 
.
≤≤ 
RemoveHandler
≤≤ 
(
≤≤ 
KeyDownEvent
≤≤ *
,
≤≤* +
Segment_KeyDown
≤≤, ;
)
≤≤; <
;
≤≤< =
textBox
≥≥ 
.
≥≥ 
TextChanged
≥≥ 
-=
≥≥ !
Segment_TextChanged
≥≥ 2
;
≥≥2 3
textBox
¥¥ 
.
¥¥ 
	LostFocus
¥¥ 
-=
¥¥ 
Segment_LostFocus
¥¥ .
;
¥¥. /
textBox
µµ 
.
µµ 
GotFocus
µµ 
-=
µµ 
Segment_GotFocus
µµ ,
;
µµ, -
}
∂∂ 
private
∏∏ 
void
∏∏ 
Segment_GotFocus
∏∏ !
(
∏∏! "
object
∏∏" (
?
∏∏( )
sender
∏∏* 0
,
∏∏0 1
RoutedEventArgs
∏∏2 A
e
∏∏B C
)
∏∏C D
{
ππ 
if
∫∫ 

(
∫∫ 
sender
∫∫ 
is
∫∫ 
TextBox
∫∫ 
tb
∫∫  
)
∫∫  !
{
ªª 	
int
ºº 
index
ºº 
=
ºº 
	_segments
ºº !
.
ºº! "
IndexOf
ºº" )
(
ºº) *
tb
ºº* ,
)
ºº, -
;
ºº- .
if
ΩΩ 
(
ΩΩ 
index
ΩΩ 
>=
ΩΩ 
$num
ΩΩ 
)
ΩΩ 
{
ææ !
_currentActiveIndex
øø #
=
øø$ %
index
øø& +
;
øø+ ,!
UpdateActiveSegment
¿¿ #
(
¿¿# $
)
¿¿$ %
;
¿¿% &
}
¡¡ 
}
¬¬ 	
}
√√ 
private
≈≈ 
void
≈≈ 
Segment_LostFocus
≈≈ "
(
≈≈" #
object
≈≈# )
?
≈≈) *
sender
≈≈+ 1
,
≈≈1 2
RoutedEventArgs
≈≈3 B
e
≈≈C D
)
≈≈D E
{
∆∆ 
HandleFocusChange
«« 
(
«« 
)
«« 
;
«« 
}
»» 
private
   
void
   
HandleFocusChange
   "
(
  " #
)
  # $
{
ÀÀ 

Dispatcher
ÃÃ 
.
ÃÃ 
UIThread
ÃÃ 
.
ÃÃ 
Post
ÃÃ  
(
ÃÃ  !
(
ÃÃ! "
)
ÃÃ" #
=>
ÃÃ$ &
{
ÕÕ 	
if
ŒŒ 
(
ŒŒ 
!
ŒŒ 
	_segments
ŒŒ 
.
ŒŒ 
Any
ŒŒ 
(
ŒŒ 
segment
ŒŒ &
=>
ŒŒ' )
segment
ŒŒ* 1
.
ŒŒ1 2
	IsFocused
ŒŒ2 ;
)
ŒŒ; <
)
ŒŒ< =
{
œœ  
ClearActiveSegment
–– "
(
––" #
)
––# $
;
––$ %
}
—— 
}
““ 	
)
““	 

;
““
 
}
”” 
private
’’ 
void
’’  
ClearActiveSegment
’’ #
(
’’# $
)
’’$ %
{
÷÷ 
foreach
◊◊ 
(
◊◊ 
TextBox
◊◊ 
tb
◊◊ 
in
◊◊ 
	_segments
◊◊ (
)
◊◊( )
{
ÿÿ 	
tb
ŸŸ 
.
ŸŸ 
Classes
ŸŸ 
.
ŸŸ 
Remove
ŸŸ 
(
ŸŸ '
SegmentedTextBoxConstants
ŸŸ 7
.
ŸŸ7 8 
ACTIVE_STYLE_CLASS
ŸŸ8 J
)
ŸŸJ K
;
ŸŸK L
}
⁄⁄ 	
}
€€ 
private
›› 
void
›› -
OverlayRectangle_PointerPressed
›› 0
(
››0 1
object
››1 7
?
››7 8
sender
››9 ?
,
››? @%
PointerPressedEventArgs
››A X
e
››Y Z
)
››Z [
{
ﬁﬁ 
if
ﬂﬂ 

(
ﬂﬂ !
_currentActiveIndex
ﬂﬂ 
>=
ﬂﬂ  "
$num
ﬂﬂ# $
&&
ﬂﬂ% '!
_currentActiveIndex
ﬂﬂ( ;
<
ﬂﬂ< =
	_segments
ﬂﬂ> G
.
ﬂﬂG H
Count
ﬂﬂH M
)
ﬂﬂM N
{
‡‡ 	
	_segments
·· 
[
·· !
_currentActiveIndex
·· )
]
··) *
.
··* +
Focus
··+ 0
(
··0 1
)
··1 2
;
··2 3
}
‚‚ 	
e
‰‰ 	
.
‰‰	 

Handled
‰‰
 
=
‰‰ 
true
‰‰ 
;
‰‰ 
}
ÂÂ 
private
ÁÁ 
void
ÁÁ %
OverlayRectangle_Tapped
ÁÁ (
(
ÁÁ( )
object
ÁÁ) /
?
ÁÁ/ 0
sender
ÁÁ1 7
,
ÁÁ7 8
TappedEventArgs
ÁÁ9 H
e
ÁÁI J
)
ÁÁJ K
{
ËË 
if
ÈÈ 

(
ÈÈ !
_currentActiveIndex
ÈÈ 
>=
ÈÈ  "
$num
ÈÈ# $
&&
ÈÈ% '!
_currentActiveIndex
ÈÈ( ;
<
ÈÈ< =
	_segments
ÈÈ> G
.
ÈÈG H
Count
ÈÈH M
)
ÈÈM N
{
ÍÍ 	
	_segments
ÎÎ 
[
ÎÎ !
_currentActiveIndex
ÎÎ )
]
ÎÎ) *
.
ÎÎ* +
Focus
ÎÎ+ 0
(
ÎÎ0 1
)
ÎÎ1 2
;
ÎÎ2 3
}
ÏÏ 	
e
ÓÓ 	
.
ÓÓ	 

Handled
ÓÓ
 
=
ÓÓ 
true
ÓÓ 
;
ÓÓ 
}
ÔÔ 
private
ÒÒ 
void
ÒÒ !
Segment_TextChanged
ÒÒ $
(
ÒÒ$ %
object
ÒÒ% +
?
ÒÒ+ ,
sender
ÒÒ- 3
,
ÒÒ3 4"
TextChangedEventArgs
ÒÒ5 I
e
ÒÒJ K
)
ÒÒK L
{
ÚÚ 
if
ÛÛ 

(
ÛÛ 
sender
ÛÛ 
is
ÛÛ 
not
ÛÛ 
TextBox
ÛÛ !
tb
ÛÛ" $
)
ÛÛ$ %
{
ÙÙ 	
return
ıı 
;
ıı 
}
ˆˆ 	
ProcessTextInput
¯¯ 
(
¯¯ 
tb
¯¯ 
)
¯¯ 
;
¯¯ 
OnSegmentChanged
˘˘ 
(
˘˘ 
)
˘˘ 
;
˘˘ 
}
˙˙ 
private
¸¸ 
void
¸¸ 
Segment_KeyDown
¸¸  
(
¸¸  !
object
¸¸! '
?
¸¸' (
sender
¸¸) /
,
¸¸/ 0
KeyEventArgs
¸¸1 =
e
¸¸> ?
)
¸¸? @
{
˝˝ 
if
˛˛ 

(
˛˛ 
sender
˛˛ 
is
˛˛ 
not
˛˛ 
TextBox
˛˛ !
tb
˛˛" $
)
˛˛$ %
{
ˇˇ 	
return
ÄÄ 
;
ÄÄ 
}
ÅÅ 	
int
ÉÉ 
index
ÉÉ 
=
ÉÉ 
	_segments
ÉÉ 
.
ÉÉ 
IndexOf
ÉÉ %
(
ÉÉ% &
tb
ÉÉ& (
)
ÉÉ( )
;
ÉÉ) *
if
ÖÖ 

(
ÖÖ 
e
ÖÖ 
is
ÖÖ 
{
ÖÖ 
Key
ÖÖ 
:
ÖÖ 
Key
ÖÖ 
.
ÖÖ 
V
ÖÖ 
,
ÖÖ 
KeyModifiers
ÖÖ +
:
ÖÖ+ ,
KeyModifiers
ÖÖ- 9
.
ÖÖ9 :
Control
ÖÖ: A
}
ÖÖB C
)
ÖÖC D
{
ÜÜ 	
HandlePasteAsync
áá 
(
áá 
)
áá 
.
áá 
ContinueWith
áá +
(
áá+ ,
task
àà 
=>
àà 
{
ââ 
if
ää 
(
ää 
task
ää 
is
ää 
{
ää  !
	IsFaulted
ää" +
:
ää+ ,
true
ää- 1
,
ää1 2
	Exception
ää3 <
:
ää< =
not
ää> A
null
ääB F
}
ääG H
)
ääH I
{
ãã 
Log
åå 
.
åå 
Error
åå !
(
åå! "
task
åå" &
.
åå& '
	Exception
åå' 0
,
åå0 1
$str
åå2 r
)
åår s
;
åås t
}
çç 
}
éé 
,
éé 
TaskScheduler
èè 
.
èè 
Default
èè %
)
èè% &
;
èè& '
e
êê 
.
êê 
Handled
êê 
=
êê 
true
êê 
;
êê 
return
ëë 
;
ëë 
}
íí 	
switch
îî 
(
îî 
e
îî 
.
îî 
Key
îî 
)
îî 
{
ïï 	
case
ññ 
Key
ññ 
.
ññ 
Back
ññ 
:
ññ  
HandleBackspaceKey
óó "
(
óó" #
index
óó# (
)
óó( )
;
óó) *
e
òò 
.
òò 
Handled
òò 
=
òò 
true
òò  
;
òò  !
OnSegmentChanged
ôô  
(
ôô  !
)
ôô! "
;
ôô" #
return
öö 
;
öö 
case
õõ 
Key
õõ 
.
õõ 
Right
õõ 
or
õõ 
Key
õõ !
.
õõ! "
Left
õõ" &
:
õõ& '
e
úú 
.
úú 
Handled
úú 
=
úú 
true
úú  
;
úú  !
return
ùù 
;
ùù 
case
ûû 
Key
ûû 
.
ûû 
Tab
ûû 
:
ûû 
return
üü 
;
üü 
}
†† 	
if
¢¢ 

(
¢¢ 
!
¢¢ )
IsPointerInteractionEnabled
¢¢ (
&&
¢¢) +
index
¢¢, 1
!=
¢¢2 4!
_currentActiveIndex
¢¢5 H
)
¢¢H I
{
££ 	
e
§§ 
.
§§ 
Handled
§§ 
=
§§ 
true
§§ 
;
§§ 
return
•• 
;
•• 
}
¶¶ 	
OnSegmentChanged
®® 
(
®® 
)
®® 
;
®® 
}
©© 
private
´´ 
async
´´ 
Task
´´ 
HandlePasteAsync
´´ '
(
´´' (
)
´´( )
{
¨¨ 
try
≠≠ 
{
ÆÆ 	

IClipboard
ØØ 
?
ØØ 
	clipboard
ØØ !
=
ØØ" #
TopLevel
ØØ$ ,
.
ØØ, -
GetTopLevel
ØØ- 8
(
ØØ8 9
this
ØØ9 =
)
ØØ= >
?
ØØ> ?
.
ØØ? @
	Clipboard
ØØ@ I
;
ØØI J
if
∞∞ 
(
∞∞ 
	clipboard
∞∞ 
==
∞∞ 
null
∞∞ !
)
∞∞! "
{
±± 
return
≤≤ 
;
≤≤ 
}
≥≥ 
string
µµ 
?
µµ 
clipboardText
µµ !
=
µµ" #
await
µµ$ )
	clipboard
µµ* 3
.
µµ3 4
TryGetTextAsync
µµ4 C
(
µµC D
)
µµD E
;
µµE F
if
∂∂ 
(
∂∂ 
string
∂∂ 
.
∂∂ 
IsNullOrEmpty
∂∂ $
(
∂∂$ %
clipboardText
∂∂% 2
)
∂∂2 3
)
∂∂3 4
{
∑∑ 
return
∏∏ 
;
∏∏ 
}
ππ 
ProcessPastedText
ªª 
(
ªª 
clipboardText
ªª +
)
ªª+ ,
;
ªª, -
}
ºº 	
catch
ΩΩ 
(
ΩΩ 
	Exception
ΩΩ 
ex
ΩΩ 
)
ΩΩ 
{
ææ 	
Log
øø 
.
øø 
Warning
øø 
(
øø 
ex
øø 
,
øø 
$str
øø D
)
øøD E
;
øøE F
}
¿¿ 	
}
¡¡ 
private
√√ 
void
√√ 
ProcessPastedText
√√ "
(
√√" #
string
√√# )

pastedText
√√* 4
)
√√4 5
{
ƒƒ 
string
≈≈ 
	validText
≈≈ 
=
≈≈ 
AllowOnlyNumbers
≈≈ +
?
∆∆ 
new
∆∆ 
string
∆∆ 
(
∆∆ 

pastedText
∆∆ #
.
∆∆# $
Where
∆∆$ )
(
∆∆) *
char
∆∆* .
.
∆∆. /
IsDigit
∆∆/ 6
)
∆∆6 7
.
∆∆7 8
ToArray
∆∆8 ?
(
∆∆? @
)
∆∆@ A
)
∆∆A B
:
«« 

pastedText
«« 
;
«« 
if
…… 

(
…… 
string
…… 
.
…… 
IsNullOrEmpty
……  
(
……  !
	validText
……! *
)
……* +
)
……+ ,
{
   	
return
ÀÀ 
;
ÀÀ 
}
ÃÃ 	
if
ŒŒ 

(
ŒŒ 
AllowOnlyNumbers
ŒŒ 
&&
ŒŒ 
!
ŒŒ  !
	validText
ŒŒ! *
.
ŒŒ* +
All
ŒŒ+ .
(
ŒŒ. /
char
ŒŒ/ 3
.
ŒŒ3 4
IsDigit
ŒŒ4 ;
)
ŒŒ; <
)
ŒŒ< =
{
œœ 	
return
–– 
;
–– 
}
—— 	
if
”” 

(
”” 
	validText
”” 
.
”” 
Length
”” 
!=
”” 
	_segments
””  )
.
””) *
Count
””* /
)
””/ 0
{
‘‘ 	
return
’’ 
;
’’ 
}
÷÷ 	%
UpdateSegmentsFromValue
ÿÿ 
(
ÿÿ  
	validText
ÿÿ  )
)
ÿÿ) *
;
ÿÿ* +
}
ŸŸ 
private
€€ 
void
€€  
HandleBackspaceKey
€€ #
(
€€# $
int
€€$ '
currentIndex
€€( 4
)
€€4 5
{
‹‹ 
TextBox
›› 
currentTextBox
›› 
=
››  
	_segments
››! *
[
››* +
currentIndex
››+ 7
]
››7 8
;
››8 9
if
ﬂﬂ 

(
ﬂﬂ 
!
ﬂﬂ 
string
ﬂﬂ 
.
ﬂﬂ 
IsNullOrEmpty
ﬂﬂ !
(
ﬂﬂ! "
currentTextBox
ﬂﬂ" 0
.
ﬂﬂ0 1
Text
ﬂﬂ1 5
)
ﬂﬂ5 6
)
ﬂﬂ6 7
{
‡‡ 	
currentTextBox
·· 
.
·· 
Text
·· 
=
··  !
$str
··" $
;
··$ %
}
‚‚ 	
else
„„ 
if
„„ 
(
„„ 
currentIndex
„„ 
>
„„ 
$num
„„  !
)
„„! "
{
‰‰ 	
int
ÂÂ 
previousIndex
ÂÂ 
=
ÂÂ 
currentIndex
ÂÂ  ,
-
ÂÂ- .
$num
ÂÂ/ 0
;
ÂÂ0 1
SetActiveSegment
ÊÊ 
(
ÊÊ 
previousIndex
ÊÊ *
)
ÊÊ* +
;
ÊÊ+ ,
	_segments
ÁÁ 
[
ÁÁ 
previousIndex
ÁÁ #
]
ÁÁ# $
.
ÁÁ$ %
Text
ÁÁ% )
=
ÁÁ* +
$str
ÁÁ, .
;
ÁÁ. /
}
ËË 	
}
ÈÈ 
private
ÎÎ 
void
ÎÎ 
SetActiveSegment
ÎÎ !
(
ÎÎ! "
int
ÎÎ" %
index
ÎÎ& +
)
ÎÎ+ ,
{
ÏÏ 
if
ÌÌ 

(
ÌÌ 
index
ÌÌ 
>=
ÌÌ 
$num
ÌÌ 
&&
ÌÌ 
index
ÌÌ 
<
ÌÌ  !
	_segments
ÌÌ" +
.
ÌÌ+ ,
Count
ÌÌ, 1
)
ÌÌ1 2
{
ÓÓ 	!
_currentActiveIndex
ÔÔ 
=
ÔÔ  !
index
ÔÔ" '
;
ÔÔ' (
UpdateTabIndexes
 
(
 
)
 
;
 !
UpdateActiveSegment
ÒÒ 
(
ÒÒ  
)
ÒÒ  !
;
ÒÒ! "
}
ÚÚ 	
}
ÛÛ 
private
ıı 
void
ıı !
UpdateActiveSegment
ıı $
(
ıı$ %
)
ıı% &
{
ˆˆ 
for
˜˜ 
(
˜˜ 
int
˜˜ 
i
˜˜ 
=
˜˜ 
$num
˜˜ 
;
˜˜ 
i
˜˜ 
<
˜˜ 
	_segments
˜˜ %
.
˜˜% &
Count
˜˜& +
;
˜˜+ ,
i
˜˜- .
++
˜˜. 0
)
˜˜0 1
{
¯¯ 	
TextBox
˘˘ 
tb
˘˘ 
=
˘˘ 
	_segments
˘˘ "
[
˘˘" #
i
˘˘# $
]
˘˘$ %
;
˘˘% &
tb
˙˙ 
.
˙˙ 
Classes
˙˙ 
.
˙˙ 
Set
˙˙ 
(
˙˙ '
SegmentedTextBoxConstants
˙˙ 4
.
˙˙4 5 
ACTIVE_STYLE_CLASS
˙˙5 G
,
˙˙G H
i
˙˙I J
==
˙˙K M!
_currentActiveIndex
˙˙N a
)
˙˙a b
;
˙˙b c
}
˚˚ 	!
FocusCurrentSegment
˝˝ 
(
˝˝ 
)
˝˝ 
;
˝˝ 
}
˛˛ 
private
ÄÄ 
void
ÄÄ !
FocusCurrentSegment
ÄÄ $
(
ÄÄ$ %
)
ÄÄ% &
{
ÅÅ 
if
ÇÇ 

(
ÇÇ !
_currentActiveIndex
ÇÇ 
>=
ÇÇ  "
$num
ÇÇ# $
&&
ÇÇ% '!
_currentActiveIndex
ÇÇ( ;
<
ÇÇ< =
	_segments
ÇÇ> G
.
ÇÇG H
Count
ÇÇH M
)
ÇÇM N
{
ÉÉ 	
TextBox
ÑÑ 
currentSegment
ÑÑ "
=
ÑÑ# $
	_segments
ÑÑ% .
[
ÑÑ. /!
_currentActiveIndex
ÑÑ/ B
]
ÑÑB C
;
ÑÑC D
currentSegment
ÖÖ 
.
ÖÖ 
Focus
ÖÖ  
(
ÖÖ  !
)
ÖÖ! "
;
ÖÖ" #
if
áá 
(
áá 
!
áá 
string
áá 
.
áá 
IsNullOrEmpty
áá %
(
áá% &
currentSegment
áá& 4
.
áá4 5
Text
áá5 9
)
áá9 :
)
áá: ;
{
àà 
currentSegment
ââ 
.
ââ 
SelectionStart
ââ -
=
ââ. /
currentSegment
ââ0 >
.
ââ> ?
Text
ââ? C
.
ââC D
Length
ââD J
;
ââJ K
currentSegment
ää 
.
ää 
SelectionEnd
ää +
=
ää, -
currentSegment
ää. <
.
ää< =
Text
ää= A
.
ääA B
Length
ääB H
;
ääH I
}
ãã 
}
åå 	
}
çç 
private
èè 
void
èè 
MoveToNextSegment
èè "
(
èè" #
)
èè# $
{
êê 
if
ëë 

(
ëë !
_currentActiveIndex
ëë 
<
ëë  !
	_segments
ëë" +
.
ëë+ ,
Count
ëë, 1
-
ëë2 3
$num
ëë4 5
)
ëë5 6
{
íí 	
SetActiveSegment
ìì 
(
ìì !
_currentActiveIndex
ìì 0
+
ìì1 2
$num
ìì3 4
)
ìì4 5
;
ìì5 6
}
îî 	
}
ïï 
private
óó 
void
óó 
OnSegmentChanged
óó !
(
óó! "
)
óó" #
{
òò 
string
ôô 
newValue
ôô 
=
ôô "
GetConcatenatedValue
ôô .
(
ôô. /
)
ôô/ 0
;
ôô0 1
bool
öö 
newIsComplete
öö 
=
öö 
	_segments
öö &
.
öö& '
All
öö' *
(
öö* +
tb
öö+ -
=>
öö. 0
!
öö1 2
string
öö2 8
.
öö8 9
IsNullOrEmpty
öö9 F
(
ööF G
tb
ööG I
.
ööI J
Text
ööJ N
)
ööN O
)
ööO P
;
ööP Q
if
úú 

(
úú 
!
úú 
_isInternalUpdate
úú 
&&
úú !
Value
úú" '
!=
úú( *
newValue
úú+ 3
)
úú3 4
{
ùù 	
_isInternalUpdate
ûû 
=
ûû 
true
ûû  $
;
ûû$ %
try
üü 
{
†† 
SetValue
°° 
(
°° 
ValueProperty
°° &
,
°°& '
newValue
°°( 0
)
°°0 1
;
°°1 2
}
¢¢ 
finally
££ 
{
§§ 
_isInternalUpdate
•• !
=
••" #
false
••$ )
;
••) *
}
¶¶ 
}
ßß 	
if
©© 

(
©© 

IsComplete
©© 
!=
©© 
newIsComplete
©© '
)
©©' (
{
™™ 	
SetValue
´´ 
(
´´  
IsCompleteProperty
´´ '
,
´´' (
newIsComplete
´´) 6
)
´´6 7
;
´´7 8
}
¨¨ 	
}
≠≠ 
private
ØØ 
void
ØØ 
UpdateTabIndexes
ØØ !
(
ØØ! "
)
ØØ" #
{
∞∞ 
for
±± 
(
±± 
int
±± 
i
±± 
=
±± 
$num
±± 
;
±± 
i
±± 
<
±± 
	_segments
±± %
.
±±% &
Count
±±& +
;
±±+ ,
i
±±- .
++
±±. 0
)
±±0 1
{
≤≤ 	
	_segments
≥≥ 
[
≥≥ 
i
≥≥ 
]
≥≥ 
.
≥≥ 
TabIndex
≥≥ !
=
≥≥" #
i
≥≥$ %
==
≥≥& (!
_currentActiveIndex
≥≥) <
?
≥≥= >
BaseTabIndex
≥≥? K
:
≥≥L M
-
≥≥N O
$num
≥≥O P
;
≥≥P Q
	_segments
¥¥ 
[
¥¥ 
i
¥¥ 
]
¥¥ 
.
¥¥ 
	IsTabStop
¥¥ "
=
¥¥# $
i
¥¥% &
==
¥¥' )!
_currentActiveIndex
¥¥* =
;
¥¥= >
}
µµ 	
}
∂∂ 
private
∏∏ 
void
∏∏ !
InitializeComponent
∏∏ $
(
∏∏$ %
)
∏∏% &
{
ππ  
AvaloniaXamlLoader
∫∫ 
.
∫∫ 
Load
∫∫ 
(
∫∫  
this
∫∫  $
)
∫∫$ %
;
∫∫% &
}
ªª 
}ºº ˜î	
{/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Core/HintedTextBox.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Core! %
;% &
public 
sealed 
partial 
class 
HintedTextBox )
:* +
UserControl, 7
,7 8
IDisposable9 D
{ 
public 

static 
readonly 
StyledProperty )
<) *
bool* .
>. /#
IsSecureKeyModeProperty0 G
=H I
AvaloniaProperty 
. 
Register !
<! "
HintedTextBox" /
,/ 0
bool1 5
>5 6
(6 7
nameof7 =
(= >
IsSecureKeyMode> M
)M N
)N O
;O P
public 

static 
readonly 
StyledProperty )
<) *
char* .
>. /%
SecureKeyMaskCharProperty0 I
=J K
AvaloniaProperty 
. 
Register !
<! "
HintedTextBox" /
,/ 0
char1 5
>5 6
(6 7
nameof7 =
(= >
SecureKeyMaskChar> O
)O P
,P Q"
HintedTextBoxConstants   "
.  " #
DEFAULT_MASK_CHAR  # 4
)  4 5
;  5 6
public"" 

static"" 
readonly"" 
StyledProperty"" )
<"") *
string""* 0
>""0 1
TextProperty""2 >
=""? @
AvaloniaProperty## 
.## 
Register## !
<##! "
HintedTextBox##" /
,##/ 0
string##1 7
>##7 8
(##8 9
nameof##9 ?
(##? @
Text##@ D
)##D E
,##E F
string##G M
.##M N
Empty##N S
,##S T
defaultBindingMode$$ 
:$$ 
Avalonia$$  (
.$$( )
Data$$) -
.$$- .
BindingMode$$. 9
.$$9 :
TwoWay$$: @
)$$@ A
;$$A B
public&& 

static&& 
readonly&& 
StyledProperty&& )
<&&) *
string&&* 0
>&&0 1
WatermarkProperty&&2 C
=&&D E
AvaloniaProperty'' 
.'' 
Register'' !
<''! "
HintedTextBox''" /
,''/ 0
string''1 7
>''7 8
(''8 9
nameof''9 ?
(''? @
	Watermark''@ I
)''I J
,''J K
string''L R
.''R S
Empty''S X
)''X Y
;''Y Z
public)) 

static)) 
readonly)) 
StyledProperty)) )
<))) *
string))* 0
>))0 1
HintProperty))2 >
=))? @
AvaloniaProperty** 
.** 
Register** !
<**! "
HintedTextBox**" /
,**/ 0
string**1 7
>**7 8
(**8 9
nameof**9 ?
(**? @
Hint**@ D
)**D E
,**E F
string**G M
.**M N
Empty**N S
)**S T
;**T U
public,, 

static,, 
readonly,, 
StyledProperty,, )
<,,) *
IBrush,,* 0
>,,0 1$
FocusBorderBrushProperty,,2 J
=,,K L
AvaloniaProperty-- 
.-- 
Register-- !
<--! "
HintedTextBox--" /
,--/ 0
IBrush--1 7
>--7 8
(--8 9
nameof.. 
(.. 
FocusBorderBrush.. #
)..# $
,..$ %
new..& )
SolidColorBrush..* 9
(..9 :
Color..: ?
...? @
Parse..@ E
(..E F"
HintedTextBoxConstants..F \
...\ ]
FOCUS_COLOR_HEX..] l
)..l m
)..m n
)..n o
;..o p
public00 

static00 
readonly00 
StyledProperty00 )
<00) *
IBrush00* 0
>000 1"
TextForegroundProperty002 H
=00I J
AvaloniaProperty11 
.11 
Register11 !
<11! "
HintedTextBox11" /
,11/ 0
IBrush111 7
>117 8
(118 9
nameof22 
(22 
TextForeground22 !
)22! "
,22" #
new22$ '
SolidColorBrush22( 7
(227 8
Colors228 >
.22> ?
Black22? D
)22D E
)22E F
;22F G
public44 

static44 
readonly44 
StyledProperty44 )
<44) *
IBrush44* 0
>440 1"
HintForegroundProperty442 H
=44I J
AvaloniaProperty55 
.55 
Register55 !
<55! "
HintedTextBox55" /
,55/ 0
IBrush551 7
>557 8
(558 9
nameof66 
(66 
HintForeground66 !
)66! "
,66" #
new66$ '
SolidColorBrush66( 7
(667 8
Colors668 >
.66> ?
Gray66? C
)66C D
)66D E
;66E F
public88 

static88 
readonly88 
StyledProperty88 )
<88) *
DrawingImage88* 6
?886 7
>887 8%
IconRegularSourceProperty889 R
=88S T
AvaloniaProperty99 
.99 
Register99 !
<99! "
HintedTextBox99" /
,99/ 0
DrawingImage991 =
?99= >
>99> ?
(99? @
nameof99@ F
(99F G
IconRegularSource99G X
)99X Y
)99Y Z
;99Z [
public;; 

static;; 
readonly;; 
StyledProperty;; )
<;;) *
DrawingImage;;* 6
?;;6 7
>;;7 8#
IconErrorSourceProperty;;9 P
=;;Q R
AvaloniaProperty<< 
.<< 
Register<< !
<<<! "
HintedTextBox<<" /
,<</ 0
DrawingImage<<1 =
?<<= >
><<> ?
(<<? @
nameof<<@ F
(<<F G
IconErrorSource<<G V
)<<V W
)<<W X
;<<X Y
public>> 

static>> 
readonly>> 
StyledProperty>> )
<>>) *
string>>* 0
>>>0 1
ErrorTextProperty>>2 C
=>>D E
AvaloniaProperty?? 
.?? 
Register?? !
<??! "
HintedTextBox??" /
,??/ 0
string??1 7
>??7 8
(??8 9
nameof??9 ?
(??? @
	ErrorText??@ I
)??I J
,??J K
string??L R
.??R S
Empty??S X
)??X Y
;??Y Z
publicAA 

staticAA 
readonlyAA 
StyledPropertyAA )
<AA) *
doubleAA* 0
>AA0 1"
EllipseOpacityPropertyAA2 H
=AAI J
AvaloniaPropertyBB 
.BB 
RegisterBB !
<BB! "
HintedTextBoxBB" /
,BB/ 0
doubleBB1 7
>BB7 8
(BB8 9
nameofBB9 ?
(BB? @
EllipseOpacityBB@ N
)BBN O
)BBO P
;BBP Q
publicDD 

staticDD 
readonlyDD 
StyledPropertyDD )
<DD) *
boolDD* .
>DD. /
HasErrorPropertyDD0 @
=DDA B
AvaloniaPropertyEE 
.EE 
RegisterEE !
<EE! "
HintedTextBoxEE" /
,EE/ 0
boolEE1 5
>EE5 6
(EE6 7
nameofEE7 =
(EE= >
HasErrorEE> F
)EEF G
)EEG H
;EEH I
publicGG 

staticGG 
readonlyGG 
StyledPropertyGG )
<GG) *
IBrushGG* 0
>GG0 1#
MainBorderBrushPropertyGG2 I
=GGJ K
AvaloniaPropertyHH 
.HH 
RegisterHH !
<HH! "
HintedTextBoxHH" /
,HH/ 0
IBrushHH1 7
>HH7 8
(HH8 9
nameofII 
(II 
MainBorderBrushII "
)II" #
,II# $
newII% (
SolidColorBrushII) 8
(II8 9
ColorsII9 ?
.II? @
	LightGrayII@ I
)III J
)IIJ K
;IIK L
publicKK 

staticKK 
readonlyKK 
StyledPropertyKK )
<KK) *
TextWrappingKK* 6
>KK6 7 
TextWrappingPropertyKK8 L
=KKM N
AvaloniaPropertyLL 
.LL 
RegisterLL !
<LL! "
HintedTextBoxLL" /
,LL/ 0
TextWrappingLL1 =
>LL= >
(LL> ?
nameofLL? E
(LLE F
TextWrappingLLF R
)LLR S
)LLS T
;LLT U
publicNN 

staticNN 
readonlyNN 
StyledPropertyNN )
<NN) *
intNN* -
>NN- .
MaxLengthPropertyNN/ @
=NNA B
AvaloniaPropertyOO 
.OO 
RegisterOO !
<OO! "
HintedTextBoxOO" /
,OO/ 0
intOO1 4
>OO4 5
(OO5 6
nameofOO6 <
(OO< =
	MaxLengthOO= F
)OOF G
,OOG H
intOOI L
.OOL M
MaxValueOOM U
)OOU V
;OOV W
publicQQ 

staticQQ 
readonlyQQ 
StyledPropertyQQ )
<QQ) *
intQQ* -
>QQ- .'
RemainingCharactersPropertyQQ/ J
=QQK L
AvaloniaPropertyRR 
.RR 
RegisterRR !
<RR! "
HintedTextBoxRR" /
,RR/ 0
intRR1 4
>RR4 5
(RR5 6
nameofRR6 <
(RR< =
RemainingCharactersRR= P
)RRP Q
,RRQ R
intRRS V
.RRV W
MaxValueRRW _
)RR_ `
;RR` a
publicTT 

staticTT 
readonlyTT 
StyledPropertyTT )
<TT) *
boolTT* .
>TT. /(
ShowCharacterCounterPropertyTT0 L
=TTM N
AvaloniaPropertyUU 
.UU 
RegisterUU !
<UU! "
HintedTextBoxUU" /
,UU/ 0
boolUU1 5
>UU5 6
(UU6 7
nameofUU7 =
(UU= > 
ShowCharacterCounterUU> R
)UUR S
)UUS T
;UUT U
publicWW 

staticWW 
readonlyWW 
StyledPropertyWW )
<WW) *
boolWW* .
>WW. /!
IsNumericOnlyPropertyWW0 E
=WWF G
AvaloniaPropertyXX 
.XX 
RegisterXX !
<XX! "
HintedTextBoxXX" /
,XX/ 0
boolXX1 5
>XX5 6
(XX6 7
nameofXX7 =
(XX= >
IsNumericOnlyXX> K
)XXK L
)XXL M
;XXM N
publicZZ 

newZZ 
staticZZ 
readonlyZZ 
StyledPropertyZZ -
<ZZ- .
IBrushZZ. 4
>ZZ4 5
BackgroundPropertyZZ6 H
=ZZI J
AvaloniaProperty[[ 
.[[ 
Register[[ !
<[[! "
HintedTextBox[[" /
,[[/ 0
IBrush[[1 7
>[[7 8
([[8 9
nameof\\ 
(\\ 

Background\\ 
)\\ 
,\\ 
new\\  #
SolidColorBrush\\$ 3
(\\3 4
Colors\\4 :
.\\: ;
White\\; @
)\\@ A
)\\A B
;\\B C
public^^ 

new^^ 
static^^ 
readonly^^ 
StyledProperty^^ -
<^^- .
double^^. 4
>^^4 5
FontSizeProperty^^6 F
=^^G H
AvaloniaProperty__ 
.__ 
Register__ !
<__! "
HintedTextBox__" /
,__/ 0
double__1 7
>__7 8
(__8 9
nameof__9 ?
(__? @
FontSize__@ H
)__H I
,__I J"
HintedTextBoxConstants__K a
.__a b
DEFAULT_FONT_SIZE__b s
)__s t
;__t u
publicaa 

staticaa 
readonlyaa 
StyledPropertyaa )
<aa) *
doubleaa* 0
>aa0 1%
WatermarkFontSizePropertyaa2 K
=aaL M
AvaloniaPropertybb 
.bb 
Registerbb !
<bb! "
HintedTextBoxbb" /
,bb/ 0
doublebb1 7
>bb7 8
(bb8 9
nameofbb9 ?
(bb? @
WatermarkFontSizebb@ Q
)bbQ R
,bbR S"
HintedTextBoxConstantscc "
.cc" #'
DEFAULT_WATERMARK_FONT_SIZEcc# >
)cc> ?
;cc? @
publicee 

newee 
staticee 
readonlyee 
StyledPropertyee -
<ee- .

FontWeightee. 8
>ee8 9
FontWeightPropertyee: L
=eeM N
AvaloniaPropertyff 
.ff 
Registerff !
<ff! "
HintedTextBoxff" /
,ff/ 0

FontWeightff1 ;
>ff; <
(ff< =
nameofff= C
(ffC D

FontWeightffD N
)ffN O
,ffO P

FontWeightffQ [
.ff[ \
Normalff\ b
)ffb c
;ffc d
publichh 

statichh 
readonlyhh 
StyledPropertyhh )
<hh) *
boolhh* .
>hh. /+
IsSecureKeyStrengthModePropertyhh0 O
=hhP Q
AvaloniaPropertyii 
.ii 
Registerii !
<ii! "
HintedTextBoxii" /
,ii/ 0
boolii1 5
>ii5 6
(ii6 7
nameofii7 =
(ii= >#
IsSecureKeyStrengthModeii> U
)iiU V
)iiV W
;iiW X
publickk 

statickk 
readonlykk 
StyledPropertykk )
<kk) *
SecureKeyStrengthkk* ;
>kk; <%
SecureKeyStrengthPropertykk= V
=kkW X
AvaloniaPropertyll 
.ll 
Registerll !
<ll! "
HintedTextBoxll" /
,ll/ 0
SecureKeyStrengthll1 B
>llB C
(llC D
nameofllD J
(llJ K
SecureKeyStrengthllK \
)ll\ ]
,ll] ^
SecureKeyStrengthll_ p
.llp q
Invalidllq x
)llx y
;lly z
publicnn 

staticnn 
readonlynn 
StyledPropertynn )
<nn) *
stringnn* 0
>nn0 1)
SecureKeyStrengthTextPropertynn2 O
=nnP Q
AvaloniaPropertyoo 
.oo 
Registeroo !
<oo! "
HintedTextBoxoo" /
,oo/ 0
stringoo1 7
>oo7 8
(oo8 9
nameofoo9 ?
(oo? @!
SecureKeyStrengthTextoo@ U
)ooU V
,ooV W
stringooX ^
.oo^ _
Emptyoo_ d
)ood e
;ooe f
publicqq 

staticqq 
readonlyqq 
StyledPropertyqq )
<qq) *
IBrushqq* 0
>qq0 1.
"SecureKeyStrengthTextBrushPropertyqq2 T
=qqU V
AvaloniaPropertyrr 
.rr 
Registerrr !
<rr! "
HintedTextBoxrr" /
,rr/ 0
IBrushrr1 7
>rr7 8
(rr8 9
nameofrr9 ?
(rr? @&
SecureKeyStrengthTextBrushrr@ Z
)rrZ [
,rr[ \
newss 
SolidColorBrushss 
(ss  
Colorsss  &
.ss& '
Grayss' +
)ss+ ,
)ss, -
;ss- .
publicuu 

staticuu 
readonlyuu 
StyledPropertyuu )
<uu) *
IBrushuu* 0
>uu0 1.
"SecureKeyStrengthIconBrushPropertyuu2 T
=uuU V
AvaloniaPropertyvv 
.vv 
Registervv !
<vv! "
HintedTextBoxvv" /
,vv/ 0
IBrushvv1 7
>vv7 8
(vv8 9
nameofvv9 ?
(vv? @&
SecureKeyStrengthIconBrushvv@ Z
)vvZ [
,vv[ \
newww 
SolidColorBrushww 
(ww  
Colorsww  &
.ww& '
Grayww' +
)ww+ ,
)ww, -
;ww- .
publicyy 

staticyy 
readonlyyy 
StyledPropertyyy )
<yy) *
stringyy* 0
>yy0 1
WarningTextPropertyyy2 E
=yyF G
AvaloniaPropertyzz 
.zz 
Registerzz !
<zz! "
HintedTextBoxzz" /
,zz/ 0
stringzz1 7
>zz7 8
(zz8 9
nameofzz9 ?
(zz? @
WarningTextzz@ K
)zzK L
,zzL M
stringzzN T
.zzT U
EmptyzzU Z
)zzZ [
;zz[ \
public|| 

static|| 
readonly|| 
StyledProperty|| )
<||) *
bool||* .
>||. /
HasWarningProperty||0 B
=||C D
AvaloniaProperty}} 
.}} 
Register}} !
<}}! "
HintedTextBox}}" /
,}}/ 0
bool}}1 5
>}}5 6
(}}6 7
nameof}}7 =
(}}= >

HasWarning}}> H
)}}H I
)}}I J
;}}J K
public 

static 
readonly 
StyledProperty )
<) *
int* -
>- .,
 WarningDisplayDurationMsProperty/ O
=P Q
AvaloniaProperty
ÄÄ 
.
ÄÄ 
Register
ÄÄ !
<
ÄÄ! "
HintedTextBox
ÄÄ" /
,
ÄÄ/ 0
int
ÄÄ1 4
>
ÄÄ4 5
(
ÄÄ5 6
nameof
ÄÄ6 <
(
ÄÄ< =&
WarningDisplayDurationMs
ÄÄ= U
)
ÄÄU V
,
ÄÄV W$
HintedTextBoxConstants
ÅÅ "
.
ÅÅ" #1
#DEFAULT_WARNING_DISPLAY_DURATION_MS
ÅÅ# F
)
ÅÅF G
;
ÅÅG H
public
ÉÉ 

static
ÉÉ 
readonly
ÉÉ 
RoutedEvent
ÉÉ &
<
ÉÉ& '(
CharacterRejectedEventArgs
ÉÉ' A
>
ÉÉA B$
CharacterRejectedEvent
ÉÉC Y
=
ÉÉZ [
RoutedEvent
ÑÑ 
.
ÑÑ 
Register
ÑÑ 
<
ÑÑ 
HintedTextBox
ÑÑ *
,
ÑÑ* +(
CharacterRejectedEventArgs
ÑÑ, F
>
ÑÑF G
(
ÑÑG H
nameof
ÑÑH N
(
ÑÑN O
CharacterRejected
ÑÑO `
)
ÑÑ` a
,
ÑÑa b
RoutingStrategies
ÑÑc t
.
ÑÑt u
Bubble
ÑÑu {
)
ÑÑ{ |
;
ÑÑ| }
public
ÜÜ 

static
ÜÜ 
readonly
ÜÜ 
RoutedEvent
ÜÜ &
<
ÜÜ& '/
!SecureKeyCharactersAddedEventArgs
ÜÜ' H
>
ÜÜH I+
SecureKeyCharactersAddedEvent
ÜÜJ g
=
ÜÜh i
RoutedEvent
áá 
.
áá 
Register
áá 
<
áá 
HintedTextBox
áá *
,
áá* +/
!SecureKeyCharactersAddedEventArgs
áá, M
>
ááM N
(
ááN O
nameof
ááO U
(
ááU V&
SecureKeyCharactersAdded
ááV n
)
áán o
,
ááo p
RoutingStrategies
àà 
.
àà 
Bubble
àà $
)
àà$ %
;
àà% &
public
ää 

static
ää 
readonly
ää 
RoutedEvent
ää &
<
ää& '1
#SecureKeyCharactersRemovedEventArgs
ää' J
>
ääJ K-
SecureKeyCharactersRemovedEvent
ääL k
=
ääl m
RoutedEvent
ãã 
.
ãã 
Register
ãã 
<
ãã 
HintedTextBox
ãã *
,
ãã* +1
#SecureKeyCharactersRemovedEventArgs
ãã, O
>
ããO P
(
ããP Q
nameof
ããQ W
(
ããW X(
SecureKeyCharactersRemoved
ããX r
)
ããr s
,
ããs t
RoutingStrategies
åå 
.
åå 
Bubble
åå $
)
åå$ %
;
åå% &
private
éé 
static
éé 
readonly
éé 

Dictionary
éé &
<
éé& '
string
éé' -
,
éé- .
SolidColorBrush
éé/ >
>
éé> ?

BrushCache
éé@ J
=
ééK L
new
ééM P
(
ééP Q
)
ééQ R
;
ééR S
private
èè 
static
èè 
readonly
èè 

Dictionary
èè &
<
èè& '
string
èè' -
,
èè- .
Color
èè/ 4
>
èè4 5

ColorCache
èè6 @
=
èèA B
new
èèC F
(
èèF G
)
èèG H
;
èèH I
private
êê 
static
êê 
readonly
êê 

Dictionary
êê &
<
êê& '
string
êê' -
,
êê- .

BoxShadows
êê/ 9
>
êê9 :
ResourceCache
êê; H
=
êêI J
new
êêK N
(
êêN O
)
êêO P
;
êêP Q
private
ëë 
static
ëë 
readonly
ëë 

Dictionary
ëë &
<
ëë& '
string
ëë' -
,
ëë- .
int
ëë/ 2
>
ëë2 3#
TextElementCountCache
ëë4 I
=
ëëJ K
new
ëëL O
(
ëëO P
StringComparer
ëëP ^
.
ëë^ _
Ordinal
ëë_ f
)
ëëf g
;
ëëg h
private
íí 
const
íí 
int
íí )
MAX_TEXT_ELEMENT_CACHE_SIZE
íí 1
=
íí2 3
$num
íí4 8
;
íí8 9
private
îî 
const
îî 
int
îî %
INPUT_DEBOUNCE_DELAY_MS
îî -
=
îî. /$
HintedTextBoxConstants
îî0 F
.
îîF G%
INPUT_DEBOUNCE_DELAY_MS
îîG ^
;
îî^ _
private
ïï 
const
ïï 
int
ïï *
SECURE_KEY_DEBOUNCE_DELAY_MS
ïï 2
=
ïï3 4
$num
ïï5 7
;
ïï7 8
private
óó 
readonly
óó !
CompositeDisposable
óó (
_disposables
óó) 5
=
óó6 7
new
óó8 ;
(
óó; <
)
óó< =
;
óó= >
private
ôô 
TextBox
ôô 
?
ôô 
_mainTextBox
ôô !
;
ôô! "
private
öö 
Border
öö 
?
öö 
_focusBorder
öö  
;
öö  !
private
õõ 
Border
õõ 
?
õõ 
_mainBorder
õõ 
;
õõ  
private
úú 
Border
úú 
?
úú 
_shadowBorder
úú !
;
úú! "
private
ùù 
bool
ùù !
_isUpdatingFromCode
ùù $
;
ùù$ %
private
ûû 
bool
ûû 
_isDisposed
ûû 
;
ûû 
private
üü 
bool
üü #
_isControlInitialized
üü &
;
üü& '
private
†† 
DispatcherTimer
†† 
?
†† 
_warningTimer
†† *
;
††* +
private
°° 
DispatcherTimer
°° 
?
°° !
_inputDebounceTimer
°° 0
;
°°0 1
private
¢¢ 
DispatcherTimer
¢¢ 
?
¢¢ %
_secureKeyDebounceTimer
¢¢ 4
;
¢¢4 5
private
££ 
bool
££ 
_lastIsFocused
££ 
;
££  
private
§§ 
bool
§§ 
_lastHasError
§§ 
;
§§ 
private
•• 
SecureKeyStrength
•• $
_lastSecureKeyStrength
•• 4
=
••5 6
SecureKeyStrength
••7 H
.
••H I
Invalid
••I P
;
••P Q
private
¶¶ 
bool
¶¶ *
_lastIsSecureKeyStrengthMode
¶¶ -
;
¶¶- .
private
ßß 
string
ßß  
_lastProcessedText
ßß %
=
ßß& '
string
ßß( .
.
ßß. /
Empty
ßß/ 4
;
ßß4 5
private
®® 
IDisposable
®® 
?
®® %
_currentTypingAnimation
®® 0
;
®®0 1
private
©© 
int
©© ,
_lastProcessedTextElementCount
©© .
;
©©. /
private
™™ 
volatile
™™ 
bool
™™ *
_isProcessingSecureKeyChange
™™ 6
;
™™6 7
private
´´ 
int
´´ $
_intendedCaretPosition
´´ &
;
´´& '
public
≠≠ 

HintedTextBox
≠≠ 
(
≠≠ 
)
≠≠ 
{
ÆÆ !
InitializeComponent
ØØ 
(
ØØ 
)
ØØ 
;
ØØ "
AttachedToVisualTree
∞∞ 
+=
∞∞ $
OnAttachedToVisualTree
∞∞  6
;
∞∞6 7
}
±± 
public
≥≥ 

int
≥≥ &
WarningDisplayDurationMs
≥≥ '
{
¥¥ 
get
µµ 
=>
µµ 
GetValue
µµ 
(
µµ .
 WarningDisplayDurationMsProperty
µµ 8
)
µµ8 9
;
µµ9 :
set
∂∂ 
=>
∂∂ 
SetValue
∂∂ 
(
∂∂ .
 WarningDisplayDurationMsProperty
∂∂ 8
,
∂∂8 9
value
∂∂: ?
)
∂∂? @
;
∂∂@ A
}
∑∑ 
public
ππ 

bool
ππ 
IsSecureKeyMode
ππ 
{
∫∫ 
get
ªª 
=>
ªª 
GetValue
ªª 
(
ªª %
IsSecureKeyModeProperty
ªª /
)
ªª/ 0
;
ªª0 1
set
ºº 
{
ΩΩ 	
bool
ææ 
oldValue
ææ 
=
ææ 
GetValue
ææ $
(
ææ$ %%
IsSecureKeyModeProperty
ææ% <
)
ææ< =
;
ææ= >
SetValue
øø 
(
øø %
IsSecureKeyModeProperty
øø ,
,
øø, -
value
øø. 3
)
øø3 4
;
øø4 5
if
¿¿ 
(
¿¿ 
oldValue
¿¿ 
!=
¿¿ 
value
¿¿ !
)
¿¿! "
{
¡¡ &
OnIsSecureKeyModeChanged
¬¬ (
(
¬¬( )
value
¬¬) .
)
¬¬. /
;
¬¬/ 0
}
√√ 
}
ƒƒ 	
}
≈≈ 
public
«« 

char
«« 
SecureKeyMaskChar
«« !
{
»» 
get
…… 
=>
…… 
GetValue
…… 
(
…… '
SecureKeyMaskCharProperty
…… 1
)
……1 2
;
……2 3
set
   
=>
   
SetValue
   
(
   '
SecureKeyMaskCharProperty
   1
,
  1 2
value
  3 8
)
  8 9
;
  9 :
}
ÀÀ 
public
ÕÕ 

string
ÕÕ 
Text
ÕÕ 
{
ŒŒ 
get
œœ 
=>
œœ 
GetValue
œœ 
(
œœ 
TextProperty
œœ $
)
œœ$ %
;
œœ% &
set
–– 
=>
–– 
SetValue
–– 
(
–– 
TextProperty
–– $
,
––$ %
value
––& +
)
––+ ,
;
––, -
}
—— 
public
”” 

string
”” 
	Watermark
”” 
{
‘‘ 
get
’’ 
=>
’’ 
GetValue
’’ 
(
’’ 
WatermarkProperty
’’ )
)
’’) *
;
’’* +
set
÷÷ 
=>
÷÷ 
SetValue
÷÷ 
(
÷÷ 
WatermarkProperty
÷÷ )
,
÷÷) *
value
÷÷+ 0
)
÷÷0 1
;
÷÷1 2
}
◊◊ 
public
ŸŸ 

string
ŸŸ 
Hint
ŸŸ 
{
⁄⁄ 
get
€€ 
=>
€€ 
GetValue
€€ 
(
€€ 
HintProperty
€€ $
)
€€$ %
;
€€% &
set
‹‹ 
=>
‹‹ 
SetValue
‹‹ 
(
‹‹ 
HintProperty
‹‹ $
,
‹‹$ %
value
‹‹& +
)
‹‹+ ,
;
‹‹, -
}
›› 
public
ﬂﬂ 

IBrush
ﬂﬂ 
FocusBorderBrush
ﬂﬂ "
{
‡‡ 
get
·· 
=>
·· 
GetValue
·· 
(
·· &
FocusBorderBrushProperty
·· 0
)
··0 1
;
··1 2
set
‚‚ 
=>
‚‚ 
SetValue
‚‚ 
(
‚‚ &
FocusBorderBrushProperty
‚‚ 0
,
‚‚0 1
value
‚‚2 7
)
‚‚7 8
;
‚‚8 9
}
„„ 
public
ÂÂ 

IBrush
ÂÂ 
TextForeground
ÂÂ  
{
ÊÊ 
get
ÁÁ 
=>
ÁÁ 
GetValue
ÁÁ 
(
ÁÁ $
TextForegroundProperty
ÁÁ .
)
ÁÁ. /
;
ÁÁ/ 0
set
ËË 
=>
ËË 
SetValue
ËË 
(
ËË $
TextForegroundProperty
ËË .
,
ËË. /
value
ËË0 5
)
ËË5 6
;
ËË6 7
}
ÈÈ 
public
ÎÎ 

IBrush
ÎÎ 
HintForeground
ÎÎ  
{
ÏÏ 
get
ÌÌ 
=>
ÌÌ 
GetValue
ÌÌ 
(
ÌÌ $
HintForegroundProperty
ÌÌ .
)
ÌÌ. /
;
ÌÌ/ 0
set
ÓÓ 
=>
ÓÓ 
SetValue
ÓÓ 
(
ÓÓ $
HintForegroundProperty
ÓÓ .
,
ÓÓ. /
value
ÓÓ0 5
)
ÓÓ5 6
;
ÓÓ6 7
}
ÔÔ 
public
ÒÒ 

DrawingImage
ÒÒ 
?
ÒÒ 
IconRegularSource
ÒÒ *
{
ÚÚ 
get
ÛÛ 
=>
ÛÛ 
GetValue
ÛÛ 
(
ÛÛ '
IconRegularSourceProperty
ÛÛ 1
)
ÛÛ1 2
;
ÛÛ2 3
set
ÙÙ 
=>
ÙÙ 
SetValue
ÙÙ 
(
ÙÙ '
IconRegularSourceProperty
ÙÙ 1
,
ÙÙ1 2
value
ÙÙ3 8
)
ÙÙ8 9
;
ÙÙ9 :
}
ıı 
public
˜˜ 

DrawingImage
˜˜ 
?
˜˜ 
IconErrorSource
˜˜ (
{
¯¯ 
get
˘˘ 
=>
˘˘ 
GetValue
˘˘ 
(
˘˘ %
IconErrorSourceProperty
˘˘ /
)
˘˘/ 0
;
˘˘0 1
set
˙˙ 
=>
˙˙ 
SetValue
˙˙ 
(
˙˙ %
IconErrorSourceProperty
˙˙ /
,
˙˙/ 0
value
˙˙1 6
)
˙˙6 7
;
˙˙7 8
}
˚˚ 
public
˝˝ 

string
˝˝ 
	ErrorText
˝˝ 
{
˛˛ 
get
ˇˇ 
=>
ˇˇ 
GetValue
ˇˇ 
(
ˇˇ 
ErrorTextProperty
ˇˇ )
)
ˇˇ) *
;
ˇˇ* +
private
ÄÄ 
set
ÄÄ 
{
ÅÅ 	
SetValue
ÇÇ 
(
ÇÇ 
ErrorTextProperty
ÇÇ &
,
ÇÇ& '
value
ÇÇ( -
)
ÇÇ- .
;
ÇÇ. /
}
ÉÉ 	
}
ÑÑ 
public
ÜÜ 

double
ÜÜ 
EllipseOpacity
ÜÜ  
{
áá 
get
àà 
=>
àà 
GetValue
àà 
(
àà $
EllipseOpacityProperty
àà .
)
àà. /
;
àà/ 0
private
ââ 
set
ââ 
=>
ââ 
SetValue
ââ 
(
ââ  $
EllipseOpacityProperty
ââ  6
,
ââ6 7
value
ââ8 =
)
ââ= >
;
ââ> ?
}
ää 
public
åå 

bool
åå 
HasError
åå 
{
çç 
get
éé 
=>
éé 
GetValue
éé 
(
éé 
HasErrorProperty
éé (
)
éé( )
;
éé) *
private
èè 
set
èè 
=>
èè 
SetValue
èè 
(
èè  
HasErrorProperty
èè  0
,
èè0 1
value
èè2 7
)
èè7 8
;
èè8 9
}
êê 
public
íí 

IBrush
íí 
MainBorderBrush
íí !
{
ìì 
get
îî 
=>
îî 
GetValue
îî 
(
îî %
MainBorderBrushProperty
îî /
)
îî/ 0
;
îî0 1
set
ïï 
=>
ïï 
SetValue
ïï 
(
ïï %
MainBorderBrushProperty
ïï /
,
ïï/ 0
value
ïï1 6
)
ïï6 7
;
ïï7 8
}
ññ 
public
òò 

TextWrapping
òò 
TextWrapping
òò $
{
ôô 
get
öö 
=>
öö 
GetValue
öö 
(
öö "
TextWrappingProperty
öö ,
)
öö, -
;
öö- .
set
õõ 
=>
õõ 
SetValue
õõ 
(
õõ "
TextWrappingProperty
õõ ,
,
õõ, -
value
õõ. 3
)
õõ3 4
;
õõ4 5
}
úú 
public
ûû 

int
ûû 
	MaxLength
ûû 
{
üü 
get
†† 
=>
†† 
GetValue
†† 
(
†† 
MaxLengthProperty
†† )
)
††) *
;
††* +
set
°° 
=>
°° 
SetValue
°° 
(
°° 
MaxLengthProperty
°° )
,
°°) *
value
°°+ 0
)
°°0 1
;
°°1 2
}
¢¢ 
public
§§ 

int
§§ !
RemainingCharacters
§§ "
{
•• 
get
¶¶ 
=>
¶¶ 
GetValue
¶¶ 
(
¶¶ )
RemainingCharactersProperty
¶¶ 3
)
¶¶3 4
;
¶¶4 5
private
ßß 
set
ßß 
=>
ßß 
SetValue
ßß 
(
ßß  )
RemainingCharactersProperty
ßß  ;
,
ßß; <
value
ßß= B
)
ßßB C
;
ßßC D
}
®® 
public
™™ 

bool
™™ "
ShowCharacterCounter
™™ $
{
´´ 
get
¨¨ 
=>
¨¨ 
GetValue
¨¨ 
(
¨¨ *
ShowCharacterCounterProperty
¨¨ 4
)
¨¨4 5
;
¨¨5 6
set
≠≠ 
=>
≠≠ 
SetValue
≠≠ 
(
≠≠ *
ShowCharacterCounterProperty
≠≠ 4
,
≠≠4 5
value
≠≠6 ;
)
≠≠; <
;
≠≠< =
}
ÆÆ 
public
∞∞ 

bool
∞∞ 
IsNumericOnly
∞∞ 
{
±± 
get
≤≤ 
=>
≤≤ 
GetValue
≤≤ 
(
≤≤ #
IsNumericOnlyProperty
≤≤ -
)
≤≤- .
;
≤≤. /
set
≥≥ 
=>
≥≥ 
SetValue
≥≥ 
(
≥≥ #
IsNumericOnlyProperty
≥≥ -
,
≥≥- .
value
≥≥/ 4
)
≥≥4 5
;
≥≥5 6
}
¥¥ 
public
∂∂ 

new
∂∂ 
IBrush
∂∂ 

Background
∂∂  
{
∑∑ 
get
∏∏ 
=>
∏∏ 
GetValue
∏∏ 
(
∏∏  
BackgroundProperty
∏∏ *
)
∏∏* +
;
∏∏+ ,
set
ππ 
=>
ππ 
SetValue
ππ 
(
ππ  
BackgroundProperty
ππ *
,
ππ* +
value
ππ, 1
)
ππ1 2
;
ππ2 3
}
∫∫ 
public
ºº 

new
ºº 
double
ºº 
FontSize
ºº 
{
ΩΩ 
get
ææ 
=>
ææ 
GetValue
ææ 
(
ææ 
FontSizeProperty
ææ (
)
ææ( )
;
ææ) *
set
øø 
=>
øø 
SetValue
øø 
(
øø 
FontSizeProperty
øø (
,
øø( )
value
øø* /
)
øø/ 0
;
øø0 1
}
¿¿ 
public
¬¬ 

double
¬¬ 
WatermarkFontSize
¬¬ #
{
√√ 
get
ƒƒ 
=>
ƒƒ 
GetValue
ƒƒ 
(
ƒƒ '
WatermarkFontSizeProperty
ƒƒ 1
)
ƒƒ1 2
;
ƒƒ2 3
set
≈≈ 
=>
≈≈ 
SetValue
≈≈ 
(
≈≈ '
WatermarkFontSizeProperty
≈≈ 1
,
≈≈1 2
value
≈≈3 8
)
≈≈8 9
;
≈≈9 :
}
∆∆ 
public
»» 

new
»» 

FontWeight
»» 

FontWeight
»» $
{
…… 
get
   
=>
   
GetValue
   
(
    
FontWeightProperty
   *
)
  * +
;
  + ,
set
ÀÀ 
=>
ÀÀ 
SetValue
ÀÀ 
(
ÀÀ  
FontWeightProperty
ÀÀ *
,
ÀÀ* +
value
ÀÀ, 1
)
ÀÀ1 2
;
ÀÀ2 3
}
ÃÃ 
public
ŒŒ 

bool
ŒŒ %
IsSecureKeyStrengthMode
ŒŒ '
{
œœ 
get
–– 
=>
–– 
GetValue
–– 
(
–– -
IsSecureKeyStrengthModeProperty
–– 7
)
––7 8
;
––8 9
set
—— 
=>
—— 
SetValue
—— 
(
—— -
IsSecureKeyStrengthModeProperty
—— 7
,
——7 8
value
——9 >
)
——> ?
;
——? @
}
““ 
public
‘‘ 

SecureKeyStrength
‘‘ 
SecureKeyStrength
‘‘ .
{
’’ 
get
÷÷ 
=>
÷÷ 
GetValue
÷÷ 
(
÷÷ '
SecureKeyStrengthProperty
÷÷ 1
)
÷÷1 2
;
÷÷2 3
set
◊◊ 
=>
◊◊ 
SetValue
◊◊ 
(
◊◊ '
SecureKeyStrengthProperty
◊◊ 1
,
◊◊1 2
value
◊◊3 8
)
◊◊8 9
;
◊◊9 :
}
ÿÿ 
public
⁄⁄ 

string
⁄⁄ #
SecureKeyStrengthText
⁄⁄ '
{
€€ 
get
‹‹ 
=>
‹‹ 
GetValue
‹‹ 
(
‹‹ +
SecureKeyStrengthTextProperty
‹‹ 5
)
‹‹5 6
;
‹‹6 7
set
›› 
=>
›› 
SetValue
›› 
(
›› +
SecureKeyStrengthTextProperty
›› 5
,
››5 6
value
››7 <
)
››< =
;
››= >
}
ﬁﬁ 
public
‡‡ 

IBrush
‡‡ (
SecureKeyStrengthTextBrush
‡‡ ,
{
·· 
get
‚‚ 
=>
‚‚ 
GetValue
‚‚ 
(
‚‚ 0
"SecureKeyStrengthTextBrushProperty
‚‚ :
)
‚‚: ;
;
‚‚; <
set
„„ 
=>
„„ 
SetValue
„„ 
(
„„ 0
"SecureKeyStrengthTextBrushProperty
„„ :
,
„„: ;
value
„„< A
)
„„A B
;
„„B C
}
‰‰ 
public
ÊÊ 

IBrush
ÊÊ (
SecureKeyStrengthIconBrush
ÊÊ ,
{
ÁÁ 
get
ËË 
=>
ËË 
GetValue
ËË 
(
ËË 0
"SecureKeyStrengthIconBrushProperty
ËË :
)
ËË: ;
;
ËË; <
set
ÈÈ 
=>
ÈÈ 
SetValue
ÈÈ 
(
ÈÈ 0
"SecureKeyStrengthIconBrushProperty
ÈÈ :
,
ÈÈ: ;
value
ÈÈ< A
)
ÈÈA B
;
ÈÈB C
}
ÍÍ 
public
ÏÏ 

string
ÏÏ 
WarningText
ÏÏ 
{
ÌÌ 
get
ÓÓ 
=>
ÓÓ 
GetValue
ÓÓ 
(
ÓÓ !
WarningTextProperty
ÓÓ +
)
ÓÓ+ ,
;
ÓÓ, -
set
ÔÔ 
=>
ÔÔ 
SetValue
ÔÔ 
(
ÔÔ !
WarningTextProperty
ÔÔ +
,
ÔÔ+ ,
value
ÔÔ- 2
)
ÔÔ2 3
;
ÔÔ3 4
}
 
public
ÚÚ 

bool
ÚÚ 

HasWarning
ÚÚ 
{
ÛÛ 
get
ÙÙ 
=>
ÙÙ 
GetValue
ÙÙ 
(
ÙÙ  
HasWarningProperty
ÙÙ *
)
ÙÙ* +
;
ÙÙ+ ,
set
ıı 
=>
ıı 
SetValue
ıı 
(
ıı  
HasWarningProperty
ıı *
,
ıı* +
value
ıı, 1
)
ıı1 2
;
ıı2 3
}
ˆˆ 
public
¯¯ 

event
¯¯ 
EventHandler
¯¯ 
<
¯¯ (
CharacterRejectedEventArgs
¯¯ 8
>
¯¯8 9
CharacterRejected
¯¯: K
{
˘˘ 
add
˙˙ 
=>
˙˙ 

AddHandler
˙˙ 
(
˙˙ $
CharacterRejectedEvent
˙˙ 0
,
˙˙0 1
value
˙˙2 7
)
˙˙7 8
;
˙˙8 9
remove
˚˚ 
=>
˚˚ 
RemoveHandler
˚˚ 
(
˚˚  $
CharacterRejectedEvent
˚˚  6
,
˚˚6 7
value
˚˚8 =
)
˚˚= >
;
˚˚> ?
}
¸¸ 
public
˛˛ 

event
˛˛ 
EventHandler
˛˛ 
<
˛˛ /
!SecureKeyCharactersAddedEventArgs
˛˛ ?
>
˛˛? @&
SecureKeyCharactersAdded
˛˛A Y
{
ˇˇ 
add
ÄÄ 
=>
ÄÄ 

AddHandler
ÄÄ 
(
ÄÄ +
SecureKeyCharactersAddedEvent
ÄÄ 7
,
ÄÄ7 8
value
ÄÄ9 >
)
ÄÄ> ?
;
ÄÄ? @
remove
ÅÅ 
=>
ÅÅ 
RemoveHandler
ÅÅ 
(
ÅÅ  +
SecureKeyCharactersAddedEvent
ÅÅ  =
,
ÅÅ= >
value
ÅÅ? D
)
ÅÅD E
;
ÅÅE F
}
ÇÇ 
public
ÑÑ 

event
ÑÑ 
EventHandler
ÑÑ 
<
ÑÑ 1
#SecureKeyCharactersRemovedEventArgs
ÑÑ A
>
ÑÑA B(
SecureKeyCharactersRemoved
ÑÑC ]
{
ÖÖ 
add
ÜÜ 
=>
ÜÜ 

AddHandler
ÜÜ 
(
ÜÜ -
SecureKeyCharactersRemovedEvent
ÜÜ 9
,
ÜÜ9 :
value
ÜÜ; @
)
ÜÜ@ A
;
ÜÜA B
remove
áá 
=>
áá 
RemoveHandler
áá 
(
áá  -
SecureKeyCharactersRemovedEvent
áá  ?
,
áá? @
value
ááA F
)
ááF G
;
ááG H
}
àà 
public
ää 

void
ää  
SyncSecureKeyState
ää "
(
ää" #
int
ää# & 
newSecureKeyLength
ää' 9
)
ää9 :
{
ãã 
if
åå 

(
åå 
_mainTextBox
åå 
==
åå 
null
åå  
)
åå  !
{
çç 	
return
éé 
;
éé 
}
èè 	
string
ëë 
maskText
ëë 
=
ëë  
newSecureKeyLength
ëë ,
>
ëë- .
$num
ëë/ 0
?
íí 
new
íí 
string
íí 
(
íí 
SecureKeyMaskChar
íí *
,
íí* + 
newSecureKeyLength
íí, >
)
íí> ?
:
ìì 
string
ìì 
.
ìì 
Empty
ìì 
;
ìì 
_mainTextBox
ïï 
.
ïï 
PasswordChar
ïï !
=
ïï" #$
HintedTextBoxConstants
ïï$ :
.
ïï: ; 
NO_SECURE_KEY_CHAR
ïï; M
;
ïïM N
int
óó 
caretPosition
óó 
=
óó 
Math
óó  
.
óó  !
Clamp
óó! &
(
óó& '$
_intendedCaretPosition
óó' =
,
óó= >
$num
óó? @
,
óó@ A 
newSecureKeyLength
óóB T
)
óóT U
;
óóU V
UpdateTextBox
òò 
(
òò 
maskText
òò 
,
òò 
caretPosition
òò  -
)
òò- .
;
òò. /'
UpdateRemainingCharacters
ôô !
(
ôô! "
)
ôô" #
;
ôô# $
}
öö 
	protected
úú 
override
úú 
void
úú &
OnDetachedFromVisualTree
úú 4
(
úú4 5+
VisualTreeAttachmentEventArgs
úú5 R
e
úúS T
)
úúT U
{
ùù 
Dispose
ûû 
(
ûû 
)
ûû 
;
ûû 
base
üü 
.
üü &
OnDetachedFromVisualTree
üü %
(
üü% &
e
üü& '
)
üü' (
;
üü( )
}
†† 
public
¢¢ 

void
¢¢ 
Dispose
¢¢ 
(
¢¢ 
)
¢¢ 
{
££ 
if
§§ 

(
§§ 
_isDisposed
§§ 
)
§§ 
{
•• 	
return
¶¶ 
;
¶¶ 
}
ßß 	
try
©© 
{
™™ 	
_isDisposed
´´ 
=
´´ 
true
´´ 
;
´´ 
if
≠≠ 
(
≠≠ !
_inputDebounceTimer
≠≠ #
!=
≠≠$ &
null
≠≠' +
)
≠≠+ ,
{
ÆÆ !
_inputDebounceTimer
ØØ #
.
ØØ# $
Stop
ØØ$ (
(
ØØ( )
)
ØØ) *
;
ØØ* +!
_inputDebounceTimer
∞∞ #
.
∞∞# $
Tick
∞∞$ (
-=
∞∞) +!
OnDebounceTimerTick
∞∞, ?
;
∞∞? @!
_inputDebounceTimer
±± #
=
±±$ %
null
±±& *
;
±±* +
}
≤≤ 
if
¥¥ 
(
¥¥ %
_secureKeyDebounceTimer
¥¥ '
!=
¥¥( *
null
¥¥+ /
)
¥¥/ 0
{
µµ %
_secureKeyDebounceTimer
∂∂ '
.
∂∂' (
Stop
∂∂( ,
(
∂∂, -
)
∂∂- .
;
∂∂. /%
_secureKeyDebounceTimer
∑∑ '
.
∑∑' (
Tick
∑∑( ,
-=
∑∑- /*
OnSecureKeyDebounceTimerTick
∑∑0 L
;
∑∑L M%
_secureKeyDebounceTimer
∏∏ '
=
∏∏( )
null
∏∏* .
;
∏∏. /
}
ππ 
if
ªª 
(
ªª 
_warningTimer
ªª 
!=
ªª  
null
ªª! %
)
ªª% &
{
ºº 
_warningTimer
ΩΩ 
.
ΩΩ 
Stop
ΩΩ "
(
ΩΩ" #
)
ΩΩ# $
;
ΩΩ$ %
_warningTimer
ææ 
.
ææ 
Tick
ææ "
-=
ææ# % 
OnWarningTimerTick
ææ& 8
;
ææ8 9
_warningTimer
øø 
=
øø 
null
øø  $
;
øø$ %
}
¿¿ %
_currentTypingAnimation
¬¬ #
?
¬¬# $
.
¬¬$ %
Dispose
¬¬% ,
(
¬¬, -
)
¬¬- .
;
¬¬. /"
AttachedToVisualTree
ƒƒ  
-=
ƒƒ! #$
OnAttachedToVisualTree
ƒƒ$ :
;
ƒƒ: ;
try
∆∆ 
{
«« 
_disposables
»» 
.
»» 
Dispose
»» $
(
»»$ %
)
»»% &
;
»»& '
}
…… 
catch
   
(
   
	Exception
   
ex
   
)
    
{
ÀÀ 
System
ÃÃ 
.
ÃÃ 
Diagnostics
ÃÃ "
.
ÃÃ" #
Debug
ÃÃ# (
.
ÃÃ( )
	WriteLine
ÃÃ) 2
(
ÃÃ2 3
$"
ÃÃ3 5
$str
ÃÃ5 T
{
ÃÃT U
ex
ÃÃU W
.
ÃÃW X
Message
ÃÃX _
}
ÃÃ_ `
"
ÃÃ` a
)
ÃÃa b
;
ÃÃb c
}
ÕÕ 
_mainTextBox
œœ 
=
œœ 
null
œœ 
;
œœ  
_focusBorder
–– 
=
–– 
null
–– 
;
––  
_mainBorder
—— 
=
—— 
null
—— 
;
—— 
_shadowBorder
““ 
=
““ 
null
““  
;
““  ! 
_lastProcessedText
‘‘ 
=
‘‘  
string
‘‘! '
.
‘‘' (
Empty
‘‘( -
;
‘‘- .,
_lastProcessedTextElementCount
’’ *
=
’’+ ,
$num
’’- .
;
’’. /*
_isProcessingSecureKeyChange
÷÷ (
=
÷÷) *
false
÷÷+ 0
;
÷÷0 1$
_intendedCaretPosition
◊◊ "
=
◊◊# $
$num
◊◊% &
;
◊◊& '
	ErrorText
ŸŸ 
=
ŸŸ 
string
ŸŸ 
.
ŸŸ 
Empty
ŸŸ $
;
ŸŸ$ %
HasError
⁄⁄ 
=
⁄⁄ 
false
⁄⁄ 
;
⁄⁄ 
}
€€ 	
catch
‹‹ 
(
‹‹ 
	Exception
‹‹ 
ex
‹‹ 
)
‹‹ 
{
›› 	
System
ﬁﬁ 
.
ﬁﬁ 
Diagnostics
ﬁﬁ 
.
ﬁﬁ 
Debug
ﬁﬁ $
.
ﬁﬁ$ %
	WriteLine
ﬁﬁ% .
(
ﬁﬁ. /
$"
ﬁﬁ/ 1
$str
ﬁﬁ1 C
{
ﬁﬁC D
ex
ﬁﬁD F
.
ﬁﬁF G
Message
ﬁﬁG N
}
ﬁﬁN O
"
ﬁﬁO P
)
ﬁﬁP Q
;
ﬁﬁQ R
}
ﬂﬂ 	
}
‡‡ 
private
‚‚ 
static
‚‚ "
CharacterWarningType
‚‚ '
GetWarningType
‚‚( 6
(
‚‚6 7
char
‚‚7 ;
c
‚‚< =
)
‚‚= >
{
„„ 
if
‰‰ 

(
‰‰ 
char
‰‰ 
.
‰‰ 
IsLetter
‰‰ 
(
‰‰ 
c
‰‰ 
)
‰‰ 
&&
‰‰ 
!
‰‰  !
(
‰‰! "
(
‰‰" #
c
‰‰# $
>=
‰‰% '
$char
‰‰( +
&&
‰‰, .
c
‰‰/ 0
<=
‰‰1 3
$char
‰‰4 7
)
‰‰7 8
||
‰‰9 ;
(
‰‰< =
c
‰‰= >
>=
‰‰? A
$char
‰‰B E
&&
‰‰F H
c
‰‰I J
<=
‰‰K M
$char
‰‰N Q
)
‰‰Q R
)
‰‰R S
)
‰‰S T
{
ÂÂ 	
return
ÊÊ "
CharacterWarningType
ÊÊ '
.
ÊÊ' (
NonLatinLetter
ÊÊ( 6
;
ÊÊ6 7
}
ÁÁ 	
return
ÈÈ "
CharacterWarningType
ÈÈ #
.
ÈÈ# $
InvalidCharacter
ÈÈ$ 4
;
ÈÈ4 5
}
ÍÍ 
private
ÏÏ 
static
ÏÏ 
bool
ÏÏ  
IsAllowedCharacter
ÏÏ *
(
ÏÏ* +
char
ÏÏ+ /
c
ÏÏ0 1
)
ÏÏ1 2
{
ÌÌ 
if
ÓÓ 

(
ÓÓ 
char
ÓÓ 
.
ÓÓ 
IsDigit
ÓÓ 
(
ÓÓ 
c
ÓÓ 
)
ÓÓ 
)
ÓÓ 
{
ÔÔ 	
return
 
true
 
;
 
}
ÒÒ 	
if
ÛÛ 

(
ÛÛ 
(
ÛÛ 
c
ÛÛ 
>=
ÛÛ 
$char
ÛÛ 
&&
ÛÛ 
c
ÛÛ 
<=
ÛÛ 
$char
ÛÛ !
)
ÛÛ! "
||
ÛÛ# %
(
ÛÛ& '
c
ÛÛ' (
>=
ÛÛ) +
$char
ÛÛ, /
&&
ÛÛ0 2
c
ÛÛ3 4
<=
ÛÛ5 7
$char
ÛÛ8 ;
)
ÛÛ; <
)
ÛÛ< =
{
ÙÙ 	
return
ıı 
true
ıı 
;
ıı 
}
ˆˆ 	
if
¯¯ 

(
¯¯ 
!
¯¯ 
char
¯¯ 
.
¯¯ 
IsLetter
¯¯ 
(
¯¯ 
c
¯¯ 
)
¯¯ 
&&
¯¯  
!
¯¯! "
char
¯¯" &
.
¯¯& '
IsDigit
¯¯' .
(
¯¯. /
c
¯¯/ 0
)
¯¯0 1
)
¯¯1 2
{
˘˘ 	
return
˙˙ 
true
˙˙ 
;
˙˙ 
}
˚˚ 	
return
˝˝ 
false
˝˝ 
;
˝˝ 
}
˛˛ 
private
ÄÄ 
static
ÄÄ 
(
ÄÄ 
Color
ÄÄ 
BorderColor
ÄÄ %
,
ÄÄ% &
string
ÄÄ' -
	ShadowKey
ÄÄ. 7
,
ÄÄ7 8
Color
ÄÄ9 >
	IconColor
ÄÄ? H
)
ÄÄH I(
GetSecureKeyStrengthColors
ÄÄJ d
(
ÄÄd e
SecureKeyStrength
ÅÅ 
strength
ÅÅ "
)
ÅÅ" #
{
ÇÇ 
return
ÉÉ 
strength
ÉÉ 
switch
ÉÉ 
{
ÑÑ 	
SecureKeyStrength
ÖÖ 
.
ÖÖ 
Invalid
ÖÖ %
=>
ÖÖ& (
(
ÖÖ) *
GetCachedColor
ÖÖ* 8
(
ÖÖ8 9$
HintedTextBoxConstants
ÖÖ9 O
.
ÖÖO P(
INVALID_STRENGTH_COLOR_HEX
ÖÖP j
)
ÖÖj k
,
ÖÖk l$
HintedTextBoxConstants
ÜÜ &
.
ÜÜ& ')
INVALID_STRENGTH_SHADOW_KEY
ÜÜ' B
,
ÜÜB C
GetCachedColor
áá 
(
áá $
HintedTextBoxConstants
áá 5
.
áá5 6(
INVALID_STRENGTH_COLOR_HEX
áá6 P
)
ááP Q
)
ááQ R
,
ááR S
SecureKeyStrength
àà 
.
àà 
VeryWeak
àà &
=>
àà' )
(
àà* +
GetCachedColor
àà+ 9
(
àà9 :$
HintedTextBoxConstants
àà: P
.
ààP Q*
VERY_WEAK_STRENGTH_COLOR_HEX
ààQ m
)
ààm n
,
ààn o$
HintedTextBoxConstants
ââ &
.
ââ& '+
VERY_WEAK_STRENGTH_SHADOW_KEY
ââ' D
,
ââD E
GetCachedColor
ää 
(
ää $
HintedTextBoxConstants
ää 5
.
ää5 6*
VERY_WEAK_STRENGTH_COLOR_HEX
ää6 R
)
ääR S
)
ääS T
,
ääT U
SecureKeyStrength
ãã 
.
ãã 
Weak
ãã "
=>
ãã# %
(
ãã& '
GetCachedColor
ãã' 5
(
ãã5 6$
HintedTextBoxConstants
ãã6 L
.
ããL M%
WEAK_STRENGTH_COLOR_HEX
ããM d
)
ããd e
,
ããe f$
HintedTextBoxConstants
åå &
.
åå& '&
WEAK_STRENGTH_SHADOW_KEY
åå' ?
,
åå? @
GetCachedColor
çç 
(
çç $
HintedTextBoxConstants
çç 5
.
çç5 6%
WEAK_STRENGTH_COLOR_HEX
çç6 M
)
ççM N
)
ççN O
,
ççO P
SecureKeyStrength
éé 
.
éé 
Good
éé "
=>
éé# %
(
éé& '
GetCachedColor
éé' 5
(
éé5 6$
HintedTextBoxConstants
éé6 L
.
ééL M%
GOOD_STRENGTH_COLOR_HEX
ééM d
)
ééd e
,
éée f$
HintedTextBoxConstants
èè &
.
èè& '&
GOOD_STRENGTH_SHADOW_KEY
èè' ?
,
èè? @
GetCachedColor
êê 
(
êê $
HintedTextBoxConstants
êê 5
.
êê5 6%
GOOD_STRENGTH_COLOR_HEX
êê6 M
)
êêM N
)
êêN O
,
êêO P
SecureKeyStrength
ëë 
.
ëë 
Strong
ëë $
=>
ëë% '
(
ëë( )
GetCachedColor
ëë) 7
(
ëë7 8$
HintedTextBoxConstants
ëë8 N
.
ëëN O'
STRONG_STRENGTH_COLOR_HEX
ëëO h
)
ëëh i
,
ëëi j$
HintedTextBoxConstants
íí &
.
íí& '(
STRONG_STRENGTH_SHADOW_KEY
íí' A
,
ííA B
GetCachedColor
ìì 
(
ìì $
HintedTextBoxConstants
ìì 5
.
ìì5 6'
STRONG_STRENGTH_COLOR_HEX
ìì6 O
)
ììO P
)
ììP Q
,
ììQ R
SecureKeyStrength
îî 
.
îî 

VeryStrong
îî (
=>
îî) +
(
îî, -
GetCachedColor
îî- ;
(
îî; <$
HintedTextBoxConstants
îî< R
.
îîR S,
VERY_STRONG_STRENGTH_COLOR_HEX
îîS q
)
îîq r
,
îîr s$
HintedTextBoxConstants
ïï &
.
ïï& '-
VERY_STRONG_STRENGTH_SHADOW_KEY
ïï' F
,
ïïF G
GetCachedColor
ññ 
(
ññ $
HintedTextBoxConstants
ññ 5
.
ññ5 6,
VERY_STRONG_STRENGTH_COLOR_HEX
ññ6 T
)
ññT U
)
ññU V
,
ññV W
_
óó 
=>
óó 
(
óó 
GetCachedColor
óó  
(
óó  !$
HintedTextBoxConstants
óó! 7
.
óó7 8(
INVALID_STRENGTH_COLOR_HEX
óó8 R
)
óóR S
,
óóS T$
HintedTextBoxConstants
òò &
.
òò& ')
INVALID_STRENGTH_SHADOW_KEY
òò' B
,
òòB C
GetCachedColor
ôô 
(
ôô $
HintedTextBoxConstants
ôô 5
.
ôô5 6(
INVALID_STRENGTH_COLOR_HEX
ôô6 P
)
ôôP Q
)
ôôQ R
}
öö 	
;
öö	 

}
õõ 
private
ùù 
static
ùù 
int
ùù !
GetTextElementCount
ùù *
(
ùù* +
string
ùù+ 1
text
ùù2 6
)
ùù6 7
{
ûû 
if
üü 

(
üü 
string
üü 
.
üü 
IsNullOrEmpty
üü  
(
üü  !
text
üü! %
)
üü% &
)
üü& '
{
†† 	
return
°° 
$num
°° 
;
°° 
}
¢¢ 	
if
§§ 

(
§§ #
TextElementCountCache
§§ !
.
§§! "
TryGetValue
§§" -
(
§§- .
text
§§. 2
,
§§2 3
out
§§4 7
int
§§8 ;
cachedCount
§§< G
)
§§G H
)
§§H I
{
•• 	
return
¶¶ 
cachedCount
¶¶ 
;
¶¶ 
}
ßß 	
try
©© 
{
™™ 	

StringInfo
´´ 

stringInfo
´´ !
=
´´" #
new
´´$ '
(
´´' (
text
´´( ,
)
´´, -
;
´´- .
int
¨¨ 
count
¨¨ 
=
¨¨ 

stringInfo
¨¨ "
.
¨¨" #"
LengthInTextElements
¨¨# 7
;
¨¨7 8
switch
ÆÆ 
(
ÆÆ #
TextElementCountCache
ÆÆ )
.
ÆÆ) *
Count
ÆÆ* /
)
ÆÆ/ 0
{
ØØ 
case
∞∞ 
<
∞∞ )
MAX_TEXT_ELEMENT_CACHE_SIZE
∞∞ 2
:
∞∞2 3#
TextElementCountCache
±± )
[
±±) *
text
±±* .
]
±±. /
=
±±0 1
count
±±2 7
;
±±7 8
break
≤≤ 
;
≤≤ 
case
≥≥ 
>
≥≥ )
MAX_TEXT_ELEMENT_CACHE_SIZE
≥≥ 2
:
≥≥2 3#
TextElementCountCache
¥¥ )
.
¥¥) *
Clear
¥¥* /
(
¥¥/ 0
)
¥¥0 1
;
¥¥1 2#
TextElementCountCache
µµ )
[
µµ) *
text
µµ* .
]
µµ. /
=
µµ0 1
count
µµ2 7
;
µµ7 8
break
∂∂ 
;
∂∂ 
}
∑∑ 
return
ππ 
count
ππ 
;
ππ 
}
∫∫ 	
catch
ªª 
(
ªª 
	Exception
ªª 
ex
ªª 
)
ªª 
{
ºº 	
System
ΩΩ 
.
ΩΩ 
Diagnostics
ΩΩ 
.
ΩΩ 
Debug
ΩΩ $
.
ΩΩ$ %
	WriteLine
ΩΩ% .
(
ΩΩ. /
$"
ΩΩ/ 1
$str
ΩΩ1 t
{
ΩΩt u
ex
ΩΩu w
.
ΩΩw x
Message
ΩΩx 
}ΩΩ Ä
"ΩΩÄ Å
)ΩΩÅ Ç
;ΩΩÇ É
int
ææ 
fallbackCount
ææ 
=
ææ 
text
ææ  $
.
ææ$ %
Length
ææ% +
;
ææ+ ,
if
øø 
(
øø #
TextElementCountCache
øø %
.
øø% &
Count
øø& +
<
øø, -)
MAX_TEXT_ELEMENT_CACHE_SIZE
øø. I
)
øøI J
{
¿¿ #
TextElementCountCache
¡¡ %
[
¡¡% &
text
¡¡& *
]
¡¡* +
=
¡¡, -
fallbackCount
¡¡. ;
;
¡¡; <
}
¬¬ 
return
ƒƒ 
fallbackCount
ƒƒ  
;
ƒƒ  !
}
≈≈ 	
}
∆∆ 
private
»» 
static
»» 
string
»» 
SafeSubstring
»» '
(
»»' (
string
»»( .
text
»»/ 3
,
»»3 4
int
»»5 8

startIndex
»»9 C
,
»»C D
int
»»E H
length
»»I O
)
»»O P
{
…… 
if
   

(
   
string
   
.
   
IsNullOrEmpty
    
(
    !
text
  ! %
)
  % &
||
  ' )

startIndex
  * 4
<
  5 6
$num
  7 8
)
  8 9
{
ÀÀ 	
return
ÃÃ 
string
ÃÃ 
.
ÃÃ 
Empty
ÃÃ 
;
ÃÃ  
}
ÕÕ 	
try
œœ 
{
–– 	

StringInfo
—— 

stringInfo
—— !
=
——" #
new
——$ '
(
——' (
text
——( ,
)
——, -
;
——- .
int
““ 
textElementCount
““  
=
““! "

stringInfo
““# -
.
““- ."
LengthInTextElements
““. B
;
““B C
if
‘‘ 
(
‘‘ 

startIndex
‘‘ 
>=
‘‘ 
textElementCount
‘‘ .
)
‘‘. /
{
’’ 
return
÷÷ 
string
÷÷ 
.
÷÷ 
Empty
÷÷ #
;
÷÷# $
}
◊◊ 
int
ŸŸ 
actualLength
ŸŸ 
=
ŸŸ 
Math
ŸŸ #
.
ŸŸ# $
Min
ŸŸ$ '
(
ŸŸ' (
length
ŸŸ( .
,
ŸŸ. /
textElementCount
ŸŸ0 @
-
ŸŸA B

startIndex
ŸŸC M
)
ŸŸM N
;
ŸŸN O
return
⁄⁄ 
actualLength
⁄⁄ 
<=
⁄⁄  "
$num
⁄⁄# $
?
⁄⁄% &
string
⁄⁄' -
.
⁄⁄- .
Empty
⁄⁄. 3
:
⁄⁄4 5

stringInfo
⁄⁄6 @
.
⁄⁄@ A%
SubstringByTextElements
⁄⁄A X
(
⁄⁄X Y

startIndex
⁄⁄Y c
,
⁄⁄c d
actualLength
⁄⁄e q
)
⁄⁄q r
;
⁄⁄r s
}
€€ 	
catch
‹‹ 
(
‹‹ 
	Exception
‹‹ 
ex
‹‹ 
)
‹‹ 
{
›› 	
System
ﬁﬁ 
.
ﬁﬁ 
Diagnostics
ﬁﬁ 
.
ﬁﬁ 
Debug
ﬁﬁ $
.
ﬁﬁ$ %
	WriteLine
ﬁﬁ% .
(
ﬁﬁ. /
$"
ﬁﬁ/ 1
$strﬁﬁ1 Ç
{ﬁﬁÇ É
exﬁﬁÉ Ö
.ﬁﬁÖ Ü
MessageﬁﬁÜ ç
}ﬁﬁç é
"ﬁﬁé è
)ﬁﬁè ê
;ﬁﬁê ë
try
ﬂﬂ 
{
‡‡ 
int
·· 
	safeStart
·· 
=
·· 
Math
··  $
.
··$ %
Min
··% (
(
··( )

startIndex
··) 3
,
··3 4
text
··5 9
.
··9 :
Length
··: @
)
··@ A
;
··A B
int
‚‚ 

safeLength
‚‚ 
=
‚‚  
Math
‚‚! %
.
‚‚% &
Min
‚‚& )
(
‚‚) *
length
‚‚* 0
,
‚‚0 1
text
‚‚2 6
.
‚‚6 7
Length
‚‚7 =
-
‚‚> ?
	safeStart
‚‚@ I
)
‚‚I J
;
‚‚J K
return
„„ 

safeLength
„„ !
>
„„" #
$num
„„$ %
?
„„& '
text
„„( ,
.
„„, -
	Substring
„„- 6
(
„„6 7
	safeStart
„„7 @
,
„„@ A

safeLength
„„B L
)
„„L M
:
„„N O
string
„„P V
.
„„V W
Empty
„„W \
;
„„\ ]
}
‰‰ 
catch
ÂÂ 
(
ÂÂ 
	Exception
ÂÂ 
ex2
ÂÂ  
)
ÂÂ  !
{
ÊÊ 
System
ÁÁ 
.
ÁÁ 
Diagnostics
ÁÁ "
.
ÁÁ" #
Debug
ÁÁ# (
.
ÁÁ( )
	WriteLine
ÁÁ) 2
(
ÁÁ2 3
$"
ÁÁ3 5
$str
ÁÁ5 l
{
ÁÁl m
ex2
ÁÁm p
.
ÁÁp q
Message
ÁÁq x
}
ÁÁx y
"
ÁÁy z
)
ÁÁz {
;
ÁÁ{ |
return
ËË 
string
ËË 
.
ËË 
Empty
ËË #
;
ËË# $
}
ÈÈ 
}
ÍÍ 	
}
ÎÎ 
private
ÌÌ 
static
ÌÌ 
string
ÌÌ "
GetAddedTextElements
ÌÌ .
(
ÌÌ. /
string
ÌÌ/ 5
?
ÌÌ5 6
currentText
ÌÌ7 B
,
ÌÌB C
string
ÌÌD J
lastText
ÌÌK S
,
ÌÌS T
int
ÌÌU X

caretIndex
ÌÌY c
)
ÌÌc d
{
ÓÓ 
if
ÔÔ 

(
ÔÔ 
string
ÔÔ 
.
ÔÔ 
IsNullOrEmpty
ÔÔ  
(
ÔÔ  !
currentText
ÔÔ! ,
)
ÔÔ, -
||
ÔÔ. 0
string
ÔÔ1 7
.
ÔÔ7 8
IsNullOrEmpty
ÔÔ8 E
(
ÔÔE F
lastText
ÔÔF N
)
ÔÔN O
)
ÔÔO P
{
 	
return
ÒÒ 
currentText
ÒÒ 
??
ÒÒ !
string
ÒÒ" (
.
ÒÒ( )
Empty
ÒÒ) .
;
ÒÒ. /
}
ÚÚ 	
try
ÙÙ 
{
ıı 	

StringInfo
ˆˆ 
currentInfo
ˆˆ "
=
ˆˆ# $
new
ˆˆ% (
(
ˆˆ( )
currentText
ˆˆ) 4
)
ˆˆ4 5
;
ˆˆ5 6

StringInfo
˜˜ 
lastInfo
˜˜ 
=
˜˜  !
new
˜˜" %
(
˜˜% &
lastText
˜˜& .
)
˜˜. /
;
˜˜/ 0
int
˘˘ 
currentCount
˘˘ 
=
˘˘ 
currentInfo
˘˘ *
.
˘˘* +"
LengthInTextElements
˘˘+ ?
;
˘˘? @
int
˙˙ 
	lastCount
˙˙ 
=
˙˙ 
lastInfo
˙˙ $
.
˙˙$ %"
LengthInTextElements
˙˙% 9
;
˙˙9 :
if
¸¸ 
(
¸¸ 
currentCount
¸¸ 
<=
¸¸ 
	lastCount
¸¸  )
)
¸¸) *
{
˝˝ 
return
˛˛ 
string
˛˛ 
.
˛˛ 
Empty
˛˛ #
;
˛˛# $
}
ˇˇ 
int
ÅÅ 

addedCount
ÅÅ 
=
ÅÅ 
currentCount
ÅÅ )
-
ÅÅ* +
	lastCount
ÅÅ, 5
;
ÅÅ5 6
int
ÇÇ 
	insertPos
ÇÇ 
=
ÇÇ 
Math
ÇÇ  
.
ÇÇ  !
Max
ÇÇ! $
(
ÇÇ$ %
$num
ÇÇ% &
,
ÇÇ& '
Math
ÇÇ( ,
.
ÇÇ, -
Min
ÇÇ- 0
(
ÇÇ0 1

caretIndex
ÇÇ1 ;
-
ÇÇ< =

addedCount
ÇÇ> H
,
ÇÇH I
currentCount
ÇÇJ V
-
ÇÇW X

addedCount
ÇÇY c
)
ÇÇc d
)
ÇÇd e
;
ÇÇe f
return
ÑÑ 
SafeSubstring
ÑÑ  
(
ÑÑ  !
currentText
ÑÑ! ,
,
ÑÑ, -
	insertPos
ÑÑ. 7
,
ÑÑ7 8

addedCount
ÑÑ9 C
)
ÑÑC D
;
ÑÑD E
}
ÖÖ 	
catch
ÜÜ 
(
ÜÜ 
	Exception
ÜÜ 
ex
ÜÜ 
)
ÜÜ 
{
áá 	
System
àà 
.
àà 
Diagnostics
àà 
.
àà 
Debug
àà $
.
àà$ %
	WriteLine
àà% .
(
àà. /
$"
àà/ 1
$str
àà1 
{àà Ä
exààÄ Ç
.ààÇ É
MessageààÉ ä
}ààä ã
"ààã å
)ààå ç
;ààç é
int
ââ 

addedCount
ââ 
=
ââ 
currentText
ââ (
.
ââ( )
Length
ââ) /
-
ââ0 1
lastText
ââ2 :
.
ââ: ;
Length
ââ; A
;
ââA B
if
ää 
(
ää 

addedCount
ää 
<=
ää 
$num
ää 
)
ää  
{
ãã 
return
åå 
string
åå 
.
åå 
Empty
åå #
;
åå# $
}
çç 
int
èè 
	insertPos
èè 
=
èè 
Math
èè  
.
èè  !
Max
èè! $
(
èè$ %
$num
èè% &
,
èè& '

caretIndex
èè( 2
-
èè3 4

addedCount
èè5 ?
)
èè? @
;
èè@ A
return
êê 
SafeSubstring
êê  
(
êê  !
currentText
êê! ,
,
êê, -
	insertPos
êê. 7
,
êê7 8

addedCount
êê9 C
)
êêC D
;
êêD E
}
ëë 	
}
íí 
private
îî 
static
îî 
Color
îî 
GetCachedColor
îî '
(
îî' (
string
îî( .
colorHex
îî/ 7
)
îî7 8
{
ïï 
if
ññ 

(
ññ 

ColorCache
ññ 
.
ññ 
TryGetValue
ññ "
(
ññ" #
colorHex
ññ# +
,
ññ+ ,
out
ññ- 0
Color
ññ1 6
color
ññ7 <
)
ññ< =
)
ññ= >
{
óó 	
return
òò 
color
òò 
;
òò 
}
ôô 	
color
öö 
=
öö 
Color
öö 
.
öö 
Parse
öö 
(
öö 
colorHex
öö $
)
öö$ %
;
öö% &

ColorCache
õõ 
[
õõ 
colorHex
õõ 
]
õõ 
=
õõ 
color
õõ $
;
õõ$ %
return
ùù 
color
ùù 
;
ùù 
}
ûû 
private
†† 
static
†† 
SolidColorBrush
†† "
GetCachedBrush
††# 1
(
††1 2
Color
††2 7
color
††8 =
)
††= >
{
°° 
string
¢¢ 
key
¢¢ 
=
¢¢ 
color
¢¢ 
.
¢¢ 
ToString
¢¢ #
(
¢¢# $
)
¢¢$ %
;
¢¢% &
if
££ 

(
££ 

BrushCache
££ 
.
££ 
TryGetValue
££ "
(
££" #
key
££# &
,
££& '
out
££( +
SolidColorBrush
££, ;
?
££; <
brush
££= B
)
££B C
)
££C D
{
§§ 	
return
•• 
brush
•• 
;
•• 
}
¶¶ 	
brush
ßß 
=
ßß 
new
ßß 
SolidColorBrush
ßß #
(
ßß# $
color
ßß$ )
)
ßß) *
;
ßß* +

BrushCache
®® 
[
®® 
key
®® 
]
®® 
=
®® 
brush
®® 
;
®®  
return
™™ 
brush
™™ 
;
™™ 
}
´´ 
private
≠≠ 
void
≠≠ $
OnAttachedToVisualTree
≠≠ '
(
≠≠' (
object
≠≠( .
?
≠≠. /
sender
≠≠0 6
,
≠≠6 7+
VisualTreeAttachmentEventArgs
≠≠8 U
e
≠≠V W
)
≠≠W X
{
ÆÆ 
if
ØØ 

(
ØØ #
_isControlInitialized
ØØ !
||
ØØ" $
_isDisposed
ØØ% 0
)
ØØ0 1
{
∞∞ 	
return
±± 
;
±± 
}
≤≤ 	

Initialize
≥≥ 
(
≥≥ 
)
≥≥ 
;
≥≥ 
}
¥¥ 
private
∂∂ 
void
∂∂ 

Initialize
∂∂ 
(
∂∂ 
)
∂∂ 
{
∑∑ 
if
∏∏ 

(
∏∏ #
_isControlInitialized
∏∏ !
)
∏∏! "
{
ππ 	
return
∫∫ 
;
∫∫ 
}
ªª 	
FindControls
ΩΩ 
(
ΩΩ 
)
ΩΩ 
;
ΩΩ 
if
ææ 

(
ææ 
_mainTextBox
ææ 
==
ææ 
null
ææ  
)
ææ  !
{
øø 	
return
¿¿ 
;
¿¿ 
}
¡¡ 	
_mainTextBox
√√ 
.
√√ 
TextChanged
√√  
+=
√√! #
OnTextChanged
√√$ 1
;
√√1 2
_mainTextBox
ƒƒ 
.
ƒƒ 
GotFocus
ƒƒ 
+=
ƒƒ  

OnGotFocus
ƒƒ! +
;
ƒƒ+ ,
_mainTextBox
≈≈ 
.
≈≈ 
	LostFocus
≈≈ 
+=
≈≈ !
OnLostFocus
≈≈" -
;
≈≈- .
if
«« 

(
«« 
IsSecureKeyMode
«« 
)
«« 
{
»» 	(
DisableClipboardOperations
…… &
(
……& '
)
……' (
;
……( )
}
   	
_disposables
ÃÃ 
.
ÃÃ 
Add
ÃÃ 
(
ÃÃ 

Disposable
ÃÃ #
.
ÃÃ# $
Create
ÃÃ$ *
(
ÃÃ* +&
UnsubscribeTextBoxEvents
ÃÃ+ C
)
ÃÃC D
)
ÃÃD E
;
ÃÃE F#
SetupReactiveBindings
ŒŒ 
(
ŒŒ 
)
ŒŒ 
;
ŒŒ  
UpdateBorderState
œœ 
(
œœ 
)
œœ 
;
œœ #
_isControlInitialized
–– 
=
–– 
true
––  $
;
––$ %
}
—— 
private
”” 
void
”” (
DisableClipboardOperations
”” +
(
””+ ,
)
””, -
{
‘‘ 
if
’’ 

(
’’ 
_mainTextBox
’’ 
==
’’ 
null
’’  
)
’’  !
{
÷÷ 	
return
◊◊ 
;
◊◊ 
}
ÿÿ 	
_mainTextBox
⁄⁄ 
.
⁄⁄ 

AddHandler
⁄⁄ 
(
⁄⁄  
TextInputEvent
⁄⁄  .
,
⁄⁄. /
OnTextInput
⁄⁄0 ;
,
⁄⁄; <
RoutingStrategies
⁄⁄= N
.
⁄⁄N O
Tunnel
⁄⁄O U
)
⁄⁄U V
;
⁄⁄V W
_mainTextBox
€€ 
.
€€ 

AddHandler
€€ 
(
€€  
KeyDownEvent
€€  ,
,
€€, -
OnPreviewKeyDown
€€. >
,
€€> ?
RoutingStrategies
€€@ Q
.
€€Q R
Tunnel
€€R X
)
€€X Y
;
€€Y Z
_mainTextBox
›› 
.
›› 

AddHandler
›› 
(
››  !
PointerPressedEvent
››  3
,
››3 4
OnPointerPressed
››5 E
,
››E F
RoutingStrategies
››G X
.
››X Y
Tunnel
››Y _
)
››_ `
;
››` a
_mainTextBox
ﬁﬁ 
.
ﬁﬁ 

AddHandler
ﬁﬁ 
(
ﬁﬁ  
PointerMovedEvent
ﬁﬁ  1
,
ﬁﬁ1 2
OnPointerMoved
ﬁﬁ3 A
,
ﬁﬁA B
RoutingStrategies
ﬁﬁC T
.
ﬁﬁT U
Tunnel
ﬁﬁU [
)
ﬁﬁ[ \
;
ﬁﬁ\ ]
_mainTextBox
ﬂﬂ 
.
ﬂﬂ 

AddHandler
ﬂﬂ 
(
ﬂﬂ  "
PointerReleasedEvent
ﬂﬂ  4
,
ﬂﬂ4 5
OnPointerReleased
ﬂﬂ6 G
,
ﬂﬂG H
RoutingStrategies
ﬂﬂI Z
.
ﬂﬂZ [
Tunnel
ﬂﬂ[ a
)
ﬂﬂa b
;
ﬂﬂb c
_mainTextBox
·· 
.
·· 

AddHandler
·· 
(
··  
DragDrop
··  (
.
··( )
DragEnterEvent
··) 7
,
··7 8
OnDragEnter
··9 D
,
··D E
RoutingStrategies
··F W
.
··W X
Tunnel
··X ^
)
··^ _
;
··_ `
_mainTextBox
‚‚ 
.
‚‚ 

AddHandler
‚‚ 
(
‚‚  
DragDrop
‚‚  (
.
‚‚( )
DragOverEvent
‚‚) 6
,
‚‚6 7

OnDragOver
‚‚8 B
,
‚‚B C
RoutingStrategies
‚‚D U
.
‚‚U V
Tunnel
‚‚V \
)
‚‚\ ]
;
‚‚] ^
_mainTextBox
„„ 
.
„„ 

AddHandler
„„ 
(
„„  
DragDrop
„„  (
.
„„( )
	DropEvent
„„) 2
,
„„2 3
OnDrop
„„4 :
,
„„: ;
RoutingStrategies
„„< M
.
„„M N
Tunnel
„„N T
)
„„T U
;
„„U V
_mainTextBox
ÂÂ 
.
ÂÂ 

AddHandler
ÂÂ 
(
ÂÂ  
Gestures
ÂÂ  (
.
ÂÂ( )
TappedEvent
ÂÂ) 4
,
ÂÂ4 5
OnTapped
ÂÂ6 >
,
ÂÂ> ?
RoutingStrategies
ÂÂ@ Q
.
ÂÂQ R
Tunnel
ÂÂR X
)
ÂÂX Y
;
ÂÂY Z
_mainTextBox
ÊÊ 
.
ÊÊ 

AddHandler
ÊÊ 
(
ÊÊ  
Gestures
ÊÊ  (
.
ÊÊ( )
DoubleTappedEvent
ÊÊ) :
,
ÊÊ: ;
OnDoubleTapped
ÊÊ< J
,
ÊÊJ K
RoutingStrategies
ÊÊL ]
.
ÊÊ] ^
Tunnel
ÊÊ^ d
)
ÊÊd e
;
ÊÊe f
_mainTextBox
ÁÁ 
.
ÁÁ 

AddHandler
ÁÁ 
(
ÁÁ  
Gestures
ÁÁ  (
.
ÁÁ( )
HoldingEvent
ÁÁ) 5
,
ÁÁ5 6
	OnHolding
ÁÁ7 @
,
ÁÁ@ A
RoutingStrategies
ÁÁB S
.
ÁÁS T
Tunnel
ÁÁT Z
)
ÁÁZ [
;
ÁÁ[ \
_mainTextBox
ÈÈ 
.
ÈÈ 
SelectionStart
ÈÈ #
=
ÈÈ$ %
$num
ÈÈ& '
;
ÈÈ' (
_mainTextBox
ÍÍ 
.
ÍÍ 
SelectionEnd
ÍÍ !
=
ÍÍ" #
$num
ÍÍ$ %
;
ÍÍ% &
_mainTextBox
ÏÏ 
.
ÏÏ 

IsReadOnly
ÏÏ 
=
ÏÏ  !
false
ÏÏ" '
;
ÏÏ' (
}
ÌÌ 
private
ÔÔ 
void
ÔÔ 
OnPointerReleased
ÔÔ "
(
ÔÔ" #
object
ÔÔ# )
?
ÔÔ) *
sender
ÔÔ+ 1
,
ÔÔ1 2&
PointerReleasedEventArgs
ÔÔ3 K
e
ÔÔL M
)
ÔÔM N
{
 
if
ÒÒ 

(
ÒÒ 
!
ÒÒ 
IsSecureKeyMode
ÒÒ 
)
ÒÒ 
{
ÚÚ 	
return
ÛÛ 
;
ÛÛ 
}
ÙÙ 	
e
ıı 	
.
ıı	 

Handled
ıı
 
=
ıı 
true
ıı 
;
ıı 
if
ˆˆ 

(
ˆˆ 
_mainTextBox
ˆˆ 
!=
ˆˆ 
null
ˆˆ  
)
ˆˆ  !
{
˜˜ 	
_mainTextBox
¯¯ 
.
¯¯ 

CaretIndex
¯¯ #
=
¯¯$ %
_mainTextBox
¯¯& 2
.
¯¯2 3
Text
¯¯3 7
?
¯¯7 8
.
¯¯8 9
Length
¯¯9 ?
??
¯¯@ B
$num
¯¯C D
;
¯¯D E$
_intendedCaretPosition
˘˘ "
=
˘˘# $
_mainTextBox
˘˘% 1
.
˘˘1 2
Text
˘˘2 6
?
˘˘6 7
.
˘˘7 8
Length
˘˘8 >
??
˘˘? A
$num
˘˘B C
;
˘˘C D
}
˙˙ 	
}
˚˚ 
private
˝˝ 
void
˝˝ 
OnTapped
˝˝ 
(
˝˝ 
object
˝˝  
?
˝˝  !
sender
˝˝" (
,
˝˝( )
TappedEventArgs
˝˝* 9
e
˝˝: ;
)
˝˝; <
{
˛˛ 
if
ˇˇ 

(
ˇˇ 
!
ˇˇ 
IsSecureKeyMode
ˇˇ 
||
ˇˇ 
_mainTextBox
ˇˇ  ,
==
ˇˇ- /
null
ˇˇ0 4
)
ˇˇ4 5
{
ÄÄ 	
return
ÅÅ 
;
ÅÅ 
}
ÇÇ 	
e
ÉÉ 	
.
ÉÉ	 

Handled
ÉÉ
 
=
ÉÉ 
true
ÉÉ 
;
ÉÉ 
_mainTextBox
ÖÖ 
.
ÖÖ 
SelectionStart
ÖÖ #
=
ÖÖ$ %
$num
ÖÖ& '
;
ÖÖ' (
_mainTextBox
ÜÜ 
.
ÜÜ 
SelectionEnd
ÜÜ !
=
ÜÜ" #
$num
ÜÜ$ %
;
ÜÜ% &
_mainTextBox
áá 
.
áá 

CaretIndex
áá 
=
áá  !
_mainTextBox
áá" .
.
áá. /
Text
áá/ 3
?
áá3 4
.
áá4 5
Length
áá5 ;
??
áá< >
$num
áá? @
;
áá@ A
if
ââ 

(
ââ 
!
ââ 
_mainTextBox
ââ 
.
ââ 
	IsFocused
ââ #
)
ââ# $
{
ää 	
_mainTextBox
ãã 
.
ãã 
Focus
ãã 
(
ãã 
)
ãã  
;
ãã  !
}
åå 	
}
çç 
private
êê 
void
êê 
OnDoubleTapped
êê 
(
êê  
object
êê  &
?
êê& '
sender
êê( .
,
êê. /
TappedEventArgs
êê0 ?
e
êê@ A
)
êêA B
{
ëë 
if
íí 

(
íí 
!
íí 
IsSecureKeyMode
íí 
)
íí 
{
ìì 	
return
îî 
;
îî 
}
ïï 	
e
ññ 	
.
ññ	 

Handled
ññ
 
=
ññ 
true
ññ 
;
ññ 
if
óó 

(
óó 
_mainTextBox
óó 
!=
óó 
null
óó  
)
óó  !
{
òò 	
_mainTextBox
ôô 
.
ôô 

CaretIndex
ôô #
=
ôô$ %
_mainTextBox
ôô& 2
.
ôô2 3
Text
ôô3 7
?
ôô7 8
.
ôô8 9
Length
ôô9 ?
??
ôô@ B
$num
ôôC D
;
ôôD E
}
öö 	
}
õõ 
private
ùù 
void
ùù 
	OnHolding
ùù 
(
ùù 
object
ùù !
?
ùù! "
sender
ùù# )
,
ùù) *$
HoldingRoutedEventArgs
ùù+ A
e
ùùB C
)
ùùC D
{
ûû 
if
üü 

(
üü 
!
üü 
IsSecureKeyMode
üü 
)
üü 
{
†† 	
return
°° 
;
°° 
}
¢¢ 	
e
££ 	
.
££	 

Handled
££
 
=
££ 
true
££ 
;
££ 
}
§§ 
private
¶¶ 
void
¶¶ 
OnPointerMoved
¶¶ 
(
¶¶  
object
¶¶  &
?
¶¶& '
sender
¶¶( .
,
¶¶. /
PointerEventArgs
¶¶0 @
e
¶¶A B
)
¶¶B C
{
ßß 
if
®® 

(
®® 
!
®® 
IsSecureKeyMode
®® 
||
®® 
_mainTextBox
®®  ,
==
®®- /
null
®®0 4
)
®®4 5
{
©© 	
return
™™ 
;
™™ 
}
´´ 	
e
¨¨ 	
.
¨¨	 

Handled
¨¨
 
=
¨¨ 
true
¨¨ 
;
¨¨ 
}
≠≠ 
private
ØØ 
void
ØØ 
OnDragEnter
ØØ 
(
ØØ 
object
ØØ #
?
ØØ# $
sender
ØØ% +
,
ØØ+ ,
DragEventArgs
ØØ- :
e
ØØ; <
)
ØØ< =
{
∞∞ 
if
±± 

(
±± 
!
±± 
IsSecureKeyMode
±± 
)
±± 
{
≤≤ 	
return
≥≥ 
;
≥≥ 
}
¥¥ 	
e
µµ 	
.
µµ	 

Handled
µµ
 
=
µµ 
true
µµ 
;
µµ 
}
∂∂ 
private
∏∏ 
void
∏∏ 

OnDragOver
∏∏ 
(
∏∏ 
object
∏∏ "
?
∏∏" #
sender
∏∏$ *
,
∏∏* +
DragEventArgs
∏∏, 9
e
∏∏: ;
)
∏∏; <
{
ππ 
if
∫∫ 

(
∫∫ 
!
∫∫ 
IsSecureKeyMode
∫∫ 
)
∫∫ 
{
ªª 	
return
ºº 
;
ºº 
}
ΩΩ 	
e
ææ 	
.
ææ	 

Handled
ææ
 
=
ææ 
true
ææ 
;
ææ 
}
øø 
private
¡¡ 
void
¡¡ 
OnDrop
¡¡ 
(
¡¡ 
object
¡¡ 
?
¡¡ 
sender
¡¡  &
,
¡¡& '
DragEventArgs
¡¡( 5
e
¡¡6 7
)
¡¡7 8
{
¬¬ 
if
√√ 

(
√√ 
!
√√ 
IsSecureKeyMode
√√ 
)
√√ 
{
ƒƒ 	
return
≈≈ 
;
≈≈ 
}
∆∆ 	
e
«« 	
.
««	 

Handled
««
 
=
«« 
true
«« 
;
«« 
}
»» 
private
   
void
   
OnPointerPressed
   !
(
  ! "
object
  " (
?
  ( )
sender
  * 0
,
  0 1%
PointerPressedEventArgs
  2 I
e
  J K
)
  K L
{
ÀÀ 
if
ÃÃ 

(
ÃÃ 
!
ÃÃ 
IsSecureKeyMode
ÃÃ 
||
ÃÃ 
_mainTextBox
ÃÃ  ,
==
ÃÃ- /
null
ÃÃ0 4
)
ÃÃ4 5
{
ÕÕ 	
return
ŒŒ 
;
ŒŒ 
}
œœ 	
e
—— 	
.
——	 

Handled
——
 
=
—— 
true
—— 
;
—— 
if
”” 

(
”” 
!
”” 
_mainTextBox
”” 
.
”” 
	IsFocused
”” #
)
””# $
{
‘‘ 	
_mainTextBox
’’ 
.
’’ 
Focus
’’ 
(
’’ 
)
’’  
;
’’  !
}
÷÷ 	
_mainTextBox
ÿÿ 
.
ÿÿ 

CaretIndex
ÿÿ 
=
ÿÿ  !
_mainTextBox
ÿÿ" .
.
ÿÿ. /
Text
ÿÿ/ 3
?
ÿÿ3 4
.
ÿÿ4 5
Length
ÿÿ5 ;
??
ÿÿ< >
$num
ÿÿ? @
;
ÿÿ@ A$
_intendedCaretPosition
ŸŸ 
=
ŸŸ  
_mainTextBox
ŸŸ! -
.
ŸŸ- .
Text
ŸŸ. 2
?
ŸŸ2 3
.
ŸŸ3 4
Length
ŸŸ4 :
??
ŸŸ; =
$num
ŸŸ> ?
;
ŸŸ? @
}
⁄⁄ 
private
‹‹ 
void
‹‹ 
OnTextInput
‹‹ 
(
‹‹ 
object
‹‹ #
?
‹‹# $
sender
‹‹% +
,
‹‹+ , 
TextInputEventArgs
‹‹- ?
e
‹‹@ A
)
‹‹A B
{
›› 
if
ﬁﬁ 

(
ﬁﬁ 
!
ﬁﬁ 
IsSecureKeyMode
ﬁﬁ 
)
ﬁﬁ 
{
ﬂﬂ 	
return
‡‡ 
;
‡‡ 
}
·· 	
if
„„ 

(
„„ 
string
„„ 
.
„„ 
IsNullOrEmpty
„„  
(
„„  !
e
„„! "
.
„„" #
Text
„„# '
)
„„' (
)
„„( )
{
‰‰ 	
return
ÂÂ 
;
ÂÂ 
}
ÊÊ 	
if
ËË 

(
ËË 
e
ËË 
.
ËË 
Text
ËË 
.
ËË 
Length
ËË 
>
ËË 
$num
ËË 
)
ËË 
{
ÈÈ 	
e
ÍÍ 
.
ÍÍ 
Handled
ÍÍ 
=
ÍÍ 
true
ÍÍ 
;
ÍÍ (
CharacterRejectedEventArgs
ÎÎ &
multiCharArgs
ÎÎ' 4
=
ÎÎ5 6
new
ÏÏ (
CharacterRejectedEventArgs
ÏÏ .
(
ÏÏ. /
$char
ÏÏ/ 3
,
ÏÏ3 4"
CharacterWarningType
ÏÏ5 I
.
ÏÏI J 
MultipleCharacters
ÏÏJ \
,
ÏÏ\ ]
e
ÏÏ^ _
.
ÏÏ_ `
Text
ÏÏ` d
)
ÏÏd e
{
ÌÌ 
RoutedEvent
ÓÓ 
=
ÓÓ  !$
CharacterRejectedEvent
ÓÓ" 8
}
ÔÔ 
;
ÔÔ 

RaiseEvent
 
(
 
multiCharArgs
 $
)
$ %
;
% &
StartWarningTimer
ÒÒ 
(
ÒÒ 
)
ÒÒ 
;
ÒÒ  
if
ÛÛ 
(
ÛÛ 
_mainTextBox
ÛÛ 
!=
ÛÛ 
null
ÛÛ  $
)
ÛÛ$ %
{
ÙÙ 
_mainTextBox
ıı 
.
ıı 

CaretIndex
ıı '
=
ıı( )
_mainTextBox
ıı* 6
.
ıı6 7
Text
ıı7 ;
?
ıı; <
.
ıı< =
Length
ıı= C
??
ııD F
$num
ııG H
;
ııH I
}
ˆˆ 
return
˜˜ 
;
˜˜ 
}
¯¯ 	
char
˙˙ 
	inputChar
˙˙ 
=
˙˙ 
e
˙˙ 
.
˙˙ 
Text
˙˙ 
[
˙˙  
$num
˙˙  !
]
˙˙! "
;
˙˙" #
if
˚˚ 

(
˚˚ 
!
˚˚  
IsAllowedCharacter
˚˚ 
(
˚˚  
	inputChar
˚˚  )
)
˚˚) *
)
˚˚* +
{
¸¸ 	
e
˝˝ 
.
˝˝ 
Handled
˝˝ 
=
˝˝ 
true
˝˝ 
;
˝˝ "
CharacterWarningType
˛˛  
warningType
˛˛! ,
=
˛˛- .
GetWarningType
˛˛/ =
(
˛˛= >
	inputChar
˛˛> G
)
˛˛G H
;
˛˛H I(
CharacterRejectedEventArgs
ˇˇ &
args
ˇˇ' +
=
ˇˇ, -
new
ˇˇ. 1(
CharacterRejectedEventArgs
ˇˇ2 L
(
ˇˇL M
	inputChar
ˇˇM V
,
ˇˇV W
warningType
ˇˇX c
)
ˇˇc d
{
ÄÄ 
RoutedEvent
ÅÅ 
=
ÅÅ $
CharacterRejectedEvent
ÅÅ 4
}
ÇÇ 
;
ÇÇ 

RaiseEvent
ÉÉ 
(
ÉÉ 
args
ÉÉ 
)
ÉÉ 
;
ÉÉ 
StartWarningTimer
ÑÑ 
(
ÑÑ 
)
ÑÑ 
;
ÑÑ  
if
ÜÜ 
(
ÜÜ 
_mainTextBox
ÜÜ 
!=
ÜÜ 
null
ÜÜ  $
)
ÜÜ$ %
{
áá 
_mainTextBox
àà 
.
àà 

CaretIndex
àà '
=
àà( )
_mainTextBox
àà* 6
.
àà6 7
Text
àà7 ;
?
àà; <
.
àà< =
Length
àà= C
??
ààD F
$num
ààG H
;
ààH I
}
ââ 
}
ää 	
if
åå 

(
åå 
_mainTextBox
åå 
!=
åå 
null
åå  
)
åå  !
{
çç 	
int
éé 
currentLength
éé 
=
éé 
_mainTextBox
éé  ,
.
éé, -
Text
éé- 1
?
éé1 2
.
éé2 3
Length
éé3 9
??
éé: <
$num
éé= >
;
éé> ?
_mainTextBox
èè 
.
èè 

CaretIndex
èè #
=
èè$ %
currentLength
èè& 3
;
èè3 4
}
êê 	
}
ëë 
private
ìì 
void
ìì 
StartWarningTimer
ìì "
(
ìì" #
)
ìì# $
{
îî 
if
ïï 

(
ïï 
_warningTimer
ïï 
==
ïï 
null
ïï !
)
ïï! "
{
ññ 	
_warningTimer
óó 
=
óó 
new
óó 
DispatcherTimer
óó  /
{
òò 
Interval
ôô 
=
ôô 
TimeSpan
ôô #
.
ôô# $
FromMilliseconds
ôô$ 4
(
ôô4 5&
WarningDisplayDurationMs
ôô5 M
)
ôôM N
}
öö 
;
öö 
_warningTimer
õõ 
.
õõ 
Tick
õõ 
+=
õõ ! 
OnWarningTimerTick
õõ" 4
;
õõ4 5
}
úú 	
else
ùù 
{
ûû 	
_warningTimer
üü 
.
üü 
Interval
üü "
=
üü# $
TimeSpan
üü% -
.
üü- .
FromMilliseconds
üü. >
(
üü> ?&
WarningDisplayDurationMs
üü? W
)
üüW X
;
üüX Y
}
†† 	
_warningTimer
¢¢ 
.
¢¢ 
Stop
¢¢ 
(
¢¢ 
)
¢¢ 
;
¢¢ 
_warningTimer
££ 
.
££ 
Start
££ 
(
££ 
)
££ 
;
££ 
}
§§ 
private
¶¶ 
void
¶¶  
OnWarningTimerTick
¶¶ #
(
¶¶# $
object
¶¶$ *
?
¶¶* +
sender
¶¶, 2
,
¶¶2 3
System
¶¶4 :
.
¶¶: ;
	EventArgs
¶¶; D
e
¶¶E F
)
¶¶F G
{
ßß 

HasWarning
®® 
=
®® 
false
®® 
;
®® 
_warningTimer
©© 
?
©© 
.
©© 
Stop
©© 
(
©© 
)
©© 
;
©© 
}
™™ 
private
¨¨ 
void
¨¨ 
OnPreviewKeyDown
¨¨ !
(
¨¨! "
object
¨¨" (
?
¨¨( )
sender
¨¨* 0
,
¨¨0 1
KeyEventArgs
¨¨2 >
e
¨¨? @
)
¨¨@ A
{
≠≠ 
if
ÆÆ 

(
ÆÆ 
!
ÆÆ 
IsSecureKeyMode
ÆÆ 
)
ÆÆ 
{
ØØ 	
return
∞∞ 
;
∞∞ 
}
±± 	
if
≥≥ 

(
≥≥ 
e
≥≥ 
.
≥≥ 
KeyModifiers
≥≥ 
.
≥≥ 
HasFlag
≥≥ "
(
≥≥" #
KeyModifiers
≥≥# /
.
≥≥/ 0
Control
≥≥0 7
)
≥≥7 8
||
≥≥9 ;
e
≥≥< =
.
≥≥= >
KeyModifiers
≥≥> J
.
≥≥J K
HasFlag
≥≥K R
(
≥≥R S
KeyModifiers
≥≥S _
.
≥≥_ `
Meta
≥≥` d
)
≥≥d e
)
≥≥e f
{
¥¥ 	
switch
µµ 
(
µµ 
e
µµ 
.
µµ 
Key
µµ 
)
µµ 
{
∂∂ 
case
∑∑ 
Key
∑∑ 
.
∑∑ 
V
∑∑ 
:
∑∑ 
case
∏∏ 
Key
∏∏ 
.
∏∏ 
C
∏∏ 
:
∏∏ 
case
ππ 
Key
ππ 
.
ππ 
X
ππ 
:
ππ 
case
∫∫ 
Key
∫∫ 
.
∫∫ 
Z
∫∫ 
:
∫∫ 
case
ªª 
Key
ªª 
.
ªª 
Y
ªª 
:
ªª 
e
ºº 
.
ºº 
Handled
ºº 
=
ºº 
true
ºº  $
;
ºº$ %
return
ΩΩ 
;
ΩΩ 
}
ææ 
}
øø 	
if
¿¿ 

(
¿¿ 
e
¿¿ 
.
¿¿ 
Key
¿¿ 
==
¿¿ 
Key
¿¿ 
.
¿¿ 
Insert
¿¿ 
&&
¿¿  "
(
¿¿# $
e
¿¿$ %
.
¿¿% &
KeyModifiers
¿¿& 2
.
¿¿2 3
HasFlag
¿¿3 :
(
¿¿: ;
KeyModifiers
¿¿; G
.
¿¿G H
Shift
¿¿H M
)
¿¿M N
||
¿¿O Q
e
¿¿R S
.
¿¿S T
KeyModifiers
¿¿T `
.
¿¿` a
HasFlag
¿¿a h
(
¿¿h i
KeyModifiers
¿¿i u
.
¿¿u v
Control
¿¿v }
)
¿¿} ~
)
¿¿~ 
)¿¿ Ä
{
¡¡ 	
e
¬¬ 
.
¬¬ 
Handled
¬¬ 
=
¬¬ 
true
¬¬ 
;
¬¬ 
}
√√ 	
if
≈≈ 

(
≈≈ 
_mainTextBox
≈≈ 
!=
≈≈ 
null
≈≈  
)
≈≈  !
{
∆∆ 	
switch
«« 
(
«« 
e
«« 
.
«« 
Key
«« 
)
«« 
{
»» 
case
…… 
Key
…… 
.
…… 
Back
…… 
:
…… 
case
   
Key
   
.
   
Delete
   
:
    
case
ÀÀ 
Key
ÀÀ 
.
ÀÀ 
End
ÀÀ 
:
ÀÀ 
case
ÃÃ 
Key
ÃÃ 
.
ÃÃ 
Home
ÃÃ 
:
ÃÃ 
return
ÕÕ 
;
ÕÕ 
case
œœ 
Key
œœ 
.
œœ 
Left
œœ 
:
œœ 
case
–– 
Key
–– 
.
–– 
Right
–– 
:
–– 
case
—— 
Key
—— 
.
—— 
Up
—— 
:
—— 
case
““ 
Key
““ 
.
““ 
Down
““ 
:
““ 
e
”” 
.
”” 
Handled
”” 
=
”” 
true
””  $
;
””$ %
return
‘‘ 
;
‘‘ 
}
’’ 
}
÷÷ 	
if
ÿÿ 

(
ÿÿ 
e
ÿÿ 
.
ÿÿ 
Key
ÿÿ 
==
ÿÿ 
Key
ÿÿ 
.
ÿÿ 
Back
ÿÿ 
)
ÿÿ 
{
ŸŸ 	
e
⁄⁄ 
.
⁄⁄ 
Handled
⁄⁄ 
=
⁄⁄ 
true
⁄⁄ 
;
⁄⁄ 
if
€€ 
(
€€ 
_mainTextBox
€€ 
!=
€€ 
null
€€  $
&&
€€% '
!
€€( )
string
€€) /
.
€€/ 0
IsNullOrEmpty
€€0 =
(
€€= >
_mainTextBox
€€> J
.
€€J K
Text
€€K O
)
€€O P
)
€€P Q
{
‹‹ 
string
›› 
currentText
›› "
=
››# $
_mainTextBox
››% 1
.
››1 2
Text
››2 6
;
››6 7
string
ﬁﬁ 
newText
ﬁﬁ 
=
ﬁﬁ  
currentText
ﬁﬁ! ,
.
ﬁﬁ, -
Length
ﬁﬁ- 3
>
ﬁﬁ4 5
$num
ﬁﬁ6 7
?
ﬁﬁ8 9
currentText
ﬁﬁ: E
.
ﬁﬁE F
	Substring
ﬁﬁF O
(
ﬁﬁO P
$num
ﬁﬁP Q
,
ﬁﬁQ R
currentText
ﬁﬁS ^
.
ﬁﬁ^ _
Length
ﬁﬁ_ e
-
ﬁﬁf g
$num
ﬁﬁh i
)
ﬁﬁi j
:
ﬁﬁk l
string
ﬁﬁm s
.
ﬁﬁs t
Empty
ﬁﬁt y
;
ﬁﬁy z!
_isUpdatingFromCode
‡‡ #
=
‡‡$ %
true
‡‡& *
;
‡‡* +
_mainTextBox
·· 
.
·· 
Text
·· !
=
··" #
newText
··$ +
;
··+ ,
_mainTextBox
‚‚ 
.
‚‚ 

CaretIndex
‚‚ '
=
‚‚( )
newText
‚‚* 1
.
‚‚1 2
Length
‚‚2 8
;
‚‚8 9!
_isUpdatingFromCode
„„ #
=
„„$ %
false
„„& +
;
„„+ ,$
_intendedCaretPosition
ÂÂ &
=
ÂÂ' (
newText
ÂÂ) 0
.
ÂÂ0 1
Length
ÂÂ1 7
;
ÂÂ7 8
}
ÊÊ 
return
ÁÁ 
;
ÁÁ 
}
ËË 	
if
ÍÍ 

(
ÍÍ 
e
ÍÍ 
.
ÍÍ 
Key
ÍÍ 
==
ÍÍ 
Key
ÍÍ 
.
ÍÍ 
Delete
ÍÍ 
)
ÍÍ  
{
ÎÎ 	
e
ÏÏ 
.
ÏÏ 
Handled
ÏÏ 
=
ÏÏ 
true
ÏÏ 
;
ÏÏ 
if
ÌÌ 
(
ÌÌ 
_mainTextBox
ÌÌ 
!=
ÌÌ 
null
ÌÌ  $
&&
ÌÌ% '
!
ÌÌ( )
string
ÌÌ) /
.
ÌÌ/ 0
IsNullOrEmpty
ÌÌ0 =
(
ÌÌ= >
_mainTextBox
ÌÌ> J
.
ÌÌJ K
Text
ÌÌK O
)
ÌÌO P
)
ÌÌP Q
{
ÓÓ 
string
ÔÔ 
currentText
ÔÔ "
=
ÔÔ# $
_mainTextBox
ÔÔ% 1
.
ÔÔ1 2
Text
ÔÔ2 6
;
ÔÔ6 7
string
 
newText
 
=
  
currentText
! ,
.
, -
Length
- 3
>
4 5
$num
6 7
?
8 9
currentText
: E
.
E F
	Substring
F O
(
O P
$num
P Q
,
Q R
currentText
S ^
.
^ _
Length
_ e
-
f g
$num
h i
)
i j
:
k l
string
m s
.
s t
Empty
t y
;
y z!
_isUpdatingFromCode
ÚÚ #
=
ÚÚ$ %
true
ÚÚ& *
;
ÚÚ* +
_mainTextBox
ÛÛ 
.
ÛÛ 
Text
ÛÛ !
=
ÛÛ" #
newText
ÛÛ$ +
;
ÛÛ+ ,
_mainTextBox
ÙÙ 
.
ÙÙ 

CaretIndex
ÙÙ '
=
ÙÙ( )
newText
ÙÙ* 1
.
ÙÙ1 2
Length
ÙÙ2 8
;
ÙÙ8 9!
_isUpdatingFromCode
ıı #
=
ıı$ %
false
ıı& +
;
ıı+ ,$
_intendedCaretPosition
˜˜ &
=
˜˜' (
newText
˜˜) 0
.
˜˜0 1
Length
˜˜1 7
;
˜˜7 8
}
¯¯ 
return
˘˘ 
;
˘˘ 
}
˙˙ 	
if
¸¸ 

(
¸¸ 
_mainTextBox
¸¸ 
!=
¸¸ 
null
¸¸  
)
¸¸  !
{
˝˝ 	
_mainTextBox
˛˛ 
.
˛˛ 

CaretIndex
˛˛ #
=
˛˛$ %
_mainTextBox
˛˛& 2
.
˛˛2 3
Text
˛˛3 7
?
˛˛7 8
.
˛˛8 9
Length
˛˛9 ?
??
˛˛@ B
$num
˛˛C D
;
˛˛D E
}
ˇˇ 	
}
ÄÄ 
private
ÇÇ 
void
ÇÇ 
OnTextChanged
ÇÇ 
(
ÇÇ 
object
ÇÇ %
?
ÇÇ% &
sender
ÇÇ' -
,
ÇÇ- ."
TextChangedEventArgs
ÇÇ/ C
e
ÇÇD E
)
ÇÇE F
{
ÉÉ 
if
ÑÑ 

(
ÑÑ !
_isUpdatingFromCode
ÑÑ 
||
ÑÑ  "
_mainTextBox
ÑÑ# /
==
ÑÑ0 2
null
ÑÑ3 7
||
ÑÑ8 :
_isDisposed
ÑÑ; F
)
ÑÑF G
{
ÖÖ 	
return
ÜÜ 
;
ÜÜ 
}
áá 	
if
ââ 

(
ââ 
IsSecureKeyMode
ââ 
)
ââ 
{
ää 	-
DebouncedProcessSecureKeyChange
ãã +
(
ãã+ ,
)
ãã, -
;
ãã- .
}
åå 	
else
çç 
{
éé 	(
DebouncedProcessTextChange
èè &
(
èè& '
)
èè' (
;
èè( )
}
êê 	
}
ëë 
private
ìì 
void
ìì (
DebouncedProcessTextChange
ìì +
(
ìì+ ,
)
ìì, -
{
îî 
if
ïï 

(
ïï !
_inputDebounceTimer
ïï 
!=
ïï  "
null
ïï# '
)
ïï' (
{
ññ 	!
_inputDebounceTimer
óó 
.
óó  
Stop
óó  $
(
óó$ %
)
óó% &
;
óó& '
}
òò 	
if
öö 

(
öö !
_inputDebounceTimer
öö 
==
öö  "
null
öö# '
)
öö' (
{
õõ 	!
_inputDebounceTimer
úú 
=
úú  !
new
úú" %
DispatcherTimer
úú& 5
{
ùù 
Interval
ûû 
=
ûû 
TimeSpan
ûû #
.
ûû# $
FromMilliseconds
ûû$ 4
(
ûû4 5%
INPUT_DEBOUNCE_DELAY_MS
ûû5 L
)
ûûL M
}
üü 
;
üü !
_inputDebounceTimer
†† 
.
††  
Tick
††  $
+=
††% '!
OnDebounceTimerTick
††( ;
;
††; <
}
°° 	!
_inputDebounceTimer
££ 
.
££ 
Start
££ !
(
££! "
)
££" #
;
££# $
}
§§ 
private
¶¶ 
void
¶¶ -
DebouncedProcessSecureKeyChange
¶¶ 0
(
¶¶0 1
)
¶¶1 2
{
ßß %
_secureKeyDebounceTimer
®® 
?
®®  
.
®®  !
Stop
®®! %
(
®®% &
)
®®& '
;
®®' (
if
™™ 

(
™™ %
_secureKeyDebounceTimer
™™ #
==
™™$ &
null
™™' +
)
™™+ ,
{
´´ 	%
_secureKeyDebounceTimer
¨¨ #
=
¨¨$ %
new
¨¨& )
DispatcherTimer
¨¨* 9
{
≠≠ 
Interval
ÆÆ 
=
ÆÆ 
TimeSpan
ÆÆ #
.
ÆÆ# $
FromMilliseconds
ÆÆ$ 4
(
ÆÆ4 5*
SECURE_KEY_DEBOUNCE_DELAY_MS
ÆÆ5 Q
)
ÆÆQ R
}
ØØ 
;
ØØ %
_secureKeyDebounceTimer
∞∞ #
.
∞∞# $
Tick
∞∞$ (
+=
∞∞) +*
OnSecureKeyDebounceTimerTick
∞∞, H
;
∞∞H I
}
±± 	%
_secureKeyDebounceTimer
≥≥ 
.
≥≥  
Start
≥≥  %
(
≥≥% &
)
≥≥& '
;
≥≥' (
}
¥¥ 
private
∂∂ 
void
∂∂ *
OnSecureKeyDebounceTimerTick
∂∂ -
(
∂∂- .
object
∂∂. 4
?
∂∂4 5
sender
∂∂6 <
,
∂∂< =
System
∂∂> D
.
∂∂D E
	EventArgs
∂∂E N
e
∂∂O P
)
∂∂P Q
{
∑∑ 
try
∏∏ 
{
ππ 	%
_secureKeyDebounceTimer
∫∫ #
?
∫∫# $
.
∫∫$ %
Stop
∫∫% )
(
∫∫) *
)
∫∫* +
;
∫∫+ ,
if
ºº 
(
ºº 
!
ºº 
_isDisposed
ºº 
)
ºº 
{
ΩΩ $
ProcessSecureKeyChange
ææ &
(
ææ& '
)
ææ' (
;
ææ( )
}
øø 
}
¿¿ 	
catch
¡¡ 
(
¡¡ 
	Exception
¡¡ 
ex
¡¡ 
)
¡¡ 
{
¬¬ 	
System
√√ 
.
√√ 
Diagnostics
√√ 
.
√√ 
Debug
√√ $
.
√√$ %
	WriteLine
√√% .
(
√√. /
$"
√√/ 1
$str
√√1 X
{
√√X Y
ex
√√Y [
.
√√[ \
Message
√√\ c
}
√√c d
"
√√d e
)
√√e f
;
√√f g
}
ƒƒ 	
}
≈≈ 
private
«« 
void
«« !
OnDebounceTimerTick
«« $
(
««$ %
object
««% +
?
««+ ,
sender
««- 3
,
««3 4
System
««5 ;
.
««; <
	EventArgs
««< E
e
««F G
)
««G H
{
»» 
try
…… 
{
   	!
_inputDebounceTimer
ÀÀ 
?
ÀÀ  
.
ÀÀ  !
Stop
ÀÀ! %
(
ÀÀ% &
)
ÀÀ& '
;
ÀÀ' (
if
ÕÕ 
(
ÕÕ 
!
ÕÕ 
_isDisposed
ÕÕ 
)
ÕÕ 
{
ŒŒ 
ProcessTextChange
œœ !
(
œœ! "
)
œœ" #
;
œœ# $
}
–– 
}
—— 	
catch
““ 
(
““ 
	Exception
““ 
ex
““ 
)
““ 
{
”” 	
System
‘‘ 
.
‘‘ 
Diagnostics
‘‘ 
.
‘‘ 
Debug
‘‘ $
.
‘‘$ %
	WriteLine
‘‘% .
(
‘‘. /
$"
‘‘/ 1
$str
‘‘1 O
{
‘‘O P
ex
‘‘P R
.
‘‘R S
Message
‘‘S Z
}
‘‘Z [
"
‘‘[ \
)
‘‘\ ]
;
‘‘] ^
}
’’ 	
}
÷÷ 
private
ÿÿ 
void
ÿÿ $
ProcessSecureKeyChange
ÿÿ '
(
ÿÿ' (
)
ÿÿ( )
{
ŸŸ 
if
⁄⁄ 

(
⁄⁄ !
_isUpdatingFromCode
⁄⁄ 
||
⁄⁄  "
_mainTextBox
⁄⁄# /
==
⁄⁄0 2
null
⁄⁄3 7
||
⁄⁄8 :
_isDisposed
⁄⁄; F
||
⁄⁄G I*
_isProcessingSecureKeyChange
⁄⁄J f
)
⁄⁄f g
{
€€ 	
return
‹‹ 
;
‹‹ 
}
›› 	*
_isProcessingSecureKeyChange
ﬂﬂ $
=
ﬂﬂ% &
true
ﬂﬂ' +
;
ﬂﬂ+ ,
try
‡‡ 
{
·· 	
string
‚‚ 
currentText
‚‚ 
=
‚‚  
_mainTextBox
‚‚! -
.
‚‚- .
Text
‚‚. 2
??
‚‚3 5
string
‚‚6 <
.
‚‚< =
Empty
‚‚= B
;
‚‚B C
string
„„ 
lastText
„„ 
=
„„  
_lastProcessedText
„„ 0
;
„„0 1
if
ÂÂ 
(
ÂÂ 
currentText
ÂÂ 
==
ÂÂ 
lastText
ÂÂ '
)
ÂÂ' (
{
ÊÊ 
return
ÁÁ 
;
ÁÁ 
}
ËË 
try
ÍÍ 
{
ÎÎ 
int
ÏÏ !
currentElementCount
ÏÏ '
=
ÏÏ( )!
GetTextElementCount
ÏÏ* =
(
ÏÏ= >
currentText
ÏÏ> I
)
ÏÏI J
;
ÏÏJ K
int
ÌÌ 
lastElementCount
ÌÌ $
=
ÌÌ% &,
_lastProcessedTextElementCount
ÌÌ' E
>
ÌÌF G
$num
ÌÌH I
?
ÓÓ ,
_lastProcessedTextElementCount
ÓÓ 4
:
ÔÔ !
GetTextElementCount
ÔÔ )
(
ÔÔ) *
lastText
ÔÔ* 2
)
ÔÔ2 3
;
ÔÔ3 4
if
ÒÒ 
(
ÒÒ !
currentElementCount
ÒÒ '
>
ÒÒ( )
lastElementCount
ÒÒ* :
)
ÒÒ: ;
{
ÚÚ 
int
ÛÛ 

addedCount
ÛÛ "
=
ÛÛ# $!
currentElementCount
ÛÛ% 8
-
ÛÛ9 :
lastElementCount
ÛÛ; K
;
ÛÛK L
string
ÙÙ 

addedChars
ÙÙ %
=
ÙÙ& '"
GetAddedTextElements
ÙÙ( <
(
ÙÙ< =
currentText
ÙÙ= H
,
ÙÙH I
lastText
ÙÙJ R
,
ÙÙR S
_mainTextBox
ÙÙT `
.
ÙÙ` a

CaretIndex
ÙÙa k
)
ÙÙk l
;
ÙÙl m
int
ˆˆ 
	insertPos
ˆˆ !
=
ˆˆ" #
Math
ˆˆ$ (
.
ˆˆ( )
Max
ˆˆ) ,
(
ˆˆ, -$
HintedTextBoxConstants
ˆˆ- C
.
ˆˆC D!
INITIAL_CARET_INDEX
ˆˆD W
,
ˆˆW X
_mainTextBox
ˆˆY e
.
ˆˆe f

CaretIndex
ˆˆf p
-
ˆˆq r

addedCount
ˆˆs }
)
ˆˆ} ~
;
ˆˆ~ $
_intendedCaretPosition
¯¯ *
=
¯¯+ ,
	insertPos
¯¯- 6
+
¯¯7 8

addedCount
¯¯9 C
;
¯¯C D
if
˙˙ 
(
˙˙ 
!
˙˙ 
string
˙˙ 
.
˙˙  
IsNullOrEmpty
˙˙  -
(
˙˙- .

addedChars
˙˙. 8
)
˙˙8 9
)
˙˙9 :
{
˚˚ 

RaiseEvent
¸¸ "
(
¸¸" #
new
¸¸# &/
!SecureKeyCharactersAddedEventArgs
¸¸' H
(
¸¸H I+
SecureKeyCharactersAddedEvent
¸¸I f
,
¸¸f g
	insertPos
¸¸h q
,
¸¸q r

addedChars
˝˝ &
)
˝˝& '
)
˝˝' (
;
˝˝( )$
TriggerTypingAnimation
˛˛ .
(
˛˛. /
)
˛˛/ 0
;
˛˛0 1
}
ˇˇ 
}
Ä	Ä	 
else
Å	Å	 
if
Å	Å	 
(
Å	Å	 !
currentElementCount
Å	Å	 ,
<
Å	Å	- .
lastElementCount
Å	Å	/ ?
)
Å	Å	? @
{
Ç	Ç	 
int
É	É	 
removedCount
É	É	 $
=
É	É	% &
lastElementCount
É	É	' 7
-
É	É	8 9!
currentElementCount
É	É	: M
;
É	É	M N
int
Ñ	Ñ	 
	removePos
Ñ	Ñ	 !
=
Ñ	Ñ	" #!
currentElementCount
Ñ	Ñ	$ 7
;
Ñ	Ñ	7 8$
_intendedCaretPosition
Ü	Ü	 *
=
Ü	Ü	+ ,
	removePos
Ü	Ü	- 6
;
Ü	Ü	6 7

RaiseEvent
à	à	 
(
à	à	 
new
â	â	 1
#SecureKeyCharactersRemovedEventArgs
â	â	 ?
(
â	â	? @-
SecureKeyCharactersRemovedEvent
â	â	@ _
,
â	â	_ `
	removePos
â	â	a j
,
â	â	j k
removedCount
ä	ä	 (
)
ä	ä	( )
)
ä	ä	) *
;
ä	ä	* +
}
ã	ã	 
}
å	å	 
catch
ç	ç	 
(
ç	ç	 
	Exception
ç	ç	 
ex
ç	ç	 
)
ç	ç	  
{
é	é	 
System
è	è	 
.
è	è	 
Diagnostics
è	è	 "
.
è	è	" #
Debug
è	è	# (
.
è	è	( )
	WriteLine
è	è	) 2
(
è	è	2 3
$"
è	è	3 5
$str
è	è	5 V
{
è	è	V W
ex
è	è	W Y
.
è	è	Y Z
Message
è	è	Z a
}
è	è	a b
"
è	è	b c
)
è	è	c d
;
è	è	d e
if
ë	ë	 
(
ë	ë	 
currentText
ë	ë	 
.
ë	ë	  
Length
ë	ë	  &
>
ë	ë	' (
lastText
ë	ë	) 1
.
ë	ë	1 2
Length
ë	ë	2 8
)
ë	ë	8 9
{
í	í	 
int
ì	ì	 

addedCount
ì	ì	 "
=
ì	ì	# $
currentText
ì	ì	% 0
.
ì	ì	0 1
Length
ì	ì	1 7
-
ì	ì	8 9
lastText
ì	ì	: B
.
ì	ì	B C
Length
ì	ì	C I
;
ì	ì	I J
int
î	î	 
	insertPos
î	î	 !
=
î	î	" #
Math
î	î	$ (
.
î	î	( )
Max
î	î	) ,
(
î	î	, -$
HintedTextBoxConstants
î	î	- C
.
î	î	C D!
INITIAL_CARET_INDEX
î	î	D W
,
î	î	W X
_mainTextBox
î	î	Y e
.
î	î	e f

CaretIndex
î	î	f p
-
î	î	q r

addedCount
î	î	s }
)
î	î	} ~
;
î	î	~ 
string
ï	ï	 

addedChars
ï	ï	 %
=
ï	ï	& '
SafeSubstring
ï	ï	( 5
(
ï	ï	5 6
currentText
ï	ï	6 A
,
ï	ï	A B
	insertPos
ï	ï	C L
,
ï	ï	L M

addedCount
ï	ï	N X
)
ï	ï	X Y
;
ï	ï	Y Z$
_intendedCaretPosition
ó	ó	 *
=
ó	ó	+ ,
	insertPos
ó	ó	- 6
+
ó	ó	7 8

addedCount
ó	ó	9 C
;
ó	ó	C D
if
ô	ô	 
(
ô	ô	 
!
ô	ô	 
string
ô	ô	 
.
ô	ô	  
IsNullOrEmpty
ô	ô	  -
(
ô	ô	- .

addedChars
ô	ô	. 8
)
ô	ô	8 9
)
ô	ô	9 :
{
ö	ö	 

RaiseEvent
õ	õ	 "
(
õ	õ	" #
new
õ	õ	# &/
!SecureKeyCharactersAddedEventArgs
õ	õ	' H
(
õ	õ	H I+
SecureKeyCharactersAddedEvent
õ	õ	I f
,
õ	õ	f g
	insertPos
õ	õ	h q
,
õ	õ	q r

addedChars
ú	ú	 &
)
ú	ú	& '
)
ú	ú	' (
;
ú	ú	( )$
TriggerTypingAnimation
ù	ù	 .
(
ù	ù	. /
)
ù	ù	/ 0
;
ù	ù	0 1
}
û	û	 
}
ü	ü	 
else
†	†	 
if
†	†	 
(
†	†	 
currentText
†	†	 $
.
†	†	$ %
Length
†	†	% +
<
†	†	, -
lastText
†	†	. 6
.
†	†	6 7
Length
†	†	7 =
)
†	†	= >
{
°	°	 
int
¢	¢	 
removedCount
¢	¢	 $
=
¢	¢	% &
lastText
¢	¢	' /
.
¢	¢	/ 0
Length
¢	¢	0 6
-
¢	¢	7 8
currentText
¢	¢	9 D
.
¢	¢	D E
Length
¢	¢	E K
;
¢	¢	K L
int
£	£	 
	removePos
£	£	 !
=
£	£	" #
_mainTextBox
£	£	$ 0
.
£	£	0 1

CaretIndex
£	£	1 ;
;
£	£	; <$
_intendedCaretPosition
•	•	 *
=
•	•	+ ,
	removePos
•	•	- 6
;
•	•	6 7

RaiseEvent
ß	ß	 
(
ß	ß	 
new
®	®	 1
#SecureKeyCharactersRemovedEventArgs
®	®	 ?
(
®	®	? @-
SecureKeyCharactersRemovedEvent
®	®	@ _
,
®	®	_ `
	removePos
®	®	a j
,
®	®	j k
removedCount
©	©	 (
)
©	©	( )
)
©	©	) *
;
©	©	* +
}
™	™	 
}
´	´	  
_lastProcessedText
≠	≠	 
=
≠	≠	  
currentText
≠	≠	! ,
;
≠	≠	, -,
_lastProcessedTextElementCount
Æ	Æ	 *
=
Æ	Æ	+ ,!
GetTextElementCount
Æ	Æ	- @
(
Æ	Æ	@ A
currentText
Æ	Æ	A L
)
Æ	Æ	L M
;
Æ	Æ	M N'
UpdateRemainingCharacters
Ø	Ø	 %
(
Ø	Ø	% &
)
Ø	Ø	& '
;
Ø	Ø	' (
}
∞	∞	 	
finally
±	±	 
{
≤	≤	 	

Dispatcher
≥	≥	 
.
≥	≥	 
UIThread
≥	≥	 
.
≥	≥	  
Post
≥	≥	  $
(
≥	≥	$ %
(
≥	≥	% &
)
≥	≥	& '
=>
≥	≥	( *
{
¥	¥	 
if
µ	µ	 
(
µ	µ	 
_mainTextBox
µ	µ	  
!=
µ	µ	! #
null
µ	µ	$ (
&&
µ	µ	) +
!
µ	µ	, -
_isDisposed
µ	µ	- 8
)
µ	µ	8 9
{
∂	∂	 
int
∑	∑	 

textLength
∑	∑	 "
=
∑	∑	# $
_mainTextBox
∑	∑	% 1
.
∑	∑	1 2
Text
∑	∑	2 6
?
∑	∑	6 7
.
∑	∑	7 8
Length
∑	∑	8 >
??
∑	∑	? A
$num
∑	∑	B C
;
∑	∑	C D
if
∏	∏	 
(
∏	∏	 
_mainTextBox
∏	∏	 $
.
∏	∏	$ %

CaretIndex
∏	∏	% /
!=
∏	∏	0 2

textLength
∏	∏	3 =
)
∏	∏	= >
{
π	π	 
_mainTextBox
∫	∫	 $
.
∫	∫	$ %

CaretIndex
∫	∫	% /
=
∫	∫	0 1

textLength
∫	∫	2 <
;
∫	∫	< =
}
ª	ª	 
}
º	º	 
}
Ω	Ω	 
)
Ω	Ω	 
;
Ω	Ω	 *
_isProcessingSecureKeyChange
æ	æ	 (
=
æ	æ	) *
false
æ	æ	+ 0
;
æ	æ	0 1
}
ø	ø	 	
}
¿	¿	 
private
¬	¬	 
void
¬	¬	 
ProcessTextChange
¬	¬	 "
(
¬	¬	" #
)
¬	¬	# $
{
√	√	 
if
ƒ	ƒ	 

(
ƒ	ƒ	 !
_isUpdatingFromCode
ƒ	ƒ	 
||
ƒ	ƒ	  "
_mainTextBox
ƒ	ƒ	# /
==
ƒ	ƒ	0 2
null
ƒ	ƒ	3 7
||
ƒ	ƒ	8 :
_isDisposed
ƒ	ƒ	; F
)
ƒ	ƒ	F G
{
≈	≈	 	
return
∆	∆	 
;
∆	∆	 
}
«	«	 	#
ProcessStandardChange
»	»	 
(
»	»	 
)
»	»	 
;
»	»	  
}
…	…	 
private
À	À	 
void
À	À	 #
ProcessStandardChange
À	À	 &
(
À	À	& '
)
À	À	' (
{
Ã	Ã	 
string
Õ	Õ	 
input
Õ	Õ	 
=
Õ	Õ	 
_mainTextBox
Õ	Õ	 #
!
Õ	Õ	# $
.
Õ	Õ	$ %
Text
Õ	Õ	% )
??
Õ	Õ	* ,
string
Õ	Õ	- 3
.
Õ	Õ	3 4
Empty
Õ	Õ	4 9
;
Õ	Õ	9 :
if
œ	œ	 

(
œ	œ	 
IsNumericOnly
œ	œ	 
)
œ	œ	 
{
–	–	 	
string
—	—	 
filtered
—	—	 
=
—	—	 
string
—	—	 $
.
—	—	$ %
Concat
—	—	% +
(
—	—	+ ,
input
—	—	, 1
.
—	—	1 2
Where
—	—	2 7
(
—	—	7 8
char
—	—	8 <
.
—	—	< =
IsDigit
—	—	= D
)
—	—	D E
)
—	—	E F
;
—	—	F G
if
“	“	 
(
“	“	 
input
“	“	 
!=
“	“	 
filtered
“	“	 !
)
“	“	! "
{
”	”	 
int
‘	‘	 
inputElementCount
‘	‘	 %
=
‘	‘	& '!
GetTextElementCount
‘	‘	( ;
(
‘	‘	; <
input
‘	‘	< A
)
‘	‘	A B
;
‘	‘	B C
int
’	’	 "
filteredElementCount
’	’	 (
=
’	’	) *!
GetTextElementCount
’	’	+ >
(
’	’	> ?
filtered
’	’	? G
)
’	’	G H
;
’	’	H I
int
÷	÷	 
caret
÷	÷	 
=
÷	÷	 
_mainTextBox
÷	÷	 (
.
÷	÷	( )

CaretIndex
÷	÷	) 3
-
÷	÷	4 5
(
÷	÷	6 7
inputElementCount
÷	÷	7 H
-
÷	÷	I J"
filteredElementCount
÷	÷	K _
)
÷	÷	_ `
;
÷	÷	` a
UpdateTextBox
◊	◊	 
(
◊	◊	 
filtered
◊	◊	 &
,
◊	◊	& '
Math
◊	◊	( ,
.
◊	◊	, -
Max
◊	◊	- 0
(
◊	◊	0 1
$num
◊	◊	1 2
,
◊	◊	2 3
caret
◊	◊	4 9
)
◊	◊	9 :
)
◊	◊	: ;
;
◊	◊	; <
return
ÿ	ÿ	 
;
ÿ	ÿ	 
}
Ÿ	Ÿ	 
}
⁄	⁄	 	
Text
‹	‹	 
=
‹	‹	 
input
‹	‹	 
;
‹	‹	 '
UpdateRemainingCharacters
›	›	 !
(
›	›	! "
)
›	›	" #
;
›	›	# $
if
ﬂ	ﬂ	 

(
ﬂ	ﬂ	 
!
ﬂ	ﬂ	 
IsSecureKeyMode
ﬂ	ﬂ	 
&&
ﬂ	ﬂ	 !
GetTextElementCount
ﬂ	ﬂ	  3
(
ﬂ	ﬂ	3 4
input
ﬂ	ﬂ	4 9
)
ﬂ	ﬂ	9 :
>
ﬂ	ﬂ	; <!
GetTextElementCount
ﬂ	ﬂ	= P
(
ﬂ	ﬂ	P Q
Text
ﬂ	ﬂ	Q U
)
ﬂ	ﬂ	U V
-
ﬂ	ﬂ	W X$
HintedTextBoxConstants
‡	‡	 "
.
‡	‡	" #(
TYPING_ANIMATION_THRESHOLD
‡	‡	# =
)
‡	‡	= >
{
·	·	 	$
TriggerTypingAnimation
‚	‚	 "
(
‚	‚	" #
)
‚	‚	# $
;
‚	‚	$ %
}
„	„	 	
}
‰	‰	 
private
Ê	Ê	 
void
Ê	Ê	 
UpdateTextBox
Ê	Ê	 
(
Ê	Ê	 
string
Ê	Ê	 %
?
Ê	Ê	% &
text
Ê	Ê	' +
,
Ê	Ê	+ ,
int
Ê	Ê	- 0

caretIndex
Ê	Ê	1 ;
)
Ê	Ê	; <
{
Á	Á	 
if
Ë	Ë	 

(
Ë	Ë	 
_mainTextBox
Ë	Ë	 
==
Ë	Ë	 
null
Ë	Ë	  
)
Ë	Ë	  !
{
È	È	 	
return
Í	Í	 
;
Í	Í	 
}
Î	Î	 	
text
Ì	Ì	 
??=
Ì	Ì	 
string
Ì	Ì	 
.
Ì	Ì	 
Empty
Ì	Ì	 
;
Ì	Ì	 !
_isUpdatingFromCode
Ó	Ó	 
=
Ó	Ó	 
true
Ó	Ó	 "
;
Ó	Ó	" #
_mainTextBox
Ô	Ô	 
.
Ô	Ô	 
Text
Ô	Ô	 
=
Ô	Ô	 
text
Ô	Ô	  
;
Ô	Ô	  !
_mainTextBox
		 
.
		 

CaretIndex
		 
=
		  !
Math
		" &
.
		& '
Clamp
		' ,
(
		, -

caretIndex
		- 7
,
		7 8$
HintedTextBoxConstants
		9 O
.
		O P!
INITIAL_CARET_INDEX
		P c
,
		c d
text
		e i
.
		i j
Length
		j p
)
		p q
;
		q r!
_isUpdatingFromCode
Ò	Ò	 
=
Ò	Ò	 
false
Ò	Ò	 #
;
Ò	Ò	# $
}
Ú	Ú	 
private
Ù	Ù	 
void
Ù	Ù	 
UpdateBorderState
Ù	Ù	 "
(
Ù	Ù	" #
)
Ù	Ù	# $
{
ı	ı	 
if
ˆ	ˆ	 

(
ˆ	ˆ	 
_mainTextBox
ˆ	ˆ	 
==
ˆ	ˆ	 
null
ˆ	ˆ	  
||
ˆ	ˆ	! #
_focusBorder
ˆ	ˆ	$ 0
==
ˆ	ˆ	1 3
null
ˆ	ˆ	4 8
||
ˆ	ˆ	9 ;
_mainBorder
ˆ	ˆ	< G
==
ˆ	ˆ	H J
null
ˆ	ˆ	K O
||
ˆ	ˆ	P R
_shadowBorder
ˆ	ˆ	S `
==
ˆ	ˆ	a c
null
ˆ	ˆ	d h
)
ˆ	ˆ	h i
{
˜	˜	 	
return
¯	¯	 
;
¯	¯	 
}
˘	˘	 	
bool
˚	˚	 
currentHasError
˚	˚	 
=
˚	˚	 
HasError
˚	˚	 '
;
˚	˚	' (
SecureKeyStrength
¸	¸	 &
currentSecureKeyStrength
¸	¸	 2
=
¸	¸	3 4
SecureKeyStrength
¸	¸	5 F
;
¸	¸	F G
bool
˝	˝	 ,
currentIsSecureKeyStrengthMode
˝	˝	 +
=
˝	˝	, -%
IsSecureKeyStrengthMode
˝	˝	. E
;
˝	˝	E F

Dispatcher
ˇ	ˇ	 
.
ˇ	ˇ	 
UIThread
ˇ	ˇ	 
.
ˇ	ˇ	 
Post
ˇ	ˇ	  
(
ˇ	ˇ	  !
(
ˇ	ˇ	! "
)
ˇ	ˇ	" #
=>
ˇ	ˇ	$ &
{
Ä
Ä
 	
if
Å
Å
 
(
Å
Å
 
_isDisposed
Å
Å
 
)
Å
Å
 
{
Ç
Ç
 
return
É
É
 
;
É
É
 
}
Ñ
Ñ
 
if
Ö
Ö
 
(
Ö
Ö
 
_mainTextBox
Ö
Ö
 
==
Ö
Ö
 
null
Ö
Ö
  $
||
Ö
Ö
% '
_focusBorder
Ö
Ö
( 4
==
Ö
Ö
5 7
null
Ö
Ö
8 <
||
Ö
Ö
= ?
_mainBorder
Ö
Ö
@ K
==
Ö
Ö
L N
null
Ö
Ö
O S
||
Ö
Ö
T V
_shadowBorder
Ö
Ö
W d
==
Ö
Ö
e g
null
Ö
Ö
h l
)
Ö
Ö
l m
{
Ü
Ü
 
return
á
á
 
;
á
á
 
}
à
à
 
bool
ä
ä
 
	isFocused
ä
ä
 
=
ä
ä
 
_mainTextBox
ä
ä
 )
.
ä
ä
) *
	IsFocused
ä
ä
* 3
;
ä
ä
3 4
if
ã
ã
 
(
ã
ã
 
	isFocused
ã
ã
 
==
ã
ã
 
_lastIsFocused
ã
ã
 +
&&
å
å
 
currentHasError
å
å
 "
==
å
å
# %
_lastHasError
å
å
& 3
&&
ç
ç
 &
currentSecureKeyStrength
ç
ç
 +
==
ç
ç
, .$
_lastSecureKeyStrength
ç
ç
/ E
&&
é
é
 ,
currentIsSecureKeyStrengthMode
é
é
 1
==
é
é
2 4*
_lastIsSecureKeyStrengthMode
é
é
5 Q
)
é
é
Q R
{
è
è
 
return
ê
ê
 
;
ê
ê
 
}
ë
ë
 
_lastIsFocused
ì
ì
 
=
ì
ì
 
	isFocused
ì
ì
 &
;
ì
ì
& '
_lastHasError
î
î
 
=
î
î
 
currentHasError
î
î
 +
;
î
î
+ ,$
_lastSecureKeyStrength
ï
ï
 "
=
ï
ï
# $&
currentSecureKeyStrength
ï
ï
% =
;
ï
ï
= >*
_lastIsSecureKeyStrengthMode
ñ
ñ
 (
=
ñ
ñ
) *,
currentIsSecureKeyStrengthMode
ñ
ñ
+ I
;
ñ
ñ
I J'
UpdateBorderStateInternal
ò
ò
 %
(
ò
ò
% &
	isFocused
ò
ò
& /
,
ò
ò
/ 0
currentHasError
ò
ò
1 @
,
ò
ò
@ A&
currentSecureKeyStrength
ò
ò
B Z
,
ò
ò
Z [,
currentIsSecureKeyStrengthMode
ò
ò
\ z
)
ò
ò
z {
;
ò
ò
{ |
}
ô
ô
 	
,
ô
ô
	 
 
DispatcherPriority
ô
ô
 
.
ô
ô
 
Render
ô
ô
 $
)
ô
ô
$ %
;
ô
ô
% &
}
ö
ö
 
private
ú
ú
 
void
ú
ú
 '
UpdateBorderStateInternal
ú
ú
 *
(
ú
ú
* +
bool
ú
ú
+ /
	isFocused
ú
ú
0 9
,
ú
ú
9 :
bool
ú
ú
; ?
hasError
ú
ú
@ H
,
ú
ú
H I
SecureKeyStrength
ú
ú
J [
secureKeyStrength
ú
ú
\ m
,
ú
ú
m n
bool
ú
ú
o s&
isSecureKeyStrengthModeú
ú
t ã
)ú
ú
ã å
{
ù
ù
 
if
û
û
 

(
û
û
 
_focusBorder
û
û
 
==
û
û
 
null
û
û
  
||
û
û
! #
_mainBorder
û
û
$ /
==
û
û
0 2
null
û
û
3 7
||
û
û
8 :
_shadowBorder
û
û
; H
==
û
û
I K
null
û
û
L P
)
û
û
P Q
{
ü
ü
 	
return
†
†
 
;
†
†
 
}
°
°
 	
if
£
£
 

(
£
£
 %
isSecureKeyStrengthMode
£
£
 #
)
£
£
# $
{
§
§
 	
(
•
•
 
Color
•
•
 
borderColor
•
•
 
,
•
•
 
string
•
•
  &
	shadowKey
•
•
' 0
,
•
•
0 1
Color
•
•
2 7
	iconColor
•
•
8 A
)
•
•
A B
=
•
•
C D(
GetSecureKeyStrengthColors
•
•
E _
(
•
•
_ `
secureKeyStrength
•
•
` q
)
•
•
q r
;
•
•
r s
_focusBorder
ß
ß
 
.
ß
ß
 
BorderBrush
ß
ß
 $
=
ß
ß
% &
GetCachedBrush
ß
ß
' 5
(
ß
ß
5 6
borderColor
ß
ß
6 A
)
ß
ß
A B
;
ß
ß
B C
_focusBorder
®
®
 
.
®
®
 
Opacity
®
®
  
=
®
®
! "$
HintedTextBoxConstants
®
®
# 9
.
®
®
9 :
FULL_OPACITY
®
®
: F
;
®
®
F G
_mainBorder
©
©
 
.
©
©
 
BorderBrush
©
©
 #
=
©
©
$ %
GetCachedBrush
©
©
& 4
(
©
©
4 5
Colors
©
©
5 ;
.
©
©
; <
Transparent
©
©
< G
)
©
©
G H
;
©
©
H I
_shadowBorder
™
™
 
.
™
™
 
	BoxShadow
™
™
 #
=
™
™
$ %
GetCachedResource
™
™
& 7
(
™
™
7 8
	shadowKey
™
™
8 A
)
™
™
A B
;
™
™
B C(
SecureKeyStrengthIconBrush
¨
¨
 &
=
¨
¨
' (
GetCachedBrush
¨
¨
) 7
(
¨
¨
7 8
	iconColor
¨
¨
8 A
)
¨
¨
A B
;
¨
¨
B C(
SecureKeyStrengthTextBrush
≠
≠
 &
=
≠
≠
' (
GetCachedBrush
≠
≠
) 7
(
≠
≠
7 8
	iconColor
≠
≠
8 A
)
≠
≠
A B
;
≠
≠
B C
}
Æ
Æ
 	
else
Ø
Ø
 
if
Ø
Ø
 
(
Ø
Ø
 
hasError
Ø
Ø
 
)
Ø
Ø
 
{
∞
∞
 	
_focusBorder
±
±
 
.
±
±
 
BorderBrush
±
±
 $
=
±
±
% &
GetCachedBrush
±
±
' 5
(
±
±
5 6
GetCachedColor
±
±
6 D
(
±
±
D E$
HintedTextBoxConstants
±
±
E [
.
±
±
[ \
ERROR_COLOR_HEX
±
±
\ k
)
±
±
k l
)
±
±
l m
;
±
±
m n
_focusBorder
≤
≤
 
.
≤
≤
 
Opacity
≤
≤
  
=
≤
≤
! "$
HintedTextBoxConstants
≤
≤
# 9
.
≤
≤
9 :
FULL_OPACITY
≤
≤
: F
;
≤
≤
F G
_mainBorder
≥
≥
 
.
≥
≥
 
BorderBrush
≥
≥
 #
=
≥
≥
$ %
GetCachedBrush
≥
≥
& 4
(
≥
≥
4 5
Colors
≥
≥
5 ;
.
≥
≥
; <
Transparent
≥
≥
< G
)
≥
≥
G H
;
≥
≥
H I
_shadowBorder
¥
¥
 
.
¥
¥
 
	BoxShadow
¥
¥
 #
=
¥
¥
$ %
GetCachedResource
¥
¥
& 7
(
¥
¥
7 8$
HintedTextBoxConstants
¥
¥
8 N
.
¥
¥
N O
ERROR_SHADOW_KEY
¥
¥
O _
)
¥
¥
_ `
;
¥
¥
` a
}
µ
µ
 	
else
∂
∂
 
if
∂
∂
 
(
∂
∂
 
	isFocused
∂
∂
 
)
∂
∂
 
{
∑
∑
 	
_focusBorder
∏
∏
 
.
∏
∏
 
BorderBrush
∏
∏
 $
=
∏
∏
% &
FocusBorderBrush
∏
∏
' 7
;
∏
∏
7 8
_focusBorder
π
π
 
.
π
π
 
Opacity
π
π
  
=
π
π
! "$
HintedTextBoxConstants
π
π
# 9
.
π
π
9 :
FULL_OPACITY
π
π
: F
;
π
π
F G
_mainBorder
∫
∫
 
.
∫
∫
 
BorderBrush
∫
∫
 #
=
∫
∫
$ %
GetCachedBrush
∫
∫
& 4
(
∫
∫
4 5
Colors
∫
∫
5 ;
.
∫
∫
; <
Transparent
∫
∫
< G
)
∫
∫
G H
;
∫
∫
H I
_shadowBorder
ª
ª
 
.
ª
ª
 
	BoxShadow
ª
ª
 #
=
ª
ª
$ %
GetCachedResource
ª
ª
& 7
(
ª
ª
7 8$
HintedTextBoxConstants
ª
ª
8 N
.
ª
ª
N O
FOCUS_SHADOW_KEY
ª
ª
O _
)
ª
ª
_ `
;
ª
ª
` a
}
º
º
 	
else
Ω
Ω
 
{
æ
æ
 	
_focusBorder
ø
ø
 
.
ø
ø
 
Opacity
ø
ø
  
=
ø
ø
! "$
HintedTextBoxConstants
ø
ø
# 9
.
ø
ø
9 :
ZERO_OPACITY
ø
ø
: F
;
ø
ø
F G
_mainBorder
¿
¿
 
.
¿
¿
 
BorderBrush
¿
¿
 #
=
¿
¿
$ %
MainBorderBrush
¿
¿
& 5
;
¿
¿
5 6
_shadowBorder
¡
¡
 
.
¡
¡
 
	BoxShadow
¡
¡
 #
=
¡
¡
$ %
GetCachedResource
¡
¡
& 7
(
¡
¡
7 8$
HintedTextBoxConstants
¡
¡
8 N
.
¡
¡
N O 
DEFAULT_SHADOW_KEY
¡
¡
O a
)
¡
¡
a b
;
¡
¡
b c
}
¬
¬
 	
}
√
√
 
private
≈
≈
 
void
≈
≈
 &
UnsubscribeTextBoxEvents
≈
≈
 )
(
≈
≈
) *
)
≈
≈
* +
{
∆
∆
 
if
«
«
 

(
«
«
 
_mainTextBox
«
«
 
==
«
«
 
null
«
«
  
)
«
«
  !
{
»
»
 	
return
…
…
 
;
…
…
 
}
 
 
 	
_mainTextBox
À
À
 
.
À
À
 
TextChanged
À
À
  
-=
À
À
! #
OnTextChanged
À
À
$ 1
;
À
À
1 2
_mainTextBox
Ã
Ã
 
.
Ã
Ã
 
GotFocus
Ã
Ã
 
-=
Ã
Ã
  

OnGotFocus
Ã
Ã
! +
;
Ã
Ã
+ ,
_mainTextBox
Õ
Õ
 
.
Õ
Õ
 
	LostFocus
Õ
Õ
 
-=
Õ
Õ
 !
OnLostFocus
Õ
Õ
" -
;
Õ
Õ
- .
_mainTextBox
Œ
Œ
 
.
Œ
Œ
 
RemoveHandler
Œ
Œ
 "
(
Œ
Œ
" #
TextInputEvent
Œ
Œ
# 1
,
Œ
Œ
1 2
OnTextInput
Œ
Œ
3 >
)
Œ
Œ
> ?
;
Œ
Œ
? @
_mainTextBox
œ
œ
 
.
œ
œ
 
RemoveHandler
œ
œ
 "
(
œ
œ
" #
KeyDownEvent
œ
œ
# /
,
œ
œ
/ 0
OnPreviewKeyDown
œ
œ
1 A
)
œ
œ
A B
;
œ
œ
B C
_mainTextBox
–
–
 
.
–
–
 
RemoveHandler
–
–
 "
(
–
–
" #!
PointerPressedEvent
–
–
# 6
,
–
–
6 7
OnPointerPressed
–
–
8 H
)
–
–
H I
;
–
–
I J
_mainTextBox
—
—
 
.
—
—
 
RemoveHandler
—
—
 "
(
—
—
" #
PointerMovedEvent
—
—
# 4
,
—
—
4 5
OnPointerMoved
—
—
6 D
)
—
—
D E
;
—
—
E F
_mainTextBox
“
“
 
.
“
“
 
RemoveHandler
“
“
 "
(
“
“
" #"
PointerReleasedEvent
“
“
# 7
,
“
“
7 8
OnPointerReleased
“
“
9 J
)
“
“
J K
;
“
“
K L
_mainTextBox
”
”
 
.
”
”
 
RemoveHandler
”
”
 "
(
”
”
" #
DragDrop
”
”
# +
.
”
”
+ ,
DragEnterEvent
”
”
, :
,
”
”
: ;
OnDragEnter
”
”
< G
)
”
”
G H
;
”
”
H I
_mainTextBox
‘
‘
 
.
‘
‘
 
RemoveHandler
‘
‘
 "
(
‘
‘
" #
DragDrop
‘
‘
# +
.
‘
‘
+ ,
DragOverEvent
‘
‘
, 9
,
‘
‘
9 :

OnDragOver
‘
‘
; E
)
‘
‘
E F
;
‘
‘
F G
_mainTextBox
’
’
 
.
’
’
 
RemoveHandler
’
’
 "
(
’
’
" #
DragDrop
’
’
# +
.
’
’
+ ,
	DropEvent
’
’
, 5
,
’
’
5 6
OnDrop
’
’
7 =
)
’
’
= >
;
’
’
> ?
_mainTextBox
÷
÷
 
.
÷
÷
 
RemoveHandler
÷
÷
 "
(
÷
÷
" #
Gestures
÷
÷
# +
.
÷
÷
+ ,
TappedEvent
÷
÷
, 7
,
÷
÷
7 8
OnTapped
÷
÷
9 A
)
÷
÷
A B
;
÷
÷
B C
_mainTextBox
◊
◊
 
.
◊
◊
 
RemoveHandler
◊
◊
 "
(
◊
◊
" #
Gestures
◊
◊
# +
.
◊
◊
+ ,
DoubleTappedEvent
◊
◊
, =
,
◊
◊
= >
OnDoubleTapped
◊
◊
? M
)
◊
◊
M N
;
◊
◊
N O
_mainTextBox
ÿ
ÿ
 
.
ÿ
ÿ
 
RemoveHandler
ÿ
ÿ
 "
(
ÿ
ÿ
" #
Gestures
ÿ
ÿ
# +
.
ÿ
ÿ
+ ,
HoldingEvent
ÿ
ÿ
, 8
,
ÿ
ÿ
8 9
	OnHolding
ÿ
ÿ
: C
)
ÿ
ÿ
C D
;
ÿ
ÿ
D E
}
Ÿ
Ÿ
 
private
€
€
 
void
€
€
 
FindControls
€
€
 
(
€
€
 
)
€
€
 
{
‹
‹
 
_mainTextBox
›
›
 
=
›
›
 
this
›
›
 
.
›
›
 
FindControl
›
›
 '
<
›
›
' (
TextBox
›
›
( /
>
›
›
/ 0
(
›
›
0 1$
HintedTextBoxConstants
›
›
1 G
.
›
›
G H 
MAIN_TEXT_BOX_NAME
›
›
H Z
)
›
›
Z [
;
›
›
[ \
_focusBorder
ﬁ
ﬁ
 
=
ﬁ
ﬁ
 
this
ﬁ
ﬁ
 
.
ﬁ
ﬁ
 
FindControl
ﬁ
ﬁ
 '
<
ﬁ
ﬁ
' (
Border
ﬁ
ﬁ
( .
>
ﬁ
ﬁ
. /
(
ﬁ
ﬁ
/ 0$
HintedTextBoxConstants
ﬁ
ﬁ
0 F
.
ﬁ
ﬁ
F G
FOCUS_BORDER_NAME
ﬁ
ﬁ
G X
)
ﬁ
ﬁ
X Y
;
ﬁ
ﬁ
Y Z
_mainBorder
ﬂ
ﬂ
 
=
ﬂ
ﬂ
 
this
ﬂ
ﬂ
 
.
ﬂ
ﬂ
 
FindControl
ﬂ
ﬂ
 &
<
ﬂ
ﬂ
& '
Border
ﬂ
ﬂ
' -
>
ﬂ
ﬂ
- .
(
ﬂ
ﬂ
. /$
HintedTextBoxConstants
ﬂ
ﬂ
/ E
.
ﬂ
ﬂ
E F
MAIN_BORDER_NAME
ﬂ
ﬂ
F V
)
ﬂ
ﬂ
V W
;
ﬂ
ﬂ
W X
_shadowBorder
‡
‡
 
=
‡
‡
 
this
‡
‡
 
.
‡
‡
 
FindControl
‡
‡
 (
<
‡
‡
( )
Border
‡
‡
) /
>
‡
‡
/ 0
(
‡
‡
0 1$
HintedTextBoxConstants
‡
‡
1 G
.
‡
‡
G H 
SHADOW_BORDER_NAME
‡
‡
H Z
)
‡
‡
Z [
;
‡
‡
[ \
}
·
·
 
private
„
„
 
void
„
„
 

OnGotFocus
„
„
 
(
„
„
 
object
„
„
 "
?
„
„
" #
sender
„
„
$ *
,
„
„
* +
GotFocusEventArgs
„
„
, =
e
„
„
> ?
)
„
„
? @
{
‰
‰
 
try
Â
Â
 
{
Ê
Ê
 	
if
Á
Á
 
(
Á
Á
 
!
Á
Á
 
_isDisposed
Á
Á
 
)
Á
Á
 
{
Ë
Ë
 
UpdateBorderState
È
È
 !
(
È
È
! "
)
È
È
" #
;
È
È
# $
}
Í
Í
 
}
Î
Î
 	
catch
Ï
Ï
 
(
Ï
Ï
 
	Exception
Ï
Ï
 
ex
Ï
Ï
 
)
Ï
Ï
 
{
Ì
Ì
 	
System
Ó
Ó
 
.
Ó
Ó
 
Diagnostics
Ó
Ó
 
.
Ó
Ó
 
Debug
Ó
Ó
 $
.
Ó
Ó
$ %
	WriteLine
Ó
Ó
% .
(
Ó
Ó
. /
$"
Ó
Ó
/ 1
$str
Ó
Ó
1 F
{
Ó
Ó
F G
ex
Ó
Ó
G I
.
Ó
Ó
I J
Message
Ó
Ó
J Q
}
Ó
Ó
Q R
"
Ó
Ó
R S
)
Ó
Ó
S T
;
Ó
Ó
T U
}
Ô
Ô
 	
}


 
private
Ú
Ú
 
void
Ú
Ú
 
OnLostFocus
Ú
Ú
 
(
Ú
Ú
 
object
Ú
Ú
 #
?
Ú
Ú
# $
sender
Ú
Ú
% +
,
Ú
Ú
+ ,
RoutedEventArgs
Ú
Ú
- <
e
Ú
Ú
= >
)
Ú
Ú
> ?
{
Û
Û
 
try
Ù
Ù
 
{
ı
ı
 	
if
ˆ
ˆ
 
(
ˆ
ˆ
 
!
ˆ
ˆ
 
_isDisposed
ˆ
ˆ
 
)
ˆ
ˆ
 
{
˜
˜
 
UpdateBorderState
¯
¯
 !
(
¯
¯
! "
)
¯
¯
" #
;
¯
¯
# $
}
˘
˘
 
}
˙
˙
 	
catch
˚
˚
 
(
˚
˚
 
	Exception
˚
˚
 
ex
˚
˚
 
)
˚
˚
 
{
¸
¸
 	
System
˝
˝
 
.
˝
˝
 
Diagnostics
˝
˝
 
.
˝
˝
 
Debug
˝
˝
 $
.
˝
˝
$ %
	WriteLine
˝
˝
% .
(
˝
˝
. /
$"
˝
˝
/ 1
$str
˝
˝
1 G
{
˝
˝
G H
ex
˝
˝
H J
.
˝
˝
J K
Message
˝
˝
K R
}
˝
˝
R S
"
˝
˝
S T
)
˝
˝
T U
;
˝
˝
U V
}
˛
˛
 	
}
ˇ
ˇ
 
private
ÅÅ 
void
ÅÅ #
SetupReactiveBindings
ÅÅ &
(
ÅÅ& '
)
ÅÅ' (
{
ÇÇ 
this
ÉÉ 
.
ÉÉ 
WhenAnyValue
ÉÉ 
(
ÉÉ 
x
ÑÑ 
=>
ÑÑ 
x
ÑÑ 
.
ÑÑ 
HasError
ÑÑ 
,
ÑÑ  
x
ÖÖ 
=>
ÖÖ 
x
ÖÖ 
.
ÖÖ 
SecureKeyStrength
ÖÖ (
,
ÖÖ( )
x
ÜÜ 
=>
ÜÜ 
x
ÜÜ 
.
ÜÜ %
IsSecureKeyStrengthMode
ÜÜ .
,
ÜÜ. /
(
áá 
hasError
áá 
,
áá 
secureKeyStrength
áá ,
,
áá, -%
isSecureKeyStrengthMode
áá. E
)
ááE F
=>
ááG I
(
ááJ K
hasError
ááK S
,
ááS T
secureKeyStrength
ááU f
,
ááf g%
isSecureKeyStrengthMode
ááh 
)áá Ä
)ááÄ Å
.
àà "
DistinctUntilChanged
àà !
(
àà! "
)
àà" #
.
ââ 
	Subscribe
ââ 
(
ââ 
_
ââ 
=>
ââ 
{
ää 
try
ãã 
{
åå 
if
çç 
(
çç 
!
çç 
_isDisposed
çç $
)
çç$ %
{
éé 
UpdateBorderState
èè )
(
èè) *
)
èè* +
;
èè+ ,
}
êê 
}
ëë 
catch
íí 
(
íí 
	Exception
íí  
ex
íí! #
)
íí# $
{
ìì 
System
îî 
.
îî 
Diagnostics
îî &
.
îî& '
Debug
îî' ,
.
îî, -
	WriteLine
îî- 6
(
îî6 7
$"
îî7 9
$str
îî9 b
{
îîb c
ex
îîc e
.
îîe f
Message
îîf m
}
îîm n
"
îîn o
)
îîo p
;
îîp q
}
ïï 
}
ññ 
)
ññ 
.
óó 
DisposeWith
óó 
(
óó 
_disposables
óó %
)
óó% &
;
óó& '
this
öö 
.
öö 
WhenAnyValue
öö 
(
öö 
x
öö 
=>
öö 
x
öö  
.
öö  !
	ErrorText
öö! *
)
öö* +
.
õõ "
DistinctUntilChanged
õõ !
(
õõ! "
)
õõ" #
.
úú 
Scan
úú 
(
úú 
string
úú 
.
úú 
Empty
úú 
,
úú 
(
úú  !
previous
úú! )
,
úú) *
current
úú+ 2
)
úú2 3
=>
úú4 6
string
ùù 
.
ùù 
IsNullOrEmpty
ùù $
(
ùù$ %
current
ùù% ,
)
ùù, -
&&
ùù. 0
!
ùù1 2
string
ùù2 8
.
ùù8 9
IsNullOrEmpty
ùù9 F
(
ùùF G
previous
ùùG O
)
ùùO P
?
ùùQ R
previous
ùùS [
:
ùù\ ]
current
ùù^ e
)
ùùe f
.
ûû 
	Subscribe
ûû 
(
ûû 
accumulatedError
ûû '
=>
ûû( *
{
üü 
try
†† 
{
°° 
if
¢¢ 
(
¢¢ 
!
¢¢ 
_isDisposed
¢¢ $
&&
¢¢% '
!
¢¢( )
string
¢¢) /
.
¢¢/ 0
IsNullOrEmpty
¢¢0 =
(
¢¢= >
accumulatedError
¢¢> N
)
¢¢N O
)
¢¢O P
{
££ 
SetValue
§§  
(
§§  !
ErrorTextProperty
§§! 2
,
§§2 3
accumulatedError
§§4 D
)
§§D E
;
§§E F
}
•• 
}
¶¶ 
catch
ßß 
(
ßß 
	Exception
ßß  
ex
ßß! #
)
ßß# $
{
®® 
System
©© 
.
©© 
Diagnostics
©© &
.
©©& '
Debug
©©' ,
.
©©, -
	WriteLine
©©- 6
(
©©6 7
$"
©©7 9
$str
©©9 Z
{
©©Z [
ex
©©[ ]
.
©©] ^
Message
©©^ e
}
©©e f
"
©©f g
)
©©g h
;
©©h i
}
™™ 
}
´´ 
)
´´ 
.
¨¨ 
DisposeWith
¨¨ 
(
¨¨ 
_disposables
¨¨ %
)
¨¨% &
;
¨¨& '
this
ÆÆ 
.
ÆÆ 
WhenAnyValue
ÆÆ 
(
ÆÆ 
x
ÆÆ 
=>
ÆÆ 
x
ÆÆ  
.
ÆÆ  !
Text
ÆÆ! %
)
ÆÆ% &
.
ØØ 
Where
ØØ 
(
ØØ 
text
ØØ 
=>
ØØ 
!
ØØ 
IsSecureKeyMode
ØØ +
&&
ØØ, .
_mainTextBox
ØØ/ ;
!=
ØØ< >
null
ØØ? C
&&
ØØD F
_mainTextBox
ØØG S
.
ØØS T
Text
ØØT X
!=
ØØY [
text
ØØ\ `
)
ØØ` a
.
∞∞ 
	Subscribe
∞∞ 
(
∞∞ 
text
∞∞ 
=>
∞∞ 
{
±± 
try
≤≤ 
{
≥≥ 
if
¥¥ 
(
¥¥ 
!
¥¥ 
_isDisposed
¥¥ $
)
¥¥$ %
{
µµ 
UpdateTextBox
∂∂ %
(
∂∂% &
text
∂∂& *
,
∂∂* +
(
∂∂, -
text
∂∂- 1
)
∂∂1 2
.
∂∂2 3
Length
∂∂3 9
)
∂∂9 :
;
∂∂: ;
}
∑∑ 
}
∏∏ 
catch
ππ 
(
ππ 
	Exception
ππ  
ex
ππ! #
)
ππ# $
{
∫∫ 
System
ªª 
.
ªª 
Diagnostics
ªª &
.
ªª& '
Debug
ªª' ,
.
ªª, -
	WriteLine
ªª- 6
(
ªª6 7
$"
ªª7 9
$str
ªª9 U
{
ªªU V
ex
ªªV X
.
ªªX Y
Message
ªªY `
}
ªª` a
"
ªªa b
)
ªªb c
;
ªªc d
}
ºº 
}
ΩΩ 
)
ΩΩ 
.
ææ 
DisposeWith
ææ 
(
ææ 
_disposables
ææ %
)
ææ% &
;
ææ& '
this
¿¿ 
.
¿¿ 
WhenAnyValue
¿¿ 
(
¿¿ 
x
¿¿ 
=>
¿¿ 
x
¿¿  
.
¿¿  !
HasError
¿¿! )
)
¿¿) *
.
¡¡ "
DistinctUntilChanged
¡¡ !
(
¡¡! "
)
¡¡" #
.
¬¬ 
	Subscribe
¬¬ 
(
¬¬ 
hasError
¬¬ 
=>
¬¬  "
{
√√ 
try
ƒƒ 
{
≈≈ 
if
∆∆ 
(
∆∆ 
!
∆∆ 
_isDisposed
∆∆ $
)
∆∆$ %
{
«« 
EllipseOpacity
»» &
=
»»' (
hasError
»») 1
?
…… $
HintedTextBoxConstants
…… 4
.
……4 5-
DEFAULT_ELLIPSE_OPACITY_VISIBLE
……5 T
:
   $
HintedTextBoxConstants
   4
.
  4 5,
DEFAULT_ELLIPSE_OPACITY_HIDDEN
  5 S
;
  S T
}
ÀÀ 
}
ÃÃ 
catch
ÕÕ 
(
ÕÕ 
	Exception
ÕÕ  
ex
ÕÕ! #
)
ÕÕ# $
{
ŒŒ 
System
œœ 
.
œœ 
Diagnostics
œœ &
.
œœ& '
Debug
œœ' ,
.
œœ, -
	WriteLine
œœ- 6
(
œœ6 7
$"
œœ7 9
$str
œœ9 Y
{
œœY Z
ex
œœZ \
.
œœ\ ]
Message
œœ] d
}
œœd e
"
œœe f
)
œœf g
;
œœg h
}
–– 
}
—— 
)
—— 
.
““ 
DisposeWith
““ 
(
““ 
_disposables
““ %
)
““% &
;
““& '
}
”” 
private
’’ 
void
’’ '
UpdateRemainingCharacters
’’ *
(
’’* +
)
’’+ ,
{
÷÷ 
int
◊◊ 
currentTextLength
◊◊ 
=
◊◊ 
IsSecureKeyMode
◊◊  /
&&
◊◊0 2
_mainTextBox
◊◊3 ?
!=
◊◊@ B
null
◊◊C G
?
ÿÿ !
GetTextElementCount
ÿÿ !
(
ÿÿ! "
_mainTextBox
ÿÿ" .
.
ÿÿ. /
Text
ÿÿ/ 3
??
ÿÿ4 6
string
ÿÿ7 =
.
ÿÿ= >
Empty
ÿÿ> C
)
ÿÿC D
:
ŸŸ !
GetTextElementCount
ŸŸ !
(
ŸŸ! "
Text
ŸŸ" &
)
ŸŸ& '
;
ŸŸ' (!
RemainingCharacters
⁄⁄ 
=
⁄⁄ 
	MaxLength
⁄⁄ '
-
⁄⁄( )
currentTextLength
⁄⁄* ;
;
⁄⁄; <
}
€€ 
private
›› 
void
›› &
OnIsSecureKeyModeChanged
›› )
(
››) *
bool
››* .
isSecureKeyMode
››/ >
)
››> ?
{
ﬁﬁ 
if
ﬂﬂ 

(
ﬂﬂ 
_mainTextBox
ﬂﬂ 
==
ﬂﬂ 
null
ﬂﬂ  
)
ﬂﬂ  !
{
‡‡ 	
return
·· 
;
·· 
}
‚‚ 	
_mainTextBox
‰‰ 
.
‰‰ 
PasswordChar
‰‰ !
=
‰‰" #$
HintedTextBoxConstants
‰‰$ :
.
‰‰: ; 
NO_SECURE_KEY_CHAR
‰‰; M
;
‰‰M N
if
ÊÊ 

(
ÊÊ 
isSecureKeyMode
ÊÊ 
)
ÊÊ 
{
ÁÁ 	 
_lastProcessedText
ËË 
=
ËË  
_mainTextBox
ËË! -
.
ËË- .
Text
ËË. 2
??
ËË3 5
string
ËË6 <
.
ËË< =
Empty
ËË= B
;
ËËB C(
DisableClipboardOperations
ÈÈ &
(
ÈÈ& '
)
ÈÈ' (
;
ÈÈ( )
}
ÍÍ 	
else
ÎÎ 
{
ÏÏ 	 
_lastProcessedText
ÌÌ 
=
ÌÌ  
string
ÌÌ! '
.
ÌÌ' (
Empty
ÌÌ( -
;
ÌÌ- .'
EnableClipboardOperations
ÓÓ %
(
ÓÓ% &
)
ÓÓ& '
;
ÓÓ' (
}
ÔÔ 	'
UpdateRemainingCharacters
ÒÒ !
(
ÒÒ! "
)
ÒÒ" #
;
ÒÒ# $
}
ÚÚ 
private
ÙÙ 
void
ÙÙ '
EnableClipboardOperations
ÙÙ *
(
ÙÙ* +
)
ÙÙ+ ,
{
ıı 
if
ˆˆ 

(
ˆˆ 
_mainTextBox
ˆˆ 
==
ˆˆ 
null
ˆˆ  
)
ˆˆ  !
{
˜˜ 	
return
¯¯ 
;
¯¯ 
}
˘˘ 	
_mainTextBox
˚˚ 
.
˚˚ 
RemoveHandler
˚˚ "
(
˚˚" #
TextInputEvent
˚˚# 1
,
˚˚1 2
OnTextInput
˚˚3 >
)
˚˚> ?
;
˚˚? @
_mainTextBox
¸¸ 
.
¸¸ 
RemoveHandler
¸¸ "
(
¸¸" #
KeyDownEvent
¸¸# /
,
¸¸/ 0
OnPreviewKeyDown
¸¸1 A
)
¸¸A B
;
¸¸B C
_mainTextBox
˝˝ 
.
˝˝ 
RemoveHandler
˝˝ "
(
˝˝" #!
PointerPressedEvent
˝˝# 6
,
˝˝6 7
OnPointerPressed
˝˝8 H
)
˝˝H I
;
˝˝I J
_mainTextBox
˛˛ 
.
˛˛ 
RemoveHandler
˛˛ "
(
˛˛" #
PointerMovedEvent
˛˛# 4
,
˛˛4 5
OnPointerMoved
˛˛6 D
)
˛˛D E
;
˛˛E F
_mainTextBox
ˇˇ 
.
ˇˇ 
RemoveHandler
ˇˇ "
(
ˇˇ" #"
PointerReleasedEvent
ˇˇ# 7
,
ˇˇ7 8
OnPointerReleased
ˇˇ9 J
)
ˇˇJ K
;
ˇˇK L
_mainTextBox
ÄÄ 
.
ÄÄ 
RemoveHandler
ÄÄ "
(
ÄÄ" #
DragDrop
ÄÄ# +
.
ÄÄ+ ,
DragEnterEvent
ÄÄ, :
,
ÄÄ: ;
OnDragEnter
ÄÄ< G
)
ÄÄG H
;
ÄÄH I
_mainTextBox
ÅÅ 
.
ÅÅ 
RemoveHandler
ÅÅ "
(
ÅÅ" #
DragDrop
ÅÅ# +
.
ÅÅ+ ,
DragOverEvent
ÅÅ, 9
,
ÅÅ9 :

OnDragOver
ÅÅ; E
)
ÅÅE F
;
ÅÅF G
_mainTextBox
ÇÇ 
.
ÇÇ 
RemoveHandler
ÇÇ "
(
ÇÇ" #
DragDrop
ÇÇ# +
.
ÇÇ+ ,
	DropEvent
ÇÇ, 5
,
ÇÇ5 6
OnDrop
ÇÇ7 =
)
ÇÇ= >
;
ÇÇ> ?
_mainTextBox
ÉÉ 
.
ÉÉ 
RemoveHandler
ÉÉ "
(
ÉÉ" #
Gestures
ÉÉ# +
.
ÉÉ+ ,
TappedEvent
ÉÉ, 7
,
ÉÉ7 8
OnTapped
ÉÉ9 A
)
ÉÉA B
;
ÉÉB C
_mainTextBox
ÑÑ 
.
ÑÑ 
RemoveHandler
ÑÑ "
(
ÑÑ" #
Gestures
ÑÑ# +
.
ÑÑ+ ,
DoubleTappedEvent
ÑÑ, =
,
ÑÑ= >
OnDoubleTapped
ÑÑ? M
)
ÑÑM N
;
ÑÑN O
_mainTextBox
ÖÖ 
.
ÖÖ 
RemoveHandler
ÖÖ "
(
ÖÖ" #
Gestures
ÖÖ# +
.
ÖÖ+ ,
HoldingEvent
ÖÖ, 8
,
ÖÖ8 9
	OnHolding
ÖÖ: C
)
ÖÖC D
;
ÖÖD E
}
ÜÜ 
private
àà 
void
àà $
TriggerTypingAnimation
àà '
(
àà' (
)
àà( )
{
ââ 
if
ää 

(
ää 
_mainTextBox
ää 
==
ää 
null
ää  
||
ää! #
_isDisposed
ää$ /
||
ää0 2
_focusBorder
ää3 ?
==
ää@ B
null
ääC G
)
ääG H
{
ãã 	
return
åå 
;
åå 
}
çç 	
try
èè 
{
êê 	%
_currentTypingAnimation
ëë #
?
ëë# $
.
ëë$ %
Dispose
ëë% ,
(
ëë, -
)
ëë- .
;
ëë. /
if
ìì 
(
ìì 
!
ìì 
(
ìì 
_focusBorder
ìì 
.
ìì 
Opacity
ìì &
>
ìì' ($
HintedTextBoxConstants
ìì) ?
.
ìì? @
ZERO_OPACITY
ìì@ L
)
ììL M
)
ììM N
{
îî 
return
ïï 
;
ïï 
}
ññ 
	Animation
óó 
pulseAnimation
óó $
=
óó% &
new
óó' *
(
óó* +
)
óó+ ,
{
òò 
Duration
ôô 
=
ôô 
TimeSpan
ôô #
.
ôô# $
FromMilliseconds
ôô$ 4
(
ôô4 5$
HintedTextBoxConstants
ôô5 K
.
ôôK L*
TYPING_ANIMATION_DURATION_MS
ôôL h
)
ôôh i
,
ôôi j
FillMode
öö 
=
öö 
FillMode
öö #
.
öö# $
None
öö$ (
,
öö( )
Easing
õõ 
=
õõ 
new
õõ 
CubicEaseOut
õõ )
(
õõ) *
)
õõ* +
}
úú 
;
úú 
KeyFrame
ûû 

startFrame
ûû 
=
ûû  !
new
ûû" %
(
ûû% &
)
ûû& '
{
üü 
Cue
†† 
=
†† 
Cue
†† 
.
†† 
Parse
†† 
(
††  $
HintedTextBoxConstants
††  6
.
††6 7%
ANIMATION_START_PERCENT
††7 N
,
††N O
CultureInfo
††P [
.
††[ \
InvariantCulture
††\ l
)
††l m
,
††m n
Setters
°° 
=
°° 
{
°° 
new
°° 
Setter
°°  &
{
°°' (
Property
°°) 1
=
°°2 3
OpacityProperty
°°4 C
,
°°C D
Value
°°E J
=
°°K L
_focusBorder
°°M Y
.
°°Y Z
Opacity
°°Z a
}
°°b c
}
°°d e
}
¢¢ 
;
¢¢ 
KeyFrame
§§ 
brightFrame
§§  
=
§§! "
new
§§# &
(
§§& '
)
§§' (
{
•• 
Cue
¶¶ 
=
¶¶ 
Cue
¶¶ 
.
¶¶ 
Parse
¶¶ 
(
¶¶  $
HintedTextBoxConstants
¶¶  6
.
¶¶6 7$
ANIMATION_PEAK_PERCENT
¶¶7 M
,
¶¶M N
CultureInfo
¶¶O Z
.
¶¶Z [
InvariantCulture
¶¶[ k
)
¶¶k l
,
¶¶l m
Setters
ßß 
=
ßß 
{
®® 
new
©© 
Setter
©© 
{
™™ 
Property
´´  
=
´´! "
OpacityProperty
´´# 2
,
´´2 3
Value
¨¨ 
=
¨¨ 
Math
¨¨  $
.
¨¨$ %
Min
¨¨% (
(
¨¨( )$
HintedTextBoxConstants
¨¨) ?
.
¨¨? @
FULL_OPACITY
¨¨@ L
,
¨¨L M
_focusBorder
≠≠ (
.
≠≠( )
Opacity
≠≠) 0
+
≠≠1 2$
HintedTextBoxConstants
≠≠3 I
.
≠≠I J%
ANIMATION_OPACITY_BOOST
≠≠J a
)
≠≠a b
}
ÆÆ 
}
ØØ 
}
∞∞ 
;
∞∞ 
KeyFrame
≤≤ 
endFrame
≤≤ 
=
≤≤ 
new
≤≤  #
(
≤≤# $
)
≤≤$ %
{
≥≥ 
Cue
¥¥ 
=
¥¥ 
Cue
¥¥ 
.
¥¥ 
Parse
¥¥ 
(
¥¥  $
HintedTextBoxConstants
¥¥  6
.
¥¥6 7#
ANIMATION_END_PERCENT
¥¥7 L
,
¥¥L M
CultureInfo
¥¥N Y
.
¥¥Y Z
InvariantCulture
¥¥Z j
)
¥¥j k
,
¥¥k l
Setters
µµ 
=
µµ 
{
µµ 
new
µµ 
Setter
µµ  &
{
µµ' (
Property
µµ) 1
=
µµ2 3
OpacityProperty
µµ4 C
,
µµC D
Value
µµE J
=
µµK L
_focusBorder
µµM Y
.
µµY Z
Opacity
µµZ a
}
µµb c
}
µµd e
}
∂∂ 
;
∂∂ 
pulseAnimation
∏∏ 
.
∏∏ 
Children
∏∏ #
.
∏∏# $
Add
∏∏$ '
(
∏∏' (

startFrame
∏∏( 2
)
∏∏2 3
;
∏∏3 4
pulseAnimation
ππ 
.
ππ 
Children
ππ #
.
ππ# $
Add
ππ$ '
(
ππ' (
brightFrame
ππ( 3
)
ππ3 4
;
ππ4 5
pulseAnimation
∫∫ 
.
∫∫ 
Children
∫∫ #
.
∫∫# $
Add
∫∫$ '
(
∫∫' (
endFrame
∫∫( 0
)
∫∫0 1
;
∫∫1 2%
_currentTypingAnimation
ºº #
=
ºº$ %
pulseAnimation
ºº& 4
.
ºº4 5
RunAsync
ºº5 =
(
ºº= >
_focusBorder
ºº> J
)
ººJ K
;
ººK L
}
ΩΩ 	
catch
ææ 
(
ææ 
	Exception
ææ 
ex
ææ 
)
ææ 
{
øø 	
System
¿¿ 
.
¿¿ 
Diagnostics
¿¿ 
.
¿¿ 
Debug
¿¿ $
.
¿¿$ %
	WriteLine
¿¿% .
(
¿¿. /
$"
¿¿/ 1
$str
¿¿1 R
{
¿¿R S
ex
¿¿S U
.
¿¿U V
Message
¿¿V ]
}
¿¿] ^
"
¿¿^ _
)
¿¿_ `
;
¿¿` a
}
¡¡ 	
}
¬¬ 
private
ƒƒ 

BoxShadows
ƒƒ 
GetCachedResource
ƒƒ (
(
ƒƒ( )
string
ƒƒ) /
resourceKey
ƒƒ0 ;
)
ƒƒ; <
{
≈≈ 
if
∆∆ 

(
∆∆ 
ResourceCache
∆∆ 
.
∆∆ 
TryGetValue
∆∆ %
(
∆∆% &
resourceKey
∆∆& 1
,
∆∆1 2
out
∆∆3 6

BoxShadows
∆∆7 A
shadow
∆∆B H
)
∆∆H I
)
∆∆I J
{
«« 	
return
»» 
shadow
»» 
;
»» 
}
…… 	
shadow
   
=
   
this
   
.
   
FindResource
   "
(
  " #
resourceKey
  # .
)
  . /
is
  0 2

BoxShadows
  3 =
foundShadow
  > I
?
  J K
foundShadow
  L W
:
  X Y
default
  Z a
;
  a b
ResourceCache
ÀÀ 
[
ÀÀ 
resourceKey
ÀÀ !
]
ÀÀ! "
=
ÀÀ# $
shadow
ÀÀ% +
;
ÀÀ+ ,
return
ÕÕ 
shadow
ÕÕ 
;
ÕÕ 
}
ŒŒ 
private
–– 
void
–– !
InitializeComponent
–– $
(
––$ %
)
––% &
{
——  
AvaloniaXamlLoader
““ 
.
““ 
Load
““ 
(
““  
this
““  $
)
““$ %
;
““% &
}
”” 
}‘‘ –◊
â/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Core/ConnectivityNotificationViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Core! %
;% &
public 
enum %
ConnectivityIssueCategory %
{ 
InternetUnavailable   
,   
ServerUnreachable!! 
}"" 
public$$ 
enum$$ &
DetailedConnectivityStatus$$ &
{%%  
NoInternetConnection&& 
,&& &
CheckingInternetConnection'' 
,'' 
InternetRestored(( 
,(( 
ConnectingToServer)) 
,)) 
Reconnecting** 
,** 
ServerNotResponding++ 
,++ 
ServerShuttingDown,, 
,,, 
RetriesExhausted-- 
,-- 
ServerReconnected.. 
}// 
public11 
sealed11 
class11 -
!ConnectivityNotificationViewModel11 5
:116 7
ReactiveObject118 F
,11F G
IDisposable11H S
{22 
public33 
 
ILocalizationService33 
LocalizationService33  3
{334 5
get336 9
;339 :
}33; <
private55 
readonly55 
CompositeDisposable55 (
_disposables55) 5
=556 7
new558 ;
(55; <
)55< =
;55= >
private66 
readonly66 
SemaphoreSlim66 ""
_statusUpdateSemaphore66# 9
=66: ;
new66< ?
(66? @
$num66@ A
,66A B
$num66C D
)66D E
;66E F
private88 
readonly88 

Dictionary88 
<88  &
DetailedConnectivityStatus88  :
,88: ;
string88< B
>88B C
_cachedStatusTexts88D V
=88W X
new88Y \
(88\ ]
)88] ^
;88^ _
private99 
readonly99 

Dictionary99 
<99  &
DetailedConnectivityStatus99  :
,99: ;
string99< B
>99B C%
_cachedStatusDescriptions99D ]
=99^ _
new99` c
(99c d
)99d e
;99e f
private:: 
string:: 
?:: "
_cachedRetryButtonText:: *
;::* +
private<< (
ConnectivityNotificationView<< (
?<<( )
_view<<* /
;<</ 0
private== 
Border== 
?== 
_mainBorder== 
;==  
private>> 
bool>> 
	_disposed>> 
;>> 
private@@ 
static@@ 
	Animation@@ 
?@@ "
_sharedAppearAnimation@@ 4
;@@4 5
privateAA 
staticAA 
	AnimationAA 
?AA %
_sharedDisappearAnimationAA 7
;AA7 8
privateCC 
BitmapCC 
?CC *
_cachedInternetUnavailableIconCC 2
;CC2 3
privateDD 
BitmapDD 
?DD (
_cachedServerUnreachableIconDD 0
;DD0 1
privateFF 
TranslateTransformFF 
?FF %
_sharedTranslateTransformFF  9
;FF9 :
publicHH 

TimeSpanHH 
AppearDurationHH "
{HH# $
getHH% (
;HH( )
setHH* -
;HH- .
}HH/ 0
=HH1 2
TimeSpanII 
.II 
FromMillisecondsII !
(II! ""
NetworkStatusConstantsII" 8
.II8 9&
DEFAULT_APPEAR_DURATION_MSII9 S
)IIS T
;IIT U
publicKK 

TimeSpanKK 
DisappearDurationKK %
{KK& '
getKK( +
;KK+ ,
setKK- 0
;KK0 1
}KK2 3
=KK4 5
TimeSpanLL 
.LL 
FromMillisecondsLL !
(LL! ""
NetworkStatusConstantsLL" 8
.LL8 9)
DEFAULT_DISAPPEAR_DURATION_MSLL9 V
)LLV W
;LLW X
privateNN 
readonlyNN &
ObservableAsPropertyHelperNN /
<NN/ 0
stringNN0 6
>NN6 7
_retryButtonTextNN8 H
;NNH I
publicOO 

stringOO 
RetryButtonTextOO !
=>OO" $
_retryButtonTextOO% 5
.OO5 6
ValueOO6 ;
;OO; <
privateQQ 
readonlyQQ &
ObservableAsPropertyHelperQQ /
<QQ/ 0
boolQQ0 4
>QQ4 5

_isVisibleQQ6 @
;QQ@ A
publicRR 

boolRR 
	IsVisibleRR 
=>RR 

_isVisibleRR '
.RR' (
ValueRR( -
;RR- .
privateTT 
readonlyTT &
ObservableAsPropertyHelperTT /
<TT/ 0
boolTT0 4
>TT4 5
_isAnimatingTT6 B
;TTB C
publicUU 

boolUU 
IsAnimatingUU 
=>UU 
_isAnimatingUU +
.UU+ ,
ValueUU, 1
;UU1 2
privateWW 
readonlyWW &
ObservableAsPropertyHelperWW /
<WW/ 0
stringWW0 6
>WW6 7
_statusTextWW8 C
;WWC D
publicXX 

stringXX 

StatusTextXX 
=>XX 
_statusTextXX  +
.XX+ ,
ValueXX, 1
;XX1 2
privateZZ 
readonlyZZ &
ObservableAsPropertyHelperZZ /
<ZZ/ 0
stringZZ0 6
>ZZ6 7
_statusDescriptionZZ8 J
;ZZJ K
public[[ 

string[[ 
StatusDescription[[ #
=>[[$ &
_statusDescription[[' 9
.[[9 :
Value[[: ?
;[[? @
private]] 
readonly]] &
ObservableAsPropertyHelper]] /
<]]/ 0
Bitmap]]0 6
?]]6 7
>]]7 8
_statusIconSource]]9 J
;]]J K
public^^ 

Bitmap^^ 
?^^ 
StatusIconSource^^ #
=>^^$ &
_statusIconSource^^' 8
.^^8 9
Value^^9 >
;^^> ?
private`` 
readonly`` &
ObservableAsPropertyHelper`` /
<``/ 0
bool``0 4
>``4 5
_showRetryButton``6 F
;``F G
publicaa 

boolaa 
ShowRetryButtonaa 
=>aa  "
_showRetryButtonaa# 3
.aa3 4
Valueaa4 9
;aa9 :
privatecc 
readonlycc &
ObservableAsPropertyHelpercc /
<cc/ 0%
ConnectivityIssueCategorycc0 I
>ccI J
_issueCategoryccK Y
;ccY Z
publicdd 
%
ConnectivityIssueCategorydd $
IssueCategorydd% 2
=>dd3 5
_issueCategorydd6 D
.ddD E
ValueddE J
;ddJ K
privateff 
readonlyff &
ObservableAsPropertyHelperff /
<ff/ 0&
DetailedConnectivityStatusff0 J
>ffJ K
_detailedStatusffL [
;ff[ \
publicgg 
&
DetailedConnectivityStatusgg %
DetailedStatusgg& 4
=>gg5 7
_detailedStatusgg8 G
.ggG H
ValueggH M
;ggM N
publicii 

ReactiveCommandii 
<ii 
Unitii 
,ii  
Unitii! %
>ii% &
RetryCommandii' 3
{ii4 5
getii6 9
;ii9 :
}ii; <
publickk 

voidkk 
SetViewkk 
(kk (
ConnectivityNotificationViewkk 4
viewkk5 9
)kk9 :
{ll 
_viewmm 
=mm 
viewmm 
;mm 
_mainBordernn 
=nn 
viewnn 
.nn 
FindControlnn &
<nn& '
Bordernn' -
>nn- .
(nn. /
$strnn/ ;
)nn; <
;nn< =
CreateAnimationsoo 
(oo 
)oo 
;oo 
}pp 
publicrr 
-
!ConnectivityNotificationViewModelrr ,
(rr, - 
ILocalizationServicess 
localizationServicess 0
,ss0 1 
IConnectivityServicett 
connectivityServicett 0
,tt0 1"
IPendingRequestManageruu !
pendingRequestManageruu 4
)uu4 5
{vv 
LocalizationServiceww 
=ww 
localizationServiceww 1
;ww1 2
IObservableyy 
<yy 
Unityy 
>yy 
languageTriggeryy )
=yy* +

Observableyy, 6
.yy6 7
	FromEventyy7 @
(yy@ A
handlerzz 
=>zz 
LocalizationServicezz .
.zz. /
LanguageChangedzz/ >
+=zz? A
handlerzzB I
,zzI J
handler{{ 
=>{{ 
LocalizationService{{ .
.{{. /
LanguageChanged{{/ >
-={{? A
handler{{B I
){{I J
.|| 
Select|| 
(|| 
_|| 
=>|| 
Unit|| 
.|| 
Default|| %
)||% &
.}} 
	StartWith}} 
(}} 
Unit}} 
.}} 
Default}} #
)}}# $
;}}$ %
languageTrigger 
.
ÄÄ 
Skip
ÄÄ 
(
ÄÄ 
$num
ÄÄ 
)
ÄÄ 
.
ÅÅ 
	Subscribe
ÅÅ 
(
ÅÅ 
_
ÅÅ 
=>
ÅÅ 
ClearStringCache
ÅÅ ,
(
ÅÅ, -
)
ÅÅ- .
)
ÅÅ. /
.
ÇÇ 
DisposeWith
ÇÇ 
(
ÇÇ 
_disposables
ÇÇ %
)
ÇÇ% &
;
ÇÇ& '"
ConnectivitySnapshot
ÑÑ 
initialSnapshot
ÑÑ ,
=
ÑÑ- .!
connectivityService
ÑÑ/ B
.
ÑÑB C
CurrentSnapshot
ÑÑC R
;
ÑÑR S
IObservable
ÜÜ 
<
ÜÜ "
ConnectivitySnapshot
ÜÜ (
>
ÜÜ( )#
connectivitySnapshots
ÜÜ* ?
=
ÜÜ@ A!
connectivityService
ÜÜB U
.
ÜÜU V 
ConnectivityStream
ÜÜV h
.
áá 
Publish
áá 
(
áá 
)
áá 
.
àà 
RefCount
àà 
(
àà 
)
àà 
;
àà 
IObservable
ää 
<
ää '
ManualRetryRequestedEvent
ää -
>
ää- .
manualRetryEvents
ää/ @
=
ääA B

Observable
ãã 
.
ãã 
Create
ãã 
<
ãã '
ManualRetryRequestedEvent
ãã 7
>
ãã7 8
(
ãã8 9
observer
ãã9 A
=>
ããB D
{
åå 
return
çç !
connectivityService
çç *
.
çç* +$
OnManualRetryRequested
çç+ A
(
ççA B
evt
éé 
=>
éé 
{
èè 
observer
êê  
.
êê  !
OnNext
êê! '
(
êê' (
evt
êê( +
)
êê+ ,
;
êê, -
return
ëë 
Task
ëë #
.
ëë# $
CompletedTask
ëë$ 1
;
ëë1 2
}
íí 
,
íí "
SubscriptionLifetime
ìì (
.
ìì( )
Scoped
ìì) /
)
ìì/ 0
;
ìì0 1
}
îî 
)
îî 
;
îî 
IObservable
ññ 
<
ññ "
ConnectivitySnapshot
ññ (
>
ññ( )
internetSnapshots
ññ* ;
=
ññ< =#
connectivitySnapshots
ññ> S
.
óó 
Where
óó 
(
óó 
snapshot
óó 
=>
óó 
snapshot
óó '
.
óó' (
Source
óó( .
==
óó/ 1 
ConnectivitySource
óó2 D
.
óóD E
InternetProbe
óóE R
)
óóR S
;
óóS T
IObservable
ôô 
<
ôô "
ConnectivitySnapshot
ôô (
>
ôô( )
serverSnapshots
ôô* 9
=
ôô: ;#
connectivitySnapshots
ôô< Q
.
öö 
Where
öö 
(
öö 
snapshot
öö 
=>
öö 
snapshot
öö '
.
öö' (
Source
öö( .
==
öö/ 1 
ConnectivitySource
öö2 D
.
ööD E

DataCenter
ööE O
)
ööO P
;
ööP Q
IObservable
úú 
<
úú (
DetailedConnectivityStatus
úú .
?
úú. /
>
úú/ 0&
internetStatusObservable
úú1 I
=
úúJ K
internetSnapshots
úúL ]
.
ùù 
Select
ùù 
(
ùù 
MapInternetStatus
ùù %
)
ùù% &
.
ûû 
	StartWith
ûû 
(
ûû 
initialSnapshot
ûû &
.
ûû& '
Source
ûû' -
==
ûû. 0 
ConnectivitySource
ûû1 C
.
ûûC D
InternetProbe
ûûD Q
?
üü 
MapInternetStatus
üü #
(
üü# $
initialSnapshot
üü$ 3
)
üü3 4
:
†† 
null
†† 
)
†† 
;
†† 
IObservable
¢¢ 
<
¢¢ (
DetailedConnectivityStatus
¢¢ .
?
¢¢. /
>
¢¢/ 0$
serverStatusObservable
¢¢1 G
=
¢¢H I
serverSnapshots
¢¢J Y
.
££ 
Select
££ 
(
££ 
MapServerStatus
££ #
)
££# $
.
§§ 
	StartWith
§§ 
(
§§ 
initialSnapshot
§§ &
.
§§& '
Source
§§' -
==
§§. 0 
ConnectivitySource
§§1 C
.
§§C D

DataCenter
§§D N
?
•• 
MapServerStatus
•• !
(
••! "
initialSnapshot
••" 1
)
••1 2
:
¶¶ 
null
¶¶ 
)
¶¶ 
;
¶¶ 
IObservable
®® 
<
®® (
DetailedConnectivityStatus
®® .
>
®®. /&
detailedStatusObservable
®®0 H
=
®®I J&
internetStatusObservable
®®K c
.
©© 
CombineLatest
©© 
(
©© $
serverStatusObservable
©© 1
,
©©1 2
(
©©3 4
internet
©©4 <
,
©©< =
server
©©> D
)
©©D E
=>
©©F H
{
™™ 
if
´´ 
(
´´ 
internet
´´ 
==
´´ (
DetailedConnectivityStatus
´´  :
.
´´: ;"
NoInternetConnection
´´; O
||
´´P R
internet
¨¨ 
==
¨¨ (
DetailedConnectivityStatus
¨¨  :
.
¨¨: ;(
CheckingInternetConnection
¨¨; U
)
¨¨U V
{
≠≠ 
return
ÆÆ 
internet
ÆÆ #
.
ÆÆ# $
Value
ÆÆ$ )
;
ÆÆ) *
}
ØØ 
if
±± 
(
±± 
server
±± 
.
±± 
HasValue
±± #
)
±±# $
{
≤≤ 
return
≥≥ 
server
≥≥ !
.
≥≥! "
Value
≥≥" '
;
≥≥' (
}
¥¥ 
return
∂∂ (
DetailedConnectivityStatus
∂∂ 1
.
∂∂1 2"
NoInternetConnection
∂∂2 F
;
∂∂F G
}
∑∑ 
)
∑∑ 
.
∏∏ "
DistinctUntilChanged
∏∏ !
(
∏∏! "
)
∏∏" #
;
∏∏# $
IObservable
∫∫ 
<
∫∫ '
ConnectivityIssueCategory
∫∫ -
>
∫∫- .%
issueCategoryObservable
∫∫/ F
=
∫∫G H&
detailedStatusObservable
∫∫I a
.
ªª 
Select
ªª 
(
ªª 
status
ªª 
=>
ªª 
status
ªª $
switch
ªª% +
{
ºº (
DetailedConnectivityStatus
ΩΩ *
.
ΩΩ* +"
NoInternetConnection
ΩΩ+ ?
or
ΩΩ@ B(
DetailedConnectivityStatus
ææ *
.
ææ* +(
CheckingInternetConnection
ææ+ E
or
ææF H(
DetailedConnectivityStatus
øø *
.
øø* +
InternetRestored
øø+ ;
=>
øø< >'
ConnectivityIssueCategory
øø? X
.
øøX Y!
InternetUnavailable
øøY l
,
øøl m
_
¿¿ 
=>
¿¿ '
ConnectivityIssueCategory
¿¿ .
.
¿¿. /
ServerUnreachable
¿¿/ @
}
¡¡ 
)
¡¡ 
.
¬¬ "
DistinctUntilChanged
¬¬ !
(
¬¬! "
)
¬¬" #
;
¬¬# $
IObservable
ƒƒ 
<
ƒƒ 
string
ƒƒ 
>
ƒƒ '
retryButtonTextObservable
ƒƒ 5
=
ƒƒ6 7
languageTrigger
ƒƒ8 G
.
≈≈ 
Select
≈≈ 
(
≈≈ 
_
≈≈ 
=>
≈≈ &
GetCachedRetryButtonText
≈≈ 1
(
≈≈1 2
)
≈≈2 3
)
≈≈3 4
;
≈≈4 5
IObservable
«« 
<
«« 
string
«« 
>
«« "
statusTextObservable
«« 0
=
««1 2&
detailedStatusObservable
««3 K
.
»» 
CombineLatest
»» 
(
»» 
languageTrigger
»» *
,
»»* +
(
»», -
status
»»- 3
,
»»3 4
_
»»5 6
)
»»6 7
=>
»»8 :
GetStatusText
»»; H
(
»»H I
status
»»I O
)
»»O P
)
»»P Q
;
»»Q R
IObservable
   
<
   
string
   
>
   )
statusDescriptionObservable
   7
=
  8 9&
detailedStatusObservable
  : R
.
ÀÀ 
CombineLatest
ÀÀ 
(
ÀÀ 
languageTrigger
ÀÀ *
,
ÀÀ* +
(
ÀÀ, -
status
ÀÀ- 3
,
ÀÀ3 4
_
ÀÀ5 6
)
ÀÀ6 7
=>
ÀÀ8 :"
GetStatusDescription
ÀÀ; O
(
ÀÀO P
status
ÀÀP V
)
ÀÀV W
)
ÀÀW X
;
ÀÀX Y
IObservable
ÕÕ 
<
ÕÕ 
Bitmap
ÕÕ 
?
ÕÕ 
>
ÕÕ "
statusIconObservable
ÕÕ 1
=
ÕÕ2 3%
issueCategoryObservable
ÕÕ4 K
.
ŒŒ 
Select
ŒŒ 
(
ŒŒ 
LoadCachedBitmap
ŒŒ $
)
ŒŒ$ %
;
ŒŒ% &
IObservable
–– 
<
–– 
bool
–– 
>
–– '
showRetryButtonObservable
–– 3
=
––4 5

Observable
––6 @
.
––@ A
Merge
––A F
(
––F G#
connectivitySnapshots
—— %
.
““ 
Where
““ 
(
““ 
snapshot
““ #
=>
““$ &
snapshot
““' /
.
““/ 0
Status
““0 6
==
““7 9 
ConnectivityStatus
““: L
.
““L M
RetriesExhausted
““M ]
)
““] ^
.
”” 
Do
”” 
(
”” 
_
”” 
=>
””  
LogRetryButtonShow
”” /
(
””/ 0
)
””0 1
)
””1 2
.
‘‘ 
Select
‘‘ 
(
‘‘ 
_
‘‘ 
=>
‘‘  
true
‘‘! %
)
‘‘% &
,
‘‘& '
manualRetryEvents
’’ !
.
÷÷ 
Do
÷÷ 
(
÷÷ 
_
÷÷ 
=>
÷÷ &
LogRetryButtonManualHide
÷÷ 5
(
÷÷5 6
)
÷÷6 7
)
÷÷7 8
.
◊◊ 
Select
◊◊ 
(
◊◊ 
_
◊◊ 
=>
◊◊  
false
◊◊! &
)
◊◊& '
,
◊◊' (#
connectivitySnapshots
ÿÿ %
.
ŸŸ 
Where
ŸŸ 
(
ŸŸ 
snapshot
ŸŸ #
=>
ŸŸ$ &
snapshot
ŸŸ' /
.
ŸŸ/ 0
Status
ŸŸ0 6
==
ŸŸ7 9 
ConnectivityStatus
ŸŸ: L
.
ŸŸL M
	Connected
ŸŸM V
)
ŸŸV W
.
⁄⁄ 
Do
⁄⁄ 
(
⁄⁄ *
LogRetryButtonConnectionHide
⁄⁄ 4
)
⁄⁄4 5
.
€€ 
Select
€€ 
(
€€ 
_
€€ 
=>
€€  
false
€€! &
)
€€& '
)
‹‹ 
.
›› 
	StartWith
›› 
(
›› 
false
›› 
)
›› 
;
›› 
IObservable
ﬂﬂ 
<
ﬂﬂ 
bool
ﬂﬂ 
>
ﬂﬂ !
isVisibleObservable
ﬂﬂ -
=
ﬂﬂ. /#
connectivitySnapshots
ﬂﬂ0 E
.
‡‡ 
Select
‡‡ 
(
‡‡ 
snapshot
‡‡ 
=>
‡‡ 
snapshot
‡‡  (
.
‡‡( )
Status
‡‡) /
switch
‡‡0 6
{
··  
ConnectivityStatus
‚‚ "
.
‚‚" #
	Connected
‚‚# ,
when
‚‚- 1
snapshot
‚‚2 :
.
‚‚: ;
Source
‚‚; A
==
‚‚B D 
ConnectivitySource
‚‚E W
.
‚‚W X
InternetProbe
‚‚X e
=>
‚‚f h

Observable
‚‚i s
.
„„ 
Return
„„ 
(
„„ 
false
„„ !
)
„„! "
,
„„" # 
ConnectivityStatus
‰‰ "
.
‰‰" #
	Connected
‰‰# ,
=>
‰‰- /

Observable
‰‰0 :
.
‰‰: ;
Return
‰‰; A
(
‰‰A B
true
‰‰B F
)
‰‰F G
.
ÂÂ 
Delay
ÂÂ 
(
ÂÂ 
TimeSpan
ÂÂ #
.
ÂÂ# $
FromMilliseconds
ÂÂ$ 4
(
ÂÂ4 5$
NetworkStatusConstants
ÂÂ5 K
.
ÂÂK L 
AUTO_HIDE_DELAY_MS
ÂÂL ^
)
ÂÂ^ _
)
ÂÂ_ `
.
ÊÊ 
Select
ÊÊ 
(
ÊÊ 
_
ÊÊ 
=>
ÊÊ  
false
ÊÊ! &
)
ÊÊ& '
,
ÊÊ' ( 
ConnectivityStatus
ÁÁ "
.
ÁÁ" #
RetriesExhausted
ÁÁ# 3
or
ÁÁ4 6 
ConnectivityStatus
ËË &
.
ËË& '
Disconnected
ËË' 3
or
ËË4 6 
ConnectivityStatus
ÈÈ &
.
ÈÈ& '
ShuttingDown
ÈÈ' 3
or
ÈÈ4 6 
ConnectivityStatus
ÍÍ &
.
ÍÍ& '

Recovering
ÍÍ' 1
=>
ÍÍ2 4

Observable
ÍÍ5 ?
.
ÍÍ? @
Return
ÍÍ@ F
(
ÍÍF G
true
ÍÍG K
)
ÍÍK L
,
ÍÍL M 
ConnectivityStatus
ÎÎ "
.
ÎÎ" #
Unavailable
ÎÎ# .
=>
ÎÎ/ 1

Observable
ÎÎ2 <
.
ÎÎ< =
Return
ÎÎ= C
(
ÎÎC D
true
ÎÎD H
)
ÎÎH I
,
ÎÎI J 
ConnectivityStatus
ÏÏ "
.
ÏÏ" #

Connecting
ÏÏ# -
when
ÏÏ. 2
snapshot
ÏÏ3 ;
.
ÏÏ; <
Source
ÏÏ< B
==
ÏÏC E 
ConnectivitySource
ÏÏF X
.
ÏÏX Y
InternetProbe
ÏÏY f
&&
ÌÌ3 5
snapshot
ÌÌ6 >
.
ÌÌ> ?
Reason
ÌÌ? E
==
ÌÌF H 
ConnectivityReason
ÌÌI [
.
ÌÌ[ \
InternetRecovered
ÌÌ\ m
=>
ÌÌn p

Observable
ÓÓ 
.
ÓÓ 
Return
ÓÓ %
(
ÓÓ% &
false
ÓÓ& +
)
ÓÓ+ ,
,
ÓÓ, - 
ConnectivityStatus
ÔÔ "
.
ÔÔ" #

Connecting
ÔÔ# -
when
ÔÔ. 2
snapshot
ÔÔ3 ;
.
ÔÔ; <
Source
ÔÔ< B
==
ÔÔC E 
ConnectivitySource
ÔÔF X
.
ÔÔX Y
InternetProbe
ÔÔY f
=>
ÔÔg i

Observable
ÔÔj t
.
 
Return
 
(
 
true
  
)
  !
,
! " 
ConnectivityStatus
ÒÒ "
.
ÒÒ" #

Connecting
ÒÒ# -
=>
ÒÒ. 0

Observable
ÒÒ1 ;
.
ÒÒ; <
Empty
ÒÒ< A
<
ÒÒA B
bool
ÒÒB F
>
ÒÒF G
(
ÒÒG H
)
ÒÒH I
,
ÒÒI J
_
ÚÚ 
=>
ÚÚ 

Observable
ÚÚ 
.
ÚÚ  
Return
ÚÚ  &
(
ÚÚ& '
false
ÚÚ' ,
)
ÚÚ, -
}
ÛÛ 
)
ÛÛ 
.
ÙÙ 
Switch
ÙÙ 
(
ÙÙ 
)
ÙÙ 
.
ıı 
	StartWith
ıı 
(
ıı 
false
ıı 
)
ıı 
;
ıı 
_issueCategory
˜˜ 
=
˜˜ %
issueCategoryObservable
˜˜ 0
.
˜˜0 1

ToProperty
˜˜1 ;
(
˜˜; <
this
˜˜< @
,
˜˜@ A
x
˜˜B C
=>
˜˜D F
x
˜˜G H
.
˜˜H I
IssueCategory
˜˜I V
)
˜˜V W
.
˜˜W X
DisposeWith
˜˜X c
(
˜˜c d
_disposables
˜˜d p
)
˜˜p q
;
˜˜q r
_detailedStatus
¯¯ 
=
¯¯ &
detailedStatusObservable
¯¯ 2
.
¯¯2 3

ToProperty
¯¯3 =
(
¯¯= >
this
¯¯> B
,
¯¯B C
x
¯¯D E
=>
¯¯F H
x
¯¯I J
.
¯¯J K
DetailedStatus
¯¯K Y
)
¯¯Y Z
.
¯¯Z [
DisposeWith
¯¯[ f
(
¯¯f g
_disposables
¯¯g s
)
¯¯s t
;
¯¯t u
_statusText
˘˘ 
=
˘˘ "
statusTextObservable
˘˘ *
.
˘˘* +

ToProperty
˘˘+ 5
(
˘˘5 6
this
˘˘6 :
,
˘˘: ;
x
˘˘< =
=>
˘˘> @
x
˘˘A B
.
˘˘B C

StatusText
˘˘C M
)
˘˘M N
.
˘˘N O
DisposeWith
˘˘O Z
(
˘˘Z [
_disposables
˘˘[ g
)
˘˘g h
;
˘˘h i 
_statusDescription
˙˙ 
=
˙˙ )
statusDescriptionObservable
˙˙ 8
.
˙˙8 9

ToProperty
˙˙9 C
(
˙˙C D
this
˙˙D H
,
˙˙H I
x
˙˙J K
=>
˙˙L N
x
˙˙O P
.
˙˙P Q
StatusDescription
˙˙Q b
)
˙˙b c
.
˚˚ 
DisposeWith
˚˚ 
(
˚˚ 
_disposables
˚˚ %
)
˚˚% &
;
˚˚& '
_statusIconSource
¸¸ 
=
¸¸ "
statusIconObservable
¸¸ 0
.
¸¸0 1

ToProperty
¸¸1 ;
(
¸¸; <
this
¸¸< @
,
¸¸@ A
x
¸¸B C
=>
¸¸D F
x
¸¸G H
.
¸¸H I
StatusIconSource
¸¸I Y
)
¸¸Y Z
.
¸¸Z [
DisposeWith
¸¸[ f
(
¸¸f g
_disposables
¸¸g s
)
¸¸s t
;
¸¸t u
_showRetryButton
˝˝ 
=
˝˝ '
showRetryButtonObservable
˝˝ 4
.
˝˝4 5

ToProperty
˝˝5 ?
(
˝˝? @
this
˝˝@ D
,
˝˝D E
x
˝˝F G
=>
˝˝H J
x
˝˝K L
.
˝˝L M
ShowRetryButton
˝˝M \
)
˝˝\ ]
.
˝˝] ^
DisposeWith
˝˝^ i
(
˝˝i j
_disposables
˝˝j v
)
˝˝v w
;
˝˝w x

_isVisible
˛˛ 
=
˛˛ !
isVisibleObservable
˛˛ (
.
˛˛( )

ToProperty
˛˛) 3
(
˛˛3 4
this
˛˛4 8
,
˛˛8 9
x
˛˛: ;
=>
˛˛< >
x
˛˛? @
.
˛˛@ A
	IsVisible
˛˛A J
)
˛˛J K
.
˛˛K L
DisposeWith
˛˛L W
(
˛˛W X
_disposables
˛˛X d
)
˛˛d e
;
˛˛e f
_isAnimating
ˇˇ 
=
ˇˇ 

Observable
ˇˇ !
.
ˇˇ! "
Return
ˇˇ" (
(
ˇˇ( )
false
ˇˇ) .
)
ˇˇ. /
.
ˇˇ/ 0

ToProperty
ˇˇ0 :
(
ˇˇ: ;
this
ˇˇ; ?
,
ˇˇ? @
x
ˇˇA B
=>
ˇˇC E
x
ˇˇF G
.
ˇˇG H
IsAnimating
ˇˇH S
)
ˇˇS T
.
ˇˇT U
DisposeWith
ˇˇU `
(
ˇˇ` a
_disposables
ˇˇa m
)
ˇˇm n
;
ˇˇn o
_retryButtonText
ÄÄ 
=
ÄÄ '
retryButtonTextObservable
ÄÄ 4
.
ÄÄ4 5

ToProperty
ÄÄ5 ?
(
ÄÄ? @
this
ÄÄ@ D
,
ÄÄD E
x
ÄÄF G
=>
ÄÄH J
x
ÄÄK L
.
ÄÄL M
RetryButtonText
ÄÄM \
)
ÄÄ\ ]
.
ÄÄ] ^
DisposeWith
ÄÄ^ i
(
ÄÄi j
_disposables
ÄÄj v
)
ÄÄv w
;
ÄÄw x
RetryCommand
ÇÇ 
=
ÇÇ 
ReactiveCommand
ÇÇ &
.
ÇÇ& '
CreateFromTask
ÇÇ' 5
(
ÇÇ5 6
async
ÉÉ 
ct
ÉÉ 
=>
ÉÉ 
{
ÑÑ 
try
ÖÖ 
{
ÜÜ 
Log
áá 
.
áá 
Information
áá #
(
áá# $
$str
áá$ g
)
áág h
;
ááh i
await
ââ !
connectivityService
ââ -
.
ââ- .%
RequestManualRetryAsync
ââ. E
(
ââE F
)
ââF G
;
ââG H
int
ãã 
retriedCount
ãã $
=
ãã% &
await
ãã' ,#
pendingRequestManager
ãã- B
.
ããB C*
RetryAllPendingRequestsAsync
ããC _
(
ãã_ `
ct
ãã` b
)
ããb c
;
ããc d
Log
åå 
.
åå 
Information
åå #
(
åå# $
$str
åå$ f
,
ååf g
retriedCount
ååh t
)
ååt u
;
ååu v
}
çç 
catch
éé 
(
éé 
	Exception
éé  
ex
éé! #
)
éé# $
{
èè 
Log
êê 
.
êê 
Error
êê 
(
êê 
ex
êê  
,
êê  !
$str
êê" G
)
êêG H
;
êêH I
}
ëë 
}
íí 
,
íí '
showRetryButtonObservable
ìì %
)
îî 	
.
îî	 

DisposeWith
îî
 
(
îî 
_disposables
îî "
)
îî" #
;
îî# $#
connectivitySnapshots
ññ 
.
óó 
	ObserveOn
óó 
(
óó 
RxApp
óó 
.
óó 
TaskpoolScheduler
óó .
)
óó. /
.
òò 
	Subscribe
òò 
(
òò 
snapshot
òò 
=>
òò  "
{
ôô 
LogNetworkEvent
öö 
(
öö  
snapshot
öö  (
)
öö( )
;
öö) *-
HandleConnectivityVisualEffects
õõ /
(
õõ/ 0
snapshot
õõ0 8
)
õõ8 9
;
õõ9 :
}
úú 
)
úú 
.
ùù 
DisposeWith
ùù 
(
ùù 
_disposables
ùù %
)
ùù% &
;
ùù& '!
isVisibleObservable
üü 
.
†† "
DistinctUntilChanged
†† !
(
††! "
)
††" #
.
°° 
	ObserveOn
°° 
(
°° 
RxApp
°° 
.
°° 
TaskpoolScheduler
°° .
)
°°. /
.
¢¢ 
	Subscribe
¢¢ 
(
¢¢ 
visible
¢¢ 
=>
¢¢ !
{
¢¢" #)
HandleVisibilityChangeAsync
¢¢$ ?
(
¢¢? @
visible
¢¢@ G
)
¢¢G H
.
¢¢H I
ConfigureAwait
¢¢I W
(
¢¢W X
false
¢¢X ]
)
¢¢] ^
;
¢¢^ _
}
¢¢` a
)
¢¢a b
.
££ 
DisposeWith
££ 
(
££ 
_disposables
££ %
)
££% &
;
££& '
}
§§ 
private
¶¶ %
CancellationTokenSource
¶¶ #
?
¶¶# $-
_visibilityOperationTokenSource
¶¶% D
;
¶¶D E
private
®® 
void
®® 
ClearStringCache
®® !
(
®®! "
)
®®" #
{
©©  
_cachedStatusTexts
™™ 
.
™™ 
Clear
™™  
(
™™  !
)
™™! "
;
™™" #'
_cachedStatusDescriptions
´´ !
.
´´! "
Clear
´´" '
(
´´' (
)
´´( )
;
´´) *$
_cachedRetryButtonText
¨¨ 
=
¨¨  
null
¨¨! %
;
¨¨% &
}
≠≠ 
private
ØØ 
async
ØØ 
Task
ØØ )
HandleVisibilityChangeAsync
ØØ 2
(
ØØ2 3
bool
ØØ3 7
visible
ØØ8 ?
)
ØØ? @
{
∞∞ 
await
±± 

Dispatcher
±± 
.
±± 
UIThread
±± !
.
±±! "
InvokeAsync
±±" -
(
±±- .
async
±±. 3
(
±±4 5
)
±±5 6
=>
±±7 9
{
≤≤ 	%
CancellationTokenSource
≥≥ #
?
≥≥# $!
previousTokenSource
≥≥% 8
=
≥≥9 :-
_visibilityOperationTokenSource
≥≥; Z
;
≥≥Z [%
CancellationTokenSource
¥¥ #
newTokenSource
¥¥$ 2
=
¥¥3 4
new
¥¥5 8
(
¥¥8 9
)
¥¥9 :
;
¥¥: ;-
_visibilityOperationTokenSource
µµ +
=
µµ, -
newTokenSource
µµ. <
;
µµ< =
try
∑∑ 
{
∏∏ !
previousTokenSource
ππ #
?
ππ# $
.
ππ$ %
Cancel
ππ% +
(
ππ+ ,
)
ππ, -
;
ππ- .!
LogVisibilityChange
∫∫ #
(
∫∫# $
visible
∫∫$ +
)
∫∫+ ,
;
∫∫, -
if
ºº 
(
ºº 
visible
ºº 
)
ºº 
{
ΩΩ 
await
ææ 
	ShowAsync
ææ #
(
ææ# $
newTokenSource
ææ$ 2
.
ææ2 3
Token
ææ3 8
)
ææ8 9
;
ææ9 :
}
øø 
else
¿¿ 
{
¡¡ 
await
¬¬ 
	HideAsync
¬¬ #
(
¬¬# $
newTokenSource
¬¬$ 2
.
¬¬2 3
Token
¬¬3 8
)
¬¬8 9
;
¬¬9 :
}
√√ 
}
ƒƒ 
catch
≈≈ 
(
≈≈ (
OperationCanceledException
≈≈ -
)
≈≈- .
{
∆∆ #
LogOperationCancelled
«« %
(
««% &
)
««& '
;
««' (
}
»» 
catch
…… 
(
…… 
	Exception
…… 
ex
…… 
)
……  
{
   
Log
ÀÀ 
.
ÀÀ 
Error
ÀÀ 
(
ÀÀ 
ex
ÀÀ 
,
ÀÀ 
$str
ÀÀ F
)
ÀÀF G
;
ÀÀG H
}
ÃÃ 
finally
ÕÕ 
{
ŒŒ 
if
œœ 
(
œœ -
_visibilityOperationTokenSource
œœ 3
==
œœ4 6
newTokenSource
œœ7 E
)
œœE F
{
–– -
_visibilityOperationTokenSource
—— 3
=
——4 5
null
——6 :
;
——: ;
}
““ 
newTokenSource
‘‘ 
.
‘‘ 
Dispose
‘‘ &
(
‘‘& '
)
‘‘' (
;
‘‘( )!
previousTokenSource
’’ #
?
’’# $
.
’’$ %
Dispose
’’% ,
(
’’, -
)
’’- .
;
’’. /
}
÷÷ 
}
◊◊ 	
)
◊◊	 

;
◊◊
 
}
ÿÿ 
private
⁄⁄ 
void
⁄⁄ -
HandleConnectivityVisualEffects
⁄⁄ 0
(
⁄⁄0 1"
ConnectivitySnapshot
⁄⁄1 E
snapshot
⁄⁄F N
)
⁄⁄N O
{
€€ 
bool
‹‹ 
isServerIssue
‹‹ 
=
‹‹ 
snapshot
‹‹ %
.
‹‹% &
Status
‹‹& ,
is
‹‹- / 
ConnectivityStatus
‹‹0 B
.
‹‹B C
RetriesExhausted
‹‹C S
or
››  
ConnectivityStatus
›› !
.
››! "
Disconnected
››" .
or
ﬁﬁ  
ConnectivityStatus
ﬁﬁ !
.
ﬁﬁ! "
ShuttingDown
ﬁﬁ" .
;
ﬁﬁ. /

Dispatcher
ﬂﬂ 
.
ﬂﬂ 
UIThread
ﬂﬂ 
.
ﬂﬂ 
InvokeAsync
ﬂﬂ '
(
ﬂﬂ' (
(
ﬂﬂ( )
)
ﬂﬂ) *
=>
ﬂﬂ+ -
ApplyClasses
ﬂﬂ. :
(
ﬂﬂ: ;
serverIssue
ﬂﬂ; F
:
ﬂﬂF G
isServerIssue
ﬂﬂH U
)
ﬂﬂU V
)
ﬂﬂV W
;
ﬂﬂW X
}
‡‡ 
private
‚‚ 
void
‚‚ 
ApplyClasses
‚‚ 
(
‚‚ 
bool
‚‚ "
serverIssue
‚‚# .
)
‚‚. /
{
„„ 
if
‰‰ 

(
‰‰ 
_mainBorder
‰‰ 
==
‰‰ 
null
‰‰ 
)
‰‰  
{
ÂÂ 	
return
ÊÊ 
;
ÊÊ 
}
ÁÁ 	
if
ÈÈ 

(
ÈÈ 
serverIssue
ÈÈ 
)
ÈÈ 
{
ÍÍ 	
_mainBorder
ÎÎ 
.
ÎÎ 
Classes
ÎÎ 
.
ÎÎ  
Add
ÎÎ  #
(
ÎÎ# $
$str
ÎÎ$ 1
)
ÎÎ1 2
;
ÎÎ2 3
}
ÏÏ 	
else
ÌÌ 
{
ÓÓ 	
_mainBorder
ÔÔ 
.
ÔÔ 
Classes
ÔÔ 
.
ÔÔ  
Remove
ÔÔ  &
(
ÔÔ& '
$str
ÔÔ' 4
)
ÔÔ4 5
;
ÔÔ5 6
}
 	
_mainBorder
ÚÚ 
.
ÚÚ 
Classes
ÚÚ 
.
ÚÚ 
Remove
ÚÚ "
(
ÚÚ" #
$str
ÚÚ# -
)
ÚÚ- .
;
ÚÚ. /
}
ÛÛ 
private
ıı 
void
ıı 
CreateAnimations
ıı !
(
ıı! "
)
ıı" #
{
ˆˆ 
if
˜˜ 

(
˜˜ 
_view
˜˜ 
==
˜˜ 
null
˜˜ 
)
˜˜ 
{
¯¯ 	
return
˘˘ 
;
˘˘ 
}
˙˙ 	$
_sharedAppearAnimation
¸¸ 
??=
¸¸ "
new
¸¸# &
	Animation
¸¸' 0
{
˝˝ 	
Duration
˛˛ 
=
˛˛ 
AppearDuration
˛˛ %
,
˛˛% &
Easing
ˇˇ 
=
ˇˇ 
new
ˇˇ 
QuadraticEaseOut
ˇˇ )
(
ˇˇ) *
)
ˇˇ* +
,
ˇˇ+ ,
FillMode
ÄÄ 
=
ÄÄ 
FillMode
ÄÄ 
.
ÄÄ  
Both
ÄÄ  $
,
ÄÄ$ %
Children
ÅÅ 
=
ÅÅ 
{
ÇÇ 
new
ÉÉ 
KeyFrame
ÉÉ 
{
ÑÑ 
Cue
ÖÖ 
=
ÖÖ 
new
ÖÖ 
Cue
ÖÖ !
(
ÖÖ! "
$num
ÖÖ" $
)
ÖÖ$ %
,
ÖÖ% &
Setters
ÜÜ 
=
ÜÜ 
{
ÜÜ 
new
ÜÜ  #
Setter
ÜÜ$ *
(
ÜÜ* +
Visual
ÜÜ+ 1
.
ÜÜ1 2
OpacityProperty
ÜÜ2 A
,
ÜÜA B
$num
ÜÜC E
)
ÜÜE F
,
ÜÜF G
new
ÜÜH K
Setter
ÜÜL R
(
ÜÜR S 
TranslateTransform
ÜÜS e
.
ÜÜe f
	YProperty
ÜÜf o
,
ÜÜo p
-
ÜÜq r
$num
ÜÜr u
)
ÜÜu v
}
ÜÜw x
}
áá 
,
áá 
new
àà 
KeyFrame
àà 
{
ââ 
Cue
ää 
=
ää 
new
ää 
Cue
ää !
(
ää! "
$num
ää" $
)
ää$ %
,
ää% &
Setters
ãã 
=
ãã 
{
ãã 
new
ãã  #
Setter
ãã$ *
(
ãã* +
Visual
ãã+ 1
.
ãã1 2
OpacityProperty
ãã2 A
,
ããA B
$num
ããC E
)
ããE F
,
ããF G
new
ããH K
Setter
ããL R
(
ããR S 
TranslateTransform
ããS e
.
ããe f
	YProperty
ããf o
,
ãão p
$num
ããq s
)
ããs t
}
ããu v
}
åå 
}
çç 
}
éé 	
;
éé	 
'
_sharedDisappearAnimation
êê !
??=
êê" %
new
êê& )
	Animation
êê* 3
{
ëë 	
Duration
íí 
=
íí 
DisappearDuration
íí (
,
íí( )
Easing
ìì 
=
ìì 
new
ìì 
QuadraticEaseIn
ìì (
(
ìì( )
)
ìì) *
,
ìì* +
FillMode
îî 
=
îî 
FillMode
îî 
.
îî  
Both
îî  $
,
îî$ %
Children
ïï 
=
ïï 
{
ññ 
new
óó 
KeyFrame
óó 
{
òò 
Cue
ôô 
=
ôô 
new
ôô 
Cue
ôô !
(
ôô! "
$num
ôô" $
)
ôô$ %
,
ôô% &
Setters
öö 
=
öö 
{
öö 
new
öö  #
Setter
öö$ *
(
öö* +
Visual
öö+ 1
.
öö1 2
OpacityProperty
öö2 A
,
ööA B
$num
ööC E
)
ööE F
,
ööF G
new
ööH K
Setter
ööL R
(
ööR S 
TranslateTransform
ööS e
.
ööe f
	YProperty
ööf o
,
ööo p
$num
ööq s
)
öös t
}
ööu v
}
õõ 
,
õõ 
new
úú 
KeyFrame
úú 
{
ùù 
Cue
ûû 
=
ûû 
new
ûû 
Cue
ûû !
(
ûû! "
$num
ûû" $
)
ûû$ %
,
ûû% &
Setters
üü 
=
üü 
{
üü 
new
üü  #
Setter
üü$ *
(
üü* +
Visual
üü+ 1
.
üü1 2
OpacityProperty
üü2 A
,
üüA B
$num
üüC E
)
üüE F
,
üüF G
new
üüH K
Setter
üüL R
(
üüR S 
TranslateTransform
üüS e
.
üüe f
	YProperty
üüf o
,
üüo p
-
üüq r
$num
üür u
)
üüu v
}
üüw x
}
†† 
}
°° 
}
¢¢ 	
;
¢¢	 
'
_sharedTranslateTransform
§§ !
??=
§§" %
new
§§& ) 
TranslateTransform
§§* <
(
§§< =
)
§§= >
;
§§> ?
}
•• 
private
ßß 
async
ßß 
Task
ßß 
	ShowAsync
ßß  
(
ßß  !
CancellationToken
ßß! 2
token
ßß3 8
)
ßß8 9
{
®® 
if
©© 

(
©© 
_view
©© 
==
©© 
null
©© 
)
©© 
{
™™ 	
return
´´ 
;
´´ 
}
¨¨ 	
try
ÆÆ 
{
ØØ 	
_view
∞∞ 
.
∞∞ 
	IsVisible
∞∞ 
=
∞∞ 
true
∞∞ "
;
∞∞" #
_view
±± 
.
±± 
RenderTransform
±± !
=
±±" #'
_sharedTranslateTransform
±±$ =
;
±±= >
if
≤≤ 
(
≤≤ $
_sharedAppearAnimation
≤≤ &
==
≤≤' )
null
≤≤* .
)
≤≤. /
{
≥≥ 
CreateAnimations
¥¥  
(
¥¥  !
)
¥¥! "
;
¥¥" #
}
µµ 
await
∂∂ $
_sharedAppearAnimation
∂∂ (
!
∂∂( )
.
∂∂) *
RunAsync
∂∂* 2
(
∂∂2 3
_view
∂∂3 8
,
∂∂8 9
token
∂∂: ?
)
∂∂? @
;
∂∂@ A
}
∑∑ 	
catch
∏∏ 
(
∏∏ (
OperationCanceledException
∏∏ )
)
∏∏) *
{
ππ 	
}
ªª 	
catch
ºº 
(
ºº 
	Exception
ºº 
ex
ºº 
)
ºº 
{
ΩΩ 	
Log
ææ 
.
ææ 
Warning
ææ 
(
ææ 
ex
ææ 
,
ææ 
$str
ææ >
)
ææ> ?
;
ææ? @
}
øø 	
}
¿¿ 
private
¬¬ 
async
¬¬ 
Task
¬¬ 
	HideAsync
¬¬  
(
¬¬  !
CancellationToken
¬¬! 2
token
¬¬3 8
)
¬¬8 9
{
√√ 
if
ƒƒ 

(
ƒƒ 
_view
ƒƒ 
==
ƒƒ 
null
ƒƒ 
)
ƒƒ 
{
≈≈ 	
return
∆∆ 
;
∆∆ 
}
«« 	
try
…… 
{
   	
if
ÀÀ 
(
ÀÀ '
_sharedDisappearAnimation
ÀÀ )
==
ÀÀ* ,
null
ÀÀ- 1
)
ÀÀ1 2
{
ÃÃ 
CreateAnimations
ÕÕ  
(
ÕÕ  !
)
ÕÕ! "
;
ÕÕ" #
}
ŒŒ 
await
œœ '
_sharedDisappearAnimation
œœ +
!
œœ+ ,
.
œœ, -
RunAsync
œœ- 5
(
œœ5 6
_view
œœ6 ;
,
œœ; <
token
œœ= B
)
œœB C
;
œœC D
_view
–– 
.
–– 
	IsVisible
–– 
=
–– 
false
–– #
;
––# $
}
—— 	
catch
““ 
(
““ (
OperationCanceledException
““ )
)
““) *
{
”” 	
}
’’ 	
catch
÷÷ 
(
÷÷ 
	Exception
÷÷ 
ex
÷÷ 
)
÷÷ 
{
◊◊ 	
Log
ÿÿ 
.
ÿÿ 
Warning
ÿÿ 
(
ÿÿ 
ex
ÿÿ 
,
ÿÿ 
$str
ÿÿ =
)
ÿÿ= >
;
ÿÿ> ?
}
ŸŸ 	
}
⁄⁄ 
private
‹‹ 
Bitmap
‹‹ 
?
‹‹ 
LoadCachedBitmap
‹‹ $
(
‹‹$ %'
ConnectivityIssueCategory
‹‹% >
category
‹‹? G
)
‹‹G H
{
›› 
try
ﬁﬁ 
{
ﬂﬂ 	
return
‡‡ 
category
‡‡ 
switch
‡‡ "
{
·· '
ConnectivityIssueCategory
‚‚ )
.
‚‚) *
ServerUnreachable
‚‚* ;
=>
‚‚< >*
_cachedServerUnreachableIcon
‚‚? [
??=
‚‚\ _
LoadBitmapFromUri
„„ %
(
„„% &$
NetworkStatusConstants
„„& <
.
„„< =,
SERVER_NOT_RESPONDING_ICON_URI
„„= [
)
„„[ \
,
„„\ ]
_
‰‰ 
=>
‰‰ ,
_cachedInternetUnavailableIcon
‰‰ 3
??=
‰‰4 7
LoadBitmapFromUri
ÂÂ %
(
ÂÂ% &$
NetworkStatusConstants
ÂÂ& <
.
ÂÂ< ="
NO_INTERNET_ICON_URI
ÂÂ= Q
)
ÂÂQ R
}
ÊÊ 
;
ÊÊ 
}
ÁÁ 	
catch
ËË 
(
ËË 
	Exception
ËË 
ex
ËË 
)
ËË 
{
ÈÈ 	
Log
ÍÍ 
.
ÍÍ 
Error
ÍÍ 
(
ÍÍ 
ex
ÍÍ 
,
ÍÍ 
$str
ÍÍ Q
,
ÍÍQ R
category
ÍÍS [
)
ÍÍ[ \
;
ÍÍ\ ]
return
ÎÎ 
null
ÎÎ 
;
ÎÎ 
}
ÏÏ 	
}
ÌÌ 
private
ÔÔ 
static
ÔÔ 
Bitmap
ÔÔ 
LoadBitmapFromUri
ÔÔ +
(
ÔÔ+ ,
string
ÔÔ, 2
	uriString
ÔÔ3 <
)
ÔÔ< =
{
 
Uri
ÒÒ 
uri
ÒÒ 
=
ÒÒ 
new
ÒÒ 
(
ÒÒ 
	uriString
ÒÒ 
,
ÒÒ  
UriKind
ÒÒ! (
.
ÒÒ( )
Absolute
ÒÒ) 1
)
ÒÒ1 2
;
ÒÒ2 3
return
ÚÚ 
new
ÚÚ 
Bitmap
ÚÚ 
(
ÚÚ 
AssetLoader
ÚÚ %
.
ÚÚ% &
Open
ÚÚ& *
(
ÚÚ* +
uri
ÚÚ+ .
)
ÚÚ. /
)
ÚÚ/ 0
;
ÚÚ0 1
}
ÛÛ 
private
ıı 
string
ıı 
GetStatusText
ıı  
(
ıı  !(
DetailedConnectivityStatus
ıı! ;
status
ıı< B
)
ııB C
{
ˆˆ 
if
˜˜ 

(
˜˜  
_cachedStatusTexts
˜˜ 
.
˜˜ 
TryGetValue
˜˜ *
(
˜˜* +
status
˜˜+ 1
,
˜˜1 2
out
˜˜3 6
string
˜˜7 =
?
˜˜= >
cached
˜˜? E
)
˜˜E F
)
˜˜F G
{
¯¯ 	
return
˘˘ 
cached
˘˘ 
;
˘˘ 
}
˙˙ 	
string
¸¸ 
key
¸¸ 
=
¸¸ 
status
¸¸ 
switch
¸¸ "
{
˝˝ 	(
DetailedConnectivityStatus
˛˛ &
.
˛˛& '"
NoInternetConnection
˛˛' ;
=>
˛˛< >
$str
˛˛? e
,
˛˛e f(
DetailedConnectivityStatus
ˇˇ &
.
ˇˇ& '(
CheckingInternetConnection
ˇˇ' A
=>
ˇˇB D
$str
ˇˇE q
,
ˇˇq r(
DetailedConnectivityStatus
ÄÄ &
.
ÄÄ& '
InternetRestored
ÄÄ' 7
=>
ÄÄ8 :
$str
ÄÄ; g
,
ÄÄg h(
DetailedConnectivityStatus
ÅÅ &
.
ÅÅ& ' 
ConnectingToServer
ÅÅ' 9
=>
ÅÅ: <
$str
ÅÅ= c
,
ÅÅc d(
DetailedConnectivityStatus
ÇÇ &
.
ÇÇ& '
Reconnecting
ÇÇ' 3
=>
ÇÇ4 6
$str
ÇÇ7 _
,
ÇÇ_ `(
DetailedConnectivityStatus
ÉÉ &
.
ÉÉ& '!
ServerNotResponding
ÉÉ' :
=>
ÉÉ; =
$str
ÉÉ> m
,
ÉÉm n(
DetailedConnectivityStatus
ÑÑ &
.
ÑÑ& ' 
ServerShuttingDown
ÑÑ' 9
=>
ÑÑ: <
$str
ÑÑ= k
,
ÑÑk l(
DetailedConnectivityStatus
ÖÖ &
.
ÖÖ& '
RetriesExhausted
ÖÖ' 7
=>
ÖÖ8 :
$str
ÖÖ; g
,
ÖÖg h(
DetailedConnectivityStatus
ÜÜ &
.
ÜÜ& '
ServerReconnected
ÜÜ' 8
=>
ÜÜ9 ;
$str
ÜÜ< i
,
ÜÜi j
_
áá 
=>
áá 
$str
áá 7
}
àà 	
;
àà	 

string
ää 
text
ää 
=
ää !
LocalizationService
ää )
[
ää) *
key
ää* -
]
ää- .
;
ää. / 
_cachedStatusTexts
ãã 
[
ãã 
status
ãã !
]
ãã! "
=
ãã# $
text
ãã% )
;
ãã) *
return
åå 
text
åå 
;
åå 
}
çç 
private
èè 
string
èè "
GetStatusDescription
èè '
(
èè' ((
DetailedConnectivityStatus
èè( B
status
èèC I
)
èèI J
{
êê 
if
ëë 

(
ëë '
_cachedStatusDescriptions
ëë %
.
ëë% &
TryGetValue
ëë& 1
(
ëë1 2
status
ëë2 8
,
ëë8 9
out
ëë: =
string
ëë> D
?
ëëD E
cached
ëëF L
)
ëëL M
)
ëëM N
{
íí 	
return
ìì 
cached
ìì 
;
ìì 
}
îî 	
string
ññ 
key
ññ 
=
ññ 
status
ññ 
switch
ññ "
{
óó 	(
DetailedConnectivityStatus
òò &
.
òò& '"
NoInternetConnection
òò' ;
=>
òò< >
$str
òò? k
,
òòk l(
DetailedConnectivityStatus
ôô &
.
ôô& '(
CheckingInternetConnection
ôô' A
=>
ôôB D
$str
ôôE w
,
ôôw x(
DetailedConnectivityStatus
öö &
.
öö& '
InternetRestored
öö' 7
=>
öö8 :
$str
öö; m
,
ööm n(
DetailedConnectivityStatus
õõ &
.
õõ& ' 
ConnectingToServer
õõ' 9
=>
õõ: <
$str
õõ= i
,
õõi j(
DetailedConnectivityStatus
úú &
.
úú& '
Reconnecting
úú' 3
=>
úú4 6
$str
úú7 e
,
úúe f(
DetailedConnectivityStatus
ùù &
.
ùù& '!
ServerNotResponding
ùù' :
=>
ùù; =
$str
ùù> s
,
ùùs t(
DetailedConnectivityStatus
ûû &
.
ûû& ' 
ServerShuttingDown
ûû' 9
=>
ûû: <
$str
ûû= q
,
ûûq r(
DetailedConnectivityStatus
üü &
.
üü& '
RetriesExhausted
üü' 7
=>
üü8 :
$str
üü; m
,
üüm n(
DetailedConnectivityStatus
†† &
.
††& '
ServerReconnected
††' 8
=>
††9 ;
$str
††< o
,
††o p
_
°° 
=>
°° 
$str
°° =
}
¢¢ 	
;
¢¢	 

string
§§ 
text
§§ 
=
§§ !
LocalizationService
§§ )
[
§§) *
key
§§* -
]
§§- .
;
§§. /'
_cachedStatusDescriptions
•• !
[
••! "
status
••" (
]
••( )
=
••* +
text
••, 0
;
••0 1
return
¶¶ 
text
¶¶ 
;
¶¶ 
}
ßß 
private
©© 
string
©© &
GetCachedRetryButtonText
©© +
(
©©+ ,
)
©©, -
=>
©©. 0$
_cachedRetryButtonText
™™ 
??=
™™ "!
LocalizationService
™™# 6
[
™™6 7
$str
™™7 Y
]
™™Y Z
;
™™Z [
private
¨¨ 
static
¨¨ (
DetailedConnectivityStatus
¨¨ -
?
¨¨- .
MapInternetStatus
¨¨/ @
(
¨¨@ A"
ConnectivitySnapshot
¨¨A U
snapshot
¨¨V ^
)
¨¨^ _
{
≠≠ 
return
ÆÆ 
snapshot
ÆÆ 
.
ÆÆ 
Status
ÆÆ 
switch
ÆÆ %
{
ØØ 	 
ConnectivityStatus
∞∞ 
.
∞∞ 
Unavailable
∞∞ *
=>
∞∞+ -(
DetailedConnectivityStatus
∞∞. H
.
∞∞H I"
NoInternetConnection
∞∞I ]
,
∞∞] ^ 
ConnectivityStatus
≤≤ 
.
≤≤ 

Connecting
≤≤ )
when
≤≤* .
snapshot
≤≤/ 7
.
≤≤7 8
Reason
≤≤8 >
==
≤≤? A 
ConnectivityReason
≤≤B T
.
≤≤T U
InternetRecovered
≤≤U f
=>
≥≥ (
DetailedConnectivityStatus
≥≥ -
.
≥≥- .
InternetRestored
≥≥. >
,
≥≥> ? 
ConnectivityStatus
µµ 
.
µµ 

Connecting
µµ )
=>
µµ* ,(
DetailedConnectivityStatus
µµ- G
.
µµG H(
CheckingInternetConnection
µµH b
,
µµb c
_
∑∑ 
=>
∑∑ 
null
∑∑ 
}
∏∏ 	
;
∏∏	 

}
ππ 
private
ªª 
static
ªª (
DetailedConnectivityStatus
ªª -
?
ªª- .
MapServerStatus
ªª/ >
(
ªª> ?"
ConnectivitySnapshot
ªª? S
snapshot
ªªT \
)
ªª\ ]
{
ºº 
return
ΩΩ 
snapshot
ΩΩ 
.
ΩΩ 
Status
ΩΩ 
switch
ΩΩ %
{
ææ 	 
ConnectivityStatus
øø 
.
øø 

Connecting
øø )
=>
øø* ,(
DetailedConnectivityStatus
øø- G
.
øøG H 
ConnectingToServer
øøH Z
,
øøZ [ 
ConnectivityStatus
¡¡ 
.
¡¡ 

Recovering
¡¡ )
=>
¡¡* ,(
DetailedConnectivityStatus
¡¡- G
.
¡¡G H
Reconnecting
¡¡H T
,
¡¡T U 
ConnectivityStatus
√√ 
.
√√ 
RetriesExhausted
√√ /
=>
√√0 2(
DetailedConnectivityStatus
√√3 M
.
√√M N
RetriesExhausted
√√N ^
,
√√^ _ 
ConnectivityStatus
≈≈ 
.
≈≈ 
ShuttingDown
≈≈ +
=>
≈≈, .(
DetailedConnectivityStatus
≈≈/ I
.
≈≈I J 
ServerShuttingDown
≈≈J \
,
≈≈\ ] 
ConnectivityStatus
«« 
.
«« 
Disconnected
«« +
=>
««, .(
DetailedConnectivityStatus
««/ I
.
««I J!
ServerNotResponding
««J ]
,
««] ^ 
ConnectivityStatus
…… 
.
…… 
	Connected
…… (
=>
……) +(
DetailedConnectivityStatus
……, F
.
……F G
ServerReconnected
……G X
,
……X Y
_
ÀÀ 
=>
ÀÀ 
null
ÀÀ 
}
ÃÃ 	
;
ÃÃ	 

}
ÕÕ 
public
œœ 

void
œœ 
Dispose
œœ 
(
œœ 
)
œœ 
{
–– 
if
—— 

(
—— 
	_disposed
—— 
)
—— 
{
““ 	
return
”” 
;
”” 
}
‘‘ 	
try
÷÷ 
{
◊◊ 	-
_visibilityOperationTokenSource
ÿÿ +
?
ÿÿ+ ,
.
ÿÿ, -
Cancel
ÿÿ- 3
(
ÿÿ3 4
)
ÿÿ4 5
;
ÿÿ5 6
}
ŸŸ 	
catch
⁄⁄ 
(
⁄⁄ %
ObjectDisposedException
⁄⁄ &
)
⁄⁄& '
{
€€ 	
}
›› 	
finally
ﬁﬁ 
{
ﬂﬂ 	-
_visibilityOperationTokenSource
‡‡ +
?
‡‡+ ,
.
‡‡, -
Dispose
‡‡- 4
(
‡‡4 5
)
‡‡5 6
;
‡‡6 7-
_visibilityOperationTokenSource
·· +
=
··, -
null
··. 2
;
··2 3
}
‚‚ 	
_disposables
‰‰ 
.
‰‰ 
Dispose
‰‰ 
(
‰‰ 
)
‰‰ 
;
‰‰ $
_statusUpdateSemaphore
ÂÂ 
.
ÂÂ 
Dispose
ÂÂ &
(
ÂÂ& '
)
ÂÂ' (
;
ÂÂ( ),
_cachedInternetUnavailableIcon
ÁÁ &
?
ÁÁ& '
.
ÁÁ' (
Dispose
ÁÁ( /
(
ÁÁ/ 0
)
ÁÁ0 1
;
ÁÁ1 2*
_cachedServerUnreachableIcon
ËË $
?
ËË$ %
.
ËË% &
Dispose
ËË& -
(
ËË- .
)
ËË. /
;
ËË/ 0,
_cachedInternetUnavailableIcon
ÈÈ &
=
ÈÈ' (
null
ÈÈ) -
;
ÈÈ- .*
_cachedServerUnreachableIcon
ÍÍ $
=
ÍÍ% &
null
ÍÍ' +
;
ÍÍ+ , 
_cachedStatusTexts
ÏÏ 
.
ÏÏ 
Clear
ÏÏ  
(
ÏÏ  !
)
ÏÏ! "
;
ÏÏ" #'
_cachedStatusDescriptions
ÌÌ !
.
ÌÌ! "
Clear
ÌÌ" '
(
ÌÌ' (
)
ÌÌ( )
;
ÌÌ) *
	_disposed
ÔÔ 
=
ÔÔ 
true
ÔÔ 
;
ÔÔ 
}
 
private
ÚÚ 
static
ÚÚ 
void
ÚÚ  
LogRetryButtonShow
ÚÚ *
(
ÚÚ* +
)
ÚÚ+ ,
{
ÛÛ 
if
ÙÙ 

(
ÙÙ 
Log
ÙÙ 
.
ÙÙ 
	IsEnabled
ÙÙ 
(
ÙÙ 
Serilog
ÙÙ !
.
ÙÙ! "
Events
ÙÙ" (
.
ÙÙ( )
LogEventLevel
ÙÙ) 6
.
ÙÙ6 7
Debug
ÙÙ7 <
)
ÙÙ< =
)
ÙÙ= >
{
ıı 	
Log
ˆˆ 
.
ˆˆ 
Debug
ˆˆ 
(
ˆˆ 
$str
ˆˆ =
)
ˆˆ= >
;
ˆˆ> ?
}
˜˜ 	
}
¯¯ 
private
˙˙ 
static
˙˙ 
void
˙˙ &
LogRetryButtonManualHide
˙˙ 0
(
˙˙0 1
)
˙˙1 2
{
˚˚ 
if
¸¸ 

(
¸¸ 
Log
¸¸ 
.
¸¸ 
	IsEnabled
¸¸ 
(
¸¸ 
Serilog
¸¸ !
.
¸¸! "
Events
¸¸" (
.
¸¸( )
LogEventLevel
¸¸) 6
.
¸¸6 7
Debug
¸¸7 <
)
¸¸< =
)
¸¸= >
{
˝˝ 	
Log
˛˛ 
.
˛˛ 
Debug
˛˛ 
(
˛˛ 
$str
˛˛ S
)
˛˛S T
;
˛˛T U
}
ˇˇ 	
}
ÄÄ 
private
ÇÇ 
static
ÇÇ 
void
ÇÇ *
LogRetryButtonConnectionHide
ÇÇ 4
(
ÇÇ4 5"
ConnectivitySnapshot
ÇÇ5 I
snapshot
ÇÇJ R
)
ÇÇR S
{
ÉÉ 
if
ÑÑ 

(
ÑÑ 
Log
ÑÑ 
.
ÑÑ 
	IsEnabled
ÑÑ 
(
ÑÑ 
Serilog
ÑÑ !
.
ÑÑ! "
Events
ÑÑ" (
.
ÑÑ( )
LogEventLevel
ÑÑ) 6
.
ÑÑ6 7
Debug
ÑÑ7 <
)
ÑÑ< =
)
ÑÑ= >
{
ÖÖ 	
Log
ÜÜ 
.
ÜÜ 
Debug
ÜÜ 
(
ÜÜ 
$str
ÜÜ _
,
ÜÜ_ `
snapshot
áá 
.
áá 
Status
áá 
,
áá  
snapshot
áá! )
.
áá) *
Reason
áá* 0
)
áá0 1
;
áá1 2
}
ââ 	
}
ää 
private
åå 
static
åå 
void
åå 
LogNetworkEvent
åå '
(
åå' ("
ConnectivitySnapshot
åå( <
snapshot
åå= E
)
ååE F
{
çç 
if
éé 

(
éé 
Log
éé 
.
éé 
	IsEnabled
éé 
(
éé 
Serilog
éé !
.
éé! "
Events
éé" (
.
éé( )
LogEventLevel
éé) 6
.
éé6 7
Debug
éé7 <
)
éé< =
)
éé= >
{
èè 	
Log
êê 
.
êê 
Debug
êê 
(
êê 
$str
êê o
,
êêo p
snapshot
ëë 
.
ëë 
Status
ëë 
,
ëë  
snapshot
íí 
.
íí 
Reason
íí 
,
íí  
snapshot
ìì 
.
ìì 
Source
ìì 
,
ìì  
snapshot
îî 
.
îî 
RetryAttempt
îî %
)
îî% &
;
îî& '
}
ññ 	
}
óó 
private
ôô 
static
ôô 
void
ôô !
LogVisibilityChange
ôô +
(
ôô+ ,
bool
ôô, 0
visible
ôô1 8
)
ôô8 9
{
öö 
if
õõ 

(
õõ 
Log
õõ 
.
õõ 
	IsEnabled
õõ 
(
õõ 
Serilog
õõ !
.
õõ! "
Events
õõ" (
.
õõ( )
LogEventLevel
õõ) 6
.
õõ6 7
Debug
õõ7 <
)
õõ< =
)
õõ= >
{
úú 	
Log
ùù 
.
ùù 
Debug
ùù 
(
ùù 
$str
ùù T
,
ùùT U
visible
ùùV ]
)
ùù] ^
;
ùù^ _
}
ûû 	
}
üü 
private
°° 
static
°° 
void
°° #
LogOperationCancelled
°° -
(
°°- .
)
°°. /
{
¢¢ 
if
££ 

(
££ 
Log
££ 
.
££ 
	IsEnabled
££ 
(
££ 
Serilog
££ !
.
££! "
Events
££" (
.
££( )
LogEventLevel
££) 6
.
££6 7
Debug
££7 <
)
££< =
)
££= >
{
§§ 	
Log
•• 
.
•• 
Debug
•• 
(
•• 
$str
•• K
)
••K L
;
••L M
}
¶¶ 	
}
ßß 
}®® àO
ä/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Core/ConnectivityNotificationView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Core! %
;% &
public

 
sealed

 
partial

 
class

 (
ConnectivityNotificationView

 8
:

9 :
ReactiveUserControl

; N
<

N O-
!ConnectivityNotificationViewModel

O p
>

p q
{ 
private 
const 
string "
DISCONNECTED_ICON_PATH /
=0 1
$str P
+Q R
$str	 ¯
;
¯ ˘
public 

static 
readonly 
StyledProperty )
<) *
TimeSpan* 2
>2 3"
AppearDurationProperty4 J
=K L
AvaloniaProperty 
. 
Register !
<! "(
ConnectivityNotificationView" >
,> ?
TimeSpan@ H
>H I
(I J
nameofJ P
(P Q
AppearDurationQ _
)_ `
,` a
TimeSpan 
. 
FromMilliseconds %
(% &
$num& )
)) *
)* +
;+ ,
public 

static 
readonly 
StyledProperty )
<) *
TimeSpan* 2
>2 3%
DisappearDurationProperty4 M
=N O
AvaloniaProperty 
. 
Register !
<! "(
ConnectivityNotificationView" >
,> ?
TimeSpan@ H
>H I
(I J
nameofJ P
(P Q
DisappearDurationQ b
)b c
,c d
TimeSpan 
. 
FromMilliseconds %
(% &
$num& )
)) *
)* +
;+ ,
public 

new 
static 
readonly 
StyledProperty -
<- .
IBrush. 4
>4 5
BackgroundProperty6 H
=I J
AvaloniaProperty 
. 
Register !
<! "(
ConnectivityNotificationView" >
,> ?
IBrush@ F
>F G
(G H
nameofH N
(N O

BackgroundO Y
)Y Z
,Z [
new 
SolidColorBrush 
(  
Color  %
.% &
Parse& +
(+ ,
$str, 5
)5 6
)6 7
)7 8
;8 9
public 

static 
readonly 
StyledProperty )
<) *
IBrush* 0
>0 1 
EllipseColorProperty2 F
=G H
AvaloniaProperty 
. 
Register !
<! "(
ConnectivityNotificationView" >
,> ?
IBrush@ F
>F G
(G H
nameofH N
(N O
EllipseColorO [
)[ \
,\ ]
new 
SolidColorBrush 
(  
Color  %
.% &
Parse& +
(+ ,
$str, 5
)5 6
)6 7
)7 8
;8 9
public 

static 
readonly 
StyledProperty )
<) *
Geometry* 2
>2 3
IconDataProperty4 D
=E F
AvaloniaProperty   
.   
Register   !
<  ! "(
ConnectivityNotificationView  " >
,  > ?
Geometry  @ H
>  H I
(  I J
nameof  J P
(  P Q
IconData  Q Y
)  Y Z
)  Z [
;  [ \
public"" 

static"" 
readonly"" 
StyledProperty"" )
<"") * 
ILocalizationService""* >
>""> ?'
LocalizationServiceProperty""@ [
=""\ ]
AvaloniaProperty## 
.## 
Register## !
<##! "(
ConnectivityNotificationView##" >
,##> ? 
ILocalizationService##@ T
>##T U
(##U V
nameof##V \
(##\ ]
LocalizationService##] p
)##p q
)##q r
;##r s
public%% 
 
ILocalizationService%% 
LocalizationService%%  3
{&& 
get'' 
=>'' 
GetValue'' 
('' '
LocalizationServiceProperty'' 3
)''3 4
;''4 5
set(( 
=>(( 
SetValue(( 
((( '
LocalizationServiceProperty(( 3
,((3 4
value((5 :
)((: ;
;((; <
})) 
public++ 

new++ 
IBrush++ 

Background++  
{,, 
get-- 
=>-- 
GetValue-- 
(-- 
BackgroundProperty-- *
)--* +
;--+ ,
set.. 
=>.. 
SetValue.. 
(.. 
BackgroundProperty.. *
,..* +
value.., 1
)..1 2
;..2 3
}// 
public11 

IBrush11 
EllipseColor11 
{22 
get33 
=>33 
GetValue33 
(33  
EllipseColorProperty33 ,
)33, -
;33- .
set44 
=>44 
SetValue44 
(44  
EllipseColorProperty44 ,
,44, -
value44. 3
)443 4
;444 5
}55 
public77 

Geometry77 
IconData77 
{88 
get99 
=>99 
GetValue99 
(99 
IconDataProperty99 (
)99( )
;99) *
set:: 
=>:: 
SetValue:: 
(:: 
IconDataProperty:: (
,::( )
value::* /
)::/ 0
;::0 1
};; 
public== 

TimeSpan== 
AppearDuration== "
{>> 
get?? 
=>?? 
GetValue?? 
(?? "
AppearDurationProperty?? .
)??. /
;??/ 0
set@@ 
=>@@ 
SetValue@@ 
(@@ "
AppearDurationProperty@@ .
,@@. /
value@@0 5
)@@5 6
;@@6 7
}AA 
publicCC 

TimeSpanCC 
DisappearDurationCC %
{DD 
getEE 
=>EE 
GetValueEE 
(EE %
DisappearDurationPropertyEE 1
)EE1 2
;EE2 3
setFF 
=>FF 
SetValueFF 
(FF %
DisappearDurationPropertyFF 1
,FF1 2
valueFF3 8
)FF8 9
;FF9 :
}GG 
publicHH 
(
ConnectivityNotificationViewHH '
(HH' (
)HH( )
{II 
InitializeComponentJJ 
(JJ 
)JJ 
;JJ 
	IsVisibleKK 
=KK 
falseKK 
;KK 
SetIconLL 
(LL 
)LL 
;LL 
}MM 
privateOO 
voidOO 
SetIconOO 
(OO 
)OO 
{PP 
tryQQ 
{RR 	
IconDataSS 
=SS 
GeometrySS 
.SS  
ParseSS  %
(SS% &"
DISCONNECTED_ICON_PATHSS& <
)SS< =
;SS= >
}TT 	
catchUU 
{VV 	
IconDataWW 
=WW 
GeometryWW 
.WW  
ParseWW  %
(WW% &
$strWW& j
)WWj k
;WWk l
}XX 	
}YY 
private[[ 
void[[ 
InitializeComponent[[ $
([[$ %
)[[% &
{\\ 
AvaloniaXamlLoader]] 
.]] 
Load]] 
(]]  
this]]  $
)]]$ %
;]]% &
}^^ 
	protected`` 
override`` 
void``  
OnDataContextChanged`` 0
(``0 1
System``1 7
.``7 8
	EventArgs``8 A
e``B C
)``C D
{aa 
basebb 
.bb  
OnDataContextChangedbb !
(bb! "
ebb" #
)bb# $
;bb$ %
ifdd 

(dd 
DataContextdd 
isdd 
notdd -
!ConnectivityNotificationViewModeldd @
	viewModelddA J
)ddJ K
{ee 	
returnff 
;ff 
}gg 	
	viewModelii 
.ii 
SetViewii 
(ii 
thisii 
)ii 
;ii  
	viewModelkk 
.kk 
AppearDurationkk  
=kk! "
AppearDurationkk# 1
;kk1 2
	viewModelll 
.ll 
DisappearDurationll #
=ll$ %
DisappearDurationll& 7
;ll7 8
}mm 
	protectedoo 
overrideoo 
voidoo 
OnPropertyChangedoo -
(oo- .,
 AvaloniaPropertyChangedEventArgsoo. N
changeooO U
)ooU V
{pp 
baseqq 
.qq 
OnPropertyChangedqq 
(qq 
changeqq %
)qq% &
;qq& '
ifss 

(ss 
DataContextss 
isss -
!ConnectivityNotificationViewModelss <
	viewModelss= F
)ssF G
{tt 	
ifuu 
(uu 
changeuu 
.uu 
Propertyuu 
==uu  ""
AppearDurationPropertyuu# 9
)uu9 :
{vv 
	viewModelww 
.ww 
AppearDurationww (
=ww) *
AppearDurationww+ 9
;ww9 :
}xx 
elseyy 
ifyy 
(yy 
changeyy 
.yy 
Propertyyy $
==yy% '%
DisappearDurationPropertyyy( A
)yyA B
{zz 
	viewModel{{ 
.{{ 
DisappearDuration{{ +
={{, -
DisappearDuration{{. ?
;{{? @
}|| 
}}} 	
}~~ 
} ê
Ü/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Constants/SegmentedTextBoxConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
	Constants! *
;* +
public 
static 
class %
SegmentedTextBoxConstants -
{ 
public 

const 
string 
SEGMENT_STYLE_CLASS +
=, -
$str. 7
;7 8
public 

const 
string 
ACTIVE_STYLE_CLASS *
=+ ,
$str- 5
;5 6
public 

const 
int !
DEFAULT_SEGMENT_COUNT *
=+ ,
$num- .
;. /
public		 

const		 
double		 #
DEFAULT_SEGMENT_SPACING		 /
=		0 1
$num		2 5
;		5 6
public

 

const

 
double

 !
DEFAULT_SEGMENT_WIDTH

 -
=

. /
$num

0 4
;

4 5
public 

const 
bool &
DEFAULT_ALLOW_ONLY_NUMBERS 0
=1 2
false3 8
;8 9
public 

const 
bool *
IS_POINTER_INTERACTION_ENABLED 4
=5 6
true7 ;
;; <
} ˛	
É/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Constants/NetworkStatusConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
	Constants! *
;* +
public 
static 
class "
NetworkStatusConstants *
{ 
public 

const 
int &
DEFAULT_APPEAR_DURATION_MS /
=0 1
$num2 5
;5 6
public 

const 
int )
DEFAULT_DISAPPEAR_DURATION_MS 2
=3 4
$num5 8
;8 9
public 

const 
int 
AUTO_HIDE_DELAY_MS '
=( )
$num* .
;. /
public		 

const		 
string		  
NO_INTERNET_ICON_URI		 ,
=		- .
$str		/ e
;		e f
public

 

const

 
string

 *
SERVER_NOT_RESPONDING_ICON_URI

 6
=

7 8
$str	

9 É
;


É Ñ
public 

const 
string 
MAIN_BORDER_NAME (
=) *
$str+ 7
;7 8
} Ÿ-
É/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Constants/HintedTextBoxConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
	Constants! *
;* +
public 
static 
class "
HintedTextBoxConstants *
{ 
public 

const 
string 
FOCUS_COLOR_HEX '
=( )
$str* 3
;3 4
public 

const 
string 
ERROR_COLOR_HEX '
=( )
$str* 3
;3 4
public 

const 
string &
INVALID_STRENGTH_COLOR_HEX 2
=3 4
$str5 >
;> ?
public		 

const		 
string		 (
VERY_WEAK_STRENGTH_COLOR_HEX		 4
=		5 6
$str		7 @
;		@ A
public

 

const

 
string

 #
WEAK_STRENGTH_COLOR_HEX

 /
=

0 1
$str

2 ;
;

; <
public 

const 
string #
GOOD_STRENGTH_COLOR_HEX /
=0 1
$str2 ;
;; <
public 

const 
string %
STRONG_STRENGTH_COLOR_HEX 1
=2 3
$str4 =
;= >
public 

const 
string *
VERY_STRONG_STRENGTH_COLOR_HEX 6
=7 8
$str9 B
;B C
public 

const 
char 
DEFAULT_MASK_CHAR '
=( )
$char* -
;- .
public 

const 
char 
NO_SECURE_KEY_CHAR (
=) *
$char+ /
;/ 0
public 

const 
double +
DEFAULT_ELLIPSE_OPACITY_VISIBLE 7
=8 9
$num: =
;= >
public 

const 
double *
DEFAULT_ELLIPSE_OPACITY_HIDDEN 6
=7 8
$num9 <
;< =
public 

const 
double 
DEFAULT_FONT_SIZE )
=* +
$num, 0
;0 1
public 

const 
double '
DEFAULT_WATERMARK_FONT_SIZE 3
=4 5
$num6 :
;: ;
public 

const 
int #
INPUT_DEBOUNCE_DELAY_MS ,
=- .
$num/ 0
;0 1
public 

const 
int 
INITIAL_CARET_INDEX (
=) *
$num+ ,
;, -
public 

const 
int &
TYPING_ANIMATION_THRESHOLD /
=0 1
$num2 3
;3 4
public 

const 
int (
TYPING_ANIMATION_DURATION_MS 1
=2 3
$num4 7
;7 8
public 

const 
int /
#DEFAULT_WARNING_DISPLAY_DURATION_MS 8
=9 :
$num; ?
;? @
public 

const 
double 
FULL_OPACITY $
=% &
$num' *
;* +
public 

const 
double 
ZERO_OPACITY $
=% &
$num' *
;* +
public 

const 
double #
ANIMATION_OPACITY_BOOST /
=0 1
$num2 5
;5 6
public   

const   
string   #
ANIMATION_START_PERCENT   /
=  0 1
$str  2 6
;  6 7
public!! 

const!! 
string!! "
ANIMATION_PEAK_PERCENT!! .
=!!/ 0
$str!!1 6
;!!6 7
public"" 

const"" 
string"" !
ANIMATION_END_PERCENT"" -
="". /
$str""0 6
;""6 7
public$$ 

const$$ 
string$$ 
MAIN_TEXT_BOX_NAME$$ *
=$$+ ,
$str$$- :
;$$: ;
public%% 

const%% 
string%% 
FOCUS_BORDER_NAME%% )
=%%* +
$str%%, 9
;%%9 :
public&& 

const&& 
string&& 
MAIN_BORDER_NAME&& (
=&&) *
$str&&+ 7
;&&7 8
public'' 

const'' 
string'' 
SHADOW_BORDER_NAME'' *
=''+ ,
$str''- ;
;''; <
public)) 

const)) 
string)) 
ERROR_SHADOW_KEY)) (
=))) *
$str))+ 8
;))8 9
public** 

const** 
string** 
FOCUS_SHADOW_KEY** (
=**) *
$str**+ 8
;**8 9
public++ 

const++ 
string++ 
DEFAULT_SHADOW_KEY++ *
=+++ ,
$str++- <
;++< =
public,, 

const,, 
string,, '
INVALID_STRENGTH_SHADOW_KEY,, 3
=,,4 5
$str,,6 M
;,,M N
public-- 

const-- 
string-- )
VERY_WEAK_STRENGTH_SHADOW_KEY-- 5
=--6 7
$str--8 P
;--P Q
public.. 

const.. 
string.. $
WEAK_STRENGTH_SHADOW_KEY.. 0
=..1 2
$str..3 G
;..G H
public// 

const// 
string// $
GOOD_STRENGTH_SHADOW_KEY// 0
=//1 2
$str//3 G
;//G H
public00 

const00 
string00 &
STRONG_STRENGTH_SHADOW_KEY00 2
=003 4
$str005 K
;00K L
public11 

const11 
string11 +
VERY_STRONG_STRENGTH_SHADOW_KEY11 7
=118 9
$str11: T
;11T U
}22 ˚
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Common/CharacterWarningType.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Common! '
;' (
public 
enum  
CharacterWarningType  
{ 
NonLatinLetter 
, 
InvalidCharacter 
, 
MultipleCharacters 
} ù!
|/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Constants/ApplicationErrorMessages.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
	Constants !
;! "
public 
static 
class $
ApplicationErrorMessages ,
{ 
public 

static 
class 
ApplicationRouter )
{ 
public 
const 
string '
CANNOT_NAVIGATE_WINDOW_NULL 7
=8 9
$str: c
;c d
public 
const 
string &
FAILED_TO_LOAD_AUTH_MODULE 6
=7 8
$str9 _
;_ `
public		 
const		 
string		 2
&FAILED_TO_CREATE_MEMBERSHIP_VIEW_MODEL		 B
=		C D
$str		E o
;		o p
public

 
const

 
string

 &
FAILED_TO_LOAD_MAIN_MODULE

 6
=

7 8
$str

9 U
;

U V
public 
const 
string ,
 FAILED_TO_CREATE_MAIN_VIEW_MODEL <
== >
$str? _
;_ `
public 
const 
string 2
&FAILED_TO_LOAD_MAIN_MODULE_FROM_SPLASH B
=C D
$strE m
;m n
public 
const 
string 2
&FAILED_TO_LOAD_AUTH_MODULE_FROM_SPLASH B
=C D
$strE w
;w x
} 
public 

static 
class !
SecureStorageProvider -
{ 
public 
const 
string 4
(SECURE_STORAGE_DIRECTORY_CREATION_FAILED D
=E F
$strG w
;w x
public 
const 
string *
APPLICATION_SETTINGS_NOT_FOUND :
=; <
$str= g
;g h
public 
const 
string !
CORRUPT_SETTINGS_DATA 1
=2 3
$str4 ^
;^ _
public 
const 
string "
FAILED_TO_ENCRYPT_DATA 2
=3 4
$str5 Z
;Z [
public 
const 
string &
FAILED_TO_WRITE_TO_STORAGE 6
=7 8
$str9 ]
;] ^
public 
const 
string "
FAILED_TO_DECRYPT_DATA 2
=3 4
$str5 N
;N O
public 
const 
string $
FAILED_TO_ACCESS_STORAGE 4
=5 6
$str7 Y
;Y Z
public 
const 
string )
FAILED_TO_DELETE_FROM_STORAGE 9
=: ;
$str< c
;c d
} 
public 

static 
class &
SecureProtocolStateStorage 2
{ 
public 
const 
string 
STORAGE_DISPOSED ,
=- .
$str/ D
;D E
public 
const 
string  
STATE_FILE_NOT_FOUND 0
=1 2
$str3 I
;I J
public   
const   
string   #
TAMPERED_STATE_DETECTED   3
=  4 5
$str  6 c
;  c d
public!! 
const!! 
string!! $
ASSOCIATED_DATA_MISMATCH!! 4
=!!5 6
$str!!7 Q
;!!Q R
public"" 
const"" 
string"" $
INVALID_CONTAINER_FORMAT"" 4
=""5 6
$str""7 Q
;""Q R
public## 
const## 
string## 
UNSUPPORTED_VERSION## /
=##0 1
$str##2 L
;##L M
public$$ 
const$$ 
string$$ 
SAVE_FAILED$$ '
=$$( )
$str$$* <
;$$< =
public%% 
const%% 
string%% 
LOAD_FAILED%% '
=%%( )
$str%%* <
;%%< =
public&& 
const&& 
string&& 
DELETE_FAILED&& )
=&&* +
$str&&, @
;&&@ A
}'' 
}(( ä
f/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/AssemblyInfo.cs
[ 
assembly 	
:	 

InternalsVisibleTo 
( 
$str 5
)5 6
]6 7
[ 
assembly 	
:	 

InternalsVisibleTo 
( 
$str (
)( )
]) *Ê
l/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/ApplicationStartup.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
;

 
public 
class 
ApplicationStartup 
(  3
'IClassicDesktopStyleApplicationLifetime +
desktop, 3
,3 4#
IApplicationInitializer 
initializer '
,' (
IApplicationRouter 
router 
, $
IApplicationStateManager 
stateManager )
)) *
{ 
private !
SplashWindowViewModel !
?! "
_splashViewModel# 3
;3 4
public 

async 
Task 
RunAsync 
( !
DefaultSystemSettings 4!
defaultSystemSettings5 J
)J K
{ 
_ 	
=
 
Locator 
. 
Current 
. 

GetService &
<& '&
InternetConnectivityBridge' A
>A B
(B C
)C D
;D E
_splashViewModel 
= 
Locator "
." #
Current# *
.* +

GetService+ 5
<5 6!
SplashWindowViewModel6 K
>K L
(L M
)M N
!N O
;O P
SplashWindow 
splashScreen !
=" #
new$ '
(' (
)( )
{* +
DataContext, 7
=8 9
_splashViewModel: J
}K L
;L M
desktop 
. 

MainWindow 
= 
splashScreen )
;) *
splashScreen 
. 
Show 
( 
) 
; 
await 
_splashViewModel 
. 
IsSubscribed +
.+ ,
Task, 0
;0 1
bool   
success   
=   
await   
initializer   (
.  ( )
InitializeAsync  ) 8
(  8 9!
defaultSystemSettings  9 N
)  N O
;  O P
if"" 

("" 
success"" 
)"" 
{## 	
bool$$ 
isAuthenticated$$  
=$$! "
stateManager$$# /
.$$/ 0
CurrentState$$0 <
==$$= ?
ApplicationState$$@ P
.$$P Q
Authenticated$$Q ^
;$$^ _
await&& 
router&& 
.&& %
TransitionFromSplashAsync&& 2
(&&2 3
splashScreen&&3 ?
,&&? @
isAuthenticated&&A P
)&&P Q
;&&Q R
_splashViewModel(( 
?(( 
.(( 
Dispose(( %
(((% &
)((& '
;((' (
_splashViewModel)) 
=)) 
null)) #
;))# $
}** 	
else++ 
{,, 	
await-- 
_splashViewModel-- "
.--" ##
PrepareForShutdownAsync--# :
(--: ;
)--; <
;--< =
desktop.. 
... 
Shutdown.. 
(.. 
).. 
;.. 
}// 	
}00 
}11 ì0
c/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/App.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
; 
public 
class 
App 
: 
Application 
{ 
public 

override 
void 

Initialize #
(# $
)$ %
{ 
RxApp 
. #
DefaultExceptionHandler %
=& '
Observer( 0
.0 1
Create1 7
<7 8
	Exception8 A
>A B
(B C
exC E
=>F H
{ 	
var 
context 
= 
new 
{ 
ExceptionType 
= 
ex  "
." #
GetType# *
(* +
)+ ,
., -
Name- 1
,1 2
InnerException 
=  
ex! #
.# $
InnerException$ 2
?2 3
.3 4
GetType4 ;
(; <
)< =
.= >
Name> B
,B C
	Timestamp 
= 
DateTime $
.$ %
UtcNow% +
} 
; 
Log 
. 
Error 
( 
ex 
, 
$str F
,F G
contextH O
)O P
;P Q
} 	
)	 

;
 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
}   
public"" 

override"" 
void"" .
"OnFrameworkInitializationCompleted"" ;
(""; <
)""< =
{## !
DefaultSystemSettings$$ !
defaultSystemSettings$$ 3
=$$4 5
Locator$$6 =
.$$= >
Current$$> E
.$$E F

GetService$$F P
<$$P Q!
DefaultSystemSettings$$Q f
>$$f g
($$g h
)$$h i
!$$i j
;$$j k
if&& 

(&& 
ApplicationLifetime&& 
is&&  "3
'IClassicDesktopStyleApplicationLifetime&&# J
desktop&&K R
)&&R S
{'' 	
Locator(( 
.(( 
CurrentMutable(( "
.((" #
RegisterConstant((# 3
(((3 4
desktop((4 ;
,((; <
typeof((= C
(((C D3
'IClassicDesktopStyleApplicationLifetime((D k
)((k l
)((l m
;((m n
Task** 
.** 
Run** 
(** 
async** 
(** 
)** 
=>**  
{++ 
try,, 
{-- 
await.. "
InitializeModulesAsync.. 0
(..0 1
)..1 2
;..2 3
Avalonia00 
.00 
	Threading00 &
.00& '

Dispatcher00' 1
.001 2
UIThread002 :
.00: ;
Post00; ?
(00? @
async00@ E
(00F G
)00G H
=>00I K
{11 
try22 
{33 
ApplicationStartup44 .
applicationStartup44/ A
=44B C
Locator44D K
.44K L
Current44L S
.44S T

GetService44T ^
<44^ _
ApplicationStartup44_ q
>44q r
(44r s
)44s t
!44t u
;44u v
await55 !
applicationStartup55" 4
.554 5
RunAsync555 =
(55= >!
defaultSystemSettings55> S
)55S T
;55T U
}66 
catch77 
(77 
	Exception77 (
ex77) +
)77+ ,
{88 
Serilog99 #
.99# $
Log99$ '
.99' (
Fatal99( -
(99- .
ex99. 0
,990 1
$str992 w
)99w x
;99x y
Environment:: '
.::' (
Exit::( ,
(::, -
$num::- .
)::. /
;::/ 0
};; 
}<< 
)<< 
;<< 
}== 
catch>> 
(>> 
	Exception>>  
ex>>! #
)>># $
{?? 
Serilog@@ 
.@@ 
Log@@ 
.@@  
Fatal@@  %
(@@% &
ex@@& (
,@@( )
$str@@* g
)@@g h
;@@h i
EnvironmentAA 
.AA  
ExitAA  $
(AA$ %
$numAA% &
)AA& '
;AA' (
}BB 
}CC 
)CC 
.CC 
ContinueWithCC 
(CC 
taskDD 
=>DD 
{EE 
ifFF 
(FF 
taskFF 
.FF 
	IsFaultedFF &
&&FF' )
taskFF* .
.FF. /
	ExceptionFF/ 8
!=FF9 ;
nullFF< @
)FF@ A
{GG 
SerilogHH 
.HH  
LogHH  #
.HH# $
FatalHH$ )
(HH) *
taskHH* .
.HH. /
	ExceptionHH/ 8
,HH8 9
$strHH: {
)HH{ |
;HH| }
EnvironmentII #
.II# $
ExitII$ (
(II( )
$numII) *
)II* +
;II+ ,
}JJ 
}KK 
,KK 
TaskSchedulerLL 
.LL 
DefaultLL %
)LL% &
;LL& '
}MM 	
baseOO 
.OO .
"OnFrameworkInitializationCompletedOO /
(OO/ 0
)OO0 1
;OO1 2
}PP 
privateRR 
staticRR 
asyncRR 
TaskRR "
InitializeModulesAsyncRR 4
(RR4 5
)RR5 6
{SS 
IModuleManagerTT 
moduleManagerTT $
=TT% &
LocatorTT' .
.TT. /
CurrentTT/ 6
.TT6 7

GetServiceTT7 A
<TTA B
IModuleManagerTTB P
>TTP Q
(TTQ R
)TTR S
!TTS T
;TTT U
awaitUU 
moduleManagerUU 
.UU !
LoadEagerModulesAsyncUU 1
(UU1 2
)UU2 3
;UU3 4
}VV 
}WW 