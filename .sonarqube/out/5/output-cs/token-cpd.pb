ÈF
…/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Views/Memberships/Components/TitleBar.axaml.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Views

 
.

 
Memberships

 )
.

) *

Components

* 4
;

4 5
public 
partial 
class 
TitleBar 
: 
UserControl  +
{ 
public 

static 
readonly 
StyledProperty )
<) *
bool* .
>. /&
DisableCloseButtonProperty0 J
=K L
AvaloniaProperty 
. 
Register !
<! "
TitleBar" *
,* +
bool, 0
>0 1
(1 2
nameof2 8
(8 9
DisableCloseButton9 K
)K L
,L M
trueN R
)R S
;S T
public 

static 
readonly 
StyledProperty )
<) *
bool* .
>. /)
DisableMinimizeButtonProperty0 M
=N O
AvaloniaProperty 
. 
Register !
<! "
TitleBar" *
,* +
bool, 0
>0 1
(1 2
nameof2 8
(8 9!
DisableMinimizeButton9 N
)N O
,O P
trueQ U
)U V
;V W
public 

static 
readonly 
StyledProperty )
<) *
bool* .
>. /)
DisableMaximizeButtonProperty0 M
=N O
AvaloniaProperty 
. 
Register !
<! "
TitleBar" *
,* +
bool, 0
>0 1
(1 2
nameof2 8
(8 9!
DisableMaximizeButton9 N
)N O
,O P
trueQ U
)U V
;V W
public 

ReactiveCommand 
< 
Unit 
,  
Unit! %
>% &
CloseCommand' 3
{4 5
get6 9
;9 :
}; <
public 

ReactiveCommand 
< 
Unit 
,  
Unit! %
>% &
MinimizeCommand' 6
{7 8
get9 <
;< =
}> ?
public 

ReactiveCommand 
< 
Unit 
,  
Unit! %
>% &
MaximizeCommand' 6
{7 8
get9 <
;< =
}> ?
private 
readonly 
IDisposable  
?  !'
_pointerPressedSubscription" =
;= >
public 

TitleBar 
( 
) 
{ 
InitializeComponent 
( 
) 
; 
CloseCommand!! 
=!! 
ReactiveCommand!! &
.!!& '
Create!!' -
(!!- .
("" 
)"" 
=>"" 
Window"" 
?"" 
."" 
Close"" 
(""  
)""  !
,""! "
this## 
.## 
WhenAnyValue## 
(## 
x## 
=>##  "
x### $
.##$ %
DisableCloseButton##% 7
)##7 8
.##8 9
Select##9 ?
(##? @
disable##@ G
=>##H J
!##K L
disable##L S
)##S T
)$$ 	
;$$	 

MinimizeCommand&& 
=&& 
ReactiveCommand&& )
.&&) *
Create&&* 0
(&&0 1
('' 
)'' 
=>'' 
{(( 
if)) 
()) 
Window)) 
!=)) 
null)) "
)))" #
{** 
Window++ 
.++ 
WindowState++ &
=++' (
WindowState++) 4
.++4 5
	Minimized++5 >
;++> ?
},, 
}-- 
,-- 
this.. 
... 
WhenAnyValue.. 
(.. 
x.. 
=>..  "
x..# $
...$ %!
DisableMinimizeButton..% :
)..: ;
...; <
Select..< B
(..B C
disable..C J
=>..K M
!..N O
disable..O V
)..V W
)// 	
;//	 

MaximizeCommand11 
=11 
ReactiveCommand11 )
.11) *
Create11* 0
(110 1
(22 
)22 
=>22 
{33 
if44 
(44 
Window44 
!=44 
null44 "
)44" #
{55 
Window66 
.66 
WindowState66 &
=66' (
Window66) /
.66/ 0
WindowState660 ;
==66< >
WindowState66? J
.66J K
	Maximized66K T
?77 
WindowState77 %
.77% &
Normal77& ,
:88 
WindowState88 %
.88% &
	Maximized88& /
;88/ 0
}99 
}:: 
,:: 
this;; 
.;; 
WhenAnyValue;; 
(;; 
x;; 
=>;;  "
x;;# $
.;;$ %!
DisableMaximizeButton;;% :
);;: ;
.;;; <
Select;;< B
(;;B C
disable;;C J
=>;;K M
!;;N O
disable;;O V
);;V W
)<< 	
;<<	 

Panel>> 
?>> 
	rootPanel>> 
=>> 
this>> 
.>>  
FindControl>>  +
<>>+ ,
Panel>>, 1
>>>1 2
(>>2 3
$str>>3 >
)>>> ?
;>>? @
if?? 

(?? 
	rootPanel?? 
!=?? 
null?? 
)?? 
{@@ 	'
_pointerPressedSubscriptionAA '
=AA( )

ObservableAA* 4
.AA4 5
FromEventPatternAA5 E
<AAE F#
PointerPressedEventArgsAAF ]
>AA] ^
(AA^ _
hBB 
=>BB 
	rootPanelBB 
.BB 
PointerPressedBB -
+=BB. 0
hBB1 2
,BB2 3
hCC 
=>CC 
	rootPanelCC 
.CC 
PointerPressedCC -
-=CC. 0
hCC1 2
)DD 
.DD 
	SubscribeDD 
(DD 
eDD 
=>DD 
{EE 
ifFF 
(FF 
eFF 
.FF 
	EventArgsFF 
.FF  
GetCurrentPointFF  /
(FF/ 0
thisFF0 4
)FF4 5
.FF5 6

PropertiesFF6 @
.FF@ A
IsLeftButtonPressedFFA T
)FFT U
{GG 
WindowHH 
?HH 
.HH 
BeginMoveDragHH )
(HH) *
eHH* +
.HH+ ,
	EventArgsHH, 5
)HH5 6
;HH6 7
}II 
}JJ 
)JJ 
;JJ 
}KK 	
thisMM 
.MM 
UnloadedMM 
+=MM 
(MM 
sMM 
,MM 
eMM 
)MM 
=>MM  "'
_pointerPressedSubscriptionMM# >
?MM> ?
.MM? @
DisposeMM@ G
(MMG H
)MMH I
;MMI J
}NN 
publicPP 

boolPP 
DisableCloseButtonPP "
{QQ 
getRR 
=>RR 
GetValueRR 
(RR &
DisableCloseButtonPropertyRR 2
)RR2 3
;RR3 4
setSS 
=>SS 
SetValueSS 
(SS &
DisableCloseButtonPropertySS 2
,SS2 3
valueSS4 9
)SS9 :
;SS: ;
}TT 
publicVV 

boolVV !
DisableMinimizeButtonVV %
{WW 
getXX 
=>XX 
GetValueXX 
(XX )
DisableMinimizeButtonPropertyXX 5
)XX5 6
;XX6 7
setYY 
=>YY 
SetValueYY 
(YY )
DisableMinimizeButtonPropertyYY 5
,YY5 6
valueYY7 <
)YY< =
;YY= >
}ZZ 
public\\ 

bool\\ !
DisableMaximizeButton\\ %
{]] 
get^^ 
=>^^ 
GetValue^^ 
(^^ )
DisableMaximizeButtonProperty^^ 5
)^^5 6
;^^6 7
set__ 
=>__ 
SetValue__ 
(__ )
DisableMaximizeButtonProperty__ 5
,__5 6
value__7 <
)__< =
;__= >
}`` 
privatebb 
Windowbb 
?bb 
Windowbb 
=>bb 

VisualRootbb (
asbb) +
Windowbb, 2
;bb2 3
privatedd 
voiddd 
InitializeComponentdd $
(dd$ %
)dd% &
{ee 
AvaloniaXamlLoaderff 
.ff 
Loadff 
(ff  
thisff  $
)ff$ %
;ff% &
}gg 
}hh ¿
o/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Views/Core/MainWindow.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Views 
. 
Core "
;" #
public 
partial 
class 

MainWindow 
:  !
ReactiveWindow" 0
<0 1
MainWindowViewModel1 D
>D E
{ 
private 
bool #
_languageSelectorLoaded (
;( )
private 
readonly 
Border 
? &
_languageSelectorContainer 7
;7 8
public 


MainWindow 
( 
) 
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
IconService 
. 
SetIconForWindow $
($ %
this% )
)) *
;* +&
_languageSelectorContainer "
=# $
this% )
.) *
FindControl* 5
<5 6
Border6 <
>< =
(= >
$str> Y
)Y Z
;Z [%
SetupLazyLanguageSelector !
(! "
)" #
;# $
}   
private"" 
void"" %
SetupLazyLanguageSelector"" *
(""* +
)""+ ,
{## 
this$$ 
.$$ 
WhenActivated$$ 
($$ 
disposables$$ &
=>$$' )
{%% 	
this&& 
.&& 
WhenAnyValue&& 
(&& 
x&& 
=>&&  "
x&&# $
.&&$ %
DataContext&&% 0
)&&0 1
.'' 
Where'' 
('' 
dc'' 
=>'' 
dc'' 
!=''  "
null''# '
)''' (
.(( 
Select(( 
((( 
dc(( 
=>(( 
dc((  
!((  !
)((! "
.)) 
OfType)) 
<)) 
MainWindowViewModel)) +
>))+ ,
()), -
)))- .
.** 
Take** 
(** 
$num** 
)** 
.++ 
Where++ 
(++ 
_++ 
=>++ 
!++ #
_languageSelectorLoaded++ 4
)++4 5
.,, 
	ObserveOn,, 
(,, 
RxApp,,  
.,,  !
MainThreadScheduler,,! 4
),,4 5
.-- 
	Subscribe-- 
(--  
LoadLanguageSelector-- /
)--/ 0
... 
DisposeWith.. 
(.. 
disposables.. (
)..( )
;..) *
}// 	
)//	 

;//
 
}00 
private22 
void22  
LoadLanguageSelector22 %
(22% &
MainWindowViewModel22& 9
	viewModel22: C
)22C D
{33 
if44 

(44 #
_languageSelectorLoaded44 #
||44$ &&
_languageSelectorContainer44' A
==44B D
null44E I
)44I J
{55 	
return66 
;66 
}77 	 
LanguageSelectorView99 
languageSelector99 -
=99. /
new990 3
(993 4
)994 5
{:: 	
DataContext;; 
=;; 
	viewModel;; #
.;;# $
LanguageSelector;;$ 4
}<< 	
;<<	 
&
_languageSelectorContainer>> "
.>>" #
Child>># (
=>>) *
languageSelector>>+ ;
;>>; <#
_languageSelectorLoaded?? 
=??  !
true??" &
;??& '
}@@ 
}AA ‡f
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/ViewModels/Core/MainWindowViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 

ViewModels "
." #
Core# '
;' (
public 
sealed 
class 
MainWindowViewModel '
:( )
ReactiveObject* 8
,8 9
IDisposable: E
{ 
private 
readonly 
IBottomSheetService (
_bottomSheetService) <
;< =
private 
bool 
_isDisposed 
; 
[ 
Reactive 
] 
public 
object 
? 
CurrentContent ,
{- .
get/ 2
;2 3
private4 ;
set< ?
;? @
}A B
[ 
Reactive 
] 
public 
double 
WindowWidth (
{) *
get+ .
;. /
private0 7
set8 ;
;; <
}= >
[ 
Reactive 
] 
public 
double 
WindowHeight )
{* +
get, /
;/ 0
private1 8
set9 <
;< =
}> ?
[!! 
Reactive!! 
]!! 
public!! 
bool!! 
	CanResize!! $
{!!% &
get!!' *
;!!* +
private!!, 3
set!!4 7
;!!7 8
}!!9 :
[## 
Reactive## 
]## 
public## 
string## 
WindowTitle## (
{##) *
get##+ .
;##. /
set##0 3
;##3 4
}##5 6
public%% 
%
LanguageSelectorViewModel%% $
LanguageSelector%%% 5
{%%6 7
get%%8 ;
;%%; <
}%%= >
public'' 
-
!ConnectivityNotificationViewModel'' ,$
ConnectivityNotification''- E
{''F G
get''H K
;''K L
}''M N
public)) 

MainWindowViewModel)) 
()) 
IBottomSheetService** 
bottomSheetService** .
,**. / 
ILocalizationService++ 
localizationService++ 0
,++0 1-
!IApplicationSecureStorageProvider,, )
storageProvider,,* 9
,,,9 : 
IRpcMetaDataProvider-- 
rpcMetaDataProvider-- 0
,--0 1-
!ConnectivityNotificationViewModel.. )$
connectivityNotification..* B
)..B C
{// 
_bottomSheetService00 
=00 
bottomSheetService00 0
;000 1
WindowWidth22 
=22 
$num22 
;22 
WindowHeight33 
=33 
$num33 
;33 
	CanResize44 
=44 
false44 
;44 
WindowTitle55 
=55 
string55 
.55 
Empty55 "
;55" #
LanguageSelector77 
=77 
new77 %
LanguageSelectorViewModel77 8
(778 9
localizationService88 
,88  
storageProvider99 
,99 
rpcMetaDataProvider:: 
)::  
;::  !$
ConnectivityNotification<<  
=<<! "$
connectivityNotification<<# ;
;<<; <
SetupHandlersAsync>> 
(>> 
)>> 
.>> 
ContinueWith>> )
(>>) *
task?? 
=>?? 
{@@ 
ifAA 
(AA 
taskAA 
isAA 
{AA 
	IsFaultedAA '
:AA' (
trueAA) -
,AA- .
	ExceptionAA/ 8
:AA8 9
notAA: =
nullAA> B
}AAC D
)AAD E
{BB 
LogCC 
.CC 
ErrorCC 
(CC 
taskCC "
.CC" #
	ExceptionCC# ,
,CC, -
$strCC. f
)CCf g
;CCg h
}DD 
}EE 
,EE 
TaskSchedulerFF 
.FF 
DefaultFF !
)FF! "
;FF" #
}GG 
publicII 

asyncII 
TaskII )
SetAuthenticationContentAsyncII 3
(II3 4
objectII4 :
contentII; B
)IIB C
{JJ 
awaitKK $
AnimateWindowResizeAsyncKK &
(KK& '
$numKK' *
,KK* +
$numKK, /
,KK/ 0
TimeSpanKK1 9
.KK9 :
FromMillisecondsKK: J
(KKJ K
$numKKK N
)KKN O
)KKO P
.KKP Q
ConfigureAwaitKKQ _
(KK_ `
falseKK` e
)KKe f
;KKf g
	CanResizeMM 
=MM 
falseMM 
;MM 
awaitOO #
SetContentWithFadeAsyncOO %
(OO% &
contentOO& -
)OO- .
.OO. /
ConfigureAwaitOO/ =
(OO= >
falseOO> C
)OOC D
;OOD E
}PP 
publicRR 

asyncRR 
TaskRR 
SetMainContentAsyncRR )
(RR) *
objectRR* 0
contentRR1 8
)RR8 9
{SS 
awaitTT $
AnimateWindowResizeAsyncTT &
(TT& '
$numTT' +
,TT+ ,
$numTT- 0
,TT0 1
TimeSpanTT2 :
.TT: ;
FromMillisecondsTT; K
(TTK L
$numTTL O
)TTO P
)TTP Q
.TTQ R
ConfigureAwaitTTR `
(TT` a
falseTTa f
)TTf g
;TTg h
	CanResizeVV 
=VV 
trueVV 
;VV 
awaitXX #
SetContentWithFadeAsyncXX %
(XX% &
contentXX& -
)XX- .
.XX. /
ConfigureAwaitXX/ =
(XX= >
falseXX> C
)XXC D
;XXD E
}YY 
public[[ 

async[[ 
Task[[  
ShowBottomSheetAsync[[ *
([[* +$
BottomSheetComponentType\\  
type\\! %
,\\% &
UserControl]] 
view]] 
,]] 
bool^^ 
	showScrim^^ 
=^^ 
true^^ 
,^^ 
bool__ 
isDismissable__ 
=__ 
false__ "
)__" #
=>__$ &
await`` 
_bottomSheetService`` !
.``! "
	ShowAsync``" +
(``+ ,
type``, 0
,``0 1
view``2 6
,``6 7
	showScrim``8 A
,``A B
isDismissable``C P
)``P Q
.``Q R
ConfigureAwait``R `
(``` a
false``a f
)``f g
;``g h
publicbb 

asyncbb 
Taskbb  
HideBottomSheetAsyncbb *
(bb* +
)bb+ ,
=>bb- /
awaitbb0 5
_bottomSheetServicebb6 I
.bbI J
	HideAsyncbbJ S
(bbS T
)bbT U
.bbU V
ConfigureAwaitbbV d
(bbd e
falsebbe j
)bbj k
;bbk l
publicdd 

IDisposabledd 
OnBottomSheetHiddendd *
(dd* +
Funcdd+ /
<dd/ 0"
BottomSheetHiddenEventdd0 F
,ddF G
TaskddH L
>ddL M
handlerddN U
,ddU V 
SubscriptionLifetimeddW k
lifetimeddl t
)ddt u
=>ddv x 
_bottomSheetService	ddy Œ
.
ddŒ !
OnBottomSheetHidden
dd  
(
dd  ¡
handler
dd¡ ¨
,
dd¨ ©
lifetime
ddª ²
)
dd² ³
;
dd³ ´
publicff 

voidff 
Disposeff 
(ff 
)ff 
{gg 
ifhh 

(hh 
_isDisposedhh 
)hh 
{ii 	
returnjj 
;jj 
}kk 	
LanguageSelectormm 
.mm 
Disposemm  
(mm  !
)mm! "
;mm" #$
ConnectivityNotificationnn  
.nn  !
Disposenn! (
(nn( )
)nn) *
;nn* +
_isDisposedpp 
=pp 
truepp 
;pp 
}qq 
privatess 
staticss 
doubless 
EaseInOutCubicss (
(ss( )
doubless) /
tss0 1
)ss1 2
=>ss3 5
tss6 7
<ss8 9
$numss: =
?ss> ?
$numss@ A
*ssB C
tssD E
*ssF G
tssH I
*ssJ K
tssL M
:ssN O
$numssP Q
-ssR S
MathssT X
.ssX Y
PowssY \
(ss\ ]
-ss] ^
$numss^ _
*ss` a
tssb c
+ssd e
$numssf g
,ssg h
$numssi j
)ssj k
/ssl m
$numssn o
;sso p
privateuu 
staticuu 
Taskuu 
SetupHandlersAsyncuu *
(uu* +
)uu+ ,
=>uu- /
Taskuu0 4
.uu4 5
CompletedTaskuu5 B
;uuB C
privateww 
asyncww 
Taskww $
AnimateWindowResizeAsyncww /
(ww/ 0
doubleww0 6
targetWidthww7 B
,wwB C
doublewwD J
targetHeightwwK W
,wwW X
TimeSpanwwY a
durationwwb j
)wwj k
{xx 
doubleyy 

startWidthyy 
=yy 
WindowWidthyy '
;yy' (
doublezz 
startHeightzz 
=zz 
WindowHeightzz )
;zz) *
if|| 

(|| 
Math|| 
.|| 
Abs|| 
(|| 

startWidth|| 
-||  !
targetWidth||" -
)||- .
<||/ 0
$num||1 5
&&||6 8
Math||9 =
.||= >
Abs||> A
(||A B
startHeight||B M
-||N O
targetHeight||P \
)||\ ]
<||^ _
$num||` d
)||d e
{}} 	
return~~ 
;~~ 
} 	
const
 
int
 
steps
 
=
 
$num
 
;
 
TimeSpan
‚‚ 
stepDuration
‚‚ 
=
‚‚ 
TimeSpan
‚‚  (
.
‚‚( )
FromMilliseconds
‚‚) 9
(
‚‚9 :
duration
‚‚: B
.
‚‚B C
TotalMilliseconds
‚‚C T
/
‚‚U V
steps
‚‚W \
)
‚‚\ ]
;
‚‚] ^
for
„„ 
(
„„ 
int
„„ 
i
„„ 
=
„„ 
$num
„„ 
;
„„ 
i
„„ 
<=
„„ 
steps
„„ "
;
„„" #
i
„„$ %
++
„„% '
)
„„' (
{
…… 	
double
†† 
progress
†† 
=
†† 
(
†† 
double
†† %
)
††% &
i
††& '
/
††( )
steps
††* /
;
††/ 0
double
‡‡ 
easedProgress
‡‡  
=
‡‡! "
EaseInOutCubic
‡‡# 1
(
‡‡1 2
progress
‡‡2 :
)
‡‡: ;
;
‡‡; <
WindowWidth
‰‰ 
=
‰‰ 

startWidth
‰‰ $
+
‰‰% &
(
‰‰' (
targetWidth
‰‰( 3
-
‰‰4 5

startWidth
‰‰6 @
)
‰‰@ A
*
‰‰B C
easedProgress
‰‰D Q
;
‰‰Q R
WindowHeight
ŠŠ 
=
ŠŠ 
startHeight
ŠŠ &
+
ŠŠ' (
(
ŠŠ) *
targetHeight
ŠŠ* 6
-
ŠŠ7 8
startHeight
ŠŠ9 D
)
ŠŠD E
*
ŠŠF G
easedProgress
ŠŠH U
;
ŠŠU V
await
ŒŒ 
Task
ŒŒ 
.
ŒŒ 
Delay
ŒŒ 
(
ŒŒ 
stepDuration
ŒŒ )
)
ŒŒ) *
.
ŒŒ* +
ConfigureAwait
ŒŒ+ 9
(
ŒŒ9 :
false
ŒŒ: ?
)
ŒŒ? @
;
ŒŒ@ A
}
 	
WindowWidth
 
=
 
targetWidth
 !
;
! "
WindowHeight
 
=
 
targetHeight
 #
;
# $
}
‘‘ 
private
““ 
async
““ 
Task
““ %
SetContentWithFadeAsync
““ .
(
““. /
object
““/ 5
content
““6 =
)
““= >
{
”” 
if
•• 

(
•• 
CurrentContent
•• 
!=
•• 
null
•• "
)
••" #
{
–– 	
await
—— 
Task
—— 
.
—— 
Delay
—— 
(
—— 
$num
——  
)
——  !
.
——! "
ConfigureAwait
——" 0
(
——0 1
false
——1 6
)
——6 7
;
——7 8
}
˜˜ 	
CurrentContent
šš 
=
šš 
content
šš  
;
šš  !
await
œœ 
Task
œœ 
.
œœ 
Delay
œœ 
(
œœ 
$num
œœ 
)
œœ 
.
œœ 
ConfigureAwait
œœ ,
(
œœ, -
false
œœ- 2
)
œœ2 3
;
œœ3 4
}
 
}žž þ>
g/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/VersionHelper.cs
	namespace 	
Ecliptix
 
. 
Core 
; 
[

 '
JsonSourceGenerationOptions

 
(

  
PropertyNamingPolicy 
= !
JsonKnownNamingPolicy 0
.0 1
	CamelCase1 :
,: ;
WriteIndented 
= 
false 
, 
GenerationMode 
= $
JsonSourceGenerationMode -
.- .
Metadata. 6
|7 8$
JsonSourceGenerationMode9 Q
.Q R
SerializationR _
)_ `
]` a
[ 
JsonSerializable 
( 
typeof 
( 
	BuildInfo "
)" #
)# $
]$ %
public 
partial 
class 
EcliptixJsonContext (
:) *!
JsonSerializerContext+ @
;@ A
public 
static 
class 
VersionHelper !
{ 
private 
static 
readonly 
Lazy  
<  !
string! '
>' (
ApplicationVersion) ;
=< =
new> A
(A B'
CalculateApplicationVersionB ]
)] ^
;^ _
[ (
UnconditionalSuppressMessage !
(! "
$str" ,
,, -
$str. 6
,6 7
Justification 
= 
$str w
)w x
]x y
private 
static 
readonly 
Lazy  
<  !
string! '
>' ( 
InformationalVersion) =
=> ?
new@ C
(C D)
CalculateInformationalVersionD a
)a b
;b c
private 
static 
readonly 
Lazy  
<  !
Option! '
<' (
	BuildInfo( 1
>1 2
>2 3
	BuildInfo4 =
=> ?
new@ C
(C D
LoadBuildInfoD Q
)Q R
;R S
private 
static 
readonly 
Lazy  
<  !
string! '
>' (
DisplayVersion) 7
=8 9
new: =
(= >#
CalculateDisplayVersion> U
)U V
;V W
public 

static 
string !
GetApplicationVersion .
(. /
)/ 0
=>1 3
ApplicationVersion4 F
.F G
ValueG L
;L M
public 

static 
string #
GetInformationalVersion 0
(0 1
)1 2
=>3 5 
InformationalVersion6 J
.J K
ValueK P
;P Q
public   

static   
Option   
<   
	BuildInfo   "
>  " #
GetBuildInfo  $ 0
(  0 1
)  1 2
=>  3 5
	BuildInfo  6 ?
.  ? @
Value  @ E
;  E F
public"" 

static"" 
string"" 
GetDisplayVersion"" *
(""* +
)""+ ,
=>""- /
DisplayVersion""0 >
.""> ?
Value""? D
;""D E
private$$ 
static$$ 
string$$ '
CalculateApplicationVersion$$ 5
($$5 6
)$$6 7
{%% 
return&& 
typeof&& 
(&& 
VersionHelper&& #
)&&# $
.&&$ %
Assembly&&% -
.&&- .
GetName&&. 5
(&&5 6
)&&6 7
.&&7 8
Version&&8 ?
?&&? @
.&&@ A
ToString&&A I
(&&I J
$num&&J K
)&&K L
??&&M O
$str&&P W
;&&W X
}'' 
[)) $
RequiresUnreferencedCode)) 
()) 
$str)) N
)))N O
]))O P
private** 
static** 
string** )
CalculateInformationalVersion** 7
(**7 8
)**8 9
{++ 
try,, 
{-- 	
string..  
informationalVersion.. '
=..( )
typeof..* 0
(..0 1
VersionHelper..1 >
)..> ?
...? @
Assembly..@ H
.// 
GetCustomAttributes// (
(//( )
typeof//) /
(/// 0
System//0 6
.//6 7

Reflection//7 A
.//A B1
%AssemblyInformationalVersionAttribute//B g
)//g h
,//h i
false//j o
)//o p
is00 
System00 
.00 

Reflection00 $
.00$ %1
%AssemblyInformationalVersionAttribute00% J
[00J K
]00K L
{00M N
Length00O U
:00U V
>00W X
$num00Y Z
}00[ \
attrs00] b
?11 
attrs11 
[11 
$num11 
]11 
.11  
InformationalVersion11 /
:22 !
GetApplicationVersion22 '
(22' (
)22( )
;22) *
return33  
informationalVersion33 '
;33' (
}44 	
catch55 
{66 	
return77 !
GetApplicationVersion77 (
(77( )
)77) *
;77* +
}88 	
}99 
private;; 
static;; 
Option;; 
<;; 
	BuildInfo;; #
>;;# $
LoadBuildInfo;;% 2
(;;2 3
);;3 4
{<< 
try== 
{>> 	
string?? 
buildInfoPath??  
=??! "
Path??# '
.??' (
Combine??( /
(??/ 0

AppContext??0 :
.??: ;
BaseDirectory??; H
,??H I
$str??J [
)??[ \
;??\ ]
if@@ 
(@@ 
!@@ 
File@@ 
.@@ 
Exists@@ 
(@@ 
buildInfoPath@@ *
)@@* +
)@@+ ,
{AA 
returnBB 
OptionBB 
<BB 
	BuildInfoBB '
>BB' (
.BB( )
NoneBB) -
;BB- .
}CC 
stringEE 
jsonEE 
=EE 
FileEE 
.EE 
ReadAllTextEE *
(EE* +
buildInfoPathEE+ 8
)EE8 9
;EE9 :
returnFF 
JsonSerializerFF !
.FF! "
DeserializeFF" -
(FF- .
jsonFF. 2
,FF2 3
EcliptixJsonContextFF4 G
.FFG H
DefaultFFH O
.FFO P
	BuildInfoFFP Y
)FFY Z
.FFZ [
ToOptionFF[ c
(FFc d
)FFd e
;FFe f
}GG 	
catchHH 
{II 	
returnJJ 
OptionJJ 
<JJ 
	BuildInfoJJ #
>JJ# $
.JJ$ %
NoneJJ% )
;JJ) *
}KK 	
}LL 
privateNN 
staticNN 
stringNN #
CalculateDisplayVersionNN 1
(NN1 2
)NN2 3
{OO 
returnPP 
GetBuildInfoPP 
(PP 
)PP 
.QQ 
SelectQQ 
(QQ 
infoQQ 
=>QQ 
infoQQ  
.QQ  !
FullVersionQQ! ,
)QQ, -
.RR 
ValueOrRR 
(RR #
GetInformationalVersionRR ,
(RR, -
)RR- .
)RR. /
;RR/ 0
}SS 
}TT 
publicVV 
recordVV 
	BuildInfoVV 
(VV 
stringWW 

VersionWW 
,WW 
stringXX 

BuildNumberXX 
,XX 
stringYY 

FullVersionYY 
,YY 
stringZZ 

	TimestampZZ 
,ZZ 
string[[ 

	GitCommit[[ 
,[[ 
string\\ 

	GitBranch\\ 
)]] 
;]] A
z/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Shared/Converters/MathConverters.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Shared 
. 

Converters )
;) *
public 
static 
class 
MathConverters "
{ 
public		 

static		 
readonly		 
IValueConverter		 *
Add		+ .
=		/ 0
new		1 4
AddConverter		5 A
(		A B
)		B C
;		C D
public

 

static

 
readonly

 
IValueConverter

 *
Subtract

+ 3
=

4 5
new

6 9
SubtractConverter

: K
(

K L
)

L M
;

M N
public 

static 
readonly 
IValueConverter *
Multiply+ 3
=4 5
new6 9
MultiplyConverter: K
(K L
)L M
;M N
public 

static 
readonly 
IValueConverter *
Divide+ 1
=2 3
new4 7
DivideConverter8 G
(G H
)H I
;I J
} 
public 
class 
AddConverter 
: 
IValueConverter +
{ 
public 

object 
? 
Convert 
( 
object !
?! "
value# (
,( )
Type* .

targetType/ 9
,9 :
object; A
?A B
	parameterC L
,L M
CultureInfoN Y
cultureZ a
)a b
{ 
return 
value 
switch 
{ 	
double 
doubleValue 
when #
	parameter$ -
is. 0
string1 7
paramStr8 @
&&A C
doubleD J
.J K
TryParseK S
(S T
paramStrT \
,\ ]
out^ a
doubleb h
parami n
)n o
=>p r
doubleValue 
+ 
param #
,# $
int 
intValue 
when 
	parameter '
is( *
string+ 1
	paramStr22 ;
&&< >
int? B
.B C
TryParseC K
(K L
	paramStr2L U
,U V
outW Z
int[ ^
param2_ e
)e f
=>g i
intValuej r
+s t
param2 
, 
_ 
=> 
value 
} 	
;	 

} 
public 

object 
ConvertBack 
( 
object $
?$ %
value& +
,+ ,
Type- 1

targetType2 <
,< =
object> D
?D E
	parameterF O
,O P
CultureInfoQ \
culture] d
)d e
{ 
throw 
new !
NotSupportedException '
(' (
$str( a
)a b
;b c
}   
}!! 
public## 
class## 
SubtractConverter## 
:##  
IValueConverter##! 0
{$$ 
public%% 

object%% 
?%% 
Convert%% 
(%% 
object%% !
?%%! "
value%%# (
,%%( )
Type%%* .

targetType%%/ 9
,%%9 :
object%%; A
?%%A B
	parameter%%C L
,%%L M
CultureInfo%%N Y
culture%%Z a
)%%a b
{&& 
if'' 

('' 
value'' 
is'' 
double'' 
doubleValue'' '
&&''( *
	parameter''+ 4
is''5 7
string''8 >
paramStr''? G
&&''H J
double''K Q
.''Q R
TryParse''R Z
(''Z [
paramStr''[ c
,''c d
out''e h
double''i o
param''p u
)''u v
)''v w
{(( 	
return)) 
doubleValue)) 
-))  
param))! &
;))& '
}** 	
return,, 
value,, 
;,, 
}-- 
public// 

object// 
ConvertBack// 
(// 
object// $
?//$ %
value//& +
,//+ ,
Type//- 1

targetType//2 <
,//< =
object//> D
?//D E
	parameter//F O
,//O P
CultureInfo//Q \
culture//] d
)//d e
{00 
throw11 
new11 !
NotSupportedException11 '
(11' (
$str11( a
)11a b
;11b c
}22 
}33 
public55 
class55 
MultiplyConverter55 
:55  
IValueConverter55! 0
{66 
public77 

object77 
?77 
Convert77 
(77 
object77 !
?77! "
value77# (
,77( )
Type77* .

targetType77/ 9
,779 :
object77; A
?77A B
	parameter77C L
,77L M
CultureInfo77N Y
culture77Z a
)77a b
{88 
if99 

(99 
value99 
is99 
double99 
doubleValue99 '
&&99( *
	parameter99+ 4
is995 7
string998 >
paramStr99? G
&&99H J
double99K Q
.99Q R
TryParse99R Z
(99Z [
paramStr99[ c
,99c d
out99e h
double99i o
param99p u
)99u v
)99v w
{:: 	
return;; 
doubleValue;; 
*;;  
param;;! &
;;;& '
}<< 	
return>> 
value>> 
;>> 
}?? 
publicAA 

objectAA 
ConvertBackAA 
(AA 
objectAA $
?AA$ %
valueAA& +
,AA+ ,
TypeAA- 1

targetTypeAA2 <
,AA< =
objectAA> D
?AAD E
	parameterAAF O
,AAO P
CultureInfoAAQ \
cultureAA] d
)AAd e
{BB 
throwCC 
newCC !
NotSupportedExceptionCC '
(CC' (
$strCC( a
)CCa b
;CCb c
}DD 
}EE 
publicGG 
classGG 
DivideConverterGG 
:GG 
IValueConverterGG .
{HH 
publicII 

objectII 
?II 
ConvertII 
(II 
objectII !
?II! "
valueII# (
,II( )
TypeII* .

targetTypeII/ 9
,II9 :
objectII; A
?IIA B
	parameterIIC L
,IIL M
CultureInfoIIN Y
cultureIIZ a
)IIa b
{JJ 
ifKK 

(KK 
valueKK 
isKK 
doubleKK 
doubleValueKK '
&&KK( *
	parameterKK+ 4
isKK5 7
stringKK8 >
paramStrKK? G
&&KKH J
doubleLL 
.LL 
TryParseLL 
(LL 
paramStrLL $
,LL$ %
outLL& )
doubleLL* 0
paramLL1 6
)LL6 7
&&LL8 :
MathLL; ?
.LL? @
AbsLL@ C
(LLC D
paramLLD I
)LLI J
>LLK L
doubleLLM S
.LLS T
EpsilonLLT [
)LL[ \
{MM 	
returnNN 
doubleValueNN 
/NN  
paramNN! &
;NN& '
}OO 	
returnQQ 
valueQQ 
;QQ 
}RR 
publicTT 

objectTT 
ConvertBackTT 
(TT 
objectTT $
?TT$ %
valueTT& +
,TT+ ,
TypeTT- 1

targetTypeTT2 <
,TT< =
objectTT> D
?TTD E
	parameterTTF O
,TTO P
CultureInfoTTQ \
cultureTT] d
)TTd e
{UU 
throwVV 
newVV !
NotSupportedExceptionVV '
(VV' (
$strVV( a
)VVa b
;VVb c
}WW 
}XX Ã
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Shared/Converters/EqualityConverter.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Shared 
. 

Converters )
;) *
public 
class 
EqualityConverter 
:  
IValueConverter! 0
{ 
public		 

object		 
?		 
Convert		 
(		 
object		 !
?		! "
value		# (
,		( )
Type		* .

targetType		/ 9
,		9 :
object		; A
?		A B
	parameter		C L
,		L M
CultureInfo		N Y
culture		Z a
)		a b
=>		c e
value

 
?

 
.

 
Equals

 
(

 
	parameter

 
)

  
??

! #
false

$ )
;

) *
public 

object 
ConvertBack 
( 
object $
?$ %
value& +
,+ ,
Type- 1

targetType2 <
,< =
object> D
?D E
	parameterF O
,O P
CultureInfoQ \
culture] d
)d e
{ 
throw 
new #
NotImplementedException )
() *
$str* e
)e f
;f g
} 
} ¦
…/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Shared/Converters/BooleanToOpacityConverter.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Shared 
. 

Converters )
;) *
public 
class %
BooleanToOpacityConverter &
:' (
IValueConverter) 8
{ 
public		 

double		 
TrueOpacity		 
{		 
get		  #
;		# $
set		% (
;		( )
}		* +
=		, -
$num		. 1
;		1 2
public

 

double

 
FalseOpacity

 
{

  
get

! $
;

$ %
set

& )
;

) *
}

+ ,
=

- .
$num

/ 0
;

0 1
public 

object 
Convert 
( 
object  
?  !
value" '
,' (
Type) -

targetType. 8
,8 9
object: @
?@ A
	parameterB K
,K L
CultureInfoM X
cultureY `
)` a
{ 
if 

( 
value 
is 
bool 
	boolValue #
)# $
{ 	
return 
	boolValue 
? 
TrueOpacity *
:+ ,
FalseOpacity- 9
;9 :
} 	
return 
FalseOpacity 
; 
} 
public 

object 
ConvertBack 
( 
object $
?$ %
value& +
,+ ,
Type- 1

targetType2 <
,< =
object> D
?D E
	parameterF O
,O P
CultureInfoQ \
culture] d
)d e
{ 
throw 
new #
NotImplementedException )
() *
$str* d
)d e
;e f
} 
} Ê
x/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Settings/DefaultSystemSettings.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Settings  
;  !
public 
class !
DefaultSystemSettings "
{ 
public 

required 
string 
DefaultTheme '
{( )
get* -
;- .
set/ 2
;2 3
}4 5
public 

required 
string 
Environment &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
public 

required 
string &
DataCenterConnectionString 5
{6 7
get8 ;
;; <
set= @
;@ A
}B C
public 

required 
string 
CountryCodeApi )
{* +
get, /
;/ 0
set1 4
;4 5
}6 7
public		 

required		 
string		 

DomainName		 %
{		& '
get		( +
;		+ ,
set		- 0
;		0 1
}		2 3
public

 

string

 
?

 
Culture

 
{

 
get

  
;

  !
set

" %
;

% &
}

' (
public 

required 
string 
PrivacyPolicyUrl +
{, -
get. 1
;1 2
set3 6
;6 7
}8 9
public 

required 
string 
TermsOfServiceUrl ,
{- .
get/ 2
;2 3
set4 7
;7 8
}9 :
public 

required 
string 

SupportUrl %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
} ê
ˆ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Settings/Constants/AppCultureSettingsConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Settings  
.  !
	Constants! *
;* +
public 
static 
class '
AppCultureSettingsConstants /
{ 
public 

const 
string  
DEFAULT_CULTURE_CODE ,
=- .
$str/ 6
;6 7
public 

const 
string "
UKRAINIAN_CULTURE_CODE .
=/ 0
$str1 8
;8 9
public 

const 
string &
UNITED_STATES_COUNTRY_CODE 2
=3 4
$str5 9
;9 :
public		 

const		 
string		  
UKRAINE_COUNTRY_CODE		 ,
=		- .
$str		/ 3
;		3 4
public 

const 
string #
UNITED_STATES_FLAG_PATH /
=0 1
$str2 j
;j k
public 

const 
string 
UKRAINE_FLAG_PATH )
=* +
$str, h
;h i
public 

const 
int "
DEFAULT_LANGUAGE_INDEX +
=, -
$num. /
;/ 0
public 

const 
int 
INITIAL_CAPACITY %
=& '
$num( )
;) *
public 

const 
char *
CULTURE_DISPLAY_NAME_SEPARATOR 4
=5 6
$char7 :
;: ;
public 

static 
readonly 
string !
EmptyString" -
=. /
string0 6
.6 7
Empty7 <
;< =
} §E
u/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Settings/AppCultureSettings.cs
	namespace		 	
Ecliptix		
 
.		 
Core		 
.		 
Settings		  
;		  !
public 
sealed 
class 
AppCultureSettings &
{ 
private 
static 
readonly 
Lazy  
<  !
AppCultureSettings! 3
>3 4
Instance5 =
=> ?
new@ C
(C D
(D E
)E F
=>G I
newJ M
AppCultureSettingsN `
(` a
)a b
)b c
;c d
public 

static 
AppCultureSettings $
Default% ,
=>- /
Instance0 8
.8 9
Value9 >
;> ?
private 
readonly 
FrozenDictionary %
<% &
string& ,
,, -
LanguageItem. :
>: ;
_languagesByCode< L
;L M
private 
readonly 
FrozenDictionary %
<% &
string& ,
,, -
string. 4
>4 5
_countryCultureMap6 H
;H I
private 
readonly 
FrozenDictionary %
<% &
string& ,
,, -
int. 1
>1 2
_languageIndexMap3 D
;D E
private 
AppCultureSettings 
( 
)  
{ 
List 
< 
LanguageItem 
> 
supportedLanguages -
=. /
new0 3
(3 4'
AppCultureSettingsConstants4 O
.O P
INITIAL_CAPACITYP `
)` a
{ 	
new 
LanguageItem 
( '
AppCultureSettingsConstants 8
.8 9 
DEFAULT_CULTURE_CODE9 M
,M N'
AppCultureSettingsConstants +
.+ ,&
UNITED_STATES_COUNTRY_CODE, F
,F G'
AppCultureSettingsConstants +
.+ ,#
UNITED_STATES_FLAG_PATH, C
)C D
,D E
new 
LanguageItem 
( '
AppCultureSettingsConstants 8
.8 9"
UKRAINIAN_CULTURE_CODE9 O
,O P'
AppCultureSettingsConstants +
.+ , 
UKRAINE_COUNTRY_CODE, @
,@ A'
AppCultureSettingsConstants +
.+ ,
UKRAINE_FLAG_PATH, =
)= >
} 	
;	 


Dictionary!! 
<!! 
string!! 
,!! 
string!! !
>!!! "
countryCultureMap!!# 4
=!!5 6
new!!7 :
(!!: ;'
AppCultureSettingsConstants!!; V
.!!V W
INITIAL_CAPACITY!!W g
)!!g h
{"" 	
{## '
AppCultureSettingsConstants## )
.##) *&
UNITED_STATES_COUNTRY_CODE##* D
,##D E'
AppCultureSettingsConstants##F a
.##a b 
DEFAULT_CULTURE_CODE##b v
}##w x
,##x y
{$$ '
AppCultureSettingsConstants$$ )
.$$) * 
UKRAINE_COUNTRY_CODE$$* >
,$$> ?'
AppCultureSettingsConstants$$@ [
.$$[ \"
UKRAINIAN_CULTURE_CODE$$\ r
}$$s t
,$$t u
}%% 	
;%%	 

_languagesByCode'' 
='' 
supportedLanguages'' -
.''- .
ToFrozenDictionary''. @
(''@ A
lang''A E
=>''F H
lang''I M
.''M N
Code''N R
,''R S
lang''T X
=>''Y [
lang''\ `
)''` a
;''a b
_countryCultureMap(( 
=(( 
countryCultureMap(( .
.((. /
ToFrozenDictionary((/ A
(((A B
)((B C
;((C D
_languageIndexMap)) 
=)) "
CreateLanguageIndexMap)) 2
())2 3
supportedLanguages))3 E
)))E F
;))F G
}** 
private,, 
static,, 
FrozenDictionary,, #
<,,# $
string,,$ *
,,,* +
int,,, /
>,,/ 0"
CreateLanguageIndexMap,,1 G
(,,G H
List,,H L
<,,L M
LanguageItem,,M Y
>,,Y Z
supportedLanguages,,[ m
),,m n
{-- 

Dictionary.. 
<.. 
string.. 
,.. 
int.. 
>.. 
indexMap..  (
=..) *
new..+ .
(... /
supportedLanguages../ A
...A B
Count..B G
)..G H
;..H I
for// 
(// 
int// 
i// 
=// 
$num// 
;// 
i// 
<// 
supportedLanguages// .
.//. /
Count/// 4
;//4 5
i//6 7
++//7 9
)//9 :
{00 	
indexMap11 
[11 
supportedLanguages11 '
[11' (
i11( )
]11) *
.11* +
Code11+ /
]11/ 0
=111 2
i113 4
;114 5
}22 	
return33 
indexMap33 
.33 
ToFrozenDictionary33 *
(33* +
)33+ ,
;33, -
}44 
public66 

IReadOnlyCollection66 
<66 
LanguageItem66 +
>66+ ,
SupportedLanguages66- ?
=>66@ B
_languagesByCode66C S
.66S T
Values66T Z
;66Z [
public88 

Option88 
<88 
LanguageItem88 
>88 
GetLanguageByCode88  1
(881 2
string882 8
cultureCode889 D
)88D E
=>88F H
_languagesByCode99 
.99 
GetValueOrDefault99 *
(99* +
cultureCode99+ 6
)996 7
.997 8
ToOption998 @
(99@ A
)99A B
;99B C
public;; 

string;; 
GetCultureByCountry;; %
(;;% &
string;;& ,
countryCode;;- 8
);;8 9
=>;;: <
_countryCultureMap<< 
.<< 
GetValueOrDefault<< ,
(<<, -
countryCode<<- 8
?<<8 9
.<<9 :
ToUpperInvariant<<: J
(<<J K
)<<K L
??<<M O'
AppCultureSettingsConstants<<P k
.<<k l
EmptyString<<l w
,<<w x(
AppCultureSettingsConstants	<<y ”
.
<<” •"
DEFAULT_CULTURE_CODE
<<• ©
)
<<© ª
;
<<ª «
public>> 

int>> 
GetLanguageIndex>> 
(>>  
string>>  &
cultureCode>>' 2
)>>2 3
=>>>4 6
_languageIndexMap?? 
.?? 
GetValueOrDefault?? +
(??+ ,
cultureCode??, 7
,??7 8'
AppCultureSettingsConstants??9 T
.??T U"
DEFAULT_LANGUAGE_INDEX??U k
)??k l
;??l m
publicAA 

stringAA 
GetDisplayNameAA  
(AA  !
stringAA! '
cultureCodeAA( 3
)AA3 4
{BB 
returnCC 
GetLanguageByCodeCC  
(CC  !
cultureCodeCC! ,
)CC, -
.DD 
SelectDD 
(DD 
langDD 
=>DD 
langDD  
.DD  !
DisplayNameDD! ,
)DD, -
.EE 
GetValueOrDefaultEE 
(EE 
(EE  
)EE  !
=>EE" $
{FF 
tryGG 
{HH 
CultureInfoII 
cultureII  '
=II( )
CultureInfoII* 5
.II5 6
GetCultureInfoII6 D
(IID E
cultureCodeIIE P
)IIP Q
;IIQ R
stringJJ 
englishNameJJ &
=JJ' (
cultureJJ) 0
.JJ0 1
EnglishNameJJ1 <
;JJ< =
intKK 
separatorIndexKK &
=KK' (
englishNameKK) 4
.KK4 5
IndexOfKK5 <
(KK< ='
AppCultureSettingsConstantsKK= X
.KKX Y*
CULTURE_DISPLAY_NAME_SEPARATORKKY w
)KKw x
;KKx y
returnLL 
separatorIndexLL )
>LL* +
$numLL, -
?LL. /
englishNameLL0 ;
[LL; <
..LL< >
separatorIndexLL> L
]LLL M
.LLM N
TrimLLN R
(LLR S
)LLS T
:LLU V
englishNameLLW b
.LLb c
TrimLLc g
(LLg h
)LLh i
;LLi j
}MM 
catchNN 
{OO 
returnPP 
cultureCodePP &
;PP& '
}QQ 
}RR 
)RR 
;RR 
}SS 
}TT Â
ƒ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Security/ServerPublicKeyProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Security! )
;) *
internal

 
sealed

	 
class

 #
ServerPublicKeyProvider

 -
(

- .
NetworkProvider

. =
networkProvider

> M
)

M N
:

O P$
IServerPublicKeyProvider

Q i
{ 
private 
readonly 
Lock 
_lock 
=  !
new" %
(% &
)& '
;' (
private 
Option 
< 
byte 
[ 
] 
> 

_cachedKey %
=& '
Option( .
<. /
byte/ 3
[3 4
]4 5
>5 6
.6 7
None7 ;
;; <
public 

byte 
[ 
] 
GetServerPublicKey $
($ %
)% &
{ 
lock 
( 
_lock 
) 
{ 	
if 
( 

_cachedKey 
. 
IsSome !
)! "
{ 
return 
( 
byte 
[ 
] 
) 

_cachedKey )
.) *
Value* /
!/ 0
.0 1
Clone1 6
(6 7
)7 8
;8 9
} 
byte 
[ 
] 
newKey 
= #
SecureByteStringInterop 3
.3 4 
WithByteStringAsSpan4 H
(H I
networkProvider 
.  '
ApplicationInstanceSettings  ;
.; <
ServerPublicKey< K
,K L
span 
=> 
span 
. 
ToArray $
($ %
)% &
)& '
;' (

_cachedKey 
= 
Option 
<  
byte  $
[$ %
]% &
>& '
.' (
Some( ,
(, -
newKey- 3
)3 4
;4 5
return 
( 
byte 
[ 
] 
) 

_cachedKey %
.% &
Value& +
!+ ,
., -
Clone- 2
(2 3
)3 4
;4 5
} 	
}   
}!! Ú
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/UnaryRpcServices.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
sealed 
class 
UnaryRpcServices $
:% &
IUnaryRpcServices' 8
{ 
private 
readonly 

Dictionary 
<  
RpcServiceType  .
,. /
GrpcMethodDelegate0 B
>B C
_serviceMethodsD S
;S T
private 
readonly 
MembershipServices '
.' ($
MembershipServicesClient( @%
_membershipServicesClientA Z
;Z [
private 
readonly 
IGrpcErrorProcessor (
_errorProcessor) 8
;8 9
private 
readonly #
IGrpcCallOptionsFactory ,
_callOptionsFactory- @
;@ A
private 
delegate 
Task 
< 
Result  
<  !
SecureEnvelope! /
,/ 0
NetworkFailure1 ?
>? @
>@ A
GrpcMethodDelegateB T
(T U
SecureEnvelope 
payload 
, 
RpcRequestContext 
? 
requestContext )
,) * 
IConnectivityService 
connectivityService 0
,0 1
CancellationToken 
token 
) 
; 
public 

UnaryRpcServices 
( 
MembershipServices   
.   $
MembershipServicesClient   3$
membershipServicesClient  4 L
,  L M
DeviceService!! 
.!! 
DeviceServiceClient!! )
deviceServiceClient!!* =
,!!= >$
AuthVerificationServices""  
.""  !*
AuthVerificationServicesClient""! ?(
authenticationServicesClient""@ \
,""\ ]
IGrpcErrorProcessor## 
errorProcessor## *
,##* +#
IGrpcCallOptionsFactory$$ 
callOptionsFactory$$  2
)%% 
{&& %
_membershipServicesClient'' !
=''" #$
membershipServicesClient''$ <
;''< =
_errorProcessor(( 
=(( 
errorProcessor(( (
;((( )
_callOptionsFactory)) 
=)) 
callOptionsFactory)) 0
;))0 1
_serviceMethods++ 
=++ 
new++ 

Dictionary++ (
<++( )
RpcServiceType++) 7
,++7 8
GrpcMethodDelegate++9 K
>++K L
{,, 	
[-- 
RpcServiceType-- 
.-- 
RegisterAppDevice-- -
]--- .
=--/ 0
RegisterDeviceAsync--1 D
,--D E
[.. 
RpcServiceType.. 
...  
ValidateMobileNumber.. 0
]..0 1
=..2 3%
ValidateMobileNumberAsync..4 M
,..M N
[// 
RpcServiceType// 
.// )
CheckMobileNumberAvailability// 9
]//9 :
=//; <.
"CheckMobileNumberAvailabilityAsync//= _
,//_ `
[00 
RpcServiceType00 
.00 
RegistrationInit00 ,
]00, -
=00. /0
$OpaqueRegistrationRecordRequestAsync000 T
,00T U
[11 
RpcServiceType11 
.11 
	VerifyOtp11 %
]11% &
=11' (
VerifyCodeAsync11) 8
,118 9
[22 
RpcServiceType22 
.22  
RegistrationComplete22 0
]220 1
=222 32
&OpaqueRegistrationCompleteRequestAsync224 Z
,22Z [
[33 
RpcServiceType33 
.33 !
RecoverySecretKeyInit33 1
]331 2
=333 4*
OpaqueRecoveryInitRequestAsync335 S
,33S T
[44 
RpcServiceType44 
.44 %
RecoverySecretKeyComplete44 5
]445 6
=447 8.
"OpaqueRecoveryCompleteRequestAsync449 [
,44[ \
[55 
RpcServiceType55 
.55 
SignInInitRequest55 -
]55- .
=55/ 0(
OpaqueSignInInitRequestAsync551 M
,55M N
[66 
RpcServiceType66 
.66 !
SignInCompleteRequest66 1
]661 2
=663 4,
 OpaqueSignInCompleteRequestAsync665 U
,66U V
[77 
RpcServiceType77 
.77 
Logout77 "
]77" #
=77$ %
LogoutAsync77& 1
,771 2
[88 
RpcServiceType88 
.88 
AnonymousLogout88 +
]88+ ,
=88- . 
AnonymousLogoutAsync88/ C
}99 	
;99	 

return:: 
;:: 
async<< 
Task<< 
<<< 
Result<< 
<<< 
SecureEnvelope<< (
,<<( )
NetworkFailure<<* 8
><<8 9
><<9 :
LogoutAsync<<; F
(<<F G
SecureEnvelope== 
payload== "
,==" #
RpcRequestContext>> 
?>> 
requestContext>> -
,>>- . 
IConnectivityService??  
connectivityService??! 4
,??4 5
CancellationToken@@ 
token@@ #
)AA 	
{BB 	
returnCC 
awaitCC  
ExecuteGrpcCallAsyncCC -
(CC- .
RpcServiceTypeDD 
.DD 
LogoutDD %
,DD% &
connectivityServiceEE #
,EE# $
requestContextFF 
,FF 
tokenGG 
,GG 
callOptionsHH 
=>HH %
_membershipServicesClientII -
.II- .
LogoutAsyncII. 9
(II9 :
payloadJJ 
,JJ  
callOptionsKK #
)LL 
)MM 
.MM 
ConfigureAwaitMM 
(MM 
falseMM "
)MM" #
;MM# $
}NN 	
asyncPP 
TaskPP 
<PP 
ResultPP 
<PP 
SecureEnvelopePP (
,PP( )
NetworkFailurePP* 8
>PP8 9
>PP9 : 
AnonymousLogoutAsyncPP; O
(PPO P
SecureEnvelopeQQ 
payloadQQ "
,QQ" #
RpcRequestContextRR 
?RR 
requestContextRR -
,RR- . 
IConnectivityServiceSS  
connectivityServiceSS! 4
,SS4 5
CancellationTokenTT 
tokenTT #
)UU 	
{VV 	
returnWW 
awaitWW  
ExecuteGrpcCallAsyncWW -
(WW- .
RpcServiceTypeXX 
.XX 
AnonymousLogoutXX .
,XX. /
connectivityServiceYY #
,YY# $
requestContextZZ 
,ZZ 
token[[ 
,[[ 
callOptions\\ 
=>\\ %
_membershipServicesClient]] -
.]]- . 
AnonymousLogoutAsync]]. B
(]]B C
payload^^ 
,^^  
callOptions__ #
)`` 
)aa 
.aa 
ConfigureAwaitaa 
(aa 
falseaa "
)aa" #
;aa# $
}bb 	
asyncdd 
Taskdd 
<dd 
Resultdd 
<dd 
SecureEnvelopedd (
,dd( )
NetworkFailuredd* 8
>dd8 9
>dd9 :
RegisterDeviceAsyncdd; N
(ddN O
SecureEnvelopeee 
payloadee "
,ee" #
RpcRequestContextff 
?ff 
requestContextff -
,ff- . 
IConnectivityServicegg  
connectivityServicegg! 4
,gg4 5
CancellationTokenhh 
tokenhh #
)ii 	
{jj 	
returnkk 
awaitkk  
ExecuteGrpcCallAsynckk -
(kk- .
RpcServiceTypell 
.ll 
RegisterAppDevicell 0
,ll0 1
connectivityServicemm #
,mm# $
requestContextnn 
,nn 
tokenoo 
,oo 
callOptionspp 
=>pp 
deviceServiceClientqq '
.qq' (
RegisterDeviceAsyncqq( ;
(qq; <
payloadrr 
,rr  
callOptionsss #
)tt 
)uu 
.uu 
ConfigureAwaituu 
(uu 
falseuu "
)uu" #
;uu# $
}vv 	
asyncxx 
Taskxx 
<xx 
Resultxx 
<xx 
SecureEnvelopexx (
,xx( )
NetworkFailurexx* 8
>xx8 9
>xx9 :%
ValidateMobileNumberAsyncxx; T
(xxT U
SecureEnvelopeyy 
payloadyy "
,yy" #
RpcRequestContextzz 
?zz 
requestContextzz -
,zz- . 
IConnectivityService{{  
connectivityService{{! 4
,{{4 5
CancellationToken|| 
token|| #
)}} 	
{~~ 	
return 
await  
ExecuteGrpcCallAsync -
(- .
RpcServiceType
€€ 
.
€€ "
ValidateMobileNumber
€€ 3
,
€€3 4!
connectivityService
 #
,
# $
requestContext
‚‚ 
,
‚‚ 
token
ƒƒ 
,
ƒƒ 
callOptions
„„ 
=>
„„ *
authenticationServicesClient
…… 0
.
……0 1'
ValidateMobileNumberAsync
……1 J
(
……J K
payload
†† 
,
††  
callOptions
‡‡ #
)
ˆˆ 
)
‰‰ 
.
‰‰ 
ConfigureAwait
‰‰ 
(
‰‰ 
false
‰‰ "
)
‰‰" #
;
‰‰# $
}
ŠŠ 	
async
ŒŒ 
Task
ŒŒ 
<
ŒŒ 
Result
ŒŒ 
<
ŒŒ 
SecureEnvelope
ŒŒ (
,
ŒŒ( )
NetworkFailure
ŒŒ* 8
>
ŒŒ8 9
>
ŒŒ9 :0
"CheckMobileNumberAvailabilityAsync
ŒŒ; ]
(
ŒŒ] ^
SecureEnvelope
 
payload
 "
,
" #
RpcRequestContext
ŽŽ 
?
ŽŽ 
requestContext
ŽŽ -
,
ŽŽ- ."
IConnectivityService
  !
connectivityService
! 4
,
4 5
CancellationToken
 
token
 #
)
‘‘ 	
{
’’ 	
return
““ 
await
““ "
ExecuteGrpcCallAsync
““ -
(
““- .
RpcServiceType
”” 
.
”” +
CheckMobileNumberAvailability
”” <
,
””< =!
connectivityService
•• #
,
••# $
requestContext
–– 
,
–– 
token
—— 
,
—— 
callOptions
˜˜ 
=>
˜˜ *
authenticationServicesClient
™™ 0
.
™™0 10
"CheckMobileNumberAvailabilityAsync
™™1 S
(
™™S T
payload
šš 
,
šš  
callOptions
›› #
)
œœ 
)
 
.
 
ConfigureAwait
 
(
 
false
 "
)
" #
;
# $
}
žž 	
async
   
Task
   
<
   
Result
   
<
   
SecureEnvelope
   (
,
  ( )
NetworkFailure
  * 8
>
  8 9
>
  9 :2
$OpaqueRegistrationRecordRequestAsync
  ; _
(
  _ `
SecureEnvelope
¡¡ 
payload
¡¡ "
,
¡¡" #
RpcRequestContext
¢¢ 
?
¢¢ 
requestContext
¢¢ -
,
¢¢- ."
IConnectivityService
££  !
connectivityService
££! 4
,
££4 5
CancellationToken
¤¤ 
token
¤¤ #
)
¥¥ 	
{
¦¦ 	
return
§§ 
await
§§ "
ExecuteGrpcCallAsync
§§ -
(
§§- .
RpcServiceType
¨¨ 
.
¨¨ 
RegistrationInit
¨¨ /
,
¨¨/ 0!
connectivityService
©© #
,
©©# $
requestContext
ªª 
,
ªª 
token
«« 
,
«« 
callOptions
¬¬ 
=>
¬¬ &
membershipServicesClient
­­ ,
.
­­, -0
"OpaqueRegistrationInitRequestAsync
­­- O
(
­­O P
payload
®® 
,
®®  
callOptions
¯¯ #
)
°° 
)
±± 
.
±± 
ConfigureAwait
±± 
(
±± 
false
±± "
)
±±" #
;
±±# $
}
²² 	
async
´´ 
Task
´´ 
<
´´ 
Result
´´ 
<
´´ 
SecureEnvelope
´´ (
,
´´( )
NetworkFailure
´´* 8
>
´´8 9
>
´´9 :
VerifyCodeAsync
´´; J
(
´´J K
SecureEnvelope
µµ 
payload
µµ "
,
µµ" #
RpcRequestContext
¶¶ 
?
¶¶ 
requestContext
¶¶ -
,
¶¶- ."
IConnectivityService
··  !
connectivityService
··! 4
,
··4 5
CancellationToken
¸¸ 
token
¸¸ #
)
¹¹ 	
{
ºº 	
return
»» 
await
»» "
ExecuteGrpcCallAsync
»» -
(
»»- .
RpcServiceType
¼¼ 
.
¼¼ 
	VerifyOtp
¼¼ (
,
¼¼( )!
connectivityService
½½ #
,
½½# $
requestContext
¾¾ 
,
¾¾ 
token
¿¿ 
,
¿¿ 
callOptions
ÀÀ 
=>
ÀÀ *
authenticationServicesClient
ÁÁ 0
.
ÁÁ0 1
VerifyOtpAsync
ÁÁ1 ?
(
ÁÁ? @
payload
ÂÂ 
,
ÂÂ  
callOptions
ÃÃ #
)
ÄÄ 
)
ÅÅ 
.
ÅÅ 
ConfigureAwait
ÅÅ 
(
ÅÅ 
false
ÅÅ "
)
ÅÅ" #
;
ÅÅ# $
}
ÆÆ 	
async
ÈÈ 
Task
ÈÈ 
<
ÈÈ 
Result
ÈÈ 
<
ÈÈ 
SecureEnvelope
ÈÈ (
,
ÈÈ( )
NetworkFailure
ÈÈ* 8
>
ÈÈ8 9
>
ÈÈ9 :4
&OpaqueRegistrationCompleteRequestAsync
ÈÈ; a
(
ÈÈa b
SecureEnvelope
ÉÉ 
payload
ÉÉ "
,
ÉÉ" #
RpcRequestContext
ÊÊ 
?
ÊÊ 
requestContext
ÊÊ -
,
ÊÊ- ."
IConnectivityService
ËË  !
connectivityService
ËË! 4
,
ËË4 5
CancellationToken
ÌÌ 
token
ÌÌ #
)
ÍÍ 	
{
ÎÎ 	
return
ÏÏ 
await
ÏÏ "
ExecuteGrpcCallAsync
ÏÏ -
(
ÏÏ- .
RpcServiceType
ÐÐ 
.
ÐÐ "
RegistrationComplete
ÐÐ 3
,
ÐÐ3 4!
connectivityService
ÑÑ #
,
ÑÑ# $
requestContext
ÒÒ 
,
ÒÒ 
token
ÓÓ 
,
ÓÓ 
callOptions
ÔÔ 
=>
ÔÔ &
membershipServicesClient
ÕÕ ,
.
ÕÕ, -4
&OpaqueRegistrationCompleteRequestAsync
ÕÕ- S
(
ÕÕS T
payload
ÖÖ 
,
ÖÖ  
callOptions
×× #
)
ØØ 
)
ÙÙ 
.
ÙÙ 
ConfigureAwait
ÙÙ 
(
ÙÙ 
false
ÙÙ "
)
ÙÙ" #
;
ÙÙ# $
}
ÚÚ 	
async
ÜÜ 
Task
ÜÜ 
<
ÜÜ 
Result
ÜÜ 
<
ÜÜ 
SecureEnvelope
ÜÜ (
,
ÜÜ( )
NetworkFailure
ÜÜ* 8
>
ÜÜ8 9
>
ÜÜ9 :*
OpaqueSignInInitRequestAsync
ÜÜ; W
(
ÜÜW X
SecureEnvelope
ÝÝ 
payload
ÝÝ "
,
ÝÝ" #
RpcRequestContext
ÞÞ 
?
ÞÞ 
requestContext
ÞÞ -
,
ÞÞ- ."
IConnectivityService
ßß  !
connectivityService
ßß! 4
,
ßß4 5
CancellationToken
àà 
token
àà #
)
áá 	
{
ââ 	
return
ãã 
await
ãã "
ExecuteGrpcCallAsync
ãã -
(
ãã- .
RpcServiceType
ää 
.
ää 
SignInInitRequest
ää 0
,
ää0 1!
connectivityService
åå #
,
åå# $
requestContext
ææ 
,
ææ 
token
çç 
,
çç 
callOptions
èè 
=>
èè &
membershipServicesClient
éé ,
.
éé, -*
OpaqueSignInInitRequestAsync
éé- I
(
ééI J
payload
êê 
,
êê  
callOptions
ëë #
)
ìì 
)
íí 
.
íí 
ConfigureAwait
íí 
(
íí 
false
íí "
)
íí" #
;
íí# $
}
îî 	
async
ðð 
Task
ðð 
<
ðð 
Result
ðð 
<
ðð 
SecureEnvelope
ðð (
,
ðð( )
NetworkFailure
ðð* 8
>
ðð8 9
>
ðð9 :.
 OpaqueSignInCompleteRequestAsync
ðð; [
(
ðð[ \
SecureEnvelope
ññ 
payload
ññ "
,
ññ" #
RpcRequestContext
òò 
?
òò 
requestContext
òò -
,
òò- ."
IConnectivityService
óó  !
connectivityService
óó! 4
,
óó4 5
CancellationToken
ôô 
token
ôô #
)
õõ 	
{
öö 	
return
÷÷ 
await
÷÷ "
ExecuteGrpcCallAsync
÷÷ -
(
÷÷- .
RpcServiceType
øø 
.
øø #
SignInCompleteRequest
øø 4
,
øø4 5!
connectivityService
ùù #
,
ùù# $
requestContext
úú 
,
úú 
token
ûû 
,
ûû 
callOptions
üü 
=>
üü &
membershipServicesClient
ýý ,
.
ýý, -.
 OpaqueSignInCompleteRequestAsync
ýý- M
(
ýýM N
payload
þþ 
,
þþ  
callOptions
ÿÿ #
)
€€ 
)
 
.
 
ConfigureAwait
 
(
 
false
 "
)
" #
;
# $
}
‚‚ 	
async
„„ 
Task
„„ 
<
„„ 
Result
„„ 
<
„„ 
SecureEnvelope
„„ (
,
„„( )
NetworkFailure
„„* 8
>
„„8 9
>
„„9 :,
OpaqueRecoveryInitRequestAsync
„„; Y
(
„„Y Z
SecureEnvelope
…… 
payload
…… "
,
……" #
RpcRequestContext
†† 
?
†† 
requestContext
†† -
,
††- ."
IConnectivityService
‡‡  !
connectivityService
‡‡! 4
,
‡‡4 5
CancellationToken
ˆˆ 
token
ˆˆ #
)
‰‰ 	
{
ŠŠ 	
return
‹‹ 
await
‹‹ "
ExecuteGrpcCallAsync
‹‹ -
(
‹‹- .
RpcServiceType
ŒŒ 
.
ŒŒ #
RecoverySecretKeyInit
ŒŒ 4
,
ŒŒ4 5!
connectivityService
 #
,
# $
requestContext
ŽŽ 
,
ŽŽ 
token
 
,
 
callOptions
 
=>
 &
membershipServicesClient
‘‘ ,
.
‘‘, -5
'OpaqueRecoverySecretKeyInitRequestAsync
‘‘- T
(
‘‘T U
payload
’’ 
,
’’  
callOptions
““ #
)
”” 
)
•• 
.
•• 
ConfigureAwait
•• 
(
•• 
false
•• "
)
••" #
;
••# $
}
–– 	
async
˜˜ 
Task
˜˜ 
<
˜˜ 
Result
˜˜ 
<
˜˜ 
SecureEnvelope
˜˜ (
,
˜˜( )
NetworkFailure
˜˜* 8
>
˜˜8 9
>
˜˜9 :0
"OpaqueRecoveryCompleteRequestAsync
˜˜; ]
(
˜˜] ^
SecureEnvelope
™™ 
payload
™™ "
,
™™" #
RpcRequestContext
šš 
?
šš 
requestContext
šš -
,
šš- ."
IConnectivityService
››  !
connectivityService
››! 4
,
››4 5
CancellationToken
œœ 
token
œœ #
)
 	
{
žž 	
return
ŸŸ 
await
ŸŸ "
ExecuteGrpcCallAsync
ŸŸ -
(
ŸŸ- .
RpcServiceType
   
.
   '
RecoverySecretKeyComplete
   8
,
  8 9!
connectivityService
¡¡ #
,
¡¡# $
requestContext
¢¢ 
,
¢¢ 
token
££ 
,
££ 
callOptions
¤¤ 
=>
¤¤ &
membershipServicesClient
¥¥ ,
.
¥¥, -9
+OpaqueRecoverySecretKeyCompleteRequestAsync
¥¥- X
(
¥¥X Y
payload
¦¦ 
,
¦¦  
callOptions
§§ #
)
¨¨ 
)
©© 
.
©© 
ConfigureAwait
©© 
(
©© 
false
©© "
)
©©" #
;
©©# $
}
ªª 	
}
«« 
public
­­ 

async
­­ 
Task
­­ 
<
­­ 
Result
­­ 
<
­­ 
RpcFlow
­­ $
,
­­$ %
NetworkFailure
­­& 4
>
­­4 5
>
­­5 6 
InvokeRequestAsync
­­7 I
(
­­I J
ServiceRequest
®® 
request
®® 
,
®® "
IConnectivityService
¯¯ !
connectivityService
¯¯ 0
,
¯¯0 1
CancellationToken
°° 
token
°° 
)
±± 
{
²² 
if
³³ 

(
³³ 
_serviceMethods
³³ 
.
³³ 
TryGetValue
³³ '
(
³³' (
request
³³( /
.
³³/ 0
RpcServiceMethod
³³0 @
,
³³@ A
out
³³B E 
GrpcMethodDelegate
³³F X
?
³³X Y
method
³³Z `
)
³³` a
)
³³a b
{
´´ 	
Result
µµ 
<
µµ 
SecureEnvelope
µµ !
,
µµ! "
NetworkFailure
µµ# 1
>
µµ1 2
result
µµ3 9
=
µµ: ;
await
µµ< A
method
µµB H
(
µµH I
request
¶¶ 
.
¶¶ 
Payload
¶¶ 
,
¶¶  
request
·· 
.
·· 
RequestContext
·· &
,
··& '!
connectivityService
¸¸ #
,
¸¸# $
token
¹¹ 
)
ºº 
.
ºº 
ConfigureAwait
ºº 
(
ºº 
false
ºº "
)
ºº" #
;
ºº# $
if
¼¼ 
(
¼¼ 
result
¼¼ 
.
¼¼ 
IsOk
¼¼ 
)
¼¼ 
{
½½ 
return
¾¾ 
Result
¾¾ 
<
¾¾ 
RpcFlow
¾¾ %
,
¾¾% &
NetworkFailure
¾¾' 5
>
¾¾5 6
.
¾¾6 7
Ok
¾¾7 9
(
¾¾9 :
new
¿¿ 
RpcFlow
¿¿ 
.
¿¿  

SingleCall
¿¿  *
(
¿¿* +
Task
¿¿+ /
.
¿¿/ 0

FromResult
¿¿0 :
(
¿¿: ;
result
¿¿; A
)
¿¿A B
)
¿¿B C
)
ÀÀ 
;
ÀÀ 
}
ÁÁ 
return
ÃÃ 
Result
ÃÃ 
<
ÃÃ 
RpcFlow
ÃÃ !
,
ÃÃ! "
NetworkFailure
ÃÃ# 1
>
ÃÃ1 2
.
ÃÃ2 3
Err
ÃÃ3 6
(
ÃÃ6 7
result
ÃÃ7 =
.
ÃÃ= >
	UnwrapErr
ÃÃ> G
(
ÃÃG H
)
ÃÃH I
)
ÃÃI J
;
ÃÃJ K
}
ÄÄ 	
return
ÆÆ 
Result
ÆÆ 
<
ÆÆ 
RpcFlow
ÆÆ 
,
ÆÆ 
NetworkFailure
ÆÆ -
>
ÆÆ- .
.
ÆÆ. /
Err
ÆÆ/ 2
(
ÆÆ2 3
NetworkFailure
ÇÇ 
.
ÇÇ  
InvalidRequestType
ÇÇ -
(
ÇÇ- .
$str
ÇÇ. D
)
ÇÇD E
)
ÈÈ 	
;
ÈÈ	 

}
ÉÉ 
private
ËË 
async
ËË 
Task
ËË 
<
ËË 
Result
ËË 
<
ËË 
SecureEnvelope
ËË ,
,
ËË, -
NetworkFailure
ËË. <
>
ËË< =
>
ËË= >"
ExecuteGrpcCallAsync
ËË? S
(
ËËS T
RpcServiceType
ÌÌ 
serviceType
ÌÌ "
,
ÌÌ" #"
IConnectivityService
ÍÍ !
connectivityService
ÍÍ 0
,
ÍÍ0 1
RpcRequestContext
ÎÎ 
?
ÎÎ 
requestContext
ÎÎ )
,
ÎÎ) *
CancellationToken
ÏÏ 
token
ÏÏ 
,
ÏÏ  
Func
ÐÐ 
<
ÐÐ 
CallOptions
ÐÐ 
,
ÐÐ 
AsyncUnaryCall
ÐÐ (
<
ÐÐ( )
SecureEnvelope
ÐÐ) 7
>
ÐÐ7 8
>
ÐÐ8 9
grpcCallFactory
ÐÐ: I
)
ÑÑ 
{
ÒÒ 
try
ÓÓ 
{
ÔÔ 	
CallOptions
ÕÕ 
callOptions
ÕÕ #
=
ÕÕ$ %!
_callOptionsFactory
ÕÕ& 9
.
ÕÕ9 :
Create
ÕÕ: @
(
ÕÕ@ A
serviceType
ÕÕA L
,
ÕÕL M
requestContext
ÕÕN \
,
ÕÕ\ ]
token
ÕÕ^ c
)
ÕÕc d
;
ÕÕd e
AsyncUnaryCall
ÖÖ 
<
ÖÖ 
SecureEnvelope
ÖÖ )
>
ÖÖ) *
call
ÖÖ+ /
=
ÖÖ0 1
grpcCallFactory
ÖÖ2 A
(
ÖÖA B
callOptions
ÖÖB M
)
ÖÖM N
;
ÖÖN O
SecureEnvelope
×× 
response
×× #
=
××$ %
await
××& +
call
××, 0
.
××0 1
ResponseAsync
××1 >
.
××> ?
ConfigureAwait
××? M
(
××M N
false
××N S
)
××S T
;
××T U
await
ÙÙ !
connectivityService
ÙÙ %
.
ÙÙ% &
PublishAsync
ÙÙ& 2
(
ÙÙ2 3 
ConnectivityIntent
ÚÚ &
.
ÚÚ& '
	Connected
ÚÚ' 0
(
ÚÚ0 1
)
ÚÚ1 2
)
ÚÚ2 3
.
ÛÛ 
ConfigureAwait
ÛÛ 
(
ÛÛ  
false
ÛÛ  %
)
ÛÛ% &
;
ÛÛ& '
return
ÝÝ 
Result
ÝÝ 
<
ÝÝ 
SecureEnvelope
ÝÝ (
,
ÝÝ( )
NetworkFailure
ÝÝ* 8
>
ÝÝ8 9
.
ÝÝ9 :
Ok
ÝÝ: <
(
ÝÝ< =
response
ÝÝ= E
)
ÝÝE F
;
ÝÝF G
}
ÞÞ 	
catch
ßß 
(
ßß 
RpcException
ßß 
rpcEx
ßß !
)
ßß! "
{
àà 	
NetworkFailure
áá 
failure
áá "
=
áá# $
await
áá% *
_errorProcessor
áá+ :
.
áá: ;
ProcessAsync
áá; G
(
ááG H
rpcEx
ááH M
)
ááM N
.
ááN O
ConfigureAwait
ááO ]
(
áá] ^
false
áá^ c
)
áác d
;
áád e
if
ãã 
(
ãã 
failure
ãã 
.
ãã 
FailureType
ãã #
!=
ãã$ & 
NetworkFailureType
ãã' 9
.
ãã9 :%
PROTOCOL_STATE_MISMATCH
ãã: Q
)
ããQ R
{
ää 
await
åå !
connectivityService
åå )
.
åå) *
PublishAsync
åå* 6
(
åå6 7 
ConnectivityIntent
ææ *
.
ææ* +
Disconnected
ææ+ 7
(
ææ7 8
failure
ææ8 ?
)
ææ? @
)
ææ@ A
.
çç 
ConfigureAwait
çç #
(
çç# $
false
çç$ )
)
çç) *
;
çç* +
}
èè 
return
êê 
Result
êê 
<
êê 
SecureEnvelope
êê (
,
êê( )
NetworkFailure
êê* 8
>
êê8 9
.
êê9 :
Err
êê: =
(
êê= >
failure
êê> E
)
êêE F
;
êêF G
}
ëë 	
catch
ìì 
(
ìì 
	Exception
ìì 
ex
ìì 
)
ìì 
{
íí 	
return
îî 
Result
îî 
<
îî 
SecureEnvelope
îî (
,
îî( )
NetworkFailure
îî* 8
>
îî8 9
.
îî9 :
Err
îî: =
(
îî= >
NetworkFailure
ïï 
.
ïï %
DataCenterNotResponding
ïï 6
(
ïï6 7
ex
ïï7 9
.
ïï9 :
Message
ïï: A
)
ïïA B
)
ïïB C
;
ïïC D
}
ðð 	
}
ññ 
}òò Ù
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/ServiceRequest.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
class 
ServiceRequest 
{ 
private 
ServiceRequest 
( 
uint		 
reqId		 
,		 
ServiceFlowType

 

actionType

 "
,

" #
RpcServiceType 
rpcServiceMethod '
,' (
SecureEnvelope 
payload 
, 
List 
< 
SecureEnvelope 
> 
encryptedChunks ,
,, -
RpcRequestContext 
? 
requestContext )
)) *
{ 
ReqId 
= 
reqId 
; 

ActionType 
= 

actionType 
;  
RpcServiceMethod 
= 
rpcServiceMethod +
;+ ,
Payload 
= 
payload 
; 
EncryptedChunks 
= 
encryptedChunks )
;) *
RequestContext 
= 
requestContext '
;' (
} 
public 

uint 
ReqId 
{ 
get 
; 
} 
public 

ServiceFlowType 

ActionType %
{& '
get( +
;+ ,
}- .
public 

RpcServiceType 
RpcServiceMethod *
{+ ,
get- 0
;0 1
}2 3
public 

SecureEnvelope 
Payload !
{" #
get$ '
;' (
}) *
public   

List   
<   
SecureEnvelope   
>   
EncryptedChunks    /
{  0 1
get  2 5
;  5 6
}  7 8
public"" 

RpcRequestContext"" 
?"" 
RequestContext"" ,
{""- .
get""/ 2
;""2 3
}""4 5
public$$ 

static$$ 
ServiceRequest$$  
New$$! $
($$$ %
uint$$% )
reqId$$* /
,$$/ 0
ServiceFlowType$$1 @

actionType$$A K
,$$K L
RpcServiceType$$M [
rpcServiceMethod$$\ l
,$$l m
SecureEnvelope%% 
payload%% 
,%% 
List%%  $
<%%$ %
SecureEnvelope%%% 3
>%%3 4
encryptedChunks%%5 D
,%%D E
RpcRequestContext%%F W
?%%W X
requestContext%%Y g
=%%h i
null%%j n
)%%n o
{&& 
return'' 
new'' 
ServiceRequest'' !
(''! "
reqId''" '
,''' (

actionType'') 3
,''3 4
rpcServiceMethod''5 E
,''E F
payload''G N
,''N O
encryptedChunks''P _
,''_ `
requestContext''a o
)''o p
;''p q
}(( 
})) ´
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/ServiceFlowType.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
enum 
ServiceFlowType 
{ 
Single 

,
 
ReceiveStream 
, 

SendStream 
, 
BidirectionalStream 
}		 Ÿš
ˆ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/SecrecyChannelRpcServices.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
sealed 
class %
SecrecyChannelRpcServices -
:. /&
ISecrecyChannelRpcServices0 J
{ 
private 
readonly 
DeviceService "
." #
DeviceServiceClient# 6 
_deviceServiceClient7 K
;K L
private 
readonly 
IGrpcErrorProcessor (
_errorProcessor) 8
;8 9
private 
readonly #
IGrpcCallOptionsFactory ,
_callOptionsFactory- @
;@ A
public 
%
SecrecyChannelRpcServices $
($ %
DeviceService 
. 
DeviceServiceClient )
deviceServiceClient* =
,= >
IGrpcErrorProcessor 
errorProcessor *
,* +#
IGrpcCallOptionsFactory 
callOptionsFactory  2
)2 3
{  
_deviceServiceClient 
= 
deviceServiceClient 2
;2 3
_errorProcessor 
= 
errorProcessor (
;( )
_callOptionsFactory 
= 
callOptionsFactory 0
;0 1
} 
public!! 

async!! 
Task!! 
<!! 
Result!! 
<!! 
SecureEnvelope!! +
,!!+ ,
NetworkFailure!!- ;
>!!; <
>!!< =1
%EstablishAppDeviceSecrecyChannelAsync!!> c
(!!c d 
IConnectivityService"" 
connectivityService"" 0
,""0 1
SecureEnvelope## 
request## 
,## 
PubKeyExchangeType$$ 
?$$ 
exchangeType$$ (
=$$) *
null$$+ /
,$$/ 0
CancellationToken%% 
cancellationToken%% +
=%%, -
default%%. 5
)%%5 6
{&& !
ArgumentNullException'' 
.'' 
ThrowIfNull'' )
('') *
request''* 1
)''1 2
;''2 3
Metadata)) 
headers)) 
=)) 
[)) 
])) 
;)) 
if** 

(** 
exchangeType** 
.** 
HasValue** !
)**! "
{++ 	
headers,, 
.,, 
Add,, 
(,, 
$str,, '
,,,' (
exchangeType,,) 5
.,,5 6
Value,,6 ;
.,,; <
ToString,,< D
(,,D E
),,E F
),,F G
;,,G H
}-- 	
return// 
await// &
ExecuteSecureEnvelopeAsync// /
(/// 0
RpcServiceType00 
.00 #
EstablishSecrecyChannel00 6
,006 7
connectivityService11 #
,11# $
request22 
,22 
headers33 
,33 
cancellationToken44 !
)44! "
.55 
ConfigureAwait55 
(55 
false55 !
)55! "
;55" #
}66 
public88 

async88 
Task88 
<88 
Result88 
<88 "
RestoreChannelResponse88 3
,883 4
NetworkFailure885 C
>88C D
>88D E/
#RestoreAppDeviceSecrecyChannelAsync88F i
(88i j 
IConnectivityService99 
connectivityService99 0
,990 1!
RestoreChannelRequest:: 
request:: %
,::% &
CancellationToken;; 
cancellationToken;; +
=;;, -
default;;. 5
);;5 6
{<< !
ArgumentNullException== 
.== 
ThrowIfNull== )
(==) *
request==* 1
)==1 2
;==2 3
return?? 
await?? 
ExecuteAsync?? !
(??! "
RpcServiceType@@ 
.@@ !
RestoreSecrecyChannel@@ 4
,@@4 5
connectivityServiceAA #
,AA# $
optionsBB 
=>BB  
_deviceServiceClientBB /
.BB/ 0%
RestoreSecureChannelAsyncBB0 I
(BBI J
requestBBJ Q
,BBQ R
optionsBBS Z
)BBZ [
,BB[ \
cancellationTokenCC !
)CC! "
.DD 
ConfigureAwaitDD 
(DD 
falseDD !
)DD! "
;DD" #
}EE 
publicGG 

asyncGG 
TaskGG 
<GG 
ResultGG 
<GG 
SecureEnvelopeGG +
,GG+ ,
NetworkFailureGG- ;
>GG; <
>GG< =4
(AuthenticatedEstablishSecureChannelAsyncGG> f
(GGf g 
IConnectivityServiceHH 
connectivityServiceHH 0
,HH0 1)
AuthenticatedEstablishRequestII %
requestII& -
,II- .
CancellationTokenJJ 
cancellationTokenJJ +
=JJ, -
defaultJJ. 5
)JJ5 6
{KK !
ArgumentNullExceptionLL 
.LL 
ThrowIfNullLL )
(LL) *
requestLL* 1
)LL1 2
;LL2 3
tryNN 
{OO 	
CallOptionsPP 
callOptionsPP #
=PP$ %
_callOptionsFactoryPP& 9
.PP9 :
CreatePP: @
(PP@ A
RpcServiceTypeQQ 
.QQ /
#EstablishAuthenticatedSecureChannelQQ B
,QQB C
requestContextRR 
:RR 
nullRR  $
,RR$ %
cancellationTokenSS !
)SS! "
;SS" #
AsyncUnaryCallTT 
<TT 
SecureEnvelopeTT )
>TT) *
callTT+ /
=TT0 1 
_deviceServiceClientTT2 F
.TTF G4
(AuthenticatedEstablishSecureChannelAsyncTTG o
(TTo p
requestUU 
,UU 
callOptionsVV 
)VV 
;VV 
SecureEnvelopeXX 
responseXX #
=XX$ %
awaitXX& +
callXX, 0
.XX0 1
ResponseAsyncXX1 >
.XX> ?
ConfigureAwaitXX? M
(XXM N
falseXXN S
)XXS T
;XXT U
awaitZZ 
connectivityServiceZZ %
.ZZ% &
PublishAsyncZZ& 2
(ZZ2 3
ConnectivityIntentZZ3 E
.ZZE F
	ConnectedZZF O
(ZZO P
)ZZP Q
)ZZQ R
.ZZR S
ConfigureAwaitZZS a
(ZZa b
falseZZb g
)ZZg h
;ZZh i
return[[ 
Result[[ 
<[[ 
SecureEnvelope[[ (
,[[( )
NetworkFailure[[* 8
>[[8 9
.[[9 :
Ok[[: <
([[< =
response[[= E
)[[E F
;[[F G
}\\ 	
catch]] 
(]] 
RpcException]] 
rpcEx]] !
)]]! "
{^^ 	
if__ 
(__ 
GrpcErrorClassifier__ #
.__# $
IsCancelled__$ /
(__/ 0
rpcEx__0 5
)__5 6
)__6 7
{`` 
throwaa 
;aa 
}bb 
NetworkFailuredd 
failuredd "
=dd# $
awaitdd% *
_errorProcessordd+ :
.dd: ;
ProcessAsyncdd; G
(ddG H
rpcExddH M
)ddM N
.ddN O
ConfigureAwaitddO ]
(dd] ^
falsedd^ c
)ddc d
;ddd e
ifff 
(ff 
GrpcErrorClassifierff #
.ff# $*
IsIdentityKeyDerivationFailureff$ B
(ffB C
rpcExffC H
)ffH I
)ffI J
{gg 
UserFacingErrorhh 
	userErrorhh  )
=hh* +
failurehh, 3
.hh3 4
	UserErrorhh4 =
??hh> @
newii, /
UserFacingErrorii0 ?
(ii? @
	ErrorCodejj0 9
.jj9 :
UNAUTHENTICATEDjj: I
,jjI J
ErrorI18NKeyskk0 =
.kk= >
UNAUTHENTICATEDkk> M
,kkM N
failurell0 7
.ll7 8
Messagell8 ?
)ll? @
;ll@ A
failurenn 
=nn 
newnn 
NetworkFailurenn ,
(nn, -
NetworkFailureTypeoo &
.oo& '+
CRITICAL_AUTHENTICATION_FAILUREoo' F
,ooF G
	userErrorpp 
.pp 
Messagepp %
,pp% &
rpcExqq 
)qq 
{rr 
	UserErrorss 
=ss 
	userErrorss  )
}tt 
;tt 
}uu 
awaitww 
connectivityServiceww %
.ww% &
PublishAsyncww& 2
(ww2 3
ConnectivityIntentxx &
.xx& '
Disconnectedxx' 3
(xx3 4
failurexx4 ;
)xx; <
)xx< =
.yy 
ConfigureAwaityy 
(yy  
falseyy  %
)yy% &
;yy& '
returnzz 
Resultzz 
<zz 
SecureEnvelopezz (
,zz( )
NetworkFailurezz* 8
>zz8 9
.zz9 :
Errzz: =
(zz= >
failurezz> E
)zzE F
;zzF G
}{{ 	
catch|| 
(|| &
OperationCanceledException|| )
)||) *
when||+ /
(||0 1
cancellationToken||1 B
.||B C#
IsCancellationRequested||C Z
)||Z [
{}} 	
throw~~ 
;~~ 
} 	
catch
€€ 
(
€€ 
	Exception
€€ 
ex
€€ 
)
€€ 
{
 	
return
‚‚ 
Result
‚‚ 
<
‚‚ 
SecureEnvelope
‚‚ (
,
‚‚( )
NetworkFailure
‚‚* 8
>
‚‚8 9
.
‚‚9 :
Err
‚‚: =
(
‚‚= >
NetworkFailure
ƒƒ 
.
ƒƒ %
DataCenterNotResponding
ƒƒ 6
(
ƒƒ6 7
ex
ƒƒ7 9
.
ƒƒ9 :
Message
ƒƒ: A
,
ƒƒA B
ex
ƒƒC E
)
ƒƒE F
)
ƒƒF G
;
ƒƒG H
}
„„ 	
}
…… 
private
‡‡ 
async
‡‡ 
Task
‡‡ 
<
‡‡ 
Result
‡‡ 
<
‡‡ 
SecureEnvelope
‡‡ ,
,
‡‡, -
NetworkFailure
‡‡. <
>
‡‡< =
>
‡‡= >(
ExecuteSecureEnvelopeAsync
‡‡? Y
(
‡‡Y Z
RpcServiceType
ˆˆ 
serviceType
ˆˆ "
,
ˆˆ" #"
IConnectivityService
‰‰ !
connectivityService
‰‰ 0
,
‰‰0 1
SecureEnvelope
ŠŠ 
request
ŠŠ 
,
ŠŠ 
Metadata
‹‹ 
headers
‹‹ 
,
‹‹ 
CancellationToken
ŒŒ 
cancellationToken
ŒŒ +
)
ŒŒ+ ,
{
 
try
ŽŽ 
{
 	
CallOptions
 
callOptions
 #
=
$ %!
_callOptionsFactory
& 9
.
9 :
Create
: @
(
@ A
serviceType
A L
,
L M
null
N R
,
R S
cancellationToken
T e
,
e f
headers
g n
)
n o
;
o p
AsyncUnaryCall
‘‘ 
<
‘‘ 
SecureEnvelope
‘‘ )
>
‘‘) *
call
‘‘+ /
=
‘‘0 1"
_deviceServiceClient
‘‘2 F
.
‘‘F G)
EstablishSecureChannelAsync
‘‘G b
(
‘‘b c
request
’’ 
,
’’ 
callOptions
““ 
)
““ 
;
““ 
SecureEnvelope
•• 
response
•• #
=
••$ %
await
••& +
call
••, 0
.
••0 1
ResponseAsync
••1 >
.
••> ?
ConfigureAwait
••? M
(
••M N
false
••N S
)
••S T
;
••T U
await
—— !
connectivityService
—— %
.
——% &
PublishAsync
——& 2
(
——2 3 
ConnectivityIntent
˜˜ &
.
˜˜& '
	Connected
˜˜' 0
(
˜˜0 1
null
˜˜1 5
,
˜˜5 6 
ConnectivityReason
˜˜7 I
.
˜˜I J 
HandshakeSucceeded
˜˜J \
)
˜˜\ ]
)
˜˜] ^
.
™™ 
ConfigureAwait
™™ 
(
™™  
false
™™  %
)
™™% &
;
™™& '
return
›› 
Result
›› 
<
›› 
SecureEnvelope
›› (
,
››( )
NetworkFailure
››* 8
>
››8 9
.
››9 :
Ok
››: <
(
››< =
response
››= E
)
››E F
;
››F G
}
œœ 	
catch
 
(
 
RpcException
 
rpcEx
 !
)
! "
{
žž 	
if
ŸŸ 
(
ŸŸ !
GrpcErrorClassifier
ŸŸ #
.
ŸŸ# $
IsCancelled
ŸŸ$ /
(
ŸŸ/ 0
rpcEx
ŸŸ0 5
)
ŸŸ5 6
)
ŸŸ6 7
{
   
throw
¡¡ 
;
¡¡ 
}
¢¢ 
NetworkFailure
¤¤ 
failure
¤¤ "
=
¤¤# $
await
¤¤% *
_errorProcessor
¤¤+ :
.
¤¤: ;
ProcessAsync
¤¤; G
(
¤¤G H
rpcEx
¤¤H M
)
¤¤M N
.
¤¤N O
ConfigureAwait
¤¤O ]
(
¤¤] ^
false
¤¤^ c
)
¤¤c d
;
¤¤d e
await
¥¥ !
connectivityService
¥¥ %
.
¥¥% &
PublishAsync
¥¥& 2
(
¥¥2 3 
ConnectivityIntent
¦¦ &
.
¦¦& '
Disconnected
¦¦' 3
(
¦¦3 4
failure
¦¦4 ;
)
¦¦; <
)
¦¦< =
.
§§ 
ConfigureAwait
§§ 
(
§§  
false
§§  %
)
§§% &
;
§§& '
return
¨¨ 
Result
¨¨ 
<
¨¨ 
SecureEnvelope
¨¨ (
,
¨¨( )
NetworkFailure
¨¨* 8
>
¨¨8 9
.
¨¨9 :
Err
¨¨: =
(
¨¨= >
failure
¨¨> E
)
¨¨E F
;
¨¨F G
}
©© 	
catch
ªª 
(
ªª (
OperationCanceledException
ªª )
)
ªª) *
when
ªª+ /
(
ªª0 1
cancellationToken
ªª1 B
.
ªªB C%
IsCancellationRequested
ªªC Z
)
ªªZ [
{
«« 	
throw
¬¬ 
;
¬¬ 
}
­­ 	
catch
®® 
(
®® 
	Exception
®® 
ex
®® 
)
®® 
{
¯¯ 	
return
°° 
Result
°° 
<
°° 
SecureEnvelope
°° (
,
°°( )
NetworkFailure
°°* 8
>
°°8 9
.
°°9 :
Err
°°: =
(
°°= >
NetworkFailure
±± 
.
±± %
DataCenterNotResponding
±± 6
(
±±6 7
ex
±±7 9
.
±±9 :
Message
±±: A
,
±±A B
ex
±±C E
)
±±E F
)
±±F G
;
±±G H
}
²² 	
}
³³ 
private
µµ 
async
µµ 
Task
µµ 
<
µµ 
Result
µµ 
<
µµ 
	TResponse
µµ '
,
µµ' (
NetworkFailure
µµ) 7
>
µµ7 8
>
µµ8 9
ExecuteAsync
µµ: F
<
µµF G
	TResponse
µµG P
>
µµP Q
(
µµQ R
RpcServiceType
¶¶ 
serviceType
¶¶ "
,
¶¶" #"
IConnectivityService
·· !
connectivityService
·· 0
,
··0 1
Func
¸¸ 
<
¸¸ 
CallOptions
¸¸ 
,
¸¸ 
AsyncUnaryCall
¸¸ (
<
¸¸( )
	TResponse
¸¸) 2
>
¸¸2 3
>
¸¸3 4
grpcCallFactory
¸¸5 D
,
¸¸D E
CancellationToken
¹¹ 
cancellationToken
¹¹ +
)
¹¹+ ,
{
ºº 
try
»» 
{
¼¼ 	
CallOptions
½½ 
callOptions
½½ #
=
½½$ %!
_callOptionsFactory
½½& 9
.
½½9 :
Create
½½: @
(
½½@ A
serviceType
½½A L
,
½½L M
null
½½N R
,
½½R S
cancellationToken
½½T e
)
½½e f
;
½½f g
AsyncUnaryCall
¾¾ 
<
¾¾ 
	TResponse
¾¾ $
>
¾¾$ %
call
¾¾& *
=
¾¾+ ,
grpcCallFactory
¾¾- <
(
¾¾< =
callOptions
¾¾= H
)
¾¾H I
;
¾¾I J
	TResponse
¿¿ 
response
¿¿ 
=
¿¿  
await
¿¿! &
call
¿¿' +
.
¿¿+ ,
ResponseAsync
¿¿, 9
.
¿¿9 :
ConfigureAwait
¿¿: H
(
¿¿H I
false
¿¿I N
)
¿¿N O
;
¿¿O P
await
ÁÁ !
connectivityService
ÁÁ %
.
ÁÁ% &
PublishAsync
ÁÁ& 2
(
ÁÁ2 3 
ConnectivityIntent
ÂÂ &
.
ÂÂ& '
	Connected
ÂÂ' 0
(
ÂÂ0 1
null
ÂÂ1 5
,
ÂÂ5 6 
ConnectivityReason
ÂÂ7 I
.
ÂÂI J 
HandshakeSucceeded
ÂÂJ \
)
ÂÂ\ ]
)
ÂÂ] ^
.
ÃÃ 
ConfigureAwait
ÃÃ 
(
ÃÃ  
false
ÃÃ  %
)
ÃÃ% &
;
ÃÃ& '
return
ÅÅ 
Result
ÅÅ 
<
ÅÅ 
	TResponse
ÅÅ #
,
ÅÅ# $
NetworkFailure
ÅÅ% 3
>
ÅÅ3 4
.
ÅÅ4 5
Ok
ÅÅ5 7
(
ÅÅ7 8
response
ÅÅ8 @
)
ÅÅ@ A
;
ÅÅA B
}
ÆÆ 	
catch
ÇÇ 
(
ÇÇ 
RpcException
ÇÇ 
rpcEx
ÇÇ !
)
ÇÇ! "
{
ÈÈ 	
if
ÉÉ 
(
ÉÉ !
GrpcErrorClassifier
ÉÉ #
.
ÉÉ# $
IsCancelled
ÉÉ$ /
(
ÉÉ/ 0
rpcEx
ÉÉ0 5
)
ÉÉ5 6
)
ÉÉ6 7
{
ÊÊ 
throw
ËË 
;
ËË 
}
ÌÌ 
NetworkFailure
ÎÎ 
failure
ÎÎ "
=
ÎÎ# $
await
ÎÎ% *
_errorProcessor
ÎÎ+ :
.
ÎÎ: ;
ProcessAsync
ÎÎ; G
(
ÎÎG H
rpcEx
ÎÎH M
)
ÎÎM N
.
ÎÎN O
ConfigureAwait
ÎÎO ]
(
ÎÎ] ^
false
ÎÎ^ c
)
ÎÎc d
;
ÎÎd e
await
ÏÏ !
connectivityService
ÏÏ %
.
ÏÏ% &
PublishAsync
ÏÏ& 2
(
ÏÏ2 3 
ConnectivityIntent
ÐÐ &
.
ÐÐ& '
Disconnected
ÐÐ' 3
(
ÐÐ3 4
failure
ÐÐ4 ;
)
ÐÐ; <
)
ÐÐ< =
.
ÑÑ 
ConfigureAwait
ÑÑ 
(
ÑÑ  
false
ÑÑ  %
)
ÑÑ% &
;
ÑÑ& '
return
ÒÒ 
Result
ÒÒ 
<
ÒÒ 
	TResponse
ÒÒ #
,
ÒÒ# $
NetworkFailure
ÒÒ% 3
>
ÒÒ3 4
.
ÒÒ4 5
Err
ÒÒ5 8
(
ÒÒ8 9
failure
ÒÒ9 @
)
ÒÒ@ A
;
ÒÒA B
}
ÓÓ 	
catch
ÔÔ 
(
ÔÔ (
OperationCanceledException
ÔÔ )
)
ÔÔ) *
when
ÔÔ+ /
(
ÔÔ0 1
cancellationToken
ÔÔ1 B
.
ÔÔB C%
IsCancellationRequested
ÔÔC Z
)
ÔÔZ [
{
ÕÕ 	
throw
ÖÖ 
;
ÖÖ 
}
×× 	
catch
ØØ 
(
ØØ 
	Exception
ØØ 
ex
ØØ 
)
ØØ 
{
ÙÙ 	
return
ÚÚ 
Result
ÚÚ 
<
ÚÚ 
	TResponse
ÚÚ #
,
ÚÚ# $
NetworkFailure
ÚÚ% 3
>
ÚÚ3 4
.
ÚÚ4 5
Err
ÚÚ5 8
(
ÚÚ8 9
NetworkFailure
ÛÛ 
.
ÛÛ %
DataCenterNotResponding
ÛÛ 6
(
ÛÛ6 7
ex
ÛÛ7 9
.
ÛÛ9 :
Message
ÛÛ: A
,
ÛÛA B
ex
ÛÛC E
)
ÛÛE F
)
ÛÛF G
;
ÛÛG H
}
ÜÜ 	
}
ÝÝ 
}ÞÞ Ê	
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/RpcServiceType.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
enum 
RpcServiceType 
: 
short "
{ #
EstablishSecrecyChannel 
, !
RestoreSecrecyChannel 
, /
#EstablishAuthenticatedSecureChannel '
,' (
RegisterAppDevice		 
,		  
ValidateMobileNumber 
, )
CheckMobileNumberAvailability !
,! " 
InitiateVerification 
, 
	VerifyOtp 
, 
RegistrationInit 
,  
RegistrationComplete 
, !
RecoverySecretKeyInit 
, %
RecoverySecretKeyComplete 
, 
SignInInitRequest 
, !
SignInCompleteRequest 
, 
Logout 

,
 
AnonymousLogout 
, 
} ¿;
€/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/RpcServiceManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
internal 
class	 
RpcServiceManager  
:! "
IRpcServiceManager# 5
{ 
private 
readonly &
ISecrecyChannelRpcServices /&
_secrecyChannelRpcServices0 J
;J K
private 
readonly 

Dictionary 
< 
ServiceFlowType "
," #
Func 
< 
ServiceRequest 
,  
CancellationToken! 2
,2 3
Task4 8
<8 9
Result9 ?
<? @
RpcFlow@ G
,G H
NetworkFailureI W
>W X
>X Y
>Y Z
>Z [
_serviceInvokers\ l
;l m
public 

RpcServiceManager 
( 
IUnaryRpcServices 
unaryRpcServices *
,* +%
IReceiveStreamRpcServices !$
receiveStreamRpcServices" :
,: ;&
ISecrecyChannelRpcServices "%
secrecyChannelRpcServices# <
,< = 
IConnectivityService 
connectivityService 0
)0 1
{ &
_secrecyChannelRpcServices "
=# $%
secrecyChannelRpcServices% >
;> ?
_serviceInvokers 
= 
new   

Dictionary   
<   
ServiceFlowType   *
,  * +
Func!! 
<!! 
ServiceRequest!! #
,!!# $
CancellationToken!!% 6
,!!6 7
Task!!8 <
<!!< =
Result!!= C
<!!C D
RpcFlow!!D K
,!!K L
NetworkFailure!!M [
>!![ \
>!!\ ]
>!!] ^
>!!^ _
{"" 
{## 
ServiceFlowType$$ #
.$$# $
Single$$$ *
,$$* +
(%% 
req%% 
,%% 
token%% 
)%%  
=>%%! #
unaryRpcServices%%$ 4
.%%4 5
InvokeRequestAsync%%5 G
(%%G H
req%%H K
,%%K L
connectivityService%%M `
,%%` a
token%%b g
)%%g h
}&& 
,&& 
{'' 
ServiceFlowType(( #
.((# $
ReceiveStream(($ 1
,((1 2$
receiveStreamRpcServices((3 K
.((K L
ProcessRequest((L Z
})) 
}** 
;** 
}++ 
public-- 

async-- 
Task-- 
<-- 
Result-- 
<-- 
SecureEnvelope-- +
,--+ ,
NetworkFailure--- ;
>--; <
>--< =(
EstablishSecrecyChannelAsync--> Z
(--Z [ 
IConnectivityService.. 
connectivityService.. 0
,..0 1
SecureEnvelope// 
envelope// 
,//  
PubKeyExchangeType00 
?00 
exchangeType00 (
=00) *
null00+ /
,00/ 0
CancellationToken11 
cancellationToken11 +
=11, -
default11. 5
)115 6
{22 
return33 
await33 &
_secrecyChannelRpcServices33 /
.33/ 01
%EstablishAppDeviceSecrecyChannelAsync330 U
(33U V
connectivityService33V i
,33i j
envelope44 
,44 
exchangeType55 
,55 
cancellationToken66 
)66 
.66 
ConfigureAwait66 -
(66- .
false66. 3
)663 4
;664 5
}77 
public99 

async99 
Task99 
<99 
Result99 
<99 "
RestoreChannelResponse99 3
,993 4
NetworkFailure995 C
>99C D
>99D E&
RestoreSecrecyChannelAsync99F `
(99` a 
IConnectivityService:: 
connectivityService:: 0
,::0 1!
RestoreChannelRequest;; 
request;; %
,;;% &
CancellationToken<< 
cancellationToken<< +
=<<, -
default<<. 5
)<<5 6
{== 
return>> 
await>> &
_secrecyChannelRpcServices>> /
.>>/ 0/
#RestoreAppDeviceSecrecyChannelAsync>>0 S
(>>S T
connectivityService>>T g
,>>g h
request?? 
,?? 
cancellationToken@@ 
)@@ 
.@@ 
ConfigureAwait@@ -
(@@- .
false@@. 3
)@@3 4
;@@4 5
}AA 
publicCC 

asyncCC 
TaskCC 
<CC 
ResultCC 
<CC 
SecureEnvelopeCC +
,CC+ ,
NetworkFailureCC- ;
>CC; <
>CC< =4
(EstablishAuthenticatedSecureChannelAsyncCC> f
(CCf g 
IConnectivityServiceDD 
connectivityServiceDD 0
,DD0 1)
AuthenticatedEstablishRequestEE %
requestEE& -
,EE- .
CancellationTokenFF 
cancellationTokenFF +
=FF, -
defaultFF. 5
)FF5 6
{GG 
returnHH 
awaitHH &
_secrecyChannelRpcServicesHH /
.HH/ 04
(AuthenticatedEstablishSecureChannelAsyncHH0 X
(HHX Y
connectivityServiceHHY l
,HHl m
requestII 
,II 
cancellationTokenJJ 
)JJ 
.JJ 
ConfigureAwaitJJ -
(JJ- .
falseJJ. 3
)JJ3 4
;JJ4 5
}KK 
publicMM 

asyncMM 
TaskMM 
<MM 
ResultMM 
<MM 
RpcFlowMM $
,MM$ %
NetworkFailureMM& 4
>MM4 5
>MM5 6%
InvokeServiceRequestAsyncMM7 P
(MMP Q
ServiceRequestMMQ _
requestMM` g
,MMg h
CancellationTokenNN 
tokenNN 
)NN  
{OO 
ifPP 

(PP 
_serviceInvokersPP 
.PP 
TryGetValuePP (
(PP( )
requestPP) 0
.PP0 1

ActionTypePP1 ;
,PP; <
outQQ 
FuncQQ 
<QQ 
ServiceRequestQQ '
,QQ' (
CancellationTokenQQ) :
,QQ: ;
TaskQQ< @
<QQ@ A
ResultQQA G
<QQG H
RpcFlowQQH O
,QQO P
NetworkFailureQQQ _
>QQ_ `
>QQ` a
>QQa b
?QQb c
invokerQQd k
)QQk l
)QQl m
{RR 	
ResultSS 
<SS 
RpcFlowSS 
,SS 
NetworkFailureSS *
>SS* +
resultSS, 2
=SS3 4
awaitSS5 :
invokerSS; B
(SSB C
requestSSC J
,SSJ K
tokenSSL Q
)SSQ R
.SSR S
ConfigureAwaitSSS a
(SSa b
falseSSb g
)SSg h
;SSh i
returnUU 
resultUU 
;UU 
}VV 	
returnXX 
ResultXX 
<XX 
RpcFlowXX 
,XX 
NetworkFailureXX -
>XX- .
.XX. /
ErrXX/ 2
(XX2 3
NetworkFailureXX3 A
.XXA B
InvalidRequestTypeXXB T
(XXT U
$strXXU j
)XXj k
)XXk l
;XXl m
}YY 
}ZZ »
€/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/RpcRequestContext.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
sealed 
class 
RpcRequestContext %
(% &
string& ,
correlationId- :
,: ;
string< B
idempotencyKeyC Q
,Q R
intS V
attemptW ^
=_ `
$numa b
)b c
{ 
public 

string 
CorrelationId 
{  !
get" %
;% &
}' (
=) *
correlationId+ 8
;8 9
public		 

string		 
IdempotencyKey		  
{		! "
get		# &
;		& '
}		( )
=		* +
idempotencyKey		, :
;		: ;
public 

int 
Attempt 
{ 
get 
; 
} 
=  !
attempt" )
;) *
public 

bool 
ReinitAttempted 
{  !
get" %
;% &
private' .
set/ 2
;2 3
}4 5
public 

static 
RpcRequestContext #
	CreateNew$ -
(- .
int. 1
attempt2 9
=: ;
$num< =
)= >
{ 
return 
new 
RpcRequestContext $
($ %
Guid 
. 
NewGuid 
( 
) 
. 
ToString #
(# $
$str$ '
)' (
,( )
Guid 
. 
NewGuid 
( 
) 
. 
ToString #
(# $
$str$ '
)' (
,( )
attempt 
) 
; 
} 
public 

static 
RpcRequestContext #"
CreateNewWithStableKey$ :
(: ;
string; A 
stableIdempotencyKeyB V
,V W
intX [
attempt\ c
=d e
$numf g
)g h
{ 
return 
new 
RpcRequestContext $
($ %
Guid 
. 
NewGuid 
( 
) 
. 
ToString #
(# $
$str$ '
)' (
,( ) 
stableIdempotencyKey  
,  !
attempt 
) 
; 
} 
public 

void 
MarkReinitAttempted #
(# $
)$ %
{   
ReinitAttempted!! 
=!! 
true!! 
;!! 
}"" 
}## ™F
v/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/RpcFlow.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
abstract 
class 
RpcFlow 
{ 
public 

static 
RpcFlow !
NewEmptyInboundStream /
(/ 0
)0 1
{ 
async 
IAsyncEnumerable 
< 
Result %
<% &
SecureEnvelope& 4
,4 5
NetworkFailure6 D
>D E
>E F
EmptyStreamG R
(R S
)S T
{ 	
yield 
break 
; 
} 	
return 
new 
InboundStream  
(  !
EmptyStream! ,
(, -
)- .
). /
;/ 0
} 
public 

static 
RpcFlow  
NewDrainOutboundSink .
(. /
)/ 0
=>1 3
new 
OutboundSink 
( 
new 
	DrainSink &
(& '
)' (
)( )
;) *
public 

static 
RpcFlow "
NewBidirectionalStream 0
(0 1
)1 2
{ 
Channel   
<   
SecureEnvelope   
>   
channel    '
=  ( )
Channel  * 1
.  1 2
CreateUnbounded  2 A
<  A B
SecureEnvelope  B P
>  P Q
(  Q R
)  R S
;  S T
IAsyncEnumerable!! 
<!! 
Result!! 
<!!  
SecureEnvelope!!  .
,!!. /
NetworkFailure!!0 >
>!!> ?
>!!? @
inbound!!A H
=!!I J

ToOkStream!!K U
(!!U V
channel!!V ]
.!!] ^
Reader!!^ d
)!!d e
;!!e f
ChannelSink"" 
outboundSink""  
=""! "
new""# &
(""& '
channel""' .
."". /
Writer""/ 5
)""5 6
;""6 7
return## 
new## 
BidirectionalStream## &
(##& '
inbound##' .
,##. /
outboundSink##0 <
)##< =
;##= >
}$$ 
private&& 
static&& 
IAsyncEnumerable&& #
<&&# $
Result&&$ *
<&&* +
SecureEnvelope&&+ 9
,&&9 :
NetworkFailure&&; I
>&&I J
>&&J K

ToOkStream&&L V
(&&V W
ChannelReader'' 
<'' 
SecureEnvelope'' $
>''$ %
reader''& ,
)'', -
=>''. 0
reader(( 
.(( 
ReadAllAsync(( 
((( 
)(( 
.(( 
Select(( $
((($ %
payload((% ,
=>((- /
Result((0 6
<((6 7
SecureEnvelope((7 E
,((E F
NetworkFailure((G U
>((U V
.((V W
Ok((W Y
(((Y Z
payload((Z a
)((a b
)((b c
;((c d
public** 

sealed** 
class** 

SingleCall** "
(**" #
Task**# '
<**' (
Result**( .
<**. /
SecureEnvelope**/ =
,**= >
NetworkFailure**? M
>**M N
>**N O
result**P V
)**V W
:**X Y
RpcFlow**Z a
{++ 
public,, 

SingleCall,, 
(,, 
Result,,  
<,,  !
SecureEnvelope,,! /
,,,/ 0
NetworkFailure,,1 ?
>,,? @
result,,A G
),,G H
:-- 
this-- 
(-- 
Task-- 
.-- 

FromResult-- "
(--" #
result--# )
)--) *
)--* +
{.. 	
}// 	
public11 
Task11 
<11 
Result11 
<11 
SecureEnvelope11 )
,11) *
NetworkFailure11+ 9
>119 :
>11: ;
Result11< B
{11C D
get11E H
;11H I
}11J K
=11L M
result11N T
;11T U
}22 
public44 

sealed44 
class44 
InboundStream44 %
(44% &
IAsyncEnumerable44& 6
<446 7
Result447 =
<44= >
SecureEnvelope44> L
,44L M
NetworkFailure44N \
>44\ ]
>44] ^
stream44_ e
)44e f
:55 	
RpcFlow55
 
{66 
public77 
IAsyncEnumerable77 
<77  
Result77  &
<77& '
SecureEnvelope77' 5
,775 6
NetworkFailure777 E
>77E F
>77F G
Stream77H N
{77O P
get77Q T
;77T U
}77V W
=77X Y
stream77Z `
;77` a
}88 
public:: 

sealed:: 
class:: 
OutboundSink:: $
(::$ %
IOutboundSink::% 2
sink::3 7
)::7 8
:::9 :
RpcFlow::; B
{;; 
public<< 
IOutboundSink<< 
Sink<< !
{<<" #
get<<$ '
;<<' (
}<<) *
=<<+ ,
sink<<- 1
;<<1 2
}== 
public?? 

sealed?? 
class?? 
BidirectionalStream?? +
(??+ ,
IAsyncEnumerable@@ 
<@@ 
Result@@ 
<@@  
SecureEnvelope@@  .
,@@. /
NetworkFailure@@0 >
>@@> ?
>@@? @
inbound@@A H
,@@H I
IOutboundSinkAA 
outboundSinkAA "
)AA" #
:BB 	
RpcFlowBB
 
{CC 
publicDD 
IAsyncEnumerableDD 
<DD  
ResultDD  &
<DD& '
SecureEnvelopeDD' 5
,DD5 6
NetworkFailureDD7 E
>DDE F
>DDF G
InboundDDH O
{DDP Q
getDDR U
;DDU V
}DDW X
=DDY Z
inboundDD[ b
;DDb c
publicEE 
IOutboundSinkEE 
OutboundEE %
{EE& '
getEE( +
;EE+ ,
}EE- .
=EE/ 0
outboundSinkEE1 =
;EE= >
}FF 
}GG 
internalII 
sealedII	 
classII 
	DrainSinkII 
:II  !
IOutboundSinkII" /
{JJ 
publicKK 

TaskKK 
<KK 
ResultKK 
<KK 
UnitKK 
,KK 
NetworkFailureKK +
>KK+ ,
>KK, -
	SendAsyncKK. 7
(KK7 8
SecureEnvelopeKK8 F
envelopeKKG O
)KKO P
=>KKQ S
TaskLL 
.LL 

FromResultLL 
(LL 
ResultLL 
<LL 
UnitLL #
,LL# $
NetworkFailureLL% 3
>LL3 4
.LL4 5
OkLL5 7
(LL7 8
UnitLL8 <
.LL< =
ValueLL= B
)LLB C
)LLC D
;LLD E
}MM 
internalOO 
sealedOO	 
classOO 
ChannelSinkOO !
(OO! "
ChannelWriterOO" /
<OO/ 0
SecureEnvelopeOO0 >
>OO> ?
writerOO@ F
)OOF G
:OOH I
IOutboundSinkOOJ W
{PP 
publicQQ 

asyncQQ 
TaskQQ 
<QQ 
ResultQQ 
<QQ 
UnitQQ !
,QQ! "
NetworkFailureQQ# 1
>QQ1 2
>QQ2 3
	SendAsyncQQ4 =
(QQ= >
SecureEnvelopeQQ> L
envelopeQQM U
)QQU V
{RR 
trySS 
{TT 	
awaitUU 
writerUU 
.UU 

WriteAsyncUU #
(UU# $
envelopeUU$ ,
)UU, -
.UU- .
ConfigureAwaitUU. <
(UU< =
falseUU= B
)UUB C
;UUC D
returnVV 
ResultVV 
<VV 
UnitVV 
,VV 
NetworkFailureVV  .
>VV. /
.VV/ 0
OkVV0 2
(VV2 3
UnitVV3 7
.VV7 8
ValueVV8 =
)VV= >
;VV> ?
}WW 	
catchXX 
(XX 
	ExceptionXX 
exXX 
)XX 
{YY 	
returnZZ 
ResultZZ 
<ZZ 
UnitZZ 
,ZZ 
NetworkFailureZZ  .
>ZZ. /
.ZZ/ 0
ErrZZ0 3
(ZZ3 4
NetworkFailure[[ 
.[[ #
DataCenterNotResponding[[ 6
([[6 7
ex[[7 9
.[[9 :
Message[[: A
,[[A B
ex[[C E
)[[E F
)[[F G
;[[G H
}\\ 	
}]] 
}^^ µ
|/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/RetryBehavior.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
sealed 
record 
RetryBehavior "
{ 
public 

required 
bool 
ShouldRetry $
{% &
get' *
;* +
init, 0
;0 1
}2 3
public 

required 
int 
MAX_ATTEMPTS $
{% &
get' *
;* +
init, 0
;0 1
}2 3
public 

required 
bool #
ReinitOnCompleteFailure 0
{1 2
get3 6
;6 7
init8 <
;< =
}> ?
public		 

static		 
RetryBehavior		 
NoRetry		  '
{		( )
get		* -
;		- .
}		/ 0
=		1 2
new		3 6
(		6 7
)		7 8
{

 
ShouldRetry 
= 
false 
, 
MAX_ATTEMPTS 
= 
$num 
, #
ReinitOnCompleteFailure 
=  !
false" '
} 
; 
} µQ
‡/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/ReceiveStreamRpcServices.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
sealed 
class $
ReceiveStreamRpcServices ,
:- .%
IReceiveStreamRpcServices/ H
{ 
private 
readonly 

Dictionary 
< 
RpcServiceType !
,! "
Func# '
<' (
ServiceRequest( 6
,6 7
CancellationToken8 I
,I J
ResultK Q
<Q R
RpcFlowR Y
,Y Z
NetworkFailure[ i
>i j
>j k
>k l
_serviceHandlers 
; 
private 
readonly $
AuthVerificationServices -
.- .*
AuthVerificationServicesClient. L)
_authenticationServicesClientM j
;j k
private 
readonly 
IGrpcErrorProcessor (
_errorProcessor) 8
;8 9
private 
readonly #
IGrpcCallOptionsFactory ,
_callOptionsFactory- @
;@ A
public 
$
ReceiveStreamRpcServices #
(# $$
AuthVerificationServices  
.  !*
AuthVerificationServicesClient! ?(
authenticationServicesClient@ \
,\ ]
IGrpcErrorProcessor 
errorProcessor *
,* +#
IGrpcCallOptionsFactory 
callOptionsFactory  2
)2 3
{ )
_authenticationServicesClient %
=& '(
authenticationServicesClient( D
;D E
_errorProcessor   
=   
errorProcessor   (
;  ( )
_callOptionsFactory!! 
=!! 
callOptionsFactory!! 0
;!!0 1
_serviceHandlers"" 
="" 
new## 

Dictionary## 
<## 
RpcServiceType## )
,##) *
Func##+ /
<##/ 0
ServiceRequest##0 >
,##> ?
CancellationToken##@ Q
,##Q R
Result##S Y
<##Y Z
RpcFlow##Z a
,##a b
NetworkFailure##c q
>##q r
>##r s
>##s t
{$$ 
{%% 
RpcServiceType%%  
.%%  ! 
InitiateVerification%%! 5
,%%5 6 
InitiateVerification%%7 K
}%%L M
}&& 
;&& 
}'' 
public)) 

Task)) 
<)) 
Result)) 
<)) 
RpcFlow)) 
,)) 
NetworkFailure))  .
>)). /
>))/ 0
ProcessRequest))1 ?
())? @
ServiceRequest))@ N
request))O V
,))V W
CancellationToken** 
token** 
)**  
{++ 
if,, 

(,, 
_serviceHandlers,, 
.,, 
TryGetValue,, (
(,,( )
request-- 
.-- 
RpcServiceMethod-- (
,--( )
out.. 
Func.. 
<.. 
ServiceRequest.. '
,..' (
CancellationToken..) :
,..: ;
Result..< B
<..B C
RpcFlow..C J
,..J K
NetworkFailure..L Z
>..Z [
>..[ \
?..\ ]
handler..^ e
)..e f
)..f g
{// 	
try00 
{11 
Result22 
<22 
RpcFlow22 
,22 
NetworkFailure22  .
>22. /
result220 6
=227 8
handler229 @
(22@ A
request22A H
,22H I
token22J O
)22O P
;22P Q
return33 
Task33 
.33 

FromResult33 &
(33& '
result33' -
)33- .
;33. /
}44 
catch55 
(55 
RpcException55 
rpcEx55  %
)55% &
{66 
return77 
Task77 
.77 

FromResult77 &
(77& '
Result77' -
<77- .
RpcFlow77. 5
,775 6
NetworkFailure777 E
>77E F
.77F G
Err77G J
(77J K
_errorProcessor77K Z
.77Z [
Process77[ b
(77b c
rpcEx77c h
)77h i
)77i j
)77j k
;77k l
}88 
catch99 
(99 
	Exception99 
ex99 
)99  
{:: 
return;; 
Task;; 
.;; 

FromResult;; &
(;;& '
Result;;' -
<;;- .
RpcFlow;;. 5
,;;5 6
NetworkFailure;;7 E
>;;E F
.;;F G
Err;;G J
(;;J K
NetworkFailure<< "
.<<" ##
DataCenterNotResponding<<# :
(<<: ;
ex<<; =
.<<= >
Message<<> E
,<<E F
ex<<G I
)<<I J
)== 
)== 
;== 
}>> 
}?? 	
returnAA 
TaskAA 
.AA 

FromResultAA 
(AA 
ResultAA %
<AA% &
RpcFlowAA& -
,AA- .
NetworkFailureAA/ =
>AA= >
.AA> ?
ErrAA? B
(AAB C
NetworkFailureBB 
.BB 
InvalidRequestTypeBB -
(BB- ."
NetworkServiceMessagesBB. D
.BBD E

RpcServiceBBE O
.BBO P&
UNSUPPORTED_SERVICE_METHODBBP j
)BBj k
)CC 	
)CC	 

;CC
 
}DD 
privateFF 
ResultFF 
<FF 
RpcFlowFF 
,FF 
NetworkFailureFF *
>FF* + 
InitiateVerificationFF, @
(FF@ A
ServiceRequestFFA O
requestFFP W
,FFW X
CancellationTokenGG 
tokenGG 
)GG  
{HH 
tryII 
{JJ 	
CallOptionsKK 
callOptionsKK #
=KK$ %
_callOptionsFactoryKK& 9
.KK9 :
CreateKK: @
(KK@ A
RpcServiceTypeLL 
.LL  
InitiateVerificationLL 3
,LL3 4
requestMM 
.MM 
RequestContextMM &
,MM& '
tokenNN 
)NN 
;NN $
AsyncServerStreamingCallPP $
<PP$ %
SecureEnvelopePP% 3
>PP3 4
streamingCallPP5 B
=PPC D)
_authenticationServicesClientQQ -
.QQ- . 
InitiateVerificationQQ. B
(QQB C
requestQQC J
.QQJ K
PayloadQQK R
,QQR S
callOptionsQQT _
)QQ_ `
;QQ` a
IAsyncEnumerableSS 
<SS 
ResultSS #
<SS# $
SecureEnvelopeSS$ 2
,SS2 3
NetworkFailureSS4 B
>SSB C
>SSC D
streamSSE K
=SSL M
streamingCallTT 
.TT 
ResponseStreamTT ,
.TT, -
ReadAllAsyncTT- 9
(TT9 :
tokenTT: ?
)TT? @
.UU 
ToObservableUU !
(UU! "
)UU" #
.VV 
SelectVV 
(VV 
ResultVV "
<VV" #
SecureEnvelopeVV# 1
,VV1 2
NetworkFailureVV3 A
>VVA B
.VVB C
OkVVC E
)VVE F
.WW 
CatchWW 
<WW 
ResultWW !
<WW! "
SecureEnvelopeWW" 0
,WW0 1
NetworkFailureWW2 @
>WW@ A
,WWA B
RpcExceptionWWC O
>WWO P
(WWP Q
rpcExWWQ V
=>WWW Y

ObservableXX "
.XX" #
ReturnXX# )
(XX) *
ResultXX* 0
<XX0 1
SecureEnvelopeXX1 ?
,XX? @
NetworkFailureXXA O
>XXO P
.XXP Q
ErrXXQ T
(XXT U
_errorProcessorYY +
.YY+ ,
ProcessYY, 3
(YY3 4
rpcExYY4 9
)YY9 :
)YY: ;
)YY; <
)YY< =
.ZZ 
CatchZZ 
<ZZ 
ResultZZ !
<ZZ! "
SecureEnvelopeZZ" 0
,ZZ0 1
NetworkFailureZZ2 @
>ZZ@ A
,ZZA B
	ExceptionZZC L
>ZZL M
(ZZM N
exZZN P
=>ZZQ S

Observable[[ "
.[[" #
Return[[# )
([[) *
Result[[* 0
<[[0 1
SecureEnvelope[[1 ?
,[[? @
NetworkFailure[[A O
>[[O P
.[[P Q
Err[[Q T
([[T U
NetworkFailure\\ *
.\\* +#
DataCenterNotResponding\\+ B
(\\B C
ex\\C E
.\\E F
Message\\F M
,\\M N
ex\\O Q
)\\Q R
)\\R S
)\\S T
)\\T U
.]] 
ToAsyncEnumerable]] &
(]]& '
)]]' (
;]]( )
return__ 
Result__ 
<__ 
RpcFlow__ !
,__! "
NetworkFailure__# 1
>__1 2
.__2 3
Ok__3 5
(__5 6
new__6 9
RpcFlow__: A
.__A B
InboundStream__B O
(__O P
stream__P V
)__V W
)__W X
;__X Y
}`` 	
catchaa 
(aa 
RpcExceptionaa 
rpcExaa !
)aa! "
{bb 	
returncc 
Resultcc 
<cc 
RpcFlowcc !
,cc! "
NetworkFailurecc# 1
>cc1 2
.cc2 3
Errcc3 6
(cc6 7
_errorProcessorcc7 F
.ccF G
ProcessccG N
(ccN O
rpcExccO T
)ccT U
)ccU V
;ccV W
}dd 	
catchee 
(ee 
	Exceptionee 
exee 
)ee 
{ff 	
returngg 
Resultgg 
<gg 
RpcFlowgg !
,gg! "
NetworkFailuregg# 1
>gg1 2
.gg2 3
Errgg3 6
(gg6 7
NetworkFailurehh 
.hh #
DataCenterNotRespondinghh 6
(hh6 7
exhh7 9
.hh9 :
Messagehh: A
,hhA B
exhhC E
)hhE F
)hhF G
;hhG H
}ii 	
}jj 
}kk †
‚/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/IGrpcErrorProcessor.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
public 
	interface 
IGrpcErrorProcessor $
{ 
NetworkFailure		 
Process		 
(		 
RpcException		 '
rpcException		( 4
)		4 5
;		5 6
Task

 
<

 	
NetworkFailure

	 
>

 
ProcessAsync

 %
(

% &
RpcException

& 2
rpcException

3 ?
)

? @
;

@ A
} î¾
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Rpc/GrpcErrorProcessor.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )
Rpc) ,
;, -
internal 
sealed	 
class 
GrpcErrorProcessor (
(( ) 
ILocalizationService) =
localizationService> Q
)Q R
:S T
IGrpcErrorProcessorU h
{ 
public 

NetworkFailure 
Process !
(! "
RpcException" .
rpcException/ ;
); <
=>= ?
CreateFailure@ M
(M N
rpcExceptionN Z
)Z [
;[ \
public 

Task 
< 
NetworkFailure 
> 
ProcessAsync  ,
(, -
RpcException- 9
rpcException: F
)F G
=>H J
Task 
. 

FromResult 
( 
CreateFailure %
(% &
rpcException& 2
)2 3
)3 4
;4 5
private 
NetworkFailure 
CreateFailure (
(( )
RpcException) 5
rpcException6 B
)B C
{ 
UserFacingError 
	userError !
=" #!
CreateUserFacingError$ 9
(9 :
rpcException: F
)F G
;G H
NetworkFailureType 
failureType &
=' ( 
DetermineFailureType) =
(= >
rpcException> J
,J K
	userErrorL U
)U V
;V W
return 
failureType 
switch !
{ 	
NetworkFailureType 
.  
INVALID_REQUEST_TYPE 3
=>4 6
NetworkFailure7 E
.E F
InvalidRequestTypeF X
(X Y
	userErrorY b
.b c
Messagec j
,j k
rpcException 
, 
	userError 
) 
, 
NetworkFailureType 
.  
DATA_CENTER_SHUTDOWN 3
=>4 6
NetworkFailure7 E
.E F
DataCenterShutdownF X
(X Y
	userErrorY b
.b c
Messagec j
,j k
rpcException   
,   
	userError!! 
)!! 
,!! 
NetworkFailureType"" 
."" #
PROTOCOL_STATE_MISMATCH"" 6
=>""7 9
NetworkFailure"": H
.""H I!
ProtocolStateMismatch""I ^
(""^ _
	userError""_ h
.""h i
Message""i p
,""p q
rpcException## 
,## 
	userError## '
)##' (
,##( )
NetworkFailureType$$ 
.$$ +
CRITICAL_AUTHENTICATION_FAILURE$$ >
=>$$? A
NetworkFailure$$B P
.$$P Q)
CriticalAuthenticationFailure$$Q n
($$n o
	userError%% 
.%% 
Message%% !
,%%! "
rpcException%%# /
,%%/ 0
	userError%%1 :
)%%: ;
,%%; <
NetworkFailureType&& 
.&& 
OPERATION_CANCELLED&& 2
=>&&3 5
NetworkFailure&&6 D
.&&D E
OperationCancelled&&E W
(&&W X
	userError&&X a
.&&a b
Message&&b i
,&&i j
rpcException&&k w
,&&w x
	userError'' 
)'' 
,'' 
_(( 
=>(( 
NetworkFailure(( 
.((  #
DataCenterNotResponding((  7
(((7 8
	userError((8 A
.((A B
Message((B I
,((I J
rpcException((K W
,((W X
	userError((Y b
)((b c
})) 	
;))	 

}** 
private,, 
UserFacingError,, !
CreateUserFacingError,, 1
(,,1 2
RpcException,,2 >
rpcException,,? K
),,K L
{-- 
Metadata.. 
trailers.. 
=.. 
rpcException.. (
...( )
Trailers..) 1
;..1 2
	ErrorCode00 
	errorCode00 
=00 
ParseErrorCode00 ,
(00, -
rpcException00- 9
,009 :
trailers00; C
)00C D
;00D E
(11 	
string11	 
message11 
,11 
string11 
keyUsed11  '
)11' (
=11) *
ResolveMessage11+ 9
(119 :
GetMetadataValue22 
(22 
trailers22 %
,22% &!
GrpcErrorMetadataKeys22' <
.22< =
	I_18N_KEY22= F
)22F G
,22G H
	errorCode33 
,33 
rpcException44 
.44 
Status44 
.44  
Detail44  &
)44& '
;44' (
bool66 
?66 
	retryable66 
=66 
ParseRetryable66 (
(66( )
trailers66) 1
)661 2
??663 5
IsTransientStatus666 G
(66G H
rpcException66H T
.66T U

StatusCode66U _
)66_ `
;66` a
if88 

(88 
GrpcErrorClassifier88 
.88  
IsAuthFlowMissing88  1
(881 2
rpcException882 >
)88> ?
)88? @
{99 	
	retryable:: 
=:: 
true:: 
;:: 
};; 	
int== 
?== 

retryAfter== 
=== 
ParseRetryAfter== )
(==) *
trailers==* 2
)==2 3
;==3 4
string>> 
?>> 
correlationId>> 
=>> 
GetMetadataValue>>  0
(>>0 1
trailers>>1 9
,>>9 :!
GrpcErrorMetadataKeys>>; P
.>>P Q
CORRELATION_ID>>Q _
)>>_ `
;>>` a
string?? 
??? 
locale?? 
=?? 
GetMetadataValue?? )
(??) *
trailers??* 2
,??2 3!
GrpcErrorMetadataKeys??4 I
.??I J
LOCALE??J P
)??P Q
;??Q R
returnAA 
newAA 
UserFacingErrorAA "
(AA" #
	errorCodeBB 
,BB 
keyUsedCC 
,CC 
messageDD 
,DD 
	retryableEE 
,EE 

retryAfterFF 
,FF 
correlationIdGG 
,GG 
localeHH 
,HH 
rpcExceptionII 
.II 

StatusCodeII #
)II# $
;II$ %
}JJ 
privateLL 
staticLL 
	ErrorCodeLL 
ParseErrorCodeLL +
(LL+ ,
RpcExceptionLL, 8
rpcExceptionLL9 E
,LLE F
MetadataLLG O
trailersLLP X
)LLX Y
{MM 
ifNN 

(NN 
GrpcErrorClassifierNN 
.NN  
IsAuthFlowMissingNN  1
(NN1 2
rpcExceptionNN2 >
)NN> ?
)NN? @
{OO 	
returnPP 
	ErrorCodePP 
.PP "
DEPENDENCY_UNAVAILABLEPP 3
;PP3 4
}QQ 	
stringSS 
?SS 
rawCodeSS 
=SS 
GetMetadataValueSS *
(SS* +
trailersSS+ 3
,SS3 4!
GrpcErrorMetadataKeysSS5 J
.SSJ K

ERROR_CODESSK U
)SSU V
;SSV W
ifTT 

(TT 
!TT 
stringTT 
.TT 
IsNullOrWhiteSpaceTT &
(TT& '
rawCodeTT' .
)TT. /
&&TT0 2
EnumUU 
.UU 
TryParseUU 
(UU 
rawCodeUU !
,UU! "

ignoreCaseUU# -
:UU- .
trueUU/ 3
,UU3 4
outUU5 8
	ErrorCodeUU9 B
parsedUUC I
)UUI J
)UUJ K
{VV 	
returnWW 
parsedWW 
;WW 
}XX 	
returnZZ 
MapStatusCodeZZ 
(ZZ 
rpcExceptionZZ )
.ZZ) *

StatusCodeZZ* 4
)ZZ4 5
;ZZ5 6
}[[ 
private]] 
(]] 
string]] 
Message]] 
,]] 
string]] #
KeyUsed]]$ +
)]]+ ,
ResolveMessage]]- ;
(]]; <
string]]< B
?]]B C
requestedKey]]D P
,]]P Q
	ErrorCode]]R [
	errorCode]]\ e
,]]e f
string^^ 
statusDetail^^ 
)^^ 
{__ 
if`` 

(`` 
!`` 
string`` 
.`` 
IsNullOrWhiteSpace`` &
(``& '
requestedKey``' 3
)``3 4
)``4 5
{aa 	
stringbb 
	localizedbb 
=bb 
Localizebb '
(bb' (
requestedKeybb( 4
)bb4 5
;bb5 6
ifcc 
(cc 
!cc 
	IsMissingcc 
(cc 
	localizedcc $
)cc$ %
)cc% &
{dd 
returnee 
(ee 
	localizedee !
,ee! "
requestedKeyee# /
)ee/ 0
;ee0 1
}ff 
}gg 	
stringii 
fallbackKeyii 
=ii 
GetFallbackKeyii +
(ii+ ,
	errorCodeii, 5
)ii5 6
;ii6 7
stringjj 
fallbackMessagejj 
=jj  
Localizejj! )
(jj) *
fallbackKeyjj* 5
)jj5 6
;jj6 7
ifkk 

(kk 
!kk 
	IsMissingkk 
(kk 
fallbackMessagekk &
)kk& '
)kk' (
{ll 	
returnmm 
(mm 
fallbackMessagemm #
,mm# $
fallbackKeymm% 0
)mm0 1
;mm1 2
}nn 	
ifpp 

(pp 
!pp 
stringpp 
.pp 
IsNullOrWhiteSpacepp &
(pp& '
statusDetailpp' 3
)pp3 4
)pp4 5
{qq 	
returnrr 
(rr 
statusDetailrr  
,rr  !
fallbackKeyrr" -
)rr- .
;rr. /
}ss 	
stringuu 
internalMessageuu 
=uu  
Localizeuu! )
(uu) *
ErrorI18NKeysuu* 7
.uu7 8
INTERNALuu8 @
)uu@ A
;uuA B
ifvv 

(vv 
	IsMissingvv 
(vv 
internalMessagevv %
)vv% &
)vv& '
{ww 	
internalMessagexx 
=xx 
$strxx <
;xx< =
}yy 	
return{{ 
({{ 
internalMessage{{ 
,{{  
ErrorI18NKeys{{! .
.{{. /
INTERNAL{{/ 7
){{7 8
;{{8 9
}|| 
private~~ 
string~~ 
Localize~~ 
(~~ 
string~~ "
key~~# &
)~~& '
{ 
try
€€ 
{
 	
return
‚‚ !
localizationService
‚‚ &
[
‚‚& '
key
‚‚' *
]
‚‚* +
;
‚‚+ ,
}
ƒƒ 	
catch
„„ 
{
…… 	
return
†† 
$"
†† 
$str
†† 
{
†† 
key
†† 
}
†† 
$str
†† 
"
†† 
;
†† 
}
‡‡ 	
}
ˆˆ 
private
ŠŠ 
static
ŠŠ 
bool
ŠŠ 
	IsMissing
ŠŠ !
(
ŠŠ! "
string
ŠŠ" (
value
ŠŠ) .
)
ŠŠ. /
{
‹‹ 
return
ŒŒ 
string
ŒŒ 
.
ŒŒ  
IsNullOrWhiteSpace
ŒŒ (
(
ŒŒ( )
value
ŒŒ) .
)
ŒŒ. /
||
ŒŒ0 2
value
 
.
 

StartsWith
 
(
  
$str
  #
,
# $
StringComparison
% 5
.
5 6
Ordinal
6 =
)
= >
&&
? A
value
B G
.
G H
EndsWith
H P
(
P Q
$str
Q T
,
T U
StringComparison
V f
.
f g
Ordinal
g n
)
n o
;
o p
}
ŽŽ 
private
 
static
 
bool
 
?
 
ParseRetryable
 '
(
' (
Metadata
( 0
trailers
1 9
)
9 :
{
‘‘ 
string
’’ 
?
’’ 
retryableValue
’’ 
=
’’  
GetMetadataValue
’’! 1
(
’’1 2
trailers
’’2 :
,
’’: ;#
GrpcErrorMetadataKeys
’’< Q
.
’’Q R
	RETRYABLE
’’R [
)
’’[ \
;
’’\ ]
if
““ 

(
““ 
string
““ 
.
““  
IsNullOrWhiteSpace
““ %
(
““% &
retryableValue
““& 4
)
““4 5
)
““5 6
{
”” 	
return
•• 
null
•• 
;
•• 
}
–– 	
return
˜˜ 
bool
˜˜ 
.
˜˜ 
TryParse
˜˜ 
(
˜˜ 
retryableValue
˜˜ +
,
˜˜+ ,
out
˜˜- 0
bool
˜˜1 5
parsed
˜˜6 <
)
˜˜< =
?
˜˜> ?
parsed
˜˜@ F
:
˜˜G H
null
˜˜I M
;
˜˜M N
}
™™ 
private
›› 
static
›› 
int
›› 
?
›› 
ParseRetryAfter
›› '
(
››' (
Metadata
››( 0
trailers
››1 9
)
››9 :
{
œœ 
string
 
?
 
retryAfterValue
 
=
  !
GetMetadataValue
" 2
(
2 3
trailers
3 ;
,
; <#
GrpcErrorMetadataKeys
= R
.
R S&
RETRY_AFTER_MILLISECONDS
S k
)
k l
;
l m
if
žž 

(
žž 
string
žž 
.
žž  
IsNullOrWhiteSpace
žž %
(
žž% &
retryAfterValue
žž& 5
)
žž5 6
)
žž6 7
{
ŸŸ 	
return
   
null
   
;
   
}
¡¡ 	
return
££ 
int
££ 
.
££ 
TryParse
££ 
(
££ 
retryAfterValue
££ +
,
££+ ,
NumberStyles
££- 9
.
££9 :
Integer
££: A
,
££A B
CultureInfo
££C N
.
££N O
InvariantCulture
££O _
,
££_ `
out
££a d
int
££e h
parsed
££i o
)
££o p
?
¤¤ 
parsed
¤¤ 
:
¥¥ 
null
¥¥ 
;
¥¥ 
}
¦¦ 
private
¨¨ 
static
¨¨ 
string
¨¨ 
?
¨¨ 
GetMetadataValue
¨¨ +
(
¨¨+ ,
Metadata
¨¨, 4
metadata
¨¨5 =
,
¨¨= >
string
¨¨? E
key
¨¨F I
)
¨¨I J
=>
¨¨K M
(
¨¨N O
from
¨¨O S
entry
¨¨T Y
in
¨¨Z \
metadata
¨¨] e
where
©© 
entry
©© 
.
©© 
Key
©© 
.
©© 
Equals
©© 
(
©© 
key
©© "
,
©©" #
StringComparison
©©$ 4
.
©©4 5
OrdinalIgnoreCase
©©5 F
)
©©F G
select
ªª 
entry
ªª 
.
ªª 
Value
ªª 
)
ªª 
.
ªª 
FirstOrDefault
ªª *
(
ªª* +
)
ªª+ ,
;
ªª, -
private
¬¬ 
static
¬¬ 
bool
¬¬ 
IsTransientStatus
¬¬ )
(
¬¬) *

StatusCode
¬¬* 4

statusCode
¬¬5 ?
)
¬¬? @
=>
¬¬A C

statusCode
­­ 
is
­­ 

StatusCode
­­  
.
­­  !
Unavailable
­­! ,
or
­­- /

StatusCode
­­0 :
.
­­: ;
DeadlineExceeded
­­; K
or
­­L N

StatusCode
­­O Y
.
­­Y Z
	Cancelled
­­Z c
;
­­c d
private
¯¯ 
static
¯¯ 
	ErrorCode
¯¯ 
MapStatusCode
¯¯ *
(
¯¯* +

StatusCode
¯¯+ 5

statusCode
¯¯6 @
)
¯¯@ A
=>
¯¯B D

statusCode
°° 
switch
°° 
{
±± 	

StatusCode
²² 
.
²² 
InvalidArgument
²² &
or
²²' )

StatusCode
²²* 4
.
²²4 5

OutOfRange
²²5 ?
=>
²²@ B
	ErrorCode
²²C L
.
²²L M
VALIDATION_FAILED
²²M ^
,
²²^ _

StatusCode
³³ 
.
³³ 
NotFound
³³ 
=>
³³  "
	ErrorCode
³³# ,
.
³³, -
	NOT_FOUND
³³- 6
,
³³6 7

StatusCode
´´ 
.
´´ 
AlreadyExists
´´ $
=>
´´% '
	ErrorCode
´´( 1
.
´´1 2
ALREADY_EXISTS
´´2 @
,
´´@ A

StatusCode
µµ 
.
µµ 
PermissionDenied
µµ '
=>
µµ( *
	ErrorCode
µµ+ 4
.
µµ4 5
PERMISSION_DENIED
µµ5 F
,
µµF G

StatusCode
¶¶ 
.
¶¶ 
Unauthenticated
¶¶ &
=>
¶¶' )
	ErrorCode
¶¶* 3
.
¶¶3 4
UNAUTHENTICATED
¶¶4 C
,
¶¶C D

StatusCode
·· 
.
··  
FailedPrecondition
·· )
=>
··* ,
	ErrorCode
··- 6
.
··6 7!
PRECONDITION_FAILED
··7 J
,
··J K

StatusCode
¸¸ 
.
¸¸ 
Aborted
¸¸ 
=>
¸¸ !
	ErrorCode
¸¸" +
.
¸¸+ ,
CONFLICT
¸¸, 4
,
¸¸4 5

StatusCode
¹¹ 
.
¹¹ 
ResourceExhausted
¹¹ (
=>
¹¹) +
	ErrorCode
¹¹, 5
.
¹¹5 6 
RESOURCE_EXHAUSTED
¹¹6 H
,
¹¹H I

StatusCode
ºº 
.
ºº 
Unavailable
ºº "
=>
ºº# %
	ErrorCode
ºº& /
.
ºº/ 0!
SERVICE_UNAVAILABLE
ºº0 C
,
ººC D

StatusCode
»» 
.
»» 
DeadlineExceeded
»» '
=>
»»( *
	ErrorCode
»»+ 4
.
»»4 5
DEADLINE_EXCEEDED
»»5 F
,
»»F G

StatusCode
¼¼ 
.
¼¼ 
	Cancelled
¼¼  
=>
¼¼! #
	ErrorCode
¼¼$ -
.
¼¼- .
	CANCELLED
¼¼. 7
,
¼¼7 8
_
½½ 
=>
½½ 
	ErrorCode
½½ 
.
½½ 
INTERNAL_ERROR
½½ )
}
¾¾ 	
;
¾¾	 

private
ÀÀ 
static
ÀÀ 
string
ÀÀ 
GetFallbackKey
ÀÀ (
(
ÀÀ( )
	ErrorCode
ÀÀ) 2
	errorCode
ÀÀ3 <
)
ÀÀ< =
=>
ÀÀ> @
	errorCode
ÁÁ 
switch
ÁÁ 
{
ÂÂ 	
	ErrorCode
ÃÃ 
.
ÃÃ 
VALIDATION_FAILED
ÃÃ '
=>
ÃÃ( *
ErrorI18NKeys
ÃÃ+ 8
.
ÃÃ8 9

VALIDATION
ÃÃ9 C
,
ÃÃC D
	ErrorCode
ÄÄ 
.
ÄÄ "
MAX_ATTEMPTS_REACHED
ÄÄ *
=>
ÄÄ+ -
ErrorI18NKeys
ÄÄ. ;
.
ÄÄ; <
MAX_ATTEMPTS
ÄÄ< H
,
ÄÄH I
	ErrorCode
ÅÅ 
.
ÅÅ #
INVALID_MOBILE_NUMBER
ÅÅ +
=>
ÅÅ, .
ErrorI18NKeys
ÅÅ/ <
.
ÅÅ< =
INVALID_MOBILE
ÅÅ= K
,
ÅÅK L
	ErrorCode
ÆÆ 
.
ÆÆ 
OTP_EXPIRED
ÆÆ !
=>
ÆÆ" $
ErrorI18NKeys
ÆÆ% 2
.
ÆÆ2 3
OTP_EXPIRED
ÆÆ3 >
,
ÆÆ> ?
	ErrorCode
ÇÇ 
.
ÇÇ 
	NOT_FOUND
ÇÇ 
=>
ÇÇ  "
ErrorI18NKeys
ÇÇ# 0
.
ÇÇ0 1
	NOT_FOUND
ÇÇ1 :
,
ÇÇ: ;
	ErrorCode
ÈÈ 
.
ÈÈ 
ALREADY_EXISTS
ÈÈ $
=>
ÈÈ% '
ErrorI18NKeys
ÈÈ( 5
.
ÈÈ5 6
ALREADY_EXISTS
ÈÈ6 D
,
ÈÈD E
	ErrorCode
ÉÉ 
.
ÉÉ 
UNAUTHENTICATED
ÉÉ %
=>
ÉÉ& (
ErrorI18NKeys
ÉÉ) 6
.
ÉÉ6 7
UNAUTHENTICATED
ÉÉ7 F
,
ÉÉF G
	ErrorCode
ÊÊ 
.
ÊÊ 
PERMISSION_DENIED
ÊÊ '
=>
ÊÊ( *
ErrorI18NKeys
ÊÊ+ 8
.
ÊÊ8 9
PERMISSION_DENIED
ÊÊ9 J
,
ÊÊJ K
	ErrorCode
ËË 
.
ËË !
PRECONDITION_FAILED
ËË )
=>
ËË* ,
ErrorI18NKeys
ËË- :
.
ËË: ;!
PRECONDITION_FAILED
ËË; N
,
ËËN O
	ErrorCode
ÌÌ 
.
ÌÌ 
CONFLICT
ÌÌ 
=>
ÌÌ !
ErrorI18NKeys
ÌÌ" /
.
ÌÌ/ 0
CONFLICT
ÌÌ0 8
,
ÌÌ8 9
	ErrorCode
ÍÍ 
.
ÍÍ  
RESOURCE_EXHAUSTED
ÍÍ (
=>
ÍÍ) +
ErrorI18NKeys
ÍÍ, 9
.
ÍÍ9 : 
RESOURCE_EXHAUSTED
ÍÍ: L
,
ÍÍL M
	ErrorCode
ÎÎ 
.
ÎÎ !
SERVICE_UNAVAILABLE
ÎÎ )
=>
ÎÎ* ,
ErrorI18NKeys
ÎÎ- :
.
ÎÎ: ;!
SERVICE_UNAVAILABLE
ÎÎ; N
,
ÎÎN O
	ErrorCode
ÏÏ 
.
ÏÏ $
DEPENDENCY_UNAVAILABLE
ÏÏ ,
=>
ÏÏ- /
ErrorI18NKeys
ÏÏ0 =
.
ÏÏ= >$
DEPENDENCY_UNAVAILABLE
ÏÏ> T
,
ÏÏT U
	ErrorCode
ÐÐ 
.
ÐÐ 
DEADLINE_EXCEEDED
ÐÐ '
=>
ÐÐ( *
ErrorI18NKeys
ÐÐ+ 8
.
ÐÐ8 9
DEADLINE_EXCEEDED
ÐÐ9 J
,
ÐÐJ K
	ErrorCode
ÑÑ 
.
ÑÑ 
	CANCELLED
ÑÑ 
=>
ÑÑ  "
ErrorI18NKeys
ÑÑ# 0
.
ÑÑ0 1
	CANCELLED
ÑÑ1 :
,
ÑÑ: ;
	ErrorCode
ÒÒ 
.
ÒÒ "
DATABASE_UNAVAILABLE
ÒÒ *
=>
ÒÒ+ -
ErrorI18NKeys
ÒÒ. ;
.
ÒÒ; <"
DATABASE_UNAVAILABLE
ÒÒ< P
,
ÒÒP Q
_
ÓÓ 
=>
ÓÓ 
ErrorI18NKeys
ÓÓ 
.
ÓÓ 
INTERNAL
ÓÓ '
}
ÔÔ 	
;
ÔÔ	 

private
ÖÖ 
static
ÖÖ  
NetworkFailureType
ÖÖ %"
DetermineFailureType
ÖÖ& :
(
ÖÖ: ;
RpcException
ÖÖ; G
rpcException
ÖÖH T
,
ÖÖT U
UserFacingError
ÖÖV e
	userError
ÖÖf o
)
ÖÖo p
{
×× 
if
ØØ 

(
ØØ !
GrpcErrorClassifier
ØØ 
.
ØØ  ,
IsIdentityKeyDerivationFailure
ØØ  >
(
ØØ> ?
rpcException
ØØ? K
)
ØØK L
||
ØØM O!
GrpcErrorClassifier
ÙÙ 
.
ÙÙ  #
IsAuthenticationError
ÙÙ  5
(
ÙÙ5 6
rpcException
ÙÙ6 B
)
ÙÙB C
||
ÙÙD F
	userError
ÚÚ 
.
ÚÚ 
	ErrorCode
ÚÚ 
==
ÚÚ  "
	ErrorCode
ÚÚ# ,
.
ÚÚ, -
UNAUTHENTICATED
ÚÚ- <
)
ÚÚ< =
{
ÛÛ 	
return
ÜÜ  
NetworkFailureType
ÜÜ %
.
ÜÜ% &-
CRITICAL_AUTHENTICATION_FAILURE
ÜÜ& E
;
ÜÜE F
}
ÝÝ 	
if
ßß 

(
ßß !
GrpcErrorClassifier
ßß 
.
ßß  %
IsProtocolStateMismatch
ßß  7
(
ßß7 8
rpcException
ßß8 D
)
ßßD E
)
ßßE F
{
àà 	
return
áá  
NetworkFailureType
áá %
.
áá% &%
PROTOCOL_STATE_MISMATCH
áá& =
;
áá= >
}
ââ 	
if
ää 

(
ää !
GrpcErrorClassifier
ää 
.
ää  
IsServerShutdown
ää  0
(
ää0 1
rpcException
ää1 =
)
ää= >
)
ää> ?
{
åå 	
return
ææ  
NetworkFailureType
ææ %
.
ææ% &"
DATA_CENTER_SHUTDOWN
ææ& :
;
ææ: ;
}
çç 	
if
éé 

(
éé !
GrpcErrorClassifier
éé 
.
éé  
IsBusinessError
éé  /
(
éé/ 0
rpcException
éé0 <
)
éé< =
&&
éé> @
!
êê !
GrpcErrorClassifier
êê  
.
êê  !
IsAuthFlowMissing
êê! 2
(
êê2 3
rpcException
êê3 ?
)
êê? @
)
êê@ A
{
ëë 	
return
ìì  
NetworkFailureType
ìì %
.
ìì% &"
INVALID_REQUEST_TYPE
ìì& :
;
ìì: ;
}
íí 	
return
ïï  
NetworkFailureType
ïï !
.
ïï! "(
DATA_CENTER_NOT_RESPONDING
ïï" <
;
ïï< =
}
ðð 
}ññ …
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Resilience/RetryStrategyConfiguration.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )

Resilience) 3
;3 4
public 
class &
RetryStrategyConfiguration '
{ 
public 

TimeSpan 
INITIAL_RETRY_DELAY '
{( )
get* -
;- .
init/ 3
;3 4
}5 6
=7 8
TimeSpan9 A
.A B
FromSecondsB M
(M N
$numN O
)O P
;P Q
public 

TimeSpan 
MAX_RETRY_DELAY #
{$ %
get& )
;) *
init+ /
;/ 0
}1 2
=3 4
TimeSpan5 =
.= >
FromMinutes> I
(I J
$numJ K
)K L
;L M
public		 

int		 
MAX_RETRIES		 
{		 
get		  
;		  !
init		" &
;		& '
}		( )
=		* +
$num		, .
;		. /
public

 

bool

 
USE_ADAPTIVE_RETRY

 "
{

# $
get

% (
;

( )
init

* .
;

. /
}

0 1
=

2 3
true

4 8
;

8 9
public 

TimeSpan 
PER_ATTEMPT_TIMEOUT '
{( )
get* -
;- .
init/ 3
;3 4
}5 6
=7 8
TimeSpan9 A
.A B
FromSecondsB M
(M N
$numN P
)P Q
;Q R
} üÿ
ƒ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Resilience/RetryStrategy.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )

Resilience) 3
;3 4
public 
sealed 
class 
RetryStrategy !
:" #
IRetryStrategy$ 2
{ 
private 
const 
int "
MAX_TRACKED_OPERATIONS ,
=- .
$num/ 3
;3 4
private 
const 
int $
CLEANUP_INTERVAL_MINUTES .
=/ 0
$num1 2
;2 3
private 
const 
int %
OPERATION_TIMEOUT_MINUTES /
=0 1
$num2 4
;4 5
private   
const   
string   
ATTEMPT_KEY   $
=  % &
$str  ' 0
;  0 1
private"" 
readonly"" &
RetryStrategyConfiguration"" /"
_strategyConfiguration""0 F
;""F G
private## 
readonly##  
IConnectivityService## ) 
_connectivityService##* >
;##> ?
private$$ 
readonly$$  
ConcurrentDictionary$$ )
<$$) *
string$$* 0
,$$0 1
RetryOperationInfo$$2 D
>$$D E"
_activeRetryOperations$$F \
=$$] ^
new$$_ b
($$b c
)$$c d
;$$d e
private%% 
readonly%%  
ConcurrentDictionary%% )
<%%) *
string%%* 0
,%%0 1
object%%2 8
>%%8 9
_pipelineCache%%: H
=%%I J
new%%K N
(%%N O
)%%O P
;%%P Q
private&& 
readonly&& 
SemaphoreSlim&& "

_stateLock&&# -
=&&. /
new&&0 3
(&&3 4
$num&&4 5
,&&5 6
$num&&7 8
)&&8 9
;&&9 :
private'' 
readonly'' 
Timer'' 
_cleanupTimer'' (
;''( )
private(( 
readonly(( 
IDisposable((  
?((  !$
_manualRetrySubscription((" :
;((: ;
private** 
Lazy** 
<** 
NetworkProvider**  
>**  !
?**! " 
_lazyNetworkProvider**# 7
;**7 8
private++ 
volatile++ 
bool++ 
_isDisposed++ %
;++% &
private-- 
sealed-- 
class-- 
RetryOperationInfo-- +
{.. 
public// 
required// 
string// 
OperationName// ,
{//- .
get/// 2
;//2 3
init//4 8
;//8 9
}//: ;
public00 
required00 
uint00 
	ConnectId00 &
{00' (
get00) ,
;00, -
init00. 2
;002 3
}004 5
public11 
required11 
DateTime11  
	StartTime11! *
{11+ ,
get11- 0
;110 1
init112 6
;116 7
}118 9
public22 
required22 
int22 

MaxRetries22 &
{22' (
get22) ,
;22, -
init22. 2
;222 3
}224 5
public33 
required33 
string33 
	UniqueKey33 (
{33) *
get33+ .
;33. /
init330 4
;334 5
}336 7
public44 
required44 
RpcServiceType44 &
?44& '
ServiceType44( 3
{444 5
get446 9
;449 :
init44; ?
;44? @
}44A B
private66 
int66 
_currentRetryCount66 &
;66& '
private77 
int77 
_isExhausted77  
;77  !
public99 
int99 
CurrentRetryCount99 $
{:: 	
set;; 
=>;; 
Interlocked;; 
.;; 
Exchange;; '
(;;' (
ref;;( +
_currentRetryCount;;, >
,;;> ?
value;;@ E
);;E F
;;;F G
}<< 	
public>> 
bool>> 
IsExhausted>> 
{?? 	
get@@ 
=>@@ 
_isExhausted@@ 
==@@  "
$num@@# $
;@@$ %
setAA 
=>AA 
InterlockedAA 
.AA 
ExchangeAA '
(AA' (
refAA( +
_isExhaustedAA, 8
,AA8 9
valueAA: ?
?AA@ A
$numAAB C
:AAD E
$numAAF G
)AAG H
;AAH I
}BB 	
}CC 
publicEE 

RetryStrategyEE 
(EE &
RetryStrategyConfigurationFF "!
strategyConfigurationFF# 8
,FF8 9 
IConnectivityServiceGG 
connectivityServiceGG 0
,GG0 1%
IOperationTimeoutProviderHH !
_HH" #
)HH# $
{II "
_strategyConfigurationJJ 
=JJ  !
strategyConfigurationJJ! 6
;JJ6 7 
_connectivityServiceKK 
=KK 
connectivityServiceKK 2
;KK2 3
_cleanupTimerMM 
=MM 
newMM 
TimerMM !
(MM! "&
CleanupAbandonedOperationsNN &
,NN& '
nullOO 
,OO 
TimeSpanPP 
.PP 
FromMinutesPP  
(PP  !$
CLEANUP_INTERVAL_MINUTESPP! 9
)PP9 :
,PP: ;
TimeSpanQQ 
.QQ 
FromMinutesQQ  
(QQ  !$
CLEANUP_INTERVAL_MINUTESQQ! 9
)QQ9 :
)QQ: ;
;QQ; <
trySS 
{TT 	$
_manualRetrySubscriptionUU $
=UU% & 
_connectivityServiceUU' ;
.UU; <"
OnManualRetryRequestedUU< R
(UUR S)
HandleManualRetryRequestAsyncUUS p
)UUp q
;UUq r
}VV 	
catchWW 
{XX 	
DisposeYY 
(YY 
)YY 
;YY 
}ZZ 	
}[[ 
public]] 

void]] "
SetLazyNetworkProvider]] &
(]]& '
Lazy]]' +
<]]+ ,
NetworkProvider]], ;
>]]; <
lazyNetworkProvider]]= P
)]]P Q
{^^ 
if__ 

(__ 
_isDisposed__ 
)__ 
{`` 	
throwaa 
newaa #
ObjectDisposedExceptionaa -
(aa- .
nameofaa. 4
(aa4 5
RetryStrategyaa5 B
)aaB C
)aaC D
;aaD E
}bb 	 
_lazyNetworkProviderdd 
=dd 
lazyNetworkProviderdd 2
;dd2 3
}ee 
publicgg 

asyncgg 
Taskgg 
<gg 
Resultgg 
<gg 
	TResponsegg &
,gg& '
NetworkFailuregg( 6
>gg6 7
>gg7 8$
ExecuteRpcOperationAsyncgg9 Q
<ggQ R
	TResponseggR [
>gg[ \
(gg\ ]
Funchh 
<hh 
inthh 
,hh 
CancellationTokenhh #
,hh# $
Taskhh% )
<hh) *
Resulthh* 0
<hh0 1
	TResponsehh1 :
,hh: ;
NetworkFailurehh< J
>hhJ K
>hhK L
>hhL M
	operationhhN W
,hhW X
stringii 
operationNameii 
,ii 
uintjj 
	connectIdjj 
,jj 
RpcServiceTypekk 
?kk 
serviceTypekk #
=kk$ %
nullkk& *
,kk* +
intll 
?ll 

maxRetriesll 
=ll 
nullll 
,ll 
CancellationTokenmm 
cancellationTokenmm +
=mm, -
defaultmm. 5
)mm5 6
{nn 
returnoo 
awaitoo 7
+ExecuteSecrecyChannelOperationInternalAsyncoo @
(oo@ A
	operationpp 
,pp 
operationNamepp (
,pp( )
	connectIdpp* 3
,pp3 4
serviceTypepp5 @
,pp@ A

maxRetriesppB L
,ppL M
cancellationTokenppN _
,pp_ `!
bypassExhaustionCheckqq %
:qq% &
falseqq' ,
)qq, -
.rr 
ConfigureAwaitrr 
(rr 
falserr !
)rr! "
;rr" #
}ss 
publicuu 

asyncuu 
Taskuu 
<uu 
Resultuu 
<uu 
	TResponseuu &
,uu& '
NetworkFailureuu( 6
>uu6 7
>uu7 8/
#ExecuteManualRetryRpcOperationAsyncuu9 \
<uu\ ]
	TResponseuu] f
>uuf g
(uug h
Funcvv 
<vv 
intvv 
,vv 
CancellationTokenvv #
,vv# $
Taskvv% )
<vv) *
Resultvv* 0
<vv0 1
	TResponsevv1 :
,vv: ;
NetworkFailurevv< J
>vvJ K
>vvK L
>vvL M
	operationvvN W
,vvW X
stringww 
operationNameww 
,ww 
uintxx 
	connectIdxx 
,xx 
RpcServiceTypeyy 
?yy 
serviceTypeyy #
=yy$ %
nullyy& *
,yy* +
intzz 
?zz 

maxRetrieszz 
=zz 
nullzz 
,zz 
CancellationToken{{ 
cancellationToken{{ +
={{, -
default{{. 5
){{5 6
{|| 
return}} 
await}} 7
+ExecuteSecrecyChannelOperationInternalAsync}} @
(}}@ A
	operation~~ 
,~~ 
operationName~~ (
,~~( )
	connectId~~* 3
,~~3 4
serviceType~~5 @
,~~@ A

maxRetries~~B L
,~~L M
cancellationToken~~N _
,~~_ `!
bypassExhaustionCheck %
:% &
true' +
)+ ,
.
€€ 
ConfigureAwait
€€ 
(
€€ 
false
€€ !
)
€€! "
;
€€" #
}
 
private
ƒƒ 
async
ƒƒ 
Task
ƒƒ 
<
ƒƒ 
Result
ƒƒ 
<
ƒƒ 
	TResponse
ƒƒ '
,
ƒƒ' (
NetworkFailure
ƒƒ) 7
>
ƒƒ7 8
>
ƒƒ8 99
+ExecuteSecrecyChannelOperationInternalAsync
ƒƒ: e
<
ƒƒe f
	TResponse
ƒƒf o
>
ƒƒo p
(
ƒƒp q
Func
„„ 
<
„„ 
int
„„ 
,
„„ 
CancellationToken
„„ #
,
„„# $
Task
„„% )
<
„„) *
Result
„„* 0
<
„„0 1
	TResponse
„„1 :
,
„„: ;
NetworkFailure
„„< J
>
„„J K
>
„„K L
>
„„L M
	operation
„„N W
,
„„W X
string
…… 
operationName
…… 
,
…… 
uint
†† 
?
†† 
	connectId
†† 
,
†† 
RpcServiceType
‡‡ 
?
‡‡ 
serviceType
‡‡ #
,
‡‡# $
int
ˆˆ 
?
ˆˆ 

maxRetries
ˆˆ 
,
ˆˆ 
CancellationToken
‰‰ 
cancellationToken
‰‰ +
,
‰‰+ ,
bool
ŠŠ #
bypassExhaustionCheck
ŠŠ "
)
ŠŠ" #
{
‹‹ 
uint
ŒŒ 
actualConnectId
ŒŒ 
=
ŒŒ 
	connectId
ŒŒ (
??
ŒŒ) +
$num
ŒŒ, -
;
ŒŒ- .
int
 
actualMaxRetries
 
=
 

maxRetries
 )
??
* ,$
_strategyConfiguration
- C
.
C D
MAX_RETRIES
D O
;
O P
if
 

(
 
!
 #
bypassExhaustionCheck
 "
&&
# %
await
& +&
IsGloballyExhaustedAsync
, D
(
D E
)
E F
.
F G
ConfigureAwait
G U
(
U V
false
V [
)
[ \
)
\ ]
{
 	
return
‘‘ 
Result
‘‘ 
<
‘‘ 
	TResponse
‘‘ #
,
‘‘# $
NetworkFailure
‘‘% 3
>
‘‘3 4
.
‘‘4 5
Err
‘‘5 8
(
‘‘8 9
NetworkFailure
’’ 
.
’’ %
DataCenterNotResponding
’’ 6
(
’’6 7
$str
’’7 h
)
’’h i
)
’’i j
;
’’j k
}
““ 	
DateTime
••  
operationStartTime
•• #
=
••$ %
DateTime
••& .
.
••. /
UtcNow
••/ 5
;
••5 6
string
–– 
operationKey
–– 
=
––  
CreateOperationKey
–– 0
(
––0 1
operationName
––1 >
,
––> ?
actualConnectId
––@ O
,
––O P 
operationStartTime
––Q c
)
––c d
;
––d e
try
˜˜ 
{
™™ 	
IAsyncPolicy
šš 
<
šš 
Result
šš 
<
šš  
	TResponse
šš  )
,
šš) *
NetworkFailure
šš+ 9
>
šš9 :
>
šš: ;
retryPolicy
šš< G
=
ššH I$
CreateTypedRetryPolicy
›› &
<
››& '
	TResponse
››' 0
>
››0 1
(
››1 2
actualMaxRetries
œœ $
,
œœ$ %
operationKey
  
,
  !
operationName
žž !
,
žž! "
actualConnectId
ŸŸ #
,
ŸŸ# $
serviceType
   
,
    
cancellationToken
¡¡ %
)
¡¡% &
;
¡¡& '
Context
££ 
context
££ 
=
££ 
new
££ !
(
££! "
operationName
££" /
)
££/ 0
{
££1 2
[
££3 4
ATTEMPT_KEY
££4 ?
]
££? @
=
££A B
$num
££C D
}
££E F
;
££F G
Result
¥¥ 
<
¥¥ 
	TResponse
¥¥ 
,
¥¥ 
NetworkFailure
¥¥ ,
>
¥¥, -
result
¥¥. 4
=
¥¥5 6
await
¥¥7 <
retryPolicy
¥¥= H
.
¥¥H I
ExecuteAsync
¥¥I U
(
¥¥U V
(
¦¦ 
ctx
¦¦ 
,
¦¦ 
ct
¦¦ 
)
¦¦ 
=>
¦¦ )
ExecuteOperationWithLogging
¦¦ 8
(
¦¦8 9
ctx
¦¦9 <
,
¦¦< =
ct
¦¦> @
,
¦¦@ A
	operation
¦¦B K
,
¦¦K L
operationName
¦¦M Z
)
¦¦Z [
,
¦¦[ \
context
§§ 
,
§§ 
cancellationToken
¨¨ !
)
¨¨! "
.
¨¨" #
ConfigureAwait
¨¨# 1
(
¨¨1 2
false
¨¨2 7
)
¨¨7 8
;
¨¨8 9
if
ªª 
(
ªª 
result
ªª 
.
ªª 
IsOk
ªª 
)
ªª 
{
«« #
StopTrackingOperation
¬¬ %
(
¬¬% &
operationKey
¬¬& 2
,
¬¬2 3
$str
¬¬4 L
)
¬¬L M
;
¬¬M N
}
­­ 
else
®® 
{
¯¯ 
Log
°° 
.
°° 
Warning
°° 
(
°° 
$str
±± q
,
±±q r
operationName
²² !
,
²²! "
result
²²# )
.
²²) *
	UnwrapErr
²²* 3
(
²²3 4
)
²²4 5
.
²²5 6
Message
²²6 =
)
²²= >
;
²²> ?
Log
³³ 
.
³³ 
Debug
³³ 
(
³³ 
$str
³³ v
,
³³v w
operationName
´´ !
)
´´! "
;
´´" #
}
µµ 
return
·· 
result
·· 
;
·· 
}
¸¸ 	
catch
¹¹ 
(
¹¹ (
OperationCanceledException
¹¹ )
)
¹¹) *
when
¹¹+ /
(
¹¹0 1
cancellationToken
¹¹1 B
.
¹¹B C%
IsCancellationRequested
¹¹C Z
)
¹¹Z [
{
ºº 	#
StopTrackingOperation
»» !
(
»»! "
operationKey
»»" .
,
»». /
$str
»»0 E
)
»»E F
;
»»F G
return
¼¼ 
Result
¼¼ 
<
¼¼ 
	TResponse
¼¼ #
,
¼¼# $
NetworkFailure
¼¼% 3
>
¼¼3 4
.
¼¼4 5
Err
¼¼5 8
(
¼¼8 9
NetworkFailure
½½ 
.
½½  
OperationCancelled
½½ 1
(
½½1 2
$str
½½2 O
)
½½O P
)
½½P Q
;
½½Q R
}
¾¾ 	
catch
¿¿ 
(
¿¿ 
	Exception
¿¿ 
ex
¿¿ 
)
¿¿ 
{
ÀÀ 	
Log
ÁÁ 
.
ÁÁ 
Error
ÁÁ 
(
ÁÁ 
ex
ÁÁ 
,
ÁÁ 
$str
ÁÁ k
,
ÁÁk l
operationName
ÂÂ 
)
ÂÂ 
;
ÂÂ #
StopTrackingOperation
ÃÃ !
(
ÃÃ! "
operationKey
ÃÃ" .
,
ÃÃ. /
$"
ÃÃ0 2
$str
ÃÃ2 D
{
ÃÃD E
ex
ÃÃE G
.
ÃÃG H
Message
ÃÃH O
}
ÃÃO P
"
ÃÃP Q
)
ÃÃQ R
;
ÃÃR S
return
ÄÄ 
Result
ÄÄ 
<
ÄÄ 
	TResponse
ÄÄ #
,
ÄÄ# $
NetworkFailure
ÄÄ% 3
>
ÄÄ3 4
.
ÄÄ4 5
Err
ÄÄ5 8
(
ÄÄ8 9
NetworkFailure
ÅÅ 
.
ÅÅ %
DataCenterNotResponding
ÅÅ 6
(
ÅÅ6 7
$"
ÅÅ7 9
$str
ÅÅ9 K
{
ÅÅK L
ex
ÅÅL N
.
ÅÅN O
Message
ÅÅO V
}
ÅÅV W
"
ÅÅW X
)
ÅÅX Y
)
ÅÅY Z
;
ÅÅZ [
}
ÆÆ 	
}
ÇÇ 
public
ÉÉ 

void
ÉÉ #
MarkConnectionHealthy
ÉÉ %
(
ÉÉ% &
uint
ÉÉ& *
	connectId
ÉÉ+ 4
)
ÉÉ4 5
{
ÊÊ 
if
ËË 

(
ËË 
_isDisposed
ËË 
)
ËË 
{
ÌÌ 	
throw
ÍÍ 
new
ÍÍ %
ObjectDisposedException
ÍÍ -
(
ÍÍ- .
nameof
ÍÍ. 4
(
ÍÍ4 5
RetryStrategy
ÍÍ5 B
)
ÍÍB C
)
ÍÍC D
;
ÍÍD E
}
ÎÎ 	
Task
ÐÐ 
.
ÐÐ 
Run
ÐÐ 
(
ÐÐ 
async
ÐÐ 
(
ÐÐ 
)
ÐÐ 
=>
ÐÐ 
{
ÑÑ 	
if
ÒÒ 
(
ÒÒ 
_isDisposed
ÒÒ 
)
ÒÒ 
{
ÓÓ 
return
ÔÔ 
;
ÔÔ 
}
ÕÕ 
await
×× +
ResetExhaustedOperationsAsync
×× /
(
××/ 0
	connectId
××0 9
)
××9 :
.
××: ;
ConfigureAwait
××; I
(
××I J
false
××J O
)
××O P
;
××P Q
}
ØØ 	
)
ØØ	 

.
ØØ
 
ContinueWith
ØØ 
(
ØØ 
task
ØØ 
=>
ØØ 
{
ÙÙ 	
if
ÚÚ 
(
ÚÚ 
task
ÚÚ 
is
ÚÚ 
{
ÚÚ 
	IsFaulted
ÚÚ #
:
ÚÚ# $
true
ÚÚ% )
,
ÚÚ) *
	Exception
ÚÚ+ 4
:
ÚÚ4 5
not
ÚÚ6 9
null
ÚÚ: >
}
ÚÚ? @
)
ÚÚ@ A
{
ÛÛ 
Log
ÜÜ 
.
ÜÜ 
Error
ÜÜ 
(
ÜÜ 
task
ÜÜ 
.
ÜÜ 
	Exception
ÜÜ (
.
ÜÜ( )
GetBaseException
ÜÜ) 9
(
ÜÜ9 :
)
ÜÜ: ;
,
ÜÜ; <
$str
ÝÝ l
,
ÝÝl m
	connectId
ÞÞ 
)
ÞÞ 
;
ÞÞ 
}
ßß 
}
àà 	
,
àà	 
%
TaskContinuationOptions
àà "
.
àà" #
OnlyOnFaulted
àà# 0
)
àà0 1
;
àà1 2
}
áá 
private
ãã 
async
ãã 
Task
ãã +
ResetExhaustedOperationsAsync
ãã 4
(
ãã4 5
uint
ãã5 9
	connectId
ãã: C
)
ããC D
{
ää 
try
åå 
{
ææ 	
await
çç 

_stateLock
çç 
.
çç 
	WaitAsync
çç &
(
çç& '
)
çç' (
.
çç( )
ConfigureAwait
çç) 7
(
çç7 8
false
çç8 =
)
çç= >
;
çç> ?
try
èè 
{
éé 
int
êê 

resetCount
êê 
=
êê  *
ResetOperationsForConnection
êê! =
(
êê= >
	connectId
êê> G
)
êêG H
;
êêH I)
LogConnectionHealthRestored
ëë +
(
ëë+ ,
	connectId
ëë, 5
,
ëë5 6

resetCount
ëë7 A
)
ëëA B
;
ëëB C
}
ìì 
finally
íí 
{
îî 

_stateLock
ïï 
.
ïï 
Release
ïï "
(
ïï" #
)
ïï# $
;
ïï$ %
}
ðð 
}
ññ 	
catch
òò 
(
òò 
	Exception
òò 
ex
òò 
)
òò 
{
óó 	
Log
ôô 
.
ôô 
Error
ôô 
(
ôô 
ex
ôô 
,
ôô 
$str
ôô W
,
ôôW X
	connectId
ôôY b
)
ôôb c
;
ôôc d
}
õõ 	
}
öö 
private
øø 
int
øø *
ResetOperationsForConnection
øø ,
(
øø, -
uint
øø- 1
	connectId
øø2 ;
)
øø; <
{
ùù 
int
úú 

resetCount
úú 
=
úú 
$num
úú 
;
úú 
foreach
ûû 
(
ûû  
RetryOperationInfo
ûû #
	operation
ûû$ -
in
ûû. 0$
_activeRetryOperations
ûû1 G
.
ûûG H
Values
ûûH N
.
ûûN O
ToArray
ûûO V
(
ûûV W
)
ûûW X
)
ûûX Y
{
üü 	
if
ýý 
(
ýý 
	operation
ýý 
.
ýý 
	ConnectId
ýý #
==
ýý$ &
	connectId
ýý' 0
&&
ýý1 3
	operation
ýý4 =
.
ýý= >
IsExhausted
ýý> I
)
ýýI J
{
þþ 
	operation
ÿÿ 
.
ÿÿ 
IsExhausted
ÿÿ %
=
ÿÿ& '
false
ÿÿ( -
;
ÿÿ- .
	operation
€€ 
.
€€ 
CurrentRetryCount
€€ +
=
€€, -
$num
€€. /
;
€€/ 0#
StopTrackingOperation
 %
(
% &
	operation
& /
.
/ 0
	UniqueKey
0 9
,
9 :
$str
; P
)
P Q
;
Q R

resetCount
‚‚ 
++
‚‚ 
;
‚‚ 
}
ƒƒ 
}
„„ 	
return
…… 

resetCount
…… 
;
…… 
}
†† 
private
ˆˆ 
static
ˆˆ 
void
ˆˆ )
LogConnectionHealthRestored
ˆˆ 3
(
ˆˆ3 4
uint
ˆˆ4 8
	connectId
ˆˆ9 B
,
ˆˆB C
int
ˆˆD G

resetCount
ˆˆH R
)
ˆˆR S
{
‰‰ 
if
ŠŠ 

(
ŠŠ 

resetCount
ŠŠ 
>
ŠŠ 
$num
ŠŠ 
)
ŠŠ 
{
‹‹ 	
Log
ŒŒ 
.
ŒŒ 
Information
ŒŒ 
(
ŒŒ 
$str
 x
,
x y
	connectId
ŽŽ 
,
ŽŽ 

resetCount
ŽŽ %
)
ŽŽ% &
;
ŽŽ& '
}
 	
}
 
public
’’ 

void
’’ &
ClearExhaustedOperations
’’ (
(
’’( )
)
’’) *
{
““ 
if
”” 

(
”” 
_isDisposed
”” 
)
”” 
{
•• 	
throw
–– 
new
–– %
ObjectDisposedException
–– -
(
––- .
nameof
––. 4
(
––4 5
RetryStrategy
––5 B
)
––B C
)
––C D
;
––D E
}
—— 	
try
™™ 
{
šš 	
List
›› 
<
›› 
string
›› 
>
›› 
exhaustedKeys
›› &
=
››' (
[
››) *
]
››* +
;
››+ ,
exhaustedKeys
œœ 
.
œœ 
AddRange
œœ "
(
œœ" #
from
œœ# '
	operation
œœ( 1
in
œœ2 4$
_activeRetryOperations
œœ5 K
.
œœK L
Values
œœL R
where
 
	operation
 
.
  
IsExhausted
  +
select
žž 
	operation
žž  
.
žž  !
	UniqueKey
žž! *
)
žž* +
;
žž+ ,
foreach
   
(
   
string
   
key
   
in
    "
exhaustedKeys
  # 0
)
  0 1
{
¡¡ 
if
¢¢ 
(
¢¢ $
_activeRetryOperations
¢¢ *
.
¢¢* +
	TryRemove
¢¢+ 4
(
¢¢4 5
key
¢¢5 8
,
¢¢8 9
out
¢¢: = 
RetryOperationInfo
¢¢> P
?
¢¢P Q
	operation
¢¢R [
)
¢¢[ \
&&
¢¢] _
Log
££ 
.
££ 
	IsEnabled
££ !
(
££! "
LogEventLevel
££" /
.
££/ 0
Debug
££0 5
)
££5 6
)
££6 7
{
¤¤ 
Log
¥¥ 
.
¥¥ 
Debug
¥¥ 
(
¥¥ 
$str
¥¥ g
,
¥¥g h
	operation
¦¦ !
.
¦¦! "
OperationName
¦¦" /
)
¦¦/ 0
;
¦¦0 1
}
§§ 
}
¨¨ 
if
ªª 
(
ªª 
exhaustedKeys
ªª 
.
ªª 
Count
ªª #
>
ªª$ %
$num
ªª& '
)
ªª' (
{
«« 
Log
¬¬ 
.
¬¬ 
Information
¬¬ 
(
¬¬  
$str
¬¬  g
,
¬¬g h
exhaustedKeys
­­ !
.
­­! "
Count
­­" '
)
­­' (
;
­­( )
}
®® 
}
¯¯ 	
catch
°° 
(
°° 
	Exception
°° 
ex
°° 
)
°° 
{
±± 	
Log
²² 
.
²² 
Error
²² 
(
²² 
ex
²² 
,
²² 
$str
²² @
)
²²@ A
;
²²A B
}
³³ 	
}
´´ 
private
¶¶ 
async
¶¶ 
Task
¶¶ 
<
¶¶ 
bool
¶¶ 
>
¶¶ &
IsGloballyExhaustedAsync
¶¶ 5
(
¶¶5 6
RpcServiceType
¶¶6 D
?
¶¶D E
serviceType
¶¶F Q
=
¶¶R S
null
¶¶T X
)
¶¶X Y
{
·· 
if
¸¸ 

(
¸¸ $
_activeRetryOperations
¸¸ "
.
¸¸" #
IsEmpty
¸¸# *
)
¸¸* +
{
¹¹ 	
return
ºº 
false
ºº 
;
ºº 
}
»» 	
await
½½ 

_stateLock
½½ 
.
½½ 
	WaitAsync
½½ "
(
½½" #
)
½½# $
.
½½$ %
ConfigureAwait
½½% 3
(
½½3 4
false
½½4 9
)
½½9 :
;
½½: ;
try
¾¾ 
{
¿¿ 	
bool
ÀÀ (
hasAnyOperationsForService
ÀÀ +
=
ÀÀ, -
false
ÀÀ. 3
;
ÀÀ3 4
foreach
ÁÁ 
(
ÁÁ  
RetryOperationInfo
ÁÁ '
	operation
ÁÁ( 1
in
ÁÁ2 4$
_activeRetryOperations
ÁÁ5 K
.
ÁÁK L
Values
ÁÁL R
.
ÁÁR S
ToArray
ÁÁS Z
(
ÁÁZ [
)
ÁÁ[ \
)
ÁÁ\ ]
{
ÂÂ 
if
ÃÃ 
(
ÃÃ 
serviceType
ÃÃ 
.
ÃÃ  
HasValue
ÃÃ  (
&&
ÃÃ) +
	operation
ÃÃ, 5
.
ÃÃ5 6
ServiceType
ÃÃ6 A
!=
ÃÃB D
serviceType
ÃÃE P
.
ÃÃP Q
Value
ÃÃQ V
)
ÃÃV W
{
ÄÄ 
continue
ÅÅ 
;
ÅÅ 
}
ÆÆ (
hasAnyOperationsForService
ÈÈ *
=
ÈÈ+ ,
true
ÈÈ- 1
;
ÈÈ1 2
if
ÉÉ 
(
ÉÉ 
!
ÉÉ 
	operation
ÉÉ 
.
ÉÉ 
IsExhausted
ÉÉ *
)
ÉÉ* +
{
ÊÊ 
return
ËË 
false
ËË  
;
ËË  !
}
ÌÌ 
}
ÍÍ 
return
ÏÏ (
hasAnyOperationsForService
ÏÏ -
;
ÏÏ- .
}
ÐÐ 	
finally
ÑÑ 
{
ÒÒ 	

_stateLock
ÓÓ 
.
ÓÓ 
Release
ÓÓ 
(
ÓÓ 
)
ÓÓ  
;
ÓÓ  !
}
ÔÔ 	
}
ÕÕ 
private
×× 
async
×× 
Task
×× +
HandleManualRetryRequestAsync
×× 4
(
××4 5'
ManualRetryRequestedEvent
××5 N
evt
××O R
)
××R S
{
ØØ 
if
ÙÙ 

(
ÙÙ 
_isDisposed
ÙÙ 
)
ÙÙ 
{
ÚÚ 	
return
ÛÛ 
;
ÛÛ 
}
ÜÜ 	
try
ÞÞ 
{
ßß 	&
ClearExhaustedOperations
àà $
(
àà$ %
)
àà% &
;
àà& '
NetworkProvider
ââ 
networkProvider
ââ +
=
ââ, - 
GetNetworkProvider
ââ. @
(
ââ@ A
)
ââA B
;
ââB C
Result
ãã 
<
ãã 
Unit
ãã 
,
ãã 
NetworkFailure
ãã '
>
ãã' (
retryResult
ãã) 4
=
ãã5 6
await
ää 
networkProvider
ää %
.
ää% &'
ForceFreshConnectionAsync
ää& ?
(
ää? @
)
ää@ A
.
ääA B
ConfigureAwait
ääB P
(
ääP Q
false
ääQ V
)
ääV W
;
ääW X
if
ææ 
(
ææ 
retryResult
ææ 
.
ææ 
IsOk
ææ  
)
ææ  !
{
çç 
Log
èè 
.
èè 
Information
èè 
(
èè  
$str
èè  S
)
èèS T
;
èèT U&
NotifyConnectionRestored
éé (
(
éé( )
evt
éé) ,
.
éé, -
	ConnectId
éé- 6
)
éé6 7
;
éé7 8
}
êê 
else
ëë 
{
ìì 
NetworkFailure
íí 
failure
íí &
=
íí' (
retryResult
íí) 4
.
íí4 5
	UnwrapErr
íí5 >
(
íí> ?
)
íí? @
;
íí@ A
Log
îî 
.
îî 
Warning
îî 
(
îî 
$str
îî Q
,
îîQ R
failure
îîS Z
.
îîZ [
Message
îî[ b
)
îîb c
;
îîc d$
NotifyConnectionFailed
ïï &
(
ïï& '
failure
ïï' .
,
ïï. /
evt
ïï0 3
.
ïï3 4
	ConnectId
ïï4 =
)
ïï= >
;
ïï> ?
}
ðð 
}
ññ 	
catch
òò 
(
òò 
	Exception
òò 
ex
òò 
)
òò 
{
óó 	
Log
ôô 
.
ôô 
Error
ôô 
(
ôô 
ex
ôô 
,
ôô 
$str
ôô X
)
ôôX Y
;
ôôY Z
}
õõ 	
}
öö 
private
øø 
void
øø &
NotifyConnectionRestored
øø )
(
øø) *
uint
øø* .
?
øø. /
	connectId
øø0 9
)
øø9 :
{
ùù 

Dispatcher
úú 
.
úú 
UIThread
úú 
.
úú 
Post
úú  
(
úú  !
(
úú! "
)
úú" #
=>
úú$ &
{
ûû 	
try
üü 
{
ýý 
_
þþ 
=
þþ "
_connectivityService
þþ (
.
þþ( )
PublishAsync
þþ) 5
(
þþ5 6 
ConnectivityIntent
ÿÿ &
.
ÿÿ& '
	Connected
ÿÿ' 0
(
ÿÿ0 1
	connectId
€€ !
,
€€! " 
ConnectivityReason
 *
.
* +
ManualRetry
+ 6
)
6 7
)
7 8
.
8 9
ContinueWith
9 E
(
E F
task
‚‚ 
=>
‚‚ 
{
ƒƒ 
if
„„ 
(
„„ 
task
„„  
.
„„  !
	IsFaulted
„„! *
&&
„„+ -
task
„„. 2
.
„„2 3
	Exception
„„3 <
!=
„„= ?
null
„„@ D
)
„„D E
{
…… 
Log
†† 
.
††  
Error
††  %
(
††% &
task
††& *
.
††* +
	Exception
††+ 4
,
††4 5
$str
††6 j
)
††j k
;
††k l
}
‡‡ 
}
ˆˆ 
,
ˆˆ 
TaskScheduler
‰‰ !
.
‰‰! "
Default
‰‰" )
)
‰‰) *
;
‰‰* +
}
ŠŠ 
catch
‹‹ 
(
‹‹ 
	Exception
‹‹ 
ex
‹‹ 
)
‹‹  
{
ŒŒ 
Log
 
.
 
Error
 
(
 
ex
 
,
 
$str
 P
)
P Q
;
Q R
}
ŽŽ 
}
 	
)
	 

;

 
}
 
private
’’ 
void
’’ $
NotifyConnectionFailed
’’ '
(
’’' (
NetworkFailure
’’( 6
failure
’’7 >
,
’’> ?
uint
’’@ D
?
’’D E
	connectId
’’F O
)
’’O P
{
““ 

Dispatcher
”” 
.
”” 
UIThread
”” 
.
”” 
Post
””  
(
””  !
(
””! "
)
””" #
=>
””$ &
{
•• 	
try
–– 
{
—— 
_
˜˜ 
=
˜˜ "
_connectivityService
˜˜ (
.
˜˜( )
PublishAsync
˜˜) 5
(
˜˜5 6 
ConnectivityIntent
™™ &
.
™™& '
Disconnected
™™' 3
(
™™3 4
failure
™™4 ;
,
™™; <
	connectId
™™= F
)
™™F G
)
™™G H
.
™™H I
ContinueWith
™™I U
(
™™U V
task
šš 
=>
šš 
{
›› 
if
œœ 
(
œœ 
task
œœ  
.
œœ  !
	IsFaulted
œœ! *
&&
œœ+ -
task
œœ. 2
.
œœ2 3
	Exception
œœ3 <
!=
œœ= ?
null
œœ@ D
)
œœD E
{
 
Log
žž 
.
žž  
Error
žž  %
(
žž% &
task
žž& *
.
žž* +
	Exception
žž+ 4
,
žž4 5
$str
žž6 i
)
žži j
;
žžj k
}
ŸŸ 
}
   
,
   
TaskScheduler
¡¡ !
.
¡¡! "
Default
¡¡" )
)
¡¡) *
;
¡¡* +
}
¢¢ 
catch
££ 
(
££ 
	Exception
££ 
ex
££ 
)
££  
{
¤¤ 
Log
¥¥ 
.
¥¥ 
Error
¥¥ 
(
¥¥ 
ex
¥¥ 
,
¥¥ 
$str
¥¥ I
)
¥¥I J
;
¥¥J K
}
¦¦ 
}
§§ 	
)
§§	 

;
§§
 
}
¨¨ 
private
ªª 
void
ªª $
StartTrackingOperation
ªª '
(
ªª' (
string
ªª( .
operationName
ªª/ <
,
ªª< =
uint
ªª> B
	connectId
ªªC L
,
ªªL M
int
ªªN Q

maxRetries
ªªR \
,
ªª\ ]
string
ªª^ d
operationKey
ªªe q
,
ªªq r
RpcServiceType
«« 
?
«« 
serviceType
«« #
)
««# $
{
¬¬ 
if
­­ 

(
­­ $
_activeRetryOperations
­­ "
.
­­" #
Count
­­# (
>=
­­) +$
MAX_TRACKED_OPERATIONS
­­, B
)
­­B C
{
®® 	
Log
¯¯ 
.
¯¯ 
Warning
¯¯ 
(
¯¯ 
$str
¯¯ p
,
¯¯p q$
MAX_TRACKED_OPERATIONS
°° &
)
°°& '
;
°°' ((
CleanupAbandonedOperations
±± &
(
±±& '
null
±±' +
)
±±+ ,
;
±±, -
}
²² 	 
RetryOperationInfo
´´ 
operationInfo
´´ (
=
´´) *
new
´´+ .
(
´´. /
)
´´/ 0
{
µµ 	
OperationName
¶¶ 
=
¶¶ 
operationName
¶¶ )
,
¶¶) *
	ConnectId
·· 
=
·· 
	connectId
·· !
,
··! "
	StartTime
¸¸ 
=
¸¸ 
DateTime
¸¸  
.
¸¸  !
UtcNow
¸¸! '
,
¸¸' (

MaxRetries
¹¹ 
=
¹¹ 

maxRetries
¹¹ #
,
¹¹# $
	UniqueKey
ºº 
=
ºº 
operationKey
ºº $
,
ºº$ %
ServiceType
»» 
=
»» 
serviceType
»» %
,
»»% &
CurrentRetryCount
¼¼ 
=
¼¼ 
$num
¼¼  !
,
¼¼! "
IsExhausted
½½ 
=
½½ 
false
½½ 
}
¾¾ 	
;
¾¾	 
$
_activeRetryOperations
ÀÀ 
.
ÀÀ 
TryAdd
ÀÀ %
(
ÀÀ% &
operationKey
ÀÀ& 2
,
ÀÀ2 3
operationInfo
ÀÀ4 A
)
ÀÀA B
;
ÀÀB C
Log
ÁÁ 
.
ÁÁ 
Debug
ÁÁ 
(
ÁÁ 
$strÂÂ ª
,ÂÂª «
operationName
ÃÃ 
,
ÃÃ 
serviceType
ÃÃ &
?
ÃÃ& '
.
ÃÃ' (
ToString
ÃÃ( 0
(
ÃÃ0 1
)
ÃÃ1 2
??
ÃÃ3 5
$str
ÃÃ6 ?
,
ÃÃ? @
	connectId
ÃÃA J
,
ÃÃJ K
operationKey
ÃÃL X
,
ÃÃX Y$
_activeRetryOperations
ÃÃZ p
.
ÃÃp q
Count
ÃÃq v
)
ÃÃv w
;
ÃÃw x
}
ÄÄ 
private
ÆÆ 
void
ÆÆ '
UpdateOperationRetryCount
ÆÆ *
(
ÆÆ* +
string
ÆÆ+ 1
operationKey
ÆÆ2 >
,
ÆÆ> ?
int
ÆÆ@ C

retryCount
ÆÆD N
)
ÆÆN O
{
ÇÇ 
if
ÈÈ 

(
ÈÈ $
_activeRetryOperations
ÈÈ "
.
ÈÈ" #
TryGetValue
ÈÈ# .
(
ÈÈ. /
operationKey
ÈÈ/ ;
,
ÈÈ; <
out
ÈÈ= @ 
RetryOperationInfo
ÈÈA S
?
ÈÈS T
	operation
ÈÈU ^
)
ÈÈ^ _
)
ÈÈ_ `
{
ÉÉ 	
	operation
ÊÊ 
.
ÊÊ 
CurrentRetryCount
ÊÊ '
=
ÊÊ( )

retryCount
ÊÊ* 4
;
ÊÊ4 5
Log
ËË 
.
ËË 
Debug
ËË 
(
ËË 
$str
ËË i
,
ËËi j
operationKey
ÌÌ 
,
ÌÌ 

retryCount
ÌÌ (
,
ÌÌ( )
	operation
ÌÌ* 3
.
ÌÌ3 4

MaxRetries
ÌÌ4 >
)
ÌÌ> ?
;
ÌÌ? @
}
ÍÍ 	
}
ÎÎ 
private
ÐÐ 
void
ÐÐ #
StopTrackingOperation
ÐÐ &
(
ÐÐ& '
string
ÐÐ' -
operationKey
ÐÐ. :
,
ÐÐ: ;
string
ÐÐ< B
reason
ÐÐC I
)
ÐÐI J
{
ÑÑ 
if
ÒÒ 

(
ÒÒ $
_activeRetryOperations
ÒÒ "
.
ÒÒ" #
	TryRemove
ÒÒ# ,
(
ÒÒ, -
operationKey
ÒÒ- 9
,
ÒÒ9 :
out
ÒÒ; > 
RetryOperationInfo
ÒÒ? Q
?
ÒÒQ R
	operation
ÒÒS \
)
ÒÒ\ ]
)
ÒÒ] ^
{
ÓÓ 	
Log
ÔÔ 
.
ÔÔ 
Debug
ÔÔ 
(
ÔÔ 
$strÕÕ ˜
,ÕÕ˜ ™
	operation
ÖÖ 
.
ÖÖ 
OperationName
ÖÖ '
,
ÖÖ' (
	operation
ÖÖ) 2
.
ÖÖ2 3
	ConnectId
ÖÖ3 <
,
ÖÖ< =
reason
ÖÖ> D
,
ÖÖD E$
_activeRetryOperations
ÖÖF \
.
ÖÖ\ ]
Count
ÖÖ] b
)
ÖÖb c
;
ÖÖc d
}
×× 	
}
ØØ 
private
ÚÚ 
void
ÚÚ &
MarkOperationAsExhausted
ÚÚ )
(
ÚÚ) *
string
ÚÚ* 0
operationKey
ÚÚ1 =
)
ÚÚ= >
{
ÛÛ 
if
ÜÜ 

(
ÜÜ $
_activeRetryOperations
ÜÜ "
.
ÜÜ" #
TryGetValue
ÜÜ# .
(
ÜÜ. /
operationKey
ÜÜ/ ;
,
ÜÜ; <
out
ÜÜ= @ 
RetryOperationInfo
ÜÜA S
?
ÜÜS T
	operation
ÜÜU ^
)
ÜÜ^ _
)
ÜÜ_ `
{
ÝÝ 	
	operation
ÞÞ 
.
ÞÞ 
IsExhausted
ÞÞ !
=
ÞÞ" #
true
ÞÞ$ (
;
ÞÞ( )
Log
ßß 
.
ßß 
Debug
ßß 
(
ßß 
$str
àà r
,
ààr s
	operation
áá 
.
áá 
OperationName
áá '
,
áá' (
	operation
áá) 2
.
áá2 3
	ConnectId
áá3 <
,
áá< =
operationKey
áá> J
)
ááJ K
;
ááK L
}
ââ 	
}
ãã 
private
åå 
void
åå (
CleanupAbandonedOperations
åå +
(
åå+ ,
object
åå, 2
?
åå2 3
state
åå4 9
)
åå9 :
{
ææ 
if
çç 

(
çç 
_isDisposed
çç 
)
çç 
{
èè 	
return
éé 
;
éé 
}
êê 	
try
ìì 
{
íí 	
DateTime
îî 
cutoff
îî 
=
îî 
DateTime
îî &
.
îî& '
UtcNow
îî' -
.
îî- .

AddMinutes
îî. 8
(
îî8 9
-
îî9 :'
OPERATION_TIMEOUT_MINUTES
îî: S
)
îîS T
;
îîT U
List
ïï 
<
ïï 
string
ïï 
>
ïï 
abandonedKeys
ïï &
=
ïï' (
new
ïï) ,
(
ïï, -
)
ïï- .
;
ïï. /
foreach
ðð 
(
ðð  
RetryOperationInfo
ðð '
	operation
ðð( 1
in
ðð2 4$
_activeRetryOperations
ðð5 K
.
ððK L
Values
ððL R
.
ððR S
ToArray
ððS Z
(
ððZ [
)
ðð[ \
)
ðð\ ]
{
ññ 
if
òò 
(
òò 
	operation
òò 
.
òò 
	StartTime
òò '
<
òò( )
cutoff
òò* 0
)
òò0 1
{
óó 
abandonedKeys
ôô !
.
ôô! "
Add
ôô" %
(
ôô% &
	operation
ôô& /
.
ôô/ 0
	UniqueKey
ôô0 9
)
ôô9 :
;
ôô: ;
}
õõ 
}
öö 
foreach
øø 
(
øø 
string
øø 
key
øø 
in
øø  "
abandonedKeys
øø# 0
)
øø0 1
{
ùù 
if
úú 
(
úú $
_activeRetryOperations
úú *
.
úú* +
	TryRemove
úú+ 4
(
úú4 5
key
úú5 8
,
úú8 9
out
úú: = 
RetryOperationInfo
úú> P
?
úúP Q
	operation
úúR [
)
úú[ \
&&
úú] _
Serilog
ûû 
.
ûû 
Log
ûû 
.
ûû  
	IsEnabled
ûû  )
(
ûû) *
LogEventLevel
ûû* 7
.
ûû7 8
Debug
ûû8 =
)
ûû= >
)
ûû> ?
{
üü 
Log
ýý 
.
ýý 
Debug
ýý 
(
ýý 
$str
ýý o
,
ýýo p
	operation
þþ !
.
þþ! "
OperationName
þþ" /
,
þþ/ 0'
OPERATION_TIMEOUT_MINUTES
þþ1 J
)
þþJ K
;
þþK L
}
ÿÿ 
}
€€ 
if
‚‚ 
(
‚‚ 
abandonedKeys
‚‚ 
.
‚‚ 
Count
‚‚ #
>
‚‚$ %
$num
‚‚& '
)
‚‚' (
{
ƒƒ 
Log
„„ 
.
„„ 
Information
„„ 
(
„„  
$str
„„  `
,
„„` a
abandonedKeys
„„b o
.
„„o p
Count
„„p u
)
„„u v
;
„„v w
}
…… 
}
†† 	
catch
‡‡ 
(
‡‡ 
	Exception
‡‡ 
ex
‡‡ 
)
‡‡ 
{
ˆˆ 	
Log
‰‰ 
.
‰‰ 
Error
‰‰ 
(
‰‰ 
ex
‰‰ 
,
‰‰ 
$str
‰‰ :
)
‰‰: ;
;
‰‰; <
}
ŠŠ 	
}
‹‹ 
private
 
static
 
string
 "
CreateDelaysCacheKey
 .
(
. /
int
/ 2

maxRetries
3 =
)
= >
=>
? A
$"
B D
$str
D K
{
K L

maxRetries
L V
}
V W
"
W X
;
X Y
private
 
TimeSpan
 
[
 
]
 $
GetOrCreateRetryDelays
 -
(
- .
int
. 1

maxRetries
2 <
)
< =
{
 
string
‘‘ 
cacheKey
‘‘ 
=
‘‘ "
CreateDelaysCacheKey
‘‘ .
(
‘‘. /

maxRetries
‘‘/ 9
)
‘‘9 :
;
‘‘: ;
if
““ 

(
““ 
_pipelineCache
““ 
.
““ 
TryGetValue
““ &
(
““& '
cacheKey
““' /
,
““/ 0
out
““1 4
object
““5 ;
?
““; <
cachedDelays
““= I
)
““I J
&&
““K M
cachedDelays
““N Z
is
““[ ]
TimeSpan
““^ f
[
““f g
]
““g h
delays
““i o
)
““o p
{
”” 	
if
•• 
(
•• 
Log
•• 
.
•• 
	IsEnabled
•• 
(
•• 
LogEventLevel
•• +
.
••+ ,
Debug
••, 1
)
••1 2
)
••2 3
{
–– 
Log
—— 
.
—— 
Debug
—— 
(
—— 
$str
—— i
,
——i j

maxRetries
˜˜ 
)
˜˜ 
;
˜˜  
}
™™ 
return
›› 
delays
›› 
;
›› 
}
œœ 	
if
žž 

(
žž 
Log
žž 
.
žž 
	IsEnabled
žž 
(
žž 
LogEventLevel
žž '
.
žž' (
Debug
žž( -
)
žž- .
)
žž. /
{
ŸŸ 	
Log
   
.
   
Debug
   
(
   
$str
   h
,
  h i

maxRetries
¡¡ 
)
¡¡ 
;
¡¡ 
}
¢¢ 	
TimeSpan
¤¤ 
	baseDelay
¤¤ 
=
¤¤ $
_strategyConfiguration
¤¤ 3
.
¤¤3 4!
INITIAL_RETRY_DELAY
¤¤4 G
;
¤¤G H
TimeSpan
¥¥ 
maxDelay
¥¥ 
=
¥¥ $
_strategyConfiguration
¥¥ 2
.
¥¥2 3
MAX_RETRY_DELAY
¥¥3 B
;
¥¥B C
bool
¦¦ 
	useJitter
¦¦ 
=
¦¦ $
_strategyConfiguration
¦¦ /
.
¦¦/ 0 
USE_ADAPTIVE_RETRY
¦¦0 B
;
¦¦B C
IEnumerable
¨¨ 
<
¨¨ 
TimeSpan
¨¨ 
>
¨¨ 
	rawDelays
¨¨ '
=
¨¨( )
	useJitter
¨¨* 3
?
©© 
Backoff
©© 
.
©© )
DecorrelatedJitterBackoffV2
©© 1
(
©©1 2#
medianFirstRetryDelay
ªª %
:
ªª% &
	baseDelay
ªª' 0
,
ªª0 1

retryCount
«« 
:
«« 

maxRetries
«« &
,
««& '
	fastFirst
¬¬ 
:
¬¬ 
true
¬¬ 
)
¬¬  
:
­­ 
Backoff
­­ 
.
­­  
ExponentialBackoff
­­ (
(
­­( )
initialDelay
®® 
:
®® 
	baseDelay
®® '
,
®®' (

retryCount
¯¯ 
:
¯¯ 

maxRetries
¯¯ &
,
¯¯& '
factor
°° 
:
°° 
$num
°° 
,
°° 
	fastFirst
±± 
:
±± 
true
±± 
)
±±  
;
±±  !
TimeSpan
³³ 
[
³³ 
]
³³ 
retryDelays
³³ 
=
³³  
	rawDelays
³³! *
.
³³* +
Select
³³+ 1
(
³³1 2
delay
³³2 7
=>
³³8 :
delay
´´ 
>
´´ 
maxDelay
´´ 
?
´´ 
maxDelay
´´ '
:
´´( )
delay
´´* /
)
´´/ 0
.
´´0 1
ToArray
´´1 8
(
´´8 9
)
´´9 :
;
´´: ;
_pipelineCache
¶¶ 
.
¶¶ 
TryAdd
¶¶ 
(
¶¶ 
cacheKey
¶¶ &
,
¶¶& '
retryDelays
¶¶( 3
)
¶¶3 4
;
¶¶4 5
return
¸¸ 
retryDelays
¸¸ 
;
¸¸ 
}
¹¹ 
private
»» 
IAsyncPolicy
»» 
<
»» 
Result
»» 
<
»»  
	TResponse
»»  )
,
»») *
NetworkFailure
»»+ 9
>
»»9 :
>
»»: ;$
CreateTypedRetryPolicy
»»< R
<
»»R S
	TResponse
»»S \
>
»»\ ]
(
»»] ^
int
¼¼ 

maxRetries
¼¼ 
,
¼¼ 
string
½½ 
operationKey
½½ 
,
½½ 
string
¾¾ 
operationName
¾¾ 
,
¾¾ 
uint
¿¿ 
	connectId
¿¿ 
,
¿¿ 
RpcServiceType
ÀÀ 
?
ÀÀ 
serviceType
ÀÀ #
,
ÀÀ# $
CancellationToken
ÁÁ 
cancellationToken
ÁÁ +
)
ÁÁ+ ,
{
ÂÂ 
TimeSpan
ÃÃ 
[
ÃÃ 
]
ÃÃ 
retryDelays
ÃÃ 
=
ÃÃ  $
GetOrCreateRetryDelays
ÃÃ! 7
(
ÃÃ7 8

maxRetries
ÃÃ8 B
)
ÃÃB C
;
ÃÃC D!
ShouldRetryDelegate
ÅÅ 
<
ÅÅ 
	TResponse
ÅÅ %
>
ÅÅ% &!
shouldRetryDelegate
ÆÆ 
=
ÆÆ  !"
RetryDecisionFactory
ÆÆ" 6
.
ÆÆ6 7'
CreateShouldRetryDelegate
ÆÆ7 P
<
ÆÆP Q
	TResponse
ÆÆQ Z
>
ÆÆZ [
(
ÆÆ[ \
)
ÆÆ\ ]
;
ÆÆ] ^0
"RequiresConnectionRecoveryDelegate
ÇÇ *
<
ÇÇ* +
	TResponse
ÇÇ+ 4
>
ÇÇ4 5(
connectionRecoveryDelegate
ÇÇ6 P
=
ÇÇQ R"
RetryDecisionFactory
ÈÈ  
.
ÈÈ  !.
 CreateConnectionRecoveryDelegate
ÈÈ! A
<
ÈÈA B
	TResponse
ÈÈB K
>
ÈÈK L
(
ÈÈL M
)
ÈÈM N
;
ÈÈN O
IAsyncPolicy
ÊÊ 
<
ÊÊ 
Result
ÊÊ 
<
ÊÊ 
	TResponse
ÊÊ %
,
ÊÊ% &
NetworkFailure
ÊÊ' 5
>
ÊÊ5 6
>
ÊÊ6 7
retryPolicy
ÊÊ8 C
=
ÊÊD E
Policy
ÊÊF L
<
ÊÊL M
Result
ÊÊM S
<
ÊÊS T
	TResponse
ÊÊT ]
,
ÊÊ] ^
NetworkFailure
ÊÊ_ m
>
ÊÊm n
>
ÊÊn o
.
ËË 
Handle
ËË 
<
ËË &
TimeoutRejectedException
ËË ,
>
ËË, -
(
ËË- .
)
ËË. /
.
ÌÌ 
OrResult
ÌÌ 
(
ÌÌ 
result
ÌÌ 
=>
ÌÌ !
shouldRetryDelegate
ÌÌ  3
(
ÌÌ3 4
result
ÌÌ4 :
)
ÌÌ: ;
)
ÌÌ; <
.
ÍÍ 
WaitAndRetryAsync
ÍÍ 
(
ÍÍ 
retryDelays
ÎÎ 
,
ÎÎ 
async
ÏÏ 
(
ÏÏ 
outcome
ÏÏ 
,
ÏÏ 
delay
ÏÏ  %
,
ÏÏ% &

retryCount
ÏÏ' 1
,
ÏÏ1 2
context
ÏÏ3 :
)
ÏÏ: ;
=>
ÏÏ< >
{
ÐÐ 
context
ÑÑ 
[
ÑÑ 
ATTEMPT_KEY
ÑÑ '
]
ÑÑ' (
=
ÑÑ) *

retryCount
ÑÑ+ 5
+
ÑÑ6 7
$num
ÑÑ8 9
;
ÑÑ9 :
bool
ÓÓ 
	isTimeout
ÓÓ "
=
ÓÓ# $
outcome
ÓÓ% ,
.
ÓÓ, -
	Exception
ÓÓ- 6
is
ÓÓ7 9&
TimeoutRejectedException
ÓÓ: R
;
ÓÓR S
bool
ÔÔ 
	hasResult
ÔÔ "
=
ÔÔ# $
outcome
ÔÔ% ,
.
ÔÔ, -
	Exception
ÔÔ- 6
is
ÔÔ7 9
null
ÔÔ: >
;
ÔÔ> ?
Result
ÕÕ 
<
ÕÕ 
	TResponse
ÕÕ $
,
ÕÕ$ %
NetworkFailure
ÕÕ& 4
>
ÕÕ4 5
result
ÕÕ6 <
=
ÕÕ= >
	hasResult
ÕÕ? H
?
ÕÕI J
outcome
ÕÕK R
.
ÕÕR S
Result
ÕÕS Y
:
ÕÕZ [
default
ÕÕ\ c
;
ÕÕc d
LogRetryAttempt
×× #
(
××# $
	isTimeout
××$ -
,
××- .
operationName
××/ <
,
××< =
	connectId
××> G
,
××G H

retryCount
××I S
,
××S T
retryDelays
××U `
.
××` a
Length
××a g
,
××g h
delay
××i n
)
××n o
;
××o p!
TrackRetryOperation
ÙÙ '
(
ÙÙ' (

retryCount
ÙÙ( 2
,
ÙÙ2 3
operationName
ÙÙ4 A
,
ÙÙA B
	connectId
ÙÙC L
,
ÙÙL M
retryDelays
ÙÙN Y
.
ÙÙY Z
Length
ÙÙZ `
,
ÙÙ` a
operationKey
ÙÙb n
,
ÙÙn o
serviceType
ÚÚ #
)
ÚÚ# $
;
ÚÚ$ %
NetworkFailure
ÜÜ "
?
ÜÜ" #
currentFailure
ÜÜ$ 2
=
ÜÜ3 4#
ExtractCurrentFailure
ÜÜ5 J
(
ÜÜJ K
	isTimeout
ÜÜK T
,
ÜÜT U
	hasResult
ÜÜV _
,
ÜÜ_ `
result
ÜÜa g
)
ÜÜg h
;
ÜÜh i
await
ÞÞ "
_connectivityService
ÞÞ .
.
ÞÞ. /
PublishAsync
ÞÞ/ ;
(
ÞÞ; < 
ConnectivityIntent
ßß .
.
ßß. /

Recovering
ßß/ 9
(
ßß9 :
currentFailure
àà  .
??
àà/ 1
NetworkFailure
àà2 @
.
àà@ A%
DataCenterNotResponding
ààA X
(
ààX Y
$str
ààY m
)
ààm n
,
ààn o
	connectId
áá  )
,
áá) *

retryCount
áá+ 5
+
áá6 7
$num
áá8 9
,
áá9 :
delay
áá; @
)
áá@ A
)
ááA B
.
ââ 
ConfigureAwait
ââ '
(
ââ' (
false
ââ( -
)
ââ- .
;
ââ. /
if
ää 
(
ää 

retryCount
ää "
==
ää# %
retryDelays
ää& 1
.
ää1 2
Length
ää2 8
)
ää8 9
{
åå 
await
ææ )
HandleRetriesExhaustedAsync
ææ 9
(
ææ9 :
operationKey
çç  ,
,
çç, -
operationName
çç. ;
,
çç; <
	connectId
çç= F
,
ççF G

retryCount
ççH R
,
ççR S
retryDelays
ççT _
.
çç_ `
Length
çç` f
,
ççf g
currentFailure
ççh v
)
ççv w
.
èè 
ConfigureAwait
èè +
(
èè+ ,
false
èè, 1
)
èè1 2
;
èè2 3
}
éé 
bool
ëë 
requiresRecovery
ëë )
=
ëë* +)
DetermineIfRecoveryRequired
ìì 3
(
ìì3 4
	isTimeout
ìì4 =
,
ìì= >
	hasResult
ìì? H
,
ììH I
result
ììJ P
,
ììP Q(
connectionRecoveryDelegate
ììR l
)
ììl m
;
ììm n
if
îî 
(
îî 
requiresRecovery
îî (
&&
îî) +
!
îî, -
_isDisposed
îî- 8
&&
îî9 ;
!
îî< =
cancellationToken
îî= N
.
îîN O%
IsCancellationRequested
îîO f
)
îîf g
{
ïï 
await
ðð '
EnsureSecrecyChannelAsync
ðð 7
(
ðð7 8
	connectId
ðð8 A
,
ððA B
cancellationToken
ððC T
)
ððT U
.
ððU V
ConfigureAwait
ððV d
(
ððd e
false
ððe j
)
ððj k
;
ððk l
}
ññ 
}
òò 
)
òò 
;
òò 
IAsyncPolicy
ôô 
<
ôô 
Result
ôô 
<
ôô 
	TResponse
ôô %
,
ôô% &
NetworkFailure
ôô' 5
>
ôô5 6
>
ôô6 7
timeoutPolicy
ôô8 E
=
ôôF G!
CreateTimeoutPolicy
õõ 
<
õõ  
	TResponse
õõ  )
>
õõ) *
(
õõ* +
operationName
õõ+ 8
,
õõ8 9
	connectId
õõ: C
)
õõC D
;
õõD E
IAsyncPolicy
÷÷ 
<
÷÷ 
Result
÷÷ 
<
÷÷ 
	TResponse
÷÷ %
,
÷÷% &
NetworkFailure
÷÷' 5
>
÷÷5 6
>
÷÷6 7
combinedPolicy
÷÷8 F
=
÷÷G H
Policy
øø 
.
øø 
	WrapAsync
øø 
(
øø 
retryPolicy
øø (
,
øø( )
timeoutPolicy
øø* 7
)
øø7 8
;
øø8 9
return
úú 
combinedPolicy
úú 
;
úú 
}
ûû 
private
ýý 
static
ýý 
void
ýý 
LogRetryAttempt
ýý '
(
ýý' (
bool
þþ 
	isTimeout
þþ 
,
þþ 
string
ÿÿ 
operationName
ÿÿ 
,
ÿÿ 
uint
€€ 
	connectId
€€ 
,
€€ 
int
 

retryCount
 
,
 
int
‚‚ 

maxRetries
‚‚ 
,
‚‚ 
TimeSpan
ƒƒ 
delay
ƒƒ 
)
ƒƒ 
{
„„ 
if
…… 

(
…… 
	isTimeout
…… 
)
…… 
{
†† 	
Log
‡‡ 
.
‡‡ 
Warning
‡‡ 
(
‡‡ 
$strˆˆ š
,ˆˆš ›
operationName
‰‰ 
,
‰‰ 
	connectId
‰‰ (
,
‰‰( )

retryCount
‰‰* 4
,
‰‰4 5

maxRetries
‰‰6 @
,
‰‰@ A
delay
‰‰B G
.
‰‰G H
TotalMilliseconds
‰‰H Y
)
‰‰Y Z
;
‰‰Z [
}
ŠŠ 	
else
‹‹ 
{
ŒŒ 	
Log
 
.
 
Information
 
(
 
$strŽŽ 
,ŽŽ 
operationName
 
,
 
	connectId
 (
,
( )

retryCount
* 4
,
4 5

maxRetries
6 @
,
@ A
delay
B G
.
G H
TotalMilliseconds
H Y
)
Y Z
;
Z [
}
 	
}
‘‘ 
private
““ 
void
““ !
TrackRetryOperation
““ $
(
““$ %
int
”” 

retryCount
”” 
,
”” 
string
•• 
operationName
•• 
,
•• 
uint
–– 
	connectId
–– 
,
–– 
int
—— 

maxRetries
—— 
,
—— 
string
˜˜ 
operationKey
˜˜ 
,
˜˜ 
RpcServiceType
™™ 
?
™™ 
serviceType
™™ #
)
™™# $
{
šš 
if
›› 

(
›› 

retryCount
›› 
==
›› 
$num
›› 
)
›› 
{
œœ 	$
StartTrackingOperation
 "
(
" #
operationName
# 0
,
0 1
	connectId
2 ;
,
; <

maxRetries
= G
,
G H
operationKey
I U
,
U V
serviceType
W b
)
b c
;
c d
}
žž 	
else
ŸŸ 
{
   	'
UpdateOperationRetryCount
¡¡ %
(
¡¡% &
operationKey
¡¡& 2
,
¡¡2 3

retryCount
¡¡4 >
)
¡¡> ?
;
¡¡? @
}
¢¢ 	
}
££ 
private
¥¥ 
static
¥¥ 
NetworkFailure
¥¥ !
?
¥¥! "#
ExtractCurrentFailure
¥¥# 8
<
¥¥8 9
	TResponse
¥¥9 B
>
¥¥B C
(
¥¥C D
bool
¦¦ 
	isTimeout
¦¦ 
,
¦¦ 
bool
§§ 
	hasResult
§§ 
,
§§ 
Result
¨¨ 
<
¨¨ 
	TResponse
¨¨ 
,
¨¨ 
NetworkFailure
¨¨ (
>
¨¨( )
result
¨¨* 0
)
¨¨0 1
{
©© 
if
ªª 

(
ªª 
	hasResult
ªª 
&&
ªª 
result
ªª 
.
ªª  
IsErr
ªª  %
)
ªª% &
{
«« 	
return
¬¬ 
result
¬¬ 
.
¬¬ 
	UnwrapErr
¬¬ #
(
¬¬# $
)
¬¬$ %
;
¬¬% &
}
­­ 	
if
¯¯ 

(
¯¯ 
	isTimeout
¯¯ 
)
¯¯ 
{
°° 	
return
±± 
NetworkFailure
±± !
.
±±! "%
DataCenterNotResponding
±±" 9
(
±±9 :
$str
±±: M
)
±±M N
;
±±N O
}
²² 	
return
´´ 
null
´´ 
;
´´ 
}
µµ 
private
·· 
async
·· 
Task
·· )
HandleRetriesExhaustedAsync
·· 2
(
··2 3
string
¸¸ 
operationKey
¸¸ 
,
¸¸ 
string
¹¹ 
operationName
¹¹ 
,
¹¹ 
uint
ºº 
	connectId
ºº 
,
ºº 
int
»» 

retryCount
»» 
,
»» 
int
¼¼ 

maxRetries
¼¼ 
,
¼¼ 
NetworkFailure
½½ 
?
½½ 
currentFailure
½½ &
)
½½& '
{
¾¾ 
Log
¿¿ 
.
¿¿ 
Warning
¿¿ 
(
¿¿ 
$strÀÀ –
,ÀÀ– —
operationName
ÁÁ 
,
ÁÁ 
	connectId
ÁÁ $
,
ÁÁ$ %

retryCount
ÁÁ& 0
,
ÁÁ0 1

maxRetries
ÁÁ2 <
)
ÁÁ< =
;
ÁÁ= >&
MarkOperationAsExhausted
ÃÃ  
(
ÃÃ  !
operationKey
ÃÃ! -
)
ÃÃ- .
;
ÃÃ. /
NetworkProvider
ÅÅ 
?
ÅÅ 
networkProvider
ÅÅ (
=
ÅÅ) * 
GetNetworkProvider
ÅÅ+ =
(
ÅÅ= >
)
ÅÅ> ?
;
ÅÅ? @
networkProvider
ÆÆ 
?
ÆÆ 
.
ÆÆ 2
$BeginSecrecyChannelEstablishRecovery
ÆÆ =
(
ÆÆ= >
)
ÆÆ> ?
;
ÆÆ? @
bool
ÈÈ 
allExhausted
ÈÈ 
=
ÈÈ 
await
ÈÈ !&
IsGloballyExhaustedAsync
ÈÈ" :
(
ÈÈ: ;
)
ÈÈ; <
.
ÈÈ< =
ConfigureAwait
ÈÈ= K
(
ÈÈK L
false
ÈÈL Q
)
ÈÈQ R
;
ÈÈR S
if
ÉÉ 

(
ÉÉ 
allExhausted
ÉÉ 
)
ÉÉ 
{
ÊÊ 	(
PublishAllRetriesExhausted
ËË &
(
ËË& '
	connectId
ËË' 0
,
ËË0 1

retryCount
ËË2 <
,
ËË< =
currentFailure
ËË> L
)
ËËL M
;
ËËM N
}
ÌÌ 	
else
ÍÍ 
{
ÎÎ 	%
HandlePartialExhaustion
ÏÏ #
(
ÏÏ# $
	connectId
ÏÏ$ -
,
ÏÏ- .
currentFailure
ÏÏ/ =
)
ÏÏ= >
;
ÏÏ> ?
}
ÐÐ 	
}
ÑÑ 
private
ÓÓ 
void
ÓÓ (
PublishAllRetriesExhausted
ÓÓ +
(
ÓÓ+ ,
uint
ÓÓ, 0
	connectId
ÓÓ1 :
,
ÓÓ: ;
int
ÓÓ< ?

retryCount
ÓÓ@ J
,
ÓÓJ K
NetworkFailure
ÓÓL Z
?
ÓÓZ [
currentFailure
ÓÓ\ j
)
ÓÓj k
{
ÔÔ 
Log
ÕÕ 
.
ÕÕ 
Warning
ÕÕ 
(
ÕÕ 
$str
ÖÖ x
)
ÖÖx y
;
ÖÖy z

Dispatcher
ØØ 
.
ØØ 
UIThread
ØØ 
.
ØØ 
Post
ØØ  
(
ØØ  !
(
ØØ! "
)
ØØ" #
=>
ØØ$ &
{
ÙÙ 	
try
ÚÚ 
{
ÛÛ "
_connectivityService
ÜÜ $
.
ÜÜ$ %
PublishAsync
ÜÜ% 1
(
ÜÜ1 2 
ConnectivityIntent
ÝÝ &
.
ÝÝ& '
RetriesExhausted
ÝÝ' 7
(
ÝÝ7 8
currentFailure
ÞÞ &
??
ÞÞ' )
NetworkFailure
ÞÞ* 8
.
ÞÞ8 9%
DataCenterNotResponding
ÞÞ9 P
(
ÞÞP Q
$str
ÞÞQ d
)
ÞÞd e
,
ÞÞe f
	connectId
ßß !
,
ßß! "

retryCount
àà "
)
àà" #
)
àà# $
.
àà$ %
ContinueWith
àà% 1
(
àà1 2
task
áá 
=>
áá 
{
ââ 
if
ãã 
(
ãã 
task
ãã  
.
ãã  !
	IsFaulted
ãã! *
&&
ãã+ -
task
ãã. 2
.
ãã2 3
	Exception
ãã3 <
!=
ãã= ?
null
ãã@ D
)
ããD E
{
ää 
Log
åå 
.
åå  
Error
åå  %
(
åå% &
task
åå& *
.
åå* +
	Exception
åå+ 4
,
åå4 5
$str
åå6 h
)
ååh i
;
ååi j
}
ææ 
}
çç 
,
çç 
TaskScheduler
èè !
.
èè! "
Default
èè" )
)
èè) *
;
èè* +
}
éé 
catch
êê 
(
êê 
	Exception
êê 
ex
êê 
)
êê  
{
ëë 
Log
ìì 
.
ìì 
Error
ìì 
(
ìì 
ex
ìì 
,
ìì 
$str
ìì F
)
ììF G
;
ììG H
}
íí 
}
îî 	
)
îî	 

;
îî
 
}
ïï 
private
ññ 
void
ññ %
HandlePartialExhaustion
ññ (
(
ññ( )
uint
ññ) -
	connectId
ññ. 7
,
ññ7 8
NetworkFailure
ññ9 G
?
ññG H
currentFailure
ññI W
)
ññW X
{
òò 
int
óó 
exhaustedCount
óó 
=
óó &
CountExhaustedOperations
óó 5
(
óó5 6
)
óó6 7
;
óó7 8
if
õõ 

(
õõ 
exhaustedCount
õõ 
==
õõ 
$num
õõ 
)
õõ  
{
öö 	
Log
÷÷ 
.
÷÷ 
Information
÷÷ 
(
÷÷ 
$str
øø `
)
øø` a
;
øøa b&
PublishDisconnectedState
úú $
(
úú$ %
	connectId
úú% .
,
úú. /
currentFailure
úú0 >
)
úú> ?
;
úú? @
}
ûû 	
if
ýý 

(
ýý 
Log
ýý 
.
ýý 
	IsEnabled
ýý 
(
ýý 
LogEventLevel
ýý '
.
ýý' (
Debug
ýý( -
)
ýý- .
)
ýý. /
{
þþ 	
Log
ÿÿ 
.
ÿÿ 
Debug
ÿÿ 
(
ÿÿ 
$str
€€ y
,
€€y z
exhaustedCount
 
)
 
;
  
}
‚‚ 	
}
ƒƒ 
private
…… 
int
…… &
CountExhaustedOperations
…… (
(
……( )
)
……) *
{
†† 
int
‡‡ 
exhaustedCount
‡‡ 
=
‡‡ 
$num
‡‡ 
;
‡‡ 
foreach
ˆˆ 
(
ˆˆ  
RetryOperationInfo
ˆˆ #
	operation
ˆˆ$ -
in
ˆˆ. 0$
_activeRetryOperations
ˆˆ1 G
.
ˆˆG H
Values
ˆˆH N
.
ˆˆN O
ToArray
ˆˆO V
(
ˆˆV W
)
ˆˆW X
)
ˆˆX Y
{
‰‰ 	
if
ŠŠ 
(
ŠŠ 
	operation
ŠŠ 
.
ŠŠ 
IsExhausted
ŠŠ %
)
ŠŠ% &
{
‹‹ 
exhaustedCount
ŒŒ 
++
ŒŒ  
;
ŒŒ  !
}
 
}
ŽŽ 	
return
 
exhaustedCount
 
;
 
}
‘‘ 
private
““ 
void
““ &
PublishDisconnectedState
““ )
(
““) *
uint
““* .
	connectId
““/ 8
,
““8 9
NetworkFailure
““: H
?
““H I
currentFailure
““J X
)
““X Y
{
”” 

Dispatcher
•• 
.
•• 
UIThread
•• 
.
•• 
Post
••  
(
••  !
(
••! "
)
••" #
=>
••$ &
{
–– 	
try
—— 
{
˜˜ "
_connectivityService
™™ $
.
™™$ %
PublishAsync
™™% 1
(
™™1 2 
ConnectivityIntent
šš &
.
šš& '
Disconnected
šš' 3
(
šš3 4
currentFailure
›› &
??
››' )
NetworkFailure
››* 8
.
››8 9%
DataCenterNotResponding
››9 P
(
››P Q
$str
››Q b
)
››b c
,
››c d
	connectId
œœ !
)
œœ! "
)
œœ" #
.
œœ# $
ContinueWith
œœ$ 0
(
œœ0 1
task
 
=>
 
{
žž 
if
ŸŸ 
(
ŸŸ 
task
ŸŸ  
.
ŸŸ  !
	IsFaulted
ŸŸ! *
&&
ŸŸ+ -
task
ŸŸ. 2
.
ŸŸ2 3
	Exception
ŸŸ3 <
!=
ŸŸ= ?
null
ŸŸ@ D
)
ŸŸD E
{
   
Log
¡¡ 
.
¡¡  
Error
¡¡  %
(
¡¡% &
task
¡¡& *
.
¡¡* +
	Exception
¡¡+ 4
,
¡¡4 5
$str
¢¢  e
)
¢¢e f
;
¢¢f g
}
££ 
}
¤¤ 
,
¤¤ 
TaskScheduler
¥¥ !
.
¥¥! "
Default
¥¥" )
)
¥¥) *
;
¥¥* +
}
¦¦ 
catch
§§ 
(
§§ 
	Exception
§§ 
ex
§§ 
)
§§  
{
¨¨ 
Log
©© 
.
©© 
Error
©© 
(
©© 
ex
©© 
,
©© 
$str
©© I
)
©©I J
;
©©J K
}
ªª 
}
«« 	
)
««	 

;
««
 
}
¬¬ 
private
®® 
static
®® 
bool
®® )
DetermineIfRecoveryRequired
®® 3
<
®®3 4
	TResponse
®®4 =
>
®®= >
(
®®> ?
bool
¯¯ 
	isTimeout
¯¯ 
,
¯¯ 
bool
°° 
	hasResult
°° 
,
°° 
Result
±± 
<
±± 
	TResponse
±± 
,
±± 
NetworkFailure
±± (
>
±±( )
result
±±* 0
,
±±0 10
"RequiresConnectionRecoveryDelegate
²² *
<
²²* +
	TResponse
²²+ 4
>
²²4 5(
connectionRecoveryDelegate
²²6 P
)
²²P Q
{
³³ 
if
´´ 

(
´´ 
	isTimeout
´´ 
)
´´ 
{
µµ 	
return
¶¶ 
true
¶¶ 
;
¶¶ 
}
·· 	
if
¹¹ 

(
¹¹ 
	hasResult
¹¹ 
)
¹¹ 
{
ºº 	
return
»» (
connectionRecoveryDelegate
»» -
(
»»- .
result
»». 4
)
»»4 5
;
»»5 6
}
¼¼ 	
return
¾¾ 
false
¾¾ 
;
¾¾ 
}
¿¿ 
private
ÁÁ 
IAsyncPolicy
ÁÁ 
<
ÁÁ 
Result
ÁÁ 
<
ÁÁ  
	TResponse
ÁÁ  )
,
ÁÁ) *
NetworkFailure
ÁÁ+ 9
>
ÁÁ9 :
>
ÁÁ: ;!
CreateTimeoutPolicy
ÁÁ< O
<
ÁÁO P
	TResponse
ÁÁP Y
>
ÁÁY Z
(
ÁÁZ [
string
ÂÂ 
operationName
ÂÂ 
,
ÂÂ 
uint
ÃÃ 
	connectId
ÃÃ 
)
ÃÃ 
{
ÄÄ 
return
ÅÅ 
Policy
ÅÅ 
.
ÆÆ 
TimeoutAsync
ÆÆ 
<
ÆÆ 
Result
ÆÆ  
<
ÆÆ  !
	TResponse
ÆÆ! *
,
ÆÆ* +
NetworkFailure
ÆÆ, :
>
ÆÆ: ;
>
ÆÆ; <
(
ÆÆ< =
(
ÇÇ 
context
ÇÇ 
)
ÇÇ 
=>
ÇÇ 
{
ÈÈ 
int
ÉÉ 
currentAttempt
ÉÉ &
=
ÉÉ' (
GetCurrentAttempt
ÉÉ) :
(
ÉÉ: ;
context
ÉÉ; B
)
ÉÉB C
;
ÉÉC D
TimeSpan
ÊÊ 
timeout
ÊÊ $
=
ÊÊ% &$
_strategyConfiguration
ÊÊ' =
.
ÊÊ= >!
PER_ATTEMPT_TIMEOUT
ÊÊ> Q
;
ÊÊQ R
if
ÌÌ 
(
ÌÌ 
Log
ÌÌ 
.
ÌÌ 
	IsEnabled
ÌÌ %
(
ÌÌ% &
LogEventLevel
ÌÌ& 3
.
ÌÌ3 4
Debug
ÌÌ4 9
)
ÌÌ9 :
)
ÌÌ: ;
{
ÍÍ 
Log
ÎÎ 
.
ÎÎ 
Debug
ÎÎ !
(
ÎÎ! "
$strÏÏ 
,ÏÏ ‚
operationName
ÐÐ )
,
ÐÐ) *
currentAttempt
ÐÐ+ 9
,
ÐÐ9 :
timeout
ÐÐ; B
.
ÐÐB C
TotalSeconds
ÐÐC O
)
ÐÐO P
;
ÐÐP Q
}
ÑÑ 
return
ÓÓ 
timeout
ÓÓ "
;
ÓÓ" #
}
ÔÔ 
,
ÔÔ 
TimeoutStrategy
ÕÕ 
.
ÕÕ  
Pessimistic
ÕÕ  +
,
ÕÕ+ ,
onTimeoutAsync
ÖÖ 
:
ÖÖ 
(
ÖÖ  !
context
ÖÖ! (
,
ÖÖ( )
timespan
ÖÖ* 2
,
ÖÖ2 3
_
ÖÖ4 5
,
ÖÖ5 6
_
ÖÖ7 8
)
ÖÖ8 9
=>
ÖÖ: <
{
×× 
int
ØØ 
currentAttempt
ØØ &
=
ØØ' (
GetCurrentAttempt
ØØ) :
(
ØØ: ;
context
ØØ; B
)
ØØB C
;
ØØC D
Log
ÙÙ 
.
ÙÙ 
Warning
ÙÙ 
(
ÙÙ  
$strÚÚ ‹
,ÚÚ‹ Œ
operationName
ÛÛ %
,
ÛÛ% &
	connectId
ÛÛ' 0
,
ÛÛ0 1
currentAttempt
ÛÛ2 @
,
ÛÛ@ A
timespan
ÛÛB J
.
ÛÛJ K
TotalSeconds
ÛÛK W
)
ÛÛW X
;
ÛÛX Y
return
ÜÜ 
Task
ÜÜ 
.
ÜÜ  
CompletedTask
ÜÜ  -
;
ÜÜ- .
}
ÝÝ 
)
ÝÝ 
;
ÝÝ 
}
ÞÞ 
private
àà 
async
àà 
Task
àà '
EnsureSecrecyChannelAsync
àà 0
(
àà0 1
uint
àà1 5
	connectId
àà6 ?
,
àà? @
CancellationToken
ààA R
cancellationToken
ààS d
)
ààd e
{
áá 
if
ââ 

(
ââ 
cancellationToken
ââ 
.
ââ %
IsCancellationRequested
ââ 5
)
ââ5 6
{
ãã 	
return
ää 
;
ää 
}
åå 	
NetworkProvider
çç 
networkProvider
çç '
=
çç( ) 
GetNetworkProvider
çç* <
(
çç< =
)
çç= >
;
çç> ?
try
éé 
{
êê 	
networkProvider
ëë 
.
ëë 2
$BeginSecrecyChannelEstablishRecovery
ëë @
(
ëë@ A
)
ëëA B
;
ëëB C
if
íí 
(
íí 
cancellationToken
íí !
.
íí! "%
IsCancellationRequested
íí" 9
)
íí9 :
{
îî 
return
ïï 
;
ïï 
}
ðð 
if
òò 
(
òò 
networkProvider
òò 
.
òò  !
IsConnectionHealthy
òò  3
(
òò3 4
	connectId
òò4 =
)
òò= >
)
òò> ?
{
óó 
return
ôô 
;
ôô 
}
õõ 
Log
÷÷ 
.
÷÷ 
Debug
÷÷ 
(
÷÷ 
$str
÷÷ R
,
÷÷R S
	connectId
÷÷T ]
)
÷÷] ^
;
÷÷^ _
Result
øø 
<
øø 
bool
øø 
,
øø 
NetworkFailure
øø '
>
øø' (
restoreResult
øø) 6
=
øø7 8
await
ùù 
networkProvider
ùù %
.
ùù% &'
TryRestoreConnectionAsync
ùù& ?
(
ùù? @
	connectId
ùù@ I
)
ùùI J
.
ùùJ K
ConfigureAwait
ùùK Y
(
ùùY Z
false
ùùZ _
)
ùù_ `
;
ùù` a
if
ûû 
(
ûû 
cancellationToken
ûû !
.
ûû! "%
IsCancellationRequested
ûû" 9
)
ûû9 :
{
üü 
return
ýý 
;
ýý 
}
þþ 
cancellationToken
€€ 
.
€€ *
ThrowIfCancellationRequested
€€ :
(
€€: ;
)
€€; <
;
€€< =
if
‚‚ 
(
‚‚ 
restoreResult
‚‚ 
.
‚‚ 
IsOk
‚‚ "
&&
‚‚# %
restoreResult
‚‚& 3
.
‚‚3 4
Unwrap
‚‚4 :
(
‚‚: ;
)
‚‚; <
)
‚‚< =
{
ƒƒ 
Log
„„ 
.
„„ 
Information
„„ 
(
„„  
$str
„„  \
,
„„\ ]
	connectId
„„^ g
)
„„g h
;
„„h i
}
…… 
else
†† 
if
†† 
(
†† 
restoreResult
†† "
.
††" #
IsErr
††# (
)
††( )
{
‡‡ 
Log
ˆˆ 
.
ˆˆ 
Warning
ˆˆ 
(
ˆˆ 
$str
ˆˆ ]
,
ˆˆ] ^
	connectId
ˆˆ_ h
,
ˆˆh i
restoreResult
‰‰ !
.
‰‰! "
	UnwrapErr
‰‰" +
(
‰‰+ ,
)
‰‰, -
.
‰‰- .
Message
‰‰. 5
)
‰‰5 6
;
‰‰6 7
}
ŠŠ 
}
‹‹ 	
catch
ŒŒ 
(
ŒŒ 
	Exception
ŒŒ 
ex
ŒŒ 
)
ŒŒ 
{
 	
Log
ŽŽ 
.
ŽŽ 
Warning
ŽŽ 
(
ŽŽ 
ex
ŽŽ 
,
ŽŽ 
$str
ŽŽ ^
,
ŽŽ^ _
	connectId
ŽŽ` i
)
ŽŽi j
;
ŽŽj k
}
 	
}
 
private
’’ 
NetworkProvider
’’  
GetNetworkProvider
’’ .
(
’’. /
)
’’/ 0
{
““ 
if
”” 

(
”” "
_lazyNetworkProvider
””  
==
””! #
null
””$ (
||
””) +
!
””, -"
_lazyNetworkProvider
””- A
.
””A B
IsValueCreated
””B P
)
””P Q
{
•• 	
throw
–– 
new
–– '
InvalidOperationException
–– /
(
––/ 0
$str
––0 Z
)
––Z [
;
––[ \
}
—— 	
return
™™ "
_lazyNetworkProvider
™™ #
.
™™# $
Value
™™$ )
;
™™) *
}
šš 
private
œœ 
static
œœ 
string
œœ  
CreateOperationKey
œœ ,
(
œœ, -
string
œœ- 3
operationName
œœ4 A
,
œœA B
uint
œœC G
	connectId
œœH Q
,
œœQ R
DateTime
œœS [
	startTime
œœ\ e
)
œœe f
=>
œœg i
$"
 

{

 
operationName
 
}
 
$str
 
{
 
	connectId
 $
}
$ %
$str
% &
{
& '
	startTime
' 0
.
0 1
Ticks
1 6
}
6 7
$str
7 8
{
8 9
Guid
9 =
.
= >
NewGuid
> E
(
E F
)
F G
:
G H
$str
H I
}
I J
"
J K
;
K L
private
ŸŸ 
static
ŸŸ 
int
ŸŸ 
GetCurrentAttempt
ŸŸ (
(
ŸŸ( )
Context
ŸŸ) 0
ctx
ŸŸ1 4
)
ŸŸ4 5
=>
ŸŸ6 8
ctx
   
.
   
TryGetValue
   
(
   
ATTEMPT_KEY
   #
,
  # $
out
  % (
object
  ) /
?
  / 0
val
  1 4
)
  4 5
&&
  6 8
val
  9 <
is
  = ?
int
  @ C
attempt
  D K
?
  L M
attempt
  N U
:
  V W
$num
  X Y
;
  Y Z
private
¢¢ 
static
¢¢ 
async
¢¢ 
Task
¢¢ 
<
¢¢ 
Result
¢¢ $
<
¢¢$ %
	TResponse
¢¢% .
,
¢¢. /
NetworkFailure
¢¢0 >
>
¢¢> ?
>
¢¢? @)
ExecuteOperationWithLogging
¢¢A \
<
¢¢\ ]
	TResponse
¢¢] f
>
¢¢f g
(
¢¢g h
Context
££ 
ctx
££ 
,
££ 
CancellationToken
¤¤ 
cancellationToken
¤¤ +
,
¤¤+ ,
Func
¥¥ 
<
¥¥ 
int
¥¥ 
,
¥¥ 
CancellationToken
¥¥ #
,
¥¥# $
Task
¥¥% )
<
¥¥) *
Result
¥¥* 0
<
¥¥0 1
	TResponse
¥¥1 :
,
¥¥: ;
NetworkFailure
¥¥< J
>
¥¥J K
>
¥¥K L
>
¥¥L M
	operation
¥¥N W
,
¥¥W X
string
¦¦ 
operationName
¦¦ 
)
¦¦ 
{
§§ 
cancellationToken
¨¨ 
.
¨¨ *
ThrowIfCancellationRequested
¨¨ 6
(
¨¨6 7
)
¨¨7 8
;
¨¨8 9
int
©© 
currentAttempt
©© 
=
©© 
GetCurrentAttempt
©© .
(
©©. /
ctx
©©/ 2
)
©©2 3
;
©©3 4
Result
ªª 
<
ªª 
	TResponse
ªª 
,
ªª 
NetworkFailure
ªª (
>
ªª( )
opResult
ªª* 2
=
ªª3 4
await
«« 
	operation
«« 
(
«« 
currentAttempt
«« *
,
««* +
cancellationToken
««, =
)
««= >
.
««> ?
ConfigureAwait
««? M
(
««M N
false
««N S
)
««S T
;
««T U
if
¬¬ 

(
¬¬ 
Log
¬¬ 
.
¬¬ 
	IsEnabled
¬¬ 
(
¬¬ 
LogEventLevel
¬¬ '
.
¬¬' (
Debug
¬¬( -
)
¬¬- .
)
¬¬. /
{
­­ 	
Log
®® 
.
®® 
Debug
®® 
(
®® 
$str
¯¯ f
,
¯¯f g
operationName
°° 
,
°° 
currentAttempt
°° -
,
°°- .
opResult
°°/ 7
.
°°7 8
IsOk
°°8 <
)
°°< =
;
°°= >
}
±± 	
return
³³ 
opResult
³³ 
;
³³ 
}
´´ 
public
¶¶ 

void
¶¶ 
Dispose
¶¶ 
(
¶¶ 
)
¶¶ 
{
·· 
if
¸¸ 

(
¸¸ 
_isDisposed
¸¸ 
)
¸¸ 
{
¹¹ 	
return
ºº 
;
ºº 
}
»» 	
_isDisposed
½½ 
=
½½ 
true
½½ 
;
½½ 
try
¿¿ 
{
ÀÀ 	&
_manualRetrySubscription
ÁÁ $
?
ÁÁ$ %
.
ÁÁ% &
Dispose
ÁÁ& -
(
ÁÁ- .
)
ÁÁ. /
;
ÁÁ/ 0
_cleanupTimer
ÂÂ 
.
ÂÂ 
Dispose
ÂÂ !
(
ÂÂ! "
)
ÂÂ" #
;
ÂÂ# $

_stateLock
ÃÃ 
.
ÃÃ 
Dispose
ÃÃ 
(
ÃÃ 
)
ÃÃ  
;
ÃÃ  !
Log
ÅÅ 
.
ÅÅ 
Information
ÅÅ 
(
ÅÅ 
$str
ÅÅ O
)
ÅÅO P
;
ÅÅP Q
}
ÆÆ 	
catch
ÇÇ 
(
ÇÇ 
	Exception
ÇÇ 
ex
ÇÇ 
)
ÇÇ 
{
ÈÈ 	
Log
ÉÉ 
.
ÉÉ 
Error
ÉÉ 
(
ÉÉ 
ex
ÉÉ 
,
ÉÉ 
$str
ÉÉ M
)
ÉÉM N
;
ÉÉN O
}
ÊÊ 	
}
ËË 
}ÌÌ …7
‰/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Resilience/RetryPolicyProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )

Resilience) 3
;3 4
public 
sealed 
class 
RetryPolicyProvider '
(' (&
RetryStrategyConfiguration( B&
retryStrategyConfigurationC ]
)] ^
:_ ` 
IRetryPolicyProvidera u
{		 
private

 
static

 
readonly

 
FrozenDictionary

 ,
<

, -
RpcServiceType

- ;
,

; <
ServiceRetryConfig

= O
>

O P
ServiceConfigs

Q _
=

` a
new 

Dictionary 
< 
RpcServiceType %
,% &
ServiceRetryConfig' 9
>9 :
{ 	
[ 
RpcServiceType 
. 
RegisterAppDevice -
]- .
=/ 0
new1 4
(4 5
ShouldRetry5 @
:@ A
trueB F
,F G#
ReinitOnCompleteFailureH _
:_ `
falsea f
)f g
,g h
[ 
RpcServiceType 
. )
CheckMobileNumberAvailability 9
]9 :
=; <
new= @
(@ A
ShouldRetryA L
:L M
trueN R
,R S#
ReinitOnCompleteFailureT k
:k l
falsem r
)r s
,s t
[ 
RpcServiceType 
.  
ValidateMobileNumber 0
]0 1
=2 3
new4 7
(7 8
ShouldRetry8 C
:C D
trueE I
,I J#
ReinitOnCompleteFailureK b
:b c
falsed i
)i j
,j k
[ 
RpcServiceType 
.  
InitiateVerification 0
]0 1
=2 3
new4 7
(7 8
ShouldRetry8 C
:C D
falseE J
,J K#
ReinitOnCompleteFailureL c
:c d
falsee j
)j k
,k l
[ 
RpcServiceType 
. 
	VerifyOtp %
]% &
=' (
new) ,
(, -
ShouldRetry- 8
:8 9
true: >
,> ?#
ReinitOnCompleteFailure@ W
:W X
falseY ^
)^ _
,_ `
[ 
RpcServiceType 
. 
RegistrationInit ,
], -
=. /
new0 3
(3 4
ShouldRetry4 ?
:? @
trueA E
,E F#
ReinitOnCompleteFailureG ^
:^ _
false` e
)e f
,f g
[ 
RpcServiceType 
.  
RegistrationComplete 0
]0 1
=2 3
new4 7
(7 8
ShouldRetry8 C
:C D
trueE I
,I J#
ReinitOnCompleteFailureK b
:b c
trued h
)h i
,i j
[ 
RpcServiceType 
. 
SignInInitRequest -
]- .
=/ 0
new1 4
(4 5
ShouldRetry5 @
:@ A
trueB F
,F G#
ReinitOnCompleteFailureH _
:_ `
falsea f
)f g
,g h
[ 
RpcServiceType 
. !
SignInCompleteRequest 1
]1 2
=3 4
new5 8
(8 9
ShouldRetry9 D
:D E
trueF J
,J K#
ReinitOnCompleteFailureL c
:c d
truee i
)i j
,j k
[ 
RpcServiceType 
. 
Logout "
]" #
=$ %
new& )
() *
ShouldRetry* 5
:5 6
false7 <
,< =#
ReinitOnCompleteFailure> U
:U V
falseW \
)\ ]
,] ^
[ 
RpcServiceType 
. 
AnonymousLogout +
]+ ,
=- .
new/ 2
(2 3
ShouldRetry3 >
:> ?
false@ E
,E F#
ReinitOnCompleteFailureG ^
:^ _
false` e
)e f
,f g
[ 
RpcServiceType 
. /
#EstablishAuthenticatedSecureChannel ?
]? @
=A B
newC F
(F G
ShouldRetryG R
:R S
trueT X
,X Y#
ReinitOnCompleteFailureZ q
:q r
trues w
)w x
,x y
[ 
RpcServiceType 
. !
RecoverySecretKeyInit 1
]1 2
=3 4
new5 8
(8 9
ShouldRetry9 D
:D E
trueF J
,J K#
ReinitOnCompleteFailureL c
:c d
falsee j
)j k
,k l
[ 
RpcServiceType 
. %
RecoverySecretKeyComplete 5
]5 6
=7 8
new9 <
(< =
ShouldRetry= H
:H I
trueJ N
,N O#
ReinitOnCompleteFailureP g
:g h
truei m
)m n
,n o
} 	
.	 

ToFrozenDictionary
 
( 
) 
; 
private 
sealed 
record 
ServiceRetryConfig ,
(, -
bool- 1
ShouldRetry2 =
,= >
bool? C#
ReinitOnCompleteFailureD [
)[ \
;\ ]
public 

RetryBehavior 
GetRetryBehavior )
() *
RpcServiceType* 8
serviceType9 D
)D E
{   
if!! 

(!! 
!!! 
ServiceConfigs!! 
.!! 
TryGetValue!! '
(!!' (
serviceType!!( 3
,!!3 4
out!!5 8
ServiceRetryConfig!!9 K
?!!K L
config!!M S
)!!S T
)!!T U
{"" 	
return## 
RetryBehavior##  
.##  !
NoRetry##! (
;##( )
}$$ 	
return&& 
new&& 
RetryBehavior&&  
{'' 	
ShouldRetry(( 
=(( 
config((  
.((  !
ShouldRetry((! ,
,((, -
MAX_ATTEMPTS)) 
=)) &
retryStrategyConfiguration)) 5
.))5 6
MAX_RETRIES))6 A
,))A B#
ReinitOnCompleteFailure** #
=**$ %
config**& ,
.**, -#
ReinitOnCompleteFailure**- D
}++ 	
;++	 

},, 
}-- 
ˆ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Resilience/RetryPolicyHelpers.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )

Resilience) 3
;3 4
public 
delegate 
bool 
ShouldRetryDelegate (
<( )
	TResponse) 2
>2 3
(3 4
Result4 :
<: ;
	TResponse; D
,D E
NetworkFailureF T
>T U
resultV \
)\ ]
;] ^
public 
delegate 
bool .
"RequiresConnectionRecoveryDelegate 7
<7 8
	TResponse8 A
>A B
(B C
ResultC I
<I J
	TResponseJ S
,S T
NetworkFailureU c
>c d
resulte k
)k l
;l m
public		 
static		 
class		  
RetryDecisionFactory		 (
{

 
public 

static 
ShouldRetryDelegate %
<% &
	TResponse& /
>/ 0%
CreateShouldRetryDelegate1 J
<J K
	TResponseK T
>T U
(U V
)V W
=>X Z
static[ a
resultb h
=>i k
resultl r
.r s
IsErrs x
&&y {"
FailureClassification	| ‘
.
‘ ’
IsTransient
’ 
(
 ž
result
ž ¤
.
¤ ¥
	UnwrapErr
¥ ®
(
® ¯
)
¯ °
)
° ±
;
± ²
public 

static .
"RequiresConnectionRecoveryDelegate 4
<4 5
	TResponse5 >
>> ?,
 CreateConnectionRecoveryDelegate@ `
<` a
	TResponsea j
>j k
(k l
)l m
{ 
return 
static 
result 
=> 
{ 	
if 
( 
result 
. 
IsOk 
) 
{ 
return 
false 
; 
} 
NetworkFailure 
failure "
=# $
result% +
.+ ,
	UnwrapErr, 5
(5 6
)6 7
;7 8
return !
FailureClassification (
.( )#
IsProtocolStateMismatch) @
(@ A
failureA H
)H I
||J L!
FailureClassification (
.( )
IsCryptoDesync) 7
(7 8
failure8 ?
)? @
;@ A
} 	
;	 

} 
} ­
‹/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Resilience/FailureClassification.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )

Resilience) 3
;3 4
public 
static 
class !
FailureClassification )
{ 
public 

static 
bool 
IsTransient "
(" #
NetworkFailure# 1
failure2 9
)9 :
{ 
if		 

(		 
failure		 
.		 
FailureType		 
==		  "
NetworkFailureType		# 5
.		5 6
OPERATION_CANCELLED		6 I
)		I J
{

 	
return 
false 
; 
} 	
if 

( 
failure 
. 
FailureType 
==  "
NetworkFailureType# 5
.5 6#
PROTOCOL_STATE_MISMATCH6 M
)M N
{ 	
return 
false 
; 
} 	
if 

( 
failure 
. 
	UserError 
? 
. 
	Retryable (
is) +
bool, 0
	retryable1 :
): ;
{ 	
return 
	retryable 
; 
} 	
return 
failure 
. 
FailureType "
==# %
NetworkFailureType& 8
.8 9&
DATA_CENTER_NOT_RESPONDING9 S
;S T
} 
public 

static 
bool 
IsServerShutdown '
(' (
NetworkFailure( 6
failure7 >
)> ?
{ 
return 
failure 
. 
FailureType "
==# %
NetworkFailureType& 8
.8 9 
DATA_CENTER_SHUTDOWN9 M
;M N
} 
public   

static   
bool   
IsCryptoDesync   %
(  % &
NetworkFailure  & 4
failure  5 <
)  < =
{!! 
return"" 
failure"" 
."" 
FailureType"" "
==""# %
NetworkFailureType""& 8
.""8 9"
RSA_ENCRYPTION_FAILURE""9 O
;""O P
}## 
public%% 

static%% 
bool%% #
IsProtocolStateMismatch%% .
(%%. /
NetworkFailure%%/ =
failure%%> E
)%%E F
{&& 
return'' 
failure'' 
.'' 
FailureType'' "
==''# %
NetworkFailureType''& 8
.''8 9#
PROTOCOL_STATE_MISMATCH''9 P
;''P Q
}(( 
public** 

static** 
bool** #
IsChainRotationMismatch** .
(**. /
NetworkFailure**/ =
failure**> E
)**E F
{++ 
return-- #
IsProtocolStateMismatch-- &
(--& '
failure--' .
)--. /
;--/ 0
}.. 
public00 

static00 
bool00 
IsCancellation00 %
(00% &
NetworkFailure00& 4
failure005 <
)00< =
{11 
return22 
failure22 
.22 
FailureType22 "
==22# %
NetworkFailureType22& 8
.228 9
OPERATION_CANCELLED229 L
;22L M
}33 
}44 øR
‰/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Resilience/GrpcErrorClassifier.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
.( )

Resilience) 3
;3 4
public		 
static		 
class		 
GrpcErrorClassifier		 '
{

 
public 

static 
bool 
IsBusinessError &
(& '
RpcException' 3
ex4 6
)6 7
=>8 :
ex 

.
 

StatusCode 
is 

StatusCode 
. 
InvalidArgument &
or' )

StatusCode 
. 
NotFound 
or  "

StatusCode 
. 
AlreadyExists $
or% '

StatusCode 
. 
FailedPrecondition )
or* ,

StatusCode 
. 

OutOfRange !
or" $

StatusCode 
. 
Unimplemented $
;$ %
public 

static 
bool !
IsAuthenticationError ,
(, -
RpcException- 9
ex: <
)< =
=>> @
ex 

.
 

StatusCode 
is 

StatusCode 
. 
Unauthenticated &
or' )

StatusCode 
. 
PermissionDenied '
;' (
public 

static 
bool %
IsTransientInfrastructure 0
(0 1
RpcException1 =
ex> @
)@ A
=>B D
ex 

.
 

StatusCode 
is 

StatusCode 
. 
DeadlineExceeded '
or( *

StatusCode 
. 
Unavailable "
or# %

StatusCode 
. 
	Cancelled  
;  !
public 

static 
bool %
RequiresHandshakeRecovery 0
(0 1
RpcException1 =
ex> @
)@ A
=>B D
ex   

.  
 

StatusCode   
is   

StatusCode!! 
.!! 
Internal!! 
or!!  "

StatusCode"" 
."" 
Unknown"" 
or"" !

StatusCode## 
.## 
DataLoss## 
;##  
public%% 

static%% 
bool%% #
IsProtocolStateMismatch%% .
(%%. /
RpcException%%/ ;
ex%%< >
)%%> ?
{&& 
if'' 

('' 
ex'' 
.'' 

StatusCode'' 
!='' 

StatusCode'' '
.''' (
Internal''( 0
&&''1 3
ex''4 6
.''6 7

StatusCode''7 A
!=''B D

StatusCode''E O
.''O P
FailedPrecondition''P b
)''b c
{(( 	
return)) 
false)) 
;)) 
}** 	
string,, 
detail,, 
=,, 
ex,, 
.,, 
Status,, !
.,,! "
Detail,," (
?,,( )
.,,) *
ToLowerInvariant,,* :
(,,: ;
),,; <
??,,= ?
string,,@ F
.,,F G
Empty,,G L
;,,L M
return.. 
detail.. 
... 
Contains.. 
(.. 
$str.. =
)..= >
||..? A
detail// 
.// 
Contains// 
(// 
$str// 0
)//0 1
&&//2 4
detail//5 ;
.//; <
Contains//< D
(//D E
$str//E Q
)//Q R
||//S U
detail00 
.00 
Contains00 
(00 
$str00 /
)00/ 0
||001 3
detail11 
.11 
Contains11 
(11 
$str11 2
)112 3
||114 6
detail22 
.22 
Contains22 
(22 
$str22 /
)22/ 0
&&221 3
detail224 :
.22: ;
Contains22; C
(22C D
$str22D N
)22N O
||22P R
detail33 
.33 
Contains33 
(33 
$str33 /
)33/ 0
&&331 3
detail334 :
.33: ;
Contains33; C
(33C D
$str33D T
)33T U
||33V X
detail44 
.44 
Contains44 
(44 
$str44 )
)44) *
&&44+ -
detail44. 4
.444 5
Contains445 =
(44= >
$str44> G
)44G H
||44I K
detail55 
.55 
Contains55 
(55 
$str55 -
)55- .
&&55/ 1
detail552 8
.558 9
Contains559 A
(55A B
$str55B K
)55K L
||55M O
detail66 
.66 
Contains66 
(66 
$str66 /
)66/ 0
&&661 3
detail664 :
.66: ;
Contains66; C
(66C D
$str66D M
)66M N
||66O Q
detail77 
.77 
Contains77 
(77 
$str77 1
)771 2
||773 5
detail88 
.88 
Contains88 
(88 
$str88 .
)88. /
||880 2
detail99 
.99 
Contains99 
(99 
$str99 .
)99. /
&&990 2
detail993 9
.999 :
Contains99: B
(99B C
$str99C L
)99L M
;99M N
}:: 
public<< 

static<< 
bool<< 
IsServerShutdown<< '
(<<' (
RpcException<<( 4
ex<<5 7
)<<7 8
=><<9 ;
ex== 

.==
 

StatusCode== 
==== 

StatusCode== #
.==# $
Unavailable==$ /
&&==0 2
(>> 	
ex>>	 
.>> 
Status>> 
.>> 
Detail>> 
?>> 
.>> 
Contains>> #
(>># $
$str>>$ .
,>>. /
StringComparison>>0 @
.>>@ A
OrdinalIgnoreCase>>A R
)>>R S
is>>T V
true>>W [
||>>\ ^
ex??	 
.?? 
Status?? 
.?? 
Detail?? 
??? 
.?? 
Contains?? #
(??# $
$str??$ 1
,??1 2
StringComparison??3 C
.??C D
OrdinalIgnoreCase??D U
)??U V
is??W Y
true??Z ^
)??^ _
;??_ `
publicAA 

staticAA 
boolAA 
IsCancelledAA "
(AA" #
RpcExceptionAA# /
exAA0 2
)AA2 3
=>AA4 6
exBB 

.BB
 

StatusCodeBB 
==BB 

StatusCodeBB #
.BB# $
	CancelledBB$ -
;BB- .
publicDD 

staticDD 
boolDD *
IsIdentityKeyDerivationFailureDD 5
(DD5 6
RpcExceptionDD6 B
exDDC E
)DDE F
=>DDG I
exEE 

.EE
 

StatusCodeEE 
==EE 

StatusCodeEE #
.EE# $
UnauthenticatedEE$ 3
&&EE4 6
(FF 	
exFF	 
.FF 
StatusFF 
.FF 
DetailFF 
?FF 
.FF 
ContainsFF #
(FF# $
$strFF$ D
,FFD E
SystemFFF L
.FFL M
StringComparisonFFM ]
.FF] ^
OrdinalFF^ e
)FFe f
isFFg i
trueFFj n
)FFn o
;FFo p
publicHH 

staticHH 
boolHH 
IsAuthFlowMissingHH (
(HH( )
RpcExceptionHH) 5
exHH6 8
)HH8 9
{II 
ifJJ 

(JJ 
exJJ 
.JJ 

StatusCodeJJ 
!=JJ 

StatusCodeJJ '
.JJ' (
NotFoundJJ( 0
)JJ0 1
{KK 	
returnLL 
falseLL 
;LL 
}MM 	
returnOO 
GetMetadataValueOO 
(OO  
exOO  "
.OO" #
TrailersOO# +
,OO+ ,!
GrpcErrorMetadataKeysOO- B
.OOB C

ERROR_CODEOOC M
)OOM N
.PP 
WherePP 
(PP 
codePP 
=>PP !
stringPP" (
.PP( )
EqualsPP) /
(PP/ 0
codePP0 4
,PP4 5
$strPP6 G
,PPG H
StringComparisonPPI Y
.PPY Z
OrdinalIgnoreCasePPZ k
)PPk l
)PPl m
.QQ 
IsSomeQQ 
||RR 
GetMetadataValueSS 
(SS  
exSS  "
.SS" #
TrailersSS# +
,SS+ ,!
GrpcErrorMetadataKeysSS- B
.SSB C
	I_18N_KEYSSC L
)SSL M
.TT 
WhereTT 
(TT 
keyTT 
=>TT  
stringTT! '
.TT' (
EqualsTT( .
(TT. /
keyTT/ 2
,TT2 3
$strTT4 M
,TTM N
StringComparisonTTO _
.TT_ `
OrdinalIgnoreCaseTT` q
)TTq r
)TTr s
.UU 
IsSomeUU 
;UU 
}VV 
privateXX 
staticXX 
OptionXX 
<XX 
stringXX  
>XX  !
GetMetadataValueXX" 2
(XX2 3
MetadataXX3 ;
metadataXX< D
,XXD E
stringXXF L
keyXXM P
)XXP Q
{YY 
MetadataZZ 
.ZZ 
EntryZZ 
?ZZ 
entryZZ 
=ZZ 
metadataZZ  (
.[[ 
FirstOrDefault[[ 
([[ 
e[[ 
=>[[  
string[[! '
.[[' (
Equals[[( .
([[. /
e[[/ 0
.[[0 1
Key[[1 4
,[[4 5
key[[6 9
,[[9 :
StringComparison[[; K
.[[K L
OrdinalIgnoreCase[[L ]
)[[] ^
)[[^ _
;[[_ `
return]] 
entry]] 
?]] 
.]] 
Value]] 
.]] 
ToOption]] $
(]]$ %
)]]% &
??]]' )
Option]]* 0
<]]0 1
string]]1 7
>]]7 8
.]]8 9
None]]9 =
;]]= >
}^^ 
}__ Í,
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/PendingLogoutProcessor.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
internal 
sealed	 
class "
PendingLogoutProcessor ,
(, -
NetworkProvider 
networkProvider #
,# $'
PendingLogoutRequestStorage  
pendingLogoutStorage  4
)4 5
{ 
public 

async 
Task %
ProcessPendingLogoutAsync /
(/ 0
uint 
	connectId 
, 
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
{ 
Result 
< 
Option 
< 
LogoutRequest #
># $
,$ %
LogoutFailure& 3
>3 4
	getResult5 >
=? @
await  
pendingLogoutStorage &
.& '!
GetPendingLogoutAsync' <
(< =
)= >
.> ?
ConfigureAwait? M
(M N
falseN S
)S T
;T U
if 

( 
	getResult 
. 
IsErr 
|| 
!  
	getResult  )
.) *
Unwrap* 0
(0 1
)1 2
.2 3
IsSome3 9
)9 :
{ 	
return 
; 
} 	
LogoutRequest!! 
pendingRequest!! $
=!!% &
	getResult!!' 0
.!!0 1
Unwrap!!1 7
(!!7 8
)!!8 9
.!!9 :
Value!!: ?
!!!? @
;!!@ A 
TaskCompletionSource## 
<## 
bool## !
>##! "$
responseCompletionSource### ;
=##< =
new$$ 
($$ 
TaskCreationOptions$$ #
.$$# $*
RunContinuationsAsynchronously$$$ B
)$$B C
;$$C D
Result&& 
<&& 
Unit&& 
,&& 
NetworkFailure&& #
>&&# $
networkResult&&% 2
=&&3 4
await&&5 :
networkProvider&&; J
.&&J K$
ExecuteUnaryRequestAsync&&K c
(&&c d
	connectId'' 
,'' 
RpcServiceType(( 
.(( 
AnonymousLogout(( *
,((* +
pendingRequest)) 
.)) 
ToByteArray)) &
())& '
)))' (
,))( )
async** 
responsePayload** !
=>**" $
{++ #
AnonymousLogoutResponse,, '
.,,' (
Parser,,( .
.,,. /
	ParseFrom,,/ 8
(,,8 9
responsePayload,,9 H
),,H I
;,,I J$
responseCompletionSource-- (
.--( )
TrySetResult--) 5
(--5 6
true--6 :
)--: ;
;--; <
return.. 
await.. 
Task.. !
...! "

FromResult.." ,
(.., -
Result..- 3
<..3 4
Unit..4 8
,..8 9
NetworkFailure..: H
>..H I
...I J
Ok..J L
(..L M
Unit..M Q
...Q R
Value..R W
)..W X
)..X Y
;..Y Z
}// 
,// 
allowDuplicates00 
:00 
false00 "
,00" #
token11 
:11 
cancellationToken11 $
)11$ %
.11% &
ConfigureAwait11& 4
(114 5
false115 :
)11: ;
;11; <
if33 

(33 
networkResult33 
.33 
IsOk33 
)33 
{44 	
await55 $
responseCompletionSource55 *
.55* +
Task55+ /
.55/ 0
ConfigureAwait550 >
(55> ?
false55? D
)55D E
;55E F
}66 	
else77 
{88 	
_99 
=99 
Task99 
.99 
Run99 
(99 
async99 
(99  
)99  !
=>99" $
{:: 
await;; &
EnsureProtocolInBackground;; 0
(;;0 1
);;1 2
;;;2 3
}<< 
,<< 
cancellationToken<<  
)<<  !
.<<! "
ContinueWith<<" .
(<<. /
task== 
=>== 
{>> 
if?? 
(?? 
task?? 
is?? 
{??  !
	IsFaulted??" +
:??+ ,
true??- 1
,??1 2
	Exception??3 <
:??< =
not??> A
null??B F
}??G H
)??H I
{@@ 
LogAA 
.AA 
ErrorAA !
(AA! "
taskAA" &
.AA& '
	ExceptionAA' 0
,AA0 1
$strAA2 p
)AAp q
;AAq r
}BB 
}CC 
,CC 
TaskSchedulerDD 
.DD 
DefaultDD %
)DD% &
;DD& '
}EE 	 
pendingLogoutStorageGG 
.GG 
ClearPendingLogoutGG /
(GG/ 0
)GG0 1
;GG1 2
}HH 
privateJJ 
asyncJJ 
TaskJJ &
EnsureProtocolInBackgroundJJ 1
(JJ1 2
)JJ2 3
{KK 
awaitLL 
networkProviderLL 
.LL &
EnsureProtocolForTypeAsyncLL 8
(LL8 9
PubKeyExchangeTypeMM 
.MM &
DataCenterEphemeralConnectMM 9
)MM9 :
;MM: ;
}NN 
}OO ´8
ƒ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/OperationTimeoutProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
public		 
sealed		 
class		 $
OperationTimeoutProvider		 ,
:		- .%
IOperationTimeoutProvider		/ H
{

 
private$$ 
static$$ 
readonly$$ 
TimeSpan$$ $
DefaultTimeout$$% 3
=$$4 5
TimeSpan$$6 >
.$$> ?
FromSeconds$$? J
($$J K
$num$$K M
)$$M N
;$$N O
private%% 
const%% 
double%% #
MAX_ADAPTIVE_MULTIPLIER%% 0
=%%1 2
$num%%3 6
;%%6 7
private&& 
const&& 
double&& )
ADAPTIVE_MULTIPLIER_INCREMENT&& 6
=&&7 8
$num&&9 <
;&&< =
private(( 
static(( 
readonly(( 
FrozenDictionary(( ,
<((, -
RpcServiceType((- ;
,((; <
TimeSpan((= E
>((E F
ServiceTimeouts((G V
=((W X
new)) 

Dictionary)) 
<)) 
RpcServiceType)) %
,))% &
TimeSpan))' /
>))/ 0
{** 	
[++ 
RpcServiceType++ 
.++  
InitiateVerification++ 0
]++0 1
=++2 3
TimeSpan++4 <
.++< =
FromSeconds++= H
(++H I
$num++I L
)++L M
,++M N
[,, 
RpcServiceType,, 
.,, #
EstablishSecrecyChannel,, 3
],,3 4
=,,5 6
TimeSpan,,7 ?
.,,? @
FromSeconds,,@ K
(,,K L
$num,,L N
),,N O
,,,O P
[-- 
RpcServiceType-- 
.-- !
RestoreSecrecyChannel-- 1
]--1 2
=--3 4
TimeSpan--5 =
.--= >
FromSeconds--> I
(--I J
$num--J L
)--L M
,--M N
[.. 
RpcServiceType.. 
... /
#EstablishAuthenticatedSecureChannel.. ?
]..? @
=..A B
TimeSpan..C K
...K L
FromSeconds..L W
(..W X
$num..X Z
)..Z [
,..[ \
[// 
RpcServiceType// 
.// 
RegistrationInit// ,
]//, -
=//. /
TimeSpan//0 8
.//8 9
FromSeconds//9 D
(//D E
$num//E G
)//G H
,//H I
[00 
RpcServiceType00 
.00  
RegistrationComplete00 0
]000 1
=002 3
TimeSpan004 <
.00< =
FromSeconds00= H
(00H I
$num00I K
)00K L
,00L M
[11 
RpcServiceType11 
.11 !
RecoverySecretKeyInit11 1
]111 2
=113 4
TimeSpan115 =
.11= >
FromSeconds11> I
(11I J
$num11J L
)11L M
,11M N
[22 
RpcServiceType22 
.22 %
RecoverySecretKeyComplete22 5
]225 6
=227 8
TimeSpan229 A
.22A B
FromSeconds22B M
(22M N
$num22N P
)22P Q
,22Q R
[33 
RpcServiceType33 
.33 
SignInInitRequest33 -
]33- .
=33/ 0
TimeSpan331 9
.339 :
FromSeconds33: E
(33E F
$num33F H
)33H I
,33I J
[44 
RpcServiceType44 
.44 !
SignInCompleteRequest44 1
]441 2
=443 4
TimeSpan445 =
.44= >
FromSeconds44> I
(44I J
$num44J L
)44L M
,44M N
[55 
RpcServiceType55 
.55  
ValidateMobileNumber55 0
]550 1
=552 3
TimeSpan554 <
.55< =
FromSeconds55= H
(55H I
$num55I K
)55K L
,55L M
[66 
RpcServiceType66 
.66 )
CheckMobileNumberAvailability66 9
]669 :
=66; <
TimeSpan66= E
.66E F
FromSeconds66F Q
(66Q R
$num66R T
)66T U
,66U V
[77 
RpcServiceType77 
.77 
	VerifyOtp77 %
]77% &
=77' (
TimeSpan77) 1
.771 2
FromSeconds772 =
(77= >
$num77> @
)77@ A
,77A B
[88 
RpcServiceType88 
.88 
RegisterAppDevice88 -
]88- .
=88/ 0
TimeSpan881 9
.889 :
FromSeconds88: E
(88E F
$num88F H
)88H I
,88I J
[99 
RpcServiceType99 
.99 
Logout99 "
]99" #
=99$ %
TimeSpan99& .
.99. /
FromSeconds99/ :
(99: ;
$num99; =
)99= >
}:: 	
.::	 

ToFrozenDictionary::
 
(:: 
):: 
;:: 
public== 

TimeSpan== 

GetTimeout== 
(== 
RpcServiceType== -
serviceType==. 9
,==9 :
RpcRequestContext==; L
?==L M
requestContext==N \
===] ^
null==_ c
)==c d
{>> 
TimeSpan?? 
baseTimeout?? 
=?? 
ServiceTimeouts?? .
.??. /
GetValueOrDefault??/ @
(??@ A
serviceType??A L
,??L M
DefaultTimeout??N \
)??\ ]
;??] ^
ifAA 

(AA 
requestContextAA 
isAA 
notAA !
{AA" #
AttemptAA$ +
:AA+ ,
>AA- .
$numAA/ 0
}AA1 2
)AA2 3
{BB 	
returnCC 
baseTimeoutCC 
;CC 
}DD 	
doubleFF 

multiplierFF 
=FF '
CalculateAdaptiveMultiplierFF 7
(FF7 8
requestContextFF8 F
.FFF G
AttemptFFG N
)FFN O
;FFO P
baseTimeoutGG 
=GG 
TimeSpanGG 
.GG 
FromMillisecondsGG /
(GG/ 0
baseTimeoutGG0 ;
.GG; <
TotalMillisecondsGG< M
*GGN O

multiplierGGP Z
)GGZ [
;GG[ \
returnII 
baseTimeoutII 
;II 
}JJ 
privateLL 
staticLL 
doubleLL '
CalculateAdaptiveMultiplierLL 5
(LL5 6
intLL6 9
attemptLL: A
)LLA B
{MM 
doubleNN 

multiplierNN 
=NN 
$numNN 
+NN  !
(NN" #
attemptNN# *
-NN+ ,
$numNN- .
)NN. /
*NN0 1)
ADAPTIVE_MULTIPLIER_INCREMENTNN2 O
;NNO P
returnOO 
MathOO 
.OO 
MinOO 
(OO 

multiplierOO "
,OO" ##
MAX_ADAPTIVE_MULTIPLIEROO$ ;
)OO; <
;OO< =
}PP 
}QQ üø
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/LogoutProofHandler.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
public 
class 
LogoutProofHandler 
(  
IIdentityService  0
identityService1 @
,@ A-
!IApplicationSecureStorageProviderB c-
 applicationSecureStorageProvider	d „
)
„ …
{ 
public 

async 
Task 
< 
Result 
< 
Unit !
,! "
LogoutFailure# 0
>0 1
>1 2&
VerifyRevocationProofAsync3 M
(M N
LogoutResponse 
response 
,  
string 
membershipId 
, 
uint 
	connectId 
) 
=> 
await .
"VerifyRevocationProofInternalAsync 0
(0 1
identityService 
, ,
 applicationSecureStorageProvider ,
,, -
response 
, 
membershipId   
,   
	connectId!! 
)!! 
;!! 
private## 
static## 
async## 
Task## 
<## 
Result## $
<##$ %
Unit##% )
,##) *
LogoutFailure##+ 8
>##8 9
>##9 :.
"VerifyRevocationProofInternalAsync##; ]
(##] ^
IIdentityService$$ 
identityService$$ (
,$$( )-
!IApplicationSecureStorageProvider%% ),
 applicationSecureStorageProvider%%* J
,%%J K
LogoutResponse&& 
response&& 
,&&  
string'' 
membershipId'' 
,'' 
uint(( 
	connectId(( 
)(( 
{)) 
Result** 
<** 
byte** 
[** 
]** 
,** 
LogoutFailure** $
>**$ %
proofValidation**& 5
=**6 7)
ValidateRevocationProofFormat**8 U
(**U V
response**V ^
)**^ _
;**_ `
if++ 

(++ 
proofValidation++ 
.++ 
IsErr++ !
)++! "
{,, 	
return-- 
Result-- 
<-- 
Unit-- 
,-- 
LogoutFailure--  -
>--- .
.--. /
Err--/ 2
(--2 3
proofValidation--3 B
.--B C
	UnwrapErr--C L
(--L M
)--M N
)--N O
;--O P
}.. 	
byte00 
[00 
]00 
revocationProof00 
=00  
proofValidation00! 0
.000 1
Unwrap001 7
(007 8
)008 9
;009 :
Result22 
<22 
ParsedProof22 
,22 
LogoutFailure22 )
>22) *
parseResult22+ 6
=227 8 
ParseRevocationProof229 M
(22M N
revocationProof22N ]
)22] ^
;22^ _
if33 

(33 
parseResult33 
.33 
IsErr33 
)33 
{44 	
return55 
Result55 
<55 
Unit55 
,55 
LogoutFailure55  -
>55- .
.55. /
Err55/ 2
(552 3
parseResult553 >
.55> ?
	UnwrapErr55? H
(55H I
)55I J
)55J K
;55K L
}66 	
ParsedProof88 
parsed88 
=88 
parseResult88 (
.88( )
Unwrap88) /
(88/ 0
)880 1
;881 2
return:: 
await:: $
VerifyAndStoreProofAsync:: -
(::- .
identityService;; 
,;; ,
 applicationSecureStorageProvider<< ,
,<<, -
membershipId== 
,== 
	connectId>> 
,>> 
response?? 
.?? 
ServerTimestamp?? $
,??$ %
parsed@@ 
,@@ 
revocationProofAA 
)AA 
;AA 
}BB 
privateDD 
staticDD 
ResultDD 
<DD 
byteDD 
[DD 
]DD  
,DD  !
LogoutFailureDD" /
>DD/ 0)
ValidateRevocationProofFormatDD1 N
(DDN O
LogoutResponseDDO ]
responseDD^ f
)DDf g
{EE 
ifFF 

(FF 
responseFF 
.FF 
RevocationProofFF $
==FF% '
nullFF( ,
||FF- /
responseFF0 8
.FF8 9
RevocationProofFF9 H
.FFH I
IsEmptyFFI P
)FFP Q
{GG 	
LogHH 
.HH 
WarningHH 
(HH 
$strHH M
)HHM N
;HHN O
returnII 
ResultII 
<II 
byteII 
[II 
]II  
,II  !
LogoutFailureII" /
>II/ 0
.II0 1
ErrII1 4
(II4 5
LogoutFailureJJ 
.JJ "
InvalidRevocationProofJJ 4
(JJ4 5
$strJJ5 ^
)JJ^ _
)JJ_ `
;JJ` a
}KK 	
byteMM 
[MM 
]MM 
revocationProofMM 
=MM  
responseMM! )
.MM) *
RevocationProofMM* 9
.MM9 :
ToByteArrayMM: E
(MME F
)MMF G
;MMG H
constNN 
intNN 

NONCE_SIZENN 
=NN 
$numNN !
;NN! "
constOO 
intOO 
	HMAC_SIZEOO 
=OO 
$numOO  
;OO  !
intPP 
minSizePP 
=PP 
$numPP 
+PP 
sizeofPP  
(PP  !
intPP! $
)PP$ %
*PP& '
$numPP( )
+PP* +

NONCE_SIZEPP, 6
+PP7 8
	HMAC_SIZEPP9 B
;PPB C
ifRR 

(RR 
revocationProofRR 
.RR 
LengthRR "
<RR# $
minSizeRR% ,
)RR, -
{SS 	
LogTT 
.TT 
WarningTT 
(TT 
$strTT T
,TTT U
revocationProofTTV e
.TTe f
LengthTTf l
)TTl m
;TTm n
returnUU 
ResultUU 
<UU 
byteUU 
[UU 
]UU  
,UU  !
LogoutFailureUU" /
>UU/ 0
.UU0 1
ErrUU1 4
(UU4 5
LogoutFailureVV 
.VV "
InvalidRevocationProofVV 4
(VV4 5
$"VV5 7
$strVV7 S
{VVS T
revocationProofVVT c
.VVc d
LengthVVd j
}VVj k
$strVVk q
"VVq r
)VVr s
)VVs t
;VVt u
}WW 	
returnYY 
ResultYY 
<YY 
byteYY 
[YY 
]YY 
,YY 
LogoutFailureYY +
>YY+ ,
.YY, -
OkYY- /
(YY/ 0
revocationProofYY0 ?
)YY? @
;YY@ A
}ZZ 
private\\ 
readonly\\ 
record\\ 
struct\\ "
ParsedProof\\# .
(\\. /
byte\\/ 3
[\\3 4
]\\4 5
Nonce\\6 ;
,\\; <
int\\= @
FingerprintLength\\A R
,\\R S
byte\\T X
[\\X Y
]\\Y Z
Fingerprint\\[ f
,\\f g
byte\\h l
[\\l m
]\\m n
	HmacProof\\o x
)\\x y
;\\y z
private^^ 
static^^ 
Result^^ 
<^^ 
ParsedProof^^ %
,^^% &
LogoutFailure^^' 4
>^^4 5 
ParseRevocationProof^^6 J
(^^J K
byte^^K O
[^^O P
]^^P Q
revocationProof^^R a
)^^a b
{__ 
const`` 
byte`` 
PROOF_VERSION_HMAC`` %
=``& '
$num``( )
;``) *
constaa 
intaa 

NONCE_SIZEaa 
=aa 
$numaa !
;aa! "
constbb 
intbb 
	HMAC_SIZEbb 
=bb 
$numbb  
;bb  !
constcc 
intcc  
MAX_FINGERPRINT_SIZEcc &
=cc' (
$numcc) +
;cc+ ,
tryee 
{ff 	
usinggg 
MemoryStreamgg 
proofStreamgg *
=gg+ ,
newgg- 0
(gg0 1
revocationProofgg1 @
,gg@ A
writableggB J
:ggJ K
falseggL Q
)ggQ R
;ggR S
usinghh 
BinaryReaderhh 
readerhh %
=hh& '
newhh( +
(hh+ ,
proofStreamhh, 7
)hh7 8
;hh8 9
Resultjj 
<jj 
Unitjj 
,jj 
LogoutFailurejj &
>jj& '
versionCheckjj( 4
=jj5 6 
ValidateProofVersionjj7 K
(jjK L
readerjjL R
,jjR S
PROOF_VERSION_HMACjjT f
)jjf g
;jjg h
ifkk 
(kk 
versionCheckkk 
.kk 
IsErrkk "
)kk" #
{ll 
returnmm 
Resultmm 
<mm 
ParsedProofmm )
,mm) *
LogoutFailuremm+ 8
>mm8 9
.mm9 :
Errmm: =
(mm= >
versionCheckmm> J
.mmJ K
	UnwrapErrmmK T
(mmT U
)mmU V
)mmV W
;mmW X
}nn 
Resultpp 
<pp 
bytepp 
[pp 
]pp 
,pp 
LogoutFailurepp (
>pp( )
nonceResultpp* 5
=pp6 7
	ReadNoncepp8 A
(ppA B
readerppB H
,ppH I

NONCE_SIZEppJ T
)ppT U
;ppU V
ifqq 
(qq 
nonceResultqq 
.qq 
IsErrqq !
)qq! "
{rr 
returnss 
Resultss 
<ss 
ParsedProofss )
,ss) *
LogoutFailuress+ 8
>ss8 9
.ss9 :
Errss: =
(ss= >
nonceResultss> I
.ssI J
	UnwrapErrssJ S
(ssS T
)ssT U
)ssU V
;ssV W
}tt 
bytevv 
[vv 
]vv 
noncevv 
=vv 
nonceResultvv &
.vv& '
Unwrapvv' -
(vv- .
)vv. /
;vv/ 0
Resultxx 
<xx 
FingerprintDataxx "
,xx" #
LogoutFailurexx$ 1
>xx1 2
fingerprintResultxx3 D
=xxE F
ReadFingerprintxxG V
(xxV W
readerxxW ]
,xx] ^ 
MAX_FINGERPRINT_SIZExx_ s
)xxs t
;xxt u
ifyy 
(yy 
fingerprintResultyy !
.yy! "
IsErryy" '
)yy' (
{zz 
return{{ 
Result{{ 
<{{ 
ParsedProof{{ )
,{{) *
LogoutFailure{{+ 8
>{{8 9
.{{9 :
Err{{: =
({{= >
fingerprintResult{{> O
.{{O P
	UnwrapErr{{P Y
({{Y Z
){{Z [
){{[ \
;{{\ ]
}|| 
FingerprintData~~ 
fingerprintData~~ +
=~~, -
fingerprintResult~~. ?
.~~? @
Unwrap~~@ F
(~~F G
)~~G H
;~~H I
Result
€€ 
<
€€ 
byte
€€ 
[
€€ 
]
€€ 
,
€€ 
LogoutFailure
€€ (
>
€€( )

hmacResult
€€* 4
=
€€5 6
ReadHmac
€€7 ?
(
€€? @
reader
€€@ F
,
€€F G
revocationProof
€€H W
.
€€W X
Length
€€X ^
,
€€^ _
	HMAC_SIZE
€€` i
)
€€i j
;
€€j k
if
 
(
 

hmacResult
 
.
 
IsErr
  
)
  !
{
‚‚ 
return
ƒƒ 
Result
ƒƒ 
<
ƒƒ 
ParsedProof
ƒƒ )
,
ƒƒ) *
LogoutFailure
ƒƒ+ 8
>
ƒƒ8 9
.
ƒƒ9 :
Err
ƒƒ: =
(
ƒƒ= >

hmacResult
ƒƒ> H
.
ƒƒH I
	UnwrapErr
ƒƒI R
(
ƒƒR S
)
ƒƒS T
)
ƒƒT U
;
ƒƒU V
}
„„ 
byte
†† 
[
†† 
]
†† 
	hmacProof
†† 
=
†† 

hmacResult
†† )
.
††) *
Unwrap
††* 0
(
††0 1
)
††1 2
;
††2 3
return
ˆˆ 
Result
ˆˆ 
<
ˆˆ 
ParsedProof
ˆˆ %
,
ˆˆ% &
LogoutFailure
ˆˆ' 4
>
ˆˆ4 5
.
ˆˆ5 6
Ok
ˆˆ6 8
(
ˆˆ8 9
new
ˆˆ9 <
ParsedProof
ˆˆ= H
(
ˆˆH I
nonce
ˆˆI N
,
ˆˆN O
fingerprintData
ˆˆP _
.
ˆˆ_ `
Length
ˆˆ` f
,
ˆˆf g
fingerprintData
ˆˆh w
.
ˆˆw x
Data
ˆˆx |
,
ˆˆ| }
	hmacProofˆˆ~ ‡
)ˆˆ‡ ˆ
)ˆˆˆ ‰
;ˆˆ‰ Š
}
‰‰ 	
catch
ŠŠ 
(
ŠŠ "
EndOfStreamException
ŠŠ #
ex
ŠŠ$ &
)
ŠŠ& '
{
‹‹ 	
Log
ŒŒ 
.
ŒŒ 
Warning
ŒŒ 
(
ŒŒ 
ex
ŒŒ 
,
ŒŒ 
$str
ŒŒ V
)
ŒŒV W
;
ŒŒW X
return
 
Result
 
<
 
ParsedProof
 %
,
% &
LogoutFailure
' 4
>
4 5
.
5 6
Err
6 9
(
9 :
LogoutFailure
ŽŽ 
.
ŽŽ $
InvalidRevocationProof
ŽŽ 4
(
ŽŽ4 5
$str
ŽŽ5 `
)
ŽŽ` a
)
ŽŽa b
;
ŽŽb c
}
 	
}
 
private
’’ 
static
’’ 
Result
’’ 
<
’’ 
Unit
’’ 
,
’’ 
LogoutFailure
’’  -
>
’’- ."
ValidateProofVersion
’’/ C
(
’’C D
BinaryReader
’’D P
reader
’’Q W
,
’’W X
byte
’’Y ]
expectedVersion
’’^ m
)
’’m n
{
““ 
byte
”” 
version
”” 
=
”” 
reader
”” 
.
”” 
ReadByte
”” &
(
””& '
)
””' (
;
””( )
if
•• 

(
•• 
version
•• 
!=
•• 
expectedVersion
•• &
)
••& '
{
–– 	
Log
—— 
.
—— 
Warning
—— 
(
—— 
$str
—— X
,
——X Y
version
——Z a
)
——a b
;
——b c
return
˜˜ 
Result
˜˜ 
<
˜˜ 
Unit
˜˜ 
,
˜˜ 
LogoutFailure
˜˜  -
>
˜˜- .
.
˜˜. /
Err
˜˜/ 2
(
˜˜2 3
LogoutFailure
™™ 
.
™™ $
InvalidRevocationProof
™™ 4
(
™™4 5
$"
™™5 7
$str
™™7 ]
{
™™] ^
version
™™^ e
}
™™e f
"
™™f g
)
™™g h
)
™™h i
;
™™i j
}
šš 	
return
›› 
Result
›› 
<
›› 
Unit
›› 
,
›› 
LogoutFailure
›› )
>
››) *
.
››* +
Ok
››+ -
(
››- .
Unit
››. 2
.
››2 3
Value
››3 8
)
››8 9
;
››9 :
}
œœ 
private
žž 
static
žž 
Result
žž 
<
žž 
byte
žž 
[
žž 
]
žž  
,
žž  !
LogoutFailure
žž" /
>
žž/ 0
	ReadNonce
žž1 :
(
žž: ;
BinaryReader
žž; G
reader
žžH N
,
žžN O
int
žžP S
expectedSize
žžT `
)
žž` a
{
ŸŸ 
int
   
nonceLength
   
=
   
reader
    
.
    !
	ReadInt32
  ! *
(
  * +
)
  + ,
;
  , -
if
¡¡ 

(
¡¡ 
nonceLength
¡¡ 
!=
¡¡ 
expectedSize
¡¡ '
)
¡¡' (
{
¢¢ 	
Log
££ 
.
££ 
Warning
££ 
(
££ 
$str
££ ]
,
££] ^
nonceLength
££_ j
,
££j k
expectedSize
££l x
)
££x y
;
££y z
return
¤¤ 
Result
¤¤ 
<
¤¤ 
byte
¤¤ 
[
¤¤ 
]
¤¤  
,
¤¤  !
LogoutFailure
¤¤" /
>
¤¤/ 0
.
¤¤0 1
Err
¤¤1 4
(
¤¤4 5
LogoutFailure
¥¥ 
.
¥¥ $
InvalidRevocationProof
¥¥ 4
(
¥¥4 5
$"
¥¥5 7
$str
¥¥7 L
{
¥¥L M
nonceLength
¥¥M X
}
¥¥X Y
"
¥¥Y Z
)
¥¥Z [
)
¥¥[ \
;
¥¥\ ]
}
¦¦ 	
byte
¨¨ 
[
¨¨ 
]
¨¨ 
nonce
¨¨ 
=
¨¨ 
reader
¨¨ 
.
¨¨ 
	ReadBytes
¨¨ '
(
¨¨' (
nonceLength
¨¨( 3
)
¨¨3 4
;
¨¨4 5
if
©© 

(
©© 
nonce
©© 
.
©© 
Length
©© 
!=
©© 
nonceLength
©© '
)
©©' (
{
ªª 	
Log
«« 
.
«« 
Warning
«« 
(
«« 
$str
«« g
,
««g h
nonceLength
««i t
,
««t u
nonce
««v {
.
««{ |
Length««| ‚
)««‚ ƒ
;««ƒ „
return
¬¬ 
Result
¬¬ 
<
¬¬ 
byte
¬¬ 
[
¬¬ 
]
¬¬  
,
¬¬  !
LogoutFailure
¬¬" /
>
¬¬/ 0
.
¬¬0 1
Err
¬¬1 4
(
¬¬4 5
LogoutFailure
­­ 
.
­­ $
InvalidRevocationProof
­­ 4
(
­­4 5
$str
­­5 e
)
­­e f
)
­­f g
;
­­g h
}
®® 	
return
°° 
Result
°° 
<
°° 
byte
°° 
[
°° 
]
°° 
,
°° 
LogoutFailure
°° +
>
°°+ ,
.
°°, -
Ok
°°- /
(
°°/ 0
nonce
°°0 5
)
°°5 6
;
°°6 7
}
±± 
private
³³ 
readonly
³³ 
record
³³ 
struct
³³ "
FingerprintData
³³# 2
(
³³2 3
int
³³3 6
Length
³³7 =
,
³³= >
byte
³³? C
[
³³C D
]
³³D E
Data
³³F J
)
³³J K
;
³³K L
private
µµ 
static
µµ 
Result
µµ 
<
µµ 
FingerprintData
µµ )
,
µµ) *
LogoutFailure
µµ+ 8
>
µµ8 9
ReadFingerprint
µµ: I
(
µµI J
BinaryReader
µµJ V
reader
µµW ]
,
µµ] ^
int
µµ_ b
maxSize
µµc j
)
µµj k
{
¶¶ 
int
·· 
fingerprintLength
·· 
=
·· 
reader
··  &
.
··& '
	ReadInt32
··' 0
(
··0 1
)
··1 2
;
··2 3
if
¸¸ 

(
¸¸ 
fingerprintLength
¸¸ 
<
¸¸ 
$num
¸¸  !
||
¸¸" $
fingerprintLength
¸¸% 6
>
¸¸7 8
maxSize
¸¸9 @
)
¸¸@ A
{
¹¹ 	
Log
ºº 
.
ºº 
Warning
ºº 
(
ºº 
$str
ºº U
,
ººU V
fingerprintLength
ººW h
)
ººh i
;
ººi j
return
»» 
Result
»» 
<
»» 
FingerprintData
»» )
,
»») *
LogoutFailure
»»+ 8
>
»»8 9
.
»»9 :
Err
»»: =
(
»»= >
LogoutFailure
¼¼ 
.
¼¼ $
InvalidRevocationProof
¼¼ 4
(
¼¼4 5
$"
¼¼5 7
$str
¼¼7 R
{
¼¼R S
fingerprintLength
¼¼S d
}
¼¼d e
"
¼¼e f
)
¼¼f g
)
¼¼g h
;
¼¼h i
}
½½ 	
byte
¿¿ 
[
¿¿ 
]
¿¿ 
fingerprint
¿¿ 
=
¿¿ 
fingerprintLength
¿¿ .
>
¿¿/ 0
$num
¿¿1 2
?
¿¿3 4
reader
¿¿5 ;
.
¿¿; <
	ReadBytes
¿¿< E
(
¿¿E F
fingerprintLength
¿¿F W
)
¿¿W X
:
¿¿Y Z
Array
¿¿[ `
.
¿¿` a
Empty
¿¿a f
<
¿¿f g
byte
¿¿g k
>
¿¿k l
(
¿¿l m
)
¿¿m n
;
¿¿n o
if
ÀÀ 

(
ÀÀ 
fingerprint
ÀÀ 
.
ÀÀ 
Length
ÀÀ 
!=
ÀÀ !
fingerprintLength
ÀÀ" 3
)
ÀÀ3 4
{
ÁÁ 	
Log
ÂÂ 
.
ÂÂ 
Warning
ÂÂ 
(
ÂÂ 
$str
ÂÂ m
,
ÂÂm n 
fingerprintLengthÂÂo €
,ÂÂ€ 
fingerprintÂÂ‚ 
.ÂÂ Ž
LengthÂÂŽ ”
)ÂÂ” •
;ÂÂ• –
return
ÃÃ 
Result
ÃÃ 
<
ÃÃ 
FingerprintData
ÃÃ )
,
ÃÃ) *
LogoutFailure
ÃÃ+ 8
>
ÃÃ8 9
.
ÃÃ9 :
Err
ÃÃ: =
(
ÃÃ= >
LogoutFailure
ÄÄ 
.
ÄÄ $
InvalidRevocationProof
ÄÄ 4
(
ÄÄ4 5
$str
ÄÄ5 k
)
ÄÄk l
)
ÄÄl m
;
ÄÄm n
}
ÅÅ 	
return
ÇÇ 
Result
ÇÇ 
<
ÇÇ 
FingerprintData
ÇÇ %
,
ÇÇ% &
LogoutFailure
ÇÇ' 4
>
ÇÇ4 5
.
ÇÇ5 6
Ok
ÇÇ6 8
(
ÇÇ8 9
new
ÇÇ9 <
FingerprintData
ÇÇ= L
(
ÇÇL M
fingerprintLength
ÇÇM ^
,
ÇÇ^ _
fingerprint
ÇÇ` k
)
ÇÇk l
)
ÇÇl m
;
ÇÇm n
}
ÈÈ 
private
ÊÊ 
static
ÊÊ 
Result
ÊÊ 
<
ÊÊ 
byte
ÊÊ 
[
ÊÊ 
]
ÊÊ  
,
ÊÊ  !
LogoutFailure
ÊÊ" /
>
ÊÊ/ 0
ReadHmac
ÊÊ1 9
(
ÊÊ9 :
BinaryReader
ÊÊ: F
reader
ÊÊG M
,
ÊÊM N
int
ÊÊO R
totalProofLength
ÊÊS c
,
ÊÊc d
int
ÊÊe h
expectedHmacSize
ÊÊi y
)
ÊÊy z
{
ËË 
int
ÌÌ 
remainingBytes
ÌÌ 
=
ÌÌ 
(
ÌÌ 
int
ÌÌ !
)
ÌÌ! "
(
ÌÌ" #
totalProofLength
ÌÌ# 3
-
ÌÌ4 5
reader
ÌÌ6 <
.
ÌÌ< =

BaseStream
ÌÌ= G
.
ÌÌG H
Position
ÌÌH P
)
ÌÌP Q
;
ÌÌQ R
if
ÍÍ 

(
ÍÍ 
remainingBytes
ÍÍ 
!=
ÍÍ 
expectedHmacSize
ÍÍ .
)
ÍÍ. /
{
ÎÎ 	
Log
ÏÏ 
.
ÏÏ 
Warning
ÏÏ 
(
ÏÏ 
$str
ÏÏ I
,
ÏÏI J
remainingBytes
ÏÏK Y
)
ÏÏY Z
;
ÏÏZ [
return
ÐÐ 
Result
ÐÐ 
<
ÐÐ 
byte
ÐÐ 
[
ÐÐ 
]
ÐÐ  
,
ÐÐ  !
LogoutFailure
ÐÐ" /
>
ÐÐ/ 0
.
ÐÐ0 1
Err
ÐÐ1 4
(
ÐÐ4 5
LogoutFailure
ÑÑ 
.
ÑÑ $
InvalidRevocationProof
ÑÑ 4
(
ÑÑ4 5
$"
ÑÑ5 7
$str
ÑÑ7 K
{
ÑÑK L
remainingBytes
ÑÑL Z
}
ÑÑZ [
"
ÑÑ[ \
)
ÑÑ\ ]
)
ÑÑ] ^
;
ÑÑ^ _
}
ÒÒ 	
byte
ÔÔ 
[
ÔÔ 
]
ÔÔ 
	hmacProof
ÔÔ 
=
ÔÔ 
reader
ÔÔ !
.
ÔÔ! "
	ReadBytes
ÔÔ" +
(
ÔÔ+ ,
expectedHmacSize
ÔÔ, <
)
ÔÔ< =
;
ÔÔ= >
if
ÕÕ 

(
ÕÕ 
	hmacProof
ÕÕ 
.
ÕÕ 
Length
ÕÕ 
!=
ÕÕ 
expectedHmacSize
ÕÕ  0
)
ÕÕ0 1
{
ÖÖ 	
Log
×× 
.
×× 
Warning
×× 
(
×× 
$str
×× f
,
××f g
expectedHmacSize
××h x
,
××x y
	hmacProof××z ƒ
.××ƒ „
Length××„ Š
)××Š ‹
;××‹ Œ
return
ØØ 
Result
ØØ 
<
ØØ 
byte
ØØ 
[
ØØ 
]
ØØ  
,
ØØ  !
LogoutFailure
ØØ" /
>
ØØ/ 0
.
ØØ0 1
Err
ØØ1 4
(
ØØ4 5
LogoutFailure
ÙÙ 
.
ÙÙ $
InvalidRevocationProof
ÙÙ 4
(
ÙÙ4 5
$str
ÙÙ5 d
)
ÙÙd e
)
ÙÙe f
;
ÙÙf g
}
ÚÚ 	
return
ÜÜ 
Result
ÜÜ 
<
ÜÜ 
byte
ÜÜ 
[
ÜÜ 
]
ÜÜ 
,
ÜÜ 
LogoutFailure
ÜÜ +
>
ÜÜ+ ,
.
ÜÜ, -
Ok
ÜÜ- /
(
ÜÜ/ 0
	hmacProof
ÜÜ0 9
)
ÜÜ9 :
;
ÜÜ: ;
}
ÝÝ 
private
ßß 
static
ßß 
async
ßß 
Task
ßß 
<
ßß 
Result
ßß $
<
ßß$ %
Unit
ßß% )
,
ßß) *
LogoutFailure
ßß+ 8
>
ßß8 9
>
ßß9 :&
VerifyAndStoreProofAsync
ßß; S
(
ßßS T
IIdentityService
àà 
identityService
àà (
,
àà( )/
!IApplicationSecureStorageProvider
áá ).
 applicationSecureStorageProvider
áá* J
,
ááJ K
string
ââ 
membershipId
ââ 
,
ââ 
uint
ãã 
	connectId
ãã 
,
ãã 
long
ää 
serverTimestamp
ää 
,
ää 
ParsedProof
åå 
parsed
åå 
,
åå 
byte
ææ 
[
ææ 
]
ææ 
revocationProof
ææ 
)
ææ 
{
çç 
byte
èè 
[
èè 
]
èè 
?
èè 
proofKey
èè 
=
èè 
null
èè 
;
èè  
try
êê 
{
ëë 	
Result
ìì 
<
ìì 
byte
ìì 
[
ìì 
]
ìì 
,
ìì 
LogoutFailure
ìì (
>
ìì( )
proofKeyResult
ìì* 8
=
ìì9 :
await
ìì; @
LoadProofKeyAsync
ììA R
(
ììR S
identityService
ììS b
,
ììb c
membershipId
ììd p
)
ììp q
;
ììq r
if
íí 
(
íí 
proofKeyResult
íí 
.
íí 
IsErr
íí $
)
íí$ %
{
îî 
return
ïï 
Result
ïï 
<
ïï 
Unit
ïï "
,
ïï" #
LogoutFailure
ïï$ 1
>
ïï1 2
.
ïï2 3
Err
ïï3 6
(
ïï6 7
proofKeyResult
ïï7 E
.
ïïE F
	UnwrapErr
ïïF O
(
ïïO P
)
ïïP Q
)
ïïQ R
;
ïïR S
}
ðð 
proofKey
òò 
=
òò 
proofKeyResult
òò %
.
òò% &
Unwrap
òò& ,
(
òò, -
)
òò- .
;
òò. /
byte
ôô 
[
ôô 
]
ôô 
canonicalData
ôô  
=
ôô! " 
BuildCanonicalData
ôô# 5
(
ôô5 6
membershipId
ôô6 B
,
ôôB C
	connectId
ôôD M
,
ôôM N
serverTimestamp
ôôO ^
,
ôô^ _
parsed
ôô` f
)
ôôf g
;
ôôg h
bool
öö 
isValid
öö 
=
öö !
LogoutKeyDerivation
öö .
.
öö. /

VerifyHmac
öö/ 9
(
öö9 :
proofKey
öö: B
,
ööB C
canonicalData
ööD Q
,
ööQ R
parsed
ööS Y
.
ööY Z
	HmacProof
ööZ c
)
ööc d
;
ööd e
if
÷÷ 
(
÷÷ 
!
÷÷ 
isValid
÷÷ 
)
÷÷ 
{
øø 
Log
ùù 
.
ùù 
Warning
ùù 
(
ùù 
$str
ùù _
)
ùù_ `
;
ùù` a
return
úú 
Result
úú 
<
úú 
Unit
úú "
,
úú" #
LogoutFailure
úú$ 1
>
úú1 2
.
úú2 3
Err
úú3 6
(
úú6 7
LogoutFailure
ûû !
.
ûû! "$
InvalidRevocationProof
ûû" 8
(
ûû8 9
$str
ûû9 k
)
ûûk l
)
ûûl m
;
ûûm n
}
üü 
Result
þþ 
<
þþ 
Unit
þþ 
,
þþ 
LogoutFailure
þþ &
>
þþ& '
storeResult
þþ( 3
=
þþ4 5
await
þþ6 ;'
StoreRevocationProofAsync
þþ< U
(
þþU V.
 applicationSecureStorageProvider
þþV v
,
þþv w
membershipIdþþx „
,þþ„ …
revocationProofþþ† •
)þþ• –
;þþ– —
if
ÿÿ 
(
ÿÿ 
storeResult
ÿÿ 
.
ÿÿ 
IsErr
ÿÿ !
)
ÿÿ! "
{
€€ 
Log
 
.
 
Warning
 
(
 
$str
 V
,
V W
storeResult
X c
.
c d
	UnwrapErr
d m
(
m n
)
n o
.
o p
Message
p w
)
w x
;
x y
}
‚‚ 
return
„„ 
Result
„„ 
<
„„ 
Unit
„„ 
,
„„ 
LogoutFailure
„„  -
>
„„- .
.
„„. /
Ok
„„/ 1
(
„„1 2
Unit
„„2 6
.
„„6 7
Value
„„7 <
)
„„< =
;
„„= >
}
…… 	
finally
†† 
{
‡‡ 	
if
ˆˆ 
(
ˆˆ 
proofKey
ˆˆ 
!=
ˆˆ 
null
ˆˆ  
)
ˆˆ  !
{
‰‰ %
CryptographicOperations
ŠŠ '
.
ŠŠ' (

ZeroMemory
ŠŠ( 2
(
ŠŠ2 3
proofKey
ŠŠ3 ;
)
ŠŠ; <
;
ŠŠ< =
}
‹‹ 
}
ŒŒ 	
}
 
private
 
static
 
async
 
Task
 
<
 
Result
 $
<
$ %
byte
% )
[
) *
]
* +
,
+ ,
LogoutFailure
- :
>
: ;
>
; <
LoadProofKeyAsync
= N
(
N O
IIdentityService
 
identityService
 (
,
( )
string
‘‘ 
membershipId
‘‘ 
)
‘‘ 
{
’’ 
Result
““ 
<
““ &
SodiumSecureMemoryHandle
““ '
,
““' (#
AuthenticationFailure
““) >
>
““> ?
handleResult
““@ L
=
““M N
await
”” 
identityService
”” !
.
””! "&
LoadMasterKeyHandleAsync
””" :
(
””: ;
membershipId
””; G
)
””G H
.
””H I
ConfigureAwait
””I W
(
””W X
false
””X ]
)
””] ^
;
””^ _
if
–– 

(
–– 
handleResult
–– 
.
–– 
IsErr
–– 
)
–– 
{
—— 	
Log
˜˜ 
.
˜˜ 
Error
˜˜ 
(
˜˜ 
$str
˜˜ ^
)
˜˜^ _
;
˜˜_ `
return
™™ 
Result
™™ 
<
™™ 
byte
™™ 
[
™™ 
]
™™  
,
™™  !
LogoutFailure
™™" /
>
™™/ 0
.
™™0 1
Err
™™1 4
(
™™4 5
LogoutFailure
šš 
.
šš *
CryptographicOperationFailed
šš :
(
šš: ;
$"
›› 
$str
›› 3
{
››3 4
handleResult
››4 @
.
››@ A
	UnwrapErr
››A J
(
››J K
)
››K L
.
››L M
Message
››M T
}
››T U
"
››U V
)
››V W
)
››W X
;
››X Y
}
œœ 	
using
žž &
SodiumSecureMemoryHandle
žž &
masterKeyHandle
žž' 6
=
žž7 8
handleResult
žž9 E
.
žžE F
Unwrap
žžF L
(
žžL M
)
žžM N
;
žžN O
Result
   
<
   
byte
   
[
   
]
   
,
   
SodiumFailure
   $
>
  $ %
proofKeyResult
  & 4
=
  5 6!
LogoutKeyDerivation
  7 J
.
  J K"
DeriveLogoutProofKey
  K _
(
  _ `
masterKeyHandle
  ` o
)
  o p
;
  p q
if
¡¡ 

(
¡¡ 
proofKeyResult
¡¡ 
.
¡¡ 
IsErr
¡¡  
)
¡¡  !
{
¢¢ 	
Log
££ 
.
££ 
Error
££ 
(
££ 
$str
££ H
)
££H I
;
££I J
return
¤¤ 
Result
¤¤ 
<
¤¤ 
byte
¤¤ 
[
¤¤ 
]
¤¤  
,
¤¤  !
LogoutFailure
¤¤" /
>
¤¤/ 0
.
¤¤0 1
Err
¤¤1 4
(
¤¤4 5
LogoutFailure
¥¥ 
.
¥¥ *
CryptographicOperationFailed
¥¥ :
(
¥¥: ;
$"
¦¦ 
$str
¦¦ 3
{
¦¦3 4
proofKeyResult
¦¦4 B
.
¦¦B C
	UnwrapErr
¦¦C L
(
¦¦L M
)
¦¦M N
.
¦¦N O
Message
¦¦O V
}
¦¦V W
"
¦¦W X
)
¦¦X Y
)
¦¦Y Z
;
¦¦Z [
}
§§ 	
return
©© 
Result
©© 
<
©© 
byte
©© 
[
©© 
]
©© 
,
©© 
LogoutFailure
©© +
>
©©+ ,
.
©©, -
Ok
©©- /
(
©©/ 0
proofKeyResult
©©0 >
.
©©> ?
Unwrap
©©? E
(
©©E F
)
©©F G
)
©©G H
;
©©H I
}
ªª 
private
¬¬ 
static
¬¬ 
byte
¬¬ 
[
¬¬ 
]
¬¬  
BuildCanonicalData
¬¬ ,
(
¬¬, -
string
¬¬- 3
membershipId
¬¬4 @
,
¬¬@ A
uint
¬¬B F
	connectId
¬¬G P
,
¬¬P Q
long
¬¬R V
serverTimestamp
¬¬W f
,
¬¬f g
ParsedProof
¬¬h s
parsed
¬¬t z
)
¬¬z {
{
­­ 
using
®® 
MemoryStream
®® 
ms
®® 
=
®® 
new
®®  #
(
®®# $
)
®®$ %
;
®®% &
using
¯¯ 
BinaryWriter
¯¯ 
writer
¯¯ !
=
¯¯" #
new
¯¯$ '
(
¯¯' (
ms
¯¯( *
)
¯¯* +
;
¯¯+ ,
writer
±± 
.
±± 
Write
±± 
(
±± 
Guid
±± 
.
±± 
Parse
±± 
(
±±  
membershipId
±±  ,
)
±±, -
.
±±- .
ToByteArray
±±. 9
(
±±9 :
)
±±: ;
)
±±; <
;
±±< =
writer
²² 
.
²² 
Write
²² 
(
²² 
	connectId
²² 
)
²² 
;
²²  
writer
³³ 
.
³³ 
Write
³³ 
(
³³ 
serverTimestamp
³³ $
)
³³$ %
;
³³% &
writer
´´ 
.
´´ 
Write
´´ 
(
´´ 
parsed
´´ 
.
´´ 
FingerprintLength
´´ -
)
´´- .
;
´´. /
if
µµ 

(
µµ 
parsed
µµ 
.
µµ 
FingerprintLength
µµ $
>
µµ% &
$num
µµ' (
)
µµ( )
{
¶¶ 	
writer
·· 
.
·· 
Write
·· 
(
·· 
parsed
·· 
.
··  
Fingerprint
··  +
)
··+ ,
;
··, -
}
¸¸ 	
writer
¹¹ 
.
¹¹ 
Write
¹¹ 
(
¹¹ 
parsed
¹¹ 
.
¹¹ 
Nonce
¹¹ !
)
¹¹! "
;
¹¹" #
writer
ºº 
.
ºº 
Flush
ºº 
(
ºº 
)
ºº 
;
ºº 
return
¼¼ 
ms
¼¼ 
.
¼¼ 
ToArray
¼¼ 
(
¼¼ 
)
¼¼ 
;
¼¼ 
}
½½ 
private
¿¿ 
static
¿¿ 
async
¿¿ 
Task
¿¿ 
<
¿¿ 
Result
¿¿ $
<
¿¿$ %
Unit
¿¿% )
,
¿¿) *
LogoutFailure
¿¿+ 8
>
¿¿8 9
>
¿¿9 :'
StoreRevocationProofAsync
¿¿; T
(
¿¿T U/
!IApplicationSecureStorageProvider
ÀÀ ).
 applicationSecureStorageProvider
ÀÀ* J
,
ÀÀJ K
string
ÁÁ 
membershipId
ÁÁ 
,
ÁÁ 
byte
ÂÂ 
[
ÂÂ 
]
ÂÂ 
revocationProof
ÂÂ 
)
ÂÂ 
{
ÃÃ 
string
ÄÄ 

storageKey
ÄÄ 
=
ÄÄ *
GetRevocationProofStorageKey
ÄÄ 8
(
ÄÄ8 9
membershipId
ÄÄ9 E
)
ÄÄE F
;
ÄÄF G
Result
ÆÆ 
<
ÆÆ 
Unit
ÆÆ 
,
ÆÆ '
InternalServiceApiFailure
ÆÆ .
>
ÆÆ. /
storeResult
ÆÆ0 ;
=
ÆÆ< =
await
ÇÇ .
 applicationSecureStorageProvider
ÇÇ 2
.
ÇÇ2 3

StoreAsync
ÇÇ3 =
(
ÇÇ= >

storageKey
ÇÇ> H
,
ÇÇH I
revocationProof
ÇÇJ Y
)
ÇÇY Z
.
ÈÈ 
ConfigureAwait
ÈÈ 
(
ÈÈ  
false
ÈÈ  %
)
ÈÈ% &
;
ÈÈ& '
if
ÊÊ 

(
ÊÊ 
storeResult
ÊÊ 
.
ÊÊ 
IsErr
ÊÊ 
)
ÊÊ 
{
ËË 	
Log
ÌÌ 
.
ÌÌ 
Error
ÌÌ 
(
ÌÌ 
$str
ÌÌ n
,
ÌÌn o
membershipId
ÍÍ 
)
ÍÍ 
;
ÍÍ 
return
ÎÎ 
Result
ÎÎ 
<
ÎÎ 
Unit
ÎÎ 
,
ÎÎ 
LogoutFailure
ÎÎ  -
>
ÎÎ- .
.
ÎÎ. /
Err
ÎÎ/ 2
(
ÎÎ2 3
LogoutFailure
ÏÏ 
.
ÏÏ 
UnexpectedError
ÏÏ -
(
ÏÏ- .
$"
ÐÐ 
$str
ÐÐ 7
{
ÐÐ7 8
storeResult
ÐÐ8 C
.
ÐÐC D
	UnwrapErr
ÐÐD M
(
ÐÐM N
)
ÐÐN O
.
ÐÐO P
Message
ÐÐP W
}
ÐÐW X
"
ÐÐX Y
)
ÐÐY Z
)
ÐÐZ [
;
ÐÐ[ \
}
ÑÑ 	
return
ÓÓ 
Result
ÓÓ 
<
ÓÓ 
Unit
ÓÓ 
,
ÓÓ 
LogoutFailure
ÓÓ )
>
ÓÓ) *
.
ÓÓ* +
Ok
ÓÓ+ -
(
ÓÓ- .
Unit
ÓÓ. 2
.
ÓÓ2 3
Value
ÓÓ3 8
)
ÓÓ8 9
;
ÓÓ9 :
}
ÔÔ 
public
ÖÖ 

static
ÖÖ 
async
ÖÖ 
Task
ÖÖ 
<
ÖÖ 
bool
ÖÖ !
>
ÖÖ! "%
HasRevocationProofAsync
ÖÖ# :
(
ÖÖ: ;/
!IApplicationSecureStorageProvider
×× )
storageProvider
××* 9
,
××9 :
string
ØØ 
membershipId
ØØ 
)
ØØ 
{
ÙÙ 
string
ÚÚ 

storageKey
ÚÚ 
=
ÚÚ *
GetRevocationProofStorageKey
ÚÚ 8
(
ÚÚ8 9
membershipId
ÚÚ9 E
)
ÚÚE F
;
ÚÚF G
Result
ÜÜ 
<
ÜÜ 
Option
ÜÜ 
<
ÜÜ 
byte
ÜÜ 
[
ÜÜ 
]
ÜÜ 
>
ÜÜ 
,
ÜÜ '
InternalServiceApiFailure
ÜÜ 8
>
ÜÜ8 9
	getResult
ÜÜ: C
=
ÜÜD E
await
ÝÝ 
storageProvider
ÝÝ !
.
ÝÝ! "
TryGetByKeyAsync
ÝÝ" 2
(
ÝÝ2 3

storageKey
ÝÝ3 =
)
ÝÝ= >
.
ÝÝ> ?
ConfigureAwait
ÝÝ? M
(
ÝÝM N
false
ÝÝN S
)
ÝÝS T
;
ÝÝT U
if
ßß 

(
ßß 
	getResult
ßß 
.
ßß 
IsErr
ßß 
)
ßß 
{
àà 	
Log
áá 
.
áá 
Warning
áá 
(
áá 
$str
áá p
,
ááp q
membershipId
ââ 
)
ââ 
;
ââ 
return
ãã 
false
ãã 
;
ãã 
}
ää 	
Option
ææ 
<
ææ 
byte
ææ 
[
ææ 
]
ææ 
>
ææ 
proofOption
ææ "
=
ææ# $
	getResult
ææ% .
.
ææ. /
Unwrap
ææ/ 5
(
ææ5 6
)
ææ6 7
;
ææ7 8
return
èè 
proofOption
èè 
.
èè 
IsSome
èè !
;
èè! "
}
éé 
public
ëë 

static
ëë 
void
ëë "
ClearRevocationProof
ëë +
(
ëë+ ,/
!IApplicationSecureStorageProvider
ìì )
storageProvider
ìì* 9
,
ìì9 :
string
íí 
membershipId
íí 
)
íí 
{
îî 
string
ïï 

storageKey
ïï 
=
ïï *
GetRevocationProofStorageKey
ïï 8
(
ïï8 9
membershipId
ïï9 E
)
ïïE F
;
ïïF G
Result
ðð 
<
ðð 
Unit
ðð 
,
ðð '
InternalServiceApiFailure
ðð .
>
ðð. /
deleteResult
ðð0 <
=
ðð= >
storageProvider
ðð? N
.
ððN O
Delete
ððO U
(
ððU V

storageKey
ððV `
)
ðð` a
;
ðða b
if
òò 

(
òò 
deleteResult
òò 
.
òò 
IsErr
òò 
)
òò 
{
óó 	
Log
ôô 
.
ôô 
Warning
ôô 
(
ôô 
$str
ôô p
,
ôôp q
membershipId
õõ 
)
õõ 
;
õõ 
}
öö 	
}
÷÷ 
private
ùù 
static
ùù 
string
ùù *
GetRevocationProofStorageKey
ùù 6
(
ùù6 7
string
ùù7 =
membershipId
ùù> J
)
ùùJ K
=>
ùùL N
$"
úú 

{
úú
 $
SecureStorageConstants
úú !
.
úú! "
Identity
úú" *
.
úú* +%
REVOCATION_PROOF_PREFIX
úú+ B
}
úúB C
{
úúC D
membershipId
úúD P
}
úúP Q
"
úúQ R
;
úúR S
public
üü 

async
üü 
Task
üü 
<
üü 
Result
üü 
<
üü 
Unit
üü !
,
üü! "
LogoutFailure
üü# 0
>
üü0 1
>
üü1 2*
GenerateLogoutHmacProofAsync
üü3 O
(
üüO P
LogoutRequest
ýý 
request
ýý 
,
ýý 
string
þþ 
membershipId
þþ 
)
þþ 
{
ÿÿ &
SodiumSecureMemoryHandle
€€  
?
€€  !
masterKeyHandle
€€" 1
=
€€2 3
null
€€4 8
;
€€8 9
byte
 
[
 
]
 
?
 
hmacKey
 
=
 
null
 
;
 
try
ƒƒ 
{
„„ 	
Result
…… 
<
…… &
SodiumSecureMemoryHandle
…… +
,
……+ ,#
AuthenticationFailure
……- B
>
……B C
handleResult
……D P
=
……Q R
await
†† 
identityService
†† %
.
††% &&
LoadMasterKeyHandleAsync
††& >
(
††> ?
membershipId
††? K
)
††K L
.
††L M
ConfigureAwait
††M [
(
††[ \
false
††\ a
)
††a b
;
††b c
if
ˆˆ 
(
ˆˆ 
handleResult
ˆˆ 
.
ˆˆ 
IsErr
ˆˆ "
)
ˆˆ" #
{
‰‰ 
Log
ŠŠ 
.
ŠŠ 
Error
ŠŠ 
(
ŠŠ 
$str
ŠŠ k
,
ŠŠk l
membershipId
‹‹  
)
‹‹  !
;
‹‹! "
return
ŒŒ 
Result
ŒŒ 
<
ŒŒ 
Unit
ŒŒ "
,
ŒŒ" #
LogoutFailure
ŒŒ$ 1
>
ŒŒ1 2
.
ŒŒ2 3
Err
ŒŒ3 6
(
ŒŒ6 7
LogoutFailure
 !
.
! "*
CryptographicOperationFailed
" >
(
> ?
$"
ŽŽ 
$str
ŽŽ 7
{
ŽŽ7 8
handleResult
ŽŽ8 D
.
ŽŽD E
	UnwrapErr
ŽŽE N
(
ŽŽN O
)
ŽŽO P
.
ŽŽP Q
Message
ŽŽQ X
}
ŽŽX Y
"
ŽŽY Z
)
ŽŽZ [
)
ŽŽ[ \
;
ŽŽ\ ]
}
 
masterKeyHandle
‘‘ 
=
‘‘ 
handleResult
‘‘ *
.
‘‘* +
Unwrap
‘‘+ 1
(
‘‘1 2
)
‘‘2 3
;
‘‘3 4
Result
““ 
<
““ 
byte
““ 
[
““ 
]
““ 
,
““ 
SodiumFailure
““ (
>
““( )
hmacKeyResult
““* 7
=
““8 9!
LogoutKeyDerivation
”” #
.
””# $!
DeriveLogoutHmacKey
””$ 7
(
””7 8
masterKeyHandle
””8 G
)
””G H
;
””H I
if
–– 
(
–– 
hmacKeyResult
–– 
.
–– 
IsErr
–– #
)
––# $
{
—— 
Log
˜˜ 
.
˜˜ 
Error
˜˜ 
(
˜˜ 
$str
˜˜ k
,
˜˜k l
membershipId
™™  
)
™™  !
;
™™! "
return
šš 
Result
šš 
<
šš 
Unit
šš "
,
šš" #
LogoutFailure
šš$ 1
>
šš1 2
.
šš2 3
Err
šš3 6
(
šš6 7
LogoutFailure
›› !
.
››! "*
CryptographicOperationFailed
››" >
(
››> ?
$"
œœ 
$str
œœ 6
{
œœ6 7
hmacKeyResult
œœ7 D
.
œœD E
	UnwrapErr
œœE N
(
œœN O
)
œœO P
.
œœP Q
Message
œœQ X
}
œœX Y
"
œœY Z
)
œœZ [
)
œœ[ \
;
œœ\ ]
}
 
hmacKey
ŸŸ 
=
ŸŸ 
hmacKeyResult
ŸŸ #
.
ŸŸ# $
Unwrap
ŸŸ$ *
(
ŸŸ* +
)
ŸŸ+ ,
;
ŸŸ, -
string
¡¡ 
	canonical
¡¡ 
=
¡¡ 
$"
¡¡ !
$str
¡¡! +
{
¡¡+ ,
request
¡¡, 3
.
¡¡3 4"
MembershipIdentifier
¡¡4 H
.
¡¡H I
ToBase64
¡¡I Q
(
¡¡Q R
)
¡¡R S
}
¡¡S T
$str
¡¡T U
"
¡¡U V
+
¡¡W X
$"
¢¢ !
{
¢¢! "
request
¢¢" )
.
¢¢) *
	Timestamp
¢¢* 3
}
¢¢3 4
$str
¢¢4 5
{
¢¢5 6
request
¢¢6 =
.
¢¢= >
Scope
¢¢> C
}
¢¢C D
$str
¢¢D E
{
¢¢E F
request
¢¢F M
.
¢¢M N
LogoutReason
¢¢N Z
}
¢¢Z [
"
¢¢[ \
;
¢¢\ ]
byte
££ 
[
££ 
]
££ 
canonicalBytes
££ !
=
££" #
Encoding
££$ ,
.
££, -
UTF8
££- 1
.
££1 2
GetBytes
££2 :
(
££: ;
	canonical
££; D
)
££D E
;
££E F
byte
¥¥ 
[
¥¥ 
]
¥¥ 
	hmacProof
¥¥ 
=
¥¥ !
LogoutKeyDerivation
¥¥ 2
.
¥¥2 3
ComputeHmac
¥¥3 >
(
¥¥> ?
hmacKey
¥¥? F
,
¥¥F G
canonicalBytes
¥¥H V
)
¥¥V W
;
¥¥W X
request
¦¦ 
.
¦¦ 
	HmacProof
¦¦ 
=
¦¦ 

ByteString
¦¦  *
.
¦¦* +
CopyFrom
¦¦+ 3
(
¦¦3 4
	hmacProof
¦¦4 =
)
¦¦= >
;
¦¦> ?
return
¨¨ 
Result
¨¨ 
<
¨¨ 
Unit
¨¨ 
,
¨¨ 
LogoutFailure
¨¨  -
>
¨¨- .
.
¨¨. /
Ok
¨¨/ 1
(
¨¨1 2
Unit
¨¨2 6
.
¨¨6 7
Value
¨¨7 <
)
¨¨< =
;
¨¨= >
}
©© 	
finally
ªª 
{
«« 	
masterKeyHandle
¬¬ 
?
¬¬ 
.
¬¬ 
Dispose
¬¬ $
(
¬¬$ %
)
¬¬% &
;
¬¬& '
if
­­ 
(
­­ 
hmacKey
­­ 
!=
­­ 
null
­­ 
)
­­  
{
®® %
CryptographicOperations
¯¯ '
.
¯¯' (

ZeroMemory
¯¯( 2
(
¯¯2 3
hmacKey
¯¯3 :
)
¯¯: ;
;
¯¯; <
}
°° 
}
±± 	
}
²² 
}´´ Ÿ
„/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/IOperationTimeoutProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
public 
	interface %
IOperationTimeoutProvider *
{ 
TimeSpan 

GetTimeout 
( 
RpcServiceType &
serviceType' 2
,2 3
RpcRequestContext4 E
?E F
requestContextG U
=V W
nullX \
)\ ]
;] ^
}		 ´ù
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/Infrastructure/PendingRequestManager.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Services

  
.

  !
Network

! (
.

( )
Infrastructure

) 7
;

7 8
internal 
	interface	  
ITypedPendingRequest '
{ 
Task 
ExecuteAsync	 
( 
CancellationToken '
cancellationToken( 9
)9 :
;: ;
void 
Cancel	 
( 
) 
; 
} 
public 
	interface "
IPendingRequestManager '
{ 
void "
RegisterPendingRequest	 
(  
string  &
	requestId' 0
,0 1
Func2 6
<6 7
CancellationToken7 H
,H I
TaskJ N
>N O
retryActionP [
)[ \
;\ ]
void  
RemovePendingRequest	 
( 
string $
	requestId% .
). /
;/ 0
Task 
< 	
int	 
> (
RetryAllPendingRequestsAsync *
(* +
CancellationToken+ <
cancellationToken= N
=O P
defaultQ X
)X Y
;Y Z
} 
public 
sealed 
class !
PendingRequestManager )
:* +"
IPendingRequestManager, B
{ 
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
Func2 6
<6 7
CancellationToken7 H
,H I
TaskJ N
>N O
>O P
_pendingRequestsQ a
=b c
newd g
(g h
)h i
;i j
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1 
ITypedPendingRequest2 F
>F G!
_typedPendingRequestsH ]
=^ _
new` c
(c d
)d e
;e f
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
bool2 6
>6 7
_retryingRequests8 I
=J K
newL O
(O P
)P Q
;Q R
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1#
CancellationTokenSource2 I
>I J'
_requestCancellationSourcesK f
=g h
newi l
(l m
)m n
;n o
private 
readonly 
SemaphoreSlim "
_retryAllSemaphore# 5
=6 7
new8 ;
(; <
$num< =
,= >
$num? @
)@ A
;A B
private   
int   
_pendingCount   
;   
public"" 

event"" 
EventHandler"" 
<"" 
int"" !
>""! "
?""" #
PendingCountChanged""$ 7
;""7 8
public$$ 

int$$ 
PendingRequestCount$$ "
=>$$# %
_pendingCount$$& 3
;$$3 4
public&& 

void&& "
RegisterPendingRequest&& &
(&&& '
string&&' -
	requestId&&. 7
,&&7 8
Func&&9 =
<&&= >
CancellationToken&&> O
,&&O P
Task&&Q U
>&&U V
retryAction&&W b
)&&b c
{'' #
CancellationTokenSource(( 

requestCts((  *
=((+ ,
new((- 0
(((0 1
)((1 2
;((2 3
if** 

(** 
!** 
_pendingRequests** 
.** 
TryAdd** $
(**$ %
	requestId**% .
,**. /
retryAction**0 ;
)**; <
)**< =
{++ 	

requestCts,, 
.,, 
Dispose,, 
(,, 
),,  
;,,  !
return-- 
;-- 
}.. 	
if00 

(00 
!00 '
_requestCancellationSources00 (
.00( )
TryAdd00) /
(00/ 0
	requestId000 9
,009 :

requestCts00; E
)00E F
)00F G
{11 	
_pendingRequests22 
.22 
	TryRemove22 &
(22& '
	requestId22' 0
,220 1
out222 5
_226 7
)227 8
;228 9

requestCts33 
.33 
Dispose33 
(33 
)33  
;33  !
return44 
;44 
}55 	
int77 
newCount77 
=77 
Interlocked77 "
.77" #
	Increment77# ,
(77, -
ref77- 0
_pendingCount771 >
)77> ?
;77? @
PendingCountChanged88 
?88 
.88 
Invoke88 #
(88# $
this88$ (
,88( )
newCount88* 2
)882 3
;883 4
}99 
public;; 

void;; "
RegisterPendingRequest;; &
<;;& '
T;;' (
>;;( )
(;;) *
string;;* 0
	requestId;;1 :
,;;: ;
Func;;< @
<;;@ A
CancellationToken;;A R
,;;R S
Task;;T X
<;;X Y
T;;Y Z
>;;Z [
>;;[ \
retryAction;;] h
,;;h i 
TaskCompletionSource<< 
<<< 
T<< 
><< (
originalTaskCompletionSource<<  <
)<<< =
{== #
CancellationTokenSource>> 

requestCts>>  *
=>>+ ,
new>>- 0
(>>0 1
)>>1 2
;>>2 3
TypedPendingRequest?? 
<?? 
T?? 
>?? 
typedRequest?? +
=??, -
new??. 1
(??1 2
retryAction??2 =
,??= >(
originalTaskCompletionSource??? [
)??[ \
;??\ ]
ifAA 

(AA 
!AA !
_typedPendingRequestsAA "
.AA" #
TryAddAA# )
(AA) *
	requestIdAA* 3
,AA3 4
typedRequestAA5 A
)AAA B
)AAB C
{BB 	

requestCtsCC 
.CC 
DisposeCC 
(CC 
)CC  
;CC  !
returnDD 
;DD 
}EE 	
ifGG 

(GG 
!GG '
_requestCancellationSourcesGG (
.GG( )
TryAddGG) /
(GG/ 0
	requestIdGG0 9
,GG9 :

requestCtsGG; E
)GGE F
)GGF G
{HH 	!
_typedPendingRequestsII !
.II! "
	TryRemoveII" +
(II+ ,
	requestIdII, 5
,II5 6
outII7 :
_II; <
)II< =
;II= >

requestCtsJJ 
.JJ 
DisposeJJ 
(JJ 
)JJ  
;JJ  !
returnKK 
;KK 
}LL 	
intNN 
newCountNN 
=NN 
InterlockedNN "
.NN" #
	IncrementNN# ,
(NN, -
refNN- 0
_pendingCountNN1 >
)NN> ?
;NN? @
PendingCountChangedOO 
?OO 
.OO 
InvokeOO #
(OO# $
thisOO$ (
,OO( )
newCountOO* 2
)OO2 3
;OO3 4
}PP 
publicRR 

voidRR  
RemovePendingRequestRR $
(RR$ %
stringRR% +
	requestIdRR, 5
)RR5 6
{SS 
boolTT 
removedTT 
=TT 
_pendingRequestsTT '
.TT' (
	TryRemoveTT( 1
(TT1 2
	requestIdTT2 ;
,TT; <
outTT= @
_TTA B
)TTB C
||TTD F!
_typedPendingRequestsUU ,
.UU, -
	TryRemoveUU- 6
(UU6 7
	requestIdUU7 @
,UU@ A
outUUB E
_UUF G
)UUG H
;UUH I
ifWW 

(WW '
_requestCancellationSourcesWW '
.WW' (
	TryRemoveWW( 1
(WW1 2
	requestIdWW2 ;
,WW; <
outWW= @#
CancellationTokenSourceWWA X
?WWX Y

requestCtsWWZ d
)WWd e
)WWe f
{XX 	

requestCtsYY 
.YY 
DisposeYY 
(YY 
)YY  
;YY  !
}ZZ 	
if\\ 

(\\ 
removed\\ 
)\\ 
{]] 	
int^^ 
newCount^^ 
=^^ 
Interlocked^^ &
.^^& '
	Decrement^^' 0
(^^0 1
ref^^1 4
_pendingCount^^5 B
)^^B C
;^^C D
PendingCountChanged__ 
?__  
.__  !
Invoke__! '
(__' (
this__( ,
,__, -
newCount__. 6
)__6 7
;__7 8
}`` 	
}aa 
publiccc 

asynccc 
Taskcc 
<cc 
intcc 
>cc (
RetryAllPendingRequestsAsynccc 7
(cc7 8
CancellationTokencc8 I
cancellationTokenccJ [
=cc\ ]
defaultcc^ e
)cce f
{dd 
awaitee 
_retryAllSemaphoreee  
.ee  !
	WaitAsyncee! *
(ee* +
cancellationTokenee+ <
)ee< =
.ee= >
ConfigureAwaitee> L
(eeL M
falseeeM R
)eeR S
;eeS T
tryff 
{gg 	
KeyValuePairhh 
<hh 
stringhh 
,hh  
Funchh! %
<hh% &
CancellationTokenhh& 7
,hh7 8
Taskhh9 =
>hh= >
>hh> ?
[hh? @
]hh@ A
untypedRequestshhB Q
=hhR S
_pendingRequestshhT d
.hhd e
ToArrayhhe l
(hhl m
)hhm n
;hhn o
KeyValuePairii 
<ii 
stringii 
,ii   
ITypedPendingRequestii! 5
>ii5 6
[ii6 7
]ii7 8
typedRequestsii9 F
=iiG H!
_typedPendingRequestsiiI ^
.ii^ _
ToArrayii_ f
(iif g
)iig h
;iih i
intjj 
successCountjj 
=jj 
$numjj  
;jj  !
Logll 
.ll 
Informationll 
(ll 
$strll o
,llo p
untypedRequestsmm 
.mm  
Lengthmm  &
,mm& '
typedRequestsmm( 5
.mm5 6
Lengthmm6 <
)mm< =
;mm= >
Listoo 
<oo 
KeyValuePairoo 
<oo 
stringoo $
,oo$ %
Funcoo& *
<oo* +
CancellationTokenoo+ <
,oo< =
Taskoo> B
>ooB C
>ooC D
>ooD E#
filteredUntypedRequestsooF ]
=oo^ _
[oo` a
]ooa b
;oob c
Listpp 
<pp 
KeyValuePairpp 
<pp 
stringpp $
,pp$ % 
ITypedPendingRequestpp& :
>pp: ;
>pp; <!
filteredTypedRequestspp= R
=ppS T
[ppU V
]ppV W
;ppW X
foreachrr 
(rr 
KeyValuePairrr !
<rr! "
stringrr" (
,rr( )
Funcrr* .
<rr. /
CancellationTokenrr/ @
,rr@ A
TaskrrB F
>rrF G
>rrG H
requestrrI P
inrrQ S
untypedRequestsrrT c
)rrc d
{ss 
iftt 
(tt 
_retryingRequeststt %
.tt% &
TryAddtt& ,
(tt, -
requesttt- 4
.tt4 5
Keytt5 8
,tt8 9
truett: >
)tt> ?
)tt? @
{uu #
filteredUntypedRequestsvv +
.vv+ ,
Addvv, /
(vv/ 0
requestvv0 7
)vv7 8
;vv8 9
}ww 
elsexx 
ifxx 
(xx 
Logxx 
.xx 
	IsEnabledxx &
(xx& '
LogEventLevelxx' 4
.xx4 5
Debugxx5 :
)xx: ;
)xx; <
{yy 
Logzz 
.zz 
Debugzz 
(zz 
$strzz ^
,zz^ _
requestzz` g
.zzg h
Keyzzh k
)zzk l
;zzl m
}{{ 
}|| 
foreach~~ 
(~~ 
KeyValuePair~~ !
<~~! "
string~~" (
,~~( ) 
ITypedPendingRequest~~* >
>~~> ?
request~~@ G
in~~H J
typedRequests~~K X
)~~X Y
{ 
if
€€ 
(
€€ 
_retryingRequests
€€ %
.
€€% &
TryAdd
€€& ,
(
€€, -
request
€€- 4
.
€€4 5
Key
€€5 8
,
€€8 9
true
€€: >
)
€€> ?
)
€€? @
{
 #
filteredTypedRequests
‚‚ )
.
‚‚) *
Add
‚‚* -
(
‚‚- .
request
‚‚. 5
)
‚‚5 6
;
‚‚6 7
}
ƒƒ 
else
„„ 
if
„„ 
(
„„ 
Log
„„ 
.
„„ 
	IsEnabled
„„ &
(
„„& '
LogEventLevel
„„' 4
.
„„4 5
Debug
„„5 :
)
„„: ;
)
„„; <
{
…… 
Log
†† 
.
†† 
Debug
†† 
(
†† 
$str
†† d
,
††d e
request
††f m
.
††m n
Key
††n q
)
††q r
;
††r s
}
‡‡ 
}
ˆˆ 
Task
ŠŠ 
[
ŠŠ 
]
ŠŠ 
untypedTasks
ŠŠ 
=
ŠŠ  !
new
ŠŠ" %
Task
ŠŠ& *
[
ŠŠ* +%
filteredUntypedRequests
ŠŠ+ B
.
ŠŠB C
Count
ŠŠC H
]
ŠŠH I
;
ŠŠI J
for
‹‹ 
(
‹‹ 
int
‹‹ 
i
‹‹ 
=
‹‹ 
$num
‹‹ 
;
‹‹ 
i
‹‹ 
<
‹‹ %
filteredUntypedRequests
‹‹  7
.
‹‹7 8
Count
‹‹8 =
;
‹‹= >
i
‹‹? @
++
‹‹@ B
)
‹‹B C
{
ŒŒ 
KeyValuePair
 
<
 
string
 #
,
# $
Func
% )
<
) *
CancellationToken
* ;
,
; <
Task
= A
>
A B
>
B C
request
D K
=
L M%
filteredUntypedRequests
N e
[
e f
i
f g
]
g h
;
h i
untypedTasks
ŽŽ 
[
ŽŽ 
i
ŽŽ 
]
ŽŽ 
=
ŽŽ  !
RetryRequestAsync
ŽŽ" 3
(
ŽŽ3 4
request
ŽŽ4 ;
.
ŽŽ; <
Key
ŽŽ< ?
,
ŽŽ? @
request
ŽŽA H
.
ŽŽH I
Value
ŽŽI N
,
ŽŽN O
cancellationToken
ŽŽP a
)
ŽŽa b
;
ŽŽb c
}
 
Task
‘‘ 
[
‘‘ 
]
‘‘ 

typedTasks
‘‘ 
=
‘‘ 
new
‘‘  #
Task
‘‘$ (
[
‘‘( )#
filteredTypedRequests
‘‘) >
.
‘‘> ?
Count
‘‘? D
]
‘‘D E
;
‘‘E F
for
’’ 
(
’’ 
int
’’ 
i
’’ 
=
’’ 
$num
’’ 
;
’’ 
i
’’ 
<
’’ #
filteredTypedRequests
’’  5
.
’’5 6
Count
’’6 ;
;
’’; <
i
’’= >
++
’’> @
)
’’@ A
{
““ 
KeyValuePair
”” 
<
”” 
string
”” #
,
””# $"
ITypedPendingRequest
””% 9
>
””9 :
request
””; B
=
””C D#
filteredTypedRequests
””E Z
[
””Z [
i
””[ \
]
””\ ]
;
””] ^

typedTasks
•• 
[
•• 
i
•• 
]
•• 
=
•• $
RetryTypedRequestAsync
••  6
(
••6 7
request
••7 >
.
••> ?
Key
••? B
,
••B C
request
••D K
.
••K L
Value
••L Q
,
••Q R
cancellationToken
••S d
)
••d e
;
••e f
}
–– 
Task
˜˜ 
[
˜˜ 
]
˜˜ 
allTasks
˜˜ 
=
˜˜ 
new
˜˜ !
Task
˜˜" &
[
˜˜& '
untypedTasks
˜˜' 3
.
˜˜3 4
Length
˜˜4 :
+
˜˜; <

typedTasks
˜˜= G
.
˜˜G H
Length
˜˜H N
]
˜˜N O
;
˜˜O P
Array
™™ 
.
™™ 
Copy
™™ 
(
™™ 
untypedTasks
™™ #
,
™™# $
allTasks
™™% -
,
™™- .
untypedTasks
™™/ ;
.
™™; <
Length
™™< B
)
™™B C
;
™™C D
Array
šš 
.
šš 
Copy
šš 
(
šš 

typedTasks
šš !
,
šš! "
$num
šš# $
,
šš$ %
allTasks
šš& .
,
šš. /
untypedTasks
šš0 <
.
šš< =
Length
šš= C
,
ššC D

typedTasks
ššE O
.
ššO P
Length
ššP V
)
ššV W
;
ššW X
if
œœ 
(
œœ 
allTasks
œœ 
.
œœ 
Length
œœ 
>
œœ  !
$num
œœ" #
)
œœ# $
{
 
await
žž 
Task
žž 
.
žž 
WhenAll
žž "
(
žž" #
allTasks
žž# +
)
žž+ ,
.
žž, -
ConfigureAwait
žž- ;
(
žž; <
false
žž< A
)
žžA B
;
žžB C
successCount
   
+=
   
allTasks
    (
.
  ( )
Count
  ) .
(
  . /
task
  / 3
=>
  4 6
task
  7 ;
.
  ; <%
IsCompletedSuccessfully
  < S
)
  S T
;
  T U
}
¡¡ 
Log
££ 
.
££ 
Information
££ 
(
££ 
$str
££ g
,
££g h
successCount
¤¤ 
,
¤¤ 
allTasks
¤¤ &
.
¤¤& '
Length
¤¤' -
)
¤¤- .
;
¤¤. /
return
¦¦ 
successCount
¦¦ 
;
¦¦  
}
§§ 	
finally
¨¨ 
{
©© 	 
_retryAllSemaphore
ªª 
.
ªª 
Release
ªª &
(
ªª& '
)
ªª' (
;
ªª( )
}
«« 	
}
¬¬ 
private
®® 
async
®® 
Task
®® 
RetryRequestAsync
®® (
(
®®( )
string
®®) /
	requestId
®®0 9
,
®®9 :
Func
®®; ?
<
®®? @
CancellationToken
®®@ Q
,
®®Q R
Task
®®S W
>
®®W X
retryAction
®®Y d
,
®®d e
CancellationToken
¯¯ 
cancellationToken
¯¯ +
)
¯¯+ ,
{
°° %
CancellationTokenSource
±± 
?
±±  
	linkedCts
±±! *
=
±±+ ,
null
±±- 1
;
±±1 2
try
²² 
{
³³ 	
CancellationToken
´´ 

tokenToUse
´´ (
=
´´) *
cancellationToken
´´+ <
;
´´< =
if
µµ 
(
µµ )
_requestCancellationSources
µµ +
.
µµ+ ,
TryGetValue
µµ, 7
(
µµ7 8
	requestId
µµ8 A
,
µµA B
out
µµC F%
CancellationTokenSource
µµG ^
?
µµ^ _

requestCts
µµ` j
)
µµj k
)
µµk l
{
¶¶ 
	linkedCts
·· 
=
·· %
CancellationTokenSource
·· 3
.
··3 4%
CreateLinkedTokenSource
··4 K
(
··K L
cancellationToken
··L ]
,
··] ^

requestCts
··_ i
.
··i j
Token
··j o
)
··o p
;
··p q

tokenToUse
¸¸ 
=
¸¸ 
	linkedCts
¸¸ &
.
¸¸& '
Token
¸¸' ,
;
¸¸, -
}
¹¹ 

tokenToUse
»» 
.
»» *
ThrowIfCancellationRequested
»» 3
(
»»3 4
)
»»4 5
;
»»5 6
Task
½½ 
	retryTask
½½ 
=
½½ 
retryAction
½½ (
(
½½( )

tokenToUse
½½) 3
)
½½3 4
;
½½4 5
if
¾¾ 
(
¾¾ 
!
¾¾ 
	retryTask
¾¾ 
.
¾¾ 
IsCompleted
¾¾ &
)
¾¾& '
{
¿¿ 
await
ÀÀ 
	retryTask
ÀÀ 
.
ÀÀ  
	WaitAsync
ÀÀ  )
(
ÀÀ) *

tokenToUse
ÀÀ* 4
)
ÀÀ4 5
.
ÀÀ5 6
ConfigureAwait
ÀÀ6 D
(
ÀÀD E
false
ÀÀE J
)
ÀÀJ K
;
ÀÀK L
}
ÁÁ 
else
ÂÂ 
{
ÃÃ 
await
ÄÄ 
	retryTask
ÄÄ 
.
ÄÄ  
ConfigureAwait
ÄÄ  .
(
ÄÄ. /
false
ÄÄ/ 4
)
ÄÄ4 5
;
ÄÄ5 6
}
ÅÅ "
RemovePendingRequest
ÇÇ  
(
ÇÇ  !
	requestId
ÇÇ! *
)
ÇÇ* +
;
ÇÇ+ ,
Log
ÈÈ 
.
ÈÈ 
Debug
ÈÈ 
(
ÈÈ 
$str
ÈÈ @
,
ÈÈ@ A
	requestId
ÈÈB K
)
ÈÈK L
;
ÈÈL M
}
ÉÉ 	
catch
ÊÊ 
(
ÊÊ (
OperationCanceledException
ÊÊ )
ex
ÊÊ* ,
)
ÊÊ, -
{
ËË 	
Log
ÌÌ 
.
ÌÌ 
Debug
ÌÌ 
(
ÌÌ 
ex
ÌÌ 
,
ÌÌ 
$str
ÌÌ K
,
ÌÌK L
	requestId
ÌÌM V
)
ÌÌV W
;
ÌÌW X
}
ÍÍ 	
catch
ÎÎ 
(
ÎÎ 
	Exception
ÎÎ 
ex
ÎÎ 
)
ÎÎ 
{
ÏÏ 	
Log
ÐÐ 
.
ÐÐ 
Warning
ÐÐ 
(
ÐÐ 
ex
ÐÐ 
,
ÐÐ 
$str
ÐÐ p
,
ÐÐp q
	requestId
ÐÐr {
)
ÐÐ{ |
;
ÐÐ| }
}
ÒÒ 	
finally
ÓÓ 
{
ÔÔ 	
	linkedCts
ÕÕ 
?
ÕÕ 
.
ÕÕ 
Dispose
ÕÕ 
(
ÕÕ 
)
ÕÕ  
;
ÕÕ  !
_retryingRequests
ÖÖ 
.
ÖÖ 
	TryRemove
ÖÖ '
(
ÖÖ' (
	requestId
ÖÖ( 1
,
ÖÖ1 2
out
ÖÖ3 6
_
ÖÖ7 8
)
ÖÖ8 9
;
ÖÖ9 :
}
×× 	
}
ØØ 
private
ÚÚ 
async
ÚÚ 
Task
ÚÚ $
RetryTypedRequestAsync
ÚÚ -
(
ÚÚ- .
string
ÚÚ. 4
	requestId
ÚÚ5 >
,
ÚÚ> ?"
ITypedPendingRequest
ÚÚ@ T
typedRequest
ÚÚU a
,
ÚÚa b
CancellationToken
ÛÛ 
cancellationToken
ÛÛ +
)
ÛÛ+ ,
{
ÜÜ %
CancellationTokenSource
ÝÝ 
?
ÝÝ  
	linkedCts
ÝÝ! *
=
ÝÝ+ ,
null
ÝÝ- 1
;
ÝÝ1 2
try
ÞÞ 
{
ßß 	
CancellationToken
àà 

tokenToUse
àà (
=
àà) *
cancellationToken
àà+ <
;
àà< =
if
áá 
(
áá )
_requestCancellationSources
áá +
.
áá+ ,
TryGetValue
áá, 7
(
áá7 8
	requestId
áá8 A
,
ááA B
out
ááC F%
CancellationTokenSource
ááG ^
?
áá^ _

requestCts
áá` j
)
ááj k
)
áák l
{
ââ 
	linkedCts
ãã 
=
ãã %
CancellationTokenSource
ãã 3
.
ãã3 4%
CreateLinkedTokenSource
ãã4 K
(
ããK L
cancellationToken
ããL ]
,
ãã] ^

requestCts
ãã_ i
.
ããi j
Token
ããj o
)
ãão p
;
ããp q

tokenToUse
ää 
=
ää 
	linkedCts
ää &
.
ää& '
Token
ää' ,
;
ää, -
}
åå 
await
çç 
typedRequest
çç 
.
çç 
ExecuteAsync
çç +
(
çç+ ,

tokenToUse
çç, 6
)
çç6 7
.
çç7 8
ConfigureAwait
çç8 F
(
ççF G
false
ççG L
)
ççL M
;
ççM N"
RemovePendingRequest
èè  
(
èè  !
	requestId
èè! *
)
èè* +
;
èè+ ,
Log
éé 
.
éé 
Debug
éé 
(
éé 
$str
éé F
,
ééF G
	requestId
ééH Q
)
ééQ R
;
ééR S
}
êê 	
catch
ëë 
(
ëë (
OperationCanceledException
ëë )
ex
ëë* ,
)
ëë, -
{
ìì 	
Log
íí 
.
íí 
Debug
íí 
(
íí 
ex
íí 
,
íí 
$str
íí Q
,
ííQ R
	requestId
ííS \
)
íí\ ]
;
íí] ^
}
îî 	
catch
ïï 
(
ïï 
	Exception
ïï 
ex
ïï 
)
ïï 
{
ðð 	
Log
ññ 
.
ññ 
Warning
ññ 
(
ññ 
ex
ññ 
,
ññ 
$str
ññ v
,
ññv w
	requestIdññx 
)ññ ‚
;ññ‚ ƒ
}
òò 	
finally
óó 
{
ôô 	
	linkedCts
õõ 
?
õõ 
.
õõ 
Dispose
õõ 
(
õõ 
)
õõ  
;
õõ  !
_retryingRequests
öö 
.
öö 
	TryRemove
öö '
(
öö' (
	requestId
öö( 1
,
öö1 2
out
öö3 6
_
öö7 8
)
öö8 9
;
öö9 :
}
÷÷ 	
}
øø 
public
úú 

void
úú &
CancelAllPendingRequests
úú (
(
úú( )
)
úú) *
{
ûû 
foreach
üü 
(
üü 
KeyValuePair
üü 
<
üü 
string
üü $
,
üü$ %%
CancellationTokenSource
üü& =
>
üü= >
entry
üü? D
in
üüE G)
_requestCancellationSources
üüH c
.
üüc d
ToArray
üüd k
(
üük l
)
üül m
)
üüm n
{
ýý 	
if
þþ 
(
þþ 
!
þþ )
_requestCancellationSources
þþ ,
.
þþ, -
	TryRemove
þþ- 6
(
þþ6 7
entry
þþ7 <
.
þþ< =
Key
þþ= @
,
þþ@ A
out
þþB E%
CancellationTokenSource
þþF ]
?
þþ] ^

requestCts
þþ_ i
)
þþi j
)
þþj k
{
ÿÿ 
continue
€€ 
;
€€ 
}
 
try
ƒƒ 
{
„„ 

requestCts
…… 
.
…… 
Cancel
…… !
(
……! "
)
……" #
;
……# $
}
†† 
catch
‡‡ 
(
‡‡ %
ObjectDisposedException
‡‡ *
)
‡‡* +
{
ˆˆ 
}
ŠŠ 
finally
‹‹ 
{
ŒŒ 

requestCts
 
.
 
Dispose
 "
(
" #
)
# $
;
$ %
}
ŽŽ 
}
 	
foreach
‘‘ 
(
‘‘ "
ITypedPendingRequest
‘‘ %
typedRequest
‘‘& 2
in
‘‘3 5#
_typedPendingRequests
‘‘6 K
.
‘‘K L
Values
‘‘L R
)
‘‘R S
{
’’ 	
typedRequest
““ 
.
““ 
Cancel
““ 
(
““  
)
““  !
;
““! "
}
”” 	
_pendingRequests
–– 
.
–– 
Clear
–– 
(
–– 
)
––  
;
––  !#
_typedPendingRequests
—— 
.
—— 
Clear
—— #
(
——# $
)
——$ %
;
——% &
_retryingRequests
˜˜ 
.
˜˜ 
Clear
˜˜ 
(
˜˜  
)
˜˜  !
;
˜˜! ")
_requestCancellationSources
™™ #
.
™™# $
Clear
™™$ )
(
™™) *
)
™™* +
;
™™+ ,
Interlocked
›› 
.
›› 
Exchange
›› 
(
›› 
ref
››  
_pendingCount
››! .
,
››. /
$num
››0 1
)
››1 2
;
››2 3!
PendingCountChanged
œœ 
?
œœ 
.
œœ 
Invoke
œœ #
(
œœ# $
this
œœ$ (
,
œœ( )
$num
œœ* +
)
œœ+ ,
;
œœ, -
}
 
}žž 
internal   
sealed
  	 
class
   !
TypedPendingRequest
   )
<
  ) *
T
  * +
>
  + ,
:
  - ."
ITypedPendingRequest
  / C
{¡¡ 
private
¢¢ 
readonly
¢¢ 
Func
¢¢ 
<
¢¢ 
CancellationToken
¢¢ +
,
¢¢+ ,
Task
¢¢- 1
<
¢¢1 2
T
¢¢2 3
>
¢¢3 4
>
¢¢4 5
_retryAction
¢¢6 B
;
¢¢B C
private
££ 
readonly
££ "
TaskCompletionSource
££ )
<
££) *
T
££* +
>
££+ ,+
_originalTaskCompletionSource
££- J
;
££J K
public
¥¥ 
!
TypedPendingRequest
¥¥ 
(
¥¥ 
Func
¥¥ #
<
¥¥# $
CancellationToken
¥¥$ 5
,
¥¥5 6
Task
¥¥7 ;
<
¥¥; <
T
¥¥< =
>
¥¥= >
>
¥¥> ?
retryAction
¥¥@ K
,
¥¥K L"
TaskCompletionSource
¦¦ 
<
¦¦ 
T
¦¦ 
>
¦¦ *
originalTaskCompletionSource
¦¦  <
)
¦¦< =
{
§§ 
_retryAction
¨¨ 
=
¨¨ 
retryAction
¨¨ "
;
¨¨" #+
_originalTaskCompletionSource
©© %
=
©©& '*
originalTaskCompletionSource
©©( D
;
©©D E
}
ªª 
public
¬¬ 

async
¬¬ 
Task
¬¬ 
ExecuteAsync
¬¬ "
(
¬¬" #
CancellationToken
¬¬# 4
cancellationToken
¬¬5 F
)
¬¬F G
{
­­ 
try
®® 
{
¯¯ 	
cancellationToken
°° 
.
°° *
ThrowIfCancellationRequested
°° :
(
°°: ;
)
°°; <
;
°°< =
Task
²² 
<
²² 
T
²² 
>
²² 
	retryTask
²² 
=
²² 
_retryAction
²²  ,
(
²², -
cancellationToken
²²- >
)
²²> ?
;
²²? @
T
³³ 
result
³³ 
=
³³ 
await
³³ 
(
³³ 
	retryTask
³³ '
.
³³' (
IsCompleted
³³( 3
?
´´ 
	retryTask
´´ 
:
µµ 
	retryTask
µµ 
.
µµ  
	WaitAsync
µµ  )
(
µµ) *
cancellationToken
µµ* ;
)
µµ; <
)
µµ< =
.
¶¶ 
ConfigureAwait
¶¶ 
(
¶¶  
false
¶¶  %
)
¶¶% &
;
¶¶& '+
_originalTaskCompletionSource
¸¸ )
.
¸¸) *
	SetResult
¸¸* 3
(
¸¸3 4
result
¸¸4 :
)
¸¸: ;
;
¸¸; <
}
¹¹ 	
catch
ºº 
(
ºº (
OperationCanceledException
ºº )
)
ºº) *
{
»» 	+
_originalTaskCompletionSource
¼¼ )
.
¼¼) *
TrySetCanceled
¼¼* 8
(
¼¼8 9
cancellationToken
¼¼9 J
)
¼¼J K
;
¼¼K L
throw
½½ 
;
½½ 
}
¾¾ 	
catch
¿¿ 
(
¿¿ 
	Exception
¿¿ 
ex
¿¿ 
)
¿¿ 
{
ÀÀ 	+
_originalTaskCompletionSource
ÁÁ )
.
ÁÁ) *
SetException
ÁÁ* 6
(
ÁÁ6 7
ex
ÁÁ7 9
)
ÁÁ9 :
;
ÁÁ: ;
throw
ÂÂ 
;
ÂÂ 
}
ÃÃ 	
}
ÄÄ 
public
ÆÆ 

void
ÆÆ 
Cancel
ÆÆ 
(
ÆÆ 
)
ÆÆ 
{
ÇÇ +
_originalTaskCompletionSource
ÈÈ %
.
ÈÈ% &
TrySetCanceled
ÈÈ& 4
(
ÈÈ4 5
)
ÈÈ5 6
;
ÈÈ6 7
}
ÉÉ 
}ÊÊ ú
€/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/IGrpcDeadlineProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
public 
	interface !
IGrpcDeadlineProvider &
{ 
DateTime 
GetDeadlineUtc 
( 
RpcServiceType *
serviceType+ 6
,6 7
RpcRequestContext8 I
?I J
requestContextK Y
)Y Z
;Z [
}		 º
‚/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/IGrpcCallOptionsFactory.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
public 
	interface #
IGrpcCallOptionsFactory (
{ 
CallOptions		 
Create		 
(		 
RpcServiceType

 
serviceType

 "
,

" #
RpcRequestContext 
? 
requestContext )
,) *
CancellationToken 
cancellationToken +
,+ ,
Metadata 
? 
additionalHeaders #
=$ %
null& *
)* +
;+ ,
} Ž
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/GrpcDeadlineProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
internal 
sealed	 
class  
GrpcDeadlineProvider *
(* +%
IOperationTimeoutProvider+ D
timeoutProviderE T
)T U
:V W!
IGrpcDeadlineProviderX m
{		 
private

 
static

 
readonly

 
TimeSpan

 $
DefaultDeadline

% 4
=

5 6
TimeSpan

7 ?
.

? @
FromSeconds

@ K
(

K L
$num

L N
)

N O
;

O P
public 

DateTime 
GetDeadlineUtc "
(" #
RpcServiceType# 1
serviceType2 =
,= >
RpcRequestContext? P
?P Q
requestContextR `
)` a
{ 
TimeSpan 
operationTimeout !
=" #
timeoutProvider$ 3
.3 4

GetTimeout4 >
(> ?
serviceType? J
,J K
requestContextL Z
)Z [
;[ \
TimeSpan 
normalizedTimeout "
=# $
NormalizeTimeout% 5
(5 6
operationTimeout6 F
)F G
;G H
DateTime 
now 
= 
DateTime 
.  
UtcNow  &
;& '
try 
{ 	
return 
now 
. 
Add 
( 
normalizedTimeout ,
), -
;- .
} 	
catch 
{ 	
return 
DateTime 
. 
SpecifyKind '
(' (
DateTime( 0
.0 1
MaxValue1 9
.9 :
AddTicks: B
(B C
-C D
$numD E
)E F
,F G
DateTimeKindH T
.T U
UtcU X
)X Y
;Y Z
} 	
} 
private 
static 
TimeSpan 
NormalizeTimeout ,
(, -
TimeSpan- 5
timeout6 =
)= >
{ 
if 

( 
timeout 
== 
Timeout 
. 
InfiniteTimeSpan /
)/ 0
{ 	
return   
TimeSpan   
.   
	FromHours   %
(  % &
$num  & (
)  ( )
;  ) *
}!! 	
return## 
timeout## 
<=## 
TimeSpan## "
.##" #
Zero### '
?##( )
DefaultDeadline##* 9
:##: ;
timeout##< C
;##C D
}$$ 
}%% ™-
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Network/GrpcCallOptionsFactory.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Network! (
;( )
internal		 
sealed			 
class		 "
GrpcCallOptionsFactory		 ,
(		, -!
IGrpcDeadlineProvider		- B
deadlineProvider		C S
)		S T
:		U V#
IGrpcCallOptionsFactory		W n
{

 
public 

CallOptions 
Create 
( 
RpcServiceType 
serviceType "
," #
RpcRequestContext 
? 
requestContext )
,) *
CancellationToken 
cancellationToken +
,+ ,
Metadata 
? 
additionalHeaders #
=$ %
null& *
)* +
{ 
Metadata 
? 
headers 
= 
MergeHeaders (
(( )
BuildHeaders) 5
(5 6
requestContext6 D
)D E
,E F
additionalHeadersG X
)X Y
;Y Z
DateTime 
deadlineUtc 
= 
deadlineProvider /
./ 0
GetDeadlineUtc0 >
(> ?
serviceType? J
,J K
requestContextL Z
)Z [
;[ \
return 
new 
CallOptions 
( 
headers &
,& '
deadline( 0
:0 1
deadlineUtc2 =
,= >
cancellationToken? P
:P Q
cancellationTokenR c
)c d
;d e
} 
private 
static 
Metadata 
? 
BuildHeaders )
() *
RpcRequestContext* ;
?; <
requestContext= K
)K L
{ 
if 

( 
requestContext 
== 
null "
)" #
{ 	
return 
null 
; 
} 	
Metadata 
headers 
= 
new 
( 
)  
{ 	
{ 
$str  
,  !
requestContext" 0
.0 1
CorrelationId1 >
}? @
,@ A
{   
$str   !
,  ! "
requestContext  # 1
.  1 2
IdempotencyKey  2 @
}  A B
,  B C
{!! 
$str!! 
,!! 
requestContext!! )
.!!) *
Attempt!!* 1
.!!1 2
ToString!!2 :
(!!: ;
CultureInfo!!; F
.!!F G
InvariantCulture!!G W
)!!W X
}!!Y Z
}"" 	
;""	 

if$$ 

($$ 
requestContext$$ 
.$$ 
ReinitAttempted$$ *
)$$* +
{%% 	
headers&& 
.&& 
Add&& 
(&& 
$str&& ,
,&&, -
$str&&. 4
)&&4 5
;&&5 6
}'' 	
return)) 
headers)) 
;)) 
}** 
private,, 
static,, 
Metadata,, 
?,, 
MergeHeaders,, )
(,,) *
Metadata,,* 2
?,,2 3
baseHeaders,,4 ?
,,,? @
Metadata,,A I
?,,I J
additionalHeaders,,K \
),,\ ]
{-- 
if.. 

(.. 
additionalHeaders.. 
==..  
null..! %
||..& (
additionalHeaders..) :
...: ;
Count..; @
==..A C
$num..D E
)..E F
{// 	
return00 
baseHeaders00 
;00 
}11 	
Metadata33 
merged33 
=33 
[33 
]33 
;33 
if55 

(55 
baseHeaders55 
!=55 
null55 
)55  
{66 	
foreach77 
(77 
Metadata77 
.77 
Entry77 #
entry77$ )
in77* ,
baseHeaders77- 8
)778 9
{88 
AddEntry99 
(99 
merged99 
,99  
entry99! &
)99& '
;99' (
}:: 
};; 	
foreach== 
(== 
Metadata== 
.== 
Entry== 
entry==  %
in==& (
additionalHeaders==) :
)==: ;
{>> 	
AddEntry?? 
(?? 
merged?? 
,?? 
entry?? "
)??" #
;??# $
}@@ 	
returnBB 
mergedBB 
;BB 
}CC 
privateEE 
staticEE 
voidEE 
AddEntryEE  
(EE  !
MetadataEE! )
targetEE* 0
,EE0 1
MetadataEE2 :
.EE: ;
EntryEE; @
entryEEA F
)EEF G
{FF 
ifGG 

(GG 
entryGG 
.GG 
IsBinaryGG 
)GG 
{HH 	
targetII 
.II 
AddII 
(II 
entryII 
.II 
KeyII  
,II  !
entryII" '
.II' (

ValueBytesII( 2
)II2 3
;II3 4
}JJ 	
elseKK 
{LL 	
targetMM 
.MM 
AddMM 
(MM 
entryMM 
.MM 
KeyMM  
,MM  !
entryMM" '
.MM' (
ValueMM( -
)MM- .
;MM. /
}NN 	
}OO 
}PP âÌ
€/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Membership/SecureKeyValidator.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !

Membership! +
;+ ,
public

 
static

 
partial

 
class

 
SecureKeyValidator

 .
{ 
private 
static 
readonly 
Regex !
HasUppercaseRegex" 3
=4 5$
HasUppercaseRegexPattern6 N
(N O
)O P
;P Q
private 
static 
readonly 
Regex !
HasDigitRegex" /
=0 1 
HasDigitRegexPattern2 F
(F G
)G H
;H I
private 
static 
readonly 
Regex !
HasLowercaseRegex" 3
=4 5$
HasLowercaseRegexPattern6 N
(N O
)O P
;P Q
private 
static 
readonly 
Regex !
HasSpecialCharRegex" 5
=6 7&
HasSpecialCharRegexPattern8 R
(R S
)S T
;T U
private 
static 
readonly 
Regex !$
HasNonEnglishLetterRegex" :
=; <+
HasNonEnglishLetterRegexPattern= \
(\ ]
)] ^
;^ _
[ 
GeneratedRegex 
( 
$str 
, 
RegexOptions )
.) *
Compiled* 2
)2 3
]3 4
private 
static 
partial 
Regex  $
HasUppercaseRegexPattern! 9
(9 :
): ;
;; <
[ 
GeneratedRegex 
( 
$str 
, 
RegexOptions '
.' (
Compiled( 0
)0 1
]1 2
private 
static 
partial 
Regex   
HasDigitRegexPattern! 5
(5 6
)6 7
;7 8
[ 
GeneratedRegex 
( 
$str 
, 
RegexOptions )
.) *
Compiled* 2
)2 3
]3 4
private 
static 
partial 
Regex  $
HasLowercaseRegexPattern! 9
(9 :
): ;
;; <
[ 
GeneratedRegex 
( 
$str "
," #
RegexOptions$ 0
.0 1
Compiled1 9
)9 :
]: ;
private 
static 
partial 
Regex  &
HasSpecialCharRegexPattern! ;
(; <
)< =
;= >
[ 
GeneratedRegex 
( 
$str '
,' (
RegexOptions) 5
.5 6
Compiled6 >
)> ?
]? @
private 
static 
partial 
Regex  +
HasNonEnglishLetterRegexPattern! @
(@ A
)A B
;B C
public!! 

static!! 
(!! 
string!! 
?!! 
ERROR!!  
,!!  !
List!!" &
<!!& '
string!!' -
>!!- .
Recommendations!!/ >
)!!> ?
Validate!!@ H
(!!H I
string!!I O
	secureKey!!P Y
,!!Y Z 
ILocalizationService"" 
localizationService"" 0
,""0 1
bool""2 6
_""7 8
=""9 :
false""; @
)""@ A
{## 
List$$ 
<$$ 
string$$ 
>$$ 
recommendations$$ $
=$$% &
[$$' (
]$$( )
;$$) *
List&& 
<&& 
(&& 
Func&& 
<&& 
string&& 
,&& 
bool&& 
>&&  
	IsInvalid&&! *
,&&* +
string&&, 2
ErrorMessageKey&&3 B
,&&B C
object&&D J
[&&J K
]&&K L
?&&L M
Args&&N R
)&&R S
>&&S T
hardValidationRules&&U h
=&&i j
['' 	
(((  
HasNonEnglishLetters(( !
,((! "'
SecureKeyValidatorConstants((# >
.((> ?
LocalizationKeys((? O
.((O P
NON_ENGLISH_LETTERS((P c
,((c d
null((e i
)((i j
,((j k
()) 
string)) 
.)) 
IsNullOrWhiteSpace)) &
,))& ''
SecureKeyValidatorConstants))( C
.))C D
LocalizationKeys))D T
.))T U
REQUIRED))U ]
,))] ^
null))_ c
)))c d
,))d e
(** 
s** 
=>** 
s** 
.** 
Length** 
<** '
SecureKeyValidatorConstants** 8
.**8 9
ValidationRules**9 H
.**H I

MIN_LENGTH**I S
,**S T'
SecureKeyValidatorConstants++ +
.+++ ,
LocalizationKeys++, <
.++< =

MIN_LENGTH++= G
,++G H
[,, '
SecureKeyValidatorConstants,, ,
.,,, -
ValidationRules,,- <
.,,< =

MIN_LENGTH,,= G
],,G H
),,H I
,,,I J
(-- 
s-- 
=>-- 
!-- 
HasUppercaseRegex-- $
.--$ %
IsMatch--% ,
(--, -
s--- .
)--. /
,--/ 0'
SecureKeyValidatorConstants--1 L
.--L M
LocalizationKeys--M ]
.--] ^
NO_UPPERCASE--^ j
,--j k
null--l p
)--p q
,--q r
(.. 
s.. 
=>.. 
!.. 
HasLowercaseRegex.. $
...$ %
IsMatch..% ,
(.., -
s..- .
)... /
,../ 0'
SecureKeyValidatorConstants..1 L
...L M
LocalizationKeys..M ]
...] ^
NO_LOWERCASE..^ j
,..j k
null..l p
)..p q
,..q r
(// 
s// 
=>// 
!// 
HasSpecialCharRegex// &
.//& '
IsMatch//' .
(//. /
s/// 0
)//0 1
,//1 2'
SecureKeyValidatorConstants//3 N
.//N O
LocalizationKeys//O _
.//_ `
NO_SPECIAL_CHAR//` o
,//o p
null//q u
)//u v
]00 	
;00	 

List22 
<22 
(22 
Func22 
<22 
string22 
,22 
bool22 
>22  
IsWeak22! '
,22' (
string22) /
ErrorMessageKey220 ?
,22? @
object22A G
[22G H
]22H I
?22I J
Args22K O
)22O P
>22P Q
recommendationRules22R e
=22f g
[33 	
(44 
s44 
=>44 
!44 
HasDigitRegex44  
.44  !
IsMatch44! (
(44( )
s44) *
)44* +
,44+ ,'
SecureKeyValidatorConstants44- H
.44H I
LocalizationKeys44I Y
.44Y Z
NO_DIGIT44Z b
,44b c
null44d h
)44h i
,44i j
(55 
s55 
=>55 
s55 
.55 
Length55 
>55 '
SecureKeyValidatorConstants55 8
.558 9
ValidationRules559 H
.55H I

MAX_LENGTH55I S
,55S T'
SecureKeyValidatorConstants66 +
.66+ ,
LocalizationKeys66, <
.66< =

MAX_LENGTH66= G
,66G H
[77 '
SecureKeyValidatorConstants77 ,
.77, -
ValidationRules77- <
.77< =

MAX_LENGTH77= G
]77G H
)77H I
,77I J
(88 
s88 
=>88 
s88 
.88 
Trim88 
(88 
)88 
!=88 
s88 
,88  '
SecureKeyValidatorConstants88! <
.88< =
LocalizationKeys88= M
.88M N
	NO_SPACES88N W
,88W X
null88Y ]
)88] ^
,88^ _
(99 
s99 
=>99 (
CalculateTotalShannonEntropy99 .
(99. /
s99/ 0
)990 1
<992 3'
SecureKeyValidatorConstants994 O
.99O P
ValidationRules99P _
.99_ `"
MIN_TOTAL_ENTROPY_BITS99` v
,99v w'
SecureKeyValidatorConstants:: +
.::+ ,
LocalizationKeys::, <
.::< =

TOO_SIMPLE::= G
,::G H
null::I M
)::M N
,::N O
(;; 
s;; 
=>;; '
SecureKeyValidatorConstants;; -
.;;- ."
CommonlyUsedSecureKeys;;. D
.;;D E
Contains;;E M
(;;M N
s;;N O
);;O P
,;;P Q'
SecureKeyValidatorConstants<< +
.<<+ ,
LocalizationKeys<<, <
.<<< =

TOO_COMMON<<= G
,<<G H
null<<I M
)<<M N
,<<N O
(== )
IsSequentialOrKeyboardPattern== *
,==* +'
SecureKeyValidatorConstants==, G
.==G H
LocalizationKeys==H X
.==X Y
SEQUENTIAL_PATTERN==Y k
,==k l
null==m q
)==q r
,==r s
(>> 
HasExcessiveRepeats>>  
,>>  !'
SecureKeyValidatorConstants>>" =
.>>= >
LocalizationKeys>>> N
.>>N O
REPEATED_CHARS>>O ]
,>>] ^
null>>_ c
)>>c d
,>>d e
(?? #
LacksCharacterDiversity?? $
,??$ %'
SecureKeyValidatorConstants??& A
.??A B
LocalizationKeys??B R
.??R S
LACKS_DIVERSITY??S b
,??b c
[@@ '
SecureKeyValidatorConstants@@ ,
.@@, -
ValidationRules@@- <
.@@< =
MIN_CHAR_CLASSES@@= M
]@@M N
)@@N O
,@@O P
(AA "
ContainsAppNameVariantAA #
,AA# $'
SecureKeyValidatorConstantsAA% @
.AA@ A
LocalizationKeysAAA Q
.AAQ R
CONTAINS_APP_NAMEAAR c
,AAc d
nullAAe i
)AAi j
]BB 	
;BB	 

foreachDD 
(DD 
(DD 
FuncDD 
<DD 
stringDD 
,DD 
boolDD #
>DD# $
	isInvalidDD% .
,DD. /
stringDD0 6
errorMessageKeyDD7 F
,DDF G
objectDDH N
[DDN O
]DDO P
?DDP Q
argsDDR V
)DDV W
inDDX Z
hardValidationRulesDD[ n
)DDn o
{EE 	
boolFF 
resultFF 
=FF 
	isInvalidFF #
(FF# $
	secureKeyFF$ -
)FF- .
;FF. /
ifGG 
(GG 
!GG 
resultGG 
)GG 
{HH 
continueII 
;II 
}JJ 
stringLL 
messageLL 
=LL 
localizationServiceLL 0
[LL0 1
errorMessageKeyLL1 @
]LL@ A
;LLA B
stringMM 
?MM 
errorMM 
=MM 
argsMM  
!=MM! #
nullMM$ (
?MM) *
stringMM+ 1
.MM1 2
FormatMM2 8
(MM8 9
messageMM9 @
,MM@ A
argsMMB F
)MMF G
:MMH I
messageMMJ Q
;MMQ R
returnNN 
(NN 
errorNN 
,NN 
recommendationsNN *
)NN* +
;NN+ ,
}OO 	
foreachQQ 
(QQ 
(QQ 
FuncQQ 
<QQ 
stringQQ 
,QQ 
boolQQ #
>QQ# $
isWeakQQ% +
,QQ+ ,
stringQQ- 3
errorMessageKeyQQ4 C
,QQC D
objectQQE K
[QQK L
]QQL M
?QQM N
argsQQO S
)QQS T
inQQU W
recommendationRulesQQX k
)QQk l
{RR 	
boolSS 
resultSS 
=SS 
isWeakSS  
(SS  !
	secureKeySS! *
)SS* +
;SS+ ,
ifTT 
(TT 
!TT 
resultTT 
)TT 
{UU 
continueVV 
;VV 
}WW 
stringYY 
messageYY 
=YY 
localizationServiceYY 0
[YY0 1
errorMessageKeyYY1 @
]YY@ A
;YYA B
recommendationsZZ 
.ZZ 
AddZZ 
(ZZ  
argsZZ  $
!=ZZ% '
nullZZ( ,
?ZZ- .
stringZZ/ 5
.ZZ5 6
FormatZZ6 <
(ZZ< =
messageZZ= D
,ZZD E
argsZZF J
)ZZJ K
:ZZL M
messageZZN U
)ZZU V
;ZZV W
}[[ 	
return]] 
(]] 
null]] 
,]] 
recommendations]] %
)]]% &
;]]& '
}^^ 
public`` 

static`` 
SecureKeyStrength`` #%
EstimateSecureKeyStrength``$ =
(``= >
string``> D
	secureKey``E N
,``N O 
ILocalizationService``P d
localizationService``e x
)``x y
{aa 
(bb 	
stringbb	 
?bb 
errorbb 
,bb 
Listbb 
<bb 
stringbb #
>bb# $
recommendationsbb% 4
)bb4 5
=bb6 7
Validatebb8 @
(bb@ A
	secureKeybbA J
,bbJ K
localizationServicebbL _
)bb_ `
;bb` a
ifcc 

(cc 
errorcc 
!=cc 
nullcc 
)cc 
{dd 	
returnee 
SecureKeyStrengthee $
.ee$ %
INVALIDee% ,
;ee, -
}ff 	
inthh 
scorehh 
=hh 
$numhh 
;hh 
scoreii 
+=ii 
	secureKeyii 
.ii 
Lengthii !
switchii" (
{jj 	
>=kk 
$numkk 
=>kk 
$numkk 
,kk 
>=ll 
$numll 
=>ll 
$numll 
,ll 
>=mm 
$nummm 
=>mm 
$nummm 
,mm 
>=nn 
$numnn 
=>nn 
$numnn 
,nn 
_oo 
=>oo 
$numoo 
}pp 	
;pp	 

intrr 
varietyrr 
=rr "
GetCharacterClassCountrr ,
(rr, -
	secureKeyrr- 6
)rr6 7
;rr7 8
ifss 

(ss 
varietyss 
>=ss 
$numss 
)ss 
{tt 	
scoreuu 
+=uu 
$numuu 
;uu 
}vv 	
ifxx 

(xx 
varietyxx 
>=xx 
$numxx 
)xx 
{yy 	
scorezz 
+=zz 
$numzz 
;zz 
}{{ 	
if}} 

(}} 
variety}} 
==}} 
$num}} 
)}} 
{~~ 	
score 
+= 
$num 
; 
}
€€ 	
score
‚‚ 
-=
‚‚ 
recommendations
‚‚  
.
‚‚  !
Count
‚‚! &
;
‚‚& '
SecureKeyStrength
„„ 
strength
„„ "
=
„„# $
score
„„% *
switch
„„+ 1
{
…… 	
<=
†† 
$num
†† 
=>
†† 
SecureKeyStrength
†† %
.
††% &
WEAK
††& *
,
††* +
<=
‡‡ 
$num
‡‡ 
=>
‡‡ 
SecureKeyStrength
‡‡ %
.
‡‡% &
GOOD
‡‡& *
,
‡‡* +
<=
ˆˆ 
$num
ˆˆ 
=>
ˆˆ 
SecureKeyStrength
ˆˆ %
.
ˆˆ% &
STRONG
ˆˆ& ,
,
ˆˆ, -
_
‰‰ 
=>
‰‰ 
SecureKeyStrength
‰‰ "
.
‰‰" #
VERY_STRONG
‰‰# .
}
ŠŠ 	
;
ŠŠ	 

return
‹‹ 
strength
‹‹ 
;
‹‹ 
}
ŒŒ 
private
 
static
 
bool
 +
IsSequentialOrKeyboardPattern
 5
(
5 6
string
6 <
s
= >
)
> ?
{
 
if
‘‘ 

(
‘‘ 
s
‘‘ 
.
‘‘ 
Length
‘‘ 
<
‘‘ 
$num
‘‘ 
)
‘‘ 
{
’’ 	
return
““ 
false
““ 
;
““ 
}
”” 	
string
–– 
lower
–– 
=
–– 
s
–– 
.
–– 
ToLowerInvariant
–– )
(
––) *
)
––* +
;
––+ ,
for
—— 
(
—— 
int
—— 
i
—— 
=
—— 
$num
—— 
;
—— 
i
—— 
<=
—— 
lower
—— "
.
——" #
Length
——# )
-
——* +
$num
——, -
;
——- .
i
——/ 0
++
——0 2
)
——2 3
{
˜˜ 	
string
™™ 
sub
™™ 
=
™™ 
lower
™™ 
.
™™ 
	Substring
™™ (
(
™™( )
i
™™) *
,
™™* +
$num
™™, -
)
™™- .
;
™™. /
if
šš 
(
šš )
SecureKeyValidatorConstants
šš +
.
šš+ ,
KeyboardRows
šš, 8
.
šš8 9
Any
šš9 <
(
šš< =
row
šš= @
=>
ššA C
row
ššD G
.
ššG H
Contains
ššH P
(
ššP Q
sub
ššQ T
)
ššT U
)
ššU V
||
ššW Y
IsCharSequence
ššZ h
(
ššh i
sub
šši l
)
ššl m
)
ššm n
{
›› 
return
œœ 
true
œœ 
;
œœ 
}
 
}
žž 	
return
   
false
   
;
   
}
¡¡ 
private
££ 
static
££ 
bool
££ 
IsCharSequence
££ &
(
££& '
string
££' -
sub
££. 1
)
££1 2
{
¤¤ 
bool
¥¥ 
asc
¥¥ 
=
¥¥ 
true
¥¥ 
,
¥¥ 
desc
¥¥ 
=
¥¥ 
true
¥¥  $
;
¥¥$ %
for
¦¦ 
(
¦¦ 
int
¦¦ 
j
¦¦ 
=
¦¦ 
$num
¦¦ 
;
¦¦ 
j
¦¦ 
<
¦¦ 
sub
¦¦ 
.
¦¦  
Length
¦¦  &
;
¦¦& '
j
¦¦( )
++
¦¦) +
)
¦¦+ ,
{
§§ 	
if
¨¨ 
(
¨¨ 
sub
¨¨ 
[
¨¨ 
j
¨¨ 
]
¨¨ 
!=
¨¨ 
sub
¨¨ 
[
¨¨ 
j
¨¨ 
-
¨¨  !
$num
¨¨" #
]
¨¨# $
+
¨¨% &
$num
¨¨' (
)
¨¨( )
{
©© 
asc
ªª 
=
ªª 
false
ªª 
;
ªª 
}
«« 
if
­­ 
(
­­ 
sub
­­ 
[
­­ 
j
­­ 
]
­­ 
!=
­­ 
sub
­­ 
[
­­ 
j
­­ 
-
­­  !
$num
­­" #
]
­­# $
-
­­% &
$num
­­' (
)
­­( )
{
®® 
desc
¯¯ 
=
¯¯ 
false
¯¯ 
;
¯¯ 
}
°° 
}
±± 	
return
³³ 
asc
³³ 
||
³³ 
desc
³³ 
;
³³ 
}
´´ 
private
¶¶ 
static
¶¶ 
bool
¶¶ !
HasExcessiveRepeats
¶¶ +
(
¶¶+ ,
string
¶¶, 2
s
¶¶3 4
)
¶¶4 5
{
·· 
if
¸¸ 

(
¸¸ 
s
¸¸ 
.
¸¸ 
Length
¸¸ 
<
¸¸ 
$num
¸¸ 
)
¸¸ 
{
¹¹ 	
return
ºº 
false
ºº 
;
ºº 
}
»» 	
for
½½ 
(
½½ 
int
½½ 
i
½½ 
=
½½ 
$num
½½ 
;
½½ 
i
½½ 
<=
½½ 
s
½½ 
.
½½ 
Length
½½ %
-
½½& '
$num
½½( )
;
½½) *
i
½½+ ,
++
½½, .
)
½½. /
{
¾¾ 	
if
¿¿ 
(
¿¿ 
s
¿¿ 
[
¿¿ 
i
¿¿ 
]
¿¿ 
==
¿¿ 
s
¿¿ 
[
¿¿ 
i
¿¿ 
+
¿¿ 
$num
¿¿ 
]
¿¿  
&&
¿¿! #
s
¿¿$ %
[
¿¿% &
i
¿¿& '
]
¿¿' (
==
¿¿) +
s
¿¿, -
[
¿¿- .
i
¿¿. /
+
¿¿0 1
$num
¿¿2 3
]
¿¿3 4
&&
¿¿5 7
s
¿¿8 9
[
¿¿9 :
i
¿¿: ;
]
¿¿; <
==
¿¿= ?
s
¿¿@ A
[
¿¿A B
i
¿¿B C
+
¿¿D E
$num
¿¿F G
]
¿¿G H
)
¿¿H I
{
ÀÀ 
return
ÁÁ 
true
ÁÁ 
;
ÁÁ 
}
ÂÂ 
}
ÃÃ 	
return
ÅÅ 
false
ÅÅ 
;
ÅÅ 
}
ÆÆ 
private
ÈÈ 
static
ÈÈ 
bool
ÈÈ %
LacksCharacterDiversity
ÈÈ /
(
ÈÈ/ 0
string
ÈÈ0 6
s
ÈÈ7 8
)
ÈÈ8 9
=>
ÈÈ: <$
GetCharacterClassCount
ÉÉ 
(
ÉÉ 
s
ÉÉ  
)
ÉÉ  !
<
ÉÉ" #)
SecureKeyValidatorConstants
ÉÉ$ ?
.
ÉÉ? @
ValidationRules
ÉÉ@ O
.
ÉÉO P
MIN_CHAR_CLASSES
ÉÉP `
;
ÉÉ` a
private
ËË 
static
ËË 
int
ËË $
GetCharacterClassCount
ËË -
(
ËË- .
string
ËË. 4
s
ËË5 6
)
ËË6 7
{
ÌÌ 
int
ÍÍ 
classes
ÍÍ 
=
ÍÍ 
$num
ÍÍ 
;
ÍÍ 
if
ÎÎ 

(
ÎÎ 
HasLowercaseRegex
ÎÎ 
.
ÎÎ 
IsMatch
ÎÎ %
(
ÎÎ% &
s
ÎÎ& '
)
ÎÎ' (
)
ÎÎ( )
{
ÏÏ 	
classes
ÐÐ 
++
ÐÐ 
;
ÐÐ 
}
ÑÑ 	
if
ÓÓ 

(
ÓÓ 
HasUppercaseRegex
ÓÓ 
.
ÓÓ 
IsMatch
ÓÓ %
(
ÓÓ% &
s
ÓÓ& '
)
ÓÓ' (
)
ÓÓ( )
{
ÔÔ 	
classes
ÕÕ 
++
ÕÕ 
;
ÕÕ 
}
ÖÖ 	
if
ØØ 

(
ØØ 
HasDigitRegex
ØØ 
.
ØØ 
IsMatch
ØØ !
(
ØØ! "
s
ØØ" #
)
ØØ# $
)
ØØ$ %
{
ÙÙ 	
classes
ÚÚ 
++
ÚÚ 
;
ÚÚ 
}
ÛÛ 	
if
ÝÝ 

(
ÝÝ !
HasSpecialCharRegex
ÝÝ 
.
ÝÝ  
IsMatch
ÝÝ  '
(
ÝÝ' (
s
ÝÝ( )
)
ÝÝ) *
)
ÝÝ* +
{
ÞÞ 	
classes
ßß 
++
ßß 
;
ßß 
}
àà 	
return
ââ 
classes
ââ 
;
ââ 
}
ãã 
private
åå 
static
åå 
bool
åå $
ContainsAppNameVariant
åå .
(
åå. /
string
åå/ 5
s
åå6 7
)
åå7 8
=>
åå9 ;)
SecureKeyValidatorConstants
ææ #
.
ææ# $
AppNameVariants
ææ$ 3
.
ææ3 4
Any
ææ4 7
(
ææ7 8
v
ææ8 9
=>
ææ: <
s
çç 
.
çç 
Contains
çç 
(
çç 
v
çç 
,
çç 
StringComparison
çç *
.
çç* +(
InvariantCultureIgnoreCase
çç+ E
)
ççE F
)
ççF G
;
ççG H
private
éé 
static
éé 
double
éé *
CalculateTotalShannonEntropy
éé 6
(
éé6 7
string
éé7 =
s
éé> ?
)
éé? @
{
êê 
if
ëë 

(
ëë 
string
ëë 
.
ëë 
IsNullOrEmpty
ëë  
(
ëë  !
s
ëë! "
)
ëë" #
)
ëë# $
{
ìì 	
return
íí 
$num
íí 
;
íí 
}
îî 	

Dictionary
ðð 
<
ðð 
char
ðð 
,
ðð 
int
ðð 
>
ðð 
freqMap
ðð %
=
ðð& '
s
ðð( )
.
ðð) *
GroupBy
ðð* 1
(
ðð1 2
c
ðð2 3
=>
ðð4 6
c
ðð7 8
)
ðð8 9
.
ðð9 :
ToDictionary
ðð: F
(
ððF G
g
ððG H
=>
ððI K
g
ððL M
.
ððM N
Key
ððN Q
,
ððQ R
g
ððS T
=>
ððU W
g
ððX Y
.
ððY Z
Count
ððZ _
(
ðð_ `
)
ðð` a
)
ðða b
;
ððb c
double
ññ 
totalLength
ññ 
=
ññ 
s
ññ 
.
ññ 
Length
ññ %
;
ññ% &
double
òò 
perCharEntropy
òò 
=
òò 
freqMap
òò  '
.
òò' (
Values
òò( .
.
óó 
Select
óó 
(
óó 
count
óó 
=>
óó 
count
óó "
/
óó# $
totalLength
óó% 0
)
óó0 1
.
ôô 
Sum
ôô 
(
ôô 
p
ôô 
=>
ôô 
-
ôô 
p
ôô 
*
ôô 
Math
ôô 
.
ôô  
Log
ôô  #
(
ôô# $
p
ôô$ %
,
ôô% &
$num
ôô' (
)
ôô( )
)
ôô) *
;
ôô* +
return
õõ 
perCharEntropy
õõ 
*
õõ 
totalLength
õõ  +
;
õõ+ ,
}
öö 
private
øø 
static
øø 
bool
øø "
HasNonEnglishLetters
øø ,
(
øø, -
string
øø- 3
s
øø4 5
)
øø5 6
=>
øø7 9&
HasNonEnglishLetterRegex
øø: R
.
øøR S
IsMatch
øøS Z
(
øøZ [
s
øø[ \
)
øø\ ]
;
øø] ^
}ùù Í
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Membership/SecureKeyStrength.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !

Membership! +
;+ ,
public 
enum 
SecureKeyStrength 
{ 
INVALID 
, 
	VERY_WEAK 
, 
WEAK 
, 	
GOOD 
, 	
STRONG		 

,		
 
VERY_STRONG

 
} ’&
ƒ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Membership/MobileNumberValidator.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !

Membership! +
;+ ,
public		 
static		 
partial		 
class		 !
MobileNumberValidator		 1
{

 
public 

static 
string 
Validate !
(! "
string" (
mobileNumber) 5
,5 6 
ILocalizationService7 K
localizationServiceL _
)_ `
{ 
List 
< 
( 
Func 
< 
string 
, 
bool 
>  
	IsInvalid! *
,* +
string, 2
ErrorMessageKey3 B
,B C
objectD J
[J K
]K L
?L M
ArgsN R
)R S
>S T
validationRulesU d
=e f
[ 	
( 
string 
. 
IsNullOrWhiteSpace &
,& '*
MobileNumberValidatorConstants( F
.F G
LocalizationKeysG W
.W X
CANNOT_BE_EMPTYX g
,g h
nulli m
)m n
,n o
( 
s 
=> 
! 
s 
. 

StartsWith 
(  *
MobileNumberValidatorConstants  >
.> ?
ValidationRules? N
.N O
COUNTRY_CODE_PREFIXO b
)b c
,c d*
MobileNumberValidatorConstants .
.. /
LocalizationKeys/ ?
.? @(
MUST_START_WITH_COUNTRY_CODE@ \
,\ ]
null^ b
)b c
,c d
( 
s 
=> 
s 
. 
Length 
> 
$num 
&& !"
ContainsNonDigitsRegex" 8
(8 9
)9 :
.: ;
IsMatch; B
(B C
sC D
[D E
$numE F
..F H
]H I
)I J
,J K*
MobileNumberValidatorConstants .
.. /
LocalizationKeys/ ?
.? @
CONTAINS_NON_DIGITS@ S
,S T
nullU Y
)Y Z
,Z [
( 
s 
=> 
s 
. 
Length 
is 
< *
MobileNumberValidatorConstants  >
.> ?
ValidationRules? N
.N O

MIN_DIGITSO Y
+Z [
$num\ ]
or 
> *
MobileNumberValidatorConstants 3
.3 4
ValidationRules4 C
.C D

MAX_DIGITSD N
+O P
$numQ R
,R S*
MobileNumberValidatorConstants .
.. /
LocalizationKeys/ ?
.? @
INCORRECT_LENGTH@ P
,P Q
[ *
MobileNumberValidatorConstants /
./ 0
ValidationRules0 ?
.? @

MIN_DIGITS@ J
,J K*
MobileNumberValidatorConstants /
./ 0
ValidationRules0 ?
.? @

MAX_DIGITS@ J
]J K
)K L
] 	
;	 

foreach 
( 
( 
Func 
< 
string 
, 
bool #
># $
	isInvalid% .
,. /
string0 6
errorMessageKey7 F
,F G
objectH N
[N O
]O P
?P Q
argsR V
)V W
inX Z
validationRules[ j
)j k
{ 	
if 
( 
	isInvalid 
( 
mobileNumber &
)& '
)' (
{ 
string 
message 
=  
localizationService! 4
[4 5
errorMessageKey5 D
]D E
;E F
return   
args   
!=   
null   #
?  $ %
string  & ,
.  , -
Format  - 3
(  3 4
message  4 ;
,  ; <
args  = A
)  A B
:  C D
message  E L
;  L M
}!! 
}"" 	
return$$ 
string$$ 
.$$ 
Empty$$ 
;$$ 
}%% 
['' 
GeneratedRegex'' 
('' 
$str'' 
)'' 
]'' 
private(( 
static(( 
partial(( 
Regex((  "
ContainsNonDigitsRegex((! 7
(((7 8
)((8 9
;((9 :
})) ‡Š
{/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Membership/LogoutService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !

Membership! +
;+ ,
internal 
sealed	 
class 
LogoutService #
(# $
NetworkProvider 
networkProvider #
,# $
IMessageBus 

messageBus 
, -
!IApplicationSecureStorageProvider %,
 applicationSecureStorageProvider& F
,F G$
IApplicationStateManager 
stateManager )
,) *
IApplicationRouter   
router   
,   
IIdentityService!! 
identityService!! $
)!!$ %
:"" 
ILogoutService"" 
{## 
private$$ 
readonly$$ '
PendingLogoutRequestStorage$$ 0(
_pendingLogoutRequestStorage$$1 M
=$$N O
new$$P S
($$S T,
 applicationSecureStorageProvider$$T t
)$$t u
;$$u v
private%% 
readonly%% 
LogoutProofHandler%% '
_logoutProofHandler%%( ;
=%%< =
new%%> A
(%%A B
identityService%%B Q
,%%Q R,
 applicationSecureStorageProvider%%S s
)%%s t
;%%t u
private'' 
readonly'' "
PendingLogoutProcessor'' +#
_pendingLogoutProcessor'', C
=''D E
new(( 
((( 
networkProvider(( 
,(( 
new((  '
PendingLogoutRequestStorage((! <
(((< =,
 applicationSecureStorageProvider((= ]
)((] ^
)((^ _
;((_ `
private** 
const** 
bool** 
KEEP_PENDING_LOGOUT** *
=**+ ,
true**- 1
;**1 2
private++ 
const++ 
bool++  
CLEAR_PENDING_LOGOUT++ +
=++, -
false++. 3
;++3 4
public-- 

async-- 
Task-- 
<-- 
Result-- 
<-- 
Unit-- !
,--! "
LogoutFailure--# 0
>--0 1
>--1 2
LogoutAsync--3 >
(--> ?
LogoutReason--? K
reason--L R
,--R S
CancellationToken.. 
cancellationToken.. +
=.., -
default... 5
)..5 6
{// 
Result00 
<00 
string00 
,00 
LogoutFailure00 $
>00$ %
membershipResult00& 6
=007 8
await009 >)
ValidateAndGetMembershipAsync00? \
(00\ ]
)00] ^
.00^ _
ConfigureAwait00_ m
(00m n
false00n s
)00s t
;00t u
if11 

(11 
membershipResult11 
.11 
IsErr11 "
)11" #
{22 	
return33 
Result33 
<33 
Unit33 
,33 
LogoutFailure33  -
>33- .
.33. /
Err33/ 2
(332 3
membershipResult333 C
.33C D
	UnwrapErr33D M
(33M N
)33N O
)33O P
;33P Q
}44 	
string66 
membershipId66 
=66 
membershipResult66 .
.66. /
Unwrap66/ 5
(665 6
)666 7
;667 8
Result88 
<88 
(88 
LogoutRequest88 
request88 %
,88% &
uint88' +
	connectId88, 5
)885 6
,886 7
LogoutFailure888 E
>88E F
prepareResult88G T
=88U V
await99 %
PrepareLogoutRequestAsync99 +
(99+ ,
membershipId99, 8
,998 9
reason99: @
)99@ A
.99A B
ConfigureAwait99B P
(99P Q
false99Q V
)99V W
;99W X
if;; 

(;; 
prepareResult;; 
.;; 
IsErr;; 
);;  
{<< 	
return== 
Result== 
<== 
Unit== 
,== 
LogoutFailure==  -
>==- .
.==. /
Err==/ 2
(==2 3
prepareResult==3 @
.==@ A
	UnwrapErr==A J
(==J K
)==K L
)==L M
;==M N
}>> 	
(@@ 	
LogoutRequest@@	 
logoutRequest@@ $
,@@$ %
uint@@& *
	connectId@@+ 4
)@@4 5
=@@6 7
prepareResult@@8 E
.@@E F
Unwrap@@F L
(@@L M
)@@M N
;@@N O
ResultBB 
<BB 
LogoutResponseBB 
,BB 
LogoutFailureBB ,
>BB, -
logoutResultBB. :
=BB; <
awaitCC $
ExecuteServerLogoutAsyncCC *
(CC* +
logoutRequestCC+ 8
,CC8 9
	connectIdCC: C
,CCC D
cancellationTokenCCE V
)CCV W
.CCW X
ConfigureAwaitCCX f
(CCf g
falseCCg l
)CCl m
;CCm n
ifEE 

(EE 
logoutResultEE 
.EE 
IsErrEE 
)EE 
{FF 	
returnGG 
awaitGG #
HandleFailedLogoutAsyncGG 0
(GG0 1
logoutRequestGG1 >
,GG> ?
membershipIdGG@ L
,GGL M
reasonGGN T
,GGT U
	connectIdGGV _
,GG_ `
cancellationTokenHH !
)HH! "
.HH" #
ConfigureAwaitHH# 1
(HH1 2
falseHH2 7
)HH7 8
;HH8 9
}II 	
LogoutResponseKK 
responseKK 
=KK  !
logoutResultKK" .
.KK. /
UnwrapKK/ 5
(KK5 6
)KK6 7
;KK7 8
returnMM 
awaitMM (
ProcessSuccessfulLogoutAsyncMM 1
(MM1 2
responseMM2 :
,MM: ;
membershipIdMM< H
,MMH I
reasonMMJ P
,MMP Q
	connectIdMMR [
,MM[ \
cancellationTokenMM] n
)MMn o
.NN 
ConfigureAwaitNN 
(NN 
falseNN !
)NN! "
;NN" #
}OO 
publicQQ 

staticQQ 
asyncQQ 
TaskQQ 
<QQ 
boolQQ !
>QQ! "#
HasRevocationProofAsyncQQ# :
(QQ: ;-
!IApplicationSecureStorageProviderQQ; \
storageProviderQQ] l
,QQl m
stringRR 
membershipIdRR 
)RR 
=>RR 
awaitSS 
LogoutProofHandlerSS  
.SS  !#
HasRevocationProofAsyncSS! 8
(SS8 9
storageProviderSS9 H
,SSH I
membershipIdSSJ V
)SSV W
;SSW X
privateUU 
asyncUU 
TaskUU &
TryStorePendingLogoutAsyncUU 1
(UU1 2
LogoutRequestUU2 ?
requestUU@ G
)UUG H
=>UUI K
awaitVV (
_pendingLogoutRequestStorageVV *
.VV* +#
StorePendingLogoutAsyncVV+ B
(VVB C
requestVVC J
)VVJ K
.VVK L
ConfigureAwaitVVL Z
(VVZ [
falseVV[ `
)VV` a
;VVa b
privateXX 
asyncXX 
TaskXX 
<XX 
ResultXX 
<XX 
UnitXX "
,XX" #
LogoutFailureXX$ 1
>XX1 2
>XX2 3#
HandleFailedLogoutAsyncXX4 K
(XXK L
LogoutRequestYY 
logoutRequestYY #
,YY# $
stringZZ 
membershipIdZZ 
,ZZ 
LogoutReason[[ 
reason[[ 
,[[ 
uint\\ 
	connectId\\ 
,\\ 
CancellationToken]] 
cancellationToken]] +
)]]+ ,
{^^ 
await__ &
TryStorePendingLogoutAsync__ (
(__( )
logoutRequest__) 6
)__6 7
.__7 8
ConfigureAwait__8 F
(__F G
false__G L
)__L M
;__M N
awaitaa *
CompleteLogoutWithCleanupAsyncaa ,
(aa, -
membershipIdaa- 9
,aa9 :
reasonaa; A
,aaA B
	connectIdaaC L
,aaL M
KEEP_PENDING_LOGOUTaaN a
,aaa b
cancellationTokenaac t
)aat u
.bb 
ConfigureAwaitbb 
(bb 
falsebb !
)bb! "
;bb" #
returndd 
Resultdd 
<dd 
Unitdd 
,dd 
LogoutFailuredd )
>dd) *
.dd* +
Okdd+ -
(dd- .
Unitdd. 2
.dd2 3
Valuedd3 8
)dd8 9
;dd9 :
}ee 
privategg 
asyncgg 
Taskgg 
<gg 
Resultgg 
<gg 
stringgg $
,gg$ %
LogoutFailuregg& 3
>gg3 4
>gg4 5)
ValidateAndGetMembershipAsyncgg6 S
(ggS T
)ggT U
{hh 
Resultii 
<ii '
ApplicationInstanceSettingsii *
,ii* +%
InternalServiceApiFailureii, E
>iiE F
settingsResultiiG U
=iiV W
awaitjj ,
 applicationSecureStorageProviderjj 2
.jj2 3/
#GetApplicationInstanceSettingsAsyncjj3 V
(jjV W
)jjW X
.jjX Y
ConfigureAwaitjjY g
(jjg h
falsejjh m
)jjm n
;jjn o
ifll 

(ll 
settingsResultll 
.ll 
IsErrll  
)ll  !
{mm 	
returnnn 
Resultnn 
<nn 
stringnn  
,nn  !
LogoutFailurenn" /
>nn/ 0
.nn0 1
Errnn1 4
(nn4 5
LogoutFailureoo 
.oo '
InvalidMembershipIdentifieroo 9
(oo9 :
$stroo: S
)ooS T
)ooT U
;ooU V
}pp 	'
ApplicationInstanceSettingsrr #
settingsrr$ ,
=rr- .
settingsResultrr/ =
.rr= >
Unwraprr> D
(rrD E
)rrE F
;rrF G
iftt 

(tt 
settingstt 
.tt 

Membershiptt 
?tt  
.tt  !
UniqueIdentifiertt! 1
==tt2 4
nulltt5 9
)tt9 :
{uu 	
returnvv 
Resultvv 
<vv 
stringvv  
,vv  !
LogoutFailurevv" /
>vv/ 0
.vv0 1
Errvv1 4
(vv4 5
LogoutFailureww 
.ww '
InvalidMembershipIdentifierww 9
(ww9 :
$strww: S
)wwS T
)wwT U
;wwU V
}xx 	
stringzz 
membershipIdzz 
=zz 
Helperszz %
.zz% & 
FromByteStringToGuidzz& :
(zz: ;
settingszz; C
.zzC D

MembershipzzD N
.zzN O
UniqueIdentifierzzO _
)zz_ `
.zz` a
ToStringzza i
(zzi j
)zzj k
;zzk l
return{{ 
Result{{ 
<{{ 
string{{ 
,{{ 
LogoutFailure{{ +
>{{+ ,
.{{, -
Ok{{- /
({{/ 0
membershipId{{0 <
){{< =
;{{= >
}|| 
private~~ 
async~~ 
Task~~ 
<~~ 
Result~~ 
<~~ 
(~~ 
LogoutRequest~~ ,
request~~- 4
,~~4 5
uint~~6 :
	connectId~~; D
)~~D E
,~~E F
LogoutFailure~~G T
>~~T U
>~~U V%
PrepareLogoutRequestAsync~~W p
(~~p q
string 
membershipId 
, 
LogoutReason
€€ 
reason
€€ 
)
€€ 
{
 
Result
‚‚ 
<
‚‚ )
ApplicationInstanceSettings
‚‚ *
,
‚‚* +'
InternalServiceApiFailure
‚‚, E
>
‚‚E F
settingsResult
‚‚G U
=
‚‚V W
await
ƒƒ .
 applicationSecureStorageProvider
ƒƒ 2
.
ƒƒ2 31
#GetApplicationInstanceSettingsAsync
ƒƒ3 V
(
ƒƒV W
)
ƒƒW X
.
ƒƒX Y
ConfigureAwait
ƒƒY g
(
ƒƒg h
false
ƒƒh m
)
ƒƒm n
;
ƒƒn o
if
…… 

(
…… 
settingsResult
…… 
.
…… 
IsErr
……  
)
……  !
{
†† 	
return
‡‡ 
Result
‡‡ 
<
‡‡ 
(
‡‡ 
LogoutRequest
‡‡ (
,
‡‡( )
uint
‡‡* .
)
‡‡. /
,
‡‡/ 0
LogoutFailure
‡‡1 >
>
‡‡> ?
.
‡‡? @
Err
‡‡@ C
(
‡‡C D
LogoutFailure
ˆˆ 
.
ˆˆ "
NetworkRequestFailed
ˆˆ 2
(
ˆˆ2 3
$str
ˆˆ3 W
,
ˆˆW X
new
‰‰ 
	Exception
‰‰ !
(
‰‰! "
settingsResult
‰‰" 0
.
‰‰0 1
	UnwrapErr
‰‰1 :
(
‰‰: ;
)
‰‰; <
.
‰‰< =
Message
‰‰= D
)
‰‰D E
)
‰‰E F
)
‰‰F G
;
‰‰G H
}
ŠŠ 	)
ApplicationInstanceSettings
ŒŒ #
settings
ŒŒ$ ,
=
ŒŒ- .
settingsResult
ŒŒ/ =
.
ŒŒ= >
Unwrap
ŒŒ> D
(
ŒŒD E
)
ŒŒE F
;
ŒŒF G
long
ŽŽ 
	timestamp
ŽŽ 
=
ŽŽ 
DateTimeOffset
ŽŽ '
.
ŽŽ' (
UtcNow
ŽŽ( .
.
ŽŽ. /
ToUnixTimeSeconds
ŽŽ/ @
(
ŽŽ@ A
)
ŽŽA B
;
ŽŽB C

ByteString
 
membershipIdBytes
 $
=
% &
Helpers
' .
.
. /
GuidToByteString
/ ?
(
? @
Guid
@ D
.
D E
Parse
E J
(
J K
membershipId
K W
)
W X
)
X Y
;
Y Z
LogoutRequest
‘‘ 
logoutRequest
‘‘ #
=
‘‘$ %
new
‘‘& )
(
‘‘) *
)
‘‘* +
{
’’ 	"
MembershipIdentifier
““  
=
““! "
membershipIdBytes
““# 4
,
““4 5
LogoutReason
”” 
=
”” 
reason
”” !
.
””! "
ToString
””" *
(
””* +
)
””+ ,
,
””, -
	Timestamp
•• 
=
•• 
	timestamp
•• !
,
••! "
Scope
–– 
=
–– 
LogoutScope
–– 
.
––  

ThisDevice
––  *
,
––* +
AccountIdentifier
—— 
=
—— 
settings
——  (
.
——( )
CurrentAccountId
——) 9
}
˜˜ 	
;
˜˜	 

Result
šš 
<
šš 
Unit
šš 
,
šš 
LogoutFailure
šš "
>
šš" #

hmacResult
šš$ .
=
šš/ 0
await
›› !
_logoutProofHandler
›› %
.
››% &*
GenerateLogoutHmacProofAsync
››& B
(
››B C
logoutRequest
››C P
,
››P Q
membershipId
››R ^
)
››^ _
;
››_ `
if
 

(
 

hmacResult
 
.
 
IsErr
 
)
 
{
žž 	
return
ŸŸ 
Result
ŸŸ 
<
ŸŸ 
(
ŸŸ 
LogoutRequest
ŸŸ (
,
ŸŸ( )
uint
ŸŸ* .
)
ŸŸ. /
,
ŸŸ/ 0
LogoutFailure
ŸŸ1 >
>
ŸŸ> ?
.
ŸŸ? @
Err
ŸŸ@ C
(
ŸŸC D

hmacResult
ŸŸD N
.
ŸŸN O
	UnwrapErr
ŸŸO X
(
ŸŸX Y
)
ŸŸY Z
)
ŸŸZ [
;
ŸŸ[ \
}
   	
uint
¢¢ 
	connectId
¢¢ 
=
¢¢ 
NetworkProvider
¢¢ (
.
¢¢( )$
ComputeUniqueConnectId
¢¢) ?
(
¢¢? @
settings
££ 
,
££  
PubKeyExchangeType
¤¤ 
.
¤¤ (
DataCenterEphemeralConnect
¤¤ 9
)
¤¤9 :
;
¤¤: ;
return
¦¦ 
Result
¦¦ 
<
¦¦ 
(
¦¦ 
LogoutRequest
¦¦ $
,
¦¦$ %
uint
¦¦& *
)
¦¦* +
,
¦¦+ ,
LogoutFailure
¦¦- :
>
¦¦: ;
.
¦¦; <
Ok
¦¦< >
(
¦¦> ?
(
¦¦? @
logoutRequest
¦¦@ M
,
¦¦M N
	connectId
¦¦O X
)
¦¦X Y
)
¦¦Y Z
;
¦¦Z [
}
§§ 
private
©© 
async
©© 
Task
©© 
<
©© 
Result
©© 
<
©© 
LogoutResponse
©© ,
,
©©, -
LogoutFailure
©©. ;
>
©©; <
>
©©< =&
ExecuteServerLogoutAsync
©©> V
(
©©V W
LogoutRequest
ªª 
logoutRequest
ªª #
,
ªª# $
uint
«« 
	connectId
«« 
,
«« 
CancellationToken
¬¬ 
cancellationToken
¬¬ +
)
¬¬+ ,
{
­­ "
TaskCompletionSource
®® 
<
®® 
Result
®® #
<
®®# $
LogoutResponse
®®$ 2
,
®®2 3
LogoutFailure
®®4 A
>
®®A B
>
®®B C&
responseCompletionSource
®®D \
=
®®] ^
new
¯¯ 
(
¯¯ !
TaskCreationOptions
¯¯ #
.
¯¯# $,
RunContinuationsAsynchronously
¯¯$ B
)
¯¯B C
;
¯¯C D
Result
±± 
<
±± 
Unit
±± 
,
±± 
NetworkFailure
±± #
>
±±# $
networkResult
±±% 2
=
±±3 4
await
±±5 :
networkProvider
±±; J
.
±±J K&
ExecuteUnaryRequestAsync
±±K c
(
±±c d
	connectId
²² 
,
²² 
RpcServiceType
³³ 
.
³³ 
Logout
³³ !
,
³³! "
logoutRequest
´´ 
.
´´ 
ToByteArray
´´ %
(
´´% &
)
´´& '
,
´´' (
responsePayload
µµ 
=>
µµ 
{
¶¶ 
LogoutResponse
·· 
logoutResponse
·· -
=
··. /
LogoutResponse
··0 >
.
··> ?
Parser
··? E
.
··E F
	ParseFrom
··F O
(
··O P
responsePayload
··P _
)
··_ `
;
··` a
if
¹¹ 
(
¹¹ 
logoutResponse
¹¹ "
.
¹¹" #
Result
¹¹# )
!=
¹¹* ,
LogoutResponse
¹¹- ;
.
¹¹; <
Types
¹¹< A
.
¹¹A B
Result
¹¹B H
.
¹¹H I
	Succeeded
¹¹I R
)
¹¹R S
{
ºº 
Log
»» 
.
»» 
Warning
»» 
(
»»  
$str
»»  W
,
»»W X
logoutResponse
»»Y g
.
»»g h
Result
»»h n
)
»»n o
;
»»o p
}
¼¼ &
responseCompletionSource
¾¾ (
.
¾¾( )
TrySetResult
¾¾) 5
(
¾¾5 6
MapLogoutResponse
¾¾6 G
(
¾¾G H
logoutResponse
¾¾H V
)
¾¾V W
)
¾¾W X
;
¾¾X Y
return
¿¿ 
Task
¿¿ 
.
¿¿ 

FromResult
¿¿ &
(
¿¿& '
Result
¿¿' -
<
¿¿- .
Unit
¿¿. 2
,
¿¿2 3
NetworkFailure
¿¿4 B
>
¿¿B C
.
¿¿C D
Ok
¿¿D F
(
¿¿F G
Unit
¿¿G K
.
¿¿K L
Value
¿¿L Q
)
¿¿Q R
)
¿¿R S
;
¿¿S T
}
ÀÀ 
,
ÀÀ 
allowDuplicates
ÁÁ 
:
ÁÁ 
false
ÁÁ "
,
ÁÁ" #
token
ÂÂ 
:
ÂÂ 
cancellationToken
ÂÂ $
,
ÂÂ$ %
waitForRecovery
ÃÃ 
:
ÃÃ 
false
ÃÃ "
)
ÃÃ" #
.
ÃÃ# $
ConfigureAwait
ÃÃ$ 2
(
ÃÃ2 3
false
ÃÃ3 8
)
ÃÃ8 9
;
ÃÃ9 :
if
ÅÅ 

(
ÅÅ 
networkResult
ÅÅ 
.
ÅÅ 
IsErr
ÅÅ 
)
ÅÅ  
{
ÆÆ 	
NetworkFailure
ÇÇ 
failure
ÇÇ "
=
ÇÇ# $
networkResult
ÇÇ% 2
.
ÇÇ2 3
	UnwrapErr
ÇÇ3 <
(
ÇÇ< =
)
ÇÇ= >
;
ÇÇ> ?
return
ÈÈ 
Result
ÈÈ 
<
ÈÈ 
LogoutResponse
ÈÈ (
,
ÈÈ( )
LogoutFailure
ÈÈ* 7
>
ÈÈ7 8
.
ÈÈ8 9
Err
ÈÈ9 <
(
ÈÈ< =
LogoutFailure
ÉÉ 
.
ÉÉ "
NetworkRequestFailed
ÉÉ 2
(
ÉÉ2 3
$str
ÉÉ3 K
,
ÉÉK L
new
ÉÉM P
	Exception
ÉÉQ Z
(
ÉÉZ [
failure
ÉÉ[ b
.
ÉÉb c
Message
ÉÉc j
)
ÉÉj k
)
ÉÉk l
)
ÉÉl m
;
ÉÉm n
}
ÊÊ 	
Result
ÌÌ 
<
ÌÌ 
LogoutResponse
ÌÌ 
,
ÌÌ 
LogoutFailure
ÌÌ ,
>
ÌÌ, -
responseResult
ÌÌ. <
=
ÌÌ= >
await
ÍÍ &
responseCompletionSource
ÍÍ *
.
ÍÍ* +
Task
ÍÍ+ /
.
ÍÍ/ 0
ConfigureAwait
ÍÍ0 >
(
ÍÍ> ?
false
ÍÍ? D
)
ÍÍD E
;
ÍÍE F
if
ÏÏ 

(
ÏÏ 
!
ÏÏ 
responseResult
ÏÏ 
.
ÏÏ 
IsErr
ÏÏ !
)
ÏÏ! "
{
ÐÐ 	
return
ÑÑ 
Result
ÑÑ 
<
ÑÑ 
LogoutResponse
ÑÑ (
,
ÑÑ( )
LogoutFailure
ÑÑ* 7
>
ÑÑ7 8
.
ÑÑ8 9
Ok
ÑÑ9 ;
(
ÑÑ; <
responseResult
ÑÑ< J
.
ÑÑJ K
Unwrap
ÑÑK Q
(
ÑÑQ R
)
ÑÑR S
)
ÑÑS T
;
ÑÑT U
}
ÒÒ 	
LogoutFailure
ÔÔ 
serverFailure
ÔÔ #
=
ÔÔ$ %
responseResult
ÔÔ& 4
.
ÔÔ4 5
	UnwrapErr
ÔÔ5 >
(
ÔÔ> ?
)
ÔÔ? @
;
ÔÔ@ A
return
ÕÕ 
Result
ÕÕ 
<
ÕÕ 
LogoutResponse
ÕÕ $
,
ÕÕ$ %
LogoutFailure
ÕÕ& 3
>
ÕÕ3 4
.
ÕÕ4 5
Err
ÕÕ5 8
(
ÕÕ8 9
serverFailure
ÕÕ9 F
)
ÕÕF G
;
ÕÕG H
}
ÖÖ 
private
ØØ 
async
ØØ 
Task
ØØ 
<
ØØ 
Result
ØØ 
<
ØØ 
Unit
ØØ "
,
ØØ" #
LogoutFailure
ØØ$ 1
>
ØØ1 2
>
ØØ2 3*
ProcessSuccessfulLogoutAsync
ØØ4 P
(
ØØP Q
LogoutResponse
ÙÙ 
response
ÙÙ 
,
ÙÙ  
string
ÚÚ 
membershipId
ÚÚ 
,
ÚÚ 
LogoutReason
ÛÛ 
reason
ÛÛ 
,
ÛÛ 
uint
ÜÜ 
	connectId
ÜÜ 
,
ÜÜ 
CancellationToken
ÝÝ 
cancellationToken
ÝÝ +
)
ÝÝ+ ,
{
ÞÞ 
Result
ßß 
<
ßß 
Unit
ßß 
,
ßß 
LogoutFailure
ßß "
>
ßß" #
proofVerification
ßß$ 5
=
ßß6 7
await
àà !
_logoutProofHandler
àà %
.
àà% &(
VerifyRevocationProofAsync
àà& @
(
àà@ A
response
ààA I
,
ààI J
membershipId
ààK W
,
ààW X
	connectId
ààY b
)
ààb c
;
ààc d
if
ââ 

(
ââ 
proofVerification
ââ 
.
ââ 
IsErr
ââ #
)
ââ# $
{
ãã 	
Log
ää 
.
ää 
Error
ää 
(
ää 
$str
ää f
,
ääf g
membershipId
åå 
)
åå 
;
åå 
}
ææ 	
await
èè ,
CompleteLogoutWithCleanupAsync
èè ,
(
èè, -
membershipId
èè- 9
,
èè9 :
reason
èè; A
,
èèA B
	connectId
èèC L
,
èèL M"
CLEAR_PENDING_LOGOUT
èèN b
,
èèb c
cancellationToken
èèd u
)
èèu v
.
éé 
ConfigureAwait
éé 
(
éé 
false
éé !
)
éé! "
;
éé" #
return
ëë 
Result
ëë 
<
ëë 
Unit
ëë 
,
ëë 
LogoutFailure
ëë )
>
ëë) *
.
ëë* +
Ok
ëë+ -
(
ëë- .
Unit
ëë. 2
.
ëë2 3
Value
ëë3 8
)
ëë8 9
;
ëë9 :
}
ìì 
private
îî 
async
îî 
Task
îî !
FinalizeLogoutAsync
îî *
(
îî* +
string
îî+ 1
membershipId
îî2 >
,
îî> ?
LogoutReason
îî@ L
reason
îîM S
,
îîS T
bool
îîU Y&
shouldRetryPendingLogout
îîZ r
,
îîr s
CancellationToken
ïï 
cancellationToken
ïï +
)
ïï+ ,
{
ðð 
await
ññ 
stateManager
ññ 
.
ññ (
TransitionToAnonymousAsync
ññ 5
(
ññ5 6
)
ññ6 7
.
ññ7 8
ConfigureAwait
ññ8 F
(
ññF G
false
ññG L
)
ññL M
;
ññM N
await
óó 

messageBus
óó 
.
óó 
PublishAsync
óó %
(
óó% &
new
óó& )&
MembershipLoggedOutEvent
óó* B
(
óóB C
membershipId
óóC O
,
óóO P
reason
óóQ W
.
óóW X
ToString
óóX `
(
óó` a
)
óóa b
)
óób c
,
óóc d
cancellationToken
óóe v
)
óóv w
.
ôô 
ConfigureAwait
ôô 
(
ôô 
false
ôô !
)
ôô! "
;
ôô" #
await
öö 
router
öö 
.
öö +
NavigateToAuthenticationAsync
öö 2
(
öö2 3
)
öö3 4
.
öö4 5
ConfigureAwait
öö5 C
(
ööC D
false
ööD I
)
ööI J
;
ööJ K
if
øø 

(
øø &
shouldRetryPendingLogout
øø $
)
øø$ %
{
ùù 	
_
úú 
=
úú 
Task
úú 
.
úú 
Run
úú 
(
úú 
async
úú 
(
úú  
)
úú  !
=>
úú" $
{
ûû 
Result
üü 
<
üü )
ApplicationInstanceSettings
üü 2
,
üü2 3'
InternalServiceApiFailure
üü4 M
>
üüM N
settingsResult
üüO ]
=
üü^ _
await
ýý .
 applicationSecureStorageProvider
ýý :
.
ýý: ;1
#GetApplicationInstanceSettingsAsync
ýý; ^
(
ýý^ _
)
ýý_ `
.
þþ 
ConfigureAwait
þþ '
(
þþ' (
false
þþ( -
)
þþ- .
;
þþ. /
if
€€ 
(
€€ 
settingsResult
€€ "
.
€€" #
IsOk
€€# '
)
€€' (
{
 )
ApplicationInstanceSettings
‚‚ /
settings
‚‚0 8
=
‚‚9 :
settingsResult
‚‚; I
.
‚‚I J
Unwrap
‚‚J P
(
‚‚P Q
)
‚‚Q R
;
‚‚R S
uint
ƒƒ  
anonymousConnectId
ƒƒ +
=
ƒƒ, -
NetworkProvider
ƒƒ. =
.
ƒƒ= >$
ComputeUniqueConnectId
ƒƒ> T
(
ƒƒT U
settings
„„  
,
„„  ! 
PubKeyExchangeType
…… *
.
……* +(
DataCenterEphemeralConnect
……+ E
)
……E F
;
……F G
await
‡‡ %
_pendingLogoutProcessor
‡‡ 1
.
‡‡1 2'
ProcessPendingLogoutAsync
‡‡2 K
(
‡‡K L 
anonymousConnectId
‡‡L ^
)
‡‡^ _
.
ˆˆ 
ConfigureAwait
ˆˆ '
(
ˆˆ' (
false
ˆˆ( -
)
ˆˆ- .
;
ˆˆ. /
}
‰‰ 
}
ŠŠ 
)
ŠŠ 
.
ŠŠ 
ContinueWith
ŠŠ 
(
ŠŠ 
task
‹‹ 
=>
‹‹ 
{
ŒŒ 
if
 
(
 
task
 
.
 
	IsFaulted
 &
&&
' )
task
* .
.
. /
	Exception
/ 8
!=
9 ;
null
< @
)
@ A
{
ŽŽ 
Log
 
.
 
Warning
 #
(
# $
task
$ (
.
( )
	Exception
) 2
,
2 3
$str
 n
)
n o
;
o p
}
‘‘ 
}
’’ 
,
’’ 
TaskScheduler
““ 
.
““ 
Default
““ %
)
““% &
;
““& '
}
”” 	
}
•• 
private
—— 
static
—— 
Result
—— 
<
—— 
LogoutResponse
—— (
,
——( )
LogoutFailure
——* 7
>
——7 8
MapLogoutResponse
——9 J
(
——J K
LogoutResponse
——K Y
response
——Z b
)
——b c
{
˜˜ 
return
™™ 
response
™™ 
.
™™ 
Result
™™ 
switch
™™ %
{
šš 	
LogoutResponse
›› 
.
›› 
Types
››  
.
››  !
Result
››! '
.
››' (
	Succeeded
››( 1
=>
››2 4
Result
››5 ;
<
››; <
LogoutResponse
››< J
,
››J K
LogoutFailure
››L Y
>
››Y Z
.
››Z [
Ok
››[ ]
(
››] ^
response
››^ f
)
››f g
,
››g h
LogoutResponse
œœ 
.
œœ 
Types
œœ  
.
œœ  !
Result
œœ! '
.
œœ' (
AlreadyLoggedOut
œœ( 8
=>
œœ9 ;
Result
œœ< B
<
œœB C
LogoutResponse
œœC Q
,
œœQ R
LogoutFailure
œœS `
>
œœ` a
.
œœa b
Err
œœb e
(
œœe f
LogoutFailure
 
.
 
AlreadyLoggedOut
 .
(
. /
$str
/ \
)
\ ]
)
] ^
,
^ _
LogoutResponse
žž 
.
žž 
Types
žž  
.
žž  !
Result
žž! '
.
žž' (
SessionNotFound
žž( 7
=>
žž8 :
Result
žž; A
<
žžA B
LogoutResponse
žžB P
,
žžP Q
LogoutFailure
žžR _
>
žž_ `
.
žž` a
Err
žža d
(
žžd e
LogoutFailure
ŸŸ 
.
ŸŸ 
SESSION_NOT_FOUND
ŸŸ /
(
ŸŸ/ 0
$str
ŸŸ0 \
)
ŸŸ\ ]
)
ŸŸ] ^
,
ŸŸ^ _
LogoutResponse
   
.
   
Types
    
.
    !
Result
  ! '
.
  ' (
InvalidTimestamp
  ( 8
=>
  9 ;
Result
  < B
<
  B C
LogoutResponse
  C Q
,
  Q R
LogoutFailure
  S `
>
  ` a
.
  a b
Err
  b e
(
  e f
LogoutFailure
¡¡ 
.
¡¡ 
UnexpectedError
¡¡ -
(
¡¡- .
$str
¡¡. `
)
¡¡` a
)
¡¡a b
,
¡¡b c
LogoutResponse
¢¢ 
.
¢¢ 
Types
¢¢  
.
¢¢  !
Result
¢¢! '
.
¢¢' (
InvalidHmac
¢¢( 3
=>
¢¢4 6
Result
¢¢7 =
<
¢¢= >
LogoutResponse
¢¢> L
,
¢¢L M
LogoutFailure
¢¢N [
>
¢¢[ \
.
¢¢\ ]
Err
¢¢] `
(
¢¢` a
LogoutFailure
££ 
.
££ *
CryptographicOperationFailed
££ :
(
££: ;
$str
££; g
)
££g h
)
££h i
,
££i j
LogoutResponse
¤¤ 
.
¤¤ 
Types
¤¤  
.
¤¤  !
Result
¤¤! '
.
¤¤' (
Failed
¤¤( .
=>
¤¤/ 1
Result
¤¤2 8
<
¤¤8 9
LogoutResponse
¤¤9 G
,
¤¤G H
LogoutFailure
¤¤I V
>
¤¤V W
.
¤¤W X
Err
¤¤X [
(
¤¤[ \
LogoutFailure
¥¥ 
.
¥¥ 
UnexpectedError
¥¥ -
(
¥¥- .
$str
¥¥. P
)
¥¥P Q
)
¥¥Q R
,
¥¥R S
_
¦¦ 
=>
¦¦ 
Result
¦¦ 
<
¦¦ 
LogoutResponse
¦¦ &
,
¦¦& '
LogoutFailure
¦¦( 5
>
¦¦5 6
.
¦¦6 7
Err
¦¦7 :
(
¦¦: ;
LogoutFailure
§§ 
.
§§ 
UnexpectedError
§§ -
(
§§- .
$str
§§. U
)
§§U V
)
§§V W
}
¨¨ 	
;
¨¨	 

}
©© 
private
«« 
async
«« 
Task
«« ,
CompleteLogoutWithCleanupAsync
«« 5
(
««5 6
string
««6 <
membershipId
««= I
,
««I J
LogoutReason
««K W
reason
««X ^
,
««^ _
uint
««` d
	connectId
««e n
,
««n o
bool
¬¬ 
keepPendingLogout
¬¬ 
,
¬¬ 
CancellationToken
¬¬  1
cancellationToken
¬¬2 C
)
¬¬C D
{
­­ 
await
®® 
identityService
®® 
.
®® 1
#CleanupMembershipStateWithKeysAsync
®® A
(
®®A B
membershipId
®®B N
,
®®N O
	connectId
®®P Y
)
®®Y Z
.
¯¯ 
ConfigureAwait
¯¯ 
(
¯¯ 
false
¯¯ !
)
¯¯! "
;
¯¯" # 
LogoutProofHandler
±± 
.
±± "
ClearRevocationProof
±± /
(
±±/ 0.
 applicationSecureStorageProvider
±±0 P
,
±±P Q
membershipId
±±R ^
)
±±^ _
;
±±_ `
if
³³ 

(
³³ 
!
³³ 
keepPendingLogout
³³ 
)
³³ 
{
´´ 	*
_pendingLogoutRequestStorage
µµ (
.
µµ( ) 
ClearPendingLogout
µµ) ;
(
µµ; <
)
µµ< =
;
µµ= >
}
¶¶ 	
await
¸¸ !
FinalizeLogoutAsync
¸¸ !
(
¸¸! "
membershipId
¸¸" .
,
¸¸. /
reason
¸¸0 6
,
¸¸6 7
keepPendingLogout
¸¸8 I
,
¸¸I J
cancellationToken
¸¸K \
)
¸¸\ ]
.
¸¸] ^
ConfigureAwait
¸¸^ l
(
¸¸l m
false
¸¸m r
)
¸¸r s
;
¸¸s t
}
¹¹ 
}ºº ¦$
“/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Membership/Constants/SecureKeyValidatorConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !

Membership! +
.+ ,
	Constants, 5
;5 6
public 
static 
class '
SecureKeyValidatorConstants /
{ 
public 

static 
class 
LocalizationKeys (
{		 
public

 
const

 
string

 
NON_ENGLISH_LETTERS

 /
=

0 1
$str

2 b
;

b c
public 
const 
string 
REQUIRED $
=% &
$str' L
;L M
public 
const 
string 

MIN_LENGTH &
=' (
$str) P
;P Q
public 
const 
string 
NO_UPPERCASE (
=) *
$str+ T
;T U
public 
const 
string 
NO_LOWERCASE (
=) *
$str+ T
;T U
public 
const 
string 
NO_SPECIAL_CHAR +
=, -
$str. Z
;Z [
public 
const 
string 
NO_DIGIT $
=% &
$str' L
;L M
public 
const 
string 

MAX_LENGTH &
=' (
$str) P
;P Q
public 
const 
string 
	NO_SPACES %
=& '
$str( N
;N O
public 
const 
string 

TOO_SIMPLE &
=' (
$str) P
;P Q
public 
const 
string 

TOO_COMMON &
=' (
$str) P
;P Q
public 
const 
string 
SEQUENTIAL_PATTERN .
=/ 0
$str1 `
;` a
public 
const 
string 
REPEATED_CHARS *
=+ ,
$str- X
;X Y
public 
const 
string 
LACKS_DIVERSITY +
=, -
$str. Z
;Z [
public 
const 
string 
CONTAINS_APP_NAME -
=. /
$str0 ^
;^ _
} 
public 

static 
class 
ValidationRules '
{ 
public 
const 
int 

MIN_LENGTH #
=$ %
$num& '
;' (
public 
const 
int 

MAX_LENGTH #
=$ %
$num& (
;( )
public 
const 
int 
MIN_CHAR_CLASSES )
=* +
$num, -
;- .
public   
const   
double   "
MIN_TOTAL_ENTROPY_BITS   2
=  3 4
$num  5 7
;  7 8
}!! 
public## 

static## 
readonly## 
	FrozenSet## $
<##$ %
string##% +
>##+ ,
KeyboardRows##- 9
=##: ;
	FrozenSet##< E
.##E F
ToFrozenSet##F Q
(##Q R
[$$ 
$str%% 
,%% 
$str&& 
,&& 
$str'' 
,'' 
$str(( 
])) 
))) 
;)) 
public++ 

static++ 
readonly++ 
	FrozenSet++ $
<++$ %
string++% +
>+++ ,
AppNameVariants++- <
=++= >
	FrozenSet++? H
.++H I
ToFrozenSet++I T
(++T U
[,, 
$str-- 
,-- 
$str.. 
,.. 
$str// 
]00 
)00 
;00 
public22 

static22 
readonly22 
	FrozenSet22 $
<22$ %
string22% +
>22+ ,"
CommonlyUsedSecureKeys22- C
=22D E
	FrozenSet22F O
.22O P
ToFrozenSet22P [
(22[ \
[33 
$str44 
,44 
$str55 
,55 
$str66 
,66 
$str77 
,77 
$str88 
]99 
,99 
StringComparer99 
.99 
OrdinalIgnoreCase99 '
)99' (
;99( )
}:: 
–/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Membership/Constants/MobileNumberValidatorConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !

Membership! +
.+ ,
	Constants, 5
;5 6
public 
static 
class *
MobileNumberValidatorConstants 2
{ 
public 

static 
class 
LocalizationKeys (
{ 
public 
const 
string 
CANNOT_BE_EMPTY +
=, -
$str. ]
;] ^
public 
const 
string (
MUST_START_WITH_COUNTRY_CODE 8
=9 :
$str; w
;w x
public		 
const		 
string		 
CONTAINS_NON_DIGITS		 /
=		0 1
$str		2 e
;		e f
public

 
const

 
string

 
INCORRECT_LENGTH

 ,
=

- .
$str

/ _
;

_ `
} 
public 

static 
class 
ValidationRules '
{ 
public 
const 
string 
COUNTRY_CODE_PREFIX /
=0 1
$str2 5
;5 6
public 
const 
int 

MIN_DIGITS #
=$ %
$num& '
;' (
public 
const 
int 

MAX_DIGITS #
=$ %
$num& (
;( )
} 
} ƒZ
Ž/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/External/IpGeolocation/IpGeolocationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
External! )
.) *
IpGeolocation* 7
;7 8
internal 
sealed	 
class  
IpGeolocationService *
(* +

HttpClient+ 5
http6 :
): ;
:< =!
IIpGeolocationService> S
{ 
private 
const 
string 
BASE_URL !
=" #
$str$ <
;< =
public 

async 
Task 
< 
Result 
< 
	IpCountry &
,& '%
InternalServiceApiFailure( A
>A B
>B C
GetIpCountryAsyncD U
(U V
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
{ 
using 
HttpRequestMessage  
req! $
=% &
new' *
(* +

HttpMethod+ 5
.5 6
Get6 9
,9 :
BASE_URL; C
)C D
;D E
req 
. 
Headers 
. 
Accept 
. 
Add 
( 
new "+
MediaTypeWithQualityHeaderValue# B
(B C
$strC U
)U V
)V W
;W X
try 
{ 	
using 
HttpResponseMessage %
res& )
=* +
await, 1
http2 6
.6 7
	SendAsync7 @
(@ A
reqA D
,D E 
HttpCompletionOptionF Z
.Z [
ResponseHeadersRead[ n
,n o
cancellationToken	p 
)
 ‚
.
‚ ƒ
ConfigureAwait
ƒ ‘
(
‘ ’
false
’ —
)
— ˜
;
˜ ™
if 
( 
! 
res 
. 
IsSuccessStatusCode (
)( )
{ 
string 
error 
= 
await $!
SafeReadAsStringAsync% :
(: ;
res; >
.> ?
Content? F
,F G
cancellationTokenH Y
)Y Z
.Z [
ConfigureAwait[ i
(i j
falsej o
)o p
;p q
return   
Result   
<   
	IpCountry   '
,  ' (%
InternalServiceApiFailure  ) B
>  B C
.  C D
Err  D G
(  G H%
InternalServiceApiFailure!! -
.!!- .
ApiRequestFailed!!. >
(!!> ?
$""" 
$str"" .
{"". /
(""/ 0
int""0 3
)""3 4
res""4 7
.""7 8

StatusCode""8 B
}""B C
$str""C D
{""D E
res""E H
.""H I
ReasonPhrase""I U
}""U V
$str""V X
{""X Y
Trim""Y ]
(""] ^
error""^ c
,""c d
$num""e i
)""i j
}""j k
"""k l
)""l m
)""m n
;""n o
}## 
await%% 
using%% 
Stream%% 
stream%% %
=%%& '
await%%( -
res%%. 1
.%%1 2
Content%%2 9
.%%9 :
ReadAsStreamAsync%%: K
(%%K L
cancellationToken%%L ]
)%%] ^
.%%^ _
ConfigureAwait%%_ m
(%%m n
false%%n s
)%%s t
;%%t u
using&& 
JsonDocument&& 
doc&& "
=&&# $
await&&% *
JsonDocument&&+ 7
.&&7 8

ParseAsync&&8 B
(&&B C
stream&&C I
,&&I J
cancellationToken&&K \
:&&\ ]
cancellationToken&&^ o
)&&o p
.&&p q
ConfigureAwait&&q 
(	&& €
false
&&€ …
)
&&… †
;
&&† ‡
JsonElement'' 
root'' 
='' 
doc'' "
.''" #
RootElement''# .
;''. /
string)) 
ipParsed)) 
=)) $
TryGetAnyCaseInsensitive)) 6
())6 7
root))7 ;
,)); <
$str))= A
,))A B
$str))C N
,))N O
$str))P W
)))W X
??))Y [
$str))\ e
;))e f
string** 
?** 
country** 
=** $
TryGetAnyCaseInsensitive++ (
(++( )
root++) -
,++- .
$str++/ 8
,++8 9
$str++: H
,++H I
$str++J W
)++W X
??++Y [$
TryGetAnyCaseInsensitive,, (
(,,( )
root,,) -
,,,- .
$str,,/ <
,,,< =
$str,,> L
),,L M
;,,M N
if.. 
(.. 
string.. 
... 
IsNullOrWhiteSpace.. )
(..) *
country..* 1
)..1 2
)..2 3
{// 
return00 
Result00 
<00 
	IpCountry00 '
,00' (%
InternalServiceApiFailure00) B
>00B C
.00C D
Err00D G
(00G H%
InternalServiceApiFailure11 -
.11- .
ApiRequestFailed11. >
(11> ?
$str11? ]
)11] ^
)11^ _
;11_ `
}22 
return44 
Result44 
<44 
	IpCountry44 #
,44# $%
InternalServiceApiFailure44% >
>44> ?
.44? @
Ok44@ B
(44B C
new44C F
	IpCountry44G P
(44P Q
ipParsed44Q Y
,44Y Z
country44[ b
)44b c
)44c d
;44d e
}55 	
catch66 
(66 !
TaskCanceledException66 $
)66$ %
when66& *
(66+ ,
!66, -
cancellationToken66- >
.66> ?#
IsCancellationRequested66? V
)66V W
{77 	
return88 
Result88 
<88 
	IpCountry88 #
,88# $%
InternalServiceApiFailure88% >
>88> ?
.88? @
Err88@ C
(88C D%
InternalServiceApiFailure99 )
.99) *
ApiRequestFailed99* :
(99: ;
$str99; W
)99W X
)99X Y
;99Y Z
}:: 	
catch;; 
(;; &
OperationCanceledException;; )
);;) *
when;;+ /
(;;0 1
cancellationToken;;1 B
.;;B C#
IsCancellationRequested;;C Z
);;Z [
{<< 	
return== 
Result== 
<== 
	IpCountry== #
,==# $%
InternalServiceApiFailure==% >
>==> ?
.==? @
Err==@ C
(==C D%
InternalServiceApiFailure>> )
.>>) *
ApiRequestFailed>>* :
(>>: ;
$str>>; `
)>>` a
)>>a b
;>>b c
}?? 	
catch@@ 
(@@  
HttpRequestException@@ #
ex@@$ &
)@@& '
{AA 	
returnBB 
ResultBB 
<BB 
	IpCountryBB #
,BB# $%
InternalServiceApiFailureBB% >
>BB> ?
.BB? @
ErrBB@ C
(BBC D%
InternalServiceApiFailureCC )
.CC) *
ApiRequestFailedCC* :
(CC: ;
$strCC; [
,CC[ \
exCC] _
)CC_ `
)CC` a
;CCa b
}DD 	
catchEE 
(EE 
JsonExceptionEE 
exEE 
)EE  
{FF 	
returnGG 
ResultGG 
<GG 
	IpCountryGG #
,GG# $%
InternalServiceApiFailureGG% >
>GG> ?
.GG? @
ErrGG@ C
(GGC D%
InternalServiceApiFailureHH )
.HH) *
ApiRequestFailedHH* :
(HH: ;
$strHH; W
,HHW X
exHHY [
)HH[ \
)HH\ ]
;HH] ^
}II 	
}JJ 
privateLL 
staticLL 
stringLL 
?LL $
TryGetAnyCaseInsensitiveLL 3
(LL3 4
JsonElementLL4 ?
rootLL@ D
,LLD E
paramsLLF L
stringLLM S
[LLS T
]LLT U
namesLLV [
)LL[ \
{MM 
foreachNN 
(NN 
stringNN 
nNN 
inNN 
namesNN "
)NN" #
{OO 	
ifPP 
(PP 
rootPP 
.PP 
TryGetPropertyPP #
(PP# $
nPP$ %
,PP% &
outPP' *
JsonElementPP+ 6
elPP7 9
)PP9 :
&&PP; =
elPP> @
.PP@ A
	ValueKindPPA J
==PPK M
JsonValueKindPPN [
.PP[ \
StringPP\ b
)PPb c
{QQ 
returnRR 
elRR 
.RR 
	GetStringRR #
(RR# $
)RR$ %
;RR% &
}SS 
}TT 	
returnVV 
(VV 
fromVV 
pVV 
inVV 
rootVV 
.VV 
EnumerateObjectVV .
(VV. /
)VV/ 0
fromWW 
nWW 
inWW 
namesWW 
whereXX 
pXX 
.XX 
NameXX 
.XX 
EqualsXX #
(XX# $
nXX$ %
,XX% &
StringComparisonXX' 7
.XX7 8
OrdinalIgnoreCaseXX8 I
)XXI J
&&XXK M
pXXN O
.XXO P
ValueXXP U
.XXU V
	ValueKindXXV _
==XX` b
JsonValueKindXXc p
.XXp q
StringXXq w
selectYY 
pYY 
.YY 
ValueYY 
.YY 
	GetStringYY (
(YY( )
)YY) *
)YY* +
.YY+ ,
FirstOrDefaultYY, :
(YY: ;
)YY; <
;YY< =
}ZZ 
private\\ 
static\\ 
async\\ 
Task\\ 
<\\ 
string\\ $
>\\$ %!
SafeReadAsStringAsync\\& ;
(\\; <
HttpContent\\< G
content\\H O
,\\O P
CancellationToken\\Q b
cancellationToken\\c t
)\\t u
{]] 
try^^ 
{__ 	
return`` 
await`` 
content``  
.``  !
ReadAsStringAsync``! 2
(``2 3
cancellationToken``3 D
)``D E
.``E F
ConfigureAwait``F T
(``T U
false``U Z
)``Z [
;``[ \
}aa 	
catchbb 
{cc 	
returndd 
stringdd 
.dd 
Emptydd 
;dd  
}ee 	
}ff 
privatehh 
statichh 
stringhh 
Trimhh 
(hh 
stringhh %
shh& '
,hh' (
inthh) ,
maxhh- 0
)hh0 1
=>hh2 4
stringii 
.ii 
IsNullOrEmptyii 
(ii 
sii 
)ii 
||ii  "
sii# $
.ii$ %
Lengthii% +
<=ii, .
maxii/ 2
?ii3 4
sii5 6
:ii7 8
sii9 :
[ii: ;
..ii; =
maxii= @
]ii@ A
+iiB C
$striiD G
;iiG H
}jj ¢
ƒ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/External/IpGeolocation/IpCountry.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
External! )
.) *
IpGeolocation* 7
;7 8
public 
record 
	IpCountry 
( 
string 
	IpAddress (
,( )
string* 0
Country1 8
)8 9
;9 :êY
ˆ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/Localization/LocalizationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
.% &
Localization& 2
;2 3
internal 
sealed	 
class 
LocalizationService )
:* + 
ILocalizationService, @
{ 
private 
readonly 
FrozenDictionary %
<% &
string& ,
,, -
string. 4
>4 5#
_defaultLanguageStrings6 M
;M N
private 
readonly 
Lock 
_cultureChangeLock ,
=- .
new/ 2
(2 3
)3 4
;4 5
private 
FrozenDictionary 
< 
string #
,# $
string% +
>+ ,#
_currentLanguageStrings- D
;D E
private 
CultureInfo 
_currentCultureInfo +
;+ ,
public 

event 
Action 
? 
LanguageChanged (
;( )
public 

event '
PropertyChangedEventHandler ,
?, -
PropertyChanged. =
=> ?
delegate@ H
{I J
}K L
;L M
public 

CultureInfo 
CurrentCultureInfo )
=>* ,
_currentCultureInfo- @
;@ A
public 

string 
CurrentCultureName $
=>% '
_currentCultureInfo( ;
.; <
Name< @
;@ A
public 

string 
this 
[ 
string 
key !
]! "
{ 
get 
{ 	
if   
(   
string   
.   
IsNullOrWhiteSpace   )
(  ) *
key  * -
)  - .
)  . /
{!! 
return"" 
$str"" &
;""& '
}## 
if%% 
(%% #
_currentLanguageStrings%% '
.%%' (
TryGetValue%%( 3
(%%3 4
key%%4 7
,%%7 8
out%%9 <
string%%= C
?%%C D
value%%E J
)%%J K
)%%K L
{&& 
return'' 
value'' 
;'' 
}(( 
return** #
_defaultLanguageStrings** *
.*** +
TryGetValue**+ 6
(**6 7
key**7 :
,**: ;
out**< ?
string**@ F
?**F G
defaultValue**H T
)**T U
?**V W
defaultValue**X d
:**e f
$"**g i
$str**i j
{**j k
key**k n
}**n o
$str**o p
"**p q
;**q r
}++ 	
},, 
public.. 

LocalizationService.. 
(.. !
DefaultSystemSettings.. 4!
defaultSystemSettings..5 J
)..J K
{// 
string00 
?00 
defaultCultureName00 "
=00# $!
defaultSystemSettings00% :
.00: ;
Culture00; B
;00B C
_currentCultureInfo22 
=22 
CreateCultureInfo22 /
(22/ 0
defaultCultureName220 B
)22B C
;22C D#
_defaultLanguageStrings33 
=33  !
LocalizationData33" 2
.332 3
EnglishStrings333 A
;33A B#
_currentLanguageStrings55 
=55  !
GetLanguageStrings55" 4
(554 5
defaultCultureName555 G
.55G H
ToOption55H P
(55P Q
)55Q R
)55R S
.66 
ValueOr66 
(66 #
_defaultLanguageStrings66 ,
)66, -
;66- .
}77 
public99 

string99 
	GetString99 
(99 
string99 "
key99# &
,99& '
params99( .
object99/ 5
[995 6
]996 7
args998 <
)99< =
{:: 
string;; 
formatString;; 
=;; 
this;; "
[;;" #
key;;# &
];;& '
;;;' (
if== 

(== 
formatString== 
.== 

StartsWith== #
(==# $
$char==$ '
)==' (
&&==) +
formatString==, 8
.==8 9
EndsWith==9 A
(==A B
$char==B E
)==E F
||==G I
args==J N
.==N O
Length==O U
====V X
$num==Y Z
)==Z [
{>> 	
return?? 
formatString?? 
;??  
}@@ 	
tryBB 
{CC 	
returnDD 
stringDD 
.DD 
FormatDD  
(DD  !
_currentCultureInfoDD! 4
,DD4 5
formatStringDD6 B
,DDB C
argsDDD H
)DDH I
;DDI J
}EE 	
catchFF 
(FF 
FormatExceptionFF 
)FF 
{GG 	
returnHH 
formatStringHH 
;HH  
}II 	
}JJ 
publicLL 

voidLL 

SetCultureLL 
(LL 
stringLL !
?LL! "
cultureNameLL# .
,LL. /
ActionLL0 6
?LL6 7
onCultureChangedLL8 H
=LLI J
nullLLK O
)LLO P
{MM 
CultureInfoNN 
newCultureInfoNN "
=NN# $
CreateCultureInfoNN% 6
(NN6 7
cultureNameNN7 B
)NNB C
;NNC D
lockPP 
(PP 
_cultureChangeLockPP  
)PP  !
{QQ 	
ifRR 
(RR 
_currentCultureInfoRR #
.RR# $
NameRR$ (
.RR( )
EqualsRR) /
(RR/ 0
newCultureInfoRR0 >
.RR> ?
NameRR? C
,RRC D
StringComparisonRRE U
.RRU V
OrdinalIgnoreCaseRRV g
)RRg h
)RRh i
{SS 
returnTT 
;TT 
}UU 
_currentCultureInfoWW 
=WW  !
newCultureInfoWW" 0
;WW0 1#
_currentLanguageStringsXX #
=XX$ %
GetLanguageStringsXX& 8
(XX8 9
cultureNameXX9 D
.XXD E
ToOptionXXE M
(XXM N
)XXN O
)XXO P
.YY 
ValueOrYY 
(YY #
_defaultLanguageStringsYY 0
)YY0 1
;YY1 2
}ZZ 	
if\\ 

(\\ 
onCultureChanged\\ 
is\\ 
not\\  #
null\\$ (
)\\( )
{]] 	
OnLanguageChanged^^ 
(^^ 
)^^ 
;^^  &
NotifyAllPropertiesChanged__ &
(__& '
)__' (
;__( )
onCultureChanged`` 
.`` 
Invoke`` #
(``# $
)``$ %
;``% &
}aa 	
}bb 
privatedd 
staticdd 
CultureInfodd 
CreateCultureInfodd 0
(dd0 1
stringdd1 7
?dd7 8
cultureNamedd9 D
)ddD E
{ee 
tryff 
{gg 	
returnhh 
CultureInfohh 
.hh 
GetCultureInfohh -
(hh- .
cultureNamehh. 9
??hh: <
$strhh= D
)hhD E
;hhE F
}ii 	
catchjj 
(jj $
CultureNotFoundExceptionjj '
)jj' (
{kk 	
returnll 
CultureInfoll 
.ll 
GetCultureInfoll -
(ll- .
$strll. 5
)ll5 6
;ll6 7
}mm 	
}nn 
privatepp 
staticpp 
Optionpp 
<pp 
FrozenDictionarypp *
<pp* +
stringpp+ 1
,pp1 2
stringpp3 9
>pp9 :
>pp: ;
GetLanguageStringspp< N
(ppN O
OptionppO U
<ppU V
stringppV \
>pp\ ]
cultureNamepp^ i
)ppi j
{qq 
returnrr 
cultureNamerr 
.ss 
Wheress 
(ss 
namess 
=>ss 
!ss 
stringss "
.ss" #
IsNullOrEmptyss# 0
(ss0 1
namess1 5
)ss5 6
)ss6 7
.tt 
Bindtt 
(tt 
namett 
=>tt 
LocalizationDatatt *
.tt* +
AllLanguagestt+ 7
.tt7 8
GetValueOrDefaulttt8 I
(ttI J
namettJ N
)ttN O
.ttO P
ToOptionttP X
(ttX Y
)ttY Z
)ttZ [
;tt[ \
}uu 
privateww 
voidww 
OnLanguageChangedww "
(ww" #
)ww# $
{xx 
ifyy 

(yy 

Dispatcheryy 
.yy 
UIThreadyy 
.yy  
CheckAccessyy  +
(yy+ ,
)yy, -
)yy- .
{zz 	
LanguageChanged{{ 
?{{ 
.{{ 
Invoke{{ #
({{# $
){{$ %
;{{% &
}|| 	
else}} 
{~~ 	

Dispatcher 
. 
UIThread 
.  
Post  $
($ %
(% &
)& '
=>( *
LanguageChanged+ :
?: ;
.; <
Invoke< B
(B C
)C D
)D E
;E F
}
€€ 	
}
 
private
ƒƒ 
void
ƒƒ (
NotifyAllPropertiesChanged
ƒƒ +
(
ƒƒ+ ,
)
ƒƒ, -
{
„„ 
if
…… 

(
…… 

Dispatcher
…… 
.
…… 
UIThread
…… 
.
……  
CheckAccess
……  +
(
……+ ,
)
……, -
)
……- .
{
†† 	
PropertyChanged
‡‡ 
?
‡‡ 
.
‡‡ 
Invoke
‡‡ #
(
‡‡# $
this
‡‡$ (
,
‡‡( )
new
‡‡* -&
PropertyChangedEventArgs
‡‡. F
(
‡‡F G
$str
‡‡G M
)
‡‡M N
)
‡‡N O
;
‡‡O P
PropertyChanged
ˆˆ 
?
ˆˆ 
.
ˆˆ 
Invoke
ˆˆ #
(
ˆˆ# $
this
ˆˆ$ (
,
ˆˆ( )
new
ˆˆ* -&
PropertyChangedEventArgs
ˆˆ. F
(
ˆˆF G
$str
ˆˆG O
)
ˆˆO P
)
ˆˆP Q
;
ˆˆQ R
}
‰‰ 	
else
ŠŠ 
{
‹‹ 	

Dispatcher
ŒŒ 
.
ŒŒ 
UIThread
ŒŒ 
.
ŒŒ  
Post
ŒŒ  $
(
ŒŒ$ %
(
ŒŒ% &
)
ŒŒ& '
=>
ŒŒ( *
{
 
PropertyChanged
ŽŽ 
?
ŽŽ  
.
ŽŽ  !
Invoke
ŽŽ! '
(
ŽŽ' (
this
ŽŽ( ,
,
ŽŽ, -
new
ŽŽ. 1&
PropertyChangedEventArgs
ŽŽ2 J
(
ŽŽJ K
$str
ŽŽK Q
)
ŽŽQ R
)
ŽŽR S
;
ŽŽS T
PropertyChanged
 
?
  
.
  !
Invoke
! '
(
' (
this
( ,
,
, -
new
. 1&
PropertyChangedEventArgs
2 J
(
J K
$str
K S
)
S T
)
T U
;
U V
}
 
)
 
;
 
}
‘‘ 	
}
’’ 
}““ Û
…/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/Localization/LocalizationKeys.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
.% &
Localization& 2
;2 3
public 
static 
class 
LocalizationKeys $
{ 
public 

static 
class 
Authentication &
{ 
public 
static 
class 
Error !
{ 	
public		 
const		 
string		 
NAVIGATION_FAILURE		  2
=		3 4
$str		5 ]
;		] ^
public

 
const

 
string

 *
MEMBERSHIP_IDENTIFIER_REQUIRED

  >
=

? @
$str

A t
;

t u
public 
const 
string 
SESSION_EXPIRED  /
=0 1
$str2 X
;X Y
public 
const 
string #
REGISTRATION_INCOMPLETE  7
=8 9
$str: g
;g h
} 	
public 
static 
class 
SignUp "
{ 	
public 
static 
class 
MobileVerification  2
{ 
public 
const 
string #
TITLE$ )
=* +
$str, \
;\ ]
public 
const 
string #
DESCRIPTION$ /
=0 1
$str2 h
;h i
public 
const 
string #
HINT$ (
=) *
$str+ Z
;Z [
public 
const 
string #
	WATERMARK$ -
=. /
$str0 d
;d e
public 
const 
string #
BUTTON$ *
=+ ,
$str- ^
;^ _
} 
public 
static 
class !
VerificationCodeEntry  5
{ 
public 
const 
string #
TITLE$ )
=* +
$str, _
;_ `
public 
const 
string #
DESCRIPTION$ /
=0 1
$str2 k
;k l
public 
const 
string #
HINT$ (
=) *
$str+ ]
;] ^
public 
const 
string #
ERROR_INVALID_CODE$ 6
=7 8
$str9 x
;x y
public   
const   
string   #
BUTTON_VERIFY  $ 1
=  2 3
$str  4 o
;  o p
public!! 
const!! 
string!! #
BUTTON_RESEND!!$ 1
=!!2 3
$str!!4 o
;!!o p
}"" 
public$$ 
static$$ 
class$$ 
NicknameInput$$  -
{%% 
public&& 
const&& 
string&& #
TITLE&&$ )
=&&* +
$str&&, W
;&&W X
public'' 
const'' 
string'' #
DESCRIPTION''$ /
=''0 1
$str''2 c
;''c d
public(( 
const(( 
string(( #
HINT(($ (
=(() *
$str((+ U
;((U V
public)) 
const)) 
string)) #
	WATERMARK))$ -
=)). /
$str))0 _
;))_ `
public** 
const** 
string** #
BUTTON**$ *
=**+ ,
$str**- Y
;**Y Z
}++ 
public-- 
static-- 
class-- !
SecureKeyConfirmation--  5
{.. 
public// 
const// 
string// #
TITLE//$ )
=//* +
$str//, _
;//_ `
public00 
const00 
string00 #
DESCRIPTION00$ /
=000 1
$str002 k
;00k l
public11 
const11 
string11 #"
SECURE_KEY_PLACEHOLDER11$ :
=11; <
$str	11= 
;
11 ‚
public22 
const22 
string22 #
SECURE_KEY_HINT22$ 3
=224 5
$str226 s
;22s t
public33 
const33 
string33 #)
VERIFY_SECURE_KEY_PLACEHOLDER33$ A
=33B C
$str	33D 
;
33 
public44 
const44 
string44 #"
VERIFY_SECURE_KEY_HINT44$ :
=44; <
$str	44= 
;
44 ‚
public55 
const55 
string55 #%
ERROR_SECURE_KEY_MISMATCH55$ =
=55> ?
$str	55@ …
;
55… †
public66 
const66 
string66 #
BUTTON66$ *
=66+ ,
$str66- a
;66a b
}77 
public99 
static99 
class99 
	PassPhase99  )
{:: 
public;; 
const;; 
string;; #
TITLE;;$ )
=;;* +
$str;;, S
;;;S T
public<< 
const<< 
string<< #
DESCRIPTION<<$ /
=<<0 1
$str<<2 _
;<<_ `
public== 
const== 
string== #
HINT==$ (
===) *
$str==+ Q
;==Q R
public>> 
const>> 
string>> #
	WATERMARK>>$ -
=>>. /
$str>>0 [
;>>[ \
public?? 
const?? 
string?? #
BUTTON??$ *
=??+ ,
$str??- U
;??U V
}@@ 
}AA 	
publicCC 
staticCC 
classCC 
SecureKeyRecoveryCC -
{DD 	
publicEE 
staticEE 
classEE 
MobileVerificationEE  2
{FF 
publicGG 
constGG 
stringGG #
TITLEGG$ )
=GG* +
$strGG, g
;GGg h
publicHH 
constHH 
stringHH #
DESCRIPTIONHH$ /
=HH0 1
$strHH2 s
;HHs t
publicII 
constII 
stringII #
HINTII$ (
=II) *
$strII+ e
;IIe f
publicJJ 
constJJ 
stringJJ #
	WATERMARKJJ$ -
=JJ. /
$strJJ0 o
;JJo p
publicKK 
constKK 
stringKK #
BUTTONKK$ *
=KK+ ,
$strKK- i
;KKi j
}LL 
publicNN 
staticNN 
classNN 
ResetNN  %
{OO 
publicPP 
constPP 
stringPP #
TITLEPP$ )
=PP* +
$strPP, Z
;PPZ [
publicQQ 
constQQ 
stringQQ #
DESCRIPTIONQQ$ /
=QQ0 1
$strQQ2 f
;QQf g
publicRR 
constRR 
stringRR #&
NEW_SECURE_KEY_PLACEHOLDERRR$ >
=RR? @
$str	RRA 
;
RR ‚
publicSS 
constSS 
stringSS #
NEW_SECURE_KEY_HINTSS$ 7
=SS8 9
$strSS: s
;SSs t
publicTT 
constTT 
stringTT #*
CONFIRM_SECURE_KEY_PLACEHOLDERTT$ B
=TTC D
$str	TTE ‰
;
TT‰ Š
publicUU 
constUU 
stringUU ##
CONFIRM_SECURE_KEY_HINTUU$ ;
=UU< =
$strUU> {
;UU{ |
publicVV 
constVV 
stringVV #
BUTTONVV$ *
=VV+ ,
$strVV- \
;VV\ ]
}WW 
}XX 	
publicZZ 
staticZZ 
classZZ 
SignInZZ "
{[[ 	
public\\ 
const\\ 
string\\ 
TITLE\\  %
=\\& '
$str\\( E
;\\E F
public]] 
const]] 
string]] 
WELCOME]]  '
=]]( )
$str]]* I
;]]I J
public^^ 
const^^ 
string^^ 
MOBILE_PLACEHOLDER^^  2
=^^3 4
$str^^5 ^
;^^^ _
public__ 
const__ 
string__ 
MOBILE_HINT__  +
=__, -
$str__. P
;__P Q
public`` 
const`` 
string`` "
SECURE_KEY_PLACEHOLDER``  6
=``7 8
$str``9 g
;``g h
publicaa 
constaa 
stringaa 
SECURE_KEY_HINTaa  /
=aa0 1
$straa2 Y
;aaY Z
publicbb 
constbb 
stringbb 
ACCOUNT_RECOVERYbb  0
=bb1 2
$strbb3 Z
;bbZ [
publiccc 
constcc 
stringcc 
CONTINUEcc  (
=cc) *
$strcc+ K
;ccK L
}dd 	
}ee 
publicgg 

staticgg 
classgg $
MobileVerificationStatusgg 0
{hh 
publicii 
staticii 
classii 
Errorii !
{jj 	
publickk 
constkk 
stringkk %
MOBILE_ALREADY_REGISTEREDkk  9
=kk: ;
$strkk< n
;kkn o
}ll 	
publicnn 
constnn 
stringnn &
AVAILABLE_FOR_REGISTRATIONnn 6
=nn7 8
$strnn9 \
;nn\ ]
publicoo 
constoo 
stringoo ,
 INCOMPLETE_REGISTRATION_CONTINUEoo <
=oo= >
$stroo? h
;ooh i
publicpp 
constpp 
stringpp  
TAKEN_ACTIVE_ACCOUNTpp 0
=pp1 2
$strpp3 P
;ppP Q
publicqq 
constqq 
stringqq "
TAKEN_INACTIVE_ACCOUNTqq 2
=qq3 4
$strqq5 T
;qqT U
publicrr 
constrr 
stringrr +
DATA_CORRUPTION_CONTACT_SUPPORTrr ;
=rr< =
$strrr> f
;rrf g
publicss 
constss 
stringss $
AVAILABLE_ON_THIS_DEVICEss 4
=ss5 6
$strss7 X
;ssX Y
}tt 
publicvv 

staticvv 
classvv 
Verificationvv $
{ww 
publicxx 
staticxx 
classxx 
Errorxx !
{yy 	
publiczz 
constzz 
stringzz 
INVALID_OTP_CODEzz  0
=zz1 2
$strzz3 V
;zzV W
public{{ 
const{{ 
string{{ 

NO_SESSION{{  *
={{+ ,
$str{{- K
;{{K L
public|| 
const|| 
string|| 
SESSION_EXPIRED||  /
=||0 1
$str||2 V
;||V W
public}} 
const}} 
string}} 
NO_ACTIVE_SESSION}}  1
=}}2 3
$str}}4 X
;}}X Y
public~~ 
const~~ 
string~~  
MAX_ATTEMPTS_REACHED~~  4
=~~5 6
$str~~7 ^
;~~^ _
public 
const 
string 
VERIFICATION_FAILED  3
=4 5
$str6 ]
;] ^
public
€€ 
const
€€ 
string
€€ 
SESSION_NOT_FOUND
€€  1
=
€€2 3
$str
€€4 X
;
€€X Y
public
 
const
 
string
 (
GLOBAL_RATE_LIMIT_EXCEEDED
  :
=
; <
$str
= i
;
i j
}
‚‚ 	
public
„„ 
static
„„ 
class
„„ 
Info
„„  
{
…… 	
public
†† 
const
†† 
string
†† 
REDIRECTING
††  +
=
††, -
$str
††. M
;
††M N
public
‡‡ 
const
‡‡ 
string
‡‡ $
REDIRECTING_IN_SECONDS
‡‡  6
=
‡‡7 8
$str
‡‡9 a
;
‡‡a b
}
ˆˆ 	
}
‰‰ 
public
‹‹ 

static
‹‹ 
class
‹‹ 
Registration
‹‹ $
{
ŒŒ 
public
 
static
 
class
 
Error
 !
{
ŽŽ 	
public
 
const
 
string
 
FAILED
  &
=
' (
$str
) D
;
D E
}
 	
}
‘‘ 
public
““ 

static
““ 
class
““ 
ValidationErrors
““ (
{
”” 
public
•• 
static
•• 
class
•• 
MobileNumber
•• (
{
–– 	
public
—— 
const
—— 
string
—— *
MUST_START_WITH_COUNTRY_CODE
——  <
=
——= >
$str
——? {
;
——{ |
public
˜˜ 
const
˜˜ 
string
˜˜ !
CONTAINS_NON_DIGITS
˜˜  3
=
˜˜4 5
$str
˜˜6 i
;
˜˜i j
public
™™ 
const
™™ 
string
™™ 
INCORRECT_LENGTH
™™  0
=
™™1 2
$str
™™3 c
;
™™c d
public
šš 
const
šš 
string
šš 
CANNOT_BE_EMPTY
šš  /
=
šš0 1
$str
šš2 a
;
šša b
public
›› 
const
›› 
string
›› 
REQUIRED
››  (
=
››) *
$str
››+ S
;
››S T
}
œœ 	
public
žž 
static
žž 
class
žž $
MobileNumberIdentifier
žž 2
{
ŸŸ 	
public
   
const
   
string
   
REQUIRED
    (
=
  ) *
$str
  + ]
;
  ] ^
}
¡¡ 	
public
££ 
static
££ 
class
££ 
DeviceIdentifier
££ ,
{
¤¤ 	
public
¥¥ 
const
¥¥ 
string
¥¥ 
REQUIRED
¥¥  (
=
¥¥) *
$str
¥¥+ W
;
¥¥W X
}
¦¦ 	
public
¨¨ 
static
¨¨ 
class
¨¨ 
SessionIdentifier
¨¨ -
{
©© 	
public
ªª 
const
ªª 
string
ªª 
REQUIRED
ªª  (
=
ªª) *
$str
ªª+ X
;
ªªX Y
}
«« 	
public
­­ 
static
­­ 
class
­­ "
MembershipIdentifier
­­ 0
{
®® 	
public
¯¯ 
const
¯¯ 
string
¯¯ 
REQUIRED
¯¯  (
=
¯¯) *
$str
¯¯+ [
;
¯¯[ \
}
°° 	
public
²² 
static
²² 
class
²² 
	SecureKey
²² %
{
³³ 	
public
´´ 
const
´´ 
string
´´ 
REQUIRED
´´  (
=
´´) *
$str
´´+ P
;
´´P Q
public
µµ 
const
µµ 
string
µµ 

MIN_LENGTH
µµ  *
=
µµ+ ,
$str
µµ- T
;
µµT U
public
¶¶ 
const
¶¶ 
string
¶¶ 

MAX_LENGTH
¶¶  *
=
¶¶+ ,
$str
¶¶- T
;
¶¶T U
public
·· 
const
·· 
string
·· 
	NO_SPACES
··  )
=
··* +
$str
··, R
;
··R S
public
¸¸ 
const
¸¸ 
string
¸¸ 
NO_UPPERCASE
¸¸  ,
=
¸¸- .
$str
¸¸/ X
;
¸¸X Y
public
¹¹ 
const
¹¹ 
string
¹¹ 
NO_LOWERCASE
¹¹  ,
=
¹¹- .
$str
¹¹/ X
;
¹¹X Y
public
ºº 
const
ºº 
string
ºº 
NO_DIGIT
ºº  (
=
ºº) *
$str
ºº+ P
;
ººP Q
public
»» 
const
»» 
string
»» 

TOO_SIMPLE
»»  *
=
»»+ ,
$str
»»- T
;
»»T U
public
¼¼ 
const
¼¼ 
string
¼¼ 

TOO_COMMON
¼¼  *
=
¼¼+ ,
$str
¼¼- T
;
¼¼T U
public
½½ 
const
½½ 
string
½½  
SEQUENTIAL_PATTERN
½½  2
=
½½3 4
$str
½½5 d
;
½½d e
public
¾¾ 
const
¾¾ 
string
¾¾ 
REPEATED_CHARS
¾¾  .
=
¾¾/ 0
$str
¾¾1 \
;
¾¾\ ]
public
¿¿ 
const
¿¿ 
string
¿¿ 
LACKS_DIVERSITY
¿¿  /
=
¿¿0 1
$str
¿¿2 ^
;
¿¿^ _
public
ÀÀ 
const
ÀÀ 
string
ÀÀ 
CONTAINS_APP_NAME
ÀÀ  1
=
ÀÀ2 3
$str
ÀÀ4 b
;
ÀÀb c
public
ÁÁ 
const
ÁÁ 
string
ÁÁ !
INVALID_CREDENTIALS
ÁÁ  3
=
ÁÁ4 5
$str
ÁÁ6 e
;
ÁÁe f
public
ÂÂ 
const
ÂÂ 
string
ÂÂ !
NON_ENGLISH_LETTERS
ÂÂ  3
=
ÂÂ4 5
$str
ÂÂ6 f
;
ÂÂf g
public
ÃÃ 
const
ÃÃ 
string
ÃÃ 
NO_SPECIAL_CHAR
ÃÃ  /
=
ÃÃ0 1
$str
ÃÃ2 ^
;
ÃÃ^ _
}
ÄÄ 	
public
ÆÆ 
static
ÆÆ 
class
ÆÆ 
VerifySecureKey
ÆÆ +
{
ÇÇ 	
public
ÈÈ 
const
ÈÈ 
string
ÈÈ 
DOES_NOT_MATCH
ÈÈ  .
=
ÈÈ/ 0
$str
ÈÈ1 `
;
ÈÈ` a
}
ÉÉ 	
public
ËË 
static
ËË 
class
ËË 
Strength
ËË $
{
ÌÌ 	
public
ÍÍ 
const
ÍÍ 
string
ÍÍ 
INVALID
ÍÍ  '
=
ÍÍ( )
$str
ÍÍ* V
;
ÍÍV W
public
ÎÎ 
const
ÎÎ 
string
ÎÎ 
	VERY_WEAK
ÎÎ  )
=
ÎÎ* +
$str
ÎÎ, Y
;
ÎÎY Z
public
ÏÏ 
const
ÏÏ 
string
ÏÏ 
WEAK
ÏÏ  $
=
ÏÏ% &
$str
ÏÏ' P
;
ÏÏP Q
public
ÐÐ 
const
ÐÐ 
string
ÐÐ 
GOOD
ÐÐ  $
=
ÐÐ% &
$str
ÐÐ' P
;
ÐÐP Q
public
ÑÑ 
const
ÑÑ 
string
ÑÑ 
STRONG
ÑÑ  &
=
ÑÑ' (
$str
ÑÑ) T
;
ÑÑT U
public
ÒÒ 
const
ÒÒ 
string
ÒÒ 
VERY_STRONG
ÒÒ  +
=
ÒÒ, -
$str
ÒÒ. ]
;
ÒÒ] ^
}
ÓÓ 	
}
ÔÔ 
public
ÖÖ 

static
ÖÖ 
class
ÖÖ  
ValidationWarnings
ÖÖ *
{
×× 
public
ØØ 
static
ØØ 
class
ØØ 
	SecureKey
ØØ %
{
ÙÙ 	
public
ÚÚ 
const
ÚÚ 
string
ÚÚ 
NON_LATIN_LETTER
ÚÚ  0
=
ÚÚ1 2
$str
ÚÚ3 `
;
ÚÚ` a
public
ÛÛ 
const
ÛÛ 
string
ÛÛ 
INVALID_CHARACTER
ÛÛ  1
=
ÛÛ2 3
$str
ÛÛ4 c
;
ÛÛc d
public
ÜÜ 
const
ÜÜ 
string
ÜÜ !
MULTIPLE_CHARACTERS
ÜÜ  3
=
ÜÜ4 5
$str
ÜÜ6 g
;
ÜÜg h
}
ÝÝ 	
}
ÞÞ 
public
àà 

static
àà 
class
àà 
ResponseErrors
àà &
{
áá 
public
ââ 
static
ââ 
class
ââ 
MobileNumber
ââ (
{
ãã 	
public
ää 
const
ää 
string
ää (
ACCOUNT_ALREADY_REGISTERED
ää  :
=
ää; <
$str
ää= s
;
ääs t
public
åå 
const
åå 
string
åå *
UNEXPECTED_MEMBERSHIP_STATUS
åå  <
=
åå= >
$str
åå? w
;
ååw x
}
ææ 	
public
èè 
static
èè 
class
èè 
General
èè #
{
éé 	
public
êê 
const
êê 
string
êê 
TIMEOUT_EXCEEDED
êê  0
=
êê1 2
$str
êê3 Z
;
êêZ [
}
ëë 	
}
ìì 
public
îî 

static
îî 
class
îî 
Welcome
îî 
{
ïï 
public
ðð 
const
ðð 
string
ðð 
SIGN_IN_BUTTON
ðð *
=
ðð+ ,
$str
ðð- C
;
ððC D
public
ññ 
const
ññ 
string
ññ #
CREATE_ACCOUNT_BUTTON
ññ 1
=
ññ2 3
$str
ññ4 Q
;
ññQ R
}
òò 
public
ôô 

static
ôô 
class
ôô 
Footer
ôô 
{
õõ 
public
öö 
const
öö 
string
öö 
PRIVACY_POLICY
öö *
=
öö+ ,
$str
öö- C
;
ööC D
public
÷÷ 
const
÷÷ 
string
÷÷ 
TERMS_OF_SERVICE
÷÷ ,
=
÷÷- .
$str
÷÷/ F
;
÷÷F G
public
øø 
const
øø 
string
øø 
SUPPORT
øø #
=
øø$ %
$str
øø& 6
;
øø6 7
public
ùù 
const
ùù 
string
ùù 
AGREEMENT_TEXT
ùù *
=
ùù+ ,
$str
ùù- C
;
ùùC D
public
úú 
const
úú 
string
úú 
	COPYRIGHT
úú %
=
úú& '
$str
úú( :
;
úú: ;
}
ûû 
public
ýý 

static
ýý 
class
ýý 

Navigation
ýý "
{
þþ 
public
ÿÿ 
const
ÿÿ 
string
ÿÿ 
BACK
ÿÿ  
=
ÿÿ! "
$str
ÿÿ# 4
;
ÿÿ4 5
public
€€ 
const
€€ 
string
€€ 
CLOSE
€€ !
=
€€" #
$str
€€$ 6
;
€€6 7
public
 
const
 
string
 
MINIMIZE
 $
=
% &
$str
' <
;
< =
public
‚‚ 
const
‚‚ 
string
‚‚ 
MAXIMIZE
‚‚ $
=
‚‚% &
$str
‚‚' <
;
‚‚< =
}
ƒƒ 
public
…… 

static
…… 
class
…… 
Common
…… 
{
†† 
public
‡‡ 
const
‡‡ 
string
‡‡ 
LOADING
‡‡ #
=
‡‡$ %
$str
‡‡& 6
;
‡‡6 7
public
ˆˆ 
const
ˆˆ 
string
ˆˆ 
ERROR
ˆˆ !
=
ˆˆ" #
$str
ˆˆ$ 2
;
ˆˆ2 3
public
‰‰ 
const
‰‰ 
string
‰‰ 
SUCCESS
‰‰ #
=
‰‰$ %
$str
‰‰& 6
;
‰‰6 7
public
ŠŠ 
const
ŠŠ 
string
ŠŠ 
CANCEL
ŠŠ "
=
ŠŠ# $
$str
ŠŠ% 4
;
ŠŠ4 5
public
‹‹ 
const
‹‹ 
string
‹‹ 
UNEXPECTED_ERROR
‹‹ ,
=
‹‹- .
$str
‹‹/ G
;
‹‹G H
public
ŒŒ 
const
ŒŒ 
string
ŒŒ 
OK
ŒŒ 
=
ŒŒ  
$str
ŒŒ! ,
;
ŒŒ, -
public
 
const
 
string
 $
NO_INTERNET_CONNECTION
 2
=
3 4
$str
5 R
;
R S
public
ŽŽ 
const
ŽŽ 
string
ŽŽ 
CHECK_CONNECTION
ŽŽ ,
=
ŽŽ- .
$str
ŽŽ/ G
;
ŽŽG H
public
 
const
 
string
  
SERVER_UNAVAILABLE
 .
=
/ 0
$str
1 K
;
K L
}
 
public
’’ 

static
’’ 
class
’’ !
NetworkNotification
’’ +
{
““ 
public
”” 
static
”” 
class
”” 

NoInternet
”” &
{
•• 	
public
–– 
const
–– 
string
–– 
TITLE
––  %
=
––& '
$str
––( N
;
––N O
public
—— 
const
—— 
string
—— 
DESCRIPTION
——  +
=
——, -
$str
——. Z
;
——Z [
}
˜˜ 	
public
šš 
static
šš 
class
šš 
CheckingInternet
šš ,
{
›› 	
public
œœ 
const
œœ 
string
œœ 
TITLE
œœ  %
=
œœ& '
$str
œœ( T
;
œœT U
public
 
const
 
string
 
DESCRIPTION
  +
=
, -
$str
. `
;
` a
}
žž 	
public
   
static
   
class
   
InternetRestored
   ,
{
¡¡ 	
public
¢¢ 
const
¢¢ 
string
¢¢ 
TITLE
¢¢  %
=
¢¢& '
$str
¢¢( T
;
¢¢T U
public
££ 
const
££ 
string
££ 
DESCRIPTION
££  +
=
££, -
$str
££. `
;
££` a
}
¤¤ 	
public
¦¦ 
static
¦¦ 
class
¦¦ 

Connecting
¦¦ &
{
§§ 	
public
¨¨ 
const
¨¨ 
string
¨¨ 
TITLE
¨¨  %
=
¨¨& '
$str
¨¨( N
;
¨¨N O
public
©© 
const
©© 
string
©© 
DESCRIPTION
©©  +
=
©©, -
$str
©©. Z
;
©©Z [
}
ªª 	
public
¬¬ 
static
¬¬ 
class
¬¬ 
Reconnecting
¬¬ (
{
­­ 	
public
®® 
const
®® 
string
®® 
TITLE
®®  %
=
®®& '
$str
®®( P
;
®®P Q
public
¯¯ 
const
¯¯ 
string
¯¯ 
DESCRIPTION
¯¯  +
=
¯¯, -
$str
¯¯. \
;
¯¯\ ]
}
°° 	
public
²² 
static
²² 
class
²² !
ServerNotResponding
²² /
{
³³ 	
public
´´ 
const
´´ 
string
´´ 
TITLE
´´  %
=
´´& '
$str
´´( W
;
´´W X
public
µµ 
const
µµ 
string
µµ 
DESCRIPTION
µµ  +
=
µµ, -
$str
µµ. c
;
µµc d
}
¶¶ 	
public
¸¸ 
static
¸¸ 
class
¸¸  
ServerShuttingDown
¸¸ .
{
¹¹ 	
public
ºº 
const
ºº 
string
ºº 
TITLE
ºº  %
=
ºº& '
$str
ºº( V
;
ººV W
public
»» 
const
»» 
string
»» 
DESCRIPTION
»»  +
=
»», -
$str
»». b
;
»»b c
}
¼¼ 	
public
¾¾ 
static
¾¾ 
class
¾¾ 
RetriesExhausted
¾¾ ,
{
¿¿ 	
public
ÀÀ 
const
ÀÀ 
string
ÀÀ 
TITLE
ÀÀ  %
=
ÀÀ& '
$str
ÀÀ( T
;
ÀÀT U
public
ÁÁ 
const
ÁÁ 
string
ÁÁ 
DESCRIPTION
ÁÁ  +
=
ÁÁ, -
$str
ÁÁ. `
;
ÁÁ` a
}
ÂÂ 	
public
ÄÄ 
static
ÄÄ 
class
ÄÄ 
ServerReconnected
ÄÄ -
{
ÅÅ 	
public
ÆÆ 
const
ÆÆ 
string
ÆÆ 
TITLE
ÆÆ  %
=
ÆÆ& '
$str
ÆÆ( U
;
ÆÆU V
public
ÇÇ 
const
ÇÇ 
string
ÇÇ 
DESCRIPTION
ÇÇ  +
=
ÇÇ, -
$str
ÇÇ. a
;
ÇÇa b
}
ÈÈ 	
public
ÊÊ 
static
ÊÊ 
class
ÊÊ 
Button
ÊÊ "
{
ËË 	
public
ÌÌ 
const
ÌÌ 
string
ÌÌ 
RETRY
ÌÌ  %
=
ÌÌ& '
$str
ÌÌ( J
;
ÌÌJ K
}
ÍÍ 	
}
ÎÎ 
public
ÐÐ 

static
ÐÐ 
class
ÐÐ 
LanguageDetection
ÐÐ )
{
ÑÑ 
public
ÒÒ 
const
ÒÒ 
string
ÒÒ 
TITLE
ÒÒ !
=
ÒÒ" #
$str
ÒÒ$ =
;
ÒÒ= >
public
ÓÓ 
const
ÓÓ 
string
ÓÓ 
PROMPT
ÓÓ "
=
ÓÓ# $
$str
ÓÓ% ?
;
ÓÓ? @
public
ÔÔ 
const
ÔÔ 
string
ÔÔ 
BUTTON_CONFIRM
ÔÔ *
=
ÔÔ+ ,
$str
ÔÔ- O
;
ÔÔO P
public
ÕÕ 
const
ÕÕ 
string
ÕÕ 
BUTTON_DECLINE
ÕÕ *
=
ÕÕ+ ,
$str
ÕÕ- O
;
ÕÕO P
}
ÖÖ 
}×× «—
…/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/Localization/LocalizationData.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
.% &
Localization& 2
;2 3
public 
static 
class 
LocalizationData $
{ 
public		 

static		 
readonly		 
FrozenDictionary		 +
<		+ ,
string		, 2
,		2 3
string		4 :
>		: ;
EnglishStrings		< J
=		K L
new		M P

Dictionary		Q [
<		[ \
string		\ b
,		b c
string		d j
>		j k
{

 
[ 	
ErrorI18NKeys	 
. 

VALIDATION !
]! "
=# $
$str% a
,a b
[ 	
ErrorI18NKeys	 
. 
MAX_ATTEMPTS #
]# $
=% &
$str' b
,b c
[ 	
ErrorI18NKeys	 
. 
INVALID_MOBILE %
]% &
=' (
$str) H
,H I
[ 	
ErrorI18NKeys	 
. 
OTP_EXPIRED "
]" #
=$ %
$str& U
,U V
[ 	
ErrorI18NKeys	 
. 
	NOT_FOUND  
]  !
=" #
$str$ C
,C D
[ 	
ErrorI18NKeys	 
. 
ALREADY_EXISTS %
]% &
=' (
$str) C
,C D
[ 	
ErrorI18NKeys	 
. 
UNAUTHENTICATED &
]& '
=( )
$str* Z
,Z [
[ 	
ErrorI18NKeys	 
. 
PERMISSION_DENIED (
]( )
=* +
$str, `
,` a
[ 	
ErrorI18NKeys	 
. 
PRECONDITION_FAILED *
]* +
=, -
$str. `
,` a
[ 	
ErrorI18NKeys	 
. 
CONFLICT 
]  
=! "
$str# `
,` a
[ 	
ErrorI18NKeys	 
. 
RESOURCE_EXHAUSTED )
]) *
=+ ,
$str- Y
,Y Z
[ 	
ErrorI18NKeys	 
. 
SERVICE_UNAVAILABLE *
]* +
=, -
$str. c
,c d
[ 	
ErrorI18NKeys	 
. "
DEPENDENCY_UNAVAILABLE -
]- .
=/ 0
$str1 d
,d e
[ 	
ErrorI18NKeys	 
. 
DEADLINE_EXCEEDED (
]( )
=* +
$str, R
,R S
[ 	
ErrorI18NKeys	 
. 
	CANCELLED  
]  !
=" #
$str$ <
,< =
[ 	
ErrorI18NKeys	 
. 
INTERNAL 
]  
=! "
$str# R
,R S
[ 	
ErrorI18NKeys	 
.  
DATABASE_UNAVAILABLE +
]+ ,
=- .
$str/ ]
,] ^
[ 	
LocalizationKeys	 
. 
Authentication (
.( )
Error) .
.. /
NAVIGATION_FAILURE/ A
]A B
=C D
$strE h
,h i
[ 	
LocalizationKeys	 
. 
Authentication (
.( )
Error) .
.. /*
MEMBERSHIP_IDENTIFIER_REQUIRED/ M
]M N
=O P
$str /
,/ 0
[ 	
LocalizationKeys	 
. 
Authentication (
.( )
Error) .
.. /
SESSION_EXPIRED/ >
]> ?
=@ A
$str   T
,  T U
[!! 	
LocalizationKeys!!	 
.!! 
Authentication!! (
.!!( )
Error!!) .
.!!. /#
REGISTRATION_INCOMPLETE!!/ F
]!!F G
=!!H I
$str"" W
,""W X
[## 	
LocalizationKeys##	 
.## 
Common##  
.##  !
SERVER_UNAVAILABLE##! 3
]##3 4
=##5 6
$str##7 q
,##q r
[$$ 	
LocalizationKeys$$	 
.$$ 
Authentication$$ (
.$$( )
SignUp$$) /
.$$/ 0
MobileVerification$$0 B
.$$B C
TITLE$$C H
]$$H I
=$$J K
$str$$L \
,$$\ ]
[%% 	
LocalizationKeys%%	 
.%% 
Authentication%% (
.%%( )
SignUp%%) /
.%%/ 0
MobileVerification%%0 B
.%%B C
DESCRIPTION%%C N
]%%N O
=%%P Q
$str&& F
,&&F G
['' 	
LocalizationKeys''	 
.'' 
Authentication'' (
.''( )
SignUp'') /
.''/ 0
MobileVerification''0 B
.''B C
HINT''C G
]''G H
=''I J
$str''K a
,''a b
[(( 	
LocalizationKeys((	 
.(( 
Authentication(( (
.((( )
SignUp(() /
.((/ 0
MobileVerification((0 B
.((B C
	WATERMARK((C L
]((L M
=((N O
$str((P _
,((_ `
[)) 	
LocalizationKeys))	 
.)) 
Authentication)) (
.))( )
SignUp))) /
.))/ 0
MobileVerification))0 B
.))B C
BUTTON))C I
]))I J
=))K L
$str))M W
,))W X
[** 	
LocalizationKeys**	 
.** 
Authentication** (
.**( )
SecureKeyRecovery**) :
.**: ;
MobileVerification**; M
.**M N
TITLE**N S
]**S T
=**U V
$str**W i
,**i j
[++ 	
LocalizationKeys++	 
.++ 
Authentication++ (
.++( )
SecureKeyRecovery++) :
.++: ;
MobileVerification++; M
.++M N
DESCRIPTION++N Y
]++Y Z
=++[ \
$str,, F
,,,F G
[-- 	
LocalizationKeys--	 
.-- 
Authentication-- (
.--( )
SecureKeyRecovery--) :
.--: ;
MobileVerification--; M
.--M N
HINT--N R
]--R S
=--T U
$str--V l
,--l m
[.. 	
LocalizationKeys..	 
... 
Authentication.. (
...( )
SecureKeyRecovery..) :
...: ;
MobileVerification..; M
...M N
	WATERMARK..N W
]..W X
=..Y Z
$str..[ j
,..j k
[// 	
LocalizationKeys//	 
.// 
Authentication// (
.//( )
SecureKeyRecovery//) :
.//: ;
MobileVerification//; M
.//M N
BUTTON//N T
]//T U
=//V W
$str//X b
,//b c
[00 	
LocalizationKeys00	 
.00 
Authentication00 (
.00( )
SignUp00) /
.00/ 0!
VerificationCodeEntry000 E
.00E F
TITLE00F K
]00K L
=00M N
$str00O c
,00c d
[11 	
LocalizationKeys11	 
.11 
Authentication11 (
.11( )
SignUp11) /
.11/ 0!
VerificationCodeEntry110 E
.11E F
DESCRIPTION11F Q
]11Q R
=11S T
$str22 1
,221 2
[33 	
LocalizationKeys33	 
.33 
Authentication33 (
.33( )
SignUp33) /
.33/ 0!
VerificationCodeEntry330 E
.33E F
HINT33F J
]33J K
=33L M
$str33N a
,33a b
[44 	
LocalizationKeys44	 
.44 
Authentication44 (
.44( )
SignUp44) /
.44/ 0!
VerificationCodeEntry440 E
.44E F
ERROR_INVALID_CODE44F X
]44X Y
=44Z [
$str55 -
,55- .
[66 	
LocalizationKeys66	 
.66 
Authentication66 (
.66( )
SignUp66) /
.66/ 0!
VerificationCodeEntry660 E
.66E F
BUTTON_VERIFY66F S
]66S T
=66U V
$str66W _
,66_ `
[77 	
LocalizationKeys77	 
.77 
Authentication77 (
.77( )
SignUp77) /
.77/ 0!
VerificationCodeEntry770 E
.77E F
BUTTON_RESEND77F S
]77S T
=77U V
$str77W d
,77d e
[88 	
LocalizationKeys88	 
.88 
Authentication88 (
.88( )
SignUp88) /
.88/ 0
NicknameInput880 =
.88= >
TITLE88> C
]88C D
=88E F
$str88G Z
,88Z [
[99 	
LocalizationKeys99	 
.99 
Authentication99 (
.99( )
SignUp99) /
.99/ 0
NicknameInput990 =
.99= >
DESCRIPTION99> I
]99I J
=99K L
$str99M s
,99s t
[:: 	
LocalizationKeys::	 
.:: 
Authentication:: (
.::( )
SignUp::) /
.::/ 0
NicknameInput::0 =
.::= >
HINT::> B
]::B C
=::D E
$str::F U
,::U V
[;; 	
LocalizationKeys;;	 
.;; 
Authentication;; (
.;;( )
SignUp;;) /
.;;/ 0
NicknameInput;;0 =
.;;= >
	WATERMARK;;> G
];;G H
=;;I J
$str;;K U
,;;U V
[<< 	
LocalizationKeys<<	 
.<< 
Authentication<< (
.<<( )
SignUp<<) /
.<</ 0
NicknameInput<<0 =
.<<= >
BUTTON<<> D
]<<D E
=<<F G
$str<<H Q
,<<Q R
[== 	
LocalizationKeys==	 
.== 
Authentication== (
.==( )
SignUp==) /
.==/ 0!
SecureKeyConfirmation==0 E
.==E F
TITLE==F K
]==K L
===M N
$str==O _
,==_ `
[>> 	
LocalizationKeys>>	 
.>> 
Authentication>> (
.>>( )
SignUp>>) /
.>>/ 0!
SecureKeyConfirmation>>0 E
.>>E F
DESCRIPTION>>F Q
]>>Q R
=>>S T
$str?? ;
,??; <
[@@ 	
LocalizationKeys@@	 
.@@ 
Authentication@@ (
.@@( )
SignUp@@) /
.@@/ 0!
SecureKeyConfirmation@@0 E
.@@E F"
SECURE_KEY_PLACEHOLDER@@F \
]@@\ ]
=@@^ _
$str@@` l
,@@l m
[AA 	
LocalizationKeysAA	 
.AA 
AuthenticationAA (
.AA( )
SignUpAA) /
.AA/ 0!
SecureKeyConfirmationAA0 E
.AAE F
SECURE_KEY_HINTAAF U
]AAU V
=AAW X
$strBB +
,BB+ ,
[CC 	
LocalizationKeysCC	 
.CC 
AuthenticationCC (
.CC( )
SignUpCC) /
.CC/ 0!
SecureKeyConfirmationCC0 E
.CCE F)
VERIFY_SECURE_KEY_PLACEHOLDERCCF c
]CCc d
=CCe f
$strDD  
,DD  !
[EE 	
LocalizationKeysEE	 
.EE 
AuthenticationEE (
.EE( )
SignUpEE) /
.EE/ 0!
SecureKeyConfirmationEE0 E
.EEE F"
VERIFY_SECURE_KEY_HINTEEF \
]EE\ ]
=EE^ _
$strFF 0
,FF0 1
[GG 	
LocalizationKeysGG	 
.GG 
AuthenticationGG (
.GG( )
SignUpGG) /
.GG/ 0!
SecureKeyConfirmationGG0 E
.GGE F%
ERROR_SECURE_KEY_MISMATCHGGF _
]GG_ `
=GGa b
$strHH '
,HH' (
[II 	
LocalizationKeysII	 
.II 
AuthenticationII (
.II( )
SignUpII) /
.II/ 0!
SecureKeyConfirmationII0 E
.IIE F
BUTTONIIF L
]IIL M
=IIN O
$strIIP `
,II` a
[JJ 	
LocalizationKeysJJ	 
.JJ 
AuthenticationJJ (
.JJ( )
SecureKeyRecoveryJJ) :
.JJ: ;
ResetJJ; @
.JJ@ A
TITLEJJA F
]JJF G
=JJH I
$strJJJ \
,JJ\ ]
[KK 	
LocalizationKeysKK	 
.KK 
AuthenticationKK (
.KK( )
SecureKeyRecoveryKK) :
.KK: ;
ResetKK; @
.KK@ A
DESCRIPTIONKKA L
]KKL M
=KKN O
$strLL 7
,LL7 8
[MM 	
LocalizationKeysMM	 
.MM 
AuthenticationMM (
.MM( )
SecureKeyRecoveryMM) :
.MM: ;
ResetMM; @
.MM@ A&
NEW_SECURE_KEY_PLACEHOLDERMMA [
]MM[ \
=MM] ^
$strMM_ o
,MMo p
[NN 	
LocalizationKeysNN	 
.NN 
AuthenticationNN (
.NN( )
SecureKeyRecoveryNN) :
.NN: ;
ResetNN; @
.NN@ A
NEW_SECURE_KEY_HINTNNA T
]NNT U
=NNV W
$strOO +
,OO+ ,
[PP 	
LocalizationKeysPP	 
.PP 
AuthenticationPP (
.PP( )
SecureKeyRecoveryPP) :
.PP: ;
ResetPP; @
.PP@ A*
CONFIRM_SECURE_KEY_PLACEHOLDERPPA _
]PP_ `
=PPa b
$strQQ 
,QQ 
[RR 	
LocalizationKeysRR	 
.RR 
AuthenticationRR (
.RR( )
SecureKeyRecoveryRR) :
.RR: ;
ResetRR; @
.RR@ A#
CONFIRM_SECURE_KEY_HINTRRA X
]RRX Y
=RRZ [
$strSS *
,SS* +
[TT 	
LocalizationKeysTT	 
.TT 
AuthenticationTT (
.TT( )
SecureKeyRecoveryTT) :
.TT: ;
ResetTT; @
.TT@ A
BUTTONTTA G
]TTG H
=TTI J
$strTTK ]
,TT] ^
[UU 	
LocalizationKeysUU	 
.UU 
AuthenticationUU (
.UU( )
SignUpUU) /
.UU/ 0
	PassPhaseUU0 9
.UU9 :
TITLEUU: ?
]UU? @
=UUA B
$strUUC L
,UUL M
[VV 	
LocalizationKeysVV	 
.VV 
AuthenticationVV (
.VV( )
SignUpVV) /
.VV/ 0
	PassPhaseVV0 9
.VV9 :
DESCRIPTIONVV: E
]VVE F
=VVG H
$strVVI o
,VVo p
[WW 	
LocalizationKeysWW	 
.WW 
AuthenticationWW (
.WW( )
SignUpWW) /
.WW/ 0
	PassPhaseWW0 9
.WW9 :
HINTWW: >
]WW> ?
=WW@ A
$strWWB L
,WWL M
[XX 	
LocalizationKeysXX	 
.XX 
AuthenticationXX (
.XX( )
SignUpXX) /
.XX/ 0
	PassPhaseXX0 9
.XX9 :
	WATERMARKXX: C
]XXC D
=XXE F
$strXXG M
,XXM N
[YY 	
LocalizationKeysYY	 
.YY 
AuthenticationYY (
.YY( )
SignUpYY) /
.YY/ 0
	PassPhaseYY0 9
.YY9 :
BUTTONYY: @
]YY@ A
=YYB C
$strYYD Q
,YYQ R
[ZZ 	
LocalizationKeysZZ	 
.ZZ 
AuthenticationZZ (
.ZZ( )
SignInZZ) /
.ZZ/ 0
TITLEZZ0 5
]ZZ5 6
=ZZ7 8
$strZZ9 B
,ZZB C
[[[ 	
LocalizationKeys[[	 
.[[ 
Authentication[[ (
.[[( )
SignIn[[) /
.[[/ 0
WELCOME[[0 7
][[7 8
=[[9 :
$str\\ V
,\\V W
[]] 	
LocalizationKeys]]	 
.]] 
Authentication]] (
.]]( )
SignIn]]) /
.]]/ 0
MOBILE_PLACEHOLDER]]0 B
]]]B C
=]]D E
$str]]F U
,]]U V
[^^ 	
LocalizationKeys^^	 
.^^ 
Authentication^^ (
.^^( )
SignIn^^) /
.^^/ 0
MOBILE_HINT^^0 ;
]^^; <
=^^= >
$str^^? `
,^^` a
[__ 	
LocalizationKeys__	 
.__ 
Authentication__ (
.__( )
SignIn__) /
.__/ 0"
SECURE_KEY_PLACEHOLDER__0 F
]__F G
=__H I
$str__J V
,__V W
[`` 	
LocalizationKeys``	 
.`` 
Authentication`` (
.``( )
SignIn``) /
.``/ 0
SECURE_KEY_HINT``0 ?
]``? @
=``A B
$str``C _
,``_ `
[aa 	
LocalizationKeysaa	 
.aa 
Authenticationaa (
.aa( )
SignInaa) /
.aa/ 0
ACCOUNT_RECOVERYaa0 @
]aa@ A
=aaB C
$straaD Q
,aaQ R
[bb 	
LocalizationKeysbb	 
.bb 
Authenticationbb (
.bb( )
SignInbb) /
.bb/ 0
CONTINUEbb0 8
]bb8 9
=bb: ;
$strbb< F
,bbF G
[cc 	
LocalizationKeyscc	 
.cc $
MobileVerificationStatuscc 2
.cc2 3
Errorcc3 8
.cc8 9%
MOBILE_ALREADY_REGISTEREDcc9 R
]ccR S
=ccT U
$str	dd ’
,
dd’ “
[ee 	
LocalizationKeysee	 
.ee $
MobileVerificationStatusee 2
.ee2 3&
AVAILABLE_FOR_REGISTRATIONee3 M
]eeM N
=eeO P
$strff ?
,ff? @
[gg 	
LocalizationKeysgg	 
.gg $
MobileVerificationStatusgg 2
.gg2 3,
 INCOMPLETE_REGISTRATION_CONTINUEgg3 S
]ggS T
=ggU V
$strhh A
,hhA B
[ii 	
LocalizationKeysii	 
.ii $
MobileVerificationStatusii 2
.ii2 3 
TAKEN_ACTIVE_ACCOUNTii3 G
]iiG H
=iiI J
$strjj f
,jjf g
[kk 	
LocalizationKeyskk	 
.kk $
MobileVerificationStatuskk 2
.kk2 3"
TAKEN_INACTIVE_ACCOUNTkk3 I
]kkI J
=kkK L
$strll m
,llm n
[mm 	
LocalizationKeysmm	 
.mm $
MobileVerificationStatusmm 2
.mm2 3+
DATA_CORRUPTION_CONTACT_SUPPORTmm3 R
]mmR S
=mmT U
$strnn ]
,nn] ^
[oo 	
LocalizationKeysoo	 
.oo $
MobileVerificationStatusoo 2
.oo2 3$
AVAILABLE_ON_THIS_DEVICEoo3 K
]ooK L
=ooM N
$strpp N
,ppN O
[qq 	
LocalizationKeysqq	 
.qq 
Verificationqq &
.qq& '
Errorqq' ,
.qq, -
INVALID_OTP_CODEqq- =
]qq= >
=qq? @
$strqqA \
,qq\ ]
[rr 	
LocalizationKeysrr	 
.rr 
Registrationrr &
.rr& '
Errorrr' ,
.rr, -
FAILEDrr- 3
]rr3 4
=rr5 6
$strrr7 L
,rrL M
[ss 	
LocalizationKeysss	 
.ss 
Verificationss &
.ss& '
Errorss' ,
.ss, -

NO_SESSIONss- 7
]ss7 8
=ss9 :
$strss; [
,ss[ \
[tt 	
LocalizationKeystt	 
.tt 
Verificationtt &
.tt& '
Errortt' ,
.tt, -
SESSION_EXPIREDtt- <
]tt< =
=tt> ?
$strtt@ b
,ttb c
[uu 	
LocalizationKeysuu	 
.uu 
Verificationuu &
.uu& '
Erroruu' ,
.uu, -
NO_ACTIVE_SESSIONuu- >
]uu> ?
=uu@ A
$struuB b
,uub c
[vv 	
LocalizationKeysvv	 
.vv 
Verificationvv &
.vv& '
Errorvv' ,
.vv, - 
MAX_ATTEMPTS_REACHEDvv- A
]vvA B
=vvC D
$strvvE l
,vvl m
[ww 	
LocalizationKeysww	 
.ww 
Verificationww &
.ww& '
Errorww' ,
.ww, -
VERIFICATION_FAILEDww- @
]ww@ A
=wwB C
$strwwD Y
,wwY Z
[xx 	
LocalizationKeysxx	 
.xx 
Verificationxx &
.xx& '
Errorxx' ,
.xx, -
SESSION_NOT_FOUNDxx- >
]xx> ?
=xx@ A
$strxxB b
,xxb c
[yy 	
LocalizationKeysyy	 
.yy 
Verificationyy &
.yy& '
Erroryy' ,
.yy, -&
GLOBAL_RATE_LIMIT_EXCEEDEDyy- G
]yyG H
=yyI J
$strzz 7
,zz7 8
[{{ 	
LocalizationKeys{{	 
.{{ 
Verification{{ &
.{{& '
Info{{' +
.{{+ ,
REDIRECTING{{, 7
]{{7 8
={{9 :
$str{{; K
,{{K L
[|| 	
LocalizationKeys||	 
.|| 
Verification|| &
.||& '
Info||' +
.||+ ,"
REDIRECTING_IN_SECONDS||, B
]||B C
=||D E
$str||F e
,||e f
[}} 	
LocalizationKeys}}	 
.}} 
ValidationErrors}} *
.}}* +
MobileNumber}}+ 7
.}}7 8(
MUST_START_WITH_COUNTRY_CODE}}8 T
]}}T U
=}}V W
$str}}X k
,}}k l
[~~ 	
LocalizationKeys~~	 
.~~ 
ValidationErrors~~ *
.~~* +
MobileNumber~~+ 7
.~~7 8
CONTAINS_NON_DIGITS~~8 K
]~~K L
=~~M N
$str~~O g
,~~g h
[ 	
LocalizationKeys	 
. 
ValidationErrors *
.* +
MobileNumber+ 7
.7 8
INCORRECT_LENGTH8 H
]H I
=J K
$strL e
,e f
[
€€ 	
LocalizationKeys
€€	 
.
€€ 
ValidationErrors
€€ *
.
€€* +
MobileNumber
€€+ 7
.
€€7 8
CANNOT_BE_EMPTY
€€8 G
]
€€G H
=
€€I J
$str
€€K U
,
€€U V
[
 	
LocalizationKeys
	 
.
 
ResponseErrors
 (
.
( )
MobileNumber
) 5
.
5 6(
ACCOUNT_ALREADY_REGISTERED
6 P
]
P Q
=
R S
$str
‚‚ ^
,
‚‚^ _
[
ƒƒ 	
LocalizationKeys
ƒƒ	 
.
ƒƒ 
ResponseErrors
ƒƒ (
.
ƒƒ( )
MobileNumber
ƒƒ) 5
.
ƒƒ5 6*
UNEXPECTED_MEMBERSHIP_STATUS
ƒƒ6 R
]
ƒƒR S
=
ƒƒT U
$str
„„ =
,
„„= >
[
…… 	
LocalizationKeys
……	 
.
…… 
ResponseErrors
…… (
.
……( )
General
……) 0
.
……0 1
TIMEOUT_EXCEEDED
……1 A
]
……A B
=
……C D
$str
……E q
,
……q r
[
†† 	
LocalizationKeys
††	 
.
†† 
ValidationErrors
†† *
.
††* +
MobileNumber
††+ 7
.
††7 8
REQUIRED
††8 @
]
††@ A
=
††B C
$str
††D _
,
††_ `
[
‡‡ 	
LocalizationKeys
‡‡	 
.
‡‡ 
ValidationErrors
‡‡ *
.
‡‡* +$
MobileNumberIdentifier
‡‡+ A
.
‡‡A B
REQUIRED
‡‡B J
]
‡‡J K
=
‡‡L M
$str
ˆˆ 2
,
ˆˆ2 3
[
‰‰ 	
LocalizationKeys
‰‰	 
.
‰‰ 
ValidationErrors
‰‰ *
.
‰‰* +
DeviceIdentifier
‰‰+ ;
.
‰‰; <
REQUIRED
‰‰< D
]
‰‰D E
=
‰‰F G
$str
‰‰H g
,
‰‰g h
[
ŠŠ 	
LocalizationKeys
ŠŠ	 
.
ŠŠ 
ValidationErrors
ŠŠ *
.
ŠŠ* +
SessionIdentifier
ŠŠ+ <
.
ŠŠ< =
REQUIRED
ŠŠ= E
]
ŠŠE F
=
ŠŠG H
$str
ŠŠI i
,
ŠŠi j
[
‹‹ 	
LocalizationKeys
‹‹	 
.
‹‹ 
ValidationErrors
‹‹ *
.
‹‹* +"
MembershipIdentifier
‹‹+ ?
.
‹‹? @
REQUIRED
‹‹@ H
]
‹‹H I
=
‹‹J K
$str
‹‹L o
,
‹‹o p
[
ŒŒ 	
LocalizationKeys
ŒŒ	 
.
ŒŒ 
ValidationErrors
ŒŒ *
.
ŒŒ* +
	SecureKey
ŒŒ+ 4
.
ŒŒ4 5
REQUIRED
ŒŒ5 =
]
ŒŒ= >
=
ŒŒ? @
$str
ŒŒA K
,
ŒŒK L
[
 	
LocalizationKeys
	 
.
 
ValidationErrors
 *
.
* +
	SecureKey
+ 4
.
4 5

MIN_LENGTH
5 ?
]
? @
=
A B
$str
C W
,
W X
[
ŽŽ 	
LocalizationKeys
ŽŽ	 
.
ŽŽ 
ValidationErrors
ŽŽ *
.
ŽŽ* +
	SecureKey
ŽŽ+ 4
.
ŽŽ4 5

MAX_LENGTH
ŽŽ5 ?
]
ŽŽ? @
=
ŽŽA B
$str
ŽŽC W
,
ŽŽW X
[
 	
LocalizationKeys
	 
.
 
ValidationErrors
 *
.
* +
	SecureKey
+ 4
.
4 5
	NO_SPACES
5 >
]
> ?
=
@ A
$str
B U
,
U V
[
 	
LocalizationKeys
	 
.
 
ValidationErrors
 *
.
* +
	SecureKey
+ 4
.
4 5
NO_UPPERCASE
5 A
]
A B
=
C D
$str
E c
,
c d
[
‘‘ 	
LocalizationKeys
‘‘	 
.
‘‘ 
ValidationErrors
‘‘ *
.
‘‘* +
	SecureKey
‘‘+ 4
.
‘‘4 5
NO_LOWERCASE
‘‘5 A
]
‘‘A B
=
‘‘C D
$str
‘‘E b
,
‘‘b c
[
’’ 	
LocalizationKeys
’’	 
.
’’ 
ValidationErrors
’’ *
.
’’* +
	SecureKey
’’+ 4
.
’’4 5
NO_DIGIT
’’5 =
]
’’= >
=
’’? @
$str
’’A S
,
’’S T
[
““ 	
LocalizationKeys
““	 
.
““ 
ValidationErrors
““ *
.
““* +
	SecureKey
““+ 4
.
““4 5

TOO_SIMPLE
““5 ?
]
““? @
=
““A B
$str
““C \
,
““\ ]
[
”” 	
LocalizationKeys
””	 
.
”” 
ValidationErrors
”” *
.
””* +
	SecureKey
””+ 4
.
””4 5

TOO_COMMON
””5 ?
]
””? @
=
””A B
$str
””C O
,
””O P
[
•• 	
LocalizationKeys
••	 
.
•• 
ValidationErrors
•• *
.
••* +
	SecureKey
••+ 4
.
••4 5 
SEQUENTIAL_PATTERN
••5 G
]
••G H
=
••I J
$str
••K j
,
••j k
[
–– 	
LocalizationKeys
––	 
.
–– 
ValidationErrors
–– *
.
––* +
	SecureKey
––+ 4
.
––4 5
REPEATED_CHARS
––5 C
]
––C D
=
––E F
$str
––G d
,
––d e
[
—— 	
LocalizationKeys
——	 
.
—— 
ValidationErrors
—— *
.
——* +
	SecureKey
——+ 4
.
——4 5
LACKS_DIVERSITY
——5 D
]
——D E
=
——F G
$str
——H s
,
——s t
[
˜˜ 	
LocalizationKeys
˜˜	 
.
˜˜ 
ValidationErrors
˜˜ *
.
˜˜* +
	SecureKey
˜˜+ 4
.
˜˜4 5
CONTAINS_APP_NAME
˜˜5 F
]
˜˜F G
=
˜˜H I
$str
˜˜J c
,
˜˜c d
[
™™ 	
LocalizationKeys
™™	 
.
™™ 
ValidationErrors
™™ *
.
™™* +
	SecureKey
™™+ 4
.
™™4 5!
INVALID_CREDENTIALS
™™5 H
]
™™H I
=
™™J K
$str
™™L a
,
™™a b
[
šš 	
LocalizationKeys
šš	 
.
šš 
ValidationErrors
šš *
.
šš* +
	SecureKey
šš+ 4
.
šš4 5!
NON_ENGLISH_LETTERS
šš5 H
]
ššH I
=
ššJ K
$str
ššL `
,
šš` a
[
›› 	
LocalizationKeys
››	 
.
›› 
ValidationErrors
›› *
.
››* +
	SecureKey
››+ 4
.
››4 5
NO_SPECIAL_CHAR
››5 D
]
››D E
=
››F G
$str
››H f
,
››f g
[
œœ 	
LocalizationKeys
œœ	 
.
œœ 
ValidationErrors
œœ *
.
œœ* +
VerifySecureKey
œœ+ :
.
œœ: ;
DOES_NOT_MATCH
œœ; I
]
œœI J
=
œœK L
$str
œœM g
,
œœg h
[
 	
LocalizationKeys
	 
.
 
ValidationErrors
 *
.
* +
Strength
+ 3
.
3 4
INVALID
4 ;
]
; <
=
= >
$str
? H
,
H I
[
žž 	
LocalizationKeys
žž	 
.
žž 
ValidationErrors
žž *
.
žž* +
Strength
žž+ 3
.
žž3 4
	VERY_WEAK
žž4 =
]
žž= >
=
žž? @
$str
žžA L
,
žžL M
[
ŸŸ 	
LocalizationKeys
ŸŸ	 
.
ŸŸ 
ValidationErrors
ŸŸ *
.
ŸŸ* +
Strength
ŸŸ+ 3
.
ŸŸ3 4
WEAK
ŸŸ4 8
]
ŸŸ8 9
=
ŸŸ: ;
$str
ŸŸ< B
,
ŸŸB C
[
   	
LocalizationKeys
  	 
.
   
ValidationErrors
   *
.
  * +
Strength
  + 3
.
  3 4
GOOD
  4 8
]
  8 9
=
  : ;
$str
  < B
,
  B C
[
¡¡ 	
LocalizationKeys
¡¡	 
.
¡¡ 
ValidationErrors
¡¡ *
.
¡¡* +
Strength
¡¡+ 3
.
¡¡3 4
STRONG
¡¡4 :
]
¡¡: ;
=
¡¡< =
$str
¡¡> F
,
¡¡F G
[
¢¢ 	
LocalizationKeys
¢¢	 
.
¢¢ 
ValidationErrors
¢¢ *
.
¢¢* +
Strength
¢¢+ 3
.
¢¢3 4
VERY_STRONG
¢¢4 ?
]
¢¢? @
=
¢¢A B
$str
¢¢C P
,
¢¢P Q
[
££ 	
LocalizationKeys
££	 
.
££  
ValidationWarnings
££ ,
.
££, -
	SecureKey
££- 6
.
££6 7
NON_LATIN_LETTER
££7 G
]
££G H
=
££I J
$str
££K _
,
££_ `
[
¤¤ 	
LocalizationKeys
¤¤	 
.
¤¤  
ValidationWarnings
¤¤ ,
.
¤¤, -
	SecureKey
¤¤- 6
.
¤¤6 7
INVALID_CHARACTER
¤¤7 H
]
¤¤H I
=
¤¤J K
$str
¤¤L d
,
¤¤d e
[
¥¥ 	
LocalizationKeys
¥¥	 
.
¥¥  
ValidationWarnings
¥¥ ,
.
¥¥, -
	SecureKey
¥¥- 6
.
¥¥6 7!
MULTIPLE_CHARACTERS
¥¥7 J
]
¥¥J K
=
¥¥L M
$str
¦¦ 2
,
¦¦2 3
[
§§ 	
LocalizationKeys
§§	 
.
§§ 
Welcome
§§ !
.
§§! "
SIGN_IN_BUTTON
§§" 0
]
§§0 1
=
§§2 3
$str
§§4 =
,
§§= >
[
¨¨ 	
LocalizationKeys
¨¨	 
.
¨¨ 
Welcome
¨¨ !
.
¨¨! "#
CREATE_ACCOUNT_BUTTON
¨¨" 7
]
¨¨7 8
=
¨¨9 :
$str
¨¨; K
,
¨¨K L
[
©© 	
LocalizationKeys
©©	 
.
©© 
Footer
©©  
.
©©  !
PRIVACY_POLICY
©©! /
]
©©/ 0
=
©©1 2
$str
©©3 C
,
©©C D
[
ªª 	
LocalizationKeys
ªª	 
.
ªª 
Footer
ªª  
.
ªª  !
TERMS_OF_SERVICE
ªª! 1
]
ªª1 2
=
ªª3 4
$str
ªª5 G
,
ªªG H
[
«« 	
LocalizationKeys
««	 
.
«« 
Footer
««  
.
««  !
SUPPORT
««! (
]
««( )
=
««* +
$str
««, 5
,
««5 6
[
¬¬ 	
LocalizationKeys
¬¬	 
.
¬¬ 
Footer
¬¬  
.
¬¬  !
AGREEMENT_TEXT
¬¬! /
]
¬¬/ 0
=
¬¬1 2
$str
¬¬3 n
,
¬¬n o
[
­­ 	
LocalizationKeys
­­	 
.
­­ 
Footer
­­  
.
­­  !
	COPYRIGHT
­­! *
]
­­* +
=
­­, -
$str
­­. ]
,
­­] ^
[
®® 	
LocalizationKeys
®®	 
.
®® 

Navigation
®® $
.
®®$ %
BACK
®®% )
]
®®) *
=
®®+ ,
$str
®®- 3
,
®®3 4
[
¯¯ 	
LocalizationKeys
¯¯	 
.
¯¯ 

Navigation
¯¯ $
.
¯¯$ %
CLOSE
¯¯% *
]
¯¯* +
=
¯¯, -
$str
¯¯. 5
,
¯¯5 6
[
°° 	
LocalizationKeys
°°	 
.
°° 

Navigation
°° $
.
°°$ %
MINIMIZE
°°% -
]
°°- .
=
°°/ 0
$str
°°1 ;
,
°°; <
[
±± 	
LocalizationKeys
±±	 
.
±± 

Navigation
±± $
.
±±$ %
MAXIMIZE
±±% -
]
±±- .
=
±±/ 0
$str
±±1 ;
,
±±; <
[
²² 	
LocalizationKeys
²²	 
.
²² 
Common
²²  
.
²²  !
LOADING
²²! (
]
²²( )
=
²²* +
$str
²², 8
,
²²8 9
[
³³ 	
LocalizationKeys
³³	 
.
³³ 
Common
³³  
.
³³  !
ERROR
³³! &
]
³³& '
=
³³( )
$str
³³* 1
,
³³1 2
[
´´ 	
LocalizationKeys
´´	 
.
´´ 
Common
´´  
.
´´  !
SUCCESS
´´! (
]
´´( )
=
´´* +
$str
´´, 5
,
´´5 6
[
µµ 	
LocalizationKeys
µµ	 
.
µµ 
Common
µµ  
.
µµ  !
CANCEL
µµ! '
]
µµ' (
=
µµ) *
$str
µµ+ 3
,
µµ3 4
[
¶¶ 	
LocalizationKeys
¶¶	 
.
¶¶ 
Common
¶¶  
.
¶¶  !
UNEXPECTED_ERROR
¶¶! 1
]
¶¶1 2
=
¶¶3 4
$str
¶¶5 S
,
¶¶S T
[
·· 	
LocalizationKeys
··	 
.
·· 
Common
··  
.
··  !
OK
··! #
]
··# $
=
··% &
$str
··' +
,
··+ ,
[
¸¸ 	
LocalizationKeys
¸¸	 
.
¸¸ 
Common
¸¸  
.
¸¸  !$
NO_INTERNET_CONNECTION
¸¸! 7
]
¸¸7 8
=
¸¸9 :
$str
¸¸; S
,
¸¸S T
[
¹¹ 	
LocalizationKeys
¹¹	 
.
¹¹ 
Common
¹¹  
.
¹¹  !
CHECK_CONNECTION
¹¹! 1
]
¹¹1 2
=
¹¹3 4
$str
¹¹5 U
,
¹¹U V
[
ºº 	
LocalizationKeys
ºº	 
.
ºº !
NetworkNotification
ºº -
.
ºº- .

NoInternet
ºº. 8
.
ºº8 9
TITLE
ºº9 >
]
ºº> ?
=
ºº@ A
$str
ººB Z
,
ººZ [
[
»» 	
LocalizationKeys
»»	 
.
»» !
NetworkNotification
»» -
.
»»- .

NoInternet
»». 8
.
»»8 9
DESCRIPTION
»»9 D
]
»»D E
=
»»F G
$str
»»H m
,
»»m n
[
¼¼ 	
LocalizationKeys
¼¼	 
.
¼¼ !
NetworkNotification
¼¼ -
.
¼¼- .
CheckingInternet
¼¼. >
.
¼¼> ?
TITLE
¼¼? D
]
¼¼D E
=
¼¼F G
$str
¼¼H ]
,
¼¼] ^
[
½½ 	
LocalizationKeys
½½	 
.
½½ !
NetworkNotification
½½ -
.
½½- .
CheckingInternet
½½. >
.
½½> ?
DESCRIPTION
½½? J
]
½½J K
=
½½L M
$str
½½N o
,
½½o p
[
¾¾ 	
LocalizationKeys
¾¾	 
.
¾¾ !
NetworkNotification
¾¾ -
.
¾¾- .
InternetRestored
¾¾. >
.
¾¾> ?
TITLE
¾¾? D
]
¾¾D E
=
¾¾F G
$str
¾¾H ]
,
¾¾] ^
[
¿¿ 	
LocalizationKeys
¿¿	 
.
¿¿ !
NetworkNotification
¿¿ -
.
¿¿- .
InternetRestored
¿¿. >
.
¿¿> ?
DESCRIPTION
¿¿? J
]
¿¿J K
=
¿¿L M
$str
¿¿N k
,
¿¿k l
[
ÀÀ 	
LocalizationKeys
ÀÀ	 
.
ÀÀ !
NetworkNotification
ÀÀ -
.
ÀÀ- .

Connecting
ÀÀ. 8
.
ÀÀ8 9
TITLE
ÀÀ9 >
]
ÀÀ> ?
=
ÀÀ@ A
$str
ÀÀB N
,
ÀÀN O
[
ÁÁ 	
LocalizationKeys
ÁÁ	 
.
ÁÁ !
NetworkNotification
ÁÁ -
.
ÁÁ- .

Connecting
ÁÁ. 8
.
ÁÁ8 9
DESCRIPTION
ÁÁ9 D
]
ÁÁD E
=
ÁÁF G
$str
ÁÁH k
,
ÁÁk l
[
ÂÂ 	
LocalizationKeys
ÂÂ	 
.
ÂÂ !
NetworkNotification
ÂÂ -
.
ÂÂ- .
Reconnecting
ÂÂ. :
.
ÂÂ: ;
TITLE
ÂÂ; @
]
ÂÂ@ A
=
ÂÂB C
$str
ÂÂD R
,
ÂÂR S
[
ÃÃ 	
LocalizationKeys
ÃÃ	 
.
ÃÃ !
NetworkNotification
ÃÃ -
.
ÃÃ- .
Reconnecting
ÃÃ. :
.
ÃÃ: ;
DESCRIPTION
ÃÃ; F
]
ÃÃF G
=
ÃÃH I
$str
ÃÃJ m
,
ÃÃm n
[
ÄÄ 	
LocalizationKeys
ÄÄ	 
.
ÄÄ !
NetworkNotification
ÄÄ -
.
ÄÄ- .!
ServerNotResponding
ÄÄ. A
.
ÄÄA B
TITLE
ÄÄB G
]
ÄÄG H
=
ÄÄI J
$str
ÄÄK _
,
ÄÄ_ `
[
ÅÅ 	
LocalizationKeys
ÅÅ	 
.
ÅÅ !
NetworkNotification
ÅÅ -
.
ÅÅ- .!
ServerNotResponding
ÅÅ. A
.
ÅÅA B
DESCRIPTION
ÅÅB M
]
ÅÅM N
=
ÅÅO P
$str
ÅÅQ q
,
ÅÅq r
[
ÆÆ 	
LocalizationKeys
ÆÆ	 
.
ÆÆ !
NetworkNotification
ÆÆ -
.
ÆÆ- . 
ServerShuttingDown
ÆÆ. @
.
ÆÆ@ A
TITLE
ÆÆA F
]
ÆÆF G
=
ÆÆH I
$str
ÆÆJ ^
,
ÆÆ^ _
[
ÇÇ 	
LocalizationKeys
ÇÇ	 
.
ÇÇ !
NetworkNotification
ÇÇ -
.
ÇÇ- . 
ServerShuttingDown
ÇÇ. @
.
ÇÇ@ A
DESCRIPTION
ÇÇA L
]
ÇÇL M
=
ÇÇN O
$str
ÇÇP i
,
ÇÇi j
[
ÈÈ 	
LocalizationKeys
ÈÈ	 
.
ÈÈ !
NetworkNotification
ÈÈ -
.
ÈÈ- .
RetriesExhausted
ÈÈ. >
.
ÈÈ> ?
TITLE
ÈÈ? D
]
ÈÈD E
=
ÈÈF G
$str
ÈÈH [
,
ÈÈ[ \
[
ÉÉ 	
LocalizationKeys
ÉÉ	 
.
ÉÉ !
NetworkNotification
ÉÉ -
.
ÉÉ- .
RetriesExhausted
ÉÉ. >
.
ÉÉ> ?
DESCRIPTION
ÉÉ? J
]
ÉÉJ K
=
ÉÉL M
$str
ÊÊ 7
,
ÊÊ7 8
[
ËË 	
LocalizationKeys
ËË	 
.
ËË !
NetworkNotification
ËË -
.
ËË- .
ServerReconnected
ËË. ?
.
ËË? @
TITLE
ËË@ E
]
ËËE F
=
ËËG H
$str
ËËI V
,
ËËV W
[
ÌÌ 	
LocalizationKeys
ÌÌ	 
.
ÌÌ !
NetworkNotification
ÌÌ -
.
ÌÌ- .
ServerReconnected
ÌÌ. ?
.
ÌÌ? @
DESCRIPTION
ÌÌ@ K
]
ÌÌK L
=
ÌÌM N
$str
ÌÌO s
,
ÌÌs t
[
ÍÍ 	
LocalizationKeys
ÍÍ	 
.
ÍÍ !
NetworkNotification
ÍÍ -
.
ÍÍ- .
Button
ÍÍ. 4
.
ÍÍ4 5
RETRY
ÍÍ5 :
]
ÍÍ: ;
=
ÍÍ< =
$str
ÍÍ> E
,
ÍÍE F
[
ÎÎ 	
LocalizationKeys
ÎÎ	 
.
ÎÎ 
LanguageDetection
ÎÎ +
.
ÎÎ+ ,
TITLE
ÎÎ, 1
]
ÎÎ1 2
=
ÎÎ3 4
$str
ÎÎ5 J
,
ÎÎJ K
[
ÏÏ 	
LocalizationKeys
ÏÏ	 
.
ÏÏ 
LanguageDetection
ÏÏ +
.
ÏÏ+ ,
PROMPT
ÏÏ, 2
]
ÏÏ2 3
=
ÏÏ4 5
$str
ÏÏ6 F
,
ÏÏF G
[
ÐÐ 	
LocalizationKeys
ÐÐ	 
.
ÐÐ 
LanguageDetection
ÐÐ +
.
ÐÐ+ ,
BUTTON_CONFIRM
ÐÐ, :
]
ÐÐ: ;
=
ÐÐ< =
$str
ÐÐ> O
,
ÐÐO P
[
ÑÑ 	
LocalizationKeys
ÑÑ	 
.
ÑÑ 
LanguageDetection
ÑÑ +
.
ÑÑ+ ,
BUTTON_DECLINE
ÑÑ, :
]
ÑÑ: ;
=
ÑÑ< =
$str
ÑÑ> G
}
ÒÒ 
.
ÒÒ  
ToFrozenDictionary
ÒÒ 
(
ÒÒ 
)
ÒÒ 
;
ÒÒ 
private
ÔÔ 
static
ÔÔ 
readonly
ÔÔ 
FrozenDictionary
ÔÔ ,
<
ÔÔ, -
string
ÔÔ- 3
,
ÔÔ3 4
string
ÔÔ5 ;
>
ÔÔ; <
UkrainianStrings
ÔÔ= M
=
ÔÔN O
new
ÔÔP S

Dictionary
ÔÔT ^
<
ÔÔ^ _
string
ÔÔ_ e
,
ÔÔe f
string
ÔÔg m
>
ÔÔm n
{
ÕÕ 
[
ÖÖ 	
ErrorI18NKeys
ÖÖ	 
.
ÖÖ 

VALIDATION
ÖÖ !
]
ÖÖ! "
=
ÖÖ# $
$str
ÖÖ% `
,
ÖÖ` a
[
×× 	
ErrorI18NKeys
××	 
.
×× 
MAX_ATTEMPTS
×× #
]
××# $
=
××% &
$str
ØØ [
,
ØØ[ \
[
ÙÙ 	
ErrorI18NKeys
ÙÙ	 
.
ÙÙ 
INVALID_MOBILE
ÙÙ %
]
ÙÙ% &
=
ÙÙ' (
$str
ÙÙ) O
,
ÙÙO P
[
ÚÚ 	
ErrorI18NKeys
ÚÚ	 
.
ÚÚ 
OTP_EXPIRED
ÚÚ "
]
ÚÚ" #
=
ÚÚ$ %
$str
ÚÚ& ]
,
ÚÚ] ^
[
ÛÛ 	
ErrorI18NKeys
ÛÛ	 
.
ÛÛ 
	NOT_FOUND
ÛÛ  
]
ÛÛ  !
=
ÛÛ" #
$str
ÛÛ$ C
,
ÛÛC D
[
ÜÜ 	
ErrorI18NKeys
ÜÜ	 
.
ÜÜ 
ALREADY_EXISTS
ÜÜ %
]
ÜÜ% &
=
ÜÜ' (
$str
ÜÜ) B
,
ÜÜB C
[
ÝÝ 	
ErrorI18NKeys
ÝÝ	 
.
ÝÝ 
UNAUTHENTICATED
ÝÝ &
]
ÝÝ& '
=
ÝÝ( )
$str
ÝÝ* U
,
ÝÝU V
[
ÞÞ 	
ErrorI18NKeys
ÞÞ	 
.
ÞÞ 
PERMISSION_DENIED
ÞÞ (
]
ÞÞ( )
=
ÞÞ* +
$str
ÞÞ, L
,
ÞÞL M
[
ßß 	
ErrorI18NKeys
ßß	 
.
ßß !
PRECONDITION_FAILED
ßß *
]
ßß* +
=
ßß, -
$str
ßß. Y
,
ßßY Z
[
àà 	
ErrorI18NKeys
àà	 
.
àà 
CONFLICT
àà 
]
àà  
=
àà! "
$str
àà# a
,
ààa b
[
áá 	
ErrorI18NKeys
áá	 
.
áá  
RESOURCE_EXHAUSTED
áá )
]
áá) *
=
áá+ ,
$str
áá- Q
,
ááQ R
[
ââ 	
ErrorI18NKeys
ââ	 
.
ââ !
SERVICE_UNAVAILABLE
ââ *
]
ââ* +
=
ââ, -
$str
ââ. `
,
ââ` a
[
ãã 	
ErrorI18NKeys
ãã	 
.
ãã $
DEPENDENCY_UNAVAILABLE
ãã -
]
ãã- .
=
ãã/ 0
$str
ãã1 d
,
ããd e
[
ää 	
ErrorI18NKeys
ää	 
.
ää 
DEADLINE_EXCEEDED
ää (
]
ää( )
=
ää* +
$str
ää, `
,
ää` a
[
åå 	
ErrorI18NKeys
åå	 
.
åå 
	CANCELLED
åå  
]
åå  !
=
åå" #
$str
åå$ ;
,
åå; <
[
ææ 	
ErrorI18NKeys
ææ	 
.
ææ 
INTERNAL
ææ 
]
ææ  
=
ææ! "
$str
ææ# H
,
ææH I
[
çç 	
ErrorI18NKeys
çç	 
.
çç "
DATABASE_UNAVAILABLE
çç +
]
çç+ ,
=
çç- .
$str
çç/ a
,
çça b
[
èè 	
LocalizationKeys
èè	 
.
èè 
Common
èè  
.
èè  ! 
SERVER_UNAVAILABLE
èè! 3
]
èè3 4
=
èè5 6
$str
èè7 r
,
èèr s
[
éé 	
LocalizationKeys
éé	 
.
éé 
Authentication
éé (
.
éé( )
Error
éé) .
.
éé. / 
NAVIGATION_FAILURE
éé/ A
]
ééA B
=
ééC D
$str
ééE l
,
éél m
[
êê 	
LocalizationKeys
êê	 
.
êê 
Authentication
êê (
.
êê( )
Error
êê) .
.
êê. /,
MEMBERSHIP_IDENTIFIER_REQUIRED
êê/ M
]
êêM N
=
êêO P
$str
ëë 3
,
ëë3 4
[
ìì 	
LocalizationKeys
ìì	 
.
ìì 
Authentication
ìì (
.
ìì( )
Error
ìì) .
.
ìì. /
SESSION_EXPIRED
ìì/ >
]
ìì> ?
=
ìì@ A
$str
íí N
,
ííN O
[
îî 	
LocalizationKeys
îî	 
.
îî 
Authentication
îî (
.
îî( )
Error
îî) .
.
îî. /%
REGISTRATION_INCOMPLETE
îî/ F
]
îîF G
=
îîH I
$str
ïï S
,
ïïS T
[
ðð 	
LocalizationKeys
ðð	 
.
ðð 
Authentication
ðð (
.
ðð( )
SignUp
ðð) /
.
ðð/ 0 
MobileVerification
ðð0 B
.
ððB C
TITLE
ððC H
]
ððH I
=
ððJ K
$str
ððL ]
,
ðð] ^
[
ññ 	
LocalizationKeys
ññ	 
.
ññ 
Authentication
ññ (
.
ññ( )
SignUp
ññ) /
.
ññ/ 0 
MobileVerification
ññ0 B
.
ññB C
DESCRIPTION
ññC N
]
ññN O
=
ññP Q
$str
òò 8
,
òò8 9
[
óó 	
LocalizationKeys
óó	 
.
óó 
Authentication
óó (
.
óó( )
SignUp
óó) /
.
óó/ 0 
MobileVerification
óó0 B
.
óóB C
HINT
óóC G
]
óóG H
=
óóI J
$str
óóK c
,
óóc d
[
ôô 	
LocalizationKeys
ôô	 
.
ôô 
Authentication
ôô (
.
ôô( )
SignUp
ôô) /
.
ôô/ 0 
MobileVerification
ôô0 B
.
ôôB C
	WATERMARK
ôôC L
]
ôôL M
=
ôôN O
$str
ôôP b
,
ôôb c
[
õõ 	
LocalizationKeys
õõ	 
.
õõ 
Authentication
õõ (
.
õõ( )
SignUp
õõ) /
.
õõ/ 0 
MobileVerification
õõ0 B
.
õõB C
BUTTON
õõC I
]
õõI J
=
õõK L
$str
õõM Y
,
õõY Z
[
öö 	
LocalizationKeys
öö	 
.
öö 
Authentication
öö (
.
öö( )
SecureKeyRecovery
öö) :
.
öö: ; 
MobileVerification
öö; M
.
ööM N
TITLE
ööN S
]
ööS T
=
ööU V
$str
ööW m
,
ööm n
[
÷÷ 	
LocalizationKeys
÷÷	 
.
÷÷ 
Authentication
÷÷ (
.
÷÷( )
SecureKeyRecovery
÷÷) :
.
÷÷: ; 
MobileVerification
÷÷; M
.
÷÷M N
DESCRIPTION
÷÷N Y
]
÷÷Y Z
=
÷÷[ \
$str
øø A
,
øøA B
[
ùù 	
LocalizationKeys
ùù	 
.
ùù 
Authentication
ùù (
.
ùù( )
SecureKeyRecovery
ùù) :
.
ùù: ; 
MobileVerification
ùù; M
.
ùùM N
HINT
ùùN R
]
ùùR S
=
ùùT U
$str
ùùV n
,
ùùn o
[
úú 	
LocalizationKeys
úú	 
.
úú 
Authentication
úú (
.
úú( )
SecureKeyRecovery
úú) :
.
úú: ; 
MobileVerification
úú; M
.
úúM N
	WATERMARK
úúN W
]
úúW X
=
úúY Z
$str
úú[ m
,
úúm n
[
ûû 	
LocalizationKeys
ûû	 
.
ûû 
Authentication
ûû (
.
ûû( )
SecureKeyRecovery
ûû) :
.
ûû: ; 
MobileVerification
ûû; M
.
ûûM N
BUTTON
ûûN T
]
ûûT U
=
ûûV W
$str
ûûX d
,
ûûd e
[
üü 	
LocalizationKeys
üü	 
.
üü 
Authentication
üü (
.
üü( )
SignUp
üü) /
.
üü/ 0#
VerificationCodeEntry
üü0 E
.
üüE F
TITLE
üüF K
]
üüK L
=
üüM N
$str
üüO e
,
üüe f
[
ýý 	
LocalizationKeys
ýý	 
.
ýý 
Authentication
ýý (
.
ýý( )
SignUp
ýý) /
.
ýý/ 0#
VerificationCodeEntry
ýý0 E
.
ýýE F
DESCRIPTION
ýýF Q
]
ýýQ R
=
ýýS T
$str
þþ 7
,
þþ7 8
[
ÿÿ 	
LocalizationKeys
ÿÿ	 
.
ÿÿ 
Authentication
ÿÿ (
.
ÿÿ( )
SignUp
ÿÿ) /
.
ÿÿ/ 0#
VerificationCodeEntry
ÿÿ0 E
.
ÿÿE F
HINT
ÿÿF J
]
ÿÿJ K
=
ÿÿL M
$str
ÿÿN a
,
ÿÿa b
[
€€ 	
LocalizationKeys
€€	 
.
€€ 
Authentication
€€ (
.
€€( )
SignUp
€€) /
.
€€/ 0#
VerificationCodeEntry
€€0 E
.
€€E F 
ERROR_INVALID_CODE
€€F X
]
€€X Y
=
€€Z [
$str
 1
,
1 2
[
‚‚ 	
LocalizationKeys
‚‚	 
.
‚‚ 
Authentication
‚‚ (
.
‚‚( )
SignUp
‚‚) /
.
‚‚/ 0#
VerificationCodeEntry
‚‚0 E
.
‚‚E F
BUTTON_VERIFY
‚‚F S
]
‚‚S T
=
‚‚U V
$str
‚‚W d
,
‚‚d e
[
ƒƒ 	
LocalizationKeys
ƒƒ	 
.
ƒƒ 
Authentication
ƒƒ (
.
ƒƒ( )
SignUp
ƒƒ) /
.
ƒƒ/ 0#
VerificationCodeEntry
ƒƒ0 E
.
ƒƒE F
BUTTON_RESEND
ƒƒF S
]
ƒƒS T
=
ƒƒU V
$str
ƒƒW h
,
ƒƒh i
[
„„ 	
LocalizationKeys
„„	 
.
„„ 
Authentication
„„ (
.
„„( )
SignUp
„„) /
.
„„/ 0
NicknameInput
„„0 =
.
„„= >
TITLE
„„> C
]
„„C D
=
„„E F
$str
„„G X
,
„„X Y
[
…… 	
LocalizationKeys
……	 
.
…… 
Authentication
…… (
.
……( )
SignUp
……) /
.
……/ 0
NicknameInput
……0 =
.
……= >
DESCRIPTION
……> I
]
……I J
=
……K L
$str
……M n
,
……n o
[
†† 	
LocalizationKeys
††	 
.
†† 
Authentication
†† (
.
††( )
SignUp
††) /
.
††/ 0
NicknameInput
††0 =
.
††= >
HINT
††> B
]
††B C
=
††D E
$str
††F S
,
††S T
[
‡‡ 	
LocalizationKeys
‡‡	 
.
‡‡ 
Authentication
‡‡ (
.
‡‡( )
SignUp
‡‡) /
.
‡‡/ 0
NicknameInput
‡‡0 =
.
‡‡= >
	WATERMARK
‡‡> G
]
‡‡G H
=
‡‡I J
$str
‡‡K T
,
‡‡T U
[
ˆˆ 	
LocalizationKeys
ˆˆ	 
.
ˆˆ 
Authentication
ˆˆ (
.
ˆˆ( )
SignUp
ˆˆ) /
.
ˆˆ/ 0
NicknameInput
ˆˆ0 =
.
ˆˆ= >
BUTTON
ˆˆ> D
]
ˆˆD E
=
ˆˆF G
$str
ˆˆH U
,
ˆˆU V
[
‰‰ 	
LocalizationKeys
‰‰	 
.
‰‰ 
Authentication
‰‰ (
.
‰‰( )
SignUp
‰‰) /
.
‰‰/ 0#
SecureKeyConfirmation
‰‰0 E
.
‰‰E F
TITLE
‰‰F K
]
‰‰K L
=
‰‰M N
$str
‰‰O h
,
‰‰h i
[
ŠŠ 	
LocalizationKeys
ŠŠ	 
.
ŠŠ 
Authentication
ŠŠ (
.
ŠŠ( )
SignUp
ŠŠ) /
.
ŠŠ/ 0#
SecureKeyConfirmation
ŠŠ0 E
.
ŠŠE F
DESCRIPTION
ŠŠF Q
]
ŠŠQ R
=
ŠŠS T
$str
‹‹ ?
,
‹‹? @
[
ŒŒ 	
LocalizationKeys
ŒŒ	 
.
ŒŒ 
Authentication
ŒŒ (
.
ŒŒ( )
SignUp
ŒŒ) /
.
ŒŒ/ 0#
SecureKeyConfirmation
ŒŒ0 E
.
ŒŒE F$
SECURE_KEY_PLACEHOLDER
ŒŒF \
]
ŒŒ\ ]
=
ŒŒ^ _
$str
ŒŒ` n
,
ŒŒn o
[
 	
LocalizationKeys
	 
.
 
Authentication
 (
.
( )
SignUp
) /
.
/ 0#
SecureKeyConfirmation
0 E
.
E F
SECURE_KEY_HINT
F U
]
U V
=
W X
$str
ŽŽ 4
,
ŽŽ4 5
[
 	
LocalizationKeys
	 
.
 
Authentication
 (
.
( )
SignUp
) /
.
/ 0#
SecureKeyConfirmation
0 E
.
E F+
VERIFY_SECURE_KEY_PLACEHOLDER
F c
]
c d
=
e f
$str
 
,
 
[
‘‘ 	
LocalizationKeys
‘‘	 
.
‘‘ 
Authentication
‘‘ (
.
‘‘( )
SignUp
‘‘) /
.
‘‘/ 0#
SecureKeyConfirmation
‘‘0 E
.
‘‘E F$
VERIFY_SECURE_KEY_HINT
‘‘F \
]
‘‘\ ]
=
‘‘^ _
$str
’’ 3
,
’’3 4
[
““ 	
LocalizationKeys
““	 
.
““ 
Authentication
““ (
.
““( )
SignUp
““) /
.
““/ 0#
SecureKeyConfirmation
““0 E
.
““E F'
ERROR_SECURE_KEY_MISMATCH
““F _
]
““_ `
=
““a b
$str
”” *
,
””* +
[
•• 	
LocalizationKeys
••	 
.
•• 
Authentication
•• (
.
••( )
SignUp
••) /
.
••/ 0#
SecureKeyConfirmation
••0 E
.
••E F
BUTTON
••F L
]
••L M
=
••N O
$str
••P i
,
••i j
[
–– 	
LocalizationKeys
––	 
.
–– 
Authentication
–– (
.
––( )
SecureKeyRecovery
––) :
.
––: ;
Reset
––; @
.
––@ A
TITLE
––A F
]
––F G
=
––H I
$str
––J b
,
––b c
[
—— 	
LocalizationKeys
——	 
.
—— 
Authentication
—— (
.
——( )
SecureKeyRecovery
——) :
.
——: ;
Reset
——; @
.
——@ A
DESCRIPTION
——A L
]
——L M
=
——N O
$str
˜˜ @
,
˜˜@ A
[
™™ 	
LocalizationKeys
™™	 
.
™™ 
Authentication
™™ (
.
™™( )
SecureKeyRecovery
™™) :
.
™™: ;
Reset
™™; @
.
™™@ A(
NEW_SECURE_KEY_PLACEHOLDER
™™A [
]
™™[ \
=
™™] ^
$str
™™_ s
,
™™s t
[
šš 	
LocalizationKeys
šš	 
.
šš 
Authentication
šš (
.
šš( )
SecureKeyRecovery
šš) :
.
šš: ;
Reset
šš; @
.
šš@ A!
NEW_SECURE_KEY_HINT
ššA T
]
ššT U
=
ššV W
$str
›› 4
,
››4 5
[
œœ 	
LocalizationKeys
œœ	 
.
œœ 
Authentication
œœ (
.
œœ( )
SecureKeyRecovery
œœ) :
.
œœ: ;
Reset
œœ; @
.
œœ@ A,
CONFIRM_SECURE_KEY_PLACEHOLDER
œœA _
]
œœ_ `
=
œœa b
$str
 $
,
$ %
[
žž 	
LocalizationKeys
žž	 
.
žž 
Authentication
žž (
.
žž( )
SecureKeyRecovery
žž) :
.
žž: ;
Reset
žž; @
.
žž@ A%
CONFIRM_SECURE_KEY_HINT
žžA X
]
žžX Y
=
žžZ [
$str
ŸŸ '
,
ŸŸ' (
[
   	
LocalizationKeys
  	 
.
   
Authentication
   (
.
  ( )
SecureKeyRecovery
  ) :
.
  : ;
Reset
  ; @
.
  @ A
BUTTON
  A G
]
  G H
=
  I J
$str
  K a
,
  a b
[
¡¡ 	
LocalizationKeys
¡¡	 
.
¡¡ 
Authentication
¡¡ (
.
¡¡( )
SignUp
¡¡) /
.
¡¡/ 0
	PassPhase
¡¡0 9
.
¡¡9 :
TITLE
¡¡: ?
]
¡¡? @
=
¡¡A B
$str
¡¡C W
,
¡¡W X
[
¢¢ 	
LocalizationKeys
¢¢	 
.
¢¢ 
Authentication
¢¢ (
.
¢¢( )
SignUp
¢¢) /
.
¢¢/ 0
	PassPhase
¢¢0 9
.
¢¢9 :
DESCRIPTION
¢¢: E
]
¢¢E F
=
¢¢G H
$str
¢¢I s
,
¢¢s t
[
££ 	
LocalizationKeys
££	 
.
££ 
Authentication
££ (
.
££( )
SignUp
££) /
.
££/ 0
	PassPhase
££0 9
.
££9 :
HINT
££: >
]
££> ?
=
££@ A
$str
££B O
,
££O P
[
¤¤ 	
LocalizationKeys
¤¤	 
.
¤¤ 
Authentication
¤¤ (
.
¤¤( )
SignUp
¤¤) /
.
¤¤/ 0
	PassPhase
¤¤0 9
.
¤¤9 :
	WATERMARK
¤¤: C
]
¤¤C D
=
¤¤E F
$str
¤¤G M
,
¤¤M N
[
¥¥ 	
LocalizationKeys
¥¥	 
.
¥¥ 
Authentication
¥¥ (
.
¥¥( )
SignUp
¥¥) /
.
¥¥/ 0
	PassPhase
¥¥0 9
.
¥¥9 :
BUTTON
¥¥: @
]
¥¥@ A
=
¥¥B C
$str
¥¥D U
,
¥¥U V
[
¦¦ 	
LocalizationKeys
¦¦	 
.
¦¦ 
Authentication
¦¦ (
.
¦¦( )
SignIn
¦¦) /
.
¦¦/ 0
TITLE
¦¦0 5
]
¦¦5 6
=
¦¦7 8
$str
¦¦9 ?
,
¦¦? @
[
§§ 	
LocalizationKeys
§§	 
.
§§ 
Authentication
§§ (
.
§§( )
SignIn
§§) /
.
§§/ 0
WELCOME
§§0 7
]
§§7 8
=
§§9 :
$str
§§; n
,
§§n o
[
¨¨ 	
LocalizationKeys
¨¨	 
.
¨¨ 
Authentication
¨¨ (
.
¨¨( )
SignIn
¨¨) /
.
¨¨/ 0 
MOBILE_PLACEHOLDER
¨¨0 B
]
¨¨B C
=
¨¨D E
$str
¨¨F V
,
¨¨V W
[
©© 	
LocalizationKeys
©©	 
.
©© 
Authentication
©© (
.
©©( )
SignIn
©©) /
.
©©/ 0
MOBILE_HINT
©©0 ;
]
©©; <
=
©©= >
$str
©©? d
,
©©d e
[
ªª 	
LocalizationKeys
ªª	 
.
ªª 
Authentication
ªª (
.
ªª( )
SignIn
ªª) /
.
ªª/ 0$
SECURE_KEY_PLACEHOLDER
ªª0 F
]
ªªF G
=
ªªH I
$str
ªªJ X
,
ªªX Y
[
«« 	
LocalizationKeys
««	 
.
«« 
Authentication
«« (
.
««( )
SignIn
««) /
.
««/ 0
SECURE_KEY_HINT
««0 ?
]
««? @
=
««A B
$str
««C h
,
««h i
[
¬¬ 	
LocalizationKeys
¬¬	 
.
¬¬ 
Authentication
¬¬ (
.
¬¬( )
SignIn
¬¬) /
.
¬¬/ 0
ACCOUNT_RECOVERY
¬¬0 @
]
¬¬@ A
=
¬¬B C
$str
¬¬D R
,
¬¬R S
[
­­ 	
LocalizationKeys
­­	 
.
­­ 
Authentication
­­ (
.
­­( )
SignIn
­­) /
.
­­/ 0
CONTINUE
­­0 8
]
­­8 9
=
­­: ;
$str
­­< H
,
­­H I
[
®® 	
LocalizationKeys
®®	 
.
®® &
MobileVerificationStatus
®® 2
.
®®2 3
Error
®®3 8
.
®®8 9'
MOBILE_ALREADY_REGISTERED
®®9 R
]
®®R S
=
®®T U
$str¯¯ •
,¯¯• –
[
°° 	
LocalizationKeys
°°	 
.
°° &
MobileVerificationStatus
°° 2
.
°°2 3(
AVAILABLE_FOR_REGISTRATION
°°3 M
]
°°M N
=
°°O P
$str
°°Q v
,
°°v w
[
±± 	
LocalizationKeys
±±	 
.
±± &
MobileVerificationStatus
±± 2
.
±±2 3.
 INCOMPLETE_REGISTRATION_CONTINUE
±±3 S
]
±±S T
=
±±U V
$str
²² 2
,
²²2 3
[
³³ 	
LocalizationKeys
³³	 
.
³³ &
MobileVerificationStatus
³³ 2
.
³³2 3"
TAKEN_ACTIVE_ACCOUNT
³³3 G
]
³³G H
=
³³I J
$str
´´ T
,
´´T U
[
µµ 	
LocalizationKeys
µµ	 
.
µµ &
MobileVerificationStatus
µµ 2
.
µµ2 3$
TAKEN_INACTIVE_ACCOUNT
µµ3 I
]
µµI J
=
µµK L
$str
¶¶ g
,
¶¶g h
[
·· 	
LocalizationKeys
··	 
.
·· &
MobileVerificationStatus
·· 2
.
··2 3-
DATA_CORRUPTION_CONTACT_SUPPORT
··3 R
]
··R S
=
··T U
$str
¸¸ \
,
¸¸\ ]
[
¹¹ 	
LocalizationKeys
¹¹	 
.
¹¹ &
MobileVerificationStatus
¹¹ 2
.
¹¹2 3&
AVAILABLE_ON_THIS_DEVICE
¹¹3 K
]
¹¹K L
=
¹¹M N
$str
ºº C
,
ººC D
[
»» 	
LocalizationKeys
»»	 
.
»» 
Verification
»» &
.
»»& '
Error
»»' ,
.
»», -
INVALID_OTP_CODE
»»- =
]
»»= >
=
»»? @
$str
»»A a
,
»»a b
[
¼¼ 	
LocalizationKeys
¼¼	 
.
¼¼ 
Registration
¼¼ &
.
¼¼& '
Error
¼¼' ,
.
¼¼, -
FAILED
¼¼- 3
]
¼¼3 4
=
¼¼5 6
$str
¼¼7 S
,
¼¼S T
[
½½ 	
LocalizationKeys
½½	 
.
½½ 
Verification
½½ &
.
½½& '
Error
½½' ,
.
½½, -

NO_SESSION
½½- 7
]
½½7 8
=
½½9 :
$str
½½; \
,
½½\ ]
[
¾¾ 	
LocalizationKeys
¾¾	 
.
¾¾ 
Verification
¾¾ &
.
¾¾& '
Error
¾¾' ,
.
¾¾, -
SESSION_EXPIRED
¾¾- <
]
¾¾< =
=
¾¾> ?
$str
¾¾@ f
,
¾¾f g
[
¿¿ 	
LocalizationKeys
¿¿	 
.
¿¿ 
Verification
¿¿ &
.
¿¿& '
Error
¿¿' ,
.
¿¿, -
NO_ACTIVE_SESSION
¿¿- >
]
¿¿> ?
=
¿¿@ A
$str
¿¿B f
,
¿¿f g
[
ÀÀ 	
LocalizationKeys
ÀÀ	 
.
ÀÀ 
Verification
ÀÀ &
.
ÀÀ& '
Error
ÀÀ' ,
.
ÀÀ, -"
MAX_ATTEMPTS_REACHED
ÀÀ- A
]
ÀÀA B
=
ÀÀC D
$str
ÁÁ A
,
ÁÁA B
[
ÂÂ 	
LocalizationKeys
ÂÂ	 
.
ÂÂ 
Verification
ÂÂ &
.
ÂÂ& '
Error
ÂÂ' ,
.
ÂÂ, -!
VERIFICATION_FAILED
ÂÂ- @
]
ÂÂ@ A
=
ÂÂB C
$str
ÂÂD ^
,
ÂÂ^ _
[
ÃÃ 	
LocalizationKeys
ÃÃ	 
.
ÃÃ 
Verification
ÃÃ &
.
ÃÃ& '
Error
ÃÃ' ,
.
ÃÃ, -
SESSION_NOT_FOUND
ÃÃ- >
]
ÃÃ> ?
=
ÃÃ@ A
$str
ÃÃB c
,
ÃÃc d
[
ÄÄ 	
LocalizationKeys
ÄÄ	 
.
ÄÄ 
Verification
ÄÄ &
.
ÄÄ& '
Error
ÄÄ' ,
.
ÄÄ, -(
GLOBAL_RATE_LIMIT_EXCEEDED
ÄÄ- G
]
ÄÄG H
=
ÄÄI J
$str
ÅÅ 7
,
ÅÅ7 8
[
ÆÆ 	
LocalizationKeys
ÆÆ	 
.
ÆÆ 
Verification
ÆÆ &
.
ÆÆ& '
Info
ÆÆ' +
.
ÆÆ+ ,
REDIRECTING
ÆÆ, 7
]
ÆÆ7 8
=
ÆÆ9 :
$str
ÆÆ; O
,
ÆÆO P
[
ÇÇ 	
LocalizationKeys
ÇÇ	 
.
ÇÇ 
Verification
ÇÇ &
.
ÇÇ& '
Info
ÇÇ' +
.
ÇÇ+ ,$
REDIRECTING_IN_SECONDS
ÇÇ, B
]
ÇÇB C
=
ÇÇD E
$str
ÇÇF k
,
ÇÇk l
[
ÈÈ 	
LocalizationKeys
ÈÈ	 
.
ÈÈ 
ValidationErrors
ÈÈ *
.
ÈÈ* +
MobileNumber
ÈÈ+ 7
.
ÈÈ7 8*
MUST_START_WITH_COUNTRY_CODE
ÈÈ8 T
]
ÈÈT U
=
ÈÈV W
$str
ÈÈX m
,
ÈÈm n
[
ÉÉ 	
LocalizationKeys
ÉÉ	 
.
ÉÉ 
ValidationErrors
ÉÉ *
.
ÉÉ* +
MobileNumber
ÉÉ+ 7
.
ÉÉ7 8!
CONTAINS_NON_DIGITS
ÉÉ8 K
]
ÉÉK L
=
ÉÉM N
$str
ÉÉO f
,
ÉÉf g
[
ÊÊ 	
LocalizationKeys
ÊÊ	 
.
ÊÊ 
ValidationErrors
ÊÊ *
.
ÊÊ* +
MobileNumber
ÊÊ+ 7
.
ÊÊ7 8
INCORRECT_LENGTH
ÊÊ8 H
]
ÊÊH I
=
ÊÊJ K
$str
ÊÊL c
,
ÊÊc d
[
ËË 	
LocalizationKeys
ËË	 
.
ËË 
ValidationErrors
ËË *
.
ËË* +
MobileNumber
ËË+ 7
.
ËË7 8
CANNOT_BE_EMPTY
ËË8 G
]
ËËG H
=
ËËI J
$str
ËËK ]
,
ËË] ^
[
ÌÌ 	
LocalizationKeys
ÌÌ	 
.
ÌÌ 
ValidationErrors
ÌÌ *
.
ÌÌ* +
MobileNumber
ÌÌ+ 7
.
ÌÌ7 8
REQUIRED
ÌÌ8 @
]
ÌÌ@ A
=
ÌÌB C
$str
ÌÌD n
,
ÌÌn o
[
ÍÍ 	
LocalizationKeys
ÍÍ	 
.
ÍÍ 
ValidationErrors
ÍÍ *
.
ÍÍ* +$
MobileNumberIdentifier
ÍÍ+ A
.
ÍÍA B
REQUIRED
ÍÍB J
]
ÍÍJ K
=
ÍÍL M
$str
ÎÎ E
,
ÎÎE F
[
ÏÏ 	
LocalizationKeys
ÏÏ	 
.
ÏÏ 
ValidationErrors
ÏÏ *
.
ÏÏ* +
DeviceIdentifier
ÏÏ+ ;
.
ÏÏ; <
REQUIRED
ÏÏ< D
]
ÏÏD E
=
ÏÏF G
$str
ÏÏH o
,
ÏÏo p
[
ÐÐ 	
LocalizationKeys
ÐÐ	 
.
ÐÐ 
ValidationErrors
ÐÐ *
.
ÐÐ* +
SessionIdentifier
ÐÐ+ <
.
ÐÐ< =
REQUIRED
ÐÐ= E
]
ÐÐE F
=
ÐÐG H
$str
ÐÐI m
,
ÐÐm n
[
ÑÑ 	
LocalizationKeys
ÑÑ	 
.
ÑÑ 
ValidationErrors
ÑÑ *
.
ÑÑ* +"
MembershipIdentifier
ÑÑ+ ?
.
ÑÑ? @
REQUIRED
ÑÑ@ H
]
ÑÑH I
=
ÑÑJ K
$str
ÑÑL s
,
ÑÑs t
[
ÒÒ 	
LocalizationKeys
ÒÒ	 
.
ÒÒ 
ResponseErrors
ÒÒ (
.
ÒÒ( )
MobileNumber
ÒÒ) 5
.
ÒÒ5 6(
ACCOUNT_ALREADY_REGISTERED
ÒÒ6 P
]
ÒÒP Q
=
ÒÒR S
$str
ÓÓ m
,
ÓÓm n
[
ÔÔ 	
LocalizationKeys
ÔÔ	 
.
ÔÔ 
ResponseErrors
ÔÔ (
.
ÔÔ( )
MobileNumber
ÔÔ) 5
.
ÔÔ5 6*
UNEXPECTED_MEMBERSHIP_STATUS
ÔÔ6 R
]
ÔÔR S
=
ÔÔT U
$str
ÕÕ <
,
ÕÕ< =
[
ÖÖ 	
LocalizationKeys
ÖÖ	 
.
ÖÖ 
ResponseErrors
ÖÖ (
.
ÖÖ( )
General
ÖÖ) 0
.
ÖÖ0 1
TIMEOUT_EXCEEDED
ÖÖ1 A
]
ÖÖA B
=
ÖÖC D
$str
×× C
,
××C D
[
ØØ 	
LocalizationKeys
ØØ	 
.
ØØ 
ValidationErrors
ØØ *
.
ØØ* +
	SecureKey
ØØ+ 4
.
ØØ4 5
REQUIRED
ØØ5 =
]
ØØ= >
=
ØØ? @
$str
ØØA S
,
ØØS T
[
ÙÙ 	
LocalizationKeys
ÙÙ	 
.
ÙÙ 
ValidationErrors
ÙÙ *
.
ÙÙ* +
	SecureKey
ÙÙ+ 4
.
ÙÙ4 5

MIN_LENGTH
ÙÙ5 ?
]
ÙÙ? @
=
ÙÙA B
$str
ÙÙC V
,
ÙÙV W
[
ÚÚ 	
LocalizationKeys
ÚÚ	 
.
ÚÚ 
ValidationErrors
ÚÚ *
.
ÚÚ* +
	SecureKey
ÚÚ+ 4
.
ÚÚ4 5

MAX_LENGTH
ÚÚ5 ?
]
ÚÚ? @
=
ÚÚA B
$str
ÚÚC W
,
ÚÚW X
[
ÛÛ 	
LocalizationKeys
ÛÛ	 
.
ÛÛ 
ValidationErrors
ÛÛ *
.
ÛÛ* +
	SecureKey
ÛÛ+ 4
.
ÛÛ4 5
	NO_SPACES
ÛÛ5 >
]
ÛÛ> ?
=
ÛÛ@ A
$str
ÛÛB P
,
ÛÛP Q
[
ÜÜ 	
LocalizationKeys
ÜÜ	 
.
ÜÜ 
ValidationErrors
ÜÜ *
.
ÜÜ* +
	SecureKey
ÜÜ+ 4
.
ÜÜ4 5
NO_UPPERCASE
ÜÜ5 A
]
ÜÜA B
=
ÜÜC D
$str
ÜÜE ]
,
ÜÜ] ^
[
ÝÝ 	
LocalizationKeys
ÝÝ	 
.
ÝÝ 
ValidationErrors
ÝÝ *
.
ÝÝ* +
	SecureKey
ÝÝ+ 4
.
ÝÝ4 5
NO_LOWERCASE
ÝÝ5 A
]
ÝÝA B
=
ÝÝC D
$str
ÝÝE [
,
ÝÝ[ \
[
ÞÞ 	
LocalizationKeys
ÞÞ	 
.
ÞÞ 
ValidationErrors
ÞÞ *
.
ÞÞ* +
	SecureKey
ÞÞ+ 4
.
ÞÞ4 5
NO_DIGIT
ÞÞ5 =
]
ÞÞ= >
=
ÞÞ? @
$str
ÞÞA Q
,
ÞÞQ R
[
ßß 	
LocalizationKeys
ßß	 
.
ßß 
ValidationErrors
ßß *
.
ßß* +
	SecureKey
ßß+ 4
.
ßß4 5

TOO_SIMPLE
ßß5 ?
]
ßß? @
=
ßßA B
$str
ßßC c
,
ßßc d
[
àà 	
LocalizationKeys
àà	 
.
àà 
ValidationErrors
àà *
.
àà* +
	SecureKey
àà+ 4
.
àà4 5

TOO_COMMON
àà5 ?
]
àà? @
=
ààA B
$str
ààC V
,
ààV W
[
áá 	
LocalizationKeys
áá	 
.
áá 
ValidationErrors
áá *
.
áá* +
	SecureKey
áá+ 4
.
áá4 5 
SEQUENTIAL_PATTERN
áá5 G
]
ááG H
=
ááI J
$str
ááK j
,
ááj k
[
ââ 	
LocalizationKeys
ââ	 
.
ââ 
ValidationErrors
ââ *
.
ââ* +
	SecureKey
ââ+ 4
.
ââ4 5
REPEATED_CHARS
ââ5 C
]
ââC D
=
ââE F
$str
ââG `
,
ââ` a
[
ãã 	
LocalizationKeys
ãã	 
.
ãã 
ValidationErrors
ãã *
.
ãã* +
	SecureKey
ãã+ 4
.
ãã4 5
LACKS_DIVERSITY
ãã5 D
]
ããD E
=
ããF G
$str
ããH q
,
ããq r
[
ää 	
LocalizationKeys
ää	 
.
ää 
ValidationErrors
ää *
.
ää* +
	SecureKey
ää+ 4
.
ää4 5
CONTAINS_APP_NAME
ää5 F
]
ääF G
=
ääH I
$str
ääJ i
,
ääi j
[
åå 	
LocalizationKeys
åå	 
.
åå 
ValidationErrors
åå *
.
åå* +
	SecureKey
åå+ 4
.
åå4 5!
INVALID_CREDENTIALS
åå5 H
]
ååH I
=
ååJ K
$str
ååL g
,
ååg h
[
ææ 	
LocalizationKeys
ææ	 
.
ææ 
ValidationErrors
ææ *
.
ææ* +
	SecureKey
ææ+ 4
.
ææ4 5!
NON_ENGLISH_LETTERS
ææ5 H
]
ææH I
=
ææJ K
$str
ææL c
,
ææc d
[
çç 	
LocalizationKeys
çç	 
.
çç 
ValidationErrors
çç *
.
çç* +
	SecureKey
çç+ 4
.
çç4 5
NO_SPECIAL_CHAR
çç5 D
]
ççD E
=
ççF G
$str
ççH e
,
ççe f
[
èè 	
LocalizationKeys
èè	 
.
èè 
ValidationErrors
èè *
.
èè* +
VerifySecureKey
èè+ :
.
èè: ;
DOES_NOT_MATCH
èè; I
]
èèI J
=
èèK L
$str
èèM j
,
èèj k
[
éé 	
LocalizationKeys
éé	 
.
éé 
ValidationErrors
éé *
.
éé* +
Strength
éé+ 3
.
éé3 4
INVALID
éé4 ;
]
éé; <
=
éé= >
$str
éé? L
,
ééL M
[
êê 	
LocalizationKeys
êê	 
.
êê 
ValidationErrors
êê *
.
êê* +
Strength
êê+ 3
.
êê3 4
	VERY_WEAK
êê4 =
]
êê= >
=
êê? @
$str
êêA O
,
êêO P
[
ëë 	
LocalizationKeys
ëë	 
.
ëë 
ValidationErrors
ëë *
.
ëë* +
Strength
ëë+ 3
.
ëë3 4
WEAK
ëë4 8
]
ëë8 9
=
ëë: ;
$str
ëë< E
,
ëëE F
[
ìì 	
LocalizationKeys
ìì	 
.
ìì 
ValidationErrors
ìì *
.
ìì* +
Strength
ìì+ 3
.
ìì3 4
GOOD
ìì4 8
]
ìì8 9
=
ìì: ;
$str
ìì< E
,
ììE F
[
íí 	
LocalizationKeys
íí	 
.
íí 
ValidationErrors
íí *
.
íí* +
Strength
íí+ 3
.
íí3 4
STRONG
íí4 :
]
íí: ;
=
íí< =
$str
íí> G
,
ííG H
[
îî 	
LocalizationKeys
îî	 
.
îî 
ValidationErrors
îî *
.
îî* +
Strength
îî+ 3
.
îî3 4
VERY_STRONG
îî4 ?
]
îî? @
=
îîA B
$str
îîC Q
,
îîQ R
[
ïï 	
LocalizationKeys
ïï	 
.
ïï  
ValidationWarnings
ïï ,
.
ïï, -
	SecureKey
ïï- 6
.
ïï6 7
NON_LATIN_LETTER
ïï7 G
]
ïïG H
=
ïïI J
$str
ïïK b
,
ïïb c
[
ðð 	
LocalizationKeys
ðð	 
.
ðð  
ValidationWarnings
ðð ,
.
ðð, -
	SecureKey
ðð- 6
.
ðð6 7
INVALID_CHARACTER
ðð7 H
]
ððH I
=
ððJ K
$str
ððL m
,
ððm n
[
ññ 	
LocalizationKeys
ññ	 
.
ññ  
ValidationWarnings
ññ ,
.
ññ, -
	SecureKey
ññ- 6
.
ññ6 7!
MULTIPLE_CHARACTERS
ññ7 J
]
ññJ K
=
ññL M
$str
ññN k
,
ññk l
[
òò 	
LocalizationKeys
òò	 
.
òò 
Welcome
òò !
.
òò! "
SIGN_IN_BUTTON
òò" 0
]
òò0 1
=
òò2 3
$str
òò4 <
,
òò< =
[
óó 	
LocalizationKeys
óó	 
.
óó 
Welcome
óó !
.
óó! "#
CREATE_ACCOUNT_BUTTON
óó" 7
]
óó7 8
=
óó9 :
$str
óó; L
,
óóL M
[
ôô 	
LocalizationKeys
ôô	 
.
ôô 
Footer
ôô  
.
ôô  !
PRIVACY_POLICY
ôô! /
]
ôô/ 0
=
ôô1 2
$str
ôô3 N
,
ôôN O
[
õõ 	
LocalizationKeys
õõ	 
.
õõ 
Footer
õõ  
.
õõ  !
TERMS_OF_SERVICE
õõ! 1
]
õõ1 2
=
õõ3 4
$str
õõ5 K
,
õõK L
[
öö 	
LocalizationKeys
öö	 
.
öö 
Footer
öö  
.
öö  !
SUPPORT
öö! (
]
öö( )
=
öö* +
$str
öö, 7
,
öö7 8
[
÷÷ 	
LocalizationKeys
÷÷	 
.
÷÷ 
Footer
÷÷  
.
÷÷  !
AGREEMENT_TEXT
÷÷! /
]
÷÷/ 0
=
÷÷1 2
$str
øø Z
,
øøZ [
[
ùù 	
LocalizationKeys
ùù	 
.
ùù 
Footer
ùù  
.
ùù  !
	COPYRIGHT
ùù! *
]
ùù* +
=
ùù, -
$str
ùù. \
,
ùù\ ]
[
úú 	
LocalizationKeys
úú	 
.
úú 

Navigation
úú $
.
úú$ %
BACK
úú% )
]
úú) *
=
úú+ ,
$str
úú- 4
,
úú4 5
[
ûû 	
LocalizationKeys
ûû	 
.
ûû 

Navigation
ûû $
.
ûû$ %
CLOSE
ûû% *
]
ûû* +
=
ûû, -
$str
ûû. 7
,
ûû7 8
[
üü 	
LocalizationKeys
üü	 
.
üü 

Navigation
üü $
.
üü$ %
MINIMIZE
üü% -
]
üü- .
=
üü/ 0
$str
üü1 ;
,
üü; <
[
ýý 	
LocalizationKeys
ýý	 
.
ýý 

Navigation
ýý $
.
ýý$ %
MAXIMIZE
ýý% -
]
ýý- .
=
ýý/ 0
$str
ýý1 =
,
ýý= >
[
þþ 	
LocalizationKeys
þþ	 
.
þþ 
Common
þþ  
.
þþ  !
LOADING
þþ! (
]
þþ( )
=
þþ* +
$str
þþ, =
,
þþ= >
[
ÿÿ 	
LocalizationKeys
ÿÿ	 
.
ÿÿ 
Common
ÿÿ  
.
ÿÿ  !
ERROR
ÿÿ! &
]
ÿÿ& '
=
ÿÿ( )
$str
ÿÿ* 3
,
ÿÿ3 4
[
€€ 	
LocalizationKeys
€€	 
.
€€ 
Common
€€  
.
€€  !
SUCCESS
€€! (
]
€€( )
=
€€* +
$str
€€, 5
,
€€5 6
[
 	
LocalizationKeys
	 
.
 
Common
  
.
  !
CANCEL
! '
]
' (
=
) *
$str
+ 6
,
6 7
[
‚‚ 	
LocalizationKeys
‚‚	 
.
‚‚ 
Common
‚‚  
.
‚‚  !
UNEXPECTED_ERROR
‚‚! 1
]
‚‚1 2
=
‚‚3 4
$str
‚‚5 J
,
‚‚J K
[
ƒƒ 	
LocalizationKeys
ƒƒ	 
.
ƒƒ 
Common
ƒƒ  
.
ƒƒ  !
OK
ƒƒ! #
]
ƒƒ# $
=
ƒƒ% &
$str
ƒƒ' /
,
ƒƒ/ 0
[
„„ 	
LocalizationKeys
„„	 
.
„„ 
Common
„„  
.
„„  !$
NO_INTERNET_CONNECTION
„„! 7
]
„„7 8
=
„„9 :
$str
„„; [
,
„„[ \
[
…… 	
LocalizationKeys
……	 
.
…… 
Common
……  
.
……  !
CHECK_CONNECTION
……! 1
]
……1 2
=
……3 4
$str
……5 X
,
……X Y
[
†† 	
LocalizationKeys
††	 
.
†† !
NetworkNotification
†† -
.
††- .

NoInternet
††. 8
.
††8 9
TITLE
††9 >
]
††> ?
=
††@ A
$str
††B b
,
††b c
[
‡‡ 	
LocalizationKeys
‡‡	 
.
‡‡ !
NetworkNotification
‡‡ -
.
‡‡- .

NoInternet
‡‡. 8
.
‡‡8 9
DESCRIPTION
‡‡9 D
]
‡‡D E
=
‡‡F G
$str
‡‡H p
,
‡‡p q
[
ˆˆ 	
LocalizationKeys
ˆˆ	 
.
ˆˆ !
NetworkNotification
ˆˆ -
.
ˆˆ- .
CheckingInternet
ˆˆ. >
.
ˆˆ> ?
TITLE
ˆˆ? D
]
ˆˆD E
=
ˆˆF G
$str
ˆˆH ]
,
ˆˆ] ^
[
‰‰ 	
LocalizationKeys
‰‰	 
.
‰‰ !
NetworkNotification
‰‰ -
.
‰‰- .
CheckingInternet
‰‰. >
.
‰‰> ?
DESCRIPTION
‰‰? J
]
‰‰J K
=
‰‰L M
$str
ŠŠ 2
,
ŠŠ2 3
[
‹‹ 	
LocalizationKeys
‹‹	 
.
‹‹ !
NetworkNotification
‹‹ -
.
‹‹- .
InternetRestored
‹‹. >
.
‹‹> ?
TITLE
‹‹? D
]
‹‹D E
=
‹‹F G
$str
‹‹H ^
,
‹‹^ _
[
ŒŒ 	
LocalizationKeys
ŒŒ	 
.
ŒŒ !
NetworkNotification
ŒŒ -
.
ŒŒ- .
InternetRestored
ŒŒ. >
.
ŒŒ> ?
DESCRIPTION
ŒŒ? J
]
ŒŒJ K
=
ŒŒL M
$str
ŒŒN s
,
ŒŒs t
[
 	
LocalizationKeys
	 
.
 !
NetworkNotification
 -
.
- .

Connecting
. 8
.
8 9
TITLE
9 >
]
> ?
=
@ A
$str
B O
,
O P
[
ŽŽ 	
LocalizationKeys
ŽŽ	 
.
ŽŽ !
NetworkNotification
ŽŽ -
.
ŽŽ- .

Connecting
ŽŽ. 8
.
ŽŽ8 9
DESCRIPTION
ŽŽ9 D
]
ŽŽD E
=
ŽŽF G
$str
ŽŽH k
,
ŽŽk l
[
 	
LocalizationKeys
	 
.
 !
NetworkNotification
 -
.
- .
Reconnecting
. :
.
: ;
TITLE
; @
]
@ A
=
B C
$str
D U
,
U V
[
 	
LocalizationKeys
	 
.
 !
NetworkNotification
 -
.
- .
Reconnecting
. :
.
: ;
DESCRIPTION
; F
]
F G
=
H I
$str
‘‘ 8
,
‘‘8 9
[
’’ 	
LocalizationKeys
’’	 
.
’’ !
NetworkNotification
’’ -
.
’’- .!
ServerNotResponding
’’. A
.
’’A B
TITLE
’’B G
]
’’G H
=
’’I J
$str
’’K _
,
’’_ `
[
““ 	
LocalizationKeys
““	 
.
““ !
NetworkNotification
““ -
.
““- .!
ServerNotResponding
““. A
.
““A B
DESCRIPTION
““B M
]
““M N
=
““O P
$str
““Q o
,
““o p
[
”” 	
LocalizationKeys
””	 
.
”” !
NetworkNotification
”” -
.
””- . 
ServerShuttingDown
””. @
.
””@ A
TITLE
””A F
]
””F G
=
””H I
$str
””J b
,
””b c
[
•• 	
LocalizationKeys
••	 
.
•• !
NetworkNotification
•• -
.
••- . 
ServerShuttingDown
••. @
.
••@ A
DESCRIPTION
••A L
]
••L M
=
••N O
$str
••P d
,
••d e
[
–– 	
LocalizationKeys
––	 
.
–– !
NetworkNotification
–– -
.
––- .
RetriesExhausted
––. >
.
––> ?
TITLE
––? D
]
––D E
=
––F G
$str
––H a
,
––a b
[
—— 	
LocalizationKeys
——	 
.
—— !
NetworkNotification
—— -
.
——- .
RetriesExhausted
——. >
.
——> ?
DESCRIPTION
——? J
]
——J K
=
——L M
$str
˜˜ 8
,
˜˜8 9
[
™™ 	
LocalizationKeys
™™	 
.
™™ !
NetworkNotification
™™ -
.
™™- .
ServerReconnected
™™. ?
.
™™? @
TITLE
™™@ E
]
™™E F
=
™™G H
$str
™™I U
,
™™U V
[
šš 	
LocalizationKeys
šš	 
.
šš !
NetworkNotification
šš -
.
šš- .
ServerReconnected
šš. ?
.
šš? @
DESCRIPTION
šš@ K
]
ššK L
=
ššM N
$str
ššO n
,
ššn o
[
›› 	
LocalizationKeys
››	 
.
›› !
NetworkNotification
›› -
.
››- .
Button
››. 4
.
››4 5
RETRY
››5 :
]
››: ;
=
››< =
$str
››> I
,
››I J
[
œœ 	
LocalizationKeys
œœ	 
.
œœ 
LanguageDetection
œœ +
.
œœ+ ,
TITLE
œœ, 1
]
œœ1 2
=
œœ3 4
$str
œœ5 F
,
œœF G
[
 	
LocalizationKeys
	 
.
 
LanguageDetection
 +
.
+ ,
PROMPT
, 2
]
2 3
=
4 5
$str
6 L
,
L M
[
žž 	
LocalizationKeys
žž	 
.
žž 
LanguageDetection
žž +
.
žž+ ,
BUTTON_CONFIRM
žž, :
]
žž: ;
=
žž< =
$str
žž> L
,
žžL M
[
ŸŸ 	
LocalizationKeys
ŸŸ	 
.
ŸŸ 
LanguageDetection
ŸŸ +
.
ŸŸ+ ,
BUTTON_DECLINE
ŸŸ, :
]
ŸŸ: ;
=
ŸŸ< =
$str
ŸŸ> H
}
   
.
    
ToFrozenDictionary
   
(
   
)
   
;
   
public
¢¢ 

static
¢¢ 
readonly
¢¢ 
FrozenDictionary
¢¢ +
<
¢¢+ ,
string
¢¢, 2
,
¢¢2 3
FrozenDictionary
¢¢4 D
<
¢¢D E
string
¢¢E K
,
¢¢K L
string
¢¢M S
>
¢¢S T
>
¢¢T U
AllLanguages
¢¢V b
=
¢¢c d
new
££ 

Dictionary
££ 
<
££ 
string
££ 
,
££ 
FrozenDictionary
££ /
<
££/ 0
string
££0 6
,
££6 7
string
££8 >
>
££> ?
>
££? @
{
¤¤ 	
[
¥¥ 
$str
¥¥ 
]
¥¥ 
=
¥¥ 
EnglishStrings
¥¥ &
,
¥¥& '
[
¥¥( )
$str
¥¥) 0
]
¥¥0 1
=
¥¥2 3
UkrainianStrings
¥¥4 D
}
¦¦ 	
.
¦¦	 
 
ToFrozenDictionary
¦¦
 
(
¦¦ 
)
¦¦ 
;
¦¦ 
}§§ š"
s/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/IconService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
;% &
internal

 
static

	 
class

 
IconService

 !
{ 
private 
static 
Option 
< 

WindowIcon $
>$ %
_cachedIcon& 1
=2 3
Option4 :
<: ;

WindowIcon; E
>E F
.F G
NoneG K
;K L
public 

static 
void 
SetIconForWindow '
(' (
Window( .
window/ 5
)5 6
{ 
_cachedIcon 
. 
Or 
( 
LoadPlatformIcon '
)' (
. 
Do 
( 
icon 
=> 
{ 
_cachedIcon 
= 
Option $
<$ %

WindowIcon% /
>/ 0
.0 1
Some1 5
(5 6
icon6 :
): ;
;; <
window 
. 
Icon 
= 
icon "
;" #
} 
) 
; 
} 
private 
static 
Option 
< 

WindowIcon $
>$ %
LoadPlatformIcon& 6
(6 7
)7 8
{ 
return 
GetPlatformIconUri !
(! "
)" #
. 
Bind 
( 
uri 
=> 
{ 
try 
{ 
Bitmap 
bitmap !
=" #
new$ '
(' (
AssetLoader( 3
.3 4
Open4 8
(8 9
uri9 <
)< =
)= >
;> ?
return   
Option   !
<  ! "

WindowIcon  " ,
>  , -
.  - .
Some  . 2
(  2 3
new  3 6

WindowIcon  7 A
(  A B
bitmap  B H
)  H I
)  I J
;  J K
}!! 
catch"" 
("" 
	Exception""  
ex""! #
)""# $
{## 
Log$$ 
.$$ 
Warning$$ 
($$  
ex$$  "
,$$" #
$str$$$ E
)$$E F
;$$F G
return%% 
Option%% !
<%%! "

WindowIcon%%" ,
>%%, -
.%%- .
None%%. 2
;%%2 3
}&& 
}'' 
)'' 
;'' 
}(( 
private** 
static** 
Option** 
<** 
Uri** 
>** 
GetPlatformIconUri** 1
(**1 2
)**2 3
{++ 
if,, 

(,, 
OperatingSystem,, 
.,, 
	IsWindows,, %
(,,% &
),,& '
),,' (
{-- 	
return.. 
Option.. 
<.. 
Uri.. 
>.. 
... 
Some.. #
(..# $
new..$ '
Uri..( +
(..+ ,
$str.., r
)..r s
)..s t
;..t u
}// 	
if11 

(11 
OperatingSystem11 
.11 
IsMacOS11 #
(11# $
)11$ %
)11% &
{22 	
return33 
Option33 
<33 
Uri33 
>33 
.33 
Some33 #
(33# $
new33$ '
Uri33( +
(33+ ,
$str33, u
)33u v
)33v w
;33w x
}44 	
if66 

(66 
OperatingSystem66 
.66 
IsLinux66 #
(66# $
)66$ %
)66% &
{77 	
return88 
Option88 
<88 
Uri88 
>88 
.88 
Some88 #
(88# $
new88$ '
Uri88( +
(88+ ,
$str88, t
)88t u
)88u v
;88v w
}99 	
return;; 
Option;; 
<;; 
Uri;; 
>;; 
.;; 
None;; 
;;;  
}<< 
}== ä
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/ApplicationStateManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
;% &
public		 
sealed		 
class		 #
ApplicationStateManager		 +
:		, -$
IApplicationStateManager		. F
,		F G
IDisposable		H S
{

 
private 
readonly 
BehaviorSubject $
<$ %
ApplicationState% 5
>5 6
_stateSubject7 D
=E F
newG J
(J K
ApplicationStateK [
.[ \
INITIALIZING\ h
)h i
;i j
private 
Option 
< 
string 
>  
_currentMembershipId /
=0 1
Option2 8
<8 9
string9 ?
>? @
.@ A
NoneA E
;E F
private 
bool 
	_disposed 
; 
public 

ApplicationState 
CurrentState (
=>) +
_stateSubject, 9
.9 :
Value: ?
;? @
public 

IObservable 
< 
ApplicationState '
>' (
StateChanges) 5
=>6 8
_stateSubject9 F
;F G
public 

Option 
< 
string 
> 
CurrentMembershipId -
=>. 0 
_currentMembershipId1 E
;E F
public 

Task &
TransitionToAnonymousAsync *
(* +
)+ ,
{  
_currentMembershipId 
= 
Option %
<% &
string& ,
>, -
.- .
None. 2
;2 3
_stateSubject 
. 
OnNext 
( 
ApplicationState -
.- .
	ANONYMOUS. 7
)7 8
;8 9
return 
Task 
. 
CompletedTask !
;! "
} 
public 

Task *
TransitionToAuthenticatedAsync .
(. /
string/ 5
membershipId6 B
)B C
{ 
if 

( 
string 
. 
IsNullOrEmpty  
(  !
membershipId! -
)- .
). /
{ 	
throw   
new   
ArgumentException   '
(  ' (
$str  ( O
,  O P
nameof  Q W
(  W X
membershipId  X d
)  d e
)  e f
;  f g
}!! 	 
_currentMembershipId## 
=## 
Option## %
<##% &
string##& ,
>##, -
.##- .
Some##. 2
(##2 3
membershipId##3 ?
)##? @
;##@ A
_stateSubject$$ 
.$$ 
OnNext$$ 
($$ 
ApplicationState$$ -
.$$- .
AUTHENTICATED$$. ;
)$$; <
;$$< =
return%% 
Task%% 
.%% 
CompletedTask%% !
;%%! "
}&& 
public(( 

void(( 
Dispose(( 
((( 
)(( 
{)) 
if** 

(** 
	_disposed** 
)** 
{++ 	
return,, 
;,, 
}-- 	
_stateSubject// 
?// 
.// 
Dispose// 
(// 
)//  
;//  !
	_disposed00 
=00 
true00 
;00 
}11 
}22 ¿Ã
y/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/ApplicationRouter.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
;% &
public 
sealed 
class 
ApplicationRouter %
(% &3
'IClassicDesktopStyleApplicationLifetime +
desktop, 3
,3 4
IModuleManager   
moduleManager    
,    !
NetworkProvider!! 
networkProvider!! #
,!!# $-
!IApplicationSecureStorageProvider"" %,
 applicationSecureStorageProvider""& F
,""F G
MainWindowViewModel## 
mainWindowViewModel## +
)##+ ,
:##- .
IApplicationRouter##/ A
{$$ 
private%% 
const%% 
int%% 
FADE_DURATION_MS%% &
=%%' (
$num%%) ,
;%%, -
private&& 
const&& 
int&&  
WINDOW_SHOW_DELAY_MS&& *
=&&+ ,
$num&&- /
;&&/ 0
private'' 
const'' 
int'' 
FRAME_DELAY_MS'' $
=''% &
$num''' )
;'') *
public)) 

async)) 
Task)) )
NavigateToAuthenticationAsync)) 3
())3 4
)))4 5
{** 
Option++ 
<++ 
IModule++ 
>++ 
authModuleOption++ (
=++) *
await+++ 0
moduleManager++1 >
.++> ?
LoadModuleAsync++? N
(++N O
$str++O _
)++_ `
.++` a
ConfigureAwait++a o
(++o p
false++p u
)++u v
;++v w
if-- 

(-- 
!-- 
authModuleOption-- 
.-- 
IsSome-- $
)--$ %
{.. 	
throw// 
new// %
InvalidOperationException// /
(/// 0$
ApplicationErrorMessages//0 H
.//H I
ApplicationRouter//I Z
.//Z [&
FAILED_TO_LOAD_AUTH_MODULE//[ u
)//u v
;//v w
}00 	
IModule22 

authModule22 
=22 
authModuleOption22 -
.22- .
Value22. 3
!223 4
;224 5
if44 

(44 

authModule44 
.44 
ServiceScope44 #
?44# $
.44$ %
ServiceProvider44% 4
==445 7
null448 <
)44< =
{55 	
throw66 
new66 %
InvalidOperationException66 /
(66/ 0$
ApplicationErrorMessages660 H
.66H I
ApplicationRouter66I Z
.66Z [&
FAILED_TO_LOAD_AUTH_MODULE66[ u
)66u v
;66v w
}77 	#
AuthenticationViewModel99 
?99  
membershipViewModel99! 4
=995 6

authModule:: 
.:: 
ServiceScope:: #
.::# $
ServiceProvider::$ 3
.::3 4

GetService::4 >
<::> ?#
AuthenticationViewModel::? V
>::V W
(::W X
)::X Y
;::Y Z
if<< 

(<< 
membershipViewModel<< 
==<<  "
null<<# '
)<<' (
{== 	
throw>> 
new>> %
InvalidOperationException>> /
(>>/ 0$
ApplicationErrorMessages>>0 H
.>>H I
ApplicationRouter>>I Z
.?? 2
&FAILED_TO_CREATE_MEMBERSHIP_VIEW_MODEL?? 7
)??7 8
;??8 9
}@@ 	
awaitBB 
mainWindowViewModelBB !
.BB! ")
SetAuthenticationContentAsyncBB" ?
(BB? @
membershipViewModelBB@ S
)BBS T
.BBT U
ConfigureAwaitBBU c
(BBc d
falseBBd i
)BBi j
;BBj k
awaitCC 
moduleManagerCC 
.CC 
UnloadModuleAsyncCC -
(CC- .
$strCC. 4
)CC4 5
.CC5 6
ConfigureAwaitCC6 D
(CCD E
falseCCE J
)CCJ K
;CCK L
awaitDD (
EnsureAnonymousProtocolAsyncDD *
(DD* +
)DD+ ,
.DD, -
ConfigureAwaitDD- ;
(DD; <
falseDD< A
)DDA B
;DDB C
}EE 
publicGG 

asyncGG 
TaskGG 
NavigateToMainAsyncGG )
(GG) *
)GG* +
{HH 
OptionII 
<II 
IModuleII 
>II 
mainModuleOptionII (
=II) *
awaitII+ 0
moduleManagerII1 >
.II> ?
LoadModuleAsyncII? N
(IIN O
$strIIO U
)IIU V
.IIV W
ConfigureAwaitIIW e
(IIe f
falseIIf k
)IIk l
;IIl m
ifKK 

(KK 
!KK 
mainModuleOptionKK 
.KK 
IsSomeKK $
)KK$ %
{LL 	
throwMM 
newMM %
InvalidOperationExceptionMM /
(MM/ 0$
ApplicationErrorMessagesMM0 H
.MMH I
ApplicationRouterMMI Z
.MMZ [&
FAILED_TO_LOAD_MAIN_MODULEMM[ u
)MMu v
;MMv w
}NN 	
IModulePP 

mainModulePP 
=PP 
mainModuleOptionPP -
.PP- .
ValuePP. 3
!PP3 4
;PP4 5
ifRR 

(RR 

mainModuleRR 
.RR 
ServiceScopeRR #
?RR# $
.RR$ %
ServiceProviderRR% 4
==RR5 7
nullRR8 <
)RR< =
{SS 	
throwTT 
newTT %
InvalidOperationExceptionTT /
(TT/ 0$
ApplicationErrorMessagesTT0 H
.TTH I
ApplicationRouterTTI Z
.TTZ [&
FAILED_TO_LOAD_MAIN_MODULETT[ u
)TTu v
;TTv w
}UU 	
MasterViewModelWW 
?WW 
mainViewModelWW &
=WW' (

mainModuleXX 
.XX 
ServiceScopeXX #
.XX# $
ServiceProviderXX$ 3
.XX3 4

GetServiceXX4 >
<XX> ?
MasterViewModelXX? N
>XXN O
(XXO P
)XXP Q
;XXQ R
ifZZ 

(ZZ 
mainViewModelZZ 
==ZZ 
nullZZ !
)ZZ! "
{[[ 	
throw\\ 
new\\ %
InvalidOperationException\\ /
(\\/ 0$
ApplicationErrorMessages\\0 H
.\\H I
ApplicationRouter\\I Z
.]] ,
 FAILED_TO_CREATE_MAIN_VIEW_MODEL]] 1
)]]1 2
;]]2 3
}^^ 	
await`` 
mainWindowViewModel`` !
.``! "
SetMainContentAsync``" 5
(``5 6
mainViewModel``6 C
)``C D
.``D E
ConfigureAwait``E S
(``S T
false``T Y
)``Y Z
;``Z [
awaitaa 
moduleManageraa 
.aa 
UnloadModuleAsyncaa -
(aa- .
$straa. >
)aa> ?
.aa? @
ConfigureAwaitaa@ N
(aaN O
falseaaO T
)aaT U
;aaU V
}bb 
publicdd 

asyncdd 
Taskdd %
TransitionFromSplashAsyncdd /
(dd/ 0
Windowdd0 6
splashWindowdd7 C
,ddC D
boolddE I
isAuthenticatedddJ Y
)ddY Z
{ee 

MainWindowff 

mainWindowff 
=ff 
awaitff  %

Dispatcherff& 0
.ff0 1
UIThreadff1 9
.ff9 :
InvokeAsyncff: E
(ffE F
(ffF G
)ffG H
=>ffI K
newffL O

MainWindowffP Z
{gg 	
DataContexthh 
=hh 
mainWindowViewModelhh -
}ii 	
)ii	 

;ii
 
ifkk 

(kk 
isAuthenticatedkk 
)kk 
{ll 	
Optionmm 
<mm 
IModulemm 
>mm 
mainModuleOptionmm ,
=mm- .
awaitmm/ 4
moduleManagermm5 B
.mmB C
LoadModuleAsyncmmC R
(mmR S
$strmmS Y
)mmY Z
.mmZ [
ConfigureAwaitmm[ i
(mmi j
falsemmj o
)mmo p
;mmp q
ifoo 
(oo 
!oo 
mainModuleOptionoo !
.oo! "
IsSomeoo" (
||oo) +
mainModuleOptionoo, <
.oo< =
Valueoo= B
!ooB C
.ooC D
ServiceScopeooD P
?ooP Q
.ooQ R
ServiceProviderooR a
==oob d
nullooe i
)ooi j
{pp 
throwqq 
newqq %
InvalidOperationExceptionqq 3
(qq3 4$
ApplicationErrorMessagesqq4 L
.qqL M
ApplicationRouterqqM ^
.rr 2
&FAILED_TO_LOAD_MAIN_MODULE_FROM_SPLASHrr ;
)rr; <
;rr< =
}ss 
IModuleuu 

mainModuleuu 
=uu  
mainModuleOptionuu! 1
.uu1 2
Valueuu2 7
!uu7 8
;uu8 9
MasterViewModelww 
?ww 
mainViewModelww *
=ww+ ,

mainModulexx 
.xx 
ServiceScopexx '
.xx' (
ServiceProviderxx( 7
.xx7 8

GetServicexx8 B
<xxB C
MasterViewModelxxC R
>xxR S
(xxS T
)xxT U
;xxU V
ifzz 
(zz 
mainViewModelzz 
==zz  
nullzz! %
)zz% &
{{{ 
throw|| 
new|| %
InvalidOperationException|| 3
(||3 4$
ApplicationErrorMessages||4 L
.||L M
ApplicationRouter||M ^
.}} ,
 FAILED_TO_CREATE_MAIN_VIEW_MODEL}} 5
)}}5 6
;}}6 7
}~~ 
await
€€ !
mainWindowViewModel
€€ %
.
€€% &!
SetMainContentAsync
€€& 9
(
€€9 :
mainViewModel
€€: G
)
€€G H
.
€€H I
ConfigureAwait
€€I W
(
€€W X
false
€€X ]
)
€€] ^
;
€€^ _
}
 	
else
‚‚ 
{
ƒƒ 	
Option
„„ 
<
„„ 
IModule
„„ 
>
„„ 
authModuleOption
„„ ,
=
„„- .
await
…… 
moduleManager
…… #
.
……# $
LoadModuleAsync
……$ 3
(
……3 4
$str
……4 D
)
……D E
.
……E F
ConfigureAwait
……F T
(
……T U
false
……U Z
)
……Z [
;
……[ \
if
‡‡ 
(
‡‡ 
!
‡‡ 
authModuleOption
‡‡ !
.
‡‡! "
IsSome
‡‡" (
||
‡‡) +
authModuleOption
‡‡, <
.
‡‡< =
Value
‡‡= B
!
‡‡B C
.
‡‡C D
ServiceScope
‡‡D P
?
‡‡P Q
.
‡‡Q R
ServiceProvider
‡‡R a
==
‡‡b d
null
‡‡e i
)
‡‡i j
{
ˆˆ 
throw
‰‰ 
new
‰‰ '
InvalidOperationException
‰‰ 3
(
‰‰3 4&
ApplicationErrorMessages
‰‰4 L
.
‰‰L M
ApplicationRouter
‰‰M ^
.
ŠŠ 4
&FAILED_TO_LOAD_AUTH_MODULE_FROM_SPLASH
ŠŠ ;
)
ŠŠ; <
;
ŠŠ< =
}
‹‹ 
IModule
 

authModule
 
=
  
authModuleOption
! 1
.
1 2
Value
2 7
!
7 8
;
8 9%
AuthenticationViewModel
 #
?
# $!
membershipViewModel
% 8
=
9 :

authModule
 
.
 
ServiceScope
 '
.
' (
ServiceProvider
( 7
.
7 8

GetService
8 B
<
B C%
AuthenticationViewModel
C Z
>
Z [
(
[ \
)
\ ]
;
] ^
if
’’ 
(
’’ !
membershipViewModel
’’ #
==
’’$ &
null
’’' +
)
’’+ ,
{
““ 
throw
”” 
new
”” '
InvalidOperationException
”” 3
(
””3 4&
ApplicationErrorMessages
””4 L
.
””L M
ApplicationRouter
””M ^
.
•• 4
&FAILED_TO_CREATE_MEMBERSHIP_VIEW_MODEL
•• ;
)
••; <
;
••< =
}
–– 
await
˜˜ !
mainWindowViewModel
˜˜ %
.
˜˜% &+
SetAuthenticationContentAsync
˜˜& C
(
˜˜C D!
membershipViewModel
˜˜D W
)
˜˜W X
.
˜˜X Y
ConfigureAwait
˜˜Y g
(
˜˜g h
false
˜˜h m
)
˜˜m n
;
˜˜n o
}
™™ 	
await
›› '
PrepareAndShowWindowAsync
›› '
(
››' (

mainWindow
››( 2
)
››2 3
.
››3 4
ConfigureAwait
››4 B
(
››B C
false
››C H
)
››H I
;
››I J
desktop
œœ 
.
œœ 

MainWindow
œœ 
=
œœ 

mainWindow
œœ '
;
œœ' (
await
 (
PerformFadeTransitionAsync
 (
(
( )
splashWindow
) 5
,
5 6

mainWindow
7 A
)
A B
.
B C
ConfigureAwait
C Q
(
Q R
false
R W
)
W X
;
X Y
}
žž 
private
   
static
   
async
   
Task
   '
PrepareAndShowWindowAsync
   7
(
  7 8
Window
  8 >
window
  ? E
)
  E F
{
¡¡ 
await
¢¢ 

Dispatcher
¢¢ 
.
¢¢ 
UIThread
¢¢ !
.
¢¢! "
InvokeAsync
¢¢" -
(
¢¢- .
(
¢¢. /
)
¢¢/ 0
=>
¢¢1 3
{
££ 	
window
¤¤ 
.
¤¤ #
WindowStartupLocation
¤¤ (
=
¤¤) *#
WindowStartupLocation
¤¤+ @
.
¤¤@ A
CenterScreen
¤¤A M
;
¤¤M N
window
¥¥ 
.
¥¥ 
Opacity
¥¥ 
=
¥¥ 
$num
¥¥ 
;
¥¥ 
window
¦¦ 
.
¦¦ 
Show
¦¦ 
(
¦¦ 
)
¦¦ 
;
¦¦ 
}
§§ 	
)
§§	 

;
§§
 
await
¨¨ 
Task
¨¨ 
.
¨¨ 
Delay
¨¨ 
(
¨¨ "
WINDOW_SHOW_DELAY_MS
¨¨ -
)
¨¨- .
.
¨¨. /
ConfigureAwait
¨¨/ =
(
¨¨= >
false
¨¨> C
)
¨¨C D
;
¨¨D E
}
©© 
private
«« 
async
«« 
Task
«« (
PerformFadeTransitionAsync
«« 1
(
««1 2
Window
««2 8

fromWindow
««9 C
,
««C D
Window
««E K
toWindow
««L T
)
««T U
{
¬¬ 
TimeSpan
­­ 
duration
­­ 
=
­­ 
TimeSpan
­­ $
.
­­$ %
FromMilliseconds
­­% 5
(
­­5 6
FADE_DURATION_MS
­­6 F
)
­­F G
;
­­G H
DateTime
®® 
start
®® 
=
®® 
DateTime
®® !
.
®®! "
UtcNow
®®" (
;
®®( )
while
°° 
(
°° 
DateTime
°° 
.
°° 
UtcNow
°° 
-
°°  
start
°°! &
<
°°' (
duration
°°) 1
)
°°1 2
{
±± 	
double
²² 
progress
²² 
=
²² 
(
²² 
DateTime
²² '
.
²²' (
UtcNow
²²( .
-
²²/ 0
start
²²1 6
)
²²6 7
.
²²7 8
TotalMilliseconds
²²8 I
/
²²J K
FADE_DURATION_MS
²²L \
;
²²\ ]
await
³³ 

Dispatcher
³³ 
.
³³ 
UIThread
³³ %
.
³³% &
InvokeAsync
³³& 1
(
³³1 2
(
³³2 3
)
³³3 4
=>
³³5 7
{
´´ 

fromWindow
µµ 
.
µµ 
Opacity
µµ "
=
µµ# $
$num
µµ% &
-
µµ' (
progress
µµ) 1
;
µµ1 2
toWindow
¶¶ 
.
¶¶ 
Opacity
¶¶  
=
¶¶! "
progress
¶¶# +
;
¶¶+ ,
}
·· 
)
·· 
;
·· 
await
¸¸ 
Task
¸¸ 
.
¸¸ 
Delay
¸¸ 
(
¸¸ 
FRAME_DELAY_MS
¸¸ +
)
¸¸+ ,
.
¸¸, -
ConfigureAwait
¸¸- ;
(
¸¸; <
false
¸¸< A
)
¸¸A B
;
¸¸B C
}
¹¹ 	
await
»» 

Dispatcher
»» 
.
»» 
UIThread
»» !
.
»»! "
InvokeAsync
»»" -
(
»»- .
(
»». /
)
»»/ 0
=>
»»1 3
{
¼¼ 	
try
½½ 
{
¾¾ 

fromWindow
¿¿ 
.
¿¿ 
Opacity
¿¿ "
=
¿¿# $
$num
¿¿% &
;
¿¿& '
toWindow
ÀÀ 
.
ÀÀ 
Opacity
ÀÀ  
=
ÀÀ! "
$num
ÀÀ# $
;
ÀÀ$ %
desktop
ÂÂ 
.
ÂÂ 

MainWindow
ÂÂ "
=
ÂÂ# $
toWindow
ÂÂ% -
;
ÂÂ- .

fromWindow
ÃÃ 
.
ÃÃ 
Hide
ÃÃ 
(
ÃÃ  
)
ÃÃ  !
;
ÃÃ! "

fromWindow
ÄÄ 
.
ÄÄ 
Close
ÄÄ  
(
ÄÄ  !
)
ÄÄ! "
;
ÄÄ" #
}
ÅÅ 
catch
ÆÆ 
{
ÇÇ 

fromWindow
ÈÈ 
.
ÈÈ 
Hide
ÈÈ 
(
ÈÈ  
)
ÈÈ  !
;
ÈÈ! "

fromWindow
ÉÉ 
.
ÉÉ 
Opacity
ÉÉ "
=
ÉÉ# $
$num
ÉÉ% &
;
ÉÉ& '
}
ÊÊ 
}
ËË 	
)
ËË	 

;
ËË
 
await
ÍÍ 
Task
ÍÍ 
.
ÍÍ 
Delay
ÍÍ 
(
ÍÍ 
$num
ÍÍ 
)
ÍÍ 
.
ÍÍ 
ConfigureAwait
ÍÍ ,
(
ÍÍ, -
false
ÍÍ- 2
)
ÍÍ2 3
;
ÍÍ3 4
bool
ÎÎ 
isStillVisible
ÎÎ 
=
ÎÎ 
await
ÎÎ #

Dispatcher
ÎÎ$ .
.
ÎÎ. /
UIThread
ÎÎ/ 7
.
ÎÎ7 8
InvokeAsync
ÎÎ8 C
(
ÎÎC D
(
ÎÎD E
)
ÎÎE F
=>
ÎÎG I

fromWindow
ÎÎJ T
.
ÎÎT U
	IsVisible
ÎÎU ^
)
ÎÎ^ _
;
ÎÎ_ `
if
ÐÐ 

(
ÐÐ 
isStillVisible
ÐÐ 
)
ÐÐ 
{
ÑÑ 	
await
ÒÒ 

Dispatcher
ÒÒ 
.
ÒÒ 
UIThread
ÒÒ %
.
ÒÒ% &
InvokeAsync
ÒÒ& 1
(
ÒÒ1 2
(
ÒÒ2 3
)
ÒÒ3 4
=>
ÒÒ5 7
{
ÓÓ 

fromWindow
ÔÔ 
.
ÔÔ 
Hide
ÔÔ 
(
ÔÔ  
)
ÔÔ  !
;
ÔÔ! "

fromWindow
ÕÕ 
.
ÕÕ 
Close
ÕÕ  
(
ÕÕ  !
)
ÕÕ! "
;
ÕÕ" #
}
ÖÖ 
)
ÖÖ 
;
ÖÖ 
}
×× 	
}
ØØ 
private
ÚÚ 
async
ÚÚ 
Task
ÚÚ *
EnsureAnonymousProtocolAsync
ÚÚ 3
(
ÚÚ3 4
)
ÚÚ4 5
{
ÛÛ 
Result
ÜÜ 
<
ÜÜ )
ApplicationInstanceSettings
ÜÜ *
,
ÜÜ* +'
InternalServiceApiFailure
ÜÜ, E
>
ÜÜE F
settingsResult
ÜÜG U
=
ÜÜV W
await
ÝÝ .
 applicationSecureStorageProvider
ÝÝ 2
.
ÝÝ2 31
#GetApplicationInstanceSettingsAsync
ÝÝ3 V
(
ÝÝV W
)
ÝÝW X
.
ÝÝX Y
ConfigureAwait
ÝÝY g
(
ÝÝg h
false
ÝÝh m
)
ÝÝm n
;
ÝÝn o
if
ßß 

(
ßß 
settingsResult
ßß 
.
ßß 
IsErr
ßß  
)
ßß  !
{
àà 	
return
áá 
;
áá 
}
ââ 	)
ApplicationInstanceSettings
ää #
settings
ää$ ,
=
ää- .
settingsResult
ää/ =
.
ää= >
Unwrap
ää> D
(
ääD E
)
ääE F
;
ääF G
if
ææ 

(
ææ 
settings
ææ 
.
ææ 

Membership
ææ 
!=
ææ  "
null
ææ# '
)
ææ' (
{
çç 	
return
èè 
;
èè 
}
éé 	
uint
ëë 
	connectId
ëë 
=
ëë 
NetworkProvider
ëë (
.
ëë( )$
ComputeUniqueConnectId
ëë) ?
(
ëë? @
settings
ëë@ H
,
ëëH I 
PubKeyExchangeType
ìì 
.
ìì (
DataCenterEphemeralConnect
ìì 9
)
ìì9 :
;
ìì: ;
if
îî 

(
îî 
networkProvider
îî 
.
îî 
HasConnection
îî )
(
îî) *
	connectId
îî* 3
)
îî3 4
)
îî4 5
{
ïï 	
return
ðð 
;
ðð 
}
ññ 	
networkProvider
óó 
.
óó ,
InitiateEcliptixProtocolSystem
óó 6
(
óó6 7
settings
óó7 ?
,
óó? @
	connectId
óóA J
)
óóJ K
;
óóK L
Result
õõ 
<
õõ "
EcliptixSessionState
õõ #
,
õõ# $
NetworkFailure
õõ% 3
>
õõ3 4
establishResult
õõ5 D
=
õõE F
await
öö 
networkProvider
öö !
.
öö! "*
EstablishSecrecyChannelAsync
öö" >
(
öö> ?
	connectId
öö? H
)
ööH I
.
ööI J
ConfigureAwait
ööJ X
(
ööX Y
false
ööY ^
)
öö^ _
;
öö_ `
if
øø 

(
øø 
establishResult
øø 
.
øø 
IsErr
øø !
)
øø! "
{
ùù 	
return
úú 
;
úú 
}
ûû 	
await
ýý !
RegisterDeviceAsync
ýý !
(
ýý! "
	connectId
ýý" +
,
ýý+ ,
settings
ýý- 5
)
ýý5 6
.
ýý6 7
ConfigureAwait
ýý7 E
(
ýýE F
false
ýýF K
)
ýýK L
;
ýýL M
}
þþ 
private
€€ 
async
€€ 
Task
€€ !
RegisterDeviceAsync
€€ *
(
€€* +
uint
€€+ /
	connectId
€€0 9
,
€€9 :)
ApplicationInstanceSettings
 #
settings
$ ,
)
, -
{
‚‚ 
	AppDevice
ƒƒ 
	appDevice
ƒƒ 
=
ƒƒ 
new
ƒƒ !
(
ƒƒ! "
)
ƒƒ" #
{
„„ 	
AppInstanceId
…… 
=
…… 
settings
…… $
.
……$ %
AppInstanceId
……% 2
,
……2 3
DeviceId
†† 
=
†† 
settings
†† 
.
††  
DeviceId
††  (
,
††( )

DeviceType
‡‡ 
=
‡‡ 
	AppDevice
‡‡ "
.
‡‡" #
Types
‡‡# (
.
‡‡( )

DeviceType
‡‡) 3
.
‡‡3 4
Desktop
‡‡4 ;
}
ˆˆ 	
;
ˆˆ	 

await
ŠŠ 
networkProvider
ŠŠ 
.
ŠŠ &
ExecuteUnaryRequestAsync
ŠŠ 6
(
ŠŠ6 7
	connectId
‹‹ 
,
‹‹ 
RpcServiceType
ŒŒ 
.
ŒŒ 
RegisterAppDevice
ŒŒ ,
,
ŒŒ, -%
SecureByteStringInterop
 #
.
# $"
WithByteStringAsSpan
$ 8
(
8 9
	appDevice
9 B
.
B C
ToByteString
C O
(
O P
)
P Q
,
Q R
span
ŽŽ 
=>
ŽŽ 
span
ŽŽ 
.
ŽŽ 
ToArray
ŽŽ $
(
ŽŽ$ %
)
ŽŽ% &
)
ŽŽ& '
,
ŽŽ' (
decryptedPayload
 
=>
 
{
 (
DeviceRegistrationResponse
‘‘ *
reply
‘‘+ 0
=
‘‘1 2
Helpers
’’ 
.
’’ 
ParseFromBytes
’’ *
<
’’* +(
DeviceRegistrationResponse
’’+ E
>
’’E F
(
’’F G
decryptedPayload
’’G W
)
’’W X
;
’’X Y
settings
”” 
.
”” 
ServerPublicKey
”” (
=
””) *%
SecureByteStringInterop
””+ B
.
””B C"
WithByteStringAsSpan
””C W
(
””W X
reply
””X ]
.
””] ^
ServerPublicKey
””^ m
,
””m n

ByteString
•• 
.
•• 
CopyFrom
•• '
)
••' (
;
••( )
return
—— 
Task
—— 
.
—— 

FromResult
—— &
(
——& '
Result
——' -
<
——- .
Unit
——. 2
,
——2 3
NetworkFailure
——4 B
>
——B C
.
——C D
Ok
——D F
(
——F G
Unit
——G K
.
——K L
Value
——L Q
)
——Q R
)
——R S
;
——S T
}
˜˜ 
,
˜˜ 
false
˜˜ 
,
˜˜ 
CancellationToken
˜˜ '
.
˜˜' (
None
˜˜( ,
)
˜˜, -
.
˜˜- .
ConfigureAwait
˜˜. <
(
˜˜< =
false
˜˜= B
)
˜˜B C
;
˜˜C D
}
™™ 
}šš êþ
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Core/ApplicationInitializer.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Core! %
;% &
public!! 
record!! "
InstanceSettingsResult!! $
(!!$ %'
ApplicationInstanceSettings!!% @
Settings!!A I
,!!I J
bool!!K O
IsNewInstance!!P ]
)!!] ^
;!!^ _
public## 
sealed## 
class## "
ApplicationInitializer## *
(##* +
NetworkProvider$$ 
networkProvider$$ #
,$$# $-
!IApplicationSecureStorageProvider%% %,
 applicationSecureStorageProvider%%& F
,%%F G'
ISecureProtocolStateStorage&& &
secureProtocolStateStorage&&  :
,&&: ; 
ILocalizationService'' 
localizationService'' ,
,'', -!
IIpGeolocationService((  
ipGeolocationService(( .
,((. /
IIdentityService)) 
identityService)) $
,))$ %$
IApplicationStateManager** 
stateManager** )
)**) *
:**+ ,#
IApplicationInitializer**- D
{++ 
private,, 
const,, 
int,, *
IP_GEOLOCATION_TIMEOUT_SECONDS,, 4
=,,5 6
$num,,7 9
;,,9 :
private.. 
readonly.. "
PendingLogoutProcessor.. +#
_pendingLogoutProcessor.., C
=..D E
new..F I
(..I J
networkProvider// 
,// 
new00 '
PendingLogoutRequestStorage00 '
(00' (,
 applicationSecureStorageProvider00( H
)00H I
)00I J
;00J K
public22 

async22 
Task22 
<22 
bool22 
>22 
InitializeAsync22 +
(22+ ,!
DefaultSystemSettings22, A!
defaultSystemSettings22B W
)22W X
{33 
Result44 
<44 "
InstanceSettingsResult44 %
,44% &%
InternalServiceApiFailure44' @
>44@ A
settingsResult44B P
=44Q R
await55 ,
 applicationSecureStorageProvider55 2
.552 30
$InitApplicationInstanceSettingsAsync553 W
(55W X!
defaultSystemSettings55X m
.55m n
Culture55n u
)55u v
.66 
ConfigureAwait66 
(66  
false66  %
)66% &
;66& '
if88 

(88 
settingsResult88 
.88 
IsErr88  
)88  !
{99 	
return:: 
false:: 
;:: 
};; 	
(== 	'
ApplicationInstanceSettings==	 $
settings==% -
,==- .
bool==/ 3
isNewInstance==4 A
)==A B
===C D
settingsResult==E S
.==S T
Unwrap==T Z
(==Z [
)==[ \
;==\ ]
_?? 	
=??
 
Task?? 
.?? 
Run?? 
(?? 
async?? 
(?? 
)?? 
=>??  
{@@ 	
awaitAA ,
 applicationSecureStorageProviderAA 2
.AA2 3'
SetApplicationInstanceAsyncAA3 N
(AAN O
isNewInstanceAAO \
)AA\ ]
.AA] ^
ConfigureAwaitAA^ l
(AAl m
falseAAm r
)AAr s
;AAs t
}BB 	
)BB	 

;BB
 
stringDD 
cultureDD 
=DD 
stringDD 
.DD  
IsNullOrEmptyDD  -
(DD- .
settingsDD. 6
.DD6 7
CultureDD7 >
)DD> ?
?EE '
AppCultureSettingsConstantsEE )
.EE) * 
DEFAULT_CULTURE_CODEEE* >
:FF 
settingsFF 
.FF 
CultureFF 
;FF 
localizationServiceGG 
.GG 

SetCultureGG &
(GG& '
cultureGG' .
)GG. /
;GG/ 0
ifII 

(II 
isNewInstanceII 
)II 
{JJ 	
_KK 
=KK /
#FetchIpGeolocationInBackgroundAsyncKK 3
(KK3 4
)KK4 5
.KK5 6
ContinueWithKK6 B
(KKB C
taskLL 
=>LL 
{MM 
ifNN 
(NN 
taskNN 
.NN 
	IsFaultedNN &
&&NN' )
taskNN* .
.NN. /
	ExceptionNN/ 8
!=NN9 ;
nullNN< @
)NN@ A
{OO 
SerilogPP 
.PP  
LogPP  #
.PP# $
ErrorPP$ )
(PP) *
taskPP* .
.PP. /
	ExceptionPP/ 8
,PP8 9
$strQQ c
)QQc d
;QQd e
}RR 
}SS 
,SS 
TaskSchedulerTT 
.TT 
DefaultTT %
)TT% &
;TT& '
}UU 	
ResultWW 
<WW 
uintWW 
,WW 
NetworkFailureWW #
>WW# $
connectIdResultWW% 4
=WW5 6
awaitXX %
EnsureSecrecyChannelAsyncXX +
(XX+ ,
settingsXX, 4
,XX4 5
isNewInstanceXX6 C
)XXC D
.XXD E
ConfigureAwaitXXE S
(XXS T
falseXXT Y
)XXY Z
;XXZ [
ifYY 

(YY 
connectIdResultYY 
.YY 
IsErrYY !
)YY! "
{ZZ 	
return[[ 
false[[ 
;[[ 
}\\ 	
uint^^ 
	connectId^^ 
=^^ 
connectIdResult^^ (
.^^( )
Unwrap^^) /
(^^/ 0
)^^0 1
;^^1 2
Result`` 
<`` 
Unit`` 
,`` 
NetworkFailure`` #
>``# $
registrationResult``% 7
=``8 9
awaitaa 
RegisterDeviceAsyncaa %
(aa% &
	connectIdaa& /
,aa/ 0
settingsaa1 9
)aa9 :
.aa: ;
ConfigureAwaitaa; I
(aaI J
falseaaJ O
)aaO P
;aaP Q
ifbb 

(bb 
registrationResultbb 
.bb 
IsErrbb $
)bb$ %
{cc 	
Logdd 
.dd 
Errordd 
(dd 
$strdd g
,ddg h
	connectIdee 
,ee 
registrationResultee -
.ee- .
	UnwrapErree. 7
(ee7 8
)ee8 9
.ee9 :
Messageee: A
)eeA B
;eeB C
returnff 
falseff 
;ff 
}gg 	
awaitii -
!ProcessPendingLogoutRequestsAsyncii /
(ii/ 0
	connectIdii0 9
)ii9 :
.ii: ;
ConfigureAwaitii; I
(iiI J
falseiiJ O
)iiO P
;iiP Q
returnkk 
truekk 
;kk 
}ll 
privatenn 
asyncnn 
Tasknn -
!ProcessPendingLogoutRequestsAsyncnn 8
(nn8 9
uintnn9 =
	connectIdnn> G
)nnG H
=>nnI K
awaitoo #
_pendingLogoutProcessoroo %
.oo% &%
ProcessPendingLogoutAsyncoo& ?
(oo? @
	connectIdoo@ I
)ooI J
.ooJ K
ConfigureAwaitooK Y
(ooY Z
falseooZ _
)oo_ `
;oo` a
privateqq 
Taskqq /
#FetchIpGeolocationInBackgroundAsyncqq 4
(qq4 5
)qq5 6
=>qq7 9
Taskrr 
.rr 
Runrr 
(rr 
asyncrr 
(rr 
)rr 
=>rr 
{ss 	
usingtt #
CancellationTokenSourcett )
ctstt* -
=tt. /
newtt0 3
(tt3 4
TimeSpantt4 <
.tt< =
FromSecondstt= H
(ttH I*
IP_GEOLOCATION_TIMEOUT_SECONDSttI g
)ttg h
)tth i
;tti j
Resultuu 
<uu 
	IpCountryuu 
,uu %
InternalServiceApiFailureuu 7
>uu7 8
countryResultuu9 F
=uuG H
awaitvv  
ipGeolocationServicevv *
.vv* +
GetIpCountryAsyncvv+ <
(vv< =
ctsvv= @
.vv@ A
TokenvvA F
)vvF G
.vvG H
ConfigureAwaitvvH V
(vvV W
falsevvW \
)vv\ ]
;vv] ^
ifxx 
(xx 
countryResultxx 
.xx 
IsOkxx "
)xx" #
{yy 
	IpCountryzz 
countryzz !
=zz" #
countryResultzz$ 1
.zz1 2
Unwrapzz2 8
(zz8 9
)zz9 :
;zz: ;
networkProvider{{ 
.{{  

SetCountry{{  *
({{* +
country{{+ 2
.{{2 3
Country{{3 :
){{: ;
;{{; <
await|| ,
 applicationSecureStorageProvider|| 6
.||6 7(
SetApplicationIpCountryAsync||7 S
(||S T
country||T [
)||[ \
.||\ ]
ConfigureAwait||] k
(||k l
false||l q
)||q r
;||r s
}}} 
}~~ 	
)~~	 

;~~
 
private
€€ 
async
€€ 
Task
€€ 
<
€€ 
Result
€€ 
<
€€ 
uint
€€ "
,
€€" #
NetworkFailure
€€$ 2
>
€€2 3
>
€€3 4'
EnsureSecrecyChannelAsync
€€5 N
(
€€N O)
ApplicationInstanceSettings
 #)
applicationInstanceSettings
$ ?
,
? @
bool
A E
isNewInstance
F S
)
S T
{
‚‚ 
uint
ƒƒ 
	connectId
ƒƒ 
=
ƒƒ 
NetworkProvider
„„ 
.
„„ $
ComputeUniqueConnectId
„„ 2
(
„„2 3)
applicationInstanceSettings
„„3 N
,
„„N O 
PubKeyExchangeType
…… "
.
……" #(
DataCenterEphemeralConnect
……# =
)
……= >
;
……> ?
string
‡‡ 
?
‡‡ 
membershipId
‡‡ 
=
‡‡ !
ExtractMembershipId
‡‡ 2
(
‡‡2 3)
applicationInstanceSettings
‡‡3 N
)
‡‡N O
;
‡‡O P
if
‰‰ 

(
‰‰ 
!
‰‰ 
isNewInstance
‰‰ 
)
‰‰ 
{
ŠŠ 	
Result
‹‹ 
<
‹‹ 
uint
‹‹ 
,
‹‹ 
NetworkFailure
‹‹ '
>
‹‹' (
?
‹‹( )
restoreResult
‹‹* 7
=
‹‹8 9
await
ŒŒ ,
TryRestoreExistingSessionAsync
ŒŒ 4
(
ŒŒ4 5
	connectId
ŒŒ5 >
,
ŒŒ> ?)
applicationInstanceSettings
ŒŒ@ [
,
ŒŒ[ \
membershipId
ŒŒ] i
)
ŒŒi j
.
 
ConfigureAwait
 #
(
# $
false
$ )
)
) *
;
* +
if
 
(
 
restoreResult
 
.
 
HasValue
 &
)
& '
{
 
return
‘‘ 
restoreResult
‘‘ $
.
‘‘$ %
Value
‘‘% *
;
‘‘* +
}
’’ 
}
““ 	
return
•• 
await
•• -
EstablishNewSecrecyChannelAsync
•• 4
(
••4 5)
applicationInstanceSettings
••5 P
,
••P Q
	connectId
••R [
,
••[ \
membershipId
••] i
)
••i j
.
–– 
ConfigureAwait
–– 
(
–– 
false
–– !
)
––! "
;
––" #
}
—— 
private
™™ 
static
™™ 
string
™™ 
?
™™ !
ExtractMembershipId
™™ .
(
™™. /)
ApplicationInstanceSettings
™™/ J)
applicationInstanceSettings
™™K f
)
™™f g
{
šš 
if
›› 

(
›› )
applicationInstanceSettings
›› '
.
››' (

Membership
››( 2
?
››2 3
.
››3 4
UniqueIdentifier
››4 D
is
››E G
{
››H I
IsEmpty
››J Q
:
››Q R
false
››S X
}
››Y Z
)
››Z [
{
œœ 	
return
 
Helpers
 
.
 "
FromByteStringToGuid
 /
(
/ 0)
applicationInstanceSettings
0 K
.
K L

Membership
L V
.
V W
UniqueIdentifier
W g
)
g h
.
h i
ToString
i q
(
q r
)
r s
;
s t
}
žž 	
return
   
null
   
;
   
}
¡¡ 
private
££ 
async
££ 
Task
££ 
<
££ 
Result
££ 
<
££ 
uint
££ "
,
££" #
NetworkFailure
££$ 2
>
££2 3
?
££3 4
>
££4 5,
TryRestoreExistingSessionAsync
££6 T
(
££T U
uint
¤¤ 
	connectId
¤¤ 
,
¤¤ )
ApplicationInstanceSettings
¥¥ #)
applicationInstanceSettings
¥¥$ ?
,
¥¥? @
string
¦¦ 
?
¦¦ 
membershipId
¦¦ 
)
¦¦ 
{
§§ 
Result
¨¨ 
<
¨¨ 
bool
¨¨ 
,
¨¨ 
NetworkFailure
¨¨ #
>
¨¨# $
restoreResult
¨¨% 2
=
¨¨3 4
await
©© )
TryRestoreSessionStateAsync
©© -
(
©©- .
	connectId
©©. 7
,
©©7 8)
applicationInstanceSettings
©©9 T
)
©©T U
.
©©U V
ConfigureAwait
©©V d
(
©©d e
false
©©e j
)
©©j k
;
©©k l
if
«« 

(
«« 
restoreResult
«« 
.
«« 
IsErr
«« 
)
««  
{
¬¬ 	
return
­­ 
Result
­­ 
<
­­ 
uint
­­ 
,
­­ 
NetworkFailure
­­  .
>
­­. /
.
­­/ 0
Err
­­0 3
(
­­3 4
restoreResult
­­4 A
.
­­A B
	UnwrapErr
­­B K
(
­­K L
)
­­L M
)
­­M N
;
­­N O
}
®® 	
if
°° 

(
°° 
!
°° 
restoreResult
°° 
.
°° 
Unwrap
°° !
(
°°! "
)
°°" #
)
°°# $
{
±± 	
return
²² 
null
²² 
;
²² 
}
³³ 	
if
µµ 

(
µµ 
!
µµ 
string
µµ 
.
µµ 
IsNullOrEmpty
µµ !
(
µµ! "
membershipId
µµ" .
)
µµ. /
&&
µµ0 2
await
¶¶ 
identityService
¶¶ !
.
¶¶! "$
HasStoredIdentityAsync
¶¶" 8
(
¶¶8 9
membershipId
¶¶9 E
)
¶¶E F
.
¶¶F G
ConfigureAwait
¶¶G U
(
¶¶U V
false
¶¶V [
)
¶¶[ \
)
¶¶\ ]
{
·· 	
await
¸¸ 
stateManager
¸¸ 
.
¸¸ ,
TransitionToAuthenticatedAsync
¸¸ =
(
¸¸= >
membershipId
¸¸> J
)
¸¸J K
.
¸¸K L
ConfigureAwait
¸¸L Z
(
¸¸Z [
false
¸¸[ `
)
¸¸` a
;
¸¸a b
}
¹¹ 	
return
»» 
Result
»» 
<
»» 
uint
»» 
,
»» 
NetworkFailure
»» *
>
»»* +
.
»»+ ,
Ok
»», .
(
»». /
	connectId
»»/ 8
)
»»8 9
;
»»9 :
}
¼¼ 
private
¾¾ 
async
¾¾ 
Task
¾¾ 
<
¾¾ 
Result
¾¾ 
<
¾¾ 
uint
¾¾ "
,
¾¾" #
NetworkFailure
¾¾$ 2
>
¾¾2 3
>
¾¾3 4-
EstablishNewSecrecyChannelAsync
¾¾5 T
(
¾¾T U)
ApplicationInstanceSettings
¿¿ #)
applicationInstanceSettings
¿¿$ ?
,
¿¿? @
uint
ÀÀ 
	connectId
ÀÀ 
,
ÀÀ 
string
ÁÁ 
?
ÁÁ 
membershipId
ÁÁ 
)
ÁÁ 
{
ÂÂ 
Option
ÃÃ 
<
ÃÃ &
SodiumSecureMemoryHandle
ÃÃ '
>
ÃÃ' (
masterKeyHandle
ÃÃ) 8
=
ÃÃ9 :
await
ÄÄ )
PrepareMasterKeyHandleAsync
ÄÄ -
(
ÄÄ- .
membershipId
ÄÄ. :
,
ÄÄ: ;)
applicationInstanceSettings
ÄÄ< W
)
ÄÄW X
.
ÅÅ 
ConfigureAwait
ÅÅ 
(
ÅÅ  
false
ÅÅ  %
)
ÅÅ% &
;
ÅÅ& '
try
ÇÇ 
{
ÈÈ 	
bool
ÉÉ ,
shouldUseAuthenticatedProtocol
ÉÉ /
=
ÉÉ0 1
masterKeyHandle
ÉÉ2 A
.
ÉÉA B
IsSome
ÉÉB H
;
ÉÉH I
if
ËË 
(
ËË ,
shouldUseAuthenticatedProtocol
ËË .
)
ËË. /
{
ÌÌ 
Result
ÍÍ 
<
ÍÍ 
uint
ÍÍ 
,
ÍÍ 
NetworkFailure
ÍÍ +
>
ÍÍ+ ,
?
ÍÍ, -!
authenticatedResult
ÍÍ. A
=
ÍÍB C
await
ÎÎ .
 TryUseAuthenticatedProtocolAsync
ÎÎ :
(
ÎÎ: ;)
applicationInstanceSettings
ÏÏ 7
,
ÏÏ7 8
	connectId
ÐÐ %
,
ÐÐ% &
membershipId
ÑÑ (
!
ÑÑ( )
,
ÑÑ) *
masterKeyHandle
ÒÒ +
.
ÒÒ+ ,
Value
ÒÒ, 1
!
ÒÒ1 2
)
ÒÒ2 3
.
ÓÓ 
ConfigureAwait
ÓÓ '
(
ÓÓ' (
false
ÓÓ( -
)
ÓÓ- .
;
ÓÓ. /
if
ÕÕ 
(
ÕÕ !
authenticatedResult
ÕÕ '
.
ÕÕ' (
HasValue
ÕÕ( 0
)
ÕÕ0 1
{
ÖÖ 
return
×× !
authenticatedResult
×× .
.
××. /
Value
××/ 4
;
××4 5
}
ØØ 
}
ÙÙ 
await
ÛÛ 4
&InitializeProtocolWithoutIdentityAsync
ÛÛ 8
(
ÛÛ8 9)
applicationInstanceSettings
ÛÛ9 T
,
ÛÛT U
	connectId
ÛÛV _
)
ÛÛ_ `
.
ÜÜ 
ConfigureAwait
ÜÜ 
(
ÜÜ  
false
ÜÜ  %
)
ÜÜ% &
;
ÜÜ& '
byte
ÞÞ 
[
ÞÞ 
]
ÞÞ 
?
ÞÞ 
membershipIdBytes
ÞÞ %
=
ÞÞ& ')
applicationInstanceSettings
ÞÞ( C
.
ÞÞC D

Membership
ÞÞD N
?
ÞÞN O
.
ÞÞO P
UniqueIdentifier
ÞÞP `
?
ÞÞ` a
.
ÞÞa b
ToByteArray
ÞÞb m
(
ÞÞm n
)
ÞÞn o
;
ÞÞo p
return
ßß 
await
ßß 1
#EstablishAndSaveSecrecyChannelAsync
ßß <
(
ßß< =
	connectId
ßß= F
,
ßßF G
membershipIdBytes
ßßH Y
)
ßßY Z
.
ßßZ [
ConfigureAwait
ßß[ i
(
ßßi j
false
ßßj o
)
ßßo p
;
ßßp q
}
àà 	
finally
áá 
{
ââ 	
masterKeyHandle
ãã 
.
ãã 
Do
ãã 
(
ãã 
handle
ãã %
=>
ãã& (
handle
ãã) /
.
ãã/ 0
Dispose
ãã0 7
(
ãã7 8
)
ãã8 9
)
ãã9 :
;
ãã: ;
}
ää 	
}
åå 
private
çç 
async
çç 
Task
çç 
<
çç 
Option
çç 
<
çç &
SodiumSecureMemoryHandle
çç 6
>
çç6 7
>
çç7 8)
PrepareMasterKeyHandleAsync
çç9 T
(
ççT U
string
èè 
?
èè 
membershipId
èè 
,
èè )
ApplicationInstanceSettings
éé #)
applicationInstanceSettings
éé$ ?
)
éé? @
{
êê 
if
ëë 

(
ëë 
string
ëë 
.
ëë 
IsNullOrEmpty
ëë  
(
ëë  !
membershipId
ëë! -
)
ëë- .
)
ëë. /
{
ìì 	
return
íí 
Option
íí 
<
íí &
SodiumSecureMemoryHandle
íí 2
>
íí2 3
.
íí3 4
None
íí4 8
;
íí8 9
}
îî 	
bool
ðð 
hasStoredIdentity
ðð 
=
ðð  
await
ðð! &
identityService
ðð' 6
.
ðð6 7$
HasStoredIdentityAsync
ðð7 M
(
ððM N
membershipId
ððN Z
)
ððZ [
.
ðð[ \
ConfigureAwait
ðð\ j
(
ððj k
false
ððk p
)
ððp q
;
ððq r
if
ññ 

(
ññ 
!
ññ 
hasStoredIdentity
ññ 
)
ññ 
{
òò 	
return
óó 
Option
óó 
<
óó &
SodiumSecureMemoryHandle
óó 2
>
óó2 3
.
óó3 4
None
óó4 8
;
óó8 9
}
ôô 	
return
öö 
await
öö *
TryReconstructMasterKeyAsync
öö 1
(
öö1 2
membershipId
öö2 >
,
öö> ?)
applicationInstanceSettings
öö@ [
)
öö[ \
.
÷÷ 
ConfigureAwait
÷÷ 
(
÷÷ 
false
÷÷ !
)
÷÷! "
;
÷÷" #
}
øø 
private
úú 
async
úú 
Task
úú 
<
úú 
Result
úú 
<
úú 
uint
úú "
,
úú" #
NetworkFailure
úú$ 2
>
úú2 3
?
úú3 4
>
úú4 5.
 TryUseAuthenticatedProtocolAsync
úú6 V
(
úúV W)
ApplicationInstanceSettings
ûû #)
applicationInstanceSettings
ûû$ ?
,
ûû? @
uint
üü 
	connectId
üü 
,
üü 
string
ýý 
membershipId
ýý 
,
ýý &
SodiumSecureMemoryHandle
þþ  
masterKeyHandle
þþ! 0
)
þþ0 1
{
ÿÿ 
if
€€ 

(
€€ )
applicationInstanceSettings
€€ '
.
€€' (

Membership
€€( 2
?
€€2 3
.
€€3 4
UniqueIdentifier
€€4 D
==
€€E G
null
€€H L
)
€€L M
{
 	
return
‚‚ 
Result
‚‚ 
<
‚‚ 
uint
‚‚ 
,
‚‚ 
NetworkFailure
‚‚  .
>
‚‚. /
.
‚‚/ 0
Err
‚‚0 3
(
‚‚3 4
NetworkFailure
ƒƒ 
.
ƒƒ  
InvalidRequestType
ƒƒ 1
(
ƒƒ1 2
$str
„„ R
)
„„R S
)
„„S T
;
„„T U
}
…… 	

ByteString
‡‡ "
membershipByteString
‡‡ '
=
‡‡( ))
applicationInstanceSettings
‡‡* E
.
‡‡E F

Membership
‡‡F P
.
‡‡P Q
UniqueIdentifier
‡‡Q a
;
‡‡a b
Result
‰‰ 
<
‰‰ 
Unit
‰‰ 
,
‰‰ 
NetworkFailure
‰‰ #
>
‰‰# $
recreateResult
‰‰% 3
=
‰‰4 5
await
ŠŠ 
networkProvider
ŠŠ !
.
ŠŠ! "0
"RecreateProtocolWithMasterKeyAsync
ŠŠ" D
(
ŠŠD E
masterKeyHandle
‹‹ 
,
‹‹  "
membershipByteString
‹‹! 5
,
‹‹5 6
	connectId
‹‹7 @
)
‹‹@ A
.
‹‹A B
ConfigureAwait
‹‹B P
(
‹‹P Q
false
‹‹Q V
)
‹‹V W
;
‹‹W X
if
 

(
 
recreateResult
 
.
 
IsErr
  
)
  !
{
ŽŽ 	
await
 5
'HandleAuthenticatedProtocolFailureAsync
 9
(
9 :
recreateResult
: H
.
H I
	UnwrapErr
I R
(
R S
)
S T
,
T U
membershipId
V b
,
b c)
applicationInstanceSettings
 /
,
/ 0
	connectId
1 :
)
: ;
.
‘‘ 
ConfigureAwait
‘‘ 
(
‘‘  
false
‘‘  %
)
‘‘% &
;
‘‘& '
return
’’ 
null
’’ 
;
’’ 
}
““ 	
await
•• 
stateManager
•• 
.
•• ,
TransitionToAuthenticatedAsync
•• 9
(
••9 :
membershipId
••: F
)
••F G
.
••G H
ConfigureAwait
••H V
(
••V W
false
••W \
)
••\ ]
;
••] ^
return
–– 
Result
–– 
<
–– 
uint
–– 
,
–– 
NetworkFailure
–– *
>
––* +
.
––+ ,
Ok
––, .
(
––. /
	connectId
––/ 8
)
––8 9
;
––9 :
}
—— 
private
™™ 
async
™™ 
Task
™™ 5
'HandleAuthenticatedProtocolFailureAsync
™™ >
(
™™> ?
NetworkFailure
šš 
failure
šš 
,
šš 
string
›› 
membershipId
›› 
,
›› )
ApplicationInstanceSettings
œœ #)
applicationInstanceSettings
œœ$ ?
,
œœ? @
uint
 
	connectId
 
)
 
{
žž 
if
ŸŸ 

(
ŸŸ 
failure
ŸŸ 
.
ŸŸ 
FailureType
ŸŸ 
==
ŸŸ  " 
NetworkFailureType
ŸŸ# 5
.
ŸŸ5 6-
CRITICAL_AUTHENTICATION_FAILURE
ŸŸ6 U
)
ŸŸU V
{
   	
await
¡¡ /
!CleanupCorruptedIdentityDataAsync
¡¡ 3
(
¡¡3 4
membershipId
¡¡4 @
,
¡¡@ A)
applicationInstanceSettings
¡¡B ]
)
¡¡] ^
.
¢¢ 
ConfigureAwait
¢¢ 
(
¢¢  
false
¢¢  %
)
¢¢% &
;
¢¢& '
}
££ 	
await
¥¥ 4
&InitializeProtocolWithoutIdentityAsync
¥¥ 4
(
¥¥4 5)
applicationInstanceSettings
¥¥5 P
,
¥¥P Q
	connectId
¥¥R [
)
¥¥[ \
.
¦¦ 
ConfigureAwait
¦¦ 
(
¦¦ 
false
¦¦ !
)
¦¦! "
;
¦¦" #
}
§§ 
private
©© 
async
©© 
Task
©© 
<
©© 
Result
©© 
<
©© 
uint
©© "
,
©©" #
NetworkFailure
©©$ 2
>
©©2 3
>
©©3 41
#EstablishAndSaveSecrecyChannelAsync
©©5 X
(
©©X Y
uint
©©Y ]
	connectId
©©^ g
,
©©g h
byte
ªª 
[
ªª 
]
ªª 
?
ªª 
membershipId
ªª 
)
ªª 
{
«« 
Result
¬¬ 
<
¬¬ "
EcliptixSessionState
¬¬ #
,
¬¬# $
NetworkFailure
¬¬% 3
>
¬¬3 4
establishResult
¬¬5 D
=
¬¬E F
await
­­ 
networkProvider
­­ !
.
­­! "*
EstablishSecrecyChannelAsync
­­" >
(
­­> ?
	connectId
­­? H
)
­­H I
.
­­I J
ConfigureAwait
­­J X
(
­­X Y
false
­­Y ^
)
­­^ _
;
­­_ `
if
¯¯ 

(
¯¯ 
establishResult
¯¯ 
.
¯¯ 
IsErr
¯¯ !
)
¯¯! "
{
°° 	
return
±± 
Result
±± 
<
±± 
uint
±± 
,
±± 
NetworkFailure
±±  .
>
±±. /
.
±±/ 0
Err
±±0 3
(
±±3 4
establishResult
±±4 C
.
±±C D
	UnwrapErr
±±D M
(
±±M N
)
±±N O
)
±±O P
;
±±P Q
}
²² 	"
EcliptixSessionState
´´ !
secrecyChannelState
´´ 0
=
´´1 2
establishResult
´´3 B
.
´´B C
Unwrap
´´C I
(
´´I J
)
´´J K
;
´´K L
if
¶¶ 

(
¶¶ 
membershipId
¶¶ 
!=
¶¶ 
null
¶¶  
)
¶¶  !
{
·· 	
await
¸¸ %
SecureByteStringInterop
¸¸ )
.
¸¸) *"
WithByteStringAsSpan
¸¸* >
(
¸¸> ?!
secrecyChannelState
¹¹ '
.
¹¹' (
ToByteString
¹¹( 4
(
¹¹4 5
)
¹¹5 6
,
¹¹6 7
span
ºº 
=>
ºº (
secureProtocolStateStorage
ºº 6
.
ºº6 7
SaveStateAsync
ºº7 E
(
ººE F
span
ººF J
.
ººJ K
ToArray
ººK R
(
ººR S
)
ººS T
,
ººT U
	connectId
ººV _
.
ºº_ `
ToString
ºº` h
(
ººh i
)
ººi j
,
ººj k
membershipId
»» $
)
»»$ %
)
»»% &
.
¼¼ 
ConfigureAwait
¼¼ 
(
¼¼  
false
¼¼  %
)
¼¼% &
;
¼¼& '
}
½½ 	
return
¿¿ 
Result
¿¿ 
<
¿¿ 
uint
¿¿ 
,
¿¿ 
NetworkFailure
¿¿ *
>
¿¿* +
.
¿¿+ ,
Ok
¿¿, .
(
¿¿. /
	connectId
¿¿/ 8
)
¿¿8 9
;
¿¿9 :
}
ÀÀ 
private
ÂÂ 
async
ÂÂ 
Task
ÂÂ 4
&InitializeProtocolWithoutIdentityAsync
ÂÂ =
(
ÂÂ= >)
ApplicationInstanceSettings
ÃÃ #)
applicationInstanceSettings
ÃÃ$ ?
,
ÃÃ? @
uint
ÄÄ 
	connectId
ÄÄ 
)
ÄÄ 
{
ÅÅ 
await
ÆÆ 
stateManager
ÆÆ 
.
ÆÆ (
TransitionToAnonymousAsync
ÆÆ 5
(
ÆÆ5 6
)
ÆÆ6 7
.
ÆÆ7 8
ConfigureAwait
ÆÆ8 F
(
ÆÆF G
false
ÆÆG L
)
ÆÆL M
;
ÆÆM N
if
ÈÈ 

(
ÈÈ )
applicationInstanceSettings
ÈÈ '
.
ÈÈ' (

Membership
ÈÈ( 2
!=
ÈÈ3 5
null
ÈÈ6 :
)
ÈÈ: ;
{
ÉÉ 	
await
ÊÊ .
 applicationSecureStorageProvider
ÊÊ 2
.
ÊÊ2 3+
SetApplicationMembershipAsync
ÊÊ3 P
(
ÊÊP Q
null
ÊÊQ U
)
ÊÊU V
.
ÊÊV W
ConfigureAwait
ÊÊW e
(
ÊÊe f
false
ÊÊf k
)
ÊÊk l
;
ÊÊl m)
applicationInstanceSettings
ÌÌ '
.
ÌÌ' (

Membership
ÌÌ( 2
=
ÌÌ3 4
null
ÌÌ5 9
;
ÌÌ9 :
}
ÍÍ 	
networkProvider
ÏÏ 
.
ÏÏ ,
InitiateEcliptixProtocolSystem
ÏÏ 6
(
ÏÏ6 7)
applicationInstanceSettings
ÏÏ7 R
,
ÏÏR S
	connectId
ÏÏT ]
)
ÏÏ] ^
;
ÏÏ^ _
}
ÐÐ 
private
ÒÒ 
async
ÒÒ 
Task
ÒÒ 
<
ÒÒ 
Result
ÒÒ 
<
ÒÒ 
bool
ÒÒ "
,
ÒÒ" #
NetworkFailure
ÒÒ$ 2
>
ÒÒ2 3
>
ÒÒ3 4)
TryRestoreSessionStateAsync
ÒÒ5 P
(
ÒÒP Q
uint
ÓÓ 
	connectId
ÓÓ 
,
ÓÓ )
ApplicationInstanceSettings
ÔÔ #)
applicationInstanceSettings
ÔÔ$ ?
)
ÔÔ? @
{
ÕÕ 
byte
ÖÖ 
[
ÖÖ 
]
ÖÖ 
?
ÖÖ 
membershipId
ÖÖ 
=
ÖÖ )
applicationInstanceSettings
ÖÖ :
.
ÖÖ: ;

Membership
ÖÖ; E
?
ÖÖE F
.
ÖÖF G
UniqueIdentifier
ÖÖG W
?
ÖÖW X
.
ÖÖX Y
ToByteArray
ÖÖY d
(
ÖÖd e
)
ÖÖe f
;
ÖÖf g
if
×× 

(
×× 
membershipId
×× 
==
×× 
null
××  
)
××  !
{
ØØ 	
return
ÙÙ 
Result
ÙÙ 
<
ÙÙ 
bool
ÙÙ 
,
ÙÙ 
NetworkFailure
ÙÙ  .
>
ÙÙ. /
.
ÙÙ/ 0
Ok
ÙÙ0 2
(
ÙÙ2 3
false
ÙÙ3 8
)
ÙÙ8 9
;
ÙÙ9 :
}
ÚÚ 	
Result
ÜÜ 
<
ÜÜ 
byte
ÜÜ 
[
ÜÜ 
]
ÜÜ 
,
ÜÜ "
SecureStorageFailure
ÜÜ +
>
ÜÜ+ ,

loadResult
ÜÜ- 7
=
ÜÜ8 9
await
ÝÝ (
secureProtocolStateStorage
ÝÝ ,
.
ÝÝ, -
LoadStateAsync
ÝÝ- ;
(
ÝÝ; <
	connectId
ÝÝ< E
.
ÝÝE F
ToString
ÝÝF N
(
ÝÝN O
)
ÝÝO P
,
ÝÝP Q
membershipId
ÝÝR ^
)
ÝÝ^ _
.
ÝÝ_ `
ConfigureAwait
ÝÝ` n
(
ÝÝn o
false
ÝÝo t
)
ÝÝt u
;
ÝÝu v
if
ßß 

(
ßß 

loadResult
ßß 
.
ßß 
IsErr
ßß 
)
ßß 
{
àà 	
return
áá 
Result
áá 
<
áá 
bool
áá 
,
áá 
NetworkFailure
áá  .
>
áá. /
.
áá/ 0
Ok
áá0 2
(
áá2 3
false
áá3 8
)
áá8 9
;
áá9 :
}
ââ 	
byte
ää 
[
ää 
]
ää 

stateBytes
ää 
=
ää 

loadResult
ää &
.
ää& '
Unwrap
ää' -
(
ää- .
)
ää. /
;
ää/ 0"
EcliptixSessionState
ææ 
?
ææ 
state
ææ #
;
ææ# $
try
çç 
{
èè 	
state
éé 
=
éé "
EcliptixSessionState
éé (
.
éé( )
Parser
éé) /
.
éé/ 0
	ParseFrom
éé0 9
(
éé9 :

stateBytes
éé: D
)
ééD E
;
ééE F
}
êê 	
catch
ëë 
(
ëë ,
InvalidProtocolBufferException
ëë -
ex
ëë. 0
)
ëë0 1
{
ìì 	
networkProvider
íí 
.
íí 
ClearConnection
íí +
(
íí+ ,
	connectId
íí, 5
)
íí5 6
;
íí6 7
Result
îî 
<
îî 
Unit
îî 
,
îî "
SecureStorageFailure
îî -
>
îî- .%
deleteSecureStateResult
îî/ F
=
îîG H
await
ïï (
secureProtocolStateStorage
ïï 0
.
ïï0 1
DeleteStateAsync
ïï1 A
(
ïïA B
	connectId
ïïB K
.
ïïK L
ToString
ïïL T
(
ïïT U
)
ïïU V
)
ïïV W
.
ïïW X
ConfigureAwait
ïïX f
(
ïïf g
false
ïïg l
)
ïïl m
;
ïïm n
if
ðð 
(
ðð %
deleteSecureStateResult
ðð '
.
ðð' (
IsErr
ðð( -
)
ðð- .
{
ññ 
Log
òò 
.
òò 
Warning
òò 
(
òò 
ex
òò 
,
òò 
$str
óó w
,
óów x
	connectId
ôô 
,
ôô %
deleteSecureStateResult
ôô 6
.
ôô6 7
	UnwrapErr
ôô7 @
(
ôô@ A
)
ôôA B
.
ôôB C
Message
ôôC J
)
ôôJ K
;
ôôK L
}
õõ 
return
÷÷ 
Result
÷÷ 
<
÷÷ 
bool
÷÷ 
,
÷÷ 
NetworkFailure
÷÷  .
>
÷÷. /
.
÷÷/ 0
Ok
÷÷0 2
(
÷÷2 3
false
÷÷3 8
)
÷÷8 9
;
÷÷9 :
}
øø 	
string
úú  
membershipIdString
úú !
=
úú" #%
SecureByteStringInterop
úú$ ;
.
úú; <"
WithByteStringAsSpan
úú< P
(
úúP Q)
applicationInstanceSettings
ûû '
.
ûû' (

Membership
ûû( 2
!
ûû2 3
.
ûû3 4
UniqueIdentifier
ûû4 D
!
ûûD E
,
ûûE F
span
üü 
=>
üü 
new
üü 
Guid
üü 
(
üü 
span
üü !
.
üü! "
ToArray
üü" )
(
üü) *
)
üü* +
)
üü+ ,
.
üü, -
ToString
üü- 5
(
üü5 6
)
üü6 7
)
üü7 8
;
üü8 9
bool
þþ  
hasRevocationProof
þþ 
=
þþ  !
await
þþ" '
LogoutService
þþ( 5
.
þþ5 6%
HasRevocationProofAsync
þþ6 M
(
þþM N.
 applicationSecureStorageProvider
ÿÿ ,
,
ÿÿ, - 
membershipIdString
€€ 
)
€€ 
.
€€  
ConfigureAwait
€€  .
(
€€. /
false
€€/ 4
)
€€4 5
;
€€5 6
if
‚‚ 

(
‚‚  
hasRevocationProof
‚‚ 
)
‚‚ 
{
ƒƒ 	
networkProvider
„„ 
.
„„ 
ClearConnection
„„ +
(
„„+ ,
	connectId
„„, 5
)
„„5 6
;
„„6 7
await
…… (
secureProtocolStateStorage
…… ,
.
……, -
DeleteStateAsync
……- =
(
……= >
	connectId
……> G
.
……G H
ToString
……H P
(
……P Q
)
……Q R
)
……R S
.
……S T
ConfigureAwait
……T b
(
……b c
false
……c h
)
……h i
;
……i j
return
‡‡ 
Result
‡‡ 
<
‡‡ 
bool
‡‡ 
,
‡‡ 
NetworkFailure
‡‡  .
>
‡‡. /
.
‡‡/ 0
Ok
‡‡0 2
(
‡‡2 3
false
‡‡3 8
)
‡‡8 9
;
‡‡9 :
}
ˆˆ 	
Result
ŠŠ 
<
ŠŠ 
bool
ŠŠ 
,
ŠŠ 
NetworkFailure
ŠŠ #
>
ŠŠ# $
restoreResult
ŠŠ% 2
=
ŠŠ3 4
await
‹‹ 
networkProvider
‹‹ !
.
‹‹! "(
RestoreSecrecyChannelAsync
‹‹" <
(
‹‹< =
state
‹‹= B
,
‹‹B C)
applicationInstanceSettings
‹‹D _
)
‹‹_ `
.
‹‹` a
ConfigureAwait
‹‹a o
(
‹‹o p
false
‹‹p u
)
‹‹u v
;
‹‹v w
if
 

(
 
restoreResult
 
.
 
IsErr
 
)
  
{
ŽŽ 	
networkProvider
 
.
 
ClearConnection
 +
(
+ ,
	connectId
, 5
)
5 6
;
6 7
await
 (
secureProtocolStateStorage
 ,
.
, -
DeleteStateAsync
- =
(
= >
	connectId
> G
.
G H
ToString
H P
(
P Q
)
Q R
)
R S
.
S T
ConfigureAwait
T b
(
b c
false
c h
)
h i
;
i j
return
’’ 
Result
’’ 
<
’’ 
bool
’’ 
,
’’ 
NetworkFailure
’’  .
>
’’. /
.
’’/ 0
Ok
’’0 2
(
’’2 3
false
’’3 8
)
’’8 9
;
’’9 :
}
““ 	
if
•• 

(
•• 
restoreResult
•• 
.
•• 
Unwrap
••  
(
••  !
)
••! "
)
••" #
{
–– 	
return
—— 
Result
—— 
<
—— 
bool
—— 
,
—— 
NetworkFailure
——  .
>
——. /
.
——/ 0
Ok
——0 2
(
——2 3
true
——3 7
)
——7 8
;
——8 9
}
˜˜ 	
networkProvider
šš 
.
šš 
ClearConnection
šš '
(
šš' (
	connectId
šš( 1
)
šš1 2
;
šš2 3
await
›› (
secureProtocolStateStorage
›› (
.
››( )
DeleteStateAsync
››) 9
(
››9 :
	connectId
››: C
.
››C D
ToString
››D L
(
››L M
)
››M N
)
››N O
.
››O P
ConfigureAwait
››P ^
(
››^ _
false
››_ d
)
››d e
;
››e f
return
 
Result
 
<
 
bool
 
,
 
NetworkFailure
 *
>
* +
.
+ ,
Ok
, .
(
. /
false
/ 4
)
4 5
;
5 6
}
žž 
private
   
async
   
Task
   
<
   
Option
   
<
   &
SodiumSecureMemoryHandle
   6
>
  6 7
>
  7 8.
 TryLoadMasterKeyFromStorageAsync
  9 Y
(
  Y Z
string
  Z `
membershipId
  a m
)
  m n
{
¡¡ 
Result
¢¢ 
<
¢¢ &
SodiumSecureMemoryHandle
¢¢ '
,
¢¢' (#
AuthenticationFailure
¢¢) >
>
¢¢> ?

loadResult
¢¢@ J
=
¢¢K L
await
££ 
identityService
££ !
.
££! "&
LoadMasterKeyHandleAsync
££" :
(
££: ;
membershipId
££; G
)
££G H
.
££H I
ConfigureAwait
££I W
(
££W X
false
££X ]
)
££] ^
;
££^ _
if
¥¥ 

(
¥¥ 

loadResult
¥¥ 
.
¥¥ 
IsErr
¥¥ 
)
¥¥ 
{
¦¦ 	
return
§§ 
Option
§§ 
<
§§ &
SodiumSecureMemoryHandle
§§ 2
>
§§2 3
.
§§3 4
None
§§4 8
;
§§8 9
}
¨¨ 	&
SodiumSecureMemoryHandle
ªª  
loadedHandle
ªª! -
=
ªª. /

loadResult
ªª0 :
.
ªª: ;
Unwrap
ªª; A
(
ªªA B
)
ªªB C
;
ªªC D
Result
¬¬ 
<
¬¬ 
byte
¬¬ 
[
¬¬ 
]
¬¬ 
,
¬¬ 
Ecliptix
¬¬ 
.
¬¬  
	Utilities
¬¬  )
.
¬¬) *
Failures
¬¬* 2
.
¬¬2 3
Sodium
¬¬3 9
.
¬¬9 :
SodiumFailure
¬¬: G
>
¬¬G H

readResult
¬¬I S
=
¬¬T U
loadedHandle
­­ 
.
­­ 
	ReadBytes
­­ "
(
­­" #
loadedHandle
­­# /
.
­­/ 0
Length
­­0 6
)
­­6 7
;
­­7 8
if
®® 

(
®® 
!
®® 

readResult
®® 
.
®® 
IsOk
®® 
)
®® 
{
¯¯ 	
return
°° 
Option
°° 
<
°° &
SodiumSecureMemoryHandle
°° 2
>
°°2 3
.
°°3 4
Some
°°4 8
(
°°8 9
loadedHandle
°°9 E
)
°°E F
;
°°F G
}
±± 	
byte
³³ 
[
³³ 
]
³³ 
masterKeyBytes
³³ 
=
³³ 

readResult
³³  *
.
³³* +
Unwrap
³³+ 1
(
³³1 2
)
³³2 3
;
³³3 4%
CryptographicOperations
´´ 
.
´´  

ZeroMemory
´´  *
(
´´* +
masterKeyBytes
´´+ 9
)
´´9 :
;
´´: ;
return
¶¶ 
Option
¶¶ 
<
¶¶ &
SodiumSecureMemoryHandle
¶¶ .
>
¶¶. /
.
¶¶/ 0
Some
¶¶0 4
(
¶¶4 5
loadedHandle
¶¶5 A
)
¶¶A B
;
¶¶B C
}
·· 
private
¹¹ 
async
¹¹ 
Task
¹¹ 
<
¹¹ 
Option
¹¹ 
<
¹¹ &
SodiumSecureMemoryHandle
¹¹ 6
>
¹¹6 7
>
¹¹7 8*
TryReconstructMasterKeyAsync
¹¹9 U
(
¹¹U V
string
ºº 
membershipId
ºº 
,
ºº )
ApplicationInstanceSettings
»» #)
applicationInstanceSettings
»»$ ?
)
»»? @
{
¼¼ 
Option
½½ 
<
½½ &
SodiumSecureMemoryHandle
½½ '
>
½½' (
storageHandle
½½) 6
=
½½7 8
await
¾¾ .
 TryLoadMasterKeyFromStorageAsync
¾¾ 2
(
¾¾2 3
membershipId
¾¾3 ?
)
¾¾? @
.
¾¾@ A
ConfigureAwait
¾¾A O
(
¾¾O P
false
¾¾P U
)
¾¾U V
;
¾¾V W
if
ÀÀ 

(
ÀÀ 
storageHandle
ÀÀ 
.
ÀÀ 
IsSome
ÀÀ  
)
ÀÀ  !
{
ÁÁ 	
return
ÂÂ 
storageHandle
ÂÂ  
;
ÂÂ  !
}
ÃÃ 	
await
ÅÅ /
!CleanupCorruptedIdentityDataAsync
ÅÅ /
(
ÅÅ/ 0
membershipId
ÅÅ0 <
,
ÅÅ< =)
applicationInstanceSettings
ÅÅ> Y
)
ÅÅY Z
.
ÅÅZ [
ConfigureAwait
ÅÅ[ i
(
ÅÅi j
false
ÅÅj o
)
ÅÅo p
;
ÅÅp q
return
ÇÇ 
Option
ÇÇ 
<
ÇÇ &
SodiumSecureMemoryHandle
ÇÇ .
>
ÇÇ. /
.
ÇÇ/ 0
None
ÇÇ0 4
;
ÇÇ4 5
}
ÈÈ 
private
ÊÊ 
async
ÊÊ 
Task
ÊÊ 
<
ÊÊ 
Result
ÊÊ 
<
ÊÊ 
Unit
ÊÊ "
,
ÊÊ" #
NetworkFailure
ÊÊ$ 2
>
ÊÊ2 3
>
ÊÊ3 4!
RegisterDeviceAsync
ÊÊ5 H
(
ÊÊH I
uint
ÊÊI M
	connectId
ÊÊN W
,
ÊÊW X)
ApplicationInstanceSettings
ËË #
settings
ËË$ ,
)
ËË, -
{
ÌÌ 
	AppDevice
ÍÍ 
	appDevice
ÍÍ 
=
ÍÍ 
new
ÍÍ !
(
ÍÍ! "
)
ÍÍ" #
{
ÎÎ 	
AppInstanceId
ÏÏ 
=
ÏÏ 
settings
ÏÏ $
.
ÏÏ$ %
AppInstanceId
ÏÏ% 2
,
ÏÏ2 3
DeviceId
ÐÐ 
=
ÐÐ 
settings
ÐÐ 
.
ÐÐ  
DeviceId
ÐÐ  (
,
ÐÐ( )

DeviceType
ÑÑ 
=
ÑÑ 
	AppDevice
ÑÑ "
.
ÑÑ" #
Types
ÑÑ# (
.
ÑÑ( )

DeviceType
ÑÑ) 3
.
ÑÑ3 4
Desktop
ÑÑ4 ;
}
ÒÒ 	
;
ÒÒ	 

return
ÔÔ 
await
ÔÔ 
networkProvider
ÔÔ $
.
ÔÔ$ %&
ExecuteUnaryRequestAsync
ÔÔ% =
(
ÔÔ= >
	connectId
ÕÕ 
,
ÕÕ 
RpcServiceType
ÖÖ 
.
ÖÖ 
RegisterAppDevice
ÖÖ ,
,
ÖÖ, -%
SecureByteStringInterop
×× #
.
××# $"
WithByteStringAsSpan
××$ 8
(
××8 9
	appDevice
××9 B
.
××B C
ToByteString
××C O
(
××O P
)
××P Q
,
××Q R
span
ØØ 
=>
ØØ 
span
ØØ 
.
ØØ 
ToArray
ØØ $
(
ØØ$ %
)
ØØ% &
)
ØØ& '
,
ØØ' (
decryptedPayload
ÙÙ 
=>
ÙÙ 
{
ÚÚ (
DeviceRegistrationResponse
ÛÛ *
reply
ÛÛ+ 0
=
ÛÛ1 2
Helpers
ÜÜ 
.
ÜÜ 
ParseFromBytes
ÜÜ *
<
ÜÜ* +(
DeviceRegistrationResponse
ÜÜ+ E
>
ÜÜE F
(
ÜÜF G
decryptedPayload
ÜÜG W
)
ÜÜW X
;
ÜÜX Y
settings
ÞÞ 
.
ÞÞ 
ServerPublicKey
ÞÞ (
=
ÞÞ) *%
SecureByteStringInterop
ÞÞ+ B
.
ÞÞB C"
WithByteStringAsSpan
ÞÞC W
(
ÞÞW X
reply
ÞÞX ]
.
ÞÞ] ^
ServerPublicKey
ÞÞ^ m
,
ÞÞm n

ByteString
ßß 
.
ßß 
CopyFrom
ßß '
)
ßß' (
;
ßß( )
return
áá 
Task
áá 
.
áá 

FromResult
áá &
(
áá& '
Result
áá' -
<
áá- .
Unit
áá. 2
,
áá2 3
NetworkFailure
áá4 B
>
ááB C
.
ááC D
Ok
ááD F
(
ááF G
Unit
ááG K
.
ááK L
Value
ááL Q
)
ááQ R
)
ááR S
;
ááS T
}
ââ 
,
ââ 
false
ââ 
,
ââ 
CancellationToken
ââ '
.
ââ' (
None
ââ( ,
)
ââ, -
.
ââ- .
ConfigureAwait
ââ. <
(
ââ< =
false
ââ= B
)
ââB C
;
ââC D
}
ãã 
private
åå 
async
åå 
Task
åå /
!CleanupCorruptedIdentityDataAsync
åå 8
(
åå8 9
string
ææ 
membershipId
ææ 
,
ææ )
ApplicationInstanceSettings
çç #)
applicationInstanceSettings
çç$ ?
)
çç? @
{
èè 
try
éé 
{
êê 	
uint
ëë 
	connectId
ëë 
=
ëë 
NetworkProvider
ëë ,
.
ëë, -$
ComputeUniqueConnectId
ëë- C
(
ëëC D)
applicationInstanceSettings
ìì +
,
ìì+ , 
PubKeyExchangeType
íí "
.
íí" #(
DataCenterEphemeralConnect
íí# =
)
íí= >
;
íí> ?
Result
ïï 
<
ïï 
Unit
ïï 
,
ïï 
	Exception
ïï "
>
ïï" #
cleanupResult
ïï$ 1
=
ïï2 3
await
ðð 
identityService
ðð %
.
ðð% &1
#CleanupMembershipStateWithKeysAsync
ðð& I
(
ððI J
membershipId
ððJ V
,
ððV W
	connectId
ððX a
)
ðða b
.
ññ 
ConfigureAwait
ññ #
(
ññ# $
false
ññ$ )
)
ññ) *
;
ññ* +
if
óó 
(
óó 
cleanupResult
óó 
.
óó 
IsErr
óó #
)
óó# $
{
ôô 
return
õõ 
;
õõ 
}
öö 
await
øø 
stateManager
øø 
.
øø (
TransitionToAnonymousAsync
øø 9
(
øø9 :
)
øø: ;
.
øø; <
ConfigureAwait
øø< J
(
øøJ K
false
øøK P
)
øøP Q
;
øøQ R
}
ùù 	
catch
úú 
(
úú 
	Exception
úú 
ex
úú 
)
úú 
{
ûû 	
Log
üü 
.
üü 
Error
üü 
(
üü 
ex
üü 
,
üü 
$str
üü u
,
üüu v
membershipId
ýý 
)
ýý 
;
ýý 
}
þþ 	
}
ÿÿ 
}€€ ¤
‡/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Common/InternalServiceApiFailureType.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Common! '
;' (
public 
enum )
InternalServiceApiFailureType )
{ &
SECURE_STORE_KEY_NOT_FOUND 
, &
SECURE_STORE_ACCESS_DENIED 
, 
API_REQUEST_FAILED 
} «æ
‹/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/OpaqueRegistrationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
;/ 0
internal 
sealed	 
class %
OpaqueRegistrationService /
(/ 0
NetworkProvider 
networkProvider #
,# $ 
ILocalizationService   
localizationService   ,
,  , -$
IServerPublicKeyProvider!! #
serverPublicKeyProvider!! 4
,!!4 5-
!IApplicationSecureStorageProvider"" %,
 applicationSecureStorageProvider""& F
)""F G
:## &
IOpaqueRegistrationService##  
,##  !
IDisposable##" -
{$$ 
private%% 
readonly%% $
RegistrationStateManager%% -
_stateManager%%. ;
=%%< =
new%%> A
(%%A B
)%%B C
;%%C D
private&& 
readonly&& %
VerificationStreamManager&& .
_streamManager&&/ =
=&&> ?
new&&@ C
(&&C D
networkProvider&&D S
)&&S T
;&&T U
public(( 

async(( 
Task(( 
<(( 
Result(( 
<(( (
ValidateMobileNumberResponse(( 9
,((9 :
string((; A
>((A B
>((B C%
ValidateMobileNumberAsync((D ]
(((] ^
string)) 
mobileNumber)) 
,)) 
uint** 
	connectId** 
,** 
CancellationToken++ 
cancellationToken++ +
=++, -
default++. 5
)++5 6
{,, 
if-- 

(-- 
string-- 
.-- 
IsNullOrEmpty--  
(--  !
mobileNumber--! -
)--- .
)--. /
{.. 	
return// 
Result// 
<// (
ValidateMobileNumberResponse// 6
,//6 7
string//8 >
>//> ?
.//? @
Err//@ C
(//C D
localizationService00 #
[00# $#
AuthenticationConstants00$ ;
.00; <&
MOBILE_NUMBER_REQUIRED_KEY00< V
]00V W
)00W X
;00X Y
}11 	'
ValidateMobileNumberRequest33 #
request33$ +
=33, -
new33. 1
(331 2
)332 3
{334 5
MobileNumber336 B
=33C D
mobileNumber33E Q
}33R S
;33S T 
TaskCompletionSource55 
<55 (
ValidateMobileNumberResponse55 9
>559 :
responseSource55; I
=55J K
new66 
(66 
TaskCreationOptions66 #
.66# $*
RunContinuationsAsynchronously66$ B
)66B C
;66C D
Result88 
<88 
Unit88 
,88 
NetworkFailure88 #
>88# $
networkResult88% 2
=883 4
await885 :
networkProvider88; J
.88J K$
ExecuteUnaryRequestAsync88K c
(88c d
	connectId99 
,99 
RpcServiceType:: 
.::  
ValidateMobileNumber:: /
,::/ 0#
SecureByteStringInterop;; #
.;;# $ 
WithByteStringAsSpan;;$ 8
(;;8 9
request;;9 @
.;;@ A
ToByteString;;A M
(;;M N
);;N O
,;;O P
span;;Q U
=>;;V X
span;;Y ]
.;;] ^
ToArray;;^ e
(;;e f
);;f g
);;g h
,;;h i
payload;;j q
=>;;r t
{<< (
ValidateMobileNumberResponse== ,
response==- 5
===6 7
Helpers==8 ?
.==? @
ParseFromBytes==@ N
<==N O(
ValidateMobileNumberResponse==O k
>==k l
(==l m
payload==m t
)==t u
;==u v
responseSource>> 
.>> 
TrySetResult>> +
(>>+ ,
response>>, 4
)>>4 5
;>>5 6
return@@ 
Task@@ 
.@@ 

FromResult@@ &
(@@& '
Result@@' -
<@@- .
Unit@@. 2
,@@2 3
NetworkFailure@@4 B
>@@B C
.@@C D
Ok@@D F
(@@F G
Unit@@G K
.@@K L
Value@@L Q
)@@Q R
)@@R S
;@@S T
}AA 
,AA 
trueAA 
,AA 
cancellationTokenAA &
)AA& '
.AA' (
ConfigureAwaitAA( 6
(AA6 7
falseAA7 <
)AA< =
;AA= >
ifCC 

(CC 
networkResultCC 
.CC 
IsErrCC 
)CC  
{DD 	
returnEE 
ResultEE 
<EE (
ValidateMobileNumberResponseEE 6
,EE6 7
stringEE8 >
>EE> ?
.EE? @
ErrEE@ C
(EEC D
networkResultEED Q
.EEQ R
	UnwrapErrEER [
(EE[ \
)EE\ ]
.EE] ^
MessageEE^ e
)EEe f
;EEf g
}FF 	(
ValidateMobileNumberResponseHH $

identifierHH% /
=HH0 1
awaitHH2 7
responseSourceHH8 F
.HHF G
TaskHHG K
.HHK L
ConfigureAwaitHHL Z
(HHZ [
falseHH[ `
)HH` a
;HHa b
returnII 
ResultII 
<II (
ValidateMobileNumberResponseII 2
,II2 3
stringII4 :
>II: ;
.II; <
OkII< >
(II> ?

identifierII? I
)III J
;IIJ K
}JJ 
publicLL 

asyncLL 
TaskLL 
<LL 
ResultLL 
<LL 1
%CheckMobileNumberAvailabilityResponseLL B
,LLB C
stringLLD J
>LLJ K
>LLK L.
"CheckMobileNumberAvailabilityAsyncMM *
(MM* +

ByteStringNN "
mobileNumberIdentifierNN -
,NN- .
uintOO 
	connectIdOO 
,OO 
CancellationTokenPP 
cancellationTokenPP /
=PP0 1
defaultPP2 9
)PP9 :
{QQ 
ifRR 

(RR "
mobileNumberIdentifierRR "
.RR" #
IsEmptyRR# *
)RR* +
{SS 	
returnTT 
ResultTT 
<TT 1
%CheckMobileNumberAvailabilityResponseTT ?
,TT? @
stringTTA G
>TTG H
.TTH I
ErrTTI L
(TTL M
localizationServiceUU #
[UU# $#
AuthenticationConstantsUU$ ;
.UU; <1
%MOBILE_NUMBER_IDENTIFIER_REQUIRED_KEYUU< a
]UUa b
)UUb c
;UUc d
}VV 	0
$CheckMobileNumberAvailabilityRequestXX ,
requestXX- 4
=XX5 6
newXX7 :
(XX: ;
)XX; <
{XX= >
MobileNumberIdXX? M
=XXN O"
mobileNumberIdentifierXXP f
}XXg h
;XXh i 
TaskCompletionSourceZZ 
<ZZ 1
%CheckMobileNumberAvailabilityResponseZZ B
>ZZB C
responseSourceZZD R
=ZZS T
new[[ 
([[ 
TaskCreationOptions[[ #
.[[# $*
RunContinuationsAsynchronously[[$ B
)[[B C
;[[C D
Result]] 
<]] 
Unit]] 
,]] 
NetworkFailure]] #
>]]# $
networkResult]]% 2
=]]3 4
await]]5 :
networkProvider]]; J
.]]J K$
ExecuteUnaryRequestAsync]]K c
(]]c d
	connectId^^ 
,^^ 
RpcServiceType__ 
.__ )
CheckMobileNumberAvailability__ 8
,__8 9#
SecureByteStringInterop`` #
.``# $ 
WithByteStringAsSpan``$ 8
(``8 9
request``9 @
.``@ A
ToByteString``A M
(``M N
)``N O
,``O P
span``Q U
=>``V X
span``Y ]
.``] ^
ToArray``^ e
(``e f
)``f g
)``g h
,``h i
payload``j q
=>``r t
{aa 1
%CheckMobileNumberAvailabilityResponsebb 5
responsebb6 >
=bb? @
Helperscc 
.cc 
ParseFromBytescc *
<cc* +1
%CheckMobileNumberAvailabilityResponsecc+ P
>ccP Q
(ccQ R
payloadccR Y
)ccY Z
;ccZ [
responseSourcedd 
.dd 
TrySetResultdd +
(dd+ ,
responsedd, 4
)dd4 5
;dd5 6
returnee 
Taskee 
.ee 

FromResultee &
(ee& '
Resultee' -
<ee- .
Unitee. 2
,ee2 3
NetworkFailureee4 B
>eeB C
.eeC D
OkeeD F
(eeF G
UniteeG K
.eeK L
ValueeeL Q
)eeQ R
)eeR S
;eeS T
}ff 
,ff 
trueff 
,ff 
cancellationTokenff &
)ff& '
.ff' (
ConfigureAwaitff( 6
(ff6 7
falseff7 <
)ff< =
;ff= >
ifhh 

(hh 
networkResulthh 
.hh 
IsErrhh 
)hh  
{ii 	
returnjj 
Resultjj 
<jj 1
%CheckMobileNumberAvailabilityResponsejj ?
,jj? @
stringjjA G
>jjG H
.jjH I
ErrjjI L
(jjL M
networkResultjjM Z
.jjZ [
	UnwrapErrjj[ d
(jjd e
)jje f
.jjf g
Messagejjg n
)jjn o
;jjo p
}kk 	1
%CheckMobileNumberAvailabilityResponsemm -
statusResponsemm. <
=mm= >
awaitmm? D
responseSourcemmE S
.mmS T
TaskmmT X
.mmX Y
ConfigureAwaitmmY g
(mmg h
falsemmh m
)mmm n
;mmn o
returnnn 
Resultnn 
<nn 1
%CheckMobileNumberAvailabilityResponsenn ;
,nn; <
stringnn= C
>nnC D
.nnD E
OknnE G
(nnG H
statusResponsennH V
)nnV W
;nnW X
}oo 
publicqq 

asyncqq 
Taskqq 
<qq 
Resultqq 
<qq 
Unitqq !
,qq! "
stringqq# )
>qq) *
>qq* +(
InitiateOtpVerificationAsyncqq, H
(qqH I

ByteStringrr "
mobileNumberIdentifierrr )
,rr) *
VerificationPurposess 
purposess #
=ss$ %
VerificationPurposess& 9
.ss9 :
Registrationss: F
,ssF G
Actiontt 
<tt 
uinttt 
,tt 
Guidtt 
,tt '
VerificationCountdownUpdatett 6
.tt6 7
Typestt7 <
.tt< =!
CountdownUpdateStatustt= R
,ttR S
stringttT Z
?ttZ [
>tt[ \
?tt\ ]
onCountdownUpdatett^ o
=ttp q
nullttr v
,ttv w
CancellationTokenuu 
cancellationTokenuu +
=uu, -
defaultuu. 5
)uu5 6
{vv 
ifww 

(ww "
mobileNumberIdentifierww "
.ww" #
IsEmptyww# *
)ww* +
{xx 	
returnyy 
Resultyy 
<yy 
Unityy 
,yy 
stringyy  &
>yy& '
.yy' (
Erryy( +
(yy+ ,
localizationServicezz #
[zz# $#
AuthenticationConstantszz$ ;
.zz; <1
%MOBILE_NUMBER_IDENTIFIER_REQUIRED_KEYzz< a
]zza b
)zzb c
;zzc d
}{{ 	
Result}} 
<}} 
uint}} 
,}} 
NetworkFailure}} #
>}}# $
protocolResult}}% 3
=}}4 5
await~~ 
networkProvider~~ !
.~~! "&
EnsureProtocolForTypeAsync~~" <
(~~< =
PubKeyExchangeType "
." #
ServerStreaming# 2
)2 3
.3 4
ConfigureAwait4 B
(B C
falseC H
)H I
;I J
if
 

(
 
protocolResult
 
.
 
IsErr
  
)
  !
{
‚‚ 	
return
ƒƒ 
Result
ƒƒ 
<
ƒƒ 
Unit
ƒƒ 
,
ƒƒ 
string
ƒƒ  &
>
ƒƒ& '
.
ƒƒ' (
Err
ƒƒ( +
(
ƒƒ+ ,
$"
„„ 
{
„„ %
AuthenticationConstants
„„ *
.
„„* +)
VERIFICATION_FAILURE_PREFIX
„„+ F
}
„„F G
{
„„G H
protocolResult
„„H V
.
„„V W
	UnwrapErr
„„W `
(
„„` a
)
„„a b
.
„„b c
Message
„„c j
}
„„j k
"
„„k l
)
„„l m
;
„„m n
}
…… 	
uint
‡‡ 
streamConnectId
‡‡ 
=
‡‡ 
protocolResult
‡‡ -
.
‡‡- .
Unwrap
‡‡. 4
(
‡‡4 5
)
‡‡5 6
;
‡‡6 7)
InitiateVerificationRequest
‰‰ #
request
‰‰$ +
=
‰‰, -
new
‰‰. 1
(
‰‰1 2
)
‰‰2 3
{
ŠŠ 	$
MobileNumberIdentifier
‹‹ "
=
‹‹# $$
mobileNumberIdentifier
‹‹% ;
,
‹‹; <
Purpose
ŒŒ 
=
ŒŒ 
purpose
ŒŒ 
,
ŒŒ 
Type
 
=
 )
InitiateVerificationRequest
 .
.
. /
Types
/ 4
.
4 5
Type
5 9
.
9 :
SendOtp
: A
}
ŽŽ 	
;
ŽŽ	 

Result
 
<
 
Unit
 
,
 
NetworkFailure
 #
>
# $
streamResult
% 1
=
2 3
await
4 9
networkProvider
: I
.
I J.
 ExecuteReceiveStreamRequestAsync
J j
(
j k
streamConnectId
‘‘ 
,
‘‘ 
RpcServiceType
’’ 
.
’’ "
InitiateVerification
’’ /
,
’’/ 0%
SecureByteStringInterop
““ #
.
““# $"
WithByteStringAsSpan
““$ 8
(
““8 9
request
““9 @
.
““@ A
ToByteString
““A M
(
““M N
)
““N O
,
““O P
span
““Q U
=>
““V X
span
““Y ]
.
““] ^
ToArray
““^ e
(
““e f
)
““f g
)
““g h
,
““h i
payload
”” 
=>
”” .
 HandleVerificationStreamResponse
”” 7
(
””7 8
payload
””8 ?
,
””? @
streamConnectId
””A P
,
””P Q
onCountdownUpdate
””R c
,
””c d
purpose
””e l
)
””l m
,
””m n
true
•• 
,
•• 
cancellationToken
•• #
)
••# $
.
••$ %
ConfigureAwait
••% 3
(
••3 4
false
••4 9
)
••9 :
;
••: ;
if
—— 

(
—— 
!
—— 
streamResult
—— 
.
—— 
IsErr
—— 
)
——  
{
˜˜ 	
return
™™ 
Result
™™ 
<
™™ 
Unit
™™ 
,
™™ 
string
™™  &
>
™™& '
.
™™' (
Ok
™™( *
(
™™* +
Unit
™™+ /
.
™™/ 0
Value
™™0 5
)
™™5 6
;
™™6 7
}
šš 	
NetworkFailure
œœ 
failure
œœ 
=
œœ  
streamResult
œœ! -
.
œœ- .
	UnwrapErr
œœ. 7
(
œœ7 8
)
œœ8 9
;
œœ9 :-
HandleVerificationStreamFailure
 '
(
' (
failure
( /
,
/ 0
onCountdownUpdate
1 B
)
B C
;
C D
return
žž 
Result
žž 
<
žž 
Unit
žž 
,
žž 
string
žž "
>
žž" #
.
žž# $
Err
žž$ '
(
žž' (&
GetNetworkFailureMessage
žž( @
(
žž@ A
failure
žžA H
)
žžH I
)
žžI J
;
žžJ K
}
ŸŸ 
public
¡¡ 

async
¡¡ 
Task
¡¡ 
<
¡¡ 
Result
¡¡ 
<
¡¡ 
Unit
¡¡ !
,
¡¡! "
string
¡¡# )
>
¡¡) *
>
¡¡* +(
ResendOtpVerificationAsync
¡¡, F
(
¡¡F G
Guid
¢¢ 
sessionIdentifier
¢¢ 
,
¢¢ 

ByteString
££ $
mobileNumberIdentifier
££ )
,
££) *
Action
¤¤ 
<
¤¤ 
uint
¤¤ 
,
¤¤ 
Guid
¤¤ 
,
¤¤ )
VerificationCountdownUpdate
¤¤ 6
.
¤¤6 7
Types
¤¤7 <
.
¤¤< =#
CountdownUpdateStatus
¤¤= R
,
¤¤R S
string
¤¤T Z
?
¤¤Z [
>
¤¤[ \
?
¤¤\ ]
onCountdownUpdate
¤¤^ o
=
¤¤p q
null
¤¤r v
,
¤¤v w
CancellationToken
¥¥ 
cancellationToken
¥¥ +
=
¥¥, -
default
¥¥. 5
)
¥¥5 6
{
¦¦ 
if
§§ 

(
§§ 
sessionIdentifier
§§ 
==
§§  %
AuthenticationConstants
§§! 8
.
§§8 9
	EmptyGuid
§§9 B
)
§§B C
{
¨¨ 	
return
©© 
Result
©© 
<
©© 
Unit
©© 
,
©© 
string
©©  &
>
©©& '
.
©©' (
Err
©©( +
(
©©+ ,!
localizationService
ªª #
[
ªª# $%
AuthenticationConstants
ªª$ ;
.
ªª; <-
SESSION_IDENTIFIER_REQUIRED_KEY
ªª< [
]
ªª[ \
)
ªª\ ]
;
ªª] ^
}
«« 	
if
­­ 

(
­­ $
mobileNumberIdentifier
­­ "
.
­­" #
IsEmpty
­­# *
)
­­* +
{
®® 	
return
¯¯ 
Result
¯¯ 
<
¯¯ 
Unit
¯¯ 
,
¯¯ 
string
¯¯  &
>
¯¯& '
.
¯¯' (
Err
¯¯( +
(
¯¯+ ,!
localizationService
°° #
[
°°# $%
AuthenticationConstants
°°$ ;
.
°°; <3
%MOBILE_NUMBER_IDENTIFIER_REQUIRED_KEY
°°< a
]
°°a b
)
°°b c
;
°°c d
}
±± 	
if
³³ 

(
³³ 
!
³³ 
_streamManager
³³ 
.
³³  
TryGetActiveStream
³³ .
(
³³. /
sessionIdentifier
³³/ @
,
³³@ A
out
³³B E
uint
³³F J
streamConnectId
³³K Z
)
³³Z [
)
³³[ \
{
´´ 	
return
µµ 
Result
µµ 
<
µµ 
Unit
µµ 
,
µµ 
string
µµ  &
>
µµ& '
.
µµ' (
Err
µµ( +
(
µµ+ ,!
localizationService
¶¶ #
[
¶¶# $%
AuthenticationConstants
¶¶$ ;
.
¶¶; <.
 VERIFICATION_SESSION_EXPIRED_KEY
¶¶< \
]
¶¶\ ]
)
¶¶] ^
;
¶¶^ _
}
·· 	!
VerificationPurpose
¹¹ 
purpose
¹¹ #
=
¹¹$ %
_streamManager
¹¹& 4
.
¹¹4 5
GetSessionPurpose
¹¹5 F
(
¹¹F G
sessionIdentifier
¹¹G X
)
¹¹X Y
;
¹¹Y Z)
InitiateVerificationRequest
»» #
request
»»$ +
=
»», -
new
»». 1
(
»»1 2
)
»»2 3
{
¼¼ 	$
MobileNumberIdentifier
½½ "
=
½½# $$
mobileNumberIdentifier
½½% ;
,
½½; <
Purpose
¾¾ 
=
¾¾ 
purpose
¾¾ 
,
¾¾ 
Type
¿¿ 
=
¿¿ )
InitiateVerificationRequest
¿¿ .
.
¿¿. /
Types
¿¿/ 4
.
¿¿4 5
Type
¿¿5 9
.
¿¿9 :
	ResendOtp
¿¿: C
}
ÀÀ 	
;
ÀÀ	 

Result
ÂÂ 
<
ÂÂ 
Unit
ÂÂ 
,
ÂÂ 
NetworkFailure
ÂÂ #
>
ÂÂ# $
result
ÂÂ% +
=
ÂÂ, -
await
ÂÂ. 3
networkProvider
ÂÂ4 C
.
ÂÂC D.
 ExecuteReceiveStreamRequestAsync
ÂÂD d
(
ÂÂd e
streamConnectId
ÃÃ 
,
ÃÃ 
RpcServiceType
ÄÄ 
.
ÄÄ "
InitiateVerification
ÄÄ /
,
ÄÄ/ 0%
SecureByteStringInterop
ÅÅ #
.
ÅÅ# $"
WithByteStringAsSpan
ÅÅ$ 8
(
ÅÅ8 9
request
ÅÅ9 @
.
ÅÅ@ A
ToByteString
ÅÅA M
(
ÅÅM N
)
ÅÅN O
,
ÅÅO P
span
ÅÅQ U
=>
ÅÅV X
span
ÅÅY ]
.
ÅÅ] ^
ToArray
ÅÅ^ e
(
ÅÅe f
)
ÅÅf g
)
ÅÅg h
,
ÅÅh i
payload
ÆÆ 
=>
ÆÆ .
 HandleVerificationStreamResponse
ÆÆ 7
(
ÆÆ7 8
payload
ÆÆ8 ?
,
ÆÆ? @
streamConnectId
ÆÆA P
,
ÆÆP Q
onCountdownUpdate
ÆÆR c
,
ÆÆc d
purpose
ÆÆe l
)
ÆÆl m
,
ÆÆm n
true
ÇÇ 
,
ÇÇ 
cancellationToken
ÇÇ #
)
ÇÇ# $
.
ÇÇ$ %
ConfigureAwait
ÇÇ% 3
(
ÇÇ3 4
false
ÇÇ4 9
)
ÇÇ9 :
;
ÇÇ: ;
if
ÉÉ 

(
ÉÉ 
!
ÉÉ 
result
ÉÉ 
.
ÉÉ 
IsErr
ÉÉ 
)
ÉÉ 
{
ÊÊ 	
return
ËË 
Result
ËË 
<
ËË 
Unit
ËË 
,
ËË 
string
ËË  &
>
ËË& '
.
ËË' (
Ok
ËË( *
(
ËË* +
Unit
ËË+ /
.
ËË/ 0
Value
ËË0 5
)
ËË5 6
;
ËË6 7
}
ÌÌ 	
NetworkFailure
ÎÎ 
failure
ÎÎ 
=
ÎÎ  
result
ÎÎ! '
.
ÎÎ' (
	UnwrapErr
ÎÎ( 1
(
ÎÎ1 2
)
ÎÎ2 3
;
ÎÎ3 4-
HandleVerificationStreamFailure
ÏÏ '
(
ÏÏ' (
failure
ÏÏ( /
,
ÏÏ/ 0
onCountdownUpdate
ÏÏ1 B
)
ÏÏB C
;
ÏÏC D
return
ÐÐ 
Result
ÐÐ 
<
ÐÐ 
Unit
ÐÐ 
,
ÐÐ 
string
ÐÐ "
>
ÐÐ" #
.
ÐÐ# $
Err
ÐÐ$ '
(
ÐÐ' (&
GetNetworkFailureMessage
ÐÐ( @
(
ÐÐ@ A
failure
ÐÐA H
)
ÐÐH I
)
ÐÐI J
;
ÐÐJ K
}
ÑÑ 
public
ÓÓ 

async
ÓÓ 
Task
ÓÓ 
<
ÓÓ 
Result
ÓÓ 
<
ÓÓ 
Protobuf
ÓÓ %
.
ÓÓ% &

Membership
ÓÓ& 0
.
ÓÓ0 1

Membership
ÓÓ1 ;
,
ÓÓ; <
string
ÓÓ= C
>
ÓÓC D
>
ÓÓD E
VerifyOtpAsync
ÓÓF T
(
ÓÓT U
Guid
ÔÔ 
sessionIdentifier
ÔÔ 
,
ÔÔ 
string
ÕÕ 
otpCode
ÕÕ 
,
ÕÕ 
uint
ÖÖ 
	connectId
ÖÖ 
,
ÖÖ 
CancellationToken
×× 
cancellationToken
×× +
=
××, -
default
××. 5
)
××5 6
{
ØØ 
if
ÙÙ 

(
ÙÙ 
string
ÙÙ 
.
ÙÙ 
IsNullOrEmpty
ÙÙ  
(
ÙÙ  !
otpCode
ÙÙ! (
)
ÙÙ( )
||
ÙÙ* ,
otpCode
ÙÙ- 4
.
ÙÙ4 5
Length
ÙÙ5 ;
!=
ÙÙ< >
$num
ÙÙ? @
)
ÙÙ@ A
{
ÚÚ 	
return
ÛÛ 
Result
ÛÛ 
<
ÛÛ 
Protobuf
ÛÛ "
.
ÛÛ" #

Membership
ÛÛ# -
.
ÛÛ- .

Membership
ÛÛ. 8
,
ÛÛ8 9
string
ÛÛ: @
>
ÛÛ@ A
.
ÛÛA B
Err
ÛÛB E
(
ÛÛE F!
localizationService
ÜÜ #
[
ÜÜ# $%
AuthenticationConstants
ÜÜ$ ;
.
ÜÜ; <"
INVALID_OTP_CODE_KEY
ÜÜ< P
]
ÜÜP Q
)
ÜÜQ R
;
ÜÜR S
}
ÝÝ 	
if
ßß 

(
ßß 
!
ßß 
_streamManager
ßß 
.
ßß  
TryGetActiveStream
ßß .
(
ßß. /
sessionIdentifier
ßß/ @
,
ßß@ A
out
ßßB E
uint
ßßF J
activeStreamId
ßßK Y
)
ßßY Z
)
ßßZ [
{
àà 	
return
áá 
Result
áá 
<
áá 
Protobuf
áá "
.
áá" #

Membership
áá# -
.
áá- .

Membership
áá. 8
,
áá8 9
string
áá: @
>
áá@ A
.
ááA B
Err
ááB E
(
ááE F!
localizationService
ââ #
[
ââ# $%
AuthenticationConstants
ââ$ ;
.
ââ; <0
"NO_ACTIVE_VERIFICATION_SESSION_KEY
ââ< ^
]
ââ^ _
)
ââ_ `
;
ââ` a
}
ãã 	!
VerificationPurpose
åå 
purpose
åå #
=
åå$ %
_streamManager
åå& 4
.
åå4 5
GetSessionPurpose
åå5 F
(
ååF G
sessionIdentifier
ååG X
)
ååX Y
;
ååY Z
VerifyCodeRequest
çç 
request
çç !
=
çç" #
new
çç$ '
(
çç' (
)
çç( )
{
çç* +
Code
çç, 0
=
çç1 2
otpCode
çç3 :
,
çç: ;
Purpose
çç< C
=
ççD E
purpose
ççF M
,
ççM N
StreamConnectId
ççO ^
=
çç_ `
activeStreamId
çça o
}
ççp q
;
ççq r"
TaskCompletionSource
éé 
<
éé 
Result
éé #
<
éé# $
Protobuf
éé$ ,
.
éé, -

Membership
éé- 7
.
éé7 8

Membership
éé8 B
,
ééB C
string
ééD J
>
ééJ K
>
ééK L
responseSource
ééM [
=
éé\ ]
new
êê 
(
êê !
TaskCreationOptions
êê #
.
êê# $,
RunContinuationsAsynchronously
êê$ B
)
êêB C
;
êêC D
Result
ìì 
<
ìì 
Unit
ìì 
,
ìì 
NetworkFailure
ìì #
>
ìì# $
networkResult
ìì% 2
=
ìì3 4
await
ìì5 :
networkProvider
ìì; J
.
ììJ K&
ExecuteUnaryRequestAsync
ììK c
(
ììc d
	connectId
íí 
,
íí 
RpcServiceType
îî 
.
îî 
	VerifyOtp
îî $
,
îî$ %%
SecureByteStringInterop
ïï #
.
ïï# $"
WithByteStringAsSpan
ïï$ 8
(
ïï8 9
request
ïï9 @
.
ïï@ A
ToByteString
ïïA M
(
ïïM N
)
ïïN O
,
ïïO P
span
ïïQ U
=>
ïïV X
span
ïïY ]
.
ïï] ^
ToArray
ïï^ e
(
ïïe f
)
ïïf g
)
ïïg h
,
ïïh i
payload
ïïj q
=>
ïïr t
{
ðð  
VerifyCodeResponse
ññ "
response
ññ# +
=
ññ, -
Helpers
ññ. 5
.
ññ5 6
ParseFromBytes
ññ6 D
<
ññD E 
VerifyCodeResponse
ññE W
>
ññW X
(
ññX Y
payload
ññY `
)
ññ` a
;
ñña b
if
óó 
(
óó 
response
óó 
.
óó 
Result
óó #
==
óó$ & 
VerificationResult
óó' 9
.
óó9 :
	Succeeded
óó: C
)
óóC D
{
ôô 
responseSource
õõ "
.
õõ" #
TrySetResult
õõ# /
(
õõ/ 0
Result
õõ0 6
<
õõ6 7
Protobuf
õõ7 ?
.
õõ? @

Membership
õõ@ J
.
õõJ K

Membership
õõK U
,
õõU V
string
õõW ]
>
õõ] ^
.
õõ^ _
Ok
õõ_ a
(
õõa b
response
õõb j
.
õõj k

Membership
õõk u
)
õõu v
)
õõv w
;
õõw x
}
öö 
else
÷÷ 
{
øø 
responseSource
ùù "
.
ùù" #
TrySetResult
ùù# /
(
ùù/ 0
Result
ùù0 6
<
ùù6 7
Protobuf
ùù7 ?
.
ùù? @

Membership
ùù@ J
.
ùùJ K

Membership
ùùK U
,
ùùU V
string
ùùW ]
>
ùù] ^
.
ùù^ _
Err
ùù_ b
(
ùùb c!
localizationService
úú +
[
úú+ ,%
AuthenticationConstants
úú, C
.
úúC D"
INVALID_OTP_CODE_KEY
úúD X
]
úúX Y
)
úúY Z
)
úúZ [
;
úú[ \
}
ûû 
return
ýý 
Task
ýý 
.
ýý 

FromResult
ýý &
(
ýý& '
Result
ýý' -
<
ýý- .
Unit
ýý. 2
,
ýý2 3
NetworkFailure
ýý4 B
>
ýýB C
.
ýýC D
Ok
ýýD F
(
ýýF G
Unit
ýýG K
.
ýýK L
Value
ýýL Q
)
ýýQ R
)
ýýR S
;
ýýS T
}
þþ 
,
þþ 
true
þþ 
,
þþ 
cancellationToken
þþ &
)
þþ& '
.
þþ' (
ConfigureAwait
þþ( 6
(
þþ6 7
false
þþ7 <
)
þþ< =
;
þþ= >
if
€€ 

(
€€ 
networkResult
€€ 
.
€€ 
IsErr
€€ 
)
€€  
{
 	
return
‚‚ 
Result
‚‚ 
<
‚‚ 
Protobuf
‚‚ "
.
‚‚" #

Membership
‚‚# -
.
‚‚- .

Membership
‚‚. 8
,
‚‚8 9
string
‚‚: @
>
‚‚@ A
.
‚‚A B
Err
‚‚B E
(
‚‚E F
networkResult
‚‚F S
.
‚‚S T
	UnwrapErr
‚‚T ]
(
‚‚] ^
)
‚‚^ _
.
‚‚_ `
Message
‚‚` g
)
‚‚g h
;
‚‚h i
}
ƒƒ 	
return
…… 
await
…… 
responseSource
…… #
.
……# $
Task
……$ (
.
……( )
ConfigureAwait
……) 7
(
……7 8
false
……8 =
)
……= >
;
……> ?
}
†† 
public
ˆˆ 

async
ˆˆ 
Task
ˆˆ 
<
ˆˆ 
Result
ˆˆ 
<
ˆˆ 
Unit
ˆˆ !
,
ˆˆ! "
string
ˆˆ# )
>
ˆˆ) *
>
ˆˆ* +'
CompleteRegistrationAsync
ˆˆ, E
(
ˆˆE F

ByteString
ˆˆF P"
membershipIdentifier
ˆˆQ e
,
ˆˆe f
SecureTextBuffer
‰‰ 
	secureKey
‰‰ "
,
‰‰" #
uint
‰‰$ (
	connectId
‰‰) 2
,
‰‰2 3
CancellationToken
‰‰4 E
cancellationToken
‰‰F W
=
‰‰X Y
default
‰‰Z a
)
‰‰a b
{
ŠŠ 
if
‹‹ 

(
‹‹ "
membershipIdentifier
‹‹  
.
‹‹  !
IsEmpty
‹‹! (
)
‹‹( )
{
ŒŒ 	
return
 
Result
 
<
 
Unit
 
,
 
string
  &
>
& '
.
' (
Err
( +
(
+ ,!
localizationService
ŽŽ #
[
ŽŽ# $%
AuthenticationConstants
ŽŽ$ ;
.
ŽŽ; <0
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY
ŽŽ< ^
]
ŽŽ^ _
)
ŽŽ_ `
;
ŽŽ` a
}
 	
if
‘‘ 

(
‘‘ 
	secureKey
‘‘ 
.
‘‘ 
Length
‘‘ 
==
‘‘ 
$num
‘‘  !
)
‘‘! "
{
’’ 	
return
““ 
Result
““ 
<
““ 
Unit
““ 
,
““ 
string
““  &
>
““& '
.
““' (
Err
““( +
(
““+ ,!
localizationService
““, ?
[
““? @%
AuthenticationConstants
““@ W
.
““W X%
SECURE_KEY_REQUIRED_KEY
““X o
]
““o p
)
““p q
;
““q r
}
”” 	
SensitiveBytes
–– 
?
–– 
secureKeyBytes
–– &
=
––' (
null
––) -
;
––- .
Result
—— 
<
—— 
SensitiveBytes
—— 
,
—— 
SodiumFailure
—— ,
>
——, -
?
——- .
createResult
——/ ;
=
——< =
null
——> B
;
——B C
try
™™ 
{
šš 	
	secureKey
›› 
.
›› 
WithSecureBytes
›› %
(
››% &
secureKeySpan
››& 3
=>
››4 6
{
››7 8
createResult
››9 E
=
››F G
SensitiveBytes
››H V
.
››V W
From
››W [
(
››[ \
secureKeySpan
››\ i
)
››i j
;
››j k
}
››l m
)
››m n
;
››n o
if
 
(
 
createResult
 
==
 
null
  $
||
% '
createResult
( 4
.
4 5
Value
5 :
.
: ;
IsErr
; @
)
@ A
{
žž 
string
ŸŸ 
errorMessage
ŸŸ #
=
ŸŸ$ %
createResult
ŸŸ& 2
?
ŸŸ2 3
.
ŸŸ3 4
IsErr
ŸŸ4 9
is
ŸŸ: <
true
ŸŸ= A
?
   
$"
   
$str
   <
{
  < =
createResult
  = I
.
  I J
Value
  J O
.
  O P
	UnwrapErr
  P Y
(
  Y Z
)
  Z [
.
  [ \
Message
  \ c
}
  c d
"
  d e
:
¡¡ !
localizationService
¡¡ )
[
¡¡) *%
AuthenticationConstants
¡¡* A
.
¡¡A B%
SECURE_KEY_REQUIRED_KEY
¡¡B Y
]
¡¡Y Z
;
¡¡Z [
return
¢¢ 
Result
¢¢ 
<
¢¢ 
Unit
¢¢ "
,
¢¢" #
string
¢¢$ *
>
¢¢* +
.
¢¢+ ,
Err
¢¢, /
(
¢¢/ 0
errorMessage
¢¢0 <
)
¢¢< =
;
¢¢= >
}
££ 
secureKeyBytes
¥¥ 
=
¥¥ 
createResult
¥¥ )
.
¥¥) *
Value
¥¥* /
.
¥¥/ 0
Unwrap
¥¥0 6
(
¥¥6 7
)
¥¥7 8
;
¥¥8 9
if
§§ 
(
§§ 
secureKeyBytes
§§ 
.
§§ 
Length
§§ %
==
§§& (
$num
§§) *
)
§§* +
{
¨¨ 
return
©© 
Result
©© 
<
©© 
Unit
©© "
,
©©" #
string
©©$ *
>
©©* +
.
©©+ ,
Err
©©, /
(
©©/ 0!
localizationService
©©0 C
[
©©C D%
AuthenticationConstants
©©D [
.
©©[ \%
SECURE_KEY_REQUIRED_KEY
©©\ s
]
©©s t
)
©©t u
;
©©u v
}
ªª 
const
¬¬ 
int
¬¬ 
maxFlowAttempts
¬¬ %
=
¬¬& '
$num
¬¬( )
;
¬¬) *
Result
®® 
<
®® 
Unit
®® 
,
®® 
string
®® 
>
®®  
result
®®! '
=
®®( )
await
®®* /

RetryAsync
®®0 :
(
®®: ;
maxFlowAttempts
¯¯ #
,
¯¯# $
(
°° 
attempt
°° 
,
°° &
attemptCancellationToken
°° 6
)
°°6 7
=>
°°8 :5
'ExecuteCompleteRegistrationAttemptAsync
±± ?
(
±±? @"
membershipIdentifier
²² 0
,
²²0 1
secureKeyBytes
³³ *
!
³³* +
,
³³+ ,
	connectId
´´ %
,
´´% &
attempt
µµ #
,
µµ# $&
attemptCancellationToken
¶¶ 4
)
¶¶4 5
,
¶¶5 6
cancellationToken
·· %
)
··% &
.
¸¸ 
ConfigureAwait
¸¸ 
(
¸¸  
false
¸¸  %
)
¸¸% &
;
¸¸& '
return
ºº 
result
ºº 
;
ºº 
}
»» 	
finally
¼¼ 
{
½½ 	
secureKeyBytes
¾¾ 
?
¾¾ 
.
¾¾ 
Dispose
¾¾ #
(
¾¾# $
)
¾¾$ %
;
¾¾% &
}
¿¿ 	
}
ÀÀ 
public
ÂÂ 

async
ÂÂ 
Task
ÂÂ 
<
ÂÂ 
Result
ÂÂ 
<
ÂÂ 
Unit
ÂÂ !
,
ÂÂ! "
string
ÂÂ# )
>
ÂÂ) *
>
ÂÂ* +-
CleanupVerificationSessionAsync
ÂÂ, K
(
ÂÂK L
Guid
ÂÂL P
sessionIdentifier
ÂÂQ b
)
ÂÂb c
{
ÃÃ 
if
ÄÄ 

(
ÄÄ 
sessionIdentifier
ÄÄ 
==
ÄÄ  %
AuthenticationConstants
ÄÄ! 8
.
ÄÄ8 9
	EmptyGuid
ÄÄ9 B
)
ÄÄB C
{
ÅÅ 	
return
ÆÆ 
Result
ÆÆ 
<
ÆÆ 
Unit
ÆÆ 
,
ÆÆ 
string
ÆÆ  &
>
ÆÆ& '
.
ÆÆ' (
Err
ÆÆ( +
(
ÆÆ+ ,!
localizationService
ÇÇ #
[
ÇÇ# $%
AuthenticationConstants
ÇÇ$ ;
.
ÇÇ; <-
SESSION_IDENTIFIER_REQUIRED_KEY
ÇÇ< [
]
ÇÇ[ \
)
ÇÇ\ ]
;
ÇÇ] ^
}
ÈÈ 	
return
ÊÊ 
await
ÊÊ  
CleanupStreamAsync
ÊÊ '
(
ÊÊ' (
sessionIdentifier
ÊÊ( 9
)
ÊÊ9 :
.
ÊÊ: ;
ConfigureAwait
ÊÊ; I
(
ÊÊI J
false
ÊÊJ O
)
ÊÊO P
;
ÊÊP Q
}
ËË 
public
ÍÍ 

void
ÍÍ 
Dispose
ÍÍ 
(
ÍÍ 
)
ÍÍ 
{
ÎÎ 
_streamManager
ÏÏ 
.
ÏÏ 
Dispose
ÏÏ 
(
ÏÏ 
)
ÏÏ  
;
ÏÏ  !
_stateManager
ÐÐ 
.
ÐÐ 
Dispose
ÐÐ 
(
ÐÐ 
)
ÐÐ 
;
ÐÐ  
}
ÑÑ 
private
ÓÓ 
static
ÓÓ '
RegistrationAttemptResult
ÓÓ ,"
CreateAttemptSuccess
ÓÓ- A
(
ÓÓA B
)
ÓÓB C
=>
ÓÓD F
new
ÔÔ 
(
ÔÔ 
Result
ÔÔ 
<
ÔÔ 
Unit
ÔÔ 
,
ÔÔ 
string
ÔÔ 
>
ÔÔ  
.
ÔÔ  !
Ok
ÔÔ! #
(
ÔÔ# $
Unit
ÔÔ$ (
.
ÔÔ( )
Value
ÔÔ) .
)
ÔÔ. /
,
ÔÔ/ 0
false
ÔÔ1 6
)
ÔÔ6 7
;
ÔÔ7 8
private
ÖÖ 
static
ÖÖ '
RegistrationAttemptResult
ÖÖ ,"
CreateAttemptFailure
ÖÖ- A
(
ÖÖA B
string
ÖÖB H
error
ÖÖI N
,
ÖÖN O
bool
ÖÖP T
isTransient
ÖÖU `
)
ÖÖ` a
=>
ÖÖb d
new
×× 
(
×× 
Result
×× 
<
×× 
Unit
×× 
,
×× 
string
×× 
>
××  
.
××  !
Err
××! $
(
××$ %
error
××% *
)
××* +
,
××+ ,
isTransient
××- 8
)
××8 9
;
××9 :
private
ÙÙ 
static
ÙÙ 
bool
ÙÙ "
IsTransientRpcStatus
ÙÙ ,
(
ÙÙ, -

StatusCode
ÙÙ- 7

statusCode
ÙÙ8 B
)
ÙÙB C
=>
ÙÙD F

statusCode
ÚÚ 
is
ÚÚ 

StatusCode
ÚÚ  
.
ÚÚ  !
Unavailable
ÚÚ! ,
or
ÚÚ- /

StatusCode
ÚÚ0 :
.
ÚÚ: ;
DeadlineExceeded
ÚÚ; K
or
ÚÚL N

StatusCode
ÚÚO Y
.
ÚÚY Z
	Cancelled
ÚÚZ c
;
ÚÚc d
private
ÜÜ 
static
ÜÜ 
bool
ÜÜ "
IsTransientException
ÜÜ ,
(
ÜÜ, -
	Exception
ÜÜ- 6
	exception
ÜÜ7 @
)
ÜÜ@ A
=>
ÜÜB D
	exception
ÝÝ 
switch
ÝÝ 
{
ÞÞ 	
RpcException
ßß 
rpcException
ßß %
when
ßß& *"
IsTransientRpcStatus
ßß+ ?
(
ßß? @
rpcException
ßß@ L
.
ßßL M

StatusCode
ßßM W
)
ßßW X
=>
ßßY [
true
ßß\ `
,
ßß` a
IOException
àà 
=>
àà 
true
àà 
,
àà  
SocketException
áá 
=>
áá 
true
áá #
,
áá# $
TimeoutException
ââ 
=>
ââ 
true
ââ  $
,
ââ$ %
_
ãã 
=>
ãã 
false
ãã 
}
ää 	
;
ää	 

private
ææ 
static
ææ 
bool
ææ ,
IsTransientRegistrationFailure
ææ 6
(
ææ6 7
NetworkFailure
ææ7 E
failure
ææF M
)
ææM N
{
çç 
return
èè 
failure
èè 
.
èè 
FailureType
èè "
is
èè# % 
NetworkFailureType
èè& 8
.
èè8 9(
DATA_CENTER_NOT_RESPONDING
èè9 S
or
éé  
NetworkFailureType
éé !
.
éé! ""
DATA_CENTER_SHUTDOWN
éé" 6
or
êê  
NetworkFailureType
êê !
.
êê! "!
OPERATION_CANCELLED
êê" 5
;
êê5 6
}
ëë 
private
íí 
static
íí 
string
íí &
GetNetworkFailureMessage
íí 2
(
íí2 3
NetworkFailure
íí3 A
failure
ííB I
)
ííI J
=>
ííK M
failure
îî 
.
îî 
	UserError
îî 
?
îî 
.
îî 
Message
îî "
??
îî# %
failure
îî& -
.
îî- .
Message
îî. 5
;
îî5 6
private
ðð 
static
ðð 
void
ðð -
HandleVerificationStreamFailure
ðð 7
(
ðð7 8
NetworkFailure
ññ 
failure
ññ 
,
ññ 
Action
òò 
<
òò 
uint
òò 
,
òò 
Guid
òò 
,
òò )
VerificationCountdownUpdate
òò 6
.
òò6 7
Types
òò7 <
.
òò< =#
CountdownUpdateStatus
òò= R
,
òòR S
string
òòT Z
?
òòZ [
>
òò[ \
?
òò\ ]
onCountdownUpdate
òò^ o
)
òòo p
{
óó 
if
ôô 

(
ôô *
IsVerificationSessionMissing
ôô (
(
ôô( )
failure
ôô) 0
)
ôô0 1
)
ôô1 2
{
õõ 	
RxApp
öö 
.
öö !
MainThreadScheduler
öö %
.
öö% &
Schedule
öö& .
(
öö. /
(
öö/ 0
)
öö0 1
=>
öö2 4
onCountdownUpdate
÷÷ !
?
÷÷! "
.
÷÷" #
Invoke
÷÷# )
(
÷÷) *
$num
÷÷* +
,
÷÷+ ,
Guid
÷÷- 1
.
÷÷1 2
Empty
÷÷2 7
,
÷÷7 8)
VerificationCountdownUpdate
øø /
.
øø/ 0
Types
øø0 5
.
øø5 6#
CountdownUpdateStatus
øø6 K
.
øøK L
NotFound
øøL T
,
øøT U%
AuthenticationConstants
ùù +
.
ùù+ ,
ErrorMessages
ùù, 9
.
ùù9 :(
SESSION_EXPIRED_START_OVER
ùù: T
)
ùùT U
)
ùùU V
;
ùùV W
}
úú 	
if
üü 

(
üü 
failure
üü 
.
üü 
FailureType
üü 
is
üü  "
not
üü# &
(
üü' ( 
NetworkFailureType
üü( :
.
üü: ;(
DATA_CENTER_NOT_RESPONDING
üü; U
or
ýý  
NetworkFailureType
ýý !
.
ýý! ""
DATA_CENTER_SHUTDOWN
ýý" 6
)
ýý6 7
)
ýý7 8
{
þþ 	
return
ÿÿ 
;
ÿÿ 
}
€€ 	
string
‚‚ 
errorMessage
‚‚ 
=
‚‚ &
GetNetworkFailureMessage
‚‚ 6
(
‚‚6 7
failure
‚‚7 >
)
‚‚> ?
;
‚‚? @
RxApp
ƒƒ 
.
ƒƒ !
MainThreadScheduler
ƒƒ !
.
ƒƒ! "
Schedule
ƒƒ" *
(
ƒƒ* +
(
ƒƒ+ ,
)
ƒƒ, -
=>
ƒƒ. 0
onCountdownUpdate
„„ 
?
„„ 
.
„„ 
Invoke
„„ %
(
„„% &
$num
„„& '
,
„„' (
Guid
„„) -
.
„„- .
Empty
„„. 3
,
„„3 4)
VerificationCountdownUpdate
…… +
.
……+ ,
Types
……, 1
.
……1 2#
CountdownUpdateStatus
……2 G
.
……G H
ServerUnavailable
……H Y
,
……Y Z
errorMessage
†† 
)
†† 
)
†† 
;
†† 
}
‡‡ 
private
‰‰ 
static
‰‰ 
bool
‰‰ *
IsVerificationSessionMissing
‰‰ 4
(
‰‰4 5
NetworkFailure
‰‰5 C
failure
‰‰D K
)
‰‰K L
{
ŠŠ 
if
‹‹ 

(
‹‹ 
failure
‹‹ 
.
‹‹ 
	UserError
‹‹ 
is
‹‹  
not
‹‹! $
{
‹‹% &
}
‹‹' (
	userError
‹‹) 2
)
‹‹2 3
{
ŒŒ 	
return
 
false
 
;
 
}
ŽŽ 	
if
 

(
 
!
 
string
 
.
  
IsNullOrWhiteSpace
 &
(
& '
	userError
' 0
.
0 1
I18NKey
1 8
)
8 9
&&
: <
(
‘‘ 
string
‘‘ 
.
‘‘ 
Equals
‘‘ 
(
‘‘ 
	userError
‘‘ $
.
‘‘$ %
I18NKey
‘‘% ,
,
‘‘, -%
AuthenticationConstants
‘‘. E
.
‘‘E F#
SESSION_NOT_FOUND_KEY
‘‘F [
,
‘‘[ \
StringComparison
’’ !
.
’’! "
OrdinalIgnoreCase
’’" 3
)
’’3 4
||
’’5 7
string
““ 
.
““ 
Equals
““ 
(
““ 
	userError
““ $
.
““$ %
I18NKey
““% ,
,
““, -%
AuthenticationConstants
““. E
.
““E F.
 VERIFICATION_SESSION_EXPIRED_KEY
““F f
,
““f g
StringComparison
”” !
.
””! "
OrdinalIgnoreCase
””" 3
)
””3 4
)
””4 5
)
””5 6
{
•• 	
return
–– 
true
–– 
;
–– 
}
—— 	
return
™™ 
	userError
™™ 
.
™™ 
	ErrorCode
™™ "
==
™™# %
	ErrorCode
™™& /
.
™™/ 0
	NOT_FOUND
™™0 9
;
™™9 :
}
šš 
private
œœ 
readonly
œœ 
record
œœ 
struct
œœ "'
RegistrationAttemptResult
œœ# <
(
œœ< =
Result
 
<
 
Unit
 
,
 
string
 
>
 
Outcome
 $
,
$ %
bool
žž 
IsTransient
žž 
)
žž 
;
žž 
private
   
Result
   
<
   
byte
   
[
   
]
   
,
   '
RegistrationAttemptResult
   4
>
  4 5#
ValidateSecureKeyCopy
  6 K
(
  K L
byte
¡¡ 
[
¡¡ 
]
¡¡ 
?
¡¡ 
secureKeyCopy
¡¡ 
)
¡¡ 
{
¢¢ 
if
££ 

(
££ 
secureKeyCopy
££ 
==
££ 
null
££ !
||
££" $
secureKeyCopy
££% 2
.
££2 3
Length
££3 9
==
££: <
$num
££= >
)
££> ?
{
¤¤ 	
return
¥¥ 
Result
¥¥ 
<
¥¥ 
byte
¥¥ 
[
¥¥ 
]
¥¥  
,
¥¥  !'
RegistrationAttemptResult
¥¥" ;
>
¥¥; <
.
¥¥< =
Err
¥¥= @
(
¥¥@ A"
CreateAttemptFailure
¦¦ $
(
¦¦$ %!
localizationService
§§ '
[
§§' (%
AuthenticationConstants
§§( ?
.
§§? @%
SECURE_KEY_REQUIRED_KEY
§§@ W
]
§§W X
,
§§X Y
false
¨¨ 
)
¨¨ 
)
¨¨ 
;
¨¨ 
}
©© 	
return
«« 
Result
«« 
<
«« 
byte
«« 
[
«« 
]
«« 
,
«« '
RegistrationAttemptResult
«« 7
>
««7 8
.
««8 9
Ok
««9 ;
(
««; <
secureKeyCopy
««< I
)
««I J
;
««J K
}
¬¬ 
private
®® 
Result
®® 
<
®®  
RegistrationResult
®® %
,
®®% &'
RegistrationAttemptResult
®®' @
>
®®@ A-
CreateAndTrackRegistrationState
®®B a
(
®®a b
OpaqueClient
¯¯ 
opaqueClient
¯¯ !
,
¯¯! "
byte
°° 
[
°° 
]
°° 
secureKeyCopy
°° 
,
°° 

ByteString
±± "
membershipIdentifier
±± '
)
±±' (
{
²²  
RegistrationResult
³³  
registrationResult
³³ -
=
³³. /
opaqueClient
³³0 <
.
³³< ='
CreateRegistrationRequest
³³= V
(
³³V W
secureKeyCopy
³³W d
)
³³d e
;
³³e f
if
µµ 

(
µµ 
_stateManager
µµ 
.
µµ  
TryAddRegistration
µµ ,
(
µµ, -"
membershipIdentifier
µµ- A
,
µµA B 
registrationResult
µµC U
)
µµU V
)
µµV W
{
¶¶ 	
return
·· 
Result
·· 
<
··  
RegistrationResult
·· ,
,
··, -'
RegistrationAttemptResult
··. G
>
··G H
.
··H I
Ok
··I K
(
··K L 
registrationResult
··L ^
)
··^ _
;
··_ `
}
¸¸ 	 
registrationResult
ºº 
.
ºº 
Dispose
ºº "
(
ºº" #
)
ºº# $
;
ºº$ %
return
»» 
Result
»» 
<
»»  
RegistrationResult
»» (
,
»»( )'
RegistrationAttemptResult
»»* C
>
»»C D
.
»»D E
Err
»»E H
(
»»H I"
CreateAttemptFailure
¼¼  
(
¼¼  !!
localizationService
½½ #
[
½½# $%
AuthenticationConstants
½½$ ;
.
½½; <%
REGISTRATION_FAILED_KEY
½½< S
]
½½S T
,
½½T U
true
¾¾ 
)
¾¾ 
)
¾¾ 
;
¾¾ 
}
¿¿ 
private
ÁÁ 
Result
ÁÁ 
<
ÁÁ 
Unit
ÁÁ 
,
ÁÁ '
RegistrationAttemptResult
ÁÁ 2
>
ÁÁ2 3+
ProcessInitializationResponse
ÁÁ4 Q
(
ÁÁQ R,
OpaqueRegistrationInitResponse
ÂÂ &
initResponse
ÂÂ' 3
,
ÂÂ3 4 
RegistrationResult
ÃÃ 
registrationState
ÃÃ ,
)
ÃÃ, -
{
ÄÄ 
if
ÅÅ 

(
ÅÅ 
initResponse
ÅÅ 
.
ÅÅ 
Result
ÅÅ 
==
ÅÅ  ",
OpaqueRegistrationInitResponse
ÅÅ# A
.
ÅÅA B
Types
ÅÅB G
.
ÅÅG H
UpdateResult
ÅÅH T
.
ÅÅT U
	Succeeded
ÅÅU ^
)
ÅÅ^ _
{
ÆÆ 	
return
ÇÇ 
Result
ÇÇ 
<
ÇÇ 
Unit
ÇÇ 
,
ÇÇ '
RegistrationAttemptResult
ÇÇ  9
>
ÇÇ9 :
.
ÇÇ: ;
Ok
ÇÇ; =
(
ÇÇ= >
Unit
ÇÇ> B
.
ÇÇB C
Value
ÇÇC H
)
ÇÇH I
;
ÇÇI J
}
ÈÈ 	
registrationState
ÊÊ 
.
ÊÊ 
Dispose
ÊÊ !
(
ÊÊ! "
)
ÊÊ" #
;
ÊÊ# $
string
ÌÌ 
errorMessage
ÌÌ 
=
ÌÌ 
initResponse
ÌÌ *
.
ÌÌ* +
Result
ÌÌ+ 1
switch
ÌÌ2 8
{
ÍÍ 	,
OpaqueRegistrationInitResponse
ÎÎ *
.
ÎÎ* +
Types
ÎÎ+ 0
.
ÎÎ0 1
UpdateResult
ÎÎ1 =
.
ÎÎ= > 
InvalidCredentials
ÎÎ> P
=>
ÎÎQ S!
localizationService
ÏÏ #
[
ÏÏ# $%
AuthenticationConstants
ÏÏ$ ;
.
ÏÏ; <%
INVALID_CREDENTIALS_KEY
ÏÏ< S
]
ÏÏS T
,
ÏÏT U
_
ÐÐ 
=>
ÐÐ !
localizationService
ÐÐ $
[
ÐÐ$ %%
AuthenticationConstants
ÐÐ% <
.
ÐÐ< =%
REGISTRATION_FAILED_KEY
ÐÐ= T
]
ÐÐT U
}
ÑÑ 	
;
ÑÑ	 

return
ÓÓ 
Result
ÓÓ 
<
ÓÓ 
Unit
ÓÓ 
,
ÓÓ '
RegistrationAttemptResult
ÓÓ 5
>
ÓÓ5 6
.
ÓÓ6 7
Err
ÓÓ7 :
(
ÓÓ: ;"
CreateAttemptFailure
ÔÔ  
(
ÔÔ  !
errorMessage
ÔÔ! -
,
ÔÔ- .
false
ÔÔ/ 4
)
ÔÔ4 5
)
ÔÔ5 6
;
ÔÔ6 7
}
ÕÕ 
private
×× 
static
×× 
void
×× .
 CleanupSensitiveRegistrationData
×× 8
(
××8 9
byte
ØØ 
[
ØØ 
]
ØØ 
?
ØØ 
secureKeyCopy
ØØ 
,
ØØ 
byte
ÙÙ 
[
ÙÙ 
]
ÙÙ 
?
ÙÙ (
serverRegistrationResponse
ÙÙ *
,
ÙÙ* +
byte
ÚÚ 
[
ÚÚ 
]
ÚÚ 
?
ÚÚ  
registrationRecord
ÚÚ "
,
ÚÚ" #
byte
ÛÛ 
[
ÛÛ 
]
ÛÛ 
?
ÛÛ 
	masterKey
ÛÛ 
)
ÛÛ 
{
ÜÜ 
if
ÝÝ 

(
ÝÝ 
secureKeyCopy
ÝÝ 
is
ÝÝ 
{
ÝÝ 
Length
ÝÝ %
:
ÝÝ% &
>
ÝÝ' (
$num
ÝÝ) *
}
ÝÝ+ ,
)
ÝÝ, -
{
ÞÞ 	%
CryptographicOperations
ßß #
.
ßß# $

ZeroMemory
ßß$ .
(
ßß. /
secureKeyCopy
ßß/ <
)
ßß< =
;
ßß= >
}
àà 	
if
ââ 

(
ââ (
serverRegistrationResponse
ââ &
is
ââ' )
{
ââ* +
Length
ââ, 2
:
ââ2 3
>
ââ4 5
$num
ââ6 7
}
ââ8 9
)
ââ9 :
{
ãã 	%
CryptographicOperations
ää #
.
ää# $

ZeroMemory
ää$ .
(
ää. /(
serverRegistrationResponse
ää/ I
)
ääI J
;
ääJ K
}
åå 	
if
çç 

(
çç  
registrationRecord
çç 
is
çç !
{
çç" #
Length
çç$ *
:
çç* +
>
çç, -
$num
çç. /
}
çç0 1
)
çç1 2
{
èè 	%
CryptographicOperations
éé #
.
éé# $

ZeroMemory
éé$ .
(
éé. / 
registrationRecord
éé/ A
)
ééA B
;
ééB C
}
êê 	
if
ìì 

(
ìì 
	masterKey
ìì 
is
ìì 
{
ìì 
Length
ìì !
:
ìì! "
>
ìì# $
$num
ìì% &
}
ìì' (
)
ìì( )
{
íí 	%
CryptographicOperations
îî #
.
îî# $

ZeroMemory
îî$ .
(
îî. /
	masterKey
îî/ 8
)
îî8 9
;
îî9 :
}
ïï 	
}
ðð 
private
òò 
async
òò 
Task
òò 
<
òò '
RegistrationAttemptResult
òò 0
>
òò0 12
$FinalizeAndCompleteRegistrationAsync
óó ,
(
óó, -
OpaqueClient
ôô 
opaqueClient
ôô %
,
ôô% &,
OpaqueRegistrationInitResponse
õõ *
initResponse
õõ+ 7
,
õõ7 8 
RegistrationResult
öö '
trackedRegistrationResult
öö 8
,
öö8 9

ByteString
÷÷ "
membershipIdentifier
÷÷ +
,
÷÷+ ,
uint
øø 
	connectId
øø 
,
øø 
RpcRequestContext
ùù 
requestContext
ùù ,
,
ùù, -
CancellationToken
úú 
cancellationToken
úú /
)
úú/ 0
{
ûû 
byte
üü 
[
üü 
]
üü (
serverRegistrationResponse
üü )
=
üü* +
new
üü, /
byte
üü0 4
[
üü4 5
initResponse
üü5 A
.
üüA B
PeerOprf
üüB J
.
üüJ K
Length
üüK Q
]
üüQ R
;
üüR S
byte
ýý 
[
ýý 
]
ýý 
?
ýý  
registrationRecord
ýý "
=
ýý# $
null
ýý% )
;
ýý) *
byte
þþ 
[
þþ 
]
þþ 
?
þþ 
	masterKey
þþ 
=
þþ 
null
þþ  
;
þþ  !
try
€€ 
{
 	
initResponse
‚‚ 
.
‚‚ 
PeerOprf
‚‚ !
.
‚‚! "
Span
‚‚" &
.
‚‚& '
CopyTo
‚‚' -
(
‚‚- .(
serverRegistrationResponse
‚‚. H
)
‚‚H I
;
‚‚I J
(
„„ 
byte
„„ 
[
„„ 
]
„„ 
record
„„ 
,
„„ 
byte
„„  
[
„„  !
]
„„! " 
generatedMasterKey
„„# 5
)
„„5 6
=
„„7 8
opaqueClient
…… 
.
…… "
FinalizeRegistration
…… 1
(
……1 2(
serverRegistrationResponse
……2 L
,
……L M'
trackedRegistrationResult
……N g
)
……g h
;
……h i 
registrationRecord
†† 
=
††  
record
††! '
;
††' (
	masterKey
‡‡ 
=
‡‡  
generatedMasterKey
‡‡ *
;
‡‡* +/
!OpaqueRegistrationCompleteRequest
‰‰ -
completeRequest
‰‰. =
=
‰‰> ?
new
‰‰@ C
(
‰‰C D
)
‰‰D E
{
ŠŠ $
PeerRegistrationRecord
‹‹ &
=
‹‹' (

ByteString
‹‹) 3
.
‹‹3 4
CopyFrom
‹‹4 <
(
‹‹< = 
registrationRecord
‹‹= O
)
‹‹O P
,
‹‹P Q"
MembershipIdentifier
ŒŒ $
=
ŒŒ% &"
membershipIdentifier
ŒŒ' ;
,
ŒŒ; <
	MasterKey
 
=
 

ByteString
 &
.
& '
CopyFrom
' /
(
/ 0
	masterKey
0 9
)
9 :
}
ŽŽ 
;
ŽŽ "
TaskCompletionSource
  
<
  !0
"OpaqueRegistrationCompleteResponse
! C
>
C D
responseSource
E S
=
T U
new
‘‘ 
(
‘‘ !
TaskCreationOptions
‘‘ '
.
‘‘' (,
RunContinuationsAsynchronously
‘‘( F
)
‘‘F G
;
‘‘G H
Result
““ 
<
““ 
Unit
““ 
,
““ 
NetworkFailure
““ '
>
““' (
networkResult
““) 6
=
““7 8
await
““9 >
networkProvider
““? N
.
““N O&
ExecuteUnaryRequestAsync
““O g
(
““g h
	connectId
”” 
,
”” 
RpcServiceType
•• "
.
••" #"
RegistrationComplete
••# 7
,
••7 8%
SecureByteStringInterop
–– +
.
––+ ,"
WithByteStringAsSpan
––, @
(
––@ A
completeRequest
––A P
.
––P Q
ToByteString
––Q ]
(
––] ^
)
––^ _
,
––_ `
span
—— 
=>
—— 
span
——  $
.
——$ %
ToArray
——% ,
(
——, -
)
——- .
)
——. /
,
——/ 0
payload
˜˜ 
=>
˜˜ 
{
™™ 0
"OpaqueRegistrationCompleteResponse
šš :
response
šš; C
=
ššD E
Helpers
›› #
.
››# $
ParseFromBytes
››$ 2
<
››2 30
"OpaqueRegistrationCompleteResponse
››3 U
>
››U V
(
››V W
payload
››W ^
)
››^ _
;
››_ `
responseSource
œœ &
.
œœ& '
TrySetResult
œœ' 3
(
œœ3 4
response
œœ4 <
)
œœ< =
;
œœ= >
return
žž 
Task
žž #
.
žž# $

FromResult
žž$ .
(
žž. /
Result
žž/ 5
<
žž5 6
Unit
žž6 :
,
žž: ;
NetworkFailure
žž< J
>
žžJ K
.
žžK L
Ok
žžL N
(
žžN O
Unit
žžO S
.
žžS T
Value
žžT Y
)
žžY Z
)
žžZ [
;
žž[ \
}
ŸŸ 
,
ŸŸ 
true
   
,
   
cancellationToken
¡¡ %
,
¡¡% &
requestContext
¢¢ "
:
¢¢" #
requestContext
¢¢$ 2
)
¢¢2 3
.
££ 
ConfigureAwait
££ 
(
££  
false
££  %
)
££% &
;
££& '
if
¥¥ 
(
¥¥ 
networkResult
¥¥ 
.
¥¥ 
IsErr
¥¥ #
)
¥¥# $
{
¦¦ 
return
§§ "
CreateAttemptFailure
§§ +
(
§§+ ,"
FormatNetworkFailure
¨¨ (
(
¨¨( )
networkResult
¨¨) 6
.
¨¨6 7
	UnwrapErr
¨¨7 @
(
¨¨@ A
)
¨¨A B
)
¨¨B C
,
¨¨C D,
IsTransientRegistrationFailure
©© 2
(
©©2 3
networkResult
©©3 @
.
©©@ A
	UnwrapErr
©©A J
(
©©J K
)
©©K L
)
©©L M
)
©©M N
;
©©N O
}
ªª 0
"OpaqueRegistrationCompleteResponse
¬¬ .
completeResponse
¬¬/ ?
=
¬¬@ A
await
­­ 
responseSource
­­ $
.
­­$ %
Task
­­% )
.
­­) *
ConfigureAwait
­­* 8
(
­­8 9
false
­­9 >
)
­­> ?
;
­­? @
if
¯¯ 
(
¯¯ 
completeResponse
¯¯  
.
¯¯  !
Result
¯¯! '
!=
¯¯( *0
"OpaqueRegistrationCompleteResponse
¯¯+ M
.
¯¯M N
Types
¯¯N S
.
¯¯S T 
RegistrationResult
¯¯T f
.
¯¯f g
	Succeeded
¯¯g p
)
¯¯p q
{
°° 
return
±± "
CreateAttemptFailure
±± +
(
±±+ ,!
localizationService
²² '
[
²²' (%
AuthenticationConstants
²²( ?
.
²²? @%
REGISTRATION_FAILED_KEY
²²@ W
]
²²W X
,
²²X Y
false
³³ 
)
³³ 
;
³³ 
}
´´ 
if
¶¶ 
(
¶¶ 
completeResponse
¶¶  
.
¶¶  !
ActiveAccount
¶¶! .
?
¶¶. /
.
¶¶/ 0
UniqueIdentifier
¶¶0 @
!=
¶¶A C
null
¶¶D H
)
¶¶H I
{
·· 
await
¸¸ .
 applicationSecureStorageProvider
¸¸ 6
.
¹¹ &
SetCurrentAccountIdAsync
¹¹ -
(
¹¹- .
completeResponse
¹¹. >
.
¹¹> ?
ActiveAccount
¹¹? L
.
¹¹L M
UniqueIdentifier
¹¹M ]
)
¹¹] ^
.
ºº 
ConfigureAwait
ºº #
(
ºº# $
false
ºº$ )
)
ºº) *
;
ºº* +
}
»» 
return
½½ "
CreateAttemptSuccess
½½ '
(
½½' (
)
½½( )
;
½½) *
}
¾¾ 	
finally
¿¿ 
{
ÀÀ 	.
 CleanupSensitiveRegistrationData
ÁÁ ,
(
ÁÁ, -
null
ÁÁ- 1
,
ÁÁ1 2(
serverRegistrationResponse
ÁÁ3 M
,
ÁÁM N 
registrationRecord
ÁÁO a
,
ÁÁa b
	masterKey
ÁÁc l
)
ÁÁl m
;
ÁÁm n
}
ÂÂ 	
}
ÃÃ 
private
ÅÅ 
async
ÅÅ 
Task
ÅÅ 
<
ÅÅ '
RegistrationAttemptResult
ÅÅ 0
>
ÅÅ0 15
'ExecuteCompleteRegistrationAttemptAsync
ÅÅ2 Y
(
ÅÅY Z

ByteString
ÆÆ "
membershipIdentifier
ÆÆ '
,
ÆÆ' (
SensitiveBytes
ÇÇ 
	secureKey
ÇÇ  
,
ÇÇ  !
uint
ÈÈ 
	connectId
ÈÈ 
,
ÈÈ 
int
ÉÉ 
attempt
ÉÉ 
,
ÉÉ 
CancellationToken
ÊÊ 
cancellationToken
ÊÊ +
)
ÊÊ+ ,
{
ËË 
RpcRequestContext
ÌÌ 
requestContext
ÌÌ (
=
ÌÌ) *
RpcRequestContext
ÌÌ+ <
.
ÌÌ< =
	CreateNew
ÌÌ= F
(
ÌÌF G
attempt
ÌÌG N
)
ÌÌN O
;
ÌÌO P
const
ÍÍ 
int
ÍÍ 
maxIterations
ÍÍ 
=
ÍÍ  !
$num
ÍÍ" #
;
ÍÍ# $
for
ÏÏ 
(
ÏÏ 
int
ÏÏ 
	iteration
ÏÏ 
=
ÏÏ 
$num
ÏÏ 
;
ÏÏ 
	iteration
ÏÏ  )
<
ÏÏ* +
maxIterations
ÏÏ, 9
;
ÏÏ9 :
	iteration
ÏÏ; D
++
ÏÏD F
)
ÏÏF G
{
ÐÐ 	
cancellationToken
ÑÑ 
.
ÑÑ *
ThrowIfCancellationRequested
ÑÑ :
(
ÑÑ: ;
)
ÑÑ; <
;
ÑÑ< =
bool
ÓÓ 
allowReinit
ÓÓ 
=
ÓÓ 
	iteration
ÓÓ (
==
ÓÓ) +
$num
ÓÓ, -
;
ÓÓ- .
using
ÕÕ 
OpaqueClient
ÕÕ 
opaqueClient
ÕÕ +
=
ÕÕ, -
new
ÕÕ. 1
(
ÕÕ1 2%
serverPublicKeyProvider
ÕÕ2 I
.
ÕÕI J 
GetServerPublicKey
ÕÕJ \
(
ÕÕ\ ]
)
ÕÕ] ^
)
ÕÕ^ _
;
ÕÕ_ `'
RegistrationAttemptResult
×× %
result
××& ,
=
××- .
await
××/ 4.
 TryExecuteRegistrationCycleAsync
××5 U
(
××U V
opaqueClient
ØØ 
,
ØØ "
membershipIdentifier
ÙÙ $
,
ÙÙ$ %
	secureKey
ÚÚ 
,
ÚÚ 
	connectId
ÛÛ 
,
ÛÛ 
requestContext
ÜÜ 
,
ÜÜ 
cancellationToken
ÝÝ !
)
ÝÝ! "
.
ÝÝ" #
ConfigureAwait
ÝÝ# 1
(
ÝÝ1 2
false
ÝÝ2 7
)
ÝÝ7 8
;
ÝÝ8 9
if
ßß 
(
ßß 
result
ßß 
.
ßß 
Outcome
ßß 
.
ßß 
IsOk
ßß #
||
ßß$ &
!
ßß' (
allowReinit
ßß( 3
||
ßß4 6
!
ßß7 8
result
ßß8 >
.
ßß> ?
IsTransient
ßß? J
)
ßßJ K
{
àà 
return
áá 
result
áá 
;
áá 
}
ââ 
requestContext
ää 
.
ää !
MarkReinitAttempted
ää .
(
ää. /
)
ää/ 0
;
ää0 1
}
åå 	
return
çç "
CreateAttemptFailure
çç #
(
çç# $!
localizationService
èè 
[
èè  %
AuthenticationConstants
èè  7
.
èè7 8%
REGISTRATION_FAILED_KEY
èè8 O
]
èèO P
,
èèP Q
false
éé 
)
éé 
;
éé 
}
êê 
private
ìì 
async
ìì 
Task
ìì 
<
ìì '
RegistrationAttemptResult
ìì 0
>
ìì0 1.
 TryExecuteRegistrationCycleAsync
ìì2 R
(
ììR S
OpaqueClient
íí 
opaqueClient
íí !
,
íí! "

ByteString
îî "
membershipIdentifier
îî '
,
îî' (
SensitiveBytes
ïï 
	secureKey
ïï  
,
ïï  !
uint
ðð 
	connectId
ðð 
,
ðð 
RpcRequestContext
ññ 
requestContext
ññ (
,
ññ( )
CancellationToken
òò 
cancellationToken
òò +
)
òò+ ,
{
óó 
byte
ôô 
[
ôô 
]
ôô 
?
ôô 
secureKeyCopy
ôô 
=
ôô 
null
ôô  $
;
ôô$ % 
RegistrationResult
õõ 
?
õõ  
registrationResult
õõ .
=
õõ/ 0
null
õõ1 5
;
õõ5 6
try
÷÷ 
{
øø 	
Result
ùù 
<
ùù (
SecureKeyPreparationResult
ùù -
,
ùù- .'
RegistrationAttemptResult
ùù/ H
>
ùùH I
prepareResult
ùùJ W
=
ùùX Y-
PrepareSecureKeyForRegistration
úú /
(
úú/ 0
	secureKey
úú0 9
)
úú9 :
;
úú: ;
if
üü 
(
üü 
prepareResult
üü 
.
üü 
IsErr
üü #
)
üü# $
{
ýý 
return
þþ 
prepareResult
þþ $
.
þþ$ %
	UnwrapErr
þþ% .
(
þþ. /
)
þþ/ 0
;
þþ0 1
}
ÿÿ 
secureKeyCopy
 
=
 
prepareResult
 )
.
) *
Unwrap
* 0
(
0 1
)
1 2
.
2 3
SecureKeyCopy
3 @
;
@ A
Result
ƒƒ 
<
ƒƒ  
RegistrationResult
ƒƒ %
,
ƒƒ% &'
RegistrationAttemptResult
ƒƒ' @
>
ƒƒ@ A
stateResult
ƒƒB M
=
ƒƒN O-
CreateAndTrackRegistrationState
„„ /
(
„„/ 0
opaqueClient
„„0 <
,
„„< =
secureKeyCopy
„„> K
,
„„K L"
membershipIdentifier
„„M a
)
„„a b
;
„„b c
if
†† 
(
†† 
stateResult
†† 
.
†† 
IsErr
†† !
)
††! "
{
‡‡ 
return
ˆˆ 
stateResult
ˆˆ "
.
ˆˆ" #
	UnwrapErr
ˆˆ# ,
(
ˆˆ, -
)
ˆˆ- .
;
ˆˆ. /
}
‰‰  
registrationResult
‹‹ 
=
‹‹  
stateResult
‹‹! ,
.
‹‹, -
Unwrap
‹‹- 3
(
‹‹3 4
)
‹‹4 5
;
‹‹5 6'
RegistrationAttemptResult
 %
attemptResult
& 3
=
4 5
await
6 ;.
 ExecuteRegistrationWorkflowAsync
< \
(
\ ]
opaqueClient
ŽŽ 
,
ŽŽ "
membershipIdentifier
 $
,
$ % 
registrationResult
 "
,
" #
	connectId
‘‘ 
,
‘‘ 
requestContext
’’ 
,
’’ 
cancellationToken
““ !
)
““! "
.
““" #
ConfigureAwait
““# 1
(
““1 2
false
““2 7
)
““7 8
;
““8 9(
CleanupTrackedRegistration
•• &
(
••& '"
membershipIdentifier
••' ;
)
••; <
;
••< =
return
–– 
attemptResult
––  
;
––  !
}
—— 	
catch
˜˜ 
(
˜˜ (
OperationCanceledException
˜˜ )
)
˜˜) *
when
˜˜+ /
(
˜˜0 1
cancellationToken
˜˜1 B
.
˜˜B C%
IsCancellationRequested
˜˜C Z
)
˜˜Z [
{
™™ 	
throw
šš 
;
šš 
}
›› 	
catch
œœ 
(
œœ 
	Exception
œœ 
ex
œœ 
)
œœ 
{
 	)
HandleRegistrationException
žž '
(
žž' ("
membershipIdentifier
žž( <
,
žž< =
ref
žž> A 
registrationResult
žžB T
)
žžT U
;
žžU V
return
ŸŸ "
CreateAttemptFailure
ŸŸ '
(
ŸŸ' (!
localizationService
   #
[
  # $%
AuthenticationConstants
  $ ;
.
  ; <%
REGISTRATION_FAILED_KEY
  < S
]
  S T
,
  T U"
IsTransientException
¡¡ $
(
¡¡$ %
ex
¡¡% '
)
¡¡' (
)
¡¡( )
;
¡¡) *
}
¢¢ 	
finally
££ 
{
¤¤ 	 
registrationResult
¥¥ 
?
¥¥ 
.
¥¥  
Dispose
¥¥  '
(
¥¥' (
)
¥¥( )
;
¥¥) *.
 CleanupSensitiveRegistrationData
¦¦ ,
(
¦¦, -
secureKeyCopy
¦¦- :
,
¦¦: ;
null
¦¦< @
,
¦¦@ A
null
¦¦B F
,
¦¦F G
null
¦¦H L
)
¦¦L M
;
¦¦M N
}
§§ 	
}
¨¨ 
private
ªª 
Result
ªª 
<
ªª (
SecureKeyPreparationResult
ªª -
,
ªª- .'
RegistrationAttemptResult
ªª/ H
>
ªªH I-
PrepareSecureKeyForRegistration
ªªJ i
(
ªªi j
SensitiveBytes
«« 
	secureKey
««  
)
««  !
{
¬¬ 
byte
­­ 
[
­­ 
]
­­ 
?
­­ 
secureKeyCopy
­­ 
=
­­ 
null
­­  $
;
­­$ %
Result
¯¯ 
<
¯¯ 
Unit
¯¯ 
,
¯¯ 
SodiumFailure
¯¯ "
>
¯¯" #!
readSecureKeyResult
¯¯$ 7
=
¯¯8 9
	secureKey
¯¯: C
.
¯¯C D
WithReadAccess
¯¯D R
(
¯¯R S
span
¯¯S W
=>
¯¯X Z
{
°° 	
secureKeyCopy
±± 
=
±± 
span
±±  
.
±±  !
ToArray
±±! (
(
±±( )
)
±±) *
;
±±* +
return
²² 
Result
²² 
<
²² 
Unit
²² 
,
²² 
SodiumFailure
²²  -
>
²²- .
.
²². /
Ok
²²/ 1
(
²²1 2
Unit
²²2 6
.
²²6 7
Value
²²7 <
)
²²< =
;
²²= >
}
³³ 	
)
³³	 

;
³³
 
if
µµ 

(
µµ !
readSecureKeyResult
µµ 
.
µµ  
IsErr
µµ  %
)
µµ% &
{
¶¶ 	
return
·· 
Result
·· 
<
·· (
SecureKeyPreparationResult
·· 4
,
··4 5'
RegistrationAttemptResult
··6 O
>
··O P
.
··P Q
Err
··Q T
(
··T U"
CreateAttemptFailure
¸¸ $
(
¸¸$ %
$"
¹¹ 
$str
¹¹ 1
{
¹¹1 2!
readSecureKeyResult
¹¹2 E
.
¹¹E F
	UnwrapErr
¹¹F O
(
¹¹O P
)
¹¹P Q
.
¹¹Q R
Message
¹¹R Y
}
¹¹Y Z
"
¹¹Z [
,
¹¹[ \
false
ºº 
)
ºº 
)
ºº 
;
ºº 
}
»» 	
Result
½½ 
<
½½ 
byte
½½ 
[
½½ 
]
½½ 
,
½½ '
RegistrationAttemptResult
½½ 0
>
½½0 1
validationResult
½½2 B
=
½½C D#
ValidateSecureKeyCopy
¾¾ !
(
¾¾! "
secureKeyCopy
¾¾" /
)
¾¾/ 0
;
¾¾0 1
if
ÀÀ 

(
ÀÀ 
validationResult
ÀÀ 
.
ÀÀ 
IsErr
ÀÀ "
)
ÀÀ" #
{
ÁÁ 	
return
ÂÂ 
Result
ÂÂ 
<
ÂÂ (
SecureKeyPreparationResult
ÂÂ 4
,
ÂÂ4 5'
RegistrationAttemptResult
ÂÂ6 O
>
ÂÂO P
.
ÂÂP Q
Err
ÂÂQ T
(
ÂÂT U
validationResult
ÂÂU e
.
ÂÂe f
	UnwrapErr
ÂÂf o
(
ÂÂo p
)
ÂÂp q
)
ÂÂq r
;
ÂÂr s
}
ÃÃ 	
return
ÅÅ 
Result
ÅÅ 
<
ÅÅ (
SecureKeyPreparationResult
ÅÅ 0
,
ÅÅ0 1'
RegistrationAttemptResult
ÅÅ2 K
>
ÅÅK L
.
ÅÅL M
Ok
ÅÅM O
(
ÅÅO P
new
ÆÆ (
SecureKeyPreparationResult
ÆÆ *
(
ÆÆ* +
secureKeyCopy
ÆÆ+ 8
!
ÆÆ8 9
)
ÆÆ9 :
)
ÆÆ: ;
;
ÆÆ; <
}
ÇÇ 
private
ÉÉ 
readonly
ÉÉ 
record
ÉÉ 
struct
ÉÉ "(
SecureKeyPreparationResult
ÉÉ# =
(
ÉÉ= >
byte
ÉÉ> B
[
ÉÉB C
]
ÉÉC D
SecureKeyCopy
ÉÉE R
)
ÉÉR S
;
ÉÉS T
private
ËË 
async
ËË 
Task
ËË 
<
ËË '
RegistrationAttemptResult
ËË 0
>
ËË0 1.
 ExecuteRegistrationWorkflowAsync
ËË2 R
(
ËËR S
OpaqueClient
ÌÌ 
opaqueClient
ÌÌ !
,
ÌÌ! "

ByteString
ÍÍ "
membershipIdentifier
ÍÍ '
,
ÍÍ' ( 
RegistrationResult
ÎÎ 
registrationState
ÎÎ ,
,
ÎÎ, -
uint
ÏÏ 
	connectId
ÏÏ 
,
ÏÏ 
RpcRequestContext
ÐÐ 
requestContext
ÐÐ (
,
ÐÐ( )
CancellationToken
ÑÑ 
cancellationToken
ÑÑ +
)
ÑÑ+ ,
{
ÒÒ 
Result
ÓÓ 
<
ÓÓ ,
OpaqueRegistrationInitResponse
ÓÓ -
,
ÓÓ- .
NetworkFailure
ÓÓ/ =
>
ÓÓ= >

initResult
ÓÓ? I
=
ÓÓJ K
await
ÔÔ -
InitiateOpaqueRegistrationAsync
ÔÔ 1
(
ÔÔ1 2"
membershipIdentifier
ÕÕ (
,
ÕÕ( )
registrationState
ÖÖ %
.
ÖÖ% &
GetRequestCopy
ÖÖ& 4
(
ÖÖ4 5
)
ÖÖ5 6
,
ÖÖ6 7
	connectId
×× 
,
×× 
requestContext
ØØ "
,
ØØ" #
cancellationToken
ÙÙ %
)
ÙÙ% &
.
ÚÚ 
ConfigureAwait
ÚÚ 
(
ÚÚ  
false
ÚÚ  %
)
ÚÚ% &
;
ÚÚ& '
if
ÜÜ 

(
ÜÜ 

initResult
ÜÜ 
.
ÜÜ 
IsErr
ÜÜ 
)
ÜÜ 
{
ÝÝ 	
NetworkFailure
ÞÞ 
failure
ÞÞ "
=
ÞÞ# $

initResult
ÞÞ% /
.
ÞÞ/ 0
	UnwrapErr
ÞÞ0 9
(
ÞÞ9 :
)
ÞÞ: ;
;
ÞÞ; <
registrationState
ßß 
.
ßß 
Dispose
ßß %
(
ßß% &
)
ßß& '
;
ßß' (
return
àà "
CreateAttemptFailure
àà '
(
àà' ("
FormatNetworkFailure
áá $
(
áá$ %
failure
áá% ,
)
áá, -
,
áá- .,
IsTransientRegistrationFailure
ââ .
(
ââ. /
failure
ââ/ 6
)
ââ6 7
)
ââ7 8
;
ââ8 9
}
ãã 	,
OpaqueRegistrationInitResponse
åå &
initResponse
åå' 3
=
åå4 5

initResult
åå6 @
.
åå@ A
Unwrap
ååA G
(
ååG H
)
ååH I
;
ååI J
Result
çç 
<
çç 
Unit
çç 
,
çç '
RegistrationAttemptResult
çç .
>
çç. /
initProcessing
çç0 >
=
çç? @+
ProcessInitializationResponse
èè )
(
èè) *
initResponse
èè* 6
,
èè6 7
registrationState
èè8 I
)
èèI J
;
èèJ K
if
êê 

(
êê 
initProcessing
êê 
.
êê 
IsErr
êê  
)
êê  !
{
ëë 	
return
ìì 
initProcessing
ìì !
.
ìì! "
	UnwrapErr
ìì" +
(
ìì+ ,
)
ìì, -
;
ìì- .
}
íí 	
return
ïï 
await
ïï 2
$FinalizeAndCompleteRegistrationAsync
ïï 9
(
ïï9 :
opaqueClient
ðð 
,
ðð 
initResponse
ññ 
,
ññ 
registrationState
òò 
,
òò "
membershipIdentifier
óó  
,
óó  !
	connectId
ôô 
,
ôô 
requestContext
õõ 
,
õõ 
cancellationToken
öö 
)
öö 
.
öö 
ConfigureAwait
öö -
(
öö- .
false
öö. 3
)
öö3 4
;
öö4 5
}
÷÷ 
private
ùù 
void
ùù (
CleanupTrackedRegistration
ùù +
(
ùù+ ,

ByteString
ùù, 6"
membershipIdentifier
ùù7 K
)
ùùK L
=>
ùùM O
_stateManager
úú 
.
úú !
CleanupRegistration
úú )
(
úú) *"
membershipIdentifier
úú* >
)
úú> ?
;
úú? @
private
üü 
void
üü )
HandleRegistrationException
üü ,
(
üü, -

ByteString
üü- 7"
membershipIdentifier
üü8 L
,
üüL M
ref
ýý  
RegistrationResult
ýý 
?
ýý  
registrationResult
ýý  2
)
ýý2 3
{
þþ 
_stateManager
ÿÿ 
.
ÿÿ !
CleanupRegistration
ÿÿ )
(
ÿÿ) *"
membershipIdentifier
ÿÿ* >
)
ÿÿ> ?
;
ÿÿ? @ 
registrationResult
€€ 
?
€€ 
.
€€ 
Dispose
€€ #
(
€€# $
)
€€$ %
;
€€% & 
registrationResult
 
=
 
null
 !
;
! "
}
‚‚ 
private
„„ 
static
„„ 
async
„„ 
Task
„„ 
<
„„ 
Result
„„ $
<
„„$ %
Unit
„„% )
,
„„) *
string
„„+ 1
>
„„1 2
>
„„2 3

RetryAsync
„„4 >
(
„„> ?
int
…… 
maxAttempts
…… 
,
…… 
Func
†† 
<
†† 
int
†† 
,
†† 
CancellationToken
†† #
,
††# $
Task
††% )
<
††) *'
RegistrationAttemptResult
††* C
>
††C D
>
††D E
attemptFactory
††F T
,
††T U
CancellationToken
‡‡ 
cancellationToken
‡‡ +
)
‡‡+ ,
{
ˆˆ '
RegistrationAttemptResult
‰‰ !

lastResult
‰‰" ,
=
‰‰- .
default
‰‰/ 6
;
‰‰6 7
for
‹‹ 
(
‹‹ 
int
‹‹ 
attempt
‹‹ 
=
‹‹ 
$num
‹‹ 
;
‹‹ 
attempt
‹‹ %
<=
‹‹& (
maxAttempts
‹‹) 4
;
‹‹4 5
attempt
‹‹6 =
++
‹‹= ?
)
‹‹? @
{
ŒŒ 	
cancellationToken
 
.
 *
ThrowIfCancellationRequested
 :
(
: ;
)
; <
;
< ='
RegistrationAttemptResult
 %
attemptResult
& 3
=
4 5
await
 
attemptFactory
 $
(
$ %
attempt
% ,
,
, -
cancellationToken
. ?
)
? @
.
@ A
ConfigureAwait
A O
(
O P
false
P U
)
U V
;
V W
if
’’ 
(
’’ 
attemptResult
’’ 
.
’’ 
Outcome
’’ %
.
’’% &
IsOk
’’& *
)
’’* +
{
““ 
return
”” 
attemptResult
”” $
.
””$ %
Outcome
””% ,
;
””, -
}
•• 

lastResult
—— 
=
—— 
attemptResult
—— &
;
——& '
if
™™ 
(
™™ 
!
™™ 
attemptResult
™™ 
.
™™ 
IsTransient
™™ *
||
™™+ -
attempt
™™. 5
==
™™6 8
maxAttempts
™™9 D
)
™™D E
{
šš 
return
›› 
attemptResult
›› $
.
››$ %
Outcome
››% ,
;
››, -
}
œœ 
}
 	
return
ŸŸ 

lastResult
ŸŸ 
.
ŸŸ 
Outcome
ŸŸ !
;
ŸŸ! "
}
   
private
¢¢ 
static
¢¢ 
string
¢¢ "
FormatNetworkFailure
¢¢ .
(
¢¢. /
NetworkFailure
¢¢/ =
failure
¢¢> E
)
¢¢E F
=>
¢¢G I
$"
££ 

{
££
 %
AuthenticationConstants
££ "
.
££" #)
REGISTRATION_FAILURE_PREFIX
££# >
}
££> ?
{
££? @
(
££@ A
failure
££A H
.
££H I
	UserError
££I R
?
££R S
.
££S T
Message
££T [
??
££\ ^
failure
££_ f
.
££f g
Message
££g n
)
££n o
}
££o p
"
££p q
;
££q r
private
¥¥ 
async
¥¥ 
Task
¥¥ 
<
¥¥ 
Result
¥¥ 
<
¥¥ ,
OpaqueRegistrationInitResponse
¥¥ <
,
¥¥< =
NetworkFailure
¥¥> L
>
¥¥L M
>
¥¥M N-
InitiateOpaqueRegistrationAsync
¥¥O n
(
¥¥n o

ByteString
¦¦ "
membershipIdentifier
¦¦ '
,
¦¦' (
byte
§§ 
[
§§ 
]
§§ !
registrationRequest
§§ "
,
§§" #
uint
¨¨ 
	connectId
¨¨ 
,
¨¨ 
RpcRequestContext
©© 
requestContext
©© (
,
©©( )
CancellationToken
ªª 
cancellationToken
ªª +
)
ªª+ ,
{
«« 
if
¬¬ 

(
¬¬ "
membershipIdentifier
¬¬  
.
¬¬  !
IsEmpty
¬¬! (
)
¬¬( )
{
­­ 	
return
®® 
Result
®® 
<
®® ,
OpaqueRegistrationInitResponse
®® 8
,
®®8 9
NetworkFailure
®®: H
>
®®H I
.
®®I J
Err
®®J M
(
®®M N
NetworkFailure
¯¯ 
.
¯¯  
InvalidRequestType
¯¯ 1
(
¯¯1 2!
localizationService
°° '
[
°°' (%
AuthenticationConstants
°°( ?
.
°°? @0
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY
°°@ b
]
°°b c
)
°°c d
)
°°d e
;
°°e f
}
±± 	+
OpaqueRegistrationInitRequest
³³ %
request
³³& -
=
³³. /
new
³³0 3
(
³³3 4
)
³³4 5
{
´´ 	
PeerOprf
µµ 
=
µµ 

ByteString
µµ !
.
µµ! "
CopyFrom
µµ" *
(
µµ* +!
registrationRequest
µµ+ >
)
µµ> ?
,
µµ? @"
MembershipIdentifier
µµA U
=
µµV W"
membershipIdentifier
µµX l
}
¶¶ 	
;
¶¶	 
"
TaskCompletionSource
¸¸ 
<
¸¸ ,
OpaqueRegistrationInitResponse
¸¸ ;
>
¸¸; <
responseSource
¸¸= K
=
¸¸L M
new
¹¹ 
(
¹¹ !
TaskCreationOptions
¹¹ #
.
¹¹# $,
RunContinuationsAsynchronously
¹¹$ B
)
¹¹B C
;
¹¹C D
Result
»» 
<
»» 
Unit
»» 
,
»» 
NetworkFailure
»» #
>
»»# $
networkResult
»»% 2
=
»»3 4
await
»»5 :
networkProvider
»»; J
.
»»J K&
ExecuteUnaryRequestAsync
»»K c
(
»»c d
	connectId
¼¼ 
,
¼¼ 
RpcServiceType
½½ 
.
½½ 
RegistrationInit
½½ +
,
½½+ ,%
SecureByteStringInterop
¾¾ #
.
¾¾# $"
WithByteStringAsSpan
¾¾$ 8
(
¾¾8 9
request
¾¾9 @
.
¾¾@ A
ToByteString
¾¾A M
(
¾¾M N
)
¾¾N O
,
¾¾O P
span
¾¾Q U
=>
¾¾V X
span
¾¾Y ]
.
¾¾] ^
ToArray
¾¾^ e
(
¾¾e f
)
¾¾f g
)
¾¾g h
,
¾¾h i
payload
¾¾j q
=>
¾¾r t
{
¿¿ ,
OpaqueRegistrationInitResponse
ÀÀ .
response
ÀÀ/ 7
=
ÀÀ8 9
Helpers
ÁÁ 
.
ÁÁ 
ParseFromBytes
ÁÁ *
<
ÁÁ* +,
OpaqueRegistrationInitResponse
ÁÁ+ I
>
ÁÁI J
(
ÁÁJ K
payload
ÁÁK R
)
ÁÁR S
;
ÁÁS T
responseSource
ÂÂ 
.
ÂÂ 
TrySetResult
ÂÂ +
(
ÂÂ+ ,
response
ÂÂ, 4
)
ÂÂ4 5
;
ÂÂ5 6
return
ÄÄ 
Task
ÄÄ 
.
ÄÄ 

FromResult
ÄÄ &
(
ÄÄ& '
Result
ÄÄ' -
<
ÄÄ- .
Unit
ÄÄ. 2
,
ÄÄ2 3
NetworkFailure
ÄÄ4 B
>
ÄÄB C
.
ÄÄC D
Ok
ÄÄD F
(
ÄÄF G
Unit
ÄÄG K
.
ÄÄK L
Value
ÄÄL Q
)
ÄÄQ R
)
ÄÄR S
;
ÄÄS T
}
ÅÅ 
,
ÅÅ 
true
ÅÅ 
,
ÅÅ 
cancellationToken
ÅÅ &
,
ÅÅ& '
requestContext
ÅÅ( 6
:
ÅÅ6 7
requestContext
ÅÅ8 F
)
ÅÅF G
.
ÅÅG H
ConfigureAwait
ÅÅH V
(
ÅÅV W
false
ÅÅW \
)
ÅÅ\ ]
;
ÅÅ] ^
if
ÇÇ 

(
ÇÇ 
networkResult
ÇÇ 
.
ÇÇ 
IsErr
ÇÇ 
)
ÇÇ  
{
ÈÈ 	
return
ÉÉ 
Result
ÉÉ 
<
ÉÉ ,
OpaqueRegistrationInitResponse
ÉÉ 8
,
ÉÉ8 9
NetworkFailure
ÉÉ: H
>
ÉÉH I
.
ÉÉI J
Err
ÉÉJ M
(
ÉÉM N
networkResult
ÉÉN [
.
ÉÉ[ \
	UnwrapErr
ÉÉ\ e
(
ÉÉe f
)
ÉÉf g
)
ÉÉg h
;
ÉÉh i
}
ÊÊ 	,
OpaqueRegistrationInitResponse
ÌÌ &
initResponse
ÌÌ' 3
=
ÌÌ4 5
await
ÌÌ6 ;
responseSource
ÌÌ< J
.
ÌÌJ K
Task
ÌÌK O
.
ÌÌO P
ConfigureAwait
ÌÌP ^
(
ÌÌ^ _
false
ÌÌ_ d
)
ÌÌd e
;
ÌÌe f
return
ÍÍ 
Result
ÍÍ 
<
ÍÍ ,
OpaqueRegistrationInitResponse
ÍÍ 4
,
ÍÍ4 5
NetworkFailure
ÍÍ6 D
>
ÍÍD E
.
ÍÍE F
Ok
ÍÍF H
(
ÍÍH I
initResponse
ÍÍI U
)
ÍÍU V
;
ÍÍV W
}
ÎÎ 
private
ÐÐ 
void
ÐÐ '
ProcessVerificationUpdate
ÐÐ *
(
ÐÐ* +)
VerificationCountdownUpdate
ÑÑ #)
verificationCountdownUpdate
ÑÑ$ ?
,
ÑÑ? @
Guid
ÒÒ $
verificationIdentifier
ÒÒ #
,
ÒÒ# $
uint
ÓÓ 
streamConnectId
ÓÓ 
,
ÓÓ !
VerificationPurpose
ÔÔ 
purpose
ÔÔ #
,
ÔÔ# $
Action
ÕÕ 
<
ÕÕ 
uint
ÕÕ 
,
ÕÕ 
Guid
ÕÕ 
,
ÕÕ )
VerificationCountdownUpdate
ÕÕ 6
.
ÕÕ6 7
Types
ÕÕ7 <
.
ÕÕ< =#
CountdownUpdateStatus
ÕÕ= R
,
ÕÕR S
string
ÕÕT Z
?
ÕÕZ [
>
ÕÕ[ \
?
ÕÕ\ ]
onCountdownUpdate
ÕÕ^ o
)
ÕÕo p
{
ÖÖ 
_streamManager
×× 
.
×× '
ProcessVerificationUpdate
×× 0
(
××0 1$
verificationIdentifier
ØØ "
,
ØØ" #
streamConnectId
ÙÙ 
,
ÙÙ )
verificationCountdownUpdate
ÚÚ '
.
ÚÚ' (
Status
ÚÚ( .
,
ÚÚ. /
purpose
ÛÛ 
)
ÛÛ 
;
ÛÛ 
RxApp
ÝÝ 
.
ÝÝ !
MainThreadScheduler
ÝÝ !
.
ÝÝ! "
Schedule
ÝÝ" *
(
ÝÝ* +
(
ÝÝ+ ,
)
ÝÝ, -
=>
ÝÝ. 0
onCountdownUpdate
ÞÞ 
?
ÞÞ 
.
ÞÞ 
Invoke
ÞÞ %
(
ÞÞ% &)
verificationCountdownUpdate
ßß +
.
ßß+ ,
SecondsRemaining
ßß, <
,
ßß< =$
verificationIdentifier
àà &
,
àà& ')
verificationCountdownUpdate
áá +
.
áá+ ,
Status
áá, 2
,
áá2 3)
verificationCountdownUpdate
ââ +
.
ââ+ ,
Message
ââ, 3
)
ââ3 4
)
ââ4 5
;
ââ5 6
}
ãã 
private
åå 
Task
åå 
<
åå 
Result
åå 
<
åå 
Unit
åå 
,
åå 
NetworkFailure
åå ,
>
åå, -
>
åå- ..
 HandleVerificationStreamResponse
åå/ O
(
ååO P
byte
ææ 
[
ææ 
]
ææ 
payload
ææ 
,
ææ 
uint
çç 
streamConnectId
çç 
,
çç 
Action
èè 
<
èè 
uint
èè 
,
èè 
Guid
èè 
,
èè )
VerificationCountdownUpdate
èè 6
.
èè6 7
Types
èè7 <
.
èè< =#
CountdownUpdateStatus
èè= R
,
èèR S
string
èèT Z
?
èèZ [
>
èè[ \
?
èè\ ]
onCountdownUpdate
èè^ o
,
èèo p!
VerificationPurpose
éé 
purpose
éé #
=
éé$ %!
VerificationPurpose
éé& 9
.
éé9 :
Registration
éé: F
)
ééF G
{
êê )
VerificationCountdownUpdate
ëë #)
verificationCountdownUpdate
ëë$ ?
=
ëë@ A
Helpers
ìì 
.
ìì 
ParseFromBytes
ìì "
<
ìì" #)
VerificationCountdownUpdate
ìì# >
>
ìì> ?
(
ìì? @
payload
ìì@ G
)
ììG H
;
ììH I
if
îî 

(
îî )
verificationCountdownUpdate
îî '
.
îî' (
SessionIdentifier
îî( 9
==
îî: <
null
îî= A
||
îîB D)
verificationCountdownUpdate
ïï '
.
ïï' (
SessionIdentifier
ïï( 9
.
ïï9 :
IsEmpty
ïï: A
)
ïïA B
{
ðð 	
RxApp
ññ 
.
ññ !
MainThreadScheduler
ññ %
.
ññ% &
Schedule
ññ& .
(
ññ. /
(
ññ/ 0
)
ññ0 1
=>
ññ2 4
onCountdownUpdate
òò !
?
òò! "
.
òò" #
Invoke
òò# )
(
òò) *
$num
òò* +
,
òò+ ,
Guid
òò- 1
.
òò1 2
Empty
òò2 7
,
òò7 8)
VerificationCountdownUpdate
óó /
.
óó/ 0
Types
óó0 5
.
óó5 6#
CountdownUpdateStatus
óó6 K
.
óóK L
Failed
óóL R
,
óóR S)
verificationCountdownUpdate
ôô /
.
ôô/ 0
Message
ôô0 7
)
ôô7 8
)
ôô8 9
;
ôô9 :
return
õõ 
Task
õõ 
.
õõ 

FromResult
õõ "
(
õõ" #
Result
õõ# )
<
õõ) *
Unit
õõ* .
,
õõ. /
NetworkFailure
õõ0 >
>
õõ> ?
.
õõ? @
Ok
õõ@ B
(
õõB C
Unit
õõC G
.
õõG H
Value
õõH M
)
õõM N
)
õõN O
;
õõO P
}
öö 	
try
øø 
{
ùù 	
Guid
úú $
verificationIdentifier
úú '
=
úú( )
Helpers
úú* 1
.
úú1 2"
FromByteStringToGuid
úú2 F
(
úúF G)
verificationCountdownUpdate
úúG b
.
úúb c
SessionIdentifier
úúc t
)
úút u
;
úúu v'
ProcessVerificationUpdate
ûû %
(
ûû% &)
verificationCountdownUpdate
ûû& A
,
ûûA B$
verificationIdentifier
ûûC Y
,
ûûY Z
streamConnectId
ûû[ j
,
ûûj k
purpose
ûûl s
,
ûûs t
onCountdownUpdate
üü !
)
üü! "
;
üü" #
return
ýý 
Task
ýý 
.
ýý 

FromResult
ýý "
(
ýý" #
Result
ýý# )
<
ýý) *
Unit
ýý* .
,
ýý. /
NetworkFailure
ýý0 >
>
ýý> ?
.
ýý? @
Ok
ýý@ B
(
ýýB C
Unit
ýýC G
.
ýýG H
Value
ýýH M
)
ýýM N
)
ýýN O
;
ýýO P
}
þþ 	
catch
ÿÿ 
(
ÿÿ 
	Exception
ÿÿ 
ex
ÿÿ 
)
ÿÿ 
{
€€ 	
return
 
Task
 
.
 

FromResult
 "
(
" #
Result
# )
<
) *
Unit
* .
,
. /
NetworkFailure
0 >
>
> ?
.
? @
Err
@ C
(
C D
NetworkFailure
‚‚ 
.
‚‚ %
DataCenterNotResponding
‚‚ 6
(
‚‚6 7
$"
ƒƒ 
{
ƒƒ %
AuthenticationConstants
ƒƒ .
.
ƒƒ. /$
NETWORK_FAILURE_PREFIX
ƒƒ/ E
}
ƒƒE F
{
ƒƒF G
ex
ƒƒG I
.
ƒƒI J
Message
ƒƒJ Q
}
ƒƒQ R
"
ƒƒR S
)
ƒƒS T
)
ƒƒT U
)
ƒƒU V
;
ƒƒV W
}
„„ 	
}
…… 
private
‡‡ 
async
‡‡ 
Task
‡‡ 
<
‡‡ 
Result
‡‡ 
<
‡‡ 
Unit
‡‡ "
,
‡‡" #
string
‡‡$ *
>
‡‡* +
>
‡‡+ , 
CleanupStreamAsync
‡‡- ?
(
‡‡? @
Guid
‡‡@ D
sessionIdentifier
‡‡E V
)
‡‡V W
=>
‡‡X Z
await
ˆˆ 
_streamManager
ˆˆ 
.
ˆˆ 
CloseStreamAsync
ˆˆ -
(
ˆˆ- .
sessionIdentifier
ˆˆ. ?
)
ˆˆ? @
.
ˆˆ@ A
ConfigureAwait
ˆˆA O
(
ˆˆO P
false
ˆˆP U
)
ˆˆU V
;
ˆˆV W
}‰‰ Ë
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/SignInResult.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
;/ 0
public 
sealed 
record 
SignInResult !
(! "
Option 

<
 
Protobuf 
. 

Membership 
. 

Membership )
>) *

Membership+ 5
,5 6
Option 

<
 
Account 
> 
ActiveAccount !
)! "
;" #Œ:
€/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/SensitiveBytes.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
;/ 0
internal 
sealed	 
class 
SensitiveBytes $
:% &
IDisposable' 2
{		 
private

 $
SodiumSecureMemoryHandle

 $
?

$ %
_handle

& -
;

- .
private 
int 
_length 
; 
private 
bool 
	_disposed 
; 
private 
SensitiveBytes 
( $
SodiumSecureMemoryHandle 3
handle4 :
,: ;
int< ?
length@ F
)F G
{ 
_handle 
= 
handle 
; 
_length 
= 
length 
; 
} 
public 

int 
Length 
{ 
get 
{ 	
EnsureNotDisposed 
( 
) 
;  
return 
_length 
; 
} 	
} 
public 

static 
Result 
< 
SensitiveBytes '
,' (
SodiumFailure) 6
>6 7
From8 <
(< =
ReadOnlySpan= I
<I J
byteJ N
>N O
sourceP V
)V W
{ 
if 

( 
source 
. 
IsEmpty 
) 
{   	
Result!! 
<!! $
SodiumSecureMemoryHandle!! +
,!!+ ,
SodiumFailure!!- :
>!!: ;
emptyResult!!< G
=!!H I$
SodiumSecureMemoryHandle"" (
.""( )
Allocate"") 1
(""1 2
$num""2 3
)""3 4
;""4 5
if$$ 
($$ 
emptyResult$$ 
.$$ 
IsErr$$ !
)$$! "
{%% 
return&& 
Result&& 
<&& 
SensitiveBytes&& ,
,&&, -
SodiumFailure&&. ;
>&&; <
.&&< =
Err&&= @
(&&@ A
emptyResult&&A L
.&&L M
	UnwrapErr&&M V
(&&V W
)&&W X
)&&X Y
;&&Y Z
}'' 
return)) 
Result)) 
<)) 
SensitiveBytes)) (
,))( )
SodiumFailure))* 7
>))7 8
.))8 9
Ok))9 ;
()); <
new** 
SensitiveBytes** "
(**" #
emptyResult**# .
.**. /
Unwrap**/ 5
(**5 6
)**6 7
,**7 8
$num**9 :
)**: ;
)**; <
;**< =
}++ 	
Result-- 
<-- $
SodiumSecureMemoryHandle-- '
,--' (
SodiumFailure--) 6
>--6 7
allocResult--8 C
=--D E$
SodiumSecureMemoryHandle.. $
...$ %
Allocate..% -
(..- .
source... 4
...4 5
Length..5 ;
)..; <
;..< =
if00 

(00 
allocResult00 
.00 
IsErr00 
)00 
{11 	
return22 
Result22 
<22 
SensitiveBytes22 (
,22( )
SodiumFailure22* 7
>227 8
.228 9
Err229 <
(22< =
allocResult22= H
.22H I
	UnwrapErr22I R
(22R S
)22S T
)22T U
;22U V
}33 	$
SodiumSecureMemoryHandle55  
handle55! '
=55( )
allocResult55* 5
.555 6
Unwrap556 <
(55< =
)55= >
;55> ?
Result77 
<77 
Unit77 
,77 
SodiumFailure77 "
>77" #
writeResult77$ /
=770 1
handle772 8
.778 9
Write779 >
(77> ?
source77? E
)77E F
;77F G
if88 

(88 
!88 
writeResult88 
.88 
IsErr88 
)88 
{99 	
return:: 
Result:: 
<:: 
SensitiveBytes:: (
,::( )
SodiumFailure::* 7
>::7 8
.::8 9
Ok::9 ;
(::; <
new;; 
SensitiveBytes;; "
(;;" #
handle;;# )
,;;) *
source;;+ 1
.;;1 2
Length;;2 8
);;8 9
);;9 :
;;;: ;
}<< 	
handle>> 
.>> 
Dispose>> 
(>> 
)>> 
;>> 
return?? 
Result?? 
<?? 
SensitiveBytes?? $
,??$ %
SodiumFailure??& 3
>??3 4
.??4 5
Err??5 8
(??8 9
writeResult??9 D
.??D E
	UnwrapErr??E N
(??N O
)??O P
)??P Q
;??Q R
}AA 
publicCC 

ResultCC 
<CC 
TResultCC 
,CC 
SodiumFailureCC (
>CC( )
WithReadAccessCC* 8
<CC8 9
TResultCC9 @
>CC@ A
(CCA B
FuncDD 
<DD 
ReadOnlySpanDD 
<DD 
byteDD 
>DD 
,DD  
ResultDD! '
<DD' (
TResultDD( /
,DD/ 0
SodiumFailureDD1 >
>DD> ?
>DD? @
	operationDDA J
)DDJ K
{EE 
EnsureNotDisposedFF 
(FF 
)FF 
;FF 
ifHH 

(HH 
_handleHH 
==HH 
nullHH 
)HH 
{II 	
returnJJ 
ResultJJ 
<JJ 
TResultJJ !
,JJ! "
SodiumFailureJJ# 0
>JJ0 1
.JJ1 2
ErrJJ2 5
(JJ5 6
SodiumFailureKK 
.KK 
NullPointerKK )
(KK) *
$strKK* I
)KKI J
)KKJ K
;KKK L
}LL 	
returnNN 
_handleNN 
.NN 
WithReadAccessNN %
(NN% &
	operationNN& /
)NN/ 0
;NN0 1
}OO 
publicQQ 

voidQQ 
DisposeQQ 
(QQ 
)QQ 
{RR 
ifSS 

(SS 
	_disposedSS 
)SS 
{TT 	
returnUU 
;UU 
}VV 	
_handleXX 
?XX 
.XX 
DisposeXX 
(XX 
)XX 
;XX 
_handleYY 
=YY 
nullYY 
;YY 
_lengthZZ 
=ZZ 
$numZZ 
;ZZ 
	_disposed[[ 
=[[ 
true[[ 
;[[ 
}\\ 
private^^ 
void^^ 
EnsureNotDisposed^^ "
(^^" #
)^^# $
{__ 
if`` 

(`` 
!`` 
	_disposed`` 
)`` 
{aa 	
returnbb 
;bb 
}cc 	
throwee 
newee #
ObjectDisposedExceptionee )
(ee) *
nameofee* 0
(ee0 1
SensitiveBytesee1 ?
)ee? @
)ee@ A
;eeA B
}ff 
}gg Ð
‚/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/SecureTextBuffer.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Services

  
.

  !
Authentication

! /
;

/ 0
public 
sealed 
class 
SecureTextBuffer $
:% &
IDisposable' 2
{ 
private $
SodiumSecureMemoryHandle $
_secureHandle% 2
=3 4$
SodiumSecureMemoryHandle5 M
.M N
AllocateN V
(V W
$numW X
)X Y
.Y Z
UnwrapZ `
(` a
)a b
;b c
private 
bool 
_isDisposed 
; 
public 

int 
Length 
{ 
get 
; 
private $
set% (
;( )
}* +
public 

void 
Insert 
( 
int 
index  
,  !
string" (
text) -
)- .
{ 
if 

( 
string 
. 
IsNullOrEmpty  
(  !
text! %
)% &
)& '
{ 	
return 
; 
} 	
ModifyState 
( 
index 
, 
$num 
, 
text "
)" #
;# $
} 
public 

void 
Remove 
( 
int 
index  
,  !
int" %
count& +
)+ ,
{ 
if 

( 
count 
<= 
$num 
) 
{   	
return!! 
;!! 
}"" 	
ModifyState$$ 
($$ 
index$$ 
,$$ 
count$$  
,$$  !
string$$" (
.$$( )
Empty$$) .
)$$. /
;$$/ 0
}%% 
public'' 

void'' 
WithSecureBytes'' 
(''  
Action''  &
<''& '
ReadOnlySpan''' 3
<''3 4
byte''4 8
>''8 9
>''9 :
action''; A
)''A B
{(( 
if)) 

()) 
_isDisposed)) 
))) 
{** 	
throw++ 
new++ #
ObjectDisposedException++ -
(++- .
nameof++. 4
(++4 5
SecureTextBuffer++5 E
)++E F
)++F G
;++G H
},, 	
if.. 

(.. 
_secureHandle.. 
... 
	IsInvalid.. #
||..$ &
_secureHandle..' 4
...4 5
Length..5 ;
==..< >
$num..? @
)..@ A
{// 	
action00 
(00 
ReadOnlySpan00 
<00  
byte00  $
>00$ %
.00% &
Empty00& +
)00+ ,
;00, -
return11 
;11 
}22 	
using44 
SecurePooledArray44 
<44  
byte44  $
>44$ %
rentedBytes44& 1
=442 3
SecureArrayPool444 C
.44C D
Rent44D H
<44H I
byte44I M
>44M N
(44N O
_secureHandle44O \
.44\ ]
Length44] c
)44c d
;44d e
Span55 
<55 
byte55 
>55 
span55 
=55 
rentedBytes55 %
.55% &
AsSpan55& ,
(55, -
)55- .
;55. /
_secureHandle77 
.77 
Read77 
(77 
span77 
)77  
.77  !
Unwrap77! '
(77' (
)77( )
;77) *
action99 
(99 
span99 
)99 
;99 
}:: 
private<< 
void<< 
ModifyState<< 
(<< 
int<<  
	charIndex<<! *
,<<* +
int<<, /
removeCharCount<<0 ?
,<<? @
string<<A G
insertChars<<H S
)<<S T
{== 
if>> 

(>> 
_isDisposed>> 
)>> 
{?? 	
throw@@ 
new@@ #
ObjectDisposedException@@ -
(@@- .
nameof@@. 4
(@@4 5
SecureTextBuffer@@5 E
)@@E F
)@@F G
;@@G H
}AA 	$
SodiumSecureMemoryHandleCC  
?CC  !
	newHandleCC" +
=CC, -
nullCC. 2
;CC2 3
boolDD 
successDD 
=DD 
falseDD 
;DD 
byteEE 
[EE 
]EE 
?EE 
insertBytesEE 
=EE 
nullEE "
;EE" #
tryGG 
{HH 	
insertBytesII 
=II 
PrepareInsertBytesII ,
(II, -
insertCharsII- 8
)II8 9
;II9 :
ifJJ 
(JJ 
insertBytesJJ 
==JJ 
nullJJ #
)JJ# $
{KK 
returnLL 
;LL 
}MM 
intOO 
oldByteLengthOO 
=OO 
_secureHandleOO  -
.OO- .
LengthOO. 4
;OO4 5
intPP #
currentTextElementCountPP '
=PP( )&
GetCurrentTextElementCountPP* D
(PPD E
oldByteLengthPPE R
)PPR S
;PPS T
	charIndexRR 
=RR 
MathRR 
.RR 
ClampRR "
(RR" #
	charIndexRR# ,
,RR, -
$numRR. /
,RR/ 0#
currentTextElementCountRR1 H
)RRH I
;RRI J
removeCharCountSS 
=SS 
MathSS "
.SS" #
ClampSS# (
(SS( )
removeCharCountSS) 8
,SS8 9
$numSS: ;
,SS; <#
currentTextElementCountSS= T
-SSU V
	charIndexSSW `
)SS` a
;SSa b
ByteIndexRangeUU 
	byteRangeUU $
=UU% & 
CalculateByteIndicesUU' ;
(UU; <
oldByteLengthUU< I
,UUI J
	charIndexUUK T
,UUT U
removeCharCountUUV e
)UUe f
;UUf g
intVV 
removedByteCountVV  
=VV! "
	byteRangeVV# ,
.VV, -
EndVV- 0
-VV1 2
	byteRangeVV3 <
.VV< =
StartVV= B
;VVB C
intWW 
newByteLengthWW 
=WW 
oldByteLengthWW  -
-WW. /
removedByteCountWW0 @
+WWA B
insertBytesWWC N
.WWN O
LengthWWO U
;WWU V
	newHandleYY 
=YY 
AssembleNewBufferYY )
(YY) *
oldByteLengthYY* 7
,YY7 8
	byteRangeYY9 B
.YYB C
StartYYC H
,YYH I
	byteRangeYYJ S
.YYS T
EndYYT W
,YYW X
insertBytesYYY d
,YYd e
newByteLengthYYf s
)YYs t
;YYt u!
UpdateHandleAndLength[[ !
([[! "
	newHandle[[" +
,[[+ ,#
currentTextElementCount[[- D
,[[D E
removeCharCount[[F U
,[[U V
insertBytes[[W b
)[[b c
;[[c d
success\\ 
=\\ 
true\\ 
;\\ 
}]] 	
finally^^ 
{__ 	
CleanupInsertBytes`` 
(`` 
insertBytes`` *
)``* +
;``+ ,
ifaa 
(aa 
!aa 
successaa 
)aa 
{bb 
	newHandlecc 
?cc 
.cc 
Disposecc "
(cc" #
)cc# $
;cc$ %
}dd 
}ee 	
}ff 
privatehh 
statichh 
bytehh 
[hh 
]hh 
?hh 
PrepareInsertByteshh -
(hh- .
stringhh. 4
insertCharshh5 @
)hh@ A
{ii 
ifjj 

(jj 
stringjj 
.jj 
IsNullOrEmptyjj  
(jj  !
insertCharsjj! ,
)jj, -
)jj- .
{kk 	
returnll 
[ll 
]ll 
;ll 
}mm 	
Resultoo 
<oo 
SecureStringHandleroo "
,oo" #
SodiumFailureoo$ 1
>oo1 2
handlerResultoo3 @
=ooA B
SecureStringHandlerooC V
.ooV W

FromStringooW a
(ooa b
insertCharsoob m
)oom n
;oon o
ifpp 

(pp 
handlerResultpp 
.pp 
IsErrpp 
)pp  
{qq 	
returnrr 
nullrr 
;rr 
}ss 	
usinguu 
SecureStringHandleruu !
insertHandleruu" /
=uu0 1
handlerResultuu2 ?
.uu? @
Unwrapuu@ F
(uuF G
)uuG H
;uuH I
usingvv 
SecurePooledArrayvv 
<vv  
bytevv  $
>vv$ %
	tempBytesvv& /
=vv0 1
SecureArrayPoolvv2 A
.vvA B
RentvvB F
<vvF G
bytevvG K
>vvK L
(vvL M
insertHandlervvM Z
.vvZ [

ByteLengthvv[ e
)vve f
;vvf g
Resultxx 
<xx 
Unitxx 
,xx 
SodiumFailurexx "
>xx" #

readResultxx$ .
=xx/ 0
insertHandlerxx1 >
.xx> ?
UseBytesxx? G
(xxG H
bytesxxH M
=>xxN P
{yy 	
byteszz 
.zz 
CopyTozz 
(zz 
	tempByteszz "
.zz" #
AsSpanzz# )
(zz) *
)zz* +
)zz+ ,
;zz, -
return{{ 
Unit{{ 
.{{ 
Value{{ 
;{{ 
}|| 	
)||	 

;||
 
if~~ 

(~~ 

readResult~~ 
.~~ 
IsErr~~ 
)~~ 
{ 	
return
€€ 
null
€€ 
;
€€ 
}
 	
byte
ƒƒ 
[
ƒƒ 
]
ƒƒ 
insertBytes
ƒƒ 
=
ƒƒ 
new
ƒƒ  
byte
ƒƒ! %
[
ƒƒ% &
insertHandler
ƒƒ& 3
.
ƒƒ3 4

ByteLength
ƒƒ4 >
]
ƒƒ> ?
;
ƒƒ? @
	tempBytes
„„ 
.
„„ 
AsSpan
„„ 
(
„„ 
)
„„ 
[
„„ 
..
„„ 
insertHandler
„„ *
.
„„* +

ByteLength
„„+ 5
]
„„5 6
.
„„6 7
CopyTo
„„7 =
(
„„= >
insertBytes
„„> I
)
„„I J
;
„„J K
return
…… 
insertBytes
…… 
;
…… 
}
†† 
private
ˆˆ 
int
ˆˆ (
GetCurrentTextElementCount
ˆˆ *
(
ˆˆ* +
int
ˆˆ+ .

byteLength
ˆˆ/ 9
)
ˆˆ9 :
{
‰‰ 
if
ŠŠ 

(
ŠŠ 

byteLength
ŠŠ 
==
ŠŠ 
$num
ŠŠ 
)
ŠŠ 
{
‹‹ 	
return
ŒŒ 
$num
ŒŒ 
;
ŒŒ 
}
 	
using
 
SecurePooledArray
 
<
  
byte
  $
>
$ %
oldBytes
& .
=
/ 0
SecureArrayPool
1 @
.
@ A
Rent
A E
<
E F
byte
F J
>
J K
(
K L

byteLength
L V
)
V W
;
W X
_secureHandle
 
.
 
Read
 
(
 
oldBytes
 #
.
# $
AsSpan
$ *
(
* +
)
+ ,
)
, -
.
- .
Unwrap
. 4
(
4 5
)
5 6
;
6 7
string
‘‘ 
currentText
‘‘ 
=
‘‘ 
Encoding
‘‘ %
.
‘‘% &
UTF8
‘‘& *
.
‘‘* +
	GetString
‘‘+ 4
(
‘‘4 5
oldBytes
‘‘5 =
.
‘‘= >
AsSpan
‘‘> D
(
‘‘D E
)
‘‘E F
)
‘‘F G
;
‘‘G H
return
’’ !
GetTextElementCount
’’ "
(
’’" #
currentText
’’# .
)
’’. /
;
’’/ 0
}
““ 
private
•• 
readonly
•• 
record
•• 
struct
•• "
ByteIndexRange
••# 1
(
••1 2
int
••2 5
Start
••6 ;
,
••; <
int
••= @
End
••A D
)
••D E
;
••E F
private
—— 
ByteIndexRange
—— "
CalculateByteIndices
—— /
(
——/ 0
int
——0 3
oldByteLength
——4 A
,
——A B
int
——C F
	charIndex
——G P
,
——P Q
int
——R U
removeCharCount
——V e
)
——e f
{
˜˜ 
if
™™ 

(
™™ 
oldByteLength
™™ 
==
™™ 
$num
™™ 
||
™™ !
(
™™" #
	charIndex
™™# ,
==
™™- /
$num
™™0 1
&&
™™2 4
removeCharCount
™™5 D
==
™™E G
$num
™™H I
)
™™I J
)
™™J K
{
šš 	
return
›› 
new
›› 
ByteIndexRange
›› %
(
››% &
$num
››& '
,
››' (
oldByteLength
››) 6
)
››6 7
;
››7 8
}
œœ 	
using
žž 
SecurePooledArray
žž 
<
žž  
byte
žž  $
>
žž$ %
oldBytes
žž& .
=
žž/ 0
SecureArrayPool
žž1 @
.
žž@ A
Rent
žžA E
<
žžE F
byte
žžF J
>
žžJ K
(
žžK L
oldByteLength
žžL Y
)
žžY Z
;
žžZ [
_secureHandle
ŸŸ 
.
ŸŸ 
Read
ŸŸ 
(
ŸŸ 
oldBytes
ŸŸ #
.
ŸŸ# $
AsSpan
ŸŸ$ *
(
ŸŸ* +
)
ŸŸ+ ,
)
ŸŸ, -
.
ŸŸ- .
Unwrap
ŸŸ. 4
(
ŸŸ4 5
)
ŸŸ5 6
;
ŸŸ6 7
string
   
currentText
   
=
   
Encoding
   %
.
  % &
UTF8
  & *
.
  * +
	GetString
  + 4
(
  4 5
oldBytes
  5 =
.
  = >
AsSpan
  > D
(
  D E
)
  E F
)
  F G
;
  G H
int
¢¢ 
startByteIndex
¢¢ 
=
¢¢ .
 GetByteIndexFromTextElementIndex
¢¢ =
(
¢¢= >
currentText
¢¢> I
,
¢¢I J
	charIndex
¢¢K T
)
¢¢T U
;
¢¢U V
int
££ 
endByteIndex
££ 
=
££ .
 GetByteIndexFromTextElementIndex
££ ;
(
££; <
currentText
££< G
,
££G H
	charIndex
££I R
+
££S T
removeCharCount
££U d
)
££d e
;
££e f
return
¥¥ 
new
¥¥ 
ByteIndexRange
¥¥ !
(
¥¥! "
startByteIndex
¥¥" 0
,
¥¥0 1
endByteIndex
¥¥2 >
)
¥¥> ?
;
¥¥? @
}
¦¦ 
private
¨¨ &
SodiumSecureMemoryHandle
¨¨ $
AssembleNewBuffer
¨¨% 6
(
¨¨6 7
int
¨¨7 :
oldByteLength
¨¨; H
,
¨¨H I
int
¨¨J M
startByteIndex
¨¨N \
,
¨¨\ ]
int
¨¨^ a
endByteIndex
¨¨b n
,
¨¨n o
byte
¨¨p t
[
¨¨t u
]
¨¨u v
insertBytes¨¨w ‚
,¨¨‚ ƒ
int¨¨„ ‡
newByteLength¨¨ˆ •
)¨¨• –
{
©© 
if
ªª 

(
ªª 
newByteLength
ªª 
==
ªª 
$num
ªª 
)
ªª 
{
«« 	
return
¬¬ &
SodiumSecureMemoryHandle
¬¬ +
.
¬¬+ ,
Allocate
¬¬, 4
(
¬¬4 5
$num
¬¬5 6
)
¬¬6 7
.
¬¬7 8
Unwrap
¬¬8 >
(
¬¬> ?
)
¬¬? @
;
¬¬@ A
}
­­ 	
using
¯¯ 
SecurePooledArray
¯¯ 
<
¯¯  
byte
¯¯  $
>
¯¯$ %
newBytes
¯¯& .
=
¯¯/ 0
SecureArrayPool
¯¯1 @
.
¯¯@ A
Rent
¯¯A E
<
¯¯E F
byte
¯¯F J
>
¯¯J K
(
¯¯K L
newByteLength
¯¯L Y
)
¯¯Y Z
;
¯¯Z [
Span
°° 
<
°° 
byte
°° 
>
°° 
newSpan
°° 
=
°° 
newBytes
°° %
.
°°% &
AsSpan
°°& ,
(
°°, -
)
°°- .
;
°°. /
if
²² 

(
²² 
oldByteLength
²² 
>
²² 
$num
²² 
)
²² 
{
³³ 	 
CopyBufferSegments
´´ 
(
´´ 
oldByteLength
´´ ,
,
´´, -
startByteIndex
´´. <
,
´´< =
endByteIndex
´´> J
,
´´J K
insertBytes
´´L W
,
´´W X
newSpan
´´Y `
)
´´` a
;
´´a b
}
µµ 	
else
¶¶ 
{
·· 	
insertBytes
¸¸ 
.
¸¸ 
CopyTo
¸¸ 
(
¸¸ 
newSpan
¸¸ &
)
¸¸& '
;
¸¸' (
}
¹¹ 	&
SodiumSecureMemoryHandle
»»  
	newHandle
»»! *
=
»»+ ,&
SodiumSecureMemoryHandle
»»- E
.
»»E F
Allocate
»»F N
(
»»N O
newByteLength
»»O \
)
»»\ ]
.
»»] ^
Unwrap
»»^ d
(
»»d e
)
»»e f
;
»»f g
	newHandle
¼¼ 
.
¼¼ 
Write
¼¼ 
(
¼¼ 
newSpan
¼¼ 
)
¼¼  
.
¼¼  !
Unwrap
¼¼! '
(
¼¼' (
)
¼¼( )
;
¼¼) *
return
½½ 
	newHandle
½½ 
;
½½ 
}
¾¾ 
private
ÀÀ 
void
ÀÀ  
CopyBufferSegments
ÀÀ #
(
ÀÀ# $
int
ÀÀ$ '
oldByteLength
ÀÀ( 5
,
ÀÀ5 6
int
ÀÀ7 :
startByteIndex
ÀÀ; I
,
ÀÀI J
int
ÀÀK N
endByteIndex
ÀÀO [
,
ÀÀ[ \
byte
ÀÀ] a
[
ÀÀa b
]
ÀÀb c
insertBytes
ÀÀd o
,
ÀÀo p
Span
ÀÀq u
<
ÀÀu v
byte
ÀÀv z
>
ÀÀz {
newSpanÀÀ| ƒ
)ÀÀƒ „
{
ÁÁ 
using
ÂÂ 
SecurePooledArray
ÂÂ 
<
ÂÂ  
byte
ÂÂ  $
>
ÂÂ$ %
oldBytesForCopy
ÂÂ& 5
=
ÂÂ6 7
SecureArrayPool
ÂÂ8 G
.
ÂÂG H
Rent
ÂÂH L
<
ÂÂL M
byte
ÂÂM Q
>
ÂÂQ R
(
ÂÂR S
oldByteLength
ÂÂS `
)
ÂÂ` a
;
ÂÂa b
_secureHandle
ÃÃ 
.
ÃÃ 
Read
ÃÃ 
(
ÃÃ 
oldBytesForCopy
ÃÃ *
.
ÃÃ* +
AsSpan
ÃÃ+ 1
(
ÃÃ1 2
)
ÃÃ2 3
)
ÃÃ3 4
.
ÃÃ4 5
Unwrap
ÃÃ5 ;
(
ÃÃ; <
)
ÃÃ< =
;
ÃÃ= >
Span
ÄÄ 
<
ÄÄ 
byte
ÄÄ 
>
ÄÄ 
oldSpan
ÄÄ 
=
ÄÄ 
oldBytesForCopy
ÄÄ ,
.
ÄÄ, -
AsSpan
ÄÄ- 3
(
ÄÄ3 4
)
ÄÄ4 5
;
ÄÄ5 6
oldSpan
ÆÆ 
[
ÆÆ 
..
ÆÆ 
startByteIndex
ÆÆ  
]
ÆÆ  !
.
ÆÆ! "
CopyTo
ÆÆ" (
(
ÆÆ( )
newSpan
ÆÆ) 0
)
ÆÆ0 1
;
ÆÆ1 2
insertBytes
ÇÇ 
.
ÇÇ 
CopyTo
ÇÇ 
(
ÇÇ 
newSpan
ÇÇ "
[
ÇÇ" #
startByteIndex
ÇÇ# 1
..
ÇÇ1 3
]
ÇÇ3 4
)
ÇÇ4 5
;
ÇÇ5 6
oldSpan
ÈÈ 
[
ÈÈ 
endByteIndex
ÈÈ 
..
ÈÈ 
]
ÈÈ 
.
ÈÈ  
CopyTo
ÈÈ  &
(
ÈÈ& '
newSpan
ÈÈ' .
[
ÈÈ. /
(
ÈÈ/ 0
startByteIndex
ÈÈ0 >
+
ÈÈ? @
insertBytes
ÈÈA L
.
ÈÈL M
Length
ÈÈM S
)
ÈÈS T
..
ÈÈT V
]
ÈÈV W
)
ÈÈW X
;
ÈÈX Y
}
ÉÉ 
private
ËË 
void
ËË #
UpdateHandleAndLength
ËË &
(
ËË& '&
SodiumSecureMemoryHandle
ËË' ?
	newHandle
ËË@ I
,
ËËI J
int
ËËK N%
currentTextElementCount
ËËO f
,
ËËf g
int
ËËh k
removeCharCount
ËËl {
,
ËË{ |
byteËË} 
[ËË ‚
]ËË‚ ƒ
insertBytesËË„ 
)ËË 
{
ÌÌ 
_secureHandle
ÍÍ 
.
ÍÍ 
Dispose
ÍÍ 
(
ÍÍ 
)
ÍÍ 
;
ÍÍ  
_secureHandle
ÎÎ 
=
ÎÎ 
	newHandle
ÎÎ !
;
ÎÎ! "
string
ÏÏ 

insertText
ÏÏ 
=
ÏÏ 
insertBytes
ÏÏ '
.
ÏÏ' (
Length
ÏÏ( .
>
ÏÏ/ 0
$num
ÏÏ1 2
?
ÏÏ3 4
Encoding
ÏÏ5 =
.
ÏÏ= >
UTF8
ÏÏ> B
.
ÏÏB C
	GetString
ÏÏC L
(
ÏÏL M
insertBytes
ÏÏM X
)
ÏÏX Y
:
ÏÏZ [
string
ÏÏ\ b
.
ÏÏb c
Empty
ÏÏc h
;
ÏÏh i
Length
ÐÐ 
=
ÐÐ %
currentTextElementCount
ÐÐ (
-
ÐÐ) *
removeCharCount
ÐÐ+ :
+
ÐÐ; <!
GetTextElementCount
ÐÐ= P
(
ÐÐP Q

insertText
ÐÐQ [
)
ÐÐ[ \
;
ÐÐ\ ]
}
ÑÑ 
private
ÓÓ 
static
ÓÓ 
void
ÓÓ  
CleanupInsertBytes
ÓÓ *
(
ÓÓ* +
byte
ÓÓ+ /
[
ÓÓ/ 0
]
ÓÓ0 1
?
ÓÓ1 2
insertBytes
ÓÓ3 >
)
ÓÓ> ?
{
ÔÔ 
if
ÕÕ 

(
ÕÕ 
insertBytes
ÕÕ 
is
ÕÕ 
{
ÕÕ 
Length
ÕÕ #
:
ÕÕ# $
>
ÕÕ% &
$num
ÕÕ' (
}
ÕÕ) *
)
ÕÕ* +
{
ÖÖ 	%
CryptographicOperations
×× #
.
××# $

ZeroMemory
××$ .
(
××. /
insertBytes
××/ :
)
××: ;
;
××; <
}
ØØ 	
}
ÙÙ 
private
ÛÛ 
static
ÛÛ 
int
ÛÛ .
 GetByteIndexFromTextElementIndex
ÛÛ 7
(
ÛÛ7 8
string
ÛÛ8 >
text
ÛÛ? C
,
ÛÛC D
int
ÛÛE H
textElementIndex
ÛÛI Y
)
ÛÛY Z
{
ÜÜ 
if
ÝÝ 

(
ÝÝ 
textElementIndex
ÝÝ 
==
ÝÝ 
$num
ÝÝ  !
||
ÝÝ" $
string
ÝÝ% +
.
ÝÝ+ ,
IsNullOrEmpty
ÝÝ, 9
(
ÝÝ9 :
text
ÝÝ: >
)
ÝÝ> ?
)
ÝÝ? @
{
ÞÞ 	
return
ßß 
$num
ßß 
;
ßß 
}
àà 	
try
ââ 
{
ãã 	

StringInfo
ää 

stringInfo
ää !
=
ää" #
new
ää$ '
(
ää' (
text
ää( ,
)
ää, -
;
ää- .
int
åå 
textElementCount
åå  
=
åå! "

stringInfo
åå# -
.
åå- ."
LengthInTextElements
åå. B
;
ååB C
if
çç 
(
çç 
textElementIndex
çç  
>=
çç! #
textElementCount
çç$ 4
)
çç4 5
{
èè 
return
éé 
Encoding
éé 
.
éé  
UTF8
éé  $
.
éé$ %
GetByteCount
éé% 1
(
éé1 2
text
éé2 6
)
éé6 7
;
éé7 8
}
êê 
string
ìì 
	substring
ìì 
=
ìì 

stringInfo
ìì )
.
ìì) *%
SubstringByTextElements
ìì* A
(
ììA B
$num
ììB C
,
ììC D
textElementIndex
ììE U
)
ììU V
;
ììV W
return
íí 
Encoding
íí 
.
íí 
UTF8
íí  
.
íí  !
GetByteCount
íí! -
(
íí- .
	substring
íí. 7
)
íí7 8
;
íí8 9
}
îî 	
catch
ïï 
(
ïï 
	Exception
ïï 
ex
ïï 
)
ïï 
{
ðð 	
Serilog
ññ 
.
ññ 
Log
ññ 
.
ññ 
Warning
ññ 
(
ññ  
ex
ññ  "
,
ññ" #
$strññ$ ”
,ññ” •
textElementIndex
òò  
)
òò  !
;
òò! "
return
óó 
Math
óó 
.
óó 
Min
óó 
(
óó 
textElementIndex
óó ,
,
óó, -
Encoding
óó. 6
.
óó6 7
UTF8
óó7 ;
.
óó; <
GetByteCount
óó< H
(
óóH I
text
óóI M
)
óóM N
)
óóN O
;
óóO P
}
ôô 	
}
õõ 
private
÷÷ 
static
÷÷ 
int
÷÷ !
GetTextElementCount
÷÷ *
(
÷÷* +
string
÷÷+ 1
text
÷÷2 6
)
÷÷6 7
{
øø 
if
ùù 

(
ùù 
string
ùù 
.
ùù 
IsNullOrEmpty
ùù  
(
ùù  !
text
ùù! %
)
ùù% &
)
ùù& '
{
úú 	
return
ûû 
$num
ûû 
;
ûû 
}
üü 	
try
þþ 
{
ÿÿ 	

StringInfo
€€ 

stringInfo
€€ !
=
€€" #
new
€€$ '
(
€€' (
text
€€( ,
)
€€, -
;
€€- .
return
 

stringInfo
 
.
 "
LengthInTextElements
 2
;
2 3
}
‚‚ 	
catch
ƒƒ 
(
ƒƒ 
	Exception
ƒƒ 
ex
ƒƒ 
)
ƒƒ 
{
„„ 	
Serilog
…… 
.
…… 
Log
…… 
.
…… 
Warning
…… 
(
……  
ex
……  "
,
……" #
$str……$ €
,……€ 
text
†† 
.
†† 
Length
†† 
)
†† 
;
†† 
return
‡‡ 
text
‡‡ 
.
‡‡ 
Length
‡‡ 
;
‡‡ 
}
ˆˆ 	
}
‰‰ 
public
‹‹ 

void
‹‹ 
Dispose
‹‹ 
(
‹‹ 
)
‹‹ 
{
ŒŒ 
if
 

(
 
_isDisposed
 
)
 
{
ŽŽ 	
return
 
;
 
}
 	
_secureHandle
’’ 
.
’’ 
Dispose
’’ 
(
’’ 
)
’’ 
;
’’  
_isDisposed
““ 
=
““ 
true
““ 
;
““ 
}
”” 
}•• ˜š
Š/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/SecureKeyRecoveryService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
;/ 0
internal 
sealed	 
class $
SecureKeyRecoveryService .
(. /
NetworkProvider 
networkProvider #
,# $&
IOpaqueRegistrationService 
registrationService 2
,2 3 
ILocalizationService 
localizationService ,
,, -$
IServerPublicKeyProvider #
serverPublicKeyProvider 4
,4 5-
!IApplicationSecureStorageProvider %,
 applicationSecureStorageProvider& F
)F G
: %
ISecureKeyRecoveryService 
,  
IDisposable! ,
{ 
private 
readonly 
Lock 
_opaqueClientLock +
=, -
new. 1
(1 2
)2 3
;3 4
private 
Option 
< 
OpaqueClient 
>  
_opaqueClient! .
=/ 0
Option1 7
<7 8
OpaqueClient8 D
>D E
.E F
NoneF J
;J K
private   
byte   
[   
]   
?   "
_cachedServerPublicKey   *
;  * +
private!! 
bool!! 
	_disposed!! 
;!! 
public## 

async## 
Task## 
<## 
Result## 
<## 

ByteString## '
,##' (
string##) /
>##/ 0
>##0 1*
ValidateMobileForRecoveryAsync##2 P
(##P Q
string$$ 
mobileNumber$$ 
,$$ 
uint%% 
	connectId%% 
,%% 
CancellationToken&& 
cancellationToken&& +
=&&, -
default&&. 5
)&&5 6
{'' 
Result(( 
<(( (
ValidateMobileNumberResponse(( +
,((+ ,
string((- 3
>((3 4
result((5 ;
=((< =
await)) 
registrationService)) %
.** %
ValidateMobileNumberAsync** *
(*** +
mobileNumber**+ 7
,**7 8
	connectId**9 B
,**B C
cancellationToken**D U
)**U V
.++ 
ConfigureAwait++ 
(++  
false++  %
)++% &
;++& '
if-- 

(-- 
result-- 
.-- 
IsErr-- 
)-- 
{.. 	
return// 
Result// 
<// 

ByteString// $
,//$ %
string//& ,
>//, -
.//- .
Err//. 1
(//1 2
result//2 8
.//8 9
	UnwrapErr//9 B
(//B C
)//C D
)//D E
;//E F
}00 	(
ValidateMobileNumberResponse22 $
response22% -
=22. /
result220 6
.226 7
Unwrap227 =
(22= >
)22> ?
;22? @
return33 
Result33 
<33 

ByteString33  
,33  !
string33" (
>33( )
.33) *
Ok33* ,
(33, -
response33- 5
.335 6"
MobileNumberIdentifier336 L
)33L M
;33M N
}44 
public66 

Task66 
<66 
Result66 
<66 
Unit66 
,66 
string66 #
>66# $
>66$ %*
InitiateSecureKeyResetOtpAsync66& D
(66D E

ByteString77 "
mobileNumberIdentifier77 )
,77) *
Action88 
<88 
uint88 
,88 
Guid88 
,88 '
VerificationCountdownUpdate88 6
.886 7
Types887 <
.88< =!
CountdownUpdateStatus88= R
,88R S
string88T Z
?88Z [
>88[ \
?88\ ]
onCountdownUpdate88^ o
=88p q
null88r v
,88v w
CancellationToken99 
cancellationToken99 +
=99, -
default99. 5
)995 6
=>997 9
registrationService:: 
.:: (
InitiateOtpVerificationAsync:: 8
(::8 9"
mobileNumberIdentifier;; "
,;;" #
VerificationPurpose<< 
.<<  
SecureKeyRecovery<<  1
,<<1 2
onCountdownUpdate== 
,== 
cancellationToken>> 
)>> 
;>> 
public@@ 

Task@@ 
<@@ 
Result@@ 
<@@ 
Unit@@ 
,@@ 
string@@ #
>@@# $
>@@$ %(
ResendSecureKeyResetOtpAsync@@& B
(@@B C
GuidAA 
sessionIdentifierAA 
,AA 

ByteStringBB "
mobileNumberIdentifierBB )
,BB) *
ActionCC 
<CC 
uintCC 
,CC 
GuidCC 
,CC '
VerificationCountdownUpdateCC 6
.CC6 7
TypesCC7 <
.CC< =!
CountdownUpdateStatusCC= R
,CCR S
stringCCT Z
?CCZ [
>CC[ \
?CC\ ]
onCountdownUpdateCC^ o
=CCp q
nullCCr v
,CCv w
CancellationTokenDD 
cancellationTokenDD +
=DD, -
defaultDD. 5
)DD5 6
=>DD7 9
registrationServiceEE 
.EE &
ResendOtpVerificationAsyncEE 6
(EE6 7
sessionIdentifierFF 
,FF "
mobileNumberIdentifierGG "
,GG" #
onCountdownUpdateHH 
,HH 
cancellationTokenII 
)II 
;II 
publicKK 

TaskKK 
<KK 
ResultKK 
<KK 
ProtobufKK 
.KK  

MembershipKK  *
.KK* +

MembershipKK+ 5
,KK5 6
stringKK7 =
>KK= >
>KK> ?(
VerifySecureKeyResetOtpAsyncKK@ \
(KK\ ]
GuidLL 
sessionIdentifierLL 
,LL 
stringMM 
otpCodeMM 
,MM 
uintNN 
	connectIdNN 
,NN 
CancellationTokenOO 
cancellationTokenOO +
=OO, -
defaultOO. 5
)OO5 6
=>OO7 9
registrationServicePP 
.PP 
VerifyOtpAsyncPP *
(PP* +
sessionIdentifierPP+ <
,PP< =
otpCodePP> E
,PPE F
	connectIdPPG P
,PPP Q
cancellationTokenQQ 
)QQ 
;QQ 
publicSS 

asyncSS 
TaskSS 
<SS 
ResultSS 
<SS 
UnitSS !
,SS! "
stringSS# )
>SS) *
>SS* +'
CompleteSecureKeyResetAsyncSS, G
(SSG H

ByteStringTT  
membershipIdentifierTT '
,TT' (
SecureTextBufferUU 
newSecureKeyUU %
,UU% &
uintVV 
	connectIdVV 
,VV 
CancellationTokenWW 
cancellationTokenWW +
=WW, -
defaultWW. 5
)WW5 6
{XX 
ifYY 

(YY  
membershipIdentifierYY  
.YY  !
IsEmptyYY! (
)YY( )
{ZZ 	
return[[ 
Result[[ 
<[[ 
Unit[[ 
,[[ 
string[[  &
>[[& '
.[[' (
Err[[( +
([[+ ,
localizationService\\ #
[\\# $#
AuthenticationConstants\\$ ;
.\\; <.
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY\\< ^
]\\^ _
)\\_ `
;\\` a
}]] 	
if__ 

(__ 
newSecureKey__ 
.__ 
Length__ 
==__  "
$num__# $
)__$ %
{`` 	
returnaa 
Resultaa 
<aa 
Unitaa 
,aa 
stringaa  &
>aa& '
.aa' (
Erraa( +
(aa+ ,
localizationServiceaa, ?
[aa? @#
AuthenticationConstantsaa@ W
.aaW X#
SECURE_KEY_REQUIRED_KEYaaX o
]aao p
)aap q
;aaq r
}bb 	
RegistrationResultdd 
?dd 
registrationResultdd .
=dd/ 0
nulldd1 5
;dd5 6
tryff 
{gg 	
OpaqueClienthh 
opaqueClienthh %
=hh& '#
GetOrCreateOpaqueClienthh( ?
(hh? @
)hh@ A
;hhA B
Resultjj 
<jj 
RegistrationResultjj %
,jj% &
stringjj' -
>jj- .
requestResultjj/ <
=jj= >*
CreateSecureKeyRecoveryRequestkk .
(kk. /
opaqueClientkk/ ;
,kk; <
newSecureKeykk= I
)kkI J
;kkJ K
ifmm 
(mm 
requestResultmm 
.mm 
IsErrmm #
)mm# $
{nn 
returnoo 
Resultoo 
<oo 
Unitoo "
,oo" #
stringoo$ *
>oo* +
.oo+ ,
Erroo, /
(oo/ 0
requestResultoo0 =
.oo= >
	UnwrapErroo> G
(ooG H
)ooH I
)ooI J
;ooJ K
}pp 
registrationResultrr 
=rr  
requestResultrr! .
.rr. /
Unwraprr/ 5
(rr5 6
)rr6 7
;rr7 8
Resulttt 
<tt /
#OpaqueRecoverySecureKeyInitResponsett 6
,tt6 7
stringtt8 >
>tt> ?

initResulttt@ J
=ttK L
awaituu *
InitiateSecureKeyRecoveryAsyncuu 4
(uu4 5 
membershipIdentifieruu5 I
,uuI J
registrationResultuuK ]
.uu] ^
GetRequestCopyuu^ l
(uul m
)uum n
,uun o
	connectIdvv 
,vv 
cancellationTokenvv 0
)vv0 1
.vv1 2
ConfigureAwaitvv2 @
(vv@ A
falsevvA F
)vvF G
;vvG H
ifxx 
(xx 

initResultxx 
.xx 
IsErrxx  
)xx  !
{yy 
returnzz 
Resultzz 
<zz 
Unitzz "
,zz" #
stringzz$ *
>zz* +
.zz+ ,
Errzz, /
(zz/ 0

initResultzz0 :
.zz: ;
	UnwrapErrzz; D
(zzD E
)zzE F
)zzF G
;zzG H
}{{ /
#OpaqueRecoverySecureKeyInitResponse}} /
initResponse}}0 <
=}}= >

initResult}}? I
.}}I J
Unwrap}}J P
(}}P Q
)}}Q R
;}}R S
Result 
< 
Unit 
, 
string 
>  
processResult! .
=/ 0
await
€€ 2
$ProcessSecureKeyRecoveryInitResponse
€€ :
(
€€: ;
initResponse
€€; G
)
€€G H
.
€€H I
ConfigureAwait
€€I W
(
€€W X
false
€€X ]
)
€€] ^
;
€€^ _
if
‚‚ 
(
‚‚ 
processResult
‚‚ 
.
‚‚ 
IsErr
‚‚ #
)
‚‚# $
{
ƒƒ 
return
„„ 
processResult
„„ $
;
„„$ %
}
…… 
return
‡‡ 
await
‡‡ ,
FinalizeSecureKeyRecoveryAsync
‡‡ 7
(
‡‡7 8
opaqueClient
‡‡8 D
,
‡‡D E
initResponse
‡‡F R
,
‡‡R S 
registrationResult
‡‡T f
,
‡‡f g"
membershipIdentifier
ˆˆ $
,
ˆˆ$ %
	connectId
ˆˆ& /
,
ˆˆ/ 0
cancellationToken
ˆˆ1 B
)
ˆˆB C
.
ˆˆC D
ConfigureAwait
ˆˆD R
(
ˆˆR S
false
ˆˆS X
)
ˆˆX Y
;
ˆˆY Z
}
‰‰ 	
catch
ŠŠ 
(
ŠŠ 
	Exception
ŠŠ 
ex
ŠŠ 
)
ŠŠ 
{
‹‹ 	
return
ŒŒ 
Result
ŒŒ 
<
ŒŒ 
Unit
ŒŒ 
,
ŒŒ 
string
ŒŒ  &
>
ŒŒ& '
.
ŒŒ' (
Err
ŒŒ( +
(
ŒŒ+ ,
ex
ŒŒ, .
.
ŒŒ. /
Message
ŒŒ/ 6
)
ŒŒ6 7
;
ŒŒ7 8
}
 	
finally
ŽŽ 
{
 	 
registrationResult
 
?
 
.
  
Dispose
  '
(
' (
)
( )
;
) *
}
‘‘ 	
}
’’ 
public
”” 

Task
”” 
<
”” 
Result
”” 
<
”” 
Unit
”” 
,
”” 
string
”” #
>
””# $
>
””$ %/
!CleanupSecureKeyResetSessionAsync
””& G
(
””G H
Guid
””H L
sessionIdentifier
””M ^
)
””^ _
=>
””` b!
registrationService
•• 
.
•• -
CleanupVerificationSessionAsync
•• ;
(
••; <
sessionIdentifier
••< M
)
••M N
;
••N O
private
—— 
static
—— 
void
—— *
CleanupSensitiveRecoveryData
—— 4
(
——4 5
byte
˜˜ 
[
˜˜ 
]
˜˜ 
?
˜˜ 
secureKeyCopy
˜˜ 
,
˜˜ 
byte
™™ 
[
™™ 
]
™™ 
?
™™ $
serverRecoveryResponse
™™ &
,
™™& '
byte
šš 
[
šš 
]
šš 
?
šš 
recoveryRecord
šš 
,
šš 
byte
›› 
[
›› 
]
›› 
?
›› 
	masterKey
›› 
)
›› 
{
œœ 
if
 

(
 
secureKeyCopy
 
is
 
{
 
Length
 %
:
% &
>
' (
$num
) *
}
+ ,
)
, -
{
žž 	%
CryptographicOperations
ŸŸ #
.
ŸŸ# $

ZeroMemory
ŸŸ$ .
(
ŸŸ. /
secureKeyCopy
ŸŸ/ <
)
ŸŸ< =
;
ŸŸ= >
}
   	
if
¢¢ 

(
¢¢ $
serverRecoveryResponse
¢¢ "
is
¢¢# %
{
¢¢& '
Length
¢¢( .
:
¢¢. /
>
¢¢0 1
$num
¢¢2 3
}
¢¢4 5
)
¢¢5 6
{
££ 	%
CryptographicOperations
¤¤ #
.
¤¤# $

ZeroMemory
¤¤$ .
(
¤¤. /$
serverRecoveryResponse
¤¤/ E
)
¤¤E F
;
¤¤F G
}
¥¥ 	
if
§§ 

(
§§ 
recoveryRecord
§§ 
is
§§ 
{
§§ 
Length
§§  &
:
§§& '
>
§§( )
$num
§§* +
}
§§, -
)
§§- .
{
¨¨ 	%
CryptographicOperations
©© #
.
©©# $

ZeroMemory
©©$ .
(
©©. /
recoveryRecord
©©/ =
)
©©= >
;
©©> ?
}
ªª 	
if
¬¬ 

(
¬¬ 
	masterKey
¬¬ 
is
¬¬ 
{
¬¬ 
Length
¬¬ !
:
¬¬! "
>
¬¬# $
$num
¬¬% &
}
¬¬' (
)
¬¬( )
{
­­ 	%
CryptographicOperations
®® #
.
®®# $

ZeroMemory
®®$ .
(
®®. /
	masterKey
®®/ 8
)
®®8 9
;
®®9 :
}
¯¯ 	
}
°° 
private
²² 
Result
²² 
<
²²  
RegistrationResult
²² %
,
²²% &
string
²²' -
>
²²- .,
CreateSecureKeyRecoveryRequest
²²/ M
(
²²M N
OpaqueClient
³³ 
opaqueClient
³³ !
,
³³! "
SecureTextBuffer
´´ 
newSecureKey
´´ %
)
´´% &
{
µµ 
try
¶¶ 
{
·· 	 
RegistrationResult
¸¸  
registrationResult
¸¸ 1
=
¸¸2 3
null
¸¸4 8
!
¸¸8 9
;
¸¸9 :
newSecureKey
ºº 
.
ºº 
WithSecureBytes
ºº (
(
ºº( )
secureKeyBytes
ºº) 7
=>
ºº8 :
{
»» 
byte
¼¼ 
[
¼¼ 
]
¼¼ 
secureKeyCopy
¼¼ $
=
¼¼% &
secureKeyBytes
¼¼' 5
.
¼¼5 6
ToArray
¼¼6 =
(
¼¼= >
)
¼¼> ?
;
¼¼? @
try
½½ 
{
¾¾  
registrationResult
¿¿ &
=
¿¿' (
opaqueClient
¿¿) 5
.
¿¿5 6'
CreateRegistrationRequest
¿¿6 O
(
¿¿O P
secureKeyCopy
¿¿P ]
)
¿¿] ^
;
¿¿^ _
}
ÀÀ 
finally
ÁÁ 
{
ÂÂ %
CryptographicOperations
ÃÃ +
.
ÃÃ+ ,

ZeroMemory
ÃÃ, 6
(
ÃÃ6 7
secureKeyCopy
ÃÃ7 D
)
ÃÃD E
;
ÃÃE F
}
ÄÄ 
}
ÅÅ 
)
ÅÅ 
;
ÅÅ 
return
ÇÇ 
Result
ÇÇ 
<
ÇÇ  
RegistrationResult
ÇÇ ,
,
ÇÇ, -
string
ÇÇ. 4
>
ÇÇ4 5
.
ÇÇ5 6
Ok
ÇÇ6 8
(
ÇÇ8 9 
registrationResult
ÇÇ9 K
)
ÇÇK L
;
ÇÇL M
}
ÈÈ 	
catch
ÉÉ 
(
ÉÉ 
	Exception
ÉÉ 
ex
ÉÉ 
)
ÉÉ 
{
ÊÊ 	
return
ËË 
Result
ËË 
<
ËË  
RegistrationResult
ËË ,
,
ËË, -
string
ËË. 4
>
ËË4 5
.
ËË5 6
Err
ËË6 9
(
ËË9 :
$"
ÌÌ 
{
ÌÌ !
localizationService
ÌÌ &
[
ÌÌ& '%
AuthenticationConstants
ÌÌ' >
.
ÌÌ> ?%
REGISTRATION_FAILED_KEY
ÌÌ? V
]
ÌÌV W
}
ÌÌW X
$str
ÌÌX Z
{
ÌÌZ [
ex
ÌÌ[ ]
.
ÌÌ] ^
Message
ÌÌ^ e
}
ÌÌe f
"
ÌÌf g
)
ÌÌg h
;
ÌÌh i
}
ÍÍ 	
}
ÎÎ 
private
ÐÐ 
async
ÐÐ 
Task
ÐÐ 
<
ÐÐ 
Result
ÐÐ 
<
ÐÐ 
Unit
ÐÐ "
,
ÐÐ" #
string
ÐÐ$ *
>
ÐÐ* +
>
ÐÐ+ ,2
$ProcessSecureKeyRecoveryInitResponse
ÐÐ- Q
(
ÐÐQ R1
#OpaqueRecoverySecureKeyInitResponse
ÑÑ +
initResponse
ÑÑ, 8
)
ÑÑ8 9
{
ÒÒ 
if
ÓÓ 

(
ÓÓ 
initResponse
ÓÓ 
.
ÓÓ 
Result
ÓÓ 
!=
ÓÓ  "1
#OpaqueRecoverySecureKeyInitResponse
ÓÓ# F
.
ÓÓF G
Types
ÓÓG L
.
ÓÓL M
RecoveryResult
ÓÓM [
.
ÓÓ[ \
	Succeeded
ÓÓ\ e
)
ÓÓe f
{
ÔÔ 	
string
ÕÕ 
errorMessage
ÕÕ 
=
ÕÕ  !
initResponse
ÕÕ" .
.
ÕÕ. /
Result
ÕÕ/ 5
switch
ÕÕ6 <
{
ÖÖ 1
#OpaqueRecoverySecureKeyInitResponse
×× 3
.
××3 4
Types
××4 9
.
××9 :
RecoveryResult
××: H
.
××H I 
InvalidCredentials
××I [
=>
××\ ^!
localizationService
ØØ '
[
ØØ' (%
AuthenticationConstants
ØØ( ?
.
ØØ? @%
INVALID_CREDENTIALS_KEY
ØØ@ W
]
ØØW X
,
ØØX Y
_
ÙÙ 
=>
ÙÙ !
localizationService
ÙÙ (
[
ÙÙ( )%
AuthenticationConstants
ÙÙ) @
.
ÙÙ@ A%
REGISTRATION_FAILED_KEY
ÙÙA X
]
ÙÙX Y
}
ÚÚ 
;
ÚÚ 
return
ÛÛ 
Result
ÛÛ 
<
ÛÛ 
Unit
ÛÛ 
,
ÛÛ 
string
ÛÛ  &
>
ÛÛ& '
.
ÛÛ' (
Err
ÛÛ( +
(
ÛÛ+ ,
errorMessage
ÛÛ, 8
)
ÛÛ8 9
;
ÛÛ9 :
}
ÜÜ 	
if
ÞÞ 

(
ÞÞ 
initResponse
ÞÞ 
.
ÞÞ 

Membership
ÞÞ #
?
ÞÞ# $
.
ÞÞ$ %%
AccountUniqueIdentifier
ÞÞ% <
!=
ÞÞ= ?
null
ÞÞ@ D
&&
ÞÞE G
initResponse
ßß 
.
ßß 

Membership
ßß #
.
ßß# $%
AccountUniqueIdentifier
ßß$ ;
.
ßß; <
Length
ßß< B
>
ßßC D
$num
ßßE F
)
ßßF G
{
àà 	
await
áá .
 applicationSecureStorageProvider
áá 2
.
ââ &
SetCurrentAccountIdAsync
ââ )
(
ââ) *
initResponse
ââ* 6
.
ââ6 7

Membership
ââ7 A
.
ââA B%
AccountUniqueIdentifier
ââB Y
)
ââY Z
.
ãã 
ConfigureAwait
ãã 
(
ãã  
false
ãã  %
)
ãã% &
;
ãã& '
}
ää 	
return
ææ 
Result
ææ 
<
ææ 
Unit
ææ 
,
ææ 
string
ææ "
>
ææ" #
.
ææ# $
Ok
ææ$ &
(
ææ& '
Unit
ææ' +
.
ææ+ ,
Value
ææ, 1
)
ææ1 2
;
ææ2 3
}
çç 
private
éé 
async
éé 
Task
éé 
<
éé 
Result
éé 
<
éé 
Unit
éé "
,
éé" #
string
éé$ *
>
éé* +
>
éé+ ,,
FinalizeSecureKeyRecoveryAsync
éé- K
(
ééK L
OpaqueClient
êê 
opaqueClient
êê !
,
êê! "1
#OpaqueRecoverySecureKeyInitResponse
ëë +
initResponse
ëë, 8
,
ëë8 9 
RegistrationResult
ìì  
registrationResult
ìì -
,
ìì- .

ByteString
íí "
membershipIdentifier
íí '
,
íí' (
uint
îî 
	connectId
îî 
,
îî 
CancellationToken
ïï 
cancellationToken
ïï +
)
ïï+ ,
{
ðð 
byte
ññ 
[
ññ 
]
ññ 
?
ññ $
serverRecoveryResponse
ññ &
=
ññ' (
null
ññ) -
;
ññ- .
byte
òò 
[
òò 
]
òò 
?
òò 
recoveryRecord
òò 
=
òò  
null
òò! %
;
òò% &
byte
óó 
[
óó 
]
óó 
?
óó 
	masterKey
óó 
=
óó 
null
óó  
;
óó  !
try
õõ 
{
öö 	$
serverRecoveryResponse
÷÷ "
=
÷÷# $%
SecureByteStringInterop
øø '
.
øø' ("
WithByteStringAsSpan
øø( <
(
øø< =
initResponse
øø= I
.
øøI J
PeerOprf
øøJ R
,
øøR S
span
øøT X
=>
øøY [
span
øø\ `
.
øø` a
ToArray
øøa h
(
øøh i
)
øøi j
)
øøj k
;
øøk l
(
úú 
byte
úú 
[
úú 
]
úú 
record
úú 
,
úú 
byte
úú  
[
úú  !
]
úú! " 
generatedMasterKey
úú# 5
)
úú5 6
=
úú7 8
opaqueClient
ûû 
.
ûû "
FinalizeRegistration
ûû 1
(
ûû1 2$
serverRecoveryResponse
ûû2 H
,
ûûH I 
registrationResult
ûûJ \
)
ûû\ ]
;
ûû] ^
recoveryRecord
üü 
=
üü 
record
üü #
;
üü# $
	masterKey
ýý 
=
ýý  
generatedMasterKey
ýý *
;
ýý* +4
&OpaqueRecoverySecretKeyCompleteRequest
ÿÿ 2
completeRequest
ÿÿ3 B
=
ÿÿC D
new
ÿÿE H
(
ÿÿH I
)
ÿÿI J
{
€€  
PeerRecoveryRecord
 "
=
# $

ByteString
% /
.
/ 0
CopyFrom
0 8
(
8 9
recoveryRecord
9 G
)
G H
,
H I"
MembershipIdentifier
‚‚ $
=
‚‚% &"
membershipIdentifier
‚‚' ;
,
‚‚; <
	MasterKey
ƒƒ 
=
ƒƒ 

ByteString
ƒƒ &
.
ƒƒ& '
CopyFrom
ƒƒ' /
(
ƒƒ/ 0
	masterKey
ƒƒ0 9
)
ƒƒ9 :
}
„„ 
;
„„ "
TaskCompletionSource
††  
<
††  !5
'OpaqueRecoverySecretKeyCompleteResponse
††! H
>
††H I
responseSource
††J X
=
††Y Z
new
††[ ^
(
††^ _
)
††_ `
;
††` a
Result
ˆˆ 
<
ˆˆ 
Unit
ˆˆ 
,
ˆˆ 
NetworkFailure
ˆˆ '
>
ˆˆ' (
networkResult
ˆˆ) 6
=
ˆˆ7 8
await
ˆˆ9 >
networkProvider
ˆˆ? N
.
ˆˆN O&
ExecuteUnaryRequestAsync
ˆˆO g
(
ˆˆg h
	connectId
‰‰ 
,
‰‰ 
RpcServiceType
ŠŠ 
.
ŠŠ '
RecoverySecretKeyComplete
ŠŠ 8
,
ŠŠ8 9%
SecureByteStringInterop
‹‹ '
.
‹‹' ("
WithByteStringAsSpan
‹‹( <
(
‹‹< =
completeRequest
‹‹= L
.
‹‹L M
ToByteString
‹‹M Y
(
‹‹Y Z
)
‹‹Z [
,
‹‹[ \
span
‹‹] a
=>
‹‹b d
span
‹‹e i
.
‹‹i j
ToArray
‹‹j q
(
‹‹q r
)
‹‹r s
)
‹‹s t
,
‹‹t u
payload
ŒŒ 
=>
ŒŒ 
{
 5
'OpaqueRecoverySecretKeyCompleteResponse
ŽŽ ;
response
ŽŽ< D
=
ŽŽE F
Helpers
 
.
  
ParseFromBytes
  .
<
. /5
'OpaqueRecoverySecretKeyCompleteResponse
/ V
>
V W
(
W X
payload
X _
)
_ `
;
` a
responseSource
 "
.
" #
TrySetResult
# /
(
/ 0
response
0 8
)
8 9
;
9 :
return
’’ 
Task
’’ 
.
’’  

FromResult
’’  *
(
’’* +
Result
’’+ 1
<
’’1 2
Unit
’’2 6
,
’’6 7
NetworkFailure
’’8 F
>
’’F G
.
’’G H
Ok
’’H J
(
’’J K
Unit
’’K O
.
’’O P
Value
’’P U
)
’’U V
)
’’V W
;
’’W X
}
““ 
,
““ 
true
““ 
,
““ 
cancellationToken
““ *
)
““* +
.
““+ ,
ConfigureAwait
““, :
(
““: ;
false
““; @
)
““@ A
;
““A B
if
•• 
(
•• 
networkResult
•• 
.
•• 
IsErr
•• #
)
••# $
{
–– 
return
—— 
Result
—— 
<
—— 
Unit
—— "
,
——" #
string
——$ *
>
——* +
.
——+ ,
Err
——, /
(
——/ 0
networkResult
——0 =
.
——= >
	UnwrapErr
——> G
(
——G H
)
——H I
.
——I J
Message
——J Q
)
——Q R
;
——R S
}
˜˜ 
await
šš 
responseSource
šš  
.
šš  !
Task
šš! %
.
šš% &
ConfigureAwait
šš& 4
(
šš4 5
false
šš5 :
)
šš: ;
;
šš; <
return
›› 
Result
›› 
<
›› 
Unit
›› 
,
›› 
string
››  &
>
››& '
.
››' (
Ok
››( *
(
››* +
Unit
››+ /
.
››/ 0
Value
››0 5
)
››5 6
;
››6 7
}
œœ 	
finally
 
{
žž 	*
CleanupSensitiveRecoveryData
ŸŸ (
(
ŸŸ( )
null
ŸŸ) -
,
ŸŸ- .$
serverRecoveryResponse
ŸŸ/ E
,
ŸŸE F
recoveryRecord
ŸŸG U
,
ŸŸU V
	masterKey
ŸŸW `
)
ŸŸ` a
;
ŸŸa b
}
   	
}
¡¡ 
public
££ 

void
££ 
Dispose
££ 
(
££ 
)
££ 
{
¤¤ 
if
¥¥ 

(
¥¥ 
	_disposed
¥¥ 
)
¥¥ 
{
¦¦ 	
return
§§ 
;
§§ 
}
¨¨ 	
lock
ªª 
(
ªª 
_opaqueClientLock
ªª 
)
ªª  
{
«« 	
_opaqueClient
¬¬ 
.
¬¬ 
Do
¬¬ 
(
¬¬ 
client
¬¬ #
=>
¬¬$ &
client
¬¬' -
.
¬¬- .
Dispose
¬¬. 5
(
¬¬5 6
)
¬¬6 7
)
¬¬7 8
;
¬¬8 9
_opaqueClient
­­ 
=
­­ 
Option
­­ "
<
­­" #
OpaqueClient
­­# /
>
­­/ 0
.
­­0 1
None
­­1 5
;
­­5 6
}
®® 	
	_disposed
°° 
=
°° 
true
°° 
;
°° 
}
±± 
private
³³ 
OpaqueClient
³³ %
GetOrCreateOpaqueClient
³³ 0
(
³³0 1
)
³³1 2
{
´´ 
byte
µµ 
[
µµ 
]
µµ 
serverPublicKey
µµ 
=
µµ  %
serverPublicKeyProvider
µµ! 8
.
µµ8 9 
GetServerPublicKey
µµ9 K
(
µµK L
)
µµL M
;
µµM N
lock
·· 
(
·· 
_opaqueClientLock
·· 
)
··  
{
¸¸ 	
if
¹¹ 
(
¹¹ 
_opaqueClient
¹¹ 
.
¹¹ 
IsSome
¹¹ $
&&
¹¹% '$
_cachedServerPublicKey
¹¹( >
!=
¹¹? A
null
¹¹B F
&&
¹¹G I%
CryptographicOperations
ºº '
.
ºº' (
FixedTimeEquals
ºº( 7
(
ºº7 8
serverPublicKey
ºº8 G
,
ººG H$
_cachedServerPublicKey
ººI _
)
ºº_ `
)
ºº` a
{
»» 
return
¼¼ 
_opaqueClient
¼¼ $
.
¼¼$ %
Value
¼¼% *
!
¼¼* +
;
¼¼+ ,
}
½½ 
_opaqueClient
¿¿ 
.
¿¿ 
Do
¿¿ 
(
¿¿ 
client
¿¿ #
=>
¿¿$ &
client
¿¿' -
.
¿¿- .
Dispose
¿¿. 5
(
¿¿5 6
)
¿¿6 7
)
¿¿7 8
;
¿¿8 9
OpaqueClient
ÀÀ 
	newClient
ÀÀ "
=
ÀÀ# $
new
ÀÀ% (
(
ÀÀ( )
serverPublicKey
ÀÀ) 8
)
ÀÀ8 9
;
ÀÀ9 :
_opaqueClient
ÁÁ 
=
ÁÁ 
Option
ÁÁ "
<
ÁÁ" #
OpaqueClient
ÁÁ# /
>
ÁÁ/ 0
.
ÁÁ0 1
Some
ÁÁ1 5
(
ÁÁ5 6
	newClient
ÁÁ6 ?
)
ÁÁ? @
;
ÁÁ@ A$
_cachedServerPublicKey
ÂÂ "
=
ÂÂ# $
(
ÂÂ% &
byte
ÂÂ& *
[
ÂÂ* +
]
ÂÂ+ ,
)
ÂÂ, -
serverPublicKey
ÂÂ- <
.
ÂÂ< =
Clone
ÂÂ= B
(
ÂÂB C
)
ÂÂC D
;
ÂÂD E
return
ÄÄ 
	newClient
ÄÄ 
;
ÄÄ 
}
ÅÅ 	
}
ÆÆ 
private
ÈÈ 
async
ÈÈ 
Task
ÈÈ 
<
ÈÈ 
Result
ÈÈ 
<
ÈÈ 1
#OpaqueRecoverySecureKeyInitResponse
ÈÈ A
,
ÈÈA B
string
ÈÈC I
>
ÈÈI J
>
ÈÈJ K,
InitiateSecureKeyRecoveryAsync
ÈÈL j
(
ÈÈj k

ByteString
ÉÉ "
membershipIdentifier
ÉÉ '
,
ÉÉ' (
byte
ÊÊ 
[
ÊÊ 
]
ÊÊ 
recoveryRequest
ÊÊ 
,
ÊÊ 
uint
ËË 
	connectId
ËË 
,
ËË 
CancellationToken
ÌÌ 
cancellationToken
ÌÌ +
)
ÌÌ+ ,
{
ÍÍ 
if
ÎÎ 

(
ÎÎ "
membershipIdentifier
ÎÎ  
.
ÎÎ  !
IsEmpty
ÎÎ! (
)
ÎÎ( )
{
ÏÏ 	
return
ÐÐ 
Result
ÐÐ 
<
ÐÐ 1
#OpaqueRecoverySecureKeyInitResponse
ÐÐ =
,
ÐÐ= >
string
ÐÐ? E
>
ÐÐE F
.
ÐÐF G
Err
ÐÐG J
(
ÐÐJ K!
localizationService
ÑÑ #
[
ÑÑ# $%
AuthenticationConstants
ÑÑ$ ;
.
ÑÑ; <0
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY
ÑÑ< ^
]
ÑÑ^ _
)
ÑÑ_ `
;
ÑÑ` a
}
ÒÒ 	
try
ÔÔ 
{
ÕÕ 	0
"OpaqueRecoverySecureKeyInitRequest
ÖÖ .
request
ÖÖ/ 6
=
ÖÖ7 8
new
ÖÖ9 <
(
ÖÖ< =
)
ÖÖ= >
{
×× 
PeerOprf
ØØ 
=
ØØ 

ByteString
ØØ %
.
ØØ% &
CopyFrom
ØØ& .
(
ØØ. /
recoveryRequest
ØØ/ >
)
ØØ> ?
,
ØØ? @"
MembershipIdentifier
ÙÙ $
=
ÙÙ% &"
membershipIdentifier
ÙÙ' ;
}
ÚÚ 
;
ÚÚ "
TaskCompletionSource
ÜÜ  
<
ÜÜ  !1
#OpaqueRecoverySecureKeyInitResponse
ÜÜ! D
>
ÜÜD E
responseSource
ÜÜF T
=
ÜÜU V
new
ÜÜW Z
(
ÜÜZ [
)
ÜÜ[ \
;
ÜÜ\ ]
Result
ÞÞ 
<
ÞÞ 
Unit
ÞÞ 
,
ÞÞ 
NetworkFailure
ÞÞ '
>
ÞÞ' (
networkResult
ÞÞ) 6
=
ÞÞ7 8
await
ÞÞ9 >
networkProvider
ÞÞ? N
.
ÞÞN O&
ExecuteUnaryRequestAsync
ÞÞO g
(
ÞÞg h
	connectId
ßß 
,
ßß 
RpcServiceType
àà 
.
àà #
RecoverySecretKeyInit
àà 4
,
àà4 5%
SecureByteStringInterop
áá '
.
áá' ("
WithByteStringAsSpan
áá( <
(
áá< =
request
áá= D
.
ááD E
ToByteString
ááE Q
(
ááQ R
)
ááR S
,
ááS T
span
ááU Y
=>
ááZ \
span
áá] a
.
ááa b
ToArray
ááb i
(
áái j
)
ááj k
)
áák l
,
áál m
payload
áán u
=>
ááv x
{
ââ 1
#OpaqueRecoverySecureKeyInitResponse
ãã 7
response
ãã8 @
=
ããA B
Helpers
ää 
.
ää  
ParseFromBytes
ää  .
<
ää. /1
#OpaqueRecoverySecureKeyInitResponse
ää/ R
>
ääR S
(
ääS T
payload
ääT [
)
ää[ \
;
ää\ ]
responseSource
åå "
.
åå" #
TrySetResult
åå# /
(
åå/ 0
response
åå0 8
)
åå8 9
;
åå9 :
return
çç 
Task
çç 
.
çç  

FromResult
çç  *
(
çç* +
Result
çç+ 1
<
çç1 2
Unit
çç2 6
,
çç6 7
NetworkFailure
çç8 F
>
ççF G
.
ççG H
Ok
ççH J
(
ççJ K
Unit
ççK O
.
ççO P
Value
ççP U
)
ççU V
)
ççV W
;
ççW X
}
èè 
,
èè 
true
èè 
,
èè 
cancellationToken
èè *
)
èè* +
.
èè+ ,
ConfigureAwait
èè, :
(
èè: ;
false
èè; @
)
èè@ A
;
èèA B
if
êê 
(
êê 
networkResult
êê 
.
êê 
IsErr
êê #
)
êê# $
{
ëë 
return
ìì 
Result
ìì 
<
ìì 1
#OpaqueRecoverySecureKeyInitResponse
ìì A
,
ììA B
string
ììC I
>
ììI J
.
ììJ K
Err
ììK N
(
ììN O
networkResult
ììO \
.
ìì\ ]
	UnwrapErr
ìì] f
(
ììf g
)
ììg h
.
ììh i
Message
ììi p
)
ììp q
;
ììq r
}
íí 1
#OpaqueRecoverySecureKeyInitResponse
ïï /
initResponse
ïï0 <
=
ïï= >
await
ïï? D
responseSource
ïïE S
.
ïïS T
Task
ïïT X
.
ïïX Y
ConfigureAwait
ïïY g
(
ïïg h
false
ïïh m
)
ïïm n
;
ïïn o
return
ðð 
Result
ðð 
<
ðð 1
#OpaqueRecoverySecureKeyInitResponse
ðð =
,
ðð= >
string
ðð? E
>
ððE F
.
ððF G
Ok
ððG I
(
ððI J
initResponse
ððJ V
)
ððV W
;
ððW X
}
ññ 	
catch
òò 
(
òò 
	Exception
òò 
ex
òò 
)
òò 
{
óó 	
return
ôô 
Result
ôô 
<
ôô 1
#OpaqueRecoverySecureKeyInitResponse
ôô =
,
ôô= >
string
ôô? E
>
ôôE F
.
ôôF G
Err
ôôG J
(
ôôJ K
ex
ôôK M
.
ôôM N
Message
ôôN U
)
ôôU V
;
ôôV W
}
õõ 	
}
öö 
}÷÷ ª
ƒ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Common/InternalServiceApiFailure.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Common! '
;' (
public 
class %
InternalServiceApiFailure &
{ 
private %
InternalServiceApiFailure %
(% &)
InternalServiceApiFailureType& C
typeD H
,H I
stringJ P
messageQ X
,X Y
	Exception 
? 
innerException !
=" #
null$ (
)( )
{		 
Type

 
=

 
type

 
;

 
Message 
= 
message 
; 
InnerException 
= 
innerException '
;' (
} 
public 
)
InternalServiceApiFailureType (
Type) -
{. /
get0 3
;3 4
}5 6
public 

string 
Message 
{ 
get 
;  
}! "
public 

	Exception 
? 
InnerException $
{% &
get' *
;* +
}, -
public 

static %
InternalServiceApiFailure +#
SecureStoreAccessDenied, C
(C D
stringD J
detailsK R
,R S
	ExceptionT ]
?] ^
inner_ d
=e f
nullg k
)k l
=>m o
new 
( )
InternalServiceApiFailureType )
.) *&
SECURE_STORE_ACCESS_DENIED* D
,D E
detailsF M
,M N
innerO T
)T U
;U V
public 

static %
InternalServiceApiFailure +"
SecureStoreKeyNotFound, B
(B C
stringC I
detailsJ Q
,Q R
	ExceptionS \
?\ ]
inner^ c
=d e
nullf j
)j k
=>l n
new 
( )
InternalServiceApiFailureType )
.) *&
SECURE_STORE_KEY_NOT_FOUND* D
,D E
detailsF M
,M N
innerO T
)T U
;U V
public 

static %
InternalServiceApiFailure +
ApiRequestFailed, <
(< =
string= C
detailsD K
,K L
	ExceptionM V
?V W
innerX ]
=^ _
null` d
)d e
=>f h
new 
( )
InternalServiceApiFailureType )
.) *
API_REQUEST_FAILED* <
,< =
details> E
,E F
innerG L
)L M
;M N
} …±
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/OpaqueAuthenticationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
;/ 0
internal 
sealed	 
class '
OpaqueAuthenticationService 1
(1 2
NetworkProvider 
networkProvider #
,# $ 
ILocalizationService 
localizationService ,
,, -
IIdentityService 
identityService $
,$ %-
!IApplicationSecureStorageProvider %,
 applicationSecureStorageProvider& F
,F G$
IServerPublicKeyProvider   #
serverPublicKeyProvider   4
)  4 5
:!! "
IAuthenticationService!! 
,!! 
IDisposable!! )
{"" 
private## 
const## 
int## "
MAX_ALLOWED_ZERO_BYTES## ,
=##- .
$num##/ 1
;##1 2
private$$ 
const$$ 
int$$ %
MAX_SIGN_IN_FLOW_ATTEMPTS$$ /
=$$0 1
$num$$2 3
;$$3 4
private&& 
static&& 
readonly&& 

Dictionary&& &
<&&& '
OpaqueResult&&' 3
,&&3 4
string&&5 ;
>&&; <
OpaqueErrorMessages&&= P
=&&Q R
new&&S V
(&&V W
)&&W X
{'' 
{(( 	
OpaqueResult((
 
.(( 
INVALID_INPUT(( $
,(($ %#
AuthenticationConstants((& =
.((= >#
INVALID_CREDENTIALS_KEY((> U
}((V W
,((W X
{)) 	
OpaqueResult))
 
.)) 
CRYPTO_ERROR)) #
,))# $#
AuthenticationConstants))% <
.))< ='
COMMON_UNEXPECTED_ERROR_KEY))= X
}))Y Z
,))Z [
{** 	
OpaqueResult**
 
.** 
MEMORY_ERROR** #
,**# $#
AuthenticationConstants**% <
.**< ='
COMMON_UNEXPECTED_ERROR_KEY**= X
}**Y Z
,**Z [
{++ 	
OpaqueResult++
 
.++ 
VALIDATION_ERROR++ '
,++' (#
AuthenticationConstants++) @
.++@ A#
INVALID_CREDENTIALS_KEY++A X
}++Y Z
,++Z [
{,, 	
OpaqueResult,,
 
.,,  
AUTHENTICATION_ERROR,, +
,,,+ ,#
AuthenticationConstants,,- D
.,,D E#
INVALID_CREDENTIALS_KEY,,E \
},,] ^
,,,^ _
{-- 	
OpaqueResult--
 
.-- 
INVALID_PUBLIC_KEY-- )
,--) *#
AuthenticationConstants--+ B
.--B C'
COMMON_UNEXPECTED_ERROR_KEY--C ^
}--_ `
,--` a
}.. 
;.. 
private00 
readonly00 
Lock00 
_opaqueClientLock00 +
=00, -
new00. 1
(001 2
)002 3
;003 4
private11 
Option11 
<11 
OpaqueClient11 
>11  
_opaqueClient11! .
=11/ 0
Option111 7
<117 8
OpaqueClient118 D
>11D E
.11E F
None11F J
;11J K
private33 
sealed33 
record33 
SignInFlowResult33 *
(33* +$
SodiumSecureMemoryHandle44  
MasterKeyHandle44! 0
,440 1

ByteString55  
MembershipIdentifier55 '
,55' (
Guid66 
MembershipId66 
)66 
:66 
IDisposable66 (
{77 
public88 
void88 
Dispose88 
(88 
)88 
=>88  
MasterKeyHandle88! 0
.880 1
Dispose881 8
(888 9
)889 :
;88: ;
}99 
public;; 

async;; 
Task;; 
<;; 
Result;; 
<;; 
Unit;; !
,;;! "!
AuthenticationFailure;;# 8
>;;8 9
>;;9 :
SignInAsync;;; F
(;;F G
string;;G M
mobileNumber;;N Z
,;;Z [
SecureTextBuffer<< 
	secureKey<< "
,<<" #
uint== 
	connectId== 
,== 
CancellationToken== )
cancellationToken==* ;
===< =
default==> E
)==E F
{>> 
if?? 

(?? 
string?? 
.?? 
IsNullOrEmpty??  
(??  !
mobileNumber??! -
)??- .
)??. /
{@@ 	
stringAA 
mobileRequiredErrorAA &
=AA' (
localizationServiceAA) <
[AA< =#
AuthenticationConstantsAA= T
.AAT U&
MOBILE_NUMBER_REQUIRED_KEYAAU o
]AAo p
;AAp q
returnBB 
ResultBB 
<BB 
UnitBB 
,BB !
AuthenticationFailureBB  5
>BB5 6
.BB6 7
ErrBB7 :
(BB: ;!
AuthenticationFailureCC %
.CC% & 
MobileNumberRequiredCC& :
(CC: ;
mobileRequiredErrorCC; N
)CCN O
)CCO P
;CCP Q
}DD 	
SensitiveBytesFF 
?FF 
secureKeyBytesFF &
=FF' (
nullFF) -
;FF- .
ResultGG 
<GG 
SensitiveBytesGG 
,GG 
SodiumFailureGG ,
>GG, -
?GG- .
createResultGG/ ;
=GG< =
nullGG> B
;GGB C
tryII 
{JJ 	
	secureKeyKK 
.KK 
WithSecureBytesKK %
(KK% &
secureKeySpanKK& 3
=>KK4 6
{KK7 8
createResultKK9 E
=KKF G
SensitiveBytesKKH V
.KKV W
FromKKW [
(KK[ \
secureKeySpanKK\ i
)KKi j
;KKj k
}KKl m
)KKm n
;KKn o
ifMM 
(MM 
createResultMM 
==MM 
nullMM  $
||MM% '
createResultMM( 4
.MM4 5
ValueMM5 :
.MM: ;
IsErrMM; @
)MM@ A
{NN 
stringOO 
errorMessageOO #
=OO$ %
createResultOO& 2
?OO2 3
.OO3 4
IsErrOO4 9
isOO: <
trueOO= A
?PP 
$"PP 
$strPP <
{PP< =
createResultPP= I
.PPI J
ValuePPJ O
.PPO P
	UnwrapErrPPP Y
(PPY Z
)PPZ [
.PP[ \
MessagePP\ c
}PPc d
"PPd e
:QQ 
localizationServiceQQ )
[QQ) *#
AuthenticationConstantsQQ* A
.QQA B#
SECURE_KEY_REQUIRED_KEYQQB Y
]QQY Z
;QQZ [
returnRR 
ResultRR 
<RR 
UnitRR "
,RR" #!
AuthenticationFailureRR$ 9
>RR9 :
.RR: ;
ErrRR; >
(RR> ?!
AuthenticationFailureRR? T
.RRT U
SecureKeyRequiredRRU f
(RRf g
errorMessageRRg s
)RRs t
)RRt u
;RRu v
}SS 
secureKeyBytesUU 
=UU 
createResultUU )
.UU) *
ValueUU* /
.UU/ 0
UnwrapUU0 6
(UU6 7
)UU7 8
;UU8 9
ifWW 
(WW 
secureKeyBytesWW 
.WW 
LengthWW %
!=WW& (
$numWW) *
)WW* +
{XX 
ResultYY 
<YY 
SignInFlowResultYY '
,YY' (!
AuthenticationFailureYY) >
>YY> ?
signInResultYY@ L
=YYM N
awaitZZ "
ExecuteSignInFlowAsyncZZ 0
(ZZ0 1
mobileNumberZZ1 =
,ZZ= >
secureKeyBytesZZ? M
,ZZM N
	connectIdZZO X
,ZZX Y
cancellationTokenZZZ k
)ZZk l
.[[ 
ConfigureAwait[[ '
([[' (
false[[( -
)[[- .
;[[. /
if]] 
(]] 
signInResult]]  
.]]  !
IsErr]]! &
)]]& '
{^^ 
return__ 
Result__ !
<__! "
Unit__" &
,__& '!
AuthenticationFailure__( =
>__= >
.__> ?
Err__? B
(__B C
signInResult__C O
.__O P
	UnwrapErr__P Y
(__Y Z
)__Z [
)__[ \
;__\ ]
}`` 
usingbb 
SignInFlowResultbb &

flowResultbb' 1
=bb2 3
signInResultbb4 @
.bb@ A
UnwrapbbA G
(bbG H
)bbH I
;bbI J
returncc 
awaitcc 7
+RecreateAuthenticatedProtocolWithRetryAsynccc H
(ccH I

flowResultccI S
,ccS T
	connectIdccU ^
,cc^ _
cancellationTokencc` q
)ccq r
.dd 
ConfigureAwaitdd #
(dd# $
falsedd$ )
)dd) *
;dd* +
}ee 
stringgg 
requiredErrorgg  
=gg! "
localizationServicegg# 6
[gg6 7#
AuthenticationConstantsgg7 N
.ggN O#
SECURE_KEY_REQUIRED_KEYggO f
]ggf g
;ggg h
returnhh 
Resulthh 
<hh 
Unithh 
,hh !
AuthenticationFailurehh  5
>hh5 6
.hh6 7
Errhh7 :
(hh: ;!
AuthenticationFailurehh; P
.hhP Q
SecureKeyRequiredhhQ b
(hhb c
requiredErrorhhc p
)hhp q
)hhq r
;hhr s
}ii 	
finallyjj 
{kk 	
secureKeyBytesll 
?ll 
.ll 
Disposell #
(ll# $
)ll$ %
;ll% &
}mm 	
}nn 
privatepp 
asyncpp 
Taskpp 
<pp 
Resultpp 
<pp 
Unitpp "
,pp" #!
AuthenticationFailurepp$ 9
>pp9 :
>pp: ;7
+RecreateAuthenticatedProtocolWithRetryAsyncpp< g
(ppg h
SignInFlowResultqq 
signInFlowResultqq )
,qq) *
uintrr 
	connectIdrr 
,rr 
CancellationTokenss 
cancellationTokenss +
)ss+ ,
{tt 
constuu 
intuu '
maxProtocolRecreateAttemptsuu -
=uu. /
$numuu0 1
;uu1 2!
AuthenticationFailurevv 
	lastErrorvv '
=vv( )!
AuthenticationFailurevv* ?
.vv? @ 
NetworkRequestFailedvv@ T
(vvT U
$strvvU q
)vvq r
;vvr s
tryxx 
{yy 	
forzz 
(zz 
intzz 
attemptzz 
=zz 
$numzz  
;zz  !
attemptzz" )
<=zz* ,'
maxProtocolRecreateAttemptszz- H
;zzH I
attemptzzJ Q
++zzQ S
)zzS T
{{{ 
cancellationToken|| !
.||! "(
ThrowIfCancellationRequested||" >
(||> ?
)||? @
;||@ A
Result~~ 
<~~ 
Unit~~ 
,~~ !
AuthenticationFailure~~ 2
>~~2 3
protocolResult~~4 B
=~~C D
await~~E J.
"RecreateAuthenticatedProtocolAsync~~K m
(~~m n
signInFlowResult $
.$ %
MasterKeyHandle% 4
,4 5
signInFlowResult
€€ $
.
€€$ %"
MembershipIdentifier
€€% 9
,
€€9 :
	connectId
 
)
 
.
 
ConfigureAwait
 -
(
- .
false
. 3
)
3 4
;
4 5
if
ƒƒ 
(
ƒƒ 
protocolResult
ƒƒ "
.
ƒƒ" #
IsOk
ƒƒ# '
)
ƒƒ' (
{
„„ 
return
…… 
Result
…… !
<
……! "
Unit
……" &
,
……& '#
AuthenticationFailure
……( =
>
……= >
.
……> ?
Ok
……? A
(
……A B
Unit
……B F
.
……F G
Value
……G L
)
……L M
;
……M N
}
†† 
	lastError
ˆˆ 
=
ˆˆ 
protocolResult
ˆˆ *
.
ˆˆ* +
	UnwrapErr
ˆˆ+ 4
(
ˆˆ4 5
)
ˆˆ5 6
;
ˆˆ6 7
bool
ŠŠ 
isRetryableError
ŠŠ %
=
ŠŠ& '
	lastError
ŠŠ( 1
.
ŠŠ1 2
FailureType
ŠŠ2 =
==
ŠŠ> @'
AuthenticationFailureType
ŠŠA Z
.
ŠŠZ [$
NETWORK_REQUEST_FAILED
ŠŠ[ q
;
ŠŠq r
if
ŒŒ 
(
ŒŒ 
!
ŒŒ 
isRetryableError
ŒŒ %
||
ŒŒ& (
attempt
ŒŒ) 0
>=
ŒŒ1 3)
maxProtocolRecreateAttempts
ŒŒ4 O
)
ŒŒO P
{
 
networkProvider
ŽŽ #
.
ŽŽ# $

ExitOutage
ŽŽ$ .
(
ŽŽ. /
)
ŽŽ/ 0
;
ŽŽ0 1
return
 
Result
 !
<
! "
Unit
" &
,
& '#
AuthenticationFailure
( =
>
= >
.
> ?
Err
? B
(
B C
	lastError
C L
)
L M
;
M N
}
 
networkProvider
’’ 
.
’’  &
ClearExhaustedOperations
’’  8
(
’’8 9
)
’’9 :
;
’’: ;
}
““ 
networkProvider
•• 
.
•• 

ExitOutage
•• &
(
••& '
)
••' (
;
••( )
return
–– 
Result
–– 
<
–– 
Unit
–– 
,
–– #
AuthenticationFailure
––  5
>
––5 6
.
––6 7
Err
––7 :
(
––: ;
	lastError
––; D
)
––D E
;
––E F
}
—— 	
finally
˜˜ 
{
™™ 	
signInFlowResult
šš 
.
šš 
Dispose
šš $
(
šš$ %
)
šš% &
;
šš& '
}
›› 	
}
œœ 
public
žž 

void
žž 
Dispose
žž 
(
žž 
)
žž 
{
ŸŸ 
lock
   
(
   
_opaqueClientLock
   
)
    
{
¡¡ 	
_opaqueClient
¢¢ 
.
¢¢ 
Do
¢¢ 
(
¢¢ 
client
¢¢ #
=>
¢¢$ &
client
¢¢' -
.
¢¢- .
Dispose
¢¢. 5
(
¢¢5 6
)
¢¢6 7
)
¢¢7 8
;
¢¢8 9
_opaqueClient
££ 
=
££ 
Option
££ "
<
££" #
OpaqueClient
££# /
>
££/ 0
.
££0 1
None
££1 5
;
££5 6
}
¤¤ 	
}
¥¥ 
private
§§ 
static
§§ 
bool
§§ (
IsInvalidCredentialFailure
§§ 2
(
§§2 3
NetworkFailure
§§3 A
failure
§§B I
)
§§I J
{
¨¨ 
if
©© 

(
©© 
failure
©© 
.
©© 
	UserError
©© 
is
©©  
null
©©! %
)
©©% &
{
ªª 	
return
«« 
false
«« 
;
«« 
}
¬¬ 	
return
®® 
!
®® 
string
®® 
.
®®  
IsNullOrWhiteSpace
®® )
(
®®) *
failure
®®* 1
.
®®1 2
	UserError
®®2 ;
.
®®; <
I18NKey
®®< C
)
®®C D
&&
®®E G
string
¯¯ 
.
¯¯ 
Equals
¯¯ 
(
¯¯ 
failure
¯¯ $
.
¯¯$ %
	UserError
¯¯% .
.
¯¯. /
I18NKey
¯¯/ 6
,
¯¯6 7%
AuthenticationConstants
¯¯8 O
.
¯¯O P%
INVALID_CREDENTIALS_KEY
¯¯P g
,
¯¯g h
StringComparison
°° #
.
°°# $
OrdinalIgnoreCase
°°$ 5
)
°°5 6
;
°°6 7
}
±± 
private
³³ 
static
³³ 
Result
³³ 
<
³³ 
Unit
³³ 
,
³³ 
ValidationFailure
³³  1
>
³³1 2"
ValidateInitResponse
³³3 G
(
³³G H&
OpaqueSignInInitResponse
³³H `
initResponse
³³a m
)
³³m n
{
´´ 
return
µµ 
initResponse
µµ 
.
µµ 
Result
µµ "
switch
µµ# )
{
¶¶ 	&
OpaqueSignInInitResponse
·· $
.
··$ %
Types
··% *
.
··* +
SignInResult
··+ 7
.
··7 8 
InvalidCredentials
··8 J
=>
··K M
Result
··N T
<
··T U
Unit
··U Y
,
··Y Z
ValidationFailure
··[ l
>
··l m
.
··m n
Err
··n q
(
··q r
ValidationFailure
¸¸ !
.
¸¸! "
SignInFailed
¸¸" .
(
¸¸. /
initResponse
¸¸/ ;
.
¸¸; <
Message
¸¸< C
)
¸¸C D
)
¸¸D E
,
¸¸E F&
OpaqueSignInInitResponse
¹¹ $
.
¹¹$ %
Types
¹¹% *
.
¹¹* +
SignInResult
¹¹+ 7
.
¹¹7 8"
LoginAttemptExceeded
¹¹8 L
=>
¹¹M O
Result
¹¹P V
<
¹¹V W
Unit
¹¹W [
,
¹¹[ \
ValidationFailure
¹¹] n
>
¹¹n o
.
¹¹o p
Err
¹¹p s
(
¹¹s t
ValidationFailure
ºº !
.
ºº! ""
LoginAttemptExceeded
ºº" 6
(
ºº6 7
initResponse
ºº7 C
.
ººC D
Message
ººD K
)
ººK L
)
ººL M
,
ººM N
_
»» 
when
»» 
!
»» 
string
»» 
.
»» 
IsNullOrEmpty
»» (
(
»»( )
initResponse
»») 5
.
»»5 6
Message
»»6 =
)
»»= >
=>
»»? A
Result
¼¼ 
<
¼¼ 
Unit
¼¼ 
,
¼¼ 
ValidationFailure
¼¼ .
>
¼¼. /
.
¼¼/ 0
Err
¼¼0 3
(
¼¼3 4
ValidationFailure
½½ %
.
½½% &
SignInFailed
½½& 2
(
½½2 3
initResponse
½½3 ?
.
½½? @
Message
½½@ G
)
½½G H
)
½½H I
,
½½I J
_
¿¿ 
=>
¿¿ 
Result
¿¿ 
<
¿¿ 
Unit
¿¿ 
,
¿¿ 
ValidationFailure
¿¿ /
>
¿¿/ 0
.
¿¿0 1
Ok
¿¿1 3
(
¿¿3 4
Unit
¿¿4 8
.
¿¿8 9
Value
¿¿9 >
)
¿¿> ?
}
ÀÀ 	
;
ÀÀ	 

}
ÁÁ 
private
ÃÃ 
static
ÃÃ 
bool
ÃÃ *
ValidateMembershipIdentifier
ÃÃ 4
(
ÃÃ4 5

ByteString
ÃÃ5 ?

identifier
ÃÃ@ J
)
ÃÃJ K
{
ÄÄ 
if
ÅÅ 

(
ÅÅ 

identifier
ÅÅ 
.
ÅÅ 
Length
ÅÅ 
!=
ÅÅ  $
CryptographicConstants
ÅÅ! 7
.
ÅÅ7 8
GUID_BYTE_LENGTH
ÅÅ8 H
)
ÅÅH I
{
ÆÆ 	
return
ÇÇ 
false
ÇÇ 
;
ÇÇ 
}
ÈÈ 	
ReadOnlySpan
ÊÊ 
<
ÊÊ 
byte
ÊÊ 
>
ÊÊ 
span
ÊÊ 
=
ÊÊ  !

identifier
ÊÊ" ,
.
ÊÊ, -
Span
ÊÊ- 1
;
ÊÊ1 2
int
ÌÌ 
	zeroCount
ÌÌ 
=
ÌÌ 
$num
ÌÌ 
;
ÌÌ 
bool
ÍÍ 

hasNonZero
ÍÍ 
=
ÍÍ 
false
ÍÍ 
;
ÍÍ  
for
ÏÏ 
(
ÏÏ 
int
ÏÏ 
i
ÏÏ 
=
ÏÏ 
$num
ÏÏ 
;
ÏÏ 
i
ÏÏ 
<
ÏÏ 
span
ÏÏ  
.
ÏÏ  !
Length
ÏÏ! '
;
ÏÏ' (
i
ÏÏ) *
++
ÏÏ* ,
)
ÏÏ, -
{
ÐÐ 	
if
ÑÑ 
(
ÑÑ 
span
ÑÑ 
[
ÑÑ 
i
ÑÑ 
]
ÑÑ 
==
ÑÑ 
$num
ÑÑ 
)
ÑÑ 
{
ÒÒ 
	zeroCount
ÓÓ 
++
ÓÓ 
;
ÓÓ 
}
ÔÔ 
else
ÕÕ 
{
ÖÖ 

hasNonZero
×× 
=
×× 
true
×× !
;
××! "
}
ØØ 
}
ÙÙ 	
return
ÛÛ 

hasNonZero
ÛÛ 
&&
ÛÛ 
	zeroCount
ÛÛ &
<=
ÛÛ' )$
MAX_ALLOWED_ZERO_BYTES
ÛÛ* @
;
ÛÛ@ A
}
ÜÜ 
private
ÞÞ 
async
ÞÞ 
Task
ÞÞ 
<
ÞÞ 
Result
ÞÞ 
<
ÞÞ 
SignInFlowResult
ÞÞ .
,
ÞÞ. /#
AuthenticationFailure
ÞÞ0 E
>
ÞÞE F
>
ÞÞF G$
ExecuteSignInFlowAsync
ÞÞH ^
(
ÞÞ^ _
string
ÞÞ_ e
mobileNumber
ÞÞf r
,
ÞÞr s
SensitiveBytes
ßß 
	secureKey
ßß  
,
ßß  !
uint
àà 
	connectId
àà 
,
àà 
CancellationToken
àà )
cancellationToken
àà* ;
)
àà; <
{
áá #
AuthenticationFailure
ââ 
?
ââ 
	lastError
ââ (
=
ââ) *
null
ââ+ /
;
ââ/ 0
for
ää 
(
ää 
int
ää 
attempt
ää 
=
ää 
$num
ää 
;
ää 
attempt
ää %
<=
ää& ('
MAX_SIGN_IN_FLOW_ATTEMPTS
ää) B
;
ääB C
attempt
ääD K
++
ääK M
)
ääM N
{
åå 	
Result
ææ 
<
ææ 
SignInFlowResult
ææ #
,
ææ# $#
AuthenticationFailure
ææ% :
>
ææ: ;
attemptResult
ææ< I
=
ææJ K
await
çç -
ExecuteSingleSignInAttemptAsync
çç 5
(
çç5 6
mobileNumber
çç6 B
,
ççB C
	secureKey
ççD M
,
ççM N
	connectId
ççO X
,
ççX Y
cancellationToken
ççZ k
)
ççk l
.
èè 
ConfigureAwait
èè #
(
èè# $
false
èè$ )
)
èè) *
;
èè* +
if
êê 
(
êê 
attemptResult
êê 
.
êê 
IsOk
êê "
)
êê" #
{
ëë 
networkProvider
ìì 
.
ìì  

ExitOutage
ìì  *
(
ìì* +
)
ìì+ ,
;
ìì, -
return
íí 
attemptResult
íí $
;
íí$ %
}
îî 
	lastError
ðð 
=
ðð 
attemptResult
ðð %
.
ðð% &
	UnwrapErr
ðð& /
(
ðð/ 0
)
ðð0 1
;
ðð1 2
if
òò 
(
òò 
!
òò &
ShouldRetrySignInAttempt
òò )
(
òò) *
	lastError
òò* 3
,
òò3 4
attempt
òò5 <
)
òò< =
)
òò= >
{
óó 
networkProvider
ôô 
.
ôô  

ExitOutage
ôô  *
(
ôô* +
)
ôô+ ,
;
ôô, -
return
õõ 
Result
õõ 
<
õõ 
SignInFlowResult
õõ .
,
õõ. /#
AuthenticationFailure
õõ0 E
>
õõE F
.
õõF G
Err
õõG J
(
õõJ K
	lastError
õõK T
)
õõT U
;
õõU V
}
öö 
networkProvider
øø 
.
øø &
ClearExhaustedOperations
øø 4
(
øø4 5
)
øø5 6
;
øø6 7
}
ùù 	
networkProvider
ûû 
.
ûû 

ExitOutage
ûû "
(
ûû" #
)
ûû# $
;
ûû$ %
return
üü 
Result
üü 
<
üü 
SignInFlowResult
üü &
,
üü& '#
AuthenticationFailure
üü( =
>
üü= >
.
üü> ?
Err
üü? B
(
üüB C
	lastError
üüC L
??
üüM O#
AuthenticationFailure
ýýC X
.
ýýX Y
UnexpectedError
ýýY h
(
ýýh i
$str
þþG \
)
þþ\ ]
)
þþ] ^
;
þþ^ _
}
ÿÿ 
private
 
async
 
Task
 
<
 
Result
 
<
 
SignInFlowResult
 .
,
. /#
AuthenticationFailure
0 E
>
E F
>
F G-
ExecuteSingleSignInAttemptAsync
H g
(
g h
string
‚‚ 
mobileNumber
‚‚ 
,
‚‚ 
SensitiveBytes
ƒƒ 
	secureKey
ƒƒ  
,
ƒƒ  !
uint
„„ 
	connectId
„„ 
,
„„ 
CancellationToken
…… 
cancellationToken
…… +
)
……+ ,
{
†† 
RpcRequestContext
‡‡ 
requestContext
‡‡ (
=
‡‡) *
RpcRequestContext
‡‡+ <
.
‡‡< =
	CreateNew
‡‡= F
(
‡‡F G
)
‡‡G H
;
‡‡H I
bool
ˆˆ 
allowReinit
ˆˆ 
=
ˆˆ 
true
ˆˆ 
;
ˆˆ  
while
ŠŠ 
(
ŠŠ 
true
ŠŠ 
)
ŠŠ 
{
‹‹ 	
Result
ŒŒ 
<
ŒŒ 
SignInFlowResult
ŒŒ #
,
ŒŒ# $#
AuthenticationFailure
ŒŒ% :
>
ŒŒ: ;
result
ŒŒ< B
=
ŒŒC D
await
 .
 PerformOpaqueSignInExchangeAsync
 6
(
6 7
mobileNumber
7 C
,
C D
	secureKey
E N
,
N O
	connectId
P Y
,
Y Z
requestContext
[ i
,
i j
cancellationToken
ŽŽ %
)
ŽŽ% &
.
ŽŽ& '
ConfigureAwait
ŽŽ' 5
(
ŽŽ5 6
false
ŽŽ6 ;
)
ŽŽ; <
;
ŽŽ< =
if
 
(
 
result
 
.
 
IsOk
 
)
 
{
‘‘ 
return
’’ 
result
’’ 
;
’’ 
}
““ #
AuthenticationFailure
•• !
failure
••" )
=
••* +
result
••, 2
.
••2 3
	UnwrapErr
••3 <
(
••< =
)
••= >
;
••> ?
if
—— 
(
—— !
ShouldAttemptReinit
—— #
(
——# $
failure
——$ +
,
——+ ,
allowReinit
——- 8
)
——8 9
)
——9 :
{
˜˜ 
allowReinit
™™ 
=
™™ 
false
™™ #
;
™™# $
requestContext
šš 
.
šš !
MarkReinitAttempted
šš 2
(
šš2 3
)
šš3 4
;
šš4 5
continue
›› 
;
›› 
}
œœ 
return
žž 
Result
žž 
<
žž 
SignInFlowResult
žž *
,
žž* +#
AuthenticationFailure
žž, A
>
žžA B
.
žžB C
Err
žžC F
(
žžF G
failure
žžG N
)
žžN O
;
žžO P
}
ŸŸ 	
}
   
private
¢¢ 
async
¢¢ 
Task
¢¢ 
<
¢¢ 
Result
¢¢ 
<
¢¢ 
SignInFlowResult
¢¢ .
,
¢¢. /#
AuthenticationFailure
¢¢0 E
>
¢¢E F
>
¢¢F G.
 PerformOpaqueSignInExchangeAsync
¢¢H h
(
¢¢h i
string
££ 
mobileNumber
££ 
,
££ 
SensitiveBytes
¤¤ 
	secureKey
¤¤  
,
¤¤  !
uint
¥¥ 
	connectId
¥¥ 
,
¥¥ 
RpcRequestContext
¦¦ 
requestContext
¦¦ (
,
¦¦( )
CancellationToken
§§ 
cancellationToken
§§ +
)
§§+ ,
{
¨¨ 
cancellationToken
©© 
.
©© *
ThrowIfCancellationRequested
©© 6
(
©©6 7
)
©©7 8
;
©©8 9
using
«« 
OpaqueClient
«« 
opaqueClient
«« '
=
««( )
new
««* -
(
««- .%
serverPublicKeyProvider
««. E
.
««E F 
GetServerPublicKey
««F X
(
««X Y
)
««Y Z
)
««Z [
;
««[ \!
OpaqueSignInContext
­­ 
signInContext
­­ )
=
­­* +
new
­­, /
(
­­/ 0
)
­­0 1
;
­­1 2
try
¯¯ 
{
°° 	
Result
±± 
<
±± 
byte
±± 
[
±± 
]
±± 
,
±± #
AuthenticationFailure
±± 0
>
±±0 1
secureKeyResult
±±2 A
=
±±B C&
ValidateAndCopySecureKey
±±D \
(
±±\ ]
	secureKey
±±] f
)
±±f g
;
±±g h
if
²² 
(
²² 
secureKeyResult
²² 
.
²²  
IsErr
²²  %
)
²²% &
{
³³ 
return
´´ 
Result
´´ 
<
´´ 
SignInFlowResult
´´ .
,
´´. /#
AuthenticationFailure
´´0 E
>
´´E F
.
´´F G
Err
´´G J
(
´´J K
secureKeyResult
´´K Z
.
´´Z [
	UnwrapErr
´´[ d
(
´´d e
)
´´e f
)
´´f g
;
´´g h
}
µµ 
signInContext
·· 
.
·· 
SecureKeyCopy
·· '
=
··( )
secureKeyResult
··* 9
.
··9 :
Unwrap
··: @
(
··@ A
)
··A B
;
··B C
Result
¹¹ 
<
¹¹ 
SignInFlowResult
¹¹ #
,
¹¹# $#
AuthenticationFailure
¹¹% :
>
¹¹: ;
result
¹¹< B
=
¹¹C D
await
¹¹E J+
ExecuteOpaqueSignInStepsAsync
¹¹K h
(
¹¹h i
opaqueClient
ºº 
,
ºº 
mobileNumber
»» 
,
»» 
signInContext
¼¼ 
,
¼¼ 
	connectId
½½ 
,
½½ 
requestContext
¾¾ 
,
¾¾ 
cancellationToken
¿¿ !
)
¿¿! "
.
¿¿" #
ConfigureAwait
¿¿# 1
(
¿¿1 2
false
¿¿2 7
)
¿¿7 8
;
¿¿8 9
return
ÁÁ 
result
ÁÁ 
;
ÁÁ 
}
ÂÂ 	
finally
ÃÃ 
{
ÄÄ 	"
CleanupSignInContext
ÅÅ  
(
ÅÅ  !
signInContext
ÅÅ! .
)
ÅÅ. /
;
ÅÅ/ 0
}
ÆÆ 	
}
ÇÇ 
private
ÉÉ 
async
ÉÉ 
Task
ÉÉ 
<
ÉÉ 
Result
ÉÉ 
<
ÉÉ 
SignInFlowResult
ÉÉ .
,
ÉÉ. /#
AuthenticationFailure
ÉÉ0 E
>
ÉÉE F
>
ÉÉF G+
ExecuteOpaqueSignInStepsAsync
ÉÉH e
(
ÉÉe f
OpaqueClient
ÊÊ 
opaqueClient
ÊÊ !
,
ÊÊ! "
string
ËË 
mobileNumber
ËË 
,
ËË !
OpaqueSignInContext
ÌÌ 
signInContext
ÌÌ )
,
ÌÌ) *
uint
ÍÍ 
	connectId
ÍÍ 
,
ÍÍ 
RpcRequestContext
ÎÎ 
requestContext
ÎÎ (
,
ÎÎ( )
CancellationToken
ÏÏ 
cancellationToken
ÏÏ +
)
ÏÏ+ ,
{
ÐÐ 
using
ÑÑ 
KeyExchangeResult
ÑÑ 
	ke1Result
ÑÑ  )
=
ÑÑ* +
opaqueClient
ÑÑ, 8
.
ÑÑ8 9
GenerateKE1
ÑÑ9 D
(
ÑÑD E
signInContext
ÑÑE R
.
ÑÑR S
SecureKeyCopy
ÑÑS `
!
ÑÑ` a
)
ÑÑa b
;
ÑÑb c
Result
ÓÓ 
<
ÓÓ &
OpaqueSignInInitResponse
ÓÓ '
,
ÓÓ' (#
AuthenticationFailure
ÓÓ) >
>
ÓÓ> ?

initResult
ÓÓ@ J
=
ÓÓK L
await
ÔÔ )
PerformSignInInitPhaseAsync
ÔÔ -
(
ÔÔ- .
mobileNumber
ÔÔ. :
,
ÔÔ: ;
	ke1Result
ÔÔ< E
,
ÔÔE F
	connectId
ÔÔG P
,
ÔÔP Q
requestContext
ÔÔR `
,
ÔÔ` a
cancellationToken
ÔÔb s
)
ÔÔs t
.
ÕÕ 
ConfigureAwait
ÕÕ 
(
ÕÕ  
false
ÕÕ  %
)
ÕÕ% &
;
ÕÕ& '
if
×× 

(
×× 

initResult
×× 
.
×× 
IsErr
×× 
)
×× 
{
ØØ 	
return
ÙÙ 
Result
ÙÙ 
<
ÙÙ 
SignInFlowResult
ÙÙ *
,
ÙÙ* +#
AuthenticationFailure
ÙÙ, A
>
ÙÙA B
.
ÙÙB C
Err
ÙÙC F
(
ÙÙF G

initResult
ÙÙG Q
.
ÙÙQ R
	UnwrapErr
ÙÙR [
(
ÙÙ[ \
)
ÙÙ\ ]
)
ÙÙ] ^
;
ÙÙ^ _
}
ÚÚ 	&
OpaqueSignInInitResponse
ÜÜ  
initResponse
ÜÜ! -
=
ÜÜ. /

initResult
ÜÜ0 :
.
ÜÜ: ;
Unwrap
ÜÜ; A
(
ÜÜA B
)
ÜÜB C
;
ÜÜC D
signInContext
ÝÝ 
.
ÝÝ 
Ke2Data
ÝÝ 
=
ÝÝ 
initResponse
ÝÝ  ,
.
ÝÝ, -
ServerStateToken
ÝÝ- =
.
ÝÝ= >
ToByteArray
ÝÝ> I
(
ÝÝI J
)
ÝÝJ K
;
ÝÝK L
Result
ßß 
<
ßß  
OpaqueExchangeData
ßß !
,
ßß! "#
AuthenticationFailure
ßß# 8
>
ßß8 9
exchangeResult
ßß: H
=
ßßI J'
CompleteOpaqueKeyExchange
àà %
(
àà% &
opaqueClient
àà& 2
,
àà2 3
signInContext
àà4 A
.
ààA B
Ke2Data
ààB I
,
ààI J
	ke1Result
ààK T
)
ààT U
;
ààU V
if
ââ 

(
ââ 
exchangeResult
ââ 
.
ââ 
IsErr
ââ  
)
ââ  !
{
ãã 	
return
ää 
Result
ää 
<
ää 
SignInFlowResult
ää *
,
ää* +#
AuthenticationFailure
ää, A
>
ääA B
.
ääB C
Err
ääC F
(
ääF G
exchangeResult
ääG U
.
ääU V
	UnwrapErr
ääV _
(
ää_ `
)
ää` a
)
ääa b
;
ääb c
}
åå 	 
OpaqueExchangeData
çç 
exchangeData
çç '
=
çç( )
exchangeResult
çç* 8
.
çç8 9
Unwrap
çç9 ?
(
çç? @
)
çç@ A
;
ççA B
signInContext
èè 
.
èè 
Ke3Data
èè 
=
èè 
exchangeData
èè  ,
.
èè, -
Ke3Data
èè- 4
;
èè4 5
signInContext
éé 
.
éé 
MasterKeyHandle
éé %
=
éé& '
exchangeData
éé( 4
.
éé4 5
MasterKeyHandle
éé5 D
;
ééD E
Result
ëë 
<
ëë 
SignInFlowResult
ëë 
,
ëë  #
AuthenticationFailure
ëë! 6
>
ëë6 7
finalizeResult
ëë8 F
=
ëëG H
await
ìì -
PerformSignInFinalizePhaseAsync
ìì 1
(
ìì1 2
mobileNumber
íí 
,
íí 
signInContext
îî 
.
îî 
Ke3Data
îî %
,
îî% &
signInContext
ïï 
.
ïï 
MasterKeyHandle
ïï -
,
ïï- .
	connectId
ðð 
,
ðð 
requestContext
ññ 
,
ññ 
cancellationToken
òò !
)
òò! "
.
òò" #
ConfigureAwait
òò# 1
(
òò1 2
false
òò2 7
)
òò7 8
;
òò8 9
if
ôô 

(
ôô 
finalizeResult
ôô 
.
ôô 
IsOk
ôô 
)
ôô  
{
õõ 	
signInContext
öö 
.
öö "
OwnershipTransferred
öö .
=
öö/ 0
true
öö1 5
;
öö5 6
}
÷÷ 	
return
ùù 
finalizeResult
ùù 
;
ùù 
}
úú 
private
üü 
static
üü 
void
üü "
CleanupSignInContext
üü ,
(
üü, -!
OpaqueSignInContext
üü- @
context
üüA H
)
üüH I
{
ýý 
if
þþ 

(
þþ 
context
þþ 
is
þþ 
{
þþ 
MasterKeyHandle
þþ (
:
þþ( )
not
þþ* -
null
þþ. 2
,
þþ2 3"
OwnershipTransferred
þþ4 H
:
þþH I
false
þþJ O
}
þþP Q
)
þþQ R
{
ÿÿ 	
context
€€ 
.
€€ 
MasterKeyHandle
€€ #
.
€€# $
Dispose
€€$ +
(
€€+ ,
)
€€, -
;
€€- .
}
 	
SecureCleanup
ƒƒ 
(
ƒƒ 
context
ƒƒ 
.
ƒƒ 
SecureKeyCopy
ƒƒ +
,
ƒƒ+ ,
context
ƒƒ- 4
.
ƒƒ4 5
Ke2Data
ƒƒ5 <
,
ƒƒ< =
context
ƒƒ> E
.
ƒƒE F
Ke3Data
ƒƒF M
)
ƒƒM N
;
ƒƒN O
}
„„ 
private
†† 
sealed
†† 
class
†† !
OpaqueSignInContext
†† ,
{
‡‡ 
public
ˆˆ 
byte
ˆˆ 
[
ˆˆ 
]
ˆˆ 
?
ˆˆ 
SecureKeyCopy
ˆˆ $
{
ˆˆ% &
get
ˆˆ' *
;
ˆˆ* +
set
ˆˆ, /
;
ˆˆ/ 0
}
ˆˆ1 2
public
‰‰ 
byte
‰‰ 
[
‰‰ 
]
‰‰ 
?
‰‰ 
Ke2Data
‰‰ 
{
‰‰  
get
‰‰! $
;
‰‰$ %
set
‰‰& )
;
‰‰) *
}
‰‰+ ,
public
ŠŠ 
byte
ŠŠ 
[
ŠŠ 
]
ŠŠ 
?
ŠŠ 
Ke3Data
ŠŠ 
{
ŠŠ  
get
ŠŠ! $
;
ŠŠ$ %
set
ŠŠ& )
;
ŠŠ) *
}
ŠŠ+ ,
public
‹‹ &
SodiumSecureMemoryHandle
‹‹ '
?
‹‹' (
MasterKeyHandle
‹‹) 8
{
‹‹9 :
get
‹‹; >
;
‹‹> ?
set
‹‹@ C
;
‹‹C D
}
‹‹E F
public
ŒŒ 
bool
ŒŒ "
OwnershipTransferred
ŒŒ (
{
ŒŒ) *
get
ŒŒ+ .
;
ŒŒ. /
set
ŒŒ0 3
;
ŒŒ3 4
}
ŒŒ5 6
}
 
private
 
async
 
Task
 
<
 
Result
 
<
 &
OpaqueSignInInitResponse
 6
,
6 7#
AuthenticationFailure
8 M
>
M N
>
N O)
PerformSignInInitPhaseAsync
P k
(
k l
string
 
mobileNumber
 
,
 
KeyExchangeResult
‘‘ 
	ke1Result
‘‘ #
,
‘‘# $
uint
’’ 
	connectId
’’ 
,
’’ 
RpcRequestContext
““ 
requestContext
““ (
,
““( )
CancellationToken
”” 
cancellationToken
”” +
)
””+ ,
{
•• %
OpaqueSignInInitRequest
–– 
initRequest
––  +
=
––, -
new
––. 1
(
––1 2
)
––2 3
{
—— 	
MobileNumber
˜˜ 
=
˜˜ 
mobileNumber
˜˜ '
,
˜˜' (
PeerOprf
˜˜) 1
=
˜˜2 3

ByteString
˜˜4 >
.
˜˜> ?
CopyFrom
˜˜? G
(
˜˜G H
	ke1Result
˜˜H Q
.
˜˜Q R$
GetKeyExchangeDataCopy
˜˜R h
(
˜˜h i
)
˜˜i j
)
˜˜j k
,
˜˜k l
}
™™ 	
;
™™	 

Result
›› 
<
›› &
OpaqueSignInInitResponse
›› '
,
››' (
NetworkFailure
››) 7
>
››7 8

initResult
››9 C
=
››D E
await
œœ "
SendInitRequestAsync
œœ &
(
œœ& '
initRequest
œœ' 2
,
œœ2 3
	connectId
œœ4 =
,
œœ= >
requestContext
œœ? M
,
œœM N
cancellationToken
œœO `
)
œœ` a
.
 
ConfigureAwait
 
(
  
false
  %
)
% &
;
& '
if
ŸŸ 

(
ŸŸ 

initResult
ŸŸ 
.
ŸŸ 
IsErr
ŸŸ 
)
ŸŸ 
{
   	
return
¡¡ 
Result
¡¡ 
<
¡¡ &
OpaqueSignInInitResponse
¡¡ 2
,
¡¡2 3#
AuthenticationFailure
¡¡4 I
>
¡¡I J
.
¡¡J K
Err
¡¡K N
(
¡¡N O
MapNetworkFailure
¢¢ !
(
¢¢! "

initResult
¢¢" ,
.
¢¢, -
	UnwrapErr
¢¢- 6
(
¢¢6 7
)
¢¢7 8
)
¢¢8 9
)
¢¢9 :
;
¢¢: ;
}
££ 	&
OpaqueSignInInitResponse
¥¥  
initResponse
¥¥! -
=
¥¥. /

initResult
¥¥0 :
.
¥¥: ;
Unwrap
¥¥; A
(
¥¥A B
)
¥¥B C
;
¥¥C D
Result
§§ 
<
§§ 
Unit
§§ 
,
§§ 
ValidationFailure
§§ &
>
§§& '
validationResult
§§( 8
=
§§9 :"
ValidateInitResponse
§§; O
(
§§O P
initResponse
§§P \
)
§§\ ]
;
§§] ^
if
¨¨ 

(
¨¨ 
validationResult
¨¨ 
.
¨¨ 
IsErr
¨¨ "
)
¨¨" #
{
©© 	
return
ªª 
Result
ªª 
<
ªª &
OpaqueSignInInitResponse
ªª 2
,
ªª2 3#
AuthenticationFailure
ªª4 I
>
ªªI J
.
ªªJ K
Err
ªªK N
(
ªªN O"
MapValidationFailure
«« $
(
««$ %
validationResult
««% 5
.
««5 6
	UnwrapErr
««6 ?
(
««? @
)
««@ A
)
««A B
)
««B C
;
««C D
}
¬¬ 	
return
®® 
Result
®® 
<
®® &
OpaqueSignInInitResponse
®® .
,
®®. /#
AuthenticationFailure
®®0 E
>
®®E F
.
®®F G
Ok
®®G I
(
®®I J
initResponse
®®J V
)
®®V W
;
®®W X
}
¯¯ 
private
±± 
Result
±± 
<
±±  
OpaqueExchangeData
±± %
,
±±% &#
AuthenticationFailure
±±' <
>
±±< ='
CompleteOpaqueKeyExchange
±±> W
(
±±W X
OpaqueClient
²² 
opaqueClient
²² !
,
²²! "
byte
³³ 
[
³³ 
]
³³ 
ke2Data
³³ 
,
³³ 
KeyExchangeResult
´´ 
	ke1Result
´´ #
)
´´# $
{
µµ 
Result
¶¶ 
<
¶¶ 
byte
¶¶ 
[
¶¶ 
]
¶¶ 
,
¶¶ #
AuthenticationFailure
¶¶ ,
>
¶¶, -
	ke3Result
¶¶. 7
=
¶¶8 9&
PerformOpaqueKe3Exchange
¶¶: R
(
¶¶R S
opaqueClient
¶¶S _
,
¶¶_ `
ke2Data
¶¶a h
,
¶¶h i
	ke1Result
¶¶j s
)
¶¶s t
;
¶¶t u
if
·· 

(
·· 
	ke3Result
·· 
.
·· 
IsErr
·· 
)
·· 
{
¸¸ 	
return
¹¹ 
Result
¹¹ 
<
¹¹  
OpaqueExchangeData
¹¹ ,
,
¹¹, -#
AuthenticationFailure
¹¹. C
>
¹¹C D
.
¹¹D E
Err
¹¹E H
(
¹¹H I
	ke3Result
¹¹I R
.
¹¹R S
	UnwrapErr
¹¹S \
(
¹¹\ ]
)
¹¹] ^
)
¹¹^ _
;
¹¹_ `
}
ºº 	
byte
¼¼ 
[
¼¼ 
]
¼¼ 
ke3Data
¼¼ 
=
¼¼ 
	ke3Result
¼¼ "
.
¼¼" #
Unwrap
¼¼# )
(
¼¼) *
)
¼¼* +
;
¼¼+ ,
Result
¾¾ 
<
¾¾ &
SodiumSecureMemoryHandle
¾¾ '
,
¾¾' (#
AuthenticationFailure
¾¾) >
>
¾¾> ?
masterKeyResult
¾¾@ O
=
¾¾P Q(
ExtractMasterKeyFromOpaque
¿¿ &
(
¿¿& '
opaqueClient
¿¿' 3
,
¿¿3 4
	ke1Result
¿¿5 >
)
¿¿> ?
;
¿¿? @
if
ÁÁ 

(
ÁÁ 
masterKeyResult
ÁÁ 
.
ÁÁ 
IsErr
ÁÁ !
)
ÁÁ! "
{
ÂÂ 	
return
ÃÃ 
Result
ÃÃ 
<
ÃÃ  
OpaqueExchangeData
ÃÃ ,
,
ÃÃ, -#
AuthenticationFailure
ÃÃ. C
>
ÃÃC D
.
ÃÃD E
Err
ÃÃE H
(
ÃÃH I
masterKeyResult
ÃÃI X
.
ÃÃX Y
	UnwrapErr
ÃÃY b
(
ÃÃb c
)
ÃÃc d
)
ÃÃd e
;
ÃÃe f
}
ÄÄ 	&
SodiumSecureMemoryHandle
ÆÆ  
masterKeyHandle
ÆÆ! 0
=
ÆÆ1 2
masterKeyResult
ÆÆ3 B
.
ÆÆB C
Unwrap
ÆÆC I
(
ÆÆI J
)
ÆÆJ K
;
ÆÆK L
return
ÈÈ 
Result
ÈÈ 
<
ÈÈ  
OpaqueExchangeData
ÈÈ (
,
ÈÈ( )#
AuthenticationFailure
ÈÈ* ?
>
ÈÈ? @
.
ÈÈ@ A
Ok
ÈÈA C
(
ÈÈC D
new
ÉÉ  
OpaqueExchangeData
ÉÉ "
(
ÉÉ" #
ke3Data
ÉÉ# *
,
ÉÉ* +
masterKeyHandle
ÉÉ, ;
)
ÉÉ; <
)
ÉÉ< =
;
ÉÉ= >
}
ÊÊ 
private
ÌÌ 
async
ÌÌ 
Task
ÌÌ 
<
ÌÌ 
Result
ÌÌ 
<
ÌÌ 
SignInFlowResult
ÌÌ .
,
ÌÌ. /#
AuthenticationFailure
ÌÌ0 E
>
ÌÌE F
>
ÌÌF G-
PerformSignInFinalizePhaseAsync
ÌÌH g
(
ÌÌg h
string
ÍÍ 
mobileNumber
ÍÍ 
,
ÍÍ 
byte
ÎÎ 
[
ÎÎ 
]
ÎÎ 
ke3Data
ÎÎ 
,
ÎÎ &
SodiumSecureMemoryHandle
ÏÏ  
masterKeyHandle
ÏÏ! 0
,
ÏÏ0 1
uint
ÐÐ 
	connectId
ÐÐ 
,
ÐÐ 
RpcRequestContext
ÑÑ 
requestContext
ÑÑ (
,
ÑÑ( )
CancellationToken
ÒÒ 
cancellationToken
ÒÒ +
)
ÒÒ+ ,
{
ÓÓ )
OpaqueSignInFinalizeRequest
ÔÔ #
finalizeRequest
ÔÔ$ 3
=
ÔÔ4 5
new
ÔÔ6 9
(
ÔÔ9 :
)
ÔÔ: ;
{
ÕÕ 	
MobileNumber
ÖÖ 
=
ÖÖ 
mobileNumber
ÖÖ '
,
ÖÖ' (
	ClientMac
ÖÖ) 2
=
ÖÖ3 4

ByteString
ÖÖ5 ?
.
ÖÖ? @
CopyFrom
ÖÖ@ H
(
ÖÖH I
ke3Data
ÖÖI P
)
ÖÖP Q
,
ÖÖQ R
}
×× 	
;
××	 

Result
ÙÙ 
<
ÙÙ 
SignInResult
ÙÙ 
,
ÙÙ 
NetworkFailure
ÙÙ +
>
ÙÙ+ ,
finalResult
ÙÙ- 8
=
ÙÙ9 :
await
ÚÚ /
!SendFinalizeRequestAndVerifyAsync
ÚÚ 3
(
ÚÚ3 4
finalizeRequest
ÚÚ4 C
,
ÚÚC D
	connectId
ÚÚE N
,
ÚÚN O
requestContext
ÚÚP ^
,
ÚÚ^ _
cancellationToken
ÚÚ` q
)
ÚÚq r
.
ÛÛ 
ConfigureAwait
ÛÛ 
(
ÛÛ  
false
ÛÛ  %
)
ÛÛ% &
;
ÛÛ& '
if
ÝÝ 

(
ÝÝ 
finalResult
ÝÝ 
.
ÝÝ 
IsErr
ÝÝ 
)
ÝÝ 
{
ÞÞ 	
return
ßß 
Result
ßß 
<
ßß 
SignInFlowResult
ßß *
,
ßß* +#
AuthenticationFailure
ßß, A
>
ßßA B
.
ßßB C
Err
ßßC F
(
ßßF G
MapNetworkFailure
àà !
(
àà! "
finalResult
àà" -
.
àà- .
	UnwrapErr
àà. 7
(
àà7 8
)
àà8 9
)
àà9 :
)
àà: ;
;
àà; <
}
áá 	
SignInResult
ãã 
signInResult
ãã !
=
ãã" #
finalResult
ãã$ /
.
ãã/ 0
Unwrap
ãã0 6
(
ãã6 7
)
ãã7 8
;
ãã8 9
return
åå 
await
åå &
ProcessSignInResultAsync
åå -
(
åå- .
masterKeyHandle
åå. =
,
åå= >
signInResult
åå? K
)
ååK L
.
ååL M
ConfigureAwait
ååM [
(
åå[ \
false
åå\ a
)
ååa b
;
ååb c
}
ææ 
private
èè 
async
èè 
Task
èè 
<
èè 
Result
èè 
<
èè 
SignInFlowResult
èè .
,
èè. /#
AuthenticationFailure
èè0 E
>
èèE F
>
èèF G&
ProcessSignInResultAsync
èèH `
(
èè` a&
SodiumSecureMemoryHandle
éé  
masterKeyHandle
éé! 0
,
éé0 1
SignInResult
êê 
signInResult
êê !
)
êê! "
{
ëë 
if
ìì 

(
ìì 
!
ìì 
signInResult
ìì 
.
ìì 

Membership
ìì $
.
ìì$ %
IsSome
ìì% +
)
ìì+ ,
{
íí 	
return
îî 
Result
îî 
<
îî 
SignInFlowResult
îî *
,
îî* +#
AuthenticationFailure
îî, A
>
îîA B
.
îîB C
Ok
îîC E
(
îîE F
new
ïï 
SignInFlowResult
ïï $
(
ïï$ %
masterKeyHandle
ïï% 4
,
ïï4 5

ByteString
ïï6 @
.
ïï@ A
Empty
ïïA F
,
ïïF G
Guid
ïïH L
.
ïïL M
Empty
ïïM R
)
ïïR S
)
ïïS T
;
ïïT U
}
ðð 	
Ecliptix
òò 
.
òò 
Protobuf
òò 
.
òò 

Membership
òò $
.
òò$ %

Membership
òò% /

membership
òò0 :
=
òò; <
signInResult
òò= I
.
òòI J

Membership
òòJ T
.
òòT U
Value
òòU Z
!
òòZ [
;
òò[ \

ByteString
óó "
membershipIdentifier
óó '
=
óó( )

membership
óó* 4
.
óó4 5
UniqueIdentifier
óó5 E
;
óóE F
Result
õõ 
<
õõ &
SodiumSecureMemoryHandle
õõ '
,
õõ' (#
AuthenticationFailure
õõ) >
>
õõ> ?'
masterKeyValidationResult
õõ@ Y
=
õõZ [*
DeriveMasterKeyForMembership
öö (
(
öö( )
masterKeyHandle
öö) 8
,
öö8 9"
membershipIdentifier
öö: N
)
ööN O
;
ööO P
if
øø 

(
øø '
masterKeyValidationResult
øø %
.
øø% &
IsErr
øø& +
)
øø+ ,
{
ùù 	
return
úú 
Result
úú 
<
úú 
SignInFlowResult
úú *
,
úú* +#
AuthenticationFailure
úú, A
>
úúA B
.
úúB C
Err
úúC F
(
úúF G'
masterKeyValidationResult
úúG `
.
úú` a
	UnwrapErr
úúa j
(
úúj k
)
úúk l
)
úúl m
;
úúm n
}
ûû 	
Result
ýý 
<
ýý 
Unit
ýý 
,
ýý #
AuthenticationFailure
ýý *
>
ýý* +
storeResult
ýý, 7
=
ýý8 9
await
þþ -
StoreIdentityAndMembershipAsync
þþ 1
(
þþ1 2
masterKeyHandle
þþ2 A
,
þþA B
signInResult
þþC O
)
þþO P
.
þþP Q
ConfigureAwait
þþQ _
(
þþ_ `
false
þþ` e
)
þþe f
;
þþf g
if
€€ 

(
€€ 
storeResult
€€ 
.
€€ 
IsErr
€€ 
)
€€ 
{
 	
return
‚‚ 
Result
‚‚ 
<
‚‚ 
SignInFlowResult
‚‚ *
,
‚‚* +#
AuthenticationFailure
‚‚, A
>
‚‚A B
.
‚‚B C
Err
‚‚C F
(
‚‚F G
storeResult
‚‚G R
.
‚‚R S
	UnwrapErr
‚‚S \
(
‚‚\ ]
)
‚‚] ^
)
‚‚^ _
;
‚‚_ `
}
ƒƒ 	
Guid
…… 
membershipId
…… 
=
…… 
Helpers
…… #
.
……# $"
FromByteStringToGuid
……$ 8
(
……8 9"
membershipIdentifier
……9 M
)
……M N
;
……N O
SignInFlowResult
†† 

flowResult
†† #
=
††$ %
new
††& )
(
††) *
masterKeyHandle
††* 9
,
††9 :"
membershipIdentifier
††; O
,
††O P
membershipId
††Q ]
)
††] ^
;
††^ _
return
ˆˆ 
Result
ˆˆ 
<
ˆˆ 
SignInFlowResult
ˆˆ &
,
ˆˆ& '#
AuthenticationFailure
ˆˆ( =
>
ˆˆ= >
.
ˆˆ> ?
Ok
ˆˆ? A
(
ˆˆA B

flowResult
ˆˆB L
)
ˆˆL M
;
ˆˆM N
}
‰‰ 
private
‹‹ 
static
‹‹ 
bool
‹‹ &
ShouldRetrySignInAttempt
‹‹ 0
(
‹‹0 1#
AuthenticationFailure
‹‹1 F
failure
‹‹G N
,
‹‹N O
int
‹‹P S
attempt
‹‹T [
)
‹‹[ \
{
ŒŒ 
bool
 
isRetryableError
 
=
 
failure
  '
.
' (
FailureType
( 3
==
4 6'
AuthenticationFailureType
7 P
.
P Q$
NETWORK_REQUEST_FAILED
Q g
;
g h
return
ŽŽ 
isRetryableError
ŽŽ 
&&
ŽŽ  "
attempt
ŽŽ# *
<
ŽŽ+ ,'
MAX_SIGN_IN_FLOW_ATTEMPTS
ŽŽ- F
;
ŽŽF G
}
 
private
‘‘ 
static
‘‘ 
bool
‘‘ !
ShouldAttemptReinit
‘‘ +
(
‘‘+ ,#
AuthenticationFailure
‘‘, A
failure
‘‘B I
,
‘‘I J
bool
‘‘K O
allowReinit
‘‘P [
)
‘‘[ \
{
’’ 
if
““ 

(
““ 
!
““ 
allowReinit
““ 
)
““ 
{
”” 	
return
•• 
false
•• 
;
•• 
}
–– 	
return
˜˜ 
failure
˜˜ 
.
˜˜ 
FailureType
˜˜ "
==
˜˜# %'
AuthenticationFailureType
˜˜& ?
.
˜˜? @$
NETWORK_REQUEST_FAILED
˜˜@ V
;
˜˜V W
}
™™ 
private
›› 
static
›› #
AuthenticationFailure
›› ("
MapValidationFailure
››) =
(
››= >
ValidationFailure
››> O

validation
››P Z
)
››Z [
{
œœ 
return
 

validation
 
.
 
FailureType
 %
switch
& ,
{
žž 	#
ValidationFailureType
ŸŸ !
.
ŸŸ! "
SIGN_IN_FAILED
ŸŸ" 0
=>
ŸŸ1 3#
AuthenticationFailure
ŸŸ4 I
.
ŸŸI J 
InvalidCredentials
ŸŸJ \
(
ŸŸ\ ]

validation
ŸŸ] g
.
ŸŸg h
Message
ŸŸh o
)
ŸŸo p
,
ŸŸp q#
ValidationFailureType
   !
.
  ! "$
LOGIN_ATTEMPT_EXCEEDED
  " 8
=>
  9 ;#
AuthenticationFailure
  < Q
.
  Q R"
LoginAttemptExceeded
  R f
(
  f g

validation
  g q
.
¡¡ 
Message
¡¡ 
)
¡¡ 
,
¡¡ 
_
¢¢ 
=>
¢¢ #
AuthenticationFailure
¢¢ &
.
¢¢& '
UnexpectedError
¢¢' 6
(
¢¢6 7

validation
¢¢7 A
.
¢¢A B
Message
¢¢B I
)
¢¢I J
}
££ 	
;
££	 

}
¤¤ 
private
¦¦ 
readonly
¦¦ 
record
¦¦ 
struct
¦¦ " 
OpaqueExchangeData
¦¦# 5
(
¦¦5 6
byte
¦¦6 :
[
¦¦: ;
]
¦¦; <
Ke3Data
¦¦= D
,
¦¦D E&
SodiumSecureMemoryHandle
¦¦F ^
MasterKeyHandle
¦¦_ n
)
¦¦n o
;
¦¦o p
private
¨¨ 
string
¨¨ #
GetOpaqueErrorMessage
¨¨ (
(
¨¨( )
OpaqueResult
¨¨) 5
error
¨¨6 ;
)
¨¨; <
{
©© 
return
ªª !
OpaqueErrorMessages
ªª "
.
ªª" #
TryGetValue
ªª# .
(
ªª. /
error
ªª/ 4
,
ªª4 5
out
ªª6 9
string
ªª: @
?
ªª@ A
key
ªªB E
)
ªªE F
?
«« !
localizationService
«« !
[
««! "
key
««" %
]
««% &
:
¬¬ !
localizationService
¬¬ !
[
¬¬! "%
AuthenticationConstants
¬¬" 9
.
¬¬9 :)
COMMON_UNEXPECTED_ERROR_KEY
¬¬: U
]
¬¬U V
;
¬¬V W
}
­­ 
private
¯¯ 
async
¯¯ 
Task
¯¯ 
<
¯¯ 
Result
¯¯ 
<
¯¯ &
OpaqueSignInInitResponse
¯¯ 6
,
¯¯6 7
NetworkFailure
¯¯8 F
>
¯¯F G
>
¯¯G H"
SendInitRequestAsync
¯¯I ]
(
¯¯] ^%
OpaqueSignInInitRequest
°° 
initRequest
°°  +
,
°°+ ,
uint
±± 
	connectId
±± 
,
±± 
RpcRequestContext
²² 
requestContext
²² (
,
²²( )
CancellationToken
³³ 
cancellationToken
³³ +
)
³³+ ,
{
´´ "
TaskCompletionSource
µµ 
<
µµ &
OpaqueSignInInitResponse
µµ 5
>
µµ5 6&
responseCompletionSource
µµ7 O
=
µµP Q
new
µµR U
(
µµU V
)
µµV W
;
µµW X
Result
·· 
<
·· 
Unit
·· 
,
·· 
NetworkFailure
·· #
>
··# $
networkResult
··% 2
=
··3 4
await
··5 :
networkProvider
··; J
.
··J K&
ExecuteUnaryRequestAsync
··K c
(
··c d
	connectId
¸¸ 
,
¸¸ 
RpcServiceType
¹¹ 
.
¹¹ 
SignInInitRequest
¹¹ ,
,
¹¹, -%
SecureByteStringInterop
ºº #
.
ºº# $"
WithByteStringAsSpan
ºº$ 8
(
ºº8 9
initRequest
ºº9 D
.
ººD E
ToByteString
ººE Q
(
ººQ R
)
ººR S
,
ººS T
span
ººU Y
=>
ººZ \
span
ºº] a
.
ººa b
ToArray
ººb i
(
ººi j
)
ººj k
)
ººk l
,
ººl m!
initResponsePayload
»» 
=>
»»  "
{
¼¼ &
OpaqueSignInInitResponse
½½ (
response
½½) 1
=
½½2 3
Helpers
¾¾ 
.
¾¾ 
ParseFromBytes
¾¾ *
<
¾¾* +&
OpaqueSignInInitResponse
¾¾+ C
>
¾¾C D
(
¾¾D E!
initResponsePayload
¾¾E X
)
¾¾X Y
;
¾¾Y Z&
responseCompletionSource
¿¿ (
.
¿¿( )
TrySetResult
¿¿) 5
(
¿¿5 6
response
¿¿6 >
)
¿¿> ?
;
¿¿? @
return
ÀÀ 
Task
ÀÀ 
.
ÀÀ 

FromResult
ÀÀ &
(
ÀÀ& '
Result
ÀÀ' -
<
ÀÀ- .
Unit
ÀÀ. 2
,
ÀÀ2 3
NetworkFailure
ÀÀ4 B
>
ÀÀB C
.
ÀÀC D
Ok
ÀÀD F
(
ÀÀF G
Unit
ÀÀG K
.
ÀÀK L
Value
ÀÀL Q
)
ÀÀQ R
)
ÀÀR S
;
ÀÀS T
}
ÁÁ 
,
ÁÁ 
false
ÁÁ 
,
ÁÁ 
cancellationToken
ÁÁ '
,
ÁÁ' (
waitForRecovery
ÁÁ) 8
:
ÁÁ8 9
false
ÁÁ: ?
,
ÁÁ? @
requestContext
ÁÁA O
)
ÂÂ 	
.
ÂÂ	 

ConfigureAwait
ÂÂ
 
(
ÂÂ 
false
ÂÂ 
)
ÂÂ 
;
ÂÂ  
if
ÄÄ 

(
ÄÄ 
networkResult
ÄÄ 
.
ÄÄ 
IsErr
ÄÄ 
)
ÄÄ  
{
ÅÅ 	
return
ÆÆ 
Result
ÆÆ 
<
ÆÆ &
OpaqueSignInInitResponse
ÆÆ 2
,
ÆÆ2 3
NetworkFailure
ÆÆ4 B
>
ÆÆB C
.
ÆÆC D
Err
ÆÆD G
(
ÆÆG H
networkResult
ÆÆH U
.
ÆÆU V
	UnwrapErr
ÆÆV _
(
ÆÆ_ `
)
ÆÆ` a
)
ÆÆa b
;
ÆÆb c
}
ÇÇ 	&
OpaqueSignInInitResponse
ÉÉ  
response
ÉÉ! )
=
ÉÉ* +
await
ÉÉ, 1&
responseCompletionSource
ÉÉ2 J
.
ÉÉJ K
Task
ÉÉK O
.
ÉÉO P
ConfigureAwait
ÉÉP ^
(
ÉÉ^ _
false
ÉÉ_ d
)
ÉÉd e
;
ÉÉe f
return
ÊÊ 
Result
ÊÊ 
<
ÊÊ &
OpaqueSignInInitResponse
ÊÊ .
,
ÊÊ. /
NetworkFailure
ÊÊ0 >
>
ÊÊ> ?
.
ÊÊ? @
Ok
ÊÊ@ B
(
ÊÊB C
response
ÊÊC K
)
ÊÊK L
;
ÊÊL M
}
ËË 
private
ÍÍ 
async
ÍÍ 
Task
ÍÍ 
<
ÍÍ 
Result
ÍÍ 
<
ÍÍ 
SignInResult
ÍÍ *
,
ÍÍ* +
NetworkFailure
ÍÍ, :
>
ÍÍ: ;
>
ÍÍ; </
!SendFinalizeRequestAndVerifyAsync
ÍÍ= ^
(
ÍÍ^ _)
OpaqueSignInFinalizeRequest
ÎÎ #
finalizeRequest
ÎÎ$ 3
,
ÎÎ3 4
uint
ÏÏ 
	connectId
ÏÏ 
,
ÏÏ 
RpcRequestContext
ÐÐ 
requestContext
ÐÐ (
,
ÐÐ( )
CancellationToken
ÑÑ 
cancellationToken
ÑÑ +
)
ÑÑ+ ,
{
ÒÒ "
TaskCompletionSource
ÓÓ 
<
ÓÓ *
OpaqueSignInFinalizeResponse
ÓÓ 9
>
ÓÓ9 :&
responseCompletionSource
ÓÓ; S
=
ÓÓT U
new
ÓÓV Y
(
ÓÓY Z
)
ÓÓZ [
;
ÓÓ[ \
Result
ÕÕ 
<
ÕÕ 
Unit
ÕÕ 
,
ÕÕ 
NetworkFailure
ÕÕ #
>
ÕÕ# $
networkResult
ÕÕ% 2
=
ÕÕ3 4
await
ÕÕ5 :
networkProvider
ÕÕ; J
.
ÕÕJ K&
ExecuteUnaryRequestAsync
ÕÕK c
(
ÕÕc d
	connectId
ÖÖ 
,
ÖÖ 
RpcServiceType
×× 
.
×× #
SignInCompleteRequest
×× 0
,
××0 1%
SecureByteStringInterop
ØØ #
.
ØØ# $"
WithByteStringAsSpan
ØØ$ 8
(
ØØ8 9
finalizeRequest
ØØ9 H
.
ØØH I
ToByteString
ØØI U
(
ØØU V
)
ØØV W
,
ØØW X
span
ØØY ]
=>
ØØ^ `
span
ØØa e
.
ØØe f
ToArray
ØØf m
(
ØØm n
)
ØØn o
)
ØØo p
,
ØØp q%
finalizeResponsePayload
ÙÙ #
=>
ÙÙ$ &
{
ÚÚ *
OpaqueSignInFinalizeResponse
ÛÛ ,
response
ÛÛ- 5
=
ÛÛ6 7
Helpers
ÜÜ 
.
ÜÜ 
ParseFromBytes
ÜÜ *
<
ÜÜ* +*
OpaqueSignInFinalizeResponse
ÜÜ+ G
>
ÜÜG H
(
ÜÜH I%
finalizeResponsePayload
ÜÜI `
)
ÜÜ` a
;
ÜÜa b&
responseCompletionSource
ÝÝ (
.
ÝÝ( )
TrySetResult
ÝÝ) 5
(
ÝÝ5 6
response
ÝÝ6 >
)
ÝÝ> ?
;
ÝÝ? @
return
ßß 
Task
ßß 
.
ßß 

FromResult
ßß &
(
ßß& '
Result
ßß' -
<
ßß- .
Unit
ßß. 2
,
ßß2 3
NetworkFailure
ßß4 B
>
ßßB C
.
ßßC D
Ok
ßßD F
(
ßßF G
Unit
ßßG K
.
ßßK L
Value
ßßL Q
)
ßßQ R
)
ßßR S
;
ßßS T
}
àà 
,
àà 
false
àà 
,
àà 
cancellationToken
àà '
,
àà' (
waitForRecovery
àà) 8
:
àà8 9
false
àà: ?
,
àà? @
requestContext
ààA O
)
áá 	
.
áá	 

ConfigureAwait
áá
 
(
áá 
false
áá 
)
áá 
;
áá  
if
ãã 

(
ãã 
networkResult
ãã 
.
ãã 
IsErr
ãã 
)
ãã  
{
ää 	
return
åå 
Result
åå 
<
åå 
SignInResult
åå &
,
åå& '
NetworkFailure
åå( 6
>
åå6 7
.
åå7 8
Err
åå8 ;
(
åå; <
networkResult
åå< I
.
ååI J
	UnwrapErr
ååJ S
(
ååS T
)
ååT U
)
ååU V
;
ååV W
}
ææ 	*
OpaqueSignInFinalizeResponse
èè $
capturedResponse
èè% 5
=
èè6 7
await
èè8 =&
responseCompletionSource
èè> V
.
èèV W
Task
èèW [
.
èè[ \
ConfigureAwait
èè\ j
(
èèj k
false
èèk p
)
èèp q
;
èèq r
if
êê 

(
êê 
capturedResponse
êê 
.
êê 
Result
êê #
==
êê$ &*
OpaqueSignInFinalizeResponse
êê' C
.
êêC D
Types
êêD I
.
êêI J
SignInResult
êêJ V
.
êêV W 
InvalidCredentials
êêW i
)
êêi j
{
ëë 	
string
ìì 
message
ìì 
=
ìì 
capturedResponse
ìì -
.
ìì- .

HasMessage
ìì. 8
?
íí 
capturedResponse
íí "
.
íí" #
Message
íí# *
:
îî !
localizationService
îî %
[
îî% &%
AuthenticationConstants
îî& =
.
îî= >%
INVALID_CREDENTIALS_KEY
îî> U
]
îîU V
;
îîV W
return
ïï 
Result
ïï 
<
ïï 
SignInResult
ïï &
,
ïï& '
NetworkFailure
ïï( 6
>
ïï6 7
.
ïï7 8
Err
ïï8 ;
(
ïï; <
NetworkFailure
ðð 
.
ðð  
InvalidRequestType
ðð 1
(
ðð1 2
message
ðð2 9
)
ðð9 :
)
ðð: ;
;
ðð; <
}
ññ 	
SignInResult
óó 
result
óó 
=
óó 
new
óó !
(
óó! "
Option
ôô 
<
ôô 
Ecliptix
ôô 
.
ôô 
Protobuf
ôô $
.
ôô$ %

Membership
ôô% /
.
ôô/ 0

Membership
ôô0 :
>
ôô: ;
.
ôô; <
From
ôô< @
(
ôô@ A
capturedResponse
ôôA Q
.
ôôQ R

Membership
ôôR \
)
ôô\ ]
,
ôô] ^
Option
õõ 
<
õõ 
Protobuf
õõ 
.
õõ 
Account
õõ #
.
õõ# $
Account
õõ$ +
>
õõ+ ,
.
õõ, -
From
õõ- 1
(
õõ1 2
capturedResponse
õõ2 B
.
õõB C
ActiveAccount
õõC P
)
õõP Q
)
õõQ R
;
õõR S
return
öö 
Result
öö 
<
öö 
SignInResult
öö "
,
öö" #
NetworkFailure
öö$ 2
>
öö2 3
.
öö3 4
Ok
öö4 6
(
öö6 7
result
öö7 =
)
öö= >
;
öö> ?
}
÷÷ 
private
ùù 
Result
ùù 
<
ùù 
byte
ùù 
[
ùù 
]
ùù 
,
ùù #
AuthenticationFailure
ùù 0
>
ùù0 1&
ValidateAndCopySecureKey
ùù2 J
(
ùùJ K
SensitiveBytes
ùùK Y
	secureKey
ùùZ c
)
ùùc d
{
úú 
byte
ûû 
[
ûû 
]
ûû 
?
ûû 
secureKeyCopy
ûû 
=
ûû 
null
ûû  $
;
ûû$ %
Result
ýý 
<
ýý 
Unit
ýý 
,
ýý 
SodiumFailure
ýý "
>
ýý" #

readResult
ýý$ .
=
ýý/ 0
	secureKey
ýý1 :
.
ýý: ;
WithReadAccess
ýý; I
(
ýýI J
span
ýýJ N
=>
ýýO Q
{
þþ 	
secureKeyCopy
ÿÿ 
=
ÿÿ 
span
ÿÿ  
.
ÿÿ  !
ToArray
ÿÿ! (
(
ÿÿ( )
)
ÿÿ) *
;
ÿÿ* +
return
€€ 
Result
€€ 
<
€€ 
Unit
€€ 
,
€€ 
SodiumFailure
€€  -
>
€€- .
.
€€. /
Ok
€€/ 1
(
€€1 2
Unit
€€2 6
.
€€6 7
Value
€€7 <
)
€€< =
;
€€= >
}
 	
)
	 

;

 
if
ƒƒ 

(
ƒƒ 

readResult
ƒƒ 
.
ƒƒ 
IsErr
ƒƒ 
)
ƒƒ 
{
„„ 	
return
…… 
Result
…… 
<
…… 
byte
…… 
[
…… 
]
……  
,
……  !#
AuthenticationFailure
……" 7
>
……7 8
.
……8 9
Err
……9 <
(
……< =#
AuthenticationFailure
†† %
.
††% &
UnexpectedError
††& 5
(
††5 6
$"
††6 8
$str
††8 S
{
††S T

readResult
††T ^
.
††^ _
	UnwrapErr
††_ h
(
††h i
)
††i j
.
††j k
Message
††k r
}
††r s
"
††s t
)
††t u
)
††u v
;
††v w
}
‡‡ 	
if
‰‰ 

(
‰‰ 
secureKeyCopy
‰‰ 
!=
‰‰ 
null
‰‰ !
&&
‰‰" $
secureKeyCopy
‰‰% 2
.
‰‰2 3
Length
‰‰3 9
!=
‰‰: <
$num
‰‰= >
)
‰‰> ?
{
ŠŠ 	
return
‹‹ 
Result
‹‹ 
<
‹‹ 
byte
‹‹ 
[
‹‹ 
]
‹‹  
,
‹‹  !#
AuthenticationFailure
‹‹" 7
>
‹‹7 8
.
‹‹8 9
Ok
‹‹9 ;
(
‹‹; <
secureKeyCopy
‹‹< I
)
‹‹I J
;
‹‹J K
}
ŒŒ 	
string
ŽŽ 
requiredError
ŽŽ 
=
ŽŽ !
localizationService
ŽŽ 2
[
ŽŽ2 3%
AuthenticationConstants
ŽŽ3 J
.
ŽŽJ K%
SECURE_KEY_REQUIRED_KEY
ŽŽK b
]
ŽŽb c
;
ŽŽc d
return
 
Result
 
<
 
byte
 
[
 
]
 
,
 #
AuthenticationFailure
 3
>
3 4
.
4 5
Err
5 8
(
8 9#
AuthenticationFailure
 !
.
! "
SecureKeyRequired
" 3
(
3 4
requiredError
4 A
)
A B
)
B C
;
C D
}
‘‘ 
private
““ 
Result
““ 
<
““ 
byte
““ 
[
““ 
]
““ 
,
““ #
AuthenticationFailure
““ 0
>
““0 1&
PerformOpaqueKe3Exchange
““2 J
(
““J K
OpaqueClient
”” 
opaqueClient
”” !
,
””! "
byte
•• 
[
•• 
]
•• 
ke2Data
•• 
,
•• 
KeyExchangeResult
–– 
	ke1Result
–– #
)
––# $
{
—— 
Result
˜˜ 
<
˜˜ 
byte
˜˜ 
[
˜˜ 
]
˜˜ 
,
˜˜ 
OpaqueResult
˜˜ #
>
˜˜# $
ke3DataResult
˜˜% 2
=
˜˜3 4
opaqueClient
˜˜5 A
.
˜˜A B
GenerateKe3
˜˜B M
(
˜˜M N
ke2Data
˜˜N U
,
˜˜U V
	ke1Result
˜˜W `
)
˜˜` a
;
˜˜a b
if
šš 

(
šš 
!
šš 
ke3DataResult
šš 
.
šš 
IsErr
šš  
)
šš  !
{
›› 	
return
œœ 
Result
œœ 
<
œœ 
byte
œœ 
[
œœ 
]
œœ  
,
œœ  !#
AuthenticationFailure
œœ" 7
>
œœ7 8
.
œœ8 9
Ok
œœ9 ;
(
œœ; <
ke3DataResult
œœ< I
.
œœI J
Unwrap
œœJ P
(
œœP Q
)
œœQ R
)
œœR S
;
œœS T
}
 	
string
ŸŸ 
errorMessage
ŸŸ 
=
ŸŸ #
GetOpaqueErrorMessage
ŸŸ 3
(
ŸŸ3 4
ke3DataResult
ŸŸ4 A
.
ŸŸA B
	UnwrapErr
ŸŸB K
(
ŸŸK L
)
ŸŸL M
)
ŸŸM N
;
ŸŸN O
return
   
Result
   
<
   
byte
   
[
   
]
   
,
   #
AuthenticationFailure
   3
>
  3 4
.
  4 5
Err
  5 8
(
  8 9#
AuthenticationFailure
¡¡ !
.
¡¡! " 
InvalidCredentials
¡¡" 4
(
¡¡4 5
errorMessage
¡¡5 A
)
¡¡A B
)
¡¡B C
;
¡¡C D
}
¢¢ 
private
¤¤ 
static
¤¤ 
Result
¤¤ 
<
¤¤ &
SodiumSecureMemoryHandle
¤¤ 2
,
¤¤2 3#
AuthenticationFailure
¤¤4 I
>
¤¤I J(
ExtractMasterKeyFromOpaque
¤¤K e
(
¤¤e f
OpaqueClient
¥¥ 
opaqueClient
¥¥ !
,
¥¥! "
KeyExchangeResult
¦¦ 
	ke1Result
¦¦ #
)
¦¦# $
{
§§ 
(
¨¨ 	
byte
¨¨	 
[
¨¨ 
]
¨¨ 
sessionKeyBytes
¨¨ 
,
¨¨  
byte
¨¨! %
[
¨¨% &
]
¨¨& '
masterKeyBytes
¨¨( 6
)
¨¨6 7
=
¨¨8 9
opaqueClient
¨¨: F
.
¨¨F G!
DeriveBaseMasterKey
¨¨G Z
(
¨¨Z [
	ke1Result
¨¨[ d
)
¨¨d e
;
¨¨e f
try
ªª 
{
«« 	
Result
¬¬ 
<
¬¬ &
SodiumSecureMemoryHandle
¬¬ +
,
¬¬+ ,
SodiumFailure
¬¬- :
>
¬¬: ;#
masterKeyHandleResult
¬¬< Q
=
¬¬R S&
SodiumSecureMemoryHandle
­­ (
.
­­( )
Allocate
­­) 1
(
­­1 2
masterKeyBytes
­­2 @
.
­­@ A
Length
­­A G
)
­­G H
;
­­H I
if
®® 
(
®® #
masterKeyHandleResult
®® %
.
®®% &
IsErr
®®& +
)
®®+ ,
{
¯¯ 
return
°° 
Result
°° 
<
°° &
SodiumSecureMemoryHandle
°° 6
,
°°6 7#
AuthenticationFailure
°°8 M
>
°°M N
.
°°N O
Err
°°O R
(
°°R S#
AuthenticationFailure
±± )
.
±±) *-
SECURE_MEMORY_ALLOCATION_FAILED
±±* I
(
±±I J#
masterKeyHandleResult
±±J _
.
±±_ `
	UnwrapErr
±±` i
(
±±i j
)
±±j k
.
±±k l
Message
±±l s
)
±±s t
)
±±t u
;
±±u v
}
²² &
SodiumSecureMemoryHandle
´´ $
masterKeyHandle
´´% 4
=
´´5 6#
masterKeyHandleResult
´´7 L
.
´´L M
Unwrap
´´M S
(
´´S T
)
´´T U
;
´´U V
Result
µµ 
<
µµ 
Unit
µµ 
,
µµ 
SodiumFailure
µµ &
>
µµ& '
writeResult
µµ( 3
=
µµ4 5
masterKeyHandle
µµ6 E
.
µµE F
Write
µµF K
(
µµK L
masterKeyBytes
µµL Z
)
µµZ [
;
µµ[ \
if
·· 
(
·· 
!
·· 
writeResult
·· 
.
·· 
IsErr
·· "
)
··" #
{
¸¸ 
return
¹¹ 
Result
¹¹ 
<
¹¹ &
SodiumSecureMemoryHandle
¹¹ 6
,
¹¹6 7#
AuthenticationFailure
¹¹8 M
>
¹¹M N
.
¹¹N O
Ok
¹¹O Q
(
¹¹Q R
masterKeyHandle
¹¹R a
)
¹¹a b
;
¹¹b c
}
ºº 
masterKeyHandle
¼¼ 
.
¼¼ 
Dispose
¼¼ #
(
¼¼# $
)
¼¼$ %
;
¼¼% &
return
½½ 
Result
½½ 
<
½½ &
SodiumSecureMemoryHandle
½½ 2
,
½½2 3#
AuthenticationFailure
½½4 I
>
½½I J
.
½½J K
Err
½½K N
(
½½N O#
AuthenticationFailure
¾¾ %
.
¾¾% &(
SECURE_MEMORY_WRITE_FAILED
¾¾& @
(
¾¾@ A
writeResult
¾¾A L
.
¾¾L M
	UnwrapErr
¾¾M V
(
¾¾V W
)
¾¾W X
.
¾¾X Y
Message
¾¾Y `
)
¾¾` a
)
¾¾a b
;
¾¾b c
}
¿¿ 	
finally
ÀÀ 
{
ÁÁ 	%
CryptographicOperations
ÂÂ #
.
ÂÂ# $

ZeroMemory
ÂÂ$ .
(
ÂÂ. /
sessionKeyBytes
ÂÂ/ >
)
ÂÂ> ?
;
ÂÂ? @%
CryptographicOperations
ÃÃ #
.
ÃÃ# $

ZeroMemory
ÃÃ$ .
(
ÃÃ. /
masterKeyBytes
ÃÃ/ =
)
ÃÃ= >
;
ÃÃ> ?
}
ÄÄ 	
}
ÅÅ 
private
ÇÇ 
async
ÇÇ 
Task
ÇÇ 
<
ÇÇ 
Result
ÇÇ 
<
ÇÇ 
Unit
ÇÇ "
,
ÇÇ" ##
AuthenticationFailure
ÇÇ$ 9
>
ÇÇ9 :
>
ÇÇ: ;0
"RecreateAuthenticatedProtocolAsync
ÇÇ< ^
(
ÇÇ^ _&
SodiumSecureMemoryHandle
ÈÈ  
masterKeyHandle
ÈÈ! 0
,
ÈÈ0 1

ByteString
ÉÉ "
membershipIdentifier
ÉÉ '
,
ÉÉ' (
uint
ÊÊ 
	connectId
ÊÊ 
)
ÊÊ 
{
ËË 
Result
ÌÌ 
<
ÌÌ 
Unit
ÌÌ 
,
ÌÌ 
NetworkFailure
ÌÌ #
>
ÌÌ# $$
recreateProtocolResult
ÌÌ% ;
=
ÌÌ< =
await
ÍÍ 
networkProvider
ÍÍ !
.
ÍÍ! "0
"RecreateProtocolWithMasterKeyAsync
ÍÍ" D
(
ÍÍD E
masterKeyHandle
ÎÎ 
,
ÎÎ  "
membershipIdentifier
ÎÎ! 5
,
ÎÎ5 6
	connectId
ÎÎ7 @
)
ÎÎ@ A
.
ÎÎA B
ConfigureAwait
ÎÎB P
(
ÎÎP Q
false
ÎÎQ V
)
ÎÎV W
;
ÎÎW X
if
ÐÐ 

(
ÐÐ $
recreateProtocolResult
ÐÐ "
.
ÐÐ" #
IsErr
ÐÐ# (
)
ÐÐ( )
{
ÑÑ 	
NetworkFailure
ÒÒ 
networkFailure
ÒÒ )
=
ÒÒ* +$
recreateProtocolResult
ÒÒ, B
.
ÒÒB C
	UnwrapErr
ÒÒC L
(
ÒÒL M
)
ÒÒM N
;
ÒÒN O
if
ÔÔ 
(
ÔÔ 
networkFailure
ÔÔ 
.
ÔÔ 
FailureType
ÔÔ *
==
ÔÔ+ - 
NetworkFailureType
ÔÔ. @
.
ÔÔ@ A-
CRITICAL_AUTHENTICATION_FAILURE
ÔÔA `
)
ÔÔ` a
{
ÕÕ 
return
ÖÖ 
Result
ÖÖ 
<
ÖÖ 
Unit
ÖÖ "
,
ÖÖ" ##
AuthenticationFailure
ÖÖ$ 9
>
ÖÖ9 :
.
ÖÖ: ;
Err
ÖÖ; >
(
ÖÖ> ?#
AuthenticationFailure
×× )
.
××) *)
CriticalAuthenticationError
××* E
(
××E F
$"
ØØ 
$str
ØØ 1
{
ØØ1 2
networkFailure
ØØ2 @
.
ØØ@ A
Message
ØØA H
}
ØØH I
"
ØØI J
)
ØØJ K
)
ØØK L
;
ØØL M
}
ÙÙ 
return
ÛÛ 
Result
ÛÛ 
<
ÛÛ 
Unit
ÛÛ 
,
ÛÛ #
AuthenticationFailure
ÛÛ  5
>
ÛÛ5 6
.
ÛÛ6 7
Err
ÛÛ7 :
(
ÛÛ: ;#
AuthenticationFailure
ÜÜ %
.
ÜÜ% &"
NetworkRequestFailed
ÜÜ& :
(
ÜÜ: ;
$"
ÝÝ 
$str
ÝÝ B
{
ÝÝB C
networkFailure
ÝÝC Q
.
ÝÝQ R
Message
ÝÝR Y
}
ÝÝY Z
"
ÝÝZ [
)
ÝÝ[ \
)
ÝÝ\ ]
;
ÝÝ] ^
}
ÞÞ 	
return
àà 
Result
àà 
<
àà 
Unit
àà 
,
àà #
AuthenticationFailure
àà 1
>
àà1 2
.
àà2 3
Ok
àà3 5
(
àà5 6
Unit
àà6 :
.
àà: ;
Value
àà; @
)
àà@ A
;
ààA B
}
áá 
private
ãã 
Result
ãã 
<
ãã &
SodiumSecureMemoryHandle
ãã +
,
ãã+ ,#
AuthenticationFailure
ãã- B
>
ããB C*
DeriveMasterKeyForMembership
ããD `
(
ãã` a&
SodiumSecureMemoryHandle
ää  
masterKeyHandle
ää! 0
,
ää0 1

ByteString
åå "
membershipIdentifier
åå '
)
åå' (
{
ææ 
if
çç 

(
çç 
!
çç *
ValidateMembershipIdentifier
çç )
(
çç) *"
membershipIdentifier
çç* >
)
çç> ?
)
çç? @
{
èè 	
return
éé 
Result
éé 
<
éé &
SodiumSecureMemoryHandle
éé 2
,
éé2 3#
AuthenticationFailure
éé4 I
>
ééI J
.
ééJ K
Err
ééK N
(
ééN O#
AuthenticationFailure
êê %
.
êê% &)
InvalidMembershipIdentifier
êê& A
(
êêA B!
localizationService
ëë '
[
ëë' (%
AuthenticationConstants
ëë( ?
.
ëë? @%
INVALID_CREDENTIALS_KEY
ëë@ W
]
ëëW X
)
ëëX Y
)
ëëY Z
;
ëëZ [
}
ìì 	
Result
îî 
<
îî 
byte
îî 
[
îî 
]
îî 
,
îî 
SodiumFailure
îî $
>
îî$ %"
masterKeyBytesResult
îî& :
=
îî; <
masterKeyHandle
ïï 
.
ïï 
	ReadBytes
ïï %
(
ïï% &
masterKeyHandle
ïï& 5
.
ïï5 6
Length
ïï6 <
)
ïï< =
;
ïï= >
if
ðð 

(
ðð 
!
ðð "
masterKeyBytesResult
ðð !
.
ðð! "
IsOk
ðð" &
)
ðð& '
{
ññ 	
return
òò 
Result
òò 
<
òò &
SodiumSecureMemoryHandle
òò 2
,
òò2 3#
AuthenticationFailure
òò4 I
>
òòI J
.
òòJ K
Ok
òòK M
(
òòM N
masterKeyHandle
òòN ]
)
òò] ^
;
òò^ _
}
óó 	
byte
õõ 
[
õõ 
]
õõ  
masterKeyBytesTemp
õõ !
=
õõ" #"
masterKeyBytesResult
õõ$ 8
.
õõ8 9
Unwrap
õõ9 ?
(
õõ? @
)
õõ@ A
;
õõA B%
CryptographicOperations
öö 
.
öö  

ZeroMemory
öö  *
(
öö* + 
masterKeyBytesTemp
öö+ =
)
öö= >
;
öö> ?
return
øø 
Result
øø 
<
øø &
SodiumSecureMemoryHandle
øø .
,
øø. /#
AuthenticationFailure
øø0 E
>
øøE F
.
øøF G
Ok
øøG I
(
øøI J
masterKeyHandle
øøJ Y
)
øøY Z
;
øøZ [
}
ùù 
private
ûû 
async
ûû 
Task
ûû 
<
ûû 
Result
ûû 
<
ûû 
Unit
ûû "
,
ûû" ##
AuthenticationFailure
ûû$ 9
>
ûû9 :
>
ûû: ;-
StoreIdentityAndMembershipAsync
ûû< [
(
ûû[ \&
SodiumSecureMemoryHandle
üü  
masterKeyHandle
üü! 0
,
üü0 1
SignInResult
ýý 
signInResult
ýý !
)
ýý! "
{
þþ 
Ecliptix
ÿÿ 
.
ÿÿ 
Protobuf
ÿÿ 
.
ÿÿ 

Membership
ÿÿ $
.
ÿÿ$ %

Membership
ÿÿ% /

membership
ÿÿ0 :
=
ÿÿ; <
signInResult
ÿÿ= I
.
ÿÿI J

Membership
ÿÿJ T
.
ÿÿT U
Value
ÿÿU Z
!
ÿÿZ [
;
ÿÿ[ \

ByteString
€€ "
membershipIdentifier
€€ '
=
€€( )

membership
€€* 4
.
€€4 5
UniqueIdentifier
€€5 E
;
€€E F
Guid
 
membershipId
 
=
 
Helpers
 #
.
# $"
FromByteStringToGuid
$ 8
(
8 9"
membershipIdentifier
9 M
)
M N
;
N O
Result
ƒƒ 
<
ƒƒ 
Unit
ƒƒ 
,
ƒƒ #
AuthenticationFailure
ƒƒ *
>
ƒƒ* +
storeResult
ƒƒ, 7
=
ƒƒ8 9
await
ƒƒ: ?
identityService
ƒƒ@ O
.
„„  
StoreIdentityAsync
„„ 
(
„„  
masterKeyHandle
„„  /
,
„„/ 0
membershipId
„„1 =
.
„„= >
ToString
„„> F
(
„„F G
)
„„G H
)
„„H I
.
„„I J
ConfigureAwait
„„J X
(
„„X Y
false
„„Y ^
)
„„^ _
;
„„_ `
if
†† 

(
†† 
storeResult
†† 
.
†† 
IsErr
†† 
)
†† 
{
‡‡ 	
return
ˆˆ 
Result
ˆˆ 
<
ˆˆ 
Unit
ˆˆ 
,
ˆˆ #
AuthenticationFailure
ˆˆ  5
>
ˆˆ5 6
.
ˆˆ6 7
Err
ˆˆ7 :
(
ˆˆ: ;
storeResult
ˆˆ; F
.
ˆˆF G
	UnwrapErr
ˆˆG P
(
ˆˆP Q
)
ˆˆQ R
)
ˆˆR S
;
ˆˆS T
}
‰‰ 	
await
‹‹ .
 applicationSecureStorageProvider
‹‹ .
.
ŒŒ +
SetApplicationMembershipAsync
ŒŒ *
(
ŒŒ* +

membership
ŒŒ+ 5
)
ŒŒ5 6
.
 
ConfigureAwait
 
(
 
false
 !
)
! "
;
" #

ByteString
 
?
 
accountIdToStore
 $
=
% &
signInResult
' 3
.
3 4
ActiveAccount
4 A
.
A B
Match
B G
(
G H
account
 
=>
 
account
 
.
 
UniqueIdentifier
 /
??
0 2
null
3 7
,
7 8
(
‘‘ 
)
‘‘ 
=>
‘‘ 
null
‘‘ 
)
‘‘ 
;
‘‘ 
if
““ 

(
““ 
accountIdToStore
““ 
==
““ 
null
““  $
&&
““% '

membership
““( 2
.
““2 3%
AccountUniqueIdentifier
““3 J
!=
““K M
null
““N R
&&
““S U

membership
”” 
.
”” %
AccountUniqueIdentifier
”” .
.
””. /
Length
””/ 5
>
””6 7
$num
””8 9
)
””9 :
{
•• 	
accountIdToStore
–– 
=
–– 

membership
–– )
.
––) *%
AccountUniqueIdentifier
––* A
;
––A B
}
—— 	
if
™™ 

(
™™ 
accountIdToStore
™™ 
==
™™ 
null
™™  $
)
™™$ %
{
šš 	
return
›› 
Result
›› 
<
›› 
Unit
›› 
,
›› #
AuthenticationFailure
››  5
>
››5 6
.
››6 7
Ok
››7 9
(
››9 :
Unit
››: >
.
››> ?
Value
››? D
)
››D E
;
››E F
}
œœ 	
await
žž .
 applicationSecureStorageProvider
žž .
.
ŸŸ &
SetCurrentAccountIdAsync
ŸŸ %
(
ŸŸ% &
accountIdToStore
ŸŸ& 6
)
ŸŸ6 7
.
   
ConfigureAwait
   
(
   
false
   !
)
  ! "
;
  " #
return
¢¢ 
Result
¢¢ 
<
¢¢ 
Unit
¢¢ 
,
¢¢ #
AuthenticationFailure
¢¢ 1
>
¢¢1 2
.
¢¢2 3
Ok
¢¢3 5
(
¢¢5 6
Unit
¢¢6 :
.
¢¢: ;
Value
¢¢; @
)
¢¢@ A
;
¢¢A B
}
££ 
private
¥¥ 
static
¥¥ 
void
¥¥ 
SecureCleanup
¥¥ %
(
¥¥% &
params
¥¥& ,
byte
¥¥- 1
[
¥¥1 2
]
¥¥2 3
?
¥¥3 4
[
¥¥4 5
]
¥¥5 6
buffers
¥¥7 >
)
¥¥> ?
{
¦¦ 
foreach
§§ 
(
§§ 
byte
§§ 
[
§§ 
]
§§ 
?
§§ 
buffer
§§ 
in
§§  "
buffers
§§# *
)
§§* +
{
¨¨ 	
if
©© 
(
©© 
buffer
©© 
is
©© 
{
©© 
Length
©© "
:
©©" #
>
©©$ %
$num
©©& '
}
©©( )
)
©©) *
{
ªª %
CryptographicOperations
«« '
.
««' (

ZeroMemory
««( 2
(
««2 3
buffer
««3 9
)
««9 :
;
««: ;
}
¬¬ 
}
­­ 	
}
®® 
private
°° 
static
°° #
AuthenticationFailure
°° (
MapNetworkFailure
°°) :
(
°°: ;
NetworkFailure
°°; I
failure
°°J Q
)
°°Q R
{
±± 
string
²² 
message
²² 
=
²² 
failure
²²  
.
²²  !
	UserError
²²! *
?
²²* +
.
²²+ ,
Message
²², 3
??
²²4 6
failure
²²7 >
.
²²> ?
Message
²²? F
;
²²F G
return
´´ 
failure
´´ 
.
´´ 
FailureType
´´ "
switch
´´# )
{
µµ 	 
NetworkFailureType
¶¶ 
.
¶¶ -
CRITICAL_AUTHENTICATION_FAILURE
¶¶ >
=>
¶¶? A#
AuthenticationFailure
·· %
.
··% &)
CriticalAuthenticationError
··& A
(
··A B
message
··B I
)
··I J
,
··J K 
NetworkFailureType
¸¸ 
.
¸¸ "
INVALID_REQUEST_TYPE
¸¸ 3
when
¸¸4 8(
IsInvalidCredentialFailure
¸¸9 S
(
¸¸S T
failure
¸¸T [
)
¸¸[ \
=>
¸¸] _#
AuthenticationFailure
¹¹ %
.
¹¹% & 
InvalidCredentials
¹¹& 8
(
¹¹8 9
message
¹¹9 @
)
¹¹@ A
,
¹¹A B
_
ºº 
=>
ºº #
AuthenticationFailure
ºº &
.
ºº& '"
NetworkRequestFailed
ºº' ;
(
ºº; <
message
ºº< C
)
ººC D
}
»» 	
;
»»	 

}
¼¼ 
}½½ ž$
“/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/Internal/RegistrationStateManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
./ 0
Internal0 8
;8 9
internal		 
sealed			 
class		 $
RegistrationStateManager		 .
:		/ 0
IDisposable		1 <
{

 
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
RegistrationResult2 D
>D E
_registrationStatesF Y
=Z [
new\ _
(_ `
)` a
;a b
private 
bool 
_isDisposed 
; 
public 

bool 
TryAddRegistration "
(" #

ByteString# - 
membershipIdentifier. B
,B C
RegistrationResultD V
registrationResultW i
)i j
{ 
if 

( 
_isDisposed 
) 
{ 	
return 
false 
; 
} 	
string 
key 
= 
	CreateKey 
(  
membershipIdentifier 3
)3 4
;4 5
return 
_registrationStates "
." #
TryAdd# )
() *
key* -
,- .
registrationResult/ A
)A B
;B C
} 
public 

bool !
TryRemoveRegistration %
(% &

ByteString& 0 
membershipIdentifier1 E
,E F
outG J
RegistrationResultK ]
?] ^
registrationResult_ q
)q r
{ 
string 
key 
= 
	CreateKey 
(  
membershipIdentifier 3
)3 4
;4 5
return 
_registrationStates "
." #
	TryRemove# ,
(, -
key- 0
,0 1
out2 5
registrationResult6 H
)H I
;I J
} 
public 

void 
CleanupRegistration #
(# $

ByteString$ . 
membershipIdentifier/ C
)C D
{   
if!! 

(!! !
TryRemoveRegistration!! !
(!!! " 
membershipIdentifier!!" 6
,!!6 7
out!!8 ;
RegistrationResult!!< N
?!!N O
result!!P V
)!!V W
)!!W X
{"" 	
result## 
?## 
.## 
Dispose## 
(## 
)## 
;## 
}$$ 	
}%% 
public'' 

void'' 
Dispose'' 
('' 
)'' 
{(( 
if)) 

()) 
_isDisposed)) 
))) 
{** 	
return++ 
;++ 
},, 	
_isDisposed.. 
=.. 
true.. 
;.. 
foreach00 
(00 
System00 
.00 
Collections00 #
.00# $
Generic00$ +
.00+ ,
KeyValuePair00, 8
<008 9
string009 ?
,00? @
RegistrationResult00A S
>00S T
kvp00U X
in00Y [
_registrationStates00\ o
)00o p
{11 	
try22 
{33 
kvp44 
.44 
Value44 
.44 
Dispose44 !
(44! "
)44" #
;44# $
}55 
catch66 
(66 
	Exception66 
ex66 
)66  
{77 
Serilog88 
.88 
Log88 
.88 
Warning88 #
(88# $
ex88$ &
,88& '
$str88( r
,88r s
kvp88t w
.88w x
Key88x {
)88{ |
;88| }
}99 
}:: 	
_registrationStates<< 
.<< 
Clear<< !
(<<! "
)<<" #
;<<# $
}== 
private?? 
static?? 
string?? 
	CreateKey?? #
(??# $

ByteString??$ . 
membershipIdentifier??/ C
)??C D
=>??E G
Convert@@ 
.@@ 
ToBase64String@@ 
(@@  
membershipIdentifier@@ 3
.@@3 4
Span@@4 8
)@@8 9
;@@9 :
}AA ¹Í
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/IdentityService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
;/ 0
internal 
sealed	 
class 
IdentityService %
:& '
IIdentityService( 8
{ 
private 
readonly '
ISecureProtocolStateStorage 0
_storage1 9
;9 :
private 
readonly %
IPlatformSecurityProvider .
_platformProvider/ @
;@ A
private 
readonly 
Lazy 
< 
bool 
> &
_hardwareSecurityAvailable  :
;: ;
private 
readonly -
!IApplicationSecureStorageProvider 6-
!_applicationSecureStorageProvider7 X
;X Y
private 
readonly 
NetworkProvider $
_networkProvider% 5
;5 6
public 

IdentityService 
( '
ISecureProtocolStateStorage #
storage$ +
,+ ,%
IPlatformSecurityProvider !
platformProvider" 2
,2 3-
!IApplicationSecureStorageProvider ),
 applicationSecureStorageProvider* J
,J K
NetworkProvider 
networkProvider '
)' (
{ 
_storage   
=   
storage   
;   
_platformProvider!! 
=!! 
platformProvider!! ,
;!!, --
!_applicationSecureStorageProvider"" )
=""* +,
 applicationSecureStorageProvider"", L
;""L M
_networkProvider## 
=## 
networkProvider## *
;##* +&
_hardwareSecurityAvailable$$ "
=$$# $
new$$% (
Lazy$$) -
<$$- .
bool$$. 2
>$$2 3
($$3 4
($$4 5
)$$5 6
=>$$7 9
_platformProvider$$: K
.$$K L'
IsHardwareSecurityAvailable$$L g
($$g h
)$$h i
)$$i j
;$$j k
}%% 
public'' 

async'' 
Task'' 
<'' 
bool'' 
>'' "
HasStoredIdentityAsync'' 2
(''2 3
string''3 9
membershipId'': F
)''F G
{(( 
IdentityContext)) 
context)) 
=))  !
new))" %
())% &
membershipId))& 2
)))2 3
;))3 4
Result++ 
<++ 
byte++ 
[++ 
]++ 
,++  
SecureStorageFailure++ +
>+++ ,
result++- 3
=++4 5
await,, 
_storage,, 
.,, 
LoadStateAsync,, )
(,,) *
context,,* 1
.,,1 2

StorageKey,,2 <
,,,< =
context,,> E
.,,E F
MembershipBytes,,F U
),,U V
.,,V W
ConfigureAwait,,W e
(,,e f
false,,f k
),,k l
;,,l m
bool-- 
exists-- 
=-- 
result-- 
.-- 
IsOk-- !
;--! "
return// 
exists// 
;// 
}00 
public22 

async22 
Task22 
<22 
Result22 
<22 
Unit22 !
,22! "!
AuthenticationFailure22# 8
>228 9
>229 :
StoreIdentityAsync22; M
(22M N$
SodiumSecureMemoryHandle22N f
masterKeyHandle22g v
,22v w
string22x ~
membershipId	22 ‹
)
22‹ Œ
{33 
IdentityContext44 
context44 
=44  !
new44" %
(44% &
membershipId44& 2
)442 3
;443 4
try66 
{77 	
Result88 
<88 
byte88 
[88 
]88 
,88 
SodiumFailure88 (
>88( )

readResult88* 4
=885 6
masterKeyHandle887 F
.88F G
	ReadBytes88G P
(88P Q
masterKeyHandle88Q `
.88` a
Length88a g
)88g h
;88h i
if99 
(99 

readResult99 
.99 
IsErr99  
)99  !
{:: 
return;; 
Result;; 
<;; 
Unit;; "
,;;" #!
AuthenticationFailure;;$ 9
>;;9 :
.;;: ;
Err;;; >
(;;> ?!
AuthenticationFailure<< )
.<<) *!
IdentityStorageFailed<<* ?
(<<? @
$"<<@ B
$str<<B i
{<<i j

readResult<<j t
.<<t u
	UnwrapErr<<u ~
(<<~ 
)	<< €
.
<<€ 
Message
<< ˆ
}
<<ˆ ‰
"
<<‰ Š
)
<<Š ‹
)
<<‹ Œ
;
<<Œ 
}== 
byte?? 
[?? 
]?? "
originalMasterKeyBytes?? )
=??* +

readResult??, 6
.??6 7
Unwrap??7 =
(??= >
)??> ?
;??? @
awaitAA &
StoreIdentityInternalAsyncAA ,
(AA, -
masterKeyHandleAA- <
,AA< =
contextAA> E
)AAE F
.AAF G
ConfigureAwaitAAG U
(AAU V
falseAAV [
)AA[ \
;AA\ ]
ResultCC 
<CC $
SodiumSecureMemoryHandleCC +
,CC+ ,!
AuthenticationFailureCC- B
>CCB C

loadResultCCD N
=CCO P
awaitCCQ V
LoadMasterKeyAsyncCCW i
(CCi j
contextCCj q
)CCq r
.CCr s
ConfigureAwait	CCs 
(
CC ‚
false
CC‚ ‡
)
CC‡ ˆ
;
CCˆ ‰
ifEE 
(EE 

loadResultEE 
.EE 
IsErrEE  
)EE  !
{FF 
returnGG 
ResultGG 
<GG 
UnitGG "
,GG" #!
AuthenticationFailureGG$ 9
>GG9 :
.GG: ;
ErrGG; >
(GG> ?!
AuthenticationFailureHH )
.HH) *!
IdentityStorageFailedHH* ?
(HH? @
$"HH@ B
$strHHB z
{HHz {

loadResult	HH{ …
.
HH… †
	UnwrapErr
HH† 
(
HH 
)
HH ‘
.
HH‘ ’
Message
HH’ ™
}
HH™ š
"
HHš ›
)
HH› œ
)
HHœ 
;
HH ž
}II 
usingKK $
SodiumSecureMemoryHandleKK *
loadedKeyHandleKK+ :
=KK; <

loadResultKK= G
.KKG H
UnwrapKKH N
(KKN O
)KKO P
;KKP Q
ResultLL 
<LL 
byteLL 
[LL 
]LL 
,LL 
SodiumFailureLL (
>LL( )
loadedReadResultLL* :
=LL; <
loadedKeyHandleLL= L
.LLL M
	ReadBytesLLM V
(LLV W
loadedKeyHandleLLW f
.LLf g
LengthLLg m
)LLm n
;LLn o
ifNN 
(NN 
loadedReadResultNN  
.NN  !
IsErrNN! &
)NN& '
{OO 
returnPP 
ResultPP 
<PP 
UnitPP "
,PP" #!
AuthenticationFailurePP$ 9
>PP9 :
.PP: ;
ErrPP; >
(PP> ?!
AuthenticationFailureQQ )
.QQ) *!
IdentityStorageFailedQQ* ?
(QQ? @
$"QQ@ B
$strQQB z
{QQz {
loadedReadResult	QQ{ ‹
.
QQ‹ Œ
	UnwrapErr
QQŒ •
(
QQ• –
)
QQ– —
.
QQ— ˜
Message
QQ˜ Ÿ
}
QQŸ  
"
QQ  ¡
)
QQ¡ ¢
)
QQ¢ £
;
QQ£ ¤
}RR 
byteTT 
[TT 
]TT  
loadedMasterKeyBytesTT '
=TT( )
loadedReadResultTT* :
.TT: ;
UnwrapTT; A
(TTA B
)TTB C
;TTC D
ifVV 
(VV 
!VV #
CryptographicOperationsVV (
.VV( )
FixedTimeEqualsVV) 8
(VV8 9"
originalMasterKeyBytesVV9 O
,VVO P 
loadedMasterKeyBytesVVQ e
)VVe f
)VVf g
{WW #
CryptographicOperationsXX '
.XX' (

ZeroMemoryXX( 2
(XX2 3 
loadedMasterKeyBytesXX3 G
)XXG H
;XXH I
returnYY 
ResultYY 
<YY 
UnitYY "
,YY" #!
AuthenticationFailureYY$ 9
>YY9 :
.YY: ;
ErrYY; >
(YY> ?!
AuthenticationFailureZZ )
.ZZ) *!
IdentityStorageFailedZZ* ?
(ZZ? @
$strZZ@ `
)ZZ` a
)ZZa b
;ZZb c
}[[ #
CryptographicOperations]] #
.]]# $

ZeroMemory]]$ .
(]]. / 
loadedMasterKeyBytes]]/ C
)]]C D
;]]D E
return^^ 
Result^^ 
<^^ 
Unit^^ 
,^^ !
AuthenticationFailure^^  5
>^^5 6
.^^6 7
Ok^^7 9
(^^9 :
Unit^^: >
.^^> ?
Value^^? D
)^^D E
;^^E F
}__ 	
catch`` 
(`` 
	Exception`` 
ex`` 
)`` 
{aa 	
returnbb 
Resultbb 
<bb 
Unitbb 
,bb !
AuthenticationFailurebb  5
>bb5 6
.bb6 7
Errbb7 :
(bb: ;!
AuthenticationFailurecc %
.cc% &!
IdentityStorageFailedcc& ;
(cc; <
$"cc< >
$strcc> a
{cca b
exccb d
.ccd e
Messagecce l
}ccl m
"ccm n
,ccn o
exccp r
)ccr s
)ccs t
;cct u
}dd 	
}ee 
publicgg 

asyncgg 
Taskgg 
<gg 
Resultgg 
<gg $
SodiumSecureMemoryHandlegg 5
,gg5 6!
AuthenticationFailuregg7 L
>ggL M
>ggM N$
LoadMasterKeyHandleAsyncggO g
(ggg h
stringggh n
membershipIdggo {
)gg{ |
=>gg} 
await
gg€ … 
LoadMasterKeyAsync
gg† ˜
(
gg˜ ™
new
gg™ œ
IdentityContext
gg ¬
(
gg¬ ­
membershipId
gg­ ¹
)
gg¹ º
)
ggº »
.
gg» ¼
ConfigureAwait
gg¼ Ê
(
ggÊ Ë
false
ggË Ð
)
ggÐ Ñ
;
ggÑ Ò
publicii 

asyncii 
Taskii 
<ii 
Resultii 
<ii 
Unitii !
,ii! "!
AuthenticationFailureii# 8
>ii8 9
>ii9 :
ClearAllCacheAsyncii; M
(iiM N
stringiiN T
membershipIdiiU a
)iia b
{jj 
IdentityContextkk 
contextkk 
=kk  !
newkk" %
(kk% &
membershipIdkk& 2
)kk2 3
;kk3 4
trymm 
{nn 	
Resultoo 
<oo 
Unitoo 
,oo  
SecureStorageFailureoo -
>oo- .
deleteStorageResultoo/ B
=ooC D
awaitpp 
_storagepp 
.pp 
DeleteStateAsyncpp /
(pp/ 0
contextpp0 7
.pp7 8

StorageKeypp8 B
)ppB C
.ppC D
ConfigureAwaitppD R
(ppR S
falseppS X
)ppX Y
;ppY Z
ifrr 
(rr 
deleteStorageResultrr #
.rr# $
IsErrrr$ )
)rr) *
{ss 
returntt 
Resulttt 
<tt 
Unittt "
,tt" #!
AuthenticationFailurett$ 9
>tt9 :
.tt: ;
Errtt; >
(tt> ?!
AuthenticationFailureuu )
.uu) *!
IdentityStorageFaileduu* ?
(uu? @
$"uu@ B
$struuB l
{uul m 
deleteStorageResult	uum €
.
uu€ 
	UnwrapErr
uu Š
(
uuŠ ‹
)
uu‹ Œ
.
uuŒ 
Message
uu ”
}
uu” •
"
uu• –
)
uu– —
)
uu— ˜
;
uu˜ ™
}vv 
ifxx 
(xx '
IsHardwareSecurityAvailablexx +
(xx+ ,
)xx, -
)xx- .
{yy 
awaitzz 
_platformProviderzz '
.zz' (&
DeleteKeyFromKeychainAsynczz( B
(zzB C
contextzzC J
.zzJ K
KeychainKeyzzK V
)zzV W
.zzW X
ConfigureAwaitzzX f
(zzf g
falsezzg l
)zzl m
;zzm n
}{{ 
return}} 
Result}} 
<}} 
Unit}} 
,}} !
AuthenticationFailure}}  5
>}}5 6
.}}6 7
Ok}}7 9
(}}9 :
Unit}}: >
.}}> ?
Value}}? D
)}}D E
;}}E F
}~~ 	
catch 
( 
	Exception 
ex 
) 
{
€€ 	
return
 
Result
 
<
 
Unit
 
,
 #
AuthenticationFailure
  5
>
5 6
.
6 7
Err
7 :
(
: ;#
AuthenticationFailure
‚‚ %
.
‚‚% &#
IdentityStorageFailed
‚‚& ;
(
‚‚; <
$"
‚‚< >
$str
‚‚> ^
{
‚‚^ _
ex
‚‚_ a
.
‚‚a b
Message
‚‚b i
}
‚‚i j
"
‚‚j k
,
‚‚k l
ex
‚‚m o
)
‚‚o p
)
‚‚p q
;
‚‚q r
}
ƒƒ 	
}
„„ 
public
†† 

async
†† 
Task
†† 
<
†† 
Result
†† 
<
†† 
Unit
†† !
,
††! "
	Exception
††# ,
>
††, -
>
††- .1
#CleanupMembershipStateWithKeysAsync
††/ R
(
††R S
string
††S Y
membershipId
††Z f
,
††f g
uint
††h l
	connectId
††m v
)
††v w
{
‡‡ 
Result
ˆˆ 
<
ˆˆ 
Unit
ˆˆ 
,
ˆˆ "
SecureStorageFailure
ˆˆ )
>
ˆˆ) *
deleteResult
ˆˆ+ 7
=
ˆˆ8 9
await
‰‰ 
_storage
‰‰ 
.
‰‰ 
DeleteStateAsync
‰‰ +
(
‰‰+ ,
	connectId
‰‰, 5
.
‰‰5 6
ToString
‰‰6 >
(
‰‰> ?
)
‰‰? @
)
‰‰@ A
.
‰‰A B
ConfigureAwait
‰‰B P
(
‰‰P Q
false
‰‰Q V
)
‰‰V W
;
‰‰W X
if
‹‹ 

(
‹‹ 
deleteResult
‹‹ 
.
‹‹ 
IsErr
‹‹ 
)
‹‹ 
{
ŒŒ 	
Log
 
.
 
Warning
 
(
 
$str …
,… †
	connectId
ŽŽ 
,
ŽŽ 
deleteResult
ŽŽ '
.
ŽŽ' (
	UnwrapErr
ŽŽ( 1
(
ŽŽ1 2
)
ŽŽ2 3
.
ŽŽ3 4
Message
ŽŽ4 ;
)
ŽŽ; <
;
ŽŽ< =
}
 	
Result
‘‘ 
<
‘‘ 
Unit
‘‘ 
,
‘‘ #
AuthenticationFailure
‘‘ *
>
‘‘* +
clearResult
‘‘, 7
=
‘‘8 9
await
’’  
ClearAllCacheAsync
’’ $
(
’’$ %
membershipId
’’% 1
)
’’1 2
.
’’2 3
ConfigureAwait
’’3 A
(
’’A B
false
’’B G
)
’’G H
;
’’H I
if
”” 

(
”” 
clearResult
”” 
.
”” 
IsErr
”” 
)
”” 
{
•• 	
Log
–– 
.
–– 
Warning
–– 
(
–– 
$str
–– S
,
––S T
clearResult
—— 
.
—— 
	UnwrapErr
—— %
(
——% &
)
——& '
.
——' (
Message
——( /
)
——/ 0
;
——0 1
}
˜˜ 	
Result
šš 
<
šš 
Unit
šš 
,
šš '
InternalServiceApiFailure
šš .
>
šš. /#
membershipClearResult
šš0 E
=
ššF G
await
›› /
!_applicationSecureStorageProvider
›› 3
.
››3 4+
SetApplicationMembershipAsync
››4 Q
(
››Q R
null
››R V
)
››V W
.
››W X
ConfigureAwait
››X f
(
››f g
false
››g l
)
››l m
;
››m n
if
œœ 

(
œœ #
membershipClearResult
œœ !
.
œœ! "
IsErr
œœ" '
)
œœ' (
{
 	
Log
žž 
.
žž 
Warning
žž 
(
žž 
$str
žž X
,
žžX Y#
membershipClearResult
ŸŸ %
.
ŸŸ% &
	UnwrapErr
ŸŸ& /
(
ŸŸ/ 0
)
ŸŸ0 1
.
ŸŸ1 2
Message
ŸŸ2 9
)
ŸŸ9 :
;
ŸŸ: ;
}
   	
_networkProvider
¢¢ 
.
¢¢ 
ClearConnection
¢¢ (
(
¢¢( )
	connectId
¢¢) 2
)
¢¢2 3
;
¢¢3 4
return
¤¤ 
Result
¤¤ 
<
¤¤ 
Unit
¤¤ 
,
¤¤ 
	Exception
¤¤ %
>
¤¤% &
.
¤¤& '
Ok
¤¤' )
(
¤¤) *
Unit
¤¤* .
.
¤¤. /
Value
¤¤/ 4
)
¤¤4 5
;
¤¤5 6
}
¥¥ 
private
§§ 
async
§§ 
Task
§§ (
StoreIdentityInternalAsync
§§ 1
(
§§1 2&
SodiumSecureMemoryHandle
§§2 J
masterKeyHandle
§§K Z
,
§§Z [
IdentityContext
§§\ k
context
§§l s
)
§§s t
{
¨¨ 
byte
©© 
[
©© 
]
©© 
?
©© 
wrappingKey
©© 
=
©© 
null
©© "
;
©©" #
string
ªª 

storageKey
ªª 
=
ªª 
context
ªª #
.
ªª# $

StorageKey
ªª$ .
;
ªª. /
bool
«« 
hardwareAvailable
«« 
=
««  )
IsHardwareSecurityAvailable
««! <
(
««< =
)
««= >
;
««> ?
try
­­ 
{
®® 	
(
¯¯ 
byte
¯¯ 
[
¯¯ 
]
¯¯ 
protectedKey
¯¯  
,
¯¯  !
byte
¯¯" &
[
¯¯& '
]
¯¯' (
?
¯¯( )!
returnedWrappingKey
¯¯* =
)
¯¯= >
=
¯¯? @
await
¯¯A F 
WrapMasterKeyAsync
¯¯G Y
(
¯¯Y Z
masterKeyHandle
¯¯Z i
)
¯¯i j
.
¯¯j k
ConfigureAwait
¯¯k y
(
¯¯y z
false
¯¯z 
)¯¯ €
;¯¯€ 
wrappingKey
°° 
=
°° !
returnedWrappingKey
°° -
;
°°- .
Result
±± 
<
±± 
Unit
±± 
,
±± "
SecureStorageFailure
±± -
>
±±- .

saveResult
±±/ 9
=
±±: ;
await
²² 
_storage
²² 
.
²² 
SaveStateAsync
²² -
(
²²- .
protectedKey
²². :
,
²²: ;

storageKey
²²< F
,
²²F G
context
²²H O
.
²²O P
MembershipBytes
²²P _
)
²²_ `
.
²²` a
ConfigureAwait
²²a o
(
²²o p
false
²²p u
)
²²u v
;
²²v w
if
´´ 
(
´´ 

saveResult
´´ 
.
´´ 
IsErr
´´  
)
´´  !
{
µµ 
throw
¶¶ 
new
¶¶ '
InvalidOperationException
¶¶ 3
(
¶¶3 4
$"
¶¶4 6
$str
¶¶6 \
{
¶¶\ ]

saveResult
¶¶] g
.
¶¶g h
	UnwrapErr
¶¶h q
(
¶¶q r
)
¶¶r s
.
¶¶s t
Message
¶¶t {
}
¶¶{ |
"
¶¶| }
)
¶¶} ~
;
¶¶~ 
}
·· 
if
¹¹ 
(
¹¹ 
hardwareAvailable
¹¹ !
&&
¹¹" $
wrappingKey
¹¹% 0
!=
¹¹1 3
null
¹¹4 8
)
¹¹8 9
{
ºº 
string
»» 
keychainKey
»» "
=
»»# $
context
»»% ,
.
»», -
KeychainKey
»»- 8
;
»»8 9
await
¼¼ 
_platformProvider
¼¼ '
.
¼¼' (%
StoreKeyInKeychainAsync
¼¼( ?
(
¼¼? @
keychainKey
¼¼@ K
,
¼¼K L
wrappingKey
¼¼M X
)
¼¼X Y
.
¼¼Y Z
ConfigureAwait
¼¼Z h
(
¼¼h i
false
¼¼i n
)
¼¼n o
;
¼¼o p
}
½½ 
}
¾¾ 	
finally
¿¿ 
{
ÀÀ 	
if
ÁÁ 
(
ÁÁ 
wrappingKey
ÁÁ 
!=
ÁÁ 
null
ÁÁ #
)
ÁÁ# $
{
ÂÂ %
CryptographicOperations
ÃÃ '
.
ÃÃ' (

ZeroMemory
ÃÃ( 2
(
ÃÃ2 3
wrappingKey
ÃÃ3 >
)
ÃÃ> ?
;
ÃÃ? @
}
ÄÄ 
}
ÅÅ 	
}
ÆÆ 
private
ÈÈ 
async
ÈÈ 
Task
ÈÈ 
<
ÈÈ 
Result
ÈÈ 
<
ÈÈ &
SodiumSecureMemoryHandle
ÈÈ 6
,
ÈÈ6 7#
AuthenticationFailure
ÈÈ8 M
>
ÈÈM N
>
ÈÈN O 
LoadMasterKeyAsync
ÈÈP b
(
ÈÈb c
IdentityContext
ÈÈc r
context
ÈÈs z
)
ÈÈz {
{
ÉÉ 
string
ÊÊ 

storageKey
ÊÊ 
=
ÊÊ 
context
ÊÊ #
.
ÊÊ# $

StorageKey
ÊÊ$ .
;
ÊÊ. /
try
ÌÌ 
{
ÍÍ 	
Result
ÎÎ 
<
ÎÎ 
byte
ÎÎ 
[
ÎÎ 
]
ÎÎ 
,
ÎÎ "
SecureStorageFailure
ÎÎ /
>
ÎÎ/ 0
result
ÎÎ1 7
=
ÎÎ8 9
await
ÏÏ 
_storage
ÏÏ 
.
ÏÏ 
LoadStateAsync
ÏÏ -
(
ÏÏ- .

storageKey
ÏÏ. 8
,
ÏÏ8 9
context
ÏÏ: A
.
ÏÏA B
MembershipBytes
ÏÏB Q
)
ÏÏQ R
.
ÏÏR S
ConfigureAwait
ÏÏS a
(
ÏÏa b
false
ÏÏb g
)
ÏÏg h
;
ÏÏh i
if
ÑÑ 
(
ÑÑ 
result
ÑÑ 
.
ÑÑ 
IsErr
ÑÑ 
)
ÑÑ 
{
ÒÒ 
return
ÓÓ 
Result
ÓÓ 
<
ÓÓ &
SodiumSecureMemoryHandle
ÓÓ 6
,
ÓÓ6 7#
AuthenticationFailure
ÓÓ8 M
>
ÓÓM N
.
ÓÓN O
Err
ÓÓO R
(
ÓÓR S#
AuthenticationFailure
ÔÔ )
.
ÔÔ) *#
IdentityStorageFailed
ÔÔ* ?
(
ÔÔ? @
$"
ÔÔ@ B
$str
ÔÔB `
{
ÔÔ` a
result
ÔÔa g
.
ÔÔg h
	UnwrapErr
ÔÔh q
(
ÔÔq r
)
ÔÔr s
.
ÔÔs t
Message
ÔÔt {
}
ÔÔ{ |
"
ÔÔ| }
)
ÔÔ} ~
)
ÔÔ~ 
;ÔÔ €
}
ÕÕ 
byte
×× 
[
×× 
]
×× 
protectedKey
×× 
=
××  !
result
××" (
.
××( )
Unwrap
××) /
(
××/ 0
)
××0 1
;
××1 2
Result
ØØ 
<
ØØ &
SodiumSecureMemoryHandle
ØØ +
,
ØØ+ ,#
AuthenticationFailure
ØØ- B
>
ØØB C
unwrapResult
ØØD P
=
ØØQ R
await
ØØS X"
UnwrapMasterKeyAsync
ØØY m
(
ØØm n
protectedKey
ØØn z
,
ØØz {
contextØØ| ƒ
)ØØƒ „
.ØØ„ …
ConfigureAwaitØØ… “
(ØØ“ ”
falseØØ” ™
)ØØ™ š
;ØØš ›
return
ÚÚ 
unwrapResult
ÚÚ 
;
ÚÚ  
}
ÛÛ 	
catch
ÜÜ 
(
ÜÜ 
	Exception
ÜÜ 
ex
ÜÜ 
)
ÜÜ 
{
ÝÝ 	
return
ÞÞ 
Result
ÞÞ 
<
ÞÞ &
SodiumSecureMemoryHandle
ÞÞ 2
,
ÞÞ2 3#
AuthenticationFailure
ÞÞ4 I
>
ÞÞI J
.
ÞÞJ K
Err
ÞÞK N
(
ÞÞN O#
AuthenticationFailure
ßß %
.
ßß% &#
IdentityStorageFailed
ßß& ;
(
ßß; <
$"
ßß< >
$str
ßß> Y
{
ßßY Z
ex
ßßZ \
.
ßß\ ]
Message
ßß] d
}
ßßd e
"
ßße f
,
ßßf g
ex
ßßh j
)
ßßj k
)
ßßk l
;
ßßl m
}
àà 	
}
áá 
private
ãã 
async
ãã 
Task
ãã 
<
ãã 
(
ãã 
byte
ãã 
[
ãã 
]
ãã 
wrappedData
ãã *
,
ãã* +
byte
ãã, 0
[
ãã0 1
]
ãã1 2
?
ãã2 3
wrappingKey
ãã4 ?
)
ãã? @
>
ãã@ A 
WrapMasterKeyAsync
ããB T
(
ããT U&
SodiumSecureMemoryHandle
ããU m
masterKeyHandle
ããn }
)
ãã} ~
{
ää 
byte
åå 
[
åå 
]
åå 
?
åå 
masterKeyBytes
åå 
=
åå  
null
åå! %
;
åå% &
bool
ææ '
hardwareSecurityAvailable
ææ &
=
ææ' ()
IsHardwareSecurityAvailable
ææ) D
(
ææD E
)
ææE F
;
ææF G
try
èè 
{
éé 	
Result
êê 
<
êê 
byte
êê 
[
êê 
]
êê 
,
êê 
SodiumFailure
êê (
>
êê( )

readResult
êê* 4
=
êê5 6
masterKeyHandle
ëë 
.
ëë  
	ReadBytes
ëë  )
(
ëë) *
masterKeyHandle
ëë* 9
.
ëë9 :
Length
ëë: @
)
ëë@ A
;
ëëA B
if
ìì 
(
ìì 

readResult
ìì 
.
ìì 
IsErr
ìì  
)
ìì  !
{
íí 
throw
îî 
new
îî '
InvalidOperationException
îî 3
(
îî3 4
$"
îî4 6
$str
îî6 Q
{
îîQ R

readResult
îîR \
.
îî\ ]
	UnwrapErr
îî] f
(
îîf g
)
îîg h
.
îîh i
Message
îîi p
}
îîp q
"
îîq r
)
îîr s
;
îîs t
}
ïï 
masterKeyBytes
ññ 
=
ññ 

readResult
ññ '
.
ññ' (
Unwrap
ññ( .
(
ññ. /
)
ññ/ 0
;
ññ0 1
if
óó 
(
óó 
!
óó '
hardwareSecurityAvailable
óó *
)
óó* +
{
ôô 
return
õõ 
(
õõ 
masterKeyBytes
õõ &
.
õõ& '
AsSpan
õõ' -
(
õõ- .
)
õõ. /
.
õõ/ 0
ToArray
õõ0 7
(
õõ7 8
)
õõ8 9
,
õõ9 :
null
õõ; ?
)
õõ? @
;
õõ@ A
}
öö 
byte
øø 
[
øø 
]
øø 
?
øø 
encryptedKey
øø  
=
øø! "
null
øø# '
;
øø' (
try
ùù 
{
úú 
byte
ûû 
[
ûû 
]
ûû 
wrappingKey
ûû "
=
ûû# $
await
ûû% *&
GenerateWrappingKeyAsync
ûû+ C
(
ûûC D
)
ûûD E
.
ûûE F
ConfigureAwait
ûûF T
(
ûûT U
false
ûûU Z
)
ûûZ [
;
ûû[ \
using
ýý 
Aes
ýý 
aes
ýý 
=
ýý 
Aes
ýý  #
.
ýý# $
Create
ýý$ *
(
ýý* +
)
ýý+ ,
;
ýý, -
aes
þþ 
.
þþ 
Key
þþ 
=
þþ 
wrappingKey
þþ %
;
þþ% &
aes
ÿÿ 
.
ÿÿ 

GenerateIV
ÿÿ 
(
ÿÿ 
)
ÿÿ  
;
ÿÿ  !
encryptedKey
 
=
 
aes
 "
.
" #

EncryptCbc
# -
(
- .
masterKeyBytes
. <
,
< =
aes
> A
.
A B
IV
B D
)
D E
;
E F
byte
ƒƒ 
[
ƒƒ 
]
ƒƒ 
wrappedData
ƒƒ "
=
ƒƒ# $
new
ƒƒ% (
byte
ƒƒ) -
[
ƒƒ- .
aes
ƒƒ. 1
.
ƒƒ1 2
IV
ƒƒ2 4
.
ƒƒ4 5
Length
ƒƒ5 ;
+
ƒƒ< =
encryptedKey
ƒƒ> J
.
ƒƒJ K
Length
ƒƒK Q
]
ƒƒQ R
;
ƒƒR S
aes
„„ 
.
„„ 
IV
„„ 
.
„„ 
CopyTo
„„ 
(
„„ 
wrappedData
„„ )
,
„„) *
$num
„„+ ,
)
„„, -
;
„„- .
encryptedKey
…… 
.
…… 
CopyTo
…… #
(
……# $
wrappedData
……$ /
,
……/ 0
aes
……1 4
.
……4 5
IV
……5 7
.
……7 8
Length
……8 >
)
……> ?
;
……? @
return
‡‡ 
(
‡‡ 
wrappedData
‡‡ #
,
‡‡# $
wrappingKey
‡‡% 0
)
‡‡0 1
;
‡‡1 2
}
ˆˆ 
finally
‰‰ 
{
ŠŠ 
if
‹‹ 
(
‹‹ 
encryptedKey
‹‹  
!=
‹‹! #
null
‹‹$ (
)
‹‹( )
{
ŒŒ %
CryptographicOperations
 +
.
+ ,

ZeroMemory
, 6
(
6 7
encryptedKey
7 C
)
C D
;
D E
}
ŽŽ 
}
 
}
 	
catch
‘‘ 
{
’’ 	
if
““ 
(
““ 
masterKeyBytes
““ 
==
““ !
null
““" &
)
““& '
{
”” 
throw
•• 
;
•• 
}
–– 
return
˜˜ 
(
˜˜ 
masterKeyBytes
˜˜ "
.
˜˜" #
AsSpan
˜˜# )
(
˜˜) *
)
˜˜* +
.
˜˜+ ,
ToArray
˜˜, 3
(
˜˜3 4
)
˜˜4 5
,
˜˜5 6
null
˜˜7 ;
)
˜˜; <
;
˜˜< =
}
™™ 	
finally
šš 
{
›› 	
if
œœ 
(
œœ 
masterKeyBytes
œœ 
!=
œœ !
null
œœ" &
)
œœ& '
{
 %
CryptographicOperations
žž '
.
žž' (

ZeroMemory
žž( 2
(
žž2 3
masterKeyBytes
žž3 A
)
žžA B
;
žžB C
}
ŸŸ 
}
   	
}
¡¡ 
private
££ 
async
££ 
Task
££ 
<
££ 
Result
££ 
<
££ &
SodiumSecureMemoryHandle
££ 6
,
££6 7#
AuthenticationFailure
££8 M
>
££M N
>
££N O"
UnwrapMasterKeyAsync
££P d
(
££d e
byte
££e i
[
££i j
]
££j k
protectedKey
££l x
,
££x y
IdentityContext££z ‰
context££Š ‘
)££‘ ’
{
¤¤ 
byte
¥¥ 
[
¥¥ 
]
¥¥ 
?
¥¥ 
masterKeyBytes
¥¥ 
=
¥¥  
null
¥¥! %
;
¥¥% &
byte
¦¦ 
[
¦¦ 
]
¦¦ 
?
¦¦ 
wrappingKey
¦¦ 
=
¦¦ 
null
¦¦ "
;
¦¦" #
byte
§§ 
[
§§ 
]
§§ 
?
§§ 
encryptedKey
§§ 
=
§§ 
null
§§ #
;
§§# $
byte
¨¨ 
[
¨¨ 
]
¨¨ 
?
¨¨ 
iv
¨¨ 
=
¨¨ 
null
¨¨ 
;
¨¨ 
bool
©© '
hardwareSecurityAvailable
©© &
=
©©' ()
IsHardwareSecurityAvailable
©©) D
(
©©D E
)
©©E F
;
©©F G
try
«« 
{
¬¬ 	
if
­­ 
(
­­ 
!
­­ '
hardwareSecurityAvailable
­­ *
)
­­* +
{
®® 
masterKeyBytes
¯¯ 
=
¯¯  
protectedKey
¯¯! -
.
¯¯- .
AsSpan
¯¯. 4
(
¯¯4 5
)
¯¯5 6
.
¯¯6 7
ToArray
¯¯7 >
(
¯¯> ?
)
¯¯? @
;
¯¯@ A
}
°° 
else
±± 
{
²² 
string
³³ 
keychainKey
³³ "
=
³³# $
context
³³% ,
.
³³, -
KeychainKey
³³- 8
;
³³8 9
wrappingKey
´´ 
=
´´ 
await
´´ #
_platformProvider
´´$ 5
.
´´5 6%
GetKeyFromKeychainAsync
´´6 M
(
´´M N
keychainKey
´´N Y
)
´´Y Z
.
´´Z [
ConfigureAwait
´´[ i
(
´´i j
false
´´j o
)
´´o p
;
´´p q
if
¶¶ 
(
¶¶ 
wrappingKey
¶¶ 
==
¶¶  "
null
¶¶# '
)
¶¶' (
{
·· 
masterKeyBytes
¸¸ "
=
¸¸# $
protectedKey
¸¸% 1
.
¸¸1 2
AsSpan
¸¸2 8
(
¸¸8 9
)
¸¸9 :
.
¸¸: ;
ToArray
¸¸; B
(
¸¸B C
)
¸¸C D
;
¸¸D E
}
¹¹ 
else
ºº 
{
»» 
using
¼¼ 
Aes
¼¼ 
aes
¼¼ !
=
¼¼" #
Aes
¼¼$ '
.
¼¼' (
Create
¼¼( .
(
¼¼. /
)
¼¼/ 0
;
¼¼0 1
aes
½½ 
.
½½ 
Key
½½ 
=
½½ 
wrappingKey
½½ )
;
½½) *
ReadOnlySpan
¿¿  
<
¿¿  !
byte
¿¿! %
>
¿¿% &
protectedSpan
¿¿' 4
=
¿¿5 6
protectedKey
¿¿7 C
.
¿¿C D
AsSpan
¿¿D J
(
¿¿J K
)
¿¿K L
;
¿¿L M
iv
ÀÀ 
=
ÀÀ 
protectedSpan
ÀÀ &
[
ÀÀ& '
..
ÀÀ' )$
SecureStorageConstants
ÀÀ) ?
.
ÀÀ? @
Identity
ÀÀ@ H
.
ÀÀH I
AES_IV_SIZE
ÀÀI T
]
ÀÀT U
.
ÀÀU V
ToArray
ÀÀV ]
(
ÀÀ] ^
)
ÀÀ^ _
;
ÀÀ_ `
encryptedKey
ÁÁ  
=
ÁÁ! "
protectedSpan
ÁÁ# 0
[
ÁÁ0 1$
SecureStorageConstants
ÁÁ1 G
.
ÁÁG H
Identity
ÁÁH P
.
ÁÁP Q
AES_IV_SIZE
ÁÁQ \
..
ÁÁ\ ^
]
ÁÁ^ _
.
ÁÁ_ `
ToArray
ÁÁ` g
(
ÁÁg h
)
ÁÁh i
;
ÁÁi j
aes
ÃÃ 
.
ÃÃ 
IV
ÃÃ 
=
ÃÃ 
iv
ÃÃ 
;
ÃÃ  
masterKeyBytes
ÄÄ "
=
ÄÄ# $
aes
ÄÄ% (
.
ÄÄ( )

DecryptCbc
ÄÄ) 3
(
ÄÄ3 4
encryptedKey
ÄÄ4 @
,
ÄÄ@ A
iv
ÄÄB D
)
ÄÄD E
;
ÄÄE F
}
ÅÅ 
}
ÆÆ 
Result
ÈÈ 
<
ÈÈ &
SodiumSecureMemoryHandle
ÈÈ +
,
ÈÈ+ ,
SodiumFailure
ÈÈ- :
>
ÈÈ: ;
allocResult
ÈÈ< G
=
ÈÈH I&
SodiumSecureMemoryHandle
ÉÉ (
.
ÉÉ( )
Allocate
ÉÉ) 1
(
ÉÉ1 2
masterKeyBytes
ÉÉ2 @
.
ÉÉ@ A
Length
ÉÉA G
)
ÉÉG H
;
ÉÉH I
if
ÊÊ 
(
ÊÊ 
allocResult
ÊÊ 
.
ÊÊ 
IsErr
ÊÊ !
)
ÊÊ! "
{
ËË 
return
ÌÌ 
Result
ÌÌ 
<
ÌÌ &
SodiumSecureMemoryHandle
ÌÌ 6
,
ÌÌ6 7#
AuthenticationFailure
ÌÌ8 M
>
ÌÌM N
.
ÌÌN O
Err
ÌÌO R
(
ÌÌR S#
AuthenticationFailure
ÍÍ )
.
ÍÍ) *-
SECURE_MEMORY_ALLOCATION_FAILED
ÍÍ* I
(
ÍÍI J
$"
ÍÍJ L
$str
ÍÍL n
{
ÍÍn o
allocResult
ÍÍo z
.
ÍÍz {
	UnwrapErrÍÍ{ „
(ÍÍ„ …
)ÍÍ… †
.ÍÍ† ‡
MessageÍÍ‡ Ž
}ÍÍŽ 
"ÍÍ 
)ÍÍ ‘
)ÍÍ‘ ’
;ÍÍ’ “
}
ÎÎ &
SodiumSecureMemoryHandle
ÐÐ $
handle
ÐÐ% +
=
ÐÐ, -
allocResult
ÐÐ. 9
.
ÐÐ9 :
Unwrap
ÐÐ: @
(
ÐÐ@ A
)
ÐÐA B
;
ÐÐB C
Result
ÑÑ 
<
ÑÑ 
Unit
ÑÑ 
,
ÑÑ 
SodiumFailure
ÑÑ &
>
ÑÑ& '
writeResult
ÑÑ( 3
=
ÑÑ4 5
handle
ÑÑ6 <
.
ÑÑ< =
Write
ÑÑ= B
(
ÑÑB C
masterKeyBytes
ÑÑC Q
)
ÑÑQ R
;
ÑÑR S
if
ÒÒ 
(
ÒÒ 
writeResult
ÒÒ 
.
ÒÒ 
IsErr
ÒÒ !
)
ÒÒ! "
{
ÓÓ 
handle
ÔÔ 
.
ÔÔ 
Dispose
ÔÔ 
(
ÔÔ 
)
ÔÔ  
;
ÔÔ  !
return
ÕÕ 
Result
ÕÕ 
<
ÕÕ &
SodiumSecureMemoryHandle
ÕÕ 6
,
ÕÕ6 7#
AuthenticationFailure
ÕÕ8 M
>
ÕÕM N
.
ÕÕN O
Err
ÕÕO R
(
ÕÕR S#
AuthenticationFailure
ÖÖ )
.
ÖÖ) *(
SECURE_MEMORY_WRITE_FAILED
ÖÖ* D
(
ÖÖD E
$"
ÖÖE G
$str
ÖÖG i
{
ÖÖi j
writeResult
ÖÖj u
.
ÖÖu v
	UnwrapErr
ÖÖv 
(ÖÖ €
)ÖÖ€ 
.ÖÖ ‚
MessageÖÖ‚ ‰
}ÖÖ‰ Š
"ÖÖŠ ‹
)ÖÖ‹ Œ
)ÖÖŒ 
;ÖÖ Ž
}
×× 
return
ÙÙ 
Result
ÙÙ 
<
ÙÙ &
SodiumSecureMemoryHandle
ÙÙ 2
,
ÙÙ2 3#
AuthenticationFailure
ÙÙ4 I
>
ÙÙI J
.
ÙÙJ K
Ok
ÙÙK M
(
ÙÙM N
handle
ÙÙN T
)
ÙÙT U
;
ÙÙU V
}
ÚÚ 	
catch
ÛÛ 
(
ÛÛ 
	Exception
ÛÛ 
ex
ÛÛ 
)
ÛÛ 
{
ÜÜ 	
return
ÝÝ 
Result
ÝÝ 
<
ÝÝ &
SodiumSecureMemoryHandle
ÝÝ 2
,
ÝÝ2 3#
AuthenticationFailure
ÝÝ4 I
>
ÝÝI J
.
ÝÝJ K
Err
ÝÝK N
(
ÝÝN O#
AuthenticationFailure
ÞÞ %
.
ÞÞ% &#
IdentityStorageFailed
ÞÞ& ;
(
ÞÞ; <
$"
ÞÞ< >
$str
ÞÞ> [
{
ÞÞ[ \
ex
ÞÞ\ ^
.
ÞÞ^ _
Message
ÞÞ_ f
}
ÞÞf g
"
ÞÞg h
,
ÞÞh i
ex
ÞÞj l
)
ÞÞl m
)
ÞÞm n
;
ÞÞn o
}
ßß 	
finally
àà 
{
áá 	
if
ââ 
(
ââ 
masterKeyBytes
ââ 
!=
ââ !
null
ââ" &
)
ââ& '
{
ãã %
CryptographicOperations
ää '
.
ää' (

ZeroMemory
ää( 2
(
ää2 3
masterKeyBytes
ää3 A
)
ääA B
;
ääB C
}
åå 
if
çç 
(
çç 
wrappingKey
çç 
!=
çç 
null
çç #
)
çç# $
{
èè %
CryptographicOperations
éé '
.
éé' (

ZeroMemory
éé( 2
(
éé2 3
wrappingKey
éé3 >
)
éé> ?
;
éé? @
}
êê 
if
ìì 
(
ìì 
encryptedKey
ìì 
!=
ìì 
null
ìì  $
)
ìì$ %
{
íí %
CryptographicOperations
îî '
.
îî' (

ZeroMemory
îî( 2
(
îî2 3
encryptedKey
îî3 ?
)
îî? @
;
îî@ A
}
ïï 
if
ññ 
(
ññ 
iv
ññ 
!=
ññ 
null
ññ 
)
ññ 
{
òò %
CryptographicOperations
óó '
.
óó' (

ZeroMemory
óó( 2
(
óó2 3
iv
óó3 5
)
óó5 6
;
óó6 7
}
ôô 
}
õõ 	
}
öö 
private
øø 
async
øø 
Task
øø 
<
øø 
byte
øø 
[
øø 
]
øø 
>
øø &
GenerateWrappingKeyAsync
øø 7
(
øø7 8
)
øø8 9
=>
øø: <
await
øø= B
_platformProvider
øøC T
.
øøT U'
GenerateSecureRandomAsync
øøU n
(
øøn o%
SecureStorageConstantsøøo …
.øø… †
Identityøø† Ž
.øøŽ 
AES_KEY_SIZEøø ›
)øø› œ
.øøœ 
ConfigureAwaitøø «
(øø« ¬
falseøø¬ ±
)øø± ²
;øø² ³
private
úú 
bool
úú )
IsHardwareSecurityAvailable
úú ,
(
úú, -
)
úú- .
=>
úú/ 1(
_hardwareSecurityAvailable
úú2 L
.
úúL M
Value
úúM R
;
úúR S
private
üü 
sealed
üü 
class
üü 
IdentityContext
üü (
(
üü( )
string
üü) /
membershipId
üü0 <
)
üü< =
{
ýý 
private
þþ 
byte
þþ 
[
þþ 
]
þþ 
?
þþ 
_membershipBytes
þþ (
;
þþ( )
public
ÿÿ 
string
ÿÿ 
MembershipId
ÿÿ "
{
ÿÿ# $
get
ÿÿ% (
;
ÿÿ( )
}
ÿÿ* +
=
ÿÿ, -
membershipId
ÿÿ. :
;
ÿÿ: ;
public
€€ 
string
€€ 

StorageKey
€€  
{
€€! "
get
€€# &
;
€€& '
}
€€( )
=
€€* +$
GetMasterKeyStorageKey
€€, B
(
€€B C
membershipId
€€C O
)
€€O P
;
€€P Q
public
 
string
 
KeychainKey
 !
{
" #
get
$ '
;
' (
}
) *
=
+ , 
GetKeychainWrapKey
- ?
(
? @
membershipId
@ L
)
L M
;
M N
public
‚‚ 
byte
‚‚ 
[
‚‚ 
]
‚‚ 
MembershipBytes
‚‚ %
=>
‚‚& (
_membershipBytes
‚‚) 9
??=
‚‚: =
Guid
‚‚> B
.
‚‚B C
Parse
‚‚C H
(
‚‚H I
MembershipId
‚‚I U
)
‚‚U V
.
‚‚V W
ToByteArray
‚‚W b
(
‚‚b c
)
‚‚c d
;
‚‚d e
private
„„ 
static
„„ 
string
„„ $
GetMasterKeyStorageKey
„„ 4
(
„„4 5
string
„„5 ;
membershipId
„„< H
)
„„H I
=>
„„J L
string
…… 
.
…… 
Concat
…… 
(
…… $
SecureStorageConstants
…… 0
.
……0 1
Identity
……1 9
.
……9 :'
MASTER_KEY_STORAGE_PREFIX
……: S
,
……S T
membershipId
……U a
)
……a b
;
……b c
private
‡‡ 
static
‡‡ 
string
‡‡  
GetKeychainWrapKey
‡‡ 0
(
‡‡0 1
string
‡‡1 7
membershipId
‡‡8 D
)
‡‡D E
=>
‡‡F H
string
ˆˆ 
.
ˆˆ 
Concat
ˆˆ 
(
ˆˆ $
SecureStorageConstants
ˆˆ 0
.
ˆˆ0 1
Identity
ˆˆ1 9
.
ˆˆ9 :&
KEYCHAIN_WRAP_KEY_PREFIX
ˆˆ: R
,
ˆˆR S
membershipId
ˆˆT `
)
ˆˆ` a
;
ˆˆa b
}
‰‰ 
}ŠŠ ËY
”/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/Internal/VerificationStreamManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
./ 0
Internal0 8
;8 9
internal 
sealed	 
class %
VerificationStreamManager /
(/ 0
NetworkProvider0 ?
networkProvider@ O
)O P
:Q R
IDisposableS ^
{ 
private 
readonly  
ConcurrentDictionary )
<) *
Guid* .
,. /
uint0 4
>4 5
_activeStreams6 D
=E F
newG J
(J K
)K L
;L M
private 
readonly  
ConcurrentDictionary )
<) *
Guid* .
,. /
VerificationPurpose0 C
>C D"
_activeSessionPurposesE [
=\ ]
new^ a
(a b
)b c
;c d
private 
readonly #
CancellationTokenSource ,
_disposalCts- 9
=: ;
new< ?
(? @
)@ A
;A B
private 
readonly 
List 
< 
Task 
> #
_backgroundCleanupTasks  7
=8 9
new: =
(= >
)> ?
;? @
private 
bool 
_isDisposed 
; 
public 

bool 
TryGetActiveStream "
(" #
Guid# '
sessionIdentifier( 9
,9 :
out; >
uint? C
	connectIdD M
)M N
=>O Q
_activeStreams 
. 
TryGetValue "
(" #
sessionIdentifier# 4
,4 5
out6 9
	connectId: C
)C D
;D E
public 

VerificationPurpose 
GetSessionPurpose 0
(0 1
Guid1 5
sessionIdentifier6 G
)G H
=>I K"
_activeSessionPurposes 
. 
GetValueOrDefault 0
(0 1
sessionIdentifier1 B
,B C
VerificationPurposeD W
.W X
RegistrationX d
)d e
;e f
public 

void 
RegisterStream 
( 
Guid #"
verificationIdentifier$ :
,: ;
uint< @
streamConnectIdA P
,P Q
VerificationPurposeR e
purposef m
)m n
{ 
if 

( 
_isDisposed 
|| "
verificationIdentifier 1
==2 4
Guid5 9
.9 :
Empty: ?
)? @
{ 	
return   
;   
}!! 	
_activeStreams## 
.## 
TryAdd## 
(## "
verificationIdentifier## 4
,##4 5
streamConnectId##6 E
)##E F
;##F G"
_activeSessionPurposes$$ 
.$$ 
TryAdd$$ %
($$% &"
verificationIdentifier$$& <
,$$< =
purpose$$> E
)$$E F
;$$F G
}%% 
public'' 

void'' %
ProcessVerificationUpdate'' )
('') *
Guid(( "
verificationIdentifier(( #
,((# $
uint)) 
streamConnectId)) 
,)) '
VerificationCountdownUpdate** #
.**# $
Types**$ )
.**) *!
CountdownUpdateStatus*** ?
status**@ F
,**F G
VerificationPurpose++ 
purpose++ #
)++# $
{,, 
bool-- 
shouldCleanup-- 
=-- 
ShouldCleanupStream-- 0
(--0 1
status--1 7
)--7 8
;--8 9
if// 

(// 
shouldCleanup// 
)// 
{00 	
if11 
(11 "
verificationIdentifier11 &
!=11' )
Guid11* .
.11. /
Empty11/ 4
)114 5
{22 !
ScheduleStreamCleanup33 %
(33% &"
verificationIdentifier33& <
)33< =
;33= >
}44 
}55 	
else66 
if66 
(66 "
verificationIdentifier66 '
!=66( *
Guid66+ /
.66/ 0
Empty660 5
)665 6
{77 	
RegisterStream88 
(88 "
verificationIdentifier88 1
,881 2
streamConnectId883 B
,88B C
purpose88D K
)88K L
;88L M
}99 	
}:: 
public<< 

async<< 
Task<< 
<<< 
Result<< 
<<< 
Unit<< !
,<<! "
string<<# )
><<) *
><<* +
CloseStreamAsync<<, <
(<<< =
Guid<<= A
sessionIdentifier<<B S
)<<S T
{== "
_activeSessionPurposes>> 
.>> 
	TryRemove>> (
(>>( )
sessionIdentifier>>) :
,>>: ;
out>>< ?
VerificationPurpose>>@ S
_>>T U
)>>U V
;>>V W
if@@ 

(@@ 
!@@ 
_activeStreams@@ 
.@@ 
	TryRemove@@ %
(@@% &
sessionIdentifier@@& 7
,@@7 8
out@@9 <
uint@@= A
	connectId@@B K
)@@K L
)@@L M
{AA 	
returnBB 
ResultBB 
<BB 
UnitBB 
,BB 
stringBB  &
>BB& '
.BB' (
OkBB( *
(BB* +
UnitBB+ /
.BB/ 0
ValueBB0 5
)BB5 6
;BB6 7
}CC 	
ResultEE 
<EE 
UnitEE 
,EE 
NetworkFailureEE #
>EE# $
resultEE% +
=EE, -
awaitEE. 3
networkProviderEE4 C
.FF &
CleanupStreamProtocolAsyncFF '
(FF' (
	connectIdFF( 1
)FF1 2
.GG 
ConfigureAwaitGG 
(GG 
falseGG !
)GG! "
;GG" #
returnII 
resultII 
.II 
IsErrII 
?JJ 
ResultJJ 
<JJ 
UnitJJ 
,JJ 
stringJJ !
>JJ! "
.JJ" #
ErrJJ# &
(JJ& '
resultJJ' -
.JJ- .
	UnwrapErrJJ. 7
(JJ7 8
)JJ8 9
.JJ9 :
MessageJJ: A
)JJA B
:KK 
ResultKK 
<KK 
UnitKK 
,KK 
stringKK !
>KK! "
.KK" #
OkKK# %
(KK% &
UnitKK& *
.KK* +
ValueKK+ 0
)KK0 1
;KK1 2
}LL 
publicNN 

voidNN 
DisposeNN 
(NN 
)NN 
{OO 
ifPP 

(PP 
_isDisposedPP 
)PP 
{QQ 	
returnRR 
;RR 
}SS 	
_isDisposedUU 
=UU 
trueUU 
;UU 
_disposalCtsVV 
.VV 
CancelVV 
(VV 
)VV 
;VV 
TaskXX 
[XX 
]XX 
tasksToWaitXX 
;XX 
lockYY 
(YY #
_backgroundCleanupTasksYY %
)YY% &
{ZZ 	
tasksToWait[[ 
=[[ #
_backgroundCleanupTasks[[ 1
.[[1 2
Where[[2 7
([[7 8
t[[8 9
=>[[: <
![[= >
t[[> ?
.[[? @
IsCompleted[[@ K
)[[K L
.[[L M
ToArray[[M T
([[T U
)[[U V
;[[V W
}\\ 	
if^^ 

(^^ 
tasksToWait^^ 
.^^ 
Length^^ 
>^^  
$num^^! "
)^^" #
{__ 	
Task`` 
.`` 
WaitAll`` 
(`` 
tasksToWait`` $
,``$ %
TimeSpan``& .
.``. /
FromSeconds``/ :
(``: ;
$num``; <
)``< =
)``= >
;``> ?
}aa 	
_disposalCtscc 
.cc 
Disposecc 
(cc 
)cc 
;cc 
_activeStreamsdd 
.dd 
Cleardd 
(dd 
)dd 
;dd "
_activeSessionPurposesee 
.ee 
Clearee $
(ee$ %
)ee% &
;ee& '
}ff 
privatehh 
statichh 
boolhh 
ShouldCleanupStreamhh +
(hh+ ,'
VerificationCountdownUpdatehh, G
.hhG H
TypeshhH M
.hhM N!
CountdownUpdateStatushhN c
statushhd j
)hhj k
{ii 
returnjj 
statusjj 
switchjj 
{kk 	'
VerificationCountdownUpdatell '
.ll' (
Typesll( -
.ll- .!
CountdownUpdateStatusll. C
.llC D
FailedllD J
=>llK M
truellN R
,llR S'
VerificationCountdownUpdatemm '
.mm' (
Typesmm( -
.mm- .!
CountdownUpdateStatusmm. C
.mmC D
MaxAttemptsReachedmmD V
=>mmW Y
truemmZ ^
,mm^ _'
VerificationCountdownUpdatenn '
.nn' (
Typesnn( -
.nn- .!
CountdownUpdateStatusnn. C
.nnC D
NotFoundnnD L
=>nnM O
truennP T
,nnT U
_oo 
=>oo 
falseoo 
}pp 	
;pp	 

}qq 
privatess 
voidss !
ScheduleStreamCleanupss &
(ss& '
Guidss' +"
verificationIdentifierss, B
)ssB C
{tt 
Taskuu 
cleanupTaskuu 
=uu 
Taskuu 
.uu  
Runuu  #
(uu# $
asyncuu$ )
(uu* +
)uu+ ,
=>uu- /
{vv 	
tryww 
{xx 
awaityy 
CloseStreamAsyncyy &
(yy& '"
verificationIdentifieryy' =
)yy= >
.yy> ?
ConfigureAwaityy? M
(yyM N
falseyyN S
)yyS T
;yyT U
}zz 
catch{{ 
({{ 
	Exception{{ 
ex{{ 
){{  
{|| 
Serilog}} 
.}} 
Log}} 
.}} 
Error}} !
(}}! "
ex}}" $
,}}$ %
$str}}& b
,}}b c"
verificationIdentifier~~ *
)~~* +
;~~+ ,
} 
}
€€ 	
,
€€	 

_disposalCts
€€ 
.
€€ 
Token
€€ 
)
€€ 
;
€€ 
lock
‚‚ 
(
‚‚ %
_backgroundCleanupTasks
‚‚ %
)
‚‚% &
{
ƒƒ 	%
_backgroundCleanupTasks
„„ #
.
„„# $
Add
„„$ '
(
„„' (
cleanupTask
„„( 3
)
„„3 4
;
„„4 5%
_backgroundCleanupTasks
…… #
.
……# $
	RemoveAll
……$ -
(
……- .
t
……. /
=>
……0 2
t
……3 4
.
……4 5
IsCompleted
……5 @
)
……@ A
;
……A B
}
†† 	
}
‡‡ 
}ˆˆ šG
“/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Authentication/Constants/AuthenticationConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Authentication! /
./ 0
	Constants0 9
;9 :
public 
static 
class #
AuthenticationConstants +
{ 
public 

const 
string &
MOBILE_NUMBER_REQUIRED_KEY 2
=3 4
$str5 ]
;] ^
public 

const 
string 1
%MOBILE_NUMBER_IDENTIFIER_REQUIRED_KEY =
=> ?
$str@ r
;r s
public		 

const		 
string		 +
SESSION_IDENTIFIER_REQUIRED_KEY		 7
=		8 9
$str		: g
;		g h
public

 

const

 
string

 .
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY

 :
=

; <
$str

= m
;

m n
public 

const 
string #
SECURE_KEY_REQUIRED_KEY /
=0 1
$str2 W
;W X
public 

const 
string #
INVALID_CREDENTIALS_KEY /
=0 1
$str2 a
;a b
public 

const 
string 0
$VERIFY_SECURE_KEY_DOES_NOT_MATCH_KEY <
== >
$str? n
;n o
public 

const 
string '
COMMON_UNEXPECTED_ERROR_KEY 3
=4 5
$str6 N
;N O
public 

const 
string +
SECURE_KEY_STRENGTH_INVALID_KEY 7
=8 9
$str: f
;f g
public 

const 
string -
!SECURE_KEY_STRENGTH_VERY_WEAK_KEY 9
=: ;
$str< i
;i j
public 

const 
string (
SECURE_KEY_STRENGTH_WEAK_KEY 4
=5 6
$str7 `
;` a
public 

const 
string (
SECURE_KEY_STRENGTH_GOOD_KEY 4
=5 6
$str7 `
;` a
public 

const 
string *
SECURE_KEY_STRENGTH_STRONG_KEY 6
=7 8
$str9 d
;d e
public 

const 
string /
#SECURE_KEY_STRENGTH_VERY_STRONG_KEY ;
=< =
$str> m
;m n
public 

const 
string "
NETWORK_FAILURE_PREFIX .
=/ 0
$str1 M
;M N
public 

const 
string '
VERIFICATION_FAILURE_PREFIX 3
=4 5
$str6 M
;M N
public 

const 
string '
REGISTRATION_FAILURE_PREFIX 3
=4 5
$str6 M
;M N
public 

const 
string  
INVALID_OTP_CODE_KEY ,
=- .
$str/ R
;R S
public 

const 
string #
REGISTRATION_FAILED_KEY /
=0 1
$str2 M
;M N
public 

const 
string '
NO_VERIFICATION_SESSION_KEY 3
=4 5
$str6 T
;T U
public 

const 
string ,
 VERIFICATION_SESSION_EXPIRED_KEY 8
=9 :
$str; _
;_ `
public 

const 
string .
"NO_ACTIVE_VERIFICATION_SESSION_KEY :
=; <
$str= a
;a b
public   

const   
string   $
MAX_ATTEMPTS_REACHED_KEY   0
=  1 2
$str  3 Z
;  Z [
public!! 

const!! 
string!! !
SESSION_NOT_FOUND_KEY!! -
=!!. /
$str!!0 T
;!!T U
public"" 

const"" 
string"" &
REDIRECTING_IN_SECONDS_KEY"" 2
=""3 4
$str""5 ]
;""] ^
public## 

const## 
string## "
NAVIGATION_FAILURE_KEY## .
=##/ 0
$str##1 Y
;##Y Z
public%% 

const%% 
string%% "
INITIAL_REMAINING_TIME%% .
=%%/ 0
$str%%1 8
;%%8 9
public&& 

const&& 
string&& "
EXPIRED_REMAINING_TIME&& .
=&&/ 0
$str&&1 8
;&&8 9
public(( 

static(( 
readonly(( 
Guid(( 
	EmptyGuid((  )
=((* +
Guid((, 0
.((0 1
Empty((1 6
;((6 7
public** 

static** 
class** 
ErrorMessages** %
{++ 
public,, 
const,, 
string,, &
SESSION_EXPIRED_START_OVER,, 6
=,,7 8
$str,,9 ^
;,,^ _
}-- 
public// 

static// 
class// 
Timeouts//  
{00 
public11 
static11 
readonly11 
TimeSpan11 '
CleanupTimeout11( 6
=117 8
TimeSpan119 A
.11A B
FromSeconds11B M
(11M N
$num11N O
)11O P
;11P Q
}22 
public44 

static44 
class44 %
SecureKeyConfirmationKeys44 1
{55 
public66 
const66 
string66 
REGISTRATION_TITLE66 .
=66/ 0
$str661 d
;66d e
public77 
const77 
string77 $
REGISTRATION_DESCRIPTION77 4
=775 6
$str777 p
;77p q
public88 
const88 
string88 
REGISTRATION_BUTTON88 /
=880 1
$str882 f
;88f g
public:: 
const:: 
string:: 
RECOVERY_TITLE:: *
=::+ ,
$str::- [
;::[ \
public;; 
const;; 
string;;  
RECOVERY_DESCRIPTION;; 0
=;;1 2
$str;;3 g
;;;g h
public<< 
const<< 
string<< 
RECOVERY_BUTTON<< +
=<<, -
$str<<. ]
;<<] ^
public>> 
const>> 
string>> "
SECURE_KEY_PLACEHOLDER>> 2
=>>3 4
$str>>5 y
;>>y z
public?? 
const?? 
string?? 
SECURE_KEY_HINT?? +
=??, -
$str??. k
;??k l
public@@ 
const@@ 
string@@ )
VERIFY_SECURE_KEY_PLACEHOLDER@@ 9
=@@: ;
$str	@@< ‡
;
@@‡ ˆ
publicAA 
constAA 
stringAA "
VERIFY_SECURE_KEY_HINTAA 2
=AA3 4
$strAA5 y
;AAy z
publicCC 
constCC 
stringCC +
RECOVERY_SECURE_KEY_PLACEHOLDERCC ;
=CC< =
$strCC> ~
;CC~ 
publicDD 
constDD 
stringDD $
RECOVERY_SECURE_KEY_HINTDD 4
=DD5 6
$strDD7 p
;DDp q
publicEE 
constEE 
stringEE 2
&RECOVERY_VERIFY_SECURE_KEY_PLACEHOLDEREE B
=EEC D
$str	EEE ‰
;
EE‰ Š
publicFF 
constFF 
stringFF +
RECOVERY_VERIFY_SECURE_KEY_HINTFF ;
=FF< =
$strFF> {
;FF{ |
}GG 
publicII 

staticII 
classII "
MobileVerificationKeysII .
{JJ 
publicKK 
constKK 
stringKK 
REGISTRATION_TITLEKK .
=KK/ 0
$strKK1 a
;KKa b
publicLL 
constLL 
stringLL $
REGISTRATION_DESCRIPTIONLL 4
=LL5 6
$strLL7 m
;LLm n
publicMM 
constMM 
stringMM 
REGISTRATION_HINTMM -
=MM. /
$strMM0 _
;MM_ `
publicNN 
constNN 
stringNN "
REGISTRATION_WATERMARKNN 2
=NN3 4
$strNN5 i
;NNi j
publicOO 
constOO 
stringOO 
REGISTRATION_BUTTONOO /
=OO0 1
$strOO2 c
;OOc d
publicQQ 
constQQ 
stringQQ 
RECOVERY_TITLEQQ *
=QQ+ ,
$strQQ- h
;QQh i
publicRR 
constRR 
stringRR  
RECOVERY_DESCRIPTIONRR 0
=RR1 2
$strRR3 t
;RRt u
publicSS 
constSS 
stringSS 
RECOVERY_HINTSS )
=SS* +
$strSS, f
;SSf g
publicTT 
constTT 
stringTT 
RECOVERY_WATERMARKTT .
=TT/ 0
$strTT1 p
;TTp q
publicUU 
constUU 
stringUU 
RECOVERY_BUTTONUU +
=UU, -
$strUU. j
;UUj k
}VV 
}YY È
‘/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Security/IServerPublicKeyProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Security. 6
;6 7
public 
	interface $
IServerPublicKeyProvider )
{ 
byte 
[ 	
]	 

GetServerPublicKey 
( 
) 
;  
} Ü
’/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Network/ISecrecyChannelRpcServices.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Services

  
.

  !
Abstractions

! -
.

- .
Network

. 5
;

5 6
public 
	interface &
ISecrecyChannelRpcServices +
{ 
Task 
< 	
Result	 
< 
SecureEnvelope 
, 
NetworkFailure  .
>. /
>/ 01
%EstablishAppDeviceSecrecyChannelAsync1 V
(V W 
IConnectivityService 
connectivityService 0
,0 1
SecureEnvelope 
request 
, 
PubKeyExchangeType 
? 
exchangeType (
=) *
null+ /
,/ 0
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< "
RestoreChannelResponse &
,& '
NetworkFailure( 6
>6 7
>7 8/
#RestoreAppDeviceSecrecyChannelAsync9 \
(\ ] 
IConnectivityService 
connectivityService 0
,0 1!
RestoreChannelRequest 
request %
,% &
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
SecureEnvelope 
, 
NetworkFailure  .
>. /
>/ 04
(AuthenticatedEstablishSecureChannelAsync1 Y
(Y Z 
IConnectivityService 
connectivityService 0
,0 1)
AuthenticatedEstablishRequest %
request& -
,- .
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
} î
‰/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Network/IUnaryRpcServices.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Network. 5
;5 6
public

 
	interface

 
IUnaryRpcServices

 "
{ 
Task 
< 	
Result	 
< 
RpcFlow 
, 
NetworkFailure '
>' (
>( )
InvokeRequestAsync* <
(< =
ServiceRequest 
request 
,  
IConnectivityService 
connectivityService 0
,0 1
CancellationToken 
token 
)  
;  !
} £
Š/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Network/IRpcServiceManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Network. 5
;5 6
public 
	interface 
IRpcServiceManager #
{ 
Task 
< 	
Result	 
< 
SecureEnvelope 
, 
NetworkFailure  .
>. /
>/ 0(
EstablishSecrecyChannelAsync1 M
(M N 
IConnectivityService 
connectivityService 0
,0 1
SecureEnvelope 
envelope 
,  
PubKeyExchangeType 
? 
exchangeType (
=) *
null+ /
,/ 0
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< "
RestoreChannelResponse &
,& '
NetworkFailure( 6
>6 7
>7 8&
RestoreSecrecyChannelAsync9 S
(S T 
IConnectivityService 
connectivityService 0
,0 1!
RestoreChannelRequest 
request %
,% &
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
SecureEnvelope 
, 
NetworkFailure  .
>. /
>/ 04
(EstablishAuthenticatedSecureChannelAsync1 Y
(Y Z 
IConnectivityService 
connectivityService 0
,0 1)
AuthenticatedEstablishRequest %
request& -
,- .
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
RpcFlow 
, 
NetworkFailure '
>' (
>( )%
InvokeServiceRequestAsync* C
(C D
ServiceRequestD R
requestS Z
,Z [
CancellationToken\ m
tokenn s
)s t
;t u
}   ¨
†/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Network/IRetryStrategy.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Network. 5
;5 6
public

 
	interface

 
IRetryStrategy

 
:

  !
IDisposable

" -
{ 
Task 
< 	
Result	 
< 
	TResponse 
, 
NetworkFailure )
>) *
>* +$
ExecuteRpcOperationAsync, D
<D E
	TResponseE N
>N O
(O P
Func 
< 
int 
, 
CancellationToken #
,# $
Task% )
<) *
Result* 0
<0 1
	TResponse1 :
,: ;
NetworkFailure< J
>J K
>K L
>L M
	operationN W
,W X
string 
operationName 
, 
uint 
	connectId 
, 
RpcServiceType 
? 
serviceType #
=$ %
null& *
,* +
int 
? 

maxRetries 
= 
null 
, 
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
	TResponse 
, 
NetworkFailure )
>) *
>* +/
#ExecuteManualRetryRpcOperationAsync, O
<O P
	TResponseP Y
>Y Z
(Z [
Func 
< 
int 
, 
CancellationToken #
,# $
Task% )
<) *
Result* 0
<0 1
	TResponse1 :
,: ;
NetworkFailure< J
>J K
>K L
>L M
	operationN W
,W X
string 
operationName 
, 
uint 
	connectId 
, 
RpcServiceType 
? 
serviceType #
=$ %
null& *
,* +
int 
? 

maxRetries 
= 
null 
, 
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
void !
MarkConnectionHealthy	 
( 
uint #
	connectId$ -
)- .
;. /
void $
ClearExhaustedOperations	 !
(! "
)" #
;# $
} Ü
Œ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Network/IRetryPolicyProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Network. 5
;5 6
public 
	interface  
IRetryPolicyProvider %
{ 
RetryBehavior 
GetRetryBehavior "
(" #
RpcServiceType# 1
serviceType2 =
)= >
;> ?
} ¨
‘/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Network/IReceiveStreamRpcServices.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Network. 5
;5 6
public		 
	interface		 %
IReceiveStreamRpcServices		 *
{

 
Task 
< 	
Result	 
< 
RpcFlow 
, 
NetworkFailure '
>' (
>( )
ProcessRequest* 8
(8 9
ServiceRequest9 G
requestH O
,O P
CancellationTokenQ b
tokenc h
)h i
;i j
} ¾
‰/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Membership/ILogoutService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .

Membership. 8
;8 9
public		 
	interface		 
ILogoutService		 
{

 
Task 
< 	
Result	 
< 
Unit 
, 
LogoutFailure #
># $
>$ %
LogoutAsync& 1
(1 2
LogoutReason2 >
reason? E
,E F
CancellationTokenG X
cancellationTokenY j
=k l
defaultm t
)t u
;u v
} ¢
Ž/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/External/IIpGeolocationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
External. 6
;6 7
public		 
	interface		 !
IIpGeolocationService		 &
{

 
Task 
< 	
Result	 
< 
	IpCountry 
, %
InternalServiceApiFailure 4
>4 5
>5 6
GetIpCountryAsync7 H
(H I
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
} È
‰/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Core/ILocalizationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Core. 2
;2 3
public 
	interface  
ILocalizationService %
:& '"
INotifyPropertyChanged( >
{ 
string		 

this		 
[		 
string		 
key		 
]		 
{		 
get		 !
;		! "
}		# $
void

 

SetCulture

	 
(

 
string

 
?

 
cultureName

 '
,

' (
Action

) /
?

/ 0
onCultureChanged

1 A
=

B C
null

D H
)

H I
;

I J
string 

	GetString 
( 
string 
key 
,  
params! '
object( .
[. /
]/ 0
args1 5
)5 6
;6 7
CultureInfo 
CurrentCultureInfo "
{# $
get% (
;( )
}* +
string 

CurrentCultureName 
{ 
get  #
;# $
}% &
event 	
Action
 
? 
LanguageChanged !
;! "
} ÿ
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Core/IApplicationStateManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Core. 2
;2 3
public 
enum 
ApplicationState 
{ 
INITIALIZING		 
,		 
	ANONYMOUS

 
,

 
AUTHENTICATED 
} 
public 
	interface $
IApplicationStateManager )
{ 
ApplicationState 
CurrentState !
{" #
get$ '
;' (
}) *
Task &
TransitionToAnonymousAsync	 #
(# $
)$ %
;% &
Task *
TransitionToAuthenticatedAsync	 '
(' (
string( .
membershipId/ ;
); <
;< =
} Ó
‡/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Core/IApplicationRouter.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Core. 2
;2 3
public 
	interface 
IApplicationRouter #
{ 
Task )
NavigateToAuthenticationAsync	 &
(& '
)' (
;( )
Task

 
NavigateToMainAsync

	 
(

 
)

 
;

 
Task %
TransitionFromSplashAsync	 "
(" #
Window# )
splashWindow* 6
,6 7
bool8 <
isAuthenticated= L
)L M
;M N
} “
Œ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Core/IApplicationInitializer.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Core. 2
;2 3
public 
	interface #
IApplicationInitializer (
{ 
Task 
< 	
bool	 
> 
InitializeAsync 
( !
DefaultSystemSettings 4!
defaultSystemSettings5 J
)J K
;K L
}		 ­
˜/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Authentication/ISecureKeyRecoveryService.cs
	namespace		 	
Ecliptix		
 
.		 
Core		 
.		 
Services		  
.		  !
Abstractions		! -
.		- .
Authentication		. <
;		< =
public 
	interface %
ISecureKeyRecoveryService *
{ 
Task 
< 	
Result	 
< 

ByteString 
, 
string "
>" #
># $*
ValidateMobileForRecoveryAsync% C
(C D
stringD J
mobileNumberK W
,W X
uint 
	connectId 
, 
CancellationToken )
cancellationToken* ;
=< =
default> E
)E F
;F G
Task 
< 	
Result	 
< 
Unit 
, 
string 
> 
> *
InitiateSecureKeyResetOtpAsync =
(= >

ByteString> H"
mobileNumberIdentifierI _
,_ `
Action 
< 
uint 
, 
Guid 
, '
VerificationCountdownUpdate 6
.6 7
Types7 <
.< =!
CountdownUpdateStatus= R
,R S
stringT Z
?Z [
>[ \
?\ ]
onCountdownUpdate^ o
=p q
nullr v
,v w
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
Unit 
, 
string 
> 
> (
ResendSecureKeyResetOtpAsync ;
(; <
Guid< @
sessionIdentifierA R
,R S

ByteStringT ^"
mobileNumberIdentifier_ u
,u v
Action 
< 
uint 
, 
Guid 
, '
VerificationCountdownUpdate 6
.6 7
Types7 <
.< =!
CountdownUpdateStatus= R
,R S
stringT Z
?Z [
>[ \
?\ ]
onCountdownUpdate^ o
=p q
nullr v
,v w
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
Protobuf 
. 

Membership #
.# $

Membership$ .
,. /
string0 6
>6 7
>7 8(
VerifySecureKeyResetOtpAsync9 U
(U V
GuidV Z
sessionIdentifier[ l
,l m
stringn t
otpCodeu |
,| }
uint 
	connectId 
, 
CancellationToken )
cancellationToken* ;
=< =
default> E
)E F
;F G
Task 
< 	
Result	 
< 
Unit 
, 
string 
> 
> '
CompleteSecureKeyResetAsync :
(: ;

ByteString; E 
membershipIdentifierF Z
,Z [
SecureTextBuffer\ l
newSecureKeym y
,y z
uint 
	connectId 
, 
CancellationToken )
cancellationToken* ;
=< =
default> E
)E F
;F G
Task 
< 	
Result	 
< 
Unit 
, 
string 
> 
> -
!CleanupSecureKeyResetSessionAsync @
(@ A
GuidA E
sessionIdentifierF W
)W X
;X Y
} »$
™/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Authentication/IOpaqueRegistrationService.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Services

  
.

  !
Abstractions

! -
.

- .
Authentication

. <
;

< =
public 
	interface &
IOpaqueRegistrationService +
{ 
Task 
< 	
Result	 
< (
ValidateMobileNumberResponse ,
,, -
string. 4
>4 5
>5 6%
ValidateMobileNumberAsync7 P
(P Q
stringQ W
mobileNumberX d
,d e
uint 
	connectId 
, 
CancellationToken )
cancellationToken* ;
=< =
default> E
)E F
;F G
Task 
< 	
Result	 
< 1
%CheckMobileNumberAvailabilityResponse 5
,5 6
string7 =
>= >
>> ?.
"CheckMobileNumberAvailabilityAsync@ b
(b c

ByteString "
mobileNumberIdentifier )
,) *
uint 
	connectId 
, 
CancellationToken )
cancellationToken* ;
=< =
default> E
)E F
;F G
Task 
< 	
Result	 
< 
Unit 
, 
string 
> 
> (
InitiateOtpVerificationAsync ;
(; <

ByteString "
mobileNumberIdentifier )
,) *
VerificationPurpose 
purpose #
=$ %
VerificationPurpose& 9
.9 :
Registration: F
,F G
Action 
< 
uint 
, 
Guid 
, '
VerificationCountdownUpdate 6
.6 7
Types7 <
.< =!
CountdownUpdateStatus= R
,R S
stringT Z
?Z [
>[ \
?\ ]
onCountdownUpdate^ o
=p q
nullr v
,v w
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
Unit 
, 
string 
> 
> &
ResendOtpVerificationAsync 9
(9 :
Guid: >
sessionIdentifier? P
,P Q

ByteStringR \"
mobileNumberIdentifier] s
,s t
Action 
< 
uint 
, 
Guid 
, '
VerificationCountdownUpdate 6
.6 7
Types7 <
.< =!
CountdownUpdateStatus= R
,R S
stringT Z
?Z [
>[ \
?\ ]
onCountdownUpdate^ o
=p q
nullr v
,v w
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
Task 
< 	
Result	 
< 
Protobuf 
. 

Membership #
.# $

Membership$ .
,. /
string0 6
>6 7
>7 8
VerifyOtpAsync9 G
(G H
GuidH L
sessionIdentifierM ^
,^ _
string` f
otpCodeg n
,n o
uint   
	connectId   
,   
CancellationToken   )
cancellationToken  * ;
=  < =
default  > E
)  E F
;  F G
Task"" 
<"" 	
Result""	 
<"" 
Unit"" 
,"" 
string"" 
>"" 
>"" %
CompleteRegistrationAsync"" 8
(""8 9

ByteString""9 C 
membershipIdentifier""D X
,""X Y
SecureTextBuffer""Z j
	secureKey""k t
,""t u
uint## 
	connectId## 
,## 
CancellationToken## )
cancellationToken##* ;
=##< =
default##> E
)##E F
;##F G
Task%% 
<%% 	
Result%%	 
<%% 
Unit%% 
,%% 
string%% 
>%% 
>%% +
CleanupVerificationSessionAsync%% >
(%%> ?
Guid%%? C
sessionIdentifier%%D U
)%%U V
;%%V W
}&& ¶
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Authentication/IIdentityService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Authentication. <
;< =
public		 
	interface		 
IIdentityService		 !
{

 
Task 
< 	
bool	 
> "
HasStoredIdentityAsync %
(% &
string& ,
membershipId- 9
)9 :
;: ;
Task 
< 	
Result	 
< 
Unit 
, !
AuthenticationFailure +
>+ ,
>, -
ClearAllCacheAsync. @
(@ A
stringA G
membershipIdH T
)T U
;U V
Task 
< 	
Result	 
< 
Unit 
, !
AuthenticationFailure +
>+ ,
>, -
StoreIdentityAsync. @
(@ A$
SodiumSecureMemoryHandleA Y
masterKeyHandleZ i
,i j
stringk q
membershipIdr ~
)~ 
;	 €
Task 
< 	
Result	 
< $
SodiumSecureMemoryHandle (
,( )!
AuthenticationFailure* ?
>? @
>@ A$
LoadMasterKeyHandleAsyncB Z
(Z [
string[ a
membershipIdb n
)n o
;o p
Task 
< 	
Result	 
< 
Unit 
, 
	Exception 
>  
>  !/
#CleanupMembershipStateWithKeysAsync" E
(E F
stringF L
membershipIdM Y
,Y Z
uint[ _
	connectId` i
)i j
;j k
} Ú
•/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Services/Abstractions/Authentication/IAuthenticationService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Services  
.  !
Abstractions! -
.- .
Authentication. <
;< =
public		 
	interface		 "
IAuthenticationService		 '
{

 
Task 
< 	
Result	 
< 
Unit 
, !
AuthenticationFailure +
>+ ,
>, -
SignInAsync. 9
(9 :
string: @
mobileNumberA M
,M N
SecureTextBufferO _
	secureKey` i
,i j
uintk o
	connectIdp y
,y z
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
;6 7
} ó
x/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Models/Membership/LogoutReason.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Models 
. 

Membership )
;) *
public 
enum 
LogoutReason 
{ 
UserInitiated 
, 
SESSION_EXPIRED 
, 
SessionTimeout 
, 
DeviceRemoved 
, 
SecurityViolation		 
,		 
AccountDeactivated

 
,

 
SecureKeyChanged 
, 
ForceLogout 
, 
SystemMaintenance 
} ª
”/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Serialization/EcliptixJsonSerializerContext.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Serialization' 4
;4 5
[ '
JsonSourceGenerationOptions 
(  
PropertyNamingPolicy 
= !
JsonKnownNamingPolicy 0
.0 1
	CamelCase1 :
,: ;
WriteIndented		 
=		 
false		 
,		 
GenerationMode

 
=

 $
JsonSourceGenerationMode

 -
.

- .
Metadata

. 6
|

7 8$
JsonSourceGenerationMode

9 Q
.

Q R
Serialization

R _
,

_ `"
DefaultIgnoreCondition 
= 
JsonIgnoreCondition 0
.0 1
WhenWritingNull1 @
,@ A"
UseStringEnumConverter 
= 
true !
)! "
]" #
[ 
JsonSerializable 
( 
typeof 
( 
	BuildInfo "
)" #
)# $
]$ %
[ 
JsonSerializable 
( 
typeof 
( !
DefaultSystemSettings .
). /
)/ 0
]0 1
public 
partial 
class )
EcliptixJsonSerializerContext 2
:3 4!
JsonSerializerContext5 J
{ 
public 

static !
JsonSerializerOptions '
DefaultOptions( 6
=>7 9
new: =
(= >
)> ?
{  
PropertyNamingPolicy 
= 
JsonNamingPolicy /
./ 0
	CamelCase0 9
,9 :
WriteIndented 
= 
false 
, "
DefaultIgnoreCondition 
=  
JsonIgnoreCondition! 4
.4 5
WhenWritingNull5 D
,D E
TypeInfoResolver 
= 
Default "
} 
; 
} ¢Ì
”/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Storage/SecureProtocolStateStorage.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Storage0 7
;7 8
public 
sealed 
class &
SecureProtocolStateStorage .
:/ 0'
ISecureProtocolStateStorage1 L
,L M
IDisposableN Y
{ 
private 
const 
string 
KeychainPrefix '
=( )
$str* 9
;9 :
private 
static 
readonly 
Encoding $
Utf8% )
=* +
Encoding, 4
.4 5
UTF85 9
;9 :
private 
static 
readonly 
Encoding $
Ascii% *
=+ ,
Encoding- 5
.5 6
ASCII6 ;
;; <
private 
static 
readonly 
byte  
[  !
]! "
MagicHeaderBytes# 3
=4 5
Ascii6 ;
.; <
GetBytes< D
(D E"
SecureStorageConstantsE [
.[ \
Header\ b
.b c
MAGIC_HEADERc o
)o p
;p q
private 
static 
readonly 
char  
[  !
]! " 
InvalidFileNameChars# 7
=8 9
Path: >
.> ?#
GetInvalidFileNameChars? V
(V W
)W X
;X Y
private 
static 
readonly 
HashSet #
<# $
char$ (
>( )'
InvalidFileNameCharacterSet* E
=F G
newH K
(K L 
InvalidFileNameCharsL `
)` a
;a b
private 
readonly %
IPlatformSecurityProvider .
_platformProvider/ @
;@ A
private 
readonly 
string 
_storageDirectory -
;- .
private 
readonly 
byte 
[ 
] 
	_deviceId %
;% &
private!! 
byte!! 
[!! 
]!! 
?!! 
_cachedHmacKey!! "
;!!" #
private"" 
bool"" 
	_disposed"" 
;"" 
public$$ 
&
SecureProtocolStateStorage$$ %
($$% &%
IPlatformSecurityProvider$$& ?
platformProvider$$@ P
,$$P Q
string$$R X
storageDirectory$$Y i
,$$i j
byte%% 
[%% 
]%% 
deviceId%% 
)%% 
{&& 
_platformProvider'' 
='' 
platformProvider'' ,
;'', -
_storageDirectory(( 
=(( 
storageDirectory(( ,
;((, -
	_deviceId)) 
=)) 
deviceId)) 
;)) '
EnsureSecureDirectoryExists++ #
(++# $
)++$ %
;++% &
},, 
public.. 

async.. 
Task.. 
<.. 
Result.. 
<.. 
Unit.. !
,..! " 
SecureStorageFailure..# 7
>..7 8
>..8 9
SaveStateAsync..: H
(..H I
byte// 
[// 
]// 
protocolState// 
,// 
string00 
	connectId00 
,00 
byte11 
[11 
]11 
membershipId11 
)11 
{22 
if33 

(33 
!33  
TryEnsureNotDisposed33 !
(33! "
out33" % 
SecureStorageFailure33& :
?33: ;
failure33< C
)33C D
)33D E
{44 	
return55 
Result55 
<55 
Unit55 
,55  
SecureStorageFailure55  4
>554 5
.555 6
Err556 9
(559 :
failure55: A
!55A B
)55B C
;55C D
}66 	
string88 
storagePath88 
=88 
GetStorageFilePath88 /
(88/ 0
	connectId880 9
)889 :
;88: ;
string99 
keychainKey99 
=99 
BuildKeychainKey99 -
(99- .
	connectId99. 7
)997 8
;998 9
byte;; 
[;; 
];; 
?;; 
encryptionKey;; 
=;; 
null;;  $
;;;$ %
byte<< 
[<< 
]<< 
?<< 
salt<< 
=<< 
null<< 
;<< 
byte== 
[== 
]== 
?== 
nonce== 
=== 
null== 
;== 
byte>> 
[>> 
]>> 
?>> 
tag>> 
=>> 
null>> 
;>> 
byte?? 
[?? 
]?? 
??? 

ciphertext?? 
=?? 
null?? !
;??! "
byte@@ 
[@@ 
]@@ 
?@@ 
containerBytes@@ 
=@@  
null@@! %
;@@% &
byteAA 
[AA 
]AA 
?AA 
protectedContainerAA "
=AA# $
nullAA% )
;AA) *
byteBB 
[BB 
]BB 
?BB 
associatedDataBB 
=BB  
nullBB! %
;BB% &
tryDD 
{EE 	
(FF 
encryptionKeyFF 
,FF 
saltFF  
)FF  !
=FF" #
awaitFF$ )
DeriveKeyAsyncFF* 8
(FF8 9
membershipIdFF9 E
)FFE F
.FFF G
ConfigureAwaitFFG U
(FFU V
falseFFV [
)FF[ \
;FF\ ]
nonceGG 
=GG 
awaitGG 
_platformProviderGG +
.GG+ ,%
GenerateSecureRandomAsyncGG, E
(GGE F"
SecureStorageConstantsGGF \
.GG\ ]

EncryptionGG] g
.GGg h

NONCE_SIZEGGh r
)GGr s
.HH 
ConfigureAwaitHH 
(HH  
falseHH  %
)HH% &
;HH& '
associatedDataJJ 
=JJ  
CreateAssociatedDataJJ 1
(JJ1 2
	connectIdJJ2 ;
,JJ; <
	_deviceIdJJ= F
)JJF G
;JJG H
(LL 

ciphertextLL 
,LL 
tagLL 
)LL 
=LL 
EncryptStateLL  ,
(LL, -
protocolStateLL- :
,LL: ;
encryptionKeyLL< I
,LLI J
nonceLLK P
,LLP Q
associatedDataLLR `
)LL` a
;LLa b
containerBytesNN 
=NN 
SerializeContainerNN /
(NN/ 0
newNN0 3
SecureContainerNN4 C
(NNC D
saltNND H
,NNH I
nonceNNJ O
,NNO P
tagNNQ T
,NNT U

ciphertextNNV `
,NN` a
associatedDataNNb p
)NNp q
)NNq r
;NNr s
protectedContainerOO 
=OO  
awaitOO! &$
AddTamperProtectionAsyncOO' ?
(OO? @
containerBytesOO@ N
)OON O
.OOO P
ConfigureAwaitOOP ^
(OO^ _
falseOO_ d
)OOd e
;OOe f
awaitQQ  
WriteSecureFileAsyncQQ &
(QQ& '
protectedContainerQQ' 9
,QQ9 :
storagePathQQ; F
)QQF G
.QQG H
ConfigureAwaitQQH V
(QQV W
falseQQW \
)QQ\ ]
;QQ] ^
awaitSS 
_platformProviderSS #
.SS# $#
StoreKeyInKeychainAsyncSS$ ;
(SS; <
keychainKeySS< G
,SSG H
encryptionKeySSI V
)SSV W
.SSW X
ConfigureAwaitSSX f
(SSf g
falseSSg l
)SSl m
;SSm n
returnUU 
ResultUU 
<UU 
UnitUU 
,UU  
SecureStorageFailureUU  4
>UU4 5
.UU5 6
OkUU6 8
(UU8 9
UnitUU9 =
.UU= >
ValueUU> C
)UUC D
;UUD E
}VV 	
catchWW 
(WW 
	ExceptionWW 
exWW 
)WW 
whenWW !
(WW" #
exWW# %
isWW& (
notWW) , 
OutOfMemoryExceptionWW- A
)WWA B
{XX 	
awaitYY "
CleanupFailedSaveAsyncYY (
(YY( )
storagePathYY) 4
,YY4 5
keychainKeyYY6 A
)YYA B
.YYB C
ConfigureAwaitYYC Q
(YYQ R
falseYYR W
)YYW X
;YYX Y
return[[ 
Result[[ 
<[[ 
Unit[[ 
,[[  
SecureStorageFailure[[  4
>[[4 5
.[[5 6
Err[[6 9
([[9 :
new\\  
SecureStorageFailure\\ (
(\\( )
string]] 
.]] 
Format]] !
(]]! "$
ApplicationErrorMessages]]" :
.]]: ;&
SecureProtocolStateStorage]]; U
.]]U V
SAVE_FAILED]]V a
,]]a b
ex]]c e
.]]e f
Message]]f m
)]]m n
)]]n o
)]]o p
;]]p q
}^^ 	
finally__ 
{`` 	

ZeroBufferaa 
(aa 
encryptionKeyaa $
)aa$ %
;aa% &

ZeroBufferbb 
(bb 
saltbb 
)bb 
;bb 

ZeroBuffercc 
(cc 
noncecc 
)cc 
;cc 

ZeroBufferdd 
(dd 
tagdd 
)dd 
;dd 

ZeroBufferee 
(ee 

ciphertextee !
)ee! "
;ee" #

ZeroBufferff 
(ff 
containerBytesff %
)ff% &
;ff& '

ZeroBuffergg 
(gg 
protectedContainergg )
)gg) *
;gg* +

ZeroBufferhh 
(hh 
associatedDatahh %
)hh% &
;hh& '

ZeroBufferii 
(ii 
protocolStateii $
)ii$ %
;ii% &
}jj 	
}kk 
publicmm 

asyncmm 
Taskmm 
<mm 
Resultmm 
<mm 
bytemm !
[mm! "
]mm" #
,mm# $ 
SecureStorageFailuremm% 9
>mm9 :
>mm: ;
LoadStateAsyncmm< J
(mmJ K
stringmmK Q
	connectIdmmR [
,mm[ \
bytemm] a
[mma b
]mmb c
membershipIdmmd p
)mmp q
{nn 
ifoo 

(oo 
!oo  
TryEnsureNotDisposedoo !
(oo! "
outoo" % 
SecureStorageFailureoo& :
?oo: ;
failureoo< C
)ooC D
)ooD E
{pp 	
returnqq 
Resultqq 
<qq 
byteqq 
[qq 
]qq  
,qq  ! 
SecureStorageFailureqq" 6
>qq6 7
.qq7 8
Errqq8 ;
(qq; <
failureqq< C
!qqC D
)qqD E
;qqE F
}rr 	
stringtt 
storagePathtt 
=tt 
GetStorageFilePathtt /
(tt/ 0
	connectIdtt0 9
)tt9 :
;tt: ;
stringuu 
keychainKeyuu 
=uu 
BuildKeychainKeyuu -
(uu- .
	connectIduu. 7
)uu7 8
;uu8 9
byteww 
[ww 
]ww 
?ww 
protectedContainerww "
=ww# $
nullww% )
;ww) *
bytexx 
[xx 
]xx 
?xx 
containerBytesxx 
=xx  
nullxx! %
;xx% &
SecureContaineryy 
	containeryy !
=yy" #
defaultyy$ +
;yy+ ,
boolzz  
containerInitializedzz !
=zz" #
falsezz$ )
;zz) *
byte{{ 
[{{ 
]{{ 
?{{ 
encryptionKey{{ 
={{ 
null{{  $
;{{$ %
byte|| 
[|| 
]|| 
?|| "
expectedAssociatedData|| &
=||' (
null||) -
;||- .
try~~ 
{ 	
Option
€€ 
<
€€ 
byte
€€ 
[
€€ 
]
€€ 
>
€€ &
protectedContainerOption
€€ 3
=
€€4 5
await
€€6 ;!
ReadSecureFileAsync
€€< O
(
€€O P
storagePath
€€P [
)
€€[ \
.
€€\ ]
ConfigureAwait
€€] k
(
€€k l
false
€€l q
)
€€q r
;
€€r s
if
 
(
 
!
 &
protectedContainerOption
 )
.
) *
IsSome
* 0
)
0 1
{
‚‚ 
return
ƒƒ 
Result
ƒƒ 
<
ƒƒ 
byte
ƒƒ "
[
ƒƒ" #
]
ƒƒ# $
,
ƒƒ$ %"
SecureStorageFailure
ƒƒ& :
>
ƒƒ: ;
.
ƒƒ; <
Err
ƒƒ< ?
(
ƒƒ? @
new
„„ "
SecureStorageFailure
„„ ,
(
„„, -&
ApplicationErrorMessages
„„- E
.
„„E F(
SecureProtocolStateStorage
„„F `
.
„„` a"
STATE_FILE_NOT_FOUND
„„a u
)
„„u v
)
„„v w
;
„„w x
}
……  
protectedContainer
‡‡ 
=
‡‡  &
protectedContainerOption
‡‡! 9
.
‡‡9 :
Value
‡‡: ?
!
‡‡? @
;
‡‡@ A
Result
‰‰ 
<
‰‰ 
byte
‰‰ 
[
‰‰ 
]
‰‰ 
,
‰‰ "
SecureStorageFailure
‰‰ /
>
‰‰/ 0
verifiedResult
‰‰1 ?
=
‰‰@ A
await
ŠŠ )
VerifyTamperProtectionAsync
ŠŠ 1
(
ŠŠ1 2 
protectedContainer
ŠŠ2 D
)
ŠŠD E
.
ŠŠE F
ConfigureAwait
ŠŠF T
(
ŠŠT U
false
ŠŠU Z
)
ŠŠZ [
;
ŠŠ[ \
if
ŒŒ 
(
ŒŒ 
verifiedResult
ŒŒ 
.
ŒŒ 
IsErr
ŒŒ $
)
ŒŒ$ %
{
 
return
ŽŽ 
Result
ŽŽ 
<
ŽŽ 
byte
ŽŽ "
[
ŽŽ" #
]
ŽŽ# $
,
ŽŽ$ %"
SecureStorageFailure
ŽŽ& :
>
ŽŽ: ;
.
ŽŽ; <
Err
ŽŽ< ?
(
ŽŽ? @
verifiedResult
ŽŽ@ N
.
ŽŽN O
	UnwrapErr
ŽŽO X
(
ŽŽX Y
)
ŽŽY Z
)
ŽŽZ [
;
ŽŽ[ \
}
 
containerBytes
‘‘ 
=
‘‘ 
verifiedResult
‘‘ +
.
‘‘+ ,
Unwrap
‘‘, 2
(
‘‘2 3
)
‘‘3 4
;
‘‘4 5
	container
’’ 
=
’’ "
ParseSecureContainer
’’ ,
(
’’, -
containerBytes
’’- ;
)
’’; <
;
’’< ="
containerInitialized
““  
=
““! "
true
““# '
;
““' ($
expectedAssociatedData
•• "
=
••# $"
CreateAssociatedData
••% 9
(
••9 :
	connectId
••: C
,
••C D
	_deviceId
••E N
)
••N O
;
••O P
if
–– 
(
–– 
!
–– %
CryptographicOperations
–– (
.
––( )
FixedTimeEquals
––) 8
(
––8 9
	container
––9 B
.
––B C
AssociatedData
––C Q
,
––Q R$
expectedAssociatedData
––S i
)
––i j
)
––j k
{
—— 
return
˜˜ 
Result
˜˜ 
<
˜˜ 
byte
˜˜ "
[
˜˜" #
]
˜˜# $
,
˜˜$ %"
SecureStorageFailure
˜˜& :
>
˜˜: ;
.
˜˜; <
Err
˜˜< ?
(
˜˜? @
new
™™ "
SecureStorageFailure
™™ ,
(
™™, -&
ApplicationErrorMessages
šš 0
.
šš0 1(
SecureProtocolStateStorage
šš1 K
.
ššK L&
ASSOCIATED_DATA_MISMATCH
ššL d
)
ššd e
)
šše f
;
ššf g
}
›› 
Option
 
<
 
byte
 
[
 
]
 
>
 
storedKeyOption
 *
=
+ ,
await
- 2"
TryGetStoredKeyAsync
3 G
(
G H
keychainKey
H S
)
S T
.
T U
ConfigureAwait
U c
(
c d
false
d i
)
i j
;
j k
bool
žž 

derivedKey
žž 
=
žž 
!
žž 
storedKeyOption
žž .
.
žž. /
IsSome
žž/ 5
;
žž5 6
if
ŸŸ 
(
ŸŸ 
storedKeyOption
ŸŸ 
.
ŸŸ  
IsSome
ŸŸ  &
)
ŸŸ& '
{
   
encryptionKey
¡¡ 
=
¡¡ 
storedKeyOption
¡¡  /
.
¡¡/ 0
Value
¡¡0 5
!
¡¡5 6
;
¡¡6 7
}
¢¢ 
else
££ 
{
¤¤ 
(
¥¥ 
encryptionKey
¥¥ 
,
¥¥ 
_
¥¥  !
)
¥¥! "
=
¥¥# $
await
¥¥% *$
DeriveKeyWithSaltAsync
¥¥+ A
(
¥¥A B
membershipId
¥¥B N
,
¥¥N O
	container
¥¥P Y
.
¥¥Y Z
Salt
¥¥Z ^
)
¥¥^ _
.
¥¥_ `
ConfigureAwait
¥¥` n
(
¥¥n o
false
¥¥o t
)
¥¥t u
;
¥¥u v
}
¦¦ 
byte
¨¨ 
[
¨¨ 
]
¨¨ 
	plaintext
¨¨ 
=
¨¨ 
DecryptState
©© 
(
©© 
	container
©© &
.
©©& '

Ciphertext
©©' 1
,
©©1 2
encryptionKey
©©3 @
,
©©@ A
	container
©©B K
.
©©K L
Nonce
©©L Q
,
©©Q R
	container
©©S \
.
©©\ ]
Tag
©©] `
,
©©` a
	container
ªª 
.
ªª 
AssociatedData
ªª ,
)
ªª, -
;
ªª- .
if
¬¬ 
(
¬¬ 

derivedKey
¬¬ 
)
¬¬ 
{
­­ 
await
®® 
_platformProvider
®® '
.
®®' (%
StoreKeyInKeychainAsync
®®( ?
(
®®? @
keychainKey
®®@ K
,
®®K L
encryptionKey
®®M Z
!
®®Z [
)
®®[ \
.
®®\ ]
ConfigureAwait
®®] k
(
®®k l
false
®®l q
)
®®q r
;
®®r s
}
¯¯ 
return
±± 
Result
±± 
<
±± 
byte
±± 
[
±± 
]
±±  
,
±±  !"
SecureStorageFailure
±±" 6
>
±±6 7
.
±±7 8
Ok
±±8 :
(
±±: ;
	plaintext
±±; D
)
±±D E
;
±±E F
}
²² 	
catch
³³ 
(
³³ 
	Exception
³³ 
ex
³³ 
)
³³ 
when
³³ !
(
³³" #
ex
³³# %
is
³³& (
not
³³) ,"
OutOfMemoryException
³³- A
)
³³A B
{
´´ 	
return
µµ 
Result
µµ 
<
µµ 
byte
µµ 
[
µµ 
]
µµ  
,
µµ  !"
SecureStorageFailure
µµ" 6
>
µµ6 7
.
µµ7 8
Err
µµ8 ;
(
µµ; <
new
¶¶ "
SecureStorageFailure
¶¶ (
(
¶¶( )
string
·· 
.
·· 
Format
·· !
(
··! "&
ApplicationErrorMessages
··" :
.
··: ;(
SecureProtocolStateStorage
··; U
.
··U V
LOAD_FAILED
··V a
,
··a b
ex
··c e
.
··e f
Message
··f m
)
··m n
)
··n o
)
··o p
;
··p q
}
¸¸ 	
finally
¹¹ 
{
ºº 	

ZeroBuffer
»» 
(
»»  
protectedContainer
»» )
)
»») *
;
»»* +

ZeroBuffer
¼¼ 
(
¼¼ 
containerBytes
¼¼ %
)
¼¼% &
;
¼¼& '

ZeroBuffer
½½ 
(
½½ $
expectedAssociatedData
½½ -
)
½½- .
;
½½. /
if
¿¿ 
(
¿¿ "
containerInitialized
¿¿ $
)
¿¿$ %
{
ÀÀ 

ZeroBuffer
ÁÁ 
(
ÁÁ 
	container
ÁÁ $
.
ÁÁ$ %
Salt
ÁÁ% )
)
ÁÁ) *
;
ÁÁ* +

ZeroBuffer
ÂÂ 
(
ÂÂ 
	container
ÂÂ $
.
ÂÂ$ %
Nonce
ÂÂ% *
)
ÂÂ* +
;
ÂÂ+ ,

ZeroBuffer
ÃÃ 
(
ÃÃ 
	container
ÃÃ $
.
ÃÃ$ %
Tag
ÃÃ% (
)
ÃÃ( )
;
ÃÃ) *

ZeroBuffer
ÄÄ 
(
ÄÄ 
	container
ÄÄ $
.
ÄÄ$ %

Ciphertext
ÄÄ% /
)
ÄÄ/ 0
;
ÄÄ0 1

ZeroBuffer
ÅÅ 
(
ÅÅ 
	container
ÅÅ $
.
ÅÅ$ %
AssociatedData
ÅÅ% 3
)
ÅÅ3 4
;
ÅÅ4 5
}
ÆÆ 

ZeroBuffer
ÈÈ 
(
ÈÈ 
encryptionKey
ÈÈ $
)
ÈÈ$ %
;
ÈÈ% &
}
ÉÉ 	
}
ÊÊ 
public
ÌÌ 

async
ÌÌ 
Task
ÌÌ 
<
ÌÌ 
Result
ÌÌ 
<
ÌÌ 
Unit
ÌÌ !
,
ÌÌ! ""
SecureStorageFailure
ÌÌ# 7
>
ÌÌ7 8
>
ÌÌ8 9
DeleteStateAsync
ÌÌ: J
(
ÌÌJ K
string
ÌÌK Q
key
ÌÌR U
)
ÌÌU V
{
ÍÍ 
if
ÎÎ 

(
ÎÎ 
!
ÎÎ "
TryEnsureNotDisposed
ÎÎ !
(
ÎÎ! "
out
ÎÎ" %"
SecureStorageFailure
ÎÎ& :
?
ÎÎ: ;
failure
ÎÎ< C
)
ÎÎC D
)
ÎÎD E
{
ÏÏ 	
return
ÐÐ 
Result
ÐÐ 
<
ÐÐ 
Unit
ÐÐ 
,
ÐÐ "
SecureStorageFailure
ÐÐ  4
>
ÐÐ4 5
.
ÐÐ5 6
Err
ÐÐ6 9
(
ÐÐ9 :
failure
ÐÐ: A
!
ÐÐA B
)
ÐÐB C
;
ÐÐC D
}
ÑÑ 	
string
ÓÓ 
storagePath
ÓÓ 
=
ÓÓ  
GetStorageFilePath
ÓÓ /
(
ÓÓ/ 0
key
ÓÓ0 3
)
ÓÓ3 4
;
ÓÓ4 5
string
ÔÔ 
keychainKey
ÔÔ 
=
ÔÔ 
BuildKeychainKey
ÔÔ -
(
ÔÔ- .
key
ÔÔ. 1
)
ÔÔ1 2
;
ÔÔ2 3
try
ÖÖ 
{
×× 	
await
ØØ %
DeleteFileIfExistsAsync
ØØ )
(
ØØ) *
storagePath
ØØ* 5
)
ØØ5 6
.
ØØ6 7
ConfigureAwait
ØØ7 E
(
ØØE F
false
ØØF K
)
ØØK L
;
ØØL M
await
ÙÙ 
_platformProvider
ÙÙ #
.
ÙÙ# $(
DeleteKeyFromKeychainAsync
ÙÙ$ >
(
ÙÙ> ?
keychainKey
ÙÙ? J
)
ÙÙJ K
.
ÙÙK L
ConfigureAwait
ÙÙL Z
(
ÙÙZ [
false
ÙÙ[ `
)
ÙÙ` a
;
ÙÙa b
return
ÛÛ 
Result
ÛÛ 
<
ÛÛ 
Unit
ÛÛ 
,
ÛÛ "
SecureStorageFailure
ÛÛ  4
>
ÛÛ4 5
.
ÛÛ5 6
Ok
ÛÛ6 8
(
ÛÛ8 9
Unit
ÛÛ9 =
.
ÛÛ= >
Value
ÛÛ> C
)
ÛÛC D
;
ÛÛD E
}
ÜÜ 	
catch
ÝÝ 
(
ÝÝ 
	Exception
ÝÝ 
ex
ÝÝ 
)
ÝÝ 
when
ÝÝ !
(
ÝÝ" #
ex
ÝÝ# %
is
ÝÝ& (
not
ÝÝ) ,"
OutOfMemoryException
ÝÝ- A
)
ÝÝA B
{
ÞÞ 	
return
ßß 
Result
ßß 
<
ßß 
Unit
ßß 
,
ßß "
SecureStorageFailure
ßß  4
>
ßß4 5
.
ßß5 6
Err
ßß6 9
(
ßß9 :
new
àà "
SecureStorageFailure
àà (
(
àà( )
string
áá 
.
áá 
Format
áá !
(
áá! "&
ApplicationErrorMessages
áá" :
.
áá: ;(
SecureProtocolStateStorage
áá; U
.
ááU V
DELETE_FAILED
ááV c
,
áác d
ex
ááe g
.
áág h
Message
ááh o
)
ááo p
)
ááp q
)
ááq r
;
áár s
}
ââ 	
}
ãã 
public
åå 

void
åå 
Dispose
åå 
(
åå 
)
åå 
{
ææ 
if
çç 

(
çç 
	_disposed
çç 
)
çç 
{
èè 	
return
éé 
;
éé 
}
êê 	
byte
ìì 
[
ìì 
]
ìì 
?
ìì 
cachedHmacKey
ìì 
=
ìì 
Interlocked
ìì  +
.
ìì+ ,
Exchange
ìì, 4
(
ìì4 5
ref
ìì5 8
_cachedHmacKey
ìì9 G
,
ììG H
null
ììI M
)
ììM N
;
ììN O
if
íí 

(
íí 
cachedHmacKey
íí 
!=
íí 
null
íí !
)
íí! "
{
îî 	

ZeroBuffer
ïï 
(
ïï 
cachedHmacKey
ïï $
)
ïï$ %
;
ïï% &
}
ðð 	
	_disposed
òò 
=
òò 
true
òò 
;
òò 
}
óó 
private
õõ 
static
õõ 
string
õõ 
BuildKeychainKey
õõ *
(
õõ* +
string
õõ+ 1
	connectId
õõ2 ;
)
õõ; <
=>
õõ= ?
$"
õõ@ B
{
õõB C
KeychainPrefix
õõC Q
}
õõQ R
{
õõR S
	connectId
õõS \
}
õõ\ ]
"
õõ] ^
;
õõ^ _
private
÷÷ 
string
÷÷  
GetStorageFilePath
÷÷ %
(
÷÷% &
string
÷÷& ,
	connectId
÷÷- 6
)
÷÷6 7
{
øø 
string
ùù 
sanitizedKey
ùù 
=
ùù 
SanitizeFilename
ùù .
(
ùù. /
	connectId
ùù/ 8
)
ùù8 9
;
ùù9 :
return
úú 
Path
úú 
.
úú 
Combine
úú 
(
úú 
_storageDirectory
úú -
,
úú- .
$"
úú/ 1
{
úú1 2
sanitizedKey
úú2 >
}
úú> ?
$str
úú? H
"
úúH I
)
úúI J
;
úúJ K
}
ûû 
private
ýý 
static
ýý 
string
ýý 
SanitizeFilename
ýý *
(
ýý* +
string
ýý+ 1
key
ýý2 5
)
ýý5 6
{
þþ 
if
ÿÿ 

(
ÿÿ 
string
ÿÿ 
.
ÿÿ 
IsNullOrEmpty
ÿÿ  
(
ÿÿ  !
key
ÿÿ! $
)
ÿÿ$ %
)
ÿÿ% &
{
€€ 	
return
 
$str
 
;
 
}
‚‚ 	
if
„„ 

(
„„ 
key
„„ 
.
„„ 

IndexOfAny
„„ 
(
„„ "
InvalidFileNameChars
„„ /
)
„„/ 0
<
„„1 2
$num
„„3 4
)
„„4 5
{
…… 	
return
†† 
key
†† 
;
†† 
}
‡‡ 	
char
‰‰ 
[
‰‰ 
]
‰‰ 

characters
‰‰ 
=
‰‰ 
key
‰‰ 
.
‰‰  
ToCharArray
‰‰  +
(
‰‰+ ,
)
‰‰, -
;
‰‰- .
for
ŠŠ 
(
ŠŠ 
int
ŠŠ 
i
ŠŠ 
=
ŠŠ 
$num
ŠŠ 
;
ŠŠ 
i
ŠŠ 
<
ŠŠ 

characters
ŠŠ &
.
ŠŠ& '
Length
ŠŠ' -
;
ŠŠ- .
i
ŠŠ/ 0
++
ŠŠ0 2
)
ŠŠ2 3
{
‹‹ 	
if
ŒŒ 
(
ŒŒ )
InvalidFileNameCharacterSet
ŒŒ +
.
ŒŒ+ ,
Contains
ŒŒ, 4
(
ŒŒ4 5

characters
ŒŒ5 ?
[
ŒŒ? @
i
ŒŒ@ A
]
ŒŒA B
)
ŒŒB C
)
ŒŒC D
{
 

characters
ŽŽ 
[
ŽŽ 
i
ŽŽ 
]
ŽŽ 
=
ŽŽ 
$char
ŽŽ  #
;
ŽŽ# $
}
 
}
 	
return
’’ 
new
’’ 
string
’’ 
(
’’ 

characters
’’ $
)
’’$ %
;
’’% &
}
““ 
private
•• 
static
•• 
byte
•• 
[
•• 
]
•• "
CreateAssociatedData
•• .
(
••. /
string
••/ 5
	connectId
••6 ?
,
••? @
byte
••A E
[
••E F
]
••F G
deviceId
••H P
)
••P Q
{
–– 
byte
—— 
[
—— 
]
—— 
connectIdBytes
—— 
=
—— 
Utf8
——  $
.
——$ %
GetBytes
——% -
(
——- .
	connectId
——. 7
)
——7 8
;
——8 9
byte
˜˜ 
[
˜˜ 
]
˜˜ 
associatedData
˜˜ 
=
˜˜ 
new
˜˜  #
byte
˜˜$ (
[
˜˜( )
sizeof
˜˜) /
(
˜˜/ 0
int
˜˜0 3
)
˜˜3 4
+
˜˜5 6
connectIdBytes
˜˜7 E
.
˜˜E F
Length
˜˜F L
+
˜˜M N
deviceId
˜˜O W
.
˜˜W X
Length
˜˜X ^
]
˜˜^ _
;
˜˜_ `
BinaryPrimitives
šš 
.
šš $
WriteInt32LittleEndian
šš /
(
šš/ 0
associatedData
šš0 >
.
šš> ?
AsSpan
šš? E
(
ššE F
$num
ššF G
,
ššG H
sizeof
ššI O
(
ššO P
int
ššP S
)
ššS T
)
ššT U
,
ššU V$
SecureStorageConstants
›› "
.
››" #
Header
››# )
.
››) *
CURRENT_VERSION
››* 9
)
››9 :
;
››: ;
connectIdBytes
œœ 
.
œœ 
CopyTo
œœ 
(
œœ 
associatedData
œœ ,
.
œœ, -
AsSpan
œœ- 3
(
œœ3 4
sizeof
œœ4 :
(
œœ: ;
int
œœ; >
)
œœ> ?
)
œœ? @
)
œœ@ A
;
œœA B
deviceId
 
.
 
CopyTo
 
(
 
associatedData
 &
.
& '
AsSpan
' -
(
- .
sizeof
. 4
(
4 5
int
5 8
)
8 9
+
: ;
connectIdBytes
< J
.
J K
Length
K Q
)
Q R
)
R S
;
S T
return
ŸŸ 
associatedData
ŸŸ 
;
ŸŸ 
}
   
private
¢¢ 
static
¢¢ 
(
¢¢ 
byte
¢¢ 
[
¢¢ 
]
¢¢ 

Ciphertext
¢¢ %
,
¢¢% &
byte
¢¢' +
[
¢¢+ ,
]
¢¢, -
Tag
¢¢. 1
)
¢¢1 2
EncryptState
¢¢3 ?
(
¢¢? @
byte
££ 
[
££ 
]
££ 
	plaintext
££ 
,
££ 
byte
¤¤ 
[
¤¤ 
]
¤¤ 
key
¤¤ 
,
¤¤ 
byte
¥¥ 
[
¥¥ 
]
¥¥ 
nonce
¥¥ 
,
¥¥ 
byte
¦¦ 
[
¦¦ 
]
¦¦ 
associatedData
¦¦ 
)
¦¦ 
{
§§ 
using
¨¨ 
AesGcm
¨¨ 
aesGcm
¨¨ 
=
¨¨ 
new
¨¨ !
(
¨¨! "
key
¨¨" %
,
¨¨% &$
SecureStorageConstants
¨¨' =
.
¨¨= >

Encryption
¨¨> H
.
¨¨H I
TAG_SIZE
¨¨I Q
)
¨¨Q R
;
¨¨R S
byte
©© 
[
©© 
]
©© 

ciphertext
©© 
=
©© 
new
©© 
byte
©©  $
[
©©$ %
	plaintext
©©% .
.
©©. /
Length
©©/ 5
]
©©5 6
;
©©6 7
byte
ªª 
[
ªª 
]
ªª 
tag
ªª 
=
ªª 
new
ªª 
byte
ªª 
[
ªª $
SecureStorageConstants
ªª 4
.
ªª4 5

Encryption
ªª5 ?
.
ªª? @
TAG_SIZE
ªª@ H
]
ªªH I
;
ªªI J
aesGcm
¬¬ 
.
¬¬ 
Encrypt
¬¬ 
(
¬¬ 
nonce
¬¬ 
,
¬¬ 
	plaintext
¬¬ '
,
¬¬' (

ciphertext
¬¬) 3
,
¬¬3 4
tag
¬¬5 8
,
¬¬8 9
associatedData
¬¬: H
)
¬¬H I
;
¬¬I J
return
®® 
(
®® 

ciphertext
®® 
,
®® 
tag
®® 
)
®®  
;
®®  !
}
¯¯ 
private
±± 
static
±± 
byte
±± 
[
±± 
]
±± 
DecryptState
±± &
(
±±& '
byte
²² 
[
²² 
]
²² 

ciphertext
²² 
,
²² 
byte
³³ 
[
³³ 
]
³³ 
key
³³ 
,
³³ 
byte
´´ 
[
´´ 
]
´´ 
nonce
´´ 
,
´´ 
byte
µµ 
[
µµ 
]
µµ 
tag
µµ 
,
µµ 
byte
¶¶ 
[
¶¶ 
]
¶¶ 
associatedData
¶¶ 
)
¶¶ 
{
·· 
using
¸¸ 
AesGcm
¸¸ 
aesGcm
¸¸ 
=
¸¸ 
new
¸¸ !
(
¸¸! "
key
¸¸" %
,
¸¸% &$
SecureStorageConstants
¸¸' =
.
¸¸= >

Encryption
¸¸> H
.
¸¸H I
TAG_SIZE
¸¸I Q
)
¸¸Q R
;
¸¸R S
byte
¹¹ 
[
¹¹ 
]
¹¹ 
	plaintext
¹¹ 
=
¹¹ 
new
¹¹ 
byte
¹¹ #
[
¹¹# $

ciphertext
¹¹$ .
.
¹¹. /
Length
¹¹/ 5
]
¹¹5 6
;
¹¹6 7
aesGcm
»» 
.
»» 
Decrypt
»» 
(
»» 
nonce
»» 
,
»» 

ciphertext
»» (
,
»»( )
tag
»»* -
,
»»- .
	plaintext
»»/ 8
,
»»8 9
associatedData
»»: H
)
»»H I
;
»»I J
return
½½ 
	plaintext
½½ 
;
½½ 
}
¾¾ 
private
ÀÀ 
static
ÀÀ 
byte
ÀÀ 
[
ÀÀ 
]
ÀÀ  
SerializeContainer
ÀÀ ,
(
ÀÀ, -
SecureContainer
ÀÀ- <
	container
ÀÀ= F
)
ÀÀF G
{
ÁÁ 
int
ÂÂ 
	totalSize
ÂÂ 
=
ÂÂ 
MagicHeaderBytes
ÂÂ (
.
ÂÂ( )
Length
ÂÂ) /
+
ÂÂ0 1
sizeof
ÂÂ2 8
(
ÂÂ8 9
int
ÂÂ9 <
)
ÂÂ< =
+
ÂÂ> ?
SegmentSize
ÃÃ #
(
ÃÃ# $
	container
ÃÃ$ -
.
ÃÃ- .
Salt
ÃÃ. 2
.
ÃÃ2 3
Length
ÃÃ3 9
)
ÃÃ9 :
+
ÃÃ; <
SegmentSize
ÄÄ #
(
ÄÄ# $
	container
ÄÄ$ -
.
ÄÄ- .
Nonce
ÄÄ. 3
.
ÄÄ3 4
Length
ÄÄ4 :
)
ÄÄ: ;
+
ÄÄ< =
SegmentSize
ÅÅ #
(
ÅÅ# $
	container
ÅÅ$ -
.
ÅÅ- .
Tag
ÅÅ. 1
.
ÅÅ1 2
Length
ÅÅ2 8
)
ÅÅ8 9
+
ÅÅ: ;
SegmentSize
ÆÆ #
(
ÆÆ# $
	container
ÆÆ$ -
.
ÆÆ- .
AssociatedData
ÆÆ. <
.
ÆÆ< =
Length
ÆÆ= C
)
ÆÆC D
+
ÆÆE F
SegmentSize
ÇÇ #
(
ÇÇ# $
	container
ÇÇ$ -
.
ÇÇ- .

Ciphertext
ÇÇ. 8
.
ÇÇ8 9
Length
ÇÇ9 ?
)
ÇÇ? @
;
ÇÇ@ A
byte
ÉÉ 
[
ÉÉ 
]
ÉÉ 
buffer
ÉÉ 
=
ÉÉ 
new
ÉÉ 
byte
ÉÉ  
[
ÉÉ  !
	totalSize
ÉÉ! *
]
ÉÉ* +
;
ÉÉ+ ,
Span
ÊÊ 
<
ÊÊ 
byte
ÊÊ 
>
ÊÊ 
	writeSpan
ÊÊ 
=
ÊÊ 
buffer
ÊÊ %
.
ÊÊ% &
AsSpan
ÊÊ& ,
(
ÊÊ, -
)
ÊÊ- .
;
ÊÊ. /
MagicHeaderBytes
ÌÌ 
.
ÌÌ 
CopyTo
ÌÌ 
(
ÌÌ  
	writeSpan
ÌÌ  )
)
ÌÌ) *
;
ÌÌ* +
	writeSpan
ÍÍ 
=
ÍÍ 
	writeSpan
ÍÍ 
[
ÍÍ 
MagicHeaderBytes
ÍÍ .
.
ÍÍ. /
Length
ÍÍ/ 5
..
ÍÍ5 7
]
ÍÍ7 8
;
ÍÍ8 9
BinaryPrimitives
ÏÏ 
.
ÏÏ $
WriteInt32LittleEndian
ÏÏ /
(
ÏÏ/ 0
	writeSpan
ÏÏ0 9
,
ÏÏ9 :$
SecureStorageConstants
ÏÏ; Q
.
ÏÏQ R
Header
ÏÏR X
.
ÏÏX Y
CURRENT_VERSION
ÏÏY h
)
ÏÏh i
;
ÏÏi j
	writeSpan
ÐÐ 
=
ÐÐ 
	writeSpan
ÐÐ 
[
ÐÐ 
sizeof
ÐÐ $
(
ÐÐ$ %
int
ÐÐ% (
)
ÐÐ( )
..
ÐÐ) +
]
ÐÐ+ ,
;
ÐÐ, -
WriteSegment
ÒÒ 
(
ÒÒ 
	container
ÒÒ 
.
ÒÒ 
Salt
ÒÒ #
,
ÒÒ# $
ref
ÒÒ% (
	writeSpan
ÒÒ) 2
)
ÒÒ2 3
;
ÒÒ3 4
WriteSegment
ÓÓ 
(
ÓÓ 
	container
ÓÓ 
.
ÓÓ 
Nonce
ÓÓ $
,
ÓÓ$ %
ref
ÓÓ& )
	writeSpan
ÓÓ* 3
)
ÓÓ3 4
;
ÓÓ4 5
WriteSegment
ÔÔ 
(
ÔÔ 
	container
ÔÔ 
.
ÔÔ 
Tag
ÔÔ "
,
ÔÔ" #
ref
ÔÔ$ '
	writeSpan
ÔÔ( 1
)
ÔÔ1 2
;
ÔÔ2 3
WriteSegment
ÕÕ 
(
ÕÕ 
	container
ÕÕ 
.
ÕÕ 
AssociatedData
ÕÕ -
,
ÕÕ- .
ref
ÕÕ/ 2
	writeSpan
ÕÕ3 <
)
ÕÕ< =
;
ÕÕ= >
WriteSegment
ÖÖ 
(
ÖÖ 
	container
ÖÖ 
.
ÖÖ 

Ciphertext
ÖÖ )
,
ÖÖ) *
ref
ÖÖ+ .
	writeSpan
ÖÖ/ 8
)
ÖÖ8 9
;
ÖÖ9 :
return
ØØ 
buffer
ØØ 
;
ØØ 
}
ÙÙ 
private
ÛÛ 
static
ÛÛ 
SecureContainer
ÛÛ ""
ParseSecureContainer
ÛÛ# 7
(
ÛÛ7 8
byte
ÛÛ8 <
[
ÛÛ< =
]
ÛÛ= >
containerBytes
ÛÛ? M
)
ÛÛM N
{
ÜÜ 
ReadOnlySpan
ÝÝ 
<
ÝÝ 
byte
ÝÝ 
>
ÝÝ 
readSpan
ÝÝ #
=
ÝÝ$ %
containerBytes
ÝÝ& 4
.
ÝÝ4 5
AsSpan
ÝÝ5 ;
(
ÝÝ; <
)
ÝÝ< =
;
ÝÝ= >
if
ßß 

(
ßß 
readSpan
ßß 
.
ßß 
Length
ßß 
<
ßß 
MagicHeaderBytes
ßß .
.
ßß. /
Length
ßß/ 5
+
ßß6 7
sizeof
ßß8 >
(
ßß> ?
int
ßß? B
)
ßßB C
)
ßßC D
{
àà 	
throw
áá 
new
áá '
InvalidOperationException
áá /
(
áá/ 0&
ApplicationErrorMessages
ââ (
.
ââ( )(
SecureProtocolStateStorage
ââ) C
.
ââC D&
INVALID_CONTAINER_FORMAT
ââD \
)
ââ\ ]
;
ââ] ^
}
ãã 	
if
åå 

(
åå 
!
åå 
readSpan
åå 
[
åå 
..
åå 
MagicHeaderBytes
åå (
.
åå( )
Length
åå) /
]
åå/ 0
.
åå0 1
SequenceEqual
åå1 >
(
åå> ?
MagicHeaderBytes
åå? O
)
ååO P
)
ååP Q
{
ææ 	
throw
çç 
new
çç '
InvalidOperationException
çç /
(
çç/ 0&
ApplicationErrorMessages
èè (
.
èè( )(
SecureProtocolStateStorage
èè) C
.
èèC D&
INVALID_CONTAINER_FORMAT
èèD \
)
èè\ ]
;
èè] ^
}
éé 	
readSpan
ëë 
=
ëë 
readSpan
ëë 
[
ëë 
MagicHeaderBytes
ëë ,
.
ëë, -
Length
ëë- 3
..
ëë3 5
]
ëë5 6
;
ëë6 7
int
íí 
version
íí 
=
íí 
BinaryPrimitives
íí &
.
íí& '#
ReadInt32LittleEndian
íí' <
(
íí< =
readSpan
íí= E
)
ííE F
;
ííF G
if
îî 

(
îî 
version
îî 
!=
îî $
SecureStorageConstants
îî -
.
îî- .
Header
îî. 4
.
îî4 5
CURRENT_VERSION
îî5 D
)
îîD E
{
ïï 	
throw
ðð 
new
ðð '
InvalidOperationException
ðð /
(
ðð/ 0
string
ññ 
.
ññ 
Format
ññ 
(
ññ &
ApplicationErrorMessages
ññ 6
.
ññ6 7(
SecureProtocolStateStorage
ññ7 Q
.
ññQ R!
UNSUPPORTED_VERSION
ññR e
,
ññe f
version
ññg n
)
ññn o
)
ñño p
;
ññp q
}
òò 	
readSpan
ôô 
=
ôô 
readSpan
ôô 
[
ôô 
sizeof
ôô "
(
ôô" #
int
ôô# &
)
ôô& '
..
ôô' )
]
ôô) *
;
ôô* +
byte
öö 
[
öö 
]
öö 
salt
öö 
=
öö 
ReadSegment
öö !
(
öö! "
ref
öö" %
readSpan
öö& .
)
öö. /
;
öö/ 0
byte
÷÷ 
[
÷÷ 
]
÷÷ 
nonce
÷÷ 
=
÷÷ 
ReadSegment
÷÷ "
(
÷÷" #
ref
÷÷# &
readSpan
÷÷' /
)
÷÷/ 0
;
÷÷0 1
byte
øø 
[
øø 
]
øø 
tag
øø 
=
øø 
ReadSegment
øø  
(
øø  !
ref
øø! $
readSpan
øø% -
)
øø- .
;
øø. /
byte
ùù 
[
ùù 
]
ùù 
associatedData
ùù 
=
ùù 
ReadSegment
ùù  +
(
ùù+ ,
ref
ùù, /
readSpan
ùù0 8
)
ùù8 9
;
ùù9 :
byte
úú 
[
úú 
]
úú 

ciphertext
úú 
=
úú 
ReadSegment
úú '
(
úú' (
ref
úú( +
readSpan
úú, 4
)
úú4 5
;
úú5 6
if
üü 

(
üü 
!
üü 
readSpan
üü 
.
üü 
IsEmpty
üü 
)
üü 
{
ýý 	
throw
þþ 
new
þþ '
InvalidOperationException
þþ /
(
þþ/ 0&
ApplicationErrorMessages
ÿÿ (
.
ÿÿ( )(
SecureProtocolStateStorage
ÿÿ) C
.
ÿÿC D&
INVALID_CONTAINER_FORMAT
ÿÿD \
)
ÿÿ\ ]
;
ÿÿ] ^
}
€€ 	
return
‚‚ 
new
‚‚ 
SecureContainer
‚‚ "
(
‚‚" #
salt
‚‚# '
,
‚‚' (
nonce
‚‚) .
,
‚‚. /
tag
‚‚0 3
,
‚‚3 4

ciphertext
‚‚5 ?
,
‚‚? @
associatedData
‚‚A O
)
‚‚O P
;
‚‚P Q
}
ƒƒ 
private
…… 
async
…… 
Task
…… 
<
…… 
byte
…… 
[
…… 
]
…… 
>
…… &
AddTamperProtectionAsync
…… 7
(
……7 8
byte
……8 <
[
……< =
]
……= >
data
……? C
)
……C D
{
†† 
byte
‡‡ 
[
‡‡ 
]
‡‡ 
hmacKey
‡‡ 
=
‡‡ 
await
‡‡ 
GetHmacKeyAsync
‡‡ .
(
‡‡. /
)
‡‡/ 0
.
‡‡0 1
ConfigureAwait
‡‡1 ?
(
‡‡? @
false
‡‡@ E
)
‡‡E F
;
‡‡F G
using
ˆˆ 

HMACSHA512
ˆˆ 
hmac
ˆˆ 
=
ˆˆ 
new
ˆˆ  #
(
ˆˆ# $
hmacKey
ˆˆ$ +
)
ˆˆ+ ,
;
ˆˆ, -
byte
‰‰ 
[
‰‰ 
]
‰‰ 
mac
‰‰ 
=
‰‰ 
hmac
‰‰ 
.
‰‰ 
ComputeHash
‰‰ %
(
‰‰% &
data
‰‰& *
)
‰‰* +
;
‰‰+ ,
byte
‹‹ 
[
‹‹ 
]
‹‹ 
result
‹‹ 
=
‹‹ 
new
‹‹ 
byte
‹‹  
[
‹‹  !
data
‹‹! %
.
‹‹% &
Length
‹‹& ,
+
‹‹- .
mac
‹‹/ 2
.
‹‹2 3
Length
‹‹3 9
]
‹‹9 :
;
‹‹: ;
Buffer
ŒŒ 
.
ŒŒ 
	BlockCopy
ŒŒ 
(
ŒŒ 
data
ŒŒ 
,
ŒŒ 
$num
ŒŒ  
,
ŒŒ  !
result
ŒŒ" (
,
ŒŒ( )
$num
ŒŒ* +
,
ŒŒ+ ,
data
ŒŒ- 1
.
ŒŒ1 2
Length
ŒŒ2 8
)
ŒŒ8 9
;
ŒŒ9 :
Buffer
 
.
 
	BlockCopy
 
(
 
mac
 
,
 
$num
 
,
  
result
! '
,
' (
data
) -
.
- .
Length
. 4
,
4 5
mac
6 9
.
9 :
Length
: @
)
@ A
;
A B

ZeroBuffer
 
(
 
mac
 
)
 
;
 
return
 
result
 
;
 
}
‘‘ 
private
““ 
async
““ 
Task
““ 
<
““ 
Result
““ 
<
““ 
byte
““ "
[
““" #
]
““# $
,
““$ %"
SecureStorageFailure
““& :
>
““: ;
>
““; <)
VerifyTamperProtectionAsync
““= X
(
““X Y
byte
““Y ]
[
““] ^
]
““^ _
protectedData
““` m
)
““m n
{
”” 
if
•• 

(
•• 
protectedData
•• 
.
•• 
Length
••  
<
••! "$
SecureStorageConstants
••# 9
.
••9 :

Encryption
••: D
.
••D E
HMAC_SHA_512_SIZE
••E V
)
••V W
{
–– 	
return
—— 
Result
—— 
<
—— 
byte
—— 
[
—— 
]
——  
,
——  !"
SecureStorageFailure
——" 6
>
——6 7
.
——7 8
Err
——8 ;
(
——; <
new
˜˜ "
SecureStorageFailure
˜˜ (
(
˜˜( )&
ApplicationErrorMessages
™™ ,
.
™™, -(
SecureProtocolStateStorage
™™- G
.
™™G H%
TAMPERED_STATE_DETECTED
™™H _
)
™™_ `
)
™™` a
;
™™a b
}
šš 	
int
œœ 
macSize
œœ 
=
œœ $
SecureStorageConstants
œœ ,
.
œœ, -

Encryption
œœ- 7
.
œœ7 8
HMAC_SHA_512_SIZE
œœ8 I
;
œœI J
int
 

dataLength
 
=
 
protectedData
 &
.
& '
Length
' -
-
. /
macSize
0 7
;
7 8
byte
ŸŸ 
[
ŸŸ 
]
ŸŸ 
data
ŸŸ 
=
ŸŸ 
new
ŸŸ 
byte
ŸŸ 
[
ŸŸ 

dataLength
ŸŸ )
]
ŸŸ) *
;
ŸŸ* +
byte
   
[
   
]
   
mac
   
=
   
new
   
byte
   
[
   
macSize
   %
]
  % &
;
  & '
Buffer
¢¢ 
.
¢¢ 
	BlockCopy
¢¢ 
(
¢¢ 
protectedData
¢¢ &
,
¢¢& '
$num
¢¢( )
,
¢¢) *
data
¢¢+ /
,
¢¢/ 0
$num
¢¢1 2
,
¢¢2 3

dataLength
¢¢4 >
)
¢¢> ?
;
¢¢? @
Buffer
££ 
.
££ 
	BlockCopy
££ 
(
££ 
protectedData
££ &
,
££& '

dataLength
££( 2
,
££2 3
mac
££4 7
,
££7 8
$num
££9 :
,
££: ;
macSize
££< C
)
££C D
;
££D E
byte
¥¥ 
[
¥¥ 
]
¥¥ 
hmacKey
¥¥ 
=
¥¥ 
await
¥¥ 
GetHmacKeyAsync
¥¥ .
(
¥¥. /
)
¥¥/ 0
.
¥¥0 1
ConfigureAwait
¥¥1 ?
(
¥¥? @
false
¥¥@ E
)
¥¥E F
;
¥¥F G
using
¦¦ 

HMACSHA512
¦¦ 
hmac
¦¦ 
=
¦¦ 
new
¦¦  #
(
¦¦# $
hmacKey
¦¦$ +
)
¦¦+ ,
;
¦¦, -
byte
§§ 
[
§§ 
]
§§ 
expectedMac
§§ 
=
§§ 
hmac
§§ !
.
§§! "
ComputeHash
§§" -
(
§§- .
data
§§. 2
)
§§2 3
;
§§3 4
bool
©© 
matches
©© 
=
©© %
CryptographicOperations
©© .
.
©©. /
FixedTimeEquals
©©/ >
(
©©> ?
mac
©©? B
,
©©B C
expectedMac
©©D O
)
©©O P
;
©©P Q

ZeroBuffer
«« 
(
«« 
mac
«« 
)
«« 
;
«« 

ZeroBuffer
¬¬ 
(
¬¬ 
expectedMac
¬¬ 
)
¬¬ 
;
¬¬  
if
®® 

(
®® 
matches
®® 
)
®® 
{
¯¯ 	
return
°° 
Result
°° 
<
°° 
byte
°° 
[
°° 
]
°°  
,
°°  !"
SecureStorageFailure
°°" 6
>
°°6 7
.
°°7 8
Ok
°°8 :
(
°°: ;
data
°°; ?
)
°°? @
;
°°@ A
}
±± 	

ZeroBuffer
³³ 
(
³³ 
data
³³ 
)
³³ 
;
³³ 
return
´´ 
Result
´´ 
<
´´ 
byte
´´ 
[
´´ 
]
´´ 
,
´´ "
SecureStorageFailure
´´ 2
>
´´2 3
.
´´3 4
Err
´´4 7
(
´´7 8
new
µµ "
SecureStorageFailure
µµ $
(
µµ$ %&
ApplicationErrorMessages
¶¶ (
.
¶¶( )(
SecureProtocolStateStorage
¶¶) C
.
¶¶C D%
TAMPERED_STATE_DETECTED
¶¶D [
)
¶¶[ \
)
¶¶\ ]
;
¶¶] ^
}
·· 
private
¹¹ 
async
¹¹ 
Task
¹¹ 
<
¹¹ 
byte
¹¹ 
[
¹¹ 
]
¹¹ 
>
¹¹ 
GetHmacKeyAsync
¹¹ .
(
¹¹. /
)
¹¹/ 0
{
ºº 
byte
»» 
[
»» 
]
»» 
?
»» 
cached
»» 
=
»» 
Volatile
»» !
.
»»! "
Read
»»" &
(
»»& '
ref
»»' *
_cachedHmacKey
»»+ 9
)
»»9 :
;
»»: ;
if
¼¼ 

(
¼¼ 
cached
¼¼ 
!=
¼¼ 
null
¼¼ 
)
¼¼ 
{
½½ 	
return
¾¾ 
cached
¾¾ 
;
¾¾ 
}
¿¿ 	
byte
ÁÁ 
[
ÁÁ 
]
ÁÁ 
newKey
ÁÁ 
=
ÁÁ 
await
ÁÁ 
_platformProvider
ÁÁ /
.
ÁÁ/ 0%
GetOrCreateHmacKeyAsync
ÁÁ0 G
(
ÁÁG H
)
ÁÁH I
.
ÁÁI J
ConfigureAwait
ÁÁJ X
(
ÁÁX Y
false
ÁÁY ^
)
ÁÁ^ _
;
ÁÁ_ `
byte
ÂÂ 
[
ÂÂ 
]
ÂÂ 
?
ÂÂ 
existing
ÂÂ 
=
ÂÂ 
Interlocked
ÂÂ &
.
ÂÂ& '
CompareExchange
ÂÂ' 6
(
ÂÂ6 7
ref
ÂÂ7 :
_cachedHmacKey
ÂÂ; I
,
ÂÂI J
newKey
ÂÂK Q
,
ÂÂQ R
null
ÂÂS W
)
ÂÂW X
;
ÂÂX Y
if
ÄÄ 

(
ÄÄ 
existing
ÄÄ 
!=
ÄÄ 
null
ÄÄ 
)
ÄÄ 
{
ÅÅ 	

ZeroBuffer
ÆÆ 
(
ÆÆ 
newKey
ÆÆ 
)
ÆÆ 
;
ÆÆ 
return
ÇÇ 
existing
ÇÇ 
;
ÇÇ 
}
ÈÈ 	
return
ÊÊ 
newKey
ÊÊ 
;
ÊÊ 
}
ËË 
private
ÍÍ 
static
ÍÍ 
async
ÍÍ 
Task
ÍÍ 
<
ÍÍ 
Option
ÍÍ $
<
ÍÍ$ %
byte
ÍÍ% )
[
ÍÍ) *
]
ÍÍ* +
>
ÍÍ+ ,
>
ÍÍ, -!
ReadSecureFileAsync
ÍÍ. A
(
ÍÍA B
string
ÍÍB H
filePath
ÍÍI Q
)
ÍÍQ R
{
ÎÎ 
return
ÏÏ 
File
ÏÏ 
.
ÏÏ 
Exists
ÏÏ 
(
ÏÏ 
filePath
ÏÏ #
)
ÏÏ# $
?
ÐÐ 
Option
ÐÐ 
<
ÐÐ 
byte
ÐÐ 
[
ÐÐ 
]
ÐÐ 
>
ÐÐ 
.
ÐÐ 
Some
ÐÐ !
(
ÐÐ! "
await
ÐÐ" '
File
ÐÐ( ,
.
ÐÐ, -
ReadAllBytesAsync
ÐÐ- >
(
ÐÐ> ?
filePath
ÐÐ? G
)
ÐÐG H
.
ÐÐH I
ConfigureAwait
ÐÐI W
(
ÐÐW X
false
ÐÐX ]
)
ÐÐ] ^
)
ÐÐ^ _
:
ÑÑ 
Option
ÑÑ 
<
ÑÑ 
byte
ÑÑ 
[
ÑÑ 
]
ÑÑ 
>
ÑÑ 
.
ÑÑ 
None
ÑÑ !
;
ÑÑ! "
}
ÒÒ 
private
ÔÔ 
static
ÔÔ 
async
ÔÔ 
Task
ÔÔ "
WriteSecureFileAsync
ÔÔ 2
(
ÔÔ2 3
byte
ÔÔ3 7
[
ÔÔ7 8
]
ÔÔ8 9
data
ÔÔ: >
,
ÔÔ> ?
string
ÔÔ@ F
filePath
ÔÔG O
)
ÔÔO P
{
ÕÕ 
string
ÖÖ 
?
ÖÖ 
	directory
ÖÖ 
=
ÖÖ 
Path
ÖÖ  
.
ÖÖ  !
GetDirectoryName
ÖÖ! 1
(
ÖÖ1 2
filePath
ÖÖ2 :
)
ÖÖ: ;
;
ÖÖ; <
if
×× 

(
×× 
!
×× 
string
×× 
.
×× 
IsNullOrEmpty
×× !
(
××! "
	directory
××" +
)
××+ ,
)
××, -
{
ØØ 	
DirectoryInfo
ÙÙ 
directoryInfo
ÙÙ '
=
ÙÙ( )
	Directory
ÙÙ* 3
.
ÙÙ3 4
CreateDirectory
ÙÙ4 C
(
ÙÙC D
	directory
ÙÙD M
)
ÙÙM N
;
ÙÙN O
if
ÛÛ 
(
ÛÛ 
!
ÛÛ  
RuntimeInformation
ÛÛ #
.
ÛÛ# $
IsOSPlatform
ÛÛ$ 0
(
ÛÛ0 1

OSPlatform
ÛÛ1 ;
.
ÛÛ; <
Windows
ÛÛ< C
)
ÛÛC D
)
ÛÛD E
{
ÜÜ 
File
ÝÝ 
.
ÝÝ 
SetUnixFileMode
ÝÝ $
(
ÝÝ$ %
directoryInfo
ÝÝ% 2
.
ÝÝ2 3
FullName
ÝÝ3 ;
,
ÝÝ; <
UnixFileMode
ÞÞ  
.
ÞÞ  !
UserRead
ÞÞ! )
|
ÞÞ* +
UnixFileMode
ÞÞ, 8
.
ÞÞ8 9
	UserWrite
ÞÞ9 B
|
ÞÞC D
UnixFileMode
ÞÞE Q
.
ÞÞQ R
UserExecute
ÞÞR ]
)
ÞÞ] ^
;
ÞÞ^ _
}
ßß 
}
àà 	
string
ââ 
tempPath
ââ 
=
ââ 
$"
ââ 
{
ââ 
filePath
ââ %
}
ââ% &
$str
ââ& +
{
ââ+ ,
Guid
ââ, 0
.
ââ0 1
NewGuid
ââ1 8
(
ââ8 9
)
ââ9 :
:
ââ: ;
$str
ââ; <
}
ââ< =
"
ââ= >
;
ââ> ?
try
ää 
{
åå 	
await
ææ 
File
ææ 
.
ææ  
WriteAllBytesAsync
ææ )
(
ææ) *
tempPath
ææ* 2
,
ææ2 3
data
ææ4 8
)
ææ8 9
.
ææ9 :
ConfigureAwait
ææ: H
(
ææH I
false
ææI N
)
ææN O
;
ææO P
if
èè 
(
èè 
!
èè  
RuntimeInformation
èè #
.
èè# $
IsOSPlatform
èè$ 0
(
èè0 1

OSPlatform
èè1 ;
.
èè; <
Windows
èè< C
)
èèC D
)
èèD E
{
éé 
File
êê 
.
êê 
SetUnixFileMode
êê $
(
êê$ %
tempPath
êê% -
,
êê- .
UnixFileMode
êê/ ;
.
êê; <
UserRead
êê< D
|
êêE F
UnixFileMode
êêG S
.
êêS T
	UserWrite
êêT ]
)
êê] ^
;
êê^ _
}
ëë 
File
íí 
.
íí 
Move
íí 
(
íí 
tempPath
íí 
,
íí 
filePath
íí  (
,
íí( )
	overwrite
íí* 3
:
íí3 4
true
íí5 9
)
íí9 :
;
íí: ;
}
îî 	
catch
ïï 
{
ðð 	
if
ññ 
(
ññ 
!
ññ 
File
ññ 
.
ññ 
Exists
ññ 
(
ññ 
tempPath
ññ %
)
ññ% &
)
ññ& '
{
òò 
throw
óó 
;
óó 
}
ôô 
try
öö 
{
÷÷ 
File
øø 
.
øø 
Delete
øø 
(
øø 
tempPath
øø $
)
øø$ %
;
øø% &
}
ùù 
catch
úú 
{
ûû 
}
ýý 
throw
ÿÿ 
;
ÿÿ 
}
€€ 	
}
 
private
ƒƒ 
static
ƒƒ 
async
ƒƒ 
Task
ƒƒ %
DeleteFileIfExistsAsync
ƒƒ 5
(
ƒƒ5 6
string
ƒƒ6 <
filePath
ƒƒ= E
,
ƒƒE F
int
ƒƒG J

maxRetries
ƒƒK U
=
ƒƒV W
$num
ƒƒX Y
)
ƒƒY Z
{
„„ 
if
…… 

(
…… 
!
…… 
File
…… 
.
…… 
Exists
…… 
(
…… 
filePath
…… !
)
……! "
)
……" #
{
†† 	
return
‡‡ 
;
‡‡ 
}
ˆˆ 	
for
ŠŠ 
(
ŠŠ 
int
ŠŠ 
attempt
ŠŠ 
=
ŠŠ 
$num
ŠŠ 
;
ŠŠ 
attempt
ŠŠ %
<=
ŠŠ& (

maxRetries
ŠŠ) 3
;
ŠŠ3 4
attempt
ŠŠ5 <
++
ŠŠ< >
)
ŠŠ> ?
{
‹‹ 	
try
ŒŒ 
{
 
FileAttributes
ŽŽ 

attributes
ŽŽ )
=
ŽŽ* +
File
ŽŽ, 0
.
ŽŽ0 1
GetAttributes
ŽŽ1 >
(
ŽŽ> ?
filePath
ŽŽ? G
)
ŽŽG H
;
ŽŽH I
if
 
(
 

attributes
 
.
 
HasFlag
 &
(
& '
FileAttributes
' 5
.
5 6
ReadOnly
6 >
)
> ?
)
? @
{
 
File
‘‘ 
.
‘‘ 
SetAttributes
‘‘ &
(
‘‘& '
filePath
‘‘' /
,
‘‘/ 0

attributes
‘‘1 ;
&
‘‘< =
~
‘‘> ?
FileAttributes
‘‘? M
.
‘‘M N
ReadOnly
‘‘N V
)
‘‘V W
;
‘‘W X
}
’’ 
File
”” 
.
”” 
Delete
”” 
(
”” 
filePath
”” $
)
””$ %
;
””% &
return
•• 
;
•• 
}
–– 
catch
—— 
(
—— 
IOException
—— 
)
—— 
when
——  $
(
——% &
attempt
——& -
<
——. /

maxRetries
——0 :
)
——: ;
{
˜˜ 
await
™™ 
Task
™™ 
.
™™ 
Delay
™™  
(
™™  !

RetryDelay
™™! +
(
™™+ ,
attempt
™™, 3
)
™™3 4
)
™™4 5
.
™™5 6
ConfigureAwait
™™6 D
(
™™D E
false
™™E J
)
™™J K
;
™™K L
}
šš 
catch
›› 
(
›› )
UnauthorizedAccessException
›› .
)
››. /
when
››0 4
(
››5 6
attempt
››6 =
<
››> ?

maxRetries
››@ J
)
››J K
{
œœ 
await
 
Task
 
.
 
Delay
  
(
  !

RetryDelay
! +
(
+ ,
attempt
, 3
)
3 4
)
4 5
.
5 6
ConfigureAwait
6 D
(
D E
false
E J
)
J K
;
K L
}
žž 
}
ŸŸ 	
if
¡¡ 

(
¡¡ 
!
¡¡ 
File
¡¡ 
.
¡¡ 
Exists
¡¡ 
(
¡¡ 
filePath
¡¡ !
)
¡¡! "
)
¡¡" #
{
¢¢ 	
return
££ 
;
££ 
}
¤¤ 	
FileAttributes
¦¦ 
finalAttributes
¦¦ &
=
¦¦' (
File
¦¦) -
.
¦¦- .
GetAttributes
¦¦. ;
(
¦¦; <
filePath
¦¦< D
)
¦¦D E
;
¦¦E F
if
§§ 

(
§§ 
finalAttributes
§§ 
.
§§ 
HasFlag
§§ #
(
§§# $
FileAttributes
§§$ 2
.
§§2 3
ReadOnly
§§3 ;
)
§§; <
)
§§< =
{
¨¨ 	
File
©© 
.
©© 
SetAttributes
©© 
(
©© 
filePath
©© '
,
©©' (
finalAttributes
©©) 8
&
©©9 :
~
©©; <
FileAttributes
©©< J
.
©©J K
ReadOnly
©©K S
)
©©S T
;
©©T U
}
ªª 	
File
¬¬ 
.
¬¬ 
Delete
¬¬ 
(
¬¬ 
filePath
¬¬ 
)
¬¬ 
;
¬¬ 
}
­­ 
private
¯¯ 
async
¯¯ 
Task
¯¯ 
<
¯¯ 
Option
¯¯ 
<
¯¯ 
byte
¯¯ "
[
¯¯" #
]
¯¯# $
>
¯¯$ %
>
¯¯% &"
TryGetStoredKeyAsync
¯¯' ;
(
¯¯; <
string
¯¯< B
keychainKey
¯¯C N
)
¯¯N O
{
°° 
byte
±± 
[
±± 
]
±± 
?
±± 
key
±± 
=
±± 
await
±± 
_platformProvider
±± -
.
±±- .%
GetKeyFromKeychainAsync
±±. E
(
±±E F
keychainKey
±±F Q
)
±±Q R
.
±±R S
ConfigureAwait
±±S a
(
±±a b
false
±±b g
)
±±g h
;
±±h i
return
²² 
Option
²² 
<
²² 
byte
²² 
[
²² 
]
²² 
>
²² 
.
²² 
From
²² "
(
²²" #
key
²²# &
)
²²& '
;
²²' (
}
³³ 
private
µµ 
async
µµ 
Task
µµ $
CleanupFailedSaveAsync
µµ -
(
µµ- .
string
µµ. 4
storagePath
µµ5 @
,
µµ@ A
string
µµB H
keychainKey
µµI T
)
µµT U
{
¶¶ 
try
·· 
{
¸¸ 	
await
¹¹ %
DeleteFileIfExistsAsync
¹¹ )
(
¹¹) *
storagePath
¹¹* 5
)
¹¹5 6
.
¹¹6 7
ConfigureAwait
¹¹7 E
(
¹¹E F
false
¹¹F K
)
¹¹K L
;
¹¹L M
}
ºº 	
catch
»» 
{
¼¼ 	
}
¾¾ 	
try
ÀÀ 
{
ÁÁ 	
await
ÂÂ 
_platformProvider
ÂÂ #
.
ÂÂ# $(
DeleteKeyFromKeychainAsync
ÂÂ$ >
(
ÂÂ> ?
keychainKey
ÂÂ? J
)
ÂÂJ K
.
ÂÂK L
ConfigureAwait
ÂÂL Z
(
ÂÂZ [
false
ÂÂ[ `
)
ÂÂ` a
;
ÂÂa b
}
ÃÃ 	
catch
ÄÄ 
{
ÅÅ 	
}
ÇÇ 	
}
ÈÈ 
private
ÊÊ 
async
ÊÊ 
Task
ÊÊ 
<
ÊÊ 
(
ÊÊ 
byte
ÊÊ 
[
ÊÊ 
]
ÊÊ 
Key
ÊÊ "
,
ÊÊ" #
byte
ÊÊ$ (
[
ÊÊ( )
]
ÊÊ) *
Salt
ÊÊ+ /
)
ÊÊ/ 0
>
ÊÊ0 1
DeriveKeyAsync
ÊÊ2 @
(
ÊÊ@ A
byte
ÊÊA E
[
ÊÊE F
]
ÊÊF G
membershipId
ÊÊH T
)
ÊÊT U
{
ËË 
byte
ÌÌ 
[
ÌÌ 
]
ÌÌ 
salt
ÌÌ 
=
ÌÌ 
await
ÌÌ 
_platformProvider
ÌÌ -
.
ÌÌ- .'
GenerateSecureRandomAsync
ÌÌ. G
(
ÌÌG H$
SecureStorageConstants
ÌÌH ^
.
ÌÌ^ _

Encryption
ÌÌ_ i
.
ÌÌi j
	SALT_SIZE
ÌÌj s
)
ÌÌs t
.
ÍÍ 
ConfigureAwait
ÍÍ 
(
ÍÍ 
false
ÍÍ !
)
ÍÍ! "
;
ÍÍ" #
(
ÏÏ 	
byte
ÏÏ	 
[
ÏÏ 
]
ÏÏ 
key
ÏÏ 
,
ÏÏ 
byte
ÏÏ 
[
ÏÏ 
]
ÏÏ 
_
ÏÏ 
)
ÏÏ 
=
ÏÏ  
await
ÏÏ! &$
DeriveKeyWithSaltAsync
ÏÏ' =
(
ÏÏ= >
membershipId
ÏÏ> J
,
ÏÏJ K
salt
ÏÏL P
)
ÏÏP Q
.
ÏÏQ R
ConfigureAwait
ÏÏR `
(
ÏÏ` a
false
ÏÏa f
)
ÏÏf g
;
ÏÏg h
return
ÐÐ 
(
ÐÐ 
key
ÐÐ 
,
ÐÐ 
salt
ÐÐ 
)
ÐÐ 
;
ÐÐ 
}
ÑÑ 
private
ÓÓ 
async
ÓÓ 
Task
ÓÓ 
<
ÓÓ 
(
ÓÓ 
byte
ÓÓ 
[
ÓÓ 
]
ÓÓ 
Key
ÓÓ "
,
ÓÓ" #
byte
ÓÓ$ (
[
ÓÓ( )
]
ÓÓ) *
Salt
ÓÓ+ /
)
ÓÓ/ 0
>
ÓÓ0 1$
DeriveKeyWithSaltAsync
ÓÓ2 H
(
ÓÓH I
byte
ÓÓI M
[
ÓÓM N
]
ÓÓN O
membershipId
ÓÓP \
,
ÓÓ\ ]
byte
ÓÓ^ b
[
ÓÓb c
]
ÓÓc d
salt
ÓÓe i
)
ÓÓi j
{
ÔÔ 
using
ÕÕ 
Argon2id
ÕÕ 
argon2
ÕÕ 
=
ÕÕ 
new
ÕÕ  #
(
ÕÕ# $
membershipId
ÕÕ$ 0
)
ÕÕ0 1
{
ÖÖ 	
Salt
×× 
=
×× 
salt
×× 
,
×× !
DegreeOfParallelism
ØØ 
=
ØØ  !$
SecureStorageConstants
ØØ" 8
.
ØØ8 9
Argon2
ØØ9 ?
.
ØØ? @
PARALLELISM
ØØ@ K
,
ØØK L

Iterations
ÙÙ 
=
ÙÙ $
SecureStorageConstants
ÙÙ /
.
ÙÙ/ 0
Argon2
ÙÙ0 6
.
ÙÙ6 7

ITERATIONS
ÙÙ7 A
,
ÙÙA B

MemorySize
ÚÚ 
=
ÚÚ $
SecureStorageConstants
ÚÚ /
.
ÚÚ/ 0
Argon2
ÚÚ0 6
.
ÚÚ6 7
MEMORY_SIZE
ÚÚ7 B
,
ÚÚB C
AssociatedData
ÛÛ 
=
ÛÛ 
	_deviceId
ÛÛ &
}
ÜÜ 	
;
ÜÜ	 

byte
ÞÞ 
[
ÞÞ 
]
ÞÞ 
key
ÞÞ 
=
ÞÞ 
await
ÞÞ 
argon2
ÞÞ !
.
ÞÞ! "
GetBytesAsync
ÞÞ" /
(
ÞÞ/ 0$
SecureStorageConstants
ÞÞ0 F
.
ÞÞF G

Encryption
ÞÞG Q
.
ÞÞQ R
KEY_SIZE
ÞÞR Z
)
ÞÞZ [
.
ÞÞ[ \
ConfigureAwait
ÞÞ\ j
(
ÞÞj k
false
ÞÞk p
)
ÞÞp q
;
ÞÞq r
return
ßß 
(
ßß 
key
ßß 
,
ßß 
salt
ßß 
)
ßß 
;
ßß 
}
àà 
private
ââ 
void
ââ )
EnsureSecureDirectoryExists
ââ ,
(
ââ, -
)
ââ- .
{
ãã 
DirectoryInfo
ää 
	directory
ää 
=
ää  !
	Directory
ää" +
.
ää+ ,
CreateDirectory
ää, ;
(
ää; <
_storageDirectory
ää< M
)
ääM N
;
ääN O
if
ææ 

(
ææ 
!
ææ  
RuntimeInformation
ææ 
.
ææ  
IsOSPlatform
ææ  ,
(
ææ, -

OSPlatform
ææ- 7
.
ææ7 8
Windows
ææ8 ?
)
ææ? @
)
ææ@ A
{
çç 	
File
èè 
.
èè 
SetUnixFileMode
èè  
(
èè  !
	directory
èè! *
.
èè* +
FullName
èè+ 3
,
èè3 4
UnixFileMode
éé 
.
éé 
UserRead
éé %
|
éé& '
UnixFileMode
éé( 4
.
éé4 5
	UserWrite
éé5 >
|
éé? @
UnixFileMode
ééA M
.
ééM N
UserExecute
ééN Y
)
ééY Z
;
ééZ [
}
êê 	
}
ëë 
private
íí 
bool
íí "
TryEnsureNotDisposed
íí %
(
íí% &
out
íí& )"
SecureStorageFailure
íí* >
?
íí> ?
failure
íí@ G
)
ííG H
{
îî 
if
ïï 

(
ïï 
	_disposed
ïï 
)
ïï 
{
ðð 	
failure
ññ 
=
ññ 
new
ññ "
SecureStorageFailure
ññ .
(
ññ. /&
ApplicationErrorMessages
ññ/ G
.
ññG H(
SecureProtocolStateStorage
ññH b
.
ññb c
STORAGE_DISPOSED
ññc s
)
ññs t
;
ññt u
return
òò 
false
òò 
;
òò 
}
óó 	
failure
õõ 
=
õõ 
null
õõ 
;
õõ 
return
öö 
true
öö 
;
öö 
}
÷÷ 
private
ùù 
static
ùù 
void
ùù 
WriteSegment
ùù $
(
ùù$ %
ReadOnlySpan
ùù% 1
<
ùù1 2
byte
ùù2 6
>
ùù6 7
value
ùù8 =
,
ùù= >
ref
ùù? B
Span
ùùC G
<
ùùG H
byte
ùùH L
>
ùùL M
destination
ùùN Y
)
ùùY Z
{
úú 
BinaryPrimitives
ûû 
.
ûû $
WriteInt32LittleEndian
ûû /
(
ûû/ 0
destination
ûû0 ;
,
ûû; <
value
ûû= B
.
ûûB C
Length
ûûC I
)
ûûI J
;
ûûJ K
destination
üü 
=
üü 
destination
üü !
[
üü! "
sizeof
üü" (
(
üü( )
int
üü) ,
)
üü, -
..
üü- /
]
üü/ 0
;
üü0 1
value
þþ 
.
þþ 
CopyTo
þþ 
(
þþ 
destination
þþ  
)
þþ  !
;
þþ! "
destination
ÿÿ 
=
ÿÿ 
destination
ÿÿ !
[
ÿÿ! "
value
ÿÿ" '
.
ÿÿ' (
Length
ÿÿ( .
..
ÿÿ. 0
]
ÿÿ0 1
;
ÿÿ1 2
}
€€ 
private
‚‚ 
static
‚‚ 
byte
‚‚ 
[
‚‚ 
]
‚‚ 
ReadSegment
‚‚ %
(
‚‚% &
ref
‚‚& )
ReadOnlySpan
‚‚* 6
<
‚‚6 7
byte
‚‚7 ;
>
‚‚; <
source
‚‚= C
)
‚‚C D
{
ƒƒ 
if
„„ 

(
„„ 
source
„„ 
.
„„ 
Length
„„ 
<
„„ 
sizeof
„„ "
(
„„" #
int
„„# &
)
„„& '
)
„„' (
{
…… 	
throw
†† 
new
†† '
InvalidOperationException
†† /
(
††/ 0&
ApplicationErrorMessages
‡‡ (
.
‡‡( )(
SecureProtocolStateStorage
‡‡) C
.
‡‡C D&
INVALID_CONTAINER_FORMAT
‡‡D \
)
‡‡\ ]
;
‡‡] ^
}
ˆˆ 	
int
ŠŠ 
length
ŠŠ 
=
ŠŠ 
BinaryPrimitives
ŠŠ %
.
ŠŠ% &#
ReadInt32LittleEndian
ŠŠ& ;
(
ŠŠ; <
source
ŠŠ< B
)
ŠŠB C
;
ŠŠC D
if
‹‹ 

(
‹‹ 
length
‹‹ 
<
‹‹ 
$num
‹‹ 
)
‹‹ 
{
ŒŒ 	
throw
 
new
 '
InvalidOperationException
 /
(
/ 0&
ApplicationErrorMessages
ŽŽ (
.
ŽŽ( )(
SecureProtocolStateStorage
ŽŽ) C
.
ŽŽC D&
INVALID_CONTAINER_FORMAT
ŽŽD \
)
ŽŽ\ ]
;
ŽŽ] ^
}
 	
source
‘‘ 
=
‘‘ 
source
‘‘ 
[
‘‘ 
sizeof
‘‘ 
(
‘‘ 
int
‘‘ "
)
‘‘" #
..
‘‘# %
]
‘‘% &
;
‘‘& '
if
’’ 

(
’’ 
source
’’ 
.
’’ 
Length
’’ 
<
’’ 
length
’’ "
)
’’" #
{
““ 	
throw
”” 
new
”” '
InvalidOperationException
”” /
(
””/ 0&
ApplicationErrorMessages
•• (
.
••( )(
SecureProtocolStateStorage
••) C
.
••C D&
INVALID_CONTAINER_FORMAT
••D \
)
••\ ]
;
••] ^
}
–– 	
byte
˜˜ 
[
˜˜ 
]
˜˜ 
result
˜˜ 
=
˜˜ 
source
˜˜ 
[
˜˜ 
..
˜˜ !
length
˜˜! '
]
˜˜' (
.
˜˜( )
ToArray
˜˜) 0
(
˜˜0 1
)
˜˜1 2
;
˜˜2 3
source
™™ 
=
™™ 
source
™™ 
[
™™ 
length
™™ 
..
™™  
]
™™  !
;
™™! "
return
šš 
result
šš 
;
šš 
}
›› 
private
 
static
 
int
 
SegmentSize
 "
(
" #
int
# &
payloadLength
' 4
)
4 5
=>
6 8
sizeof
9 ?
(
? @
int
@ C
)
C D
+
E F
payloadLength
G T
;
T U
private
ŸŸ 
static
ŸŸ 
TimeSpan
ŸŸ 

RetryDelay
ŸŸ &
(
ŸŸ& '
int
ŸŸ' *
attempt
ŸŸ+ 2
)
ŸŸ2 3
=>
ŸŸ4 6
TimeSpan
ŸŸ7 ?
.
ŸŸ? @
FromMilliseconds
ŸŸ@ P
(
ŸŸP Q
$num
ŸŸQ T
*
ŸŸU V
(
ŸŸW X
attempt
ŸŸX _
+
ŸŸ` a
$num
ŸŸb c
)
ŸŸc d
)
ŸŸd e
;
ŸŸe f
private
¡¡ 
static
¡¡ 
void
¡¡ 

ZeroBuffer
¡¡ "
(
¡¡" #
byte
¡¡# '
[
¡¡' (
]
¡¡( )
?
¡¡) *
buffer
¡¡+ 1
)
¡¡1 2
{
¢¢ 
if
££ 

(
££ 
buffer
££ 
is
££ 
null
££ 
)
££ 
{
¤¤ 	
return
¥¥ 
;
¥¥ 
}
¦¦ 	%
CryptographicOperations
¨¨ 
.
¨¨  

ZeroMemory
¨¨  *
(
¨¨* +
buffer
¨¨+ 1
)
¨¨1 2
;
¨¨2 3
}
©© 
private
«« 
readonly
«« 
record
«« 
struct
«« "
SecureContainer
««# 2
(
««2 3
byte
¬¬ 
[
¬¬ 
]
¬¬ 
Salt
¬¬ 
,
¬¬ 
byte
­­ 
[
­­ 
]
­­ 
Nonce
­­ 
,
­­ 
byte
®® 
[
®® 
]
®® 
Tag
®® 
,
®® 
byte
¯¯ 
[
¯¯ 
]
¯¯ 

Ciphertext
¯¯ 
,
¯¯ 
byte
°° 
[
°° 
]
°° 
AssociatedData
°° 
)
°° 
;
°° 
}±± 
public³³ 
record
³³ "
SecureStorageFailure
³³ "
(
³³" #
string
³³# )
Message
³³* 1
)
³³1 2
:
³³3 4
FailureBase
³³5 @
(
³³@ A
Message
³³A H
)
³³H I
{´´ 
public
µµ 

override
µµ 
object
µµ 
ToStructuredLog
µµ *
(
µµ* +
)
µµ+ ,
=>
µµ- /
new
µµ0 3
{
µµ4 5
Message
µµ6 =
,
µµ= >
Type
µµ? C
=
µµD E
$str
µµF \
}
µµ] ^
;
µµ^ _
public
·· 

override
·· !
GrpcErrorDescriptor
·· '
ToGrpcDescriptor
··( 8
(
··8 9
)
··9 :
=>
··; =
new
¸¸ 
(
¸¸ 
	ErrorCode
¸¸ 
.
¸¸ 
INTERNAL_ERROR
¸¸ $
,
¸¸$ %

StatusCode
¸¸& 0
.
¸¸0 1
Internal
¸¸1 9
,
¸¸9 :
ErrorI18NKeys
¸¸; H
.
¸¸H I
INTERNAL
¸¸I Q
)
¸¸Q R
;
¸¸R S
}¹¹ …ì
˜/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Platform/CrossPlatformSecurityProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Platform0 8
;8 9
internal 
sealed	 
class )
CrossPlatformSecurityProvider 3
:4 5%
IPlatformSecurityProvider6 O
{ 
private 
const 
int 
AES_KEY_SIZE "
=# $
$num% '
;' (
private 
const 
int 
AES_IV_SIZE !
=" #
$num$ &
;& '
private 
const 
int 
HMAC_KEY_SIZE #
=$ %
$num& (
;( )
private 
const 
int 
PBKDF_2_ITERATIONS (
=) *
$num+ 1
;1 2
private 
const 
int !
SECURE_OVERWRITE_SIZE +
=, -
$num. 2
;2 3
private 
const 
string 
MACHINE_KEY_SALT )
=* +
$str, @
;@ A
private 
const 
string 
HMAC_KEY_IDENTIFIER ,
=- .
$str/ B
;B C
private 
const 
string  
MACHINE_KEY_FILENAME -
=. /
$str0 >
;> ?
private 
const 
string 
KEYCHAIN_FOLDER (
=) *
$str+ 6
;6 7
private 
const 
string 
TPM_REGISTRY_PATH *
=+ ,
$str- V
;V W
private 
const 
string !
LINUX_MACHINE_ID_PATH .
=/ 0
$str1 B
;B C
private 
const 
string 
LINUX_TPM_PATH '
=( )
$str* 5
;5 6
private 
const 
string 
LINUX_TPMRM_PATH )
=* +
$str, 9
;9 :
private   
const   
string   
MACOS_UUID_PATTERN   +
=  , -
$str  . T
;  T U
private"" 
readonly"" 
string"" 
_keychainPath"" )
;"") *
private## 
readonly## 
Lock## 
_lockObject## %
=##& '
new##( +
(##+ ,
)##, -
;##- .
private%% 
byte%% 
[%% 
]%% 
?%% 
_cachedMachineKey%% %
;%%% &
private&& 
byte&& 
[&& 
]&& 
?&& 
_cachedHmacKey&& "
;&&" #
public(( 
)
CrossPlatformSecurityProvider(( (
(((( )
string(() /
appDataPath((0 ;
)((; <
{)) 
_keychainPath** 
=** 
Path** 
.** 
Combine** $
(**$ %
appDataPath**% 0
,**0 1
KEYCHAIN_FOLDER**2 A
)**A B
;**B C
InitializeKeychain++ 
(++ 
)++ 
;++ 
},, 
private.. 
void.. 
InitializeKeychain.. #
(..# $
)..$ %
{// 
if00 

(00 
	Directory00 
.00 
Exists00 
(00 
_keychainPath00 *
)00* +
)00+ ,
{11 	
return22 
;22 
}33 	
	Directory55 
.55 
CreateDirectory55 !
(55! "
_keychainPath55" /
)55/ 0
;550 1
if77 

(77 
!77 
RuntimeInformation77 
.77  
IsOSPlatform77  ,
(77, -

OSPlatform77- 7
.777 8
Windows778 ?
)77? @
)77@ A
{88 	
File99 
.99 
SetUnixFileMode99  
(99  !
_keychainPath99! .
,99. /
UnixFileMode:: 
.:: 
UserRead:: %
|::& '
UnixFileMode::( 4
.::4 5
	UserWrite::5 >
|::? @
UnixFileMode::A M
.::M N
UserExecute::N Y
)::Y Z
;::Z [
};; 	
}<< 
public>> 

async>> 
Task>> 
<>> 
byte>> 
[>> 
]>> 
>>> %
GenerateSecureRandomAsync>> 7
(>>7 8
int>>8 ;
length>>< B
)>>B C
{?? 
return@@ 
await@@ 
Task@@ 
.@@ 
Run@@ 
(@@ 
(@@ 
)@@  
=>@@! #
{AA 	
tryBB 
{CC 
byteDD 
[DD 
]DD 
bytesDD 
=DD !
RandomNumberGeneratorDD 4
.DD4 5
GetBytesDD5 =
(DD= >
lengthDD> D
)DDD E
;DDE F
ifFF 
(FF 
RuntimeInformationFF &
.FF& '
IsOSPlatformFF' 3
(FF3 4

OSPlatformFF4 >
.FF> ?
LinuxFF? D
)FFD E
)FFE F
{GG (
TryEnhanceWithHardwareRandomHH 0
(HH0 1
bytesHH1 6
)HH6 7
;HH7 8
}II 
returnKK 
bytesKK 
;KK 
}LL 
catchMM 
(MM 
	ExceptionMM 
)MM 
{NN 
returnOO !
RandomNumberGeneratorOO ,
.OO, -
GetBytesOO- 5
(OO5 6
lengthOO6 <
)OO< =
;OO= >
}PP 
}QQ 	
)QQ	 

;QQ
 
}RR 
publicTT 

asyncTT 
TaskTT #
StoreKeyInKeychainAsyncTT -
(TT- .
stringTT. 4

identifierTT5 ?
,TT? @
byteTTA E
[TTE F
]TTF G
keyTTH K
)TTK L
{UU 
awaitVV 
TaskVV 
.VV 
RunVV 
(VV 
(VV 
)VV 
=>VV 
{WW 	
lockXX 
(XX 
_lockObjectXX 
)XX 
{YY 
tryZZ 
{[[ 
Result\\ 
<\\ 
Unit\\ 
,\\   
SecureStorageFailure\\! 5
>\\5 6
result\\7 =
=\\> ?
GetPlatformStore\\@ P
(\\P Q

identifier\\Q [
,\\[ \
key\\] `
)\\` a
;\\a b
if]] 
(]] 
result]] 
.]] 
IsErr]] $
)]]$ %
{^^  
StoreInEncryptedFile__ ,
(__, -

identifier__- 7
,__7 8
key__9 <
)__< =
;__= >
}`` 
}aa 
catchbb 
(bb 
	Exceptionbb  
)bb  !
{cc  
StoreInEncryptedFiledd (
(dd( )

identifierdd) 3
,dd3 4
keydd5 8
)dd8 9
;dd9 :
}ee 
}ff 
}gg 	
)gg	 

;gg
 
}hh 
privatejj 
Resultjj 
<jj 
Unitjj 
,jj  
SecureStorageFailurejj -
>jj- .
GetPlatformStorejj/ ?
(jj? @
stringjj@ F

identifierjjG Q
,jjQ R
bytejjS W
[jjW X
]jjX Y
keyjjZ ]
)jj] ^
{kk 
ifll 

(ll 
RuntimeInformationll 
.ll 
IsOSPlatformll +
(ll+ ,

OSPlatformll, 6
.ll6 7
Windowsll7 >
)ll> ?
)ll? @
{mm 	
returnnn +
StoreInWindowsCredentialManagernn 2
(nn2 3

identifiernn3 =
,nn= >
keynn? B
)nnB C
;nnC D
}oo 	
ifqq 

(qq 
RuntimeInformationqq 
.qq 
IsOSPlatformqq +
(qq+ ,

OSPlatformqq, 6
.qq6 7
OSXqq7 :
)qq: ;
)qq; <
{rr 	
returnss  
StoreInMacOsKeychainss '
(ss' (

identifierss( 2
,ss2 3
keyss4 7
)ss7 8
;ss8 9
}tt 	
returnvv 
RuntimeInformationvv !
.vv! "
IsOSPlatformvv" .
(vv. /

OSPlatformvv/ 9
.vv9 :
Linuxvv: ?
)vv? @
?ww %
StoreInLinuxSecretServiceww '
(ww' (

identifierww( 2
,ww2 3
keyww4 7
)ww7 8
:xx  
StoreInEncryptedFilexx "
(xx" #

identifierxx# -
,xx- .
keyxx/ 2
)xx2 3
;xx3 4
}yy 
public{{ 

async{{ 
Task{{ 
<{{ 
byte{{ 
[{{ 
]{{ 
?{{ 
>{{ #
GetKeyFromKeychainAsync{{ 6
({{6 7
string{{7 =

identifier{{> H
){{H I
{|| 
return}} 
await}} 
Task}} 
.}} 
Run}} 
(}} 
(}} 
)}}  
=>}}! #
{~~ 	
lock 
( 
_lockObject 
) 
{
€€ 
try
 
{
‚‚ 
Result
ƒƒ 
<
ƒƒ 
byte
ƒƒ 
[
ƒƒ  
]
ƒƒ  !
,
ƒƒ! ""
SecureStorageFailure
ƒƒ# 7
>
ƒƒ7 8
result
ƒƒ9 ?
=
ƒƒ@ A!
GetPlatformRetrieve
ƒƒB U
(
ƒƒU V

identifier
ƒƒV `
)
ƒƒ` a
;
ƒƒa b
if
„„ 
(
„„ 
!
„„ 
result
„„ 
.
„„  
IsErr
„„  %
)
„„% &
{
…… 
return
†† 
result
†† %
.
††% &
IsOk
††& *
?
††+ ,
result
††- 3
.
††3 4
Unwrap
††4 :
(
††: ;
)
††; <
:
††= >
null
††? C
;
††C D
}
‡‡ 
Result
‰‰ 
<
‰‰ 
byte
‰‰ 
[
‰‰  
]
‰‰  !
,
‰‰! ""
SecureStorageFailure
‰‰# 7
>
‰‰7 8

fileResult
‰‰9 C
=
‰‰D E"
GetFromEncryptedFile
‰‰F Z
(
‰‰Z [

identifier
‰‰[ e
)
‰‰e f
;
‰‰f g
return
ŠŠ 

fileResult
ŠŠ %
.
ŠŠ% &
IsOk
ŠŠ& *
?
ŠŠ+ ,

fileResult
ŠŠ- 7
.
ŠŠ7 8
Unwrap
ŠŠ8 >
(
ŠŠ> ?
)
ŠŠ? @
:
ŠŠA B
null
ŠŠC G
;
ŠŠG H
}
‹‹ 
catch
ŒŒ 
(
ŒŒ 
	Exception
ŒŒ  
)
ŒŒ  !
{
 
Result
ŽŽ 
<
ŽŽ 
byte
ŽŽ 
[
ŽŽ  
]
ŽŽ  !
,
ŽŽ! ""
SecureStorageFailure
ŽŽ# 7
>
ŽŽ7 8

fileResult
ŽŽ9 C
=
ŽŽD E"
GetFromEncryptedFile
ŽŽF Z
(
ŽŽZ [

identifier
ŽŽ[ e
)
ŽŽe f
;
ŽŽf g
return
 

fileResult
 %
.
% &
IsOk
& *
?
+ ,

fileResult
- 7
.
7 8
Unwrap
8 >
(
> ?
)
? @
:
A B
null
C G
;
G H
}
 
}
‘‘ 
}
’’ 	
)
’’	 

;
’’
 
}
““ 
private
•• 
Result
•• 
<
•• 
byte
•• 
[
•• 
]
•• 
,
•• "
SecureStorageFailure
•• /
>
••/ 0!
GetPlatformRetrieve
••1 D
(
••D E
string
••E K

identifier
••L V
)
••V W
{
–– 
if
—— 

(
——  
RuntimeInformation
—— 
.
—— 
IsOSPlatform
—— +
(
——+ ,

OSPlatform
——, 6
.
——6 7
Windows
——7 >
)
——> ?
)
——? @
{
˜˜ 	
return
™™ -
GetFromWindowsCredentialManager
™™ 2
(
™™2 3

identifier
™™3 =
)
™™= >
;
™™> ?
}
šš 	
if
œœ 

(
œœ  
RuntimeInformation
œœ 
.
œœ 
IsOSPlatform
œœ +
(
œœ+ ,

OSPlatform
œœ, 6
.
œœ6 7
OSX
œœ7 :
)
œœ: ;
)
œœ; <
{
 	
return
žž "
GetFromMacOsKeychain
žž '
(
žž' (

identifier
žž( 2
)
žž2 3
;
žž3 4
}
ŸŸ 	
return
¡¡  
RuntimeInformation
¡¡ !
.
¡¡! "
IsOSPlatform
¡¡" .
(
¡¡. /

OSPlatform
¡¡/ 9
.
¡¡9 :
Linux
¡¡: ?
)
¡¡? @
?
¢¢ '
GetFromLinuxSecretService
¢¢ '
(
¢¢' (

identifier
¢¢( 2
)
¢¢2 3
:
££ "
GetFromEncryptedFile
££ "
(
££" #

identifier
££# -
)
££- .
;
££. /
}
¤¤ 
public
¦¦ 

async
¦¦ 
Task
¦¦ (
DeleteKeyFromKeychainAsync
¦¦ 0
(
¦¦0 1
string
¦¦1 7

identifier
¦¦8 B
)
¦¦B C
{
§§ 
await
¨¨ 
Task
¨¨ 
.
¨¨ 
Run
¨¨ 
(
¨¨ 
(
¨¨ 
)
¨¨ 
=>
¨¨ 
{
©© 	
lock
ªª 
(
ªª 
_lockObject
ªª 
)
ªª 
{
«« 
string
¬¬ 
keyFile
¬¬ 
=
¬¬  
GetKeyFilePath
¬¬! /
(
¬¬/ 0

identifier
¬¬0 :
)
¬¬: ;
;
¬¬; <
try
­­ 
{
®® 
if
¯¯ 
(
¯¯ 
!
¯¯ 
File
¯¯ 
.
¯¯ 
Exists
¯¯ $
(
¯¯$ %
keyFile
¯¯% ,
)
¯¯, -
)
¯¯- .
{
°° 
return
±± 
;
±± 
}
²² 
byte
µµ 
[
µµ 
]
µµ 

randomData
µµ %
=
µµ& '#
RandomNumberGenerator
µµ( =
.
µµ= >
GetBytes
µµ> F
(
µµF G#
SECURE_OVERWRITE_SIZE
µµG \
)
µµ\ ]
;
µµ] ^
using
·· 
(
·· 

FileStream
·· %
fs
··& (
=
··) *
File
··+ /
.
··/ 0
	OpenWrite
··0 9
(
··9 :
keyFile
··: A
)
··A B
)
··B C
{
¸¸ 
fs
¹¹ 
.
¹¹ 
Write
¹¹  
(
¹¹  !

randomData
¹¹! +
,
¹¹+ ,
$num
¹¹- .
,
¹¹. /

randomData
¹¹0 :
.
¹¹: ;
Length
¹¹; A
)
¹¹A B
;
¹¹B C
fs
ºº 
.
ºº 
Flush
ºº  
(
ºº  !
true
ºº! %
)
ºº% &
;
ºº& '
}
»» 
File
½½ 
.
½½ 
Delete
½½ 
(
½½  
keyFile
½½  '
)
½½' (
;
½½( )
}
¾¾ 
catch
¿¿ 
(
¿¿ 
	Exception
¿¿  
ex
¿¿! #
)
¿¿# $
{
ÀÀ 
Log
ÁÁ 
.
ÁÁ 
Debug
ÁÁ 
(
ÁÁ 
ex
ÁÁ  
,
ÁÁ  !
$str
ÁÁ" o
,
ÁÁo p
keyFile
ÂÂ 
)
ÂÂ  
;
ÂÂ  !
}
ÃÃ 
}
ÄÄ 
}
ÅÅ 	
)
ÅÅ	 

;
ÅÅ
 
}
ÆÆ 
public
ÈÈ 

async
ÈÈ 
Task
ÈÈ 
<
ÈÈ 
byte
ÈÈ 
[
ÈÈ 
]
ÈÈ 
>
ÈÈ %
GetOrCreateHmacKeyAsync
ÈÈ 5
(
ÈÈ5 6
)
ÈÈ6 7
{
ÉÉ 
if
ÊÊ 

(
ÊÊ 
_cachedHmacKey
ÊÊ 
!=
ÊÊ 
null
ÊÊ "
)
ÊÊ" #
{
ËË 	
return
ÌÌ 
_cachedHmacKey
ÌÌ !
;
ÌÌ! "
}
ÍÍ 	
byte
ÏÏ 
[
ÏÏ 
]
ÏÏ 
?
ÏÏ 
hmacKey
ÏÏ 
=
ÏÏ 
await
ÏÏ %
GetKeyFromKeychainAsync
ÏÏ  7
(
ÏÏ7 8!
HMAC_KEY_IDENTIFIER
ÏÏ8 K
)
ÏÏK L
;
ÏÏL M
if
ÑÑ 

(
ÑÑ 
hmacKey
ÑÑ 
==
ÑÑ 
null
ÑÑ 
)
ÑÑ 
{
ÒÒ 	
byte
ÓÓ 
[
ÓÓ 
]
ÓÓ 
newKey
ÓÓ 
=
ÓÓ 
await
ÓÓ !'
GenerateSecureRandomAsync
ÓÓ" ;
(
ÓÓ; <
HMAC_KEY_SIZE
ÓÓ< I
)
ÓÓI J
;
ÓÓJ K
await
ÔÔ %
StoreKeyInKeychainAsync
ÔÔ )
(
ÔÔ) *!
HMAC_KEY_IDENTIFIER
ÔÔ* =
,
ÔÔ= >
newKey
ÔÔ? E
)
ÔÔE F
;
ÔÔF G
_cachedHmacKey
ÖÖ 
=
ÖÖ 
newKey
ÖÖ #
;
ÖÖ# $
return
×× 
newKey
×× 
;
×× 
}
ØØ 	
_cachedHmacKey
ÚÚ 
=
ÚÚ 
hmacKey
ÚÚ  
;
ÚÚ  !
return
ÛÛ 
hmacKey
ÛÛ 
;
ÛÛ 
}
ÜÜ 
public
ÞÞ 

bool
ÞÞ )
IsHardwareSecurityAvailable
ÞÞ +
(
ÞÞ+ ,
)
ÞÞ, -
{
ßß 
if
àà 

(
àà  
RuntimeInformation
àà 
.
àà 
IsOSPlatform
àà +
(
àà+ ,

OSPlatform
àà, 6
.
àà6 7
Windows
àà7 >
)
àà> ?
)
àà? @
{
áá 	
return
ââ 
CheckWindowsTpm
ââ "
(
ââ" #
)
ââ# $
;
ââ$ %
}
ãã 	
if
åå 

(
åå  
RuntimeInformation
åå 
.
åå 
IsOSPlatform
åå +
(
åå+ ,

OSPlatform
åå, 6
.
åå6 7
OSX
åå7 :
)
åå: ;
)
åå; <
{
ææ 	
return
çç %
CheckMacOsSecureEnclave
çç *
(
çç* +
)
çç+ ,
;
çç, -
}
èè 	
if
êê 

(
êê  
RuntimeInformation
êê 
.
êê 
IsOSPlatform
êê +
(
êê+ ,

OSPlatform
êê, 6
.
êê6 7
Linux
êê7 <
)
êê< =
)
êê= >
{
ëë 	
return
ìì 
CheckLinuxTpm
ìì  
(
ìì  !
)
ìì! "
;
ìì" #
}
íí 	
return
ïï 
false
ïï 
;
ïï 
}
ðð 
public
òò 

async
òò 
Task
òò 
<
òò 
Option
òò 
<
òò 
byte
òò !
[
òò! "
]
òò" #
>
òò# $
>
òò$ %"
HardwareEncryptAsync
òò& :
(
òò: ;
byte
òò; ?
[
òò? @
]
òò@ A
data
òòB F
)
òòF G
{
óó 
byte
ôô 
[
ôô 
]
ôô 
key
ôô 
=
ôô 
await
ôô %
GetOrCreateHmacKeyAsync
ôô 2
(
ôô2 3
)
ôô3 4
;
ôô4 5
try
öö 
{
÷÷ 	
using
øø 
Aes
øø 
aes
øø 
=
øø 
Aes
øø 
.
øø  
Create
øø  &
(
øø& '
)
øø' (
;
øø( )
Span
ùù 
<
ùù 
byte
ùù 
>
ùù 
keySpan
ùù 
=
ùù  
key
ùù! $
.
ùù$ %
AsSpan
ùù% +
(
ùù+ ,
$num
ùù, -
,
ùù- .
AES_KEY_SIZE
ùù/ ;
)
ùù; <
;
ùù< =
aes
úú 
.
úú 
Key
úú 
=
úú 
keySpan
úú 
.
úú 
ToArray
úú %
(
úú% &
)
úú& '
;
úú' (
aes
ûû 
.
ûû 

GenerateIV
ûû 
(
ûû 
)
ûû 
;
ûû 
using
ýý 
MemoryStream
ýý 
ms
ýý !
=
ýý" #
new
ýý$ '
(
ýý' (
)
ýý( )
;
ýý) *
await
þþ 
ms
þþ 
.
þþ 

WriteAsync
þþ 
(
þþ  
aes
þþ  #
.
þþ# $
IV
þþ$ &
.
þþ& '
AsMemory
þþ' /
(
þþ/ 0
$num
þþ0 1
,
þþ1 2
AES_IV_SIZE
þþ3 >
)
þþ> ?
)
þþ? @
;
þþ@ A
await
€€ 
using
€€ 
(
€€ 
CryptoStream
€€ %
cryptoStream
€€& 2
=
€€3 4
new
€€5 8
(
€€8 9
ms
€€9 ;
,
€€; <
aes
€€= @
.
€€@ A
CreateEncryptor
€€A P
(
€€P Q
)
€€Q R
,
€€R S
CryptoStreamMode
€€T d
.
€€d e
Write
€€e j
)
€€j k
)
€€k l
{
 
await
‚‚ 
cryptoStream
‚‚ "
.
‚‚" #

WriteAsync
‚‚# -
(
‚‚- .
data
‚‚. 2
)
‚‚2 3
;
‚‚3 4
await
ƒƒ 
cryptoStream
ƒƒ "
.
ƒƒ" #"
FlushFinalBlockAsync
ƒƒ# 7
(
ƒƒ7 8
)
ƒƒ8 9
;
ƒƒ9 :
}
„„ 
return
†† 
Option
†† 
<
†† 
byte
†† 
[
†† 
]
††  
>
††  !
.
††! "
Some
††" &
(
††& '
ms
††' )
.
††) *
ToArray
††* 1
(
††1 2
)
††2 3
)
††3 4
;
††4 5
}
‡‡ 	
catch
ˆˆ 
(
ˆˆ 
	Exception
ˆˆ 
ex
ˆˆ 
)
ˆˆ 
{
‰‰ 	
Log
ŠŠ 
.
ŠŠ 
Error
ŠŠ 
(
ŠŠ 
ex
ŠŠ 
,
ŠŠ 
$str
ŠŠ 6
)
ŠŠ6 7
;
ŠŠ7 8
return
‹‹ 
Option
‹‹ 
<
‹‹ 
byte
‹‹ 
[
‹‹ 
]
‹‹  
>
‹‹  !
.
‹‹! "
None
‹‹" &
;
‹‹& '
}
ŒŒ 	
}
 
public
 

async
 
Task
 
<
 
Option
 
<
 
byte
 !
[
! "
]
" #
>
# $
>
$ %"
HardwareDecryptAsync
& :
(
: ;
byte
; ?
[
? @
]
@ A
data
B F
)
F G
{
 
if
‘‘ 

(
‘‘ 
data
‘‘ 
.
‘‘ 
Length
‘‘ 
<
‘‘ 
AES_IV_SIZE
‘‘ %
)
‘‘% &
{
’’ 	
Log
““ 
.
““ 
Error
““ 
(
““ 
$str““ …
,““… †
data
”” 
.
”” 
Length
”” 
,
”” 
AES_IV_SIZE
”” (
)
””( )
;
””) *
return
•• 
Option
•• 
<
•• 
byte
•• 
[
•• 
]
••  
>
••  !
.
••! "
None
••" &
;
••& '
}
–– 	
byte
˜˜ 
[
˜˜ 
]
˜˜ 
key
˜˜ 
=
˜˜ 
await
˜˜ %
GetOrCreateHmacKeyAsync
˜˜ 2
(
˜˜2 3
)
˜˜3 4
;
˜˜4 5
try
šš 
{
›› 	
using
œœ 
Aes
œœ 
aes
œœ 
=
œœ 
Aes
œœ 
.
œœ  
Create
œœ  &
(
œœ& '
)
œœ' (
;
œœ( )
Span
 
<
 
byte
 
>
 
keySpan
 
=
  
key
! $
.
$ %
AsSpan
% +
(
+ ,
$num
, -
,
- .
AES_KEY_SIZE
/ ;
)
; <
;
< =
aes
žž 
.
žž 
Key
žž 
=
žž 
keySpan
žž 
.
žž 
ToArray
žž %
(
žž% &
)
žž& '
;
žž' (
byte
   
[
   
]
   
iv
   
=
   
new
   
byte
    
[
    !
AES_IV_SIZE
  ! ,
]
  , -
;
  - .
Array
¡¡ 
.
¡¡ 
Copy
¡¡ 
(
¡¡ 
data
¡¡ 
,
¡¡ 
$num
¡¡ 
,
¡¡ 
iv
¡¡  "
,
¡¡" #
$num
¡¡$ %
,
¡¡% &
AES_IV_SIZE
¡¡' 2
)
¡¡2 3
;
¡¡3 4
aes
¢¢ 
.
¢¢ 
IV
¢¢ 
=
¢¢ 
iv
¢¢ 
;
¢¢ 
using
¤¤ 
MemoryStream
¤¤ 
ms
¤¤ !
=
¤¤" #
new
¤¤$ '
(
¤¤' (
data
¤¤( ,
,
¤¤, -
AES_IV_SIZE
¤¤. 9
,
¤¤9 :
data
¤¤; ?
.
¤¤? @
Length
¤¤@ F
-
¤¤G H
AES_IV_SIZE
¤¤I T
)
¤¤T U
;
¤¤U V
await
¥¥ 
using
¥¥ 
CryptoStream
¥¥ $
cs
¥¥% '
=
¥¥( )
new
¥¥* -
(
¥¥- .
ms
¥¥. 0
,
¥¥0 1
aes
¥¥2 5
.
¥¥5 6
CreateDecryptor
¥¥6 E
(
¥¥E F
)
¥¥F G
,
¥¥G H
CryptoStreamMode
¥¥I Y
.
¥¥Y Z
Read
¥¥Z ^
)
¥¥^ _
;
¥¥_ `
using
¦¦ 
MemoryStream
¦¦ 
result
¦¦ %
=
¦¦& '
new
¦¦( +
(
¦¦+ ,
)
¦¦, -
;
¦¦- .
await
¨¨ 
cs
¨¨ 
.
¨¨ 
CopyToAsync
¨¨  
(
¨¨  !
result
¨¨! '
)
¨¨' (
;
¨¨( )
return
©© 
Option
©© 
<
©© 
byte
©© 
[
©© 
]
©©  
>
©©  !
.
©©! "
Some
©©" &
(
©©& '
result
©©' -
.
©©- .
ToArray
©©. 5
(
©©5 6
)
©©6 7
)
©©7 8
;
©©8 9
}
ªª 	
catch
«« 
(
«« 
	Exception
«« 
ex
«« 
)
«« 
{
¬¬ 	
Log
­­ 
.
­­ 
Error
­­ 
(
­­ 
ex
­­ 
,
­­ 
$str
­­ X
,
­­X Y
ex
­­Z \
.
­­\ ]
Message
­­] d
)
­­d e
;
­­e f
return
®® 
Option
®® 
<
®® 
byte
®® 
[
®® 
]
®®  
>
®®  !
.
®®! "
None
®®" &
;
®®& '
}
¯¯ 	
}
°° 
private
²² 
Result
²² 
<
²² 
Unit
²² 
,
²² "
SecureStorageFailure
²² -
>
²²- .-
StoreInWindowsCredentialManager
²²/ N
(
²²N O
string
²²O U

identifier
²²V `
,
²²` a
byte
²²b f
[
²²f g
]
²²g h
key
²²i l
)
²²l m
=>
²²n p"
StoreInEncryptedFile
³³ 
(
³³ 

identifier
³³ '
,
³³' (
key
³³) ,
)
³³, -
;
³³- .
private
µµ 
Result
µµ 
<
µµ 
byte
µµ 
[
µµ 
]
µµ 
,
µµ "
SecureStorageFailure
µµ /
>
µµ/ 0-
GetFromWindowsCredentialManager
µµ1 P
(
µµP Q
string
µµQ W

identifier
µµX b
)
µµb c
=>
µµd f"
GetFromEncryptedFile
¶¶ 
(
¶¶ 

identifier
¶¶ '
)
¶¶' (
;
¶¶( )
private
¸¸ 
Result
¸¸ 
<
¸¸ 
Unit
¸¸ 
,
¸¸ "
SecureStorageFailure
¸¸ -
>
¸¸- ."
StoreInMacOsKeychain
¸¸/ C
(
¸¸C D
string
¸¸D J

identifier
¸¸K U
,
¸¸U V
byte
¸¸W [
[
¸¸[ \
]
¸¸\ ]
key
¸¸^ a
)
¸¸a b
=>
¸¸c e"
StoreInEncryptedFile
¹¹ 
(
¹¹ 

identifier
¹¹ '
,
¹¹' (
key
¹¹) ,
)
¹¹, -
;
¹¹- .
private
»» 
Result
»» 
<
»» 
byte
»» 
[
»» 
]
»» 
,
»» "
SecureStorageFailure
»» /
>
»»/ 0"
GetFromMacOsKeychain
»»1 E
(
»»E F
string
»»F L

identifier
»»M W
)
»»W X
=>
»»Y ["
GetFromEncryptedFile
¼¼ 
(
¼¼ 

identifier
¼¼ '
)
¼¼' (
;
¼¼( )
private
¾¾ 
Result
¾¾ 
<
¾¾ 
Unit
¾¾ 
,
¾¾ "
SecureStorageFailure
¾¾ -
>
¾¾- .'
StoreInLinuxSecretService
¾¾/ H
(
¾¾H I
string
¾¾I O

identifier
¾¾P Z
,
¾¾Z [
byte
¾¾\ `
[
¾¾` a
]
¾¾a b
key
¾¾c f
)
¾¾f g
=>
¾¾h j"
StoreInEncryptedFile
¿¿ 
(
¿¿ 

identifier
¿¿ '
,
¿¿' (
key
¿¿) ,
)
¿¿, -
;
¿¿- .
private
ÁÁ 
Result
ÁÁ 
<
ÁÁ 
byte
ÁÁ 
[
ÁÁ 
]
ÁÁ 
,
ÁÁ "
SecureStorageFailure
ÁÁ /
>
ÁÁ/ 0'
GetFromLinuxSecretService
ÁÁ1 J
(
ÁÁJ K
string
ÁÁK Q

identifier
ÁÁR \
)
ÁÁ\ ]
=>
ÁÁ^ `"
GetFromEncryptedFile
ÂÂ 
(
ÂÂ 

identifier
ÂÂ '
)
ÂÂ' (
;
ÂÂ( )
private
ÄÄ 
Result
ÄÄ 
<
ÄÄ 
Unit
ÄÄ 
,
ÄÄ "
SecureStorageFailure
ÄÄ -
>
ÄÄ- ."
StoreInEncryptedFile
ÄÄ/ C
(
ÄÄC D
string
ÄÄD J

identifier
ÄÄK U
,
ÄÄU V
byte
ÄÄW [
[
ÄÄ[ \
]
ÄÄ\ ]
key
ÄÄ^ a
)
ÄÄa b
{
ÅÅ 
try
ÆÆ 
{
ÇÇ 	
string
ÈÈ 
keyFile
ÈÈ 
=
ÈÈ 
GetKeyFilePath
ÈÈ +
(
ÈÈ+ ,

identifier
ÈÈ, 6
)
ÈÈ6 7
;
ÈÈ7 8
Option
ÉÉ 
<
ÉÉ 
byte
ÉÉ 
[
ÉÉ 
]
ÉÉ 
>
ÉÉ 
machineKeyOpt
ÉÉ (
=
ÉÉ) *
GetMachineKey
ÉÉ+ 8
(
ÉÉ8 9
)
ÉÉ9 :
;
ÉÉ: ;
if
ÊÊ 
(
ÊÊ 
!
ÊÊ 
machineKeyOpt
ÊÊ 
.
ÊÊ 
IsSome
ÊÊ %
)
ÊÊ% &
{
ËË 
return
ÌÌ 
Result
ÌÌ 
<
ÌÌ 
Unit
ÌÌ "
,
ÌÌ" #"
SecureStorageFailure
ÌÌ$ 8
>
ÌÌ8 9
.
ÌÌ9 :
Err
ÌÌ: =
(
ÌÌ= >
new
ÍÍ "
SecureStorageFailure
ÍÍ ,
(
ÍÍ, -
$str
ÍÍ- H
)
ÍÍH I
)
ÍÍI J
;
ÍÍJ K
}
ÎÎ 
byte
ÏÏ 
[
ÏÏ 
]
ÏÏ 

machineKey
ÏÏ 
=
ÏÏ 
machineKeyOpt
ÏÏ  -
.
ÏÏ- .
Value
ÏÏ. 3
!
ÏÏ3 4
;
ÏÏ4 5
using
ÑÑ 
Aes
ÑÑ 
aes
ÑÑ 
=
ÑÑ 
Aes
ÑÑ 
.
ÑÑ  
Create
ÑÑ  &
(
ÑÑ& '
)
ÑÑ' (
;
ÑÑ( )
aes
ÒÒ 
.
ÒÒ 
Key
ÒÒ 
=
ÒÒ 

machineKey
ÒÒ  
;
ÒÒ  !
aes
ÓÓ 
.
ÓÓ 

GenerateIV
ÓÓ 
(
ÓÓ 
)
ÓÓ 
;
ÓÓ 
byte
ÕÕ 
[
ÕÕ 
]
ÕÕ 
buffer
ÕÕ 
=
ÕÕ 
	ArrayPool
ÕÕ %
<
ÕÕ% &
byte
ÕÕ& *
>
ÕÕ* +
.
ÕÕ+ ,
Shared
ÕÕ, 2
.
ÕÕ2 3
Rent
ÕÕ3 7
(
ÕÕ7 8
AES_IV_SIZE
ÕÕ8 C
+
ÕÕD E
key
ÕÕF I
.
ÕÕI J
Length
ÕÕJ P
+
ÕÕQ R
$num
ÕÕS U
)
ÕÕU V
;
ÕÕV W
try
ÖÖ 
{
×× 
aes
ØØ 
.
ØØ 
IV
ØØ 
.
ØØ 
CopyTo
ØØ 
(
ØØ 
buffer
ØØ $
,
ØØ$ %
$num
ØØ& '
)
ØØ' (
;
ØØ( )
using
ÚÚ 
ICryptoTransform
ÚÚ &
	encryptor
ÚÚ' 0
=
ÚÚ1 2
aes
ÚÚ3 6
.
ÚÚ6 7
CreateEncryptor
ÚÚ7 F
(
ÚÚF G
)
ÚÚG H
;
ÚÚH I
int
ÛÛ 
encryptedLength
ÛÛ #
=
ÛÛ$ %
	encryptor
ÛÛ& /
.
ÛÛ/ 0
TransformBlock
ÛÛ0 >
(
ÛÛ> ?
key
ÛÛ? B
,
ÛÛB C
$num
ÛÛD E
,
ÛÛE F
key
ÛÛG J
.
ÛÛJ K
Length
ÛÛK Q
,
ÛÛQ R
buffer
ÛÛS Y
,
ÛÛY Z
AES_IV_SIZE
ÛÛ[ f
)
ÛÛf g
;
ÛÛg h
byte
ÜÜ 
[
ÜÜ 
]
ÜÜ 

finalBlock
ÜÜ !
=
ÜÜ" #
	encryptor
ÜÜ$ -
.
ÜÜ- .!
TransformFinalBlock
ÜÜ. A
(
ÜÜA B
key
ÜÜB E
,
ÜÜE F
$num
ÜÜG H
,
ÜÜH I
$num
ÜÜJ K
)
ÜÜK L
;
ÜÜL M
if
ÞÞ 
(
ÞÞ 

finalBlock
ÞÞ 
.
ÞÞ 
Length
ÞÞ %
>
ÞÞ& '
$num
ÞÞ( )
)
ÞÞ) *
{
ßß 

finalBlock
àà 
.
àà 
CopyTo
àà %
(
àà% &
buffer
àà& ,
,
àà, -
AES_IV_SIZE
àà. 9
+
àà: ;
encryptedLength
àà< K
)
ààK L
;
ààL M
encryptedLength
áá #
+=
áá$ &

finalBlock
áá' 1
.
áá1 2
Length
áá2 8
;
áá8 9
}
ââ 
using
ää 

FileStream
ää  
fs
ää! #
=
ää$ %
File
ää& *
.
ää* +
Create
ää+ 1
(
ää1 2
keyFile
ää2 9
)
ää9 :
;
ää: ;
fs
åå 
.
åå 
Write
åå 
(
åå 
buffer
åå 
,
åå  
$num
åå! "
,
åå" #
AES_IV_SIZE
åå$ /
+
åå0 1
encryptedLength
åå2 A
)
ååA B
;
ååB C
if
çç 
(
çç 
!
çç  
RuntimeInformation
çç '
.
çç' (
IsOSPlatform
çç( 4
(
çç4 5

OSPlatform
çç5 ?
.
çç? @
Windows
çç@ G
)
ççG H
)
ççH I
{
èè 
File
éé 
.
éé 
SetUnixFileMode
éé (
(
éé( )
keyFile
éé) 0
,
éé0 1
UnixFileMode
éé2 >
.
éé> ?
UserRead
éé? G
|
ééH I
UnixFileMode
ééJ V
.
ééV W
	UserWrite
ééW `
)
éé` a
;
ééa b
}
êê 
return
ìì 
Result
ìì 
<
ìì 
Unit
ìì "
,
ìì" #"
SecureStorageFailure
ìì$ 8
>
ìì8 9
.
ìì9 :
Ok
ìì: <
(
ìì< =
Unit
ìì= A
.
ììA B
Value
ììB G
)
ììG H
;
ììH I
}
íí 
finally
îî 
{
ïï 
	ArrayPool
ðð 
<
ðð 
byte
ðð 
>
ðð 
.
ðð  
Shared
ðð  &
.
ðð& '
Return
ðð' -
(
ðð- .
buffer
ðð. 4
,
ðð4 5

clearArray
ðð6 @
:
ðð@ A
true
ððB F
)
ððF G
;
ððG H
}
ññ 
}
òò 	
catch
óó 
(
óó 
	Exception
óó 
ex
óó 
)
óó 
{
ôô 	
return
õõ 
Result
õõ 
<
õõ 
Unit
õõ 
,
õõ "
SecureStorageFailure
õõ  4
>
õõ4 5
.
õõ5 6
Err
õõ6 9
(
õõ9 :
new
öö "
SecureStorageFailure
öö (
(
öö( )
$"
öö) +
$str
öö+ K
{
ööK L
ex
ööL N
.
ööN O
Message
ööO V
}
ööV W
"
ööW X
)
ööX Y
)
ööY Z
;
ööZ [
}
÷÷ 	
}
øø 
private
úú 
Result
úú 
<
úú 
byte
úú 
[
úú 
]
úú 
,
úú "
SecureStorageFailure
úú /
>
úú/ 0"
GetFromEncryptedFile
úú1 E
(
úúE F
string
úúF L

identifier
úúM W
)
úúW X
{
ûû 
string
üü 
keyFile
üü 
=
üü 
GetKeyFilePath
üü '
(
üü' (

identifier
üü( 2
)
üü2 3
;
üü3 4
if
ýý 

(
ýý 
!
ýý 
File
ýý 
.
ýý 
Exists
ýý 
(
ýý 
keyFile
ýý  
)
ýý  !
)
ýý! "
{
þþ 	
Log
ÿÿ 
.
ÿÿ 
Debug
ÿÿ 
(
ÿÿ 
$str
ÿÿ b
,
ÿÿb c

identifier
€€ 
,
€€ 
keyFile
€€ #
)
€€# $
;
€€$ %
return
 
Result
 
<
 
byte
 
[
 
]
  
,
  !"
SecureStorageFailure
" 6
>
6 7
.
7 8
Err
8 ;
(
; <
new
‚‚ "
SecureStorageFailure
‚‚ (
(
‚‚( )
$str
‚‚) =
)
‚‚= >
)
‚‚> ?
;
‚‚? @
}
ƒƒ 	
try
…… 
{
†† 	
byte
‡‡ 
[
‡‡ 
]
‡‡ 
	encrypted
‡‡ 
=
‡‡ 
File
‡‡ #
.
‡‡# $
ReadAllBytes
‡‡$ 0
(
‡‡0 1
keyFile
‡‡1 8
)
‡‡8 9
;
‡‡9 :
if
ˆˆ 
(
ˆˆ 
	encrypted
ˆˆ 
.
ˆˆ 
Length
ˆˆ  
<
ˆˆ! "
AES_IV_SIZE
ˆˆ# .
)
ˆˆ. /
{
‰‰ 
Log
ŠŠ 
.
ŠŠ 
Error
ŠŠ 
(
ŠŠ 
$str‹‹ ‘
,‹‹‘ ’

identifier
ŒŒ 
,
ŒŒ 
	encrypted
ŒŒ  )
.
ŒŒ) *
Length
ŒŒ* 0
,
ŒŒ0 1
AES_IV_SIZE
ŒŒ2 =
)
ŒŒ= >
;
ŒŒ> ?
return
 
Result
 
<
 
byte
 "
[
" #
]
# $
,
$ %"
SecureStorageFailure
& :
>
: ;
.
; <
Err
< ?
(
? @
new
ŽŽ "
SecureStorageFailure
ŽŽ ,
(
ŽŽ, -
$str
ŽŽ- L
)
ŽŽL M
)
ŽŽM N
;
ŽŽN O
}
 
Option
‘‘ 
<
‘‘ 
byte
‘‘ 
[
‘‘ 
]
‘‘ 
>
‘‘ 
machineKeyOpt
‘‘ (
=
‘‘) *
GetMachineKey
‘‘+ 8
(
‘‘8 9
)
‘‘9 :
;
‘‘: ;
if
’’ 
(
’’ 
!
’’ 
machineKeyOpt
’’ 
.
’’ 
IsSome
’’ %
)
’’% &
{
““ 
return
”” 
Result
”” 
<
”” 
byte
”” "
[
””" #
]
””# $
,
””$ %"
SecureStorageFailure
””& :
>
””: ;
.
””; <
Err
””< ?
(
””? @
new
•• "
SecureStorageFailure
•• ,
(
••, -
$str
••- H
)
••H I
)
••I J
;
••J K
}
–– 
byte
—— 
[
—— 
]
—— 

machineKey
—— 
=
—— 
machineKeyOpt
——  -
.
——- .
Value
——. 3
!
——3 4
;
——4 5
using
™™ 
Aes
™™ 
aes
™™ 
=
™™ 
Aes
™™ 
.
™™  
Create
™™  &
(
™™& '
)
™™' (
;
™™( )
aes
šš 
.
šš 
Key
šš 
=
šš 

machineKey
šš  
;
šš  !
Span
œœ 
<
œœ 
byte
œœ 
>
œœ 
iv
œœ 
=
œœ 
	encrypted
œœ %
.
œœ% &
AsSpan
œœ& ,
(
œœ, -
$num
œœ- .
,
œœ. /
AES_IV_SIZE
œœ0 ;
)
œœ; <
;
œœ< =
aes
 
.
 
IV
 
=
 
iv
 
.
 
ToArray
 
(
  
)
  !
;
! "
using
ŸŸ 
ICryptoTransform
ŸŸ "
	decryptor
ŸŸ# ,
=
ŸŸ- .
aes
ŸŸ/ 2
.
ŸŸ2 3
CreateDecryptor
ŸŸ3 B
(
ŸŸB C
)
ŸŸC D
;
ŸŸD E
byte
   
[
   
]
   
	decrypted
   
=
   
	decryptor
   (
.
  ( )!
TransformFinalBlock
  ) <
(
  < =
	encrypted
  = F
,
  F G
AES_IV_SIZE
  H S
,
  S T
	encrypted
  U ^
.
  ^ _
Length
  _ e
-
  f g
AES_IV_SIZE
  h s
)
  s t
;
  t u
return
¢¢ 
Result
¢¢ 
<
¢¢ 
byte
¢¢ 
[
¢¢ 
]
¢¢  
,
¢¢  !"
SecureStorageFailure
¢¢" 6
>
¢¢6 7
.
¢¢7 8
Ok
¢¢8 :
(
¢¢: ;
	decrypted
¢¢; D
)
¢¢D E
;
¢¢E F
}
££ 	
catch
¤¤ 
(
¤¤ $
CryptographicException
¤¤ %
)
¤¤% &
{
¥¥ 	
try
¦¦ 
{
§§ 
File
¨¨ 
.
¨¨ 
Delete
¨¨ 
(
¨¨ 
keyFile
¨¨ #
)
¨¨# $
;
¨¨$ %
}
©© 
catch
ªª 
(
ªª 
	Exception
ªª 
deleteEx
ªª %
)
ªª% &
{
«« 
Log
¬¬ 
.
¬¬ 
Error
¬¬ 
(
¬¬ 
deleteEx
¬¬ "
,
¬¬" #
$str­­ Ž
,­­Ž 

identifier
®® 
,
®® 
keyFile
®®  '
,
®®' (
deleteEx
®®) 1
.
®®1 2
Message
®®2 9
)
®®9 :
;
®®: ;
}
¯¯ 
return
±± 
Result
±± 
<
±± 
byte
±± 
[
±± 
]
±±  
,
±±  !"
SecureStorageFailure
±±" 6
>
±±6 7
.
±±7 8
Err
±±8 ;
(
±±; <
new
²² "
SecureStorageFailure
²² (
(
²²( )
$str
²²) U
)
²²U V
)
²²V W
;
²²W X
}
³³ 	
catch
´´ 
(
´´ 
	Exception
´´ 
ex
´´ 
)
´´ 
{
µµ 	
Log
¶¶ 
.
¶¶ 
Error
¶¶ 
(
¶¶ 
ex
¶¶ 
,
¶¶ 
$str
·· }
,
··} ~

identifier
¸¸ 
,
¸¸ 
keyFile
¸¸ #
,
¸¸# $
ex
¸¸% '
.
¸¸' (
Message
¸¸( /
)
¸¸/ 0
;
¸¸0 1
return
¹¹ 
Result
¹¹ 
<
¹¹ 
byte
¹¹ 
[
¹¹ 
]
¹¹  
,
¹¹  !"
SecureStorageFailure
¹¹" 6
>
¹¹6 7
.
¹¹7 8
Err
¹¹8 ;
(
¹¹; <
new
ºº "
SecureStorageFailure
ºº (
(
ºº( )
$"
ºº) +
$str
ºº+ J
{
ººJ K
ex
ººK M
.
ººM N
Message
ººN U
}
ººU V
"
ººV W
)
ººW X
)
ººX Y
;
ººY Z
}
»» 	
}
¼¼ 
private
¾¾ 
string
¾¾ 
GetKeyFilePath
¾¾ !
(
¾¾! "
string
¾¾" (

identifier
¾¾) 3
)
¾¾3 4
{
¿¿ 
ReadOnlySpan
ÀÀ 
<
ÀÀ 
byte
ÀÀ 
>
ÀÀ 
identifierBytes
ÀÀ *
=
ÀÀ+ ,
Encoding
ÀÀ- 5
.
ÀÀ5 6
UTF8
ÀÀ6 :
.
ÀÀ: ;
GetBytes
ÀÀ; C
(
ÀÀC D

identifier
ÀÀD N
)
ÀÀN O
;
ÀÀO P
Span
ÁÁ 
<
ÁÁ 
byte
ÁÁ 
>
ÁÁ 

hashBuffer
ÁÁ 
=
ÁÁ 

stackalloc
ÁÁ  *
byte
ÁÁ+ /
[
ÁÁ/ 0
$num
ÁÁ0 2
]
ÁÁ2 3
;
ÁÁ3 4
SHA256
ÂÂ 
.
ÂÂ 
HashData
ÂÂ 
(
ÂÂ 
identifierBytes
ÂÂ '
,
ÂÂ' (

hashBuffer
ÂÂ) 3
)
ÂÂ3 4
;
ÂÂ4 5
string
ÄÄ 
safeIdentifier
ÄÄ 
=
ÄÄ 
Convert
ÄÄ  '
.
ÄÄ' (
ToBase64String
ÄÄ( 6
(
ÄÄ6 7

hashBuffer
ÄÄ7 A
)
ÄÄA B
.
ÅÅ 
Replace
ÅÅ 
(
ÅÅ 
$char
ÅÅ 
,
ÅÅ 
$char
ÅÅ 
)
ÅÅ 
.
ÆÆ 
Replace
ÆÆ 
(
ÆÆ 
$char
ÆÆ 
,
ÆÆ 
$char
ÆÆ 
)
ÆÆ 
;
ÆÆ 
return
ÈÈ 
Path
ÈÈ 
.
ÈÈ 
Combine
ÈÈ 
(
ÈÈ 
_keychainPath
ÈÈ )
,
ÈÈ) *
$"
ÈÈ+ -
{
ÈÈ- .
safeIdentifier
ÈÈ. <
}
ÈÈ< =
$str
ÈÈ= A
"
ÈÈA B
)
ÈÈB C
;
ÈÈC D
}
ÉÉ 
private
ËË 
Option
ËË 
<
ËË 
byte
ËË 
[
ËË 
]
ËË 
>
ËË 
GetMachineKey
ËË (
(
ËË( )
)
ËË) *
{
ÌÌ 
if
ÍÍ 

(
ÍÍ 
_cachedMachineKey
ÍÍ 
!=
ÍÍ  
null
ÍÍ! %
)
ÍÍ% &
{
ÎÎ 	
return
ÏÏ 
Option
ÏÏ 
<
ÏÏ 
byte
ÏÏ 
[
ÏÏ 
]
ÏÏ  
>
ÏÏ  !
.
ÏÏ! "
Some
ÏÏ" &
(
ÏÏ& '
_cachedMachineKey
ÏÏ' 8
)
ÏÏ8 9
;
ÏÏ9 :
}
ÐÐ 	
string
ÒÒ 
machineKeyFile
ÒÒ 
=
ÒÒ 
Path
ÒÒ  $
.
ÒÒ$ %
Combine
ÒÒ% ,
(
ÒÒ, -
_keychainPath
ÒÒ- :
,
ÒÒ: ;"
MACHINE_KEY_FILENAME
ÒÒ< P
)
ÒÒP Q
;
ÒÒQ R
string
ÓÓ 
	machineId
ÓÓ 
=
ÓÓ $
BuildMachineIdentifier
ÓÓ 1
(
ÓÓ1 2
)
ÓÓ2 3
;
ÓÓ3 4
if
ÕÕ 

(
ÕÕ 
File
ÕÕ 
.
ÕÕ 
Exists
ÕÕ 
(
ÕÕ 
machineKeyFile
ÕÕ &
)
ÕÕ& '
)
ÕÕ' (
{
ÖÖ 	
try
×× 
{
ØØ 
_cachedMachineKey
ÙÙ !
=
ÙÙ" #
File
ÙÙ$ (
.
ÙÙ( )
ReadAllBytes
ÙÙ) 5
(
ÙÙ5 6
machineKeyFile
ÙÙ6 D
)
ÙÙD E
;
ÙÙE F
if
ÚÚ 
(
ÚÚ 
_cachedMachineKey
ÚÚ %
.
ÚÚ% &
Length
ÚÚ& ,
!=
ÚÚ- /
AES_KEY_SIZE
ÚÚ0 <
)
ÚÚ< =
{
ÛÛ 
_cachedMachineKey
ÜÜ %
=
ÜÜ& '
null
ÜÜ( ,
;
ÜÜ, -
return
ÝÝ 
Option
ÝÝ !
<
ÝÝ! "
byte
ÝÝ" &
[
ÝÝ& '
]
ÝÝ' (
>
ÝÝ( )
.
ÝÝ) *
None
ÝÝ* .
;
ÝÝ. /
}
ÞÞ 
byte
àà 
[
àà 
]
àà 

derivedKey
àà !
=
àà" #$
DeriveKeyFromMachineId
àà$ :
(
àà: ;
	machineId
àà; D
)
ààD E
;
ààE F
if
ââ 
(
ââ 
!
ââ %
CryptographicOperations
ââ ,
.
ââ, -
FixedTimeEquals
ââ- <
(
ââ< =

derivedKey
ââ= G
,
ââG H
_cachedMachineKey
ââI Z
)
ââZ [
)
ââ[ \
{
ãã %
CryptographicOperations
ää +
.
ää+ ,

ZeroMemory
ää, 6
(
ää6 7

derivedKey
ää7 A
)
ääA B
;
ääB C
_cachedMachineKey
åå %
=
åå& '
null
åå( ,
;
åå, -
return
ææ 
Option
ææ !
<
ææ! "
byte
ææ" &
[
ææ& '
]
ææ' (
>
ææ( )
.
ææ) *
None
ææ* .
;
ææ. /
}
çç %
CryptographicOperations
éé '
.
éé' (

ZeroMemory
éé( 2
(
éé2 3

derivedKey
éé3 =
)
éé= >
;
éé> ?
return
êê 
Option
êê 
<
êê 
byte
êê "
[
êê" #
]
êê# $
>
êê$ %
.
êê% &
Some
êê& *
(
êê* +
_cachedMachineKey
êê+ <
)
êê< =
;
êê= >
}
ëë 
catch
ìì 
(
ìì 
	Exception
ìì 
ex
ìì 
)
ìì  
{
íí 
Log
îî 
.
îî 
Error
îî 
(
îî 
ex
îî 
,
îî 
$str
îî e
,
îîe f
ex
ïï 
.
ïï 
Message
ïï 
)
ïï 
;
ïï  
_cachedMachineKey
ðð !
=
ðð" #
null
ðð$ (
;
ðð( )
return
ññ 
Option
ññ 
<
ññ 
byte
ññ "
[
ññ" #
]
ññ# $
>
ññ$ %
.
ññ% &
None
ññ& *
;
ññ* +
}
òò 
}
óó 	
_cachedMachineKey
õõ 
=
õõ $
DeriveKeyFromMachineId
õõ 2
(
õõ2 3
	machineId
õõ3 <
)
õõ< =
;
õõ= >
try
÷÷ 
{
øø 	
File
ùù 
.
ùù 
WriteAllBytes
ùù 
(
ùù 
machineKeyFile
ùù -
,
ùù- .
_cachedMachineKey
ùù/ @
)
ùù@ A
;
ùùA B
if
úú 
(
úú 
!
úú  
RuntimeInformation
úú #
.
úú# $
IsOSPlatform
úú$ 0
(
úú0 1

OSPlatform
úú1 ;
.
úú; <
Windows
úú< C
)
úúC D
)
úúD E
{
ûû 
File
üü 
.
üü 
SetUnixFileMode
üü $
(
üü$ %
machineKeyFile
üü% 3
,
üü3 4
UnixFileMode
üü5 A
.
üüA B
UserRead
üüB J
|
üüK L
UnixFileMode
üüM Y
.
üüY Z
	UserWrite
üüZ c
)
üüc d
;
üüd e
}
ýý 
}
þþ 	
catch
ÿÿ 
(
ÿÿ 
	Exception
ÿÿ 
ex
ÿÿ 
)
ÿÿ 
{
€€ 	
Log
 
.
 
Error
 
(
 
ex
 
,
 
$str
 Y
,
Y Z
ex
‚‚ 
.
‚‚ 
Message
‚‚ 
)
‚‚ 
;
‚‚ 
}
ƒƒ 	
return
…… 
Option
…… 
<
…… 
byte
…… 
[
…… 
]
…… 
>
…… 
.
…… 
Some
…… "
(
……" #
_cachedMachineKey
……# 4
)
……4 5
;
……5 6
}
†† 
private
ˆˆ 
static
ˆˆ 
void
ˆˆ *
TryEnhanceWithHardwareRandom
ˆˆ 4
(
ˆˆ4 5
Span
ˆˆ5 9
<
ˆˆ9 :
byte
ˆˆ: >
>
ˆˆ> ?
bytes
ˆˆ@ E
)
ˆˆE F
{
‰‰ 
try
ŠŠ 
{
‹‹ 	
using
ŒŒ 

FileStream
ŒŒ 
hwRandom
ŒŒ %
=
ŒŒ& '
File
ŒŒ( ,
.
ŒŒ, -
OpenRead
ŒŒ- 5
(
ŒŒ5 6
$str
ŒŒ6 C
)
ŒŒC D
;
ŒŒD E
int
 
	bytesRead
 
=
 
hwRandom
 $
.
$ %
Read
% )
(
) *
bytes
* /
)
/ 0
;
0 1
if
ŽŽ 
(
ŽŽ 
	bytesRead
ŽŽ 
>=
ŽŽ 
bytes
ŽŽ "
.
ŽŽ" #
Length
ŽŽ# )
)
ŽŽ) *
{
 
return
 
;
 
}
‘‘ 
Span
““ 
<
““ 
byte
““ 
>
““ 

tempBuffer
““ !
=
““" #

stackalloc
““$ .
byte
““/ 3
[
““3 4
bytes
““4 9
.
““9 :
Length
““: @
]
““@ A
;
““A B#
RandomNumberGenerator
”” !
.
””! "
Fill
””" &
(
””& '

tempBuffer
””' 1
)
””1 2
;
””2 3
for
•• 
(
•• 
int
•• 
i
•• 
=
•• 
$num
•• 
;
•• 
i
•• 
<
•• 
bytes
••  %
.
••% &
Length
••& ,
;
••, -
i
••. /
++
••/ 1
)
••1 2
{
–– 
bytes
—— 
[
—— 
i
—— 
]
—— 
^=
—— 

tempBuffer
—— &
[
——& '
i
——' (
]
——( )
;
——) *
}
˜˜ 
}
™™ 	
catch
šš 
(
šš 
	Exception
šš 
)
šš 
{
›› 	
}
 	
}
žž 
private
   
static
   
string
   $
BuildMachineIdentifier
   0
(
  0 1
)
  1 2
{
¡¡ 
StringBuilder
¢¢ 
	machineId
¢¢ 
=
¢¢  !
new
¢¢" %
(
¢¢% &
Environment
¢¢& 1
.
¢¢1 2
MachineName
¢¢2 =
)
¢¢= >
;
¢¢> ?
	machineId
££ 
.
££ 
Append
££ 
(
££ 
Environment
££ $
.
££$ %
ProcessorCount
££% 3
)
££3 4
;
££4 5
if
¥¥ 

(
¥¥  
RuntimeInformation
¥¥ 
.
¥¥ 
IsOSPlatform
¥¥ +
(
¥¥+ ,

OSPlatform
¥¥, 6
.
¥¥6 7
Linux
¥¥7 <
)
¥¥< =
)
¥¥= >
{
¦¦ 	%
TryAppendLinuxMachineId
§§ #
(
§§# $
	machineId
§§$ -
)
§§- .
;
§§. /
}
¨¨ 	
else
©© 
if
©© 
(
©©  
RuntimeInformation
©© #
.
©©# $
IsOSPlatform
©©$ 0
(
©©0 1

OSPlatform
©©1 ;
.
©©; <
OSX
©©< ?
)
©©? @
)
©©@ A
{
ªª 	 
TryAppendMacOsuuid
«« 
(
«« 
	machineId
«« (
)
««( )
;
««) *
}
¬¬ 	
return
®® 
	machineId
®® 
.
®® 
ToString
®® !
(
®®! "
)
®®" #
;
®®# $
}
¯¯ 
private
±± 
static
±± 
void
±± %
TryAppendLinuxMachineId
±± /
(
±±/ 0
StringBuilder
±±0 =
	machineId
±±> G
)
±±G H
{
²² 
try
³³ 
{
´´ 	
string
µµ 
id
µµ 
=
µµ 
File
µµ 
.
µµ 
ReadAllText
µµ (
(
µµ( )#
LINUX_MACHINE_ID_PATH
µµ) >
)
µµ> ?
.
µµ? @
Trim
µµ@ D
(
µµD E
)
µµE F
;
µµF G
	machineId
¶¶ 
.
¶¶ 
Append
¶¶ 
(
¶¶ 
id
¶¶ 
)
¶¶  
;
¶¶  !
}
·· 	
catch
¸¸ 
{
¹¹ 	
	machineId
ºº 
.
ºº 
Append
ºº 
(
ºº 
$str
ºº *
)
ºº* +
;
ºº+ ,
}
»» 	
}
¼¼ 
private
¾¾ 
static
¾¾ 
void
¾¾  
TryAppendMacOsuuid
¾¾ *
(
¾¾* +
StringBuilder
¾¾+ 8
	machineId
¾¾9 B
)
¾¾B C
{
¿¿ 
try
ÀÀ 
{
ÁÁ 	
using
ÂÂ 
System
ÂÂ 
.
ÂÂ 
Diagnostics
ÂÂ $
.
ÂÂ$ %
Process
ÂÂ% ,
process
ÂÂ- 4
=
ÂÂ5 6
new
ÂÂ7 :
(
ÂÂ: ;
)
ÂÂ; <
{
ÃÃ 
	StartInfo
ÄÄ 
=
ÄÄ 
new
ÄÄ 
System
ÄÄ  &
.
ÄÄ& '
Diagnostics
ÄÄ' 2
.
ÄÄ2 3
ProcessStartInfo
ÄÄ3 C
{
ÅÅ 
FileName
ÆÆ 
=
ÆÆ 
$str
ÆÆ &
,
ÆÆ& '
	Arguments
ÇÇ 
=
ÇÇ 
$str
ÇÇ  @
,
ÇÇ@ A$
RedirectStandardOutput
ÈÈ *
=
ÈÈ+ ,
true
ÈÈ- 1
,
ÈÈ1 2
UseShellExecute
ÉÉ #
=
ÉÉ$ %
false
ÉÉ& +
,
ÉÉ+ ,
CreateNoWindow
ÊÊ "
=
ÊÊ# $
true
ÊÊ% )
}
ËË 
}
ÌÌ 
;
ÌÌ 
process
ÎÎ 
.
ÎÎ 
Start
ÎÎ 
(
ÎÎ 
)
ÎÎ 
;
ÎÎ 
string
ÏÏ 
output
ÏÏ 
=
ÏÏ 
process
ÏÏ #
.
ÏÏ# $
StandardOutput
ÏÏ$ 2
.
ÏÏ2 3
	ReadToEnd
ÏÏ3 <
(
ÏÏ< =
)
ÏÏ= >
;
ÏÏ> ?
if
ÑÑ 
(
ÑÑ 
!
ÑÑ 
process
ÑÑ 
.
ÑÑ 
WaitForExit
ÑÑ $
(
ÑÑ$ %
$num
ÑÑ% )
)
ÑÑ) *
)
ÑÑ* +
{
ÒÒ 
process
ÓÓ 
.
ÓÓ 
Kill
ÓÓ 
(
ÓÓ 
)
ÓÓ 
;
ÓÓ 
	machineId
ÔÔ 
.
ÔÔ 
Append
ÔÔ  
(
ÔÔ  !
$str
ÔÔ! 1
)
ÔÔ1 2
;
ÔÔ2 3
return
ÕÕ 
;
ÕÕ 
}
ÖÖ 
Match
ØØ 
match
ØØ 
=
ØØ 
Regex
ØØ 
.
ØØ  
Match
ØØ  %
(
ØØ% &
output
ØØ& ,
,
ØØ, - 
MACOS_UUID_PATTERN
ØØ. @
,
ØØ@ A
RegexOptions
ØØB N
.
ØØN O
None
ØØO S
,
ØØS T
TimeSpan
ØØU ]
.
ØØ] ^
FromSeconds
ØØ^ i
(
ØØi j
$num
ØØj k
)
ØØk l
)
ØØl m
;
ØØm n
	machineId
ÙÙ 
.
ÙÙ 
Append
ÙÙ 
(
ÙÙ 
match
ÙÙ "
.
ÙÙ" #
Success
ÙÙ# *
?
ÙÙ+ ,
match
ÙÙ- 2
.
ÙÙ2 3
Groups
ÙÙ3 9
[
ÙÙ9 :
$num
ÙÙ: ;
]
ÙÙ; <
.
ÙÙ< =
Value
ÙÙ= B
:
ÙÙC D
$str
ÙÙE M
)
ÙÙM N
;
ÙÙN O
}
ÚÚ 	
catch
ÛÛ 
{
ÜÜ 	
	machineId
ÝÝ 
.
ÝÝ 
Append
ÝÝ 
(
ÝÝ 
$str
ÝÝ &
)
ÝÝ& '
;
ÝÝ' (
}
ÞÞ 	
}
ßß 
private
áá 
static
áá 
byte
áá 
[
áá 
]
áá $
DeriveKeyFromMachineId
áá 0
(
áá0 1
string
áá1 7
	machineId
áá8 A
)
ááA B
{
ââ 
ReadOnlySpan
ãã 
<
ãã 
byte
ãã 
>
ãã 
salt
ãã 
=
ãã  !
SHA256
ãã" (
.
ãã( )
HashData
ãã) 1
(
ãã1 2
Encoding
ãã2 :
.
ãã: ;
UTF8
ãã; ?
.
ãã? @
GetBytes
ãã@ H
(
ããH I
MACHINE_KEY_SALT
ããI Y
)
ããY Z
)
ããZ [
;
ãã[ \
using
åå  
Rfc2898DeriveBytes
åå  
pbkdf2
åå! '
=
åå( )
new
åå* -
(
åå- .
	machineId
ææ 
,
ææ 
salt
çç 
.
çç 
ToArray
çç 
(
çç 
)
çç 
,
çç  
PBKDF_2_ITERATIONS
èè 
,
èè 
HashAlgorithmName
éé 
.
éé 
SHA256
éé $
)
éé$ %
;
éé% &
return
ëë 
pbkdf2
ëë 
.
ëë 
GetBytes
ëë 
(
ëë 
AES_KEY_SIZE
ëë +
)
ëë+ ,
;
ëë, -
}
ìì 
private
îî 
static
îî 
bool
îî 
CheckLinuxTpm
îî %
(
îî% &
)
îî& '
=>
îî( *
File
ïï 
.
ïï 
Exists
ïï 
(
ïï 
LINUX_TPM_PATH
ïï "
)
ïï" #
||
ïï$ &
File
ïï' +
.
ïï+ ,
Exists
ïï, 2
(
ïï2 3
LINUX_TPMRM_PATH
ïï3 C
)
ïïC D
;
ïïD E
private
ññ 
static
ññ 
bool
ññ 
CheckWindowsTpm
ññ '
(
ññ' (
)
ññ( )
{
òò 
if
óó 

(
óó 
!
óó  
RuntimeInformation
óó 
.
óó  
IsOSPlatform
óó  ,
(
óó, -

OSPlatform
óó- 7
.
óó7 8
Windows
óó8 ?
)
óó? @
)
óó@ A
{
ôô 	
return
õõ 
false
õõ 
;
õõ 
}
öö 	
try
øø 
{
ùù 	
using
úú 
	Microsoft
úú 
.
úú 
Win32
úú !
.
úú! "
RegistryKey
úú" -
?
úú- .
key
úú/ 2
=
úú3 4
	Microsoft
ûû 
.
ûû 
Win32
ûû 
.
ûû  
Registry
ûû  (
.
ûû( )
LocalMachine
ûû) 5
.
ûû5 6

OpenSubKey
ûû6 @
(
ûû@ A
TPM_REGISTRY_PATH
ûûA R
)
ûûR S
;
ûûS T
return
üü 
key
üü 
!=
üü 
null
üü 
;
üü 
}
ýý 	
catch
þþ 
{
ÿÿ 	
return
€€ 
false
€€ 
;
€€ 
}
 	
}
‚‚ 
private
„„ 
static
„„ 
bool
„„ %
CheckMacOsSecureEnclave
„„ /
(
„„/ 0
)
„„0 1
{
…… 
try
†† 
{
‡‡ 	
using
ˆˆ 
System
ˆˆ 
.
ˆˆ 
Diagnostics
ˆˆ $
.
ˆˆ$ %
Process
ˆˆ% ,
process
ˆˆ- 4
=
ˆˆ5 6
new
ˆˆ7 :
(
ˆˆ: ;
)
ˆˆ; <
;
ˆˆ< =
process
‰‰ 
.
‰‰ 
	StartInfo
‰‰ 
=
‰‰ 
new
‰‰  #
System
‰‰$ *
.
‰‰* +
Diagnostics
‰‰+ 6
.
‰‰6 7
ProcessStartInfo
‰‰7 G
{
ŠŠ 
FileName
‹‹ 
=
‹‹ 
$str
‹‹ #
,
‹‹# $
	Arguments
ŒŒ 
=
ŒŒ 
$str
ŒŒ 2
,
ŒŒ2 3$
RedirectStandardOutput
 &
=
' (
true
) -
,
- .
UseShellExecute
ŽŽ 
=
ŽŽ  !
false
ŽŽ" '
,
ŽŽ' (
CreateNoWindow
 
=
  
true
! %
}
 
;
 
process
’’ 
.
’’ 
Start
’’ 
(
’’ 
)
’’ 
;
’’ 
string
““ 
output
““ 
=
““ 
process
““ #
.
““# $
StandardOutput
““$ 2
.
““2 3
	ReadToEnd
““3 <
(
““< =
)
““= >
;
““> ?
if
•• 
(
•• 
!
•• 
process
•• 
.
•• 
WaitForExit
•• $
(
••$ %
$num
••% )
)
••) *
)
••* +
{
–– 
process
—— 
.
—— 
Kill
—— 
(
—— 
)
—— 
;
—— 
return
˜˜ 
false
˜˜ 
;
˜˜ 
}
™™ 
return
›› 
output
›› 
.
›› 
Trim
›› 
(
›› 
)
››  
==
››! #
$str
››$ '
;
››' (
}
œœ 	
catch
 
{
žž 	
return
ŸŸ 
false
ŸŸ 
;
ŸŸ 
}
   	
}
¡¡ 
}¢¢ ”
•/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/KeySplitting/IHardenedKeyDerivation.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
KeySplitting0 <
;< =
public 
	interface "
IHardenedKeyDerivation '
{		 
Task

 
<

 	
Result

	 
<

 $
SodiumSecureMemoryHandle

 (
,

( )
KeySplittingFailure

* =
>

= >
>

> ?.
"DeriveEnhancedMasterKeyHandleAsync

@ b
(

b c$
SodiumSecureMemoryHandle  
baseKeyHandle! .
,. /
string 
context 
,  
KeyDerivationOptions 
options $
)$ %
;% &
} 
public 
class  
KeyDerivationOptions !
{ 
public 

int 
MEMORY_SIZE 
{ 
get  
;  !
set" %
;% &
}' (
=) *
$num+ 1
;1 2
public 

int 

ITERATIONS 
{ 
get 
;  
set! $
;$ %
}& '
=( )
$num* +
;+ ,
public 

int 
DegreeOfParallelism "
{# $
get% (
;( )
set* -
;- .
}/ 0
=1 2
$num3 4
;4 5
public 

bool 
UseHardwareEntropy "
{# $
get% (
;( )
set* -
;- .
}/ 0
=1 2
true3 7
;7 8
public 

int 
OutputLength 
{ 
get !
;! "
set# &
;& '
}( )
=* +
$num, .
;. /
} ¨Ò
”/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/KeySplitting/HardenedKeyDerivation.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
KeySplitting0 <
;< =
public 
sealed 
class !
HardenedKeyDerivation )
() *%
IPlatformSecurityProvider* C$
platformSecurityProviderD \
)\ ]
:^ _"
IHardenedKeyDerivation` v
{ 
private 
async 
Task 
< 
Result 
< 
byte "
[" #
]# $
,$ %
KeySplittingFailure& 9
>9 :
>: ;"
DeriveEnhancedKeyAsync< R
(R S
byte 
[ 
] 
baseKey 
, 
string 
context 
,  
KeyDerivationOptions 
options $
)$ %
{ 
try 
{ 	
byte 
[ 
] 
salt 
= 
GenerateContextSalt -
(- .
context. 5
)5 6
;6 7
Result 
< 
byte 
[ 
] 
, 
KeySplittingFailure .
>. /
stretchedResult0 ?
=@ A
await 
StretchKeyAsync %
(% &
baseKey& -
,- .
salt/ 3
,3 4
options5 <
.< =
OutputLength= I
,I J
optionsK R
)R S
;S T
if 
( 
stretchedResult 
.  
IsErr  %
)% &
{ 
return 
stretchedResult &
;& '
}   
byte"" 
["" 
]"" 
stretchedKey"" 
=""  !
stretchedResult""" 1
.""1 2
Unwrap""2 8
(""8 9
)""9 :
;"": ;
byte## 
[## 
]## 
expandedKey## 
=##  
await##! &"
ExpandKeyWithHkdfAsync##' =
(##= >
stretchedKey##> J
,##J K
context##L S
,##S T
options##U \
.##\ ]
OutputLength##] i
)##i j
;##j k
if%% 
(%% 
options%% 
.%% 
UseHardwareEntropy%% *
&&%%+ -$
platformSecurityProvider%%. F
.%%F G'
IsHardwareSecurityAvailable%%G b
(%%b c
)%%c d
)%%d e
{&& 
byte'' 
['' 
]'' 
?'' 
	hwEntropy'' !
=''" #
null''$ (
;''( )
try(( 
{)) 
	hwEntropy** 
=** 
await**  %$
platformSecurityProvider**& >
.**> ?%
GenerateSecureRandomAsync**? X
(**X Y
options**Y `
.**` a
OutputLength**a m
)**m n
;**n o
for++ 
(++ 
int++ 
i++ 
=++  
$num++! "
;++" #
i++$ %
<++& '
expandedKey++( 3
.++3 4
Length++4 :
&&++; =
i++> ?
<++@ A
	hwEntropy++B K
.++K L
Length++L R
;++R S
i++T U
++++U W
)++W X
{,, 
expandedKey-- #
[--# $
i--$ %
]--% &
^=--' )
	hwEntropy--* 3
[--3 4
i--4 5
]--5 6
;--6 7
}.. 
}// 
finally00 
{11 
if22 
(22 
	hwEntropy22 !
!=22" $
null22% )
)22) *
{33 #
CryptographicOperations44 /
.44/ 0

ZeroMemory440 :
(44: ;
	hwEntropy44; D
)44D E
;44E F
}55 
}66 
}77 
byte99 
[99 
]99 
finalKey99 
=99 
await99 #&
ApplyAdditionalRoundsAsync99$ >
(99> ?
expandedKey99? J
)99J K
;99K L#
CryptographicOperations;; #
.;;# $

ZeroMemory;;$ .
(;;. /
stretchedKey;;/ ;
);;; <
;;;< =#
CryptographicOperations<< #
.<<# $

ZeroMemory<<$ .
(<<. /
expandedKey<</ :
)<<: ;
;<<; <
return>> 
Result>> 
<>> 
byte>> 
[>> 
]>>  
,>>  !
KeySplittingFailure>>" 5
>>>5 6
.>>6 7
Ok>>7 9
(>>9 :
finalKey>>: B
)>>B C
;>>C D
}?? 	
catch@@ 
(@@ 
	Exception@@ 
ex@@ 
)@@ 
{AA 	
returnBB 
ResultBB 
<BB 
byteBB 
[BB 
]BB  
,BB  !
KeySplittingFailureBB" 5
>BB5 6
.BB6 7
ErrBB7 :
(BB: ;
KeySplittingFailureBB; N
.BBN O
KeyDerivationFailedBBO b
(BBb c
exBBc e
.BBe f
MessageBBf m
,BBm n
exBBo q
)BBq r
)BBr s
;BBs t
}CC 	
}DD 
privateFF 
asyncFF 
TaskFF 
<FF 
ResultFF 
<FF 
byteFF "
[FF" #
]FF# $
,FF$ %
KeySplittingFailureFF& 9
>FF9 :
>FF: ;
StretchKeyAsyncFF< K
(FFK L
byteGG 
[GG 
]GG 
inputGG 
,GG 
byteHH 
[HH 
]HH 
saltHH 
,HH 
intII 
outputLengthII 
,II  
KeyDerivationOptionsJJ 
optionsJJ $
)JJ$ %
{KK 
tryLL 
{MM 	
returnNN 
awaitNN 
TaskNN 
.NN 
RunNN !
(NN! "
(NN" #
)NN# $
=>NN% '
{OO 
usingPP 
Argon2idPP 
argon2PP %
=PP& '
newPP( +
(PP+ ,
inputPP, 1
)PP1 2
{QQ 
SaltRR 
=RR 
saltRR 
,RR  
DegreeOfParallelismSS '
=SS( )
optionsSS* 1
.SS1 2
DegreeOfParallelismSS2 E
,SSE F

IterationsTT 
=TT  
optionsTT! (
.TT( )

ITERATIONSTT) 3
,TT3 4

MemorySizeUU 
=UU  
optionsUU! (
.UU( )
MEMORY_SIZEUU) 4
}VV 
;VV 
byteXX 
[XX 
]XX 
hashXX 
=XX 
argon2XX $
.XX$ %
GetBytesXX% -
(XX- .
outputLengthXX. :
)XX: ;
;XX; <
returnYY 
ResultYY 
<YY 
byteYY "
[YY" #
]YY# $
,YY$ %
KeySplittingFailureYY& 9
>YY9 :
.YY: ;
OkYY; =
(YY= >
hashYY> B
)YYB C
;YYC D
}ZZ 
)ZZ 
;ZZ 
}[[ 	
catch\\ 
(\\ 
	Exception\\ 
ex\\ 
)\\ 
{]] 	
return^^ 
Result^^ 
<^^ 
byte^^ 
[^^ 
]^^  
,^^  !
KeySplittingFailure^^" 5
>^^5 6
.^^6 7
Err^^7 :
(^^: ;
KeySplittingFailure^^; N
.^^N O
KeyDerivationFailed^^O b
(^^b c
ex^^c e
.^^e f
Message^^f m
,^^m n
ex^^o q
)^^q r
)^^r s
;^^s t
}__ 	
}`` 
privatebb 
staticbb 
bytebb 
[bb 
]bb 
GenerateContextSaltbb -
(bb- .
stringbb. 4
contextbb5 <
)bb< =
{cc 
stringdd 
	saltInputdd 
=dd 
$"dd 
{dd 
StorageKeyConstantsdd 1
.dd1 2
SessionContextdd2 @
.dd@ A
SESSION_KEY_PREFIXddA S
}ddS T
$strddT U
{ddU V
contextddV ]
}dd] ^
"dd^ _
;dd_ `
byteee 
[ee 
]ee 
	saltBytesee 
=ee 
SHA256ee !
.ee! "
HashDataee" *
(ee* +
Encodingee+ 3
.ee3 4
UTF8ee4 8
.ee8 9
GetBytesee9 A
(eeA B
	saltInputeeB K
)eeK L
)eeL M
;eeM N
returnff 
	saltBytesff 
;ff 
}gg 
privateii 
staticii 
asyncii 
Taskii 
<ii 
byteii "
[ii" #
]ii# $
>ii$ %"
ExpandKeyWithHkdfAsyncii& <
(ii< =
byteii= A
[iiA B
]iiB C
keyiiD G
,iiG H
stringiiI O
contextiiP W
,iiW X
intiiY \
outputLengthii] i
)iii j
{jj 
returnkk 
awaitkk 
Taskkk 
.kk 
Runkk 
(kk 
(kk 
)kk  
=>kk! #
{ll 	
Spanmm 
<mm 
bytemm 
>mm 

infoBuffermm !
=mm" #

stackallocmm$ .
bytemm/ 3
[mm3 4"
CryptographicConstantsmm4 J
.mmJ K
BuffermmK Q
.mmQ R
MAX_INFO_SIZEmmR _
]mm_ `
;mm` a
intnn 

infoLengthnn 
=nn 
Encodingnn %
.nn% &
UTF8nn& *
.nn* +
GetBytesnn+ 3
(nn3 4
$"nn4 6
{nn6 7
StorageKeyConstantsnn7 J
.nnJ K
SessionContextnnK Y
.nnY Z
SESSION_KEY_PREFIXnnZ l
}nnl m
$strnnm n
{nnn o
contextnno v
}nnv w
"nnw x
,nnx y

infoBuffer	nnz „
)
nn„ …
;
nn… †
ReadOnlySpanoo 
<oo 
byteoo 
>oo 
infooo #
=oo$ %

infoBufferoo& 0
[oo0 1
..oo1 3

infoLengthoo3 =
]oo= >
;oo> ?
byteqq 
[qq 
]qq 
saltqq 
=qq 
SHA256qq  
.qq  !
HashDataqq! )
(qq) *
Encodingqq* 2
.qq2 3
UTF8qq3 7
.qq7 8
GetBytesqq8 @
(qq@ A
contextqqA H
)qqH I
)qqI J
;qqJ K
bytess 
[ss 
]ss 
pseudoRandomKeyss "
;ss" #
usingtt 
(tt 

HMACSHA512tt 
hmactt "
=tt# $
newtt% (
(tt( )
salttt) -
)tt- .
)tt. /
{uu 
pseudoRandomKeyvv 
=vv  !
hmacvv" &
.vv& '
ComputeHashvv' 2
(vv2 3
keyvv3 6
)vv6 7
;vv7 8
}ww 
byteyy 
[yy 
]yy 
expandedKeyyy 
=yy  
newyy! $
byteyy% )
[yy) *
outputLengthyy* 6
]yy6 7
;yy7 8
intzz 
bytesGeneratedzz 
=zz  
$numzz! "
;zz" #
using|| 

HMACSHA512|| 

expandHmac|| '
=||( )
new||* -
(||- .
pseudoRandomKey||. =
)||= >
;||> ?
byte}} 
[}} 
]}} 
previousBlock}}  
=}}! "
[}}# $
]}}$ %
;}}% &
int 
maxDataToHashSize !
=" #"
CryptographicConstants$ :
.: ;
Buffer; A
.A B#
MAX_PREVIOUS_BLOCK_SIZEB Y
+Z ["
CryptographicConstants\ r
.r s
Buffers y
.y z
MAX_INFO_SIZE	z ‡
+
ˆ ‰
$num
Š ‹
;
‹ Œ
byte
€€ 
[
€€ 
]
€€ 
dataToHashBuffer
€€ #
=
€€$ %
	ArrayPool
€€& /
<
€€/ 0
byte
€€0 4
>
€€4 5
.
€€5 6
Shared
€€6 <
.
€€< =
Rent
€€= A
(
€€A B
maxDataToHashSize
€€B S
)
€€S T
;
€€T U
try
‚‚ 
{
ƒƒ 
int
„„ 
	iteration
„„ 
=
„„ 
$num
„„  !
;
„„! "
while
…… 
(
…… 
bytesGenerated
…… %
<
……& '
outputLength
……( 4
)
……4 5
{
†† 
int
‡‡ 
offset
‡‡ 
=
‡‡  
$num
‡‡! "
;
‡‡" #
previousBlock
ˆˆ !
.
ˆˆ! "
CopyTo
ˆˆ" (
(
ˆˆ( )
dataToHashBuffer
ˆˆ) 9
,
ˆˆ9 :
offset
ˆˆ; A
)
ˆˆA B
;
ˆˆB C
offset
‰‰ 
+=
‰‰ 
previousBlock
‰‰ +
.
‰‰+ ,
Length
‰‰, 2
;
‰‰2 3
info
ŠŠ 
.
ŠŠ 
CopyTo
ŠŠ 
(
ŠŠ  
dataToHashBuffer
ŠŠ  0
.
ŠŠ0 1
AsSpan
ŠŠ1 7
(
ŠŠ7 8
offset
ŠŠ8 >
)
ŠŠ> ?
)
ŠŠ? @
;
ŠŠ@ A
offset
‹‹ 
+=
‹‹ 
info
‹‹ "
.
‹‹" #
Length
‹‹# )
;
‹‹) *
dataToHashBuffer
ŒŒ $
[
ŒŒ$ %
offset
ŒŒ% +
]
ŒŒ+ ,
=
ŒŒ- .
(
ŒŒ/ 0
byte
ŒŒ0 4
)
ŒŒ4 5
	iteration
ŒŒ5 >
;
ŒŒ> ?
offset
 
++
 
;
 
byte
 
[
 
]
 
currentBlock
 '
=
( )

expandHmac
* 4
.
4 5
ComputeHash
5 @
(
@ A
dataToHashBuffer
A Q
,
Q R
$num
S T
,
T U
offset
V \
)
\ ]
;
] ^
int
‘‘ 
bytesToCopy
‘‘ #
=
‘‘$ %
Math
‘‘& *
.
‘‘* +
Min
‘‘+ .
(
‘‘. /
currentBlock
‘‘/ ;
.
‘‘; <
Length
‘‘< B
,
‘‘B C
outputLength
‘‘D P
-
‘‘Q R
bytesGenerated
‘‘S a
)
‘‘a b
;
‘‘b c
Array
’’ 
.
’’ 
Copy
’’ 
(
’’ 
currentBlock
’’ +
,
’’+ ,
$num
’’- .
,
’’. /
expandedKey
’’0 ;
,
’’; <
bytesGenerated
’’= K
,
’’K L
bytesToCopy
’’M X
)
’’X Y
;
’’Y Z
bytesGenerated
”” "
+=
””# %
bytesToCopy
””& 1
;
””1 2
previousBlock
•• !
=
••" #
currentBlock
••$ 0
;
••0 1
	iteration
–– 
++
–– 
;
––  
}
—— 
}
˜˜ 
finally
™™ 
{
šš 
	ArrayPool
›› 
<
›› 
byte
›› 
>
›› 
.
››  
Shared
››  &
.
››& '
Return
››' -
(
››- .
dataToHashBuffer
››. >
,
››> ?

clearArray
››@ J
:
››J K
true
››L P
)
››P Q
;
››Q R
}
œœ %
CryptographicOperations
žž #
.
žž# $

ZeroMemory
žž$ .
(
žž. /
pseudoRandomKey
žž/ >
)
žž> ?
;
žž? @
return
ŸŸ 
expandedKey
ŸŸ 
;
ŸŸ 
}
   	
)
  	 

;
  
 
}
¡¡ 
private
££ 
static
££ 
async
££ 
Task
££ 
<
££ 
byte
££ "
[
££" #
]
££# $
>
££$ %(
ApplyAdditionalRoundsAsync
££& @
(
££@ A
byte
££A E
[
££E F
]
££F G
key
££H K
)
££K L
{
¤¤ 
return
¥¥ 
await
¥¥ 
Task
¥¥ 
.
¥¥ 
Run
¥¥ 
(
¥¥ 
(
¥¥ 
)
¥¥  
=>
¥¥! #
{
¦¦ 	
byte
§§ 
[
§§ 
]
§§ 
result
§§ 
=
§§ 
(
§§ 
byte
§§ !
[
§§! "
]
§§" #
)
§§# $
key
§§$ '
.
§§' (
Clone
§§( -
(
§§- .
)
§§. /
;
§§/ 0
Span
©© 
<
©© 
byte
©© 
>
©© 
roundBuffer
©© "
=
©©# $

stackalloc
©©% /
byte
©©0 4
[
©©4 5$
CryptographicConstants
©©5 K
.
©©K L
Buffer
©©L R
.
©©R S
MAX_ROUND_SIZE
©©S a
]
©©a b
;
©©b c
for
«« 
(
«« 
int
«« 
round
«« 
=
«« 
$num
«« 
;
«« 
round
««  %
<
««& '$
CryptographicConstants
««( >
.
««> ?
KeyDerivation
««? L
.
««L M%
ADDITIONAL_ROUNDS_COUNT
««M d
;
««d e
round
««f k
++
««k m
)
««m n
{
¬¬ 
using
­­ 

HMACSHA512
­­  
hmac
­­! %
=
­­& '
new
­­( +
(
­­+ ,
result
­­, 2
)
­­2 3
;
­­3 4
int
®® 
roundInputLength
®® $
=
®®% &
Encoding
®®' /
.
®®/ 0
UTF8
®®0 4
.
®®4 5
GetBytes
®®5 =
(
®®= >
string
®®> D
.
®®D E
Format
®®E K
(
®®K L$
CryptographicConstants
®®L b
.
®®b c
KeyDerivation
®®c p
.
®®p q
ROUND_KEY_FORMAT®®q 
,®® ‚
round®®ƒ ˆ
)®®ˆ ‰
,®®‰ Š
roundBuffer®®‹ –
)®®– —
;®®— ˜
byte
¯¯ 
[
¯¯ 
]
¯¯ 
roundKey
¯¯ 
=
¯¯  !
hmac
¯¯" &
.
¯¯& '
ComputeHash
¯¯' 2
(
¯¯2 3
roundBuffer
¯¯3 >
[
¯¯> ?
..
¯¯? A
roundInputLength
¯¯A Q
]
¯¯Q R
.
¯¯R S
ToArray
¯¯S Z
(
¯¯Z [
)
¯¯[ \
)
¯¯\ ]
;
¯¯] ^
for
±± 
(
±± 
int
±± 
i
±± 
=
±± 
$num
±± 
;
±± 
i
±±  !
<
±±" #
result
±±$ *
.
±±* +
Length
±±+ 1
&&
±±2 4
i
±±5 6
<
±±7 8
roundKey
±±9 A
.
±±A B
Length
±±B H
;
±±H I
i
±±J K
++
±±K M
)
±±M N
{
²² 
result
³³ 
[
³³ 
i
³³ 
]
³³ 
^=
³³  
roundKey
³³! )
[
³³) *
i
³³* +
]
³³+ ,
;
³³, -
}
´´ 
byte
¶¶ 
[
¶¶ 
]
¶¶ 
temp
¶¶ 
=
¶¶ 
SHA512
¶¶ $
.
¶¶$ %
HashData
¶¶% -
(
¶¶- .
result
¶¶. 4
)
¶¶4 5
;
¶¶5 6
Array
·· 
.
·· 
Copy
·· 
(
·· 
temp
·· 
,
··  
result
··! '
,
··' (
Math
··) -
.
··- .
Min
··. 1
(
··1 2
temp
··2 6
.
··6 7
Length
··7 =
,
··= >
result
··? E
.
··E F
Length
··F L
)
··L M
)
··M N
;
··N O
}
¸¸ 
return
ºº 
result
ºº 
;
ºº 
}
»» 	
)
»»	 

;
»»
 
}
¼¼ 
public
¾¾ 

async
¾¾ 
Task
¾¾ 
<
¾¾ 
Result
¾¾ 
<
¾¾ &
SodiumSecureMemoryHandle
¾¾ 5
,
¾¾5 6!
KeySplittingFailure
¾¾7 J
>
¾¾J K
>
¾¾K L0
"DeriveEnhancedMasterKeyHandleAsync
¾¾M o
(
¾¾o p&
SodiumSecureMemoryHandle
¿¿  
baseKeyHandle
¿¿! .
,
¿¿. /
string
ÀÀ 
context
ÀÀ 
,
ÀÀ "
KeyDerivationOptions
ÁÁ 
options
ÁÁ $
)
ÁÁ$ %
{
ÂÂ 
byte
ÃÃ 
[
ÃÃ 
]
ÃÃ 
?
ÃÃ 
baseKeyBytes
ÃÃ 
=
ÃÃ 
null
ÃÃ #
;
ÃÃ# $
try
ÅÅ 
{
ÆÆ 	
Result
ÇÇ 
<
ÇÇ 
byte
ÇÇ 
[
ÇÇ 
]
ÇÇ 
,
ÇÇ 
SodiumFailure
ÇÇ (
>
ÇÇ( )

readResult
ÇÇ* 4
=
ÇÇ5 6
baseKeyHandle
ÈÈ 
.
ÈÈ 
	ReadBytes
ÈÈ '
(
ÈÈ' (
baseKeyHandle
ÈÈ( 5
.
ÈÈ5 6
Length
ÈÈ6 <
)
ÈÈ< =
;
ÈÈ= >
if
ÉÉ 
(
ÉÉ 

readResult
ÉÉ 
.
ÉÉ 
IsErr
ÉÉ  
)
ÉÉ  !
{
ÊÊ 
return
ËË 
Result
ËË 
<
ËË &
SodiumSecureMemoryHandle
ËË 6
,
ËË6 7!
KeySplittingFailure
ËË8 K
>
ËËK L
.
ËËL M
Err
ËËM P
(
ËËP Q!
KeySplittingFailure
ÌÌ '
.
ÌÌ' (
MemoryReadFailed
ÌÌ( 8
(
ÌÌ8 9

readResult
ÌÌ9 C
.
ÌÌC D
	UnwrapErr
ÌÌD M
(
ÌÌM N
)
ÌÌN O
.
ÌÌO P
Message
ÌÌP W
)
ÌÌW X
)
ÌÌX Y
;
ÌÌY Z
}
ÍÍ 
baseKeyBytes
ÏÏ 
=
ÏÏ 

readResult
ÏÏ %
.
ÏÏ% &
Unwrap
ÏÏ& ,
(
ÏÏ, -
)
ÏÏ- .
;
ÏÏ. /
Result
ÑÑ 
<
ÑÑ 
byte
ÑÑ 
[
ÑÑ 
]
ÑÑ 
,
ÑÑ !
KeySplittingFailure
ÑÑ .
>
ÑÑ. /
deriveResult
ÑÑ0 <
=
ÑÑ= >
await
ÒÒ $
DeriveEnhancedKeyAsync
ÒÒ ,
(
ÒÒ, -
baseKeyBytes
ÒÒ- 9
,
ÒÒ9 :
context
ÒÒ; B
,
ÒÒB C
options
ÒÒD K
)
ÒÒK L
;
ÒÒL M
if
ÓÓ 
(
ÓÓ 
deriveResult
ÓÓ 
.
ÓÓ 
IsErr
ÓÓ "
)
ÓÓ" #
{
ÔÔ 
return
ÕÕ 
Result
ÕÕ 
<
ÕÕ &
SodiumSecureMemoryHandle
ÕÕ 6
,
ÕÕ6 7!
KeySplittingFailure
ÕÕ8 K
>
ÕÕK L
.
ÕÕL M
Err
ÕÕM P
(
ÕÕP Q
deriveResult
ÕÕQ ]
.
ÕÕ] ^
	UnwrapErr
ÕÕ^ g
(
ÕÕg h
)
ÕÕh i
)
ÕÕi j
;
ÕÕj k
}
ÖÖ 
byte
ØØ 
[
ØØ 
]
ØØ 

derivedKey
ØØ 
=
ØØ 
deriveResult
ØØ  ,
.
ØØ, -
Unwrap
ØØ- 3
(
ØØ3 4
)
ØØ4 5
;
ØØ5 6
try
ÚÚ 
{
ÛÛ 
Result
ÜÜ 
<
ÜÜ &
SodiumSecureMemoryHandle
ÜÜ /
,
ÜÜ/ 0
SodiumFailure
ÜÜ1 >
>
ÜÜ> ?
allocateResult
ÜÜ@ N
=
ÜÜO P&
SodiumSecureMemoryHandle
ÝÝ ,
.
ÝÝ, -
Allocate
ÝÝ- 5
(
ÝÝ5 6

derivedKey
ÝÝ6 @
.
ÝÝ@ A
Length
ÝÝA G
)
ÝÝG H
;
ÝÝH I
if
ÞÞ 
(
ÞÞ 
allocateResult
ÞÞ "
.
ÞÞ" #
IsErr
ÞÞ# (
)
ÞÞ( )
{
ßß 
return
àà 
Result
àà !
<
àà! "&
SodiumSecureMemoryHandle
àà" :
,
àà: ;!
KeySplittingFailure
àà< O
>
ààO P
.
ààP Q
Err
ààQ T
(
ààT U!
KeySplittingFailure
áá +
.
áá+ ,
ALLOCATION_FAILED
áá, =
(
áá= >
allocateResult
áá> L
.
ááL M
	UnwrapErr
ááM V
(
ááV W
)
ááW X
.
ááX Y
Message
ááY `
)
áá` a
)
ááa b
;
ááb c
}
ââ &
SodiumSecureMemoryHandle
ää (
handle
ää) /
=
ää0 1
allocateResult
ää2 @
.
ää@ A
Unwrap
ääA G
(
ääG H
)
ääH I
;
ääI J
Result
ææ 
<
ææ 
Unit
ææ 
,
ææ 
SodiumFailure
ææ *
>
ææ* +
writeResult
ææ, 7
=
ææ8 9
handle
ææ: @
.
ææ@ A
Write
ææA F
(
ææF G

derivedKey
ææG Q
)
ææQ R
;
ææR S
if
çç 
(
çç 
writeResult
çç 
.
çç  
IsErr
çç  %
)
çç% &
{
èè 
handle
éé 
.
éé 
Dispose
éé "
(
éé" #
)
éé# $
;
éé$ %
return
êê 
Result
êê !
<
êê! "&
SodiumSecureMemoryHandle
êê" :
,
êê: ;!
KeySplittingFailure
êê< O
>
êêO P
.
êêP Q
Err
êêQ T
(
êêT U!
KeySplittingFailure
ëë +
.
ëë+ ,
MemoryWriteFailed
ëë, =
(
ëë= >
writeResult
ëë> I
.
ëëI J
	UnwrapErr
ëëJ S
(
ëëS T
)
ëëT U
.
ëëU V
Message
ëëV ]
)
ëë] ^
)
ëë^ _
;
ëë_ `
}
ìì 
return
îî 
Result
îî 
<
îî &
SodiumSecureMemoryHandle
îî 6
,
îî6 7!
KeySplittingFailure
îî8 K
>
îîK L
.
îîL M
Ok
îîM O
(
îîO P
handle
îîP V
)
îîV W
;
îîW X
}
ïï 
finally
ðð 
{
ññ %
CryptographicOperations
òò '
.
òò' (

ZeroMemory
òò( 2
(
òò2 3

derivedKey
òò3 =
)
òò= >
;
òò> ?
}
óó 
}
ôô 	
catch
õõ 
(
õõ 
	Exception
õõ 
ex
õõ 
)
õõ 
{
öö 	
return
÷÷ 
Result
÷÷ 
<
÷÷ &
SodiumSecureMemoryHandle
÷÷ 2
,
÷÷2 3!
KeySplittingFailure
÷÷4 G
>
÷÷G H
.
÷÷H I
Err
÷÷I L
(
÷÷L M!
KeySplittingFailure
øø #
.
øø# $!
KeyDerivationFailed
øø$ 7
(
øø7 8
ex
øø8 :
.
øø: ;
Message
øø; B
,
øøB C
ex
øøD F
)
øøF G
)
øøG H
;
øøH I
}
ùù 	
finally
úú 
{
ûû 	
if
üü 
(
üü 
baseKeyBytes
üü 
!=
üü 
null
üü  $
)
üü$ %
{
ýý %
CryptographicOperations
þþ '
.
þþ' (

ZeroMemory
þþ( 2
(
þþ2 3
baseKeyBytes
þþ3 ?
)
þþ? @
;
þþ@ A
}
ÿÿ 
}
€€ 	
}
 
}‚‚ ÷
Š/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Crypto/RsaChunkEncryptor.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Crypto0 6
;6 7
public

 
sealed

 
class

 
RsaChunkEncryptor

 %
:

& '
IRsaChunkEncryptor

( :
{ 
private 
const 
int 
RSA_MAX_CHUNK_SIZE (
=) *
$num+ .
;. /
private 
const 
int $
RSA_ENCRYPTED_CHUNK_SIZE .
=/ 0
$num1 4
;4 5
public 

Result 
< 
byte 
[ 
] 
, 
NetworkFailure (
>( )
EncryptInChunks* 9
(9 :%
CertificatePinningService !%
certificatePinningService" ;
,; <
byte 
[ 
] 
originalData 
) 
{ !
ArgumentNullException 
. 
ThrowIfNull )
() *%
certificatePinningService* C
)C D
;D E!
ArgumentNullException 
. 
ThrowIfNull )
() *
originalData* 6
)6 7
;7 8
int 

chunkCount 
= 
( 
originalData &
.& '
Length' -
+. /
RSA_MAX_CHUNK_SIZE0 B
-C D
$numE F
)F G
/H I
RSA_MAX_CHUNK_SIZEJ \
;\ ]
int 
estimatedSize 
= 

chunkCount &
*' ($
RSA_ENCRYPTED_CHUNK_SIZE) A
;A B
byte 
[ 
] 
rentedBuffer 
= 
	ArrayPool '
<' (
byte( ,
>, -
.- .
Shared. 4
.4 5
Rent5 9
(9 :
estimatedSize: G
)G H
;H I
try 
{ 	
int 
currentOffset 
= 
$num  !
;! "
for 
( 
int 
offset 
= 
$num 
;  
offset! '
<( )
originalData* 6
.6 7
Length7 =
;= >
offset? E
+=F H
RSA_MAX_CHUNK_SIZEI [
)[ \
{ 
int   
	chunkSize   
=   
Math    $
.  $ %
Min  % (
(  ( )
RSA_MAX_CHUNK_SIZE  ) ;
,  ; <
originalData  = I
.  I J
Length  J P
-  Q R
offset  S Y
)  Y Z
;  Z [
Memory!! 
<!! 
byte!! 
>!! 
chunk!! "
=!!# $
originalData!!% 1
.!!1 2
AsMemory!!2 :
(!!: ;
offset!!; A
,!!A B
	chunkSize!!C L
)!!L M
;!!M N-
!CertificatePinningByteArrayResult## 1
chunkResult##2 =
=##> ?%
certificatePinningService$$ -
.$$- .
Encrypt$$. 5
($$5 6
chunk$$6 ;
)$$; <
;$$< =
if&& 
(&& 
chunkResult&& 
.&&  
ERROR&&  %
!=&&& (
null&&) -
)&&- .
{'' 
return(( 
Result(( !
<((! "
byte((" &
[((& '
]((' (
,((( )
NetworkFailure((* 8
>((8 9
.((9 :
Err((: =
(((= >
NetworkFailure)) &
.))& '
RsaEncryption))' 4
())4 5
$"))5 7
$str))7 N
{))N O
chunkResult))O Z
.))Z [
ERROR))[ `
.))` a
Message))a h
}))h i
"))i j
)))j k
)))k l
;))l m
}** 
if,, 
(,, 
chunkResult,, 
.,,  
Value,,  %
==,,& (
null,,) -
),,- .
{-- 
continue.. 
;.. 
}// 
int11 
encryptedLength11 #
=11$ %
chunkResult11& 1
.111 2
Value112 7
.117 8
Length118 >
;11> ?
if22 
(22 
currentOffset22 !
+22" #
encryptedLength22$ 3
>224 5
rentedBuffer226 B
.22B C
Length22C I
)22I J
{33 
byte44 
[44 
]44 
	newBuffer44 $
=44% &
	ArrayPool44' 0
<440 1
byte441 5
>445 6
.446 7
Shared447 =
.44= >
Rent44> B
(44B C
currentOffset44C P
+44Q R
encryptedLength44S b
)44b c
;44c d
Array55 
.55 
Copy55 
(55 
rentedBuffer55 +
,55+ ,
$num55- .
,55. /
	newBuffer550 9
,559 :
$num55; <
,55< =
currentOffset55> K
)55K L
;55L M
	ArrayPool66 
<66 
byte66 "
>66" #
.66# $
Shared66$ *
.66* +
Return66+ 1
(661 2
rentedBuffer662 >
)66> ?
;66? @
rentedBuffer77  
=77! "
	newBuffer77# ,
;77, -
}88 
Array:: 
.:: 
Copy:: 
(:: 
chunkResult:: &
.::& '
Value::' ,
,::, -
$num::. /
,::/ 0
rentedBuffer::1 =
,::= >
currentOffset::? L
,::L M
encryptedLength::N ]
)::] ^
;::^ _
currentOffset;; 
+=;;  
encryptedLength;;! 0
;;;0 1
}<< 
byte>> 
[>> 
]>> 
result>> 
=>> 
new>> 
byte>>  $
[>>$ %
currentOffset>>% 2
]>>2 3
;>>3 4
Array?? 
.?? 
Copy?? 
(?? 
rentedBuffer?? #
,??# $
$num??% &
,??& '
result??( .
,??. /
$num??0 1
,??1 2
currentOffset??3 @
)??@ A
;??A B
return@@ 
Result@@ 
<@@ 
byte@@ 
[@@ 
]@@  
,@@  !
NetworkFailure@@" 0
>@@0 1
.@@1 2
Ok@@2 4
(@@4 5
result@@5 ;
)@@; <
;@@< =
}AA 	
catchBB 
(BB "
CryptographicExceptionBB %
exBB& (
)BB( )
{CC 	
returnDD 
ResultDD 
<DD 
byteDD 
[DD 
]DD  
,DD  !
NetworkFailureDD" 0
>DD0 1
.DD1 2
ErrDD2 5
(DD5 6
NetworkFailureEE 
.EE 
RsaEncryptionEE ,
(EE, -
$"EE- /
$strEE/ D
{EED E
exEEE G
.EEG H
MessageEEH O
}EEO P
"EEP Q
)EEQ R
)EER S
;EES T
}FF 	
catchGG 
(GG  
OutOfMemoryExceptionGG #
exGG$ &
)GG& '
{HH 	
returnII 
ResultII 
<II 
byteII 
[II 
]II  
,II  !
NetworkFailureII" 0
>II0 1
.II1 2
ErrII2 5
(II5 6
NetworkFailureJJ 
.JJ 
RsaEncryptionJJ ,
(JJ, -
$"JJ- /
$strJJ/ N
{JJN O
exJJO Q
.JJQ R
MessageJJR Y
}JJY Z
"JJZ [
)JJ[ \
)JJ\ ]
;JJ] ^
}KK 	
catchLL 
(LL 
ArgumentExceptionLL  
exLL! #
)LL# $
{MM 	
returnNN 
ResultNN 
<NN 
byteNN 
[NN 
]NN  
,NN  !
NetworkFailureNN" 0
>NN0 1
.NN1 2
ErrNN2 5
(NN5 6
NetworkFailureOO 
.OO 
RsaEncryptionOO ,
(OO, -
$"OO- /
$strOO/ N
{OON O
exOOO Q
.OOQ R
MessageOOR Y
}OOY Z
"OOZ [
)OO[ \
)OO\ ]
;OO] ^
}PP 	
catchQQ 
(QQ 
	ExceptionQQ 
exQQ 
)QQ 
{RR 	
returnSS 
ResultSS 
<SS 
byteSS 
[SS 
]SS  
,SS  !
NetworkFailureSS" 0
>SS0 1
.SS1 2
ErrSS2 5
(SS5 6
NetworkFailureTT 
.TT 
RsaEncryptionTT ,
(TT, -
$"TT- /
$strTT/ B
{TTB C
exTTC E
.TTE F
MessageTTF M
}TTM N
"TTN O
)TTO P
)TTP Q
;TTQ R
}UU 	
finallyVV 
{WW 	
	ArrayPoolXX 
<XX 
byteXX 
>XX 
.XX 
SharedXX "
.XX" #
ReturnXX# )
(XX) *
rentedBufferXX* 6
)XX6 7
;XX7 8
}YY 	
}ZZ 
public\\ 

Result\\ 
<\\ 
byte\\ 
[\\ 
]\\ 
,\\ 
NetworkFailure\\ (
>\\( )
DecryptInChunks\\* 9
(\\9 :%
CertificatePinningService]] !%
certificatePinningService]]" ;
,]]; <
byte^^ 
[^^ 
]^^ !
combinedEncryptedData^^ $
)^^$ %
{__ !
ArgumentNullException`` 
.`` 
ThrowIfNull`` )
(``) *%
certificatePinningService``* C
)``C D
;``D E!
ArgumentNullExceptionaa 
.aa 
ThrowIfNullaa )
(aa) *!
combinedEncryptedDataaa* ?
)aa? @
;aa@ A
intcc 

chunkCountcc 
=cc 
(cc !
combinedEncryptedDatacc /
.cc/ 0
Lengthcc0 6
+cc7 8$
RSA_ENCRYPTED_CHUNK_SIZEcc9 Q
-ccR S
$numccT U
)ccU V
/ccW X$
RSA_ENCRYPTED_CHUNK_SIZEccY q
;ccq r
intdd 
estimatedSizedd 
=dd 

chunkCountdd &
*dd' (
RSA_MAX_CHUNK_SIZEdd) ;
;dd; <
byteee 
[ee 
]ee 
rentedBufferee 
=ee 
	ArrayPoolee '
<ee' (
byteee( ,
>ee, -
.ee- .
Sharedee. 4
.ee4 5
Rentee5 9
(ee9 :
estimatedSizeee: G
)eeG H
;eeH I
trygg 
{hh 	
intii 
currentOffsetii 
=ii 
$numii  !
;ii! "
forkk 
(kk 
intkk 
offsetkk 
=kk 
$numkk 
;kk  
offsetkk! '
<kk( )!
combinedEncryptedDatakk* ?
.kk? @
Lengthkk@ F
;kkF G
offsetkkH N
+=kkO Q$
RSA_ENCRYPTED_CHUNK_SIZEkkR j
)kkj k
{ll 
intmm 
	chunkSizemm 
=mm 
Mathmm  $
.mm$ %
Minmm% (
(mm( )$
RSA_ENCRYPTED_CHUNK_SIZEmm) A
,mmA B!
combinedEncryptedDatammC X
.mmX Y
LengthmmY _
-mm` a
offsetmmb h
)mmh i
;mmi j
Memorynn 
<nn 
bytenn 
>nn 
encryptedChunknn +
=nn, -!
combinedEncryptedDatann. C
.nnC D
AsMemorynnD L
(nnL M
offsetnnM S
,nnS T
	chunkSizennU ^
)nn^ _
;nn_ `-
!CertificatePinningByteArrayResultpp 1
chunkDecryptResultpp2 D
=ppE F%
certificatePinningServiceqq -
.qq- .
Decryptqq. 5
(qq5 6
encryptedChunkqq6 D
)qqD E
;qqE F
ifss 
(ss 
!ss 
chunkDecryptResultss '
.ss' (
	IsSuccessss( 1
)ss1 2
{tt 
returnuu 
Resultuu !
<uu! "
byteuu" &
[uu& '
]uu' (
,uu( )
NetworkFailureuu* 8
>uu8 9
.uu9 :
Erruu: =
(uu= >
NetworkFailurevv &
.vv& '#
DataCenterNotRespondingvv' >
(vv> ?
$"ww 
$strww ?
{ww? @
(ww@ A
offsetwwA G
/wwH I$
RSA_ENCRYPTED_CHUNK_SIZEwwJ b
)wwb c
+wwd e
$numwwf g
}wwg h
$strwwh j
{wwj k
chunkDecryptResultwwk }
.ww} ~
ERROR	ww~ ƒ
?
wwƒ „
.
ww„ …
Message
ww… Œ
}
wwŒ 
"
ww Ž
)
wwŽ 
)
ww 
;
ww ‘
}xx 
ifzz 
(zz 
chunkDecryptResultzz &
.zz& '
Valuezz' ,
==zz- /
nullzz0 4
)zz4 5
{{{ 
continue|| 
;|| 
}}} 
int 
decryptedLength #
=$ %
chunkDecryptResult& 8
.8 9
Value9 >
.> ?
Length? E
;E F
if
€€ 
(
€€ 
currentOffset
€€ !
+
€€" #
decryptedLength
€€$ 3
>
€€4 5
rentedBuffer
€€6 B
.
€€B C
Length
€€C I
)
€€I J
{
 
byte
‚‚ 
[
‚‚ 
]
‚‚ 
	newBuffer
‚‚ $
=
‚‚% &
	ArrayPool
‚‚' 0
<
‚‚0 1
byte
‚‚1 5
>
‚‚5 6
.
‚‚6 7
Shared
‚‚7 =
.
‚‚= >
Rent
‚‚> B
(
‚‚B C
currentOffset
‚‚C P
+
‚‚Q R
decryptedLength
‚‚S b
)
‚‚b c
;
‚‚c d
Array
ƒƒ 
.
ƒƒ 
Copy
ƒƒ 
(
ƒƒ 
rentedBuffer
ƒƒ +
,
ƒƒ+ ,
$num
ƒƒ- .
,
ƒƒ. /
	newBuffer
ƒƒ0 9
,
ƒƒ9 :
$num
ƒƒ; <
,
ƒƒ< =
currentOffset
ƒƒ> K
)
ƒƒK L
;
ƒƒL M
	ArrayPool
„„ 
<
„„ 
byte
„„ "
>
„„" #
.
„„# $
Shared
„„$ *
.
„„* +
Return
„„+ 1
(
„„1 2
rentedBuffer
„„2 >
)
„„> ?
;
„„? @
rentedBuffer
……  
=
……! "
	newBuffer
……# ,
;
……, -
}
†† 
Array
ˆˆ 
.
ˆˆ 
Copy
ˆˆ 
(
ˆˆ  
chunkDecryptResult
ˆˆ -
.
ˆˆ- .
Value
ˆˆ. 3
,
ˆˆ3 4
$num
ˆˆ5 6
,
ˆˆ6 7
rentedBuffer
ˆˆ8 D
,
ˆˆD E
currentOffset
ˆˆF S
,
ˆˆS T
decryptedLength
ˆˆU d
)
ˆˆd e
;
ˆˆe f
currentOffset
‰‰ 
+=
‰‰  
decryptedLength
‰‰! 0
;
‰‰0 1
}
ŠŠ 
byte
ŒŒ 
[
ŒŒ 
]
ŒŒ 
result
ŒŒ 
=
ŒŒ 
new
ŒŒ 
byte
ŒŒ  $
[
ŒŒ$ %
currentOffset
ŒŒ% 2
]
ŒŒ2 3
;
ŒŒ3 4
Array
 
.
 
Copy
 
(
 
rentedBuffer
 #
,
# $
$num
% &
,
& '
result
( .
,
. /
$num
0 1
,
1 2
currentOffset
3 @
)
@ A
;
A B
return
ŽŽ 
Result
ŽŽ 
<
ŽŽ 
byte
ŽŽ 
[
ŽŽ 
]
ŽŽ  
,
ŽŽ  !
NetworkFailure
ŽŽ" 0
>
ŽŽ0 1
.
ŽŽ1 2
Ok
ŽŽ2 4
(
ŽŽ4 5
result
ŽŽ5 ;
)
ŽŽ; <
;
ŽŽ< =
}
 	
finally
 
{
‘‘ 	
	ArrayPool
’’ 
<
’’ 
byte
’’ 
>
’’ 
.
’’ 
Shared
’’ "
.
’’" #
Return
’’# )
(
’’) *
rentedBuffer
’’* 6
)
’’6 7
;
’’7 8
}
““ 	
}
”” 
}•• ó
‹/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Crypto/RatchetStateHasher.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Crypto0 6
;6 7
internal		 
static			 
class		 
RatchetStateHasher		 (
{

 
public 

static 
byte 
[ 
] %
ComputeRatchetFingerprint 2
(2 3
RatchetState3 ?
ratchetState@ L
,L M
uintN R
	connectIdS \
)\ ]
{ !
ArgumentNullException 
. 
ThrowIfNull )
() *
ratchetState* 6
)6 7
;7 8
using 
MemoryStream 
memoryStream '
=( )
new* -
MemoryStream. :
(: ;
); <
;< =
using 
BinaryWriter 
writer !
=" #
new$ '
BinaryWriter( 4
(4 5
memoryStream5 A
)A B
;B C
writer 
. 
Write 
( 
	connectId 
) 
;  
byte 
[ 
] 
ratchetBytes 
= 
ratchetState *
.* +
ToByteArray+ 6
(6 7
)7 8
;8 9
writer 
. 
Write 
( 
ratchetBytes !
)! "
;" #
byte 
[ 
] 
data 
= 
memoryStream "
." #
ToArray# *
(* +
)+ ,
;, -
byte 
[ 
] 
hash 
= 
SHA256 
. 
HashData %
(% &
data& *
)* +
;+ ,
return 
hash 
; 
} 
} Ä	
‹/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Crypto/IRsaChunkEncryptor.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Crypto0 6
;6 7
public 
	interface 
IRsaChunkEncryptor #
{ 
Result		 

<		
 
byte		 
[		 
]		 
,		 
NetworkFailure		 !
>		! "
EncryptInChunks		# 2
(		2 3%
CertificatePinningService

 !%
certificatePinningService

" ;
,

; <
byte 
[ 
] 
originalData 
) 
; 
Result 

<
 
byte 
[ 
] 
, 
NetworkFailure !
>! "
DecryptInChunks# 2
(2 3%
CertificatePinningService !%
certificatePinningService" ;
,; <
byte 
[ 
] !
combinedEncryptedData $
)$ %
;% &
} Î
š/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Abstractions/ISecureProtocolStateStorage.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Abstractions0 <
;< =
public 
	interface '
ISecureProtocolStateStorage ,
{ 
Task		 
<		 	
Result			 
<		 
Unit		 
,		  
SecureStorageFailure		 *
>		* +
>		+ ,
SaveStateAsync		- ;
(		; <
byte		< @
[		@ A
]		A B
protocolState		C P
,		P Q
string		R X
	connectId		Y b
,		b c
byte		d h
[		h i
]		i j
membershipId		k w
)		w x
;		x y
Task 
< 	
Result	 
< 
byte 
[ 
] 
,  
SecureStorageFailure ,
>, -
>- .
LoadStateAsync/ =
(= >
string> D
	connectIdE N
,N O
byteP T
[T U
]U V
membershipIdW c
)c d
;d e
Task 
< 	
Result	 
< 
Unit 
,  
SecureStorageFailure *
>* +
>+ ,
DeleteStateAsync- =
(= >
string> D
keyE H
)H I
;I J
} ò
˜/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Security/Abstractions/IPlatformSecurityProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Security' /
./ 0
Abstractions0 <
;< =
public 
	interface %
IPlatformSecurityProvider *
{ 
Task 
< 	
byte	 
[ 
] 
> %
GenerateSecureRandomAsync *
(* +
int+ .
length/ 5
)5 6
;6 7
Task

 #
StoreKeyInKeychainAsync

	  
(

  !
string

! '

identifier

( 2
,

2 3
byte

4 8
[

8 9
]

9 :
key

; >
)

> ?
;

? @
Task 
< 	
byte	 
[ 
] 
? 
> #
GetKeyFromKeychainAsync )
() *
string* 0

identifier1 ;
); <
;< =
Task &
DeleteKeyFromKeychainAsync	 #
(# $
string$ *

identifier+ 5
)5 6
;6 7
Task 
< 	
byte	 
[ 
] 
> #
GetOrCreateHmacKeyAsync (
(( )
)) *
;* +
bool '
IsHardwareSecurityAvailable	 $
($ %
)% &
;& '
Task 
< 	
Option	 
< 
byte 
[ 
] 
> 
>  
HardwareEncryptAsync -
(- .
byte. 2
[2 3
]3 4
data5 9
)9 :
;: ;
Task 
< 	
Option	 
< 
byte 
[ 
] 
> 
>  
HardwareDecryptAsync -
(- .
byte. 2
[2 3
]3 4
data5 9
)9 :
;: ;
} ¢K
Ž/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Transport/RpcMetaDataProvider.cs
	namespace		 	
Ecliptix		
 
.		 
Core		 
.		 
Infrastructure		 &
.		& '
Network		' .
.		. /
	Transport		/ 8
;		8 9
internal 
sealed	 
class 
RpcMetaDataProvider )
:* + 
IRpcMetaDataProvider, @
{ 
public 

Guid 
AppInstanceId 
{ 
get  #
;# $
private% ,
set- 0
;0 1
}2 3
public 

Guid 
DeviceId 
{ 
get 
; 
private  '
set( +
;+ ,
}- .
public 

string 
? 
CULTURE 
{ 
get  
;  !
private" )
set* -
;- .
}/ 0
public 

string 
LocalIpAddress  
{! "
get# &
;& '
}( )
public 

string 
? 
PublicIpAddress "
{# $
get% (
;( )
}* +
public 

string 
Platform 
{ 
get  
;  !
}" #
public 

RpcMetaDataProvider 
( 
)  
{ 
LocalIpAddress 
=  
DetectLocalIpAddress -
(- .
). /
;/ 0
PublicIpAddress 
= !
DetectPublicIpAddress /
(/ 0
)0 1
;1 2
Platform 
= 
DetectPlatform !
(! "
)" #
;# $
} 
public 

void 

SetAppInfo 
( 
Guid 
appInstanceId  -
,- .
Guid/ 3
deviceId4 <
,< =
string> D
?D E
cultureF M
)M N
{ 
AppInstanceId 
= 
appInstanceId %
;% &
DeviceId 
= 
deviceId 
; 
CULTURE 
= 
culture 
; 
}   
public"" 

void"" 

SetCulture"" 
("" 
string"" !
?""! "
culture""# *
)""* +
{## 
CULTURE$$ 
=$$ 
culture$$ 
;$$ 
}%% 
private'' 
static'' 
string''  
DetectLocalIpAddress'' .
(''. /
)''/ 0
{(( 
try)) 
{** 	
string++ 
localIp++ 
=++ 
NetworkInterface++ -
.++- .#
GetAllNetworkInterfaces++. E
(++E F
)++F G
.,, 
Where,, 
(,, 
x,, 
=>,, 
x,, 
.,, 
OperationalStatus,, /
==,,0 2
OperationalStatus,,3 D
.,,D E
Up,,E G
&&,,H J
!,,K L
x,,L M
.,,M N
IsReceiveOnly,,N [
),,[ \
.-- 

SelectMany-- 
(-- 
x-- 
=>--  
x--! "
.--" #
GetIPProperties--# 2
(--2 3
)--3 4
.--4 5
UnicastAddresses--5 E
)--E F
... 
Where.. 
(.. 
x.. 
=>.. 
x.. 
... 
Address.. %
...% &
AddressFamily..& 3
==..4 6
AddressFamily..7 D
...D E
InterNetwork..E Q
&&..R T
!..U V
	IPAddress..V _
..._ `

IsLoopback..` j
(..j k
x..k l
...l m
Address..m t
)..t u
)..u v
.// 
Select// 
(// 
x// 
=>// 
x// 
.// 
Address// &
.//& '
ToString//' /
(/// 0
)//0 1
)//1 2
.00 
FirstOrDefault00 
(00  
)00  !
??00" $
$str00% 0
;000 1
return22 
localIp22 
;22 
}33 	
catch44 
{55 	
return66 
$str66 
;66 
}77 	
}88 
private:: 
static:: 
string:: 
?:: !
DetectPublicIpAddress:: 0
(::0 1
)::1 2
{;; 
try<< 
{== 	
using>> 
	UdpClient>> 
client>> "
=>># $
new>>% (
(>>( )
)>>) *
;>>* +
client?? 
.?? 
Connect?? 
(?? 
$str?? $
,??$ %
$num??& (
)??( )
;??) *

IPEndPoint@@ 
?@@ 
endpoint@@  
=@@! "
client@@# )
.@@) *
Client@@* 0
.@@0 1
LocalEndPoint@@1 >
as@@? A

IPEndPoint@@B L
;@@L M
returnAA 
endpointAA 
?AA 
.AA 
AddressAA $
.AA$ %
ToStringAA% -
(AA- .
)AA. /
??AA0 2 
DetectLocalIpAddressAA3 G
(AAG H
)AAH I
;AAI J
}BB 	
catchCC 
{DD 	
returnEE  
DetectLocalIpAddressEE '
(EE' (
)EE( )
;EE) *
}FF 	
}GG 
privateII 
staticII 
stringII 
DetectPlatformII (
(II( )
)II) *
{JJ 
stringKK 
osKK 
=KK 
GetOperatingSystemKK &
(KK& '
)KK' (
;KK( )
stringLL 
archLL 
=LL 
GetArchitectureLL %
(LL% &
)LL& '
;LL' (
stringMM 
runtimeMM 
=MM 
GetRuntimeVersionMM *
(MM* +
)MM+ ,
;MM, -
returnNN 
$"NN 
{NN 
osNN 
}NN 
$strNN 
{NN 
archNN 
}NN 
$strNN #
{NN# $
runtimeNN$ +
}NN+ ,
$strNN, -
"NN- .
;NN. /
}OO 
privateQQ 
staticQQ 
stringQQ 
GetOperatingSystemQQ ,
(QQ, -
)QQ- .
{RR 
ifSS 

(SS 
RuntimeInformationSS 
.SS 
IsOSPlatformSS +
(SS+ ,

OSPlatformSS, 6
.SS6 7
OSXSS7 :
)SS: ;
)SS; <
{TT 	
returnUU 
$strUU 
;UU 
}VV 	
ifXX 

(XX 
RuntimeInformationXX 
.XX 
IsOSPlatformXX +
(XX+ ,

OSPlatformXX, 6
.XX6 7
WindowsXX7 >
)XX> ?
)XX? @
{YY 	
returnZZ 
$strZZ 
;ZZ 
}[[ 	
if]] 

(]] 
RuntimeInformation]] 
.]] 
IsOSPlatform]] +
(]]+ ,

OSPlatform]], 6
.]]6 7
Linux]]7 <
)]]< =
)]]= >
{^^ 	
return__ 
$str__ 
;__ 
}`` 	
returnbb 
$strbb 
;bb 
}cc 
privateee 
staticee 
stringee 
GetArchitectureee )
(ee) *
)ee* +
{ff 
Architecturegg 
processArchgg  
=gg! "
RuntimeInformationgg# 5
.gg5 6
ProcessArchitecturegg6 I
;ggI J
returnhh 
processArchhh 
switchhh !
{ii 	
Architecturejj 
.jj 
Arm64jj 
=>jj !
$strjj" )
,jj) *
Architecturekk 
.kk 
X64kk 
=>kk 
$strkk  %
,kk% &
Architecturell 
.ll 
X86ll 
=>ll 
$strll  %
,ll% &
Architecturemm 
.mm 
Armmm 
=>mm 
$strmm  '
,mm' (
_nn 
=>nn 
processArchnn 
.nn 
ToStringnn %
(nn% &
)nn& '
}oo 	
;oo	 

}pp 
privaterr 
staticrr 
stringrr 
GetRuntimeVersionrr +
(rr+ ,
)rr, -
{ss 
stringtt  
frameworkDescriptiontt #
=tt$ %
RuntimeInformationtt& 8
.tt8 9 
FrameworkDescriptiontt9 M
;ttM N
intuu 

startIndexuu 
=uu  
frameworkDescriptionuu -
.uu- .
IndexOfuu. 5
(uu5 6
$charuu6 9
)uu9 :
;uu: ;
ifvv 

(vv 

startIndexvv 
>=vv 
$numvv 
&&vv 

startIndexvv )
<vv* + 
frameworkDescriptionvv, @
.vv@ A
LengthvvA G
-vvH I
$numvvJ K
)vvK L
{ww 	
returnxx  
frameworkDescriptionxx '
[xx' (
(xx( )

startIndexxx) 3
+xx4 5
$numxx6 7
)xx7 8
..xx8 :
]xx: ;
;xx; <
}yy 	
returnzz  
frameworkDescriptionzz #
;zz# $
}{{ 
}|| £T
§/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Transport/Grpc/Interceptors/RequestMetaDataInterceptor.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
	Transport/ 8
.8 9
Grpc9 =
.= >
Interceptors> J
;J K
public		 
sealed		 
class		 &
RequestMetaDataInterceptor		 .
(		. / 
IRpcMetaDataProvider		/ C
rpcMetaDataProvider		D W
)		W X
:		Y Z
Interceptor		[ f
{

 
public 

override $
AsyncServerStreamingCall ,
<, -
	TResponse- 6
>6 7$
AsyncServerStreamingCall8 P
<P Q
TRequestQ Y
,Y Z
	TResponse[ d
>d e
(e f
TRequest 
request 
, $
ClientInterceptorContext  
<  !
TRequest! )
,) *
	TResponse+ 4
>4 5
context6 =
,= >0
$AsyncServerStreamingCallContinuation ,
<, -
TRequest- 5
,5 6
	TResponse7 @
>@ A
continuationB N
)N O
{ 
Metadata 
headers 
= 
context "
." #
Options# *
.* +
Headers+ 2
??3 5
[6 7
]7 8
;8 9
string 
? 
culture 
= 
rpcMetaDataProvider -
.- .
CULTURE. 5
;5 6
Serilog 
. 
Log 
. 
Information 
(  
$str  i
,i j
culturek r
)r s
;s t
PubKeyExchangeType 
EXCHANGE_TYPE (
=) *$
GetExchangeTypeForMethod+ C
(C D
contextD K
.K L
MethodL R
,R S
headersT [
)[ \
;\ ]
if 

( 
Serilog 
. 
Log 
. 
	IsEnabled !
(! "
Serilog" )
.) *
Events* 0
.0 1
LogEventLevel1 >
.> ?
Debug? D
)D E
)E F
{ 	
Serilog 
. 
Log 
. 
Debug 
( 
$str	 ‚
,
‚ ƒ
EXCHANGE_TYPE 
, 
context &
.& '
Method' -
.- .
Name. 2
)2 3
;3 4
} 	
Metadata 
newMetadata 
= 
GrpcMetadataHandler 2
.2 3
GenerateMetadata3 C
(C D
rpcMetaDataProvider 
.  
AppInstanceId  -
.- .
ToString. 6
(6 7
)7 8
,8 9
rpcMetaDataProvider 
.  
DeviceId  (
.( )
ToString) 1
(1 2
)2 3
,3 4
culture 
, 
EXCHANGE_TYPE 
, 
rpcMetaDataProvider   
.    
LocalIpAddress    .
,  . /
rpcMetaDataProvider!! 
.!!  
PublicIpAddress!!  /
,!!/ 0
rpcMetaDataProvider"" 
.""  
Platform""  (
)""( )
;"") *
foreach## 
(## 
Metadata## 
.## 
Entry## 
entry##  %
in##& (
newMetadata##) 4
)##4 5
{$$ 	
headers%% 
.%% 
Add%% 
(%% 
entry%% 
)%% 
;%% 
}&& 	
CallOptions(( 

newOptions(( 
=((  
context((! (
.((( )
Options(() 0
.((0 1
WithHeaders((1 <
(((< =
headers((= D
)((D E
;((E F$
ClientInterceptorContext))  
<))  !
TRequest))! )
,))) *
	TResponse))+ 4
>))4 5

newContext))6 @
=))A B
new))C F
())F G
context** 
.** 
Method** 
,** 
context++ 
.++ 
Host++ 
,++ 

newOptions,, 
),, 
;,, 
return.. 
continuation.. 
(.. 
request.. #
,..# $

newContext..% /
)../ 0
;..0 1
}// 
public11 

override11 
AsyncUnaryCall11 "
<11" #
	TResponse11# ,
>11, -
AsyncUnaryCall11. <
<11< =
TRequest11= E
,11E F
	TResponse11G P
>11P Q
(11Q R
TRequest22 
request22 
,22 $
ClientInterceptorContext33  
<33  !
TRequest33! )
,33) *
	TResponse33+ 4
>334 5
context336 =
,33= >&
AsyncUnaryCallContinuation44 "
<44" #
TRequest44# +
,44+ ,
	TResponse44- 6
>446 7
continuation448 D
)44D E
{55 
Metadata66 
headers66 
=66 
context66 "
.66" #
Options66# *
.66* +
Headers66+ 2
??663 5
[666 7
]667 8
;668 9
string77 
?77 
culture77 
=77 
rpcMetaDataProvider77 -
.77- .
CULTURE77. 5
;775 6
Serilog88 
.88 
Log88 
.88 
Information88 
(88  
$str88  i
,88i j
culture88k r
)88r s
;88s t
PubKeyExchangeType:: 
EXCHANGE_TYPE:: (
=::) *$
GetExchangeTypeForMethod::+ C
(::C D
context::D K
.::K L
Method::L R
,::R S
headers::T [
)::[ \
;::\ ]
if;; 

(;; 
Serilog;; 
.;; 
Log;; 
.;; 
	IsEnabled;; !
(;;! "
Serilog;;" )
.;;) *
Events;;* 0
.;;0 1
LogEventLevel;;1 >
.;;> ?
Debug;;? D
);;D E
);;E F
{<< 	
Serilog== 
.== 
Log== 
.== 
Debug== 
(== 
$str== ~
,==~ 
EXCHANGE_TYPE>> 
,>> 
context>> &
.>>& '
Method>>' -
.>>- .
Name>>. 2
)>>2 3
;>>3 4
}?? 	
MetadataAA 
newMetadataAA 
=AA 
GrpcMetadataHandlerAA 2
.AA2 3
GenerateMetadataAA3 C
(AAC D
rpcMetaDataProviderBB 
.BB  
AppInstanceIdBB  -
.BB- .
ToStringBB. 6
(BB6 7
)BB7 8
,BB8 9
rpcMetaDataProviderCC 
.CC  
DeviceIdCC  (
.CC( )
ToStringCC) 1
(CC1 2
)CC2 3
,CC3 4
cultureDD 
,DD 
EXCHANGE_TYPEEE 
,EE 
rpcMetaDataProviderFF 
.FF  
LocalIpAddressFF  .
,FF. /
rpcMetaDataProviderGG 
.GG  
PublicIpAddressGG  /
,GG/ 0
rpcMetaDataProviderHH 
.HH  
PlatformHH  (
)HH( )
;HH) *
foreachII 
(II 
MetadataII 
.II 
EntryII 
entryII  %
inII& (
newMetadataII) 4
)II4 5
{JJ 	
headersKK 
.KK 
AddKK 
(KK 
entryKK 
)KK 
;KK 
}LL 	
CallOptionsNN 

newOptionsNN 
=NN  
contextNN! (
.NN( )
OptionsNN) 0
.NN0 1
WithHeadersNN1 <
(NN< =
headersNN= D
)NND E
;NNE F$
ClientInterceptorContextOO  
<OO  !
TRequestOO! )
,OO) *
	TResponseOO+ 4
>OO4 5

newContextOO6 @
=OOA B
newOOC F
(OOF G
contextPP 
.PP 
MethodPP 
,PP 
contextQQ 
.QQ 
HostQQ 
,QQ 

newOptionsRR 
)RR 
;RR 
returnTT 
continuationTT 
(TT 
requestTT #
,TT# $

newContextTT% /
)TT/ 0
;TT0 1
}UU 
privateWW 
staticWW 
PubKeyExchangeTypeWW %$
GetExchangeTypeForMethodWW& >
<WW> ?
TRequestWW? G
,WWG H
	TResponseWWI R
>WWR S
(WWS T
MethodWWT Z
<WWZ [
TRequestWW[ c
,WWc d
	TResponseWWe n
>WWn o
methodWWp v
,WWv w
Metadata	WWx €
?
WW€ 
headers
WW‚ ‰
=
WWŠ ‹
null
WWŒ 
)
WW ‘
{XX 
ifYY 

(YY 
headersYY 
!=YY 
nullYY 
)YY 
{ZZ 	
string[[ 
?[[ 
exchangeTypeHeader[[ &
=[[' (
headers[[) 0
.[[0 1
GetValue[[1 9
([[9 :
$str[[: I
)[[I J
;[[J K
if\\ 
(\\ 
!\\ 
string\\ 
.\\ 
IsNullOrEmpty\\ %
(\\% &
exchangeTypeHeader\\& 8
)\\8 9
&&\\: <
Enum]] 
.]] 
TryParse]] 
(]] 
exchangeTypeHeader]] 0
,]]0 1
true]]2 6
,]]6 7
out]]8 ;
PubKeyExchangeType]]< N
headerExchangeType]]O a
)]]a b
&&]]c e
Enum^^ 
.^^ 
	IsDefined^^ 
(^^ 
typeof^^ %
(^^% &
PubKeyExchangeType^^& 8
)^^8 9
,^^9 :
headerExchangeType^^; M
)^^M N
)^^N O
{__ 
return`` 
headerExchangeType`` )
;``) *
}aa 
}bb 	
returndd 
methoddd 
.dd 
Namedd 
switchdd !
{ee 	
$strff "
=>ff# %
PubKeyExchangeTypeff& 8
.ff8 9
ServerStreamingff9 H
,ffH I
_gg 
=>gg 
PubKeyExchangeTypegg #
.gg# $&
DataCenterEphemeralConnectgg$ >
}hh 	
;hh	 

}ii 
}jj ýd
 /Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Transport/Grpc/Interceptors/GrpcMetadataHandler.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Infrastructure

 &
.

& '
Network

' .
.

. /
	Transport

/ 8
.

8 9
Grpc

9 =
.

= >
Interceptors

> J
;

J K
public 
static 
class 
GrpcMetadataHandler '
{ 
private 
const 
string 
REQUEST_ID_KEY '
=( )
$str* 6
;6 7
private 
const 
string 
DATE_TIME_KEY &
=' (
$str) 7
;7 8
private 
const 
string  
LOCAL_IP_ADDRESS_KEY -
=. /
$str0 B
;B C
private 
const 
string !
PUBLIC_IP_ADDRESS_KEY .
=/ 0
$str1 D
;D E
private 
const 
string 

LOCALE_KEY #
=$ %
$str& ,
;, -
private 
const 
string 
LINK_ID_KEY $
=% &
$str' 3
;3 4
private 
const 
string '
APPLICATION_INSTANCE_ID_KEY 4
=5 6
$str7 O
;O P
private 
const 
string 
APP_DEVICE_ID &
=' (
$str) 7
;7 8
private 
const 
string 
PLATFORM_KEY %
=& '
$str( 2
;2 3
private 
const 
string )
KEY_EXCHANGE_CONTEXT_TYPE_KEY 6
=7 8
$str9 O
;O P
private 
const 
string +
KEY_EXCHANGE_CONTEXT_TYPE_VALUE 8
=9 :
$str; R
;R S
private 
const 
string !
CONNECTION_CONTEXT_ID .
=/ 0
$str1 ?
;? @
private 
const 
string  
OPERATION_CONTEXT_ID -
=. /
$str0 >
;> ?
public 

static 
Metadata 
GenerateMetadata +
(+ ,
string 
appInstanceId 
, 
string 
appDeviceId 
, 
string 
? 
culture 
, 
PubKeyExchangeType   
exchangeType   '
=  ( )
PubKeyExchangeType  * <
.  < =&
DataCenterEphemeralConnect  = W
,  W X
string!! 
?!! 
localIpAddress!! 
=!!  
null!!! %
,!!% &
string"" 
?"" 
publicIpAddress"" 
=""  !
null""" &
,""& '
string## 
?## 
platform## 
=## 
null## 
)##  
{$$ 
Metadata%% 
metadata%% 
=%% 
new%% 
(%%  
)%%  !
{&& 	
{'' 
REQUEST_ID_KEY'' 
,'' 
Guid'' "
.''" #
NewGuid''# *
(''* +
)''+ ,
.'', -
ToString''- 5
(''5 6
)''6 7
}''8 9
,''9 :
{(( 
DATE_TIME_KEY(( 
,(( 
DateTimeOffset(( +
.((+ ,
UtcNow((, 2
.((2 3
ToString((3 ;
(((; <
$str((< ?
)((? @
}((A B
,((B C
{))  
LOCAL_IP_ADDRESS_KEY)) "
,))" #
localIpAddress))$ 2
??))3 5
GetLocalIpAddress))6 G
())G H
)))H I
}))J K
,))K L
{** !
PUBLIC_IP_ADDRESS_KEY** #
,**# $
publicIpAddress**% 4
??**5 7
GetPublicIpAddress**8 J
(**J K
)**K L
}**M N
,**N O
{++ 

LOCALE_KEY++ 
,++ 
culture++ !
??++" $
$str++% ,
}++- .
,++. /
{,, 
LINK_ID_KEY,, 
,,, 
GenerateLinkId,, )
(,,) *
),,* +
},,, -
,,,- .
{-- '
APPLICATION_INSTANCE_ID_KEY-- )
,--) *
appInstanceId--+ 8
}--9 :
,--: ;
{.. 
APP_DEVICE_ID.. 
,.. 
appDeviceId.. (
}..) *
,..* +
{// 
PLATFORM_KEY// 
,// 
platform// $
??//% '
GetPlatform//( 3
(//3 4
)//4 5
}//6 7
,//7 8
{00 )
KEY_EXCHANGE_CONTEXT_TYPE_KEY00 +
,00+ ,+
KEY_EXCHANGE_CONTEXT_TYPE_VALUE00- L
}00M N
,00N O
{11 !
CONNECTION_CONTEXT_ID11 #
,11# $
exchangeType11% 1
.111 2
ToString112 :
(11: ;
)11; <
}11= >
,11> ?
{22  
OPERATION_CONTEXT_ID22 "
,22" #
string22$ *
.22* +
Empty22+ 0
}221 2
}33 	
;33	 

return55 
metadata55 
;55 
}66 
private88 
static88 
string88 
GetLocalIpAddress88 +
(88+ ,
)88, -
{99 
try:: 
{;; 	
string<< 
localIp<< 
=<< 
NetworkInterface<< -
.<<- .#
GetAllNetworkInterfaces<<. E
(<<E F
)<<F G
.== 
Where== 
(== 
x== 
=>== 
x== 
.== 
OperationalStatus== /
====0 2
OperationalStatus==3 D
.==D E
Up==E G
&&==H J
!==K L
x==L M
.==M N
IsReceiveOnly==N [
)==[ \
.>> 

SelectMany>> 
(>> 
x>> 
=>>>  
x>>! "
.>>" #
GetIPProperties>># 2
(>>2 3
)>>3 4
.>>4 5
UnicastAddresses>>5 E
)>>E F
.?? 
Where?? 
(?? 
x?? 
=>?? 
x?? 
.?? 
Address?? %
.??% &
AddressFamily??& 3
==??4 6
AddressFamily??7 D
.??D E
InterNetwork??E Q
&&??R T
!??U V
	IPAddress??V _
.??_ `

IsLoopback??` j
(??j k
x??k l
.??l m
Address??m t
)??t u
)??u v
.@@ 
Select@@ 
(@@ 
x@@ 
=>@@ 
x@@ 
.@@ 
Address@@ &
.@@& '
ToString@@' /
(@@/ 0
)@@0 1
)@@1 2
.AA 
FirstOrDefaultAA 
(AA  
)AA  !
??AA" $
$strAA% 0
;AA0 1
returnCC 
localIpCC 
;CC 
}DD 	
catchEE 
{FF 	
returnGG 
$strGG 
;GG 
}HH 	
}II 
privateKK 
staticKK 
stringKK 
GetPublicIpAddressKK ,
(KK, -
)KK- .
{LL 
tryMM 
{NN 	
usingOO 
	UdpClientOO 
clientOO "
=OO# $
newOO% (
(OO( )
)OO) *
;OO* +
clientPP 
.PP 
ConnectPP 
(PP 
$strPP $
,PP$ %
$numPP& (
)PP( )
;PP) *

IPEndPointQQ 
?QQ 
endpointQQ  
=QQ! "
clientQQ# )
.QQ) *
ClientQQ* 0
.QQ0 1
LocalEndPointQQ1 >
asQQ? A

IPEndPointQQB L
;QQL M
returnRR 
endpointRR 
?RR 
.RR 
AddressRR $
.RR$ %
ToStringRR% -
(RR- .
)RR. /
??RR0 2
GetLocalIpAddressRR3 D
(RRD E
)RRE F
;RRF G
}SS 	
catchTT 
{UU 	
returnVV 
GetLocalIpAddressVV $
(VV$ %
)VV% &
;VV& '
}WW 	
}XX 
privateZZ 
staticZZ 
stringZZ 
GenerateLinkIdZZ (
(ZZ( )
)ZZ) *
=>ZZ+ -
$"ZZ. 0
$strZZ0 5
{ZZ5 6
GuidZZ6 :
.ZZ: ;
NewGuidZZ; B
(ZZB C
)ZZC D
:ZZD E
$strZZE F
}ZZF G
"ZZG H
[ZZH I
..ZZI K
$numZZK M
]ZZM N
;ZZN O
private\\ 
static\\ 
string\\ 
GetPlatform\\ %
(\\% &
)\\& '
{]] 
string^^ 
os^^ 
=^^ 
GetOperatingSystem^^ &
(^^& '
)^^' (
;^^( )
string__ 
arch__ 
=__ 
GetArchitecture__ %
(__% &
)__& '
;__' (
string`` 
runtime`` 
=`` 
GetRuntimeVersion`` *
(``* +
)``+ ,
;``, -
returnaa 
$"aa 
{aa 
osaa 
}aa 
$straa 
{aa 
archaa 
}aa 
$straa #
{aa# $
runtimeaa$ +
}aa+ ,
$straa, -
"aa- .
;aa. /
}bb 
privatedd 
staticdd 
stringdd 
GetOperatingSystemdd ,
(dd, -
)dd- .
{ee 
ifff 

(ff 
RuntimeInformationff 
.ff 
IsOSPlatformff +
(ff+ ,

OSPlatformff, 6
.ff6 7
OSXff7 :
)ff: ;
)ff; <
{gg 	
returnhh 
$strhh 
;hh 
}ii 	
ifkk 

(kk 
RuntimeInformationkk 
.kk 
IsOSPlatformkk +
(kk+ ,

OSPlatformkk, 6
.kk6 7
Windowskk7 >
)kk> ?
)kk? @
{ll 	
returnmm 
$strmm 
;mm 
}nn 	
ifpp 

(pp 
RuntimeInformationpp 
.pp 
IsOSPlatformpp +
(pp+ ,

OSPlatformpp, 6
.pp6 7
Linuxpp7 <
)pp< =
)pp= >
{qq 	
returnrr 
$strrr 
;rr 
}ss 	
returnuu 
$struu 
;uu 
}vv 
privatexx 
staticxx 
stringxx 
GetArchitecturexx )
(xx) *
)xx* +
{yy 
Architecturezz 
processArchzz  
=zz! "
RuntimeInformationzz# 5
.zz5 6
ProcessArchitecturezz6 I
;zzI J
return{{ 
processArch{{ 
switch{{ !
{|| 	
Architecture}} 
.}} 
Arm64}} 
=>}} !
$str}}" )
,}}) *
Architecture~~ 
.~~ 
X64~~ 
=>~~ 
$str~~  %
,~~% &
Architecture 
. 
X86 
=> 
$str  %
,% &
Architecture
€€ 
.
€€ 
Arm
€€ 
=>
€€ 
$str
€€  '
,
€€' (
_
 
=>
 
processArch
 
.
 
ToString
 %
(
% &
)
& '
}
‚‚ 	
;
‚‚	 

}
ƒƒ 
private
…… 
static
…… 
string
…… 
GetRuntimeVersion
…… +
(
……+ ,
)
……, -
{
†† 
string
‡‡ "
frameworkDescription
‡‡ #
=
‡‡$ % 
RuntimeInformation
‡‡& 8
.
‡‡8 9"
FrameworkDescription
‡‡9 M
;
‡‡M N
int
ˆˆ 

startIndex
ˆˆ 
=
ˆˆ "
frameworkDescription
ˆˆ -
.
ˆˆ- .
IndexOf
ˆˆ. 5
(
ˆˆ5 6
$char
ˆˆ6 9
)
ˆˆ9 :
;
ˆˆ: ;
if
‰‰ 

(
‰‰ 

startIndex
‰‰ 
>=
‰‰ 
$num
‰‰ 
&&
‰‰ 

startIndex
‰‰ )
<
‰‰* +"
frameworkDescription
‰‰, @
.
‰‰@ A
Length
‰‰A G
-
‰‰H I
$num
‰‰J K
)
‰‰K L
{
ŠŠ 	
return
‹‹ "
frameworkDescription
‹‹ '
[
‹‹' (
(
‹‹( )

startIndex
‹‹) 3
+
‹‹4 5
$num
‹‹6 7
)
‹‹7 8
..
‹‹8 :
]
‹‹: ;
;
‹‹; <
}
ŒŒ 	
return
 "
frameworkDescription
 #
;
# $
}
ŽŽ 
} 
›/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Transport/Grpc/GrpcClientServiceExtensions.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Infrastructure

 &
.

& '
Network

' .
.

. /
	Transport

/ 8
.

8 9
Grpc

9 =
;

= >
public 
static 
class '
GrpcClientServiceExtensions /
{ 
public 

static 
void $
AddConfiguredGrpcClients /
(/ 0
this0 4
IServiceCollection5 G
servicesH P
)P Q
{ 
services 
. 
AddGrpcClient 
< 
DeviceService ,
., -
DeviceServiceClient- @
>@ A
(A B
ConfigureClientB Q
)Q R
. 
AddInterceptor 
< &
RequestMetaDataInterceptor 6
>6 7
(7 8
)8 9
;9 :
services 
. 
AddGrpcClient 
< 
MembershipServices 1
.1 2$
MembershipServicesClient2 J
>J K
(K L
ConfigureClientL [
)[ \
. 
AddInterceptor 
< &
RequestMetaDataInterceptor 6
>6 7
(7 8
)8 9
;9 :
services 
. 
AddGrpcClient 
< $
AuthVerificationServices 7
.7 8*
AuthVerificationServicesClient8 V
>V W
(W X
ConfigureClientX g
)g h
. 
AddInterceptor 
< &
RequestMetaDataInterceptor 6
>6 7
(7 8
)8 9
;9 :
} 
private 
static 
void 
ConfigureClient '
(' (
IServiceProvider( 8
serviceProvider9 H
,H I$
GrpcClientFactoryOptionsJ b
optionsc j
)j k
{ !
DefaultSystemSettings 
settings &
=' (
serviceProvider) 8
.8 9
GetRequiredService9 K
<K L
IOptionsL T
<T U!
DefaultSystemSettingsU j
>j k
>k l
(l m
)m n
.n o
Valueo t
;t u
string 
endpoint 
= 
settings "
." #&
DataCenterConnectionString# =
;= >
if   

(   
string   
.   
IsNullOrEmpty    
(    !
endpoint  ! )
)  ) *
)  * +
{!! 	
throw"" 
new"" %
InvalidOperationException"" /
(""/ 0
$str""0 g
)""g h
;""h i
}## 	
options%% 
.%% 
Address%% 
=%% 
new%% 
Uri%% !
(%%! "
endpoint%%" *
)%%* +
;%%+ ,
}&& 
}(( ‹¤
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Core/Providers/NetworkProvider.cs
	namespace$$ 	
Ecliptix$$
 
.$$ 
Core$$ 
.$$ 
Infrastructure$$ &
.$$& '
Network$$' .
.$$. /
Core$$/ 3
.$$3 4
	Providers$$4 =
;$$= >
public&& 
sealed&& 
record&& '
NetworkProviderDependencies&& 0
(&&0 1
IRpcServiceManager'' 
RpcServiceManager'' (
,''( )-
!IApplicationSecureStorageProvider(( %,
 ApplicationSecureStorageProvider((& F
,((F G'
ISecureProtocolStateStorage)) &
SecureProtocolStateStorage))  :
,)): ; 
IRpcMetaDataProvider** 
RpcMetaDataProvider** ,
)**, -
;**- .
public,, 
sealed,, 
record,, #
NetworkProviderServices,, ,
(,,, - 
IConnectivityService-- 
ConnectivityService-- ,
,--, -
IRetryStrategy.. 
RetryStrategy..  
,..  !"
IPendingRequestManager// !
PendingRequestManager// 0
)//0 1
;//1 2
public11 
sealed11 
record11 #
NetworkProviderSecurity11 ,
(11, --
!ICertificatePinningServiceFactory22 %,
 CertificatePinningServiceFactory22& F
,22F G
IRsaChunkEncryptor33 
RsaChunkEncryptor33 (
,33( ) 
IRetryPolicyProvider44 
RetryPolicyProvider44 ,
)44, -
;44- .
public66 
sealed66 
class66 
NetworkProvider66 #
:66$ %
INetworkProvider66& 6
,666 7
IDisposable668 C
,66C D!
IProtocolEventHandler66E Z
{77 
private88 
readonly88 
IRpcServiceManager88 '
rpcServiceManager88( 9
;889 :
private99 
readonly99 -
!IApplicationSecureStorageProvider99 6,
 applicationSecureStorageProvider997 W
;99W X
private:: 
readonly:: '
ISecureProtocolStateStorage:: 0&
secureProtocolStateStorage::1 K
;::K L
private;; 
readonly;;  
IRpcMetaDataProvider;; )
rpcMetaDataProvider;;* =
;;;= >
private<< 
readonly<<  
IConnectivityService<< )
connectivityService<<* =
;<<= >
private== 
readonly== 
IRetryStrategy== #
retryStrategy==$ 1
;==1 2
private>> 
readonly>> "
IPendingRequestManager>> +!
pendingRequestManager>>, A
;>>A B
private?? 
readonly?? -
!ICertificatePinningServiceFactory?? 6,
 certificatePinningServiceFactory??7 W
;??W X
private@@ 
readonly@@ 
IRsaChunkEncryptor@@ '
rsaChunkEncryptor@@( 9
;@@9 :
privateAA 
readonlyAA  
IRetryPolicyProviderAA )
retryPolicyProviderAA* =
;AA= >
publicCC 

NetworkProviderCC 
(CC '
NetworkProviderDependenciesDD #
dependenciesDD$ 0
,DD0 1#
NetworkProviderServicesEE 
servicesEE  (
,EE( )#
NetworkProviderSecurityFF 
securityFF  (
)FF( )
{GG 
rpcServiceManagerHH 
=HH 
dependenciesHH (
.HH( )
RpcServiceManagerHH) :
;HH: ;,
 applicationSecureStorageProviderII (
=II) *
dependenciesII+ 7
.II7 8,
 ApplicationSecureStorageProviderII8 X
;IIX Y&
secureProtocolStateStorageJJ "
=JJ# $
dependenciesJJ% 1
.JJ1 2&
SecureProtocolStateStorageJJ2 L
;JJL M
rpcMetaDataProviderKK 
=KK 
dependenciesKK *
.KK* +
RpcMetaDataProviderKK+ >
;KK> ?
connectivityServiceLL 
=LL 
servicesLL &
.LL& '
ConnectivityServiceLL' :
;LL: ;
retryStrategyMM 
=MM 
servicesMM  
.MM  !
RetryStrategyMM! .
;MM. /!
pendingRequestManagerNN 
=NN 
servicesNN  (
.NN( )!
PendingRequestManagerNN) >
;NN> ?,
 certificatePinningServiceFactoryOO (
=OO) *
securityOO+ 3
.OO3 4,
 CertificatePinningServiceFactoryOO4 T
;OOT U
rsaChunkEncryptorPP 
=PP 
securityPP $
.PP$ %
RsaChunkEncryptorPP% 6
;PP6 7
retryPolicyProviderQQ 
=QQ 
securityQQ &
.QQ& '
RetryPolicyProviderQQ' :
;QQ: ;
}RR 
privateSS 
staticSS  
TaskCompletionSourceSS '
<SS' (
boolSS( ,
>SS, -
CreateOutageTcsSS. =
(SS= >
)SS> ?
=>SS@ B
newTT 
(TT 
TaskCreationOptionsTT 
.TT  *
RunContinuationsAsynchronouslyTT  >
)TT> ?
;TT? @
privateVV 
readonlyVV  
ConcurrentDictionaryVV )
<VV) *
uintVV* .
,VV. /"
EcliptixProtocolSystemVV0 F
>VVF G
_connectionsVVH T
=VVU V
newVVW Z
(VVZ [
)VV[ \
;VV\ ]
privateWW 
readonlyWW  
ConcurrentDictionaryWW )
<WW) *
uintWW* .
,WW. /#
CancellationTokenSourceWW0 G
>WWG H
_activeStreamsWWI W
=WWX Y
newWWZ ]
(WW] ^
)WW^ _
;WW_ `
privateXX 
readonlyXX  
ConcurrentDictionaryXX )
<XX) *
stringXX* 0
,XX0 1#
CancellationTokenSourceXX2 I
>XXI J
_pendingRequestsXXK [
=XX\ ]
newXX^ a
(XXa b
)XXb c
;XXc d
privateYY 
readonlyYY 
LockYY 
_cancellationLockYY +
=YY, -
newYY. 1
(YY1 2
)YY2 3
;YY3 4
privateZZ 
readonlyZZ #
CancellationTokenSourceZZ ,&
_shutdownCancellationTokenZZ- G
=ZZH I
newZZJ M
(ZZM N
)ZZN O
;ZZO P
private[[ 
readonly[[  
ConcurrentDictionary[[ )
<[[) *
uint[[* .
,[[. /
SemaphoreSlim[[0 =
>[[= >
_channelGates[[? L
=[[M N
new[[O R
([[R S
)[[S T
;[[T U
private\\ 
readonly\\ 
SemaphoreSlim\\ "%
_retryPendingRequestsGate\\# <
=\\= >
new\\? B
(\\B C
$num\\C D
,\\D E
$num\\F G
)\\G H
;\\H I
private]] 
readonly]] 
Lock]] 
_outageLock]] %
=]]& '
new]]( +
(]]+ ,
)]], -
;]]- .
private^^ 
readonly^^ 
Lock^^ 
_disposeLock^^ &
=^^' (
new^^) ,
(^^, -
)^^- .
;^^. /
private__ 
readonly__ 
Lock__ "
_appInstanceSetterLock__ 0
=__1 2
new__3 6
(__6 7
)__7 8
;__8 9
privateaa #
CancellationTokenSourceaa #
?aa# $"
_connectionRecoveryCtsaa% ;
;aa; <
privatebb 
Optionbb 
<bb '
ApplicationInstanceSettingsbb .
>bb. /(
_applicationInstanceSettingsbb0 L
=bbM N
OptionbbO U
<bbU V'
ApplicationInstanceSettingsbbV q
>bbq r
.bbr s
Nonebbs w
;bbw x
privatecc 
intcc 
_outageStatecc 
;cc 
privatedd  
TaskCompletionSourcedd  
<dd  !
booldd! %
>dd% &#
_outageCompletionSourcedd' >
=dd? @
CreateOutageTcsddA P
(ddP Q
)ddQ R
;ddR S
privateee 
volatileee 
boolee 
	_disposedee #
;ee# $
publicgg 
'
ApplicationInstanceSettingsgg &'
ApplicationInstanceSettingsgg' B
{hh 
getii 
{jj 	
ifkk 
(kk 
!kk (
_applicationInstanceSettingskk -
.kk- .
IsSomekk. 4
)kk4 5
{ll 
throwmm 
newmm %
InvalidOperationExceptionmm 3
(mm3 4
$strnn v
)nnv w
;nnw x
}oo 
returnqq (
_applicationInstanceSettingsqq /
.qq/ 0
Valueqq0 5
!qq5 6
;qq6 7
}rr 	
}ss 
privateuu 
asyncuu 
Taskuu 
<uu 
Resultuu 
<uu 
Optionuu $
<uu$ % 
EcliptixSessionStateuu% 9
>uu9 :
,uu: ;
NetworkFailureuu< J
>uuJ K
>uuK L0
$EstablishSecrecyChannelInternalAsyncuuM q
(uuq r
uintvv 
	connectIdvv 
,vv 
PubKeyExchangeTypeww 
EXCHANGE_TYPEww (
,ww( )
intxx 
?xx 

maxRetriesxx 
=xx 
nullxx 
,xx 
boolyy 
	saveStateyy 
=yy 
trueyy 
,yy 
CancellationTokenzz 
cancellationTokenzz +
=zz, -
defaultzz. 5
,zz5 6
bool{{ %
enablePendingRegistration{{ &
={{' (
true{{) -
){{- .
{|| 
if}} 

(}} 
EXCHANGE_TYPE}} 
==}} 
PubKeyExchangeType}} /
.}}/ 0&
DataCenterEphemeralConnect}}0 J
)}}J K
{~~ 	
Avalonia 
. 
	Threading 
. 

Dispatcher )
.) *
UIThread* 2
.2 3
Post3 7
(7 8
(8 9
)9 :
=>; =
{
€€ !
connectivityService
 #
.
# $
PublishAsync
$ 0
(
0 1 
ConnectivityIntent
1 C
.
C D

Connecting
D N
(
N O
	connectId
O X
)
X Y
)
Y Z
.
Z [
ContinueWith
[ g
(
g h
task
‚‚ 
=>
‚‚ 
{
ƒƒ 
if
„„ 
(
„„ 
task
„„  
.
„„  !
	IsFaulted
„„! *
&&
„„+ -
task
„„. 2
.
„„2 3
	Exception
„„3 <
!=
„„= ?
null
„„@ D
)
„„D E
{
…… 
Log
†† 
.
††  
Error
††  %
(
††% &
task
††& *
.
††* +
	Exception
††+ 4
,
††4 5
$str
††6 z
)
††z {
;
††{ |
}
‡‡ 
}
ˆˆ 
,
ˆˆ 
TaskScheduler
‰‰ !
.
‰‰! "
Default
‰‰" )
)
‰‰) *
;
‰‰* +
}
ŠŠ 
)
ŠŠ 
;
ŠŠ 
}
‹‹ 	
if
 

(
 
!
 
_connections
 
.
 
TryGetValue
 %
(
% &
	connectId
& /
,
/ 0
out
1 4$
EcliptixProtocolSystem
5 K
?
K L
protocolSystem
M [
)
[ \
)
\ ]
{
ŽŽ 	
return
 
Result
 
<
 
Option
  
<
  !"
EcliptixSessionState
! 5
>
5 6
,
6 7
NetworkFailure
8 F
>
F G
.
G H
Err
H K
(
K L
NetworkFailure
 
.
 %
DataCenterNotResponding
 6
(
6 7
$str
7 j
)
j k
)
k l
;
l m
}
‘‘ 	
Result
““ 
<
““ 
PubKeyExchange
““ 
,
““ %
EcliptixProtocolFailure
““ 6
>
““6 7#
pubKeyExchangeRequest
““8 M
=
““N O
protocolSystem
”” 
.
”” +
BeginDataCenterPubKeyExchange
”” 8
(
””8 9
	connectId
””9 B
,
””B C
EXCHANGE_TYPE
””D Q
)
””Q R
;
””R S
if
–– 

(
–– #
pubKeyExchangeRequest
–– !
.
––! "
IsErr
––" '
)
––' (
{
—— 	
return
˜˜ 
Result
˜˜ 
<
˜˜ 
Option
˜˜  
<
˜˜  !"
EcliptixSessionState
˜˜! 5
>
˜˜5 6
,
˜˜6 7
NetworkFailure
˜˜8 F
>
˜˜F G
.
˜˜G H
Err
˜˜H K
(
˜˜K L#
pubKeyExchangeRequest
™™ %
.
™™% &
	UnwrapErr
™™& /
(
™™/ 0
)
™™0 1
.
™™1 2
ToNetworkFailure
™™2 B
(
™™B C
)
™™C D
)
™™D E
;
™™E F
}
šš 	
EnvelopeMetadata
œœ 
metadata
œœ !
=
œœ" #
EnvelopeBuilder
œœ$ 3
.
œœ3 4$
CreateEnvelopeMetadata
œœ4 J
(
œœJ K
	requestId
 
:
 
	connectId
  
,
  !
nonce
žž 
:
žž 

ByteString
žž 
.
žž 
Empty
žž #
,
žž# $
ratchetIndex
ŸŸ 
:
ŸŸ 
$num
ŸŸ 
,
ŸŸ 
envelopeType
   
:
   
EnvelopeType
   &
.
  & '
Request
  ' .
)
¡¡ 	
;
¡¡	 

Option
££ 
<
££ '
CertificatePinningService
££ (
>
££( )'
certificatePinningService
££* C
=
££D E
await
¤¤ .
 certificatePinningServiceFactory
¤¤ 2
.
¤¤2 3)
GetOrInitializeServiceAsync
¤¤3 N
(
¤¤N O
)
¤¤O P
;
¤¤P Q
if
¦¦ 

(
¦¦ 
!
¦¦ '
certificatePinningService
¦¦ &
.
¦¦& '
IsSome
¦¦' -
)
¦¦- .
{
§§ 	
return
¨¨ 
Result
¨¨ 
<
¨¨ 
Option
¨¨  
<
¨¨  !"
EcliptixSessionState
¨¨! 5
>
¨¨5 6
,
¨¨6 7
NetworkFailure
¨¨8 F
>
¨¨F G
.
¨¨G H
Err
¨¨H K
(
¨¨K L
NetworkFailure
©© 
.
©© 
RsaEncryption
©© ,
(
©©, -
$str
©©- _
)
©©_ `
)
©©` a
;
©©a b
}
ªª 	
byte
¬¬ 
[
¬¬ 
]
¬¬ 
originalData
¬¬ 
=
¬¬ #
pubKeyExchangeRequest
¬¬ 3
.
¬¬3 4
Unwrap
¬¬4 :
(
¬¬: ;
)
¬¬; <
.
¬¬< =
ToByteArray
¬¬= H
(
¬¬H I
)
¬¬I J
;
¬¬J K
Result
®® 
<
®® 
byte
®® 
[
®® 
]
®® 
,
®® 
NetworkFailure
®® %
>
®®% &
encryptResult
®®' 4
=
®®5 6
rsaChunkEncryptor
¯¯ 
.
¯¯ 
EncryptInChunks
¯¯ -
(
¯¯- .'
certificatePinningService
¯¯. G
.
¯¯G H
Value
¯¯H M
!
¯¯M N
,
¯¯N O
originalData
¯¯P \
)
¯¯\ ]
;
¯¯] ^
if
°° 

(
°° 
encryptResult
°° 
.
°° 
IsErr
°° 
)
°°  
{
±± 	
return
²² 
Result
²² 
<
²² 
Option
²²  
<
²²  !"
EcliptixSessionState
²²! 5
>
²²5 6
,
²²6 7
NetworkFailure
²²8 F
>
²²F G
.
²²G H
Err
²²H K
(
²²K L
encryptResult
²²L Y
.
²²Y Z
	UnwrapErr
²²Z c
(
²²c d
)
²²d e
)
²²e f
;
²²f g
}
³³ 	
byte
µµ 
[
µµ 
]
µµ &
combinedEncryptedPayload
µµ '
=
µµ( )
encryptResult
µµ* 7
.
µµ7 8
Unwrap
µµ8 >
(
µµ> ?
)
µµ? @
;
µµ@ A
SecureEnvelope
·· 
envelope
·· 
=
··  !
EnvelopeBuilder
··" 1
.
··1 2"
CreateSecureEnvelope
··2 F
(
··F G
metadata
¸¸ 
,
¸¸ 

ByteString
¹¹ 
.
¹¹ 
CopyFrom
¹¹ 
(
¹¹  &
combinedEncryptedPayload
¹¹  8
)
¹¹8 9
)
ºº 	
;
ºº	 

CancellationToken
¼¼ 

finalToken
¼¼ $
=
¼¼% &
cancellationToken
¼¼' 8
==
¼¼9 ;
CancellationToken
¼¼< M
.
¼¼M N
None
¼¼N R
?
½½ (
GetConnectionRecoveryToken
½½ (
(
½½( )
)
½½) *
:
¾¾ 
cancellationToken
¾¾ 
;
¾¾  
Result
ÀÀ 
<
ÀÀ 
SecureEnvelope
ÀÀ 
,
ÀÀ 
NetworkFailure
ÀÀ -
>
ÀÀ- .4
&establishAppDeviceSecrecyChannelResult
ÀÀ/ U
;
ÀÀU V
if
ÁÁ 

(
ÁÁ 

maxRetries
ÁÁ 
.
ÁÁ 
HasValue
ÁÁ 
)
ÁÁ  
{
ÂÂ 	4
&establishAppDeviceSecrecyChannelResult
ÃÃ 2
=
ÃÃ3 4
await
ÃÃ5 :
retryStrategy
ÃÃ; H
.
ÃÃH I&
ExecuteRpcOperationAsync
ÃÃI a
(
ÃÃa b
(
ÄÄ 
_
ÄÄ 
,
ÄÄ 
ct
ÄÄ 
)
ÄÄ 
=>
ÄÄ 
rpcServiceManager
ÄÄ ,
.
ÄÄ, -*
EstablishSecrecyChannelAsync
ÄÄ- I
(
ÄÄI J!
connectivityService
ÄÄJ ]
,
ÄÄ] ^
envelope
ÄÄ_ g
,
ÄÄg h
EXCHANGE_TYPE
ÅÅ !
,
ÅÅ! "
cancellationToken
ÆÆ %
:
ÆÆ% &
ct
ÆÆ' )
)
ÆÆ) *
,
ÆÆ* +
$str
ÇÇ )
,
ÇÇ) *
	connectId
ÈÈ 
,
ÈÈ 
serviceType
ÉÉ 
:
ÉÉ 
RpcServiceType
ÉÉ +
.
ÉÉ+ ,%
EstablishSecrecyChannel
ÉÉ, C
,
ÉÉC D

maxRetries
ÊÊ 
:
ÊÊ 

maxRetries
ÊÊ &
.
ÊÊ& '
Value
ÊÊ' ,
,
ÊÊ, -
cancellationToken
ËË !
:
ËË! "

finalToken
ËË# -
)
ËË- .
.
ËË. /
ConfigureAwait
ËË/ =
(
ËË= >
false
ËË> C
)
ËËC D
;
ËËD E
}
ÌÌ 	
else
ÍÍ 
{
ÎÎ 	4
&establishAppDeviceSecrecyChannelResult
ÏÏ 2
=
ÏÏ3 4
await
ÏÏ5 :
retryStrategy
ÏÏ; H
.
ÏÏH I&
ExecuteRpcOperationAsync
ÏÏI a
(
ÏÏa b
(
ÐÐ 
_
ÐÐ 
,
ÐÐ 
ct
ÐÐ 
)
ÐÐ 
=>
ÐÐ 
rpcServiceManager
ÐÐ ,
.
ÐÐ, -*
EstablishSecrecyChannelAsync
ÐÐ- I
(
ÐÐI J!
connectivityService
ÐÐJ ]
,
ÐÐ] ^
envelope
ÐÐ_ g
,
ÐÐg h
EXCHANGE_TYPE
ÑÑ !
,
ÑÑ! "
cancellationToken
ÒÒ %
:
ÒÒ% &
ct
ÒÒ' )
)
ÒÒ) *
,
ÒÒ* +
$str
ÓÓ )
,
ÓÓ) *
	connectId
ÔÔ 
,
ÔÔ 
serviceType
ÕÕ 
:
ÕÕ 
RpcServiceType
ÕÕ +
.
ÕÕ+ ,%
EstablishSecrecyChannel
ÕÕ, C
,
ÕÕC D
cancellationToken
ÖÖ !
:
ÖÖ! "

finalToken
ÖÖ# -
)
ÖÖ- .
.
ÖÖ. /
ConfigureAwait
ÖÖ/ =
(
ÖÖ= >
false
ÖÖ> C
)
ÖÖC D
;
ÖÖD E
}
×× 	
if
ÙÙ 

(
ÙÙ 4
&establishAppDeviceSecrecyChannelResult
ÙÙ 2
.
ÙÙ2 3
IsErr
ÙÙ3 8
)
ÙÙ8 9
{
ÚÚ 	
NetworkFailure
ÛÛ 
failure
ÛÛ "
=
ÛÛ# $4
&establishAppDeviceSecrecyChannelResult
ÛÛ% K
.
ÛÛK L
	UnwrapErr
ÛÛL U
(
ÛÛU V
)
ÛÛV W
;
ÛÛW X
if
ÜÜ 
(
ÜÜ '
enablePendingRegistration
ÜÜ )
&&
ÜÜ* ,,
ShouldQueueSecrecyChannelRetry
ÜÜ- K
(
ÜÜK L
failure
ÜÜL S
)
ÜÜS T
)
ÜÜT U
{
ÝÝ /
!QueueSecrecyChannelEstablishRetry
ÞÞ 1
(
ÞÞ1 2
	connectId
ÞÞ2 ;
,
ÞÞ; <
EXCHANGE_TYPE
ÞÞ= J
,
ÞÞJ K

maxRetries
ÞÞL V
,
ÞÞV W
	saveState
ÞÞX a
)
ÞÞa b
;
ÞÞb c
}
ßß 
return
áá 
Result
áá 
<
áá 
Option
áá  
<
áá  !"
EcliptixSessionState
áá! 5
>
áá5 6
,
áá6 7
NetworkFailure
áá8 F
>
ááF G
.
ááG H
Err
ááH K
(
ááK L
failure
ááL S
)
ááS T
;
ááT U
}
ââ 	
SecureEnvelope
ää 
responseEnvelope
ää '
=
ää( )4
&establishAppDeviceSecrecyChannelResult
ää* P
.
ääP Q
Unwrap
ääQ W
(
ääW X
)
ääX Y
;
ääY Z
if
ææ 

(
ææ 
EXCHANGE_TYPE
ææ 
==
ææ  
PubKeyExchangeType
ææ /
.
ææ/ 0(
DataCenterEphemeralConnect
ææ0 J
)
ææJ K
{
çç 	*
CertificatePinningBoolResult
èè (*
certificatePinningBoolResult
èè) E
=
èèF G'
certificatePinningService
éé )
.
éé) *
Value
éé* /
!
éé/ 0
.
éé0 1#
VerifyServerSignature
éé1 F
(
ééF G
responseEnvelope
êê $
.
êê$ %
EncryptedPayload
êê% 5
.
êê5 6
Memory
êê6 <
,
êê< =
responseEnvelope
ëë $
.
ëë$ %
AuthenticationTag
ëë% 6
.
ëë6 7
Memory
ëë7 =
)
ëë= >
;
ëë> ?
if
íí 
(
íí 
!
íí *
certificatePinningBoolResult
íí -
.
íí- .
	IsSuccess
íí. 7
)
íí7 8
{
îî 
return
ïï 
Result
ïï 
<
ïï 
Option
ïï $
<
ïï$ %"
EcliptixSessionState
ïï% 9
>
ïï9 :
,
ïï: ;
NetworkFailure
ïï< J
>
ïïJ K
.
ïïK L
Err
ïïL O
(
ïïO P
NetworkFailure
ðð "
.
ðð" #
RsaEncryption
ðð# 0
(
ðð0 1
$"
ññ 
$str
ññ @
{
ññ@ A*
certificatePinningBoolResult
ññA ]
.
ññ] ^
ERROR
ññ^ c
?
ññc d
.
ññd e
Message
ññe l
}
ññl m
"
ññm n
)
ññn o
)
ñño p
;
ññp q
}
òò 
}
óó 	
byte
õõ 
[
õõ 
]
õõ '
combinedEncryptedResponse
õõ (
=
õõ) *
responseEnvelope
õõ+ ;
.
õõ; <
EncryptedPayload
õõ< L
.
õõL M
ToByteArray
õõM X
(
õõX Y
)
õõY Z
;
õõZ [
Result
÷÷ 
<
÷÷ 
byte
÷÷ 
[
÷÷ 
]
÷÷ 
,
÷÷ 
NetworkFailure
÷÷ %
>
÷÷% &
decryptResult
÷÷' 4
=
÷÷5 6
rsaChunkEncryptor
øø 
.
øø 
DecryptInChunks
øø -
(
øø- .'
certificatePinningService
øø. G
.
øøG H
Value
øøH M
!
øøM N
,
øøN O'
combinedEncryptedResponse
øøP i
)
øøi j
;
øøj k
if
ùù 

(
ùù 
decryptResult
ùù 
.
ùù 
IsErr
ùù 
)
ùù  
{
úú 	
return
ûû 
Result
ûû 
<
ûû 
Option
ûû  
<
ûû  !"
EcliptixSessionState
ûû! 5
>
ûû5 6
,
ûû6 7
NetworkFailure
ûû8 F
>
ûûF G
.
ûûG H
Err
ûûH K
(
ûûK L
decryptResult
ûûL Y
.
ûûY Z
	UnwrapErr
ûûZ c
(
ûûc d
)
ûûd e
)
ûûe f
;
ûûf g
}
üü 	
PubKeyExchange
þþ  
peerPubKeyExchange
þþ )
=
þþ* +
PubKeyExchange
þþ, :
.
þþ: ;
Parser
þþ; A
.
þþA B
	ParseFrom
þþB K
(
þþK L
decryptResult
þþL Y
.
þþY Z
Unwrap
þþZ `
(
þþ` a
)
þþa b
)
þþb c
;
þþc d
Result
€€ 
<
€€ 
Unit
€€ 
,
€€ %
EcliptixProtocolFailure
€€ ,
>
€€, -
completeResult
€€. <
=
€€= >
protocolSystem
 
.
 .
 CompleteDataCenterPubKeyExchange
 ;
(
; < 
peerPubKeyExchange
< N
)
N O
;
O P
if
‚‚ 

(
‚‚ 
completeResult
‚‚ 
.
‚‚ 
IsErr
‚‚  
)
‚‚  !
{
ƒƒ 	
return
„„ 
Result
„„ 
<
„„ 
Option
„„  
<
„„  !"
EcliptixSessionState
„„! 5
>
„„5 6
,
„„6 7
NetworkFailure
„„8 F
>
„„F G
.
„„G H
Err
„„H K
(
„„K L
completeResult
…… 
.
…… 
	UnwrapErr
…… (
(
……( )
)
……) *
.
……* +
ToNetworkFailure
……+ ;
(
……; <
)
……< =
)
……= >
;
……> ?
}
†† 	
if
ˆˆ 

(
ˆˆ 
!
ˆˆ 
	saveState
ˆˆ 
||
ˆˆ 
EXCHANGE_TYPE
ˆˆ '
!=
ˆˆ( * 
PubKeyExchangeType
ˆˆ+ =
.
ˆˆ= >(
DataCenterEphemeralConnect
ˆˆ> X
)
ˆˆX Y
{
‰‰ 	
return
ŠŠ 
Result
ŠŠ 
<
ŠŠ 
Option
ŠŠ  
<
ŠŠ  !"
EcliptixSessionState
ŠŠ! 5
>
ŠŠ5 6
,
ŠŠ6 7
NetworkFailure
ŠŠ8 F
>
ŠŠF G
.
ŠŠG H
Ok
ŠŠH J
(
ŠŠJ K
Option
ŠŠK Q
<
ŠŠQ R"
EcliptixSessionState
ŠŠR f
>
ŠŠf g
.
ŠŠg h
None
ŠŠh l
)
ŠŠl m
;
ŠŠm n
}
‹‹ 	(
EcliptixSystemIdentityKeys
 "
idKeys
# )
=
* +
protocolSystem
, :
.
: ;
GetIdentityKeys
; J
(
J K
)
K L
;
L M(
EcliptixProtocolConnection
ŽŽ "
?
ŽŽ" #

connection
ŽŽ$ .
=
ŽŽ/ 0
protocolSystem
ŽŽ1 ?
.
ŽŽ? @
GetConnection
ŽŽ@ M
(
ŽŽM N
)
ŽŽN O
;
ŽŽO P
if
 

(
 

connection
 
==
 
null
 
)
 
{
 	
return
‘‘ 
Result
‘‘ 
<
‘‘ 
Option
‘‘  
<
‘‘  !"
EcliptixSessionState
‘‘! 5
>
‘‘5 6
,
‘‘6 7
NetworkFailure
‘‘8 F
>
‘‘F G
.
‘‘G H
Err
‘‘H K
(
‘‘K L
new
’’ 
NetworkFailure
’’ "
(
’’" # 
NetworkFailureType
’’# 5
.
’’5 6(
DATA_CENTER_NOT_RESPONDING
’’6 P
,
’’P Q
$str
““ >
)
““> ?
)
““? @
;
““@ A
}
”” 	
Result
–– 
<
–– "
EcliptixSessionState
–– #
,
––# $%
EcliptixProtocolFailure
––% <
>
––< =/
!ecliptixSecrecyChannelStateResult
––> _
=
––` a
idKeys
—— 
.
—— 
ToProtoState
—— 
(
——  
)
——  !
.
˜˜ 
AndThen
˜˜ 
(
˜˜ 
identityKeysProto
˜˜ *
=>
˜˜+ -

connection
˜˜. 8
.
˜˜8 9
ToProtoState
˜˜9 E
(
˜˜E F
)
˜˜F G
.
™™ 
Map
™™ 
(
™™ 
ratchetStateProto
™™ *
=>
™™+ -
new
™™. 1"
EcliptixSessionState
™™2 F
{
šš 
	ConnectId
›› !
=
››" #
	connectId
››$ -
,
››- .
IdentityKeys
œœ $
=
œœ% &
identityKeysProto
œœ' 8
,
œœ8 9"
PeerHandshakeMessage
 ,
=
- . 
peerPubKeyExchange
/ A
,
A B
RatchetState
žž $
=
žž% &
ratchetStateProto
žž' 8
}
ŸŸ 
)
ŸŸ 
)
   
;
   
Result
¢¢ 
<
¢¢ 
Option
¢¢ 
<
¢¢ "
EcliptixSessionState
¢¢ *
>
¢¢* +
,
¢¢+ ,
NetworkFailure
¢¢- ;
>
¢¢; <
mappedResult
¢¢= I
=
¢¢J K/
!ecliptixSecrecyChannelStateResult
££ -
.
££- .
ToNetworkFailure
££. >
(
££> ?
)
££? @
.
££@ A
Map
££A D
(
££D E
Option
££E K
<
££K L"
EcliptixSessionState
££L `
>
££` a
.
££a b
Some
££b f
)
££f g
;
££g h
if
¥¥ 

(
¥¥ '
enablePendingRegistration
¥¥ %
&&
¥¥& (
mappedResult
¥¥) 5
.
¥¥5 6
IsOk
¥¥6 :
)
¥¥: ;
{
¦¦ 	#
pendingRequestManager
§§ !
.
§§! ""
RemovePendingRequest
§§" 6
(
§§6 7+
BuildSecrecyChannelPendingKey
§§7 T
(
§§T U
	connectId
§§U ^
,
§§^ _
EXCHANGE_TYPE
§§` m
)
§§m n
)
§§n o
;
§§o p

ExitOutage
¨¨ 
(
¨¨ 
)
¨¨ 
;
¨¨ 
}
©© 	
return
«« 
mappedResult
«« 
;
«« 
}
¬¬ 
public
®® 

void
®® 

SetCountry
®® 
(
®® 
string
®® !
country
®®" )
)
®®) *
{
¯¯ 
lock
°° 
(
°° $
_appInstanceSetterLock
°° $
)
°°$ %
{
±± 	
if
²² 
(
²² *
_applicationInstanceSettings
²² ,
.
²², -
IsSome
²²- 3
)
²²3 4
{
³³ )
ApplicationInstanceSettings
´´ +
current
´´, 3
=
´´4 5*
_applicationInstanceSettings
´´6 R
.
´´R S
Value
´´S X
!
´´X Y
;
´´Y Z)
ApplicationInstanceSettings
µµ +
updated
µµ, 3
=
µµ4 5
current
µµ6 =
.
µµ= >
Clone
µµ> C
(
µµC D
)
µµD E
;
µµE F
updated
¶¶ 
.
¶¶ 
Country
¶¶ 
=
¶¶  !
country
¶¶" )
;
¶¶) **
_applicationInstanceSettings
·· ,
=
··- .
Option
··/ 5
<
··5 6)
ApplicationInstanceSettings
··6 Q
>
··Q R
.
··R S
Some
··S W
(
··W X
updated
··X _
)
··_ `
;
··` a
}
¸¸ 
}
¹¹ 	
}
ºº 
public
¼¼ 

uint
¼¼ $
ComputeUniqueConnectId
¼¼ &
(
¼¼& ' 
PubKeyExchangeType
¼¼' 9 
pubKeyExchangeType
¼¼: L
)
¼¼L M
=>
¼¼N P$
ComputeUniqueConnectId
½½ 
(
½½ *
_applicationInstanceSettings
½½ ;
.
½½; <
Value
½½< A
!
½½A B
,
½½B C 
pubKeyExchangeType
½½D V
)
½½V W
;
½½W X
public
¿¿ 

void
¿¿ ,
InitiateEcliptixProtocolSystem
¿¿ .
(
¿¿. /)
ApplicationInstanceSettings
¿¿/ J)
applicationInstanceSettings
¿¿K f
,
¿¿f g
uint
¿¿h l
	connectId
¿¿m v
)
¿¿v w
{
ÀÀ *
_applicationInstanceSettings
ÁÁ $
=
ÁÁ% &
Option
ÁÁ' -
<
ÁÁ- .)
ApplicationInstanceSettings
ÁÁ. I
>
ÁÁI J
.
ÁÁJ K
Some
ÁÁK O
(
ÁÁO P)
applicationInstanceSettings
ÁÁP k
)
ÁÁk l
;
ÁÁl m(
EcliptixSystemIdentityKeys
ÃÃ "
identityKeys
ÃÃ# /
=
ÃÃ0 1(
EcliptixSystemIdentityKeys
ÄÄ &
.
ÄÄ& '
Create
ÄÄ' -
(
ÄÄ- .
NetworkConstants
ÄÄ. >
.
ÄÄ> ?
Protocol
ÄÄ? G
.
ÄÄG H(
DEFAULT_ONE_TIME_KEY_COUNT
ÄÄH b
)
ÄÄb c
.
ÄÄc d
Unwrap
ÄÄd j
(
ÄÄj k
)
ÄÄk l
;
ÄÄl m0
"DetermineExchangeTypeFromConnectId
ÆÆ *
(
ÆÆ* +)
applicationInstanceSettings
ÆÆ+ F
,
ÆÆF G
	connectId
ÆÆH Q
)
ÆÆQ R
;
ÆÆR S$
EcliptixProtocolSystem
ÈÈ 
protocolSystem
ÈÈ -
=
ÈÈ. /
new
ÈÈ0 3
(
ÈÈ3 4
identityKeys
ÈÈ4 @
)
ÈÈ@ A
;
ÈÈA B
protocolSystem
ÊÊ 
.
ÊÊ 
SetEventHandler
ÊÊ &
(
ÊÊ& '
this
ÊÊ' +
)
ÊÊ+ ,
;
ÊÊ, -
_connections
ÌÌ 
.
ÌÌ 
TryAdd
ÌÌ 
(
ÌÌ 
	connectId
ÌÌ %
,
ÌÌ% &
protocolSystem
ÌÌ' 5
)
ÌÌ5 6
;
ÌÌ6 7
Guid
ÎÎ 
appInstanceId
ÎÎ 
=
ÎÎ 
Helpers
ÎÎ $
.
ÎÎ$ %"
FromByteStringToGuid
ÎÎ% 9
(
ÎÎ9 :)
applicationInstanceSettings
ÎÎ: U
.
ÎÎU V
AppInstanceId
ÎÎV c
)
ÎÎc d
;
ÎÎd e
Guid
ÏÏ 
deviceId
ÏÏ 
=
ÏÏ 
Helpers
ÏÏ 
.
ÏÏ  "
FromByteStringToGuid
ÏÏ  4
(
ÏÏ4 5)
applicationInstanceSettings
ÏÏ5 P
.
ÏÏP Q
DeviceId
ÏÏQ Y
)
ÏÏY Z
;
ÏÏZ [
string
ÐÐ 
?
ÐÐ 
culture
ÐÐ 
=
ÐÐ 
string
ÐÐ  
.
ÐÐ  !
IsNullOrEmpty
ÐÐ! .
(
ÐÐ. /)
applicationInstanceSettings
ÐÐ/ J
.
ÐÐJ K
Culture
ÐÐK R
)
ÐÐR S
?
ÑÑ )
AppCultureSettingsConstants
ÑÑ )
.
ÑÑ) *"
DEFAULT_CULTURE_CODE
ÑÑ* >
:
ÒÒ )
applicationInstanceSettings
ÒÒ )
.
ÒÒ) *
Culture
ÒÒ* 1
;
ÒÒ1 2!
rpcMetaDataProvider
ÔÔ 
.
ÔÔ 

SetAppInfo
ÔÔ &
(
ÔÔ& '
appInstanceId
ÔÔ' 4
,
ÔÔ4 5
deviceId
ÔÔ6 >
,
ÔÔ> ?
culture
ÔÔ@ G
)
ÔÔG H
;
ÔÔH I
}
ÕÕ 
public
×× 

void
×× 
ClearConnection
×× 
(
××  
uint
××  $
	connectId
××% .
)
××. /
{
ØØ 
if
ÙÙ 

(
ÙÙ 
!
ÙÙ 
_connections
ÙÙ 
.
ÙÙ 
	TryRemove
ÙÙ #
(
ÙÙ# $
	connectId
ÙÙ$ -
,
ÙÙ- .
out
ÙÙ/ 2$
EcliptixProtocolSystem
ÙÙ3 I
?
ÙÙI J
system
ÙÙK Q
)
ÙÙQ R
)
ÙÙR S
{
ÚÚ 	
return
ÛÛ 
;
ÛÛ 
}
ÜÜ 	
system
ÞÞ 
.
ÞÞ 
Dispose
ÞÞ 
(
ÞÞ 
)
ÞÞ 
;
ÞÞ 
}
ßß 
public
áá 

void
áá &
ClearExhaustedOperations
áá (
(
áá( )
)
áá) *
{
ââ 
retryStrategy
ãã 
.
ãã &
ClearExhaustedOperations
ãã .
(
ãã. /
)
ãã/ 0
;
ãã0 1
}
ää 
public
ææ 

bool
ææ 
HasConnection
ææ 
(
ææ 
uint
ææ "
	connectId
ææ# ,
)
ææ, -
=>
ææ. 0
_connections
ææ1 =
.
ææ= >
ContainsKey
ææ> I
(
ææI J
	connectId
ææJ S
)
ææS T
;
ææT U
public
èè 

async
èè 
Task
èè 
<
èè 
Result
èè 
<
èè 
Unit
èè !
,
èè! "
NetworkFailure
èè# 1
>
èè1 2
>
èè2 3&
ExecuteUnaryRequestAsync
èè4 L
(
èèL M
uint
éé 
	connectId
éé 
,
éé 
RpcServiceType
êê 
serviceType
êê "
,
êê" #
byte
ëë 
[
ëë 
]
ëë 
plainBuffer
ëë 
,
ëë 
Func
ìì 
<
ìì 
byte
ìì 
[
ìì 
]
ìì 
,
ìì 
Task
ìì 
<
ìì 
Result
ìì  
<
ìì  !
Unit
ìì! %
,
ìì% &
NetworkFailure
ìì' 5
>
ìì5 6
>
ìì6 7
>
ìì7 8
onCompleted
ìì9 D
,
ììD E
bool
íí 
allowDuplicates
íí 
=
íí 
false
íí $
,
íí$ %
CancellationToken
îî 
token
îî 
=
îî  !
default
îî" )
,
îî) *
bool
ïï 
waitForRecovery
ïï 
=
ïï 
true
ïï #
,
ïï# $
RpcRequestContext
ðð 
?
ðð 
requestContext
ðð )
=
ðð* +
null
ðð, 0
)
ðð0 1
{
ññ 
return
òò 
await
òò 0
"ExecuteServiceRequestInternalAsync
òò 7
(
òò7 8
	connectId
óó 
,
óó 
serviceType
óó "
,
óó" #
plainBuffer
óó$ /
,
óó/ 0
ServiceFlowType
óó1 @
.
óó@ A
Single
óóA G
,
óóG H
onCompleted
ôô 
,
ôô 
allowDuplicates
ôô (
,
ôô( )
token
ôô* /
,
ôô/ 0
waitForRecovery
ôô1 @
,
ôô@ A
requestContext
ôôB P
)
ôôP Q
.
ôôQ R
ConfigureAwait
ôôR `
(
ôô` a
false
ôôa f
)
ôôf g
;
ôôg h
}
õõ 
public
÷÷ 

async
÷÷ 
Task
÷÷ 
<
÷÷ 
Result
÷÷ 
<
÷÷ 
Unit
÷÷ !
,
÷÷! "
NetworkFailure
÷÷# 1
>
÷÷1 2
>
÷÷2 3.
 ExecuteReceiveStreamRequestAsync
÷÷4 T
(
÷÷T U
uint
øø 
	connectId
øø 
,
øø 
RpcServiceType
ùù 
serviceType
ùù "
,
ùù" #
byte
úú 
[
úú 
]
úú 
plainBuffer
úú 
,
úú 
Func
ûû 
<
ûû 
byte
ûû 
[
ûû 
]
ûû 
,
ûû 
Task
ûû 
<
ûû 
Result
ûû  
<
ûû  !
Unit
ûû! %
,
ûû% &
NetworkFailure
ûû' 5
>
ûû5 6
>
ûû6 7
>
ûû7 8
onStreamItem
ûû9 E
,
ûûE F
bool
üü 
allowDuplicates
üü 
=
üü 
false
üü $
,
üü$ %
CancellationToken
ýý 
token
ýý 
=
ýý  !
default
ýý" )
)
ýý) *
{
þþ 
return
ÿÿ 
await
ÿÿ 0
"ExecuteServiceRequestInternalAsync
ÿÿ 7
(
ÿÿ7 8
	connectId
€€ 
,
€€ 
serviceType
€€ "
,
€€" #
plainBuffer
€€$ /
,
€€/ 0
ServiceFlowType
€€1 @
.
€€@ A
ReceiveStream
€€A N
,
€€N O
onStreamItem
 
,
 
allowDuplicates
 )
,
) *
token
+ 0
)
0 1
.
1 2
ConfigureAwait
2 @
(
@ A
false
A F
)
F G
;
G H
}
‚‚ 
private
„„ 
async
„„ 
Task
„„ 
<
„„ 
Result
„„ 
<
„„ 
Unit
„„ "
,
„„" #
NetworkFailure
„„$ 2
>
„„2 3
>
„„3 40
"ExecuteServiceRequestInternalAsync
„„5 W
(
„„W X
uint
…… 
	connectId
…… 
,
…… 
RpcServiceType
†† 
serviceType
†† "
,
††" #
byte
‡‡ 
[
‡‡ 
]
‡‡ 
plainBuffer
‡‡ 
,
‡‡ 
ServiceFlowType
ˆˆ 
flowType
ˆˆ  
,
ˆˆ  !
Func
‰‰ 
<
‰‰ 
byte
‰‰ 
[
‰‰ 
]
‰‰ 
,
‰‰ 
Task
‰‰ 
<
‰‰ 
Result
‰‰  
<
‰‰  !
Unit
‰‰! %
,
‰‰% &
NetworkFailure
‰‰' 5
>
‰‰5 6
>
‰‰6 7
>
‰‰7 8
onCompleted
‰‰9 D
,
‰‰D E
bool
ŠŠ $
allowDuplicateRequests
ŠŠ #
=
ŠŠ$ %
false
ŠŠ& +
,
ŠŠ+ ,
CancellationToken
‹‹ 
cancellationToken
‹‹ +
=
‹‹, -
default
‹‹. 5
,
‹‹5 6
bool
ŒŒ 
waitForRecovery
ŒŒ 
=
ŒŒ 
true
ŒŒ #
,
ŒŒ# $
RpcRequestContext
 
?
 
requestContext
 )
=
* +
null
, 0
)
0 1
{
ŽŽ 
RpcRequestContext
 
effectiveContext
 *
=
+ ,
requestContext
- ;
??
< >
RpcRequestContext
? P
.
P Q
	CreateNew
Q Z
(
Z [
)
[ \
;
\ ]
RetryBehavior
 
retryBehavior
 #
=
$ %!
retryPolicyProvider
& 9
.
9 :
GetRetryBehavior
: J
(
J K
serviceType
K V
)
V W
;
W X
string
’’ 

requestKey
’’ 
;
’’ 
if
““ 

(
““ 
serviceType
““ 
is
““ 
RpcServiceType
““ )
.
““) *
SignInInitRequest
““* ;
or
““< >
RpcServiceType
““? M
.
““M N#
SignInCompleteRequest
““N c
)
““c d
{
”” 	

requestKey
•• 
=
•• 
$"
•• 
{
•• 
	connectId
•• %
}
••% &
$str
••& '
{
••' (
serviceType
••( 3
}
••3 4
$str
••4 C
"
••C D
;
••D E
}
–– 	
else
—— 
{
˜˜ 	
int
™™ 
bytesToHash
™™ 
=
™™ 
Math
™™ "
.
™™" #
Min
™™# &
(
™™& '
plainBuffer
™™' 2
.
™™2 3
Length
™™3 9
,
™™9 :
NetworkConstants
™™; K
.
™™K L
Protocol
™™L T
.
™™T U+
REQUEST_KEY_HEX_PREFIX_LENGTH
™™U r
/
™™s t
$num
™™u v
)
™™v w
;
™™w x
Span
šš 
<
šš 
char
šš 
>
šš 
	hexBuffer
šš  
=
šš! "

stackalloc
šš# -
char
šš. 2
[
šš2 3
NetworkConstants
šš3 C
.
ššC D
Protocol
ššD L
.
ššL M+
REQUEST_KEY_HEX_PREFIX_LENGTH
ššM j
]
ššj k
;
ššk l
bool
›› 
success
›› 
=
›› 
Convert
›› "
.
››" #
TryToHexString
››# 1
(
››1 2
plainBuffer
››2 =
.
››= >
AsSpan
››> D
(
››D E
$num
››E F
,
››F G
bytesToHash
››H S
)
››S T
,
››T U
	hexBuffer
››V _
,
››_ `
out
››a d
int
››e h
charsWritten
››i u
)
››u v
;
››v w

requestKey
œœ 
=
œœ 
success
œœ  
?
 
$"
 
{
 
	connectId
 
}
 
$str
  
{
  !
serviceType
! ,
}
, -
$str
- .
{
. /
	hexBuffer
/ 8
[
8 9
..
9 ;
charsWritten
; G
]
G H
.
H I
ToString
I Q
(
Q R
)
R S
}
S T
"
T U
:
žž 
$"
žž 
{
žž 
	connectId
žž 
}
žž 
$str
žž  
{
žž  !
serviceType
žž! ,
}
žž, -
$str
žž- 6
"
žž6 7
;
žž7 8
}
ŸŸ 	
bool
¡¡ #
shouldAllowDuplicates
¡¡ "
=
¡¡# $$
allowDuplicateRequests
¡¡% ;
||
¡¡< >(
CanServiceTypeBeDuplicated
¡¡? Y
(
¡¡Y Z
serviceType
¡¡Z e
)
¡¡e f
;
¡¡f g%
CancellationTokenSource
¢¢ %
cancellationTokenSource
¢¢  7
=
¢¢8 9
new
¢¢: =
(
¢¢= >
)
¢¢> ?
;
¢¢? @
if
££ 

(
££ 
!
££ #
shouldAllowDuplicates
££ "
&&
££# %
!
££& '
_pendingRequests
££' 7
.
££7 8
TryAdd
££8 >
(
££> ?

requestKey
££? I
,
££I J%
cancellationTokenSource
££K b
)
££b c
)
££c d
{
¤¤ 	%
cancellationTokenSource
¥¥ #
.
¥¥# $
Dispose
¥¥$ +
(
¥¥+ ,
)
¥¥, -
;
¥¥- .
return
¦¦ 
Result
¦¦ 
<
¦¦ 
Unit
¦¦ 
,
¦¦ 
NetworkFailure
¦¦  .
>
¦¦. /
.
¦¦/ 0
Err
¦¦0 3
(
¦¦3 4
NetworkFailure
§§ 
.
§§  
InvalidRequestType
§§ 1
(
§§1 2
$str
§§2 N
)
§§N O
)
§§O P
;
§§P Q
}
¨¨ 	+
CancellationTokenRegistration
ªª %
tokenRegistration
ªª& 7
=
ªª8 9
default
ªª: A
;
ªªA B
if
«« 

(
«« 
cancellationToken
«« 
.
«« 
CanBeCanceled
«« +
)
««+ ,
{
¬¬ 	
tokenRegistration
­­ 
=
­­ 
cancellationToken
­­  1
.
­­1 2
Register
­­2 :
(
­­: ;
(
­­; <
)
­­< =
=>
­­> @
{
®® 
try
¯¯ 
{
°° 
if
±± 
(
±± 
!
±± %
cancellationTokenSource
±± 0
.
±±0 1%
IsCancellationRequested
±±1 H
)
±±H I
{
²² %
cancellationTokenSource
³³ /
.
³³/ 0
Cancel
³³0 6
(
³³6 7
)
³³7 8
;
³³8 9
}
´´ 
}
µµ 
catch
¶¶ 
(
¶¶ %
ObjectDisposedException
¶¶ .
)
¶¶. /
{
·· 
}
¹¹ 
}
ºº 
)
ºº 
;
ºº 
}
»» 	%
CancellationTokenSource
½½ +
linkedCancellationTokenSource
½½  =
=
½½> ?%
CancellationTokenSource
¾¾ #
.
¾¾# $%
CreateLinkedTokenSource
¾¾$ ;
(
¾¾; <
cancellationToken
¾¾< M
,
¾¾M N%
cancellationTokenSource
¾¾O f
.
¾¾f g
Token
¾¾g l
)
¾¾l m
;
¾¾m n
CancellationToken
¿¿ 
operationToken
¿¿ (
=
¿¿) *+
linkedCancellationTokenSource
¿¿+ H
.
¿¿H I
Token
¿¿I N
;
¿¿N O
bool
ÁÁ  
disposedRequestCts
ÁÁ 
=
ÁÁ  !
false
ÁÁ" '
;
ÁÁ' (
try
ÂÂ 
{
ÃÃ 	
await
ÄÄ (
WaitForOutageRecoveryAsync
ÄÄ ,
(
ÄÄ, -
operationToken
ÄÄ- ;
,
ÄÄ; <
waitForRecovery
ÄÄ= L
)
ÄÄL M
.
ÄÄM N
ConfigureAwait
ÄÄN \
(
ÄÄ\ ]
false
ÄÄ] b
)
ÄÄb c
;
ÄÄc d
operationToken
ÆÆ 
.
ÆÆ *
ThrowIfCancellationRequested
ÆÆ 7
(
ÆÆ7 8
)
ÆÆ8 9
;
ÆÆ9 :
if
ÈÈ 
(
ÈÈ 
!
ÈÈ 
_connections
ÈÈ 
.
ÈÈ 
TryGetValue
ÈÈ )
(
ÈÈ) *
	connectId
ÈÈ* 3
,
ÈÈ3 4
out
ÈÈ5 8$
EcliptixProtocolSystem
ÈÈ9 O
?
ÈÈO P
protocolSystem
ÈÈQ _
)
ÈÈ_ `
)
ÈÈ` a
{
ÉÉ 
NetworkFailure
ÊÊ !
noConnectionFailure
ÊÊ 2
=
ÊÊ3 4
NetworkFailure
ÊÊ5 C
.
ÊÊC D%
DataCenterNotResponding
ÊÊD [
(
ÊÊ[ \
$str
ËË G
)
ËËG H
;
ËËH I
_
ÌÌ 
=
ÌÌ !
connectivityService
ÌÌ '
.
ÌÌ' (
PublishAsync
ÌÌ( 4
(
ÌÌ4 5 
ConnectivityIntent
ÍÍ &
.
ÍÍ& '
ServerShutdown
ÍÍ' 5
(
ÍÍ5 6!
noConnectionFailure
ÍÍ6 I
)
ÍÍI J
)
ÍÍJ K
.
ÍÍK L
ContinueWith
ÍÍL X
(
ÍÍX Y
task
ÎÎ 
=>
ÎÎ 
{
ÏÏ 
if
ÐÐ 
(
ÐÐ 
task
ÐÐ  
.
ÐÐ  !
	IsFaulted
ÐÐ! *
&&
ÐÐ+ -
task
ÐÐ. 2
.
ÐÐ2 3
	Exception
ÐÐ3 <
!=
ÐÐ= ?
null
ÐÐ@ D
)
ÐÐD E
{
ÑÑ 
Log
ÒÒ 
.
ÒÒ  
Error
ÒÒ  %
(
ÒÒ% &
task
ÒÒ& *
.
ÒÒ* +
	Exception
ÒÒ+ 4
,
ÒÒ4 5
$str
ÒÒ6 
)ÒÒ €
;ÒÒ€ 
}
ÓÓ 
}
ÔÔ 
,
ÔÔ 
TaskScheduler
ÕÕ !
.
ÕÕ! "
Default
ÕÕ" )
)
ÕÕ) *
;
ÕÕ* +
return
ÖÖ 
Result
ÖÖ 
<
ÖÖ 
Unit
ÖÖ "
,
ÖÖ" #
NetworkFailure
ÖÖ$ 2
>
ÖÖ2 3
.
ÖÖ3 4
Err
ÖÖ4 7
(
ÖÖ7 8!
noConnectionFailure
ÖÖ8 K
)
ÖÖK L
;
ÖÖL M
}
×× 
uint
ÙÙ  
logicalOperationId
ÙÙ #
=
ÙÙ$ %(
GenerateLogicalOperationId
ÙÙ& @
(
ÙÙ@ A
	connectId
ÙÙA J
,
ÙÙJ K
serviceType
ÙÙL W
,
ÙÙW X
plainBuffer
ÙÙY d
)
ÙÙd e
;
ÙÙe f
try
ÛÛ 
{
ÜÜ 
Result
ÝÝ 
<
ÝÝ 
Unit
ÝÝ 
,
ÝÝ 
NetworkFailure
ÝÝ +
>
ÝÝ+ ,
networkResult
ÝÝ- :
=
ÝÝ; <
flowType
ÝÝ= E
switch
ÝÝF L
{
ÞÞ 
ServiceFlowType
ßß #
.
ßß# $
Single
ßß$ *
=>
ßß+ -
await
ßß. 3#
SendUnaryRequestAsync
ßß4 I
(
ßßI J
protocolSystem
ßßJ X
,
ßßX Y 
logicalOperationId
ßßZ l
,
ßßl m
serviceType
àà '
,
àà' (
plainBuffer
àà) 4
,
àà4 5
flowType
àà6 >
,
àà> ?
onCompleted
àà@ K
,
ààK L
	connectId
ààM V
,
ààV W
retryBehavior
ààX e
,
ààe f
operationToken
ààg u
)
ààu v
.
áá 
ConfigureAwait
áá '
(
áá' (
false
áá( -
)
áá- .
,
áá. /
ServiceFlowType
ââ #
.
ââ# $
ReceiveStream
ââ$ 1
=>
ââ2 4
await
ââ5 :+
SendReceiveStreamRequestAsync
ââ; X
(
ââX Y
protocolSystem
ââY g
,
ââg h 
logicalOperationId
ãã *
,
ãã* +
serviceType
ää #
,
ää# $
plainBuffer
ää% 0
,
ää0 1
flowType
ää2 :
,
ää: ;
effectiveContext
ää< L
,
ääL M
onCompleted
ääN Y
,
ääY Z
retryBehavior
ää[ h
,
ääh i
	connectId
ääj s
,
ääs t
operationToken
åå &
)
åå& '
.
åå' (
ConfigureAwait
åå( 6
(
åå6 7
false
åå7 <
)
åå< =
,
åå= >
ServiceFlowType
ææ #
.
ææ# $

SendStream
ææ$ .
=>
ææ/ 1
await
ææ2 7(
SendSendStreamRequestAsync
ææ8 R
(
ææR S
protocolSystem
ææS a
,
ææa b 
logicalOperationId
ææc u
,
ææu v
serviceType
çç '
,
çç' (
plainBuffer
çç) 4
,
çç4 5
flowType
çç6 >
,
çç> ?
effectiveContext
çç@ P
,
ççP Q
operationToken
ççR `
)
çç` a
.
èè 
ConfigureAwait
èè '
(
èè' (
false
èè( -
)
èè- .
,
èè. /
ServiceFlowType
éé #
.
éé# $!
BidirectionalStream
éé$ 7
=>
éé8 :
await
éé; @1
#SendBidirectionalStreamRequestAsync
ééA d
(
ééd e
protocolSystem
éée s
,
éés t 
logicalOperationId
êê .
,
êê. /
serviceType
êê0 ;
,
êê; <
plainBuffer
êê= H
,
êêH I
flowType
êêJ R
,
êêR S
effectiveContext
êêT d
,
êêd e
operationToken
êêf t
)
êêt u
.
ëë 
ConfigureAwait
ëë '
(
ëë' (
false
ëë( -
)
ëë- .
,
ëë. /
_
ìì 
=>
ìì 
Result
ìì 
<
ìì  
Unit
ìì  $
,
ìì$ %
NetworkFailure
ìì& 4
>
ìì4 5
.
ìì5 6
Err
ìì6 9
(
ìì9 :
NetworkFailure
íí &
.
íí& ' 
InvalidRequestType
íí' 9
(
íí9 :
$"
íí: <
$str
íí< S
{
ííS T
flowType
ííT \
}
íí\ ]
"
íí] ^
)
íí^ _
)
íí_ `
}
îî 
;
îî 
if
ðð 
(
ðð 
networkResult
ðð !
.
ðð! "
IsOk
ðð" &
&&
ðð' )
Volatile
ðð* 2
.
ðð2 3
Read
ðð3 7
(
ðð7 8
ref
ðð8 ;
_outageState
ðð< H
)
ððH I
==
ððJ L
$num
ððM N
)
ððN O
{
ññ 

ExitOutage
òò 
(
òò 
)
òò  
;
òò  !
}
óó 
return
õõ 
networkResult
õõ $
;
õõ$ %
}
öö 
catch
÷÷ 
(
÷÷ (
OperationCanceledException
÷÷ -
)
÷÷- .
when
÷÷/ 3
(
÷÷4 5
cancellationToken
÷÷5 F
.
÷÷F G%
IsCancellationRequested
÷÷G ^
)
÷÷^ _
{
øø 
return
ùù 
Result
ùù 
<
ùù 
Unit
ùù "
,
ùù" #
NetworkFailure
ùù$ 2
>
ùù2 3
.
ùù3 4
Err
ùù4 7
(
ùù7 8
NetworkFailure
úú "
.
úú" # 
OperationCancelled
úú# 5
(
úú5 6
$str
úú6 S
)
úúS T
)
úúT U
;
úúU V
}
ûû 
catch
üü 
(
üü (
OperationCanceledException
üü -
)
üü- .
when
üü/ 3
(
üü4 5
flowType
üü5 =
==
üü> @
ServiceFlowType
üüA P
.
üüP Q
ReceiveStream
üüQ ^
)
üü^ _
{
ýý 
return
þþ 
Result
þþ 
<
þþ 
Unit
þþ "
,
þþ" #
NetworkFailure
þþ$ 2
>
þþ2 3
.
þþ3 4
Ok
þþ4 6
(
þþ6 7
Unit
þþ7 ;
.
þþ; <
Value
þþ< A
)
þþA B
;
þþB C
}
ÿÿ 
catch
€€ 
(
€€ (
OperationCanceledException
€€ -
)
€€- .
{
 
return
‚‚ 
Result
‚‚ 
<
‚‚ 
Unit
‚‚ "
,
‚‚" #
NetworkFailure
‚‚$ 2
>
‚‚2 3
.
‚‚3 4
Err
‚‚4 7
(
‚‚7 8
NetworkFailure
ƒƒ "
.
ƒƒ" #%
DataCenterNotResponding
ƒƒ# :
(
ƒƒ: ;
$str
„„ X
)
„„X Y
)
„„Y Z
;
„„Z [
}
…… 
catch
†† 
(
†† 
	Exception
†† 
ex
†† 
)
††  
{
‡‡ 
return
ŠŠ 
Result
ŠŠ 
<
ŠŠ 
Unit
ŠŠ "
,
ŠŠ" #
NetworkFailure
ŠŠ$ 2
>
ŠŠ2 3
.
ŠŠ3 4
Err
ŠŠ4 7
(
ŠŠ7 8
NetworkFailure
ŠŠ8 F
.
ŠŠF G%
DataCenterNotResponding
ŠŠG ^
(
ŠŠ^ _
ex
ŠŠ_ a
.
ŠŠa b
Message
ŠŠb i
)
ŠŠi j
)
ŠŠj k
;
ŠŠk l
}
‹‹ 
}
ŒŒ 	
finally
 
{
ŽŽ 	
tokenRegistration
 
.
 
Dispose
 %
(
% &
)
& '
;
' (
if
‘‘ 
(
‘‘ 
!
‘‘ #
shouldAllowDuplicates
‘‘ &
&&
‘‘' )
_pendingRequests
’’  
.
’’  !
	TryRemove
’’! *
(
’’* +

requestKey
’’+ 5
,
’’5 6
out
’’7 :%
CancellationTokenSource
’’; R
?
’’R S!
pendingCancellation
’’T g
)
’’g h
)
’’h i
{
““ !
pendingCancellation
”” #
.
””# $
Dispose
””$ +
(
””+ ,
)
””, -
;
””- . 
disposedRequestCts
•• "
=
••# $
true
••% )
;
••) *
}
–– +
linkedCancellationTokenSource
˜˜ )
.
˜˜) *
Dispose
˜˜* 1
(
˜˜1 2
)
˜˜2 3
;
˜˜3 4
if
šš 
(
šš 
!
šš  
disposedRequestCts
šš #
)
šš# $
{
›› %
cancellationTokenSource
œœ '
.
œœ' (
Dispose
œœ( /
(
œœ/ 0
)
œœ0 1
;
œœ1 2
}
 
}
žž 	
}
ŸŸ 
private
¡¡ 
async
¡¡ 
Task
¡¡ /
!RetryPendingRequestsAfterRecovery
¡¡ 8
(
¡¡8 9
)
¡¡9 :
{
¢¢ 
bool
££ 
acquired
££ 
=
££ 
false
££ 
;
££ 
try
¤¤ 
{
¥¥ 	
await
¦¦ '
_retryPendingRequestsGate
¦¦ +
.
¦¦+ ,
	WaitAsync
¦¦, 5
(
¦¦5 6(
_shutdownCancellationToken
¦¦6 P
.
¦¦P Q
Token
¦¦Q V
)
¦¦V W
.
¦¦W X
ConfigureAwait
¦¦X f
(
¦¦f g
false
¦¦g l
)
¦¦l m
;
¦¦m n
acquired
§§ 
=
§§ 
true
§§ 
;
§§ 
await
¨¨ #
pendingRequestManager
¨¨ '
.
¨¨' (*
RetryAllPendingRequestsAsync
¨¨( D
(
¨¨D E
)
¨¨E F
.
¨¨F G
ConfigureAwait
¨¨G U
(
¨¨U V
false
¨¨V [
)
¨¨[ \
;
¨¨\ ]
}
©© 	
catch
ªª 
(
ªª (
OperationCanceledException
ªª )
)
ªª) *
when
ªª+ /
(
ªª0 1(
_shutdownCancellationToken
ªª1 K
.
ªªK L%
IsCancellationRequested
ªªL c
)
ªªc d
{
«« 	
}
¬¬ 	
finally
­­ 
{
®® 	
if
¯¯ 
(
¯¯ 
acquired
¯¯ 
)
¯¯ 
{
°° '
_retryPendingRequestsGate
±± )
.
±±) *
Release
±±* 1
(
±±1 2
)
±±2 3
;
±±3 4
}
²² 
}
³³ 	
}
´´ 
public
¶¶ 

enum
¶¶ 
RestoreRetryMode
¶¶  
{
·· 
	AutoRetry
¸¸ 
,
¸¸ 
ManualRetry
¹¹ 
,
¹¹ 
DirectNoRetry
ºº 
}
»» 
public
½½ 

async
½½ 
Task
½½ 
<
½½ 
Result
½½ 
<
½½ 
bool
½½ !
,
½½! "
NetworkFailure
½½# 1
>
½½1 2
>
½½2 3(
RestoreSecrecyChannelAsync
½½4 N
(
½½N O"
EcliptixSessionState
¾¾ )
ecliptixSecrecyChannelState
¾¾ 8
,
¾¾8 9)
ApplicationInstanceSettings
¿¿ #)
applicationInstanceSettings
¿¿$ ?
,
¿¿? @
RestoreRetryMode
ÀÀ 
	retryMode
ÀÀ "
=
ÀÀ# $
RestoreRetryMode
ÀÀ% 5
.
ÀÀ5 6
	AutoRetry
ÀÀ6 ?
,
ÀÀ? @
bool
ÁÁ '
enablePendingRegistration
ÁÁ &
=
ÁÁ' (
true
ÁÁ) -
,
ÁÁ- .
CancellationToken
ÂÂ 
cancellationToken
ÂÂ +
=
ÂÂ, -
default
ÂÂ. 5
)
ÂÂ5 6
{
ÃÃ 
if
ÄÄ 

(
ÄÄ 
!
ÄÄ *
_applicationInstanceSettings
ÄÄ )
.
ÄÄ) *
IsSome
ÄÄ* 0
)
ÄÄ0 1
{
ÅÅ 	*
_applicationInstanceSettings
ÆÆ (
=
ÆÆ) *
Option
ÆÆ+ 1
<
ÆÆ1 2)
ApplicationInstanceSettings
ÆÆ2 M
>
ÆÆM N
.
ÆÆN O
Some
ÆÆO S
(
ÆÆS T)
applicationInstanceSettings
ÆÆT o
)
ÆÆo p
;
ÆÆp q
}
ÇÇ 	
string
ÉÉ 
?
ÉÉ 
culture
ÉÉ 
=
ÉÉ 
string
ÉÉ  
.
ÉÉ  !
IsNullOrEmpty
ÉÉ! .
(
ÉÉ. /)
applicationInstanceSettings
ÉÉ/ J
.
ÉÉJ K
Culture
ÉÉK R
)
ÉÉR S
?
ÊÊ )
AppCultureSettingsConstants
ÊÊ )
.
ÊÊ) *"
DEFAULT_CULTURE_CODE
ÊÊ* >
:
ËË )
applicationInstanceSettings
ËË )
.
ËË) *
Culture
ËË* 1
;
ËË1 2!
rpcMetaDataProvider
ÍÍ 
.
ÍÍ 

SetAppInfo
ÍÍ &
(
ÍÍ& '
Helpers
ÎÎ 
.
ÎÎ "
FromByteStringToGuid
ÎÎ (
(
ÎÎ( ))
applicationInstanceSettings
ÎÎ) D
.
ÎÎD E
AppInstanceId
ÎÎE R
)
ÎÎR S
,
ÎÎS T
Helpers
ÏÏ 
.
ÏÏ "
FromByteStringToGuid
ÏÏ (
(
ÏÏ( ))
applicationInstanceSettings
ÏÏ) D
.
ÏÏD E
DeviceId
ÏÏE M
)
ÏÏM N
,
ÏÏN O
culture
ÐÐ 
)
ÐÐ 
;
ÐÐ #
RestoreChannelRequest
ÒÒ 
request
ÒÒ %
=
ÒÒ& '
new
ÒÒ( +
(
ÒÒ+ ,
)
ÒÒ, -
;
ÒÒ- .
Result
ÔÔ 
<
ÔÔ $
RestoreChannelResponse
ÔÔ %
,
ÔÔ% &
NetworkFailure
ÔÔ' 5
>
ÔÔ5 64
&restoreAppDeviceSecrecyChannelResponse
ÔÔ7 ]
;
ÔÔ] ^
switch
ÖÖ 
(
ÖÖ 
	retryMode
ÖÖ 
)
ÖÖ 
{
×× 	
case
ØØ 
RestoreRetryMode
ØØ !
.
ØØ! "
	AutoRetry
ØØ" +
:
ØØ+ ,
{
ÙÙ 2
$BeginSecrecyChannelEstablishRecovery
ÚÚ 8
(
ÚÚ8 9
)
ÚÚ9 :
;
ÚÚ: ;
CancellationToken
ÛÛ %
recoveryToken
ÛÛ& 3
=
ÛÛ4 5(
GetConnectionRecoveryToken
ÛÛ6 P
(
ÛÛP Q
)
ÛÛQ R
;
ÛÛR S
using
ÜÜ %
CancellationTokenSource
ÜÜ 1-
combinedCancellationTokenSource
ÜÜ2 Q
=
ÜÜR S
cancellationToken
ÝÝ )
.
ÝÝ) *
CanBeCanceled
ÝÝ* 7
?
ÞÞ %
CancellationTokenSource
ÞÞ 5
.
ÞÞ5 6%
CreateLinkedTokenSource
ÞÞ6 M
(
ÞÞM N
recoveryToken
ÞÞN [
,
ÞÞ[ \
cancellationToken
ÞÞ] n
)
ÞÞn o
:
ßß %
CancellationTokenSource
ßß 5
.
ßß5 6%
CreateLinkedTokenSource
ßß6 M
(
ßßM N
recoveryToken
ßßN [
)
ßß[ \
;
ßß\ ]4
&restoreAppDeviceSecrecyChannelResponse
áá :
=
áá; <
await
áá= B
retryStrategy
ááC P
.
ááP Q&
ExecuteRpcOperationAsync
ááQ i
(
áái j
(
ââ 
_
ââ 
,
ââ 
ct
ââ 
)
ââ 
=>
ââ  "
rpcServiceManager
ââ# 4
.
ââ4 5(
RestoreSecrecyChannelAsync
ââ5 O
(
ââO P!
connectivityService
ââP c
,
ââc d
request
ãã #
,
ãã# $
cancellationToken
ää -
:
ää- .
ct
ää/ 1
)
ää1 2
,
ää2 3
$str
åå /
,
åå/ 0)
ecliptixSecrecyChannelState
ææ 3
.
ææ3 4
	ConnectId
ææ4 =
,
ææ= >
serviceType
çç #
:
çç# $
RpcServiceType
çç% 3
.
çç3 4#
RestoreSecrecyChannel
çç4 I
,
ççI J
cancellationToken
èè )
:
èè) *-
combinedCancellationTokenSource
èè+ J
.
èèJ K
Token
èèK P
)
èèP Q
.
èèQ R
ConfigureAwait
èèR `
(
èè` a
false
èèa f
)
èèf g
;
èèg h
break
éé 
;
éé 
}
êê 
case
ëë 
RestoreRetryMode
ëë !
.
ëë! "
ManualRetry
ëë" -
:
ëë- .
{
ìì 2
$BeginSecrecyChannelEstablishRecovery
íí 8
(
íí8 9
)
íí9 :
;
íí: ;
CancellationToken
îî %
recoveryToken
îî& 3
=
îî4 5(
GetConnectionRecoveryToken
îî6 P
(
îîP Q
)
îîQ R
;
îîR S
using
ïï %
CancellationTokenSource
ïï 1
combinedCts
ïï2 =
=
ïï> ?
cancellationToken
ðð )
.
ðð) *
CanBeCanceled
ðð* 7
?
ññ %
CancellationTokenSource
ññ 5
.
ññ5 6%
CreateLinkedTokenSource
ññ6 M
(
ññM N
recoveryToken
ññN [
,
ññ[ \
cancellationToken
ññ] n
)
ññn o
:
òò %
CancellationTokenSource
òò 5
.
òò5 6%
CreateLinkedTokenSource
òò6 M
(
òòM N
recoveryToken
òòN [
)
òò[ \
;
òò\ ]4
&restoreAppDeviceSecrecyChannelResponse
ôô :
=
ôô; <
await
ôô= B
retryStrategy
ôôC P
.
ôôP Q1
#ExecuteManualRetryRpcOperationAsync
ôôQ t
(
ôôt u
(
õõ 
_
õõ 
,
õõ 
ct
õõ 
)
õõ 
=>
õõ  "
rpcServiceManager
õõ# 4
.
õõ4 5(
RestoreSecrecyChannelAsync
õõ5 O
(
õõO P!
connectivityService
õõP c
,
õõc d
request
öö #
,
öö# $
cancellationToken
÷÷ -
:
÷÷- .
ct
÷÷/ 1
)
÷÷1 2
,
÷÷2 3
$str
øø /
,
øø/ 0)
ecliptixSecrecyChannelState
ùù 3
.
ùù3 4
	ConnectId
ùù4 =
,
ùù= >
cancellationToken
úú )
:
úú) *
combinedCts
úú+ 6
.
úú6 7
Token
úú7 <
)
úú< =
.
úú= >
ConfigureAwait
úú> L
(
úúL M
false
úúM R
)
úúR S
;
úúS T
break
ûû 
;
ûû 
}
üü 
case
ýý 
RestoreRetryMode
ýý !
.
ýý! "
DirectNoRetry
ýý" /
:
ýý/ 0
try
þþ 
{
ÿÿ 4
&restoreAppDeviceSecrecyChannelResponse
€€ :
=
€€; <
await
 
rpcServiceManager
 /
.
/ 0(
RestoreSecrecyChannelAsync
0 J
(
J K!
connectivityService
K ^
,
^ _
request
‚‚ #
,
‚‚# $
cancellationToken
ƒƒ -
:
ƒƒ- .
cancellationToken
ƒƒ/ @
)
ƒƒ@ A
.
ƒƒA B
ConfigureAwait
ƒƒB P
(
ƒƒP Q
false
ƒƒQ V
)
ƒƒV W
;
ƒƒW X
}
„„ 
catch
…… 
(
…… 
	Exception
……  
ex
……! #
)
……# $
{
†† 
return
‡‡ 
Result
‡‡ !
<
‡‡! "
bool
‡‡" &
,
‡‡& '
NetworkFailure
‡‡( 6
>
‡‡6 7
.
‡‡7 8
Err
‡‡8 ;
(
‡‡; <
NetworkFailure
‡‡< J
.
‡‡J K%
DataCenterNotResponding
‡‡K b
(
‡‡b c
ex
‡‡c e
.
‡‡e f
Message
‡‡f m
)
‡‡m n
)
‡‡n o
;
‡‡o p
}
ˆˆ 
break
ŠŠ 
;
ŠŠ 
default
‹‹ 
:
‹‹ 
return
ŒŒ 
Result
ŒŒ 
<
ŒŒ 
bool
ŒŒ "
,
ŒŒ" #
NetworkFailure
ŒŒ$ 2
>
ŒŒ2 3
.
ŒŒ3 4
Err
ŒŒ4 7
(
ŒŒ7 8
NetworkFailure
 "
.
" # 
InvalidRequestType
# 5
(
5 6
$"
6 8
$str
8 L
{
L M
	retryMode
M V
}
V W
"
W X
)
X Y
)
Y Z
;
Z [
}
ŽŽ 	
if
 

(
 4
&restoreAppDeviceSecrecyChannelResponse
 2
.
2 3
IsErr
3 8
)
8 9
{
‘‘ 	
NetworkFailure
’’ 
failure
’’ "
=
’’# $4
&restoreAppDeviceSecrecyChannelResponse
’’% K
.
’’K L
	UnwrapErr
’’L U
(
’’U V
)
’’V W
;
’’W X
if
”” 
(
”” '
enablePendingRegistration
”” )
&&
””* ,,
ShouldQueueSecrecyChannelRetry
””- K
(
””K L
failure
””L S
)
””S T
)
””T U
{
•• -
QueueSecrecyChannelRestoreRetry
–– /
(
––/ 0)
ecliptixSecrecyChannelState
––0 K
,
––K L)
applicationInstanceSettings
––M h
,
––h i
	retryMode
––j s
)
––s t
;
––t u
}
—— 
return
™™ 
Result
™™ 
<
™™ 
bool
™™ 
,
™™ 
NetworkFailure
™™  .
>
™™. /
.
™™/ 0
Err
™™0 3
(
™™3 4
failure
™™4 ;
)
™™; <
;
™™< =
}
šš 	$
RestoreChannelResponse
œœ 
response
œœ '
=
œœ( )4
&restoreAppDeviceSecrecyChannelResponse
œœ* P
.
œœP Q
Unwrap
œœQ W
(
œœW X
)
œœX Y
;
œœY Z
switch
žž 
(
žž 
response
žž 
.
žž 
Status
žž 
)
žž  
{
ŸŸ 	
case
   $
RestoreChannelResponse
   '
.
  ' (
Types
  ( -
.
  - .
Status
  . 4
.
  4 5
SessionRestored
  5 D
:
  D E
{
¡¡ 
Result
¢¢ 
<
¢¢ 
Unit
¢¢ 
,
¢¢  %
EcliptixProtocolFailure
¢¢! 8
>
¢¢8 9

syncResult
££ "
=
££# $ 
SyncSecrecyChannel
££% 7
(
££7 8)
ecliptixSecrecyChannelState
££8 S
,
££S T
response
££U ]
)
££] ^
;
££^ _
if
¥¥ 
(
¥¥ 

syncResult
¥¥ "
.
¥¥" #
IsErr
¥¥# (
)
¥¥( )
{
¦¦ %
EcliptixProtocolFailure
§§ /
error
§§0 5
=
§§6 7

syncResult
§§8 B
.
§§B C
	UnwrapErr
§§C L
(
§§L M
)
§§M N
;
§§N O
return
¨¨ 
error
¨¨ $
.
¨¨$ %
Message
¨¨% ,
.
¨¨, -
Contains
¨¨- 5
(
¨¨5 6
$str
¨¨6 Q
)
¨¨Q R
?
©© 
Result
©© $
<
©©$ %
bool
©©% )
,
©©) *
NetworkFailure
©©+ 9
>
©©9 :
.
©©: ;
Ok
©©; =
(
©©= >
false
©©> C
)
©©C D
:
ªª 
Result
ªª $
<
ªª$ %
bool
ªª% )
,
ªª) *
NetworkFailure
ªª+ 9
>
ªª9 :
.
ªª: ;
Err
ªª; >
(
ªª> ?
error
ªª? D
.
ªªD E
ToNetworkFailure
ªªE U
(
ªªU V
)
ªªV W
)
ªªW X
;
ªªX Y
}
«« 
if
­­ 
(
­­ '
enablePendingRegistration
­­ 1
)
­­1 2
{
®® #
pendingRequestManager
¯¯ -
.
¯¯- ."
RemovePendingRequest
¯¯. B
(
¯¯B C+
BuildSecrecyChannelRestoreKey
°° 9
(
°°9 :)
ecliptixSecrecyChannelState
°°: U
.
°°U V
	ConnectId
°°V _
)
°°_ `
)
°°` a
;
°°a b
}
±± 

ExitOutage
³³ 
(
³³ 
)
³³  
;
³³  !
return
µµ 
Result
µµ !
<
µµ! "
bool
µµ" &
,
µµ& '
NetworkFailure
µµ( 6
>
µµ6 7
.
µµ7 8
Ok
µµ8 :
(
µµ: ;
true
µµ; ?
)
µµ? @
;
µµ@ A
}
¶¶ 
case
·· $
RestoreChannelResponse
·· '
.
··' (
Types
··( -
.
··- .
Status
··. 4
.
··4 5
SessionNotFound
··5 D
:
··D E
{
¸¸ 
Result
¹¹ 
<
¹¹ "
EcliptixSessionState
¹¹ /
,
¹¹/ 0
NetworkFailure
¹¹1 ?
>
¹¹? @
establishResult
¹¹A P
=
¹¹Q R
await
ºº *
EstablishSecrecyChannelAsync
ºº :
(
ºº: ;)
ecliptixSecrecyChannelState
ºº; V
.
ººV W
	ConnectId
ººW `
)
ºº` a
;
ººa b
if
»» 
(
»» 
establishResult
»» '
.
»»' (
IsErr
»»( -
)
»»- .
{
¼¼ 
Log
½½ 
.
½½ 
Warning
½½ #
(
½½# $
$str
½½$ }
,
½½} ~
establishResult
¾¾ +
.
¾¾+ ,
	UnwrapErr
¾¾, 5
(
¾¾5 6
)
¾¾6 7
.
¾¾7 8
Message
¾¾8 ?
)
¾¾? @
;
¾¾@ A
}
¿¿ 
break
ÀÀ 
;
ÀÀ 
}
ÁÁ 
default
ÂÂ 
:
ÂÂ 
throw
ÃÃ 
new
ÃÃ )
ArgumentOutOfRangeException
ÃÃ 5
(
ÃÃ5 6
)
ÃÃ6 7
;
ÃÃ7 8
}
ÄÄ 	
return
ÆÆ 
Result
ÆÆ 
<
ÆÆ 
bool
ÆÆ 
,
ÆÆ 
NetworkFailure
ÆÆ *
>
ÆÆ* +
.
ÆÆ+ ,
Ok
ÆÆ, .
(
ÆÆ. /
false
ÆÆ/ 4
)
ÆÆ4 5
;
ÆÆ5 6
}
ÇÇ 
public
ÉÉ 

async
ÉÉ 
Task
ÉÉ 
<
ÉÉ 
Result
ÉÉ 
<
ÉÉ "
EcliptixSessionState
ÉÉ 1
,
ÉÉ1 2
NetworkFailure
ÉÉ3 A
>
ÉÉA B
>
ÉÉB C*
EstablishSecrecyChannelAsync
ÉÉD `
(
ÉÉ` a
uint
ÊÊ 
	connectId
ÊÊ 
)
ÊÊ 
{
ËË 
Result
ÌÌ 
<
ÌÌ 
Option
ÌÌ 
<
ÌÌ "
EcliptixSessionState
ÌÌ *
>
ÌÌ* +
,
ÌÌ+ ,
NetworkFailure
ÌÌ- ;
>
ÌÌ; <
result
ÌÌ= C
=
ÌÌD E
await
ÍÍ 2
$EstablishSecrecyChannelInternalAsync
ÍÍ 6
(
ÍÍ6 7
	connectId
ÎÎ 
,
ÎÎ  
PubKeyExchangeType
ÏÏ "
.
ÏÏ" #(
DataCenterEphemeralConnect
ÏÏ# =
,
ÏÏ= >
	saveState
ÐÐ 
:
ÐÐ 
true
ÐÐ 
)
ÐÐ  
.
ÐÐ  !
ConfigureAwait
ÐÐ! /
(
ÐÐ/ 0
false
ÐÐ0 5
)
ÐÐ5 6
;
ÐÐ6 7
if
ÒÒ 

(
ÒÒ 
result
ÒÒ 
.
ÒÒ 
IsErr
ÒÒ 
)
ÒÒ 
{
ÓÓ 	
return
ÔÔ 
Result
ÔÔ 
<
ÔÔ "
EcliptixSessionState
ÔÔ .
,
ÔÔ. /
NetworkFailure
ÔÔ0 >
>
ÔÔ> ?
.
ÔÔ? @
Err
ÔÔ@ C
(
ÔÔC D
result
ÔÔD J
.
ÔÔJ K
	UnwrapErr
ÔÔK T
(
ÔÔT U
)
ÔÔU V
)
ÔÔV W
;
ÔÔW X
}
ÕÕ 	
Option
×× 
<
×× "
EcliptixSessionState
×× #
>
××# $
stateOption
××% 0
=
××1 2
result
××3 9
.
××9 :
Unwrap
××: @
(
××@ A
)
××A B
;
××B C
if
ØØ 

(
ØØ 
!
ØØ 
stateOption
ØØ 
.
ØØ 
IsSome
ØØ 
)
ØØ  
{
ÙÙ 	
return
ÚÚ 
Result
ÚÚ 
<
ÚÚ "
EcliptixSessionState
ÚÚ .
,
ÚÚ. /
NetworkFailure
ÚÚ0 >
>
ÚÚ> ?
.
ÚÚ? @
Err
ÚÚ@ C
(
ÚÚC D
NetworkFailure
ÛÛ 
.
ÛÛ %
DataCenterNotResponding
ÛÛ 6
(
ÛÛ6 7
$str
ÛÛ7 W
)
ÛÛW X
)
ÛÛX Y
;
ÛÛY Z
}
ÜÜ 	
return
ÞÞ 
Result
ÞÞ 
<
ÞÞ "
EcliptixSessionState
ÞÞ *
,
ÞÞ* +
NetworkFailure
ÞÞ, :
>
ÞÞ: ;
.
ÞÞ; <
Ok
ÞÞ< >
(
ÞÞ> ?
stateOption
ÞÞ? J
.
ÞÞJ K
Value
ÞÞK P
!
ÞÞP Q
)
ÞÞQ R
;
ÞÞR S
}
ßß 
public
áá 

async
áá 
Task
áá 
<
áá 
Result
áá 
<
áá 
uint
áá !
,
áá! "
NetworkFailure
áá# 1
>
áá1 2
>
áá2 3(
EnsureProtocolForTypeAsync
áá4 N
(
ááN O 
PubKeyExchangeType
ââ 
EXCHANGE_TYPE
ââ (
)
ââ( )
{
ãã 
if
ää 

(
ää 
!
ää *
_applicationInstanceSettings
ää )
.
ää) *
IsSome
ää* 0
)
ää0 1
{
åå 	
return
ææ 
Result
ææ 
<
ææ 
uint
ææ 
,
ææ 
NetworkFailure
ææ  .
>
ææ. /
.
ææ/ 0
Err
ææ0 3
(
ææ3 4
NetworkFailure
çç 
.
çç  
InvalidRequestType
çç 1
(
çç1 2
$str
çç2 O
)
ççO P
)
ççP Q
;
ççQ R
}
èè 	)
ApplicationInstanceSettings
êê #
appSettings
êê$ /
=
êê0 1*
_applicationInstanceSettings
êê2 N
.
êêN O
Value
êêO T
!
êêT U
;
êêU V
uint
ëë 
	connectId
ëë 
=
ëë $
ComputeUniqueConnectId
ëë /
(
ëë/ 0
appSettings
ëë0 ;
,
ëë; <
EXCHANGE_TYPE
ëë= J
)
ëëJ K
;
ëëK L
if
íí 

(
íí 
_connections
íí 
.
íí 
	TryRemove
íí "
(
íí" #
	connectId
íí# ,
,
íí, -
out
íí. 1$
EcliptixProtocolSystem
íí2 H
?
ííH I 
existingConnection
ííJ \
)
íí\ ]
)
íí] ^
{
îî 	 
existingConnection
ïï 
.
ïï 
Dispose
ïï &
(
ïï& '
)
ïï' (
;
ïï( )
}
ðð 	3
%InitiateEcliptixProtocolSystemForType
òò -
(
òò- .
	connectId
òò. 7
)
òò7 8
;
òò8 9
Result
ôô 
<
ôô 
Option
ôô 
<
ôô "
EcliptixSessionState
ôô *
>
ôô* +
,
ôô+ ,
NetworkFailure
ôô- ;
>
ôô; <#
establishOptionResult
ôô= R
=
ôôS T
await
õõ 1
#EstablishSecrecyChannelForTypeAsync
õõ 5
(
õõ5 6
	connectId
õõ6 ?
,
õõ? @
EXCHANGE_TYPE
õõA N
)
õõN O
.
õõO P
ConfigureAwait
õõP ^
(
õõ^ _
false
õõ_ d
)
õõd e
;
õõe f
if
÷÷ 

(
÷÷ 
!
÷÷ #
establishOptionResult
÷÷ "
.
÷÷" #
IsErr
÷÷# (
)
÷÷( )
{
øø 	
return
ùù 
Result
ùù 
<
ùù 
uint
ùù 
,
ùù 
NetworkFailure
ùù  .
>
ùù. /
.
ùù/ 0
Ok
ùù0 2
(
ùù2 3
	connectId
ùù3 <
)
ùù< =
;
ùù= >
}
úú 	
_connections
üü 
.
üü 
	TryRemove
üü 
(
üü 
	connectId
üü (
,
üü( )
out
üü* -
_
üü. /
)
üü/ 0
;
üü0 1
return
ýý 
Result
ýý 
<
ýý 
uint
ýý 
,
ýý 
NetworkFailure
ýý *
>
ýý* +
.
ýý+ ,
Err
ýý, /
(
ýý/ 0#
establishOptionResult
ýý0 E
.
ýýE F
	UnwrapErr
ýýF O
(
ýýO P
)
ýýP Q
)
ýýQ R
;
ýýR S
}
þþ 
private
€€ 
void
€€ +
CancelOperationsForConnection
€€ .
(
€€. /
uint
€€/ 3
	connectId
€€4 =
)
€€= >
{
 
string
‚‚ 
connectIdPrefix
‚‚ 
=
‚‚  
$"
‚‚! #
{
‚‚# $
	connectId
‚‚$ -
}
‚‚- .
$str
‚‚. /
"
‚‚/ 0
;
‚‚0 1
foreach
„„ 
(
„„ 
KeyValuePair
„„ 
<
„„ 
string
„„ $
,
„„$ %%
CancellationTokenSource
„„& =
>
„„= >
kvp
„„? B
in
„„C E
_pendingRequests
„„F V
)
„„V W
{
…… 	
if
†† 
(
†† 
!
†† 
kvp
†† 
.
†† 
Key
†† 
.
†† 

StartsWith
†† #
(
††# $
connectIdPrefix
††$ 3
)
††3 4
)
††4 5
{
‡‡ 
continue
ˆˆ 
;
ˆˆ 
}
‰‰ 
if
‹‹ 
(
‹‹ 
!
‹‹ 
_pendingRequests
‹‹ !
.
‹‹! "
	TryRemove
‹‹" +
(
‹‹+ ,
kvp
‹‹, /
.
‹‹/ 0
Key
‹‹0 3
,
‹‹3 4
out
‹‹5 8%
CancellationTokenSource
‹‹9 P
?
‹‹P Q
operationCts
‹‹R ^
)
‹‹^ _
)
‹‹_ `
{
ŒŒ 
continue
 
;
 
}
ŽŽ 
try
 
{
‘‘ 
operationCts
’’ 
.
’’ 
Cancel
’’ #
(
’’# $
)
’’$ %
;
’’% &
operationCts
““ 
.
““ 
Dispose
““ $
(
““$ %
)
““% &
;
““& '
}
”” 
catch
•• 
(
•• %
ObjectDisposedException
•• *
)
••* +
{
–– 
}
˜˜ 
}
™™ 	
}
šš 
public
œœ 

async
œœ 
Task
œœ 
<
œœ 
Result
œœ 
<
œœ 
Unit
œœ !
,
œœ! "
NetworkFailure
œœ# 1
>
œœ1 2
>
œœ2 3(
CleanupStreamProtocolAsync
œœ4 N
(
œœN O
uint
œœO S
	connectId
œœT ]
)
œœ] ^
{
 +
CancelOperationsForConnection
žž %
(
žž% &
	connectId
žž& /
)
žž/ 0
;
žž0 1
if
   

(
   
_activeStreams
   
.
   
	TryRemove
   $
(
  $ %
	connectId
  % .
,
  . /
out
  0 3%
CancellationTokenSource
  4 K
?
  K L%
cancellationTokenSource
  M d
)
  d e
)
  e f
{
¡¡ 	
await
¢¢ %
cancellationTokenSource
¢¢ )
.
¢¢) *
CancelAsync
¢¢* 5
(
¢¢5 6
)
¢¢6 7
.
¢¢7 8
ConfigureAwait
¢¢8 F
(
¢¢F G
false
¢¢G L
)
¢¢L M
;
¢¢M N%
cancellationTokenSource
££ #
.
££# $
Dispose
££$ +
(
££+ ,
)
££, -
;
££- .
}
¤¤ 	
if
¦¦ 

(
¦¦ 
!
¦¦ 
_connections
¦¦ 
.
¦¦ 
	TryRemove
¦¦ #
(
¦¦# $
	connectId
¦¦$ -
,
¦¦- .
out
¦¦/ 2$
EcliptixProtocolSystem
¦¦3 I
?
¦¦I J
protocolSystem
¦¦K Y
)
¦¦Y Z
)
¦¦Z [
{
§§ 	
return
¨¨ 
Result
¨¨ 
<
¨¨ 
Unit
¨¨ 
,
¨¨ 
NetworkFailure
¨¨  .
>
¨¨. /
.
¨¨/ 0
Ok
¨¨0 2
(
¨¨2 3
Unit
¨¨3 7
.
¨¨7 8
Value
¨¨8 =
)
¨¨= >
;
¨¨> ?
}
©© 	
protocolSystem
«« 
.
«« 
Dispose
«« 
(
«« 
)
««  
;
««  !
return
­­ 
Result
­­ 
<
­­ 
Unit
­­ 
,
­­ 
NetworkFailure
­­ *
>
­­* +
.
­­+ ,
Ok
­­, .
(
­­. /
Unit
­­/ 3
.
­­3 4
Value
­­4 9
)
­­9 :
;
­­: ;
}
®® 
private
°° 
static
°° 
RatchetConfig
°°  -
GetRatchetConfigForExchangeType
°°! @
(
°°@ A 
PubKeyExchangeType
°°A S
EXCHANGE_TYPE
°°T a
)
°°a b
{
±± 
RatchetConfig
²² 
config
²² 
=
²² 
EXCHANGE_TYPE
²² ,
switch
²²- 3
{
³³ 	 
PubKeyExchangeType
´´ 
.
´´ 
ServerStreaming
´´ .
=>
´´/ 1
new
´´2 5
RatchetConfig
´´6 C
{
µµ %
DhRatchetEveryNMessages
¶¶ '
=
¶¶( )
$num
¶¶* ,
,
¶¶, -
MaxChainAge
·· 
=
·· 
TimeSpan
·· &
.
··& '
FromMinutes
··' 2
(
··2 3
$num
··3 4
)
··4 5
,
··5 6'
MaxMessagesWithoutRatchet
¸¸ )
=
¸¸* +
$num
¸¸, /
}
¹¹ 
,
¹¹ 
_
ºº 
=>
ºº 
RatchetConfig
ºº 
.
ºº 
Default
ºº &
}
»» 	
;
»»	 

return
½½ 
config
½½ 
;
½½ 
}
¾¾ 
private
ÀÀ 
static
ÀÀ  
PubKeyExchangeType
ÀÀ %0
"DetermineExchangeTypeFromConnectId
ÀÀ& H
(
ÀÀH I)
ApplicationInstanceSettings
ÁÁ #)
applicationInstanceSettings
ÁÁ$ ?
,
ÁÁ? @
uint
ÁÁA E
	connectId
ÁÁF O
)
ÁÁO P
{
ÂÂ  
PubKeyExchangeType
ÃÃ 
[
ÃÃ 
]
ÃÃ 

knownTypes
ÃÃ '
=
ÃÃ( )
[
ÄÄ 	 
PubKeyExchangeType
ÅÅ 
.
ÅÅ (
DataCenterEphemeralConnect
ÅÅ 9
,
ÅÅ9 : 
PubKeyExchangeType
ÆÆ 
.
ÆÆ 
ServerStreaming
ÆÆ .
]
ÇÇ 	
;
ÇÇ	 

foreach
ÉÉ 
(
ÉÉ  
PubKeyExchangeType
ÉÉ #
EXCHANGE_TYPE
ÉÉ$ 1
in
ÉÉ2 4

knownTypes
ÉÉ5 ?
)
ÉÉ? @
{
ÊÊ 	
uint
ËË 
computedConnectId
ËË "
=
ËË# $$
ComputeUniqueConnectId
ËË% ;
(
ËË; <)
applicationInstanceSettings
ËË< W
,
ËËW X
EXCHANGE_TYPE
ËËY f
)
ËËf g
;
ËËg h
if
ÌÌ 
(
ÌÌ 
computedConnectId
ÌÌ !
!=
ÌÌ" $
	connectId
ÌÌ% .
)
ÌÌ. /
{
ÍÍ 
continue
ÎÎ 
;
ÎÎ 
}
ÏÏ 
return
ÑÑ 
EXCHANGE_TYPE
ÑÑ  
;
ÑÑ  !
}
ÒÒ 	
return
ÔÔ  
PubKeyExchangeType
ÔÔ !
.
ÔÔ! "(
DataCenterEphemeralConnect
ÔÔ" <
;
ÔÔ< =
}
ÕÕ 
private
×× 
void
×× 3
%InitiateEcliptixProtocolSystemForType
×× 6
(
××6 7
uint
××7 ;
	connectId
××< E
)
ØØ 
{
ÙÙ (
EcliptixSystemIdentityKeys
ÚÚ "
identityKeys
ÚÚ# /
=
ÚÚ0 1(
EcliptixSystemIdentityKeys
ÛÛ &
.
ÛÛ& '
Create
ÛÛ' -
(
ÛÛ- .
NetworkConstants
ÛÛ. >
.
ÛÛ> ?
Protocol
ÛÛ? G
.
ÛÛG H(
DEFAULT_ONE_TIME_KEY_COUNT
ÛÛH b
)
ÛÛb c
.
ÛÛc d
Unwrap
ÛÛd j
(
ÛÛj k
)
ÛÛk l
;
ÛÛl m$
EcliptixProtocolSystem
ÝÝ 
protocolSystem
ÝÝ -
=
ÝÝ. /
new
ÝÝ0 3
(
ÝÝ3 4
identityKeys
ÝÝ4 @
)
ÝÝ@ A
;
ÝÝA B
protocolSystem
ÞÞ 
.
ÞÞ 
SetEventHandler
ÞÞ &
(
ÞÞ& '
this
ÞÞ' +
)
ÞÞ+ ,
;
ÞÞ, -
_connections
àà 
.
àà 
TryAdd
àà 
(
àà 
	connectId
àà %
,
àà% &
protocolSystem
àà' 5
)
àà5 6
;
àà6 7
}
áá 
private
ãã 
async
ãã 
Task
ãã 
<
ãã 
Result
ãã 
<
ãã 
Option
ãã $
<
ãã$ %"
EcliptixSessionState
ãã% 9
>
ãã9 :
,
ãã: ;
NetworkFailure
ãã< J
>
ããJ K
>
ããK L1
#EstablishSecrecyChannelForTypeAsync
ããM p
(
ããp q
uint
ää 
	connectId
ää 
,
ää  
PubKeyExchangeType
åå 
EXCHANGE_TYPE
åå (
)
åå( )
{
ææ 
return
çç 
await
çç 2
$EstablishSecrecyChannelInternalAsync
çç 9
(
çç9 :
	connectId
èè 
,
èè 
EXCHANGE_TYPE
éé 
,
éé 

maxRetries
êê 
:
êê 
$num
êê 
,
êê 
	saveState
ëë 
:
ëë 
EXCHANGE_TYPE
ëë $
==
ëë% ' 
PubKeyExchangeType
ëë( :
.
ëë: ;(
DataCenterEphemeralConnect
ëë; U
)
ëëU V
.
ëëV W
ConfigureAwait
ëëW e
(
ëëe f
false
ëëf k
)
ëëk l
;
ëël m
}
ìì 
private
îî 
Result
îî 
<
îî 
Unit
îî 
,
îî %
EcliptixProtocolFailure
îî 0
>
îî0 1 
SyncSecrecyChannel
îî2 D
(
îîD E"
EcliptixSessionState
ïï 
currentState
ïï )
,
ïï) *$
RestoreChannelResponse
ðð %
peerSecrecyChannelState
ðð 6
)
ðð6 7
{
ññ 
Result
òò 
<
òò $
EcliptixProtocolSystem
òò %
,
òò% &%
EcliptixProtocolFailure
òò' >
>
òò> ?
systemResult
òò@ L
=
òòM N%
RecreateSystemFromState
òòO f
(
òòf g
currentState
òòg s
)
òòs t
;
òòt u
if
óó 

(
óó 
systemResult
óó 
.
óó 
IsErr
óó 
)
óó 
{
ôô 	
return
õõ 
Result
õõ 
<
õõ 
Unit
õõ 
,
õõ %
EcliptixProtocolFailure
õõ  7
>
õõ7 8
.
õõ8 9
Err
õõ9 <
(
õõ< =
systemResult
õõ= I
.
õõI J
	UnwrapErr
õõJ S
(
õõS T
)
õõT U
)
õõU V
;
õõV W
}
öö 	$
EcliptixProtocolSystem
øø 
system
øø %
=
øø& '
systemResult
øø( 4
.
øø4 5
Unwrap
øø5 ;
(
øø; <
)
øø< =
;
øø= >
system
úú 
.
úú 
SetEventHandler
úú 
(
úú 
this
úú #
)
úú# $
;
úú$ %(
EcliptixProtocolConnection
üü "
?
üü" #

connection
üü$ .
=
üü/ 0
system
üü1 7
.
üü7 8
GetConnection
üü8 E
(
üüE F
)
üüF G
;
üüG H
if
ýý 

(
ýý 

connection
ýý 
==
ýý 
null
ýý 
)
ýý 
{
þþ 	
return
ÿÿ 
Result
ÿÿ 
<
ÿÿ 
Unit
ÿÿ 
,
ÿÿ %
EcliptixProtocolFailure
ÿÿ  7
>
ÿÿ7 8
.
ÿÿ8 9
Err
ÿÿ9 <
(
ÿÿ< =%
EcliptixProtocolFailure
€€ '
.
€€' (
Generic
€€( /
(
€€/ 0
$str
€€0 L
)
€€L M
)
€€M N
;
€€N O
}
 	
Result
ƒƒ 
<
ƒƒ 
Unit
ƒƒ 
,
ƒƒ %
EcliptixProtocolFailure
ƒƒ ,
>
ƒƒ, -

syncResult
ƒƒ. 8
=
ƒƒ9 :

connection
ƒƒ; E
.
ƒƒE F!
SyncWithRemoteState
ƒƒF Y
(
ƒƒY Z%
peerSecrecyChannelState
„„ #
.
„„# $ 
SendingChainLength
„„$ 6
,
„„6 7%
peerSecrecyChannelState
…… #
.
……# $"
ReceivingChainLength
……$ 8
)
†† 	
;
††	 

if
ˆˆ 

(
ˆˆ 

syncResult
ˆˆ 
.
ˆˆ 
IsErr
ˆˆ 
)
ˆˆ 
{
‰‰ 	
system
ŠŠ 
.
ŠŠ 
Dispose
ŠŠ 
(
ŠŠ 
)
ŠŠ 
;
ŠŠ 
return
‹‹ 
Result
‹‹ 
<
‹‹ 
Unit
‹‹ 
,
‹‹ %
EcliptixProtocolFailure
‹‹  7
>
‹‹7 8
.
‹‹8 9
Err
‹‹9 <
(
‹‹< =

syncResult
‹‹= G
.
‹‹G H
	UnwrapErr
‹‹H Q
(
‹‹Q R
)
‹‹R S
)
‹‹S T
;
‹‹T U
}
ŒŒ 	
_
ŽŽ 	
=
ŽŽ
 

connection
ŽŽ 
.
ŽŽ 
ToProtoState
ŽŽ #
(
ŽŽ# $
)
ŽŽ$ %
;
ŽŽ% &
_connections
 
.
 
TryAdd
 
(
 
currentState
 (
.
( )
	ConnectId
) 2
,
2 3
system
4 :
)
: ;
;
; <
return
‘‘ 
Result
‘‘ 
<
‘‘ 
Unit
‘‘ 
,
‘‘ %
EcliptixProtocolFailure
‘‘ 3
>
‘‘3 4
.
‘‘4 5
Ok
‘‘5 7
(
‘‘7 8
Unit
‘‘8 <
.
‘‘< =
Value
‘‘= B
)
‘‘B C
;
‘‘C D
}
’’ 
private
”” 
Result
”” 
<
”” $
EcliptixProtocolSystem
”” )
,
””) *%
EcliptixProtocolFailure
””+ B
>
””B C%
RecreateSystemFromState
””D [
(
””[ \"
EcliptixSessionState
•• 
state
•• "
)
••" #
{
–– 
Result
—— 
<
—— (
EcliptixSystemIdentityKeys
—— )
,
——) *%
EcliptixProtocolFailure
——+ B
>
——B C
idKeysResult
——D P
=
——Q R(
EcliptixSystemIdentityKeys
˜˜ &
.
˜˜& '
FromProtoState
˜˜' 5
(
˜˜5 6
state
˜˜6 ;
.
˜˜; <
IdentityKeys
˜˜< H
)
˜˜H I
;
˜˜I J
if
™™ 

(
™™ 
idKeysResult
™™ 
.
™™ 
IsErr
™™ 
)
™™ 
{
šš 	
return
›› 
Result
›› 
<
›› $
EcliptixProtocolSystem
›› 0
,
››0 1%
EcliptixProtocolFailure
››2 I
>
››I J
.
››J K
Err
››K N
(
››N O
idKeysResult
››O [
.
››[ \
	UnwrapErr
››\ e
(
››e f
)
››f g
)
››g h
;
››h i
}
œœ 	 
PubKeyExchangeType
žž 
EXCHANGE_TYPE
žž (
=
žž) **
_applicationInstanceSettings
žž+ G
.
žžG H
IsSome
žžH N
?
ŸŸ 0
"DetermineExchangeTypeFromConnectId
ŸŸ 0
(
ŸŸ0 1*
_applicationInstanceSettings
ŸŸ1 M
.
ŸŸM N
Value
ŸŸN S
!
ŸŸS T
,
ŸŸT U
state
ŸŸV [
.
ŸŸ[ \
	ConnectId
ŸŸ\ e
)
ŸŸe f
:
    
PubKeyExchangeType
    
.
    !(
DataCenterEphemeralConnect
  ! ;
;
  ; <
RatchetConfig
¢¢ 
config
¢¢ 
=
¢¢ -
GetRatchetConfigForExchangeType
¢¢ >
(
¢¢> ?
EXCHANGE_TYPE
¢¢? L
)
¢¢L M
;
¢¢M N
Result
¤¤ 
<
¤¤ (
EcliptixProtocolConnection
¤¤ )
,
¤¤) *%
EcliptixProtocolFailure
¤¤+ B
>
¤¤B C

connResult
¤¤D N
=
¤¤O P(
EcliptixProtocolConnection
¥¥ &
.
¥¥& '
FromProtoState
¥¥' 5
(
¥¥5 6
state
¥¥6 ;
.
¥¥; <
	ConnectId
¥¥< E
,
¥¥E F
state
¥¥G L
.
¥¥L M
RatchetState
¥¥M Y
,
¥¥Y Z
config
¥¥[ a
,
¥¥a b
EXCHANGE_TYPE
¥¥c p
)
¥¥p q
;
¥¥q r
if
§§ 

(
§§ 

connResult
§§ 
.
§§ 
IsErr
§§ 
)
§§ 
{
¨¨ 	
idKeysResult
©© 
.
©© 
Unwrap
©© 
(
©©  
)
©©  !
.
©©! "
Dispose
©©" )
(
©©) *
)
©©* +
;
©©+ ,
return
ªª 
Result
ªª 
<
ªª $
EcliptixProtocolSystem
ªª 0
,
ªª0 1%
EcliptixProtocolFailure
ªª2 I
>
ªªI J
.
ªªJ K
Err
ªªK N
(
ªªN O

connResult
ªªO Y
.
ªªY Z
	UnwrapErr
ªªZ c
(
ªªc d
)
ªªd e
)
ªªe f
;
ªªf g
}
«« 	
return
­­ $
EcliptixProtocolSystem
­­ %
.
­­% &

CreateFrom
­­& 0
(
­­0 1
idKeysResult
­­1 =
.
­­= >
Unwrap
­­> D
(
­­D E
)
­­E F
,
­­F G

connResult
­­H R
.
­­R S
Unwrap
­­S Y
(
­­Y Z
)
­­Z [
)
­­[ \
;
­­\ ]
}
®® 
private
°° 
static
°° 
uint
°° (
GenerateLogicalOperationId
°° 2
(
°°2 3
uint
°°3 7
	connectId
°°8 A
,
°°A B
RpcServiceType
°°C Q
serviceType
°°R ]
,
°°] ^
byte
°°_ c
[
°°c d
]
°°d e
plainBuffer
°°f q
)
°°q r
{
±± 
Span
²² 
<
²² 
byte
²² 
>
²² 

hashBuffer
²² 
=
²² 

stackalloc
²²  *
byte
²²+ /
[
²²/ 0
NetworkConstants
²²0 @
.
²²@ A
Cryptography
²²A M
.
²²M N
SHA_256_HASH_SIZE
²²N _
]
²²_ `
;
²²` a
switch
´´ 
(
´´ 
serviceType
´´ 
.
´´ 
ToString
´´ $
(
´´$ %
)
´´% &
)
´´& '
{
µµ 	
case
¶¶ 
$str
¶¶ *
or
¶¶+ -
$str
¶¶. K
:
¶¶K L
{
·· 
Span
¸¸ 
<
¸¸ 
byte
¸¸ 
>
¸¸ 
semanticBuffer
¸¸ -
=
¸¸. /

stackalloc
¸¸0 :
byte
¸¸; ?
[
¸¸? @
$num
¸¸@ C
]
¸¸C D
;
¸¸D E
int
¹¹ 
written
¹¹ 
=
¹¹  !
System
¹¹" (
.
¹¹( )
Text
¹¹) -
.
¹¹- .
Encoding
¹¹. 6
.
¹¹6 7
UTF8
¹¹7 ;
.
¹¹; <
GetBytes
¹¹< D
(
¹¹D E
$"
¹¹E G
$str
¹¹G S
{
¹¹S T
	connectId
¹¹T ]
}
¹¹] ^
"
¹¹^ _
,
¹¹_ `
semanticBuffer
¹¹a o
)
¹¹o p
;
¹¹p q
SHA256
ºº 
.
ºº 
HashData
ºº #
(
ºº# $
semanticBuffer
ºº$ 2
[
ºº2 3
..
ºº3 5
written
ºº5 <
]
ºº< =
,
ºº= >

hashBuffer
ºº? I
)
ººI J
;
ººJ K
break
»» 
;
»» 
}
¼¼ 
case
½½ 
$str
½½ *
or
½½+ -
$str
½½. K
:
½½K L
{
¾¾ 
Span
¿¿ 
<
¿¿ 
byte
¿¿ 
>
¿¿ 
semanticBuffer
¿¿ -
=
¿¿. /

stackalloc
¿¿0 :
byte
¿¿; ?
[
¿¿? @
$num
¿¿@ C
]
¿¿C D
;
¿¿D E
int
ÀÀ 
written
ÀÀ 
=
ÀÀ  !
System
ÀÀ" (
.
ÀÀ( )
Text
ÀÀ) -
.
ÀÀ- .
Encoding
ÀÀ. 6
.
ÀÀ6 7
UTF8
ÀÀ7 ;
.
ÀÀ; <
GetBytes
ÀÀ< D
(
ÀÀD E
$"
ÀÀE G
$str
ÀÀG S
{
ÀÀS T
	connectId
ÀÀT ]
}
ÀÀ] ^
"
ÀÀ^ _
,
ÀÀ_ `
semanticBuffer
ÀÀa o
)
ÀÀo p
;
ÀÀp q
SHA256
ÁÁ 
.
ÁÁ 
HashData
ÁÁ #
(
ÁÁ# $
semanticBuffer
ÁÁ$ 2
[
ÁÁ2 3
..
ÁÁ3 5
written
ÁÁ5 <
]
ÁÁ< =
,
ÁÁ= >

hashBuffer
ÁÁ? I
)
ÁÁI J
;
ÁÁJ K
break
ÂÂ 
;
ÂÂ 
}
ÃÃ 
case
ÄÄ 
$str
ÄÄ '
:
ÄÄ' (
{
ÅÅ 
Span
ÆÆ 
<
ÆÆ 
byte
ÆÆ 
>
ÆÆ 
payloadHash
ÆÆ *
=
ÆÆ+ ,

stackalloc
ÆÆ- 7
byte
ÆÆ8 <
[
ÆÆ< =
NetworkConstants
ÆÆ= M
.
ÆÆM N
Cryptography
ÆÆN Z
.
ÆÆZ [
SHA_256_HASH_SIZE
ÆÆ[ l
]
ÆÆl m
;
ÆÆm n
SHA256
ÇÇ 
.
ÇÇ 
HashData
ÇÇ #
(
ÇÇ# $
plainBuffer
ÇÇ$ /
,
ÇÇ/ 0
payloadHash
ÇÇ1 <
)
ÇÇ< =
;
ÇÇ= >
string
ÉÉ 
semantic
ÉÉ #
=
ÉÉ$ %
$"
ÊÊ 
$str
ÊÊ !
{
ÊÊ! "
serviceType
ÊÊ" -
}
ÊÊ- .
$str
ÊÊ. /
{
ÊÊ/ 0
	connectId
ÊÊ0 9
}
ÊÊ9 :
$str
ÊÊ: ;
{
ÊÊ; <
DateTime
ÊÊ< D
.
ÊÊD E
UtcNow
ÊÊE K
.
ÊÊK L
Ticks
ÊÊL Q
}
ÊÊQ R
$str
ÊÊR S
{
ÊÊS T
Convert
ÊÊT [
.
ÊÊ[ \
ToHexString
ÊÊ\ g
(
ÊÊg h
payloadHash
ÊÊh s
)
ÊÊs t
}
ÊÊt u
"
ÊÊu v
;
ÊÊv w
Span
ËË 
<
ËË 
byte
ËË 
>
ËË 
semanticBuffer
ËË -
=
ËË. /

stackalloc
ËË0 :
byte
ËË; ?
[
ËË? @
System
ËË@ F
.
ËËF G
Text
ËËG K
.
ËËK L
Encoding
ËËL T
.
ËËT U
UTF8
ËËU Y
.
ËËY Z
GetByteCount
ËËZ f
(
ËËf g
semantic
ËËg o
)
ËËo p
]
ËËp q
;
ËËq r
int
ÌÌ 
written
ÌÌ 
=
ÌÌ  !
System
ÌÌ" (
.
ÌÌ( )
Text
ÌÌ) -
.
ÌÌ- .
Encoding
ÌÌ. 6
.
ÌÌ6 7
UTF8
ÌÌ7 ;
.
ÌÌ; <
GetBytes
ÌÌ< D
(
ÌÌD E
semantic
ÌÌE M
,
ÌÌM N
semanticBuffer
ÌÌO ]
)
ÌÌ] ^
;
ÌÌ^ _
SHA256
ÍÍ 
.
ÍÍ 
HashData
ÍÍ #
(
ÍÍ# $
semanticBuffer
ÍÍ$ 2
[
ÍÍ2 3
..
ÍÍ3 5
written
ÍÍ5 <
]
ÍÍ< =
,
ÍÍ= >

hashBuffer
ÍÍ? I
)
ÍÍI J
;
ÍÍJ K
break
ÎÎ 
;
ÎÎ 
}
ÏÏ 
default
ÐÐ 
:
ÐÐ 
{
ÑÑ 
Span
ÒÒ 
<
ÒÒ 
byte
ÒÒ 
>
ÒÒ 
payloadHash
ÒÒ *
=
ÒÒ+ ,

stackalloc
ÒÒ- 7
byte
ÒÒ8 <
[
ÒÒ< =
NetworkConstants
ÒÒ= M
.
ÒÒM N
Cryptography
ÒÒN Z
.
ÒÒZ [
SHA_256_HASH_SIZE
ÒÒ[ l
]
ÒÒl m
;
ÒÒm n
SHA256
ÓÓ 
.
ÓÓ 
HashData
ÓÓ #
(
ÓÓ# $
plainBuffer
ÓÓ$ /
,
ÓÓ/ 0
payloadHash
ÓÓ1 <
)
ÓÓ< =
;
ÓÓ= >
string
ÕÕ 
semantic
ÕÕ #
=
ÕÕ$ %
$"
ÕÕ& (
$str
ÕÕ( -
{
ÕÕ- .
serviceType
ÕÕ. 9
}
ÕÕ9 :
$str
ÕÕ: ;
{
ÕÕ; <
	connectId
ÕÕ< E
}
ÕÕE F
$str
ÕÕF G
{
ÕÕG H
Convert
ÕÕH O
.
ÕÕO P
ToHexString
ÕÕP [
(
ÕÕ[ \
payloadHash
ÕÕ\ g
)
ÕÕg h
}
ÕÕh i
"
ÕÕi j
;
ÕÕj k
Span
ÖÖ 
<
ÖÖ 
byte
ÖÖ 
>
ÖÖ 
semanticBuffer
ÖÖ -
=
ÖÖ. /

stackalloc
ÖÖ0 :
byte
ÖÖ; ?
[
ÖÖ? @
System
ÖÖ@ F
.
ÖÖF G
Text
ÖÖG K
.
ÖÖK L
Encoding
ÖÖL T
.
ÖÖT U
UTF8
ÖÖU Y
.
ÖÖY Z
GetByteCount
ÖÖZ f
(
ÖÖf g
semantic
ÖÖg o
)
ÖÖo p
]
ÖÖp q
;
ÖÖq r
int
×× 
written
×× 
=
××  !
System
××" (
.
××( )
Text
××) -
.
××- .
Encoding
××. 6
.
××6 7
UTF8
××7 ;
.
××; <
GetBytes
××< D
(
××D E
semantic
××E M
,
××M N
semanticBuffer
××O ]
)
××] ^
;
××^ _
SHA256
ØØ 
.
ØØ 
HashData
ØØ #
(
ØØ# $
semanticBuffer
ØØ$ 2
[
ØØ2 3
..
ØØ3 5
written
ØØ5 <
]
ØØ< =
,
ØØ= >

hashBuffer
ØØ? I
)
ØØI J
;
ØØJ K
break
ÙÙ 
;
ÙÙ 
}
ÚÚ 
}
ÛÛ 	
const
ÝÝ 
int
ÝÝ 
HASH_LENGTH
ÝÝ 
=
ÝÝ 
NetworkConstants
ÝÝ  0
.
ÝÝ0 1
Cryptography
ÝÝ1 =
.
ÝÝ= >
SHA_256_HASH_SIZE
ÝÝ> O
;
ÝÝO P
uint
ßß 
rawId
ßß 
=
ßß 
BitConverter
ßß !
.
ßß! "
ToUInt32
ßß" *
(
ßß* +

hashBuffer
ßß+ 5
[
ßß5 6
..
ßß6 8
HASH_LENGTH
ßß8 C
]
ßßC D
)
ßßD E
;
ßßE F
uint
àà 
finalId
àà 
=
àà 
Math
àà 
.
àà 
Max
àà 
(
àà  
rawId
àà  %
%
àà& '
(
àà( )
uint
àà) -
.
àà- .
MaxValue
àà. 6
-
àà7 8
NetworkConstants
àà9 I
.
ààI J
Protocol
ààJ R
.
ààR S)
OPERATION_ID_RESERVED_RANGE
ààS n
)
ààn o
,
àào p
NetworkConstants
áá 
.
áá 
Protocol
áá %
.
áá% &$
OPERATION_ID_MIN_VALUE
áá& <
)
áá< =
;
áá= >
return
ãã 
finalId
ãã 
;
ãã 
}
ää 
private
ææ 
static
ææ 
Result
ææ 
<
ææ 
SecureEnvelope
ææ (
,
ææ( )
NetworkFailure
ææ* 8
>
ææ8 9
EncryptPayload
ææ: H
(
ææH I$
EcliptixProtocolSystem
çç 
protocolSystem
çç -
,
çç- .
byte
èè 
[
èè 
]
èè 
plainBuffer
èè 
)
èè 
{
éé 
Result
êê 
<
êê 
SecureEnvelope
êê 
,
êê %
EcliptixProtocolFailure
êê 6
>
êê6 7
outboundPayload
êê8 G
=
êêH I
protocolSystem
ëë 
.
ëë %
ProduceOutboundEnvelope
ëë 2
(
ëë2 3
plainBuffer
ëë3 >
)
ëë> ?
;
ëë? @
if
íí 

(
íí 
outboundPayload
íí 
.
íí 
IsErr
íí !
)
íí! "
{
îî 	
return
ïï 
Result
ïï 
<
ïï 
SecureEnvelope
ïï (
,
ïï( )
NetworkFailure
ïï* 8
>
ïï8 9
.
ïï9 :
Err
ïï: =
(
ïï= >
outboundPayload
ðð 
.
ðð  
	UnwrapErr
ðð  )
(
ðð) *
)
ðð* +
.
ðð+ ,
ToNetworkFailure
ðð, <
(
ðð< =
)
ðð= >
)
ðð> ?
;
ðð? @
}
ññ 	
SecureEnvelope
óó 
cipherPayload
óó $
=
óó% &
outboundPayload
óó' 6
.
óó6 7
Unwrap
óó7 =
(
óó= >
)
óó> ?
;
óó? @
return
õõ 
Result
õõ 
<
õõ 
SecureEnvelope
õõ $
,
õõ$ %
NetworkFailure
õõ& 4
>
õõ4 5
.
õõ5 6
Ok
õõ6 8
(
õõ8 9
cipherPayload
õõ9 F
)
õõF G
;
õõG H
}
öö 
private
øø 
static
øø 
Result
øø 
<
øø 
ServiceRequest
øø (
,
øø( )
NetworkFailure
øø* 8
>
øø8 9 
BuildRequestWithId
øø: L
(
øøL M$
EcliptixProtocolSystem
ùù 
protocolSystem
ùù -
,
ùù- .
uint
úú  
logicalOperationId
úú 
,
úú  
RpcServiceType
ûû 
serviceType
ûû "
,
ûû" #
byte
üü 
[
üü 
]
üü 
plainBuffer
üü 
,
üü 
ServiceFlowType
ýý 
flowType
ýý  
,
ýý  !
RpcRequestContext
þþ 
requestContext
þþ (
)
þþ( )
{
ÿÿ 
Result
€€ 
<
€€ 
SecureEnvelope
€€ 
,
€€ 
NetworkFailure
€€ -
>
€€- .
encryptResult
€€/ <
=
€€= >
EncryptPayload
€€? M
(
€€M N
protocolSystem
€€N \
,
€€\ ]
plainBuffer
€€^ i
)
€€i j
;
€€j k
if
‚‚ 

(
‚‚ 
encryptResult
‚‚ 
.
‚‚ 
IsErr
‚‚ 
)
‚‚  
{
ƒƒ 	
return
„„ 
Result
„„ 
<
„„ 
ServiceRequest
„„ (
,
„„( )
NetworkFailure
„„* 8
>
„„8 9
.
„„9 :
Err
„„: =
(
„„= >
encryptResult
„„> K
.
„„K L
	UnwrapErr
„„L U
(
„„U V
)
„„V W
)
„„W X
;
„„X Y
}
…… 	
SecureEnvelope
‡‡ 
cipherPayload
‡‡ $
=
‡‡% &
encryptResult
‡‡' 4
.
‡‡4 5
Unwrap
‡‡5 ;
(
‡‡; <
)
‡‡< =
;
‡‡= >
return
‰‰ 
Result
‰‰ 
<
‰‰ 
ServiceRequest
‰‰ $
,
‰‰$ %
NetworkFailure
‰‰& 4
>
‰‰4 5
.
‰‰5 6
Ok
‰‰6 8
(
‰‰8 9
ServiceRequest
ŠŠ 
.
ŠŠ 
New
ŠŠ 
(
ŠŠ  
logicalOperationId
ŠŠ 1
,
ŠŠ1 2
flowType
ŠŠ3 ;
,
ŠŠ; <
serviceType
ŠŠ= H
,
ŠŠH I
cipherPayload
ŠŠJ W
,
ŠŠW X
[
ŠŠY Z
]
ŠŠZ [
,
ŠŠ[ \
requestContext
ŠŠ] k
)
ŠŠk l
)
ŠŠl m
;
ŠŠm n
}
‹‹ 
private
 
async
 
Task
 
<
 
Result
 
<
 
Unit
 "
,
" #
NetworkFailure
$ 2
>
2 3
>
3 4#
SendUnaryRequestAsync
5 J
(
J K$
EcliptixProtocolSystem
ŽŽ 
protocolSystem
ŽŽ -
,
ŽŽ- .
uint
  
logicalOperationId
 
,
  
RpcServiceType
 
serviceType
 "
,
" #
byte
‘‘ 
[
‘‘ 
]
‘‘ 
plainBuffer
‘‘ 
,
‘‘ 
ServiceFlowType
’’ 
flowType
’’  
,
’’  !
Func
““ 
<
““ 
byte
““ 
[
““ 
]
““ 
,
““ 
Task
““ 
<
““ 
Result
““  
<
““  !
Unit
““! %
,
““% &
NetworkFailure
““' 5
>
““5 6
>
““6 7
>
““7 8
onCompleted
““9 D
,
““D E
uint
”” 
	connectId
”” 
,
”” 
RetryBehavior
•• 
retryBehavior
•• #
,
••# $
CancellationToken
–– 
token
–– 
)
––  
{
—— 
bool
˜˜ 
shouldUseRetry
˜˜ 
=
˜˜ 
retryBehavior
˜˜ +
.
˜˜+ ,
ShouldRetry
˜˜, 7
;
˜˜7 8
Result
šš 
<
šš 
RpcFlow
šš 
,
šš 
NetworkFailure
šš &
>
šš& '
invokeResult
šš( 4
;
šš4 5
RpcRequestContext
›› 
?
››  
lastRequestContext
›› -
=
››. /
null
››0 4
;
››4 5
if
 

(
 
shouldUseRetry
 
)
 
{
žž 	
Result
ŸŸ 
<
ŸŸ 
SecureEnvelope
ŸŸ !
,
ŸŸ! "
NetworkFailure
ŸŸ# 1
>
ŸŸ1 2
encryptResult
ŸŸ3 @
=
ŸŸA B
EncryptPayload
   
(
   
protocolSystem
   -
,
  - .
plainBuffer
  / :
)
  : ;
;
  ; <
if
¢¢ 
(
¢¢ 
encryptResult
¢¢ 
.
¢¢ 
IsErr
¢¢ #
)
¢¢# $
{
££ 
return
¤¤ 
Result
¤¤ 
<
¤¤ 
Unit
¤¤ "
,
¤¤" #
NetworkFailure
¤¤$ 2
>
¤¤2 3
.
¤¤3 4
Err
¤¤4 7
(
¤¤7 8
encryptResult
¤¤8 E
.
¤¤E F
	UnwrapErr
¤¤F O
(
¤¤O P
)
¤¤P Q
)
¤¤Q R
;
¤¤R S
}
¥¥ 
SecureEnvelope
§§ 
encryptedPayload
§§ +
=
§§, -
encryptResult
§§. ;
.
§§; <
Unwrap
§§< B
(
§§B C
)
§§C D
;
§§D E
string
¨¨ "
stableIdempotencyKey
¨¨ '
=
¨¨( )
Guid
¨¨* .
.
¨¨. /
NewGuid
¨¨/ 6
(
¨¨6 7
)
¨¨7 8
.
¨¨8 9
ToString
¨¨9 A
(
¨¨A B
$str
¨¨B E
)
¨¨E F
;
¨¨F G
invokeResult
ªª 
=
ªª 
await
ªª  
retryStrategy
ªª! .
.
ªª. /&
ExecuteRpcOperationAsync
ªª/ G
(
ªªG H
(
«« 
attempt
«« 
,
«« 
ct
«« 
)
«« 
=>
««  
{
¬¬ 
RpcRequestContext
­­ %
attemptContext
­­& 4
=
­­5 6
RpcRequestContext
®® )
.
®®) *$
CreateNewWithStableKey
®®* @
(
®®@ A"
stableIdempotencyKey
®®A U
,
®®U V
attempt
®®W ^
)
®®^ _
;
®®_ ` 
lastRequestContext
¯¯ &
=
¯¯' (
attemptContext
¯¯) 7
;
¯¯7 8
ServiceRequest
±± "
request
±±# *
=
±±+ ,
ServiceRequest
±±- ;
.
±±; <
New
±±< ?
(
±±? @ 
logicalOperationId
²² *
,
²²* +
flowType
³³  
,
³³  !
serviceType
´´ #
,
´´# $
encryptedPayload
µµ (
,
µµ( )
[
¶¶ 
]
¶¶ 
,
¶¶ 
attemptContext
·· &
)
··& '
;
··' (
return
¹¹ 
rpcServiceManager
¹¹ ,
.
¹¹, -'
InvokeServiceRequestAsync
¹¹- F
(
¹¹F G
request
¹¹G N
,
¹¹N O
ct
¹¹P R
)
¹¹R S
;
¹¹S T
}
ºº 
,
ºº 
$"
»» 
$str
»» 
{
»»  
serviceType
»»  +
}
»»+ ,
"
»», -
,
»»- .
	connectId
¼¼ 
,
¼¼ 
serviceType
½½ 
:
½½ 
serviceType
½½ (
,
½½( )

maxRetries
¾¾ 
:
¾¾ 
Math
¾¾  
.
¾¾  !
Max
¾¾! $
(
¾¾$ %
$num
¾¾% &
,
¾¾& '
retryBehavior
¾¾( 5
.
¾¾5 6
MAX_ATTEMPTS
¾¾6 B
-
¾¾C D
$num
¾¾E F
)
¾¾F G
,
¾¾G H
cancellationToken
¿¿ !
:
¿¿! "
token
¿¿# (
)
¿¿( )
.
¿¿) *
ConfigureAwait
¿¿* 8
(
¿¿8 9
false
¿¿9 >
)
¿¿> ?
;
¿¿? @
}
ÀÀ 	
else
ÁÁ 
{
ÂÂ 	
RpcRequestContext
ÃÃ "
singleAttemptContext
ÃÃ 2
=
ÃÃ3 4
RpcRequestContext
ÃÃ5 F
.
ÃÃF G
	CreateNew
ÃÃG P
(
ÃÃP Q
)
ÃÃQ R
;
ÃÃR S 
lastRequestContext
ÄÄ 
=
ÄÄ  "
singleAttemptContext
ÄÄ! 5
;
ÄÄ5 6
Result
ÆÆ 
<
ÆÆ 
ServiceRequest
ÆÆ !
,
ÆÆ! "
NetworkFailure
ÆÆ# 1
>
ÆÆ1 2"
serviceRequestResult
ÆÆ3 G
=
ÆÆH I 
BuildRequestWithId
ÆÆJ \
(
ÆÆ\ ]
protocolSystem
ÇÇ 
,
ÇÇ  
logicalOperationId
ÇÇ  2
,
ÇÇ2 3
serviceType
ÇÇ4 ?
,
ÇÇ? @
plainBuffer
ÇÇA L
,
ÇÇL M
flowType
ÇÇN V
,
ÇÇV W"
singleAttemptContext
ÇÇX l
)
ÇÇl m
;
ÇÇm n
if
ÉÉ 
(
ÉÉ "
serviceRequestResult
ÉÉ $
.
ÉÉ$ %
IsErr
ÉÉ% *
)
ÉÉ* +
{
ÊÊ 
return
ËË 
Result
ËË 
<
ËË 
Unit
ËË "
,
ËË" #
NetworkFailure
ËË$ 2
>
ËË2 3
.
ËË3 4
Err
ËË4 7
(
ËË7 8"
serviceRequestResult
ËË8 L
.
ËËL M
	UnwrapErr
ËËM V
(
ËËV W
)
ËËW X
)
ËËX Y
;
ËËY Z
}
ÌÌ 
ServiceRequest
ÎÎ 
request
ÎÎ "
=
ÎÎ# $"
serviceRequestResult
ÎÎ% 9
.
ÎÎ9 :
Unwrap
ÎÎ: @
(
ÎÎ@ A
)
ÎÎA B
;
ÎÎB C
invokeResult
ÏÏ 
=
ÏÏ 
await
ÏÏ  
rpcServiceManager
ÏÏ! 2
.
ÏÏ2 3'
InvokeServiceRequestAsync
ÏÏ3 L
(
ÏÏL M
request
ÏÏM T
,
ÏÏT U
token
ÏÏV [
)
ÏÏ[ \
.
ÏÏ\ ]
ConfigureAwait
ÏÏ] k
(
ÏÏk l
false
ÏÏl q
)
ÏÏq r
;
ÏÏr s
}
ÐÐ 	
if
ÒÒ 

(
ÒÒ 
invokeResult
ÒÒ 
.
ÒÒ 
IsErr
ÒÒ 
)
ÒÒ 
{
ÓÓ 	
NetworkFailure
ÔÔ 
failure
ÔÔ "
=
ÔÔ# $
AttachCorrelation
ÔÔ% 6
(
ÔÔ6 7
invokeResult
ÔÔ7 C
.
ÔÔC D
	UnwrapErr
ÔÔD M
(
ÔÔM N
)
ÔÔN O
,
ÔÔO P 
lastRequestContext
ÔÔQ c
)
ÔÔc d
;
ÔÔd e
failure
ÕÕ 
=
ÕÕ !
ApplyReinitIfNeeded
ÕÕ )
(
ÕÕ) *
failure
ÕÕ* 1
,
ÕÕ1 2
serviceType
ÕÕ3 >
,
ÕÕ> ?
retryBehavior
ÕÕ@ M
)
ÕÕM N
;
ÕÕN O
return
ÖÖ 
Result
ÖÖ 
<
ÖÖ 
Unit
ÖÖ 
,
ÖÖ 
NetworkFailure
ÖÖ  .
>
ÖÖ. /
.
ÖÖ/ 0
Err
ÖÖ0 3
(
ÖÖ3 4
failure
ÖÖ4 ;
)
ÖÖ; <
;
ÖÖ< =
}
×× 	
RpcFlow
ÙÙ 
flow
ÙÙ 
=
ÙÙ 
invokeResult
ÙÙ #
.
ÙÙ# $
Unwrap
ÙÙ$ *
(
ÙÙ* +
)
ÙÙ+ ,
;
ÙÙ, -
if
ÚÚ 

(
ÚÚ 
flow
ÚÚ 
is
ÚÚ 
not
ÚÚ 
RpcFlow
ÚÚ 
.
ÚÚ  

SingleCall
ÚÚ  *

singleCall
ÚÚ+ 5
)
ÚÚ5 6
{
ÛÛ 	
return
ÜÜ 
Result
ÜÜ 
<
ÜÜ 
Unit
ÜÜ 
,
ÜÜ 
NetworkFailure
ÜÜ  .
>
ÜÜ. /
.
ÜÜ/ 0
Err
ÜÜ0 3
(
ÜÜ3 4
NetworkFailure
ÝÝ 
.
ÝÝ  
InvalidRequestType
ÝÝ 1
(
ÝÝ1 2
$"
ÝÝ2 4
$str
ÝÝ4 Z
{
ÝÝZ [
flow
ÝÝ[ _
.
ÝÝ_ `
GetType
ÝÝ` g
(
ÝÝg h
)
ÝÝh i
.
ÝÝi j
Name
ÝÝj n
}
ÝÝn o
"
ÝÝo p
)
ÝÝp q
)
ÝÝq r
;
ÝÝr s
}
ÞÞ 	
Result
àà 
<
àà 
SecureEnvelope
àà 
,
àà 
NetworkFailure
àà -
>
àà- .

callResult
àà/ 9
=
àà: ;
await
àà< A

singleCall
ààB L
.
ààL M
Result
ààM S
.
ààS T
ConfigureAwait
ààT b
(
ààb c
false
ààc h
)
ààh i
;
àài j
if
áá 

(
áá 

callResult
áá 
.
áá 
IsErr
áá 
)
áá 
{
ââ 	
NetworkFailure
ãã 
failure
ãã "
=
ãã# $
AttachCorrelation
ãã% 6
(
ãã6 7

callResult
ãã7 A
.
ããA B
	UnwrapErr
ããB K
(
ããK L
)
ããL M
,
ããM N 
lastRequestContext
ããO a
)
ããa b
;
ããb c
failure
ää 
=
ää !
ApplyReinitIfNeeded
ää )
(
ää) *
failure
ää* 1
,
ää1 2
serviceType
ää3 >
,
ää> ?
retryBehavior
ää@ M
)
ääM N
;
ääN O
return
åå 
Result
åå 
<
åå 
Unit
åå 
,
åå 
NetworkFailure
åå  .
>
åå. /
.
åå/ 0
Err
åå0 3
(
åå3 4
failure
åå4 ;
)
åå; <
;
åå< =
}
ææ 	
SecureEnvelope
èè 
inboundPayload
èè %
=
èè& '

callResult
èè( 2
.
èè2 3
Unwrap
èè3 9
(
èè9 :
)
èè: ;
;
èè; <
Result
êê 
<
êê 
byte
êê 
[
êê 
]
êê 
,
êê %
EcliptixProtocolFailure
êê .
>
êê. /
decryptedData
êê0 =
=
êê> ?
protocolSystem
ëë 
.
ëë $
ProcessInboundEnvelope
ëë 1
(
ëë1 2
inboundPayload
ëë2 @
)
ëë@ A
;
ëëA B
if
ìì 

(
ìì 
decryptedData
ìì 
.
ìì 
IsErr
ìì 
)
ìì  
{
íí 	
Log
îî 
.
îî 
Error
îî 
(
îî 
$str
îî P
,
îîP Q
decryptedData
îîR _
.
îî_ `
	UnwrapErr
îî` i
(
îîi j
)
îîj k
.
îîk l
Message
îîl s
)
îîs t
;
îît u
NetworkFailure
ïï 
decryptFailure
ïï )
=
ïï* +
decryptedData
ïï, 9
.
ïï9 :
	UnwrapErr
ïï: C
(
ïïC D
)
ïïD E
.
ïïE F
ToNetworkFailure
ïïF V
(
ïïV W
)
ïïW X
;
ïïX Y
decryptFailure
ðð 
=
ðð !
ApplyReinitIfNeeded
ðð 0
(
ðð0 1
decryptFailure
ðð1 ?
,
ðð? @
serviceType
ððA L
,
ððL M
retryBehavior
ððN [
)
ðð[ \
;
ðð\ ]
return
ññ 
Result
ññ 
<
ññ 
Unit
ññ 
,
ññ 
NetworkFailure
ññ  .
>
ññ. /
.
ññ/ 0
Err
ññ0 3
(
ññ3 4
decryptFailure
ññ4 B
)
ññB C
;
ññC D
}
òò 	
await
ôô 
onCompleted
ôô 
(
ôô 
decryptedData
ôô '
.
ôô' (
Unwrap
ôô( .
(
ôô. /
)
ôô/ 0
)
ôô0 1
.
ôô1 2
ConfigureAwait
ôô2 @
(
ôô@ A
false
ôôA F
)
ôôF G
;
ôôG H
return
õõ 
Result
õõ 
<
õõ 
Unit
õõ 
,
õõ 
NetworkFailure
õõ *
>
õõ* +
.
õõ+ ,
Ok
õõ, .
(
õõ. /
Unit
õõ/ 3
.
õõ3 4
Value
õõ4 9
)
õõ9 :
;
õõ: ;
}
öö 
private
øø 
static
øø 
NetworkFailure
øø !
AttachCorrelation
øø" 3
(
øø3 4
NetworkFailure
øø4 B
failure
øøC J
,
øøJ K
RpcRequestContext
øøL ]
?
øø] ^
context
øø_ f
)
øøf g
{
ùù 
if
úú 

(
úú 
context
úú 
==
úú 
null
úú 
)
úú 
{
ûû 	
return
üü 
failure
üü 
;
üü 
}
ýý 	
if
ÿÿ 

(
ÿÿ 
failure
ÿÿ 
.
ÿÿ 
	UserError
ÿÿ 
is
ÿÿ  
{
ÿÿ! "
}
ÿÿ# $
	userError
ÿÿ% .
&&
ÿÿ/ 1
string
ÿÿ2 8
.
ÿÿ8 9 
IsNullOrWhiteSpace
ÿÿ9 K
(
ÿÿK L
	userError
ÿÿL U
.
ÿÿU V
CorrelationId
ÿÿV c
)
ÿÿc d
)
ÿÿd e
{
€	€	 	
return
		 
failure
		 
with
		 
{
		  !
	UserError
		" +
=
		, -
	userError
		. 7
with
		8 <
{
		= >
CorrelationId
		? L
=
		M N
context
		O V
.
		V W
CorrelationId
		W d
}
		e f
}
		g h
;
		h i
}
‚	‚	 	
return
„	„	 
failure
„	„	 
;
„	„	 
}
…	…	 
private
‡	‡	 
static
‡	‡	 
bool
‡	‡	 !
IsCompleteOperation
‡	‡	 +
(
‡	‡	+ ,
RpcServiceType
‡	‡	, :
serviceType
‡	‡	; F
)
‡	‡	F G
{
ˆ	ˆ	 
return
‰	‰	 
serviceType
‰	‰	 
is
‰	‰	 
RpcServiceType
Š	Š	 
.
Š	Š	 "
RegistrationComplete
Š	Š	 /
or
Š	Š	0 2
RpcServiceType
‹	‹	 
.
‹	‹	 '
RecoverySecretKeyComplete
‹	‹	 4
or
‹	‹	5 7
RpcServiceType
Œ	Œ	 
.
Œ	Œ	 #
SignInCompleteRequest
Œ	Œ	 0
;
Œ	Œ	0 1
}
		 
private
		 
static
		 
bool
		 #
ShouldReinitOnFailure
		 -
(
		- .
NetworkFailure
		. <
failure
		= D
)
		D E
{
		 
return
‘	‘	 
failure
‘	‘	 
.
‘	‘	 
FailureType
‘	‘	 "
is
‘	‘	# % 
NetworkFailureType
’	’	 
.
’	’	 (
DATA_CENTER_NOT_RESPONDING
’	’	 9
or
’	’	: < 
NetworkFailureType
“	“	 
.
“	“	 "
DATA_CENTER_SHUTDOWN
“	“	 3
or
“	“	4 6 
NetworkFailureType
”	”	 
.
”	”	 %
PROTOCOL_STATE_MISMATCH
”	”	 6
;
”	”	6 7
}
•	•	 
private
—	—	 
static
—	—	 
NetworkFailure
—	—	 !!
ApplyReinitIfNeeded
—	—	" 5
(
—	—	5 6
NetworkFailure
˜	˜	 
failure
˜	˜	 
,
˜	˜	 
RpcServiceType
™	™	 
serviceType
™	™	 "
,
™	™	" #
RetryBehavior
š	š	 
retryBehavior
š	š	 #
)
š	š	# $
{
›	›	 
if
œ	œ	 

(
œ	œ	 !
IsCompleteOperation
œ	œ	 
(
œ	œ	  
serviceType
œ	œ	  +
)
œ	œ	+ ,
&&
œ	œ	- /
retryBehavior
		 
.
		 %
ReinitOnCompleteFailure
		 1
&&
		2 4#
ShouldReinitOnFailure
ž	ž	 !
(
ž	ž	! "
failure
ž	ž	" )
)
ž	ž	) *
)
ž	ž	* +
{
Ÿ	Ÿ	 	
return
 	 	 
failure
 	 	 
with
 	 	 
{
 	 	  !
RequiresReinit
 	 	" 0
=
 	 	1 2
true
 	 	3 7
}
 	 	8 9
;
 	 	9 :
}
¡	¡	 	
return
£	£	 
failure
£	£	 
;
£	£	 
}
¤	¤	 
private
¦	¦	 
async
¦	¦	 
Task
¦	¦	 
<
¦	¦	 
Result
¦	¦	 
<
¦	¦	 
Unit
¦	¦	 "
,
¦	¦	" #
NetworkFailure
¦	¦	$ 2
>
¦	¦	2 3
>
¦	¦	3 4+
SendReceiveStreamRequestAsync
¦	¦	5 R
(
¦	¦	R S$
EcliptixProtocolSystem
§	§	 
protocolSystem
§	§	 -
,
§	§	- .
uint
¨	¨	  
logicalOperationId
¨	¨	 
,
¨	¨	  
RpcServiceType
©	©	 
serviceType
©	©	 "
,
©	©	" #
byte
ª	ª	 
[
ª	ª	 
]
ª	ª	 
plainBuffer
ª	ª	 
,
ª	ª	 
ServiceFlowType
«	«	 
flowType
«	«	  
,
«	«	  !
RpcRequestContext
¬	¬	 
requestContext
¬	¬	 (
,
¬	¬	( )
Func
­	­	 
<
­	­	 
byte
­	­	 
[
­	­	 
]
­	­	 
,
­	­	 
Task
­	­	 
<
­	­	 
Result
­	­	  
<
­	­	  !
Unit
­	­	! %
,
­	­	% &
NetworkFailure
­	­	' 5
>
­	­	5 6
>
­	­	6 7
>
­	­	7 8
onStreamItem
­	­	9 E
,
­	­	E F
RetryBehavior
®	®	 
retryBehavior
®	®	 #
,
®	®	# $
uint
¯	¯	 
	connectId
¯	¯	 
,
¯	¯	 
CancellationToken
°	°	 
token
°	°	 
)
°	°	  
{
±	±	 
if
²	²	 

(
²	²	 
retryBehavior
²	²	 
.
²	²	 
ShouldRetry
²	²	 %
)
²	²	% &
{
³	³	 	
Result
´	´	 
<
´	´	 
SecureEnvelope
´	´	 !
,
´	´	! "
NetworkFailure
´	´	# 1
>
´	´	1 2
encryptResult
´	´	3 @
=
´	´	A B
EncryptPayload
µ	µ	 
(
µ	µ	 
protocolSystem
µ	µ	 -
,
µ	µ	- .
plainBuffer
µ	µ	/ :
)
µ	µ	: ;
;
µ	µ	; <
if
·	·	 
(
·	·	 
encryptResult
·	·	 
.
·	·	 
IsErr
·	·	 #
)
·	·	# $
{
¸	¸	 
return
¹	¹	 
Result
¹	¹	 
<
¹	¹	 
Unit
¹	¹	 "
,
¹	¹	" #
NetworkFailure
¹	¹	$ 2
>
¹	¹	2 3
.
¹	¹	3 4
Err
¹	¹	4 7
(
¹	¹	7 8
encryptResult
¹	¹	8 E
.
¹	¹	E F
	UnwrapErr
¹	¹	F O
(
¹	¹	O P
)
¹	¹	P Q
)
¹	¹	Q R
;
¹	¹	R S
}
º	º	 
SecureEnvelope
¼	¼	 
encryptedPayload
¼	¼	 +
=
¼	¼	, -
encryptResult
¼	¼	. ;
.
¼	¼	; <
Unwrap
¼	¼	< B
(
¼	¼	B C
)
¼	¼	C D
;
¼	¼	D E
string
½	½	 "
stableIdempotencyKey
½	½	 '
=
½	½	( )
requestContext
½	½	* 8
.
½	½	8 9
IdempotencyKey
½	½	9 G
;
½	½	G H
return
¿	¿	 
await
¿	¿	 
retryStrategy
¿	¿	 &
.
¿	¿	& '&
ExecuteRpcOperationAsync
¿	¿	' ?
(
¿	¿	? @
async
À	À	 
(
À	À	 
attempt
À	À	 
,
À	À	 
ct
À	À	  "
)
À	À	" #
=>
À	À	$ &
{
Á	Á	 
RpcRequestContext
Â	Â	 %
attemptContext
Â	Â	& 4
=
Â	Â	5 6
RpcRequestContext
Ã	Ã	 )
.
Ã	Ã	) *$
CreateNewWithStableKey
Ã	Ã	* @
(
Ã	Ã	@ A"
stableIdempotencyKey
Ã	Ã	A U
,
Ã	Ã	U V
attempt
Ã	Ã	W ^
)
Ã	Ã	^ _
;
Ã	Ã	_ `
ServiceRequest
Å	Å	 "
request
Å	Å	# *
=
Å	Å	+ ,
ServiceRequest
Å	Å	- ;
.
Å	Å	; <
New
Å	Å	< ?
(
Å	Å	? @ 
logicalOperationId
Æ	Æ	 *
,
Æ	Æ	* +
flowType
Ç	Ç	  
,
Ç	Ç	  !
serviceType
È	È	 #
,
È	È	# $
encryptedPayload
É	É	 (
,
É	É	( )
[
Ê	Ê	 
]
Ê	Ê	 
,
Ê	Ê	 
attemptContext
Ë	Ë	 &
)
Ë	Ë	& '
;
Ë	Ë	' (
Result
Í	Í	 
<
Í	Í	 
Unit
Í	Í	 
,
Í	Í	  
NetworkFailure
Í	Í	! /
>
Í	Í	/ 0
processResult
Í	Í	1 >
=
Í	Í	? @
await
Í	Í	A F&
ProcessStreamWithRequest
Í	Í	G _
(
Í	Í	_ `
protocolSystem
Î	Î	 &
,
Î	Î	& '
request
Î	Î	( /
,
Î	Î	/ 0
onStreamItem
Î	Î	1 =
,
Î	Î	= >
	connectId
Î	Î	? H
,
Î	Î	H I
ct
Î	Î	J L
)
Î	Î	L M
.
Î	Î	M N
ConfigureAwait
Î	Î	N \
(
Î	Î	\ ]
false
Î	Î	] b
)
Î	Î	b c
;
Î	Î	c d
return
Ð	Ð	 
processResult
Ð	Ð	 (
;
Ð	Ð	( )
}
Ñ	Ñ	 
,
Ñ	Ñ	 
$"
Ò	Ò	 
$str
Ò	Ò	  
{
Ò	Ò	  !
serviceType
Ò	Ò	! ,
}
Ò	Ò	, -
"
Ò	Ò	- .
,
Ò	Ò	. /
	connectId
Ó	Ó	 
,
Ó	Ó	 
serviceType
Ô	Ô	 
:
Ô	Ô	 
serviceType
Ô	Ô	 (
,
Ô	Ô	( )

maxRetries
Õ	Õ	 
:
Õ	Õ	 
Math
Õ	Õ	  
.
Õ	Õ	  !
Max
Õ	Õ	! $
(
Õ	Õ	$ %
$num
Õ	Õ	% &
,
Õ	Õ	& '
retryBehavior
Õ	Õ	( 5
.
Õ	Õ	5 6
MAX_ATTEMPTS
Õ	Õ	6 B
-
Õ	Õ	C D
$num
Õ	Õ	E F
)
Õ	Õ	F G
,
Õ	Õ	G H
cancellationToken
Ö	Ö	 !
:
Ö	Ö	! "
token
Ö	Ö	# (
)
Ö	Ö	( )
.
Ö	Ö	) *
ConfigureAwait
Ö	Ö	* 8
(
Ö	Ö	8 9
false
Ö	Ö	9 >
)
Ö	Ö	> ?
;
Ö	Ö	? @
}
×	×	 	
Result
Ù	Ù	 
<
Ù	Ù	 
ServiceRequest
Ù	Ù	 
,
Ù	Ù	 
NetworkFailure
Ù	Ù	 -
>
Ù	Ù	- ."
serviceRequestResult
Ù	Ù	/ C
=
Ù	Ù	D E 
BuildRequestWithId
Ù	Ù	F X
(
Ù	Ù	X Y
protocolSystem
Ú	Ú	 
,
Ú	Ú	  
logicalOperationId
Ú	Ú	 .
,
Ú	Ú	. /
serviceType
Ú	Ú	0 ;
,
Ú	Ú	; <
plainBuffer
Ú	Ú	= H
,
Ú	Ú	H I
flowType
Ú	Ú	J R
,
Ú	Ú	R S
requestContext
Ú	Ú	T b
)
Ú	Ú	b c
;
Ú	Ú	c d
if
Ü	Ü	 

(
Ü	Ü	 "
serviceRequestResult
Ü	Ü	  
.
Ü	Ü	  !
IsErr
Ü	Ü	! &
)
Ü	Ü	& '
{
Ý	Ý	 	
return
Þ	Þ	 
Result
Þ	Þ	 
<
Þ	Þ	 
Unit
Þ	Þ	 
,
Þ	Þ	 
NetworkFailure
Þ	Þ	  .
>
Þ	Þ	. /
.
Þ	Þ	/ 0
Err
Þ	Þ	0 3
(
Þ	Þ	3 4"
serviceRequestResult
Þ	Þ	4 H
.
Þ	Þ	H I
	UnwrapErr
Þ	Þ	I R
(
Þ	Þ	R S
)
Þ	Þ	S T
)
Þ	Þ	T U
;
Þ	Þ	U V
}
ß	ß	 	
ServiceRequest
á	á	 
request
á	á	 
=
á	á	  "
serviceRequestResult
á	á	! 5
.
á	á	5 6
Unwrap
á	á	6 <
(
á	á	< =
)
á	á	= >
;
á	á	> ?
return
â	â	 
await
â	â	 &
ProcessStreamWithRequest
â	â	 -
(
â	â	- .
protocolSystem
â	â	. <
,
â	â	< =
request
â	â	> E
,
â	â	E F
onStreamItem
â	â	G S
,
â	â	S T
	connectId
â	â	U ^
,
â	â	^ _
token
â	â	` e
)
â	â	e f
.
ã	ã	 
ConfigureAwait
ã	ã	 
(
ã	ã	 
false
ã	ã	 !
)
ã	ã	! "
;
ã	ã	" #
}
ä	ä	 
private
æ	æ	 
async
æ	æ	 
Task
æ	æ	 
<
æ	æ	 
Result
æ	æ	 
<
æ	æ	 
Unit
æ	æ	 "
,
æ	æ	" #
NetworkFailure
æ	æ	$ 2
>
æ	æ	2 3
>
æ	æ	3 4&
ProcessStreamWithRequest
æ	æ	5 M
(
æ	æ	M N$
EcliptixProtocolSystem
ç	ç	 
protocolSystem
ç	ç	 -
,
ç	ç	- .
ServiceRequest
è	è	 
request
è	è	 
,
è	è	 
Func
é	é	 
<
é	é	 
byte
é	é	 
[
é	é	 
]
é	é	 
,
é	é	 
Task
é	é	 
<
é	é	 
Result
é	é	  
<
é	é	  !
Unit
é	é	! %
,
é	é	% &
NetworkFailure
é	é	' 5
>
é	é	5 6
>
é	é	6 7
>
é	é	7 8
onStreamItem
é	é	9 E
,
é	é	E F
uint
ê	ê	 
	connectId
ê	ê	 
,
ê	ê	 
CancellationToken
ë	ë	 
token
ë	ë	 
)
ë	ë	  
{
ì	ì	 
if
í	í	 

(
í	í	 
	connectId
í	í	 
==
í	í	 
$num
í	í	 
)
í	í	 
{
î	î	 	
return
ï	ï	 
await
ï	ï	 #
ProcessStreamDirectly
ï	ï	 .
(
ï	ï	. /
protocolSystem
ï	ï	/ =
,
ï	ï	= >
request
ï	ï	? F
,
ï	ï	F G
onStreamItem
ï	ï	H T
,
ï	ï	T U
token
ï	ï	V [
)
ï	ï	[ \
.
ï	ï	\ ]
ConfigureAwait
ï	ï	] k
(
ï	ï	k l
false
ï	ï	l q
)
ï	ï	q r
;
ï	ï	r s
}
ð	ð	 	
using
ò	ò	 %
CancellationTokenSource
ò	ò	 %
linkedTokenSource
ò	ò	& 7
=
ò	ò	8 9%
CancellationTokenSource
ò	ò	: Q
.
ò	ò	Q R%
CreateLinkedTokenSource
ò	ò	R i
(
ò	ò	i j
token
ò	ò	j o
)
ò	ò	o p
;
ò	ò	p q
_activeStreams
ó	ó	 
.
ó	ó	 
TryAdd
ó	ó	 
(
ó	ó	 
	connectId
ó	ó	 '
,
ó	ó	' (
linkedTokenSource
ó	ó	) :
)
ó	ó	: ;
;
ó	ó	; <
Result
õ	õ	 
<
õ	õ	 
RpcFlow
õ	õ	 
,
õ	õ	 
NetworkFailure
õ	õ	 &
>
õ	õ	& '
invokeResult
õ	õ	( 4
=
õ	õ	5 6
await
ö	ö	 
rpcServiceManager
ö	ö	 #
.
ö	ö	# $'
InvokeServiceRequestAsync
ö	ö	$ =
(
ö	ö	= >
request
ö	ö	> E
,
ö	ö	E F
linkedTokenSource
ö	ö	G X
.
ö	ö	X Y
Token
ö	ö	Y ^
)
ö	ö	^ _
.
ö	ö	_ `
ConfigureAwait
ö	ö	` n
(
ö	ö	n o
false
ö	ö	o t
)
ö	ö	t u
;
ö	ö	u v
if
ø	ø	 

(
ø	ø	 
invokeResult
ø	ø	 
.
ø	ø	 
IsErr
ø	ø	 
)
ø	ø	 
{
ù	ù	 	
return
ú	ú	 
Result
ú	ú	 
<
ú	ú	 
Unit
ú	ú	 
,
ú	ú	 
NetworkFailure
ú	ú	  .
>
ú	ú	. /
.
ú	ú	/ 0
Err
ú	ú	0 3
(
ú	ú	3 4
invokeResult
ú	ú	4 @
.
ú	ú	@ A
	UnwrapErr
ú	ú	A J
(
ú	ú	J K
)
ú	ú	K L
)
ú	ú	L M
;
ú	ú	M N
}
û	û	 	
Result
ý	ý	 
<
ý	ý	 
RpcFlow
ý	ý	 
.
ý	ý	 
InboundStream
ý	ý	 $
,
ý	ý	$ %
NetworkFailure
ý	ý	& 4
>
ý	ý	4 5
streamResult
ý	ý	6 B
=
ý	ý	C D 
ValidateStreamFlow
ý	ý	E W
(
ý	ý	W X
invokeResult
ý	ý	X d
.
ý	ý	d e
Unwrap
ý	ý	e k
(
ý	ý	k l
)
ý	ý	l m
)
ý	ý	m n
;
ý	ý	n o
if
þ	þ	 

(
þ	þ	 
streamResult
þ	þ	 
.
þ	þ	 
IsErr
þ	þ	 
)
þ	þ	 
{
ÿ	ÿ	 	
return
€
€
 
Result
€
€
 
<
€
€
 
Unit
€
€
 
,
€
€
 
NetworkFailure
€
€
  .
>
€
€
. /
.
€
€
/ 0
Err
€
€
0 3
(
€
€
3 4
streamResult
€
€
4 @
.
€
€
@ A
	UnwrapErr
€
€
A J
(
€
€
J K
)
€
€
K L
)
€
€
L M
;
€
€
M N
}


 	
RpcFlow
ƒ
ƒ
 
.
ƒ
ƒ
 
InboundStream
ƒ
ƒ
 
inboundStream
ƒ
ƒ
 +
=
ƒ
ƒ
, -
streamResult
ƒ
ƒ
. :
.
ƒ
ƒ
: ;
Unwrap
ƒ
ƒ
; A
(
ƒ
ƒ
A B
)
ƒ
ƒ
B C
;
ƒ
ƒ
C D
try
…
…
 
{
†
†
 	
await
‡
‡
 
foreach
‡
‡
 
(
‡
‡
 
Result
‡
‡
 !
<
‡
‡
! "
SecureEnvelope
‡
‡
" 0
,
‡
‡
0 1
NetworkFailure
‡
‡
2 @
>
‡
‡
@ A

streamItem
‡
‡
B L
in
‡
‡
M O
inboundStream
ˆ
ˆ
 (
.
ˆ
ˆ
( )
Stream
ˆ
ˆ
) /
.
ˆ
ˆ
/ 0
WithCancellation
ˆ
ˆ
0 @
(
ˆ
ˆ
@ A
linkedTokenSource
ˆ
ˆ
A R
.
ˆ
ˆ
R S
Token
ˆ
ˆ
S X
)
ˆ
ˆ
X Y
)
ˆ
ˆ
Y Z
{
‰
‰
 
if
Š
Š
 
(
Š
Š
 

streamItem
Š
Š
 
.
Š
Š
 
IsErr
Š
Š
 $
)
Š
Š
$ %
{
‹
‹
 
NetworkFailure
Œ
Œ
 "
failure
Œ
Œ
# *
=
Œ
Œ
+ ,

streamItem
Œ
Œ
- 7
.
Œ
Œ
7 8
	UnwrapErr
Œ
Œ
8 A
(
Œ
Œ
A B
)
Œ
Œ
B C
;
Œ
Œ
C D
NotifyStreamError


 %
(


% &
failure


& -
,


- .
	connectId


/ 8
)


8 9
;


9 :
return
Ž
Ž
 
Result
Ž
Ž
 !
<
Ž
Ž
! "
Unit
Ž
Ž
" &
,
Ž
Ž
& '
NetworkFailure
Ž
Ž
( 6
>
Ž
Ž
6 7
.
Ž
Ž
7 8
Err
Ž
Ž
8 ;
(
Ž
Ž
; <
failure
Ž
Ž
< C
)
Ž
Ž
C D
;
Ž
Ž
D E
}


 
SecureEnvelope
‘
‘
 
streamPayload
‘
‘
 ,
=
‘
‘
- .

streamItem
‘
‘
/ 9
.
‘
‘
9 :
Unwrap
‘
‘
: @
(
‘
‘
@ A
)
‘
‘
A B
;
‘
‘
B C
await
’
’
 $
ProcessStreamItemAsync
’
’
 ,
(
’
’
, -
streamPayload
’
’
- :
,
’
’
: ;
protocolSystem
’
’
< J
,
’
’
J K
onStreamItem
’
’
L X
)
’
’
X Y
.
’
’
Y Z
ConfigureAwait
’
’
Z h
(
’
’
h i
false
’
’
i n
)
’
’
n o
;
’
’
o p
}
“
“
 
}
”
”
 	
catch
•
•
 
(
•
•
 (
OperationCanceledException
•
•
 )
)
•
•
) *
when
•
•
+ /
(
•
•
0 1
linkedTokenSource
•
•
1 B
.
•
•
B C
Token
•
•
C H
.
•
•
H I%
IsCancellationRequested
•
•
I `
)
•
•
` a
{
–
–
 	
}
—
—
 	
finally
˜
˜
 
{
™
™
 	!
CleanupActiveStream
š
š
 
(
š
š
  
	connectId
š
š
  )
)
š
š
) *
;
š
š
* +
}
›
›
 	!
NotifyStreamSuccess


 
(


 
	connectId


 %
)


% &
;


& '
return
Ÿ
Ÿ
 
Result
Ÿ
Ÿ
 
<
Ÿ
Ÿ
 
Unit
Ÿ
Ÿ
 
,
Ÿ
Ÿ
 
NetworkFailure
Ÿ
Ÿ
 *
>
Ÿ
Ÿ
* +
.
Ÿ
Ÿ
+ ,
Ok
Ÿ
Ÿ
, .
(
Ÿ
Ÿ
. /
Unit
Ÿ
Ÿ
/ 3
.
Ÿ
Ÿ
3 4
Value
Ÿ
Ÿ
4 9
)
Ÿ
Ÿ
9 :
;
Ÿ
Ÿ
: ;
}
 
 
 
private
¢
¢
 
static
¢
¢
 
Result
¢
¢
 
<
¢
¢
 
RpcFlow
¢
¢
 !
.
¢
¢
! "
InboundStream
¢
¢
" /
,
¢
¢
/ 0
NetworkFailure
¢
¢
1 ?
>
¢
¢
? @ 
ValidateStreamFlow
¢
¢
A S
(
¢
¢
S T
RpcFlow
¢
¢
T [
flow
¢
¢
\ `
)
¢
¢
` a
{
£
£
 
if
¤
¤
 

(
¤
¤
 
flow
¤
¤
 
is
¤
¤
 
not
¤
¤
 
RpcFlow
¤
¤
 
.
¤
¤
  
InboundStream
¤
¤
  -
inboundStream
¤
¤
. ;
)
¤
¤
; <
{
¥
¥
 	
return
¦
¦
 
Result
¦
¦
 
<
¦
¦
 
RpcFlow
¦
¦
 !
.
¦
¦
! "
InboundStream
¦
¦
" /
,
¦
¦
/ 0
NetworkFailure
¦
¦
1 ?
>
¦
¦
? @
.
¦
¦
@ A
Err
¦
¦
A D
(
¦
¦
D E
NetworkFailure
§
§
 
.
§
§
  
InvalidRequestType
§
§
 1
(
§
§
1 2
$"
§
§
2 4
$str
§
§
4 ]
{
§
§
] ^
flow
§
§
^ b
.
§
§
b c
GetType
§
§
c j
(
§
§
j k
)
§
§
k l
.
§
§
l m
Name
§
§
m q
}
§
§
q r
"
§
§
r s
)
§
§
s t
)
§
§
t u
;
§
§
u v
}
¨
¨
 	
return
ª
ª
 
Result
ª
ª
 
<
ª
ª
 
RpcFlow
ª
ª
 
.
ª
ª
 
InboundStream
ª
ª
 +
,
ª
ª
+ ,
NetworkFailure
ª
ª
- ;
>
ª
ª
; <
.
ª
ª
< =
Ok
ª
ª
= ?
(
ª
ª
? @
inboundStream
ª
ª
@ M
)
ª
ª
M N
;
ª
ª
N O
}
«
«
 
private
­
­
 
void
­
­
 
NotifyStreamError
­
­
 "
(
­
­
" #
NetworkFailure
­
­
# 1
failure
­
­
2 9
,
­
­
9 :
uint
­
­
; ?
	connectId
­
­
@ I
)
­
­
I J
{
®
®
 
Avalonia
¯
¯
 
.
¯
¯
 
	Threading
¯
¯
 
.
¯
¯
 

Dispatcher
¯
¯
 %
.
¯
¯
% &
UIThread
¯
¯
& .
.
¯
¯
. /
Post
¯
¯
/ 3
(
¯
¯
3 4
(
¯
¯
4 5
)
¯
¯
5 6
=>
¯
¯
7 9
{
°
°
 	
_
±
±
 
=
±
±
 !
connectivityService
±
±
 #
.
±
±
# $
PublishAsync
±
±
$ 0
(
±
±
0 1 
ConnectivityIntent
²
²
 "
.
²
²
" #
Disconnected
²
²
# /
(
²
²
/ 0
failure
²
²
0 7
,
²
²
7 8
	connectId
²
²
9 B
)
²
²
B C
)
²
²
C D
.
²
²
D E
ContinueWith
²
²
E Q
(
²
²
Q R
task
³
³
 
=>
³
³
 
{
´
´
 
if
µ
µ
 
(
µ
µ
 
task
µ
µ
 
.
µ
µ
 
	IsFaulted
µ
µ
 &
&&
µ
µ
' )
task
µ
µ
* .
.
µ
µ
. /
	Exception
µ
µ
/ 8
!=
µ
µ
9 ;
null
µ
µ
< @
)
µ
µ
@ A
{
¶
¶
 
Log
·
·
 
.
·
·
 
Error
·
·
 !
(
·
·
! "
task
·
·
" &
.
·
·
& '
	Exception
·
·
' 0
,
·
·
0 1
$str
·
·
2 x
)
·
·
x y
;
·
·
y z
}
¸
¸
 
}
¹
¹
 
,
¹
¹
 
TaskScheduler
º
º
 
.
º
º
 
Default
º
º
 %
)
º
º
% &
;
º
º
& '
}
»
»
 	
)
»
»
	 

;
»
»

 
}
¼
¼
 
private
¾
¾
 
static
¾
¾
 
async
¾
¾
 
Task
¾
¾
 
<
¾
¾
 
Result
¾
¾
 $
<
¾
¾
$ %
byte
¾
¾
% )
[
¾
¾
) *
]
¾
¾
* +
,
¾
¾
+ ,
NetworkFailure
¾
¾
- ;
>
¾
¾
; <
>
¾
¾
< =$
ProcessStreamItemAsync
¾
¾
> T
(
¾
¾
T U
SecureEnvelope
¿
¿
 
envelope
¿
¿
 
,
¿
¿
  $
EcliptixProtocolSystem
À
À
 
protocolSystem
À
À
 -
,
À
À
- .
Func
Á
Á
 
<
Á
Á
 
byte
Á
Á
 
[
Á
Á
 
]
Á
Á
 
,
Á
Á
 
Task
Á
Á
 
<
Á
Á
 
Result
Á
Á
  
<
Á
Á
  !
Unit
Á
Á
! %
,
Á
Á
% &
NetworkFailure
Á
Á
' 5
>
Á
Á
5 6
>
Á
Á
6 7
>
Á
Á
7 8
onStreamItem
Á
Á
9 E
)
Á
Á
E F
{
Â
Â
 
Result
Ã
Ã
 
<
Ã
Ã
 
byte
Ã
Ã
 
[
Ã
Ã
 
]
Ã
Ã
 
,
Ã
Ã
 %
EcliptixProtocolFailure
Ã
Ã
 .
>
Ã
Ã
. /
decryptResult
Ã
Ã
0 =
=
Ã
Ã
> ?
protocolSystem
Ä
Ä
 
.
Ä
Ä
 $
ProcessInboundEnvelope
Ä
Ä
 1
(
Ä
Ä
1 2
envelope
Ä
Ä
2 :
)
Ä
Ä
: ;
;
Ä
Ä
; <
if
Æ
Æ
 

(
Æ
Æ
 
decryptResult
Æ
Æ
 
.
Æ
Æ
 
IsErr
Æ
Æ
 
)
Æ
Æ
  
{
Ç
Ç
 	
return
È
È
 
Result
È
È
 
<
È
È
 
byte
È
È
 
[
È
È
 
]
È
È
  
,
È
È
  !
NetworkFailure
È
È
" 0
>
È
È
0 1
.
È
È
1 2
Err
È
È
2 5
(
È
È
5 6
NetworkFailure
É
É
 
.
É
É
  
InvalidRequestType
É
É
 1
(
É
É
1 2
$str
É
É
2 Q
)
É
É
Q R
)
É
É
R S
;
É
É
S T
}
Ê
Ê
 	
byte
Ì
Ì
 
[
Ì
Ì
 
]
Ì
Ì
 
decryptedData
Ì
Ì
 
=
Ì
Ì
 
decryptResult
Ì
Ì
 ,
.
Ì
Ì
, -
Unwrap
Ì
Ì
- 3
(
Ì
Ì
3 4
)
Ì
Ì
4 5
;
Ì
Ì
5 6
Result
Í
Í
 
<
Í
Í
 
Unit
Í
Í
 
,
Í
Í
 
NetworkFailure
Í
Í
 #
>
Í
Í
# $

itemResult
Í
Í
% /
=
Í
Í
0 1
await
Í
Í
2 7
onStreamItem
Í
Í
8 D
(
Í
Í
D E
decryptedData
Í
Í
E R
)
Í
Í
R S
.
Í
Í
S T
ConfigureAwait
Í
Í
T b
(
Í
Í
b c
false
Í
Í
c h
)
Í
Í
h i
;
Í
Í
i j
if
Ï
Ï
 

(
Ï
Ï
 

itemResult
Ï
Ï
 
.
Ï
Ï
 
IsErr
Ï
Ï
 
)
Ï
Ï
 
{
Ð
Ð
 	
return
Ñ
Ñ
 
Result
Ñ
Ñ
 
<
Ñ
Ñ
 
byte
Ñ
Ñ
 
[
Ñ
Ñ
 
]
Ñ
Ñ
  
,
Ñ
Ñ
  !
NetworkFailure
Ñ
Ñ
" 0
>
Ñ
Ñ
0 1
.
Ñ
Ñ
1 2
Err
Ñ
Ñ
2 5
(
Ñ
Ñ
5 6

itemResult
Ñ
Ñ
6 @
.
Ñ
Ñ
@ A
	UnwrapErr
Ñ
Ñ
A J
(
Ñ
Ñ
J K
)
Ñ
Ñ
K L
)
Ñ
Ñ
L M
;
Ñ
Ñ
M N
}
Ò
Ò
 	
return
Ô
Ô
 
Result
Ô
Ô
 
<
Ô
Ô
 
byte
Ô
Ô
 
[
Ô
Ô
 
]
Ô
Ô
 
,
Ô
Ô
 
NetworkFailure
Ô
Ô
 ,
>
Ô
Ô
, -
.
Ô
Ô
- .
Ok
Ô
Ô
. 0
(
Ô
Ô
0 1
decryptedData
Ô
Ô
1 >
)
Ô
Ô
> ?
;
Ô
Ô
? @
}
Õ
Õ
 
private
×
×
 
void
×
×
 !
CleanupActiveStream
×
×
 $
(
×
×
$ %
uint
×
×
% )
	connectId
×
×
* 3
)
×
×
3 4
{
Ø
Ø
 
_activeStreams
Ù
Ù
 
.
Ù
Ù
 
	TryRemove
Ù
Ù
  
(
Ù
Ù
  !
	connectId
Ù
Ù
! *
,
Ù
Ù
* +
out
Ù
Ù
, /
_
Ù
Ù
0 1
)
Ù
Ù
1 2
;
Ù
Ù
2 3
}
Ú
Ú
 
private
Ü
Ü
 
void
Ü
Ü
 !
NotifyStreamSuccess
Ü
Ü
 $
(
Ü
Ü
$ %
uint
Ü
Ü
% )
	connectId
Ü
Ü
* 3
)
Ü
Ü
3 4
{
Ý
Ý
 
bool
Þ
Þ
 
exitedOutage
Þ
Þ
 
=
Þ
Þ
 
Interlocked
Þ
Þ
 '
.
Þ
Þ
' (
CompareExchange
Þ
Þ
( 7
(
Þ
Þ
7 8
ref
Þ
Þ
8 ;
_outageState
Þ
Þ
< H
,
Þ
Þ
H I
$num
Þ
Þ
J K
,
Þ
Þ
K L
$num
Þ
Þ
M N
)
Þ
Þ
N O
==
Þ
Þ
P R
$num
Þ
Þ
S T
;
Þ
Þ
T U
if
à
à
 

(
à
à
 
!
à
à
 
exitedOutage
à
à
 
)
à
à
 
{
á
á
 	
return
â
â
 
;
â
â
 
}
ã
ã
 	
lock
å
å
 
(
å
å
 
_outageLock
å
å
 
)
å
å
 
{
æ
æ
 	
if
ç
ç
 
(
ç
ç
 
!
ç
ç
 %
_outageCompletionSource
ç
ç
 (
.
ç
ç
( )
Task
ç
ç
) -
.
ç
ç
- .
IsCompleted
ç
ç
. 9
)
ç
ç
9 :
{
è
è
 %
_outageCompletionSource
é
é
 '
.
é
é
' (
TrySetResult
é
é
( 4
(
é
é
4 5
true
é
é
5 9
)
é
é
9 :
;
é
é
: ;
}
ê
ê
 
}
ë
ë
 	
Avalonia
í
í
 
.
í
í
 
	Threading
í
í
 
.
í
í
 

Dispatcher
í
í
 %
.
í
í
% &
UIThread
í
í
& .
.
í
í
. /
Post
í
í
/ 3
(
í
í
3 4
(
í
í
4 5
)
í
í
5 6
=>
í
í
7 9
{
î
î
 	
_
ï
ï
 
=
ï
ï
 !
connectivityService
ï
ï
 #
.
ï
ï
# $
PublishAsync
ï
ï
$ 0
(
ï
ï
0 1 
ConnectivityIntent
ð
ð
 "
.
ð
ð
" #
	Connected
ð
ð
# ,
(
ð
ð
, -
	connectId
ð
ð
- 6
)
ð
ð
6 7
)
ð
ð
7 8
.
ð
ð
8 9
ContinueWith
ð
ð
9 E
(
ð
ð
E F
task
ñ
ñ
 
=>
ñ
ñ
 
{
ò
ò
 
if
ó
ó
 
(
ó
ó
 
task
ó
ó
 
.
ó
ó
 
	IsFaulted
ó
ó
 &
&&
ó
ó
' )
task
ó
ó
* .
.
ó
ó
. /
	Exception
ó
ó
/ 8
!=
ó
ó
9 ;
null
ó
ó
< @
)
ó
ó
@ A
{
ô
ô
 
Log
õ
õ
 
.
õ
õ
 
Error
õ
õ
 !
(
õ
õ
! "
task
õ
õ
" &
.
õ
õ
& '
	Exception
õ
õ
' 0
,
õ
õ
0 1
$str
õ
õ
2 u
)
õ
õ
u v
;
õ
õ
v w
}
ö
ö
 
}
÷
÷
 
,
÷
÷
 
TaskScheduler
ø
ø
 
.
ø
ø
 
Default
ø
ø
 %
)
ø
ø
% &
;
ø
ø
& '
}
ù
ù
 	
)
ù
ù
	 

;
ù
ù

 
}
ú
ú
 
private
ü
ü
 
async
ü
ü
 
Task
ü
ü
 
<
ü
ü
 
Result
ü
ü
 
<
ü
ü
 
Unit
ü
ü
 "
,
ü
ü
" #
NetworkFailure
ü
ü
$ 2
>
ü
ü
2 3
>
ü
ü
3 4#
ProcessStreamDirectly
ü
ü
5 J
(
ü
ü
J K$
EcliptixProtocolSystem
ý
ý
 
protocolSystem
ý
ý
 -
,
ý
ý
- .
ServiceRequest
þ
þ
 
request
þ
þ
 
,
þ
þ
 
Func
ÿ
ÿ
 
<
ÿ
ÿ
 
byte
ÿ
ÿ
 
[
ÿ
ÿ
 
]
ÿ
ÿ
 
,
ÿ
ÿ
 
Task
ÿ
ÿ
 
<
ÿ
ÿ
 
Result
ÿ
ÿ
  
<
ÿ
ÿ
  !
Unit
ÿ
ÿ
! %
,
ÿ
ÿ
% &
NetworkFailure
ÿ
ÿ
' 5
>
ÿ
ÿ
5 6
>
ÿ
ÿ
6 7
>
ÿ
ÿ
7 8
onStreamItem
ÿ
ÿ
9 E
,
ÿ
ÿ
E F
CancellationToken
€€ 
token
€€ 
)
€€  
{
 
Result
‚‚ 
<
‚‚ 
RpcFlow
‚‚ 
,
‚‚ 
NetworkFailure
‚‚ &
>
‚‚& '
invokeResult
‚‚( 4
=
‚‚5 6
await
ƒƒ 
rpcServiceManager
ƒƒ #
.
ƒƒ# $'
InvokeServiceRequestAsync
ƒƒ$ =
(
ƒƒ= >
request
ƒƒ> E
,
ƒƒE F
token
ƒƒG L
)
ƒƒL M
.
ƒƒM N
ConfigureAwait
ƒƒN \
(
ƒƒ\ ]
false
ƒƒ] b
)
ƒƒb c
;
ƒƒc d
if
…… 

(
…… 
invokeResult
…… 
.
…… 
IsErr
…… 
)
…… 
{
†† 	
return
‡‡ 
Result
‡‡ 
<
‡‡ 
Unit
‡‡ 
,
‡‡ 
NetworkFailure
‡‡  .
>
‡‡. /
.
‡‡/ 0
Err
‡‡0 3
(
‡‡3 4
invokeResult
‡‡4 @
.
‡‡@ A
	UnwrapErr
‡‡A J
(
‡‡J K
)
‡‡K L
)
‡‡L M
;
‡‡M N
}
ˆˆ 	
RpcFlow
ŠŠ 
flow
ŠŠ 
=
ŠŠ 
invokeResult
ŠŠ #
.
ŠŠ# $
Unwrap
ŠŠ$ *
(
ŠŠ* +
)
ŠŠ+ ,
;
ŠŠ, -
if
‹‹ 

(
‹‹ 
flow
‹‹ 
is
‹‹ 
not
‹‹ 
RpcFlow
‹‹ 
.
‹‹  
InboundStream
‹‹  -
inboundStream
‹‹. ;
)
‹‹; <
{
ŒŒ 	
return
 
Result
 
<
 
Unit
 
,
 
NetworkFailure
  .
>
. /
.
/ 0
Err
0 3
(
3 4
NetworkFailure
ŽŽ 
.
ŽŽ  
InvalidRequestType
ŽŽ 1
(
ŽŽ1 2
$"
ŽŽ2 4
$str
ŽŽ4 ]
{
ŽŽ] ^
flow
ŽŽ^ b
.
ŽŽb c
GetType
ŽŽc j
(
ŽŽj k
)
ŽŽk l
.
ŽŽl m
Name
ŽŽm q
}
ŽŽq r
"
ŽŽr s
)
ŽŽs t
)
ŽŽt u
;
ŽŽu v
}
 	
await
‘‘ 
foreach
‘‘ 
(
‘‘ 
Result
‘‘ 
<
‘‘ 
SecureEnvelope
‘‘ ,
,
‘‘, -
NetworkFailure
‘‘. <
>
‘‘< =

streamItem
‘‘> H
in
‘‘I K
inboundStream
’’ $
.
’’$ %
Stream
’’% +
.
’’+ ,
WithCancellation
’’, <
(
’’< =
token
’’= B
)
’’B C
)
’’C D
{
““ 	
if
”” 
(
”” 

streamItem
”” 
.
”” 
IsErr
””  
)
””  !
{
•• 
continue
–– 
;
–– 
}
—— 
SecureEnvelope
™™ 
streamPayload
™™ (
=
™™) *

streamItem
™™+ 5
.
™™5 6
Unwrap
™™6 <
(
™™< =
)
™™= >
;
™™> ?
Result
šš 
<
šš 
byte
šš 
[
šš 
]
šš 
,
šš %
EcliptixProtocolFailure
šš 2
>
šš2 3!
streamDecryptedData
šš4 G
=
ššH I
protocolSystem
›› 
.
›› $
ProcessInboundEnvelope
›› 5
(
››5 6
streamPayload
››6 C
)
››C D
;
››D E
if
œœ 
(
œœ !
streamDecryptedData
œœ #
.
œœ# $
IsErr
œœ$ )
)
œœ) *
{
 
continue
žž 
;
žž 
}
ŸŸ 
await
¡¡ 
onStreamItem
¡¡ 
(
¡¡ !
streamDecryptedData
¡¡ 2
.
¡¡2 3
Unwrap
¡¡3 9
(
¡¡9 :
)
¡¡: ;
)
¡¡; <
.
¡¡< =
ConfigureAwait
¡¡= K
(
¡¡K L
false
¡¡L Q
)
¡¡Q R
;
¡¡R S
}
¢¢ 	
return
¤¤ 
Result
¤¤ 
<
¤¤ 
Unit
¤¤ 
,
¤¤ 
NetworkFailure
¤¤ *
>
¤¤* +
.
¤¤+ ,
Ok
¤¤, .
(
¤¤. /
Unit
¤¤/ 3
.
¤¤3 4
Value
¤¤4 9
)
¤¤9 :
;
¤¤: ;
}
¥¥ 
private
§§ 
async
§§ 
Task
§§ 
<
§§ 
Result
§§ 
<
§§ 
Unit
§§ "
,
§§" #
NetworkFailure
§§$ 2
>
§§2 3
>
§§3 4(
SendSendStreamRequestAsync
§§5 O
(
§§O P$
EcliptixProtocolSystem
¨¨ 
protocolSystem
¨¨ -
,
¨¨- .
uint
©©  
logicalOperationId
©© 
,
©©  
RpcServiceType
ªª 
serviceType
ªª "
,
ªª" #
byte
«« 
[
«« 
]
«« 
plainBuffer
«« 
,
«« 
ServiceFlowType
¬¬ 
flowType
¬¬  
,
¬¬  !
RpcRequestContext
­­ 
requestContext
­­ (
,
­­( )
CancellationToken
®® 
token
®® 
)
®®  
{
¯¯ 
Result
°° 
<
°° 
ServiceRequest
°° 
,
°° 
NetworkFailure
°° -
>
°°- ."
serviceRequestResult
°°/ C
=
°°D E 
BuildRequestWithId
°°F X
(
°°X Y
protocolSystem
±± 
,
±±  
logicalOperationId
±± .
,
±±. /
serviceType
±±0 ;
,
±±; <
plainBuffer
±±= H
,
±±H I
flowType
±±J R
,
±±R S
requestContext
±±T b
)
±±b c
;
±±c d
if
³³ 

(
³³ "
serviceRequestResult
³³  
.
³³  !
IsErr
³³! &
)
³³& '
{
´´ 	
return
µµ 
Result
µµ 
<
µµ 
Unit
µµ 
,
µµ 
NetworkFailure
µµ  .
>
µµ. /
.
µµ/ 0
Err
µµ0 3
(
µµ3 4"
serviceRequestResult
µµ4 H
.
µµH I
	UnwrapErr
µµI R
(
µµR S
)
µµS T
)
µµT U
;
µµU V
}
¶¶ 	
ServiceRequest
¸¸ 
request
¸¸ 
=
¸¸  "
serviceRequestResult
¸¸! 5
.
¸¸5 6
Unwrap
¸¸6 <
(
¸¸< =
)
¸¸= >
;
¸¸> ?
Result
ºº 
<
ºº 
RpcFlow
ºº 
,
ºº 
NetworkFailure
ºº &
>
ºº& '
invokeResult
ºº( 4
=
ºº5 6
await
»» 
rpcServiceManager
»» #
.
»»# $'
InvokeServiceRequestAsync
»»$ =
(
»»= >
request
»»> E
,
»»E F
token
»»G L
)
»»L M
.
»»M N
ConfigureAwait
»»N \
(
»»\ ]
false
»»] b
)
»»b c
;
»»c d
if
½½ 

(
½½ 
invokeResult
½½ 
.
½½ 
IsErr
½½ 
)
½½ 
{
¾¾ 	
return
¿¿ 
Result
¿¿ 
<
¿¿ 
Unit
¿¿ 
,
¿¿ 
NetworkFailure
¿¿  .
>
¿¿. /
.
¿¿/ 0
Err
¿¿0 3
(
¿¿3 4
invokeResult
¿¿4 @
.
¿¿@ A
	UnwrapErr
¿¿A J
(
¿¿J K
)
¿¿K L
)
¿¿L M
;
¿¿M N
}
ÀÀ 	
RpcFlow
ÂÂ 
flow
ÂÂ 
=
ÂÂ 
invokeResult
ÂÂ #
.
ÂÂ# $
Unwrap
ÂÂ$ *
(
ÂÂ* +
)
ÂÂ+ ,
;
ÂÂ, -
if
ÃÃ 

(
ÃÃ 
flow
ÃÃ 
is
ÃÃ 
not
ÃÃ 
RpcFlow
ÃÃ 
.
ÃÃ  
OutboundSink
ÃÃ  ,
)
ÃÃ, -
{
ÄÄ 	
return
ÅÅ 
Result
ÅÅ 
<
ÅÅ 
Unit
ÅÅ 
,
ÅÅ 
NetworkFailure
ÅÅ  .
>
ÅÅ. /
.
ÅÅ/ 0
Err
ÅÅ0 3
(
ÅÅ3 4
NetworkFailure
ÆÆ 
.
ÆÆ  
InvalidRequestType
ÆÆ 1
(
ÆÆ1 2
$"
ÆÆ2 4
$str
ÆÆ4 \
{
ÆÆ\ ]
flow
ÆÆ] a
.
ÆÆa b
GetType
ÆÆb i
(
ÆÆi j
)
ÆÆj k
.
ÆÆk l
Name
ÆÆl p
}
ÆÆp q
"
ÆÆq r
)
ÆÆr s
)
ÆÆs t
;
ÆÆt u
}
ÇÇ 	
return
ÉÉ 
Result
ÉÉ 
<
ÉÉ 
Unit
ÉÉ 
,
ÉÉ 
NetworkFailure
ÉÉ *
>
ÉÉ* +
.
ÉÉ+ ,
Err
ÉÉ, /
(
ÉÉ/ 0
NetworkFailure
ÊÊ 
.
ÊÊ  
InvalidRequestType
ÊÊ -
(
ÊÊ- .
$str
ÊÊ. W
)
ÊÊW X
)
ÊÊX Y
;
ÊÊY Z
}
ËË 
private
ÍÍ 
async
ÍÍ 
Task
ÍÍ 
<
ÍÍ 
Result
ÍÍ 
<
ÍÍ 
Unit
ÍÍ "
,
ÍÍ" #
NetworkFailure
ÍÍ$ 2
>
ÍÍ2 3
>
ÍÍ3 41
#SendBidirectionalStreamRequestAsync
ÍÍ5 X
(
ÍÍX Y$
EcliptixProtocolSystem
ÎÎ 
protocolSystem
ÎÎ -
,
ÎÎ- .
uint
ÏÏ  
logicalOperationId
ÏÏ 
,
ÏÏ  
RpcServiceType
ÐÐ 
serviceType
ÐÐ "
,
ÐÐ" #
byte
ÑÑ 
[
ÑÑ 
]
ÑÑ 
plainBuffer
ÑÑ 
,
ÑÑ 
ServiceFlowType
ÒÒ 
flowType
ÒÒ  
,
ÒÒ  !
RpcRequestContext
ÓÓ 
requestContext
ÓÓ (
,
ÓÓ( )
CancellationToken
ÔÔ 
token
ÔÔ 
)
ÔÔ  
{
ÕÕ 
Result
ÖÖ 
<
ÖÖ 
ServiceRequest
ÖÖ 
,
ÖÖ 
NetworkFailure
ÖÖ -
>
ÖÖ- ."
serviceRequestResult
ÖÖ/ C
=
ÖÖD E 
BuildRequestWithId
ÖÖF X
(
ÖÖX Y
protocolSystem
×× 
,
××  
logicalOperationId
×× .
,
××. /
serviceType
××0 ;
,
××; <
plainBuffer
××= H
,
××H I
flowType
××J R
,
××R S
requestContext
××T b
)
××b c
;
××c d
if
ÙÙ 

(
ÙÙ "
serviceRequestResult
ÙÙ  
.
ÙÙ  !
IsErr
ÙÙ! &
)
ÙÙ& '
{
ÚÚ 	
return
ÛÛ 
Result
ÛÛ 
<
ÛÛ 
Unit
ÛÛ 
,
ÛÛ 
NetworkFailure
ÛÛ  .
>
ÛÛ. /
.
ÛÛ/ 0
Err
ÛÛ0 3
(
ÛÛ3 4"
serviceRequestResult
ÛÛ4 H
.
ÛÛH I
	UnwrapErr
ÛÛI R
(
ÛÛR S
)
ÛÛS T
)
ÛÛT U
;
ÛÛU V
}
ÜÜ 	
ServiceRequest
ÞÞ 
request
ÞÞ 
=
ÞÞ  "
serviceRequestResult
ÞÞ! 5
.
ÞÞ5 6
Unwrap
ÞÞ6 <
(
ÞÞ< =
)
ÞÞ= >
;
ÞÞ> ?
Result
àà 
<
àà 
RpcFlow
àà 
,
àà 
NetworkFailure
àà &
>
àà& '
invokeResult
àà( 4
=
àà5 6
await
áá 
rpcServiceManager
áá #
.
áá# $'
InvokeServiceRequestAsync
áá$ =
(
áá= >
request
áá> E
,
ááE F
token
ááG L
)
ááL M
.
ááM N
ConfigureAwait
ááN \
(
áá\ ]
false
áá] b
)
ááb c
;
áác d
if
ãã 

(
ãã 
invokeResult
ãã 
.
ãã 
IsErr
ãã 
)
ãã 
{
ää 	
return
åå 
Result
åå 
<
åå 
Unit
åå 
,
åå 
NetworkFailure
åå  .
>
åå. /
.
åå/ 0
Err
åå0 3
(
åå3 4
invokeResult
åå4 @
.
åå@ A
	UnwrapErr
ååA J
(
ååJ K
)
ååK L
)
ååL M
;
ååM N
}
ææ 	
RpcFlow
èè 
flow
èè 
=
èè 
invokeResult
èè #
.
èè# $
Unwrap
èè$ *
(
èè* +
)
èè+ ,
;
èè, -
if
éé 

(
éé 
flow
éé 
is
éé 
not
éé 
RpcFlow
éé 
.
éé  !
BidirectionalStream
éé  3
)
éé3 4
{
êê 	
return
ëë 
Result
ëë 
<
ëë 
Unit
ëë 
,
ëë 
NetworkFailure
ëë  .
>
ëë. /
.
ëë/ 0
Err
ëë0 3
(
ëë3 4
NetworkFailure
ìì 
.
ìì  
InvalidRequestType
ìì 1
(
ìì1 2
$"
íí 
$str
íí E
{
ííE F
flow
ííF J
.
ííJ K
GetType
ííK R
(
ííR S
)
ííS T
.
ííT U
Name
ííU Y
}
ííY Z
"
ííZ [
)
íí[ \
)
íí\ ]
;
íí] ^
}
îî 	
return
ðð 
Result
ðð 
<
ðð 
Unit
ðð 
,
ðð 
NetworkFailure
ðð *
>
ðð* +
.
ðð+ ,
Err
ðð, /
(
ðð/ 0
NetworkFailure
ññ 
.
ññ  
InvalidRequestType
ññ -
(
ññ- .
$str
ññ. ^
)
ññ^ _
)
ññ_ `
;
ññ` a
}
òò 
private
ôô 
async
ôô 
Task
ôô (
WaitForOutageRecoveryAsync
ôô 1
(
ôô1 2
CancellationToken
ôô2 C
token
ôôD I
,
ôôI J
bool
ôôK O
waitForRecovery
ôôP _
=
ôô` a
true
ôôb f
)
ôôf g
{
õõ 
if
öö 

(
öö 
Volatile
öö 
.
öö 
Read
öö 
(
öö 
ref
öö 
_outageState
öö *
)
öö* +
==
öö, .
$num
öö/ 0
)
öö0 1
{
÷÷ 	
return
øø 
;
øø 
}
ùù 	
if
ûû 

(
ûû 
!
ûû 
waitForRecovery
ûû 
)
ûû 
{
üü 	
return
ýý 
;
ýý 
}
þþ 	
Task
€€ 
waitTask
€€ 
;
€€ 
lock
 
(
 
_outageLock
 
)
 
{
‚‚ 	
waitTask
ƒƒ 
=
ƒƒ %
_outageCompletionSource
ƒƒ .
.
ƒƒ. /
Task
ƒƒ/ 3
;
ƒƒ3 4
}
„„ 	
using
†† %
CancellationTokenSource
†† %
cts
††& )
=
††* +%
CancellationTokenSource
‡‡ #
.
‡‡# $%
CreateLinkedTokenSource
‡‡$ ;
(
‡‡; <
token
‡‡< A
,
‡‡A B(
_shutdownCancellationToken
‡‡C ]
.
‡‡] ^
Token
‡‡^ c
)
‡‡c d
;
‡‡d e
cts
ˆˆ 
.
ˆˆ 
CancelAfter
ˆˆ 
(
ˆˆ 
NetworkConstants
ˆˆ (
.
ˆˆ( )
Timeouts
ˆˆ) 1
.
ˆˆ1 2#
OutageRecoveryTimeout
ˆˆ2 G
)
ˆˆG H
;
ˆˆH I
try
ŠŠ 
{
‹‹ 	
await
ŒŒ 
waitTask
ŒŒ 
.
ŒŒ 
	WaitAsync
ŒŒ $
(
ŒŒ$ %
cts
ŒŒ% (
.
ŒŒ( )
Token
ŒŒ) .
)
ŒŒ. /
.
ŒŒ/ 0
ConfigureAwait
ŒŒ0 >
(
ŒŒ> ?
false
ŒŒ? D
)
ŒŒD E
;
ŒŒE F
}
 	
catch
ŽŽ 
(
ŽŽ (
OperationCanceledException
ŽŽ )
)
ŽŽ) *
when
ŽŽ+ /
(
ŽŽ0 1(
_shutdownCancellationToken
ŽŽ1 K
.
ŽŽK L
Token
ŽŽL Q
.
ŽŽQ R%
IsCancellationRequested
ŽŽR i
)
ŽŽi j
{
 	
throw
 
new
 %
ObjectDisposedException
 -
(
- .
nameof
. 4
(
4 5
NetworkProvider
5 D
)
D E
,
E F
$str
G b
)
b c
;
c d
}
‘‘ 	
catch
’’ 
(
’’ (
OperationCanceledException
’’ )
)
’’) *
when
’’+ /
(
’’0 1
token
’’1 6
.
’’6 7%
IsCancellationRequested
’’7 N
)
’’N O
{
““ 	
throw
”” 
;
”” 
}
•• 	
catch
–– 
(
–– (
OperationCanceledException
–– )
)
––) *
{
—— 	
throw
˜˜ 
new
˜˜ 
TimeoutException
˜˜ &
(
˜˜& '
$str
™™ f
)
™™f g
;
™™g h
}
šš 	
}
›› 
internal
 
void
 

ExitOutage
 
(
 
)
 
{
žž 
if
ŸŸ 

(
ŸŸ 
Interlocked
ŸŸ 
.
ŸŸ 
Exchange
ŸŸ  
(
ŸŸ  !
ref
ŸŸ! $
_outageState
ŸŸ% 1
,
ŸŸ1 2
$num
ŸŸ3 4
)
ŸŸ4 5
==
ŸŸ6 8
$num
ŸŸ9 :
)
ŸŸ: ;
{
   	
return
¡¡ 
;
¡¡ 
}
¢¢ 	+
CancelConnectionRecoveryToken
¤¤ %
(
¤¤% &
)
¤¤& '
;
¤¤' (
lock
¦¦ 
(
¦¦ 
_outageLock
¦¦ 
)
¦¦ 
{
§§ 	
if
¨¨ 
(
¨¨ 
!
¨¨ %
_outageCompletionSource
¨¨ (
.
¨¨( )
Task
¨¨) -
.
¨¨- .
IsCompleted
¨¨. 9
)
¨¨9 :
{
©© %
_outageCompletionSource
ªª '
.
ªª' (
TrySetResult
ªª( 4
(
ªª4 5
true
ªª5 9
)
ªª9 :
;
ªª: ;
}
«« 
}
¬¬ 	
Avalonia
®® 
.
®® 
	Threading
®® 
.
®® 

Dispatcher
®® %
.
®®% &
UIThread
®®& .
.
®®. /
Post
®®/ 3
(
®®3 4
(
®®4 5
)
®®5 6
=>
®®7 9
{
¯¯ 	!
connectivityService
°° 
.
°°  
PublishAsync
°°  ,
(
°°, - 
ConnectivityIntent
±± "
.
±±" #
	Connected
±±# ,
(
±±, -
)
±±- .
)
±±. /
.
±±/ 0
ContinueWith
±±0 <
(
±±< =
task
²² 
=>
²² 
{
³³ 
if
´´ 
(
´´ 
task
´´ 
.
´´ 
	IsFaulted
´´ &
&&
´´' )
task
´´* .
.
´´. /
	Exception
´´/ 8
!=
´´9 ;
null
´´< @
)
´´@ A
{
µµ 
Log
¶¶ 
.
¶¶ 
Error
¶¶ !
(
¶¶! "
task
¶¶" &
.
¶¶& '
	Exception
¶¶' 0
,
¶¶0 1
$str
¶¶2 u
)
¶¶u v
;
¶¶v w
}
·· 
}
¸¸ 
,
¸¸ 
TaskScheduler
¹¹ 
.
¹¹ 
Default
¹¹ %
)
¹¹% &
;
¹¹& '
}
ºº 	
)
ºº	 

;
ºº
 
}
»» 
private
½½ 
CancellationToken
½½ (
GetConnectionRecoveryToken
½½ 8
(
½½8 9
)
½½9 :
=>
½½; =+
EnsureConnectionRecoveryToken
½½> [
(
½½[ \
)
½½\ ]
;
½½] ^
private
¿¿ 
CancellationToken
¿¿ +
EnsureConnectionRecoveryToken
¿¿ ;
(
¿¿; <
)
¿¿< =
{
ÀÀ 
lock
ÁÁ 
(
ÁÁ 
_cancellationLock
ÁÁ 
)
ÁÁ  
{
ÂÂ 	
if
ÃÃ 
(
ÃÃ $
_connectionRecoveryCts
ÃÃ &
==
ÃÃ' )
null
ÃÃ* .
||
ÃÃ/ 1$
_connectionRecoveryCts
ÃÃ2 H
.
ÃÃH I%
IsCancellationRequested
ÃÃI `
)
ÃÃ` a
{
ÄÄ $
_connectionRecoveryCts
ÅÅ &
?
ÅÅ& '
.
ÅÅ' (
Dispose
ÅÅ( /
(
ÅÅ/ 0
)
ÅÅ0 1
;
ÅÅ1 2
if
ÇÇ 
(
ÇÇ (
_shutdownCancellationToken
ÇÇ .
.
ÇÇ. /%
IsCancellationRequested
ÇÇ/ F
)
ÇÇF G
{
ÈÈ 
return
ÉÉ (
_shutdownCancellationToken
ÉÉ 5
.
ÉÉ5 6
Token
ÉÉ6 ;
;
ÉÉ; <
}
ÊÊ $
_connectionRecoveryCts
ÌÌ &
=
ÌÌ' (%
CancellationTokenSource
ÍÍ +
.
ÍÍ+ ,%
CreateLinkedTokenSource
ÍÍ, C
(
ÍÍC D(
_shutdownCancellationToken
ÍÍD ^
.
ÍÍ^ _
Token
ÍÍ_ d
)
ÍÍd e
;
ÍÍe f
}
ÎÎ 
return
ÐÐ $
_connectionRecoveryCts
ÐÐ )
.
ÐÐ) *
Token
ÐÐ* /
;
ÐÐ/ 0
}
ÑÑ 	
}
ÒÒ 
internal
ÔÔ 
void
ÔÔ 2
$BeginSecrecyChannelEstablishRecovery
ÔÔ 6
(
ÔÔ6 7
)
ÔÔ7 8
{
ÕÕ 
if
ÖÖ 

(
ÖÖ 
	_disposed
ÖÖ 
||
ÖÖ (
_shutdownCancellationToken
ÖÖ 3
.
ÖÖ3 4%
IsCancellationRequested
ÖÖ4 K
)
ÖÖK L
{
×× 	
return
ØØ 
;
ØØ 
}
ÙÙ 	
bool
ÛÛ 
enteredOutage
ÛÛ 
=
ÛÛ 
Interlocked
ÛÛ (
.
ÛÛ( )
CompareExchange
ÛÛ) 8
(
ÛÛ8 9
ref
ÛÛ9 <
_outageState
ÛÛ= I
,
ÛÛI J
$num
ÛÛK L
,
ÛÛL M
$num
ÛÛN O
)
ÛÛO P
==
ÛÛQ S
$num
ÛÛT U
;
ÛÛU V
if
ÜÜ 

(
ÜÜ 
enteredOutage
ÜÜ 
)
ÜÜ 
{
ÝÝ 	
lock
ÞÞ 
(
ÞÞ 
_outageLock
ÞÞ 
)
ÞÞ 
{
ßß 
if
àà 
(
àà %
_outageCompletionSource
àà +
.
àà+ ,
Task
àà, 0
.
àà0 1
IsCompleted
àà1 <
)
àà< =
{
áá %
_outageCompletionSource
ââ +
=
ââ, -
CreateOutageTcs
ââ. =
(
ââ= >
)
ââ> ?
;
ââ? @
}
ãã 
}
ää !
connectivityService
ææ 
.
ææ  
PublishAsync
ææ  ,
(
ææ, - 
ConnectivityIntent
çç "
.
çç" #

Recovering
çç# -
(
çç- .
NetworkFailure
èè "
.
èè" #%
DataCenterNotResponding
èè# :
(
èè: ;
$str
èè; W
)
èèW X
)
èèX Y
)
èèY Z
.
èèZ [
ContinueWith
èè[ g
(
èèg h
task
éé 
=>
éé 
{
êê 
if
ëë 
(
ëë 
task
ëë 
.
ëë 
	IsFaulted
ëë &
&&
ëë' )
task
ëë* .
.
ëë. /
	Exception
ëë/ 8
!=
ëë9 ;
null
ëë< @
)
ëë@ A
{
ìì 
Log
íí 
.
íí 
Error
íí !
(
íí! "
task
íí" &
.
íí& '
	Exception
íí' 0
,
íí0 1
$str
íí2 v
)
íív w
;
ííw x
}
îî 
}
ïï 
,
ïï 
TaskScheduler
ðð 
.
ðð 
Default
ðð %
)
ðð% &
;
ðð& '
}
ññ 	+
EnsureConnectionRecoveryToken
óó %
(
óó% &
)
óó& '
;
óó' (
}
ôô 
private
öö 
void
öö +
CancelConnectionRecoveryToken
öö .
(
öö. /
)
öö/ 0
{
÷÷ 
lock
øø 
(
øø 
_cancellationLock
øø 
)
øø  
{
ùù 	
if
úú 
(
úú $
_connectionRecoveryCts
úú &
==
úú' )
null
úú* .
)
úú. /
{
ûû 
return
üü 
;
üü 
}
ýý 
try
ÿÿ 
{
€€ 
if
 
(
 
!
 $
_connectionRecoveryCts
 +
.
+ ,%
IsCancellationRequested
, C
)
C D
{
‚‚ $
_connectionRecoveryCts
ƒƒ *
.
ƒƒ* +
Cancel
ƒƒ+ 1
(
ƒƒ1 2
)
ƒƒ2 3
;
ƒƒ3 4
}
„„ 
}
…… 
catch
†† 
(
†† %
ObjectDisposedException
†† *
)
††* +
{
‡‡ 
}
‰‰ 
finally
ŠŠ 
{
‹‹ $
_connectionRecoveryCts
ŒŒ &
.
ŒŒ& '
Dispose
ŒŒ' .
(
ŒŒ. /
)
ŒŒ/ 0
;
ŒŒ0 1$
_connectionRecoveryCts
 &
=
' (
null
) -
;
- .
}
ŽŽ 
}
 	
}
 
private
’’ 
async
’’ 
Task
’’ 
<
’’ 
T
’’ 
>
’’ 
WithChannelGate
’’ )
<
’’) *
T
’’* +
>
’’+ ,
(
’’, -
uint
’’- 1
	connectId
’’2 ;
,
’’; <
Func
’’= A
<
’’A B
Task
’’B F
<
’’F G
T
’’G H
>
’’H I
>
’’I J
action
’’K Q
)
’’Q R
{
““ 
SemaphoreSlim
”” 
gate
”” 
=
”” 
_channelGates
”” *
.
””* +
GetOrAdd
””+ 3
(
””3 4
	connectId
””4 =
,
””= >
_
””? @
=>
””A C
new
””D G
SemaphoreSlim
””H U
(
””U V
$num
””V W
,
””W X
$num
””Y Z
)
””Z [
)
””[ \
;
””\ ]
bool
•• 
acquired
•• 
=
•• 
false
•• 
;
•• 
try
–– 
{
—— 	
await
˜˜ 
gate
˜˜ 
.
˜˜ 
	WaitAsync
˜˜  
(
˜˜  !(
_shutdownCancellationToken
˜˜! ;
.
˜˜; <
Token
˜˜< A
)
˜˜A B
.
˜˜B C
ConfigureAwait
˜˜C Q
(
˜˜Q R
false
˜˜R W
)
˜˜W X
;
˜˜X Y
acquired
™™ 
=
™™ 
true
™™ 
;
™™ 
return
šš 
await
šš 
action
šš 
(
šš  
)
šš  !
.
šš! "
ConfigureAwait
šš" 0
(
šš0 1
false
šš1 6
)
šš6 7
;
šš7 8
}
›› 	
catch
œœ 
(
œœ (
OperationCanceledException
œœ )
)
œœ) *
when
œœ+ /
(
œœ0 1(
_shutdownCancellationToken
œœ1 K
.
œœK L%
IsCancellationRequested
œœL c
)
œœc d
{
 	
throw
žž 
new
žž %
ObjectDisposedException
žž -
(
žž- .
nameof
žž. 4
(
žž4 5
NetworkProvider
žž5 D
)
žžD E
,
žžE F
$str
žžG b
)
žžb c
;
žžc d
}
ŸŸ 	
finally
   
{
¡¡ 	
if
¢¢ 
(
¢¢ 
acquired
¢¢ 
)
¢¢ 
{
££ 
gate
¤¤ 
.
¤¤ 
Release
¤¤ 
(
¤¤ 
)
¤¤ 
;
¤¤ 
}
¥¥ 
}
¦¦ 	
}
§§ 
private
©© 
static
©© 
bool
©© (
CanServiceTypeBeDuplicated
©© 2
(
©©2 3
RpcServiceType
©©3 A
serviceType
©©B M
)
©©M N
{
ªª 
return
«« 
serviceType
«« 
switch
«« !
{
¬¬ 	
RpcServiceType
­­ 
.
­­ "
InitiateVerification
­­ /
=>
­­0 2
true
­­3 7
,
­­7 8
RpcServiceType
®® 
.
®® "
ValidateMobileNumber
®® /
=>
®®0 2
true
®®3 7
,
®®7 8
_
¯¯ 
=>
¯¯ 
false
¯¯ 
}
°° 	
;
°°	 

}
±± 
private
³³ 
void
³³ .
 PersistProtocolStateInBackground
³³ 1
(
³³1 2
uint
³³2 6
	connectId
³³7 @
)
³³@ A
{
´´ 
Task
µµ 
.
µµ 
Run
µµ 
(
µµ 
async
µµ 
(
µµ 
)
µµ 
=>
µµ 
{
¶¶ 	
try
·· 
{
¸¸ 
await
¹¹ *
TryPersistProtocolStateAsync
¹¹ 2
(
¹¹2 3
	connectId
¹¹3 <
)
¹¹< =
.
¹¹= >
ConfigureAwait
¹¹> L
(
¹¹L M
false
¹¹M R
)
¹¹R S
;
¹¹S T
}
ºº 
catch
»» 
(
»» 
	Exception
»» 
ex
»» 
)
»»  
{
¼¼ 
if
½½ 
(
½½ 
!
½½ 
	_disposed
½½ 
)
½½ 
{
¾¾ 
Log
¿¿ 
.
¿¿ 
Error
¿¿ 
(
¿¿ 
ex
¿¿  
,
¿¿  !
$str
¿¿" k
)
¿¿k l
;
¿¿l m
}
ÀÀ 
}
ÁÁ 
}
ÂÂ 	
,
ÂÂ	 
(
_shutdownCancellationToken
ÂÂ %
.
ÂÂ% &
Token
ÂÂ& +
)
ÂÂ+ ,
.
ÂÂ, -
ContinueWith
ÂÂ- 9
(
ÂÂ9 :
task
ÃÃ 
=>
ÃÃ 
{
ÄÄ 
if
ÅÅ 
(
ÅÅ 
task
ÅÅ 
.
ÅÅ 
	IsFaulted
ÅÅ "
&&
ÅÅ# %
task
ÅÅ& *
.
ÅÅ* +
	Exception
ÅÅ+ 4
!=
ÅÅ5 7
null
ÅÅ8 <
)
ÅÅ< =
{
ÆÆ 
Log
ÇÇ 
.
ÇÇ 
Error
ÇÇ 
(
ÇÇ 
task
ÇÇ "
.
ÇÇ" #
	Exception
ÇÇ# ,
,
ÇÇ, -
$str
ÇÇ. t
)
ÇÇt u
;
ÇÇu v
}
ÈÈ 
}
ÉÉ 
,
ÉÉ 
TaskScheduler
ÊÊ 
.
ÊÊ 
Default
ÊÊ !
)
ÊÊ! "
;
ÊÊ" #
}
ËË 
private
ÍÍ 
async
ÍÍ 
Task
ÍÍ *
TryPersistProtocolStateAsync
ÍÍ 3
(
ÍÍ3 4
uint
ÍÍ4 8
	connectId
ÍÍ9 B
)
ÍÍB C
{
ÎÎ 
if
ÏÏ 

(
ÏÏ 
	_disposed
ÏÏ 
||
ÏÏ (
_shutdownCancellationToken
ÏÏ 3
.
ÏÏ3 4%
IsCancellationRequested
ÏÏ4 K
)
ÏÏK L
{
ÐÐ 	
return
ÑÑ 
;
ÑÑ 
}
ÒÒ 	
if
ÔÔ 

(
ÔÔ 
!
ÔÔ 
_connections
ÔÔ 
.
ÔÔ 
TryGetValue
ÔÔ %
(
ÔÔ% &
	connectId
ÔÔ& /
,
ÔÔ/ 0
out
ÔÔ1 4$
EcliptixProtocolSystem
ÔÔ5 K
?
ÔÔK L
protocolSystem
ÔÔM [
)
ÔÔ[ \
)
ÔÔ\ ]
{
ÕÕ 	
return
ÖÖ 
;
ÖÖ 
}
×× 	(
EcliptixProtocolConnection
ÙÙ "
?
ÙÙ" #

connection
ÙÙ$ .
=
ÙÙ/ 0
protocolSystem
ÙÙ1 ?
.
ÙÙ? @
GetConnection
ÙÙ@ M
(
ÙÙM N
)
ÙÙN O
;
ÙÙO P
if
ÚÚ 

(
ÚÚ 

connection
ÚÚ 
==
ÚÚ 
null
ÚÚ 
||
ÚÚ !

connection
ÚÚ" ,
.
ÚÚ, -
ExchangeType
ÚÚ- 9
==
ÚÚ: < 
PubKeyExchangeType
ÚÚ= O
.
ÚÚO P
ServerStreaming
ÚÚP _
)
ÚÚ_ `
{
ÛÛ 	
return
ÜÜ 
;
ÜÜ 
}
ÝÝ 	
Option
ßß 
<
ßß "
EcliptixSessionState
ßß #
>
ßß# $ 
sessionStateOption
ßß% 7
=
ßß8 9
BuildSessionState
ßß: K
(
ßßK L
	connectId
ßßL U
,
ßßU V
protocolSystem
ßßW e
,
ßße f

connection
ßßg q
)
ßßq r
;
ßßr s
if
àà 

(
àà  
sessionStateOption
àà 
.
àà 
IsSome
àà %
)
àà% &
{
áá 	
await
ââ &
PersistSessionStateAsync
ââ *
(
ââ* + 
sessionStateOption
ââ+ =
.
ââ= >
Value
ââ> C
!
ââC D
,
ââD E
	connectId
ââF O
)
ââO P
.
ââP Q
ConfigureAwait
ââQ _
(
ââ_ `
false
ââ` e
)
ââe f
;
ââf g
}
ãã 	
}
ää 
private
ææ 
static
ææ 
Option
ææ 
<
ææ "
EcliptixSessionState
ææ .
>
ææ. /
BuildSessionState
ææ0 A
(
ææA B
uint
ææB F
	connectId
ææG P
,
ææP Q$
EcliptixProtocolSystem
ææR h
protocolSystem
ææi w
,
ææw x)
EcliptixProtocolConnectionææy “

connectionææ” ž
)ææž Ÿ
{
çç (
EcliptixSystemIdentityKeys
èè "
idKeys
èè# )
=
èè* +
protocolSystem
èè, :
.
èè: ;
GetIdentityKeys
èè; J
(
èèJ K
)
èèK L
;
èèL M
Result
éé 
<
éé 
IdentityKeysState
éé  
,
éé  !%
EcliptixProtocolFailure
éé" 9
>
éé9 :
idKeysStateResult
éé; L
=
ééM N
idKeys
ééO U
.
ééU V
ToProtoState
ééV b
(
ééb c
)
ééc d
;
ééd e
Result
êê 
<
êê 
RatchetState
êê 
,
êê %
EcliptixProtocolFailure
êê 4
>
êê4 5 
ratchetStateResult
êê6 H
=
êêI J

connection
êêK U
.
êêU V
ToProtoState
êêV b
(
êêb c
)
êêc d
;
êêd e
if
ìì 

(
ìì 
!
ìì 
idKeysStateResult
ìì 
.
ìì 
IsOk
ìì #
||
ìì$ &
!
ìì' ( 
ratchetStateResult
ìì( :
.
ìì: ;
IsOk
ìì; ?
)
ìì? @
{
íí 	
return
îî 
Option
îî 
<
îî "
EcliptixSessionState
îî .
>
îî. /
.
îî/ 0
None
îî0 4
;
îî4 5
}
ïï 	"
EcliptixSessionState
ññ 
state
ññ "
=
ññ# $
new
ññ% (
(
ññ( )
)
ññ) *
{
òò 	
	ConnectId
óó 
=
óó 
	connectId
óó !
,
óó! "
IdentityKeys
ôô 
=
ôô 
idKeysStateResult
ôô ,
.
ôô, -
Unwrap
ôô- 3
(
ôô3 4
)
ôô4 5
,
ôô5 6
RatchetState
õõ 
=
õõ  
ratchetStateResult
õõ -
.
õõ- .
Unwrap
õõ. 4
(
õõ4 5
)
õõ5 6
}
öö 	
;
öö	 

return
øø 
Option
øø 
<
øø "
EcliptixSessionState
øø *
>
øø* +
.
øø+ ,
Some
øø, 0
(
øø0 1
state
øø1 6
)
øø6 7
;
øø7 8
}
ùù 
public
ûû 

void
ûû $
OnProtocolStateChanged
ûû &
(
ûû& '
uint
ûû' +
	connectId
ûû, 5
)
ûû5 6
=>
ûû7 9.
 PersistProtocolStateInBackground
üü (
(
üü( )
	connectId
üü) 2
)
üü2 3
;
üü3 4
public
þþ 

static
þþ 
uint
þþ $
ComputeUniqueConnectId
þþ -
(
þþ- .)
ApplicationInstanceSettings
þþ. I
?
þþI J)
applicationInstanceSettings
þþK f
,
þþf g 
PubKeyExchangeType
ÿÿ  
pubKeyExchangeType
ÿÿ -
)
ÿÿ- .
{
€€ 
if
 

(
 )
applicationInstanceSettings
 '
==
( *
null
+ /
)
/ 0
{
‚‚ 	
throw
ƒƒ 
new
ƒƒ '
InvalidOperationException
ƒƒ /
(
ƒƒ/ 0
$str
ƒƒ0 q
)
ƒƒq r
;
ƒƒr s
}
„„ 	
if
†† 

(
†† )
applicationInstanceSettings
†† '
.
††' (
AppInstanceId
††( 5
==
††6 8
null
††9 =
||
††> @)
applicationInstanceSettings
††A \
.
††\ ]
AppInstanceId
††] j
.
††j k
IsEmpty
††k r
)
††r s
{
‡‡ 	
throw
ˆˆ 
new
ˆˆ '
InvalidOperationException
ˆˆ /
(
ˆˆ/ 0
$str
ˆˆ0 l
)
ˆˆl m
;
ˆˆm n
}
‰‰ 	
if
‹‹ 

(
‹‹ )
applicationInstanceSettings
‹‹ '
.
‹‹' (
DeviceId
‹‹( 0
==
‹‹1 3
null
‹‹4 8
||
‹‹9 ;)
applicationInstanceSettings
‹‹< W
.
‹‹W X
DeviceId
‹‹X `
.
‹‹` a
IsEmpty
‹‹a h
)
‹‹h i
{
ŒŒ 	
throw
 
new
 '
InvalidOperationException
 /
(
/ 0
$str
0 g
)
g h
;
h i
}
ŽŽ 	
Guid
 
appInstanceGuid
 
=
 
Helpers
 &
.
& '"
FromByteStringToGuid
' ;
(
; <)
applicationInstanceSettings
< W
.
W X
AppInstanceId
X e
)
e f
;
f g
Guid
‘‘ 

deviceGuid
‘‘ 
=
‘‘ 
Helpers
‘‘ !
.
‘‘! ""
FromByteStringToGuid
‘‘" 6
(
‘‘6 7)
applicationInstanceSettings
‘‘7 R
.
‘‘R S
DeviceId
‘‘S [
)
‘‘[ \
;
‘‘\ ]
string
““ !
appInstanceIdString
““ "
=
““# $
appInstanceGuid
““% 4
.
““4 5
ToString
““5 =
(
““= >
)
““> ?
;
““? @
string
”” 
deviceIdString
”” 
=
”” 

deviceGuid
””  *
.
””* +
ToString
””+ 3
(
””3 4
)
””4 5
;
””5 6
uint
–– 
	connectId
–– 
=
–– 
Helpers
––  
.
––  !$
ComputeUniqueConnectId
––! 7
(
––7 8!
appInstanceIdString
—— 
,
——  
deviceIdString
˜˜ 
,
˜˜  
pubKeyExchangeType
˜˜ .
)
˜˜. /
;
˜˜/ 0
return
šš 
	connectId
šš 
;
šš 
}
›› 
public
 

void
 
Dispose
 
(
 
)
 
{
žž 
if
ŸŸ 

(
ŸŸ 
	_disposed
ŸŸ 
)
ŸŸ 
{
   	
return
¡¡ 
;
¡¡ 
}
¢¢ 	
lock
¤¤ 
(
¤¤ 
_disposeLock
¤¤ 
)
¤¤ 
{
¥¥ 	
if
¦¦ 
(
¦¦ 
	_disposed
¦¦ 
)
¦¦ 
{
§§ 
return
¨¨ 
;
¨¨ 
}
©© 
	_disposed
«« 
=
«« 
true
«« 
;
«« 
try
­­ 
{
®® (
_shutdownCancellationToken
¯¯ *
.
¯¯* +
Cancel
¯¯+ 1
(
¯¯1 2
)
¯¯2 3
;
¯¯3 4
foreach
±± 
(
±± 
KeyValuePair
±± %
<
±±% &
string
±±& ,
,
±±, -%
CancellationTokenSource
±±. E
>
±±E F
kv
±±G I
in
±±J L
_pendingRequests
±±M ]
.
±±] ^
ToArray
±±^ e
(
±±e f
)
±±f g
)
±±g h
{
²² 
if
³³ 
(
³³ 
!
³³ 
_pendingRequests
³³ )
.
³³) *
	TryRemove
³³* 3
(
³³3 4
kv
³³4 6
.
³³6 7
Key
³³7 :
,
³³: ;
out
³³< ?%
CancellationTokenSource
³³@ W
?
³³W X
cts
³³Y \
)
³³\ ]
)
³³] ^
{
´´ 
continue
µµ  
;
µµ  !
}
¶¶ 
try
¸¸ 
{
¹¹ 
cts
ºº 
.
ºº 
Cancel
ºº "
(
ºº" #
)
ºº# $
;
ºº$ %
cts
»» 
.
»» 
Dispose
»» #
(
»»# $
)
»»$ %
;
»»% &
}
¼¼ 
catch
½½ 
(
½½ %
ObjectDisposedException
½½ 2
)
½½2 3
{
¾¾ 
}
ÀÀ 
}
ÁÁ 
foreach
ÃÃ 
(
ÃÃ 
KeyValuePair
ÃÃ %
<
ÃÃ% &
uint
ÃÃ& *
,
ÃÃ* +%
CancellationTokenSource
ÃÃ, C
>
ÃÃC D
kv
ÃÃE G
in
ÃÃH J
_activeStreams
ÃÃK Y
.
ÃÃY Z
ToArray
ÃÃZ a
(
ÃÃa b
)
ÃÃb c
)
ÃÃc d
{
ÄÄ 
if
ÅÅ 
(
ÅÅ 
!
ÅÅ 
_activeStreams
ÅÅ '
.
ÅÅ' (
	TryRemove
ÅÅ( 1
(
ÅÅ1 2
kv
ÅÅ2 4
.
ÅÅ4 5
Key
ÅÅ5 8
,
ÅÅ8 9
out
ÅÅ: =%
CancellationTokenSource
ÅÅ> U
?
ÅÅU V
	streamCts
ÅÅW `
)
ÅÅ` a
)
ÅÅa b
{
ÆÆ 
continue
ÇÇ  
;
ÇÇ  !
}
ÈÈ 
try
ÊÊ 
{
ËË 
	streamCts
ÌÌ !
.
ÌÌ! "
Cancel
ÌÌ" (
(
ÌÌ( )
)
ÌÌ) *
;
ÌÌ* +
	streamCts
ÍÍ !
.
ÍÍ! "
Dispose
ÍÍ" )
(
ÍÍ) *
)
ÍÍ* +
;
ÍÍ+ ,
}
ÎÎ 
catch
ÏÏ 
(
ÏÏ %
ObjectDisposedException
ÏÏ 2
)
ÏÏ2 3
{
ÐÐ 
}
ÒÒ 
}
ÓÓ 
lock
ÕÕ 
(
ÕÕ 
_outageLock
ÕÕ !
)
ÕÕ! "
{
ÖÖ %
_outageCompletionSource
×× +
.
××+ ,
TrySetException
××, ;
(
××; <
new
××< ?(
OperationCanceledException
××@ Z
(
××Z [
$str
××[ s
)
××s t
)
××t u
;
××u v
}
ØØ 
List
ÚÚ 
<
ÚÚ 
KeyValuePair
ÚÚ !
<
ÚÚ! "
uint
ÚÚ" &
,
ÚÚ& '$
EcliptixProtocolSystem
ÚÚ( >
>
ÚÚ> ?
>
ÚÚ? @"
connectionsToDispose
ÚÚA U
=
ÚÚV W
new
ÚÚX [
(
ÚÚ[ \
_connections
ÚÚ\ h
)
ÚÚh i
;
ÚÚi j
_connections
ÛÛ 
.
ÛÛ 
Clear
ÛÛ "
(
ÛÛ" #
)
ÛÛ# $
;
ÛÛ$ %
foreach
ÝÝ 
(
ÝÝ 
KeyValuePair
ÝÝ %
<
ÝÝ% &
uint
ÝÝ& *
,
ÝÝ* +$
EcliptixProtocolSystem
ÝÝ, B
>
ÝÝB C

connection
ÝÝD N
in
ÝÝO Q"
connectionsToDispose
ÝÝR f
)
ÝÝf g
{
ÞÞ 
try
ßß 
{
àà 

connection
áá "
.
áá" #
Value
áá# (
.
áá( )
Dispose
áá) 0
(
áá0 1
)
áá1 2
;
áá2 3
}
ââ 
catch
ãã 
{
ää 
}
ææ 
}
çç 
lock
éé 
(
éé 
_cancellationLock
éé '
)
éé' (
{
êê $
_connectionRecoveryCts
ëë *
?
ëë* +
.
ëë+ ,
Dispose
ëë, 3
(
ëë3 4
)
ëë4 5
;
ëë5 6$
_connectionRecoveryCts
ìì *
=
ìì+ ,
null
ìì- 1
;
ìì1 2
}
íí 
foreach
ïï 
(
ïï 
SemaphoreSlim
ïï &
gate
ïï' +
in
ïï, .
_channelGates
ïï/ <
.
ïï< =
Values
ïï= C
)
ïïC D
{
ðð 
gate
ññ 
.
ññ 
Dispose
ññ  
(
ññ  !
)
ññ! "
;
ññ" #
}
òò 
_channelGates
ôô 
.
ôô 
Clear
ôô #
(
ôô# $
)
ôô$ %
;
ôô% &'
_retryPendingRequestsGate
öö )
.
öö) *
Dispose
öö* 1
(
öö1 2
)
öö2 3
;
öö3 4(
_shutdownCancellationToken
øø *
.
øø* +
Dispose
øø+ 2
(
øø2 3
)
øø3 4
;
øø4 5
}
ùù 
catch
úú 
(
úú 
	Exception
úú 
ex
úú 
)
úú  
{
ûû 
Log
ýý 
.
ýý 
Warning
ýý 
(
ýý 
ex
ýý 
,
ýý 
$str
ýý  X
)
ýýX Y
;
ýýY Z
}
þþ 
}
ÿÿ 	
}
€€ 
public
‚‚ 

async
‚‚ 
Task
‚‚ 
<
‚‚ 
Result
‚‚ 
<
‚‚ 
Unit
‚‚ !
,
‚‚! "
NetworkFailure
‚‚# 1
>
‚‚1 2
>
‚‚2 3'
ForceFreshConnectionAsync
‚‚4 M
(
‚‚M N
)
‚‚N O
{
ƒƒ 
retryStrategy
„„ 
.
„„ &
ClearExhaustedOperations
„„ .
(
„„. /
)
„„/ 0
;
„„0 1
Result
†† 
<
†† 
Unit
†† 
,
†† 
NetworkFailure
†† #
>
††# $
immediateResult
††% 4
=
††5 6
await
††7 <+
PerformImmediateRecoveryLogic
††= Z
(
††Z [
)
††[ \
.
††\ ]
ConfigureAwait
††] k
(
††k l
false
††l q
)
††q r
;
††r s
if
ˆˆ 

(
ˆˆ 
immediateResult
ˆˆ 
.
ˆˆ 
IsOk
ˆˆ  
)
ˆˆ  !
{
‰‰ 	
return
ŠŠ 
immediateResult
ŠŠ "
;
ŠŠ" #
}
‹‹ 	
Result
 
<
 
Unit
 
,
 
NetworkFailure
 #
>
# $
result
% +
=
, -
await
. 39
+PerformAdvancedRecoveryWithManualRetryAsync
4 _
(
_ `
)
` a
.
a b
ConfigureAwait
b p
(
p q
false
q v
)
v w
;
w x
return
 
result
 
;
 
}
 
private
’’ 
async
’’ 
Task
’’ 
<
’’ 
Result
’’ 
<
’’ 
Unit
’’ "
,
’’" #
NetworkFailure
’’$ 2
>
’’2 3
>
’’3 49
+PerformAdvancedRecoveryWithManualRetryAsync
’’5 `
(
’’` a
)
’’a b
{
““ 
return
”” 
await
”” 6
(PerformRecoveryWithStateRestorationAsync
”” =
(
””= >
RestoreRetryMode
•• 
.
•• 
ManualRetry
•• (
,
••( )
$str
–– -
)
––- .
.
––. /
ConfigureAwait
––/ =
(
––= >
false
––> C
)
––C D
;
––D E
}
—— 
private
™™ 
async
™™ 
Task
™™ 
<
™™ 
Result
™™ 
<
™™ 
Unit
™™ "
,
™™" #
NetworkFailure
™™$ 2
>
™™2 3
>
™™3 4+
PerformImmediateRecoveryLogic
™™5 R
(
™™R S
)
™™S T
{
šš 
return
›› 
await
›› 6
(PerformRecoveryWithStateRestorationAsync
›› =
(
››= >
RestoreRetryMode
œœ 
.
œœ 
DirectNoRetry
œœ *
,
œœ* +
NetworkConstants
 
.
 
ErrorMessages
 *
.
* +)
SESSION_NOT_FOUND_ON_SERVER
+ F
,
F G 
failOnMissingState
žž 
:
žž 
true
žž  $
)
žž$ %
.
žž% &
ConfigureAwait
žž& 4
(
žž4 5
false
žž5 :
)
žž: ;
;
žž; <
}
ŸŸ 
private
¡¡ 
async
¡¡ 
Task
¡¡ 
<
¡¡ 
Result
¡¡ 
<
¡¡ 
Unit
¡¡ "
,
¡¡" #
NetworkFailure
¡¡$ 2
>
¡¡2 3
>
¡¡3 46
(PerformRecoveryWithStateRestorationAsync
¡¡5 ]
(
¡¡] ^
RestoreRetryMode
¢¢ 
	retryMode
¢¢ "
,
¢¢" #
string
££ 
failureMessage
££ 
,
££ 
bool
¤¤  
failOnMissingState
¤¤ 
=
¤¤  !
false
¤¤" '
)
¤¤' (
{
¥¥ 
Result
¦¦ 
<
¦¦ 
(
¦¦ 
uint
¦¦ 
	connectId
¦¦ 
,
¦¦ 
byte
¦¦  $
[
¦¦$ %
]
¦¦% &
membershipId
¦¦' 3
)
¦¦3 4
,
¦¦4 5
NetworkFailure
¦¦6 D
>
¦¦D E!
prerequisitesResult
¦¦F Y
=
¦¦Z [+
ValidateRecoveryPrerequisites
¦¦\ y
(
¦¦y z
)
¦¦z {
;
¦¦{ |
if
§§ 

(
§§ !
prerequisitesResult
§§ 
.
§§  
IsErr
§§  %
)
§§% &
{
¨¨ 	
return
©© 
Result
©© 
<
©© 
Unit
©© 
,
©© 
NetworkFailure
©©  .
>
©©. /
.
©©/ 0
Err
©©0 3
(
©©3 4!
prerequisitesResult
©©4 G
.
©©G H
	UnwrapErr
©©H Q
(
©©Q R
)
©©R S
)
©©S T
;
©©T U
}
ªª 	
(
¬¬ 	
uint
¬¬	 
	connectId
¬¬ 
,
¬¬ 
byte
¬¬ 
[
¬¬ 
]
¬¬ 
membershipId
¬¬  ,
)
¬¬, -
=
¬¬. /!
prerequisitesResult
¬¬0 C
.
¬¬C D
Unwrap
¬¬D J
(
¬¬J K
)
¬¬K L
;
¬¬L M
_connections
­­ 
.
­­ 
	TryRemove
­­ 
(
­­ 
	connectId
­­ (
,
­­( )
out
­­* -
_
­­. /
)
­­/ 0
;
­­0 1
Result
¯¯ 
<
¯¯ "
EcliptixSessionState
¯¯ #
,
¯¯# $
NetworkFailure
¯¯% 3
>
¯¯3 4
stateResult
¯¯5 @
=
¯¯A B
await
°° %
LoadAndParseStoredState
°° )
(
°°) *
	connectId
°°* 3
,
°°3 4
membershipId
°°5 A
,
°°A B 
failOnMissingState
°°C U
,
°°U V
failureMessage
°°W e
)
°°e f
.
°°f g
ConfigureAwait
°°g u
(
°°u v
false
°°v {
)
°°{ |
;
°°| }
if
²² 

(
²² 
stateResult
²² 
.
²² 
IsErr
²² 
)
²² 
{
³³ 	
return
´´ 
Result
´´ 
<
´´ 
Unit
´´ 
,
´´ 
NetworkFailure
´´  .
>
´´. /
.
´´/ 0
Err
´´0 3
(
´´3 4
stateResult
´´4 ?
.
´´? @
	UnwrapErr
´´@ I
(
´´I J
)
´´J K
)
´´K L
;
´´L M
}
µµ 	
bool
·· "
restorationSucceeded
·· !
;
··! "
try
¸¸ 
{
¹¹ 	"
EcliptixSessionState
ºº  
state
ºº! &
=
ºº' (
stateResult
ºº) 4
.
ºº4 5
Unwrap
ºº5 ;
(
ºº; <
)
ºº< =
;
ºº= >
Result
»» 
<
»» 
bool
»» 
,
»» 
NetworkFailure
»» '
>
»»' (
restoreResult
»») 6
=
»»7 8
await
¼¼ (
RestoreSecrecyChannelAsync
¼¼ 0
(
¼¼0 1
state
¼¼1 6
,
¼¼6 7*
_applicationInstanceSettings
¼¼8 T
.
¼¼T U
Value
¼¼U Z
!
¼¼Z [
,
¼¼[ \
	retryMode
¼¼] f
)
¼¼f g
.
½½ 
ConfigureAwait
½½ #
(
½½# $
false
½½$ )
)
½½) *
;
½½* +"
restorationSucceeded
¿¿  
=
¿¿! "
restoreResult
¿¿# 0
.
¿¿0 1
IsOk
¿¿1 5
&&
¿¿6 8
restoreResult
¿¿9 F
.
¿¿F G
Unwrap
¿¿G M
(
¿¿M N
)
¿¿N O
;
¿¿O P
if
ÁÁ 
(
ÁÁ "
restorationSucceeded
ÁÁ $
)
ÁÁ$ %
{
ÂÂ '
PublishConnectionRestored
ÃÃ )
(
ÃÃ) *
	connectId
ÃÃ* 3
)
ÃÃ3 4
;
ÃÃ4 5
}
ÄÄ 
}
ÅÅ 	
catch
ÆÆ 
(
ÆÆ 
	Exception
ÆÆ 
ex
ÆÆ 
)
ÆÆ 
{
ÇÇ 	
if
ÈÈ 
(
ÈÈ 
	retryMode
ÈÈ 
==
ÈÈ 
RestoreRetryMode
ÈÈ -
.
ÈÈ- .
DirectNoRetry
ÈÈ. ;
)
ÈÈ; <
{
ÉÉ 
return
ÊÊ 
Result
ÊÊ 
<
ÊÊ 
Unit
ÊÊ "
,
ÊÊ" #
NetworkFailure
ÊÊ$ 2
>
ÊÊ2 3
.
ÊÊ3 4
Err
ÊÊ4 7
(
ÊÊ7 8
NetworkFailure
ËË "
.
ËË" #%
DataCenterNotResponding
ËË# :
(
ËË: ;
$"
ËË; =
$str
ËË= [
{
ËË[ \
ex
ËË\ ^
.
ËË^ _
Message
ËË_ f
}
ËËf g
"
ËËg h
)
ËËh i
)
ËËi j
;
ËËj k
}
ÌÌ "
restorationSucceeded
ÎÎ  
=
ÎÎ! "
false
ÎÎ# (
;
ÎÎ( )
}
ÏÏ 	
if
ÑÑ 

(
ÑÑ 
!
ÑÑ "
restorationSucceeded
ÑÑ !
)
ÑÑ! "
{
ÒÒ 	
return
ÓÓ 
Result
ÓÓ 
<
ÓÓ 
Unit
ÓÓ 
,
ÓÓ 
NetworkFailure
ÓÓ  .
>
ÓÓ. /
.
ÓÓ/ 0
Err
ÓÓ0 3
(
ÓÓ3 4
NetworkFailure
ÔÔ 
.
ÔÔ %
DataCenterNotResponding
ÔÔ 6
(
ÔÔ6 7
failureMessage
ÔÔ7 E
)
ÔÔE F
)
ÔÔF G
;
ÔÔG H
}
ÕÕ 	

ExitOutage
×× 
(
×× 
)
×× 
;
×× +
ResetRetryStrategyAfterOutage
ØØ %
(
ØØ% &
)
ØØ& '
;
ØØ' (
await
ÙÙ /
!RetryPendingRequestsAfterRecovery
ÙÙ /
(
ÙÙ/ 0
)
ÙÙ0 1
.
ÙÙ1 2
ConfigureAwait
ÙÙ2 @
(
ÙÙ@ A
false
ÙÙA F
)
ÙÙF G
;
ÙÙG H
return
ÛÛ 
Result
ÛÛ 
<
ÛÛ 
Unit
ÛÛ 
,
ÛÛ 
NetworkFailure
ÛÛ *
>
ÛÛ* +
.
ÛÛ+ ,
Ok
ÛÛ, .
(
ÛÛ. /
Unit
ÛÛ/ 3
.
ÛÛ3 4
Value
ÛÛ4 9
)
ÛÛ9 :
;
ÛÛ: ;
}
ÜÜ 
private
ÞÞ 
Result
ÞÞ 
<
ÞÞ 
(
ÞÞ 
uint
ÞÞ 
	connectId
ÞÞ "
,
ÞÞ" #
byte
ÞÞ$ (
[
ÞÞ( )
]
ÞÞ) *
membershipId
ÞÞ+ 7
)
ÞÞ7 8
,
ÞÞ8 9
NetworkFailure
ÞÞ: H
>
ÞÞH I+
ValidateRecoveryPrerequisites
ÞÞJ g
(
ÞÞg h
)
ÞÞh i
{
ßß 
if
àà 

(
àà 
!
àà *
_applicationInstanceSettings
àà )
.
àà) *
IsSome
àà* 0
)
àà0 1
{
áá 	
return
ââ 
Result
ââ 
<
ââ 
(
ââ 
uint
ââ 
,
ââ  
byte
ââ! %
[
ââ% &
]
ââ& '
)
ââ' (
,
ââ( )
NetworkFailure
ââ* 8
>
ââ8 9
.
ââ9 :
Err
ââ: =
(
ââ= >
NetworkFailure
ãã 
.
ãã  
InvalidRequestType
ãã 1
(
ãã1 2
$str
ãã2 _
)
ãã_ `
)
ãã` a
;
ããa b
}
ää 	
uint
ææ 
	connectId
ææ 
=
ææ $
ComputeUniqueConnectId
ææ /
(
ææ/ 0*
_applicationInstanceSettings
ææ0 L
.
ææL M
Value
ææM R
!
ææR S
,
ææS T 
PubKeyExchangeType
çç 
.
çç (
DataCenterEphemeralConnect
çç 9
)
çç9 :
;
çç: ;
byte
éé 
[
éé 
]
éé 
?
éé 
membershipId
éé 
=
éé "
GetMembershipIdBytes
éé 3
(
éé3 4
)
éé4 5
;
éé5 6
if
êê 

(
êê 
membershipId
êê 
==
êê 
null
êê  
)
êê  !
{
ëë 	
Log
ìì 
.
ìì 
Warning
ìì 
(
ìì 
$str
ìì w
,
ììw x
	connectId
íí 
)
íí 
;
íí 
return
îî 
Result
îî 
<
îî 
(
îî 
uint
îî 
,
îî  
byte
îî! %
[
îî% &
]
îî& '
)
îî' (
,
îî( )
NetworkFailure
îî* 8
>
îî8 9
.
îî9 :
Err
îî: =
(
îî= >
NetworkFailure
ïï 
.
ïï %
DataCenterNotResponding
ïï 6
(
ïï6 7
$str
ïï7 i
)
ïïi j
)
ïïj k
;
ïïk l
}
ðð 	
return
òò 
Result
òò 
<
òò 
(
òò 
uint
òò 
,
òò 
byte
òò !
[
òò! "
]
òò" #
)
òò# $
,
òò$ %
NetworkFailure
òò& 4
>
òò4 5
.
òò5 6
Ok
òò6 8
(
òò8 9
(
òò9 :
	connectId
òò: C
,
òòC D
membershipId
òòE Q
)
òòQ R
)
òòR S
;
òòS T
}
óó 
private
õõ 
async
õõ 
Task
õõ 
<
õõ 
Result
õõ 
<
õõ "
EcliptixSessionState
õõ 2
,
õõ2 3
NetworkFailure
õõ4 B
>
õõB C
>
õõC D%
LoadAndParseStoredState
õõE \
(
õõ\ ]
uint
öö 
	connectId
öö 
,
öö 
byte
÷÷ 
[
÷÷ 
]
÷÷ 
membershipId
÷÷ 
,
÷÷ 
bool
øø  
failOnMissingState
øø 
,
øø  
string
ùù 
failureMessage
ùù 
)
ùù 
{
úú 
Result
ûû 
<
ûû 
byte
ûû 
[
ûû 
]
ûû 
,
ûû "
SecureStorageFailure
ûû +
>
ûû+ ,
stateResult
ûû- 8
=
ûû9 :
await
üü (
secureProtocolStateStorage
üü ,
.
üü, -
LoadStateAsync
üü- ;
(
üü; <
	connectId
üü< E
.
üüE F
ToString
üüF N
(
üüN O
)
üüO P
,
üüP Q
membershipId
üüR ^
)
üü^ _
.
üü_ `
ConfigureAwait
üü` n
(
üün o
false
üüo t
)
üüt u
;
üüu v
if
þþ 

(
þþ 
stateResult
þþ 
.
þþ 
IsErr
þþ 
)
þþ 
{
ÿÿ 	
return
€€ 
Result
€€ 
<
€€ "
EcliptixSessionState
€€ .
,
€€. /
NetworkFailure
€€0 >
>
€€> ?
.
€€? @
Err
€€@ C
(
€€C D 
failOnMissingState
€€D V
?
 
NetworkFailure
  
.
  !%
DataCenterNotResponding
! 8
(
8 9
$str
9 a
)
a b
:
‚‚ 
NetworkFailure
‚‚  
.
‚‚  !%
DataCenterNotResponding
‚‚! 8
(
‚‚8 9
failureMessage
‚‚9 G
)
‚‚G H
)
‚‚H I
;
‚‚I J
}
ƒƒ 	
try
…… 
{
†† 	
byte
‡‡ 
[
‡‡ 
]
‡‡ 

stateBytes
‡‡ 
=
‡‡ 
stateResult
‡‡  +
.
‡‡+ ,
Unwrap
‡‡, 2
(
‡‡2 3
)
‡‡3 4
;
‡‡4 5"
EcliptixSessionState
ˆˆ  
state
ˆˆ! &
=
ˆˆ' ("
EcliptixSessionState
ˆˆ) =
.
ˆˆ= >
Parser
ˆˆ> D
.
ˆˆD E
	ParseFrom
ˆˆE N
(
ˆˆN O

stateBytes
ˆˆO Y
)
ˆˆY Z
;
ˆˆZ [
return
‰‰ 
Result
‰‰ 
<
‰‰ "
EcliptixSessionState
‰‰ .
,
‰‰. /
NetworkFailure
‰‰0 >
>
‰‰> ?
.
‰‰? @
Ok
‰‰@ B
(
‰‰B C
state
‰‰C H
)
‰‰H I
;
‰‰I J
}
ŠŠ 	
catch
‹‹ 
(
‹‹ 
	Exception
‹‹ 
ex
‹‹ 
)
‹‹ 
{
ŒŒ 	
return
 
Result
 
<
 "
EcliptixSessionState
 .
,
. /
NetworkFailure
0 >
>
> ?
.
? @
Err
@ C
(
C D
NetworkFailure
ŽŽ 
.
ŽŽ %
DataCenterNotResponding
ŽŽ 6
(
ŽŽ6 7
$"
ŽŽ7 9
$str
ŽŽ9 W
{
ŽŽW X
ex
ŽŽX Z
.
ŽŽZ [
Message
ŽŽ[ b
}
ŽŽb c
"
ŽŽc d
)
ŽŽd e
)
ŽŽe f
;
ŽŽf g
}
 	
}
 
private
’’ 
void
’’ '
PublishConnectionRestored
’’ *
(
’’* +
uint
’’+ /
	connectId
’’0 9
)
’’9 :
{
““ 
Avalonia
”” 
.
”” 
	Threading
”” 
.
”” 

Dispatcher
”” %
.
””% &
UIThread
””& .
.
””. /
Post
””/ 3
(
””3 4
(
””4 5
)
””5 6
=>
””7 9
{
•• 	
_
–– 
=
–– !
connectivityService
–– #
.
––# $
PublishAsync
––$ 0
(
––0 1 
ConnectivityIntent
—— "
.
——" #
	Connected
——# ,
(
——, -
	connectId
——- 6
)
——6 7
)
——7 8
.
——8 9
ContinueWith
——9 E
(
——E F
task
˜˜ 
=>
˜˜ 
{
™™ 
if
šš 
(
šš 
task
šš 
.
šš 
	IsFaulted
šš &
&&
šš' )
task
šš* .
.
šš. /
	Exception
šš/ 8
!=
šš9 ;
null
šš< @
)
šš@ A
{
›› 
Log
œœ 
.
œœ 
Error
œœ !
(
œœ! "
task
œœ" &
.
œœ& '
	Exception
œœ' 0
,
œœ0 1
$strœœ2 ‡
)œœ‡ ˆ
;œœˆ ‰
}
 
}
žž 
,
žž 
TaskScheduler
ŸŸ 
.
ŸŸ 
Default
ŸŸ %
)
ŸŸ% &
;
ŸŸ& '
}
   	
)
  	 

;
  
 
}
¡¡ 
private
££ 
void
££ +
ResetRetryStrategyAfterOutage
££ .
(
££. /
)
££/ 0
{
¤¤ 
foreach
¥¥ 
(
¥¥ 
KeyValuePair
¥¥ 
<
¥¥ 
uint
¥¥ "
,
¥¥" #$
EcliptixProtocolSystem
¥¥$ :
>
¥¥: ;

connection
¥¥< F
in
¥¥G I
_connections
¥¥J V
)
¥¥V W
{
¦¦ 	
retryStrategy
§§ 
.
§§ #
MarkConnectionHealthy
§§ /
(
§§/ 0

connection
§§0 :
.
§§: ;
Key
§§; >
)
§§> ?
;
§§? @
}
¨¨ 	
}
©© 
private
«« 
static
«« 
string
«« +
BuildSecrecyChannelPendingKey
«« 7
(
««7 8
uint
««8 <
	connectId
««= F
,
««F G 
PubKeyExchangeType
««H Z
EXCHANGE_TYPE
««[ h
)
««h i
=>
««j l
$"
¬¬ 

$str
¬¬
 
{
¬¬ 
	connectId
¬¬ $
}
¬¬$ %
$str
¬¬% &
{
¬¬& '
EXCHANGE_TYPE
¬¬' 4
}
¬¬4 5
"
¬¬5 6
;
¬¬6 7
private
®® 
static
®® 
string
®® +
BuildSecrecyChannelRestoreKey
®® 7
(
®®7 8
uint
®®8 <
	connectId
®®= F
)
®®F G
=>
®®H J
$"
¯¯ 

$str
¯¯
 "
{
¯¯" #
	connectId
¯¯# ,
}
¯¯, -
"
¯¯- .
;
¯¯. /
private
±± 
static
±± 
bool
±± ,
ShouldQueueSecrecyChannelRetry
±± 6
(
±±6 7
NetworkFailure
±±7 E
failure
±±F M
)
±±M N
{
²² 
return
³³ 
failure
³³ 
.
³³ 
FailureType
³³ "
is
³³# % 
NetworkFailureType
³³& 8
.
³³8 9(
DATA_CENTER_NOT_RESPONDING
³³9 S
or
´´  
NetworkFailureType
´´ !
.
´´! ""
DATA_CENTER_SHUTDOWN
´´" 6
or
µµ  
NetworkFailureType
µµ !
.
µµ! "%
PROTOCOL_STATE_MISMATCH
µµ" 9
or
¶¶  
NetworkFailureType
¶¶ !
.
¶¶! "$
RSA_ENCRYPTION_FAILURE
¶¶" 8
;
¶¶8 9
}
·· 
private
¹¹ 
void
¹¹ /
!QueueSecrecyChannelEstablishRetry
¹¹ 2
(
¹¹2 3
uint
¹¹3 7
	connectId
¹¹8 A
,
¹¹A B 
PubKeyExchangeType
¹¹C U
EXCHANGE_TYPE
¹¹V c
,
¹¹c d
int
¹¹e h
?
¹¹h i

maxRetries
¹¹j t
,
¹¹t u
bool
ºº 
	saveState
ºº 
)
ºº 
{
»» 
if
¼¼ 

(
¼¼ 
	_disposed
¼¼ 
)
¼¼ 
{
½½ 	
return
¾¾ 
;
¾¾ 
}
¿¿ 	2
$BeginSecrecyChannelEstablishRecovery
ÁÁ ,
(
ÁÁ, -
)
ÁÁ- .
;
ÁÁ. /
string
ÃÃ 

pendingKey
ÃÃ 
=
ÃÃ +
BuildSecrecyChannelPendingKey
ÃÃ 9
(
ÃÃ9 :
	connectId
ÃÃ: C
,
ÃÃC D
EXCHANGE_TYPE
ÃÃE R
)
ÃÃR S
;
ÃÃS T#
pendingRequestManager
ÅÅ 
.
ÅÅ $
RegisterPendingRequest
ÅÅ 4
(
ÅÅ4 5

pendingKey
ÅÅ5 ?
,
ÅÅ? @
async
ÅÅA F
ct
ÅÅG I
=>
ÅÅJ L
{
ÆÆ 	
CancellationToken
ÇÇ 
recoveryToken
ÇÇ +
=
ÇÇ, -(
GetConnectionRecoveryToken
ÇÇ. H
(
ÇÇH I
)
ÇÇI J
;
ÇÇJ K
using
ÈÈ %
CancellationTokenSource
ÈÈ )
	linkedCts
ÈÈ* 3
=
ÈÈ4 5%
CancellationTokenSource
ÉÉ '
.
ÉÉ' (%
CreateLinkedTokenSource
ÉÉ( ?
(
ÉÉ? @
ct
ÉÉ@ B
,
ÉÉB C
recoveryToken
ÉÉD Q
)
ÉÉQ R
;
ÉÉR S
await
ËË 2
$EstablishSecrecyChannelInternalAsync
ËË 6
(
ËË6 7
	connectId
ÌÌ 
,
ÌÌ 
EXCHANGE_TYPE
ÍÍ !
,
ÍÍ! "

maxRetries
ÎÎ 
,
ÎÎ 
	saveState
ÏÏ 
,
ÏÏ 
cancellationToken
ÐÐ %
:
ÐÐ% &
	linkedCts
ÐÐ' 0
.
ÐÐ0 1
Token
ÐÐ1 6
,
ÐÐ6 7'
enablePendingRegistration
ÑÑ -
:
ÑÑ- .
false
ÑÑ/ 4
)
ÑÑ4 5
.
ÒÒ 
ConfigureAwait
ÒÒ 
(
ÒÒ  
false
ÒÒ  %
)
ÒÒ% &
;
ÒÒ& '
}
ÓÓ 	
)
ÓÓ	 

;
ÓÓ
 
}
ÔÔ 
private
ÖÖ 
void
ÖÖ -
QueueSecrecyChannelRestoreRetry
ÖÖ 0
(
ÖÖ0 1"
EcliptixSessionState
×× 
sessionState
×× )
,
××) *)
ApplicationInstanceSettings
ØØ #)
applicationInstanceSettings
ØØ$ ?
,
ØØ? @
RestoreRetryMode
ÙÙ 
	retryMode
ÙÙ "
)
ÙÙ" #
{
ÚÚ 
if
ÛÛ 

(
ÛÛ 
	_disposed
ÛÛ 
)
ÛÛ 
{
ÜÜ 	
return
ÝÝ 
;
ÝÝ 
}
ÞÞ 	2
$BeginSecrecyChannelEstablishRecovery
àà ,
(
àà, -
)
àà- .
;
àà. /
string
ââ 

pendingKey
ââ 
=
ââ +
BuildSecrecyChannelRestoreKey
ââ 9
(
ââ9 :
sessionState
ââ: F
.
ââF G
	ConnectId
ââG P
)
ââP Q
;
ââQ R#
pendingRequestManager
ää 
.
ää $
RegisterPendingRequest
ää 4
(
ää4 5

pendingKey
ää5 ?
,
ää? @
async
ääA F
ct
ääG I
=>
ääJ L
{
åå 	
CancellationToken
ææ 
recoveryToken
ææ +
=
ææ, -(
GetConnectionRecoveryToken
ææ. H
(
ææH I
)
ææI J
;
ææJ K
using
çç %
CancellationTokenSource
çç )
	linkedCts
çç* 3
=
çç4 5%
CancellationTokenSource
èè '
.
èè' (%
CreateLinkedTokenSource
èè( ?
(
èè? @
ct
èè@ B
,
èèB C
recoveryToken
èèD Q
)
èèQ R
;
èèR S
await
êê (
RestoreSecrecyChannelAsync
êê ,
(
êê, -
sessionState
ëë  
,
ëë  !)
applicationInstanceSettings
ìì /
,
ìì/ 0
	retryMode
íí 
,
íí '
enablePendingRegistration
îî -
:
îî- .
false
îî/ 4
,
îî4 5
cancellationToken
ïï %
:
ïï% &
	linkedCts
ïï' 0
.
ïï0 1
Token
ïï1 6
)
ïï6 7
.
ðð 
ConfigureAwait
ðð 
(
ðð  
false
ðð  %
)
ðð% &
;
ðð& '
}
ññ 	
)
ññ	 

;
ññ
 
}
òò 
private
ôô 
byte
ôô 
[
ôô 
]
ôô 
?
ôô "
GetMembershipIdBytes
ôô (
(
ôô( )
)
ôô) *
{
õõ 
if
öö 

(
öö 
!
öö *
_applicationInstanceSettings
öö )
.
öö) *
IsSome
öö* 0
)
öö0 1
{
÷÷ 	
return
øø 
null
øø 
;
øø 
}
ùù 	)
ApplicationInstanceSettings
ûû #
settings
ûû$ ,
=
ûû- .*
_applicationInstanceSettings
ûû/ K
.
ûûK L
Value
ûûL Q
!
ûûQ R
;
ûûR S
return
ýý 
settings
ýý 
.
ýý 

Membership
ýý "
?
ýý" #
.
ýý# $
UniqueIdentifier
ýý$ 4
.
ýý4 5
ToByteArray
ýý5 @
(
ýý@ A
)
ýýA B
;
ýýB C
}
þþ 
private
€€ 
async
€€ 
Task
€€ &
PersistSessionStateAsync
€€ /
(
€€/ 0"
EcliptixSessionState
€€0 D
state
€€E J
,
€€J K
uint
€€L P
	connectId
€€Q Z
,
€€Z [
byte
 
[
 
]
 
?
 "
membershipIdOverride
 $
=
% &
null
' +
)
+ ,
{
‚‚ 
byte
ƒƒ 
[
ƒƒ 
]
ƒƒ 
?
ƒƒ 
membershipId
ƒƒ 
=
ƒƒ "
membershipIdOverride
ƒƒ 3
??
ƒƒ4 6"
GetMembershipIdBytes
ƒƒ7 K
(
ƒƒK L
)
ƒƒL M
;
ƒƒM N
if
„„ 

(
„„ 
membershipId
„„ 
==
„„ 
null
„„  
)
„„  !
{
…… 	
Log
†† 
.
†† 
Warning
†† 
(
†† 
$str
†† s
,
††s t
	connectId
‡‡ 
)
‡‡ 
;
‡‡ 
return
ˆˆ 
;
ˆˆ 
}
‰‰ 	
Result
‹‹ 
<
‹‹ 
Unit
‹‹ 
,
‹‹ "
SecureStorageFailure
‹‹ )
>
‹‹) *

saveResult
‹‹+ 5
=
‹‹6 7
await
‹‹8 =%
SecureByteStringInterop
‹‹> U
.
‹‹U V"
WithByteStringAsSpan
‹‹V j
(
‹‹j k
state
ŒŒ 
.
ŒŒ 
ToByteString
ŒŒ "
(
ŒŒ" #
)
ŒŒ# $
,
ŒŒ$ %
span
 
=>
 (
secureProtocolStateStorage
 2
.
2 3
SaveStateAsync
3 A
(
A B
span
B F
.
F G
ToArray
G N
(
N O
)
O P
,
P Q
	connectId
R [
.
[ \
ToString
\ d
(
d e
)
e f
,
f g
membershipId
h t
)
t u
)
u v
.
ŽŽ 
ConfigureAwait
ŽŽ 
(
ŽŽ 
false
ŽŽ !
)
ŽŽ! "
;
ŽŽ" #
if
 

(
 

saveResult
 
.
 
IsErr
 
)
 
{
‘‘ 	
Log
’’ 
.
’’ 
Warning
’’ 
(
’’ 
$str
’’ u
,
’’u v
	connectId
““ 
,
““ 

saveResult
““ %
.
““% &
	UnwrapErr
““& /
(
““/ 0
)
““0 1
.
““1 2
Message
““2 9
)
““9 :
;
““: ;
}
”” 	
string
–– 
timestampKey
–– 
=
–– 
$"
––  
{
––  !
	connectId
––! *
}
––* +
$str
––+ 5
"
––5 6
;
––6 7
await
—— .
 applicationSecureStorageProvider
—— .
.
——. /

StoreAsync
——/ 9
(
——9 :
timestampKey
——: F
,
——F G
BitConverter
˜˜ 
.
˜˜ 
GetBytes
˜˜ !
(
˜˜! "
DateTime
˜˜" *
.
˜˜* +
UtcNow
˜˜+ 1
.
˜˜1 2
ToBinary
˜˜2 :
(
˜˜: ;
)
˜˜; <
)
˜˜< =
)
˜˜= >
.
˜˜> ?
ConfigureAwait
˜˜? M
(
˜˜M N
false
˜˜N S
)
˜˜S T
;
˜˜T U
}
™™ 
public
›› 

bool
›› !
IsConnectionHealthy
›› #
(
››# $
uint
››$ (
	connectId
››) 2
)
››2 3
{
œœ 
if
 

(
 
!
 
_connections
 
.
 
TryGetValue
 %
(
% &
	connectId
& /
,
/ 0
out
1 4$
EcliptixProtocolSystem
5 K
?
K L
protocolSystem
M [
)
[ \
)
\ ]
{
žž 	
return
ŸŸ 
false
ŸŸ 
;
ŸŸ 
}
   	(
EcliptixProtocolConnection
¢¢ "
?
¢¢" #

connection
¢¢$ .
=
¢¢/ 0
protocolSystem
¢¢1 ?
.
¢¢? @
GetConnection
¢¢@ M
(
¢¢M N
)
¢¢N O
;
¢¢O P
if
££ 

(
££ 

connection
££ 
==
££ 
null
££ 
)
££ 
{
¤¤ 	
return
¥¥ 
false
¥¥ 
;
¥¥ 
}
¦¦ 	
Result
¨¨ 
<
¨¨ "
LocalPublicKeyBundle
¨¨ #
,
¨¨# $%
EcliptixProtocolFailure
¨¨% <
>
¨¨< =
peerBundleResult
¨¨> N
=
¨¨O P

connection
¨¨Q [
.
¨¨[ \
GetPeerBundle
¨¨\ i
(
¨¨i j
)
¨¨j k
;
¨¨k l
return
©© 
peerBundleResult
©© 
.
©©  
IsOk
©©  $
;
©©$ %
}
ªª 
public
¬¬ 

async
¬¬ 
Task
¬¬ 
<
¬¬ 
Result
¬¬ 
<
¬¬ 
bool
¬¬ !
,
¬¬! "
NetworkFailure
¬¬# 1
>
¬¬1 2
>
¬¬2 3'
TryRestoreConnectionAsync
¬¬4 M
(
¬¬M N
uint
¬¬N R
	connectId
¬¬S \
)
¬¬\ ]
{
­­ 
return
®® 
await
®® 
WithChannelGate
®® $
(
®®$ %
	connectId
®®% .
,
®®. /
async
®®0 5
(
®®6 7
)
®®7 8
=>
®®9 ;
{
¯¯ 	
try
°° 
{
±± 
byte
²² 
[
²² 
]
²² 
?
²² 
membershipId
²² $
=
²²% &"
GetMembershipIdBytes
²²' ;
(
²²; <
)
²²< =
;
²²= >
if
³³ 
(
³³ 
membershipId
³³  
==
³³! #
null
³³$ (
)
³³( )
{
´´ 
if
µµ 
(
µµ 
_connections
µµ $
.
µµ$ %
	TryRemove
µµ% .
(
µµ. /
	connectId
µµ/ 8
,
µµ8 9
out
µµ: =$
EcliptixProtocolSystem
µµ> T
?
µµT U
	oldSystem
µµV _
)
µµ_ `
)
µµ` a
{
¶¶ 
	oldSystem
·· !
.
··! "
Dispose
··" )
(
··) *
)
··* +
;
··+ ,
}
¸¸ 
Result
ºº 
<
ºº 
Option
ºº !
<
ºº! ""
EcliptixSessionState
ºº" 6
>
ºº6 7
,
ºº7 8
NetworkFailure
ºº9 G
>
ººG H
reEstablishResult
ººI Z
=
ºº[ \
await
»» 2
$EstablishSecrecyChannelInternalAsync
»» B
(
»»B C
	connectId
¼¼ %
,
¼¼% & 
PubKeyExchangeType
½½ .
.
½½. /(
DataCenterEphemeralConnect
½½/ I
,
½½I J
	saveState
¾¾ %
:
¾¾% &
false
¾¾' ,
,
¾¾, -'
enablePendingRegistration
¿¿ 5
:
¿¿5 6
false
¿¿7 <
)
¿¿< =
.
¿¿= >
ConfigureAwait
¿¿> L
(
¿¿L M
false
¿¿M R
)
¿¿R S
;
¿¿S T
return
ÁÁ 
reEstablishResult
ÁÁ ,
.
ÁÁ, -
IsOk
ÁÁ- 1
?
ÂÂ 
Result
ÂÂ  
<
ÂÂ  !
bool
ÂÂ! %
,
ÂÂ% &
NetworkFailure
ÂÂ' 5
>
ÂÂ5 6
.
ÂÂ6 7
Ok
ÂÂ7 9
(
ÂÂ9 :
true
ÂÂ: >
)
ÂÂ> ?
:
ÃÃ 
Result
ÃÃ  
<
ÃÃ  !
bool
ÃÃ! %
,
ÃÃ% &
NetworkFailure
ÃÃ' 5
>
ÃÃ5 6
.
ÃÃ6 7
Ok
ÃÃ7 9
(
ÃÃ9 :
false
ÃÃ: ?
)
ÃÃ? @
;
ÃÃ@ A
}
ÄÄ 
Result
ÆÆ 
<
ÆÆ 
byte
ÆÆ 
[
ÆÆ 
]
ÆÆ 
,
ÆÆ "
SecureStorageFailure
ÆÆ 3
>
ÆÆ3 4
stateResult
ÆÆ5 @
=
ÆÆA B
await
ÇÇ (
secureProtocolStateStorage
ÇÇ 4
.
ÇÇ4 5
LoadStateAsync
ÇÇ5 C
(
ÇÇC D
	connectId
ÇÇD M
.
ÇÇM N
ToString
ÇÇN V
(
ÇÇV W
)
ÇÇW X
,
ÇÇX Y
membershipId
ÇÇZ f
)
ÇÇf g
.
ÈÈ 
ConfigureAwait
ÈÈ '
(
ÈÈ' (
false
ÈÈ( -
)
ÈÈ- .
;
ÈÈ. /
if
ÉÉ 
(
ÉÉ 
stateResult
ÉÉ 
.
ÉÉ  
IsErr
ÉÉ  %
)
ÉÉ% &
{
ÊÊ 
return
ËË 
Result
ËË !
<
ËË! "
bool
ËË" &
,
ËË& '
NetworkFailure
ËË( 6
>
ËË6 7
.
ËË7 8
Ok
ËË8 :
(
ËË: ;
false
ËË; @
)
ËË@ A
;
ËËA B
}
ÌÌ 
byte
ÎÎ 
[
ÎÎ 
]
ÎÎ 

stateBytes
ÎÎ !
=
ÎÎ" #
stateResult
ÎÎ$ /
.
ÎÎ/ 0
Unwrap
ÎÎ0 6
(
ÎÎ6 7
)
ÎÎ7 8
;
ÎÎ8 9"
EcliptixSessionState
ÏÏ $
state
ÏÏ% *
=
ÏÏ+ ,"
EcliptixSessionState
ÏÏ- A
.
ÏÏA B
Parser
ÏÏB H
.
ÏÏH I
	ParseFrom
ÏÏI R
(
ÏÏR S

stateBytes
ÏÏS ]
)
ÏÏ] ^
;
ÏÏ^ _
Result
ÐÐ 
<
ÐÐ 
bool
ÐÐ 
,
ÐÐ 
NetworkFailure
ÐÐ +
>
ÐÐ+ ,
restoreResult
ÐÐ- :
=
ÐÐ; <
await
ÑÑ (
RestoreSecrecyChannelAsync
ÑÑ 4
(
ÑÑ4 5
state
ÑÑ5 :
,
ÑÑ: ;*
_applicationInstanceSettings
ÑÑ< X
.
ÑÑX Y
Value
ÑÑY ^
!
ÑÑ^ _
)
ÑÑ_ `
.
ÑÑ` a
ConfigureAwait
ÑÑa o
(
ÑÑo p
false
ÑÑp u
)
ÑÑu v
;
ÑÑv w
return
ÓÓ 
restoreResult
ÓÓ $
;
ÓÓ$ %
}
ÔÔ 
catch
ÕÕ 
(
ÕÕ 
	Exception
ÕÕ 
)
ÕÕ 
{
ÖÖ 
return
×× 
Result
×× 
<
×× 
bool
×× "
,
××" #
NetworkFailure
××$ 2
>
××2 3
.
××3 4
Ok
××4 6
(
××6 7
false
××7 <
)
××< =
;
××= >
}
ØØ 
}
ÙÙ 	
)
ÙÙ	 

;
ÙÙ
 
}
ÚÚ 
public
ÜÜ 

async
ÜÜ 
Task
ÜÜ 
<
ÜÜ 
Result
ÜÜ 
<
ÜÜ 
Unit
ÜÜ !
,
ÜÜ! "
NetworkFailure
ÜÜ# 1
>
ÜÜ1 2
>
ÜÜ2 30
"RecreateProtocolWithMasterKeyAsync
ÜÜ4 V
(
ÜÜV W&
SodiumSecureMemoryHandle
ÝÝ  
masterKeyHandle
ÝÝ! 0
,
ÝÝ0 1

ByteString
ÞÞ "
membershipIdentifier
ÞÞ '
,
ÞÞ' (
uint
ßß 
	connectId
ßß 
)
ßß 
{
àà 
RetryBehavior
áá 
retryBehavior
áá #
=
áá$ %!
retryPolicyProvider
ââ 
.
ââ  
GetRetryBehavior
ââ  0
(
ââ0 1
RpcServiceType
ââ1 ?
.
ââ? @1
#EstablishAuthenticatedSecureChannel
ââ@ c
)
ââc d
;
ââd e
Result
ãã 
<
ãã 
Unit
ãã 
,
ãã 
NetworkFailure
ãã #
>
ãã# $
networkResult
ãã% 2
=
ãã3 4
await
ãã5 :
retryStrategy
ãã; H
.
ããH I&
ExecuteRpcOperationAsync
ããI a
(
ããa b
async
ää 
(
ää 
_
ää 
,
ää 
_
ää 
)
ää 
=>
ää 
await
ää !8
*RecreateProtocolWithMasterKeyAsyncInternal
ää" L
(
ääL M
masterKeyHandle
åå 
,
åå  "
membershipIdentifier
ææ $
,
ææ$ %
	connectId
çç 
)
çç 
.
çç 
ConfigureAwait
çç )
(
çç) *
false
çç* /
)
çç/ 0
,
çç0 1
$str
èè +
,
èè+ ,
	connectId
éé 
,
éé 
serviceType
êê 
:
êê 
RpcServiceType
êê '
.
êê' (1
#EstablishAuthenticatedSecureChannel
êê( K
,
êêK L

maxRetries
ëë 
:
ëë 
retryBehavior
ëë %
.
ëë% &
MAX_ATTEMPTS
ëë& 2
-
ëë3 4
$num
ëë5 6
,
ëë6 7
cancellationToken
ìì 
:
ìì 
CancellationToken
ìì 0
.
ìì0 1
None
ìì1 5
)
ìì5 6
.
ìì6 7
ConfigureAwait
ìì7 E
(
ììE F
false
ììF K
)
ììK L
;
ììL M
if
îî 

(
îî 
networkResult
îî 
.
îî 
IsOk
îî 
&&
îî !
Volatile
îî" *
.
îî* +
Read
îî+ /
(
îî/ 0
ref
îî0 3
_outageState
îî4 @
)
îî@ A
==
îîB D
$num
îîE F
)
îîF G
{
ïï 	

ExitOutage
ðð 
(
ðð 
)
ðð 
;
ðð 
}
ññ 	
return
óó 
networkResult
óó 
;
óó 
}
ôô 
private
öö 
async
öö 
Task
öö 
<
öö 
Result
öö 
<
öö 
Unit
öö "
,
öö" #
NetworkFailure
öö$ 2
>
öö2 3
>
öö3 48
*RecreateProtocolWithMasterKeyAsyncInternal
öö5 _
(
öö_ `&
SodiumSecureMemoryHandle
÷÷  
masterKeyHandle
÷÷! 0
,
÷÷0 1

ByteString
øø "
membershipIdentifier
øø '
,
øø' (
uint
ùù 
	connectId
ùù 
)
ùù 
{
úú 
byte
ûû 
[
ûû 
]
ûû 
?
ûû 
masterKeyBytes
ûû 
=
ûû  
null
ûû! %
;
ûû% &
byte
üü 
[
üü 
]
üü 
?
üü 
rootKeyBytes
üü 
=
üü 
null
üü #
;
üü# $
try
þþ 
{
ÿÿ 	
Result
€€ 
<
€€ 
byte
€€ 
[
€€ 
]
€€ 
,
€€ 
SodiumFailure
€€ (
>
€€( )

readResult
€€* 4
=
€€5 6
masterKeyHandle
€€7 F
.
€€F G
	ReadBytes
€€G P
(
€€P Q
masterKeyHandle
€€Q `
.
€€` a
Length
€€a g
)
€€g h
;
€€h i
if
 
(
 

readResult
 
.
 
IsErr
  
)
  !
{
‚‚ 
return
ƒƒ 
Result
ƒƒ 
<
ƒƒ 
Unit
ƒƒ "
,
ƒƒ" #
NetworkFailure
ƒƒ$ 2
>
ƒƒ2 3
.
ƒƒ3 4
Err
ƒƒ4 7
(
ƒƒ7 8
NetworkFailure
„„ "
.
„„" #%
DataCenterNotResponding
„„# :
(
„„: ;
$"
…… 
$str
…… 5
{
……5 6

readResult
……6 @
.
……@ A
	UnwrapErr
……A J
(
……J K
)
……K L
.
……L M
Message
……M T
}
……T U
"
……U V
)
……V W
)
……W X
;
……X Y
}
†† 
masterKeyBytes
ˆˆ 
=
ˆˆ 

readResult
ˆˆ '
.
ˆˆ' (
Unwrap
ˆˆ( .
(
ˆˆ. /
)
ˆˆ/ 0
;
ˆˆ0 1
string
‰‰ 
membershipId
‰‰ 
=
‰‰  !
Helpers
‰‰" )
.
‰‰) *"
FromByteStringToGuid
‰‰* >
(
‰‰> ?"
membershipIdentifier
‰‰? S
)
‰‰S T
.
‰‰T U
ToString
‰‰U ]
(
‰‰] ^
)
‰‰^ _
;
‰‰_ `
rootKeyBytes
‹‹ 
=
‹‹ 
new
‹‹ 
byte
‹‹ #
[
‹‹# $$
CryptographicConstants
‹‹$ :
.
‹‹: ;
AES_KEY_SIZE
‹‹; G
]
‹‹G H
;
‹‹H I
HKDF
ŒŒ 
.
ŒŒ 
	DeriveKey
ŒŒ 
(
ŒŒ 
HashAlgorithmName
 !
.
! "
SHA256
" (
,
( )
ikm
ŽŽ 
:
ŽŽ 
masterKeyBytes
ŽŽ #
,
ŽŽ# $
output
 
:
 
rootKeyBytes
 $
,
$ %
salt
 
:
 
null
 
,
 
info
‘‘ 
:
‘‘ 
$str
‘‘ 4
.
‘‘4 5
ToArray
‘‘5 <
(
‘‘< =
)
‘‘= >
)
’’ 
;
’’ 
Result
”” 
<
”” (
EcliptixSystemIdentityKeys
”” -
,
””- .%
EcliptixProtocolFailure
””/ F
>
””F G 
identityKeysResult
””H Z
=
””[ \(
EcliptixSystemIdentityKeys
•• *
.
••* +!
CreateFromMasterKey
••+ >
(
••> ?
masterKeyBytes
••? M
,
••M N
membershipId
••O [
,
••[ \
NetworkConstants
–– $
.
––$ %
Protocol
––% -
.
––- .(
DEFAULT_ONE_TIME_KEY_COUNT
––. H
)
––H I
;
––I J
if
˜˜ 
(
˜˜  
identityKeysResult
˜˜ "
.
˜˜" #
IsErr
˜˜# (
)
˜˜( )
{
™™ 
return
šš 
Result
šš 
<
šš 
Unit
šš "
,
šš" #
NetworkFailure
šš$ 2
>
šš2 3
.
šš3 4
Err
šš4 7
(
šš7 8 
identityKeysResult
›› &
.
››& '
	UnwrapErr
››' 0
(
››0 1
)
››1 2
.
››2 3
ToNetworkFailure
››3 C
(
››C D
)
››D E
)
››E F
;
››F G
}
œœ (
EcliptixSystemIdentityKeys
žž &
identityKeys
žž' 3
=
žž4 5 
identityKeysResult
žž6 H
.
žžH I
Unwrap
žžI O
(
žžO P
)
žžP Q
;
žžQ R
if
   
(
   
_connections
   
.
   
	TryRemove
   &
(
  & '
	connectId
  ' 0
,
  0 1
out
  2 5$
EcliptixProtocolSystem
  6 L
?
  L M
oldProtocol
  N Y
)
  Y Z
)
  Z [
{
¡¡ +
CancelOperationsForConnection
¢¢ -
(
¢¢- .
	connectId
¢¢. 7
)
¢¢7 8
;
¢¢8 9
oldProtocol
££ 
.
££ 
Dispose
££ #
(
££# $
)
££$ %
;
££% &
}
¤¤ 
const
¦¦  
PubKeyExchangeType
¦¦ $
EXCHANGE_TYPE
¦¦% 2
=
¦¦3 4 
PubKeyExchangeType
¦¦5 G
.
¦¦G H(
DataCenterEphemeralConnect
¦¦H b
;
¦¦b c$
EcliptixProtocolSystem
§§ "
?
§§" #
newProtocol
§§$ /
=
§§0 1
new
§§2 5
(
§§5 6
identityKeys
§§6 B
)
§§B C
;
§§C D
try
©© 
{
ªª 
newProtocol
«« 
.
«« 
SetEventHandler
«« +
(
««+ ,
this
««, 0
)
««0 1
;
««1 2
Result
­­ 
<
­­ 
PubKeyExchange
­­ %
,
­­% &%
EcliptixProtocolFailure
­­' >
>
­­> ?"
clientExchangeResult
­­@ T
=
­­U V
newProtocol
®® 
.
®®  +
BeginDataCenterPubKeyExchange
®®  =
(
®®= >
	connectId
®®> G
,
®®G H
EXCHANGE_TYPE
®®I V
)
®®V W
;
®®W X
if
°° 
(
°° "
clientExchangeResult
°° (
.
°°( )
IsErr
°°) .
)
°°. /
{
±± 
await
²² .
 CleanupFailedAuthenticationAsync
²² :
(
²²: ;
	connectId
²²; D
)
²²D E
.
²²E F
ConfigureAwait
²²F T
(
²²T U
false
²²U Z
)
²²Z [
;
²²[ \
return
³³ 
Result
³³ !
<
³³! "
Unit
³³" &
,
³³& '
NetworkFailure
³³( 6
>
³³6 7
.
³³7 8
Err
³³8 ;
(
³³; <"
clientExchangeResult
´´ ,
.
´´, -
	UnwrapErr
´´- 6
(
´´6 7
)
´´7 8
.
´´8 9
ToNetworkFailure
´´9 I
(
´´I J
)
´´J K
)
´´K L
;
´´L M
}
µµ 
PubKeyExchange
·· 
clientExchange
·· -
=
··. /"
clientExchangeResult
··0 D
.
··D E
Unwrap
··E K
(
··K L
)
··L M
;
··M N+
AuthenticatedEstablishRequest
¹¹ -"
authenticatedRequest
¹¹. B
=
¹¹C D
new
¹¹E H
(
¹¹H I
)
¹¹I J
{
ºº  
MembershipUniqueId
»» &
=
»»' ("
membershipIdentifier
»») =
,
»»= >"
ClientPubKeyExchange
¼¼ (
=
¼¼) *
clientExchange
¼¼+ 9
}
½½ 
;
½½ 
Result
¿¿ 
<
¿¿ 
SecureEnvelope
¿¿ %
,
¿¿% &
NetworkFailure
¿¿' 5
>
¿¿5 6"
serverResponseResult
¿¿7 K
=
¿¿L M
await
ÀÀ 
rpcServiceManager
ÀÀ +
.
ÀÀ+ ,6
(EstablishAuthenticatedSecureChannelAsync
ÀÀ, T
(
ÀÀT U!
connectivityService
ÁÁ +
,
ÁÁ+ ,"
authenticatedRequest
ÁÁ- A
)
ÁÁA B
.
ÁÁB C
ConfigureAwait
ÁÁC Q
(
ÁÁQ R
false
ÁÁR W
)
ÁÁW X
;
ÁÁX Y
if
ÃÃ 
(
ÃÃ "
serverResponseResult
ÃÃ (
.
ÃÃ( )
IsErr
ÃÃ) .
)
ÃÃ. /
{
ÄÄ 
NetworkFailure
ÅÅ "
failure
ÅÅ# *
=
ÅÅ+ ,"
serverResponseResult
ÅÅ- A
.
ÅÅA B
	UnwrapErr
ÅÅB K
(
ÅÅK L
)
ÅÅL M
;
ÅÅM N
await
ÆÆ .
 CleanupFailedAuthenticationAsync
ÆÆ :
(
ÆÆ: ;
	connectId
ÆÆ; D
)
ÆÆD E
.
ÆÆE F
ConfigureAwait
ÆÆF T
(
ÆÆT U
false
ÆÆU Z
)
ÆÆZ [
;
ÆÆ[ \
return
ÇÇ 
Result
ÇÇ !
<
ÇÇ! "
Unit
ÇÇ" &
,
ÇÇ& '
NetworkFailure
ÇÇ( 6
>
ÇÇ6 7
.
ÇÇ7 8
Err
ÇÇ8 ;
(
ÇÇ; <
failure
ÇÇ< C
)
ÇÇC D
;
ÇÇD E
}
ÈÈ 
SecureEnvelope
ÊÊ 
responseEnvelope
ÊÊ /
=
ÊÊ0 1"
serverResponseResult
ÊÊ2 F
.
ÊÊF G
Unwrap
ÊÊG M
(
ÊÊM N
)
ÊÊN O
;
ÊÊO P
Option
ÌÌ 
<
ÌÌ '
CertificatePinningService
ÌÌ 0
>
ÌÌ0 1'
certificatePinningService
ÌÌ2 K
=
ÌÌL M
await
ÍÍ .
 certificatePinningServiceFactory
ÍÍ :
.
ÍÍ: ;)
GetOrInitializeServiceAsync
ÍÍ; V
(
ÍÍV W
)
ÍÍW X
;
ÍÍX Y
if
ÏÏ 
(
ÏÏ 
!
ÏÏ '
certificatePinningService
ÏÏ .
.
ÏÏ. /
IsSome
ÏÏ/ 5
)
ÏÏ5 6
{
ÐÐ 
await
ÑÑ .
 CleanupFailedAuthenticationAsync
ÑÑ :
(
ÑÑ: ;
	connectId
ÑÑ; D
)
ÑÑD E
.
ÑÑE F
ConfigureAwait
ÑÑF T
(
ÑÑT U
false
ÑÑU Z
)
ÑÑZ [
;
ÑÑ[ \
return
ÒÒ 
Result
ÒÒ !
<
ÒÒ! "
Unit
ÒÒ" &
,
ÒÒ& '
NetworkFailure
ÒÒ( 6
>
ÒÒ6 7
.
ÒÒ7 8
Err
ÒÒ8 ;
(
ÒÒ; <
NetworkFailure
ÓÓ &
.
ÓÓ& '
RsaEncryption
ÓÓ' 4
(
ÓÓ4 5
$str
ÓÓ5 g
)
ÓÓg h
)
ÓÓh i
;
ÓÓi j
}
ÔÔ 
byte
ÖÖ 
[
ÖÖ 
]
ÖÖ '
combinedEncryptedResponse
ÖÖ 0
=
ÖÖ1 2
responseEnvelope
ÖÖ3 C
.
ÖÖC D
EncryptedPayload
ÖÖD T
.
ÖÖT U
ToByteArray
ÖÖU `
(
ÖÖ` a
)
ÖÖa b
;
ÖÖb c
Result
×× 
<
×× 
byte
×× 
[
×× 
]
×× 
,
×× 
NetworkFailure
×× -
>
××- .
decryptResult
××/ <
=
××= >
rsaChunkEncryptor
ØØ %
.
ØØ% &
DecryptInChunks
ØØ& 5
(
ØØ5 6'
certificatePinningService
ØØ6 O
.
ØØO P
Value
ØØP U
!
ØØU V
,
ØØV W'
combinedEncryptedResponse
ØØX q
)
ØØq r
;
ØØr s
if
ÚÚ 
(
ÚÚ 
decryptResult
ÚÚ !
.
ÚÚ! "
IsErr
ÚÚ" '
)
ÚÚ' (
{
ÛÛ 
await
ÜÜ .
 CleanupFailedAuthenticationAsync
ÜÜ :
(
ÜÜ: ;
	connectId
ÜÜ; D
)
ÜÜD E
.
ÜÜE F
ConfigureAwait
ÜÜF T
(
ÜÜT U
false
ÜÜU Z
)
ÜÜZ [
;
ÜÜ[ \
return
ÝÝ 
Result
ÝÝ !
<
ÝÝ! "
Unit
ÝÝ" &
,
ÝÝ& '
NetworkFailure
ÝÝ( 6
>
ÝÝ6 7
.
ÝÝ7 8
Err
ÝÝ8 ;
(
ÝÝ; <
decryptResult
ÝÝ< I
.
ÝÝI J
	UnwrapErr
ÝÝJ S
(
ÝÝS T
)
ÝÝT U
)
ÝÝU V
;
ÝÝV W
}
ÞÞ 
PubKeyExchange
àà 
serverExchange
àà -
=
àà. /
PubKeyExchange
àà0 >
.
àà> ?
Parser
àà? E
.
ààE F
	ParseFrom
ààF O
(
ààO P
decryptResult
ààP ]
.
àà] ^
Unwrap
àà^ d
(
ààd e
)
ààe f
)
ààf g
;
ààg h
Result
ââ 
<
ââ 
Unit
ââ 
,
ââ %
EcliptixProtocolFailure
ââ 4
>
ââ4 5
completeResult
ââ6 D
=
ââE F
newProtocol
ãã 
.
ãã  1
#CompleteAuthenticatedPubKeyExchange
ãã  C
(
ããC D
serverExchange
ããD R
,
ããR S
rootKeyBytes
ããT `
)
ãã` a
;
ããa b
if
åå 
(
åå 
completeResult
åå "
.
åå" #
IsErr
åå# (
)
åå( )
{
ææ 
await
çç .
 CleanupFailedAuthenticationAsync
çç :
(
çç: ;
	connectId
çç; D
)
ççD E
.
ççE F
ConfigureAwait
ççF T
(
ççT U
false
ççU Z
)
ççZ [
;
çç[ \
return
èè 
Result
èè !
<
èè! "
Unit
èè" &
,
èè& '
NetworkFailure
èè( 6
>
èè6 7
.
èè7 8
Err
èè8 ;
(
èè; <
completeResult
éé &
.
éé& '
	UnwrapErr
éé' 0
(
éé0 1
)
éé1 2
.
éé2 3
ToNetworkFailure
éé3 C
(
ééC D
)
ééD E
)
ééE F
;
ééF G
}
êê 
_connections
ìì 
.
ìì 
TryAdd
ìì #
(
ìì# $
	connectId
ìì$ -
,
ìì- .
newProtocol
ìì/ :
)
ìì: ;
;
ìì; <(
EcliptixProtocolConnection
îî *
?
îî* +

connection
îî, 6
=
îî7 8
newProtocol
îî9 D
.
îîD E
GetConnection
îîE R
(
îîR S
)
îîS T
;
îîT U
if
ïï 
(
ïï 

connection
ïï 
!=
ïï !
null
ïï" &
)
ïï& '
{
ðð 
Result
ññ 
<
ññ "
EcliptixSessionState
ññ /
,
ññ/ 0%
EcliptixProtocolFailure
ññ1 H
>
ññH I 
sessionStateResult
ññJ \
=
ññ] ^
identityKeys
òò $
.
òò$ %
ToProtoState
òò% 1
(
òò1 2
)
òò2 3
.
óó 
AndThen
óó $
(
óó$ %
identityKeysProto
óó% 6
=>
óó7 9

connection
óó: D
.
óóD E
ToProtoState
óóE Q
(
óóQ R
)
óóR S
.
ôô  !
Map
ôô! $
(
ôô$ %
ratchetStateProto
ôô% 6
=>
ôô7 9
new
ôô: ="
EcliptixSessionState
ôô> R
{
õõ  !
	ConnectId
öö$ -
=
öö. /
	connectId
öö0 9
,
öö9 :
IdentityKeys
÷÷$ 0
=
÷÷1 2
identityKeysProto
÷÷3 D
,
÷÷D E"
PeerHandshakeMessage
øø$ 8
=
øø9 :
serverExchange
øø; I
,
øøI J
RatchetState
ùù$ 0
=
ùù1 2
ratchetStateProto
ùù3 D
}
úú  !
)
úú! "
)
ûû 
;
ûû 
if
ýý 
(
ýý  
sessionStateResult
ýý *
.
ýý* +
IsOk
ýý+ /
)
ýý/ 0
{
þþ "
EcliptixSessionState
ÿÿ ,
sessionState
ÿÿ- 9
=
ÿÿ: ; 
sessionStateResult
ÿÿ< N
.
ÿÿN O
Unwrap
ÿÿO U
(
ÿÿU V
)
ÿÿV W
;
ÿÿW X
await
 &
PersistSessionStateAsync
 6
(
6 7
sessionState
7 C
,
C D
	connectId
E N
,
N O"
membershipIdentifier
P d
.
d e
ToByteArray
e p
(
p q
)
q r
)
r s
.
‚‚ 
ConfigureAwait
‚‚ +
(
‚‚+ ,
false
‚‚, 1
)
‚‚1 2
;
‚‚2 3
}
ƒƒ 
}
„„ 
newProtocol
†† 
=
†† 
null
†† "
;
††" #
return
‡‡ 
Result
‡‡ 
<
‡‡ 
Unit
‡‡ "
,
‡‡" #
NetworkFailure
‡‡$ 2
>
‡‡2 3
.
‡‡3 4
Ok
‡‡4 6
(
‡‡6 7
Unit
‡‡7 ;
.
‡‡; <
Value
‡‡< A
)
‡‡A B
;
‡‡B C
}
ˆˆ 
finally
‰‰ 
{
ŠŠ 
newProtocol
‹‹ 
?
‹‹ 
.
‹‹ 
Dispose
‹‹ $
(
‹‹$ %
)
‹‹% &
;
‹‹& '
}
ŒŒ 
}
 	
catch
ŽŽ 
(
ŽŽ 
	Exception
ŽŽ 
ex
ŽŽ 
)
ŽŽ 
{
 	
return
 
Result
 
<
 
Unit
 
,
 
NetworkFailure
  .
>
. /
.
/ 0
Err
0 3
(
3 4
NetworkFailure
‘‘ 
.
‘‘ %
DataCenterNotResponding
‘‘ 6
(
‘‘6 7
$"
‘‘7 9
$str
‘‘9 V
{
‘‘V W
ex
‘‘W Y
.
‘‘Y Z
Message
‘‘Z a
}
‘‘a b
"
‘‘b c
)
‘‘c d
)
‘‘d e
;
‘‘e f
}
’’ 	
finally
““ 
{
”” 	
if
•• 
(
•• 
masterKeyBytes
•• 
!=
•• !
null
••" &
)
••& '
{
–– %
CryptographicOperations
—— '
.
——' (

ZeroMemory
——( 2
(
——2 3
masterKeyBytes
——3 A
)
——A B
;
——B C
}
˜˜ 
if
šš 
(
šš 
rootKeyBytes
šš 
!=
šš 
null
šš  $
)
šš$ %
{
›› %
CryptographicOperations
œœ '
.
œœ' (

ZeroMemory
œœ( 2
(
œœ2 3
rootKeyBytes
œœ3 ?
)
œœ? @
;
œœ@ A
}
 
}
žž 	
}
ŸŸ 
private
¡¡ 
async
¡¡ 
Task
¡¡ .
 CleanupFailedAuthenticationAsync
¡¡ 7
(
¡¡7 8
uint
¡¡8 <
	connectId
¡¡= F
)
¡¡F G
{
¢¢ 
Result
££ 
<
££ 
Unit
££ 
,
££ "
SecureStorageFailure
££ )
>
££) *
deleteResult
££+ 7
=
££8 9
await
¤¤ (
secureProtocolStateStorage
¤¤ ,
.
¤¤, -
DeleteStateAsync
¤¤- =
(
¤¤= >
	connectId
¤¤> G
.
¤¤G H
ToString
¤¤H P
(
¤¤P Q
)
¤¤Q R
)
¤¤R S
.
¤¤S T
ConfigureAwait
¤¤T b
(
¤¤b c
false
¤¤c h
)
¤¤h i
;
¤¤i j
if
¦¦ 

(
¦¦ 
deleteResult
¦¦ 
.
¦¦ 
IsErr
¦¦ 
)
¦¦ 
{
§§ 	
Log
¨¨ 
.
¨¨ 
Warning
¨¨ 
(
¨¨ 
$str©© 
,©© Ž
	connectId
ªª 
,
ªª 
deleteResult
ªª '
.
ªª' (
	UnwrapErr
ªª( 1
(
ªª1 2
)
ªª2 3
.
ªª3 4
Message
ªª4 ;
)
ªª; <
;
ªª< =
}
«« 	
}
¬¬ 
}­­ š
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Core/Constants/NetworkConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Core/ 3
.3 4
	Constants4 =
;= >
public 
static 
class 
NetworkConstants $
{ 
public 

static 
class 
Protocol  
{ 
public		 
const		 
int		 &
DEFAULT_ONE_TIME_KEY_COUNT		 3
=		4 5
$num		6 7
;		7 8
public

 
const

 
uint

 "
OPERATION_ID_MIN_VALUE

 0
=

1 2
$num

3 5
;

5 6
public 
const 
uint '
OPERATION_ID_RESERVED_RANGE 5
=6 7
$num8 :
;: ;
public 
const 
int )
REQUEST_KEY_HEX_PREFIX_LENGTH 6
=7 8
$num9 ;
;; <
} 
public 

static 
class 
Cryptography $
{ 
public 
const 
int 
SHA_256_HASH_SIZE *
=+ ,
$num- /
;/ 0
} 
public 

static 
class 
Timeouts  
{ 
public 
static 
readonly 
TimeSpan '!
OutageRecoveryTimeout( =
=> ?
TimeSpan@ H
.H I
FromSecondsI T
(T U
$numU V
)V W
;W X
} 
public 

static 
class 
ErrorMessages %
{ 
public 
const 
string '
SESSION_NOT_FOUND_ON_SERVER 7
=8 9
$str: W
;W X
} 
} 

•/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Core/Constants/GrpcErrorMetadataKeys.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Core/ 3
.3 4
	Constants4 =
;= >
public 
static 
class !
GrpcErrorMetadataKeys )
{ 
public 

const 
string 

ERROR_CODE "
=# $
$str% 1
;1 2
public 

const 
string 
	I_18N_KEY !
=" #
$str$ .
;. /
public 

const 
string 
LOCALE 
=  
$str! )
;) *
public 

const 
string 
CORRELATION_ID &
=' (
$str) 9
;9 :
public		 

const		 
string		 
	RETRYABLE		 !
=		" #
$str		$ /
;		/ 0
public

 

const

 
string

 $
RETRY_AFTER_MILLISECONDS

 0
=

1 2
$str

3 C
;

C D
} Ò
¦/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Core/Connectivity/InternetConnectivityObserverOptions.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Core/ 3
.3 4
Connectivity4 @
;@ A
public 
record /
#InternetConnectivityObserverOptions 1
{ 
public 

static /
#InternetConnectivityObserverOptions 5
Default6 =
{> ?
get@ C
;C D
}E F
=G H
newI L
(L M
)M N
;N O
public

 

IReadOnlyList

 
<

 
string

 
>

  
	ProbeUrls

! *
{

+ ,
get

- 0
;

0 1
init

2 6
;

6 7
}

8 9
=

: ;
[

< =
$str -
,- .
$str -
] 
; 
public 

TimeSpan 
PollingInterval #
{$ %
get& )
;) *
init+ /
;/ 0
}1 2
=3 4
TimeSpan5 =
.= >
FromSeconds> I
(I J
$numJ K
)K L
;L M
public 

TimeSpan 
ProbeTimeout  
{! "
get# &
;& '
init( ,
;, -
}. /
=0 1
TimeSpan2 :
.: ;
FromSeconds; F
(F G
$numG H
)H I
;I J
public 

int 
FailureThreshold 
{  !
get" %
;% &
init' +
;+ ,
}- .
=/ 0
$num1 2
;2 3
public 

int 
SuccessThreshold 
{  !
get" %
;% &
init' +
;+ ,
}- .
=/ 0
$num1 2
;2 3
} g
Ÿ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Core/Connectivity/InternetConnectivityObserver.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Core/ 3
.3 4
Connectivity4 @
;@ A
internal 
sealed	 
class (
InternetConnectivityObserver 2
:3 4)
IInternetConnectivityObserver5 R
{ 
public 

const 
string 
HTTP_CLIENT_NAME (
=) *
$str+ L
;L M
private 
const 
int &
NETWORK_CHANGE_THROTTLE_MS 0
=1 2
$num3 6
;6 7
private 
const 
int #
FAILURE_POLLING_SECONDS -
=. /
$num0 1
;1 2
private 
readonly 
IHttpClientFactory '
_httpClientFactory( :
;: ;
private 
readonly 
IObservable  
<  !
bool! %
>% &#
_connectivityObservable' >
;> ?
private 
readonly #
CancellationTokenSource ,$
_cancellationTokenSource- E
=F G
newH K
(K L
)L M
;M N
private 
readonly 
Subject 
< 
Unit !
>! "
_manualProbeTrigger# 6
=7 8
new9 <
(< =
)= >
;> ?
private 
readonly /
#InternetConnectivityObserverOptions 8
_options9 A
;A B
public 
(
InternetConnectivityObserver '
(' (
IHttpClientFactory 
httpClientFactory ,
,, -

IScheduler 
uiScheduler 
, /
#InternetConnectivityObserverOptions +
currentOptions, :
): ;
{ 
if   

(   
currentOptions   
==   
null   "
)  " #
{!! 	
throw"" 
new"" !
ArgumentNullException"" +
(""+ ,
nameof"", 2
(""2 3
currentOptions""3 A
)""A B
)""B C
;""C D
}## 	
if%% 

(%% 
currentOptions%% 
.%% 
	ProbeUrls%% $
==%%% '
null%%( ,
||%%- /
!%%0 1
currentOptions%%1 ?
.%%? @
	ProbeUrls%%@ I
.%%I J
Any%%J M
(%%M N
)%%N O
)%%O P
{&& 	
throw'' 
new'' 
ArgumentException'' '
(''' (
$str''( K
,''K L
nameof''M S
(''S T
currentOptions''T b
)''b c
)''c d
;''d e
}(( 	
_httpClientFactory** 
=** 
httpClientFactory** .
;**. /
_options++ 
=++ 
currentOptions++ !
;++! "
BehaviorSubject-- 
<-- 
TimeSpan--  
>--  !"
pollingIntervalSubject--" 8
=--9 :
new--; >
(--> ?
currentOptions--? M
.--M N
PollingInterval--N ]
)--] ^
;--^ _
IObservable// 
<// 
Unit// 
>// #
networkChangeObservable// 1
=//2 3

Observable//4 >
.00 
	FromEvent00 
<00 -
!NetworkAddressChangedEventHandler00 8
,008 9
EventPattern00: F
<00F G
	EventArgs00G P
>00P Q
>00Q R
(00R S
handler11 
=>11 
(11 
sender11 "
,11" #
e11$ %
)11% &
=>11' )
handler11* 1
(111 2
new112 5
EventPattern116 B
<11B C
	EventArgs11C L
>11L M
(11M N
sender11N T
,11T U
e11V W
)11W X
)11X Y
,11Y Z
h22 
=>22 
NetworkChange22 "
.22" #!
NetworkAddressChanged22# 8
+=229 ;
new22< ?-
!NetworkAddressChangedEventHandler22@ a
(22a b
(22b c
s22c d
,22d e
e22f g
)22g h
=>22i k
h22l m
(22m n
s22n o
,22o p
e22q r
)22r s
)22s t
,22t u
h33 
=>33 
NetworkChange33 "
.33" #!
NetworkAddressChanged33# 8
-=339 ;
new33< ?-
!NetworkAddressChangedEventHandler33@ a
(33a b
(33b c
s33c d
,33d e
e33f g
)33g h
=>33i k
h33l m
(33m n
s33n o
,33o p
e33q r
)33r s
)33s t
)33t u
.44 
Throttle44 
(44 
TimeSpan44 
.44 
FromMilliseconds44 /
(44/ 0&
NETWORK_CHANGE_THROTTLE_MS440 J
)44J K
)44K L
.55 
Select55 
(55 
_55 
=>55 
Unit55 
.55 
Default55 %
)55% &
;55& '
IObservable77 
<77 
bool77 
>77 
probeObservable77 )
=77* +"
pollingIntervalSubject77, B
.88  
DistinctUntilChanged88 !
(88! "
)88" #
.99 
Select99 
(99 
interval99 
=>99 

Observable99  *
.99* +
Timer99+ 0
(990 1
TimeSpan991 9
.999 :
Zero99: >
,99> ?
interval99@ H
,99H I
	Scheduler99J S
.99S T
Default99T [
)99[ \
)99\ ]
.:: 
Switch:: 
(:: 
):: 
.;; 
Select;; 
(;; 
_;; 
=>;; 
Unit;; 
.;; 
Default;; %
);;% &
.<< 
Merge<< 
(<< 
_manualProbeTrigger<< &
)<<& '
.== 
Merge== 
(== #
networkChangeObservable== *
)==* +
.>> 

SelectMany>> 
(>> 
_>> 
=>>> "
ProbeConnectivityAsync>> 3
(>>3 4
_options>>4 <
,>>< =$
_cancellationTokenSource>>> V
.>>V W
Token>>W \
)>>\ ]
)>>] ^
;>>^ _#
_connectivityObservable@@ 
=@@  !
probeObservable@@" 1
.AA 
ScanAA 
(AA 
seedBB 
:BB 
(BB 
countBB 
:BB 
$numBB 
,BB  
stateBB! &
:BB& '
trueBB( ,
)BB, -
,BB- .
accumulatorCC 
:CC 
(CC 
accCC !
,CC! "
	isSuccessCC# ,
)CC, -
=>CC. 0
accDD 
.DD 
stateDD 
==DD  
	isSuccessDD! *
?EE 
(EE 
accEE 
.EE 
countEE $
+EE% &
$numEE' (
,EE( )
accEE* -
.EE- .
stateEE. 3
)EE3 4
:FF 
(FF 
$numFF 
,FF 
	isSuccessFF '
)FF' (
)FF( )
.GG 
DoGG 
(GG 
accGG 
=>GG 
{HH 
TimeSpanII 
currentIntervalII (
=II) *"
pollingIntervalSubjectII+ A
.IIA B
ValueIIB G
;IIG H
TimeSpanJJ 
desiredIntervalJJ (
=JJ) *
!JJ+ ,
accJJ, /
.JJ/ 0
stateJJ0 5
?KK 
TimeSpanKK 
.KK 
FromSecondsKK *
(KK* +#
FAILURE_POLLING_SECONDSKK+ B
)KKB C
:LL 
currentOptionsLL $
.LL$ %
PollingIntervalLL% 4
;LL4 5
ifNN 
(NN 
currentIntervalNN #
!=NN$ &
desiredIntervalNN' 6
)NN6 7
{OO "
pollingIntervalSubjectPP *
.PP* +
OnNextPP+ 1
(PP1 2
desiredIntervalPP2 A
)PPA B
;PPB C
}QQ 
}RR 
)RR 
.SS 
WhereSS 
(SS 
accSS 
=>SS 
{TT 
(UU 
intUU 
countUU 
,UU 
boolUU  
stateUU! &
)UU& '
=UU( )
accUU* -
;UU- .
intVV 
	thresholdVV 
=VV 
stateVV  %
?VV& '
currentOptionsVV( 6
.VV6 7
SuccessThresholdVV7 G
:VVH I
currentOptionsVVJ X
.VVX Y
FailureThresholdVVY i
;VVi j
returnWW 
countWW 
>=WW 
	thresholdWW  )
;WW) *
}XX 
)XX 
.YY 
SelectYY 
(YY 
accYY 
=>YY 
accYY 
.YY 
stateYY $
)YY$ %
.ZZ  
DistinctUntilChangedZZ !
(ZZ! "
)ZZ" #
.[[ 
	ObserveOn[[ 
([[ 
uiScheduler[[ "
)[[" #
.\\ 
Replay\\ 
(\\ 
$num\\ 
)\\ 
.]] 
RefCount]] 
(]] 
)]] 
;]] 
}^^ 
private`` 
async`` 
Task`` 
<`` 
bool`` 
>`` "
ProbeConnectivityAsync`` 3
(``3 4/
#InternetConnectivityObserverOptionsaa +
optionsaa, 3
,aa3 4
CancellationTokenbb 
ctbb 
)bb 
{cc 

HttpClientdd 

httpClientdd 
=dd 
_httpClientFactorydd  2
.dd2 3
CreateClientdd3 ?
(dd? @
HTTP_CLIENT_NAMEdd@ P
)ddP Q
;ddQ R
foreachff 
(ff 
stringff 
urlff 
inff 
optionsff &
.ff& '
	ProbeUrlsff' 0
)ff0 1
{gg 	
ifhh 
(hh 
cthh 
.hh #
IsCancellationRequestedhh *
)hh* +
{ii 
returnjj 
falsejj 
;jj 
}kk 
trymm 
{nn 
usingoo #
CancellationTokenSourceoo -
	linkedCtsoo. 7
=oo8 9#
CancellationTokenSourceoo: Q
.ooQ R#
CreateLinkedTokenSourceooR i
(ooi j
ctooj l
)ool m
;oom n
	linkedCtspp 
.pp 
CancelAfterpp %
(pp% &
optionspp& -
.pp- .
ProbeTimeoutpp. :
)pp: ;
;pp; <
usingrr 
HttpRequestMessagerr (
requestrr) 0
=rr1 2
newrr3 6
(rr6 7

HttpMethodrr7 A
.rrA B
HeadrrB F
,rrF G
urlrrH K
)rrK L
;rrL M
HttpResponseMessagess #
responsess$ ,
=ss- .
awaitss/ 4

httpClientss5 ?
.ss? @
	SendAsyncss@ I
(ssI J
requestssJ Q
,ssQ R 
HttpCompletionOptiontt (
.tt( )
ResponseHeadersReadtt) <
,tt< =
	linkedCtstt> G
.ttG H
TokenttH M
)ttM N
;ttN O
ifvv 
(vv 
responsevv 
.vv 
IsSuccessStatusCodevv 0
)vv0 1
{ww 
returnxx 
truexx 
;xx  
}yy 
}zz 
catch{{ 
({{ 
	Exception{{ 
){{ 
{|| 
}~~ 
} 	
return
 
false
 
;
 
}
‚‚ 
public
„„ 

IDisposable
„„ 
	Subscribe
„„  
(
„„  !
	IObserver
„„! *
<
„„* +
bool
„„+ /
>
„„/ 0
observer
„„1 9
)
„„9 :
=>
„„; =%
_connectivityObservable
…… 
.
……  
	Subscribe
……  )
(
……) *
observer
……* 2
)
……2 3
;
……3 4
public
‡‡ 

void
‡‡ 
Dispose
‡‡ 
(
‡‡ 
)
‡‡ 
{
ˆˆ 
if
‰‰ 

(
‰‰ 
!
‰‰ &
_cancellationTokenSource
‰‰ %
.
‰‰% &%
IsCancellationRequested
‰‰& =
)
‰‰= >
{
ŠŠ 	&
_cancellationTokenSource
‹‹ $
.
‹‹$ %
Cancel
‹‹% +
(
‹‹+ ,
)
‹‹, -
;
‹‹- .
}
ŒŒ 	&
_cancellationTokenSource
ŽŽ  
.
ŽŽ  !
Dispose
ŽŽ! (
(
ŽŽ( )
)
ŽŽ) *
;
ŽŽ* +!
_manualProbeTrigger
 
.
 
Dispose
 #
(
# $
)
$ %
;
% &
}
 
}‘‘ ê
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Core/Connectivity/InternetConnectivityBridge.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Core/ 3
.3 4
Connectivity4 @
;@ A
internal 
sealed	 
class &
InternetConnectivityBridge 0
:1 2
IDisposable3 >
{		 
private

 
readonly

  
IConnectivityService

 ) 
_connectivityService

* >
;

> ?
private 
readonly 
IDisposable  
_subscription! .
;. /
private 
bool 
	_disposed 
; 
public 
&
InternetConnectivityBridge %
(% &)
IInternetConnectivityObserver % 
connectivityObserver& :
,: ; 
IConnectivityService 
connectivityService 0
)0 1
{  
_connectivityService 
= 
connectivityService 2
;2 3
_subscription 
=  
connectivityObserver ,
., -
	Subscribe- 6
(6 7
async7 <
isOnline= E
=>F H
{ 	
if 
( 
	_disposed 
) 
{ 
return 
; 
} 
ConnectivityIntent 
intent %
=& '
isOnline( 0
? 
ConnectivityIntent $
.$ %
InternetRecovered% 6
(6 7
)7 8
: 
ConnectivityIntent $
.$ %
InternetLost% 1
(1 2
)2 3
;3 4
await  
_connectivityService &
.& '
PublishAsync' 3
(3 4
intent4 :
): ;
.; <
ConfigureAwait< J
(J K
falseK P
)P Q
;Q R
}   	
)  	 

;  
 
}!! 
public## 

void## 
Dispose## 
(## 
)## 
{$$ 
if%% 

(%% 
	_disposed%% 
)%% 
{&& 	
return'' 
;'' 
}(( 	
	_disposed** 
=** 
true** 
;** 
_subscription++ 
.++ 
Dispose++ 
(++ 
)++ 
;++  
},, 
}-- ©
œ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Abstractions/Transport/IRpcMetaDataProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Abstractions/ ;
.; <
	Transport< E
;E F
public 
	interface  
IRpcMetaDataProvider %
{ 
Guid 
AppInstanceId	 
{ 
get 
; 
} 
Guid 
DeviceId	 
{ 
get 
; 
} 
string		 

?		
 
CULTURE		 
{		 
get		 
;		 
}		 
string

 

LocalIpAddress

 
{

 
get

 
;

  
}

! "
string 

?
 
PublicIpAddress 
{ 
get !
;! "
}# $
string 

Platform 
{ 
get 
; 
} 
void 

SetAppInfo	 
( 
Guid 
appInstanceId &
,& '
Guid( ,
deviceId- 5
,5 6
string7 =
?= >
culture? F
)F G
;G H
void 

SetCulture	 
( 
string 
? 
culture #
)# $
;$ %
} „
•/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Abstractions/Transport/IOutboundSink.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Abstractions/ ;
.; <
	Transport< E
;E F
public 
	interface 
IOutboundSink 
{		 
Task

 
<

 	
Result

	 
<

 
Unit

 
,

 
NetworkFailure

 $
>

$ %
>

% &
	SendAsync

' 0
(

0 1
SecureEnvelope

1 ?
envelope

@ H
)

H I
;

I J
} ˜
˜/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Abstractions/Transport/INetworkProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Abstractions/ ;
.; <
	Transport< E
;E F
public 
	interface 
INetworkProvider !
{ 
uint "
ComputeUniqueConnectId	 
(  
PubKeyExchangeType  2
pubKeyExchangeType3 E
)E F
;F G
} ú
 /Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Network/Abstractions/Core/IInternetConnectivityObserver.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Network' .
.. /
Abstractions/ ;
.; <
Core< @
;@ A
public 
	interface )
IInternetConnectivityObserver .
:/ 0
IObservable1 <
<< =
bool= A
>A B
,B C
IDisposableD O
;O Pä
œ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Data/SecureStorage/Configuration/SecureStoreOptions.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Data' +
.+ ,
SecureStorage, 9
.9 :
Configuration: G
;G H
public 
sealed 
class 
SecureStoreOptions &
{ 
public 

string 
EncryptedStatePath $
{% &
get' *
;* +
init, 0
;0 1
}2 3
=4 5
$str6 X
;X Y
} ¡˜
œ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Data/SecureStorage/ApplicationSecureStorageProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Data' +
.+ ,
SecureStorage, 9
;9 :
internal 
sealed	 
class ,
 ApplicationSecureStorageProvider 6
:7 8-
!IApplicationSecureStorageProvider9 Z
{ 
private 
const 
string 
SETTINGS_KEY %
=& '
$str( E
;E F
private 
readonly 
IDataProtector #

_protector$ .
;. /
private 
readonly 
string 
_storagePath (
;( )
private 
bool 
	_disposed 
; 
public   
,
 ApplicationSecureStorageProvider   +
(  + ,
IOptions!! 
<!! 
SecureStoreOptions!! #
>!!# $
options!!% ,
,!!, -#
IDataProtectionProvider"" "
dataProtectionProvider""  6
)""6 7
{## 
SecureStoreOptions$$ 
opts$$ 
=$$  !
options$$" )
.$$) *
Value$$* /
;$$/ 0
_storagePath&& 
=&& 
opts&& 
.&& 
EncryptedStatePath&& .
;&&. /

_protector'' 
='' "
dataProtectionProvider'' +
.''+ ,
CreateProtector'', ;
(''; <
$str''< W
)''W X
;''X Y&
InitializeStorageDirectory)) "
())" #
)))# $
;))$ %
}** 
public,, 

async,, 
Task,, 
<,, 
Result,, 
<,, 
Unit,, !
,,,! "%
InternalServiceApiFailure,,# <
>,,< =
>,,= >.
"SetApplicationSettingsCultureAsync,,? a
(,,a b
string,,b h
?,,h i
cultureName,,j u
),,u v
{-- 
Result.. 
<.. '
ApplicationInstanceSettings.. *
,..* +%
InternalServiceApiFailure.., E
>..E F
settingsResult..G U
=..V W
await// /
#GetApplicationInstanceSettingsAsync// 5
(//5 6
)//6 7
;//7 8
if00 

(00 
settingsResult00 
.00 
IsErr00  
)00  !
{11 	
return22 
Result22 
<22 
Unit22 
,22 %
InternalServiceApiFailure22  9
>229 :
.22: ;
Err22; >
(22> ?
settingsResult22? M
.22M N
	UnwrapErr22N W
(22W X
)22X Y
)22Y Z
;22Z [
}33 	'
ApplicationInstanceSettings55 #
settings55$ ,
=55- .
settingsResult55/ =
.55= >
Unwrap55> D
(55D E
)55E F
;55F G
settings66 
.66 
Culture66 
=66 
cultureName66 &
;66& '
return88 
await88 #
SecureByteStringInterop88 ,
.88, - 
WithByteStringAsSpan88- A
(88A B
settings88B J
.88J K
ToByteString88K W
(88W X
)88X Y
,88Y Z
span99 
=>99 

StoreAsync99 
(99 
SETTINGS_KEY99 +
,99+ ,
span99- 1
.991 2
ToArray992 9
(999 :
)99: ;
)99; <
)99< =
;99= >
}:: 
public<< 

async<< 
Task<< 
<<< 
Result<< 
<<< 
Unit<< !
,<<! "%
InternalServiceApiFailure<<# <
><<< =
><<= >'
SetApplicationInstanceAsync<<? Z
(<<Z [
bool<<[ _
isNewInstance<<` m
)<<m n
{== 
Result>> 
<>> '
ApplicationInstanceSettings>> *
,>>* +%
InternalServiceApiFailure>>, E
>>>E F
settingsResult>>G U
=>>V W
await?? /
#GetApplicationInstanceSettingsAsync?? 5
(??5 6
)??6 7
;??7 8
if@@ 

(@@ 
settingsResult@@ 
.@@ 
IsErr@@  
)@@  !
{AA 	
returnBB 
ResultBB 
<BB 
UnitBB 
,BB %
InternalServiceApiFailureBB  9
>BB9 :
.BB: ;
ErrBB; >
(BB> ?
settingsResultBB? M
.BBM N
	UnwrapErrBBN W
(BBW X
)BBX Y
)BBY Z
;BBZ [
}CC 	'
ApplicationInstanceSettingsEE #
settingsEE$ ,
=EE- .
settingsResultEE/ =
.EE= >
UnwrapEE> D
(EED E
)EEE F
;EEF G
settingsFF 
.FF 
IsNewInstanceFF 
=FF  
isNewInstanceFF! .
;FF. /
returnGG 
awaitGG #
SecureByteStringInteropGG ,
.GG, - 
WithByteStringAsSpanGG- A
(GGA B
settingsGGB J
.GGJ K
ToByteStringGGK W
(GGW X
)GGX Y
,GGY Z
spanHH 
=>HH 

StoreAsyncHH 
(HH 
SETTINGS_KEYHH +
,HH+ ,
spanHH- 1
.HH1 2
ToArrayHH2 9
(HH9 :
)HH: ;
)HH; <
)HH< =
;HH= >
}II 
publicKK 

asyncKK 
TaskKK 
<KK 
ResultKK 
<KK 
UnitKK !
,KK! "%
InternalServiceApiFailureKK# <
>KK< =
>KK= >(
SetApplicationIpCountryAsyncKK? [
(KK[ \
	IpCountryKK\ e
	ipCountryKKf o
)KKo p
{LL 
ResultMM 
<MM '
ApplicationInstanceSettingsMM *
,MM* +%
InternalServiceApiFailureMM, E
>MME F
settingsResultMMG U
=MMV W
awaitNN /
#GetApplicationInstanceSettingsAsyncNN 5
(NN5 6
)NN6 7
;NN7 8
ifOO 

(OO 
settingsResultOO 
.OO 
IsErrOO  
)OO  !
{PP 	
returnQQ 
ResultQQ 
<QQ 
UnitQQ 
,QQ %
InternalServiceApiFailureQQ  9
>QQ9 :
.QQ: ;
ErrQQ; >
(QQ> ?
settingsResultQQ? M
.QQM N
	UnwrapErrQQN W
(QQW X
)QQX Y
)QQY Z
;QQZ [
}RR 	'
ApplicationInstanceSettingsTT #
settingsTT$ ,
=TT- .
settingsResultTT/ =
.TT= >
UnwrapTT> D
(TTD E
)TTE F
;TTF G
settingsUU 
.UU 
CountryUU 
=UU 
	ipCountryUU $
.UU$ %
CountryUU% ,
;UU, -
returnWW 
awaitWW #
SecureByteStringInteropWW ,
.WW, - 
WithByteStringAsSpanWW- A
(WWA B
settingsWWB J
.WWJ K
ToByteStringWWK W
(WWW X
)WWX Y
,WWY Z
spanXX 
=>XX 

StoreAsyncXX 
(XX 
SETTINGS_KEYXX +
,XX+ ,
spanXX- 1
.XX1 2
ToArrayXX2 9
(XX9 :
)XX: ;
)XX; <
)XX< =
;XX= >
}YY 
public[[ 

async[[ 
Task[[ 
<[[ 
Result[[ 
<[[ 
Unit[[ !
,[[! "%
InternalServiceApiFailure[[# <
>[[< =
>[[= >)
SetApplicationMembershipAsync[[? \
([[\ ]

Membership[[] g
?[[g h

membership[[i s
)[[s t
{\\ 
Result]] 
<]] '
ApplicationInstanceSettings]] *
,]]* +%
InternalServiceApiFailure]], E
>]]E F
settingsResult]]G U
=]]V W
await^^ /
#GetApplicationInstanceSettingsAsync^^ 5
(^^5 6
)^^6 7
;^^7 8
if__ 

(__ 
settingsResult__ 
.__ 
IsErr__  
)__  !
{`` 	
returnaa 
Resultaa 
<aa 
Unitaa 
,aa %
InternalServiceApiFailureaa  9
>aa9 :
.aa: ;
Erraa; >
(aa> ?
settingsResultaa? M
.aaM N
	UnwrapErraaN W
(aaW X
)aaX Y
)aaY Z
;aaZ [
}bb 	'
ApplicationInstanceSettingsdd #
settingsdd$ ,
=dd- .
settingsResultdd/ =
.dd= >
Unwrapdd> D
(ddD E
)ddE F
;ddF G
settingsee 
.ee 

Membershipee 
=ee 

membershipee (
;ee( )
returngg 
awaitgg #
SecureByteStringInteropgg ,
.gg, - 
WithByteStringAsSpangg- A
(ggA B
settingsggB J
.ggJ K
ToByteStringggK W
(ggW X
)ggX Y
,ggY Z
spanhh 
=>hh 

StoreAsynchh 
(hh 
SETTINGS_KEYhh +
,hh+ ,
spanhh- 1
.hh1 2
ToArrayhh2 9
(hh9 :
)hh: ;
)hh; <
)hh< =
;hh= >
}ii 
publickk 

asynckk 
Taskkk 
<kk 
Resultkk 
<kk 
Unitkk !
,kk! "%
InternalServiceApiFailurekk# <
>kk< =
>kk= >$
SetCurrentAccountIdAsynckk? W
(kkW X

ByteStringkkX b
?kkb c
	accountIdkkd m
)kkm n
{ll 
Resultmm 
<mm '
ApplicationInstanceSettingsmm *
,mm* +%
InternalServiceApiFailuremm, E
>mmE F
settingsResultmmG U
=mmV W
awaitnn /
#GetApplicationInstanceSettingsAsyncnn 5
(nn5 6
)nn6 7
;nn7 8
ifoo 

(oo 
settingsResultoo 
.oo 
IsErroo  
)oo  !
{pp 	
returnqq 
Resultqq 
<qq 
Unitqq 
,qq %
InternalServiceApiFailureqq  9
>qq9 :
.qq: ;
Errqq; >
(qq> ?
settingsResultqq? M
.qqM N
	UnwrapErrqqN W
(qqW X
)qqX Y
)qqY Z
;qqZ [
}rr 	'
ApplicationInstanceSettingstt #
settingstt$ ,
=tt- .
settingsResulttt/ =
.tt= >
Unwraptt> D
(ttD E
)ttE F
;ttF G
settingsuu 
.uu 
CurrentAccountIduu !
=uu" #
	accountIduu$ -
??uu. 0

ByteStringuu1 ;
.uu; <
Emptyuu< A
;uuA B
returnww 
awaitww #
SecureByteStringInteropww ,
.ww, - 
WithByteStringAsSpanww- A
(wwA B
settingswwB J
.wwJ K
ToByteStringwwK W
(wwW X
)wwX Y
,wwY Z
spanxx 
=>xx 

StoreAsyncxx 
(xx 
SETTINGS_KEYxx +
,xx+ ,
spanxx- 1
.xx1 2
ToArrayxx2 9
(xx9 :
)xx: ;
)xx; <
)xx< =
;xx= >
}yy 
public{{ 

async{{ 
Task{{ 
<{{ 
Result{{ 
<{{ '
ApplicationInstanceSettings{{ 8
,{{8 9%
InternalServiceApiFailure{{: S
>{{S T
>{{T U/
#GetApplicationInstanceSettingsAsync|| +
(||+ ,
)||, -
{}} 
Result~~ 
<~~ 
Option~~ 
<~~ 
byte~~ 
[~~ 
]~~ 
>~~ 
,~~ %
InternalServiceApiFailure~~ 8
>~~8 9
	getResult~~: C
=~~D E
await~~F K
TryGetByKeyAsync~~L \
(~~\ ]
SETTINGS_KEY~~] i
)~~i j
;~~j k
if 

( 
	getResult 
. 
IsErr 
) 
{
€€ 	
return
 
Result
 
<
 )
ApplicationInstanceSettings
 5
,
5 6'
InternalServiceApiFailure
7 P
>
P Q
.
Q R
Err
R U
(
U V
	getResult
V _
.
_ `
	UnwrapErr
` i
(
i j
)
j k
)
k l
;
l m
}
‚‚ 	
Option
„„ 
<
„„ 
byte
„„ 
[
„„ 
]
„„ 
>
„„ 
	maybeData
„„  
=
„„! "
	getResult
„„# ,
.
„„, -
Unwrap
„„- 3
(
„„3 4
)
„„4 5
;
„„5 6
if
…… 

(
…… 
!
…… 
	maybeData
…… 
.
…… 
IsSome
…… 
)
…… 
{
†† 	
return
‡‡ 
Result
‡‡ 
<
‡‡ )
ApplicationInstanceSettings
‡‡ 5
,
‡‡5 6'
InternalServiceApiFailure
‡‡7 P
>
‡‡P Q
.
‡‡Q R
Err
‡‡R U
(
‡‡U V'
InternalServiceApiFailure
ˆˆ )
.
ˆˆ) *$
SecureStoreKeyNotFound
ˆˆ* @
(
ˆˆ@ A&
ApplicationErrorMessages
ˆˆA Y
.
ˆˆY Z#
SecureStorageProvider
ˆˆZ o
.
‰‰ ,
APPLICATION_SETTINGS_NOT_FOUND
‰‰ 3
)
‰‰3 4
)
‰‰4 5
;
‰‰5 6
}
ŠŠ 	
try
ŒŒ 
{
 	)
ApplicationInstanceSettings
ŽŽ '
settings
ŽŽ( 0
=
ŽŽ1 2)
ApplicationInstanceSettings
ŽŽ3 N
.
ŽŽN O
Parser
ŽŽO U
.
ŽŽU V
	ParseFrom
ŽŽV _
(
ŽŽ_ `
	maybeData
ŽŽ` i
.
ŽŽi j
Value
ŽŽj o
)
ŽŽo p
;
ŽŽp q
return
 
Result
 
<
 )
ApplicationInstanceSettings
 5
,
5 6'
InternalServiceApiFailure
7 P
>
P Q
.
Q R
Ok
R T
(
T U
settings
U ]
)
] ^
;
^ _
}
 	
catch
‘‘ 
(
‘‘ ,
InvalidProtocolBufferException
‘‘ -
ex
‘‘. 0
)
‘‘0 1
{
’’ 	
return
““ 
Result
““ 
<
““ )
ApplicationInstanceSettings
““ 5
,
““5 6'
InternalServiceApiFailure
““7 P
>
““P Q
.
““Q R
Err
““R U
(
““U V'
InternalServiceApiFailure
”” )
.
””) *%
SecureStoreAccessDenied
””* A
(
””A B&
ApplicationErrorMessages
•• ,
.
••, -#
SecureStorageProvider
••- B
.
••B C#
CORRUPT_SETTINGS_DATA
••C X
,
••X Y
ex
••Z \
)
••\ ]
)
••] ^
;
••^ _
}
–– 	
}
—— 
public
™™ 

async
™™ 
Task
™™ 
<
™™ 
Result
™™ 
<
™™ $
InstanceSettingsResult
™™ 3
,
™™3 4'
InternalServiceApiFailure
™™5 N
>
™™N O
>
™™O P2
$InitApplicationInstanceSettingsAsync
™™Q u
(
™™u v
string
šš 
?
šš 
defaultCulture
šš 
)
šš 
{
›› 
Result
œœ 
<
œœ 
Option
œœ 
<
œœ 
byte
œœ 
[
œœ 
]
œœ 
>
œœ 
,
œœ '
InternalServiceApiFailure
œœ 8
>
œœ8 9
	getResult
œœ: C
=
œœD E
await
œœF K
TryGetByKeyAsync
œœL \
(
œœ\ ]
SETTINGS_KEY
œœ] i
)
œœi j
;
œœj k
if
 

(
 
	getResult
 
.
 
IsErr
 
)
 
{
žž 	'
InternalServiceApiFailure
ŸŸ %
failure
ŸŸ& -
=
ŸŸ. /
	getResult
ŸŸ0 9
.
ŸŸ9 :
	UnwrapErr
ŸŸ: C
(
ŸŸC D
)
ŸŸD E
;
ŸŸE F
Log
   
.
   
Warning
   
(
   
$str
   q
,
  q r
failure
¡¡ 
.
¡¡ 
Message
¡¡ 
)
¡¡  
;
¡¡  !
return
¢¢ 
await
¢¢ ,
CreateAndStoreNewSettingsAsync
¢¢ 7
(
¢¢7 8
defaultCulture
¢¢8 F
)
¢¢F G
;
¢¢G H
}
££ 	
Option
¥¥ 
<
¥¥ 
byte
¥¥ 
[
¥¥ 
]
¥¥ 
>
¥¥ 
	maybeData
¥¥  
=
¥¥! "
	getResult
¥¥# ,
.
¥¥, -
Unwrap
¥¥- 3
(
¥¥3 4
)
¥¥4 5
;
¥¥5 6
if
¦¦ 

(
¦¦ 
	maybeData
¦¦ 
.
¦¦ 
IsSome
¦¦ 
)
¦¦ 
{
§§ 	
try
¨¨ 
{
©© )
ApplicationInstanceSettings
ªª +
settings
ªª, 4
=
ªª5 6)
ApplicationInstanceSettings
ªª7 R
.
ªªR S
Parser
ªªS Y
.
ªªY Z
	ParseFrom
ªªZ c
(
ªªc d
	maybeData
ªªd m
.
ªªm n
Value
ªªn s
)
ªªs t
;
ªªt u
return
«« 
Result
«« 
<
«« $
InstanceSettingsResult
«« 4
,
««4 5'
InternalServiceApiFailure
««6 O
>
««O P
.
««P Q
Ok
««Q S
(
««S T
new
¬¬ $
InstanceSettingsResult
¬¬ .
(
¬¬. /
settings
¬¬/ 7
,
¬¬7 8
false
¬¬9 >
)
¬¬> ?
)
¬¬? @
;
¬¬@ A
}
­­ 
catch
®® 
(
®® ,
InvalidProtocolBufferException
®® 1
ex
®®2 4
)
®®4 5
{
¯¯ 
Log
°° 
.
°° 
Warning
°° 
(
°° 
ex
°° 
,
°° 
$str
±± o
,
±±o p
ex
²² 
.
²² 
Message
²² 
)
²² 
;
²²  
return
³³ 
await
³³ ,
CreateAndStoreNewSettingsAsync
³³ ;
(
³³; <
defaultCulture
³³< J
)
³³J K
;
³³K L
}
´´ 
}
µµ 	
return
·· 
await
·· ,
CreateAndStoreNewSettingsAsync
·· 3
(
··3 4
defaultCulture
··4 B
)
··B C
;
··C D
}
¸¸ 
private
ºº 
async
ºº 
Task
ºº 
<
ºº 
Result
ºº 
<
ºº $
InstanceSettingsResult
ºº 4
,
ºº4 5'
InternalServiceApiFailure
ºº6 O
>
ººO P
>
ººP Q,
CreateAndStoreNewSettingsAsync
ººR p
(
ººp q
string
»» 
?
»» 
defaultCulture
»» 
)
»» 
{
¼¼ )
ApplicationInstanceSettings
½½ #
newSettings
½½$ /
=
½½0 1
new
½½2 5
(
½½5 6
)
½½6 7
{
¾¾ 	
AppInstanceId
¿¿ 
=
¿¿ 
Helpers
¿¿ #
.
¿¿# $
GuidToByteString
¿¿$ 4
(
¿¿4 5
Guid
¿¿5 9
.
¿¿9 :
NewGuid
¿¿: A
(
¿¿A B
)
¿¿B C
)
¿¿C D
,
¿¿D E
DeviceId
ÀÀ 
=
ÀÀ 
Helpers
ÀÀ 
.
ÀÀ 
GuidToByteString
ÀÀ /
(
ÀÀ/ 0
Guid
ÀÀ0 4
.
ÀÀ4 5
NewGuid
ÀÀ5 <
(
ÀÀ< =
)
ÀÀ= >
)
ÀÀ> ?
,
ÀÀ? @
Culture
ÁÁ 
=
ÁÁ 
defaultCulture
ÁÁ $
}
ÂÂ 	
;
ÂÂ	 

Result
ÄÄ 
<
ÄÄ 
Unit
ÄÄ 
,
ÄÄ '
InternalServiceApiFailure
ÄÄ .
>
ÄÄ. /
storeResult
ÄÄ0 ;
=
ÄÄ< =
await
ÄÄ> C%
SecureByteStringInterop
ÄÄD [
.
ÄÄ[ \"
WithByteStringAsSpan
ÄÄ\ p
(
ÄÄp q
newSettings
ÅÅ 
.
ÅÅ 
ToByteString
ÅÅ $
(
ÅÅ$ %
)
ÅÅ% &
,
ÅÅ& '
span
ÆÆ 
=>
ÆÆ 

StoreAsync
ÆÆ 
(
ÆÆ 
SETTINGS_KEY
ÆÆ +
,
ÆÆ+ ,
span
ÆÆ- 1
.
ÆÆ1 2
ToArray
ÆÆ2 9
(
ÆÆ9 :
)
ÆÆ: ;
)
ÆÆ; <
)
ÆÆ< =
;
ÆÆ= >
if
ÈÈ 

(
ÈÈ 
storeResult
ÈÈ 
.
ÈÈ 
IsErr
ÈÈ 
)
ÈÈ 
{
ÉÉ 	
Log
ÊÊ 
.
ÊÊ 
Warning
ÊÊ 
(
ÊÊ 
$str
ËË q
,
ËËq r
storeResult
ÌÌ 
.
ÌÌ 
	UnwrapErr
ÌÌ %
(
ÌÌ% &
)
ÌÌ& '
.
ÌÌ' (
Message
ÌÌ( /
)
ÌÌ/ 0
;
ÌÌ0 1
}
ÍÍ 	
return
ÏÏ 
Result
ÏÏ 
<
ÏÏ $
InstanceSettingsResult
ÏÏ ,
,
ÏÏ, -'
InternalServiceApiFailure
ÏÏ. G
>
ÏÏG H
.
ÏÏH I
Ok
ÏÏI K
(
ÏÏK L
new
ÐÐ $
InstanceSettingsResult
ÐÐ &
(
ÐÐ& '
newSettings
ÐÐ' 2
,
ÐÐ2 3
true
ÐÐ4 8
)
ÐÐ8 9
)
ÐÐ9 :
;
ÐÐ: ;
}
ÑÑ 
public
ÓÓ 

async
ÓÓ 
Task
ÓÓ 
<
ÓÓ 
Result
ÓÓ 
<
ÓÓ 
Unit
ÓÓ !
,
ÓÓ! "'
InternalServiceApiFailure
ÓÓ# <
>
ÓÓ< =
>
ÓÓ= >

StoreAsync
ÓÓ? I
(
ÓÓI J
string
ÓÓJ P
key
ÓÓQ T
,
ÓÓT U
byte
ÓÓV Z
[
ÓÓZ [
]
ÓÓ[ \
data
ÓÓ] a
)
ÓÓa b
{
ÔÔ 
try
ÕÕ 
{
ÖÖ 	
string
×× 
filePath
×× 
=
×× 
GetHashedFilePath
×× /
(
××/ 0
key
××0 3
)
××3 4
;
××4 5
byte
ØØ 
[
ØØ 
]
ØØ 
protectedData
ØØ  
=
ØØ! "

_protector
ØØ# -
.
ØØ- .
Protect
ØØ. 5
(
ØØ5 6
data
ØØ6 :
)
ØØ: ;
;
ØØ; <
await
ÙÙ 
File
ÙÙ 
.
ÙÙ  
WriteAllBytesAsync
ÙÙ )
(
ÙÙ) *
filePath
ÙÙ* 2
,
ÙÙ2 3
protectedData
ÙÙ4 A
)
ÙÙA B
;
ÙÙB C&
SetSecureFilePermissions
ÚÚ $
(
ÚÚ$ %
filePath
ÚÚ% -
)
ÚÚ- .
;
ÚÚ. /
return
ÛÛ 
Result
ÛÛ 
<
ÛÛ 
Unit
ÛÛ 
,
ÛÛ '
InternalServiceApiFailure
ÛÛ  9
>
ÛÛ9 :
.
ÛÛ: ;
Ok
ÛÛ; =
(
ÛÛ= >
Unit
ÛÛ> B
.
ÛÛB C
Value
ÛÛC H
)
ÛÛH I
;
ÛÛI J
}
ÜÜ 	
catch
ÝÝ 
(
ÝÝ $
CryptographicException
ÝÝ %
ex
ÝÝ& (
)
ÝÝ( )
{
ÞÞ 	
return
ßß 
Result
ßß 
<
ßß 
Unit
ßß 
,
ßß '
InternalServiceApiFailure
ßß  9
>
ßß9 :
.
ßß: ;
Err
ßß; >
(
ßß> ?'
InternalServiceApiFailure
àà )
.
àà) *%
SecureStoreAccessDenied
àà* A
(
ààA B&
ApplicationErrorMessages
áá ,
.
áá, -#
SecureStorageProvider
áá- B
.
ááB C$
FAILED_TO_ENCRYPT_DATA
ááC Y
,
ááY Z
ex
áá[ ]
)
áá] ^
)
áá^ _
;
áá_ `
}
ââ 	
catch
ãã 
(
ãã 
IOException
ãã 
ex
ãã 
)
ãã 
{
ää 	
return
åå 
Result
åå 
<
åå 
Unit
åå 
,
åå '
InternalServiceApiFailure
åå  9
>
åå9 :
.
åå: ;
Err
åå; >
(
åå> ?'
InternalServiceApiFailure
ææ )
.
ææ) *%
SecureStoreAccessDenied
ææ* A
(
ææA B&
ApplicationErrorMessages
çç ,
.
çç, -#
SecureStorageProvider
çç- B
.
ççB C(
FAILED_TO_WRITE_TO_STORAGE
ççC ]
,
çç] ^
ex
çç_ a
)
çça b
)
ççb c
;
ççc d
}
èè 	
}
éé 
public
ëë 

async
ëë 
Task
ëë 
<
ëë 
Result
ëë 
<
ëë 
Option
ëë #
<
ëë# $
byte
ëë$ (
[
ëë( )
]
ëë) *
>
ëë* +
,
ëë+ ,'
InternalServiceApiFailure
ëë- F
>
ëëF G
>
ëëG H
TryGetByKeyAsync
ëëI Y
(
ëëY Z
string
ëëZ `
key
ëëa d
)
ëëd e
{
ìì 
string
íí 
filePath
íí 
=
íí 
GetHashedFilePath
íí +
(
íí+ ,
key
íí, /
)
íí/ 0
;
íí0 1
if
îî 

(
îî 
!
îî 
File
îî 
.
îî 
Exists
îî 
(
îî 
filePath
îî !
)
îî! "
)
îî" #
{
ïï 	
return
ðð 
Result
ðð 
<
ðð 
Option
ðð  
<
ðð  !
byte
ðð! %
[
ðð% &
]
ðð& '
>
ðð' (
,
ðð( )'
InternalServiceApiFailure
ðð* C
>
ððC D
.
ððD E
Ok
ððE G
(
ððG H
Option
ððH N
<
ððN O
byte
ððO S
[
ððS T
]
ððT U
>
ððU V
.
ððV W
None
ððW [
)
ðð[ \
;
ðð\ ]
}
ññ 	
try
óó 
{
ôô 	
byte
õõ 
[
õõ 
]
õõ 
protectedData
õõ  
=
õõ! "
await
õõ# (
File
õõ) -
.
õõ- .
ReadAllBytesAsync
õõ. ?
(
õõ? @
filePath
õõ@ H
)
õõH I
;
õõI J
if
öö 
(
öö 
protectedData
öö 
.
öö 
Length
öö $
==
öö% '
$num
öö( )
)
öö) *
{
÷÷ 
return
øø 
Result
øø 
<
øø 
Option
øø $
<
øø$ %
byte
øø% )
[
øø) *
]
øø* +
>
øø+ ,
,
øø, -'
InternalServiceApiFailure
øø. G
>
øøG H
.
øøH I
Ok
øøI K
(
øøK L
Option
øøL R
<
øøR S
byte
øøS W
[
øøW X
]
øøX Y
>
øøY Z
.
øøZ [
None
øø[ _
)
øø_ `
;
øø` a
}
ùù 
byte
ûû 
[
ûû 
]
ûû 
data
ûû 
=
ûû 

_protector
ûû $
.
ûû$ %
	Unprotect
ûû% .
(
ûû. /
protectedData
ûû/ <
)
ûû< =
;
ûû= >
return
üü 
Result
üü 
<
üü 
Option
üü  
<
üü  !
byte
üü! %
[
üü% &
]
üü& '
>
üü' (
,
üü( )'
InternalServiceApiFailure
üü* C
>
üüC D
.
üüD E
Ok
üüE G
(
üüG H
Option
üüH N
<
üüN O
byte
üüO S
[
üüS T
]
üüT U
>
üüU V
.
üüV W
Some
üüW [
(
üü[ \
data
üü\ `
)
üü` a
)
üüa b
;
üüb c
}
ýý 	
catch
þþ 
(
þþ $
CryptographicException
þþ %
ex
þþ& (
)
þþ( )
{
ÿÿ 	
return
€€ 
Result
€€ 
<
€€ 
Option
€€  
<
€€  !
byte
€€! %
[
€€% &
]
€€& '
>
€€' (
,
€€( )'
InternalServiceApiFailure
€€* C
>
€€C D
.
€€D E
Err
€€E H
(
€€H I'
InternalServiceApiFailure
 )
.
) *%
SecureStoreAccessDenied
* A
(
A B&
ApplicationErrorMessages
‚‚ ,
.
‚‚, -#
SecureStorageProvider
‚‚- B
.
‚‚B C$
FAILED_TO_DECRYPT_DATA
‚‚C Y
,
‚‚Y Z
ex
‚‚[ ]
)
‚‚] ^
)
‚‚^ _
;
‚‚_ `
}
ƒƒ 	
catch
„„ 
(
„„ 
IOException
„„ 
ex
„„ 
)
„„ 
{
…… 	
return
†† 
Result
†† 
<
†† 
Option
††  
<
††  !
byte
††! %
[
††% &
]
††& '
>
††' (
,
††( )'
InternalServiceApiFailure
††* C
>
††C D
.
††D E
Err
††E H
(
††H I'
InternalServiceApiFailure
‡‡ )
.
‡‡) *%
SecureStoreAccessDenied
‡‡* A
(
‡‡A B&
ApplicationErrorMessages
ˆˆ ,
.
ˆˆ, -#
SecureStorageProvider
ˆˆ- B
.
ˆˆB C&
FAILED_TO_ACCESS_STORAGE
ˆˆC [
,
ˆˆ[ \
ex
ˆˆ] _
)
ˆˆ_ `
)
ˆˆ` a
;
ˆˆa b
}
‰‰ 	
}
ŠŠ 
public
ŒŒ 

Result
ŒŒ 
<
ŒŒ 
Unit
ŒŒ 
,
ŒŒ '
InternalServiceApiFailure
ŒŒ 1
>
ŒŒ1 2
Delete
ŒŒ3 9
(
ŒŒ9 :
string
ŒŒ: @
key
ŒŒA D
)
ŒŒD E
{
 
if
ŽŽ 

(
ŽŽ 
string
ŽŽ 
.
ŽŽ 
IsNullOrEmpty
ŽŽ  
(
ŽŽ  !
key
ŽŽ! $
)
ŽŽ$ %
)
ŽŽ% &
{
 	
throw
 
new
 #
ArgumentNullException
 +
(
+ ,
nameof
, 2
(
2 3
key
3 6
)
6 7
)
7 8
;
8 9
}
‘‘ 	
try
““ 
{
”” 	
string
•• 
filePath
•• 
=
•• 
GetHashedFilePath
•• /
(
••/ 0
key
••0 3
)
••3 4
;
••4 5
if
–– 
(
–– 
File
–– 
.
–– 
Exists
–– 
(
–– 
filePath
–– $
)
––$ %
)
––% &
{
—— 
File
˜˜ 
.
˜˜ 
Delete
˜˜ 
(
˜˜ 
filePath
˜˜ $
)
˜˜$ %
;
˜˜% &
}
™™ 
return
›› 
Result
›› 
<
›› 
Unit
›› 
,
›› '
InternalServiceApiFailure
››  9
>
››9 :
.
››: ;
Ok
››; =
(
››= >
Unit
››> B
.
››B C
Value
››C H
)
››H I
;
››I J
}
œœ 	
catch
 
(
 
IOException
 
ex
 
)
 
{
žž 	
return
ŸŸ 
Result
ŸŸ 
<
ŸŸ 
Unit
ŸŸ 
,
ŸŸ '
InternalServiceApiFailure
ŸŸ  9
>
ŸŸ9 :
.
ŸŸ: ;
Err
ŸŸ; >
(
ŸŸ> ?'
InternalServiceApiFailure
   )
.
  ) *%
SecureStoreAccessDenied
  * A
(
  A B&
ApplicationErrorMessages
¡¡ ,
.
¡¡, -#
SecureStorageProvider
¡¡- B
.
¡¡B C+
FAILED_TO_DELETE_FROM_STORAGE
¡¡C `
,
¡¡` a
ex
¡¡b d
)
¡¡d e
)
¡¡e f
;
¡¡f g
}
¢¢ 	
}
££ 
private
¥¥ 
string
¥¥ 
GetHashedFilePath
¥¥ $
(
¥¥$ %
string
¥¥% +
key
¥¥, /
)
¥¥/ 0
{
¦¦ 
byte
§§ 
[
§§ 
]
§§ 
	hashBytes
§§ 
=
§§ 
SHA256
§§ !
.
§§! "
HashData
§§" *
(
§§* +
Encoding
§§+ 3
.
§§3 4
UTF8
§§4 8
.
§§8 9
GetBytes
§§9 A
(
§§A B
key
§§B E
)
§§E F
)
§§F G
;
§§G H
string
¨¨ 
safeFilename
¨¨ 
=
¨¨ 
Convert
¨¨ %
.
¨¨% &
ToHexString
¨¨& 1
(
¨¨1 2
	hashBytes
¨¨2 ;
)
¨¨; <
;
¨¨< =
return
©© 
Path
©© 
.
©© 
Combine
©© 
(
©© 
_storagePath
©© (
,
©©( )
$"
©©* ,
{
©©, -
safeFilename
©©- 9
}
©©9 :
$str
©©: >
"
©©> ?
)
©©? @
;
©©@ A
}
ªª 
private
¬¬ 
void
¬¬ (
InitializeStorageDirectory
¬¬ +
(
¬¬+ ,
)
¬¬, -
{
­­ 
try
®® 
{
¯¯ 	
if
°° 
(
°° 
!
°° 
	Directory
°° 
.
°° 
Exists
°° !
(
°°! "
_storagePath
°°" .
)
°°. /
)
°°/ 0
{
±± 
	Directory
²² 
.
²² 
CreateDirectory
²² )
(
²²) *
_storagePath
²²* 6
)
²²6 7
;
²²7 8
if
´´ 
(
´´  
RuntimeInformation
´´ &
.
´´& '
IsOSPlatform
´´' 3
(
´´3 4

OSPlatform
´´4 >
.
´´> ?
Linux
´´? D
)
´´D E
||
´´F H 
RuntimeInformation
µµ &
.
µµ& '
IsOSPlatform
µµ' 3
(
µµ3 4

OSPlatform
µµ4 >
.
µµ> ?
OSX
µµ? B
)
µµB C
)
µµC D
{
¶¶ 
File
·· 
.
·· 
SetUnixFileMode
·· (
(
··( )
_storagePath
··) 5
,
··5 6
UnixFileMode
¸¸ $
.
¸¸$ %
UserRead
¸¸% -
|
¸¸. /
UnixFileMode
¸¸0 <
.
¸¸< =
	UserWrite
¸¸= F
|
¸¸G H
UnixFileMode
¸¸I U
.
¸¸U V
UserExecute
¸¸V a
)
¸¸a b
;
¸¸b c
}
¹¹ 
}
ºº 
}
»» 	
catch
¼¼ 
(
¼¼ 
IOException
¼¼ 
ex
¼¼ 
)
¼¼ 
{
½½ 	
throw
¾¾ 
new
¾¾ '
InvalidOperationException
¾¾ /
(
¾¾/ 0
string
¿¿ 
.
¿¿ 
Format
¿¿ 
(
¿¿ &
ApplicationErrorMessages
¿¿ 6
.
¿¿6 7#
SecureStorageProvider
¿¿7 L
.
¿¿L M6
(SECURE_STORAGE_DIRECTORY_CREATION_FAILED
¿¿M u
,
¿¿u v
_storagePath
ÀÀ  
)
ÀÀ  !
,
ÀÀ! "
ex
ÀÀ# %
)
ÀÀ% &
;
ÀÀ& '
}
ÁÁ 	
}
ÂÂ 
private
ÄÄ 
static
ÄÄ 
void
ÄÄ &
SetSecureFilePermissions
ÄÄ 0
(
ÄÄ0 1
string
ÄÄ1 7
filePath
ÄÄ8 @
)
ÄÄ@ A
{
ÅÅ 
if
ÆÆ 

(
ÆÆ 
!
ÆÆ  
RuntimeInformation
ÆÆ 
.
ÆÆ  
IsOSPlatform
ÆÆ  ,
(
ÆÆ, -

OSPlatform
ÆÆ- 7
.
ÆÆ7 8
Linux
ÆÆ8 =
)
ÆÆ= >
&&
ÆÆ? A
!
ÆÆB C 
RuntimeInformation
ÆÆC U
.
ÆÆU V
IsOSPlatform
ÆÆV b
(
ÆÆb c

OSPlatform
ÆÆc m
.
ÆÆm n
OSX
ÆÆn q
)
ÆÆq r
)
ÆÆr s
{
ÇÇ 	
return
ÈÈ 
;
ÈÈ 
}
ÉÉ 	
File
ËË 
.
ËË 
SetUnixFileMode
ËË 
(
ËË 
filePath
ËË %
,
ËË% &
UnixFileMode
ËË' 3
.
ËË3 4
UserRead
ËË4 <
|
ËË= >
UnixFileMode
ËË? K
.
ËËK L
	UserWrite
ËËL U
)
ËËU V
;
ËËV W
}
ÌÌ 
public
ÎÎ 

	ValueTask
ÎÎ 
DisposeAsync
ÎÎ !
(
ÎÎ! "
)
ÎÎ" #
{
ÏÏ 
if
ÐÐ 

(
ÐÐ 
!
ÐÐ 
	_disposed
ÐÐ 
)
ÐÐ 
{
ÑÑ 	
	_disposed
ÒÒ 
=
ÒÒ 
true
ÒÒ 
;
ÒÒ 
}
ÓÓ 	
return
ÕÕ 
	ValueTask
ÕÕ 
.
ÕÕ 
CompletedTask
ÕÕ &
;
ÕÕ& '
}
ÖÖ 
}×× Û3
‰/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Data/PendingLogoutRequestStorage.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Infrastructure

 &
.

& '
Data

' +
;

+ ,
internal 
sealed	 
class '
PendingLogoutRequestStorage 1
(1 2-
!IApplicationSecureStorageProvider2 S
storageProviderT c
)c d
{ 
private 
const 
string 
STORAGE_KEY $
=% &
$str' 6
;6 7
public 

async 
Task 
< 
Result 
< 
Unit !
,! "
LogoutFailure# 0
>0 1
>1 2#
StorePendingLogoutAsync3 J
(J K
LogoutRequestK X
requestY `
)` a
{ 
byte 
[ 
] 
requestData 
= 
request $
.$ %
ToByteArray% 0
(0 1
)1 2
;2 3
Result 
< 
Unit 
, %
InternalServiceApiFailure .
>. /
storeResult0 ;
=< =
await 
storageProvider !
.! "

StoreAsync" ,
(, -
STORAGE_KEY- 8
,8 9
requestData: E
)E F
.F G
ConfigureAwaitG U
(U V
falseV [
)[ \
;\ ]
if 

( 
storeResult 
. 
IsErr 
) 
{ 	
return 
Result 
< 
Unit 
, 
LogoutFailure  -
>- .
.. /
Err/ 2
(2 3
LogoutFailure 
. 
UnexpectedError -
(- .
$". 0
$str0 @
{@ A
storeResultA L
.L M
	UnwrapErrM V
(V W
)W X
.X Y
MessageY `
}` a
"a b
)b c
)c d
;d e
} 	
return 
Result 
< 
Unit 
, 
LogoutFailure )
>) *
.* +
Ok+ -
(- .
Unit. 2
.2 3
Value3 8
)8 9
;9 :
} 
public   

async   
Task   
<   
Result   
<   
Option   #
<  # $
LogoutRequest  $ 1
>  1 2
,  2 3
LogoutFailure  4 A
>  A B
>  B C!
GetPendingLogoutAsync  D Y
(  Y Z
)  Z [
{!! 
Result"" 
<"" 
Option"" 
<"" 
byte"" 
["" 
]"" 
>"" 
,"" %
InternalServiceApiFailure"" 8
>""8 9
	getResult"": C
=""D E
await## 
storageProvider## !
.##! "
TryGetByKeyAsync##" 2
(##2 3
STORAGE_KEY##3 >
)##> ?
.##? @
ConfigureAwait##@ N
(##N O
false##O T
)##T U
;##U V
if%% 

(%% 
	getResult%% 
.%% 
IsErr%% 
)%% 
{&& 	
return'' 
Result'' 
<'' 
Option''  
<''  !
LogoutRequest''! .
>''. /
,''/ 0
LogoutFailure''1 >
>''> ?
.''? @
Err''@ C
(''C D
LogoutFailure(( 
.(( 
UnexpectedError(( -
(((- .
$"((. 0
$str((0 G
{((G H
	getResult((H Q
.((Q R
	UnwrapErr((R [
((([ \
)((\ ]
.((] ^
Message((^ e
}((e f
"((f g
)((g h
)((h i
;((i j
})) 	
Option++ 
<++ 
byte++ 
[++ 
]++ 
>++ 

dataOption++ !
=++" #
	getResult++$ -
.++- .
Unwrap++. 4
(++4 5
)++5 6
;++6 7
if,, 

(,, 
!,, 

dataOption,, 
.,, 
IsSome,, 
),, 
{-- 	
return.. 
Result.. 
<.. 
Option..  
<..  !
LogoutRequest..! .
>... /
,../ 0
LogoutFailure..1 >
>..> ?
...? @
Ok..@ B
(..B C
Option..C I
<..I J
LogoutRequest..J W
>..W X
...X Y
None..Y ]
)..] ^
;..^ _
}// 	
try11 
{22 	
LogoutRequest33 
request33 !
=33" #
LogoutRequest33$ 1
.331 2
Parser332 8
.338 9
	ParseFrom339 B
(33B C

dataOption33C M
.33M N
Value33N S
)33S T
;33T U
return44 
Result44 
<44 
Option44  
<44  !
LogoutRequest44! .
>44. /
,44/ 0
LogoutFailure441 >
>44> ?
.44? @
Ok44@ B
(44B C
Option44C I
<44I J
LogoutRequest44J W
>44W X
.44X Y
Some44Y ]
(44] ^
request44^ e
)44e f
)44f g
;44g h
}55 	
catch66 
(66 *
InvalidProtocolBufferException66 -
ex66. 0
)660 1
{77 	
ClearPendingLogout88 
(88 
)88  
;88  !
return99 
Result99 
<99 
Option99  
<99  !
LogoutRequest99! .
>99. /
,99/ 0
LogoutFailure991 >
>99> ?
.99? @
Err99@ C
(99C D
LogoutFailure:: 
.:: 
UnexpectedError:: -
(::- .
$"::. 0
$str::0 P
{::P Q
ex::Q S
.::S T
Message::T [
}::[ \
"::\ ]
,::] ^
ex::_ a
)::a b
)::b c
;::c d
};; 	
}<< 
public>> 

void>> 
ClearPendingLogout>> "
(>>" #
)>># $
=>>>% '
storageProvider>>( 7
.>>7 8
Delete>>8 >
(>>> ?
STORAGE_KEY>>? J
)>>J K
;>>K L
}?? Ñ
œ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Infrastructure/Data/Abstractions/IApplicationSecureStorageProvider.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Infrastructure &
.& '
Data' +
.+ ,
Abstractions, 8
;8 9
public 
	interface -
!IApplicationSecureStorageProvider 2
:3 4
IAsyncDisposable5 E
{ 
Task 
< 	
Result	 
< 
Unit 
, %
InternalServiceApiFailure /
>/ 0
>0 1.
"SetApplicationSettingsCultureAsync2 T
(T U
stringU [
?[ \
cultureName] h
)h i
;i j
Task 
< 	
Result	 
< 
Unit 
, %
InternalServiceApiFailure /
>/ 0
>0 1'
SetApplicationInstanceAsync2 M
(M N
boolN R
isNewInstanceS `
)` a
;a b
Task 
< 	
Result	 
< 
Unit 
, %
InternalServiceApiFailure /
>/ 0
>0 1(
SetApplicationIpCountryAsync2 N
(N O
	IpCountryO X
	ipCountryY b
)b c
;c d
Task 
< 	
Result	 
< 
Unit 
, %
InternalServiceApiFailure /
>/ 0
>0 1)
SetApplicationMembershipAsync2 O
(O P

MembershipP Z
?Z [

membership\ f
)f g
;g h
Task 
< 	
Result	 
< 
Unit 
, %
InternalServiceApiFailure /
>/ 0
>0 1$
SetCurrentAccountIdAsync2 J
(J K

ByteStringK U
?U V
	accountIdW `
)` a
;a b
Task 
< 	
Result	 
< '
ApplicationInstanceSettings +
,+ ,%
InternalServiceApiFailure- F
>F G
>G H/
#GetApplicationInstanceSettingsAsyncI l
(l m
)m n
;n o
Task 
< 	
Result	 
< "
InstanceSettingsResult &
,& '%
InternalServiceApiFailure( A
>A B
>B C0
$InitApplicationInstanceSettingsAsyncD h
(h i
string 
? 
defaultCulture 
) 
;  
Task 
< 	
Result	 
< 
Unit 
, %
InternalServiceApiFailure /
>/ 0
>0 1

StoreAsync2 <
(< =
string= C
keyD G
,G H
byteI M
[M N
]N O
dataP T
)T U
;U V
Task 
< 	
Result	 
< 
Option 
< 
byte 
[ 
] 
> 
, %
InternalServiceApiFailure  9
>9 :
>: ;
TryGetByKeyAsync< L
(L M
stringM S
keyT W
)W X
;X Y
Result 

<
 
Unit 
, %
InternalServiceApiFailure *
>* +
Delete, 2
(2 3
string3 9
key: =
)= >
;> ?
} Â6
‚/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Splash/Views/SplashWindow.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Splash! '
.' (
Views( -
;- .
public 
partial 
class 
SplashWindow !
:" #
ReactiveWindow$ 2
<2 3!
SplashWindowViewModel3 H
>H I
{ 
private 
const 
string 
CONNECTED_CLASS (
=) *
$str+ 6
;6 7
private 
const 
string 
CONNECTING_CLASS )
=* +
$str, 8
;8 9
private 
const 
string 
DISCONNECTED_CLASS +
=, -
$str. <
;< =
private 
const 
string 
RESTORE_CLASS &
=' (
$str) 2
;2 3
private 
const 
string 
DEFAULT_CLASS &
=' (
$str) 2
;2 3
private 
static 
readonly 
FrozenDictionary ,
<, -
ConnectivityStatus- ?
,? @
stringA G
>G H
StatusClassMapI W
=X Y
new 

Dictionary 
< 
ConnectivityStatus )
,) *
string+ 1
>1 2
{ 	
[ 
ConnectivityStatus 
.  
	Connected  )
]) *
=+ ,
CONNECTED_CLASS- <
,< =
[ 
ConnectivityStatus 
.  

Connecting  *
]* +
=, -
CONNECTING_CLASS. >
,> ?
[ 
ConnectivityStatus 
.  

Recovering  *
]* +
=, -
RESTORE_CLASS. ;
,; <
[ 
ConnectivityStatus 
.  
Disconnected  ,
], -
=. /
DISCONNECTED_CLASS0 B
,B C
[ 
ConnectivityStatus 
.  
Unavailable  +
]+ ,
=- .
DISCONNECTED_CLASS/ A
,A B
[ 
ConnectivityStatus 
.  
RetriesExhausted  0
]0 1
=2 3
DISCONNECTED_CLASS4 F
,F G
[ 
ConnectivityStatus 
.  
ShuttingDown  ,
], -
=. /
DISCONNECTED_CLASS0 B
}   	
.  	 

ToFrozenDictionary  
 
(   
)   
;   
private"" 
ConnectivityStatus"" &
_currentConnectivityStatus"" 9
="": ;
ConnectivityStatus""< N
.""N O
Disconnected""O [
;""[ \
public$$ 

SplashWindow$$ 
($$ 
)$$ 
{%% 
InitializeComponent&& 
(&& 
)&& 
;&& $
SetupPrecompiledBindings''  
(''  !
)''! "
;''" #
}(( 
private** 
void** $
SetupPrecompiledBindings** )
(**) *
)*** +
{++ 
this,, 
.,, 
WhenActivated,, 
(,, 
disposables,, &
=>,,' )
{-- 	
this.. 
... 
WhenAnyValue.. 
(.. 
x.. 
=>..  "
x..# $
...$ %
DataContext..% 0
)..0 1
.// 
Where// 
(// 
dc// 
=>// 
dc// 
!=//  "
null//# '
)//' (
.00 
Select00 
(00 
dc00 
=>00 
dc00  
!00  !
)00! "
.11 
OfType11 
<11 !
SplashWindowViewModel11 -
>11- .
(11. /
)11/ 0
.22 

SelectMany22 
(22 
vm22 
=>22 !
vm22" $
.22$ %
WhenAnyValue22% 1
(221 2
x222 3
=>224 6
x227 8
.228 9
ConnectivityStatus229 K
)22K L
)22L M
.33  
DistinctUntilChanged33 %
(33% &
)33& '
.44 
	ObserveOn44 
(44 
RxApp44  
.44  !
MainThreadScheduler44! 4
)444 5
.55 
	Subscribe55 
(55 
UpdateWindowClass55 ,
)55, -
.66 
DisposeWith66 
(66 
disposables66 (
)66( )
;66) *
}77 	
)77	 

;77
 
}88 
private:: 
void:: 
UpdateWindowClass:: "
(::" #
ConnectivityStatus::# 5
status::6 <
)::< =
{;; 
if<< 

(<< &
_currentConnectivityStatus<< &
==<<' )
status<<* 0
)<<0 1
{== 	
return>> 
;>> 
}?? 	
ifAA 

(AA &
_currentConnectivityStatusAA &
!=AA' )
ConnectivityStatusAA* <
.AA< =
DisconnectedAA= I
)AAI J
{BB 	
stringCC 
oldClassCC 
=CC !
GetClassForStatusFastCC 3
(CC3 4&
_currentConnectivityStatusCC4 N
)CCN O
;CCO P
ClassesDD 
.DD 
RemoveDD 
(DD 
oldClassDD #
)DD# $
;DD$ %
}EE 	
stringGG 
newClassGG 
=GG !
GetClassForStatusFastGG /
(GG/ 0
statusGG0 6
)GG6 7
;GG7 8
ClassesHH 
.HH 
AddHH 
(HH 
newClassHH 
)HH 
;HH &
_currentConnectivityStatusII "
=II# $
statusII% +
;II+ ,
}JJ 
privateLL 
staticLL 
stringLL !
GetClassForStatusFastLL /
(LL/ 0
ConnectivityStatusLL0 B
statusLLC I
)LLI J
=>LLK M
StatusClassMapMM 
.MM 
GetValueOrDefaultMM (
(MM( )
statusMM) /
,MM/ 0
DEFAULT_CLASSMM1 >
)MM> ?
;MM? @
	protectedOO 
overrideOO 
voidOO 

OnUnloadedOO &
(OO& '
RoutedEventArgsOO' 6
eOO7 8
)OO8 9
{PP &
_currentConnectivityStatusQQ "
=QQ# $
ConnectivityStatusQQ% 7
.QQ7 8
DisconnectedQQ8 D
;QQD E
baseRR 
.RR 

OnUnloadedRR 
(RR 
eRR 
)RR 
;RR 
}SS 
}TT ó"
Š/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Splash/ViewModels/SplashWindowViewModel.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Features

  
.

  !
Splash

! '
.

' (

ViewModels

( 2
;

2 3
public 
sealed 
class !
SplashWindowViewModel )
:* +
Core, 0
.0 1
MVVM1 5
.5 6
ViewModelBase6 C
{ 
private  
ConnectivitySnapshot  
_connectivity! .
=/ 0 
ConnectivitySnapshot1 E
.E F
InitialF M
withN R
{S T
StatusU [
=\ ]
ConnectivityStatus^ p
.p q

Connectingq {
}| }
;} ~
private 
bool 
_isShuttingDown  
;  !
public 
 
ConnectivitySnapshot 
Connectivity  ,
{ 
get 
=> 
_connectivity 
; 
private 
set 
{ 	
this 
.  
RaiseAndSetIfChanged %
(% &
ref& )
_connectivity* 7
,7 8
value9 >
)> ?
;? @
this 
.  
RaisePropertyChanged %
(% &
nameof& ,
(, -
ConnectivityStatus- ?
)? @
)@ A
;A B
} 	
} 
public 

ConnectivityStatus 
ConnectivityStatus 0
=>1 3
Connectivity4 @
.@ A
StatusA G
;G H
public 
 
TaskCompletionSource 
<  
bool  $
>$ %
IsSubscribed& 2
{3 4
get5 8
;8 9
}: ;
=< =
new> A
(A B
)B C
;C D
public 
!
SplashWindowViewModel  
(  ! 
IConnectivityService   
connectivityService   0
,  0 1 
ILocalizationService!! 
localizationService!! 0
,!!0 1
NetworkProvider"" 
networkProvider"" '
)""' (
:## 	
base##
 
(## 
networkProvider## 
,## 
localizationService##  3
)##3 4
{$$ *
SetupPrecompiledNetworkBinding%% &
(%%& '
connectivityService%%' :
)%%: ;
;%%; <
}&& 
public(( 

Task(( #
PrepareForShutdownAsync(( '
(((' (
)((( )
{)) 
_isShuttingDown** 
=** 
true** 
;** 
return++ 
Task++ 
.++ 
CompletedTask++ !
;++! "
},, 
private.. 
void.. *
SetupPrecompiledNetworkBinding.. /
(../ 0 
IConnectivityService..0 D
connectivityService..E X
)..X Y
{// %
ProcessConnectivityChange00 !
(00! "
connectivityService00" 5
.005 6
CurrentSnapshot006 E
)00E F
;00F G
IDisposable22 
subscription22  
=22! "
connectivityService22# 6
.226 7
ConnectivityStream227 I
.22I J
	Subscribe22J S
(22S T%
ProcessConnectivityChange22T m
)22m n
;22n o
this44 
.44 
WhenActivated44 
(44 
disposables44 &
=>44' )
{55 	
subscription66 
.66 
DisposeWith66 $
(66$ %
disposables66% 0
)660 1
;661 2
IsSubscribed77 
.77 
TrySetResult77 %
(77% &
true77& *
)77* +
;77+ ,
}88 	
)88	 

;88
 
}99 
private;; 
void;; %
ProcessConnectivityChange;; *
(;;* + 
ConnectivitySnapshot;;+ ?
snapshot;;@ H
);;H I
{<< 
if== 

(== 
_isShuttingDown== 
)== 
{>> 	
return?? 
;?? 
}@@ 	
ConnectivityBB 
=BB 
snapshotBB 
;BB  
}CC 
}DD ¿
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Main/Views/MasterView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Main! %
.% &
Views& +
;+ ,
public 
partial 
class 

MasterView 
:  !
UserControl" -
{ 
public 


MasterView 
( 
) 
{		 
AvaloniaXamlLoader

 
.

 
Load

 
(

  
this

  $
)

$ %
;

% &
} 
} õ
Š/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Main/Views/Components/WelcomeView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Main! %
.% &
Views& +
.+ ,

Components, 6
;6 7
public 
partial 
class 
WelcomeView  
:! "
UserControl# .
{ 
public 

WelcomeView 
( 
) 
{		 
AvaloniaXamlLoader

 
.

 
Load

 
(

  
this

  $
)

$ %
;

% &
} 
} šH
‚/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Main/ViewModels/MasterViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Main! %
.% &

ViewModels& 0
;0 1
public 
sealed 
class 
MasterViewModel #
:$ %
Core& *
.* +
MVVM+ /
./ 0
ViewModelBase0 =
{ 
private 
readonly 
ILogoutService #
_logoutService$ 2
;2 3
private 
readonly 
CompositeDisposable (
_disposables) 5
=6 7
new8 ;
(; <
)< =
;= >
private #
CancellationTokenSource #
?# $*
_logoutCancellationTokenSource% C
;C D
private 
bool 
_isDisposed 
; 
[  
ObservableAsProperty 
] 
public !
bool" &
IsBusy' -
{. /
get0 3
;3 4
}5 6
public!! 
-
!ConnectivityNotificationViewModel!! ,$
ConnectivityNotification!!- E
{!!F G
get!!H K
;!!K L
}!!M N
public## 

ReactiveCommand## 
<## 
SystemU## "
,##" #
Result##$ *
<##* +
Unit##+ /
,##/ 0
LogoutFailure##1 >
>##> ?
>##? @
LogoutCommand##A N
{##O P
get##Q T
;##T U
}##V W
public%% 

MasterViewModel%% 
(%% 
NetworkProvider&& 
networkProvider&& '
,&&' ( 
ILocalizationService'' 
localizationService'' 0
,''0 1
ILogoutService(( 
logoutService(( $
,(($ %
MainWindowViewModel)) 
mainWindowViewModel)) /
)))/ 0
:** 	
base**
 
(** 
networkProvider** 
,** 
localizationService**  3
,**3 4
null**5 9
)**9 :
{++ 
_logoutService,, 
=,, 
logoutService,, &
;,,& '$
ConnectivityNotification--  
=--! "
mainWindowViewModel--# 6
.--6 7$
ConnectivityNotification--7 O
;--O P
IObservable// 
<// 
bool// 
>// 
	canLogout// #
=//$ %
this//& *
.//* +
WhenAnyValue//+ 7
(//7 8
x//8 9
=>//: <
x//= >
.//> ?
IsBusy//? E
,//E F
isBusy//G M
=>//N P
!//Q R
isBusy//R X
)//X Y
;//Y Z
LogoutCommand11 
=11 
ReactiveCommand11 '
.11' (
CreateFromTask11( 6
(116 7
async22 
(22 
)22 
=>22 
{33 !
CancelLogoutOperation44 %
(44% &
)44& '
;44' (#
CancellationTokenSource66 '
operationCts66( 4
=665 6
new667 :
(66: ;
)66; <
;66< =*
_logoutCancellationTokenSource77 .
=77/ 0
operationCts771 =
;77= >
try99 
{:: 
Result;; 
<;; 
Unit;; 
,;;  
LogoutFailure;;! .
>;;. /
result;;0 6
=;;7 8
await;;9 >
_logoutService;;? M
.;;M N
LogoutAsync;;N Y
(;;Y Z
LogoutReason<< $
.<<$ %
UserInitiated<<% 2
,<<2 3
operationCts== $
.==$ %
Token==% *
)==* +
.==+ ,
ConfigureAwait==, :
(==: ;
false==; @
)==@ A
;==A B
return>> 
result>> !
;>>! "
}?? 
catch@@ 
(@@ 
TimeoutException@@ '
ex@@( *
)@@* +
{AA 
returnBB 
ResultBB !
<BB! "
UnitBB" &
,BB& '
LogoutFailureBB( 5
>BB5 6
.BB6 7
ErrBB7 :
(BB: ;
LogoutFailureCC %
.CC% & 
NetworkRequestFailedCC& :
(CC: ;
$strCC; m
,CCm n
exCCo q
)CCq r
)CCr s
;CCs t
}DD 
catchEE 
(EE &
OperationCanceledExceptionEE 1
exEE2 4
)EE4 5
{FF 
returnGG 
ResultGG !
<GG! "
UnitGG" &
,GG& '
LogoutFailureGG( 5
>GG5 6
.GG6 7
ErrGG7 :
(GG: ;
LogoutFailureHH %
.HH% & 
NetworkRequestFailedHH& :
(HH: ;
$strHH; N
,HHN O
exHHP R
)HHR S
)HHS T
;HHT U
}II 
catchJJ 
(JJ 
	ExceptionJJ  
exJJ! #
)JJ# $
{KK 
returnLL 
ResultLL !
<LL! "
UnitLL" &
,LL& '
LogoutFailureLL( 5
>LL5 6
.LL6 7
ErrLL7 :
(LL: ;
LogoutFailureMM %
.MM% & 
NetworkRequestFailedMM& :
(MM: ;
$strMM; f
,MMf g
exMMh j
)MMj k
)MMk l
;MMl m
}NN 
finallyOO 
{PP 
ifQQ 
(QQ 
ReferenceEqualsQQ '
(QQ' (*
_logoutCancellationTokenSourceQQ( F
,QQF G
operationCtsQQH T
)QQT U
)QQU V
{RR *
_logoutCancellationTokenSourceSS 6
=SS7 8
nullSS9 =
;SS= >
}TT 
operationCtsVV  
.VV  !
DisposeVV! (
(VV( )
)VV) *
;VV* +
}WW 
}XX 
,XX 
	canLogoutYY 
)YY 
;YY 
LogoutCommand[[ 
.[[ 
IsExecuting[[ !
.[[! "
ToPropertyEx[[" .
([[. /
this[[/ 3
,[[3 4
x[[5 6
=>[[7 9
x[[: ;
.[[; <
IsBusy[[< B
)[[B C
.[[C D
DisposeWith[[D O
([[O P
_disposables[[P \
)[[\ ]
;[[] ^
LogoutCommand]] 
.^^ 
Where^^ 
(^^ 
result^^ 
=>^^ 
result^^ #
.^^# $
IsErr^^$ )
)^^) *
.__ 
Select__ 
(__ 
result__ 
=>__ 
result__ $
.__$ %
	UnwrapErr__% .
(__. /
)__/ 0
)__0 1
.`` 
	Subscribe`` 
(`` 
error`` 
=>`` 
{aa 
Logbb 
.bb 
Errorbb 
(bb 
$strbb 4
,bb4 5
errorbb6 ;
.bb; <
Messagebb< C
)bbC D
;bbD E
}cc 
)cc 
.dd 
DisposeWithdd 
(dd 
_disposablesdd %
)dd% &
;dd& '
}ff 
	protectedhh 
overridehh 
voidhh 
Disposehh #
(hh# $
boolhh$ (
	disposinghh) 2
)hh2 3
{ii 
ifjj 

(jj 
_isDisposedjj 
)jj 
{kk 	
returnll 
;ll 
}mm 	
ifoo 

(oo 
	disposingoo 
)oo 
{pp 	!
CancelLogoutOperationqq !
(qq! "
)qq" #
;qq# $
LogoutCommandrr 
?rr 
.rr 
Disposerr "
(rr" #
)rr# $
;rr$ %
_disposablesss 
.ss 
Disposess  
(ss  !
)ss! "
;ss" #
}tt 	
basevv 
.vv 
Disposevv 
(vv 
	disposingvv 
)vv 
;vv  
_isDisposedww 
=ww 
trueww 
;ww 
}xx 
privatezz 
voidzz !
CancelLogoutOperationzz &
(zz& '
)zz' (
{{{ #
CancellationTokenSource|| 
?||  
logoutSource||! -
=||. /
Interlocked||0 ;
.||; <
Exchange||< D
(||D E
ref||E H*
_logoutCancellationTokenSource||I g
,||g h
null||i m
)||m n
;||n o
if}} 

(}} 
logoutSource}} 
==}} 
null}}  
)}}  !
{~~ 	
return 
; 
}
€€ 	
try
‚‚ 
{
ƒƒ 	
logoutSource
„„ 
.
„„ 
Cancel
„„ 
(
„„  
)
„„  !
;
„„! "
}
…… 	
catch
†† 
(
†† %
ObjectDisposedException
†† &
)
††& '
{
‡‡ 	
}
‰‰ 	
finally
ŠŠ 
{
‹‹ 	
logoutSource
ŒŒ 
.
ŒŒ 
Dispose
ŒŒ  
(
ŒŒ  !
)
ŒŒ! "
;
ŒŒ" #
}
 	
}
ŽŽ 
} å
r/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Main/MainModule.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Main! %
;% &
public		 
record		 
MainModuleManifest		  
(		  !
)		! "
:		# $
ModuleManifest		% 3
(		3 4
Priority

 
:

 
$num

 
,

 
LoadingStrategy 
: !
ModuleLoadingStrategy *
.* +
Lazy+ /
,/ 0
Dependencies 
: 
[ 
] 
) 
; 
public 
class 

MainModule 
: 

ModuleBase $
<$ %
MainModuleManifest% 7
>7 8
{ 
public 

override 
ModuleIdentifier $
Id% '
=>( *
ModuleIdentifier+ ;
.; <
Main< @
;@ A
public 

override 
MainModuleManifest &
Manifest' /
{0 1
get2 5
;5 6
}7 8
=9 :
new; >
(> ?
)? @
;@ A
public 

override 
async 
Task %
SetupMessageHandlersAsync 8
(8 9
IModuleMessageBus9 J

messageBusK U
)U V
{ 
await 

messageBus 
. 
PublishAsync %
(% &
new& )"
ModuleInitializedEvent* @
{ 	

ModuleName 
= 
Id 
. 
ToName "
(" #
)# $
} 	
)	 

;
 
Log 
. 
Information 
( 
$str F
)F G
;G H
} 
} Ç
‘/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/Welcome/WelcomeView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Views0 5
.5 6
Welcome6 =
;= >
public 
partial 
class 
WelcomeView  
:! "
ReactiveUserControl# 6
<6 7
WelcomeViewModel7 G
>G H
{ 
public		 

WelcomeView		 
(		 
)		 
{

 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
} ¡H
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/SignIn/SignInView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Views0 5
.5 6
SignIn6 <
;< =
public 
partial 
class 

SignInView 
:  !
ReactiveUserControl" 5
<5 6
SignInViewModel6 E
>E F
{ 
private 
const 
string ,
 SECURE_KEY_TEXT_BOX_CONTROL_NAME 9
=: ;
$str< N
;N O
private 
bool 
_handlersAttached "
;" #
public 


SignInView 
( 
) 
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
	protected 
override 
void "
OnAttachedToVisualTree 2
(2 3)
VisualTreeAttachmentEventArgs3 P
eQ R
)R S
{ 
base 
. "
OnAttachedToVisualTree #
(# $
e$ %
)% &
;& '
SetupEventHandlers 
( 
) 
; 
} 
	protected 
override 
void $
OnDetachedFromVisualTree 4
(4 5)
VisualTreeAttachmentEventArgs5 R
eS T
)T U
{ 
base   
.   $
OnDetachedFromVisualTree   %
(  % &
e  & '
)  ' (
;  ( )!
TeardownEventHandlers!! 
(!! 
)!! 
;!!  
}"" 
private$$ 
void$$ 
SetupEventHandlers$$ #
($$# $
)$$$ %
{%% 
if&& 

(&& 
_handlersAttached&& 
)&& 
{'' 	
return(( 
;(( 
})) 	
if++ 

(++ 
this++ 
.++ 
FindControl++ 
<++ 
HintedTextBox++ *
>++* +
(+++ ,,
 SECURE_KEY_TEXT_BOX_CONTROL_NAME++, L
)++L M
is++N P
{++Q R
}++S T
secureKeyBox++U a
)++a b
{,, 	
secureKeyBox-- 
.-- $
SecureKeyCharactersAdded-- 1
+=--2 4&
OnSecureKeyCharactersAdded--5 O
;--O P
secureKeyBox.. 
... &
SecureKeyCharactersRemoved.. 3
+=..4 6(
OnSecureKeyCharactersRemoved..7 S
;..S T
secureKeyBox// 
.// 
KeyDown//  
+=//! #!
OnSecureKeyBoxKeyDown//$ 9
;//9 :
secureKeyBox00 
.00 
CharacterRejected00 *
+=00+ -
OnCharacterRejected00. A
;00A B
_handlersAttached11 
=11 
true11  $
;11$ %
}22 	
}33 
private55 
void55 !
TeardownEventHandlers55 &
(55& '
)55' (
{66 
if77 

(77 
!77 
_handlersAttached77 
)77 
{88 	
return99 
;99 
}:: 	
if<< 

(<< 
this<< 
.<< 
FindControl<< 
<<< 
HintedTextBox<< *
><<* +
(<<+ ,,
 SECURE_KEY_TEXT_BOX_CONTROL_NAME<<, L
)<<L M
is<<N P
{<<Q R
}<<S T
secureKeyBox<<U a
)<<a b
{== 	
secureKeyBox>> 
.>> $
SecureKeyCharactersAdded>> 1
-=>>2 4&
OnSecureKeyCharactersAdded>>5 O
;>>O P
secureKeyBox?? 
.?? &
SecureKeyCharactersRemoved?? 3
-=??4 6(
OnSecureKeyCharactersRemoved??7 S
;??S T
secureKeyBox@@ 
.@@ 
KeyDown@@  
-=@@! #!
OnSecureKeyBoxKeyDown@@$ 9
;@@9 :
secureKeyBoxAA 
.AA 
CharacterRejectedAA *
-=AA+ -
OnCharacterRejectedAA. A
;AAA B
}BB 	
_handlersAttachedDD 
=DD 
falseDD !
;DD! "
}EE 
privateGG 
voidGG 
OnCharacterRejectedGG $
(GG$ %
objectGG% +
?GG+ ,
senderGG- 3
,GG3 4&
CharacterRejectedEventArgsGG5 O
eGGP Q
)GGQ R
{HH 
ifII 

(II 
DataContextII 
isII 
notII 
SignInViewModelII .
vmII/ 1
||II2 4
senderII5 ;
isII< >
notII? B
HintedTextBoxIIC P
tbIIQ S
)IIS T
{JJ 	
returnKK 
;KK 
}LL 	
stringNN 
localizedMessageNN 
=NN  !
vmNN" $
.NN$ %&
GetLocalizedWarningMessageNN% ?
(NN? @
eNN@ A
.NNA B
WarningTypeNNB M
)NNM N
;NNN O
tbOO 

.OO
 
WarningTextOO 
=OO 
localizedMessageOO )
;OO) *
tbPP 

.PP
 

HasWarningPP 
=PP 
truePP 
;PP 
}QQ 
privateTT 
voidTT &
OnSecureKeyCharactersAddedTT +
(TT+ ,
objectTT, 2
?TT2 3
senderTT4 :
,TT: ;-
!SecureKeyCharactersAddedEventArgsTT< ]
eTT^ _
)TT_ `
{UU 
ifVV 

(VV 
DataContextVV 
isVV 
notVV 
SignInViewModelVV .
vmVV/ 1
||VV2 4
senderVV5 ;
isVV< >
notVV? B
HintedTextBoxVVC P
tbVVQ S
)VVS T
{WW 	
returnXX 
;XX 
}YY 	
vm[[ 

.[[
  
InsertSecureKeyChars[[ 
([[  
e[[  !
.[[! "
Index[[" '
,[[' (
e[[) *
.[[* +

Characters[[+ 5
)[[5 6
;[[6 7
tb\\ 

.\\
 
SyncSecureKeyState\\ 
(\\ 
vm\\  
.\\  !"
CurrentSecureKeyLength\\! 7
)\\7 8
;\\8 9
}]] 
private__ 
void__ (
OnSecureKeyCharactersRemoved__ -
(__- .
object__. 4
?__4 5
sender__6 <
,__< =/
#SecureKeyCharactersRemovedEventArgs__> a
e__b c
)__c d
{`` 
ifaa 

(aa 
DataContextaa 
isaa 
notaa 
SignInViewModelaa .
vmaa/ 1
||aa2 4
senderaa5 ;
isaa< >
notaa? B
HintedTextBoxaaC P
tbaaQ S
)aaS T
{bb 	
returncc 
;cc 
}dd 	
vmff 

.ff
  
RemoveSecureKeyCharsff 
(ff  
eff  !
.ff! "
Indexff" '
,ff' (
eff) *
.ff* +
Countff+ 0
)ff0 1
;ff1 2
tbgg 

.gg
 
SyncSecureKeyStategg 
(gg 
vmgg  
.gg  !"
CurrentSecureKeyLengthgg! 7
)gg7 8
;gg8 9
}hh 
privatejj 
voidjj !
OnSecureKeyBoxKeyDownjj &
(jj& '
objectjj' -
?jj- .
senderjj/ 5
,jj5 6
KeyEventArgsjj7 C
ejjD E
)jjE F
{kk 
ifll 

(ll 
ell 
.ll 
Keyll 
!=ll 
Keyll 
.ll 
Enterll 
&&ll !
ell" #
.ll# $
Keyll$ '
!=ll( *
Keyll+ .
.ll. /
Returnll/ 5
)ll5 6
{mm 	
returnnn 
;nn 
}oo 	
ifqq 

(qq 
DataContextqq 
isqq 
notqq 
SignInViewModelqq .
vmqq/ 1
)qq1 2
{rr 	
returnss 
;ss 
}tt 	
vmvv 

.vv
 $
HandleEnterKeyPressAsyncvv #
(vv# $
)vv$ %
.vv% &
ContinueWithvv& 2
(vv2 3
taskww 
=>ww 
{xx 
ifyy 
(yy 
taskyy 
isyy 
{yy 
	IsFaultedyy '
:yy' (
trueyy) -
,yy- .
	Exceptionyy/ 8
:yy8 9
notyy: =
nullyy> B
}yyC D
)yyD E
{zz 
Serilog{{ 
.{{ 
Log{{ 
.{{  
Error{{  %
({{% &
task{{& *
.{{* +
	Exception{{+ 4
,{{4 5
$str{{6 u
){{u v
;{{v w
}|| 
}}} 
,}} 
TaskScheduler~~ 
.~~ 
Default~~ !
)~~! "
;~~" #
e 	
.	 

Handled
 
= 
true 
; 
}
€€ 
} ±*
¤/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/Registration/VerificationCodeEntryView.axaml.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Features

  
.

  !
Authentication

! /
.

/ 0
Views

0 5
.

5 6
Registration

6 B
;

B C
public 
partial 
class %
VerificationCodeEntryView .
:/ 0
ReactiveUserControl1 D
<D E
VerifyOtpViewModelE W
>W X
{ 
private 
bool 
_handlersAttached "
;" #
public 
%
VerificationCodeEntryView $
($ %
)% &
{ 
InitializeComponent 
( 
) 
; 
} 
private 
void 
InitializeComponent $
($ %
)% &
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
	protected 
override 
void "
OnAttachedToVisualTree 2
(2 3)
VisualTreeAttachmentEventArgs3 P
eQ R
)R S
{ 
base 
. "
OnAttachedToVisualTree #
(# $
e$ %
)% &
;& '
SetupEventHandlers 
( 
) 
; 
} 
	protected   
override   
void   $
OnDetachedFromVisualTree   4
(  4 5)
VisualTreeAttachmentEventArgs  5 R
e  S T
)  T U
{!! 
base"" 
."" $
OnDetachedFromVisualTree"" %
(""% &
e""& '
)""' (
;""( )!
TeardownEventHandlers## 
(## 
)## 
;##  
}$$ 
private&& 
void&& 
SetupEventHandlers&& #
(&&# $
)&&$ %
{'' 
if(( 

((( 
_handlersAttached(( 
)(( 
{)) 	
return** 
;** 
}++ 	
if-- 

(-- 
this-- 
.-- 
FindControl-- 
<-- 
SegmentedTextBox-- -
>--- .
(--. /
$str--/ A
)--A B
is--C E
{--F G
}--H I
segmentedTextBox--J Z
)--Z [
{.. 	
segmentedTextBox// 
.// 
KeyDown// $
+=//% '%
OnSegmentedTextBoxKeyDown//( A
;//A B
_handlersAttached00 
=00 
true00  $
;00$ %
}11 	
}22 
private44 
void44 !
TeardownEventHandlers44 &
(44& '
)44' (
{55 
if66 

(66 
!66 
_handlersAttached66 
)66 
{77 	
return88 
;88 
}99 	
if;; 

(;; 
this;; 
.;; 
FindControl;; 
<;; 
SegmentedTextBox;; -
>;;- .
(;;. /
$str;;/ A
);;A B
is;;C E
{;;F G
};;H I
segmentedTextBox;;J Z
);;Z [
{<< 	
segmentedTextBox== 
.== 
KeyDown== $
-===% '%
OnSegmentedTextBoxKeyDown==( A
;==A B
}>> 	
_handlersAttached@@ 
=@@ 
false@@ !
;@@! "
}AA 
privateCC 
voidCC %
OnSegmentedTextBoxKeyDownCC *
(CC* +
objectCC+ 1
?CC1 2
senderCC3 9
,CC9 :
KeyEventArgsCC; G
eCCH I
)CCI J
{DD 
ifEE 

(EE 
eEE 
.EE 
KeyEE 
!=EE 
KeyEE 
.EE 
EnterEE 
&&EE !
eEE" #
.EE# $
KeyEE$ '
!=EE( *
KeyEE+ .
.EE. /
ReturnEE/ 5
)EE5 6
{FF 	
returnGG 
;GG 
}HH 	
ifJJ 

(JJ 
DataContextJJ 
isJJ 
notJJ 
VerifyOtpViewModelJJ 1
vmJJ2 4
)JJ4 5
{KK 	
returnLL 
;LL 
}MM 	
vmOO 

.OO
 $
HandleEnterKeyPressAsyncOO #
(OO# $
)OO$ %
.OO% &
ContinueWithOO& 2
(OO2 3
taskPP 
=>PP 
{QQ 
ifRR 
(RR 
taskRR 
isRR 
{RR 
	IsFaultedRR '
:RR' (
trueRR) -
,RR- .
	ExceptionRR/ 8
:RR8 9
notRR: =
nullRR> B
}RRC D
)RRD E
{SS 
SerilogTT 
.TT 
LogTT 
.TT  
ErrorTT  %
(TT% &
taskTT& *
.TT* +
	ExceptionTT+ 4
,TT4 5
$strUU h
)UUh i
;UUi j
}VV 
}WW 
,WW 
TaskSchedulerXX 
.XX 
DefaultXX !
)XX! "
;XX" #
eYY 	
.YY	 

HandledYY
 
=YY 
trueYY 
;YY 
}ZZ 
}[[ Äj
¤/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/Registration/SecureKeyConfirmationView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Views0 5
.5 6
Registration6 B
;B C
public 
partial 
class %
SecureKeyConfirmationView .
:/ 0
ReactiveUserControl1 D
<D E&
SecureKeyVerifierViewModelE _
>_ `
{ 
private 
bool 
_handlersAttached "
;" #
public 
%
SecureKeyConfirmationView $
($ %
)% &
{ 
InitializeComponent 
( 
) 
; 
} 
private 
void 
InitializeComponent $
($ %
)% &
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
	protected 
override 
void "
OnAttachedToVisualTree 2
(2 3)
VisualTreeAttachmentEventArgs3 P
eQ R
)R S
{ 
base 
. "
OnAttachedToVisualTree #
(# $
e$ %
)% &
;& '
SetupEventHandlers 
( 
) 
; 
} 
	protected!! 
override!! 
void!! $
OnDetachedFromVisualTree!! 4
(!!4 5)
VisualTreeAttachmentEventArgs!!5 R
e!!S T
)!!T U
{"" 
base## 
.## $
OnDetachedFromVisualTree## %
(##% &
e##& '
)##' (
;##( )!
TeardownEventHandlers$$ 
($$ 
)$$ 
;$$  
}%% 
private'' 
void'' 
SetupEventHandlers'' #
(''# $
)''$ %
{(( 
if)) 

()) 
_handlersAttached)) 
))) 
{** 	
return++ 
;++ 
},, 	
if.. 

(.. 
this.. 
... 
FindControl.. 
<.. 
HintedTextBox.. *
>..* +
(..+ ,
$str.., >
)..> ?
is..@ B
{..C D
}..E F
secureKeyBox..G S
)..S T
{// 	
secureKeyBox00 
.00 $
SecureKeyCharactersAdded00 1
+=002 4&
OnSecureKeyCharactersAdded005 O
;00O P
secureKeyBox11 
.11 &
SecureKeyCharactersRemoved11 3
+=114 6(
OnSecureKeyCharactersRemoved117 S
;11S T
secureKeyBox22 
.22 
KeyDown22  
+=22! #%
OnSecureKeyTextBoxKeyDown22$ =
;22= >
secureKeyBox33 
.33 
CharacterRejected33 *
+=33+ -
OnCharacterRejected33. A
;33A B
}44 	
if66 

(66 
this66 
.66 
FindControl66 
<66 
HintedTextBox66 *
>66* +
(66+ ,
$str66, D
)66D E
is66F H
{66I J
}66K L
verifySecureKeyBox66M _
)66_ `
{77 	
verifySecureKeyBox88 
.88 $
SecureKeyCharactersAdded88 7
+=888 :,
 OnVerifySecureKeyCharactersAdded88; [
;88[ \
verifySecureKeyBox99 
.99 &
SecureKeyCharactersRemoved99 9
+=99: <.
"OnVerifySecureKeyCharactersRemoved99= _
;99_ `
verifySecureKeyBox:: 
.:: 
KeyDown:: &
+=::' )%
OnSecureKeyTextBoxKeyDown::* C
;::C D
verifySecureKeyBox;; 
.;; 
CharacterRejected;; 0
+=;;1 3
OnCharacterRejected;;4 G
;;;G H
}<< 	
_handlersAttached>> 
=>> 
true>>  
;>>  !
}?? 
privateAA 
voidAA !
TeardownEventHandlersAA &
(AA& '
)AA' (
{BB 
ifCC 

(CC 
!CC 
_handlersAttachedCC 
)CC 
{DD 	
returnEE 
;EE 
}FF 	
ifHH 

(HH 
thisHH 
.HH 
FindControlHH 
<HH 
HintedTextBoxHH *
>HH* +
(HH+ ,
$strHH, >
)HH> ?
isHH@ B
HintedTextBoxHHC P
secureKeyBoxHHQ ]
)HH] ^
{II 	
secureKeyBoxJJ 
.JJ $
SecureKeyCharactersAddedJJ 1
-=JJ2 4&
OnSecureKeyCharactersAddedJJ5 O
;JJO P
secureKeyBoxKK 
.KK &
SecureKeyCharactersRemovedKK 3
-=KK4 6(
OnSecureKeyCharactersRemovedKK7 S
;KKS T
secureKeyBoxLL 
.LL 
KeyDownLL  
-=LL! #%
OnSecureKeyTextBoxKeyDownLL$ =
;LL= >
secureKeyBoxMM 
.MM 
CharacterRejectedMM *
-=MM+ -
OnCharacterRejectedMM. A
;MMA B
}NN 	
ifPP 

(PP 
thisPP 
.PP 
FindControlPP 
<PP 
HintedTextBoxPP *
>PP* +
(PP+ ,
$strPP, D
)PPD E
isPPF H
HintedTextBoxPPI V
verifySecureKeyBoxPPW i
)PPi j
{QQ 	
verifySecureKeyBoxRR 
.RR $
SecureKeyCharactersAddedRR 7
-=RR8 :,
 OnVerifySecureKeyCharactersAddedRR; [
;RR[ \
verifySecureKeyBoxSS 
.SS &
SecureKeyCharactersRemovedSS 9
-=SS: <.
"OnVerifySecureKeyCharactersRemovedSS= _
;SS_ `
verifySecureKeyBoxTT 
.TT 
KeyDownTT &
-=TT' )%
OnSecureKeyTextBoxKeyDownTT* C
;TTC D
verifySecureKeyBoxUU 
.UU 
CharacterRejectedUU 0
-=UU1 3
OnCharacterRejectedUU4 G
;UUG H
}VV 	
_handlersAttachedXX 
=XX 
falseXX !
;XX! "
}YY 
private[[ 
void[[ &
OnSecureKeyCharactersAdded[[ +
([[+ ,
object[[, 2
?[[2 3
sender[[4 :
,[[: ;-
!SecureKeyCharactersAddedEventArgs[[< ]
e[[^ _
)[[_ `
{\\ 
if]] 

(]] 
DataContext]] 
is]] 
not]] &
SecureKeyVerifierViewModel]] 9
vm]]: <
||]]= ?
sender]]@ F
is]]G I
not]]J M
HintedTextBox]]N [
tb]]\ ^
)]]^ _
{^^ 	
return__ 
;__ 
}`` 	
vmbb 

.bb
  
InsertSecureKeyCharsbb 
(bb  
ebb  !
.bb! "
Indexbb" '
,bb' (
ebb) *
.bb* +

Charactersbb+ 5
)bb5 6
;bb6 7
tbcc 

.cc
 
SyncSecureKeyStatecc 
(cc 
vmcc  
.cc  !"
CurrentSecureKeyLengthcc! 7
)cc7 8
;cc8 9
}dd 
privateff 
voidff (
OnSecureKeyCharactersRemovedff -
(ff- .
objectff. 4
?ff4 5
senderff6 <
,ff< =/
#SecureKeyCharactersRemovedEventArgsff> a
effb c
)ffc d
{gg 
ifhh 

(hh 
DataContexthh 
ishh 
nothh &
SecureKeyVerifierViewModelhh 9
vmhh: <
||hh= ?
senderhh@ F
ishhG I
nothhJ M
HintedTextBoxhhN [
tbhh\ ^
)hh^ _
{ii 	
returnjj 
;jj 
}kk 	
vmmm 

.mm
  
RemoveSecureKeyCharsmm 
(mm  
emm  !
.mm! "
Indexmm" '
,mm' (
emm) *
.mm* +
Countmm+ 0
)mm0 1
;mm1 2
tbnn 

.nn
 
SyncSecureKeyStatenn 
(nn 
vmnn  
.nn  !"
CurrentSecureKeyLengthnn! 7
)nn7 8
;nn8 9
}oo 
privateqq 
voidqq ,
 OnVerifySecureKeyCharactersAddedqq 1
(qq1 2
objectqq2 8
?qq8 9
senderqq: @
,qq@ A-
!SecureKeyCharactersAddedEventArgsqqB c
eqqd e
)qqe f
{rr 
ifss 

(ss 
DataContextss 
isss 
notss &
SecureKeyVerifierViewModelss 9
vmss: <
||ss= ?
senderss@ F
isssG I
notssJ M
HintedTextBoxssN [
tbss\ ^
)ss^ _
{tt 	
returnuu 
;uu 
}vv 	
vmxx 

.xx
 &
InsertVerifySecureKeyCharsxx %
(xx% &
exx& '
.xx' (
Indexxx( -
,xx- .
exx/ 0
.xx0 1

Charactersxx1 ;
)xx; <
;xx< =
tbyy 

.yy
 
SyncSecureKeyStateyy 
(yy 
vmyy  
.yy  !(
CurrentVerifySecureKeyLengthyy! =
)yy= >
;yy> ?
}zz 
private|| 
void|| .
"OnVerifySecureKeyCharactersRemoved|| 3
(||3 4
object||4 :
?||: ;
sender||< B
,||B C/
#SecureKeyCharactersRemovedEventArgs||D g
e||h i
)||i j
{}} 
if~~ 

(~~ 
DataContext~~ 
is~~ 
not~~ &
SecureKeyVerifierViewModel~~ 9
vm~~: <
||~~= ?
sender~~@ F
is~~G I
not~~J M
HintedTextBox~~N [
tb~~\ ^
)~~^ _
{ 	
return
€€ 
;
€€ 
}
 	
vm
ƒƒ 

.
ƒƒ
 (
RemoveVerifySecureKeyChars
ƒƒ %
(
ƒƒ% &
e
ƒƒ& '
.
ƒƒ' (
Index
ƒƒ( -
,
ƒƒ- .
e
ƒƒ/ 0
.
ƒƒ0 1
Count
ƒƒ1 6
)
ƒƒ6 7
;
ƒƒ7 8
tb
„„ 

.
„„
  
SyncSecureKeyState
„„ 
(
„„ 
vm
„„  
.
„„  !*
CurrentVerifySecureKeyLength
„„! =
)
„„= >
;
„„> ?
}
…… 
private
‡‡ 
void
‡‡ '
OnSecureKeyTextBoxKeyDown
‡‡ *
(
‡‡* +
object
‡‡+ 1
?
‡‡1 2
sender
‡‡3 9
,
‡‡9 :
KeyEventArgs
‡‡; G
e
‡‡H I
)
‡‡I J
{
ˆˆ 
if
‰‰ 

(
‰‰ 
e
‰‰ 
.
‰‰ 
Key
‰‰ 
!=
‰‰ 
Key
‰‰ 
.
‰‰ 
Enter
‰‰ 
&&
‰‰ !
e
‰‰" #
.
‰‰# $
Key
‰‰$ '
!=
‰‰( *
Key
‰‰+ .
.
‰‰. /
Return
‰‰/ 5
)
‰‰5 6
{
ŠŠ 	
return
‹‹ 
;
‹‹ 
}
ŒŒ 	
if
ŽŽ 

(
ŽŽ 
DataContext
ŽŽ 
is
ŽŽ 
not
ŽŽ (
SecureKeyVerifierViewModel
ŽŽ 9
vm
ŽŽ: <
)
ŽŽ< =
{
 	
return
 
;
 
}
‘‘ 	
vm
““ 

.
““
 &
HandleEnterKeyPressAsync
““ #
(
““# $
)
““$ %
.
““% &
ContinueWith
““& 2
(
““2 3
task
”” 
=>
”” 
{
•• 
if
–– 
(
–– 
task
–– 
is
–– 
{
–– 
	IsFaulted
–– '
:
––' (
true
––) -
,
––- .
	Exception
––/ 8
:
––8 9
not
––: =
null
––> B
}
––C D
)
––D E
{
—— 
Serilog
˜˜ 
.
˜˜ 
Log
˜˜ 
.
˜˜  
Error
˜˜  %
(
˜˜% &
task
˜˜& *
.
˜˜* +
	Exception
˜˜+ 4
,
˜˜4 5
$str
™™ h
)
™™h i
;
™™i j
}
šš 
}
›› 
,
›› 
TaskScheduler
œœ 
.
œœ 
Default
œœ !
)
œœ! "
;
œœ" #
e
 	
.
	 

Handled

 
=
 
true
 
;
 
}
žž 
private
   
void
   !
OnCharacterRejected
   $
(
  $ %
object
  % +
?
  + ,
sender
  - 3
,
  3 4(
CharacterRejectedEventArgs
  5 O
e
  P Q
)
  Q R
{
¡¡ 
if
¢¢ 

(
¢¢ 
DataContext
¢¢ 
is
¢¢ 
not
¢¢ (
SecureKeyVerifierViewModel
¢¢ 9
vm
¢¢: <
||
¢¢= ?
sender
¢¢@ F
is
¢¢G I
not
¢¢J M
HintedTextBox
¢¢N [
tb
¢¢\ ^
)
¢¢^ _
{
££ 	
return
¤¤ 
;
¤¤ 
}
¥¥ 	
string
§§ 
localizedMessage
§§ 
=
§§  !
vm
§§" $
.
§§$ %(
GetLocalizedWarningMessage
§§% ?
(
§§? @
e
§§@ A
.
§§A B
WarningType
§§B M
)
§§M N
;
§§N O
tb
¨¨ 

.
¨¨
 
WarningText
¨¨ 
=
¨¨ 
localizedMessage
¨¨ )
;
¨¨) *
tb
©© 

.
©©
 

HasWarning
©© 
=
©© 
true
©© 
;
©© 
}
ªª 
}«« «
˜/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/Registration/PassPhaseView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Views0 5
.5 6
Registration6 B
;B C
public 
partial 
class 
PassPhaseView "
:# $
ReactiveUserControl% 8
<8 9
PassPhaseViewModel9 K
>K L
{ 
public		 

PassPhaseView		 
(		 
)		 
{

 
InitializeComponent 
( 
) 
; 
} 
private 
void 
InitializeComponent $
($ %
)% &
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
} ê+
¡/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/Registration/MobileVerificationView.axaml.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
.

 
Features

  
.

  !
Authentication

! /
.

/ 0
Views

0 5
.

5 6
Registration

6 B
;

B C
public 
partial 
class "
MobileVerificationView +
:, -
ReactiveUserControl. A
<A B'
MobileVerificationViewModelB ]
>] ^
{ 
private 
const 
string (
MOBILE_TEXT_BOX_CONTROL_NAME 5
=6 7
$str8 G
;G H
private 
bool 
_handlersAttached "
;" #
public 
"
MobileVerificationView !
(! "
)" #
{ 
InitializeComponent 
( 
) 
; 
} 
private 
void 
InitializeComponent $
($ %
)% &
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
	protected 
override 
void "
OnAttachedToVisualTree 2
(2 3)
VisualTreeAttachmentEventArgs3 P
eQ R
)R S
{ 
base 
. "
OnAttachedToVisualTree #
(# $
e$ %
)% &
;& '
SetupEventHandlers 
( 
) 
; 
} 
	protected!! 
override!! 
void!! $
OnDetachedFromVisualTree!! 4
(!!4 5)
VisualTreeAttachmentEventArgs!!5 R
e!!S T
)!!T U
{"" 
base## 
.## $
OnDetachedFromVisualTree## %
(##% &
e##& '
)##' (
;##( )!
TeardownEventHandlers$$ 
($$ 
)$$ 
;$$  
}%% 
private'' 
void'' 
SetupEventHandlers'' #
(''# $
)''$ %
{(( 
if)) 

()) 
_handlersAttached)) 
))) 
{** 	
return++ 
;++ 
},, 	
if.. 

(.. 
this.. 
... 
FindControl.. 
<.. 
HintedTextBox.. *
>..* +
(..+ ,(
MOBILE_TEXT_BOX_CONTROL_NAME.., H
)..H I
is..J L
{..M N
}..O P
mobileTextBox..Q ^
)..^ _
{// 	
mobileTextBox00 
.00 
KeyDown00 !
+=00" $"
OnMobileTextBoxKeyDown00% ;
;00; <
_handlersAttached11 
=11 
true11  $
;11$ %
}22 	
}33 
private55 
void55 !
TeardownEventHandlers55 &
(55& '
)55' (
{66 
if77 

(77 
!77 
_handlersAttached77 
)77 
{88 	
return99 
;99 
}:: 	
if<< 

(<< 
this<< 
.<< 
FindControl<< 
<<< 
HintedTextBox<< *
><<* +
(<<+ ,(
MOBILE_TEXT_BOX_CONTROL_NAME<<, H
)<<H I
is<<J L
{<<M N
}<<O P
mobileTextBox<<Q ^
)<<^ _
{== 	
mobileTextBox>> 
.>> 
KeyDown>> !
-=>>" $"
OnMobileTextBoxKeyDown>>% ;
;>>; <
}?? 	
_handlersAttachedAA 
=AA 
falseAA !
;AA! "
}BB 
privateDD 
voidDD "
OnMobileTextBoxKeyDownDD '
(DD' (
objectDD( .
?DD. /
senderDD0 6
,DD6 7
KeyEventArgsDD8 D
eDDE F
)DDF G
{EE 
ifFF 

(FF 
eFF 
.FF 
KeyFF 
!=FF 
KeyFF 
.FF 
EnterFF 
&&FF !
eFF" #
.FF# $
KeyFF$ '
!=FF( *
KeyFF+ .
.FF. /
ReturnFF/ 5
)FF5 6
{GG 	
returnHH 
;HH 
}II 	
ifKK 

(KK 
DataContextKK 
isKK 
notKK '
MobileVerificationViewModelKK :
vmKK; =
)KK= >
{LL 	
returnMM 
;MM 
}NN 	
vmPP 

.PP
 $
HandleEnterKeyPressAsyncPP #
(PP# $
)PP$ %
.PP% &
ContinueWithPP& 2
(PP2 3
taskQQ 
=>QQ 
{RR 
ifSS 
(SS 
taskSS 
isSS 
{SS 
	IsFaultedSS '
:SS' (
trueSS) -
,SS- .
	ExceptionSS/ 8
:SS8 9
notSS: =
nullSS> B
}SSC D
)SSD E
{TT 
SerilogUU 
.UU 
LogUU 
.UU  
ErrorUU  %
(UU% &
taskUU& *
.UU* +
	ExceptionUU+ 4
,UU4 5
$str	UU6 ‚
)
UU‚ ƒ
;
UUƒ „
}VV 
}WW 
,WW 
TaskSchedulerXX 
.XX 
DefaultXX !
)XX! "
;XX" #
eYY 	
.YY	 

HandledYY
 
=YY 
trueYY 
;YY 
}ZZ 
}[[ ß
–/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Views/Hosts/AuthenticationView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Views0 5
.5 6
Hosts6 ;
;; <
public 
partial 
class 
AuthenticationView '
:( )
ReactiveUserControl* =
<= >#
AuthenticationViewModel> U
>U V
{ 
public		 

AuthenticationView		 
(		 
)		 
{

 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
} ›=
•/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/Welcome/WelcomeViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0

ViewModels0 :
.: ;
Welcome; B
;B C
public 
sealed 
class 
WelcomeViewModel $
:% &
Core' +
.+ ,
MVVM, 0
.0 1
ViewModelBase1 >
,> ?
IRoutableViewModel@ R
,R S
IResettableT _
{ 
private 
const 
string 
CREATE_ACCOUNT_KEY +
=, -
$str. =
;= >
private 
const 
string 
SIGN_IN_KEY $
=% &
$str' /
;/ 0
private 
static 
readonly 
FrozenDictionary ,
<, -
string- 3
,3 4
MembershipViewType5 G
>G H
NavigationCacheI X
=Y Z
new 

Dictionary 
< 
string 
, 
MembershipViewType 1
>1 2
{ 	
[ 
CREATE_ACCOUNT_KEY 
]  
=! "
MembershipViewType# 5
.5 6$
MOBILE_VERIFICATION_VIEW6 N
,N O
[ 
SIGN_IN_KEY 
] 
= 
MembershipViewType .
.. /
SIGN_IN_VIEW/ ;
} 	
.	 

ToFrozenDictionary
 
( 
) 
; 
private 
readonly 
CompositeDisposable (
_disposables) 5
=6 7
new8 ;
(; <
)< =
;= >
private 
bool 
_isDisposed 
; 
public 

WelcomeViewModel 
( 
IScreen #

hostScreen$ .
,. / 
ILocalizationService0 D
localizationServiceE X
,X Y
NetworkProviderZ i
networkProviderj y
)y z
: 	
base
 
( 
networkProvider 
, 
localizationService  3
)3 4
{   

HostScreen!! 
=!! 

hostScreen!! 
;!!  %
NavToCreateAccountCommand## !
=##" #
ReactiveCommand##$ 3
.##3 4 
CreateFromObservable##4 H
(##H I
(##I J
)##J K
=>##L N
{$$ 	#
AuthenticationViewModel%% #

hostWindow%%$ .
=%%/ 0
(%%1 2#
AuthenticationViewModel%%2 I
)%%I J

HostScreen%%J T
;%%T U
(&& 
(&& #
AuthenticationViewModel&& %
)&&% &

HostScreen&&& 0
)&&0 1
.&&1 2
CurrentFlowContext&&2 D
=&&E F%
AuthenticationFlowContext&&G `
.&&` a
REGISTRATION&&a m
;&&m n
MembershipViewType'' 
viewType'' '
=''( )
NavigationCache''* 9
[''9 :
CREATE_ACCOUNT_KEY'': L
]''L M
;''M N
return(( 

hostWindow(( 
.(( 
Navigate(( &
.((& '
Execute((' .
(((. /
viewType((/ 7
)((7 8
;((8 9
})) 	
)))	 

;))
 
NavToSignInCommand++ 
=++ 
ReactiveCommand++ ,
.++, - 
CreateFromObservable++- A
(++A B
(++B C
)++C D
=>++E G
{,, 	#
AuthenticationViewModel-- #

hostWindow--$ .
=--/ 0
(--1 2#
AuthenticationViewModel--2 I
)--I J

HostScreen--J T
;--T U
(.. 
(.. #
AuthenticationViewModel.. %
)..% &

HostScreen..& 0
)..0 1
...1 2
CurrentFlowContext..2 D
=..E F%
AuthenticationFlowContext..G `
...` a
SECURE_KEY_RECOVERY..a t
;..t u
MembershipViewType// 
viewType// '
=//( )
NavigationCache//* 9
[//9 :
SIGN_IN_KEY//: E
]//E F
;//F G
return00 

hostWindow00 
.00 
Navigate00 &
.00& '
Execute00' .
(00. /
viewType00/ 7
)007 8
;008 9
}11 	
)11	 

;11
 %
NavToCreateAccountCommand33 !
.33! "
IsExecuting33" -
.33- .
ToPropertyEx33. :
(33: ;
this33; ?
,33? @
x33A B
=>33C E
x33F G
.33G H
IsCreateAccountBusy33H [
)33[ \
.33\ ]
DisposeWith33] h
(33h i
_disposables33i u
)33u v
;33v w
NavToSignInCommand44 
.44 
IsExecuting44 &
.44& '
ToPropertyEx44' 3
(443 4
this444 8
,448 9
x44: ;
=>44< >
x44? @
.44@ A
IsSignInBusy44A M
)44M N
.44N O
DisposeWith44O Z
(44Z [
_disposables44[ g
)44g h
;44h i
_disposables66 
.66 
Add66 
(66 %
NavToCreateAccountCommand66 2
)662 3
;663 4
_disposables77 
.77 
Add77 
(77 
NavToSignInCommand77 +
)77+ ,
;77, -
}88 
public:: 

string:: 
UrlPathSegment::  
=>::! #
$str::$ .
;::. /
public<< 

IScreen<< 

HostScreen<< 
{<< 
get<<  #
;<<# $
}<<% &
public>> 

ReactiveCommand>> 
<>> 
Unit>> 
,>>  
IRoutableViewModel>>! 3
>>>3 4%
NavToCreateAccountCommand>>5 N
{>>O P
get>>Q T
;>>T U
}>>V W
public@@ 

ReactiveCommand@@ 
<@@ 
Unit@@ 
,@@  
IRoutableViewModel@@! 3
>@@3 4
NavToSignInCommand@@5 G
{@@H I
get@@J M
;@@M N
}@@O P
[BB  
ObservableAsPropertyBB 
]BB 
publicCC 

boolCC 
IsCreateAccountBusyCC #
{CC$ %
getCC& )
;CC) *
}CC+ ,
[EE  
ObservableAsPropertyEE 
]EE 
publicFF 

boolFF 
IsSignInBusyFF 
{FF 
getFF "
;FF" #
}FF$ %
publicHH 

voidHH 

ResetStateHH 
(HH 
)HH 
{II 
}JJ 
	protectedLL 
overrideLL 
voidLL 
DisposeLL #
(LL# $
boolLL$ (
	disposingLL) 2
)LL2 3
{MM 
ifNN 

(NN 
_isDisposedNN 
)NN 
{OO 	
basePP 
.PP 
DisposePP 
(PP 
	disposingPP "
)PP" #
;PP# $
returnQQ 
;QQ 
}RR 	
ifTT 

(TT 
	disposingTT 
)TT 
{UU 	
_disposablesVV 
.VV 
DisposeVV  
(VV  !
)VV! "
;VV" #
}WW 	
_isDisposedYY 
=YY 
trueYY 
;YY 
baseZZ 
.ZZ 
DisposeZZ 
(ZZ 
	disposingZZ 
)ZZ 
;ZZ  
}[[ 
}\\ ¤í
“/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/SignIn/SignInViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0

ViewModels0 :
.: ;
SignIn; A
;A B
public 
sealed 
class 
SignInViewModel #
:$ %
Core& *
.* +
MVVM+ /
./ 0
ViewModelBase0 =
,= >
IRoutableViewModel? Q
,Q R
IResettableS ^
,^ _
IDisposable` k
{ 
private   
readonly   "
IAuthenticationService   +
_authService  , 8
;  8 9
private!! 
readonly!! 
SecureTextBuffer!! %
_secureKeyBuffer!!& 6
=!!7 8
new!!9 <
(!!< =
)!!= >
;!!> ?
private"" 
readonly"" 
CompositeDisposable"" (
_disposables"") 5
=""6 7
new""8 ;
(""; <
)""< =
;""= >
private## 
readonly## 
Subject## 
<## 
string## #
>### $
_signInErrorSubject##% 8
=##9 :
new##; >
(##> ?
)##? @
;##@ A
private$$ 
readonly$$ #
AuthenticationViewModel$$ ,
_hostWindowModel$$- =
;$$= >
private&& #
CancellationTokenSource&& #
?&&# $*
_signInCancellationTokenSource&&% C
;&&C D
private'' 
bool'' '
_hasMobileNumberBeenTouched'' ,
;'', -
private(( 
bool(( $
_hasSecureKeyBeenTouched(( )
;(() *
private)) 
bool)) 
_isDisposed)) 
;)) 
public++ 

SignInViewModel++ 
(++  
IConnectivityService,, 
connectivityService,, 0
,,,0 1
NetworkProvider-- 
networkProvider-- '
,--' ( 
ILocalizationService.. 
localizationService.. 0
,..0 1"
IAuthenticationService// 
authService// *
,//* +
IScreen00 

hostScreen00 
)00 
:00 
base00 "
(00" #
networkProvider00# 2
,002 3
localizationService004 G
,00G H
connectivityService00I \
)00\ ]
{11 

HostScreen22 
=22 

hostScreen22 
;22  
_authService33 
=33 
authService33 "
;33" #
_hostWindowModel44 
=44 
(44 #
AuthenticationViewModel44 3
)443 4

hostScreen444 >
;44> ?
IObservable66 
<66 
bool66 
>66  
isFormLogicallyValid66 .
=66/ 0
SetupValidation661 @
(66@ A
)66A B
;66B C
SetupCommands77 
(77  
isFormLogicallyValid77 *
)77* +
;77+ ,
SetupSubscriptions88 
(88 
)88 
;88 
}99 
public;; 

string;; 
UrlPathSegment;;  
=>;;! #
$str;;$ .
;;;. /
public== 

IScreen== 

HostScreen== 
{== 
get==  #
;==# $
}==% &
[?? 
Reactive?? 
]?? 
public?? 
string?? 
MobileNumber?? )
{??* +
get??, /
;??/ 0
set??1 4
;??4 5
}??6 7
=??8 9
string??: @
.??@ A
Empty??A F
;??F G
[AA  
ObservableAsPropertyAA 
]AA 
publicAA !
boolAA" &
IsBusyAA' -
{AA. /
getAA0 3
;AA3 4
}AA5 6
[CC 
ReactiveCC 
]CC 
publicCC 
stringCC 
?CC 
MobileNumberErrorCC /
{CC0 1
getCC2 5
;CC5 6
setCC7 :
;CC: ;
}CC< =
[EE 
ReactiveEE 
]EE 
publicEE 
boolEE  
HasMobileNumberErrorEE /
{EE0 1
getEE2 5
;EE5 6
setEE7 :
;EE: ;
}EE< =
[GG 
ReactiveGG 
]GG 
publicGG 
stringGG 
?GG 
SecureKeyErrorGG ,
{GG- .
getGG/ 2
;GG2 3
setGG4 7
;GG7 8
}GG9 :
[II 
ReactiveII 
]II 
publicII 
boolII 
HasSecureKeyErrorII ,
{II- .
getII/ 2
;II2 3
setII4 7
;II7 8
}II9 :
[KK 
ReactiveKK 
]KK 
publicKK 
stringKK 
?KK 
ServerErrorKK )
{KK* +
getKK, /
;KK/ 0
setKK1 4
;KK4 5
}KK6 7
[MM 
ReactiveMM 
]MM 
publicMM 
boolMM 
HasServerErrorMM )
{MM* +
getMM, /
;MM/ 0
setMM1 4
;MM4 5
}MM6 7
publicOO 

intOO "
CurrentSecureKeyLengthOO %
=>OO& (
_secureKeyBufferOO) 9
.OO9 :
LengthOO: @
;OO@ A
publicQQ 

ReactiveCommandQQ 
<QQ 
SystemUQQ "
,QQ" #
ResultQQ$ *
<QQ* +
UnitQQ+ /
,QQ/ 0!
AuthenticationFailureQQ1 F
>QQF G
>QQG H
?QQH I
SignInCommandQQJ W
{QQX Y
getQQZ ]
;QQ] ^
privateQQ_ f
setQQg j
;QQj k
}QQl m
publicSS 

ReactiveCommandSS 
<SS 
SystemUSS "
,SS" #
SystemUSS$ +
>SS+ ,
?SS, -"
AccountRecoveryCommandSS. D
{SSE F
getSSG J
;SSJ K
privateSSL S
setSST W
;SSW X
}SSY Z
publicUU 

voidUU  
InsertSecureKeyCharsUU $
(UU$ %
intUU% (
indexUU) .
,UU. /
stringUU0 6
charsUU7 <
)UU< =
{VV 
ifWW 

(WW 
!WW $
_hasSecureKeyBeenTouchedWW %
)WW% &
{XX 	$
_hasSecureKeyBeenTouchedYY $
=YY% &
trueYY' +
;YY+ ,
}ZZ 	
_secureKeyBuffer\\ 
.\\ 
Insert\\ 
(\\  
index\\  %
,\\% &
chars\\' ,
)\\, -
;\\- .
this]] 
.]]  
RaisePropertyChanged]] !
(]]! "
nameof]]" (
(]]( )"
CurrentSecureKeyLength]]) ?
)]]? @
)]]@ A
;]]A B
}^^ 
public`` 

void``  
RemoveSecureKeyChars`` $
(``$ %
int``% (
index``) .
,``. /
int``0 3
count``4 9
)``9 :
{aa 
ifbb 

(bb 
!bb $
_hasSecureKeyBeenTouchedbb %
)bb% &
{cc 	$
_hasSecureKeyBeenToucheddd $
=dd% &
truedd' +
;dd+ ,
}ee 	
_secureKeyBuffergg 
.gg 
Removegg 
(gg  
indexgg  %
,gg% &
countgg' ,
)gg, -
;gg- .
thishh 
.hh  
RaisePropertyChangedhh !
(hh! "
nameofhh" (
(hh( )"
CurrentSecureKeyLengthhh) ?
)hh? @
)hh@ A
;hhA B
}ii 
publickk 

asynckk 
Taskkk $
HandleEnterKeyPressAsynckk .
(kk. /
)kk/ 0
{ll 
trymm 
{nn 	
ifoo 
(oo 
awaitoo 
SignInCommandoo #
!oo# $
.oo$ %

CanExecuteoo% /
.oo/ 0
FirstOrDefaultAsyncoo0 C
(ooC D
)ooD E
)ooE F
{pp 
SignInCommandqq 
.qq 
Executeqq %
(qq% &
)qq& '
.qq' (
	Subscribeqq( 1
(qq1 2
)qq2 3
.qq3 4
DisposeWithqq4 ?
(qq? @
_disposablesqq@ L
)qqL M
;qqM N
}rr 
}ss 	
catchtt 
(tt 
	Exceptiontt 
extt 
)tt 
{uu 	
Logvv 
.vv 
Errorvv 
(vv 
exvv 
,vv 
$strvv L
)vvL M
;vvM N
}ww 	
}xx 
publiczz 

voidzz 

ResetStatezz 
(zz 
)zz 
{{{ 
if|| 

(|| 
_isDisposed|| 
)|| 
{}} 	
return~~ 
;~~ 
} 	)
_hasMobileNumberBeenTouched
 #
=
$ %
false
& +
;
+ ,&
_hasSecureKeyBeenTouched
‚‚  
=
‚‚! "
false
‚‚# (
;
‚‚( )
MobileNumber
„„ 
=
„„ 
string
„„ 
.
„„ 
Empty
„„ #
;
„„# $
_secureKeyBuffer
…… 
.
…… 
Remove
…… 
(
……  
$num
……  !
,
……! "
_secureKeyBuffer
……# 3
.
……3 4
Length
……4 :
)
……: ;
;
……; <#
CancelSignInOperation
‡‡ 
(
‡‡ 
)
‡‡ 
;
‡‡  !
_signInErrorSubject
ˆˆ 
.
ˆˆ 
OnNext
ˆˆ "
(
ˆˆ" #
string
ˆˆ# )
.
ˆˆ) *
Empty
ˆˆ* /
)
ˆˆ/ 0
;
ˆˆ0 1
MobileNumberError
ŠŠ 
=
ŠŠ 
string
ŠŠ "
.
ŠŠ" #
Empty
ŠŠ# (
;
ŠŠ( )"
HasMobileNumberError
‹‹ 
=
‹‹ 
false
‹‹ $
;
‹‹$ %
SecureKeyError
ŒŒ 
=
ŒŒ 
string
ŒŒ 
.
ŒŒ  
Empty
ŒŒ  %
;
ŒŒ% &
HasSecureKeyError
 
=
 
false
 !
;
! "
ServerError
ŽŽ 
=
ŽŽ 
string
ŽŽ 
.
ŽŽ 
Empty
ŽŽ "
;
ŽŽ" #
HasServerError
 
=
 
false
 
;
 
}
 
public
’’ 

new
’’ 
void
’’ 
Dispose
’’ 
(
’’ 
)
’’ 
=>
’’  
Dispose
’’! (
(
’’( )
true
’’) -
)
’’- .
;
’’. /
	protected
”” 
override
”” 
void
”” 
Dispose
”” #
(
””# $
bool
””$ (
	disposing
””) 2
)
””2 3
{
•• 
if
–– 

(
–– 
_isDisposed
–– 
)
–– 
{
—— 	
return
˜˜ 
;
˜˜ 
}
™™ 	
if
›› 

(
›› 
	disposing
›› 
)
›› 
{
œœ 	#
CancelSignInOperation
 !
(
! "
)
" #
;
# $
SignInCommand
ŸŸ 
?
ŸŸ 
.
ŸŸ 
Dispose
ŸŸ "
(
ŸŸ" #
)
ŸŸ# $
;
ŸŸ$ %$
AccountRecoveryCommand
   "
?
  " #
.
  # $
Dispose
  $ +
(
  + ,
)
  , -
;
  - .
_secureKeyBuffer
¢¢ 
.
¢¢ 
Dispose
¢¢ $
(
¢¢$ %
)
¢¢% &
;
¢¢& '!
_signInErrorSubject
££ 
.
££  
Dispose
££  '
(
££' (
)
££( )
;
££) *
_disposables
¤¤ 
.
¤¤ 
Dispose
¤¤  
(
¤¤  !
)
¤¤! "
;
¤¤" #
MobileNumber
¦¦ 
=
¦¦ 
string
¦¦ !
.
¦¦! "
Empty
¦¦" '
;
¦¦' ()
_hasMobileNumberBeenTouched
§§ '
=
§§( )
false
§§* /
;
§§/ 0&
_hasSecureKeyBeenTouched
¨¨ $
=
¨¨% &
false
¨¨' ,
;
¨¨, -
}
©© 	
base
«« 
.
«« 
Dispose
«« 
(
«« 
	disposing
«« 
)
«« 
;
««  
_isDisposed
¬¬ 
=
¬¬ 
true
¬¬ 
;
¬¬ 
}
­­ 
private
¯¯ 
IObservable
¯¯ 
<
¯¯ 
bool
¯¯ 
>
¯¯ 
SetupValidation
¯¯ -
(
¯¯- .
)
¯¯. /
{
°° 
IObservable
±± 
<
±± 
SystemU
±± 
>
±± 
languageTrigger
±± ,
=
±±- .
LanguageChanged
±±/ >
;
±±> ?
IObservable
³³ 
<
³³ 
SystemU
³³ 
>
³³ 
mobileTrigger
³³ *
=
³³+ ,
this
³³- 1
.
´´ 
WhenAnyValue
´´ 
(
´´ 
x
´´ 
=>
´´ 
x
´´  
.
´´  !
MobileNumber
´´! -
)
´´- .
.
µµ 
Select
µµ 
(
µµ 
_
µµ 
=>
µµ 
SystemU
µµ  
.
µµ  !
Default
µµ! (
)
µµ( )
;
µµ) *
IObservable
·· 
<
·· 
SystemU
·· 
>
·· 
secureKeyTrigger
·· -
=
··. /
this
··0 4
.
¸¸ 
WhenAnyValue
¸¸ 
(
¸¸ 
x
¸¸ 
=>
¸¸ 
x
¸¸  
.
¸¸  !$
CurrentSecureKeyLength
¸¸! 7
)
¸¸7 8
.
¹¹ 
Select
¹¹ 
(
¹¹ 
_
¹¹ 
=>
¹¹ 
SystemU
¹¹  
.
¹¹  !
Default
¹¹! (
)
¹¹( )
;
¹¹) *
IObservable
»» 
<
»» 
SystemU
»» 
>
»» 
validationTrigger
»» .
=
»»/ 0
mobileTrigger
¼¼ 
.
½½ 
Merge
½½ 
(
½½ 
secureKeyTrigger
½½ '
)
½½' (
.
¾¾ 
Merge
¾¾ 
(
¾¾ 
languageTrigger
¾¾ &
)
¾¾& '
;
¾¾' (
IObservable
ÀÀ 
<
ÀÀ 
string
ÀÀ 
>
ÀÀ 
mobileValidation
ÀÀ ,
=
ÀÀ- .
validationTrigger
ÀÀ/ @
.
ÁÁ 
Select
ÁÁ 
(
ÁÁ 
_
ÁÁ 
=>
ÁÁ #
MobileNumberValidator
ÁÁ .
.
ÁÁ. /
Validate
ÁÁ/ 7
(
ÁÁ7 8
MobileNumber
ÁÁ8 D
,
ÁÁD E!
LocalizationService
ÁÁF Y
)
ÁÁY Z
)
ÁÁZ [
.
ÂÂ 
Replay
ÂÂ 
(
ÂÂ 
$num
ÂÂ 
)
ÂÂ 
.
ÃÃ 
RefCount
ÃÃ 
(
ÃÃ 
)
ÃÃ 
;
ÃÃ 
IObservable
ÅÅ 
<
ÅÅ 
string
ÅÅ 
>
ÅÅ 
mobileErrorStream
ÅÅ -
=
ÅÅ. /
this
ÅÅ0 4
.
ÅÅ4 5
WhenAnyValue
ÅÅ5 A
(
ÅÅA B
x
ÅÅB C
=>
ÅÅD F
x
ÅÅG H
.
ÅÅH I
MobileNumber
ÅÅI U
)
ÅÅU V
.
ÆÆ 
CombineLatest
ÆÆ 
(
ÆÆ 
mobileValidation
ÆÆ +
,
ÆÆ+ ,
(
ÆÆ- .
mobile
ÆÆ. 4
,
ÆÆ4 5
error
ÆÆ6 ;
)
ÆÆ; <
=>
ÆÆ= ?
{
ÇÇ 
if
ÈÈ 
(
ÈÈ 
!
ÈÈ )
_hasMobileNumberBeenTouched
ÈÈ 0
&&
ÈÈ1 3
!
ÈÈ4 5
string
ÈÈ5 ;
.
ÈÈ; < 
IsNullOrWhiteSpace
ÈÈ< N
(
ÈÈN O
mobile
ÈÈO U
)
ÈÈU V
)
ÈÈV W
{
ÉÉ )
_hasMobileNumberBeenTouched
ÊÊ /
=
ÊÊ0 1
true
ÊÊ2 6
;
ÊÊ6 7
}
ËË 
return
ÍÍ 
!
ÍÍ )
_hasMobileNumberBeenTouched
ÍÍ 3
?
ÍÍ4 5
string
ÍÍ6 <
.
ÍÍ< =
Empty
ÍÍ= B
:
ÍÍC D
error
ÍÍE J
;
ÍÍJ K
}
ÎÎ 
)
ÎÎ 
.
ÏÏ 
Replay
ÏÏ 
(
ÏÏ 
$num
ÏÏ 
)
ÏÏ 
.
ÐÐ 
RefCount
ÐÐ 
(
ÐÐ 
)
ÐÐ 
;
ÐÐ 
mobileErrorStream
ÒÒ 
.
ÓÓ "
DistinctUntilChanged
ÓÓ !
(
ÓÓ! "
)
ÓÓ" #
.
ÔÔ 
	Subscribe
ÔÔ 
(
ÔÔ 
error
ÔÔ 
=>
ÔÔ 
MobileNumberError
ÔÔ  1
=
ÔÔ2 3
error
ÔÔ4 9
)
ÔÔ9 :
.
ÕÕ 
DisposeWith
ÕÕ 
(
ÕÕ 
_disposables
ÕÕ %
)
ÕÕ% &
;
ÕÕ& '
this
×× 
.
×× 
WhenAnyValue
×× 
(
×× 
x
×× 
=>
×× 
x
××  
.
××  !
MobileNumberError
××! 2
)
××2 3
.
ØØ 
Select
ØØ 
(
ØØ 
e
ØØ 
=>
ØØ 
!
ØØ 
string
ØØ  
.
ØØ  !
IsNullOrEmpty
ØØ! .
(
ØØ. /
e
ØØ/ 0
)
ØØ0 1
)
ØØ1 2
.
ÙÙ 
	Subscribe
ÙÙ 
(
ÙÙ 
flag
ÙÙ 
=>
ÙÙ "
HasMobileNumberError
ÙÙ 3
=
ÙÙ4 5
flag
ÙÙ6 :
)
ÙÙ: ;
.
ÚÚ 
DisposeWith
ÚÚ 
(
ÚÚ 
_disposables
ÚÚ %
)
ÚÚ% &
;
ÚÚ& '
IObservable
ÜÜ 
<
ÜÜ 
string
ÜÜ 
>
ÜÜ !
secureKeyValidation
ÜÜ /
=
ÜÜ0 1
validationTrigger
ÜÜ2 C
.
ÝÝ 
Select
ÝÝ 
(
ÝÝ 
_
ÝÝ 
=>
ÝÝ 
ValidateSecureKey
ÝÝ *
(
ÝÝ* +
)
ÝÝ+ ,
)
ÝÝ, -
.
ÞÞ 
Replay
ÞÞ 
(
ÞÞ 
$num
ÞÞ 
)
ÞÞ 
.
ßß 
RefCount
ßß 
(
ßß 
)
ßß 
;
ßß 
IObservable
áá 
<
áá 
string
áá 
>
áá #
keyDisplayErrorStream
áá 1
=
áá2 3!
secureKeyValidation
áá4 G
.
ââ 
Select
ââ 
(
ââ 
error
ââ 
=>
ââ &
_hasSecureKeyBeenTouched
ââ 5
?
ââ6 7
error
ââ8 =
:
ââ> ?
string
ââ@ F
.
ââF G
Empty
ââG L
)
ââL M
.
ãã 
Replay
ãã 
(
ãã 
$num
ãã 
)
ãã 
.
ää 
RefCount
ää 
(
ää 
)
ää 
;
ää #
keyDisplayErrorStream
ææ 
.
çç "
DistinctUntilChanged
çç !
(
çç! "
)
çç" #
.
èè 
	Subscribe
èè 
(
èè 
error
èè 
=>
èè 
SecureKeyError
èè  .
=
èè/ 0
error
èè1 6
)
èè6 7
.
éé 
DisposeWith
éé 
(
éé 
_disposables
éé %
)
éé% &
;
éé& '
this
ëë 
.
ëë 
WhenAnyValue
ëë 
(
ëë 
x
ëë 
=>
ëë 
x
ëë  
.
ëë  !
SecureKeyError
ëë! /
)
ëë/ 0
.
ìì 
Select
ìì 
(
ìì 
e
ìì 
=>
ìì 
!
ìì 
string
ìì  
.
ìì  !
IsNullOrEmpty
ìì! .
(
ìì. /
e
ìì/ 0
)
ìì0 1
)
ìì1 2
.
íí 
	Subscribe
íí 
(
íí 
flag
íí 
=>
íí 
HasSecureKeyError
íí 0
=
íí1 2
flag
íí3 7
)
íí7 8
.
îî 
DisposeWith
îî 
(
îî 
_disposables
îî %
)
îî% &
;
îî& '!
_signInErrorSubject
ðð 
.
ññ "
DistinctUntilChanged
ññ !
(
ññ! "
)
ññ" #
.
òò 
	Subscribe
òò 
(
òò 
err
òò 
=>
òò 
ServerError
òò )
=
òò* +
err
òò, /
)
òò/ 0
.
óó 
DisposeWith
óó 
(
óó 
_disposables
óó %
)
óó% &
;
óó& '
this
õõ 
.
õõ 
WhenAnyValue
õõ 
(
õõ 
x
õõ 
=>
õõ 
x
õõ  
.
õõ  !
ServerError
õõ! ,
)
õõ, -
.
öö 
Select
öö 
(
öö 
e
öö 
=>
öö 
!
öö 
string
öö  
.
öö  !
IsNullOrEmpty
öö! .
(
öö. /
e
öö/ 0
)
öö0 1
)
öö1 2
.
÷÷ 
	Subscribe
÷÷ 
(
÷÷ 
flag
÷÷ 
=>
÷÷ 
HasServerError
÷÷ -
=
÷÷. /
flag
÷÷0 4
)
÷÷4 5
.
øø 
DisposeWith
øø 
(
øø 
_disposables
øø %
)
øø% &
;
øø& '
IObservable
úú 
<
úú 
bool
úú 
>
úú $
isMobileLogicallyValid
úú 0
=
úú1 2
mobileValidation
úú3 C
.
ûû 
Select
ûû 
(
ûû 
string
ûû 
.
ûû 
IsNullOrEmpty
ûû (
)
ûû( )
;
ûû) *
IObservable
ýý 
<
ýý 
bool
ýý 
>
ýý !
isKeyLogicallyValid
ýý -
=
ýý. /!
secureKeyValidation
ýý0 C
.
þþ 
Select
þþ 
(
þþ 
string
þþ 
.
þþ 
IsNullOrEmpty
þþ (
)
þþ( )
;
þþ) *
IObservable
€€ 
<
€€ 
bool
€€ 
>
€€ "
isFormLogicallyValid
€€ .
=
€€/ 0$
isMobileLogicallyValid
€€1 G
.
 
CombineLatest
 
(
 !
isKeyLogicallyValid
 .
,
. /
(
0 1
isMobileValid
1 >
,
> ?

isKeyValid
@ J
)
J K
=>
L N
isMobileValid
O \
&&
] _

isKeyValid
` j
)
j k
.
‚‚ "
DistinctUntilChanged
‚‚ !
(
‚‚! "
)
‚‚" #
;
‚‚# $
return
„„ "
isFormLogicallyValid
„„ #
;
„„# $
}
…… 
private
‡‡ 
void
‡‡ 
SetupCommands
‡‡ 
(
‡‡ 
IObservable
‡‡ *
<
‡‡* +
bool
‡‡+ /
>
‡‡/ 0"
isFormLogicallyValid
‡‡1 E
)
‡‡E F
{
ˆˆ 
IObservable
‰‰ 
<
‰‰ 
bool
‰‰ 
>
‰‰ 
	canSignIn
‰‰ #
=
‰‰$ %
this
‰‰& *
.
‰‰* +
WhenAnyValue
‰‰+ 7
(
‰‰7 8
x
‰‰8 9
=>
‰‰: <
x
‰‰= >
.
‰‰> ?
IsBusy
‰‰? E
,
‰‰E F
x
‰‰G H
=>
‰‰I K
x
‰‰L M
.
‰‰M N
IsInNetworkOutage
‰‰N _
,
‰‰_ `
(
ŠŠ 
isBusy
ŠŠ 
,
ŠŠ 

isInOutage
ŠŠ #
)
ŠŠ# $
=>
ŠŠ% '
!
ŠŠ( )
isBusy
ŠŠ) /
&&
ŠŠ0 2
!
ŠŠ3 4

isInOutage
ŠŠ4 >
)
ŠŠ> ?
.
‹‹ 
CombineLatest
‹‹ 
(
‹‹ "
isFormLogicallyValid
‹‹ /
,
‹‹/ 0
(
‹‹1 2

canExecute
‹‹2 <
,
‹‹< =
isValid
‹‹> E
)
‹‹E F
=>
‹‹G I

canExecute
‹‹J T
&&
‹‹U W
isValid
‹‹X _
)
‹‹_ `
;
‹‹` a
SignInCommand
 
=
 
ReactiveCommand
 '
.
' (
CreateFromTask
( 6
(
6 7
async
ŽŽ 
(
ŽŽ 
)
ŽŽ 
=>
ŽŽ 
{
 %
CancellationTokenSource
 '
cts
( +
=
, -'
RecreateCancellationToken
. G
(
G H
ref
H K,
_signInCancellationTokenSource
L j
)
j k
;
k l
uint
’’ 
	connectId
’’ 
=
’’  
ComputeConnectId
’’! 1
(
’’1 2 
PubKeyExchangeType
’’2 D
.
’’D E(
DataCenterEphemeralConnect
’’E _
)
’’_ `
;
’’` a
CancellationToken
““ !
cancellationToken
““" 3
=
““4 5
cts
““6 9
.
““9 :
Token
““: ?
;
““? @
Result
”” 
<
”” 
Unit
”” 
,
”” #
AuthenticationFailure
”” 2
>
””2 3
result
””4 :
=
””; <
await
•• 
_authService
•• &
.
••& '
SignInAsync
••' 2
(
••2 3
MobileNumber
••3 ?
,
••? @
_secureKeyBuffer
••A Q
,
••Q R
	connectId
••S \
,
••\ ]
cancellationToken
••^ o
)
••o p
;
••p q
return
–– 
result
–– 
;
–– 
}
—— 
,
—— 
	canSignIn
˜˜ 
)
˜˜ 
;
˜˜ 
SignInCommand
šš 
.
šš 
IsExecuting
šš !
.
šš! "
ToPropertyEx
šš" .
(
šš. /
this
šš/ 3
,
šš3 4
x
šš5 6
=>
šš7 9
x
šš: ;
.
šš; <
IsBusy
šš< B
)
ššB C
;
ššC D$
AccountRecoveryCommand
œœ 
=
œœ  
ReactiveCommand
œœ! 0
.
œœ0 1
Create
œœ1 7
(
œœ7 8
(
œœ8 9
)
œœ9 :
=>
œœ; =
{
 	
(
žž 
(
žž %
AuthenticationViewModel
žž %
)
žž% &

HostScreen
žž& 0
)
žž0 1
.
žž1 2(
StartSecureKeyRecoveryFlow
žž2 L
(
žžL M
)
žžM N
;
žžN O
}
ŸŸ 	
)
ŸŸ	 

;
ŸŸ
 
}
   
private
¢¢ 
void
¢¢  
SetupSubscriptions
¢¢ #
(
¢¢# $
)
¢¢$ %
{
££ 
SignInCommand
¤¤ 
?
¤¤ 
.
¥¥ 
Where
¥¥ 
(
¥¥ 
result
¥¥ 
=>
¥¥ 
result
¥¥ #
.
¥¥# $
IsErr
¥¥$ )
)
¥¥) *
.
¦¦ 
Select
¦¦ 
(
¦¦ 
result
¦¦ 
=>
¦¦ 
result
¦¦ $
.
¦¦$ %
	UnwrapErr
¦¦% .
(
¦¦. /
)
¦¦/ 0
)
¦¦0 1
.
§§ 
	Subscribe
§§ 
(
§§ 
error
§§ 
=>
§§ 
{
¨¨ &
_hasSecureKeyBeenTouched
©© (
=
©©) *
true
©©+ /
;
©©/ 0!
_signInErrorSubject
ªª #
.
ªª# $
OnNext
ªª$ *
(
ªª* +
error
ªª+ 0
.
ªª0 1
Message
ªª1 8
)
ªª8 9
;
ªª9 :
if
«« 
(
«« 

HostScreen
«« 
is
«« !%
AuthenticationViewModel
««" 9

hostWindow
««: D
)
««D E
{
¬¬ )
ShowServerErrorNotification
­­ /
(
­­/ 0

hostWindow
­­0 :
,
­­: ;
error
­­< A
.
­­A B
Message
­­B I
)
­­I J
;
­­J K
}
®® 
}
¯¯ 
)
¯¯ 
.
°° 
DisposeWith
°° 
(
°° 
_disposables
°° %
)
°°% &
;
°°& '
SignInCommand
²² 
?
²² 
.
³³ 
Where
³³ 
(
³³ 
result
³³ 
=>
³³ 
result
³³ #
.
³³# $
IsOk
³³$ (
)
³³( )
.
´´ 
	Subscribe
´´ 
(
´´ 
_
´´ 
=>
´´ 
{
µµ !
_signInErrorSubject
¶¶ #
.
¶¶# $
OnNext
¶¶$ *
(
¶¶* +
string
¶¶+ 1
.
¶¶1 2
Empty
¶¶2 7
)
¶¶7 8
;
¶¶8 9
_hostWindowModel
¸¸  
.
¸¸  !'
SwitchToMainWindowCommand
¸¸! :
.
¸¸: ;
Execute
¸¸; B
(
¸¸B C
)
¸¸C D
.
¸¸D E
	Subscribe
¸¸E N
(
¸¸N O
_
¹¹ 
=>
¹¹ 
{
¹¹ 
}
¹¹ 
,
¹¹ 
ex
ºº 
=>
ºº 
{
ºº 
Log
ºº 
.
ºº  
Error
ºº  %
(
ºº% &
ex
ºº& (
,
ºº( )
$str
ºº* O
)
ººO P
;
ººP Q
}
ººR S
)
»» 
;
»» 
}
¼¼ 
)
¼¼ 
.
½½ 
DisposeWith
½½ 
(
½½ 
_disposables
½½ %
)
½½% &
;
½½& '
}
¾¾ 
private
ÀÀ 
string
ÀÀ 
ValidateSecureKey
ÀÀ $
(
ÀÀ$ %
)
ÀÀ% &
=>
ÀÀ' )
_secureKeyBuffer
ÁÁ 
.
ÁÁ 
Length
ÁÁ 
==
ÁÁ  "
$num
ÁÁ# $
?
ÂÂ !
LocalizationService
ÂÂ !
[
ÂÂ! ")
SecureKeyValidatorConstants
ÂÂ" =
.
ÂÂ= >
LocalizationKeys
ÂÂ> N
.
ÂÂN O
REQUIRED
ÂÂO W
]
ÂÂW X
:
ÃÃ 
string
ÃÃ 
.
ÃÃ 
Empty
ÃÃ 
;
ÃÃ 
private
ÅÅ 
void
ÅÅ #
CancelSignInOperation
ÅÅ &
(
ÅÅ& '
)
ÅÅ' (
{
ÆÆ %
CancellationTokenSource
ÇÇ 
?
ÇÇ   
cancellationSource
ÇÇ! 3
=
ÇÇ4 5
Interlocked
ÇÇ6 A
.
ÇÇA B
Exchange
ÇÇB J
(
ÇÇJ K
ref
ÈÈ ,
_signInCancellationTokenSource
ÈÈ .
,
ÈÈ. /
null
ÉÉ 
)
ÉÉ 
;
ÉÉ 
if
ËË 

(
ËË  
cancellationSource
ËË 
!=
ËË !
null
ËË" &
)
ËË& '
{
ÌÌ 	
try
ÍÍ 
{
ÎÎ  
cancellationSource
ÏÏ "
.
ÏÏ" #
Cancel
ÏÏ# )
(
ÏÏ) *
)
ÏÏ* +
;
ÏÏ+ ,
}
ÐÐ 
catch
ÑÑ 
(
ÑÑ %
ObjectDisposedException
ÑÑ *
)
ÑÑ* +
{
ÒÒ 
}
ÔÔ 
finally
ÕÕ 
{
ÖÖ  
cancellationSource
×× "
.
××" #
Dispose
××# *
(
××* +
)
××+ ,
;
××, -
}
ØØ 
}
ÙÙ 	
}
ÚÚ 
}ÛÛ ¼‡
œ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/Registration/VerifyOtpViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0

ViewModels0 :
.: ;
Registration; G
;G H
public 
sealed 
class 
VerifyOtpViewModel &
:' (
Core) -
.- .
MVVM. 2
.2 3
ViewModelBase3 @
,@ A
IRoutableViewModelB T
,T U
IResettableV a
{ 
private   
readonly   

ByteString   #
_mobileNumberIdentifier    7
;  7 8
private!! 
readonly!! -
!IApplicationSecureStorageProvider!! 6-
!_applicationSecureStorageProvider!!7 X
;!!X Y
private"" 
readonly"" &
IOpaqueRegistrationService"" / 
_registrationService""0 D
;""D E
private## 
readonly## %
ISecureKeyRecoveryService## .
?##. /%
_secureKeyRecoveryService##0 I
;##I J
private$$ 
readonly$$  
ILocalizationService$$ ) 
_localizationService$$* >
;$$> ?
private%% 
readonly%% %
AuthenticationFlowContext%% .
_flowContext%%/ ;
;%%; <
private&& 
readonly&& 
Lock&& 
_sessionLock&& &
=&&' (
new&&) ,
(&&, -
)&&- .
;&&. /
private'' 
readonly'' 
CompositeDisposable'' (
_disposables'') 5
=''6 7
new''8 ;
(''; <
)''< =
;''= >
private)) 
Guid)) *
_verificationSessionIdentifier)) /
=))0 1
Guid))2 6
.))6 7
Empty))7 <
;))< =
private** 
IDisposable** 
?** 
_autoRedirectTimer** +
;**+ ,
private++ 
IDisposable++ 
?++ 
_cooldownTimer++ '
;++' (
private,, #
CancellationTokenSource,, #
?,,# $$
_cancellationTokenSource,,% =
;,,= >
private-- 
volatile-- 
bool-- 
_isDisposed-- %
;--% &
public// 

VerifyOtpViewModel// 
(//  
IConnectivityService00 
connectivityService00 0
,000 1
NetworkProvider11 
networkProvider11 '
,11' ( 
ILocalizationService22 
localizationService22 0
,220 1
IScreen33 

hostScreen33 
,33 

ByteString44 "
mobileNumberIdentifier44 )
,44) *-
!IApplicationSecureStorageProvider55 ),
 applicationSecureStorageProvider55* J
,55J K&
IOpaqueRegistrationService66 "
registrationService66# 6
,666 7%
AuthenticationFlowContext77 !
flowContext77" -
=77. /%
AuthenticationFlowContext770 I
.77I J
REGISTRATION77J V
,77V W%
ISecureKeyRecoveryService88 !
?88! "$
secureKeyRecoveryService88# ;
=88< =
null88> B
)88B C
:88D E
base88F J
(88J K
networkProvider88K Z
,88Z [
localizationService99 
,99 
connectivityService99 0
)990 1
{:: #
_mobileNumberIdentifier;; 
=;;  !"
mobileNumberIdentifier;;" 8
;;;8 9-
!_applicationSecureStorageProvider<< )
=<<* +,
 applicationSecureStorageProvider<<, L
;<<L M 
_registrationService== 
=== 
registrationService== 2
;==2 3%
_secureKeyRecoveryService>> !
=>>" #$
secureKeyRecoveryService>>$ <
;>>< =
_flowContext?? 
=?? 
flowContext?? "
;??" # 
_localizationService@@ 
=@@ 
localizationService@@ 2
;@@2 3
ifBB 

(BB 
flowContextBB 
==BB %
AuthenticationFlowContextBB 4
.BB4 5
SECURE_KEY_RECOVERYBB5 H
&&BBI K$
secureKeyRecoveryServiceBBL d
==BBe g
nullBBh l
)BBl m
{CC 	
throwDD 
newDD !
ArgumentNullExceptionDD +
(DD+ ,
nameofDD, 2
(DD2 3$
secureKeyRecoveryServiceDD3 K
)DDK L
,DDL M
$strEE `
)EE` a
;EEa b
}FF 	
LogHH 
.HH 
InformationHH 
(HH 
$strHH U
,HHU V
flowContextHHW b
)HHb c
;HHc d

HostScreenJJ 
=JJ 

hostScreenJJ 
;JJ  &
NavToSecureKeyConfirmationLL "
=LL# $
ReactiveCommandLL% 4
.LL4 5 
CreateFromObservableLL5 I
(LLI J
(LLJ K
)LLK L
=>LLM O
{MM 	#
AuthenticationViewModelNN #

hostWindowNN$ .
=NN/ 0
(NN1 2#
AuthenticationViewModelNN2 I
)NNI J

HostScreenNNJ T
;NNT U
returnOO 

hostWindowOO 
.OO 
NavigateOO &
.OO& '
ExecuteOO' .
(OO. /
MembershipViewTypeOO/ A
.OOA B(
SECURE_KEY_CONFIRMATION_VIEWOOB ^
)OO^ _
;OO_ `
}PP 	
)PP	 

;PP
 
IObservableRR 
<RR 
boolRR 
>RR 
	canVerifyRR #
=RR$ %
thisRR& *
.RR* +
WhenAnyValueRR+ 7
(RR7 8
xSS 
=>SS 
xSS 
.SS 
VerificationCodeSS #
,SS# $
xTT 
=>TT 
xTT 
.TT 
RemainingTimeTT  
,TT  !
xUU 
=>UU 
xUU 
.UU 
IsInNetworkOutageUU $
,UU$ %
(VV 
codeVV 
,VV 
timeVV 
,VV 

isInOutageVV #
)VV# $
=>VV% '
codeVV( ,
.VV, -
LengthVV- 3
==VV4 6
$numVV7 8
&&VV9 ;
codeVV< @
.VV@ A
AllVVA D
(VVD E
charVVE I
.VVI J
IsDigitVVJ Q
)VVQ R
&&VVS U
timeWW( ,
!=WW- /#
AuthenticationConstantsWW0 G
.WWG H"
EXPIRED_REMAINING_TIMEWWH ^
&&WW_ a
!WWb c

isInOutageWWc m
)XX 	
;XX	 
'
SendVerificationCodeCommandYY #
=YY$ %
ReactiveCommandYY& 5
.YY5 6
CreateFromTaskYY6 D
(YYD E 
SendVerificationCodeYYE Y
,YYY Z
	canVerifyYY[ d
)YYd e
;YYe f'
SendVerificationCodeCommand[[ #
.[[# $
ThrownExceptions[[$ 4
.\\ 
	Subscribe\\ 
(\\ 
ex\\ 
=>\\ 
{]] 
Log^^ 
.^^ 
Error^^ 
(^^ 
ex^^ 
,^^ 
$str^^ e
)^^e f
;^^f g
if__ 
(__ 
_isDisposed__ 
)__  
{`` 
returnaa 
;aa 
}bb 
ErrorMessagedd 
=dd 
exdd !
.dd! "
Messagedd" )
;dd) *
HasErroree 
=ee 
trueee 
;ee  
}ff 
)ff 
.gg 
DisposeWithgg 
(gg 
_disposablesgg %
)gg% &
;gg& '
IObservableii 
<ii 
boolii 
>ii 
	canResendii #
=ii$ %
thisii& *
.ii* +
WhenAnyValueii+ 7
(ii7 8
xjj 
=>jj 
xjj 
.jj 
SecondsRemainingjj '
,jj' (
xkk 
=>kk 
xkk 
.kk 
HasValidSessionkk &
,kk& '
xll 
=>ll 
xll 
.ll 
CurrentStatusll $
,ll$ %
xmm 
=>mm 
xmm 
.mm !
CooldownBufferSecondsmm ,
,mm, -
xnn 
=>nn 
xnn 
.nn 
IsInNetworkOutagenn (
)nn( )
.oo 
Selectoo 
(oo 
tupleoo 
=>oo !
CanResendVerificationoo 2
(oo2 3
tupleoo3 8
.oo8 9
Item1oo9 >
,oo> ?
tupleoo@ E
.ooE F
Item2ooF K
,ooK L
tupleooM R
.ooR S
Item3ooS X
,ooX Y
tupleooZ _
.oo_ `
Item4oo` e
,ooe f
tupleoog l
.ool m
Item5oom r
)oor s
)oos t
.pp  
DistinctUntilChangedpp !
(pp! "
)pp" #
.qq 
Catchqq 
<qq 
boolqq 
,qq 
	Exceptionqq "
>qq" #
(qq# $
_qq$ %
=>qq& (

Observableqq) 3
.qq3 4
Returnqq4 :
(qq: ;
falseqq; @
)qq@ A
)qqA B
;qqB C-
!ResendSendVerificationCodeCommandrr )
=rr* +
ReactiveCommandrr, ;
.rr; <
CreateFromTaskrr< J
(rrJ K"
ReSendVerificationCoderrK a
,rra b
	canResendrrc l
)rrl m
;rrm n-
!ResendSendVerificationCodeCommandtt )
.tt) *
ThrownExceptionstt* :
.uu 
	Subscribeuu 
(uu 
exuu 
=>uu 
{vv 
Logww 
.ww 
Errorww 
(ww 
exww 
,ww 
$strww e
)wwe f
;wwf g
ifxx 
(xx 
!xx 
_isDisposedxx  
)xx  !
{yy 
ErrorMessagezz  
=zz! "
exzz# %
.zz% &
Messagezz& -
;zz- .
HasError{{ 
={{ 
true{{ #
;{{# $
}|| 
}}} 
)}} 
.~~ 
DisposeWith~~ 
(~~ 
_disposables~~ %
)~~% &
;~~& ')
SendVerificationCodeCommand
€€ #
.
€€# $
IsExecuting
€€$ /
.
 
ToPropertyEx
 
(
 
this
 
,
 
x
  !
=>
" $
x
% &
.
& '
IsBusy
' -
)
- .
.
‚‚ 
DisposeWith
‚‚ 
(
‚‚ 
_disposables
‚‚ %
)
‚‚% &
;
‚‚& '/
!ResendSendVerificationCodeCommand
„„ )
.
„„) *
IsExecuting
„„* 5
.
…… 
ToPropertyEx
…… 
(
…… 
this
…… 
,
…… 
x
……  !
=>
……" $
x
……% &
.
……& '
IsResending
……' 2
)
……2 3
.
†† 
DisposeWith
†† 
(
†† 
_disposables
†† %
)
††% &
;
††& '
this
ˆˆ 
.
ˆˆ 
WhenActivated
ˆˆ 
(
ˆˆ 
disposables
ˆˆ &
=>
ˆˆ' )
{
‰‰ 	
OnViewLoaded
ŠŠ 
(
ŠŠ 
)
ŠŠ 
.
ŠŠ 
	Subscribe
ŠŠ $
(
ŠŠ$ %
)
ŠŠ% &
.
ŠŠ& '
DisposeWith
ŠŠ' 2
(
ŠŠ2 3
disposables
ŠŠ3 >
)
ŠŠ> ?
.
ŠŠ? @
DisposeWith
ŠŠ@ K
(
ŠŠK L
_disposables
ŠŠL X
)
ŠŠX Y
;
ŠŠY Z
this
ŒŒ 
.
ŒŒ 
WhenAnyValue
ŒŒ 
(
ŒŒ 
x
ŒŒ 
=>
ŒŒ  "
x
ŒŒ# $
.
ŒŒ$ %
ErrorMessage
ŒŒ% 1
)
ŒŒ1 2
.
 "
DistinctUntilChanged
 %
(
% &
)
& '
.
ŽŽ 
	Subscribe
ŽŽ 
(
ŽŽ 
err
ŽŽ 
=>
 
{
 
HasError
‘‘ 
=
‘‘ 
!
‘‘  
string
‘‘  &
.
‘‘& '
IsNullOrEmpty
‘‘' 4
(
‘‘4 5
err
‘‘5 8
)
‘‘8 9
;
‘‘9 :
if
’’ 
(
’’ 
!
’’ 
string
’’ 
.
’’  
IsNullOrEmpty
’’  -
(
’’- .
err
’’. 1
)
’’1 2
&&
’’3 5

HostScreen
’’6 @
is
’’A C%
AuthenticationViewModel
’’D [

hostWindow
’’\ f
)
’’f g
{
““ )
ShowServerErrorNotification
”” 3
(
””3 4

hostWindow
””4 >
,
””> ?
err
””@ C
)
””C D
;
””D E
}
•• 
}
–– 
)
–– 
.
—— 
DisposeWith
—— 
(
—— 
disposables
—— (
)
——( )
.
——) *
DisposeWith
——* 5
(
——5 6
_disposables
——6 B
)
——B C
;
——C D
this
™™ 
.
™™ 
WhenAnyValue
™™ 
(
™™ 
x
™™ 
=>
™™  "
x
™™# $
.
™™$ %
SecondsRemaining
™™% 5
)
™™5 6
.
šš 
Select
šš 
(
šš !
FormatRemainingTime
šš +
)
šš+ ,
.
›› 
	Subscribe
›› 
(
›› 
rt
›› 
=>
››  
RemainingTime
››! .
=
››/ 0
rt
››1 3
)
››3 4
.
œœ 
DisposeWith
œœ 
(
œœ 
disposables
œœ (
)
œœ( )
.
œœ) *
DisposeWith
œœ* 5
(
œœ5 6
_disposables
œœ6 B
)
œœB C
;
œœC D
}
 	
)
	 

;

 
}
žž 
public
   

string
   
?
   
UrlPathSegment
   !
{
  " #
get
  $ '
;
  ' (
}
  ) *
=
  + ,
$str
  - G
;
  G H
public
¢¢ 

IScreen
¢¢ 

HostScreen
¢¢ 
{
¢¢ 
get
¢¢  #
;
¢¢# $
}
¢¢% &
public
¤¤ 

new
¤¤  
ViewModelActivator
¤¤ !
	Activator
¤¤" +
{
¤¤, -
get
¤¤. 1
;
¤¤1 2
}
¤¤3 4
=
¤¤5 6
new
¤¤7 :
(
¤¤: ;
)
¤¤; <
;
¤¤< =
public
¦¦ 

ReactiveCommand
¦¦ 
<
¦¦ 
Unit
¦¦ 
,
¦¦  
Unit
¦¦! %
>
¦¦% &)
SendVerificationCodeCommand
¦¦' B
{
¦¦C D
get
¦¦E H
;
¦¦H I
}
¦¦J K
public
¨¨ 

ReactiveCommand
¨¨ 
<
¨¨ 
Unit
¨¨ 
,
¨¨  
Unit
¨¨! %
>
¨¨% &/
!ResendSendVerificationCodeCommand
¨¨' H
{
¨¨I J
get
¨¨K N
;
¨¨N O
}
¨¨P Q
public
ªª 

ReactiveCommand
ªª 
<
ªª 
Unit
ªª 
,
ªª   
IRoutableViewModel
ªª! 3
>
ªª3 4(
NavToSecureKeyConfirmation
ªª5 O
{
ªªP Q
get
ªªR U
;
ªªU V
}
ªªW X
[
¬¬ 
Reactive
¬¬ 
]
¬¬ 
public
¬¬ 
string
¬¬ 
VerificationCode
¬¬ -
{
¬¬. /
get
¬¬0 3
;
¬¬3 4
set
¬¬5 8
;
¬¬8 9
}
¬¬: ;
=
¬¬< =
string
¬¬> D
.
¬¬D E
Empty
¬¬E J
;
¬¬J K
[
®® 
Reactive
®® 
]
®® 
public
®® 
string
®® 
ErrorMessage
®® )
{
®®* +
get
®®, /
;
®®/ 0
private
®®1 8
set
®®9 <
;
®®< =
}
®®> ?
=
®®@ A
string
®®B H
.
®®H I
Empty
®®I N
;
®®N O
[
°° 
Reactive
°° 
]
°° 
public
°° 
string
°° 
RemainingTime
°° *
{
°°+ ,
get
°°- 0
;
°°0 1
private
°°2 9
set
°°: =
;
°°= >
}
°°? @
=
°°A B%
AuthenticationConstants
°°C Z
.
°°Z [$
INITIAL_REMAINING_TIME
°°[ q
;
°°q r
[
²² 
Reactive
²² 
]
²² 
private
²² 
uint
²² 
SecondsRemaining
²² ,
{
²²- .
get
²²/ 2
;
²²2 3
set
²²4 7
;
²²7 8
}
²²9 :
[
´´ 
Reactive
´´ 
]
´´ 
public
´´ 
bool
´´ 
HasError
´´ #
{
´´$ %
get
´´& )
;
´´) *
private
´´+ 2
set
´´3 6
;
´´6 7
}
´´8 9
[
¶¶ 
Reactive
¶¶ 
]
¶¶ 
private
¶¶ 
uint
¶¶ #
CooldownBufferSeconds
¶¶ 1
{
¶¶2 3
get
¶¶4 7
;
¶¶7 8
set
¶¶9 <
;
¶¶< =
}
¶¶> ?
[
¸¸ 
Reactive
¸¸ 
]
¸¸ 
private
¹¹ )
VerificationCountdownUpdate
¹¹ '
.
¹¹' (
Types
¹¹( -
.
¹¹- .#
CountdownUpdateStatus
¹¹. C
CurrentStatus
¹¹D Q
{
¹¹R S
get
¹¹T W
;
¹¹W X
set
¹¹Y \
;
¹¹\ ]
}
¹¹^ _
=
¹¹` a)
VerificationCountdownUpdate
ºº #
.
ºº# $
Types
ºº$ )
.
ºº) *#
CountdownUpdateStatus
ºº* ?
.
ºº? @
Active
ºº@ F
;
ººF G
[
¼¼ 
Reactive
¼¼ 
]
¼¼ 
private
¼¼ 
bool
¼¼ "
IsMaxAttemptsReached
¼¼ 0
{
¼¼1 2
get
¼¼3 6
;
¼¼6 7
set
¼¼8 ;
;
¼¼; <
}
¼¼= >
[
¾¾ 
Reactive
¾¾ 
]
¾¾ 
private
¾¾ 
bool
¾¾ 
HasValidSession
¾¾ +
{
¾¾, -
get
¾¾. 1
;
¾¾1 2
set
¾¾3 6
;
¾¾6 7
}
¾¾8 9
[
ÀÀ "
ObservableAsProperty
ÀÀ 
]
ÀÀ 
public
ÀÀ !
bool
ÀÀ" &
IsBusy
ÀÀ' -
{
ÀÀ. /
get
ÀÀ0 3
;
ÀÀ3 4
}
ÀÀ5 6
[
ÂÂ "
ObservableAsProperty
ÂÂ 
]
ÂÂ 
public
ÂÂ !
bool
ÂÂ" &
IsResending
ÂÂ' 2
{
ÂÂ3 4
get
ÂÂ5 8
;
ÂÂ8 9
}
ÂÂ: ;
private
ÄÄ 
Guid
ÄÄ 
?
ÄÄ +
VerificationSessionIdentifier
ÄÄ /
{
ÅÅ 
get
ÆÆ 
{
ÇÇ 	
lock
ÈÈ 
(
ÈÈ 
_sessionLock
ÈÈ 
)
ÈÈ 
{
ÉÉ 
return
ÊÊ ,
_verificationSessionIdentifier
ÊÊ 5
==
ÊÊ6 8
Guid
ÊÊ9 =
.
ÊÊ= >
Empty
ÊÊ> C
?
ÊÊD E
null
ÊÊF J
:
ÊÊK L,
_verificationSessionIdentifier
ÊÊM k
;
ÊÊk l
}
ËË 
}
ÌÌ 	
}
ÍÍ 
public
ÏÏ 

async
ÏÏ 
Task
ÏÏ &
HandleEnterKeyPressAsync
ÏÏ .
(
ÏÏ. /
)
ÏÏ/ 0
{
ÐÐ 
if
ÑÑ 

(
ÑÑ 
_isDisposed
ÑÑ 
)
ÑÑ 
{
ÒÒ 	
return
ÓÓ 
;
ÓÓ 
}
ÔÔ 	
if
ÖÖ 

(
ÖÖ 
await
ÖÖ )
SendVerificationCodeCommand
ÖÖ -
.
ÖÖ- .

CanExecute
ÖÖ. 8
.
ÖÖ8 9!
FirstOrDefaultAsync
ÖÖ9 L
(
ÖÖL M
)
ÖÖM N
)
ÖÖN O
{
×× 	)
SendVerificationCodeCommand
ØØ '
.
ØØ' (
Execute
ØØ( /
(
ØØ/ 0
)
ØØ0 1
.
ØØ1 2
	Subscribe
ØØ2 ;
(
ØØ; <
)
ØØ< =
.
ØØ= >
DisposeWith
ØØ> I
(
ØØI J
_disposables
ØØJ V
)
ØØV W
;
ØØW X
}
ÙÙ 	
}
ÚÚ 
public
ÜÜ 

void
ÜÜ 

ResetState
ÜÜ 
(
ÜÜ 
)
ÜÜ 
{
ÝÝ 
if
ÞÞ 

(
ÞÞ 
_isDisposed
ÞÞ 
)
ÞÞ 
{
ßß 	
return
àà 
;
àà 
}
áá 	%
CancellationTokenSource
ãã 
?
ãã  %
cancellationTokenSource
ãã! 8
=
ãã9 :
Interlocked
ãã; F
.
ããF G
Exchange
ããG O
(
ããO P
ref
ããP S&
_cancellationTokenSource
ããT l
,
ããl m
null
ããn r
)
ããr s
;
ããs t%
cancellationTokenSource
ää 
?
ää  
.
ää  !
Cancel
ää! '
(
ää' (
)
ää( )
;
ää) *%
cancellationTokenSource
åå 
?
åå  
.
åå  !
Dispose
åå! (
(
åå( )
)
åå) *
;
åå* +
Task
çç 
.
çç 
Run
çç 
(
çç 
async
çç 
(
çç 
)
çç 
=>
çç 
{
èè 	
try
éé 
{
êê 
await
ëë 
ResetUiState
ëë "
(
ëë" #
)
ëë# $
;
ëë$ %
await
ìì !
CleanupSessionAsync
ìì )
(
ìì) *
)
ìì* +
;
ìì+ ,
}
íí 
catch
îî 
(
îî 
	Exception
îî 
ex
îî 
)
îî  
{
ïï 
Log
ðð 
.
ðð 
Error
ðð 
(
ðð 
ex
ðð 
,
ðð 
$str
ðð S
)
ððS T
;
ððT U
}
ññ 
}
òò 	
)
òò	 

.
òò
 
ContinueWith
òò 
(
òò 
task
óó 
=>
óó 
{
ôô 
if
õõ 
(
õõ 
task
õõ 
is
õõ 
{
õõ 
	IsFaulted
õõ '
:
õõ' (
true
õõ) -
,
õõ- .
	Exception
õõ/ 8
:
õõ8 9
not
õõ: =
null
õõ> B
}
õõC D
)
õõD E
{
öö 
Log
÷÷ 
.
÷÷ 
Error
÷÷ 
(
÷÷ 
task
÷÷ "
.
÷÷" #
	Exception
÷÷# ,
,
÷÷, -
$str
÷÷. k
)
÷÷k l
;
÷÷l m
}
øø 
}
ùù 
,
ùù 
TaskScheduler
úú 
.
úú 
Default
úú !
)
úú! "
;
úú" #
}
ûû 
	protected
ýý 
override
ýý 
void
ýý 
Dispose
ýý #
(
ýý# $
bool
ýý$ (
	disposing
ýý) 2
)
ýý2 3
{
þþ 
if
ÿÿ 

(
ÿÿ 
	disposing
ÿÿ 
&&
ÿÿ 
!
ÿÿ 
_isDisposed
ÿÿ %
)
ÿÿ% &
{
€€ 	
_isDisposed
 
=
 
true
 
;
 &
_cancellationTokenSource
‚‚ $
?
‚‚$ %
.
‚‚% &
Cancel
‚‚& ,
(
‚‚, -
)
‚‚- .
;
‚‚. /&
_cancellationTokenSource
ƒƒ $
?
ƒƒ$ %
.
ƒƒ% &
Dispose
ƒƒ& -
(
ƒƒ- .
)
ƒƒ. /
;
ƒƒ/ 0 
_autoRedirectTimer
„„ 
?
„„ 
.
„„  
Dispose
„„  '
(
„„' (
)
„„( )
;
„„) *
_cooldownTimer
…… 
?
…… 
.
…… 
Dispose
…… #
(
……# $
)
……$ %
;
……% &
_disposables
†† 
.
†† 
Dispose
††  
(
††  !
)
††! "
;
††" #
}
‡‡ 	
base
‰‰ 
.
‰‰ 
Dispose
‰‰ 
(
‰‰ 
	disposing
‰‰ 
)
‰‰ 
;
‰‰  
}
ŠŠ 
private
ŒŒ 
IObservable
ŒŒ 
<
ŒŒ 
Unit
ŒŒ 
>
ŒŒ 
OnViewLoaded
ŒŒ *
(
ŒŒ* +
)
ŒŒ+ ,
{
 
return
ŽŽ 

Observable
ŽŽ 
.
ŽŽ 
	FromAsync
ŽŽ #
(
ŽŽ# $
async
ŽŽ$ )
(
ŽŽ* +
)
ŽŽ+ ,
=>
ŽŽ- /
{
 	
if
 
(
 
_isDisposed
 
)
 
{
‘‘ 
return
’’ 
;
’’ 
}
““ %
CancellationTokenSource
•• #%
cancellationTokenSource
••$ ;
=
••< ='
RecreateCancellationToken
••> W
(
••W X
ref
••X [&
_cancellationTokenSource
••\ t
)
••t u
;
••u v
_disposables
–– 
.
–– 
Add
–– 
(
–– %
cancellationTokenSource
–– 4
)
––4 5
;
––5 6
Task
˜˜ 
<
˜˜ 
Result
˜˜ 
<
˜˜ 
Ecliptix
˜˜  
.
˜˜  !
	Utilities
˜˜! *
.
˜˜* +
Unit
˜˜+ /
,
˜˜/ 0
string
˜˜1 7
>
˜˜7 8
>
˜˜8 9
initiateTask
˜˜: F
=
˜˜G H 
CreateInitiateTask
˜˜I [
(
˜˜[ \
)
˜˜\ ]
;
˜˜] ^
Result
™™ 
<
™™ 
Ecliptix
™™ 
.
™™ 
	Utilities
™™ %
.
™™% &
Unit
™™& *
,
™™* +
string
™™, 2
>
™™2 3
result
™™4 :
=
™™; <
await
™™= B
initiateTask
™™C O
;
™™O P"
HandleInitiateResult
››  
(
››  !
result
››! '
)
››' (
;
››( )
}
œœ 	
)
œœ	 

;
œœ
 
}
 
private
ŸŸ 
Task
ŸŸ 
<
ŸŸ 
Result
ŸŸ 
<
ŸŸ 
Ecliptix
ŸŸ  
.
ŸŸ  !
	Utilities
ŸŸ! *
.
ŸŸ* +
Unit
ŸŸ+ /
,
ŸŸ/ 0
string
ŸŸ1 7
>
ŸŸ7 8
>
ŸŸ8 9 
CreateInitiateTask
ŸŸ: L
(
ŸŸL M
)
ŸŸM N
{
   
CancellationToken
¡¡ 
cancellationToken
¡¡ +
=
¡¡, -&
_cancellationTokenSource
¡¡. F
?
¡¡F G
.
¡¡G H
Token
¡¡H M
??
¡¡N P
CancellationToken
¡¡Q b
.
¡¡b c
None
¡¡c g
;
¡¡g h
Action
¢¢ 
<
¢¢ 
uint
¢¢ 
,
¢¢ 
Guid
¢¢ 
,
¢¢ )
VerificationCountdownUpdate
¢¢ 6
.
¢¢6 7
Types
¢¢7 <
.
¢¢< =#
CountdownUpdateStatus
¢¢= R
,
¢¢R S
string
¢¢T Z
?
¢¢Z [
>
¢¢[ \
callback
¢¢] e
=
¢¢f g%
CreateCountdownCallback
££ #
(
££# $
)
££$ %
;
££% &
return
¥¥ 
_flowContext
¥¥ 
==
¥¥ '
AuthenticationFlowContext
¥¥ 8
.
¥¥8 9
REGISTRATION
¥¥9 E
?
¦¦ "
_registrationService
¦¦ "
.
¦¦" #*
InitiateOtpVerificationAsync
¦¦# ?
(
¦¦? @%
_mobileNumberIdentifier
¦¦@ W
,
¦¦W X!
VerificationPurpose
§§ #
.
§§# $
Registration
§§$ 0
,
§§0 1
callback
§§2 :
,
§§: ;
cancellationToken
§§< M
)
§§M N
:
¨¨ '
_secureKeyRecoveryService
¨¨ '
!
¨¨' (
.
¨¨( ),
InitiateSecureKeyResetOtpAsync
¨¨) G
(
¨¨G H%
_mobileNumberIdentifier
¨¨H _
,
¨¨_ `
callback
¨¨a i
,
¨¨i j
cancellationToken
©© !
)
©©! "
;
©©" #
}
ªª 
private
¬¬ 
Action
¬¬ 
<
¬¬ 
uint
¬¬ 
,
¬¬ 
Guid
¬¬ 
,
¬¬ )
VerificationCountdownUpdate
¬¬ :
.
¬¬: ;
Types
¬¬; @
.
¬¬@ A#
CountdownUpdateStatus
¬¬A V
,
¬¬V W
string
¬¬X ^
?
¬¬^ _
>
¬¬_ `%
CreateCountdownCallback
­­ 
(
­­  
)
­­  !
{
®® 
return
¯¯ 
(
¯¯ 
seconds
¯¯ 
,
¯¯ 

identifier
¯¯ #
,
¯¯# $
status
¯¯% +
,
¯¯+ ,
message
¯¯- 4
)
¯¯4 5
=>
¯¯6 8
RxApp
°° 
.
°° !
MainThreadScheduler
°° %
.
°°% &
Schedule
°°& .
(
°°. /
(
°°/ 0
)
°°0 1
=>
°°2 4
{
±± 
if
²² 
(
²² 
_isDisposed
²² 
)
²²  
{
³³ 
return
´´ 
;
´´ 
}
µµ 
try
·· 
{
¸¸ #
HandleCountdownUpdate
¹¹ )
(
¹¹) *
seconds
¹¹* 1
,
¹¹1 2

identifier
¹¹3 =
,
¹¹= >
status
¹¹? E
,
¹¹E F
message
¹¹G N
)
¹¹N O
;
¹¹O P
}
ºº 
catch
»» 
(
»» %
ObjectDisposedException
»» .
)
»». /
{
¼¼ 
}
¾¾ 
}
¿¿ 
)
¿¿ 
;
¿¿ 
}
ÀÀ 
private
ÂÂ 
void
ÂÂ "
HandleInitiateResult
ÂÂ %
(
ÂÂ% &
Result
ÂÂ& ,
<
ÂÂ, -
Ecliptix
ÂÂ- 5
.
ÂÂ5 6
	Utilities
ÂÂ6 ?
.
ÂÂ? @
Unit
ÂÂ@ D
,
ÂÂD E
string
ÂÂF L
>
ÂÂL M
result
ÂÂN T
)
ÂÂT U
{
ÃÃ 
bool
ÄÄ 
shouldSetError
ÄÄ 
=
ÄÄ 
result
ÄÄ $
.
ÄÄ$ %
IsErr
ÄÄ% *
&&
ÅÅ  
!
ÅÅ! "
_isDisposed
ÅÅ" -
&&
ÆÆ  
CurrentStatus
ÆÆ! .
!=
ÆÆ/ 1)
VerificationCountdownUpdate
ÆÆ2 M
.
ÆÆM N
Types
ÆÆN S
.
ÆÆS T#
CountdownUpdateStatus
ÆÆT i
.
ÇÇ" #
ServerUnavailable
ÇÇ# 4
;
ÇÇ4 5
if
ÉÉ 

(
ÉÉ 
shouldSetError
ÉÉ 
)
ÉÉ 
{
ÊÊ 	
ErrorMessage
ËË 
=
ËË 
result
ËË !
.
ËË! "
	UnwrapErr
ËË" +
(
ËË+ ,
)
ËË, -
;
ËË- .
}
ÌÌ 	
}
ÍÍ 
private
ÏÏ 
async
ÏÏ 
Task
ÏÏ "
SendVerificationCode
ÏÏ +
(
ÏÏ+ ,
)
ÏÏ, -
{
ÐÐ 
if
ÑÑ 

(
ÑÑ 
_isDisposed
ÑÑ 
)
ÑÑ 
{
ÒÒ 	
return
ÓÓ 
;
ÓÓ 
}
ÔÔ 	
ErrorMessage
ÖÖ 
=
ÖÖ 
string
ÖÖ 
.
ÖÖ 
Empty
ÖÖ #
;
ÖÖ# $
if
ØØ 

(
ØØ 
!
ØØ 
HasValidSession
ØØ 
)
ØØ 
{
ÙÙ 	"
HandleNoValidSession
ÚÚ  
(
ÚÚ  !
)
ÚÚ! "
;
ÚÚ" #
return
ÛÛ 
;
ÛÛ 
}
ÜÜ 	
uint
ÞÞ 
	connectId
ÞÞ 
=
ÞÞ 
ComputeConnectId
ÞÞ )
(
ÞÞ) * 
PubKeyExchangeType
ÞÞ* <
.
ÞÞ< =(
DataCenterEphemeralConnect
ÞÞ= W
)
ÞÞW X
;
ÞÞX Y
CancellationToken
ßß 
operationToken
ßß (
=
ßß) *&
_cancellationTokenSource
ßß+ C
?
ßßC D
.
ßßD E
Token
ßßE J
??
ßßK M
CancellationToken
ßßN _
.
ßß_ `
None
ßß` d
;
ßßd e
Task
áá 
<
áá 
Result
áá 
<
áá 

Membership
áá 
,
áá 
string
áá  &
>
áá& '
>
áá' (

verifyTask
áá) 3
=
áá4 5
CreateVerifyTask
áá6 F
(
ááF G
	connectId
ááG P
,
ááP Q
operationToken
ááR `
)
áá` a
;
ááa b
Result
ââ 
<
ââ 

Membership
ââ 
,
ââ 
string
ââ !
>
ââ! "
result
ââ# )
=
ââ* +
await
ââ, 1

verifyTask
ââ2 <
;
ââ< =
if
ää 

(
ää 
_isDisposed
ää 
)
ää 
{
åå 	
return
ææ 
;
ææ 
}
çç 	
if
éé 

(
éé 
result
éé 
.
éé 
IsOk
éé 
)
éé 
{
êê 	
await
ëë *
HandleSuccessfulVerification
ëë .
(
ëë. /
result
ëë/ 5
.
ëë5 6
Unwrap
ëë6 <
(
ëë< =
)
ëë= >
,
ëë> ?
operationToken
ëë@ N
)
ëëN O
;
ëëO P
}
ìì 	
else
íí 
{
îî 	%
HandleVerificationError
ïï #
(
ïï# $
result
ïï$ *
.
ïï* +
	UnwrapErr
ïï+ 4
(
ïï4 5
)
ïï5 6
)
ïï6 7
;
ïï7 8
}
ðð 	
}
ññ 
private
óó 
void
óó "
HandleNoValidSession
óó %
(
óó% &
)
óó& '
{
ôô 
HasError
õõ 
=
õõ 
true
õõ 
;
õõ 
ErrorMessage
öö 
=
öö "
_localizationService
öö +
[
öö+ ,%
AuthenticationConstants
öö, C
.
ööC D)
NO_VERIFICATION_SESSION_KEY
ööD _
]
öö_ `
;
öö` a
}
÷÷ 
private
ùù 
Task
ùù 
<
ùù 
Result
ùù 
<
ùù 

Membership
ùù "
,
ùù" #
string
ùù$ *
>
ùù* +
>
ùù+ ,
CreateVerifyTask
ùù- =
(
ùù= >
uint
ùù> B
	connectId
ùùC L
,
ùùL M
CancellationToken
ùùN _
cancellationToken
ùù` q
)
ùùq r
{
úú 
return
ûû 
_flowContext
ûû 
==
ûû '
AuthenticationFlowContext
ûû 8
.
ûû8 9
REGISTRATION
ûû9 E
?
üü "
_registrationService
üü "
.
üü" #
VerifyOtpAsync
üü# 1
(
üü1 2+
VerificationSessionIdentifier
ýý -
!
ýý- .
.
ýý. /
Value
ýý/ 4
,
ýý4 5
VerificationCode
þþ  
,
þþ  !
	connectId
ÿÿ 
,
ÿÿ 
cancellationToken
€€ !
)
€€! "
:
 '
_secureKeyRecoveryService
 '
!
' (
.
( )*
VerifySecureKeyResetOtpAsync
) E
(
E F+
VerificationSessionIdentifier
‚‚ -
!
‚‚- .
.
‚‚. /
Value
‚‚/ 4
,
‚‚4 5
VerificationCode
ƒƒ  
,
ƒƒ  !
	connectId
„„ 
,
„„ 
cancellationToken
…… !
)
……! "
;
……" #
}
†† 
private
ˆˆ 
async
ˆˆ 
Task
ˆˆ *
HandleSuccessfulVerification
ˆˆ 3
(
ˆˆ3 4

Membership
ˆˆ4 >

membership
ˆˆ? I
,
ˆˆI J
CancellationToken
ˆˆK \
operationToken
ˆˆ] k
)
ˆˆk l
{
‰‰ 
if
ŠŠ 

(
ŠŠ 

HostScreen
ŠŠ 
is
ŠŠ %
AuthenticationViewModel
ŠŠ 1

hostWindow
ŠŠ2 <
)
ŠŠ< =
{
‹‹ 	
await
ŒŒ !
StoreMembershipData
ŒŒ %
(
ŒŒ% &

membership
ŒŒ& 0
)
ŒŒ0 1
;
ŒŒ1 2 
NavigateToNextStep
 
(
 

hostWindow
 )
)
) *
;
* +
}
ŽŽ 	
if
 

(
 
HasValidSession
 
)
 
{
‘‘ 	
await
’’ (
CleanupVerificationSession
’’ ,
(
’’, -
operationToken
’’- ;
)
’’; <
;
’’< =
}
““ 	
}
”” 
private
–– 
async
–– 
Task
–– !
StoreMembershipData
–– *
(
––* +

Membership
––+ 5

membership
––6 @
)
––@ A
{
—— 
await
˜˜ /
!_applicationSecureStorageProvider
˜˜ /
.
˜˜/ 0+
SetApplicationMembershipAsync
˜˜0 M
(
˜˜M N

membership
˜˜N X
)
˜˜X Y
;
˜˜Y Z
if
šš 

(
šš 

membership
šš 
.
šš %
AccountUniqueIdentifier
šš .
!=
šš/ 1
null
šš2 6
&&
šš7 9

membership
šš: D
.
ššD E%
AccountUniqueIdentifier
ššE \
.
šš\ ]
Length
šš] c
>
ššd e
$num
ššf g
)
ššg h
{
›› 	
await
œœ /
!_applicationSecureStorageProvider
œœ 3
.
 &
SetCurrentAccountIdAsync
 )
(
) *

membership
* 4
.
4 5%
AccountUniqueIdentifier
5 L
)
L M
.
žž 
ConfigureAwait
žž 
(
žž  
false
žž  %
)
žž% &
;
žž& '
Log
ŸŸ 
.
ŸŸ 
Information
ŸŸ 
(
ŸŸ 
$str   ˆ
,  ˆ ‰
Helpers
¡¡ 
.
¡¡ "
FromByteStringToGuid
¡¡ ,
(
¡¡, -

membership
¡¡- 7
.
¡¡7 8
UniqueIdentifier
¡¡8 H
)
¡¡H I
,
¡¡I J
Helpers
¢¢ 
.
¢¢ "
FromByteStringToGuid
¢¢ ,
(
¢¢, -

membership
¢¢- 7
.
¢¢7 8%
AccountUniqueIdentifier
¢¢8 O
)
¢¢O P
)
¢¢P Q
;
¢¢Q R
}
££ 	
}
¤¤ 
private
¦¦ 
void
¦¦  
NavigateToNextStep
¦¦ #
(
¦¦# $%
AuthenticationViewModel
¦¦$ ;

hostWindow
¦¦< F
)
¦¦F G
{
§§ 

hostWindow
¨¨ 
.
¨¨ "
ClearNavigationStack
¨¨ '
(
¨¨' (
true
¨¨( ,
,
¨¨, - 
MembershipViewType
¨¨. @
.
¨¨@ A&
MOBILE_VERIFICATION_VIEW
¨¨A Y
)
¨¨Y Z
;
¨¨Z [(
NavToSecureKeyConfirmation
©© "
.
©©" #
Execute
©©# *
(
©©* +
)
©©+ ,
.
©©, -
	Subscribe
©©- 6
(
©©6 7
)
©©7 8
.
©©8 9
DisposeWith
©©9 D
(
©©D E
_disposables
©©E Q
)
©©Q R
;
©©R S
}
ªª 
private
¬¬ 
async
¬¬ 
Task
¬¬ (
CleanupVerificationSession
¬¬ 1
(
¬¬1 2
CancellationToken
¬¬2 C
cancellationToken
¬¬D U
)
¬¬U V
{
­­ 
if
®® 

(
®® 
_flowContext
®® 
==
®® '
AuthenticationFlowContext
®® 5
.
®®5 6
REGISTRATION
®®6 B
)
®®B C
{
¯¯ 	
await
°° "
_registrationService
°° &
.
°°& '-
CleanupVerificationSessionAsync
°°' F
(
°°F G+
VerificationSessionIdentifier
°°G d
!
°°d e
.
°°e f
Value
°°f k
)
°°k l
.
±± 
	WaitAsync
±± 
(
±± %
AuthenticationConstants
±± 2
.
±±2 3
Timeouts
±±3 ;
.
±±; <
CleanupTimeout
±±< J
,
±±J K
cancellationToken
±±L ]
)
±±] ^
;
±±^ _
}
²² 	
else
³³ 
if
³³ 
(
³³ '
_secureKeyRecoveryService
³³ *
!=
³³+ -
null
³³. 2
)
³³2 3
{
´´ 	
await
µµ '
_secureKeyRecoveryService
µµ +
.
¶¶ /
!CleanupSecureKeyResetSessionAsync
¶¶ 2
(
¶¶2 3+
VerificationSessionIdentifier
¶¶3 P
!
¶¶P Q
.
¶¶Q R
Value
¶¶R W
)
¶¶W X
.
·· 
	WaitAsync
·· 
(
·· %
AuthenticationConstants
·· 2
.
··2 3
Timeouts
··3 ;
.
··; <
CleanupTimeout
··< J
,
··J K
cancellationToken
··L ]
)
··] ^
;
··^ _
}
¸¸ 	
}
¹¹ 
private
»» 
void
»» %
HandleVerificationError
»» (
(
»»( )
string
»») /
error
»»0 5
)
»»5 6
{
¼¼ 
ErrorMessage
½½ 
=
½½ 
error
½½ 
;
½½ 
}
¾¾ 
private
ÀÀ 
Task
ÀÀ $
ReSendVerificationCode
ÀÀ '
(
ÀÀ' (
)
ÀÀ( )
{
ÁÁ 
if
ÂÂ 

(
ÂÂ 
_isDisposed
ÂÂ 
)
ÂÂ 
{
ÃÃ 	
return
ÄÄ 
Task
ÄÄ 
.
ÄÄ 
CompletedTask
ÄÄ %
;
ÄÄ% &
}
ÅÅ 	
if
ÇÇ 

(
ÇÇ 
HasValidSession
ÇÇ 
)
ÇÇ 
{
ÈÈ 	$
ExecuteResendOperation
ÉÉ "
(
ÉÉ" #
)
ÉÉ# $
;
ÉÉ$ %
}
ÊÊ 	
else
ËË 
{
ÌÌ 	#
HandleNoActiveSession
ÍÍ !
(
ÍÍ! "
)
ÍÍ" #
;
ÍÍ# $
}
ÎÎ 	
return
ÐÐ 
Task
ÐÐ 
.
ÐÐ 
CompletedTask
ÐÐ !
;
ÐÐ! "
}
ÑÑ 
private
ÓÓ 
void
ÓÓ $
ExecuteResendOperation
ÓÓ '
(
ÓÓ' (
)
ÓÓ( )
{
ÔÔ 
ErrorMessage
ÕÕ 
=
ÕÕ 
string
ÕÕ 
.
ÕÕ 
Empty
ÕÕ #
;
ÕÕ# $
HasError
ÖÖ 
=
ÖÖ 
false
ÖÖ 
;
ÖÖ %
CancellationTokenSource
ØØ 
cancellationToken
ØØ  1
=
ØØ2 3(
CreateNewCancellationToken
ØØ4 N
(
ØØN O
)
ØØO P
;
ØØP Q
Task
ÚÚ 
.
ÚÚ 
Run
ÚÚ 
(
ÚÚ 
async
ÚÚ 
(
ÚÚ 
)
ÚÚ 
=>
ÚÚ 
{
ÛÛ 	
try
ÜÜ 
{
ÝÝ 
if
ÞÞ 
(
ÞÞ 
_isDisposed
ÞÞ 
||
ÞÞ  "
cancellationToken
ÞÞ# 4
.
ÞÞ4 5
Token
ÞÞ5 :
.
ÞÞ: ;%
IsCancellationRequested
ÞÞ; R
)
ÞÞR S
{
ßß 
return
àà 
;
àà 
}
áá 
cancellationToken
ãã !
.
ãã! "
Token
ãã" '
.
ãã' (*
ThrowIfCancellationRequested
ãã( D
(
ããD E
)
ããE F
;
ããF G
Task
åå 
<
åå 
Result
åå 
<
åå 
Ecliptix
åå $
.
åå$ %
	Utilities
åå% .
.
åå. /
Unit
åå/ 3
,
åå3 4
string
åå5 ;
>
åå; <
>
åå< =

resendTask
åå> H
=
ååI J
CreateResendTask
ååK [
(
åå[ \
cancellationToken
åå\ m
.
ååm n
Token
åån s
)
åås t
;
ååt u
Result
ææ 
<
ææ 
Ecliptix
ææ 
.
ææ  
	Utilities
ææ  )
.
ææ) *
Unit
ææ* .
,
ææ. /
string
ææ0 6
>
ææ6 7
result
ææ8 >
=
ææ? @
await
ææA F

resendTask
ææG Q
;
ææQ R
if
èè 
(
èè 
result
èè 
.
èè 
IsErr
èè  
&&
èè! #
!
èè$ %
_isDisposed
èè% 0
)
èè0 1
{
éé 
HandleResendError
êê %
(
êê% &
result
êê& ,
.
êê, -
	UnwrapErr
êê- 6
(
êê6 7
)
êê7 8
)
êê8 9
;
êê9 :
}
ëë 
}
ìì 
catch
íí 
(
íí 
	Exception
íí 
ex
íí 
)
íí  
{
îî 
Log
ïï 
.
ïï 
Error
ïï 
(
ïï 
ex
ïï 
,
ïï 
$str
ïï R
)
ïïR S
;
ïïS T
}
ðð 
}
ññ 	
,
ññ	 

cancellationToken
ññ 
.
ññ 
Token
ññ "
)
ññ" #
;
ññ# $
}
òò 
private
ôô %
CancellationTokenSource
ôô #(
CreateNewCancellationToken
ôô$ >
(
ôô> ?
)
ôô? @
{
õõ %
CancellationTokenSource
öö 
?
öö  
oldCts
öö! '
=
öö( )&
_cancellationTokenSource
öö* B
;
ööB C%
CancellationTokenSource
÷÷ 
newCts
÷÷  &
=
÷÷' (
new
÷÷) ,
(
÷÷, -
)
÷÷- .
;
÷÷. /&
_cancellationTokenSource
øø  
=
øø! "
newCts
øø# )
;
øø) *
_disposables
ùù 
.
ùù 
Add
ùù 
(
ùù 
newCts
ùù 
)
ùù  
;
ùù  !
oldCts
úú 
?
úú 
.
úú 
Dispose
úú 
(
úú 
)
úú 
;
úú 
return
ûû 
newCts
ûû 
;
ûû 
}
üü 
private
þþ 
Task
þþ 
<
þþ 
Result
þþ 
<
þþ 
Ecliptix
þþ  
.
þþ  !
	Utilities
þþ! *
.
þþ* +
Unit
þþ+ /
,
þþ/ 0
string
þþ1 7
>
þþ7 8
>
þþ8 9
CreateResendTask
þþ: J
(
þþJ K
CancellationToken
þþK \
cancellationToken
þþ] n
)
þþn o
{
ÿÿ 
Action
€€ 
<
€€ 
uint
€€ 
,
€€ 
Guid
€€ 
,
€€ )
VerificationCountdownUpdate
€€ 6
.
€€6 7
Types
€€7 <
.
€€< =#
CountdownUpdateStatus
€€= R
,
€€R S
string
€€T Z
?
€€Z [
>
€€[ \
countdownCallback
€€] n
=
€€o p
(
 
seconds
 
,
 

identifier
  
,
  !
status
" (
,
( )
message
* 1
)
1 2
=>
3 5
RxApp
‚‚ 
.
‚‚ !
MainThreadScheduler
‚‚ )
.
‚‚) *
Schedule
‚‚* 2
(
‚‚2 3
(
‚‚3 4
)
‚‚4 5
=>
‚‚6 8
{
ƒƒ 
if
„„ 
(
„„ 
!
„„ 
_isDisposed
„„ $
)
„„$ %
{
…… #
HandleCountdownUpdate
†† -
(
††- .
seconds
††. 5
,
††5 6

identifier
††7 A
,
††A B
status
††C I
,
††I J
message
††K R
)
††R S
;
††S T
}
‡‡ 
}
ˆˆ 
)
ˆˆ 
;
ˆˆ 
return
ŠŠ 
_flowContext
ŠŠ 
==
ŠŠ '
AuthenticationFlowContext
ŠŠ 8
.
ŠŠ8 9
REGISTRATION
ŠŠ9 E
?
‹‹ "
_registrationService
‹‹ "
.
‹‹" #(
ResendOtpVerificationAsync
‹‹# =
(
‹‹= >+
VerificationSessionIdentifier
ŒŒ -
!
ŒŒ- .
.
ŒŒ. /
Value
ŒŒ/ 4
,
ŒŒ4 5%
_mobileNumberIdentifier
 '
,
' (
onCountdownUpdate
ŽŽ !
:
ŽŽ! "
countdownCallback
ŽŽ# 4
,
ŽŽ4 5
cancellationToken
 !
:
! "
cancellationToken
# 4
)
4 5
:
 '
_secureKeyRecoveryService
 '
!
' (
.
( )*
ResendSecureKeyResetOtpAsync
) E
(
E F+
VerificationSessionIdentifier
‘‘ -
!
‘‘- .
.
‘‘. /
Value
‘‘/ 4
,
‘‘4 5%
_mobileNumberIdentifier
’’ '
,
’’' (
onCountdownUpdate
““ !
:
““! "
countdownCallback
““# 4
,
““4 5
cancellationToken
”” !
:
””! "
cancellationToken
””# 4
)
””4 5
;
””5 6
}
•• 
private
—— 
void
—— 
HandleResendError
—— "
(
——" #
string
——# )
error
——* /
)
——/ 0
{
˜˜ 
RxApp
™™ 
.
™™ !
MainThreadScheduler
™™ !
.
™™! "
Schedule
™™" *
(
™™* +
(
™™+ ,
)
™™, -
=>
™™. 0
{
šš 	
if
›› 
(
›› 
_isDisposed
›› 
)
›› 
{
œœ 
return
 
;
 
}
žž 
if
   
(
   &
IsServerUnavailableError
   (
(
  ( )
error
  ) .
)
  . /
)
  / 0
{
¡¡ 
ErrorMessage
¢¢ 
=
¢¢ 
error
¢¢ $
;
¢¢$ %$
StartAutoRedirectAsync
££ &
(
££& '
$num
££' (
,
££( ) 
MembershipViewType
££* <
.
££< =
WELCOME_VIEW
££= I
,
££I J
error
££K P
)
££P Q
.
££Q R
ContinueWith
££R ^
(
££^ _
task
¤¤ 
=>
¤¤ 
{
¥¥ 
if
¦¦ 
(
¦¦ 
task
¦¦  
is
¦¦! #
{
¦¦$ %
	IsFaulted
¦¦& /
:
¦¦/ 0
true
¦¦1 5
,
¦¦5 6
	Exception
¦¦7 @
:
¦¦@ A
not
¦¦B E
null
¦¦F J
}
¦¦K L
)
¦¦L M
{
§§ 
Log
¨¨ 
.
¨¨  
Error
¨¨  %
(
¨¨% &
task
¨¨& *
.
¨¨* +
	Exception
¨¨+ 4
,
¨¨4 5
$str
¨¨6 i
)
¨¨i j
;
¨¨j k
}
©© 
}
ªª 
,
ªª 
TaskScheduler
«« !
.
««! "
Default
««" )
)
««) *
;
««* +
HasError
¬¬ 
=
¬¬ 
true
¬¬ 
;
¬¬  
HasValidSession
­­ 
=
­­  !
false
­­" '
;
­­' (
}
®® 
else
¯¯ 
{
°° 
ErrorMessage
±± 
=
±± 
error
±± $
;
±±$ %
HasError
²² 
=
²² 
true
²² 
;
²²  
SecondsRemaining
³³  
=
³³! "
$num
³³# $
;
³³$ %
}
´´ 
}
µµ 	
)
µµ	 

;
µµ
 
}
¶¶ 
private
¸¸ 
void
¸¸ #
HandleNoActiveSession
¸¸ &
(
¸¸& '
)
¸¸' (
{
¹¹ 
SecondsRemaining
ºº 
=
ºº 
$num
ºº 
;
ºº 
ErrorMessage
»» 
=
»» "
_localizationService
»» +
[
»»+ ,%
AuthenticationConstants
»», C
.
»»C D0
"NO_ACTIVE_VERIFICATION_SESSION_KEY
»»D f
]
»»f g
;
»»g h
HasError
¼¼ 
=
¼¼ 
true
¼¼ 
;
¼¼ 
HasValidSession
½½ 
=
½½ 
false
½½ 
;
½½  
}
¾¾ 
private
ÀÀ 
uint
ÀÀ "
HandleResendCooldown
ÀÀ %
(
ÀÀ% &
string
ÀÀ& ,
?
ÀÀ, -
message
ÀÀ. 5
,
ÀÀ5 6
uint
ÀÀ7 ;
seconds
ÀÀ< C
)
ÀÀC D
{
ÁÁ 
if
ÂÂ 

(
ÂÂ 
!
ÂÂ 
string
ÂÂ 
.
ÂÂ 
IsNullOrEmpty
ÂÂ !
(
ÂÂ! "
message
ÂÂ" )
)
ÂÂ) *
)
ÂÂ* +
{
ÃÃ 	
string
ÄÄ  
messageWithSeconds
ÄÄ %
;
ÄÄ% &
if
ÅÅ 
(
ÅÅ 
seconds
ÅÅ 
>
ÅÅ 
$num
ÅÅ 
)
ÅÅ 
{
ÆÆ 
string
ÇÇ 
pluralSuffix
ÇÇ #
=
ÇÇ$ %
seconds
ÇÇ& -
>
ÇÇ. /
$num
ÇÇ0 1
?
ÇÇ2 3
$str
ÇÇ4 7
:
ÇÇ8 9
$str
ÇÇ: <
;
ÇÇ< = 
messageWithSeconds
ÈÈ "
=
ÈÈ# $
$"
ÈÈ% '
{
ÈÈ' (
message
ÈÈ( /
}
ÈÈ/ 0
$str
ÈÈ0 2
{
ÈÈ2 3
seconds
ÈÈ3 :
}
ÈÈ: ;
$str
ÈÈ; B
{
ÈÈB C
pluralSuffix
ÈÈC O
}
ÈÈO P
$str
ÈÈP Z
"
ÈÈZ [
;
ÈÈ[ \
}
ÉÉ 
else
ÊÊ 
{
ËË  
messageWithSeconds
ÌÌ "
=
ÌÌ# $
message
ÌÌ% ,
;
ÌÌ, -
}
ÍÍ 
ErrorMessage
ÏÏ 
=
ÏÏ  
messageWithSeconds
ÏÏ -
;
ÏÏ- .
HasError
ÐÐ 
=
ÐÐ 
true
ÐÐ 
;
ÐÐ 
}
ÑÑ 	#
CooldownBufferSeconds
ÓÓ 
=
ÓÓ 
seconds
ÓÓ  '
;
ÓÓ' (
_cooldownTimer
ÕÕ 
?
ÕÕ 
.
ÕÕ 
Dispose
ÕÕ 
(
ÕÕ  
)
ÕÕ  !
;
ÕÕ! "
if
×× 

(
×× 
seconds
×× 
>
×× 
$num
×× 
)
×× 
{
ØØ 	
_cooldownTimer
ÙÙ 
=
ÙÙ 

Observable
ÙÙ '
.
ÙÙ' (
Interval
ÙÙ( 0
(
ÙÙ0 1
TimeSpan
ÙÙ1 9
.
ÙÙ9 :
FromSeconds
ÙÙ: E
(
ÙÙE F
$num
ÙÙF G
)
ÙÙG H
)
ÙÙH I
.
ÚÚ 
	TakeWhile
ÚÚ 
(
ÚÚ 
_
ÚÚ 
=>
ÚÚ #
CooldownBufferSeconds
ÚÚ  5
>
ÚÚ6 7
$num
ÚÚ8 9
&&
ÚÚ: <
!
ÚÚ= >
_isDisposed
ÚÚ> I
)
ÚÚI J
.
ÛÛ 
	ObserveOn
ÛÛ 
(
ÛÛ 
RxApp
ÛÛ  
.
ÛÛ  !!
MainThreadScheduler
ÛÛ! 4
)
ÛÛ4 5
.
ÜÜ 
	Subscribe
ÜÜ 
(
ÜÜ 
_
ÜÜ 
=>
ÜÜ 
{
ÝÝ 
if
ÞÞ 
(
ÞÞ #
CooldownBufferSeconds
ÞÞ -
>
ÞÞ. /
$num
ÞÞ0 1
)
ÞÞ1 2
{
ßß #
CooldownBufferSeconds
àà -
--
àà- /
;
àà/ 0
}
áá 
if
ãã 
(
ãã #
CooldownBufferSeconds
ãã -
!=
ãã. 0
$num
ãã1 2
)
ãã2 3
{
ää 
return
åå 
;
åå 
}
ææ 
ErrorMessage
èè  
=
èè! "
string
èè# )
.
èè) *
Empty
èè* /
;
èè/ 0
HasError
éé 
=
éé 
false
éé $
;
éé$ %
CurrentStatus
êê !
=
êê" #)
VerificationCountdownUpdate
êê$ ?
.
êê? @
Types
êê@ E
.
êêE F#
CountdownUpdateStatus
êêF [
.
êê[ \
Expired
êê\ c
;
êêc d
_cooldownTimer
ëë "
?
ëë" #
.
ëë# $
Dispose
ëë$ +
(
ëë+ ,
)
ëë, -
;
ëë- .
_cooldownTimer
ìì "
=
ìì# $
null
ìì% )
;
ìì) *
}
íí 
)
íí 
;
íí 
}
îî 	
return
ðð 
$num
ðð 
;
ðð 
}
ññ 
private
óó 
uint
óó %
HandleMaxAttemptsStatus
óó (
(
óó( )
)
óó) *
{
ôô "
IsMaxAttemptsReached
õõ 
=
õõ 
true
õõ #
;
õõ# $$
StartAutoRedirectAsync
öö 
(
öö 
$num
öö  
,
öö  ! 
MembershipViewType
öö" 4
.
öö4 5
WELCOME_VIEW
öö5 A
)
ööA B
.
ööB C
ContinueWith
ööC O
(
ööO P
task
÷÷ 
=>
÷÷ 
{
øø 
if
ùù 
(
ùù 
task
ùù 
is
ùù 
{
ùù 
	IsFaulted
ùù '
:
ùù' (
true
ùù) -
,
ùù- .
	Exception
ùù/ 8
:
ùù8 9
not
ùù: =
null
ùù> B
}
ùùC D
)
ùùD E
{
úú 
Log
ûû 
.
ûû 
Error
ûû 
(
ûû 
task
ûû "
.
ûû" #
	Exception
ûû# ,
,
ûû, -
$str
ûû. n
)
ûûn o
;
ûûo p
}
üü 
}
ýý 
,
ýý 
TaskScheduler
þþ 
.
þþ 
Default
þþ !
)
þþ! "
;
þþ" #
return
ÿÿ 
$num
ÿÿ 
;
ÿÿ 
}
€€ 
private
‚‚ 
uint
‚‚ "
HandleNotFoundStatus
‚‚ %
(
‚‚% &
)
‚‚& '
{
ƒƒ 
string
„„ 
message
„„ 
=
„„ "
_localizationService
„„ -
[
„„- .%
AuthenticationConstants
„„. E
.
„„E F#
SESSION_NOT_FOUND_KEY
„„F [
]
„„[ \
;
„„\ ]$
StartAutoRedirectAsync
…… 
(
…… 
$num
……  
,
……  ! 
MembershipViewType
……" 4
.
……4 5
WELCOME_VIEW
……5 A
,
……A B
message
……C J
)
……J K
.
……K L
ContinueWith
……L X
(
……X Y
task
†† 
=>
†† 
{
‡‡ 
if
ˆˆ 
(
ˆˆ 
task
ˆˆ 
is
ˆˆ 
{
ˆˆ 
	IsFaulted
ˆˆ '
:
ˆˆ' (
true
ˆˆ) -
,
ˆˆ- .
	Exception
ˆˆ/ 8
:
ˆˆ8 9
not
ˆˆ: =
null
ˆˆ> B
}
ˆˆC D
)
ˆˆD E
{
‰‰ 
Log
ŠŠ 
.
ŠŠ 
Error
ŠŠ 
(
ŠŠ 
task
ŠŠ "
.
ŠŠ" #
	Exception
ŠŠ# ,
,
ŠŠ, -
$str
ŠŠ. k
)
ŠŠk l
;
ŠŠl m
}
‹‹ 
}
ŒŒ 
,
ŒŒ 
TaskScheduler
 
.
 
Default
 !
)
! "
;
" #
return
ŽŽ 
$num
ŽŽ 
;
ŽŽ 
}
 
private
‘‘ 
uint
‘‘ (
HandleSessionExpiredStatus
‘‘ +
(
‘‘+ ,
)
‘‘, -
{
’’ 
string
““ 
message
““ 
=
““ "
_localizationService
““ -
[
““- .%
AuthenticationConstants
““. E
.
““E F.
 VERIFICATION_SESSION_EXPIRED_KEY
““F f
]
““f g
;
““g h$
StartAutoRedirectAsync
”” 
(
”” 
$num
””  
,
””  ! 
MembershipViewType
””" 4
.
””4 5
WELCOME_VIEW
””5 A
,
””A B
message
””C J
)
””J K
.
””K L
ContinueWith
””L X
(
””X Y
task
•• 
=>
•• 
{
–– 
if
—— 
(
—— 
task
—— 
is
—— 
{
—— 
	IsFaulted
—— '
:
——' (
true
——) -
,
——- .
	Exception
——/ 8
:
——8 9
not
——: =
null
——> B
}
——C D
)
——D E
{
˜˜ 
Log
™™ 
.
™™ 
Error
™™ 
(
™™ 
task
™™ "
.
™™" #
	Exception
™™# ,
,
™™, -
$str
šš [
)
šš[ \
;
šš\ ]
}
›› 
}
œœ 
,
œœ 
TaskScheduler
 
.
 
Default
 !
)
! "
;
" #
return
žž 
$num
žž 
;
žž 
}
ŸŸ 
private
¡¡ 
uint
¡¡  
HandleFailedStatus
¡¡ #
(
¡¡# $
string
¡¡$ *
?
¡¡* +
error
¡¡, 1
)
¡¡1 2
{
¢¢ 
Task
££ 
redirectTask
££ 
=
££ 
!
££ 
string
££ #
.
££# $
IsNullOrEmpty
££$ 1
(
££1 2
error
££2 7
)
££7 8
?
¤¤ $
StartAutoRedirectAsync
¤¤ $
(
¤¤$ %
$num
¤¤% &
,
¤¤& ' 
MembershipViewType
¤¤( :
.
¤¤: ;
WELCOME_VIEW
¤¤; G
,
¤¤G H
error
¤¤I N
)
¤¤N O
:
¥¥ $
StartAutoRedirectAsync
¥¥ $
(
¥¥$ %
$num
¥¥% &
,
¥¥& ' 
MembershipViewType
¥¥( :
.
¥¥: ;
WELCOME_VIEW
¥¥; G
)
¥¥G H
;
¥¥H I
redirectTask
§§ 
.
§§ 
ContinueWith
§§ !
(
§§! "
task
¨¨ 
=>
¨¨ 
{
©© 
if
ªª 
(
ªª 
task
ªª 
is
ªª 
{
ªª 
	IsFaulted
ªª '
:
ªª' (
true
ªª) -
,
ªª- .
	Exception
ªª/ 8
:
ªª8 9
not
ªª: =
null
ªª> B
}
ªªC D
)
ªªD E
{
«« 
Log
¬¬ 
.
¬¬ 
Error
¬¬ 
(
¬¬ 
task
¬¬ "
.
¬¬" #
	Exception
¬¬# ,
,
¬¬, -
$str
­­ Y
)
­­Y Z
;
­­Z [
}
®® 
}
¯¯ 
,
¯¯ 
TaskScheduler
°° 
.
°° 
Default
°° !
)
°°! "
;
°°" #
HasError
²² 
=
²² 
true
²² 
;
²² 
HasValidSession
³³ 
=
³³ 
false
³³ 
;
³³  
return
´´ 
$num
´´ 
;
´´ 
}
µµ 
private
·· 
uint
·· 
HandleUnavailable
·· "
(
··" #
string
··# )
?
··) *
message
··+ 2
)
··2 3
{
¸¸ 
string
¹¹ 
errorMessage
¹¹ 
=
¹¹ 
!
¹¹ 
string
¹¹ %
.
¹¹% &
IsNullOrEmpty
¹¹& 3
(
¹¹3 4
message
¹¹4 ;
)
¹¹; <
?
ºº 
message
ºº 
:
»» "
_localizationService
»» "
[
»»" #
LocalizationKeys
»»# 3
.
»»3 4
Common
»»4 :
.
»»: ; 
SERVER_UNAVAILABLE
»»; M
]
»»M N
;
»»N O$
StartAutoRedirectAsync
½½ 
(
½½ 
$num
½½  
,
½½  ! 
MembershipViewType
½½" 4
.
½½4 5
WELCOME_VIEW
½½5 A
,
½½A B
errorMessage
½½C O
)
½½O P
.
½½P Q
ContinueWith
½½Q ]
(
½½] ^
task
¾¾ 
=>
¾¾ 
{
¿¿ 
if
ÀÀ 
(
ÀÀ 
task
ÀÀ 
.
ÀÀ 
	IsFaulted
ÀÀ "
&&
ÀÀ# %
task
ÀÀ& *
.
ÀÀ* +
	Exception
ÀÀ+ 4
!=
ÀÀ5 7
null
ÀÀ8 <
)
ÀÀ< =
{
ÁÁ 
Log
ÂÂ 
.
ÂÂ 
Error
ÂÂ 
(
ÂÂ 
task
ÂÂ "
.
ÂÂ" #
	Exception
ÂÂ# ,
,
ÂÂ, -
$str
ÂÂ. j
)
ÂÂj k
;
ÂÂk l
}
ÃÃ 
}
ÄÄ 
,
ÄÄ 
TaskScheduler
ÅÅ 
.
ÅÅ 
Default
ÅÅ !
)
ÅÅ! "
;
ÅÅ" #
HasError
ÇÇ 
=
ÇÇ 
true
ÇÇ 
;
ÇÇ 
HasValidSession
ÈÈ 
=
ÈÈ 
false
ÈÈ 
;
ÈÈ  
Task
ÊÊ 
.
ÊÊ 
Run
ÊÊ 
(
ÊÊ 
async
ÊÊ 
(
ÊÊ 
)
ÊÊ 
=>
ÊÊ 
{
ËË 	
try
ÌÌ 
{
ÍÍ 
await
ÎÎ (
EnsureProtocolInBackground
ÎÎ 0
(
ÎÎ0 1
)
ÎÎ1 2
;
ÎÎ2 3
}
ÏÏ 
catch
ÐÐ 
(
ÐÐ 
	Exception
ÐÐ 
ex
ÐÐ 
)
ÐÐ  
{
ÑÑ 
Log
ÒÒ 
.
ÒÒ 
Warning
ÒÒ 
(
ÒÒ 
ex
ÒÒ 
,
ÒÒ 
$str
ÒÒ  ^
)
ÒÒ^ _
;
ÒÒ_ `
}
ÓÓ 
}
ÔÔ 	
)
ÔÔ	 

.
ÔÔ
 
ContinueWith
ÔÔ 
(
ÔÔ 
task
ÕÕ 
=>
ÕÕ 
{
ÖÖ 
if
×× 
(
×× 
task
×× 
.
×× 
	IsFaulted
×× "
&&
××# %
task
××& *
.
××* +
	Exception
××+ 4
!=
××5 7
null
××8 <
)
××< =
{
ØØ 
Log
ÙÙ 
.
ÙÙ 
Error
ÙÙ 
(
ÙÙ 
task
ÙÙ "
.
ÙÙ" #
	Exception
ÙÙ# ,
,
ÙÙ, -
$str
ÙÙ. n
)
ÙÙn o
;
ÙÙo p
}
ÚÚ 
}
ÛÛ 
,
ÛÛ 
TaskScheduler
ÜÜ 
.
ÜÜ 
Default
ÜÜ !
)
ÜÜ! "
;
ÜÜ" #
return
ÞÞ 
$num
ÞÞ 
;
ÞÞ 
}
ßß 
private
áá 
async
áá 
Task
áá (
EnsureProtocolInBackground
áá 1
(
áá1 2
)
áá2 3
{
ââ 
await
ãã 
NetworkProvider
ãã 
.
ãã (
EnsureProtocolForTypeAsync
ãã 8
(
ãã8 9 
PubKeyExchangeType
ää 
.
ää (
DataCenterEphemeralConnect
ää 9
)
ää9 :
;
ää: ;
}
åå 
private
çç 
async
çç 
Task
çç $
StartAutoRedirectAsync
çç -
(
çç- .
int
çç. 1
seconds
çç2 9
,
çç9 : 
MembershipViewType
çç; M

targetView
ççN X
,
ççX Y
string
ççZ `
localizedMessage
çça q
=
ççr s
$str
ççt v
)
ççv w
{
èè 
if
éé 

(
éé 
_isDisposed
éé 
)
éé 
{
êê 	
return
ëë 
;
ëë 
}
ìì 	
await
îî 

Dispatcher
îî 
.
îî 
UIThread
îî !
.
îî! "
InvokeAsync
îî" -
(
îî- .
(
îî. /
)
îî/ 0
=>
îî1 3
{
ïï 	 
_autoRedirectTimer
ðð 
?
ðð 
.
ðð  
Dispose
ðð  '
(
ðð' (
)
ðð( )
;
ðð) * 
_autoRedirectTimer
ññ 
=
ññ  
null
ññ! %
;
ññ% &
return
óó 
Task
óó 
.
óó 
CompletedTask
óó %
;
óó% &
}
ôô 	
)
ôô	 

;
ôô
 
string
öö 
message
öö 
;
öö 
if
øø 

(
øø 
!
øø 
string
øø 
.
øø 
IsNullOrEmpty
øø !
(
øø! "
localizedMessage
øø" 2
)
øø2 3
)
øø3 4
{
ùù 	
message
úú 
=
úú 
localizedMessage
úú &
;
úú& '
}
ûû 	
else
üü 
{
ýý 	
string
þþ 
key
þþ 
=
þþ "
IsMaxAttemptsReached
þþ -
?
ÿÿ %
AuthenticationConstants
ÿÿ )
.
ÿÿ) *&
MAX_ATTEMPTS_REACHED_KEY
ÿÿ* B
:
€€ %
AuthenticationConstants
€€ )
.
€€) *#
SESSION_NOT_FOUND_KEY
€€* ?
;
€€? @
message
‚‚ 
=
‚‚ "
_localizationService
‚‚ *
.
‚‚* +
	GetString
‚‚+ 4
(
‚‚4 5
key
‚‚5 8
)
‚‚8 9
;
‚‚9 :
}
ƒƒ 	
if
…… 

(
…… 

HostScreen
…… 
is
…… %
AuthenticationViewModel
…… 1

hostWindow
……2 <
)
……< =
{
†† 	&
ShowRedirectNotification
‡‡ $
(
‡‡$ %

hostWindow
‡‡% /
,
‡‡/ 0
message
‡‡1 8
,
‡‡8 9
seconds
‡‡: A
,
‡‡A B
(
‡‡C D
)
‡‡D E
=>
‡‡F H
{
ˆˆ 
if
‰‰ 
(
‰‰ 
!
‰‰ 
_isDisposed
‰‰  
)
‰‰  !
{
ŠŠ %
CleanupAndNavigateAsync
‹‹ +
(
‹‹+ ,

targetView
‹‹, 6
)
‹‹6 7
.
‹‹7 8
ContinueWith
‹‹8 D
(
‹‹D E
task
ŒŒ 
=>
ŒŒ 
{
 
if
ŽŽ 
(
ŽŽ  
task
ŽŽ  $
is
ŽŽ% '
{
ŽŽ( )
	IsFaulted
ŽŽ* 3
:
ŽŽ3 4
true
ŽŽ5 9
,
ŽŽ9 :
	Exception
ŽŽ; D
:
ŽŽD E
not
ŽŽF I
null
ŽŽJ N
}
ŽŽO P
)
ŽŽP Q
{
 
Log
  #
.
# $
Error
$ )
(
) *
task
* .
.
. /
	Exception
/ 8
,
8 9
$str
‘‘$ ^
)
‘‘^ _
;
‘‘_ `
}
’’ 
}
““ 
,
““ 
TaskScheduler
”” %
.
””% &
Default
””& -
)
””- .
;
””. /
}
•• 
}
–– 
)
–– 
;
–– 
}
—— 	
}
˜˜ 
private
šš 
void
šš #
HandleCountdownUpdate
šš &
(
šš& '
uint
šš' +
seconds
šš, 3
,
šš3 4
Guid
šš5 9

identifier
šš: D
,
ššD E)
VerificationCountdownUpdate
›› #
.
››# $
Types
››$ )
.
››) *#
CountdownUpdateStatus
››* ?
status
››@ F
,
››F G
string
››H N
?
››N O
message
››P W
)
››W X
{
œœ 
if
 

(
 
_isDisposed
 
)
 
{
žž 	
return
ŸŸ 
;
ŸŸ 
}
   	
if
¢¢ 

(
¢¢ 
!
¢¢ 0
"ValidateAndUpdateSessionIdentifier
¢¢ /
(
¢¢/ 0

identifier
¢¢0 :
)
¢¢: ;
)
¢¢; <
{
££ 	
return
¤¤ 
;
¤¤ 
}
¥¥ 	
SecondsRemaining
§§ 
=
§§ $
ProcessCountdownStatus
§§ 1
(
§§1 2
status
§§2 8
,
§§8 9
seconds
§§: A
,
§§A B
message
§§C J
)
§§J K
;
§§K L
CurrentStatus
¨¨ 
=
¨¨ 
status
¨¨ 
;
¨¨ 
}
©© 
private
«« 
uint
«« $
ProcessCountdownStatus
«« '
(
««' ()
VerificationCountdownUpdate
¬¬ #
.
¬¬# $
Types
¬¬$ )
.
¬¬) *#
CountdownUpdateStatus
¬¬* ?
status
¬¬@ F
,
¬¬F G
uint
­­ 
seconds
­­ 
,
­­ 
string
®® 
?
®® 
message
®® 
)
®® 
{
¯¯ 
return
°° 
status
°° 
switch
°° 
{
±± 	)
VerificationCountdownUpdate
²² '
.
²²' (
Types
²²( -
.
²²- .#
CountdownUpdateStatus
²². C
.
²²C D
Active
²²D J
=>
²²K M
seconds
²²N U
,
²²U V)
VerificationCountdownUpdate
³³ '
.
³³' (
Types
³³( -
.
³³- .#
CountdownUpdateStatus
³³. C
.
³³C D
Expired
³³D K
=>
³³L N
$num
³³O P
,
³³P Q)
VerificationCountdownUpdate
´´ '
.
´´' (
Types
´´( -
.
´´- .#
CountdownUpdateStatus
´´. C
.
´´C D
ResendCooldown
´´D R
=>
´´S U"
HandleResendCooldown
´´V j
(
´´j k
message
´´k r
,
´´r s
seconds
´´t {
)
´´{ |
,
´´| })
VerificationCountdownUpdate
µµ '
.
µµ' (
Types
µµ( -
.
µµ- .#
CountdownUpdateStatus
µµ. C
.
µµC D
Failed
µµD J
=>
µµK M 
HandleFailedStatus
µµN `
(
µµ` a
message
µµa h
)
µµh i
,
µµi j)
VerificationCountdownUpdate
¶¶ '
.
¶¶' (
Types
¶¶( -
.
¶¶- .#
CountdownUpdateStatus
¶¶. C
.
¶¶C D
NotFound
¶¶D L
=>
¶¶M O"
HandleNotFoundStatus
¶¶P d
(
¶¶d e
)
¶¶e f
,
¶¶f g)
VerificationCountdownUpdate
·· '
.
··' (
Types
··( -
.
··- .#
CountdownUpdateStatus
··. C
.
··C D 
MaxAttemptsReached
··D V
=>
··W Y%
HandleMaxAttemptsStatus
··Z q
(
··q r
)
··r s
,
··s t)
VerificationCountdownUpdate
¸¸ '
.
¸¸' (
Types
¸¸( -
.
¸¸- .#
CountdownUpdateStatus
¸¸. C
.
¸¸C D
SessionExpired
¸¸D R
=>
¸¸S U(
HandleSessionExpiredStatus
¸¸V p
(
¸¸p q
)
¸¸q r
,
¸¸r s)
VerificationCountdownUpdate
¹¹ '
.
¹¹' (
Types
¹¹( -
.
¹¹- .#
CountdownUpdateStatus
¹¹. C
.
¹¹C D
ServerUnavailable
¹¹D U
=>
¹¹V X
HandleUnavailable
¹¹Y j
(
¹¹j k
message
¹¹k r
)
¹¹r s
,
¹¹s t
_
ºº 
=>
ºº 
Math
ºº 
.
ºº 
Min
ºº 
(
ºº 
seconds
ºº !
,
ºº! "
SecondsRemaining
ºº# 3
)
ºº3 4
}
»» 	
;
»»	 

}
¼¼ 
private
¾¾ 
bool
¾¾ 0
"ValidateAndUpdateSessionIdentifier
¾¾ 3
(
¾¾3 4
Guid
¾¾4 8

identifier
¾¾9 C
)
¾¾C D
{
¿¿ 
if
ÀÀ 

(
ÀÀ 

identifier
ÀÀ 
==
ÀÀ 
Guid
ÀÀ 
.
ÀÀ 
Empty
ÀÀ $
)
ÀÀ$ %
{
ÁÁ 	
return
ÂÂ 
true
ÂÂ 
;
ÂÂ 
}
ÃÃ 	
lock
ÅÅ 
(
ÅÅ 
_sessionLock
ÅÅ 
)
ÅÅ 
{
ÆÆ 	
if
ÇÇ 
(
ÇÇ 
_isDisposed
ÇÇ 
)
ÇÇ 
{
ÈÈ 
return
ÉÉ 
false
ÉÉ 
;
ÉÉ 
}
ÊÊ 
if
ÌÌ 
(
ÌÌ ,
_verificationSessionIdentifier
ÌÌ .
!=
ÌÌ/ 1
Guid
ÌÌ2 6
.
ÌÌ6 7
Empty
ÌÌ7 <
)
ÌÌ< =
{
ÍÍ 
return
ÎÎ ,
_verificationSessionIdentifier
ÎÎ 5
==
ÎÎ6 8

identifier
ÎÎ9 C
;
ÎÎC D
}
ÏÏ ,
_verificationSessionIdentifier
ÑÑ *
=
ÑÑ+ ,

identifier
ÑÑ- 7
;
ÑÑ7 8
HasValidSession
ÒÒ 
=
ÒÒ 
true
ÒÒ "
;
ÒÒ" #
return
ÓÓ 
true
ÓÓ 
;
ÓÓ 
}
ÕÕ 	
}
ÖÖ 
private
ØØ 
async
ØØ 
Task
ØØ %
CleanupAndNavigateAsync
ØØ .
(
ØØ. / 
MembershipViewType
ØØ/ A

targetView
ØØB L
)
ØØL M
{
ÙÙ 
if
ÚÚ 

(
ÚÚ 
_isDisposed
ÚÚ 
)
ÚÚ 
{
ÛÛ 	
return
ÜÜ 
;
ÜÜ 
}
ÝÝ 	
if
ßß 

(
ßß &
_cancellationTokenSource
ßß $
!=
ßß% '
null
ßß( ,
)
ßß, -
{
àà 	
await
áá &
_cancellationTokenSource
áá *
.
áá* +
CancelAsync
áá+ 6
(
áá6 7
)
áá7 8
;
áá8 9&
_cancellationTokenSource
ââ $
.
ââ$ %
Dispose
ââ% ,
(
ââ, -
)
ââ- .
;
ââ. /&
_cancellationTokenSource
ãã $
=
ãã% &
null
ãã' +
;
ãã+ ,
}
ää 	
await
ææ 

Dispatcher
ææ 
.
ææ 
UIThread
ææ !
.
ææ! "
InvokeAsync
ææ" -
(
ææ- .
(
ææ. /
)
ææ/ 0
=>
ææ1 3
{
çç 	
if
èè 
(
èè 
!
èè 
_isDisposed
èè 
&&
èè 

HostScreen
èè  *
is
èè+ -%
AuthenticationViewModel
èè. E"
membershipHostWindow
èèF Z
)
èèZ [
{
éé  
CleanupAndNavigate
êê "
(
êê" #"
membershipHostWindow
êê# 7
,
êê7 8

targetView
êê9 C
)
êêC D
;
êêD E
}
ëë 
return
íí 
Task
íí 
.
íí 
CompletedTask
íí %
;
íí% &
}
îî 	
)
îî	 

;
îî
 
}
ïï 
private
ññ 
static
ññ 
string
ññ !
FormatRemainingTime
ññ -
(
ññ- .
uint
ññ. 2
seconds
ññ3 :
)
ññ: ;
=>
ññ< >
TimeSpan
ññ? G
.
ññG H
FromSeconds
ññH S
(
ññS T
seconds
ññT [
)
ññ[ \
.
ññ\ ]
ToString
ññ] e
(
ññe f
$str
ññf o
)
ñño p
;
ññp q
private
óó 
bool
óó &
IsServerUnavailableError
óó )
(
óó) *
string
óó* 0
errorMessage
óó1 =
)
óó= >
{
ôô 
string
õõ #
serverUnavailableText
õõ $
=
õõ% &"
_localizationService
õõ' ;
[
õõ; <
LocalizationKeys
õõ< L
.
õõL M
Common
õõM S
.
õõS T 
SERVER_UNAVAILABLE
õõT f
]
õõf g
;
õõg h
string
öö $
serviceUnavailableText
öö %
=
öö& '"
_localizationService
öö( <
[
öö< =
ErrorI18NKeys
öö= J
.
ööJ K!
SERVICE_UNAVAILABLE
ööK ^
]
öö^ _
;
öö_ `
return
øø 
errorMessage
øø 
.
øø 
Contains
øø $
(
øø$ %#
serverUnavailableText
øø% :
,
øø: ;
StringComparison
øø< L
.
øøL M
OrdinalIgnoreCase
øøM ^
)
øø^ _
||
øø` b
errorMessage
ùù 
.
ùù 
Contains
ùù $
(
ùù$ %$
serviceUnavailableText
ùù% ;
,
ùù; <
StringComparison
ùù= M
.
ùùM N
OrdinalIgnoreCase
ùùN _
)
ùù_ `
||
ùùa c
errorMessage
úú 
.
úú 
Contains
úú $
(
úú$ %
$str
úú% 2
,
úú2 3
StringComparison
úú4 D
.
úúD E
OrdinalIgnoreCase
úúE V
)
úúV W
||
úúX Z
errorMessage
ûû 
.
ûû 
Contains
ûû $
(
ûû$ %
$str
ûû% 5
,
ûû5 6
StringComparison
ûû7 G
.
ûûG H
OrdinalIgnoreCase
ûûH Y
)
ûûY Z
;
ûûZ [
}
üü 
private
þþ 
async
þþ 
Task
þþ !
CleanupSessionAsync
þþ *
(
þþ* +
)
þþ+ ,
{
ÿÿ 
if
€€ 

(
€€ 
HasValidSession
€€ 
)
€€ 
{
 	
Guid
‚‚ 
	sessionId
‚‚ 
=
‚‚ +
VerificationSessionIdentifier
‚‚ :
!
‚‚: ;
.
‚‚; <
Value
‚‚< A
;
‚‚A B
if
„„ 
(
„„ 
_flowContext
„„ 
==
„„ '
AuthenticationFlowContext
„„  9
.
„„9 :
REGISTRATION
„„: F
)
„„F G
{
…… 
await
†† "
_registrationService
†† *
.
††* +-
CleanupVerificationSessionAsync
††+ J
(
††J K
	sessionId
††K T
)
††T U
;
††U V
}
‡‡ 
else
ˆˆ 
if
ˆˆ 
(
ˆˆ '
_secureKeyRecoveryService
ˆˆ .
!=
ˆˆ/ 1
null
ˆˆ2 6
)
ˆˆ6 7
{
‰‰ 
await
ŠŠ '
_secureKeyRecoveryService
ŠŠ /
.
ŠŠ/ 0/
!CleanupSecureKeyResetSessionAsync
ŠŠ0 Q
(
ŠŠQ R
	sessionId
ŠŠR [
)
ŠŠ[ \
;
ŠŠ\ ]
}
‹‹ 
}
ŒŒ 	
}
 
private
 
async
 
Task
 
ResetUiState
 #
(
# $
)
$ %
{
 
if
‘‘ 

(
‘‘ 
_isDisposed
‘‘ 
)
‘‘ 
{
’’ 	
return
““ 
;
““ 
}
”” 	
await
–– 

Dispatcher
–– 
.
–– 
UIThread
–– !
.
––! "
InvokeAsync
––" -
(
––- .
async
––. 3
(
––4 5
)
––5 6
=>
––7 9
{
—— 	 
_autoRedirectTimer
˜˜ 
?
˜˜ 
.
˜˜  
Dispose
˜˜  '
(
˜˜' (
)
˜˜( )
;
˜˜) * 
_autoRedirectTimer
™™ 
=
™™  
null
™™! %
;
™™% &
_cooldownTimer
›› 
?
›› 
.
›› 
Dispose
›› #
(
››# $
)
››$ %
;
››% &
_cooldownTimer
œœ 
=
œœ 
null
œœ !
;
œœ! "
if
žž 
(
žž 

HostScreen
žž 
is
žž %
AuthenticationViewModel
žž 5

hostWindow
žž6 @
)
žž@ A
{
ŸŸ 
await
   

hostWindow
    
.
    !"
HideBottomSheetAsync
  ! 5
(
  5 6
)
  6 7
;
  7 8
}
¡¡ 
VerificationCode
££ 
=
££ 
$str
££ !
;
££! "
ErrorMessage
¤¤ 
=
¤¤ 
string
¤¤ !
.
¤¤! "
Empty
¤¤" '
;
¤¤' (
HasError
¥¥ 
=
¥¥ 
false
¥¥ 
;
¥¥ 
SecondsRemaining
¦¦ 
=
¦¦ 
$num
¦¦  
;
¦¦  !
RemainingTime
§§ 
=
§§ %
AuthenticationConstants
§§ 3
.
§§3 4$
INITIAL_REMAINING_TIME
§§4 J
;
§§J K"
IsMaxAttemptsReached
¨¨  
=
¨¨! "
false
¨¨# (
;
¨¨( )
CurrentStatus
©© 
=
©© )
VerificationCountdownUpdate
©© 7
.
©©7 8
Types
©©8 =
.
©©= >#
CountdownUpdateStatus
©©> S
.
©©S T
Active
©©T Z
;
©©Z [
lock
ªª 
(
ªª 
_sessionLock
ªª 
)
ªª 
{
«« ,
_verificationSessionIdentifier
¬¬ .
=
¬¬/ 0
Guid
¬¬1 5
.
¬¬5 6
Empty
¬¬6 ;
;
¬¬; <
HasValidSession
­­ 
=
­­  !
false
­­" '
;
­­' (
}
®® 
}
¯¯ 	
)
¯¯	 

;
¯¯
 
}
°° 
private
²² 
static
²² 
bool
²² #
CanResendVerification
²² -
(
²²- .
uint
³³ 
secondsRemaining
³³ 
,
³³ 
bool
´´ 
hasValidSession
´´ 
,
´´ )
VerificationCountdownUpdate
µµ #
.
µµ# $
Types
µµ$ )
.
µµ) *#
CountdownUpdateStatus
µµ* ?
status
µµ@ F
,
µµF G
uint
¶¶ #
cooldownBufferSeconds
¶¶ "
,
¶¶" #
bool
·· 
isInNetworkOutage
·· 
)
·· 
{
¸¸ 
if
¹¹ 

(
¹¹ 
!
¹¹ 
hasValidSession
¹¹ 
||
¹¹ 
isInNetworkOutage
¹¹  1
)
¹¹1 2
{
ºº 	
return
»» 
false
»» 
;
»» 
}
¼¼ 	
if
¾¾ 

(
¾¾ 
status
¾¾ 
==
¾¾ )
VerificationCountdownUpdate
¾¾ 1
.
¾¾1 2
Types
¾¾2 7
.
¾¾7 8#
CountdownUpdateStatus
¾¾8 M
.
¾¾M N
ResendCooldown
¾¾N \
)
¾¾\ ]
{
¿¿ 	
return
ÀÀ #
cooldownBufferSeconds
ÀÀ (
==
ÀÀ) +
$num
ÀÀ, -
;
ÀÀ- .
}
ÁÁ 	
if
ÃÃ 

(
ÃÃ 
secondsRemaining
ÃÃ 
!=
ÃÃ 
$num
ÃÃ  !
)
ÃÃ! "
{
ÄÄ 	
return
ÅÅ 
false
ÅÅ 
;
ÅÅ 
}
ÆÆ 	
return
ÈÈ 
status
ÈÈ 
==
ÈÈ )
VerificationCountdownUpdate
ÈÈ 4
.
ÈÈ4 5
Types
ÈÈ5 :
.
ÈÈ: ;#
CountdownUpdateStatus
ÈÈ; P
.
ÈÈP Q
Expired
ÈÈQ X
;
ÈÈX Y
}
ÉÉ 
}ÊÊ ¯Ñ
¤/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/Registration/SecureKeyVerifierViewModel.cs
	namespace!! 	
Ecliptix!!
 
.!! 
Core!! 
.!! 
Features!!  
.!!  !
Authentication!!! /
.!!/ 0

ViewModels!!0 :
.!!: ;
Registration!!; G
;!!G H
public## 
sealed## 
class## &
SecureKeyVerifierViewModel## .
:##/ 0
Core##1 5
.##5 6
MVVM##6 :
.##: ;
ViewModelBase##; H
,##H I
IRoutableViewModel##J \
,##\ ]
IResettable##^ i
{$$ 
private%% 
const%% 
int%% "
VALIDATION_THROTTLE_MS%% ,
=%%- .
$num%%/ 2
;%%2 3
private'' 
readonly'' 
SecureTextBuffer'' %
_secureKeyBuffer''& 6
=''7 8
new''9 <
(''< =
)''= >
;''> ?
private(( 
readonly(( 
SecureTextBuffer(( %"
_verifySecureKeyBuffer((& <
=((= >
new((? B
(((B C
)((C D
;((D E
private)) 
readonly)) -
!IApplicationSecureStorageProvider)) 6-
!_applicationSecureStorageProvider))7 X
;))X Y
private** 
readonly** &
IOpaqueRegistrationService** / 
_registrationService**0 D
;**D E
private++ 
readonly++ "
IAuthenticationService++ +"
_authenticationService++, B
;++B C
private,, 
readonly,, %
ISecureKeyRecoveryService,, .%
_secureKeyRecoveryService,,/ H
;,,H I
private-- 
readonly-- %
AuthenticationFlowContext-- .
_flowContext--/ ;
;--; <
private// #
CancellationTokenSource// #
?//# $ 
_currentOperationCts//% 9
;//9 :
private00 
bool00 $
_hasSecureKeyBeenTouched00 )
;00) *
private11 
bool11 *
_hasVerifySecureKeyBeenTouched11 /
;11/ 0
private22 
bool22 
_isDisposed22 
;22 
public44 
&
SecureKeyVerifierViewModel44 %
(44% & 
IConnectivityService55 
connectivityService55 0
,550 1
NetworkProvider66 
networkProvider66 '
,66' ( 
ILocalizationService77 
localizationService77 0
,770 1
IScreen88 

hostScreen88 
,88 -
!IApplicationSecureStorageProvider99 ),
 applicationSecureStorageProvider99* J
,99J K&
IOpaqueRegistrationService:: "
registrationService::# 6
,::6 7"
IAuthenticationService;; !
authenticationService;; 4
,;;4 5%
ISecureKeyRecoveryService<< !$
secureKeyRecoveryService<<" :
,<<: ;%
AuthenticationFlowContext== !
flowContext==" -
)>> 
:>> 
base>> 
(>> 
networkProvider>> 
,>> 
localizationService>> 1
,>>1 2
connectivityService>>3 F
)>>F G
{?? 

HostScreen@@ 
=@@ 

hostScreen@@ 
;@@  -
!_applicationSecureStorageProviderAA )
=AA* +,
 applicationSecureStorageProviderAA, L
;AAL M 
_registrationServiceBB 
=BB 
registrationServiceBB 2
;BB2 3"
_authenticationServiceCC 
=CC  !
authenticationServiceCC! 6
;CC6 7%
_secureKeyRecoveryServiceDD !
=DD" #$
secureKeyRecoveryServiceDD$ <
;DD< =
_flowContextEE 
=EE 
flowContextEE "
;EE" #
LogGG 
.GG 
InformationGG 
(GG 
$strGG ]
,GG] ^
flowContextGG_ j
)GGj k
;GGk l
IObservableII 
<II 
boolII 
>II  
isFormLogicallyValidII .
=II/ 0
SetupValidationII1 @
(II@ A
)IIA B
;IIB C
SetupCommandsJJ 
(JJ  
isFormLogicallyValidJJ *
)JJ* +
;JJ+ ,
SetupSubscriptionsKK 
(KK 
)KK 
;KK 
}LL 
publicNN 

stringNN 
TitleNN 
=>NN 
LocalizeNN #
(NN# $
KeysNN$ (
.NN( )
REGISTRATION_TITLENN) ;
,NN; <
KeysNN= A
.NNA B
RECOVERY_TITLENNB P
)NNP Q
;NNQ R
publicOO 

stringOO 
DescriptionOO 
=>OO  
LocalizeOO! )
(OO) *
KeysOO* .
.OO. /$
REGISTRATION_DESCRIPTIONOO/ G
,OOG H
KeysOOI M
.OOM N 
RECOVERY_DESCRIPTIONOON b
)OOb c
;OOc d
publicPP 

stringPP  
SecureKeyPlaceholderPP &
=>PP' )
LocalizePP* 2
(PP2 3
KeysPP3 7
.PP7 8"
SECURE_KEY_PLACEHOLDERPP8 N
,PPN O
KeysPPP T
.PPT U+
RECOVERY_SECURE_KEY_PLACEHOLDERPPU t
)PPt u
;PPu v
publicQQ 

stringQQ 
SecureKeyHintQQ 
=>QQ  "
LocalizeQQ# +
(QQ+ ,
KeysQQ, 0
.QQ0 1
SECURE_KEY_HINTQQ1 @
,QQ@ A
KeysQQB F
.QQF G$
RECOVERY_SECURE_KEY_HINTQQG _
)QQ_ `
;QQ` a
publicSS 

stringSS &
VerifySecureKeyPlaceholderSS ,
=>SS- /
LocalizeTT 
(TT 
KeysTT 
.TT )
VERIFY_SECURE_KEY_PLACEHOLDERTT 3
,TT3 4
KeysTT5 9
.TT9 :2
&RECOVERY_VERIFY_SECURE_KEY_PLACEHOLDERTT: `
)TT` a
;TTa b
publicVV 

stringVV 
VerifySecureKeyHintVV %
=>VV& (
LocalizeVV) 1
(VV1 2
KeysVV2 6
.VV6 7"
VERIFY_SECURE_KEY_HINTVV7 M
,VVM N
KeysVVO S
.VVS T+
RECOVERY_VERIFY_SECURE_KEY_HINTVVT s
)VVs t
;VVt u
publicWW 

stringWW 

ButtonTextWW 
=>WW 
LocalizeWW  (
(WW( )
KeysWW) -
.WW- .
REGISTRATION_BUTTONWW. A
,WWA B
KeysWWC G
.WWG H
RECOVERY_BUTTONWWH W
)WWW X
;WWX Y
publicYY 

stringYY 
UrlPathSegmentYY  
=>YY! #
$strYY$ >
;YY> ?
publicZZ 

IScreenZZ 

HostScreenZZ 
{ZZ 
getZZ  #
;ZZ# $
}ZZ% &
public\\ 

int\\ "
CurrentSecureKeyLength\\ %
=>\\& (
_secureKeyBuffer\\) 9
.\\9 :
Length\\: @
;\\@ A
public]] 

int]] (
CurrentVerifySecureKeyLength]] +
=>]], ."
_verifySecureKeyBuffer]]/ E
.]]E F
Length]]F L
;]]L M
public__ 

ReactiveCommand__ 
<__ 
SystemU__ "
,__" #
SystemU__$ +
>__+ ,
SubmitCommand__- :
{__; <
get__= @
;__@ A
private__B I
set__J M
;__M N
}__O P
=__Q R
null__S W
!__W X
;__X Y
[aa 
Reactiveaa 
]aa 
publicaa 
stringaa 
?aa 
SecureKeyErroraa ,
{aa- .
getaa/ 2
;aa2 3
privateaa4 ;
setaa< ?
;aa? @
}aaA B
[bb 
Reactivebb 
]bb 
publicbb 
boolbb 
HasSecureKeyErrorbb ,
{bb- .
getbb/ 2
;bb2 3
privatebb4 ;
setbb< ?
;bb? @
}bbA B
[cc 
Reactivecc 
]cc 
publiccc 
stringcc 
?cc  
VerifySecureKeyErrorcc 2
{cc3 4
getcc5 8
;cc8 9
privatecc: A
setccB E
;ccE F
}ccG H
[dd 
Reactivedd 
]dd 
publicdd 
booldd #
HasVerifySecureKeyErrordd 2
{dd3 4
getdd5 8
;dd8 9
privatedd: A
setddB E
;ddE F
}ddG H
[ee 
Reactiveee 
]ee 
publicee 
stringee 
?ee 
ServerErroree )
{ee* +
getee, /
;ee/ 0
privateee1 8
setee9 <
;ee< =
}ee> ?
[ff 
Reactiveff 
]ff 
publicff 
boolff 
HasServerErrorff )
{ff* +
getff, /
;ff/ 0
privateff1 8
setff9 <
;ff< =
}ff> ?
[gg  
ObservableAsPropertygg 
]gg 
publicgg !
boolgg" &
	CanSubmitgg' 0
{gg1 2
getgg3 6
;gg6 7
}gg8 9
[ii  
ObservableAsPropertyii 
]ii 
publicii !
SecureKeyStrengthii" 3$
CurrentSecureKeyStrengthii4 L
{iiM N
getiiO R
;iiR S
privateiiT [
setii\ _
;ii_ `
}iia b
[jj  
ObservableAsPropertyjj 
]jj 
publicjj !
stringjj" (
?jj( )$
SecureKeyStrengthMessagejj* B
{jjC D
getjjE H
;jjH I
privatejjJ Q
setjjR U
;jjU V
}jjW X
[kk  
ObservableAsPropertykk 
]kk 
publickk !
boolkk" &#
HasSecureKeyBeenTouchedkk' >
{kk? @
getkkA D
;kkD E
privatekkF M
setkkN Q
;kkQ R
}kkS T
[ll  
ObservableAsPropertyll 
]ll 
publicll !
boolll" &
IsBusyll' -
{ll. /
getll0 3
;ll3 4
}ll5 6
[nn 
Reactivenn 
]nn 
publicnn 
boolnn 
IsMembershipLoadingnn .
{nn/ 0
getnn1 4
;nn4 5
privatenn6 =
setnn> A
;nnA B
}nnC D
=nnE F
truennG K
;nnK L
privatepp 

ByteStringpp 
?pp 
MembershipUniqueIdpp *
{pp+ ,
getpp- 0
;pp0 1
setpp2 5
;pp5 6
}pp7 8
privaterr 
voidrr 
SetupCommandsrr 
(rr 
IObservablerr *
<rr* +
boolrr+ /
>rr/ 0 
isFormLogicallyValidrr1 E
)rrE F
{ss 
IObservablett 
<tt 
booltt 
>tt 
canExecuteSubmittt *
=tt+ ,
thistt- 1
.tt1 2
WhenAnyValuett2 >
(tt> ?
xuu 
=>uu 
xuu 
.uu 
IsBusyuu 
,uu 
xvv 
=>vv 
xvv 
.vv 
IsInNetworkOutagevv (
,vv( )
xww 
=>ww 
xww 
.ww 
IsMembershipLoadingww *
,ww* +
(xx 
isBusyxx 
,xx 

isInOutagexx #
,xx# $
isMembershipLoadingxx% 8
)xx8 9
=>xx: <
!xx= >
isBusyxx> D
&&xxE G
!xxH I

isInOutagexxI S
&&xxT V
!xxW X
isMembershipLoadingxxX k
)xxk l
.yy 
CombineLatestyy 
(yy  
isFormLogicallyValidyy /
,yy/ 0
(yy1 2

canExecuteyy2 <
,yy< =
isValidyy> E
)yyE F
=>yyG I

canExecuteyyJ T
&&yyU W
isValidyyX _
)yy_ `
;yy` a
SubmitCommand{{ 
={{ 
ReactiveCommand{{ '
.{{' (
CreateFromTask{{( 6
({{6 7
SubmitAsync{{7 B
,{{B C
canExecuteSubmit{{D T
){{T U
;{{U V
SubmitCommand|| 
.|| 
IsExecuting|| !
.||! "
ToPropertyEx||" .
(||. /
this||/ 3
,||3 4
x||5 6
=>||7 9
x||: ;
.||; <
IsBusy||< B
)||B C
;||C D
canExecuteSubmit}} 
.}} 
ToPropertyEx}} %
(}}% &
this}}& *
,}}* +
x}}, -
=>}}. 0
x}}1 2
.}}2 3
	CanSubmit}}3 <
)}}< =
;}}= >
}~~ 
private
€€ 
void
€€  
SetupSubscriptions
€€ #
(
€€# $
)
€€$ %
{
 
this
‚‚ 
.
‚‚ 
WhenActivated
‚‚ 
(
‚‚ 
disposables
‚‚ &
=>
‚‚' )
{
ƒƒ 	

Observable
„„ 
.
„„ 
	FromAsync
„„  
(
„„  !!
LoadMembershipAsync
„„! 4
)
„„4 5
.
…… 
	Subscribe
…… 
(
…… 
result
†† 
=>
†† 
{
‡‡ !
IsMembershipLoading
ˆˆ +
=
ˆˆ, -
false
ˆˆ. 3
;
ˆˆ3 4
if
ŠŠ 
(
ŠŠ 
!
ŠŠ 
result
ŠŠ #
.
ŠŠ# $
IsErr
ŠŠ$ )
)
ŠŠ) *
{
‹‹ 
return
ŒŒ "
;
ŒŒ" #
}
 
(
 
(
 %
AuthenticationViewModel
 1
)
1 2

HostScreen
2 <
)
< =
.
= >"
ClearNavigationStack
> R
(
R S
)
S T
;
T U
(
 
(
 %
AuthenticationViewModel
 1
)
1 2

HostScreen
2 <
)
< =
.
= >
Navigate
> F
.
F G
Execute
G N
(
N O 
MembershipViewType
O a
.
a b
WELCOME_VIEW
b n
)
n o
;
o p
}
‘‘ 
,
‘‘ 
error
’’ 
=>
’’ 
{
““ !
IsMembershipLoading
”” +
=
””, -
false
””. 3
;
””3 4
Log
•• 
.
•• 
Error
•• !
(
••! "
error
••" '
,
••' (
$str
••) e
)
••e f
;
••f g
(
–– 
(
–– %
AuthenticationViewModel
–– 1
)
––1 2

HostScreen
––2 <
)
––< =
.
––= >"
ClearNavigationStack
––> R
(
––R S
)
––S T
;
––T U
(
—— 
(
—— %
AuthenticationViewModel
—— 1
)
——1 2

HostScreen
——2 <
)
——< =
.
——= >
Navigate
——> F
.
——F G
Execute
——G N
(
——N O 
MembershipViewType
——O a
.
——a b
WELCOME_VIEW
——b n
)
——n o
;
——o p
}
˜˜ 
)
˜˜ 
.
™™ 
DisposeWith
™™ 
(
™™ 
disposables
™™ (
)
™™( )
;
™™) *
this
›› 
.
›› 
WhenAnyValue
›› 
(
›› 
x
›› 
=>
››  "
x
››# $
.
››$ %
ServerError
››% 0
)
››0 1
.
œœ "
DistinctUntilChanged
œœ %
(
œœ% &
)
œœ& '
.
 
	Subscribe
 
(
 
err
 
=>
žž 
{
ŸŸ 
HasServerError
   "
=
  # $
!
  % &
string
  & ,
.
  , -
IsNullOrEmpty
  - :
(
  : ;
err
  ; >
)
  > ?
;
  ? @
if
¡¡ 
(
¡¡ 
!
¡¡ 
string
¡¡ 
.
¡¡  
IsNullOrEmpty
¡¡  -
(
¡¡- .
err
¡¡. 1
)
¡¡1 2
&&
¡¡3 5

HostScreen
¡¡6 @
is
¡¡A C%
AuthenticationViewModel
¡¡D [

hostWindow
¡¡\ f
)
¡¡f g
{
¢¢ )
ShowServerErrorNotification
££ 3
(
££3 4

hostWindow
££4 >
,
££> ?
err
££@ C
)
££C D
;
££D E
}
¤¤ 
}
¥¥ 
)
¥¥ 
.
¦¦ 
DisposeWith
¦¦ 
(
¦¦ 
disposables
¦¦ (
)
¦¦( )
;
¦¦) *
SubmitCommand
¨¨ 
.
©© 
Where
©© 
(
©© 
_
©© 
=>
©© 
!
©© 
IsBusy
©© #
&&
©©$ &
	CanSubmit
©©' 0
)
©©0 1
.
ªª 
	Subscribe
ªª 
(
ªª 
_
ªª 
=>
ªª 
{
«« 
(
¬¬ 
(
¬¬ %
AuthenticationViewModel
¬¬ -
)
¬¬- .

HostScreen
¬¬. 8
)
¬¬8 9
.
¬¬9 :"
ClearNavigationStack
¬¬: N
(
¬¬N O
true
¬¬O S
)
¬¬S T
;
¬¬T U
(
­­ 
(
­­ %
AuthenticationViewModel
­­ -
)
­­- .

HostScreen
­­. 8
)
­­8 9
.
­­9 :
Navigate
­­: B
.
­­B C
Execute
­­C J
(
­­J K 
MembershipViewType
­­K ]
.
­­] ^
PIN_SET_VIEW
­­^ j
)
­­j k
;
­­k l
}
®® 
)
®® 
.
¯¯ 
DisposeWith
¯¯ 
(
¯¯ 
disposables
¯¯ (
)
¯¯( )
;
¯¯) *
}
°° 	
)
°°	 

;
°°
 
}
±± 
public
³³ 

void
³³ "
InsertSecureKeyChars
³³ $
(
³³$ %
int
³³% (
index
³³) .
,
³³. /
string
³³0 6
chars
³³7 <
)
³³< =
{
´´ 
if
µµ 

(
µµ 
!
µµ &
_hasSecureKeyBeenTouched
µµ %
)
µµ% &
{
¶¶ 	&
_hasSecureKeyBeenTouched
·· $
=
··% &
true
··' +
;
··+ ,
}
¸¸ 	
_secureKeyBuffer
ºº 
.
ºº 
Insert
ºº 
(
ºº  
index
ºº  %
,
ºº% &
chars
ºº' ,
)
ºº, -
;
ºº- .
this
»» 
.
»» "
RaisePropertyChanged
»» !
(
»»! "
nameof
»»" (
(
»»( )$
CurrentSecureKeyLength
»») ?
)
»»? @
)
»»@ A
;
»»A B
}
¼¼ 
public
¾¾ 

void
¾¾ "
RemoveSecureKeyChars
¾¾ $
(
¾¾$ %
int
¾¾% (
index
¾¾) .
,
¾¾. /
int
¾¾0 3
count
¾¾4 9
)
¾¾9 :
{
¿¿ 
if
ÀÀ 

(
ÀÀ 
!
ÀÀ &
_hasSecureKeyBeenTouched
ÀÀ %
)
ÀÀ% &
{
ÁÁ 	&
_hasSecureKeyBeenTouched
ÂÂ $
=
ÂÂ% &
true
ÂÂ' +
;
ÂÂ+ ,
}
ÃÃ 	
_secureKeyBuffer
ÅÅ 
.
ÅÅ 
Remove
ÅÅ 
(
ÅÅ  
index
ÅÅ  %
,
ÅÅ% &
count
ÅÅ' ,
)
ÅÅ, -
;
ÅÅ- .
this
ÆÆ 
.
ÆÆ "
RaisePropertyChanged
ÆÆ !
(
ÆÆ! "
nameof
ÆÆ" (
(
ÆÆ( )$
CurrentSecureKeyLength
ÆÆ) ?
)
ÆÆ? @
)
ÆÆ@ A
;
ÆÆA B
}
ÇÇ 
public
ÉÉ 

void
ÉÉ (
InsertVerifySecureKeyChars
ÉÉ *
(
ÉÉ* +
int
ÉÉ+ .
index
ÉÉ/ 4
,
ÉÉ4 5
string
ÉÉ6 <
chars
ÉÉ= B
)
ÉÉB C
{
ÊÊ 
if
ËË 

(
ËË 
!
ËË ,
_hasVerifySecureKeyBeenTouched
ËË +
)
ËË+ ,
{
ÌÌ 	,
_hasVerifySecureKeyBeenTouched
ÍÍ *
=
ÍÍ+ ,
true
ÍÍ- 1
;
ÍÍ1 2
}
ÎÎ 	$
_verifySecureKeyBuffer
ÐÐ 
.
ÐÐ 
Insert
ÐÐ %
(
ÐÐ% &
index
ÐÐ& +
,
ÐÐ+ ,
chars
ÐÐ- 2
)
ÐÐ2 3
;
ÐÐ3 4
this
ÑÑ 
.
ÑÑ "
RaisePropertyChanged
ÑÑ !
(
ÑÑ! "
nameof
ÑÑ" (
(
ÑÑ( )*
CurrentVerifySecureKeyLength
ÑÑ) E
)
ÑÑE F
)
ÑÑF G
;
ÑÑG H
}
ÒÒ 
public
ÔÔ 

void
ÔÔ (
RemoveVerifySecureKeyChars
ÔÔ *
(
ÔÔ* +
int
ÔÔ+ .
index
ÔÔ/ 4
,
ÔÔ4 5
int
ÔÔ6 9
count
ÔÔ: ?
)
ÔÔ? @
{
ÕÕ 
if
ÖÖ 

(
ÖÖ 
!
ÖÖ ,
_hasVerifySecureKeyBeenTouched
ÖÖ +
)
ÖÖ+ ,
{
×× 	,
_hasVerifySecureKeyBeenTouched
ØØ *
=
ØØ+ ,
true
ØØ- 1
;
ØØ1 2
}
ÙÙ 	$
_verifySecureKeyBuffer
ÛÛ 
.
ÛÛ 
Remove
ÛÛ %
(
ÛÛ% &
index
ÛÛ& +
,
ÛÛ+ ,
count
ÛÛ- 2
)
ÛÛ2 3
;
ÛÛ3 4
this
ÜÜ 
.
ÜÜ "
RaisePropertyChanged
ÜÜ !
(
ÜÜ! "
nameof
ÜÜ" (
(
ÜÜ( )*
CurrentVerifySecureKeyLength
ÜÜ) E
)
ÜÜE F
)
ÜÜF G
;
ÜÜG H
}
ÝÝ 
public
ßß 

async
ßß 
Task
ßß &
HandleEnterKeyPressAsync
ßß .
(
ßß. /
)
ßß/ 0
{
àà 
if
áá 

(
áá 
await
áá 
SubmitCommand
áá 
.
áá  

CanExecute
áá  *
.
áá* +!
FirstOrDefaultAsync
áá+ >
(
áá> ?
)
áá? @
)
áá@ A
{
ââ 	
SubmitCommand
ãã 
.
ãã 
Execute
ãã !
(
ãã! "
)
ãã" #
.
ãã# $
	Subscribe
ãã$ -
(
ãã- .
)
ãã. /
;
ãã/ 0
}
ää 	
}
åå 
public
çç 

void
çç 

ResetState
çç 
(
çç 
)
çç 
{
èè 
_secureKeyBuffer
éé 
.
éé 
Remove
éé 
(
éé  
$num
éé  !
,
éé! "
_secureKeyBuffer
éé# 3
.
éé3 4
Length
éé4 :
)
éé: ;
;
éé; <$
_verifySecureKeyBuffer
êê 
.
êê 
Remove
êê %
(
êê% &
$num
êê& '
,
êê' ($
_verifySecureKeyBuffer
êê) ?
.
êê? @
Length
êê@ F
)
êêF G
;
êêG H&
_hasSecureKeyBeenTouched
ëë  
=
ëë! "
false
ëë# (
;
ëë( ),
_hasVerifySecureKeyBeenTouched
ìì &
=
ìì' (
false
ìì) .
;
ìì. /
SecureKeyError
îî 
=
îî 
string
îî 
.
îî  
Empty
îî  %
;
îî% &
HasSecureKeyError
ïï 
=
ïï 
false
ïï !
;
ïï! ""
VerifySecureKeyError
ðð 
=
ðð 
string
ðð %
.
ðð% &
Empty
ðð& +
;
ðð+ ,%
HasVerifySecureKeyError
ññ 
=
ññ  !
false
ññ" '
;
ññ' (
ServerError
óó 
=
óó 
string
óó 
.
óó 
Empty
óó "
;
óó" #
HasServerError
ôô 
=
ôô 
false
ôô 
;
ôô !
IsMembershipLoading
öö 
=
öö 
true
öö "
;
öö" # 
MembershipUniqueId
÷÷ 
=
÷÷ 
null
÷÷ !
;
÷÷! "
}
øø 
private
úú 
string
úú 
Localize
úú 
(
úú 
string
úú "
registrationKey
úú# 2
,
úú2 3
string
úú4 :
recoveryKey
úú; F
)
úúF G
=>
úúH J&
GetSecureKeyLocalization
ûû  
(
ûû  !
_flowContext
ûû! -
,
ûû- .
registrationKey
ûû/ >
,
ûû> ?
recoveryKey
ûû@ K
)
ûûK L
;
ûûL M
private
ýý 
async
ýý 
Task
ýý 
<
ýý 
Result
ýý 
<
ýý 
Unit
ýý "
,
ýý" #'
InternalServiceApiFailure
ýý$ =
>
ýý= >
>
ýý> ?!
LoadMembershipAsync
ýý@ S
(
ýýS T
)
ýýT U
{
þþ 
Result
ÿÿ 
<
ÿÿ )
ApplicationInstanceSettings
ÿÿ *
,
ÿÿ* +'
InternalServiceApiFailure
ÿÿ, E
>
ÿÿE F!
applicationInstance
ÿÿG Z
=
ÿÿ[ \
await
€€ /
!_applicationSecureStorageProvider
€€ 3
.
€€3 41
#GetApplicationInstanceSettingsAsync
€€4 W
(
€€W X
)
€€X Y
;
€€Y Z
if
‚‚ 

(
‚‚ !
applicationInstance
‚‚ 
.
‚‚  
IsErr
‚‚  %
)
‚‚% &
{
ƒƒ 	
return
„„ 
Result
„„ 
<
„„ 
Unit
„„ 
,
„„ '
InternalServiceApiFailure
„„  9
>
„„9 :
.
„„: ;
Err
„„; >
(
„„> ?!
applicationInstance
„„? R
.
„„R S
	UnwrapErr
„„S \
(
„„\ ]
)
„„] ^
)
„„^ _
;
„„_ `
}
…… 	)
ApplicationInstanceSettings
‡‡ #
settings
‡‡$ ,
=
‡‡- .!
applicationInstance
‡‡/ B
.
‡‡B C
Unwrap
‡‡C I
(
‡‡I J
)
‡‡J K
;
‡‡K L
if
‰‰ 

(
‰‰ 
settings
‰‰ 
.
‰‰ 

Membership
‰‰ 
==
‰‰  "
null
‰‰# '
)
‰‰' (
{
ŠŠ 	
return
‹‹ 
Result
‹‹ 
<
‹‹ 
Unit
‹‹ 
,
‹‹ '
InternalServiceApiFailure
‹‹  9
>
‹‹9 :
.
‹‹: ;
Err
‹‹; >
(
‹‹> ?'
InternalServiceApiFailure
ŒŒ )
.
ŒŒ) *$
SecureStoreKeyNotFound
ŒŒ* @
(
ŒŒ@ A
$str
 h
)
h i
)
i j
;
j k
}
ŽŽ 	
if
 

(
 
settings
 
.
 

Membership
 
.
  
UniqueIdentifier
  0
==
1 3
null
4 8
||
9 ;
settings
< D
.
D E

Membership
E O
.
O P
UniqueIdentifier
P `
.
` a
IsEmpty
a h
)
h i
{
‘‘ 	
return
’’ 
Result
’’ 
<
’’ 
Unit
’’ 
,
’’ '
InternalServiceApiFailure
’’  9
>
’’9 :
.
’’: ;
Err
’’; >
(
’’> ?'
InternalServiceApiFailure
““ )
.
““) *$
SecureStoreKeyNotFound
““* @
(
““@ A
$str
”” o
)
””o p
)
””p q
;
””q r
}
•• 	 
MembershipUniqueId
—— 
=
—— 
settings
—— %
.
——% &

Membership
——& 0
.
——0 1
UniqueIdentifier
——1 A
;
——A B
return
˜˜ 
Result
˜˜ 
<
˜˜ 
Unit
˜˜ 
,
˜˜ '
InternalServiceApiFailure
˜˜ 5
>
˜˜5 6
.
˜˜6 7
Ok
˜˜7 9
(
˜˜9 :
Unit
˜˜: >
.
˜˜> ?
Value
˜˜? D
)
˜˜D E
;
˜˜E F
}
™™ 
private
›› 
IObservable
›› 
<
›› 
bool
›› 
>
›› 
SetupValidation
›› -
(
››- .
)
››. /
{
œœ 
IObservable
 
<
 
SystemU
 
>
 
languageTrigger
 ,
=
- .
LanguageChanged
/ >
;
> ?
IObservable
ŸŸ 
<
ŸŸ 
SystemU
ŸŸ 
>
ŸŸ 
lengthTrigger
ŸŸ *
=
ŸŸ+ ,
this
ŸŸ- 1
.
   
WhenAnyValue
   
(
   
x
   
=>
   
x
    
.
    !$
CurrentSecureKeyLength
  ! 7
,
  7 8
x
  9 :
=>
  ; =
x
  > ?
.
  ? @*
CurrentVerifySecureKeyLength
  @ \
)
  \ ]
.
¡¡ 
Select
¡¡ 
(
¡¡ 
_
¡¡ 
=>
¡¡ 
SystemU
¡¡  
.
¡¡  !
Default
¡¡! (
)
¡¡( )
;
¡¡) *
IObservable
££ 
<
££ 
SystemU
££ 
>
££ 
validationTrigger
££ .
=
££/ 0
lengthTrigger
££1 >
.
££> ?
Merge
££? D
(
££D E
languageTrigger
££E T
)
££T U
;
££U V
IObservable
¥¥ 
<
¥¥ 
bool
¥¥ 
>
¥¥ '
isSecureKeyLogicallyValid
¥¥ 3
=
¥¥4 5&
SetupSecureKeyValidation
¥¥6 N
(
¥¥N O
validationTrigger
¥¥O `
)
¥¥` a
;
¥¥a b
IObservable
¦¦ 
<
¦¦ 
bool
¦¦ 
>
¦¦ 
secureKeysMatch
¦¦ )
=
¦¦* +&
SetupVerifyKeyValidation
¦¦, D
(
¦¦D E
validationTrigger
¦¦E V
)
¦¦V W
;
¦¦W X
return
¨¨ '
isSecureKeyLogicallyValid
¨¨ (
.
©© 
CombineLatest
©© 
(
©© 
secureKeysMatch
©© *
,
©©* +
(
©©, -
isSecureKeyValid
©©- =
,
©©= >
areMatching
©©? J
)
©©J K
=>
©©L N
isSecureKeyValid
©©O _
&&
©©` b
areMatching
©©c n
)
©©n o
.
ªª "
DistinctUntilChanged
ªª !
(
ªª! "
)
ªª" #
;
ªª# $
}
«« 
private
­­ 
IObservable
­­ 
<
­­ 
bool
­­ 
>
­­ &
SetupSecureKeyValidation
­­ 6
(
­­6 7
IObservable
­­7 B
<
­­B C
SystemU
­­C J
>
­­J K
validationTrigger
­­L ]
)
­­] ^
{
®® 
IObservable
¯¯ 
<
¯¯ 
(
¯¯ 
string
¯¯ 
?
¯¯ 
ERROR
¯¯ "
,
¯¯" #
string
¯¯$ *
Recommendations
¯¯+ :
,
¯¯: ;
SecureKeyStrength
¯¯< M
Strength
¯¯N V
)
¯¯V W
>
¯¯W X!
secureKeyValidation
¯¯Y l
=
¯¯m n
validationTrigger
°° 
.
±± 
Select
±± 
(
±± 
_
±± 
=>
±± +
ValidateSecureKeyWithStrength
±± :
(
±±: ;
)
±±; <
)
±±< =
.
²² 
Replay
²² 
(
²² 
$num
²² 
)
²² 
.
³³ 
RefCount
³³ 
(
³³ 
)
³³ 
;
³³ !
secureKeyValidation
µµ 
.
µµ 
Select
µµ "
(
µµ" #
v
µµ# $
=>
µµ% '
v
µµ( )
.
µµ) *
Strength
µµ* 2
)
µµ2 3
.
µµ3 4
ToPropertyEx
µµ4 @
(
µµ@ A
this
µµA E
,
µµE F
x
µµG H
=>
µµI K
x
µµL M
.
µµM N&
CurrentSecureKeyStrength
µµN f
)
µµf g
;
µµg h!
secureKeyValidation
¶¶ 
.
¶¶ 
Select
¶¶ "
(
¶¶" #
v
¶¶# $
=>
¶¶% '&
_hasSecureKeyBeenTouched
·· (
?
¸¸ ,
FormatSecureKeyStrengthMessage
¸¸ 4
(
¸¸4 5
v
¸¸5 6
.
¸¸6 7
Strength
¸¸7 ?
,
¸¸? @
v
¸¸A B
.
¸¸B C
ERROR
¸¸C H
,
¸¸H I
v
¸¸J K
.
¸¸K L
Recommendations
¸¸L [
)
¸¸[ \
:
¹¹ 
string
¹¹ 
.
¹¹ 
Empty
¹¹ "
)
¹¹" #
.
ºº 
ToPropertyEx
ºº 
(
ºº 
this
ºº 
,
ºº 
x
ºº  !
=>
ºº" $
x
ºº% &
.
ºº& '&
SecureKeyStrengthMessage
ºº' ?
)
ºº? @
;
ºº@ A
this
¼¼ 
.
¼¼ 
WhenAnyValue
¼¼ 
(
¼¼ 
x
¼¼ 
=>
¼¼ 
x
¼¼  
.
¼¼  !$
CurrentSecureKeyLength
¼¼! 7
)
¼¼7 8
.
½½ 
Select
½½ 
(
½½ 
_
½½ 
=>
½½ &
_hasSecureKeyBeenTouched
½½ 1
)
½½1 2
.
¾¾ 
ToPropertyEx
¾¾ 
(
¾¾ 
this
¾¾ 
,
¾¾ 
x
¾¾  !
=>
¾¾" $
x
¾¾% &
.
¾¾& '%
HasSecureKeyBeenTouched
¾¾' >
)
¾¾> ?
;
¾¾? @
this
ÀÀ 
.
ÀÀ 
WhenAnyValue
ÀÀ 
(
ÀÀ 
x
ÀÀ 
=>
ÀÀ 
x
ÀÀ  
.
ÀÀ  !&
SecureKeyStrengthMessage
ÀÀ! 9
)
ÀÀ9 :
.
ÁÁ 
	Subscribe
ÁÁ 
(
ÁÁ 
message
ÁÁ 
=>
ÁÁ !
SecureKeyError
ÁÁ" 0
=
ÁÁ1 2
message
ÁÁ3 :
)
ÁÁ: ;
;
ÁÁ; <
this
ÂÂ 
.
ÂÂ 
WhenAnyValue
ÂÂ 
(
ÂÂ 
x
ÂÂ 
=>
ÂÂ 
x
ÂÂ  
.
ÂÂ  !
SecureKeyError
ÂÂ! /
)
ÂÂ/ 0
.
ÃÃ 
Select
ÃÃ 
(
ÃÃ 
e
ÃÃ 
=>
ÃÃ 
!
ÃÃ 
string
ÃÃ  
.
ÃÃ  !
IsNullOrEmpty
ÃÃ! .
(
ÃÃ. /
e
ÃÃ/ 0
)
ÃÃ0 1
)
ÃÃ1 2
.
ÄÄ 
	Subscribe
ÄÄ 
(
ÄÄ 
flag
ÄÄ 
=>
ÄÄ 
HasSecureKeyError
ÄÄ 0
=
ÄÄ1 2
flag
ÄÄ3 7
)
ÄÄ7 8
;
ÄÄ8 9
return
ÆÆ !
secureKeyValidation
ÆÆ "
.
ÆÆ" #
Select
ÆÆ# )
(
ÆÆ) *
v
ÆÆ* +
=>
ÆÆ, .
string
ÆÆ/ 5
.
ÆÆ5 6
IsNullOrEmpty
ÆÆ6 C
(
ÆÆC D
v
ÆÆD E
.
ÆÆE F
ERROR
ÆÆF K
)
ÆÆK L
)
ÆÆL M
;
ÆÆM N
}
ÇÇ 
private
ÉÉ 
IObservable
ÉÉ 
<
ÉÉ 
bool
ÉÉ 
>
ÉÉ &
SetupVerifyKeyValidation
ÉÉ 6
(
ÉÉ6 7
IObservable
ÉÉ7 B
<
ÉÉB C
SystemU
ÉÉC J
>
ÉÉJ K
validationTrigger
ÉÉL ]
)
ÉÉ] ^
{
ÊÊ 
IObservable
ËË 
<
ËË 
bool
ËË 
>
ËË 
secureKeysMatch
ËË )
=
ËË* +
validationTrigger
ËË, =
.
ÌÌ 
Select
ÌÌ 
(
ÌÌ 
_
ÌÌ 
=>
ÌÌ 
DoSecureKeysMatch
ÌÌ *
(
ÌÌ* +
)
ÌÌ+ ,
)
ÌÌ, -
.
ÍÍ 
Replay
ÍÍ 
(
ÍÍ 
$num
ÍÍ 
)
ÍÍ 
.
ÎÎ 
RefCount
ÎÎ 
(
ÎÎ 
)
ÎÎ 
;
ÎÎ 
IObservable
ÐÐ 
<
ÐÐ 
string
ÐÐ 
>
ÐÐ (
verifySecureKeyErrorStream
ÐÐ 6
=
ÐÐ7 8
secureKeysMatch
ÐÐ9 H
.
ÑÑ 
Select
ÑÑ 
(
ÑÑ 
match
ÑÑ 
=>
ÑÑ 
{
ÒÒ 
bool
ÓÓ 
shouldShowError
ÓÓ $
=
ÓÓ% &,
_hasVerifySecureKeyBeenTouched
ÓÓ' E
&&
ÓÓF H
!
ÓÓI J
match
ÓÓJ O
;
ÓÓO P
return
ÕÕ 
shouldShowError
ÕÕ &
?
ÖÖ !
LocalizationService
ÖÖ )
[
ÖÖ) *%
AuthenticationConstants
ÖÖ* A
.
ÖÖA B2
$VERIFY_SECURE_KEY_DOES_NOT_MATCH_KEY
ÖÖB f
]
ÖÖf g
:
×× 
string
×× 
.
×× 
Empty
×× "
;
××" #
}
ØØ 
)
ØØ 
.
ÙÙ "
DistinctUntilChanged
ÙÙ !
(
ÙÙ! "
)
ÙÙ" #
.
ÚÚ 
Throttle
ÚÚ 
(
ÚÚ 
TimeSpan
ÚÚ 
.
ÚÚ 
FromMilliseconds
ÚÚ /
(
ÚÚ/ 0$
VALIDATION_THROTTLE_MS
ÚÚ0 F
)
ÚÚF G
)
ÚÚG H
.
ÛÛ 
	ObserveOn
ÛÛ 
(
ÛÛ 
RxApp
ÛÛ 
.
ÛÛ !
MainThreadScheduler
ÛÛ 0
)
ÛÛ0 1
.
ÜÜ 
Replay
ÜÜ 
(
ÜÜ 
$num
ÜÜ 
)
ÜÜ 
.
ÝÝ 
RefCount
ÝÝ 
(
ÝÝ 
)
ÝÝ 
;
ÝÝ (
verifySecureKeyErrorStream
ßß "
.
àà "
DistinctUntilChanged
àà !
(
àà! "
)
àà" #
.
áá 
	Subscribe
áá 
(
áá 
error
áá 
=>
áá "
VerifySecureKeyError
áá  4
=
áá5 6
error
áá7 <
)
áá< =
;
áá= >
this
ãã 
.
ãã 
WhenAnyValue
ãã 
(
ãã 
x
ãã 
=>
ãã 
x
ãã  
.
ãã  !"
VerifySecureKeyError
ãã! 5
)
ãã5 6
.
ää 
Select
ää 
(
ää 
e
ää 
=>
ää 
!
ää 
string
ää  
.
ää  !
IsNullOrEmpty
ää! .
(
ää. /
e
ää/ 0
)
ää0 1
)
ää1 2
.
åå 
	Subscribe
åå 
(
åå 
flag
åå 
=>
åå %
HasVerifySecureKeyError
åå 6
=
åå7 8
flag
åå9 =
)
åå= >
;
åå> ?
return
çç 
secureKeysMatch
çç 
;
çç 
}
èè 
private
êê 
(
êê 
string
êê 
?
êê 
ERROR
êê 
,
êê 
string
êê "
Recommendations
êê# 2
,
êê2 3
SecureKeyStrength
êê4 E
Strength
êêF N
)
êêN O+
ValidateSecureKeyWithStrength
êêP m
(
êêm n
)
êên o
{
ëë 
string
ìì 
?
ìì 
error
ìì 
=
ìì 
null
ìì 
;
ìì 
string
íí 
recommendations
íí 
=
íí  
string
íí! '
.
íí' (
Empty
íí( -
;
íí- .
SecureKeyStrength
îî 
strength
îî "
=
îî# $
SecureKeyStrength
îî% 6
.
îî6 7
INVALID
îî7 >
;
îî> ?
_secureKeyBuffer
ðð 
.
ðð 
WithSecureBytes
ðð (
(
ðð( )
bytes
ðð) .
=>
ðð/ 1
{
ññ 	
string
òò 
	secureKey
òò 
=
òò 
Encoding
òò '
.
òò' (
UTF8
òò( ,
.
òò, -
	GetString
òò- 6
(
òò6 7
bytes
òò7 <
)
òò< =
;
òò= >
(
óó 
error
óó 
,
óó 
List
óó 
<
óó 
string
óó 
>
óó  
recs
óó! %
)
óó% &
=
óó' ( 
SecureKeyValidator
óó) ;
.
óó; <
Validate
óó< D
(
óóD E
	secureKey
óóE N
,
óóN O!
LocalizationService
óóP c
)
óóc d
;
óód e
strength
ôô 
=
ôô  
SecureKeyValidator
ôô )
.
ôô) *'
EstimateSecureKeyStrength
ôô* C
(
ôôC D
	secureKey
ôôD M
,
ôôM N!
LocalizationService
ôôO b
)
ôôb c
;
ôôc d
if
õõ 
(
õõ 
recs
õõ 
.
õõ 
Count
õõ 
>
õõ 
$num
õõ 
)
õõ 
{
öö 
recommendations
÷÷ 
=
÷÷  !
recs
÷÷" &
[
÷÷& '
$num
÷÷' (
]
÷÷( )
;
÷÷) *
}
øø 
}
ùù 	
)
ùù	 

;
ùù
 
return
úú 
(
úú 
error
úú 
,
úú 
recommendations
úú &
,
úú& '
strength
úú( 0
)
úú0 1
;
úú1 2
}
ûû 
private
ýý 
bool
ýý 
DoSecureKeysMatch
ýý "
(
ýý" #
)
ýý# $
{
þþ 
if
ÿÿ 

(
ÿÿ 
_secureKeyBuffer
ÿÿ 
.
ÿÿ 
Length
ÿÿ #
!=
ÿÿ$ &$
_verifySecureKeyBuffer
ÿÿ' =
.
ÿÿ= >
Length
ÿÿ> D
)
ÿÿD E
{
€€ 	
return
 
false
 
;
 
}
‚‚ 	
if
„„ 

(
„„ 
_secureKeyBuffer
„„ 
.
„„ 
Length
„„ #
==
„„$ &
$num
„„' (
)
„„( )
{
…… 	
return
†† 
true
†† 
;
†† 
}
‡‡ 	
int
‰‰ 
length
‰‰ 
=
‰‰ 
_secureKeyBuffer
‰‰ %
.
‰‰% &
Length
‰‰& ,
;
‰‰, -
byte
ŠŠ 
[
ŠŠ 
]
ŠŠ 
secureKeyArray
ŠŠ 
=
ŠŠ 
	ArrayPool
ŠŠ  )
<
ŠŠ) *
byte
ŠŠ* .
>
ŠŠ. /
.
ŠŠ/ 0
Shared
ŠŠ0 6
.
ŠŠ6 7
Rent
ŠŠ7 ;
(
ŠŠ; <
length
ŠŠ< B
)
ŠŠB C
;
ŠŠC D
byte
‹‹ 
[
‹‹ 
]
‹‹ 
verifyArray
‹‹ 
=
‹‹ 
	ArrayPool
‹‹ &
<
‹‹& '
byte
‹‹' +
>
‹‹+ ,
.
‹‹, -
Shared
‹‹- 3
.
‹‹3 4
Rent
‹‹4 8
(
‹‹8 9
length
‹‹9 ?
)
‹‹? @
;
‹‹@ A
try
 
{
ŽŽ 	
_secureKeyBuffer
 
.
 
WithSecureBytes
 ,
(
, -
secureKeyBytes
- ;
=>
< >
{
? @
secureKeyBytes
A O
.
O P
CopyTo
P V
(
V W
secureKeyArray
W e
.
e f
AsSpan
f l
(
l m
)
m n
)
n o
;
o p
}
q r
)
r s
;
s t$
_verifySecureKeyBuffer
 "
.
" #
WithSecureBytes
# 2
(
2 3
verifyBytes
3 >
=>
? A
{
B C
verifyBytes
D O
.
O P
CopyTo
P V
(
V W
verifyArray
W b
.
b c
AsSpan
c i
(
i j
)
j k
)
k l
;
l m
}
n o
)
o p
;
p q
return
’’ %
CryptographicOperations
’’ *
.
’’* +
FixedTimeEquals
’’+ :
(
’’: ;
secureKeyArray
““ 
.
““ 
AsSpan
““ %
(
““% &
$num
““& '
,
““' (
length
““) /
)
““/ 0
,
““0 1
verifyArray
”” 
.
”” 
AsSpan
”” "
(
””" #
$num
””# $
,
””$ %
length
””& ,
)
””, -
)
””- .
;
””. /
}
•• 	
finally
–– 
{
—— 	
	ArrayPool
˜˜ 
<
˜˜ 
byte
˜˜ 
>
˜˜ 
.
˜˜ 
Shared
˜˜ "
.
˜˜" #
Return
˜˜# )
(
˜˜) *
secureKeyArray
˜˜* 8
,
˜˜8 9

clearArray
˜˜: D
:
˜˜D E
true
˜˜F J
)
˜˜J K
;
˜˜K L
	ArrayPool
™™ 
<
™™ 
byte
™™ 
>
™™ 
.
™™ 
Shared
™™ "
.
™™" #
Return
™™# )
(
™™) *
verifyArray
™™* 5
,
™™5 6

clearArray
™™7 A
:
™™A B
true
™™C G
)
™™G H
;
™™H I
}
šš 	
}
›› 
private
 
string
 ,
FormatSecureKeyStrengthMessage
 1
(
1 2
SecureKeyStrength
2 C
strength
D L
,
L M
string
N T
?
T U
error
V [
,
[ \
string
] c
recommendations
d s
)
s t
{
žž 
string
ŸŸ 
strengthText
ŸŸ 
=
ŸŸ 
strength
ŸŸ &
switch
ŸŸ' -
{
   	
SecureKeyStrength
¡¡ 
.
¡¡ 
INVALID
¡¡ %
=>
¡¡& (!
LocalizationService
¡¡) <
[
¡¡< =%
AuthenticationConstants
¡¡= T
.
¡¡T U-
SECURE_KEY_STRENGTH_INVALID_KEY
¡¡U t
]
¡¡t u
,
¡¡u v
SecureKeyStrength
¢¢ 
.
¢¢ 
	VERY_WEAK
¢¢ '
=>
¢¢( *!
LocalizationService
¢¢+ >
[
¢¢> ?%
AuthenticationConstants
¢¢? V
.
¢¢V W/
!SECURE_KEY_STRENGTH_VERY_WEAK_KEY
¢¢W x
]
¢¢x y
,
¢¢y z
SecureKeyStrength
££ 
.
££ 
WEAK
££ "
=>
££# %!
LocalizationService
££& 9
[
££9 :%
AuthenticationConstants
££: Q
.
££Q R*
SECURE_KEY_STRENGTH_WEAK_KEY
££R n
]
££n o
,
££o p
SecureKeyStrength
¤¤ 
.
¤¤ 
GOOD
¤¤ "
=>
¤¤# %!
LocalizationService
¤¤& 9
[
¤¤9 :%
AuthenticationConstants
¤¤: Q
.
¤¤Q R*
SECURE_KEY_STRENGTH_GOOD_KEY
¤¤R n
]
¤¤n o
,
¤¤o p
SecureKeyStrength
¥¥ 
.
¥¥ 
STRONG
¥¥ $
=>
¥¥% '!
LocalizationService
¥¥( ;
[
¥¥; <%
AuthenticationConstants
¥¥< S
.
¥¥S T,
SECURE_KEY_STRENGTH_STRONG_KEY
¥¥T r
]
¥¥r s
,
¥¥s t
SecureKeyStrength
¦¦ 
.
¦¦ 
VERY_STRONG
¦¦ )
=>
¦¦* ,!
LocalizationService
¦¦- @
[
¦¦@ A%
AuthenticationConstants
¦¦A X
.
¦¦X Y1
#SECURE_KEY_STRENGTH_VERY_STRONG_KEY
¦¦Y |
]
¦¦| }
,
¦¦} ~
_
§§ 
=>
§§ !
LocalizationService
§§ $
[
§§$ %%
AuthenticationConstants
§§% <
.
§§< =-
SECURE_KEY_STRENGTH_INVALID_KEY
§§= \
]
§§\ ]
}
¨¨ 	
;
¨¨	 

string
ªª 
message
ªª 
=
ªª 
!
ªª 
string
ªª  
.
ªª  !
IsNullOrEmpty
ªª! .
(
ªª. /
error
ªª/ 4
)
ªª4 5
?
ªª6 7
error
ªª8 =
:
ªª> ?
recommendations
ªª@ O
;
ªªO P
return
«« 
string
«« 
.
«« 
IsNullOrEmpty
«« #
(
««# $
message
««$ +
)
««+ ,
?
««- .
strengthText
««/ ;
:
««< =
$"
««> @
{
««@ A
strengthText
««A M
}
««M N
$str
««N P
{
««P Q
message
««Q X
}
««X Y
"
««Y Z
;
««Z [
}
¬¬ 
private
®® 
void
®® 
SetServerError
®® 
(
®®  
string
®®  &
?
®®& '
error
®®( -
)
®®- .
{
¯¯ 
ServerError
°° 
=
°° 
error
°° 
;
°° 
HasServerError
±± 
=
±± 
!
±± 
string
±±  
.
±±  !
IsNullOrEmpty
±±! .
(
±±. /
error
±±/ 4
)
±±4 5
;
±±5 6
}
²² 
private
´´ 
async
´´ 
Task
´´ 
<
´´ 
SystemU
´´ 
>
´´ 
SubmitAsync
´´  +
(
´´+ ,
)
´´, -
{
µµ 
if
¶¶ 

(
¶¶ 
IsBusy
¶¶ 
||
¶¶ 
!
¶¶ 
	CanSubmit
¶¶  
)
¶¶  !
{
·· 	
return
¸¸ 
SystemU
¸¸ 
.
¸¸ 
Default
¸¸ "
;
¸¸" #
}
¹¹ 	
SetServerError
»» 
(
»» 
string
»» 
.
»» 
Empty
»» #
)
»»# $
;
»»$ %
try
½½ 
{
¾¾ 	%
CancellationTokenSource
¿¿ #
operationCts
¿¿$ 0
=
¿¿1 2'
RecreateCancellationToken
¿¿3 L
(
¿¿L M
ref
¿¿M P"
_currentOperationCts
¿¿Q e
)
¿¿e f
;
¿¿f g
CancellationToken
ÀÀ 
operationToken
ÀÀ ,
=
ÀÀ- .
operationCts
ÀÀ/ ;
.
ÀÀ; <
Token
ÀÀ< A
;
ÀÀA B
try
ÂÂ 
{
ÃÃ 
uint
ÄÄ 
	connectId
ÄÄ 
=
ÄÄ  
ComputeConnectId
ÄÄ! 1
(
ÄÄ1 2 
PubKeyExchangeType
ÄÄ2 D
.
ÄÄD E(
DataCenterEphemeralConnect
ÄÄE _
)
ÄÄ_ `
;
ÄÄ` a
Task
ÆÆ 
<
ÆÆ 
Result
ÆÆ 
<
ÆÆ 
Unit
ÆÆ  
,
ÆÆ  !
string
ÆÆ" (
>
ÆÆ( )
>
ÆÆ) *
completeTask
ÆÆ+ 7
=
ÆÆ8 9
_flowContext
ÆÆ: F
==
ÆÆG I'
AuthenticationFlowContext
ÆÆJ c
.
ÆÆc d
REGISTRATION
ÆÆd p
?
ÇÇ '
CompleteRegistrationAsync
ÇÇ /
(
ÇÇ/ 0
	connectId
ÇÇ0 9
,
ÇÇ9 :
operationToken
ÇÇ; I
)
ÇÇI J
:
ÈÈ )
CompleteSecureKeyResetAsync
ÈÈ 1
(
ÈÈ1 2
	connectId
ÈÈ2 ;
,
ÈÈ; <
operationToken
ÈÈ= K
)
ÈÈK L
;
ÈÈL M
Result
ÊÊ 
<
ÊÊ 
Unit
ÊÊ 
,
ÊÊ 
string
ÊÊ #
>
ÊÊ# $
result
ÊÊ% +
=
ÊÊ, -
await
ÊÊ. 3
completeTask
ÊÊ4 @
;
ÊÊ@ A
if
ÌÌ 
(
ÌÌ 
result
ÌÌ 
.
ÌÌ 
IsErr
ÌÌ  
)
ÌÌ  !
{
ÍÍ 
SetServerError
ÎÎ "
(
ÎÎ" #
result
ÎÎ# )
.
ÎÎ) *
	UnwrapErr
ÎÎ* 3
(
ÎÎ3 4
)
ÎÎ4 5
)
ÎÎ5 6
;
ÎÎ6 7
return
ÏÏ 
SystemU
ÏÏ "
.
ÏÏ" #
Default
ÏÏ# *
;
ÏÏ* +
}
ÐÐ 
if
ÒÒ 
(
ÒÒ 

HostScreen
ÒÒ 
is
ÒÒ !
not
ÒÒ" %%
AuthenticationViewModel
ÒÒ& =
hostViewModel
ÒÒ> K
)
ÒÒK L
{
ÓÓ 
return
ÔÔ 
SystemU
ÔÔ "
.
ÔÔ" #
Default
ÔÔ# *
;
ÔÔ* +
}
ÕÕ 
Option
×× 
<
×× 
string
×× 
>
××  
mobileNumberOption
×× 1
=
××2 3
_flowContext
××4 @
==
××A C'
AuthenticationFlowContext
××D ]
.
××] ^
REGISTRATION
××^ j
?
ØØ 
Option
ØØ 
<
ØØ 
string
ØØ #
>
ØØ# $
.
ØØ$ %
Some
ØØ% )
(
ØØ) *
hostViewModel
ØØ* 7
.
ØØ7 8&
RegistrationMobileNumber
ØØ8 P
!
ØØP Q
)
ØØQ R
:
ÙÙ 
Option
ÙÙ 
<
ÙÙ 
string
ÙÙ #
>
ÙÙ# $
.
ÙÙ$ %
Some
ÙÙ% )
(
ÙÙ) *
hostViewModel
ÙÙ* 7
.
ÙÙ7 8"
RecoveryMobileNumber
ÙÙ8 L
!
ÙÙL M
)
ÙÙM N
;
ÙÙN O
if
ÛÛ 
(
ÛÛ  
mobileNumberOption
ÛÛ &
.
ÛÛ& '
IsSome
ÛÛ' -
)
ÛÛ- .
{
ÜÜ 
await
ÝÝ 
SignInAsync
ÝÝ %
(
ÝÝ% & 
mobileNumberOption
ÝÝ& 8
.
ÝÝ8 9
Value
ÝÝ9 >
!
ÝÝ> ?
,
ÝÝ? @
	connectId
ÝÝA J
,
ÝÝJ K
operationToken
ÝÝL Z
)
ÝÝZ [
;
ÝÝ[ \
}
ÞÞ 
return
àà 
SystemU
àà 
.
àà 
Default
àà &
;
àà& '
}
áá 
finally
ââ 
{
ãã 
if
ää 
(
ää "
_currentOperationCts
ää (
!=
ää) +
null
ää, 0
&&
ää1 3
ReferenceEquals
ää4 C
(
ääC D"
_currentOperationCts
ääD X
,
ääX Y
operationCts
ääZ f
)
ääf g
)
ääg h
{
åå "
_currentOperationCts
ææ (
=
ææ) *
null
ææ+ /
;
ææ/ 0
}
çç 
operationCts
éé 
.
éé 
Dispose
éé $
(
éé$ %
)
éé% &
;
éé& '
}
êê 
}
ëë 	
catch
ìì 
(
ìì (
OperationCanceledException
ìì )
)
ìì) *
{
íí 	
return
îî 
SystemU
îî 
.
îî 
Default
îî "
;
îî" #
}
ïï 	
}
ðð 
private
òò 
async
òò 
Task
òò 
<
òò 
Result
òò 
<
òò 
Unit
òò "
,
òò" #
string
òò$ *
>
òò* +
>
òò+ ,'
CompleteRegistrationAsync
òò- F
(
òòF G
uint
òòG K
	connectId
òòL U
,
òòU V
CancellationToken
óó 
cancellationToken
óó +
)
óó+ ,
{
ôô 
if
õõ 

(
õõ  
MembershipUniqueId
õõ 
==
õõ !
null
õõ" &
)
õõ& '
{
öö 	
return
÷÷ 
Result
÷÷ 
<
÷÷ 
Unit
÷÷ 
,
÷÷ 
string
÷÷  &
>
÷÷& '
.
÷÷' (
Err
÷÷( +
(
÷÷+ ,!
LocalizationService
øø #
[
øø# $%
AuthenticationConstants
øø$ ;
.
øø; <0
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY
øø< ^
]
øø^ _
)
øø_ `
;
øø` a
}
ùù 	
return
ûû 
await
ûû "
_registrationService
ûû )
.
ûû) *'
CompleteRegistrationAsync
ûû* C
(
ûûC D 
MembershipUniqueId
üü 
,
üü 
_secureKeyBuffer
ýý 
,
ýý 
	connectId
þþ 
,
þþ 
cancellationToken
ÿÿ 
)
ÿÿ 
;
ÿÿ 
}
€€ 
private
‚‚ 
async
‚‚ 
Task
‚‚ 
<
‚‚ 
Result
‚‚ 
<
‚‚ 
Unit
‚‚ "
,
‚‚" #
string
‚‚$ *
>
‚‚* +
>
‚‚+ ,)
CompleteSecureKeyResetAsync
‚‚- H
(
‚‚H I
uint
‚‚I M
	connectId
‚‚N W
,
‚‚W X
CancellationToken
ƒƒ 
cancellationToken
ƒƒ +
)
ƒƒ+ ,
{
„„ 
if
…… 

(
……  
MembershipUniqueId
…… 
==
…… !
null
……" &
)
……& '
{
†† 	
return
‡‡ 
Result
‡‡ 
<
‡‡ 
Unit
‡‡ 
,
‡‡ 
string
‡‡  &
>
‡‡& '
.
‡‡' (
Err
‡‡( +
(
‡‡+ ,!
LocalizationService
ˆˆ #
[
ˆˆ# $%
AuthenticationConstants
ˆˆ$ ;
.
ˆˆ; <0
"MEMBERSHIP_IDENTIFIER_REQUIRED_KEY
ˆˆ< ^
]
ˆˆ^ _
)
ˆˆ_ `
;
ˆˆ` a
}
‰‰ 	
return
‹‹ 
await
‹‹ '
_secureKeyRecoveryService
‹‹ .
.
‹‹. /)
CompleteSecureKeyResetAsync
‹‹/ J
(
‹‹J K 
MembershipUniqueId
ŒŒ 
,
ŒŒ 
_secureKeyBuffer
 
,
 
	connectId
ŽŽ 
,
ŽŽ 
cancellationToken
 
)
 
;
 
}
 
private
’’ 
async
’’ 
Task
’’ 
SignInAsync
’’ "
(
’’" #
string
’’# )
mobileNumber
’’* 6
,
’’6 7
uint
’’8 <
	connectId
’’= F
,
’’F G
CancellationToken
’’H Y
cancellationToken
’’Z k
)
’’k l
{
““ 
Result
”” 
<
”” 
Unit
”” 
,
”” #
AuthenticationFailure
”” *
>
””* +
signInResult
””, 8
=
””9 :
await
””; @$
_authenticationService
””A W
.
””W X
SignInAsync
””X c
(
””c d
mobileNumber
•• 
,
•• 
_secureKeyBuffer
–– 
,
–– 
	connectId
—— 
,
—— 
cancellationToken
˜˜ 
)
˜˜ 
;
˜˜ 
if
šš 

(
šš 
signInResult
šš 
.
šš 
IsOk
šš 
&&
šš  

HostScreen
šš! +
is
šš, .%
AuthenticationViewModel
šš/ F
hostViewModel
ššG T
)
ššT U
{
›› 	
try
œœ 
{
 
await
žž 
hostViewModel
žž #
.
žž# $'
SwitchToMainWindowCommand
žž$ =
.
žž= >
Execute
žž> E
(
žžE F
)
žžF G
;
žžG H
}
ŸŸ 
catch
   
(
   
	Exception
   
ex
   
)
    
{
¡¡ 
Log
¢¢ 
.
¢¢ 
Error
¢¢ 
(
¢¢ 
ex
¢¢ 
,
¢¢ 
$str
¢¢ _
)
¢¢_ `
;
¢¢` a
SetServerError
££ 
(
££ 
$"
££ !
{
££! "!
LocalizationService
££" 5
[
££5 6%
AuthenticationConstants
££6 M
.
££M N$
NAVIGATION_FAILURE_KEY
££N d
]
££d e
}
££e f
"
££f g
)
££g h
;
££h i
}
¤¤ 
}
¥¥ 	
else
¦¦ 
if
¦¦ 
(
¦¦ 
signInResult
¦¦ 
.
¦¦ 
IsErr
¦¦ #
)
¦¦# $
{
§§ 	#
AuthenticationFailure
¨¨ !
failure
¨¨" )
=
¨¨* +
signInResult
¨¨, 8
.
¨¨8 9
	UnwrapErr
¨¨9 B
(
¨¨B C
)
¨¨C D
;
¨¨D E
SetServerError
©© 
(
©© 
failure
©© "
.
©©" #
Message
©©# *
)
©©* +
;
©©+ ,
}
ªª 	
}
«« 
	protected
­­ 
override
­­ 
void
­­ 
Dispose
­­ #
(
­­# $
bool
­­$ (
	disposing
­­) 2
)
­­2 3
{
®® 
if
¯¯ 

(
¯¯ 
_isDisposed
¯¯ 
)
¯¯ 
{
°° 	
return
±± 
;
±± 
}
²² 	
if
´´ 

(
´´ 
	disposing
´´ 
)
´´ 
{
µµ 	$
CancelCurrentOperation
¶¶ "
(
¶¶" #
)
¶¶# $
;
¶¶$ %
_secureKeyBuffer
·· 
.
·· 
Dispose
·· $
(
··$ %
)
··% &
;
··& '$
_verifySecureKeyBuffer
¸¸ "
.
¸¸" #
Dispose
¸¸# *
(
¸¸* +
)
¸¸+ ,
;
¸¸, -
}
¹¹ 	
_isDisposed
»» 
=
»» 
true
»» 
;
»» 
base
¼¼ 
.
¼¼ 
Dispose
¼¼ 
(
¼¼ 
	disposing
¼¼ 
)
¼¼ 
;
¼¼  
}
½½ 
private
¿¿ 
void
¿¿ $
CancelCurrentOperation
¿¿ '
(
¿¿' (
)
¿¿( )
{
ÀÀ %
CancellationTokenSource
ÁÁ 
?
ÁÁ  
operationSource
ÁÁ! 0
=
ÁÁ1 2
Interlocked
ÁÁ3 >
.
ÁÁ> ?
Exchange
ÁÁ? G
(
ÁÁG H
ref
ÂÂ "
_currentOperationCts
ÂÂ $
,
ÂÂ$ %
null
ÃÃ 
)
ÃÃ 
;
ÃÃ 
if
ÅÅ 

(
ÅÅ 
operationSource
ÅÅ 
==
ÅÅ 
null
ÅÅ #
)
ÅÅ# $
{
ÆÆ 	
return
ÇÇ 
;
ÇÇ 
}
ÈÈ 	
try
ÊÊ 
{
ËË 	
operationSource
ÌÌ 
.
ÌÌ 
Cancel
ÌÌ "
(
ÌÌ" #
)
ÌÌ# $
;
ÌÌ$ %
}
ÍÍ 	
catch
ÎÎ 
(
ÎÎ %
ObjectDisposedException
ÎÎ &
)
ÎÎ& '
{
ÏÏ 	
}
ÑÑ 	
finally
ÒÒ 
{
ÓÓ 	
operationSource
ÔÔ 
.
ÔÔ 
Dispose
ÔÔ #
(
ÔÔ# $
)
ÔÔ$ %
;
ÔÔ% &
}
ÕÕ 	
}
ÖÖ 
}×× Ú"
œ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/Registration/PassPhaseViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0

ViewModels0 :
.: ;
Registration; G
;G H
public 
sealed 
class 
PassPhaseViewModel &
:' (
Core) -
.- .
MVVM. 2
.2 3
ViewModelBase3 @
,@ A
IRoutableViewModelB T
,T U
IDisposableV a
,a b
IResettablec n
{ 
private 
readonly 
CompositeDisposable (
_disposables) 5
=6 7
new8 ;
(; <
)< =
;= >
private 
string 

_passPhase 
= 
string  &
.& '
Empty' ,
;, -
private 
bool 
_isDisposed 
; 
public 

PassPhaseViewModel 
(  
ILocalizationService 
localizationService 0
,0 1
IScreen 

hostScreen 
, 
NetworkProvider +
networkProvider, ;
); <
:= >
base? C
(C D
networkProviderD S
,S T
localizationServiceU h
,h i
nullj n
)n o
{ 

HostScreen 
= 

hostScreen 
;  
SubmitCommand 
= 
ReactiveCommand '
.' (
Create( .
(. /
(/ 0
)0 1
=>2 4
{5 6
}7 8
)8 9
;9 :
_disposables 
. 
Add 
( 
SubmitCommand &
)& '
;' (
} 
public 

string 
? 
UrlPathSegment !
{" #
get$ '
;' (
}) *
=+ ,
$str- :
;: ;
public 

IScreen 

HostScreen 
{ 
get  #
;# $
}% &
public!! 

ReactiveCommand!! 
<!! 
Unit!! 
,!!  
Unit!!! %
>!!% &
SubmitCommand!!' 4
{!!5 6
get!!7 :
;!!: ;
}!!< =
public## 

string## 
	PassPhase## 
{$$ 
get%% 
=>%% 

_passPhase%% 
;%% 
set&& 
=>&& 
this&& 
.&&  
RaiseAndSetIfChanged&& (
(&&( )
ref&&) ,

_passPhase&&- 7
,&&7 8
value&&9 >
)&&> ?
;&&? @
}'' 
public)) 

void)) 

ResetState)) 
()) 
))) 
{** 
if++ 

(++ 
_isDisposed++ 
)++ 
{,, 	
return-- 
;-- 
}.. 	
	PassPhase00 
=00 
string00 
.00 
Empty00  
;00  !
}11 
public33 

new33 
void33 
Dispose33 
(33 
)33 
{44 
Dispose55 
(55 
true55 
)55 
;55 
GC66 

.66
 
SuppressFinalize66 
(66 
this66  
)66  !
;66! "
}77 
	protected99 
override99 
void99 
Dispose99 #
(99# $
bool99$ (
	disposing99) 2
)992 3
{:: 
if;; 

(;; 
_isDisposed;; 
);; 
{<< 	
return== 
;== 
}>> 	
if@@ 

(@@ 
	disposing@@ 
)@@ 
{AA 	
_disposablesBB 
.BB 
DisposeBB  
(BB  !
)BB! "
;BB" #
}CC 	
baseEE 
.EE 
DisposeEE 
(EE 
	disposingEE 
)EE 
;EE  
_isDisposedFF 
=FF 
trueFF 
;FF 
}GG 
}HH ç¿
¥/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/Registration/MobileVerificationViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0

ViewModels0 :
.: ;
Registration; G
;G H
public 
sealed 
class '
MobileVerificationViewModel /
:0 1
Core2 6
.6 7
MVVM7 ;
.; <
ViewModelBase< I
,I J
IRoutableViewModelK ]
,] ^
IResettable_ j
,j k
IDisposablel w
{ 
private 
readonly -
!IApplicationSecureStorageProvider 6-
!_applicationSecureStorageProvider7 X
;X Y
private 
readonly &
IOpaqueRegistrationService / 
_registrationService0 D
;D E
private   
readonly   %
ISecureKeyRecoveryService   .
?  . /%
_secureKeyRecoveryService  0 I
;  I J
private!! 
readonly!! %
AuthenticationFlowContext!! .
_flowContext!!/ ;
;!!; <
private"" 
readonly""  
IConnectivityService"" ) 
_connectivityService""* >
;""> ?
private## 
readonly## 
CompositeDisposable## (
_disposables##) 5
=##6 7
new##8 ;
(##; <
)##< =
;##= >
private%% #
CancellationTokenSource%% #
?%%# $ 
_currentOperationCts%%% 9
;%%9 :
private&& 
bool&& '
_hasMobileNumberBeenTouched&& ,
;&&, -
private'' 
bool'' 
_isDisposed'' 
;'' 
public)) 
'
MobileVerificationViewModel)) &
())& ' 
IConnectivityService** 
connectivityService** 0
,**0 1
NetworkProvider++ 
networkProvider++ '
,++' ( 
ILocalizationService,, 
localizationService,, 0
,,,0 1
IScreen-- 

hostScreen-- 
,-- -
!IApplicationSecureStorageProvider.. ),
 applicationSecureStorageProvider..* J
,..J K&
IOpaqueRegistrationService// "
registrationService//# 6
,//6 7%
ISecureKeyRecoveryService00 !$
secureKeyRecoveryService00" :
,00: ;%
AuthenticationFlowContext11 !
flowContext11" -
)11- .
:11/ 0
base111 5
(115 6
networkProvider116 E
,11E F
localizationService11G Z
,11Z [
connectivityService22 
)22 
{33  
_registrationService44 
=44 
registrationService44 2
;442 3%
_secureKeyRecoveryService55 !
=55" #$
secureKeyRecoveryService55$ <
;55< = 
_connectivityService66 
=66 
connectivityService66 2
;662 3
_flowContext77 
=77 
flowContext77 "
;77" #

HostScreen88 
=88 

hostScreen88 
;88  -
!_applicationSecureStorageProvider99 )
=99* +,
 applicationSecureStorageProvider99, L
;99L M
IObservable;; 
<;; 
bool;; 
>;;  
isFormLogicallyValid;; .
=;;/ 0
SetupValidation;;1 @
(;;@ A
);;A B
;;;B C
SetupCommands<< 
(<<  
isFormLogicallyValid<< *
)<<* +
;<<+ ,
}== 
public?? 

string?? 
??? 
UrlPathSegment?? !
{??" #
get??$ '
;??' (
}??) *
=??+ ,
$str??- C
;??C D
public@@ 

IScreen@@ 

HostScreen@@ 
{@@ 
get@@  #
;@@# $
}@@% &
privateBB 
stringBB 
LocalizeBB 
(BB 
stringBB "
registrationKeyBB# 2
,BB2 3
stringBB4 :
recoveryKeyBB; F
)BBF G
=>BBH J$
GetSecureKeyLocalizationCC  
(CC  !
_flowContextCC! -
,CC- .
registrationKeyCC/ >
,CC> ?
recoveryKeyCC@ K
)CCK L
;CCL M
publicEE 

stringEE 
TitleEE 
=>EE 
LocalizeEE #
(EE# $
KeysEE$ (
.EE( )
REGISTRATION_TITLEEE) ;
,EE; <
KeysEE= A
.EEA B
RECOVERY_TITLEEEB P
)EEP Q
;EEQ R
publicGG 

stringGG 
DescriptionGG 
=>GG  
LocalizeGG! )
(GG) *
KeysGG* .
.GG. /$
REGISTRATION_DESCRIPTIONGG/ G
,GGG H
KeysGGI M
.GGM N 
RECOVERY_DESCRIPTIONGGN b
)GGb c
;GGc d
publicII 

stringII 
HintII 
=>II 
LocalizeII "
(II" #
KeysII# '
.II' (
REGISTRATION_HINTII( 9
,II9 :
KeysII; ?
.II? @
RECOVERY_HINTII@ M
)IIM N
;IIN O
publicKK 

stringKK 
	WatermarkKK 
=>KK 
LocalizeKK '
(KK' (
KeysKK( ,
.KK, -"
REGISTRATION_WATERMARKKK- C
,KKC D
KeysKKE I
.KKI J
RECOVERY_WATERMARKKKJ \
)KK\ ]
;KK] ^
publicMM 

stringMM 

ButtonTextMM 
=>MM 
LocalizeMM  (
(MM( )
KeysMM) -
.MM- .
REGISTRATION_BUTTONMM. A
,MMA B
KeysMMC G
.MMG H
RECOVERY_BUTTONMMH W
)MMW X
;MMX Y
publicOO 

ReactiveCommandOO 
<OO 
UnitOO 
,OO  
UnitOO! %
>OO% &
?OO& '%
VerifyMobileNumberCommandOO( A
{OOB C
getOOD G
;OOG H
privateOOI P
setOOQ T
;OOT U
}OOV W
[QQ 
ReactiveQQ 
]QQ 
publicQQ 
stringQQ 
MobileNumberQQ )
{QQ* +
getQQ, /
;QQ/ 0
setQQ1 4
;QQ4 5
}QQ6 7
=QQ8 9
stringQQ: @
.QQ@ A
EmptyQQA F
;QQF G
[RR 
ReactiveRR 
]RR 
publicRR 
stringRR 
?RR 
MobileNumberErrorRR /
{RR0 1
getRR2 5
;RR5 6
privateRR7 >
setRR? B
;RRB C
}RRD E
[SS 
ReactiveSS 
]SS 
publicSS 
boolSS  
HasMobileNumberErrorSS /
{SS0 1
getSS2 5
;SS5 6
privateSS7 >
setSS? B
;SSB C
}SSD E
[UU  
ObservableAsPropertyUU 
]UU 
publicUU !
boolUU" &
IsBusyUU' -
{UU. /
getUU0 3
;UU3 4
}UU5 6
publicWW 

asyncWW 
TaskWW $
HandleEnterKeyPressAsyncWW .
(WW. /
)WW/ 0
{XX 
ifYY 

(YY 
_isDisposedYY 
)YY 
{ZZ 	
return[[ 
;[[ 
}\\ 	
if^^ 

(^^ %
VerifyMobileNumberCommand^^ %
!=^^& (
null^^) -
&&^^. 0
await^^1 6%
VerifyMobileNumberCommand^^7 P
.^^P Q

CanExecute^^Q [
.^^[ \
FirstOrDefaultAsync^^\ o
(^^o p
)^^p q
)^^q r
{__ 	%
VerifyMobileNumberCommand`` %
.``% &
Execute``& -
(``- .
)``. /
.``/ 0
	Subscribe``0 9
(``9 :
)``: ;
.``; <
DisposeWith``< G
(``G H
_disposables``H T
)``T U
;``U V
}aa 	
}bb 
publicdd 

voiddd 

ResetStatedd 
(dd 
)dd 
{ee 
ifff 

(ff 
_isDisposedff 
)ff 
{gg 	
returnhh 
;hh 
}ii 	"
CancelCurrentOperationkk 
(kk 
)kk  
;kk  !
MobileNumberll 
=ll 
stringll 
.ll 
Emptyll #
;ll# $'
_hasMobileNumberBeenTouchedmm #
=mm$ %
falsemm& +
;mm+ , 
HasMobileNumberErrornn 
=nn 
falsenn $
;nn$ %
MobileNumberErroroo 
=oo 
stringoo "
.oo" #
Emptyoo# (
;oo( )
}pp 
privaterr 
IObservablerr 
<rr 
boolrr 
>rr 
SetupValidationrr -
(rr- .
)rr. /
{ss 
IObservablett 
<tt 
Unittt 
>tt 
languageTriggertt )
=tt* +
LanguageChangedtt, ;
;tt; <
languageTriggervv 
.ww 
	Subscribeww 
(ww 
_ww 
=>ww 
{xx 
thisyy 
.yy  
RaisePropertyChangedyy )
(yy) *
nameofyy* 0
(yy0 1
Titleyy1 6
)yy6 7
)yy7 8
;yy8 9
thiszz 
.zz  
RaisePropertyChangedzz )
(zz) *
nameofzz* 0
(zz0 1
Descriptionzz1 <
)zz< =
)zz= >
;zz> ?
this{{ 
.{{  
RaisePropertyChanged{{ )
({{) *
nameof{{* 0
({{0 1
Hint{{1 5
){{5 6
){{6 7
;{{7 8
this|| 
.||  
RaisePropertyChanged|| )
(||) *
nameof||* 0
(||0 1
	Watermark||1 :
)||: ;
)||; <
;||< =
this}} 
.}}  
RaisePropertyChanged}} )
(}}) *
nameof}}* 0
(}}0 1

ButtonText}}1 ;
)}}; <
)}}< =
;}}= >
}~~ 
)~~ 
. 
DisposeWith 
( 
_disposables %
)% &
;& '
IObservable
 
<
 
Unit
 
>
 
mobileTrigger
 '
=
( )
this
* .
.
‚‚ 
WhenAnyValue
‚‚ 
(
‚‚ 
x
‚‚ 
=>
‚‚ 
x
‚‚  
.
‚‚  !
MobileNumber
‚‚! -
)
‚‚- .
.
ƒƒ 
Select
ƒƒ 
(
ƒƒ 
_
ƒƒ 
=>
ƒƒ 
Unit
ƒƒ 
.
ƒƒ 
Default
ƒƒ %
)
ƒƒ% &
;
ƒƒ& '
IObservable
…… 
<
…… 
Unit
…… 
>
…… 
validationTrigger
…… +
=
……, -
mobileTrigger
†† 
.
‡‡ 
Merge
‡‡ 
(
‡‡ 
languageTrigger
‡‡ &
)
‡‡& '
;
‡‡' (
IObservable
‰‰ 
<
‰‰ 
string
‰‰ 
>
‰‰ 
mobileValidation
‰‰ ,
=
‰‰- .
validationTrigger
‰‰/ @
.
ŠŠ 
Select
ŠŠ 
(
ŠŠ 
_
ŠŠ 
=>
ŠŠ #
MobileNumberValidator
ŠŠ .
.
ŠŠ. /
Validate
ŠŠ/ 7
(
ŠŠ7 8
MobileNumber
ŠŠ8 D
,
ŠŠD E!
LocalizationService
ŠŠF Y
)
ŠŠY Z
)
ŠŠZ [
.
‹‹ 
Replay
‹‹ 
(
‹‹ 
$num
‹‹ 
)
‹‹ 
.
ŒŒ 
RefCount
ŒŒ 
(
ŒŒ 
)
ŒŒ 
;
ŒŒ 
IObservable
ŽŽ 
<
ŽŽ 
string
ŽŽ 
>
ŽŽ 
mobileErrorStream
ŽŽ -
=
ŽŽ. /
this
ŽŽ0 4
.
ŽŽ4 5
WhenAnyValue
ŽŽ5 A
(
ŽŽA B
x
ŽŽB C
=>
ŽŽD F
x
ŽŽG H
.
ŽŽH I
MobileNumber
ŽŽI U
)
ŽŽU V
.
 
CombineLatest
 
(
 
mobileValidation
 +
,
+ ,
(
- .
mobile
. 4
,
4 5
validationError
6 E
)
E F
=>
G I
{
 
if
‘‘ 
(
‘‘ 
!
‘‘ )
_hasMobileNumberBeenTouched
‘‘ 0
&&
‘‘1 3
!
‘‘4 5
string
‘‘5 ;
.
‘‘; < 
IsNullOrWhiteSpace
‘‘< N
(
‘‘N O
mobile
‘‘O U
)
‘‘U V
)
‘‘V W
{
’’ )
_hasMobileNumberBeenTouched
““ /
=
““0 1
true
““2 6
;
““6 7
}
”” 
return
–– 
!
–– )
_hasMobileNumberBeenTouched
–– 3
?
––4 5
string
––6 <
.
––< =
Empty
––= B
:
––C D
validationError
––E T
;
––T U
}
—— 
)
—— 
.
˜˜ 
Replay
˜˜ 
(
˜˜ 
$num
˜˜ 
)
˜˜ 
.
™™ 
RefCount
™™ 
(
™™ 
)
™™ 
;
™™ 
mobileErrorStream
›› 
.
œœ 
	Subscribe
œœ 
(
œœ 
error
œœ 
=>
œœ 
{
 
MobileNumberError
žž !
=
žž" #
error
žž$ )
;
žž) *"
HasMobileNumberError
ŸŸ $
=
ŸŸ% &
!
ŸŸ' (
string
ŸŸ( .
.
ŸŸ. /
IsNullOrEmpty
ŸŸ/ <
(
ŸŸ< =
error
ŸŸ= B
)
ŸŸB C
;
ŸŸC D
}
   
)
   
.
¡¡ 
DisposeWith
¡¡ 
(
¡¡ 
_disposables
¡¡ %
)
¡¡% &
;
¡¡& '
return
££ 
mobileValidation
££ 
.
¤¤ 
Select
¤¤ 
(
¤¤ 
string
¤¤ 
.
¤¤ 
IsNullOrEmpty
¤¤ (
)
¤¤( )
.
¥¥ "
DistinctUntilChanged
¥¥ !
(
¥¥! "
)
¥¥" #
;
¥¥# $
}
¦¦ 
private
¨¨ 
void
¨¨ 
SetupCommands
¨¨ 
(
¨¨ 
IObservable
¨¨ *
<
¨¨* +
bool
¨¨+ /
>
¨¨/ 0"
isFormLogicallyValid
¨¨1 E
)
¨¨E F
{
©© 
IObservable
ªª 
<
ªª 
bool
ªª 
>
ªª 
	canVerify
ªª #
=
ªª$ %
this
ªª& *
.
ªª* +
WhenAnyValue
ªª+ 7
(
ªª7 8
x
ªª8 9
=>
ªª: <
x
ªª= >
.
ªª> ?
IsBusy
ªª? E
,
ªªE F
x
ªªG H
=>
ªªI K
x
ªªL M
.
ªªM N
IsInNetworkOutage
ªªN _
,
ªª_ `
(
«« 
isBusy
«« 
,
«« 

isInOutage
«« #
)
««# $
=>
««% '
!
««( )
isBusy
««) /
&&
««0 2
!
««3 4

isInOutage
««4 >
)
««> ?
.
¬¬ 
CombineLatest
¬¬ 
(
¬¬ "
isFormLogicallyValid
¬¬ /
,
¬¬/ 0
(
¬¬1 2

canExecute
¬¬2 <
,
¬¬< =
isValid
¬¬> E
)
¬¬E F
=>
¬¬G I

canExecute
¬¬J T
&&
¬¬U W
isValid
¬¬X _
)
¬¬_ `
;
¬¬` a'
VerifyMobileNumberCommand
®® !
=
®®" #
ReactiveCommand
®®$ 3
.
®®3 4
CreateFromTask
®®4 B
(
®®B C&
ExecuteVerificationAsync
®®C [
,
®®[ \
	canVerify
®®] f
)
®®f g
;
®®g h'
VerifyMobileNumberCommand
¯¯ !
.
¯¯! "
IsExecuting
¯¯" -
.
°° 
ToPropertyEx
°° 
(
°° 
this
°° 
,
°° 
x
°°  !
=>
°°" $
x
°°% &
.
°°& '
IsBusy
°°' -
)
°°- .
.
±± 
DisposeWith
±± 
(
±± 
_disposables
±± %
)
±±% &
;
±±& '
_disposables
³³ 
.
³³ 
Add
³³ 
(
³³ '
VerifyMobileNumberCommand
³³ 2
)
³³2 3
;
³³3 4
}
´´ 
private
¶¶ 
async
¶¶ 
Task
¶¶ 
<
¶¶ 
Unit
¶¶ 
>
¶¶ &
ExecuteVerificationAsync
¶¶ 5
(
¶¶5 6
)
¶¶6 7
{
·· 
if
¸¸ 

(
¸¸ 
_isDisposed
¸¸ 
)
¸¸ 
{
¹¹ 	
return
ºº 
Unit
ºº 
.
ºº 
Default
ºº 
;
ºº  
}
»» 	
try
½½ 
{
¾¾ 	%
CancellationTokenSource
¿¿ #%
cancellationTokenSource
¿¿$ ;
=
¿¿< ='
RecreateCancellationToken
¿¿> W
(
¿¿W X
ref
¿¿X ["
_currentOperationCts
¿¿\ p
)
¿¿p q
;
¿¿q r
uint
ÁÁ 
	connectId
ÁÁ 
=
ÁÁ 
ComputeConnectId
ÁÁ -
(
ÁÁ- . 
PubKeyExchangeType
ÁÁ. @
.
ÁÁ@ A(
DataCenterEphemeralConnect
ÁÁA [
)
ÁÁ[ \
;
ÁÁ\ ]
CancellationToken
ÂÂ 
operationToken
ÂÂ ,
=
ÂÂ- .%
cancellationTokenSource
ÂÂ/ F
.
ÂÂF G
Token
ÂÂG L
;
ÂÂL M
if
ÄÄ 
(
ÄÄ 
_flowContext
ÄÄ 
==
ÄÄ '
AuthenticationFlowContext
ÄÄ  9
.
ÄÄ9 :
REGISTRATION
ÄÄ: F
)
ÄÄF G
{
ÅÅ 
await
ÆÆ *
ExecuteRegistrationFlowAsync
ÆÆ 2
(
ÆÆ2 3
	connectId
ÆÆ3 <
,
ÆÆ< =
operationToken
ÆÆ> L
)
ÆÆL M
;
ÆÆM N
}
ÇÇ 
else
ÈÈ 
{
ÉÉ 
await
ÊÊ &
ExecuteRecoveryFlowAsync
ÊÊ .
(
ÊÊ. /
	connectId
ÊÊ/ 8
,
ÊÊ8 9
operationToken
ÊÊ: H
)
ÊÊH I
;
ÊÊI J
}
ËË 
}
ÌÌ 	
catch
ÍÍ 
(
ÍÍ (
OperationCanceledException
ÍÍ )
)
ÍÍ) *
{
ÎÎ 	
}
ÐÐ 	
catch
ÑÑ 
(
ÑÑ 
	Exception
ÑÑ 
ex
ÑÑ 
)
ÑÑ 
{
ÒÒ 	
string
ÓÓ 
errorMessage
ÓÓ 
=
ÓÓ  !!
LocalizationService
ÓÓ" 5
[
ÓÓ5 6%
AuthenticationConstants
ÓÓ6 M
.
ÓÓM N)
COMMON_UNEXPECTED_ERROR_KEY
ÓÓN i
]
ÓÓi j
;
ÓÓj k
Log
ÔÔ 
.
ÔÔ 
Error
ÔÔ 
(
ÔÔ 
ex
ÔÔ 
,
ÔÔ 
$str
ÔÔ ]
)
ÔÔ] ^
;
ÔÔ^ _
	ShowError
ÕÕ 
(
ÕÕ 
errorMessage
ÕÕ "
)
ÕÕ" #
;
ÕÕ# $
}
ÖÖ 	
return
ØØ 
Unit
ØØ 
.
ØØ 
Default
ØØ 
;
ØØ 
}
ÙÙ 
private
ÛÛ 
async
ÛÛ 
Task
ÛÛ *
ExecuteRegistrationFlowAsync
ÛÛ 3
(
ÛÛ3 4
uint
ÛÛ4 8
	connectId
ÛÛ9 B
,
ÛÛB C
CancellationToken
ÛÛD U
operationToken
ÛÛV d
)
ÛÛd e
{
ÜÜ 
Task
ÝÝ 
<
ÝÝ 
Result
ÝÝ 
<
ÝÝ *
ValidateMobileNumberResponse
ÝÝ 0
,
ÝÝ0 1
string
ÝÝ2 8
>
ÝÝ8 9
>
ÝÝ9 :
validationTask
ÝÝ; I
=
ÝÝJ K"
_registrationService
ÞÞ  
.
ÞÞ  !'
ValidateMobileNumberAsync
ÞÞ! :
(
ÞÞ: ;
MobileNumber
ÞÞ; G
,
ÞÞG H
	connectId
ÞÞI R
,
ÞÞR S
operationToken
ÞÞT b
)
ÞÞb c
;
ÞÞc d
Result
àà 
<
àà *
ValidateMobileNumberResponse
àà +
,
àà+ ,
string
àà- 3
>
àà3 4
result
àà5 ;
=
àà< =
await
àà> C
validationTask
ààD R
;
ààR S
if
ââ 

(
ââ 
_isDisposed
ââ 
)
ââ 
{
ãã 	
return
ää 
;
ää 
}
åå 	
if
çç 

(
çç 
result
çç 
.
çç 
IsErr
çç 
)
çç 
{
èè 	
	ShowError
éé 
(
éé 
result
éé 
.
éé 
	UnwrapErr
éé &
(
éé& '
)
éé' (
)
éé( )
;
éé) *
return
êê 
;
êê 
}
ëë 	*
ValidateMobileNumberResponse
íí $*
validateMobileNumberResponse
íí% A
=
ííB C
result
ííD J
.
ííJ K
Unwrap
ííK Q
(
ííQ R
)
ííR S
;
ííS T
if
ïï 

(
ïï *
validateMobileNumberResponse
ïï (
.
ïï( )
Result
ïï) /
==
ïï0 2 
VerificationResult
ïï3 E
.
ïïE F
InvalidMobile
ïïF S
)
ïïS T
{
ðð 	
	ShowError
ññ 
(
ññ *
validateMobileNumberResponse
ññ 2
.
ññ2 3
Message
ññ3 :
)
ññ: ;
;
ññ; <
return
òò 
;
òò 
}
óó 	
await
õõ 0
"HandleMobileAvailabilityCheckAsync
õõ 0
(
õõ0 1*
validateMobileNumberResponse
õõ1 M
.
õõM N$
MobileNumberIdentifier
õõN d
,
õõd e
	connectId
õõf o
,
õõo p
operationToken
öö 
)
öö 
;
öö 
}
÷÷ 
private
ùù 
async
ùù 
Task
ùù 0
"HandleMobileAvailabilityCheckAsync
ùù 9
(
ùù9 :

ByteString
ùù: D$
mobileNumberIdentifier
ùùE [
,
ùù[ \
uint
ùù] a
	connectId
ùùb k
,
ùùk l
CancellationToken
úú 
operationToken
úú (
)
úú( )
{
ûû 
Result
üü 
<
üü 3
%CheckMobileNumberAvailabilityResponse
üü 4
,
üü4 5
string
üü6 <
>
üü< =
statusResult
üü> J
=
üüK L
await
ýý "
_registrationService
ýý &
.
ýý& '0
"CheckMobileNumberAvailabilityAsync
ýý' I
(
ýýI J$
mobileNumberIdentifier
ýýJ `
,
ýý` a
	connectId
ýýb k
,
ýýk l
operationToken
þþ 
)
þþ 
;
þþ  
if
€€ 

(
€€ 
_isDisposed
€€ 
)
€€ 
{
 	
return
‚‚ 
;
‚‚ 
}
ƒƒ 	
if
…… 

(
…… 
statusResult
…… 
.
…… 
IsErr
…… 
)
…… 
{
†† 	
	ShowError
‡‡ 
(
‡‡ 
statusResult
‡‡ "
.
‡‡" #
	UnwrapErr
‡‡# ,
(
‡‡, -
)
‡‡- .
)
‡‡. /
;
‡‡/ 0
return
ˆˆ 
;
ˆˆ 
}
‰‰ 	3
%CheckMobileNumberAvailabilityResponse
‹‹ -
statusResponse
‹‹. <
=
‹‹= >
statusResult
‹‹? K
.
‹‹K L
Unwrap
‹‹L R
(
‹‹R S
)
‹‹S T
;
‹‹T U
await
ŒŒ +
HandleAvailabilityStatusAsync
ŒŒ +
(
ŒŒ+ ,
statusResponse
ŒŒ, :
,
ŒŒ: ;$
mobileNumberIdentifier
ŒŒ< R
)
ŒŒR S
;
ŒŒS T
}
 
private
 
async
 
Task
 +
HandleAvailabilityStatusAsync
 4
(
4 53
%CheckMobileNumberAvailabilityResponse
5 Z
statusResponse
[ i
,
i j

ByteString
 $
mobileNumberIdentifier
 )
)
) *
{
‘‘ 
switch
’’ 
(
’’ 
statusResponse
’’ 
.
’’ 
Status
’’ %
)
’’% &
{
““ 	
case
”” &
MobileAvailabilityStatus
”” )
.
””) *
	Available
””* 3
:
””3 4
await
•• ,
NavigateToOtpVerificationAsync
•• 4
(
••4 5$
mobileNumberIdentifier
••5 K
)
••K L
;
••L M
break
–– 
;
–– 
case
˜˜ &
MobileAvailabilityStatus
˜˜ )
.
˜˜) *!
RegistrationExpired
˜˜* =
:
˜˜= >
await
™™ ,
NavigateToOtpVerificationAsync
™™ 4
(
™™4 5$
mobileNumberIdentifier
™™5 K
)
™™K L
;
™™L M
break
šš 
;
šš 
case
œœ &
MobileAvailabilityStatus
œœ )
.
œœ) *$
IncompleteRegistration
œœ* @
:
œœ@ A
await
 /
!HandleIncompleteRegistrationAsync
 7
(
7 8
statusResponse
8 F
,
F G$
mobileNumberIdentifier
H ^
)
^ _
;
_ `
break
žž 
;
žž 
case
   &
MobileAvailabilityStatus
   )
.
  ) *
DataCorruption
  * 8
:
  8 9(
HandleDataCorruptionStatus
¡¡ *
(
¡¡* +
statusResponse
¡¡+ 9
)
¡¡9 :
;
¡¡: ;
break
¢¢ 
;
¢¢ 
case
¤¤ &
MobileAvailabilityStatus
¤¤ )
.
¤¤) *
TakenActive
¤¤* 5
:
¤¤5 6
case
¥¥ &
MobileAvailabilityStatus
¥¥ )
.
¥¥) *
TakenInactive
¥¥* 7
:
¥¥7 8%
HandleMobileTakenStatus
¦¦ '
(
¦¦' (
statusResponse
¦¦( 6
)
¦¦6 7
;
¦¦7 8
break
§§ 
;
§§ 
default
©© 
:
©© $
HandleUnexpectedStatus
ªª &
(
ªª& '
statusResponse
ªª' 5
)
ªª5 6
;
ªª6 7
break
«« 
;
«« 
}
¬¬ 	
}
­­ 
private
¯¯ 
async
¯¯ 
Task
¯¯ /
!HandleIncompleteRegistrationAsync
¯¯ 8
(
¯¯8 93
%CheckMobileNumberAvailabilityResponse
¯¯9 ^
statusResponse
¯¯_ m
,
¯¯m n

ByteString
°° $
mobileNumberIdentifier
°° )
)
°°) *
{
±± 
if
²² 

(
²² 
statusResponse
²² 
is
²² 
{
³³ 
HasCreationStatus
´´ !
:
´´! "
true
´´# '
,
´´' (
CreationStatus
´´) 7
:
´´7 8
Protobuf
´´9 A
.
´´A B

Membership
´´B L
.
´´L M

Membership
´´M W
.
´´W X
Types
´´X ]
.
´´] ^
CreationStatus
´´^ l
.
´´l m
OtpVerified
´´m x
}
µµ 
)
µµ 
{
¶¶ 	
await
·· 7
)StoreIncompleteMembershipAndNavigateAsync
·· ;
(
··; <
statusResponse
··< J
)
··J K
;
··K L
}
¸¸ 	
else
¹¹ 
{
ºº 	
await
»» ,
NavigateToOtpVerificationAsync
»» 0
(
»»0 1$
mobileNumberIdentifier
»»1 G
)
»»G H
;
»»H I
}
¼¼ 	
}
½½ 
private
¿¿ 
async
¿¿ 
Task
¿¿ 7
)StoreIncompleteMembershipAndNavigateAsync
¿¿ @
(
¿¿@ A3
%CheckMobileNumberAvailabilityResponse
¿¿A f
statusResponse
¿¿g u
)
¿¿u v
{
ÀÀ 

Membership
ÁÁ 

membership
ÁÁ 
=
ÁÁ 
new
ÁÁ  #
(
ÁÁ# $
)
ÁÁ$ %
{
ÂÂ 	
UniqueIdentifier
ÃÃ 
=
ÃÃ 
statusResponse
ÃÃ -
.
ÃÃ- ."
ExistingMembershipId
ÃÃ. B
,
ÃÃB C
Status
ÄÄ 
=
ÄÄ 
statusResponse
ÄÄ #
.
ÄÄ# $
HasActivityStatus
ÄÄ$ 5
?
ÅÅ 
statusResponse
ÅÅ  
.
ÅÅ  !
ActivityStatus
ÅÅ! /
:
ÆÆ 
Protobuf
ÆÆ 
.
ÆÆ 

Membership
ÆÆ %
.
ÆÆ% &

Membership
ÆÆ& 0
.
ÆÆ0 1
Types
ÆÆ1 6
.
ÆÆ6 7
ActivityStatus
ÆÆ7 E
.
ÆÆE F
Active
ÆÆF L
,
ÆÆL M
CreationStatus
ÇÇ 
=
ÇÇ 
statusResponse
ÇÇ +
.
ÇÇ+ ,
CreationStatus
ÇÇ, :
}
ÈÈ 	
;
ÈÈ	 

if
ÊÊ 

(
ÊÊ 
statusResponse
ÊÊ 
.
ÊÊ %
AccountUniqueIdentifier
ÊÊ 2
!=
ÊÊ3 5
null
ÊÊ6 :
&&
ÊÊ; =
!
ÊÊ> ?
statusResponse
ÊÊ? M
.
ÊÊM N%
AccountUniqueIdentifier
ÊÊN e
.
ÊÊe f
IsEmpty
ÊÊf m
)
ÊÊm n
{
ËË 	

membership
ÌÌ 
.
ÌÌ %
AccountUniqueIdentifier
ÌÌ .
=
ÌÌ/ 0
statusResponse
ÌÌ1 ?
.
ÌÌ? @%
AccountUniqueIdentifier
ÌÌ@ W
;
ÌÌW X
}
ÍÍ 	
await
ÏÏ /
!_applicationSecureStorageProvider
ÏÏ /
.
ÏÏ/ 0+
SetApplicationMembershipAsync
ÏÏ0 M
(
ÏÏM N

membership
ÏÏN X
)
ÏÏX Y
;
ÏÏY Z
if
ÑÑ 

(
ÑÑ 
statusResponse
ÑÑ 
.
ÑÑ %
AccountUniqueIdentifier
ÑÑ 2
!=
ÑÑ3 5
null
ÑÑ6 :
&&
ÑÑ; =
!
ÑÑ> ?
statusResponse
ÑÑ? M
.
ÑÑM N%
AccountUniqueIdentifier
ÑÑN e
.
ÑÑe f
IsEmpty
ÑÑf m
)
ÑÑm n
{
ÒÒ 	
await
ÓÓ /
!_applicationSecureStorageProvider
ÓÓ 3
.
ÓÓ3 4&
SetCurrentAccountIdAsync
ÓÓ4 L
(
ÓÓL M
statusResponse
ÓÓM [
.
ÓÓ[ \%
AccountUniqueIdentifier
ÓÓ\ s
)
ÓÓs t
.
ÔÔ 
ConfigureAwait
ÔÔ 
(
ÔÔ  
false
ÔÔ  %
)
ÔÔ% &
;
ÔÔ& '
}
ÕÕ 	
await
×× &
NavigateToSecureKeyAsync
×× &
(
××& '
)
××' (
;
××( )
}
ØØ 
private
ÚÚ 
void
ÚÚ (
HandleDataCorruptionStatus
ÚÚ +
(
ÚÚ+ ,3
%CheckMobileNumberAvailabilityResponse
ÚÚ, Q
statusResponse
ÚÚR `
)
ÚÚ` a
{
ÛÛ 
string
ÜÜ 
corruptionError
ÜÜ 
=
ÜÜ  
!
ÜÜ! "
string
ÜÜ" (
.
ÜÜ( )
IsNullOrEmpty
ÜÜ) 6
(
ÜÜ6 7
statusResponse
ÜÜ7 E
.
ÜÜE F
LocalizationKey
ÜÜF U
)
ÜÜU V
?
ÝÝ !
LocalizationService
ÝÝ !
[
ÝÝ! "
statusResponse
ÝÝ" 0
.
ÝÝ0 1
LocalizationKey
ÝÝ1 @
]
ÝÝ@ A
:
ÞÞ !
LocalizationService
ÞÞ !
[
ÞÞ! "
$str
ÞÞ" K
]
ÞÞK L
;
ÞÞL M
	ShowError
ßß 
(
ßß 
corruptionError
ßß !
)
ßß! "
;
ßß" #
}
àà 
private
ââ 
void
ââ %
HandleMobileTakenStatus
ââ (
(
ââ( )3
%CheckMobileNumberAvailabilityResponse
ââ) N
statusResponse
ââO ]
)
ââ] ^
{
ãã 
string
ää 

takenError
ää 
=
ää 
!
ää 
string
ää #
.
ää# $
IsNullOrEmpty
ää$ 1
(
ää1 2
statusResponse
ää2 @
.
ää@ A
LocalizationKey
ääA P
)
ääP Q
?
åå !
LocalizationService
åå !
[
åå! "
statusResponse
åå" 0
.
åå0 1
LocalizationKey
åå1 @
]
åå@ A
:
ææ !
LocalizationService
ææ !
[
ææ! "
$str
ææ" T
]
ææT U
;
ææU V
	ShowError
çç 
(
çç 

takenError
çç 
)
çç 
;
çç 
}
èè 
private
êê 
void
êê $
HandleUnexpectedStatus
êê '
(
êê' (3
%CheckMobileNumberAvailabilityResponse
êê( M
statusResponse
êêN \
)
êê\ ]
{
ëë 
string
ìì 
defaultError
ìì 
=
ìì 
!
ìì 
string
ìì %
.
ìì% &
IsNullOrEmpty
ìì& 3
(
ìì3 4
statusResponse
ìì4 B
.
ììB C
LocalizationKey
ììC R
)
ììR S
?
íí !
LocalizationService
íí !
[
íí! "
statusResponse
íí" 0
.
íí0 1
LocalizationKey
íí1 @
]
íí@ A
:
îî !
LocalizationService
îî !
[
îî! "
$str
îî" T
]
îîT U
;
îîU V
	ShowError
ïï 
(
ïï 
defaultError
ïï 
)
ïï 
;
ïï  
}
ðð 
private
òò 
async
òò 
Task
òò &
ExecuteRecoveryFlowAsync
òò /
(
òò/ 0
uint
òò0 4
	connectId
òò5 >
,
òò> ?
CancellationToken
òò@ Q
operationToken
òòR `
)
òò` a
{
óó 
Task
ôô 
<
ôô 
Result
ôô 
<
ôô 

ByteString
ôô 
,
ôô 
string
ôô  &
>
ôô& '
>
ôô' ($
recoveryValidationTask
ôô) ?
=
ôô@ A'
_secureKeyRecoveryService
õõ %
!
õõ% &
.
õõ& ',
ValidateMobileForRecoveryAsync
õõ' E
(
õõE F
MobileNumber
õõF R
,
õõR S
	connectId
õõT ]
,
õõ] ^
operationToken
õõ_ m
)
õõm n
;
õõn o
Result
÷÷ 
<
÷÷ 

ByteString
÷÷ 
,
÷÷ 
string
÷÷ !
>
÷÷! "
result
÷÷# )
=
÷÷* +
await
÷÷, 1$
recoveryValidationTask
÷÷2 H
;
÷÷H I
if
ùù 

(
ùù 
_isDisposed
ùù 
)
ùù 
{
úú 	
return
ûû 
;
ûû 
}
üü 	
if
þþ 

(
þþ 
result
þþ 
.
þþ 
IsErr
þþ 
)
þþ 
{
ÿÿ 	
	ShowError
€€ 
(
€€ 
result
€€ 
.
€€ 
	UnwrapErr
€€ &
(
€€& '
)
€€' (
)
€€( )
;
€€) *
return
 
;
 
}
‚‚ 	

ByteString
„„ $
mobileNumberIdentifier
„„ )
=
„„* +
result
„„, 2
.
„„2 3
Unwrap
„„3 9
(
„„9 :
)
„„: ;
;
„„; < 
VerifyOtpViewModel
†† 
vm
†† 
=
†† 
new
††  #
(
††# $"
_connectivityService
††$ 8
,
††8 9
NetworkProvider
††: I
,
††I J!
LocalizationService
††K ^
,
††^ _

HostScreen
††` j
,
††j k$
mobileNumberIdentifier
‡‡ "
,
‡‡" #/
!_applicationSecureStorageProvider
‡‡$ E
,
‡‡E F"
_registrationService
‡‡G [
,
‡‡[ \
_flowContext
ˆˆ 
,
ˆˆ '
_secureKeyRecoveryService
ˆˆ 3
)
ˆˆ3 4
;
ˆˆ4 5
if
ŠŠ 

(
ŠŠ 

HostScreen
ŠŠ 
is
ŠŠ %
AuthenticationViewModel
ŠŠ 1

hostWindow
ŠŠ2 <
)
ŠŠ< =
{
‹‹ 	

hostWindow
ŒŒ 
.
ŒŒ "
RecoveryMobileNumber
ŒŒ +
=
ŒŒ, -
MobileNumber
ŒŒ. :
;
ŒŒ: ;

hostWindow
 
.
 !
NavigateToViewModel
 *
(
* +
vm
+ -
)
- .
;
. /
}
ŽŽ 	
}
 
private
‘‘ 
void
‘‘ 
	ShowError
‘‘ 
(
‘‘ 
string
‘‘ !
errorMessage
‘‘" .
)
‘‘. /
{
’’ 
if
““ 

(
““ 

HostScreen
““ 
is
““ %
AuthenticationViewModel
““ 1

hostWindow
““2 <
&&
““= ?
!
”” 
string
”” 
.
”” 
IsNullOrEmpty
”” !
(
””! "
errorMessage
””" .
)
””. /
)
””/ 0
{
•• 	)
ShowServerErrorNotification
–– '
(
––' (

hostWindow
––( 2
,
––2 3
errorMessage
––4 @
)
––@ A
;
––A B
}
—— 	
}
˜˜ 
private
šš 
Task
šš ,
NavigateToOtpVerificationAsync
šš /
(
šš/ 0

ByteString
šš0 :$
mobileNumberIdentifier
šš; Q
)
ššQ R
{
›› 
if
œœ 

(
œœ 
_isDisposed
œœ 
)
œœ 
{
 	
return
žž 
Task
žž 
.
žž 
CompletedTask
žž %
;
žž% &
}
ŸŸ 	 
VerifyOtpViewModel
¡¡ 
vm
¡¡ 
=
¡¡ 
new
¡¡  #
(
¡¡# $"
_connectivityService
¡¡$ 8
,
¡¡8 9
NetworkProvider
¡¡: I
,
¡¡I J!
LocalizationService
¡¡K ^
,
¡¡^ _

HostScreen
¡¡` j
,
¡¡j k$
mobileNumberIdentifier
¢¢ "
,
¢¢" #/
!_applicationSecureStorageProvider
¢¢$ E
,
¢¢E F"
_registrationService
¢¢G [
)
¢¢[ \
;
¢¢\ ]
if
¤¤ 

(
¤¤ 

HostScreen
¤¤ 
is
¤¤ %
AuthenticationViewModel
¤¤ 1

hostWindow
¤¤2 <
)
¤¤< =
{
¥¥ 	

hostWindow
¦¦ 
.
¦¦ &
RegistrationMobileNumber
¦¦ /
=
¦¦0 1
MobileNumber
¦¦2 >
;
¦¦> ?

hostWindow
§§ 
.
§§ !
NavigateToViewModel
§§ *
(
§§* +
vm
§§+ -
)
§§- .
;
§§. /
}
¨¨ 	
return
ªª 
Task
ªª 
.
ªª 
CompletedTask
ªª !
;
ªª! "
}
«« 
private
­­ 
Task
­­ &
NavigateToSecureKeyAsync
­­ )
(
­­) *
)
­­* +
{
®® 
if
¯¯ 

(
¯¯ 
_isDisposed
¯¯ 
)
¯¯ 
{
°° 	
return
±± 
Task
±± 
.
±± 
CompletedTask
±± %
;
±±% &
}
²² 	
if
´´ 

(
´´ 

HostScreen
´´ 
is
´´ %
AuthenticationViewModel
´´ 1

hostWindow
´´2 <
)
´´< =
{
µµ 	

hostWindow
¶¶ 
.
¶¶ &
RegistrationMobileNumber
¶¶ /
=
¶¶0 1
MobileNumber
¶¶2 >
;
¶¶> ?

hostWindow
·· 
.
·· 
Navigate
·· 
.
··  
Execute
··  '
(
··' ( 
MembershipViewType
··( :
.
··: ;*
SECURE_KEY_CONFIRMATION_VIEW
··; W
)
··W X
.
··X Y
	Subscribe
··Y b
(
··b c
)
··c d
;
··d e
}
¸¸ 	
return
ºº 
Task
ºº 
.
ºº 
CompletedTask
ºº !
;
ºº! "
}
»» 
public
½½ 

new
½½ 
void
½½ 
Dispose
½½ 
(
½½ 
)
½½ 
{
¾¾ 
Dispose
¿¿ 
(
¿¿ 
true
¿¿ 
)
¿¿ 
;
¿¿ 
}
ÀÀ 
	protected
ÂÂ 
override
ÂÂ 
void
ÂÂ 
Dispose
ÂÂ #
(
ÂÂ# $
bool
ÂÂ$ (
	disposing
ÂÂ) 2
)
ÂÂ2 3
{
ÃÃ 
if
ÄÄ 

(
ÄÄ 
_isDisposed
ÄÄ 
)
ÄÄ 
{
ÅÅ 	
return
ÆÆ 
;
ÆÆ 
}
ÇÇ 	
if
ÉÉ 

(
ÉÉ 
	disposing
ÉÉ 
)
ÉÉ 
{
ÊÊ 	$
CancelCurrentOperation
ËË "
(
ËË" #
)
ËË# $
;
ËË$ %
_disposables
ÌÌ 
.
ÌÌ 
Dispose
ÌÌ  
(
ÌÌ  !
)
ÌÌ! "
;
ÌÌ" #
}
ÍÍ 	
base
ÏÏ 
.
ÏÏ 
Dispose
ÏÏ 
(
ÏÏ 
	disposing
ÏÏ 
)
ÏÏ 
;
ÏÏ  
_isDisposed
ÐÐ 
=
ÐÐ 
true
ÐÐ 
;
ÐÐ 
}
ÑÑ 
private
ÓÓ 
void
ÓÓ $
CancelCurrentOperation
ÓÓ '
(
ÓÓ' (
)
ÓÓ( )
{
ÔÔ %
CancellationTokenSource
ÕÕ 
?
ÕÕ  
operationSource
ÕÕ! 0
=
ÕÕ1 2
Interlocked
ÕÕ3 >
.
ÕÕ> ?
Exchange
ÕÕ? G
(
ÕÕG H
ref
ÖÖ "
_currentOperationCts
ÖÖ $
,
ÖÖ$ %
null
×× 
)
×× 
;
×× 
if
ÙÙ 

(
ÙÙ 
operationSource
ÙÙ 
!=
ÙÙ 
null
ÙÙ #
)
ÙÙ# $
{
ÚÚ 	
try
ÛÛ 
{
ÜÜ 
operationSource
ÝÝ 
.
ÝÝ  
Cancel
ÝÝ  &
(
ÝÝ& '
)
ÝÝ' (
;
ÝÝ( )
}
ÞÞ 
catch
ßß 
(
ßß %
ObjectDisposedException
ßß *
)
ßß* +
{
àà 
}
ââ 
finally
ãã 
{
ää 
operationSource
åå 
.
åå  
Dispose
åå  '
(
åå' (
)
åå( )
;
åå) *
}
ææ 
}
çç 	
}
èè 
}éé ÇÌ
š/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/ViewModels/Hosts/AuthenticationViewModel.cs
	namespace%% 	
Ecliptix%%
 
.%% 
Core%% 
.%% 
Features%%  
.%%  !
Authentication%%! /
.%%/ 0

ViewModels%%0 :
.%%: ;
Hosts%%; @
;%%@ A
public'' 
readonly'' 
struct'' /
#AuthenticationViewModelDependencies'' :
{(( 
public)) 

required))  
IConnectivityService)) (
ConnectivityService))) <
{))= >
get))? B
;))B C
init))D H
;))H I
}))J K
public** 

required** 
NetworkProvider** #
NetworkProvider**$ 3
{**4 5
get**6 9
;**9 :
init**; ?
;**? @
}**A B
public++ 

required++  
ILocalizationService++ (
LocalizationService++) <
{++= >
get++? B
;++B C
init++D H
;++H I
}++J K
public,, 

required,, -
!IApplicationSecureStorageProvider,, 5
StorageProvider,,6 E
{,,F G
get,,H K
;,,K L
init,,M Q
;,,Q R
},,S T
public-- 

required-- "
IAuthenticationService-- *!
AuthenticationService--+ @
{--A B
get--C F
;--F G
init--H L
;--L M
}--N O
public.. 

required.. &
IOpaqueRegistrationService.. .
RegistrationService../ B
{..C D
get..E H
;..H I
init..J N
;..N O
}..P Q
public// 

required// %
ISecureKeyRecoveryService// -
RecoveryService//. =
{//> ?
get//@ C
;//C D
init//E I
;//I J
}//K L
public00 

required00 %
ILanguageDetectionService00 -$
LanguageDetectionService00. F
{00G H
get00I L
;00L M
init00N R
;00R S
}00T U
public11 

required11 
IApplicationRouter11 &
Router11' -
{11. /
get110 3
;113 4
init115 9
;119 :
}11; <
public22 

required22 
MainWindowViewModel22 '
MainWindowViewModel22( ;
{22< =
get22> A
;22A B
init22C G
;22G H
}22I J
public33 

required33 !
DefaultSystemSettings33 )
Settings33* 2
{333 4
get335 8
;338 9
init33: >
;33> ?
}33@ A
}44 
public66 
readonly66 
struct66 #
ViewModelFactoryContext66 .
{77 
public88 

required88  
IConnectivityService88 (
ConnectivityService88) <
{88= >
get88? B
;88B C
init88D H
;88H I
}88J K
public99 

required99 
NetworkProvider99 #
NetworkProvider99$ 3
{994 5
get996 9
;999 :
init99; ?
;99? @
}99A B
public:: 

required::  
ILocalizationService:: (
LocalizationService::) <
{::= >
get::? B
;::B C
init::D H
;::H I
}::J K
public;; 

required;; "
IAuthenticationService;; *!
AuthenticationService;;+ @
{;;A B
get;;C F
;;;F G
init;;H L
;;;L M
};;N O
public<< 

required<< -
!IApplicationSecureStorageProvider<< 5
StorageProvider<<6 E
{<<F G
get<<H K
;<<K L
init<<M Q
;<<Q R
}<<S T
public== 

required== #
AuthenticationViewModel== +
HostViewModel==, 9
{==: ;
get==< ?
;==? @
init==A E
;==E F
}==G H
public>> 

required>> &
IOpaqueRegistrationService>> .
RegistrationService>>/ B
{>>C D
get>>E H
;>>H I
init>>J N
;>>N O
}>>P Q
public?? 

required?? %
ISecureKeyRecoveryService?? -
RecoveryService??. =
{??> ?
get??@ C
;??C D
init??E I
;??I J
}??K L
public@@ 

required@@ %
AuthenticationFlowContext@@ -
FlowContext@@. 9
{@@: ;
get@@< ?
;@@? @
init@@A E
;@@E F
}@@G H
}AA 
publicCC 
classCC #
AuthenticationViewModelCC $
:CC% &
CoreCC' +
.CC+ ,
MVVMCC, 0
.CC0 1
ViewModelBaseCC1 >
,CC> ?
IScreenCC@ G
{DD 
privateEE 
staticEE 
readonlyEE 
AppCultureSettingsEE .
LanguageConfigEE/ =
=EE> ?
AppCultureSettingsEE@ R
.EER S
DefaultEES Z
;EEZ [
privateGG 
staticGG 
readonlyGG 
FrozenDictionaryGG ,
<GG, -
MembershipViewTypeGG- ?
,GG? @
FuncGGA E
<GGE F#
ViewModelFactoryContextGGF ]
,GG] ^
IRoutableViewModelGG_ q
>GGq r
>GGr s
ViewModelFactoriesHH 
=HH 
newHH  

DictionaryHH! +
<HH+ ,
MembershipViewTypeHH, >
,HH> ?
FuncHH@ D
<HHD E#
ViewModelFactoryContextHHE \
,HH\ ]
IRoutableViewModelHH^ p
>HHp q
>HHq r
{II 	
[JJ 
MembershipViewTypeJJ 
.JJ  
SIGN_IN_VIEWJJ  ,
]JJ, -
=JJ. /
ctxJJ0 3
=>JJ4 6
newKK 
SignInViewModelKK #
(KK# $
ctxKK$ '
.KK' (
ConnectivityServiceKK( ;
,KK; <
ctxKK= @
.KK@ A
NetworkProviderKKA P
,KKP Q
ctxKKR U
.KKU V
LocalizationServiceKKV i
,KKi j
ctxLL 
.LL !
AuthenticationServiceLL -
,LL- .
ctxLL/ 2
.LL2 3
HostViewModelLL3 @
)LL@ A
,LLA B
[MM 
MembershipViewTypeMM 
.MM  
WELCOME_VIEWMM  ,
]MM, -
=MM. /
ctxMM0 3
=>MM4 6
newNN 
WelcomeViewModelNN $
(NN$ %
ctxNN% (
.NN( )
HostViewModelNN) 6
,NN6 7
ctxNN8 ;
.NN; <
LocalizationServiceNN< O
,NNO P
ctxNNQ T
.NNT U
NetworkProviderNNU d
)NNd e
,NNe f
[OO 
MembershipViewTypeOO 
.OO  $
MOBILE_VERIFICATION_VIEWOO  8
]OO8 9
=OO: ;
ctxOO< ?
=>OO@ B
newPP '
MobileVerificationViewModelPP /
(PP/ 0
ctxPP0 3
.PP3 4
ConnectivityServicePP4 G
,PPG H
ctxPPI L
.PPL M
NetworkProviderPPM \
,PP\ ]
ctxPP^ a
.PPa b
LocalizationServicePPb u
,PPu v
ctxQQ 
.QQ 
HostViewModelQQ %
,QQ% &
ctxQQ' *
.QQ* +
StorageProviderQQ+ :
,QQ: ;
ctxQQ< ?
.QQ? @
RegistrationServiceQQ@ S
,QQS T
ctxRR 
.RR 
RecoveryServiceRR '
,RR' (
ctxRR) ,
.RR, -
FlowContextRR- 8
)RR8 9
,RR9 :
[SS 
MembershipViewTypeSS 
.SS  (
SECURE_KEY_CONFIRMATION_VIEWSS  <
]SS< =
=SS> ?
ctxSS@ C
=>SSD F
newTT &
SecureKeyVerifierViewModelTT .
(TT. /
ctxTT/ 2
.TT2 3
ConnectivityServiceTT3 F
,TTF G
ctxTTH K
.TTK L
NetworkProviderTTL [
,TT[ \
ctxTT] `
.TT` a
LocalizationServiceTTa t
,TTt u
ctxUU 
.UU 
HostViewModelUU %
,UU% &
ctxUU' *
.UU* +
StorageProviderUU+ :
,UU: ;
ctxUU< ?
.UU? @
RegistrationServiceUU@ S
,UUS T
ctxUUU X
.UUX Y!
AuthenticationServiceUUY n
,UUn o
ctxVV 
.VV 
RecoveryServiceVV '
,VV' (
ctxVV) ,
.VV, -
FlowContextVV- 8
)VV8 9
,VV9 :
[WW 
MembershipViewTypeWW 
.WW  
PIN_SET_VIEWWW  ,
]WW, -
=WW. /
ctxWW0 3
=>WW4 6
newXX 
PassPhaseViewModelXX &
(XX& '
ctxXX' *
.XX* +
LocalizationServiceXX+ >
,XX> ?
ctxXX@ C
.XXC D
HostViewModelXXD Q
,XXQ R
ctxXXS V
.XXV W
NetworkProviderXXW f
)XXf g
,XXg h
}YY 	
.YY	 

ToFrozenDictionaryYY
 
(YY 
)YY 
;YY 
private[[ 
readonly[[ -
!IApplicationSecureStorageProvider[[ 6-
!_applicationSecureStorageProvider[[7 X
;[[X Y
private\\ 
readonly\\  
IConnectivityService\\ ) 
_connectivityService\\* >
;\\> ?
private]] 
readonly]] 
NetworkProvider]] $
_networkProvider]]% 5
;]]5 6
private^^ 
readonly^^ %
ILanguageDetectionService^^ .%
_languageDetectionService^^/ H
;^^H I
private__ 
readonly__  
ILocalizationService__ ) 
_localizationService__* >
;__> ?
private`` 
readonly`` 
MainWindowViewModel`` ( 
_mainWindowViewModel``) =
;``= >
privateaa 
readonlyaa "
IAuthenticationServiceaa +"
_authenticationServiceaa, B
;aaB C
privatebb 
readonlybb &
IOpaqueRegistrationServicebb /&
_opaqueRegistrationServicebb0 J
;bbJ K
privatecc 
readonlycc %
ISecureKeyRecoveryServicecc .%
_secureKeyRecoveryServicecc/ H
;ccH I
privatedd 
readonlydd !
DefaultSystemSettingsdd *
	_settingsdd+ 4
;dd4 5
privateff 
readonlyff 

Dictionarygg 
<gg 
(gg 
MembershipViewTypegg &
ViewTypegg' /
,gg/ 0%
AuthenticationFlowContextgg1 J
FlowContextggK V
)ggV W
,ggW X
WeakReferencehh 
<hh 
IRoutableViewModelhh ,
>hh, -
>hh- .
_viewModelCachehh/ >
=hh? @
newhhA D
(hhD E
)hhE F
;hhF G
privatejj 
readonlyjj 
Stackjj 
<jj 
IRoutableViewModeljj -
>jj- .
_navigationStackjj/ ?
=jj@ A
newjjB E
(jjE F
)jjF G
;jjG H
privatell 
boolll 
_canNavigateBackll !
;ll! "
privatemm 
IDisposablemm 
?mm !
_languageSubscriptionmm .
;mm. /
privatenn 
IDisposablenn 
?nn *
_bottomSheetHiddenSubscriptionnn 7
;nn7 8
privateoo 
IRoutableViewModeloo 
?oo 
_currentViewoo  ,
;oo, -
publicqq 
%
AuthenticationFlowContextqq $
CurrentFlowContextqq% 7
{qq8 9
getqq: =
;qq= >
setqq? B
;qqB C
}qqD E
=qqF G%
AuthenticationFlowContextqqH a
.qqa b
REGISTRATIONqqb n
;qqn o
publicss 
#
AuthenticationViewModelss "
(ss" #/
#AuthenticationViewModelDependenciesss# F
dependenciesssG S
)ssS T
:tt 	
basett
 
(tt 
dependenciestt 
.tt 
NetworkProvidertt +
,tt+ ,
dependenciestt- 9
.tt9 :
LocalizationServicett: M
)ttM N
{uu  
_localizationServicevv 
=vv 
dependenciesvv +
.vv+ ,
LocalizationServicevv, ?
;vv? @ 
_connectivityServiceww 
=ww 
dependenciesww +
.ww+ ,
ConnectivityServiceww, ?
;ww? @-
!_applicationSecureStorageProviderxx )
=xx* +
dependenciesxx, 8
.xx8 9
StorageProviderxx9 H
;xxH I
_networkProvideryy 
=yy 
dependenciesyy '
.yy' (
NetworkProvideryy( 7
;yy7 8"
_authenticationServicezz 
=zz  
dependencieszz! -
.zz- .!
AuthenticationServicezz. C
;zzC D&
_opaqueRegistrationService{{ "
={{# $
dependencies{{% 1
.{{1 2
RegistrationService{{2 E
;{{E F%
_secureKeyRecoveryService|| !
=||" #
dependencies||$ 0
.||0 1
RecoveryService||1 @
;||@ A%
_languageDetectionService}} !
=}}" #
dependencies}}$ 0
.}}0 1$
LanguageDetectionService}}1 I
;}}I J 
_mainWindowViewModel~~ 
=~~ 
dependencies~~ +
.~~+ ,
MainWindowViewModel~~, ?
;~~? @
	_settings 
= 
dependencies  
.  !
Settings! )
;) *#
InitializeVersionInfo
 
(
 
)
 
;
   
InitializeCommands
‚‚ 
(
‚‚ 
dependencies
‚‚ '
.
‚‚' (
Router
‚‚( .
)
‚‚. /
;
‚‚/ 0%
SetupActivationBehavior
ƒƒ 
(
ƒƒ  
)
ƒƒ  !
;
ƒƒ! "
}
„„ 
public
†† 
 
IRoutableViewModel
†† 
?
†† 
CurrentView
†† *
{
‡‡ 
get
ˆˆ 
=>
ˆˆ 
_currentView
ˆˆ 
;
ˆˆ 
private
‰‰ 
set
‰‰ 
{
ŠŠ 	
this
‹‹ 
.
‹‹ "
RaiseAndSetIfChanged
‹‹ %
(
‹‹% &
ref
‹‹& )
_currentView
‹‹* 6
,
‹‹6 7
value
‹‹8 =
)
‹‹= >
;
‹‹> ?
CanNavigateBack
 
=
 
_navigationStack
 .
.
. /
Count
/ 4
>
5 6
$num
7 8
;
8 9
}
ŽŽ 	
}
 
public
‘‘ 

bool
‘‘ 
CanNavigateBack
‘‘ 
{
’’ 
get
““ 
=>
““ 
_canNavigateBack
““ 
;
““  
private
”” 
set
”” 
=>
”” 
this
”” 
.
”” "
RaiseAndSetIfChanged
”” 0
(
””0 1
ref
””1 4
_canNavigateBack
””5 E
,
””E F
value
””G L
)
””L M
;
””M N
}
•• 
public
—— 

RoutingState
—— 
Router
—— 
=>
—— !
new
——" %
(
——% &
)
——& '
;
——' (
public
™™ 

string
™™ 

AppVersion
™™ 
{
™™ 
get
™™ "
;
™™" #
private
™™$ +
set
™™, /
;
™™/ 0
}
™™1 2
=
™™3 4
string
™™5 ;
.
™™; <
Empty
™™< A
;
™™A B
public
›› 

string
›› 
FullVersionInfo
›› !
{
››" #
get
››$ '
;
››' (
private
››) 0
set
››1 4
;
››4 5
}
››6 7
=
››8 9
string
››: @
.
››@ A
Empty
››A F
;
››F G
public
 

string
 
?
 &
RegistrationMobileNumber
 +
{
, -
get
. 1
;
1 2
set
3 6
;
6 7
}
8 9
public
ŸŸ 

string
ŸŸ 
?
ŸŸ "
RecoveryMobileNumber
ŸŸ '
{
ŸŸ( )
get
ŸŸ* -
;
ŸŸ- .
set
ŸŸ/ 2
;
ŸŸ2 3
}
ŸŸ4 5
public
¡¡ 

ReactiveCommand
¡¡ 
<
¡¡  
MembershipViewType
¡¡ -
,
¡¡- . 
IRoutableViewModel
¡¡/ A
>
¡¡A B
Navigate
¡¡C K
{
¡¡L M
get
¡¡N Q
;
¡¡Q R
private
¡¡S Z
set
¡¡[ ^
;
¡¡^ _
}
¡¡` a
=
¡¡b c
null
¡¡d h
!
¡¡h i
;
¡¡i j
public
££ 

ReactiveCommand
££ 
<
££ 
Unit
££ 
,
££   
IRoutableViewModel
££! 3
?
££3 4
>
££4 5
NavigateBack
££6 B
{
££C D
get
££E H
;
££H I
private
££J Q
set
££R U
;
££U V
}
££W X
=
££Y Z
null
££[ _
!
££_ `
;
££` a
public
¥¥ 

ReactiveCommand
¥¥ 
<
¥¥ 
Unit
¥¥ 
,
¥¥  
Unit
¥¥! %
>
¥¥% &'
SwitchToMainWindowCommand
¥¥' @
{
¥¥A B
get
¥¥C F
;
¥¥F G
private
¥¥H O
set
¥¥P S
;
¥¥S T
}
¥¥U V
=
¥¥W X
null
¥¥Y ]
!
¥¥] ^
;
¥¥^ _
public
§§ 

ReactiveCommand
§§ 
<
§§ 
Unit
§§ 
,
§§  
Unit
§§! %
>
§§% &&
OpenPrivacyPolicyCommand
§§' ?
{
§§@ A
get
§§B E
;
§§E F
private
§§G N
set
§§O R
;
§§R S
}
§§T U
=
§§V W
null
§§X \
!
§§\ ]
;
§§] ^
public
©© 

ReactiveCommand
©© 
<
©© 
Unit
©© 
,
©©  
Unit
©©! %
>
©©% &'
OpenTermsOfServiceCommand
©©' @
{
©©A B
get
©©C F
;
©©F G
private
©©H O
set
©©P S
;
©©S T
}
©©U V
=
©©W X
null
©©Y ]
!
©©] ^
;
©©^ _
public
«« 

ReactiveCommand
«« 
<
«« 
Unit
«« 
,
««  
Unit
««! %
>
««% & 
OpenSupportCommand
««' 9
{
««: ;
get
««< ?
;
««? @
private
««A H
set
««I L
;
««L M
}
««N O
=
««P Q
null
««R V
!
««V W
;
««W X
public
­­ 

ReactiveCommand
­­ 
<
­­ 
Unit
­­ 
,
­­  
Unit
­­! %
>
­­% &0
"CheckCountryCultureMismatchCommand
­­' I
{
­­J K
get
­­L O
;
­­O P
private
­­Q X
set
­­Y \
;
­­\ ]
}
­­^ _
=
­­` a
null
­­b f
!
­­f g
;
­­g h
public
¯¯ 

void
¯¯ "
ClearNavigationStack
¯¯ $
(
¯¯$ %
bool
¯¯% )$
preserveInitialWelcome
¯¯* @
=
¯¯A B
false
¯¯C H
,
¯¯H I 
MembershipViewType
¯¯J \
?
¯¯\ ]
preserveViewType
¯¯^ n
=
¯¯o p
null
¯¯q u
)
¯¯u v
{
°° 
if
±± 

(
±± 
_currentView
±± 
is
±± 
IResettable
±± '
currentResettable
±±( 9
)
±±9 :
{
²² 	
currentResettable
³³ 
.
³³ 

ResetState
³³ (
(
³³( )
)
³³) *
;
³³* +
}
´´ 	
_navigationStack
¶¶ 
.
¶¶ 
Clear
¶¶ 
(
¶¶ 
)
¶¶  
;
¶¶  !
if
¸¸ 

(
¸¸ $
preserveInitialWelcome
¸¸ "
)
¸¸" #
{
¹¹ 	 
IRoutableViewModel
ºº 
welcomeView
ºº *
=
ºº+ ,)
GetOrCreateViewModelForView
ºº- H
(
ººH I 
MembershipViewType
»» "
.
»»" #
WELCOME_VIEW
»»# /
,
»»/ 0

resetState
¼¼ 
:
¼¼ 
true
¼¼  
)
¼¼  !
;
¼¼! "
_navigationStack
½½ 
.
½½ 
Push
½½ !
(
½½! "
welcomeView
½½" -
)
½½- .
;
½½. /
}
¾¾ 	
if
ÀÀ 

(
ÀÀ 
preserveViewType
ÀÀ 
.
ÀÀ 
HasValue
ÀÀ %
)
ÀÀ% &
{
ÁÁ 	 
IRoutableViewModel
ÂÂ 
preservedView
ÂÂ ,
=
ÂÂ- .)
GetOrCreateViewModelForView
ÂÂ/ J
(
ÂÂJ K
preserveViewType
ÃÃ  
.
ÃÃ  !
Value
ÃÃ! &
,
ÃÃ& '

resetState
ÄÄ 
:
ÄÄ 
true
ÄÄ  
)
ÄÄ  !
;
ÄÄ! "
_navigationStack
ÅÅ 
.
ÅÅ 
Push
ÅÅ !
(
ÅÅ! "
preservedView
ÅÅ" /
)
ÅÅ/ 0
;
ÅÅ0 1
}
ÆÆ 	
_currentView
ÈÈ 
=
ÈÈ 
null
ÈÈ 
;
ÈÈ 
this
ÉÉ 
.
ÉÉ "
RaisePropertyChanged
ÉÉ !
(
ÉÉ! "
nameof
ÉÉ" (
(
ÉÉ( )
CurrentView
ÉÉ) 4
)
ÉÉ4 5
)
ÉÉ5 6
;
ÉÉ6 7
CanNavigateBack
ËË 
=
ËË 
_navigationStack
ËË *
.
ËË* +
Count
ËË+ 0
>
ËË1 2
$num
ËË3 4
;
ËË4 5
}
ÌÌ 
public
ÏÏ 

void
ÏÏ !
NavigateToViewModel
ÏÏ #
(
ÏÏ# $ 
IRoutableViewModel
ÏÏ$ 6
	viewModel
ÏÏ7 @
)
ÏÏ@ A
{
ÐÐ 
if
ÑÑ 

(
ÑÑ 
_currentView
ÑÑ 
!=
ÑÑ 
null
ÑÑ  
)
ÑÑ  !
{
ÒÒ 	
if
ÓÓ 
(
ÓÓ 
_currentView
ÓÓ 
is
ÓÓ 
IResettable
ÓÓ  +
currentResettable
ÓÓ, =
)
ÓÓ= >
{
ÔÔ 
currentResettable
ÕÕ !
.
ÕÕ! "

ResetState
ÕÕ" ,
(
ÕÕ, -
)
ÕÕ- .
;
ÕÕ. /
}
ÖÖ 
_navigationStack
ØØ 
.
ØØ 
Push
ØØ !
(
ØØ! "
_currentView
ØØ" .
)
ØØ. /
;
ØØ/ 0
}
ÙÙ 	
CurrentView
ÛÛ 
=
ÛÛ 
	viewModel
ÛÛ 
;
ÛÛ  
}
ÜÜ 
public
ÞÞ 

void
ÞÞ (
StartSecureKeyRecoveryFlow
ÞÞ *
(
ÞÞ* +
)
ÞÞ+ ,
{
ßß "
ClearNavigationStack
àà 
(
àà 
true
àà !
)
àà! "
;
àà" # 
CurrentFlowContext
áá 
=
áá '
AuthenticationFlowContext
áá 6
.
áá6 7!
SECURE_KEY_RECOVERY
áá7 J
;
ááJ K
Navigate
ââ 
.
ââ 
Execute
ââ 
(
ââ  
MembershipViewType
ââ +
.
ââ+ ,&
MOBILE_VERIFICATION_VIEW
ââ, D
)
ââD E
.
ââE F
	Subscribe
ââF O
(
ââO P
)
ââP Q
;
ââQ R
}
ãã 
public
åå 

async
åå 
Task
åå 
ShowBottomSheet
åå %
(
åå% &&
BottomSheetComponentType
åå& >
componentType
åå? L
,
ååL M
UserControl
ååN Y
redirectView
ååZ f
,
ååf g
bool
ææ 
	showScrim
ææ 
=
ææ 
true
ææ 
,
ææ 
bool
ææ #
isDismissable
ææ$ 1
=
ææ2 3
false
ææ4 9
)
ææ9 :
{
çç 
if
èè 

(
èè 
Application
èè 
.
èè 
Current
èè 
?
èè  
.
èè  !!
ApplicationLifetime
èè! 4
is
èè5 75
'IClassicDesktopStyleApplicationLifetime
èè8 _
)
èè_ `
{
éé 	
await
êê 

Dispatcher
êê 
.
êê 
UIThread
êê %
.
êê% &
InvokeAsync
êê& 1
(
êê1 2
async
êê2 7
(
êê8 9
)
êê9 :
=>
êê; =
{
ëë 
await
ìì "
_mainWindowViewModel
ìì *
.
ìì* +"
ShowBottomSheetAsync
ìì+ ?
(
ìì? @
componentType
ìì@ M
,
ììM N
redirectView
ììO [
,
ìì[ \
	showScrim
íí 
:
íí 
	showScrim
íí (
,
íí( )
isDismissable
íí* 7
:
íí7 8
isDismissable
íí9 F
)
ííF G
.
ííG H
ConfigureAwait
ííH V
(
ííV W
false
ííW \
)
íí\ ]
;
íí] ^
}
îî 
)
îî 
.
îî 
ConfigureAwait
îî 
(
îî 
false
îî #
)
îî# $
;
îî$ %
}
ïï 	
else
ðð 
{
ññ 	
await
òò "
_mainWindowViewModel
òò &
.
òò& '"
ShowBottomSheetAsync
òò' ;
(
òò; <
componentType
òò< I
,
òòI J
redirectView
òòK W
,
òòW X
	showScrim
óó 
:
óó 
	showScrim
óó $
,
óó$ %
isDismissable
óó& 3
:
óó3 4
isDismissable
óó5 B
)
óóB C
.
óóC D
ConfigureAwait
óóD R
(
óóR S
false
óóS X
)
óóX Y
;
óóY Z
}
ôô 	
}
õõ 
public
÷÷ 

async
÷÷ 
Task
÷÷ "
HideBottomSheetAsync
÷÷ *
(
÷÷* +
)
÷÷+ ,
{
øø 
if
ùù 

(
ùù 
Application
ùù 
.
ùù 
Current
ùù 
?
ùù  
.
ùù  !!
ApplicationLifetime
ùù! 4
is
ùù5 75
'IClassicDesktopStyleApplicationLifetime
ùù8 _
)
ùù_ `
{
úú 	
await
ûû 

Dispatcher
ûû 
.
ûû 
UIThread
ûû %
.
ûû% &
InvokeAsync
ûû& 1
(
ûû1 2
async
ûû2 7
(
ûû8 9
)
ûû9 :
=>
ûû; =
{
üü 
await
ýý "
_mainWindowViewModel
ýý *
.
ýý* +"
HideBottomSheetAsync
ýý+ ?
(
ýý? @
)
ýý@ A
.
ýýA B
ConfigureAwait
ýýB P
(
ýýP Q
false
ýýQ V
)
ýýV W
;
ýýW X
}
þþ 
)
þþ 
.
þþ 
ConfigureAwait
þþ 
(
þþ 
false
þþ #
)
þþ# $
;
þþ$ %
}
ÿÿ 	
else
€€ 
{
 	
await
‚‚ "
_mainWindowViewModel
‚‚ &
.
‚‚& '"
HideBottomSheetAsync
‚‚' ;
(
‚‚; <
)
‚‚< =
.
‚‚= >
ConfigureAwait
‚‚> L
(
‚‚L M
false
‚‚M R
)
‚‚R S
;
‚‚S T
}
ƒƒ 	
}
„„ 
	protected
†† 
override
†† 
void
†† 
Dispose
†† #
(
††# $
bool
††$ (
	disposing
††) 2
)
††2 3
{
‡‡ 
if
ˆˆ 

(
ˆˆ 
	disposing
ˆˆ 
)
ˆˆ 
{
‰‰ 	'
CleanupAuthenticationFlow
ŠŠ %
(
ŠŠ% &
)
ŠŠ& '
;
ŠŠ' (
}
‹‹ 	
base
 
.
 
Dispose
 
(
 
	disposing
 
)
 
;
  
}
ŽŽ 
private
 
static
 
void
 
OpenUrl
 
(
  
string
  &
url
' *
)
* +
{
‘‘ 
if
’’ 

(
’’ 
System
’’ 
.
’’ 
Runtime
’’ 
.
’’ 
InteropServices
’’ *
.
’’* + 
RuntimeInformation
’’+ =
.
’’= >
IsOSPlatform
’’> J
(
’’J K
System
’’K Q
.
’’Q R
Runtime
’’R Y
.
’’Y Z
InteropServices
’’Z i
.
’’i j

OSPlatform
’’j t
.
““ 
Windows
““ 
)
““ 
)
““ 
{
”” 	
System
•• 
.
•• 
Diagnostics
•• 
.
•• 
Process
•• &
.
••& '
Start
••' ,
(
••, -
new
–– 
System
–– 
.
–– 
Diagnostics
–– &
.
––& '
ProcessStartInfo
––' 7
(
––7 8
url
––8 ;
)
––; <
{
––= >
UseShellExecute
––? N
=
––O P
true
––Q U
}
––V W
)
––W X
;
––X Y
}
—— 	
else
˜˜ 
if
˜˜ 
(
˜˜ 
System
˜˜ 
.
˜˜ 
Runtime
˜˜ 
.
˜˜  
InteropServices
˜˜  /
.
˜˜/ 0 
RuntimeInformation
˜˜0 B
.
˜˜B C
IsOSPlatform
˜˜C O
(
˜˜O P
System
˜˜P V
.
˜˜V W
Runtime
˜˜W ^
.
˜˜^ _
InteropServices
˜˜_ n
.
™™ 

OSPlatform
™™  
.
™™  !
OSX
™™! $
)
™™$ %
)
™™% &
{
šš 	
System
›› 
.
›› 
Diagnostics
›› 
.
›› 
Process
›› &
.
››& '
Start
››' ,
(
››, -
$str
››- 3
,
››3 4
url
››5 8
)
››8 9
;
››9 :
}
œœ 	
else
 
if
 
(
 
System
 
.
 
Runtime
 
.
  
InteropServices
  /
.
/ 0 
RuntimeInformation
0 B
.
B C
IsOSPlatform
C O
(
O P
System
P V
.
V W
Runtime
W ^
.
^ _
InteropServices
_ n
.
žž 

OSPlatform
žž  
.
žž  !
Linux
žž! &
)
žž& '
)
žž' (
{
ŸŸ 	
System
   
.
   
Diagnostics
   
.
   
Process
   &
.
  & '
Start
  ' ,
(
  , -
$str
  - 7
,
  7 8
url
  9 <
)
  < =
;
  = >
}
¡¡ 	
else
¢¢ 
{
££ 	
Log
¤¤ 
.
¤¤ 
Warning
¤¤ 
(
¤¤ 
$str
¤¤ E
,
¤¤E F
url
¤¤G J
)
¤¤J K
;
¤¤K L
}
¥¥ 	
}
¦¦ 
private
¨¨ 
void
¨¨ '
CleanupAuthenticationFlow
¨¨ *
(
¨¨* +
)
¨¨+ ,
{
©© "
ClearNavigationStack
ªª 
(
ªª 
)
ªª 
;
ªª 
List
¬¬ 
<
¬¬ 
KeyValuePair
¬¬ 
<
¬¬ 
(
¬¬  
MembershipViewType
¬¬ -
viewType
¬¬. 6
,
¬¬6 7'
AuthenticationFlowContext
¬¬8 Q
actualFlowContext
¬¬R c
)
¬¬c d
,
¬¬d e
WeakReference
­­ 
<
­­  
IRoutableViewModel
­­ ,
>
­­, -
>
­­- .
>
­­. /
cachedItems
­­0 ;
=
­­< =
_viewModelCache
®® 
.
®® 
ToList
®® "
(
®®" #
)
®®# $
;
®®$ %
foreach
°° 
(
°° 
KeyValuePair
°° 
<
°° 
(
°°  
MembershipViewType
°° 1
viewType
°°2 :
,
°°: ;'
AuthenticationFlowContext
°°< U
actualFlowContext
°°V g
)
°°g h
,
°°h i
WeakReference
±± "
<
±±" # 
IRoutableViewModel
±±# 5
>
±±5 6
>
±±6 7
item
±±8 <
in
±±= ?
cachedItems
±±@ K
)
±±K L
{
²² 	
if
³³ 
(
³³ 
!
³³ 
item
³³ 
.
³³ 
Value
³³ 
.
³³ 
TryGetTarget
³³ (
(
³³( )
out
³³) , 
IRoutableViewModel
³³- ?
?
³³? @
	viewModel
³³A J
)
³³J K
)
³³K L
{
´´ 
continue
µµ 
;
µµ 
}
¶¶ 
if
¸¸ 
(
¸¸ 
	viewModel
¸¸ 
is
¸¸ 
IResettable
¸¸ (!
resettableViewModel
¸¸) <
)
¸¸< =
{
¹¹ !
resettableViewModel
ºº #
.
ºº# $

ResetState
ºº$ .
(
ºº. /
)
ºº/ 0
;
ºº0 1
}
»» 
if
½½ 
(
½½ 
	viewModel
½½ 
is
½½ 
IDisposable
½½ (!
disposableViewModel
½½) <
)
½½< =
{
¾¾ !
disposableViewModel
¿¿ #
.
¿¿# $
Dispose
¿¿$ +
(
¿¿+ ,
)
¿¿, -
;
¿¿- .
}
ÀÀ 
}
ÁÁ 	
_viewModelCache
ÃÃ 
.
ÃÃ 
Clear
ÃÃ 
(
ÃÃ 
)
ÃÃ 
;
ÃÃ  
CurrentView
ÄÄ 
=
ÄÄ 
null
ÄÄ 
;
ÄÄ 
}
ÅÅ 
private
ÇÇ 
async
ÇÇ 
Task
ÇÇ *
HandleLanguageDetectionEvent
ÇÇ 3
(
ÇÇ3 4*
LanguageDetectionDialogEvent
ÇÇ4 P
evt
ÇÇQ T
)
ÇÇT U
{
ÈÈ 
try
ÉÉ 
{
ÊÊ 	
switch
ËË 
(
ËË 
evt
ËË 
.
ËË 
Action
ËË 
)
ËË 
{
ÌÌ 
case
ÍÍ %
LanguageDetectionAction
ÍÍ ,
.
ÍÍ, -
Confirm
ÍÍ- 4
when
ÍÍ5 9
!
ÍÍ: ;
string
ÍÍ; A
.
ÍÍA B
IsNullOrEmpty
ÍÍB O
(
ÍÍO P
evt
ÍÍP S
.
ÍÍS T
TargetCulture
ÍÍT a
)
ÍÍa b
:
ÍÍb c'
ChangeApplicationLanguage
ÎÎ -
(
ÎÎ- .
evt
ÎÎ. 1
.
ÎÎ1 2
TargetCulture
ÎÎ2 ?
)
ÎÎ? @
;
ÎÎ@ A
break
ÏÏ 
;
ÏÏ 
case
ÑÑ %
LanguageDetectionAction
ÑÑ ,
.
ÑÑ, -
Decline
ÑÑ- 4
:
ÑÑ4 5
break
ÒÒ 
;
ÒÒ 
}
ÓÓ 
await
ÕÕ "
_mainWindowViewModel
ÕÕ &
.
ÕÕ& '"
HideBottomSheetAsync
ÕÕ' ;
(
ÕÕ; <
)
ÕÕ< =
.
ÕÕ= >
ConfigureAwait
ÕÕ> L
(
ÕÕL M
false
ÕÕM R
)
ÕÕR S
;
ÕÕS T
}
ÖÖ 	
finally
×× 
{
ØØ 	#
_languageSubscription
ÙÙ !
?
ÙÙ! "
.
ÙÙ" #
Dispose
ÙÙ# *
(
ÙÙ* +
)
ÙÙ+ ,
;
ÙÙ, -,
_bottomSheetHiddenSubscription
ÚÚ *
?
ÚÚ* +
.
ÚÚ+ ,
Dispose
ÚÚ, 3
(
ÚÚ3 4
)
ÚÚ4 5
;
ÚÚ5 6
}
ÛÛ 	
}
ÜÜ 
private
ÞÞ 
void
ÞÞ '
ChangeApplicationLanguage
ÞÞ *
(
ÞÞ* +
string
ÞÞ+ 1
targetCulture
ÞÞ2 ?
)
ÞÞ? @
{
ßß "
_localizationService
àà 
.
àà 

SetCulture
àà '
(
àà' (
targetCulture
àà( 5
,
àà5 6
(
áá 
)
áá 
=>
áá 
{
ââ 
Task
ãã 
.
ãã 
Run
ãã 
(
ãã 
async
ãã 
(
ãã  
)
ãã  !
=>
ãã" $
{
ää 
await
åå /
!_applicationSecureStorageProvider
åå ;
.
åå; <0
"SetApplicationSettingsCultureAsync
åå< ^
(
åå^ _
targetCulture
åå_ l
)
åål m
.
ææ 
ConfigureAwait
ææ '
(
ææ' (
false
ææ( -
)
ææ- .
;
ææ. /
}
çç 
)
çç 
.
çç 
ContinueWith
çç 
(
çç  
task
èè 
=>
èè 
{
éé 
if
êê 
(
êê 
task
êê  
is
êê! #
{
êê$ %
	IsFaulted
êê& /
:
êê/ 0
true
êê1 5
,
êê5 6
	Exception
êê7 @
:
êê@ A
not
êêB E
null
êêF J
}
êêK L
)
êêL M
{
ëë 
Log
ìì 
.
ìì  
Error
ìì  %
(
ìì% &
task
ìì& *
.
ìì* +
	Exception
ìì+ 4
,
ìì4 5
$str
ìì6 p
)
ììp q
;
ììq r
}
íí 
}
îî 
,
îî 
TaskScheduler
ïï !
.
ïï! "
Default
ïï" )
)
ïï) *
;
ïï* +
}
ðð 
)
ðð 
;
ðð 
}
ññ 
private
óó 
Task
óó -
HandleBottomSheetDismissedEvent
óó 0
(
óó0 1$
BottomSheetHiddenEvent
óó1 G
evt
óóH K
)
óóK L
{
ôô #
_languageSubscription
õõ 
?
õõ 
.
õõ 
Dispose
õõ &
(
õõ& '
)
õõ' (
;
õõ( ),
_bottomSheetHiddenSubscription
öö &
?
öö& '
.
öö' (
Dispose
öö( /
(
öö/ 0
)
öö0 1
;
öö1 2
return
÷÷ 
Task
÷÷ 
.
÷÷ 
CompletedTask
÷÷ !
;
÷÷! "
}
øø 
private
úú 
async
úú 
Task
úú .
 CheckCountryCultureMismatchAsync
úú 7
(
úú7 8
)
úú8 9
{
ûû 
Result
üü 
<
üü )
ApplicationInstanceSettings
üü *
,
üü* +'
InternalServiceApiFailure
üü, E
>
üüE F
appSettings
üüG R
=
üüS T
await
ýý /
!_applicationSecureStorageProvider
ýý 3
.
ýý3 41
#GetApplicationInstanceSettingsAsync
ýý4 W
(
ýýW X
)
ýýX Y
;
ýýY Z
if
ÿÿ 

(
ÿÿ 
appSettings
ÿÿ 
.
ÿÿ 
IsOk
ÿÿ 
)
ÿÿ 
{
€€ 	)
ApplicationInstanceSettings
 ')
applicationInstanceSettings
( C
=
D E
appSettings
F Q
.
Q R
Unwrap
R X
(
X Y
)
Y Z
;
Z [
if
‚‚ 
(
‚‚ 
!
‚‚ 
string
‚‚ 
.
‚‚ 
IsNullOrEmpty
‚‚ %
(
‚‚% &)
applicationInstanceSettings
‚‚& A
.
‚‚A B
Country
‚‚B I
)
‚‚I J
&&
‚‚K M)
applicationInstanceSettings
‚‚N i
.
‚‚i j
IsNewInstance
‚‚j w
)
‚‚w x
{
ƒƒ #
_languageSubscription
„„ %
=
„„& ''
_languageDetectionService
…… -
.
……- .*
OnLanguageDetectionRequested
……. J
(
……J K*
HandleLanguageDetectionEvent
……K g
,
……g h"
SubscriptionLifetime
†† ,
.
††, -
Scoped
††- 3
)
††3 4
;
††4 5,
_bottomSheetHiddenSubscription
‡‡ .
=
‡‡/ 0"
_mainWindowViewModel
ˆˆ (
.
ˆˆ( )!
OnBottomSheetHidden
ˆˆ) <
(
ˆˆ< =-
HandleBottomSheetDismissedEvent
ˆˆ= \
,
ˆˆ\ ]"
SubscriptionLifetime
‰‰ ,
.
‰‰, -
Scoped
‰‰- 3
)
‰‰3 4
;
‰‰4 5
string
‹‹ 
currentCulture
‹‹ %
=
‹‹& '
System
‹‹( .
.
‹‹. /
Globalization
‹‹/ <
.
‹‹< =
CultureInfo
‹‹= H
.
‹‹H I
CurrentUICulture
‹‹I Y
.
‹‹Y Z
Name
‹‹Z ^
;
‹‹^ _
string
 
expectedCulture
 &
=
' (
LanguageConfig
) 7
.
7 8!
GetCultureByCountry
8 K
(
K L)
applicationInstanceSettings
L g
.
g h
Country
h o
)
o p
;
p q
if
 
(
 
!
 
string
 
.
 
Equals
 "
(
" #
currentCulture
# 1
,
1 2
expectedCulture
3 B
,
B C
StringComparison
D T
.
T U
OrdinalIgnoreCase
U f
)
f g
)
g h
{
 +
DetectLanguageDialogViewModel
‘‘ 1%
detectLanguageViewModel
‘‘2 I
=
‘‘J K
new
‘‘L O
(
‘‘O P!
LocalizationService
’’ +
,
’’+ ,'
_languageDetectionService
““ 1
,
““1 2
_networkProvider
”” (
)
•• 
;
•• "
DetectLanguageDialog
—— ( 
detectLanguageView
——) ;
=
——< =
new
——> A
(
——A B
)
——B C
{
——D E
DataContext
——F Q
=
——R S%
detectLanguageViewModel
——T k
}
——l m
;
——m n
await
™™ "
_mainWindowViewModel
™™ .
.
™™. /"
ShowBottomSheetAsync
™™/ C
(
™™C D&
BottomSheetComponentType
šš 0
.
šš0 1"
DetectedLocalization
šš1 E
,
ššE F 
detectLanguageView
›› *
,
››* +
	showScrim
œœ !
:
œœ! "
true
œœ# '
,
œœ' (
isDismissable
 %
:
% &
true
' +
)
žž 
.
žž 
ConfigureAwait
žž $
(
žž$ %
false
žž% *
)
žž* +
;
žž+ ,
}
ŸŸ 
}
   
}
¡¡ 	
}
¢¢ 
private
¤¤ 
static
¤¤ 
readonly
¤¤ 
	FrozenSet
¤¤ %
<
¤¤% & 
MembershipViewType
¤¤& 8
>
¤¤8 9
FlowSpecificViews
¤¤: K
=
¤¤L M
new
¤¤N Q
HashSet
¤¤R Y
<
¤¤Y Z 
MembershipViewType
¤¤Z l
>
¤¤l m
{
¥¥  
MembershipViewType
¦¦ 
.
¦¦ &
MOBILE_VERIFICATION_VIEW
¦¦ 3
,
¦¦3 4 
MembershipViewType
§§ 
.
§§ #
OTP_VERIFICATION_VIEW
§§ 0
,
§§0 1 
MembershipViewType
¨¨ 
.
¨¨ *
SECURE_KEY_CONFIRMATION_VIEW
¨¨ 7
,
¨¨7 8
}
©© 
.
©© 
ToFrozenSet
©© 
(
©© 
)
©© 
;
©© 
private
¬¬  
IRoutableViewModel
¬¬ )
GetOrCreateViewModelForView
¬¬ :
(
¬¬: ; 
MembershipViewType
¬¬; M
viewType
¬¬N V
,
¬¬V W
bool
¬¬X \

resetState
¬¬] g
=
¬¬h i
true
¬¬j n
)
¬¬n o
{
­­ '
AuthenticationFlowContext
®® !
flowContext
®®" -
=
®®. / 
CurrentFlowContext
®®0 B
;
®®B C
bool
°° $
useFlowSpecificCaching
°° #
=
°°$ %
FlowSpecificViews
°°& 7
.
°°7 8
Contains
°°8 @
(
°°@ A
viewType
°°A I
)
°°I J
;
°°J K
(
²² 	 
MembershipViewType
²²	 
viewType
²² $
,
²²$ %'
AuthenticationFlowContext
²²& ?
)
²²? @
cacheKey
²²A I
=
²²J K$
useFlowSpecificCaching
²²L b
?
³³ 
(
³³ 
viewType
³³ 
,
³³ 
flowContext
³³ $
)
³³$ %
:
´´ 
(
´´ 
viewType
´´ 
,
´´ '
AuthenticationFlowContext
´´ 2
.
´´2 3
REGISTRATION
´´3 ?
)
´´? @
;
´´@ A
if
¶¶ 

(
¶¶ 
_viewModelCache
¶¶ 
.
¶¶ 
TryGetValue
¶¶ '
(
¶¶' (
cacheKey
¶¶( 0
,
¶¶0 1
out
¶¶2 5
WeakReference
¶¶6 C
<
¶¶C D 
IRoutableViewModel
¶¶D V
>
¶¶V W
?
¶¶W X
weakRef
¶¶Y `
)
¶¶` a
&&
¶¶b d
weakRef
·· 
.
·· 
TryGetTarget
··  
(
··  !
out
··! $ 
IRoutableViewModel
··% 7
?
··7 8
cachedViewModel
··9 H
)
··H I
)
··I J
{
¸¸ 	
if
¹¹ 
(
¹¹ 

resetState
¹¹ 
&&
¹¹ 
cachedViewModel
¹¹ -
is
¹¹. 0
IResettable
¹¹1 <

resettable
¹¹= G
)
¹¹G H
{
ºº 

resettable
»» 
.
»» 

ResetState
»» %
(
»»% &
)
»»& '
;
»»' (
}
¼¼ 
return
¾¾ 
cachedViewModel
¾¾ "
;
¾¾" #
}
¿¿ 	
if
ÁÁ 

(
ÁÁ 
!
ÁÁ  
ViewModelFactories
ÁÁ 
.
ÁÁ  
TryGetValue
ÁÁ  +
(
ÁÁ+ ,
viewType
ÁÁ, 4
,
ÁÁ4 5
out
ÁÁ6 9
Func
ÁÁ: >
<
ÁÁ> ?%
ViewModelFactoryContext
ÁÁ? V
,
ÁÁV W 
IRoutableViewModel
ÁÁX j
>
ÁÁj k
?
ÁÁk l
factory
ÁÁm t
)
ÁÁt u
)
ÁÁu v
{
ÂÂ 	
throw
ÃÃ 
new
ÃÃ '
InvalidOperationException
ÃÃ /
(
ÃÃ/ 0
$"
ÃÃ0 2
$str
ÃÃ2 R
{
ÃÃR S
viewType
ÃÃS [
}
ÃÃ[ \
"
ÃÃ\ ]
)
ÃÃ] ^
;
ÃÃ^ _
}
ÄÄ 	%
ViewModelFactoryContext
ÆÆ 
context
ÆÆ  '
=
ÆÆ( )
new
ÆÆ* -
(
ÆÆ- .
)
ÆÆ. /
{
ÇÇ 	!
ConnectivityService
ÈÈ 
=
ÈÈ  !"
_connectivityService
ÈÈ" 6
,
ÈÈ6 7
NetworkProvider
ÉÉ 
=
ÉÉ 
_networkProvider
ÉÉ .
,
ÉÉ. /!
LocalizationService
ÊÊ 
=
ÊÊ  !!
LocalizationService
ÊÊ" 5
,
ÊÊ5 6#
AuthenticationService
ËË !
=
ËË" #$
_authenticationService
ËË$ :
,
ËË: ;
StorageProvider
ÌÌ 
=
ÌÌ /
!_applicationSecureStorageProvider
ÌÌ ?
,
ÌÌ? @
HostViewModel
ÍÍ 
=
ÍÍ 
this
ÍÍ  
,
ÍÍ  !!
RegistrationService
ÎÎ 
=
ÎÎ  !(
_opaqueRegistrationService
ÎÎ" <
,
ÎÎ< =
RecoveryService
ÏÏ 
=
ÏÏ '
_secureKeyRecoveryService
ÏÏ 7
,
ÏÏ7 8
FlowContext
ÐÐ 
=
ÐÐ 
flowContext
ÐÐ %
}
ÑÑ 	
;
ÑÑ	 
 
IRoutableViewModel
ÓÓ 
newViewModel
ÓÓ '
=
ÓÓ( )
factory
ÓÓ* 1
(
ÓÓ1 2
context
ÓÓ2 9
)
ÓÓ9 :
;
ÓÓ: ;
_viewModelCache
ÕÕ 
[
ÕÕ 
cacheKey
ÕÕ  
]
ÕÕ  !
=
ÕÕ" #
new
ÕÕ$ '
WeakReference
ÕÕ( 5
<
ÕÕ5 6 
IRoutableViewModel
ÕÕ6 H
>
ÕÕH I
(
ÕÕI J
newViewModel
ÕÕJ V
)
ÕÕV W
;
ÕÕW X
if
×× 

(
×× 

resetState
×× 
&&
×× 
newViewModel
×× &
is
××' )
IResettable
××* 5
resettableNew
××6 C
)
××C D
{
ØØ 	
resettableNew
ÙÙ 
.
ÙÙ 

ResetState
ÙÙ $
(
ÙÙ$ %
)
ÙÙ% &
;
ÙÙ& '
}
ÚÚ 	
return
ÜÜ 
newViewModel
ÜÜ 
;
ÜÜ 
}
ÝÝ 
private
ßß 
void
ßß #
InitializeVersionInfo
ßß &
(
ßß& '
)
ßß' (
{
àà 

AppVersion
áá 
=
áá 
VersionHelper
áá "
.
áá" ##
GetApplicationVersion
áá# 8
(
áá8 9
)
áá9 :
;
áá: ;
Option
ââ 
<
ââ 
	BuildInfo
ââ 
>
ââ 
	buildInfo
ââ #
=
ââ$ %
VersionHelper
ââ& 3
.
ââ3 4
GetBuildInfo
ââ4 @
(
ââ@ A
)
ââA B
;
ââB C
	buildInfo
ãã 
.
ãã 
Select
ãã 
(
ãã 
bi
ãã 
=>
ãã 
bi
ãã !
.
ãã! "
BuildNumber
ãã" -
)
ãã- .
.
ãã. /
GetValueOrDefault
ãã/ @
(
ãã@ A
$str
ããA N
)
ããN O
;
ããO P
FullVersionInfo
åå 
=
åå 
	buildInfo
åå #
.
åå# $
Match
åå$ )
(
åå) *
bi
ææ 
=>
ææ 
string
ææ 
.
ææ 
Concat
ææ 
(
ææ  
VersionHelper
çç 
.
çç 
GetDisplayVersion
çç /
(
çç/ 0
)
çç0 1
,
çç1 2
$str
èè 
,
èè 
bi
èè 
.
èè  
BuildNumber
èè  +
,
èè+ ,
$str
éé 
,
éé 
bi
éé  
.
éé  !
	GitCommit
éé! *
[
éé* +
..
éé+ -
$num
éé- .
]
éé. /
,
éé/ 0
$str
êê 
,
êê 
bi
êê  
.
êê  !
	GitBranch
êê! *
)
êê* +
,
êê+ ,
VersionHelper
ëë 
.
ëë 
GetDisplayVersion
ëë +
)
ëë+ ,
;
ëë, -
}
ìì 
private
îî 
void
îî  
InitializeCommands
îî #
(
îî# $ 
IApplicationRouter
îî$ 6
router
îî7 =
)
îî= >
{
ïï 
Navigate
ðð 
=
ðð 
ReactiveCommand
ðð "
.
ðð" #
Create
ðð# )
<
ðð) * 
MembershipViewType
ðð* <
,
ðð< = 
IRoutableViewModel
ðð> P
>
ððP Q
(
ððQ R
ExecuteNavigate
ððR a
)
ðða b
;
ððb c
NavigateBack
ññ 
=
ññ 
ReactiveCommand
ññ &
.
ññ& '
Create
ññ' -
(
ññ- .!
ExecuteNavigateBack
ññ. A
)
ññA B
;
ññB C0
"CheckCountryCultureMismatchCommand
òò *
=
òò+ ,
ReactiveCommand
òò- <
.
òò< =
CreateFromTask
òò= K
(
òòK L
async
òòL Q
(
òòR S
)
òòS T
=>
òòU W
{
óó 	
await
ôô .
 CheckCountryCultureMismatchAsync
ôô 2
(
ôô2 3
)
ôô3 4
;
ôô4 5
return
õõ 
Unit
õõ 
.
õõ 
Default
õõ 
;
õõ  
}
öö 	
)
öö	 

;
öö
 '
SwitchToMainWindowCommand
÷÷ !
=
÷÷" #
ReactiveCommand
÷÷$ 3
.
÷÷3 4
CreateFromTask
÷÷4 B
(
÷÷B C
async
÷÷C H
(
÷÷I J
)
÷÷J K
=>
÷÷L N
{
øø 	
IModuleManager
ùù 
?
ùù 
moduleManager
ùù )
=
ùù* +
Locator
ùù, 3
.
ùù3 4
Current
ùù4 ;
.
ùù; <

GetService
ùù< F
<
ùùF G
IModuleManager
ùùG U
>
ùùU V
(
ùùV W
)
ùùW X
;
ùùX Y
if
úú 
(
úú 
moduleManager
úú 
==
úú  
null
úú! %
)
úú% &
{
ûû 
Log
üü 
.
üü 
Error
üü 
(
üü 
$str
üü J
)
üüJ K
;
üüK L
return
ýý 
;
ýý 
}
þþ 
Option
€€ 
<
€€ 
IModule
€€ 
>
€€ 
mainModuleOption
€€ ,
=
€€- .
await
€€/ 4
moduleManager
€€5 B
.
€€B C
LoadModuleAsync
€€C R
(
€€R S
$str
€€S Y
)
€€Y Z
;
€€Z [
if
 
(
 
!
 
mainModuleOption
 !
.
! "
IsSome
" (
)
( )
{
‚‚ 
Log
ƒƒ 
.
ƒƒ 
Error
ƒƒ 
(
ƒƒ 
$str
ƒƒ H
)
ƒƒH I
;
ƒƒI J
return
„„ 
;
„„ 
}
…… '
CleanupAuthenticationFlow
‡‡ %
(
‡‡% &
)
‡‡& '
;
‡‡' (
await
ˆˆ 
router
ˆˆ 
.
ˆˆ !
NavigateToMainAsync
ˆˆ ,
(
ˆˆ, -
)
ˆˆ- .
;
ˆˆ. /
}
‰‰ 	
)
‰‰	 

;
‰‰
 &
OpenPrivacyPolicyCommand
ŠŠ  
=
ŠŠ! "
ReactiveCommand
ŠŠ# 2
.
ŠŠ2 3
Create
ŠŠ3 9
(
ŠŠ9 :
(
ŠŠ: ;
)
ŠŠ; <
=>
ŠŠ= ?
OpenUrl
ŠŠ@ G
(
ŠŠG H
	_settings
ŠŠH Q
.
ŠŠQ R
PrivacyPolicyUrl
ŠŠR b
)
ŠŠb c
)
ŠŠc d
;
ŠŠd e'
OpenTermsOfServiceCommand
‹‹ !
=
‹‹" #
ReactiveCommand
‹‹$ 3
.
‹‹3 4
Create
‹‹4 :
(
‹‹: ;
(
‹‹; <
)
‹‹< =
=>
‹‹> @
OpenUrl
‹‹A H
(
‹‹H I
	_settings
‹‹I R
.
‹‹R S
TermsOfServiceUrl
‹‹S d
)
‹‹d e
)
‹‹e f
;
‹‹f g 
OpenSupportCommand
ŒŒ 
=
ŒŒ 
ReactiveCommand
ŒŒ ,
.
ŒŒ, -
Create
ŒŒ- 3
(
ŒŒ3 4
(
ŒŒ4 5
)
ŒŒ5 6
=>
ŒŒ7 9
OpenUrl
ŒŒ: A
(
ŒŒA B
	_settings
ŒŒB K
.
ŒŒK L

SupportUrl
ŒŒL V
)
ŒŒV W
)
ŒŒW X
;
ŒŒX Y
}
 
private
  
IRoutableViewModel
 
ExecuteNavigate
 .
(
. / 
MembershipViewType
/ A
viewType
B J
)
J K
{
  
IRoutableViewModel
‘‘ 
	viewModel
‘‘ $
=
‘‘% &)
GetOrCreateViewModelForView
‘‘' B
(
‘‘B C
viewType
‘‘C K
)
‘‘K L
;
‘‘L M
if
““ 

(
““ 
_currentView
““ 
!=
““ 
null
““  
)
““  !
{
”” 	
_navigationStack
•• 
.
•• 
Push
•• !
(
••! "
_currentView
••" .
)
••. /
;
••/ 0
}
–– 	
CurrentView
˜˜ 
=
˜˜ 
	viewModel
˜˜ 
;
˜˜  
return
šš 
	viewModel
šš 
;
šš 
}
›› 
private
  
IRoutableViewModel
 
?
 !
ExecuteNavigateBack
  3
(
3 4
)
4 5
{
žž 
if
ŸŸ 

(
ŸŸ 
_navigationStack
ŸŸ 
.
ŸŸ 
Count
ŸŸ "
>
ŸŸ# $
$num
ŸŸ% &
)
ŸŸ& '
{
   	
if
¡¡ 
(
¡¡ 
_currentView
¡¡ 
is
¡¡ 
IResettable
¡¡  +

resettable
¡¡, 6
)
¡¡6 7
{
¢¢ 

resettable
££ 
.
££ 

ResetState
££ %
(
££% &
)
££& '
;
££' (
}
¤¤  
IRoutableViewModel
¦¦ 
previousView
¦¦ +
=
¦¦, -
_navigationStack
¦¦. >
.
¦¦> ?
Pop
¦¦? B
(
¦¦B C
)
¦¦C D
;
¦¦D E
if
¨¨ 
(
¨¨ 
previousView
¨¨ 
is
¨¨ 
IResettable
¨¨  + 
previousResettable
¨¨, >
)
¨¨> ?
{
©©  
previousResettable
ªª "
.
ªª" #

ResetState
ªª# -
(
ªª- .
)
ªª. /
;
ªª/ 0
}
«« 
_currentView
­­ 
=
­­ 
previousView
­­ '
;
­­' (
this
®® 
.
®® "
RaisePropertyChanged
®® %
(
®®% &
nameof
®®& ,
(
®®, -
CurrentView
®®- 8
)
®®8 9
)
®®9 :
;
®®: ;
CanNavigateBack
¯¯ 
=
¯¯ 
_navigationStack
¯¯ .
.
¯¯. /
Count
¯¯/ 4
>
¯¯5 6
$num
¯¯7 8
;
¯¯8 9
return
±± 
previousView
±± 
;
±±  
}
²² 	
return
´´ 
null
´´ 
;
´´ 
}
µµ 
private
·· 
void
·· %
SetupActivationBehavior
·· (
(
··( )
)
··) *
{
¸¸ 
this
¹¹ 
.
¹¹ 
WhenActivated
¹¹ 
(
¹¹ 
disposables
¹¹ &
=>
¹¹' )
{
ºº 	"
_connectivityService
»»  
.
»»  !$
OnManualRetryRequested
»»! 7
(
»»7 8-
HandleManualRetryRequestedAsync
»»8 W
)
»»W X
.
¼¼ 
DisposeWith
¼¼ 
(
¼¼ 
disposables
¼¼ (
)
¼¼( )
;
¼¼) *

Observable
½½ 
.
½½ 
Timer
½½ 
(
½½ 
TimeSpan
½½ %
.
½½% &
FromSeconds
½½& 1
(
½½1 2
$num
½½2 3
)
½½3 4
,
½½4 5
RxApp
½½6 ;
.
½½; <!
MainThreadScheduler
½½< O
)
½½O P
.
¾¾ 

SelectMany
¾¾ 
(
¾¾ 
_
¾¾ 
=>
¾¾  0
"CheckCountryCultureMismatchCommand
¾¾! C
.
¾¾C D
Execute
¾¾D K
(
¾¾K L
)
¾¾L M
)
¾¾M N
.
¿¿ 
	Subscribe
¿¿ 
(
¿¿ 
_
¿¿ 
=>
¿¿ 
{
¿¿  !
}
¿¿" #
)
¿¿# $
.
ÀÀ 
DisposeWith
ÀÀ 
(
ÀÀ 
disposables
ÀÀ (
)
ÀÀ( )
;
ÀÀ) *
Navigate
ÁÁ 
.
ÁÁ 
Execute
ÁÁ 
(
ÁÁ  
MembershipViewType
ÁÁ /
.
ÁÁ/ 0
WELCOME_VIEW
ÁÁ0 <
)
ÁÁ< =
.
ÂÂ 
	Subscribe
ÂÂ 
(
ÂÂ 
_
ÂÂ 
=>
ÂÂ 
{
ÂÂ  !
}
ÂÂ" #
)
ÂÂ# $
.
ÃÃ 
DisposeWith
ÃÃ 
(
ÃÃ 
disposables
ÃÃ (
)
ÃÃ( )
;
ÃÃ) *
}
ÄÄ 	
)
ÄÄ	 

;
ÄÄ
 
}
ÅÅ 
private
ÇÇ 
async
ÇÇ 
Task
ÇÇ -
HandleManualRetryRequestedAsync
ÇÇ 6
(
ÇÇ6 7'
ManualRetryRequestedEvent
ÇÇ7 P
e
ÇÇQ R
)
ÇÇR S
{
ÈÈ 
Result
ÉÉ 
<
ÉÉ 
	Utilities
ÉÉ 
.
ÉÉ 
Unit
ÉÉ 
,
ÉÉ 
NetworkFailure
ÉÉ -
>
ÉÉ- .
recoveryResult
ÉÉ/ =
=
ÉÉ> ?
await
ÊÊ 
_networkProvider
ÊÊ "
.
ÊÊ" #'
ForceFreshConnectionAsync
ÊÊ# <
(
ÊÊ< =
)
ÊÊ= >
;
ÊÊ> ?
if
ÌÌ 

(
ÌÌ 
recoveryResult
ÌÌ 
.
ÌÌ 
IsOk
ÌÌ 
)
ÌÌ  
{
ÍÍ 	 
ConnectivityIntent
ÎÎ 
intent
ÎÎ %
=
ÎÎ& ' 
ConnectivityIntent
ÏÏ "
.
ÏÏ" #
	Connected
ÏÏ# ,
(
ÏÏ, -
e
ÏÏ- .
.
ÏÏ. /
	ConnectId
ÏÏ/ 8
,
ÏÏ8 9 
ConnectivityReason
ÏÏ: L
.
ÏÏL M
ManualRetry
ÏÏM X
)
ÏÏX Y
with
ÐÐ 
{
ÑÑ 
Source
ÒÒ 
=
ÒÒ  
ConnectivitySource
ÒÒ /
.
ÒÒ/ 0
ManualAction
ÒÒ0 <
}
ÓÓ 
;
ÓÓ 
await
ÔÔ "
_connectivityService
ÔÔ &
.
ÔÔ& '
PublishAsync
ÔÔ' 3
(
ÔÔ3 4
intent
ÔÔ4 :
)
ÔÔ: ;
;
ÔÔ; <
}
ÕÕ 	
}
ÖÖ 
}×× Æ
‹/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Common/MembershipViewType.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Common0 6
;6 7
public 
enum 
MembershipViewType 
{ 
WELCOME_VIEW 
, 
SIGN_IN_VIEW 
, $
MOBILE_VERIFICATION_VIEW 
, !
OTP_VERIFICATION_VIEW 
, (
SECURE_KEY_CONFIRMATION_VIEW		  
,		  !
PIN_SET_VIEW

 
} ’
’/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/Common/AuthenticationFlowContext.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
./ 0
Common0 6
;6 7
public 
enum %
AuthenticationFlowContext %
{ 
REGISTRATION 
, 
SECURE_KEY_RECOVERY 
} ¿
†/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Features/Authentication/AuthenticationModule.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Features  
.  !
Authentication! /
;/ 0
public 
record (
AuthenticationModuleManifest *
(* +
)+ ,
:- .
ModuleManifest/ =
(= >
Priority		 
:		 
$num		 
,		 
LoadingStrategy

 
:

 !
ModuleLoadingStrategy

 *
.

* +
Eager

+ 0
,

0 1
Dependencies 
: 
[ 
] 
) 
; 
public 
class  
AuthenticationModule !
:" #

ModuleBase$ .
<. /(
AuthenticationModuleManifest/ K
>K L
{ 
public 

override 
ModuleIdentifier $
Id% '
=>( *
ModuleIdentifier+ ;
.; <
Authentication< J
;J K
public 

override (
AuthenticationModuleManifest 0
Manifest1 9
{: ;
get< ?
;? @
}A B
=C D
newE H
(H I
)I J
;J K
public 

override 
async 
Task %
SetupMessageHandlersAsync 8
(8 9
IModuleMessageBus9 J

messageBusK U
)U V
{ 
await 

messageBus 
. 
PublishAsync %
(% &
new& )"
ModuleInitializedEvent* @
{ 	

ModuleName 
= 
Id 
. 
ToName "
(" #
)# $
} 	
)	 

;
 
} 
} Ð
y/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Utilities/DisposableAction.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Utilities &
;& '
internal 
sealed	 
class 
DisposableAction &
(& '
Action' -
action. 4
)4 5
:6 7
IDisposable8 C
{ 
private 
bool 
	_disposed 
; 
public		 

void		 
Dispose		 
(		 
)		 
{

 
if 

( 
	_disposed 
) 
{ 	
return 
; 
} 	
	_disposed 
= 
true 
; 
action 
( 
) 
; 
} 
} ±¢
q/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/MVVM/ViewModelBase.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
MVVM !
;! "
public 
abstract 
class 
ViewModelBase #
:$ %
ReactiveObject& 4
,4 5
IDisposable6 A
,A B!
IActivatableViewModelC X
{ 
private 
bool 
_disposedValue 
;  
private &
ObservableAsPropertyHelper &
<& '
bool' +
>+ ,
?, -%
_connectivitySubscription. G
;G H
	protected 
ViewModelBase 
( 
NetworkProvider +
networkProvider, ;
,; < 
ILocalizationService 
localizationService 0
,0 1 
IConnectivityService 
? 
connectivityService 1
=2 3
null4 8
)8 9
{   
NetworkProvider!! 
=!! 
networkProvider!! )
;!!) *
LocalizationService"" 
="" 
localizationService"" 1
;""1 2
LanguageChanged$$ 
=$$ 

Observable$$ $
.$$$ %
	FromEvent$$% .
($$. /
handler%% 
=>%% 
localizationService%% .
.%%. /
LanguageChanged%%/ >
+=%%? A
handler%%B I
,%%I J
handler&& 
=>&& 
localizationService&& .
.&&. /
LanguageChanged&&/ >
-=&&? A
handler&&B I
)'' 
.(( 
	StartWith(( 
((( 
SystemU(( 
.(( 
Default(( &
)((& '
.)) 
Publish)) 
()) 
))) 
.** 
RefCount** 
(** 
)** 
;** 
if,, 

(,, 
connectivityService,, 
!=,,  "
null,,# '
),,' (
{-- 	
IObservable.. 
<.. 
bool.. 
>.. 
networkStatusStream.. 1
=..2 3
connectivityService..4 G
...G H
ConnectivityStream..H Z
.// 
Select// 
(// 
IsNetworkInOutage// )
)//) *
.00 
	StartWith00 
(00 
IsNetworkInOutage00 ,
(00, -
connectivityService00- @
.00@ A
CurrentSnapshot00A P
)00P Q
)00Q R
.11  
DistinctUntilChanged11 %
(11% &
)11& '
;11' (%
_connectivitySubscription33 %
=33& '
networkStatusStream33( ;
.33; <
ToPropertyEx33< H
(33H I
this33I M
,33M N
x33O P
=>33Q S
x33T U
.33U V
IsInNetworkOutage33V g
)33g h
;33h i
}44 	
this66 
.66 
WhenActivated66 
(66 
disposables66 &
=>66' )
{77 	
LanguageChanged88 
.99 
Do99 
(99 
_99 
=>99 
this99 
.99  
RaisePropertyChanged99 2
(992 3
string993 9
.999 :
Empty99: ?
)99? @
)99@ A
.:: 
	Subscribe:: 
(:: 
):: 
.;; 
DisposeWith;; 
(;; 
disposables;; (
);;( )
;;;) *
}<< 	
)<<	 

;<<
 
}== 
public?? 
 
ILocalizationService?? 
LocalizationService??  3
{??4 5
get??6 9
;??9 :
}??; <
public@@ 

ViewModelActivator@@ 
	Activator@@ '
{@@( )
get@@* -
;@@- .
}@@/ 0
=@@1 2
new@@3 6
(@@6 7
)@@7 8
;@@8 9
[BB  
ObservableAsPropertyBB 
]BB 
publicBB !
boolBB" &
IsInNetworkOutageBB' 8
{BB9 :
getBB; >
;BB> ?
}BB@ A
	protectedDD 
NetworkProviderDD 
NetworkProviderDD -
{DD. /
getDD0 3
;DD3 4
}DD5 6
	protectedEE 
IObservableEE 
<EE 
SystemUEE !
>EE! "
LanguageChangedEE# 2
{EE3 4
getEE5 8
;EE8 9
}EE: ;
	protectedGG 
uintGG 
ComputeConnectIdGG #
(GG# $
PubKeyExchangeTypeGG$ 6
pubKeyExchangeTypeGG7 I
)GGI J
{HH 
uintII 
	connectIdII 
=II 
NetworkProviderJJ 
.JJ "
ComputeUniqueConnectIdJJ 2
(JJ2 3
NetworkProviderJJ3 B
.JJB C'
ApplicationInstanceSettingsJJC ^
,JJ^ _
pubKeyExchangeTypeKK "
)KK" #
;KK# $
returnMM 
	connectIdMM 
;MM 
}NN 
	protectedPP 

MembershipPP 

MembershipPP #
(PP# $
)PP$ %
=>PP& (
NetworkProviderQQ 
.QQ '
ApplicationInstanceSettingsQQ 3
.QQ3 4

MembershipQQ4 >
;QQ> ?
publicSS 

stringSS &
GetLocalizedWarningMessageSS ,
(SS, - 
CharacterWarningTypeSS- A
warningTypeSSB M
)SSM N
{TT 
returnUU 
warningTypeUU 
switchUU !
{VV 	 
CharacterWarningTypeWW  
.WW  !
NonLatinLetterWW! /
=>WW0 2
LocalizationServiceWW3 F
[WWF G
$strWWG t
]WWt u
,WWu v 
CharacterWarningTypeXX  
.XX  !
InvalidCharacterXX! 1
=>XX2 4
LocalizationServiceXX5 H
[XXH I
$strYY ?
]YY? @
,YY@ A 
CharacterWarningTypeZZ  
.ZZ  !
MultipleCharactersZZ! 3
=>ZZ4 6
LocalizationServiceZZ7 J
[ZZJ K
$str[[ A
][[A B
,[[B C
_\\ 
=>\\ 
LocalizationService\\ $
[\\$ %
$str\\% T
]\\T U
}]] 	
;]]	 

}^^ 
	protected`` 
void`` '
ShowServerErrorNotification`` .
(``. /#
AuthenticationViewModel``/ F

hostWindow``G Q
,``Q R
string``S Y
errorMessage``Z f
)``f g
{aa 
ifbb 

(bb 
stringbb 
.bb 
IsNullOrEmptybb  
(bb  !
errorMessagebb! -
)bb- .
)bb. /
{cc 	
returndd 
;dd 
}ee 	%
UserRequestErrorViewModelgg !
errorViewModelgg" 0
=gg1 2
newgg3 6
(gg6 7
errorMessagegg7 C
,ggC D
LocalizationServiceggE X
)ggX Y
;ggY Z 
UserRequestErrorViewhh 
	errorViewhh &
=hh' (
newhh) ,
(hh, -
)hh- .
{hh/ 0
DataContexthh1 <
=hh= >
errorViewModelhh? M
}hhN O
;hhO P
Taskjj 
.jj 
Runjj 
(jj 
asyncjj 
(jj 
)jj 
=>jj 
{kk 	
tryll 
{mm 
awaitnn 

hostWindownn  
.nn  !
ShowBottomSheetnn! 0
(nn0 1$
BottomSheetComponentTypeoo ,
.oo, -
UserRequestErroroo- =
,oo= >
	errorViewpp 
,pp 
	showScrimqq 
:qq 
falseqq $
,qq$ %
isDismissablerr !
:rr! "
truerr# '
)rr' (
;rr( )
}ss 
catchtt 
(tt 
	Exceptiontt 
extt 
)tt  
{uu 
Serilogvv 
.vv 
Logvv 
.vv 
Errorvv !
(vv! "
exvv" $
,vv$ %
$strvv& j
)vvj k
;vvk l
}ww 
}xx 	
)xx	 

.xx
 
ContinueWithxx 
(xx 
taskyy 
=>yy 
{zz 
if{{ 
({{ 
task{{ 
.{{ 
	IsFaulted{{ "
&&{{# %
task{{& *
.{{* +
	Exception{{+ 4
!={{5 7
null{{8 <
){{< =
{|| 
Serilog}} 
.}} 
Log}} 
.}}  
Error}}  %
(}}% &
task}}& *
.}}* +
	Exception}}+ 4
,}}4 5
$str	}}6 ‹
)
}}‹ Œ
;
}}Œ 
}~~ 
} 
, 
TaskScheduler
€€ 
.
€€ 
Default
€€ !
)
€€! "
;
€€" #
}
 
	protected
ƒƒ 
void
ƒƒ &
ShowRedirectNotification
ƒƒ +
(
ƒƒ+ ,%
AuthenticationViewModel
ƒƒ, C

hostWindow
ƒƒD N
,
ƒƒN O
string
ƒƒP V
message
ƒƒW ^
,
ƒƒ^ _
int
ƒƒ` c
seconds
ƒƒd k
,
ƒƒk l
Action
„„ 

onComplete
„„ 
)
„„ 
{
…… 
if
†† 

(
†† 
_disposedValue
†† 
)
†† 
{
‡‡ 	

onComplete
ˆˆ 
(
ˆˆ 
)
ˆˆ 
;
ˆˆ 
return
‰‰ 
;
‰‰ 
}
ŠŠ 	+
RedirectNotificationViewModel
ŒŒ %
redirectViewModel
ŒŒ& 7
=
ŒŒ8 9
new
ŒŒ: =
(
ŒŒ= >
message
ŒŒ> E
,
ŒŒE F
seconds
ŒŒG N
,
ŒŒN O

onComplete
ŒŒP Z
,
ŒŒZ [!
LocalizationService
ŒŒ\ o
)
ŒŒo p
;
ŒŒp q&
RedirectNotificationView
  
redirectView
! -
=
. /
new
0 3
(
3 4
)
4 5
{
6 7
DataContext
8 C
=
D E
redirectViewModel
F W
}
X Y
;
Y Z
Task
 
.
 
Run
 
(
 
async
 
(
 
)
 
=>
 
{
 	
try
‘‘ 
{
’’ 
if
““ 
(
““ 
!
““ 
_disposedValue
““ #
)
““# $
{
”” 
await
•• 

hostWindow
•• $
.
••$ %
ShowBottomSheet
••% 4
(
••4 5&
BottomSheetComponentType
••5 M
.
••M N"
RedirectNotification
••N b
,
••b c
redirectView
••d p
,
••p q
	showScrim
–– !
:
––! "
true
––# '
,
––' (
isDismissable
––) 6
:
––6 7
false
––8 =
)
––= >
;
––> ?
}
—— 
else
˜˜ 
{
™™ 

onComplete
šš 
(
šš 
)
šš  
;
šš  !
}
›› 
}
œœ 
catch
 
(
 
	Exception
 
ex
 
)
  
{
žž 
Serilog
ŸŸ 
.
ŸŸ 
Log
ŸŸ 
.
ŸŸ 
Error
ŸŸ !
(
ŸŸ! "
ex
ŸŸ" $
,
ŸŸ$ %
$str
ŸŸ& m
)
ŸŸm n
;
ŸŸn o

onComplete
   
(
   
)
   
;
   
}
¡¡ 
}
¢¢ 	
)
¢¢	 

.
¢¢
 
ContinueWith
¢¢ 
(
¢¢ 
task
££ 
=>
££ 
{
¤¤ 
if
¥¥ 
(
¥¥ 
task
¥¥ 
.
¥¥ 
	IsFaulted
¥¥ "
&&
¥¥# %
task
¥¥& *
.
¥¥* +
	Exception
¥¥+ 4
!=
¥¥5 7
null
¥¥8 <
)
¥¥< =
{
¦¦ 
Serilog
§§ 
.
§§ 
Log
§§ 
.
§§  
Error
§§  %
(
§§% &
task
§§& *
.
§§* +
	Exception
§§+ 4
,
§§4 5
$str§§6 ˆ
)§§ˆ ‰
;§§‰ Š

onComplete
¨¨ 
(
¨¨ 
)
¨¨  
;
¨¨  !
}
©© 
}
ªª 
,
ªª 
TaskScheduler
«« 
.
«« 
Default
«« !
)
««! "
;
««" #
}
¬¬ 
	protected
®® 
static
®® 
void
®®  
CleanupAndNavigate
®® ,
(
®®, -%
AuthenticationViewModel
®®- D"
membershipHostWindow
®®E Y
,
®®Y Z 
MembershipViewType
®®[ m

targetView
®®n x
)
®®x y
{
¯¯ "
membershipHostWindow
°° 
.
°° "
ClearNavigationStack
°° 1
(
°°1 2
)
°°2 3
;
°°3 4"
membershipHostWindow
±± 
.
±± 
Navigate
±± %
.
±±% &
Execute
±±& -
(
±±- .

targetView
±±. 8
)
±±8 9
.
±±9 :
	Subscribe
±±: C
(
±±C D
)
±±D E
;
±±E F
Task
³³ 
.
³³ 
Run
³³ 
(
³³ 
async
³³ 
(
³³ 
)
³³ 
=>
³³ 
{
´´ 	
try
µµ 
{
¶¶ 
await
·· "
membershipHostWindow
·· *
.
··* +"
HideBottomSheetAsync
··+ ?
(
··? @
)
··@ A
;
··A B
}
¸¸ 
catch
¹¹ 
(
¹¹ 
	Exception
¹¹ 
ex
¹¹ 
)
¹¹  
{
ºº 
Serilog
»» 
.
»» 
Log
»» 
.
»» 
Error
»» !
(
»»! "
ex
»»" $
,
»»$ %
$str
»»& e
)
»»e f
;
»»f g
}
¼¼ 
}
½½ 	
)
½½	 

.
½½
 
ContinueWith
½½ 
(
½½ 
task
¾¾ 
=>
¾¾ 
{
¿¿ 
if
ÀÀ 
(
ÀÀ 
task
ÀÀ 
.
ÀÀ 
	IsFaulted
ÀÀ "
&&
ÀÀ# %
task
ÀÀ& *
.
ÀÀ* +
	Exception
ÀÀ+ 4
!=
ÀÀ5 7
null
ÀÀ8 <
)
ÀÀ< =
{
ÁÁ 
Serilog
ÂÂ 
.
ÂÂ 
Log
ÂÂ 
.
ÂÂ  
Error
ÂÂ  %
(
ÂÂ% &
task
ÂÂ& *
.
ÂÂ* +
	Exception
ÂÂ+ 4
,
ÂÂ4 5
$strÂÂ6 ‚
)ÂÂ‚ ƒ
;ÂÂƒ „
}
ÃÃ 
}
ÄÄ 
,
ÄÄ 
TaskScheduler
ÅÅ 
.
ÅÅ 
Default
ÅÅ !
)
ÅÅ! "
;
ÅÅ" #
}
ÆÆ 
	protected
ÈÈ 
string
ÈÈ &
GetSecureKeyLocalization
ÈÈ -
(
ÈÈ- .'
AuthenticationFlowContext
ÈÈ. G
flowContext
ÈÈH S
,
ÈÈS T
string
ÈÈU [
registrationKey
ÈÈ\ k
,
ÈÈk l
string
ÈÈm s
recoveryKey
ÈÈt 
)ÈÈ €
=>ÈÈ ƒ
flowContextÈÈ„ 
switchÈÈ –
{
ÉÉ '
AuthenticationFlowContext
ÊÊ !
.
ÊÊ! "
REGISTRATION
ÊÊ" .
=>
ÊÊ/ 1!
LocalizationService
ÊÊ2 E
[
ÊÊE F
registrationKey
ÊÊF U
]
ÊÊU V
,
ÊÊV W'
AuthenticationFlowContext
ËË !
.
ËË! "!
SECURE_KEY_RECOVERY
ËË" 5
=>
ËË6 8!
LocalizationService
ËË9 L
[
ËËL M
recoveryKey
ËËM X
]
ËËX Y
,
ËËY Z
_
ÌÌ 	
=>
ÌÌ
 !
LocalizationService
ÌÌ  
[
ÌÌ  !
registrationKey
ÌÌ! 0
]
ÌÌ0 1
}
ÍÍ 
;
ÍÍ 
private
ÏÏ 
static
ÏÏ 
bool
ÏÏ 
IsNetworkInOutage
ÏÏ )
(
ÏÏ) *"
ConnectivitySnapshot
ÏÏ* >
snapshot
ÏÏ? G
)
ÏÏG H
=>
ÏÏI K
snapshot
ÐÐ 
.
ÐÐ 
Status
ÐÐ 
is
ÐÐ  
ConnectivityStatus
ÐÐ -
.
ÐÐ- .
Disconnected
ÐÐ. :
or
ÑÑ  
ConnectivityStatus
ÑÑ !
.
ÑÑ! "
ShuttingDown
ÑÑ" .
or
ÒÒ  
ConnectivityStatus
ÒÒ !
.
ÒÒ! "

Recovering
ÒÒ" ,
or
ÓÓ  
ConnectivityStatus
ÓÓ !
.
ÓÓ! "
RetriesExhausted
ÓÓ" 2
or
ÔÔ  
ConnectivityStatus
ÔÔ !
.
ÔÔ! "
Unavailable
ÔÔ" -
;
ÔÔ- .
	protected
ÖÖ 
static
ÖÖ %
CancellationTokenSource
ÖÖ ,'
RecreateCancellationToken
ÖÖ- F
(
ÖÖF G
ref
ÖÖG J%
CancellationTokenSource
ÖÖK b
?
ÖÖb c
cts
ÖÖd g
)
ÖÖg h
{
×× 
try
ØØ 
{
ÙÙ 	
cts
ÚÚ 
?
ÚÚ 
.
ÚÚ 
Cancel
ÚÚ 
(
ÚÚ 
)
ÚÚ 
;
ÚÚ 
}
ÛÛ 	
catch
ÜÜ 
(
ÜÜ %
ObjectDisposedException
ÜÜ &
ex
ÜÜ' )
)
ÜÜ) *
{
ÝÝ 	
System
ÞÞ 
.
ÞÞ 
Diagnostics
ÞÞ 
.
ÞÞ 
Debug
ÞÞ $
.
ÞÞ$ %
	WriteLine
ÞÞ% .
(
ÞÞ. /
$"
ÞÞ/ 1
$str
ÞÞ1 j
{
ÞÞj k
ex
ÞÞk m
.
ÞÞm n
Message
ÞÞn u
}
ÞÞu v
"
ÞÞv w
)
ÞÞw x
;
ÞÞx y
}
ßß 	
cts
áá 
?
áá 
.
áá 
Dispose
áá 
(
áá 
)
áá 
;
áá 
cts
ââ 
=
ââ 
new
ââ %
CancellationTokenSource
ââ )
(
ââ) *
)
ââ* +
;
ââ+ ,
return
ãã 
cts
ãã 
;
ãã 
}
ää 
	protected
ææ 
static
ææ %
CancellationTokenSource
ææ ,'
RecreateCancellationToken
ææ- F
(
ææF G
ref
ææG J
Option
ææK Q
<
ææQ R%
CancellationTokenSource
ææR i
>
ææi j
	ctsOption
ææk t
)
ææt u
{
çç 
	ctsOption
èè 
.
èè 
Do
èè 
(
èè 
cts
èè 
=>
èè 
{
éé 	
try
êê 
{
ëë 
cts
ìì 
.
ìì 
Cancel
ìì 
(
ìì 
)
ìì 
;
ìì 
}
íí 
catch
îî 
(
îî %
ObjectDisposedException
îî *
ex
îî+ -
)
îî- .
{
ïï 
System
ðð 
.
ðð 
Diagnostics
ðð "
.
ðð" #
Debug
ðð# (
.
ðð( )
	WriteLine
ðð) 2
(
ðð2 3
$"
ðð3 5
$str
ðð5 w
{
ððw x
ex
ððx z
.
ððz {
Messageðð{ ‚
}ðð‚ ƒ
"ððƒ „
)ðð„ …
;ðð… †
}
ññ 
cts
òò 
.
òò 
Dispose
òò 
(
òò 
)
òò 
;
òò 
}
óó 	
)
óó	 

;
óó
 %
CancellationTokenSource
õõ 
newCts
õõ  &
=
õõ' (
new
õõ) ,%
CancellationTokenSource
õõ- D
(
õõD E
)
õõE F
;
õõF G
	ctsOption
öö 
=
öö 
Option
öö 
<
öö %
CancellationTokenSource
öö 2
>
öö2 3
.
öö3 4
Some
öö4 8
(
öö8 9
newCts
öö9 ?
)
öö? @
;
öö@ A
return
÷÷ 
newCts
÷÷ 
;
÷÷ 
}
øø 
	protected
úú 
virtual
úú 
void
úú 
Dispose
úú "
(
úú" #
bool
úú# '
	disposing
úú( 1
)
úú1 2
{
ûû 
if
üü 

(
üü 
_disposedValue
üü 
)
üü 
{
ýý 	
return
þþ 
;
þþ 
}
ÿÿ 	
if
 

(
 
	disposing
 
)
 
{
‚‚ 	'
_connectivitySubscription
ƒƒ %
?
ƒƒ% &
.
ƒƒ& '
Dispose
ƒƒ' .
(
ƒƒ. /
)
ƒƒ/ 0
;
ƒƒ0 1'
_connectivitySubscription
„„ %
=
„„& '
null
„„( ,
;
„„, -
}
…… 	
_disposedValue
‡‡ 
=
‡‡ 
true
‡‡ 
;
‡‡ 
}
ˆˆ 
public
ŠŠ 

void
ŠŠ 
Dispose
ŠŠ 
(
ŠŠ 
)
ŠŠ 
{
‹‹ 
Dispose
ŒŒ 
(
ŒŒ 
	disposing
ŒŒ 
:
ŒŒ 
true
ŒŒ 
)
ŒŒ  
;
ŒŒ  !
GC
 

.

 
SuppressFinalize
 
(
 
this
  
)
  !
;
! "
}
ŽŽ 
} á;
o/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/MVVM/ViewLocator.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
MVVM !
;! "
public

 
sealed

 
class

 
ViewLocator

 
:

  !
IViewLocator

" .
{ 
private 
readonly  
ConcurrentDictionary )
<) *
Type* .
,. /
Func0 4
<4 5
object5 ;
>; <
>< =
_viewFactories> L
=M N
newO R
(R S
)S T
;T U
public 

void 
Register 
< 

TViewModel #
,# $
TView% *
>* +
(+ ,
), -
where 

TViewModel 
: 
class  
,  !
IRoutableViewModel" 4
where 
TView 
: 
class 
, 
new  
(  !
)! "
{ 
RegisterFactory 
< 

TViewModel "
>" #
(# $
($ %
)% &
=>' )
new* -
TView. 3
(3 4
)4 5
)5 6
;6 7
} 
public 

void 
RegisterFactory 
<  

TViewModel  *
>* +
(+ ,
Func, 0
<0 1
object1 7
>7 8
factory9 @
)@ A
where 

TViewModel 
: 
class  
,  !
IRoutableViewModel" 4
{ 
_viewFactories 
[ 
typeof 
( 

TViewModel (
)( )
]) *
=+ ,
factory- 4
;4 5
} 
public 

Option 
< 
object 
> 
ResolveView %
<% &

TViewModel& 0
>0 1
(1 2

TViewModel2 <
?< =
	viewModel> G
=H I
nullJ N
)N O
where 

TViewModel 
: 
class  
,  !
IRoutableViewModel" 4
{ 
if 

( 
	viewModel 
== 
null 
) 
{ 	
return   
Option   
<   
object    
>    !
.  ! "
None  " &
;  & '
}!! 	
Type## 
viewModelType## 
=## 
typeof## #
(### $

TViewModel##$ .
)##. /
;##/ 0
if%% 

(%% 
_viewFactories%% 
.%% 
TryGetValue%% &
(%%& '
viewModelType%%' 4
,%%4 5
out%%6 9
Func%%: >
<%%> ?
object%%? E
>%%E F
?%%F G
factory%%H O
)%%O P
)%%P Q
{&& 	
object'' 
view'' 
='' 
factory'' !
(''! "
)''" #
;''# $
return(( 
Option(( 
<(( 
object((  
>((  !
.((! "
Some((" &
(((& '
view((' +
)((+ ,
;((, -
})) 	
Type++ 

actualType++ 
=++ 
	viewModel++ #
.++# $
GetType++$ +
(+++ ,
)++, -
;++- .
if,, 

(,, 

actualType,, 
!=,, 
viewModelType,, '
&&,,( *
_viewFactories,,+ 9
.,,9 :
TryGetValue,,: E
(,,E F

actualType,,F P
,,,P Q
out,,R U
factory,,V ]
),,] ^
),,^ _
{-- 	
object.. 
view.. 
=.. 
factory.. !
(..! "
).." #
;..# $
return// 
Option// 
<// 
object//  
>//  !
.//! "
Some//" &
(//& '
view//' +
)//+ ,
;//, -
}00 	
object22 
?22 

staticView22 
=22 
StaticViewMapper22 -
.22- .

CreateView22. 8
(228 9

actualType229 C
)22C D
;22D E
return33 

staticView33 
.33 
ToOption33 "
(33" #
)33# $
;33$ %
}44 
public66 

Option66 
<66 
object66 
>66 
ResolveView66 %
(66% &
object66& ,
?66, -
	viewModel66. 7
)667 8
{77 
if88 

(88 
	viewModel88 
==88 
null88 
)88 
{99 	
return:: 
Option:: 
<:: 
object::  
>::  !
.::! "
None::" &
;::& '
};; 	
Type== 
viewModelType== 
=== 
	viewModel== &
.==& '
GetType==' .
(==. /
)==/ 0
;==0 1
if?? 

(?? 
_viewFactories?? 
.?? 
TryGetValue?? &
(??& '
viewModelType??' 4
,??4 5
out??6 9
Func??: >
<??> ?
object??? E
>??E F
???F G
factory??H O
)??O P
)??P Q
{@@ 	
objectAA 
viewAA 
=AA 
factoryAA !
(AA! "
)AA" #
;AA# $
returnBB 
OptionBB 
<BB 
objectBB  
>BB  !
.BB! "
SomeBB" &
(BB& '
viewBB' +
)BB+ ,
;BB, -
}CC 	
objectEE 
?EE 

staticViewEE 
=EE 
StaticViewMapperEE -
.EE- .

CreateViewEE. 8
(EE8 9
viewModelTypeEE9 F
)EEF G
;EEG H
returnFF 

staticViewFF 
.FF 
ToOptionFF "
(FF" #
)FF# $
;FF$ %
}GG 
publicII 

boolII 
IsRegisteredII 
<II 

TViewModelII '
>II' (
(II( )
)II) *
whereII+ 0

TViewModelII1 ;
:II< =
classII> C
,IIC D
IRoutableViewModelIIE W
{JJ 
returnKK 
IsRegisteredKK 
(KK 
typeofKK "
(KK" #

TViewModelKK# -
)KK- .
)KK. /
;KK/ 0
}LL 
publicNN 

boolNN 
IsRegisteredNN 
(NN 
TypeNN !
viewModelTypeNN" /
)NN/ 0
{OO 
returnPP 
_viewFactoriesPP 
.PP 
ContainsKeyPP )
(PP) *
viewModelTypePP* 7
)PP7 8
;PP8 9
}QQ 
publicSS 

IReadOnlyDictionarySS 
<SS 
TypeSS #
,SS# $
FuncSS% )
<SS) *
objectSS* 0
>SS0 1
>SS1 2
GetRegistrationsSS3 C
(SSC D
)SSD E
{TT 
returnUU 
newUU 

DictionaryUU 
<UU 
TypeUU "
,UU" #
FuncUU$ (
<UU( )
objectUU) /
>UU/ 0
>UU0 1
(UU1 2
_viewFactoriesUU2 @
)UU@ A
;UUA B
}VV 
}WW â%
t/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/MVVM/StaticViewMapper.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
MVVM !
;! "
internal 
static	 
class 
StaticViewMapper &
{ 
private 
static 
readonly 
FrozenDictionary ,
<, -
Type- 1
,1 2
Lazy3 7
<7 8
Func8 <
<< =
Control= D
>D E
>E F
>F G
ViewFactoriesH U
=V W
CreateViewFactories 
( 
) 
. 
ToFrozenDictionary 0
(0 1
)1 2
;2 3
private 
static 

Dictionary 
< 
Type "
," #
Lazy$ (
<( )
Func) -
<- .
Control. 5
>5 6
>6 7
>7 8
CreateViewFactories9 L
(L M
)M N
{ 
return 
new 

Dictionary 
< 
Type "
," #
Lazy$ (
<( )
Func) -
<- .
Control. 5
>5 6
>6 7
>7 8
{ 	
[ 
typeof 
( 
SignInViewModel #
)# $
]$ %
=& '
new( +
(+ ,
(, -
)- .
=>/ 1
(2 3
)3 4
=>5 7
new8 ;

SignInView< F
(F G
)G H
)H I
,I J
[ 
typeof 
( '
MobileVerificationViewModel /
)/ 0
]0 1
=2 3
new4 7
(7 8
(8 9
)9 :
=>; =
(> ?
)? @
=>A C
newD G"
MobileVerificationViewH ^
(^ _
)_ `
)` a
,a b
[ 
typeof 
( 
VerifyOtpViewModel &
)& '
]' (
=) *
new+ .
(. /
(/ 0
)0 1
=>2 4
(5 6
)6 7
=>8 :
new; >%
VerificationCodeEntryView? X
(X Y
)Y Z
)Z [
,[ \
[ 
typeof 
( &
SecureKeyVerifierViewModel .
). /
]/ 0
=1 2
new3 6
(6 7
(7 8
)8 9
=>: <
(= >
)> ?
=>@ B
newC F%
SecureKeyConfirmationViewG `
(` a
)a b
)b c
,c d
[ 
typeof 
( 
PassPhaseViewModel &
)& '
]' (
=) *
new+ .
(. /
(/ 0
)0 1
=>2 4
(5 6
)6 7
=>8 :
new; >
PassPhaseView? L
(L M
)M N
)N O
,O P
[ 
typeof 
( 
WelcomeViewModel $
)$ %
]% &
=' (
new) ,
(, -
(- .
). /
=>0 2
(3 4
)4 5
=>6 8
new9 <
WelcomeView= H
(H I
)I J
)J K
,K L
} 	
;	 

} 
[!! 

MethodImpl!! 
(!! 
MethodImplOptions!! !
.!!! "
AggressiveInlining!!" 4
)!!4 5
]!!5 6
public"" 

static"" 
Control"" 
?"" 

CreateView"" %
(""% &
Type""& *
viewModelType""+ 8
)""8 9
{## 
if$$ 

($$ 
!$$ 
ViewFactories$$ 
.$$ 
TryGetValue$$ &
($$& '
viewModelType$$' 4
,$$4 5
out$$6 9
Lazy$$: >
<$$> ?
Func$$? C
<$$C D
Control$$D K
>$$K L
>$$L M
?$$M N
lazyFactory$$O Z
)$$Z [
)$$[ \
{%% 	
return&& 
null&& 
;&& 
}'' 	
Func)) 
<)) 
Control)) 
>)) 
factory)) 
=)) 
lazyFactory))  +
.))+ ,
Value)), 1
;))1 2
Control** 
result** 
=** 
factory**  
(**  !
)**! "
;**" #
return++ 
result++ 
;++ 
},, 
}-- ž
€/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/MVVM/ReactiveUIViewLocatorAdapter.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
MVVM !
;! "
public 
class (
ReactiveUiViewLocatorAdapter )
() *
Abstractions* 6
.6 7
IViewLocator7 C
moduleViewLocatorD U
)U V
:W X
IViewLocatorY e
{ 
[		 (
UnconditionalSuppressMessage		 !
(		! "
$str		" ,
,		, -
$str		. 6
,		6 7
Justification

 
=

 
$str

 d
)

d e
]

e f
public 

IViewFor 
? 
ResolveView  
<  !
T! "
>" #
(# $
T$ %
?% &
	viewModel' 0
,0 1
string2 8
?8 9
contract: B
=C D
nullE I
)I J
{ 
if 

( 
object 
. 
Equals 
( 
	viewModel #
,# $
default% ,
(, -
T- .
). /
)/ 0
)0 1
{ 	
return 
null 
; 
} 	
Option 
< 
object 
> 

viewOption !
=" #
moduleViewLocator$ 5
.5 6
ResolveView6 A
(A B
	viewModelB K
)K L
;L M
if 

( 
! 

viewOption 
. 
IsSome 
) 
{ 	
return 
null 
; 
} 	
object 
view 
= 

viewOption  
.  !
Value! &
!& '
;' (
if 

( 
view 
is 
not 
IViewFor  
viewForInstance! 0
)0 1
{ 	
return 
null 
; 
} 	
viewForInstance   
.   
	ViewModel   !
??=  " %
	viewModel  & /
;  / 0
return!! 
viewForInstance!! 
;!! 
}"" 
}## ¶
u/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/MVVM/ModuleViewFactory.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
MVVM !
;! "
public		 
class		 
ModuleViewFactory		 
:		  
IModuleViewFactory		! 3
{

 
private 
readonly 

Dictionary 
<  
Type  $
,$ %
Func& *
<* +
Control+ 2
>2 3
>3 4

_factories5 ?
=@ A
newB E
(E F
)F G
;G H
public 

void 
RegisterView 
< 

TViewModel '
,' (
TView) .
>. /
(/ 0
)0 1
where 

TViewModel 
: 
class  
where 
TView 
: 
Control 
, 
new "
(" #
)# $
{ 
Type 
vmType 
= 
typeof 
( 

TViewModel '
)' (
;( )

_factories 
[ 
vmType 
] 
= 
( 
) 
=>  "
new# &
TView' ,
(, -
)- .
;. /
} 
public 

Option 
< 
Control 
> 

CreateView %
(% &
Type& *
viewModelType+ 8
)8 9
{ 
return 

_factories 
. 
GetValueOrDefault +
(+ ,
viewModelType, 9
)9 :
.: ;
ToOption; C
(C D
)D E
. 
Select 
( 
factory 
=> 
factory &
(& '
)' (
)( )
;) *
} 
} ñ
u/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/ModuleScope.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
internal 
sealed	 
class 
ModuleScope !
(! "
string" (

moduleName) 3
,3 4
IServiceScope5 B
serviceScopeC O
)O P
:Q R
IModuleScopeS _
{		 
private

 
long

 
	_disposed

 
;

 
public 

IServiceProvider 
ServiceProvider +
{, -
get. 1
;1 2
}3 4
=5 6
serviceScope7 C
.C D
ServiceProviderD S
;S T
public 

string 

ModuleName 
{ 
get "
;" #
}$ %
=& '

moduleName( 2
;2 3
public 

void 
Dispose 
( 
) 
{ 
if 

( 
Interlocked 
. 
CompareExchange '
(' (
ref( +
	_disposed, 5
,5 6
$num7 8
,8 9
$num: ;
); <
=== ?
$num@ A
)A B
{ 	
return 
; 
} 	
serviceScope 
. 
Dispose 
( 
) 
; 
} 
} Âf
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/ModuleResourceManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
internal

 
sealed

	 
class

  
ModuleServiceContext

 *
(

* +
IServiceProvider

+ ;
parentProvider

< J
)

J K
{ 
public 

T 
GetParentService 
< 
T 
>  
(  !
)! "
where# (
T) *
:+ ,
notnull- 4
=>5 7
parentProvider8 F
.F G
GetRequiredServiceG Y
<Y Z
TZ [
>[ \
(\ ]
)] ^
;^ _
} 
internal 
class	 !
ModuleResourceManager $
($ %
IServiceProvider% 5
serviceProvider6 E
)E F
:G H
IDisposableI T
{ 
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
IModuleScope2 >
>> ?
_moduleScopes@ M
=N O
newP S
(S T
)T U
;U V
private 
bool 
	_disposed 
; 
public 

IModuleScope 
CreateModuleScope )
() *
string* 0

moduleName1 ;
,; <
Action= C
<C D
IServiceCollectionD V
>V W
?W X
configureServicesY j
=k l
nullm q
)q r
{ 
IServiceScope 
serviceScope "
;" #
if 

( 
configureServices 
!=  
null! %
)% &
{ 	
IServiceScope 
parentScope %
=& '
serviceProvider( 7
.7 8
CreateScope8 C
(C D
)D E
;E F
ServiceCollection 
moduleServices ,
=- .
new/ 2
(2 3
)3 4
;4 5 
ModuleServiceContext  
context! (
=) *
new+ .
(. /
parentScope/ :
.: ;
ServiceProvider; J
)J K
;K L
moduleServices 
. 
AddSingleton '
(' (
context( /
)/ 0
;0 1#
AutoForwardCoreServices   #
(  # $
moduleServices  $ 2
,  2 3
context  4 ;
)  ; <
;  < =
configureServices"" 
("" 
moduleServices"" ,
)"", -
;""- .
ServiceProvider$$ !
moduleServiceProvider$$ 1
=$$2 3
moduleServices$$4 B
.$$B C 
BuildServiceProvider$$C W
($$W X
)$$X Y
;$$Y Z
serviceScope%% 
=%% 
new%% !
CompositeServiceScope%% 4
(%%4 5!
moduleServiceProvider%%5 J
,%%J K
parentScope%%L W
)%%W X
;%%X Y
}&& 	
else'' 
{(( 	
serviceScope)) 
=)) 
serviceProvider)) *
.))* +
CreateScope))+ 6
())6 7
)))7 8
;))8 9
}** 	
ModuleScope,, 
moduleScope,, 
=,,  !
new,," %
(,,% &

moduleName,,& 0
,,,0 1
serviceScope,,2 >
),,> ?
;,,? @
if.. 

(.. 
!.. 
_moduleScopes.. 
... 
TryAdd.. !
(..! "

moduleName.." ,
,.., -
moduleScope... 9
)..9 :
)..: ;
{// 	
moduleScope00 
.00 
Dispose00 
(00  
)00  !
;00! "
throw11 
new11 %
InvalidOperationException11 /
(11/ 0
$"110 2
$str112 D
{11D E

moduleName11E O
}11O P
$str11P `
"11` a
)11a b
;11b c
}22 	
Log44 
.44 
Information44 
(44 
$str44 ?
,44? @

moduleName44A K
)44K L
;44L M
return66 
moduleScope66 
;66 
}77 
private99 
static99 
void99 #
AutoForwardCoreServices99 /
(99/ 0
IServiceCollection990 B
moduleServices99C Q
,99Q R 
ModuleServiceContext99S g
context99h o
)99o p
{:: 
moduleServices;; 
.;; 
AddSingleton;; #
(;;# $
context;;$ +
.;;+ ,
GetParentService;;, <
<;;< =
Core;;= A
.;;A B
	Messaging;;B K
.;;K L
Services;;L T
.;;T U 
IConnectivityService;;U i
>;;i j
(;;j k
);;k l
);;l m
;;;m n
moduleServices<< 
.<< 
AddSingleton<< #
(<<# $
context<<$ +
.<<+ ,
GetParentService<<, <
<<<< =
Core<<= A
.<<A B
	Messaging<<B K
.<<K L
Services<<L T
.<<T U
IBottomSheetService<<U h
><<h i
(<<i j
)<<j k
)<<k l
;<<l m
moduleServices== 
.== 
AddSingleton== #
(==# $
context==$ +
.==+ ,
GetParentService==, <
<==< =
Core=== A
.==A B
	Messaging==B K
.==K L
Services==L T
.==T U%
ILanguageDetectionService==U n
>==n o
(==o p
)==p q
)==q r
;==r s
moduleServices>> 
.>> 
AddSingleton>> #
(>># $
context>>$ +
.>>+ ,
GetParentService>>, <
<>>< =
Infrastructure>>= K
.>>K L
Network>>L S
.>>S T
Core>>T X
.>>X Y
	Providers>>Y b
.>>b c
NetworkProvider>>c r
>>>r s
(>>s t
)>>t u
)>>u v
;>>v w
moduleServices?? 
.?? 
AddSingleton?? #
(??# $
context??$ +
.??+ ,
GetParentService??, <
<??< =
Infrastructure??= K
.??K L
Network??L S
.??S T
Abstractions??T `
.??` a
Core??a e
.??e f*
IInternetConnectivityObserver	??f ƒ
>
??ƒ „
(
??„ …
)
??… †
)
??† ‡
;
??‡ ˆ
moduleServices@@ 
.@@ 
AddSingleton@@ #
(@@# $
context@@$ +
.@@+ ,
GetParentService@@, <
<@@< =
Infrastructure@@= K
.@@K L
Network@@L S
.@@S T
Abstractions@@T `
.@@` a
	Transport@@a j
.@@j k 
IRpcMetaDataProvider@@k 
>	@@ €
(
@@€ 
)
@@ ‚
)
@@‚ ƒ
;
@@ƒ „
moduleServicesAA 
.AA 
AddSingletonAA #
(AA# $
contextAA$ +
.AA+ ,
GetParentServiceAA, <
<AA< =
InfrastructureAA= K
.AAK L
DataAAL P
.AAP Q
AbstractionsAAQ ]
.AA] ^-
!IApplicationSecureStorageProviderAA^ 
>	AA €
(
AA€ 
)
AA ‚
)
AA‚ ƒ
;
AAƒ „
moduleServicesBB 
.BB 
AddSingletonBB #
(BB# $
contextBB$ +
.BB+ ,
GetParentServiceBB, <
<BB< =
ServicesBB= E
.BBE F
AbstractionsBBF R
.BBR S
CoreBBS W
.BBW X 
ILocalizationServiceBBX l
>BBl m
(BBm n
)BBn o
)BBo p
;BBp q
moduleServicesCC 
.CC 
AddSingletonCC #
(CC# $
contextCC$ +
.CC+ ,
GetParentServiceCC, <
<CC< =
ServicesCC= E
.CCE F
AbstractionsCCF R
.CCR S
CoreCCS W
.CCW X
IApplicationRouterCCX j
>CCj k
(CCk l
)CCl m
)CCm n
;CCn o
moduleServicesDD 
.DD 
AddSingletonDD #
(DD# $
contextDD$ +
.DD+ ,
GetParentServiceDD, <
<DD< =
ServicesDD= E
.DDE F
AbstractionsDDF R
.DDR S

MembershipDDS ]
.DD] ^
ILogoutServiceDD^ l
>DDl m
(DDm n
)DDn o
)DDo p
;DDp q
moduleServicesEE 
.EE 
AddSingletonEE #
(EE# $
contextEE$ +
.EE+ ,
GetParentServiceEE, <
<EE< =
ServicesEE= E
.EEE F
AbstractionsEEF R
.EER S
AuthenticationEES a
.EEa b"
IAuthenticationServiceEEb x
>EEx y
(EEy z
)EEz {
)EE{ |
;EE| }
moduleServicesFF 
.FF 
AddSingletonFF #
(FF# $
contextFF$ +
.FF+ ,
GetParentServiceFF, <
<FF< =
ServicesFF= E
.FFE F
AbstractionsFFF R
.FFR S
AuthenticationFFS a
.FFa b&
IOpaqueRegistrationServiceFFb |
>FF| }
(FF} ~
)FF~ 
)	FF €
;
FF€ 
moduleServicesGG 
.GG 
AddSingletonGG #
(GG# $
contextGG$ +
.GG+ ,
GetParentServiceGG, <
<GG< =
ServicesGG= E
.GGE F
AbstractionsGGF R
.GGR S
AuthenticationGGS a
.GGa b%
ISecureKeyRecoveryServiceGGb {
>GG{ |
(GG| }
)GG} ~
)GG~ 
;	GG €
moduleServicesHH 
.HH 
AddSingletonHH #
(HH# $
contextHH$ +
.HH+ ,
GetParentServiceHH, <
<HH< =
EcliptixHH= E
.HHE F
CoreHHF J
.HHJ K
ControlsHHK S
.HHS T
CoreHHT X
.HHX Y-
!ConnectivityNotificationViewModelHHY z
>HHz {
(HH{ |
)HH| }
)HH} ~
;HH~ 
LogJJ 
.JJ 
DebugJJ 
(JJ 
$strJJ M
)JJM N
;JJN O
}KK 
publicMM 

boolMM 
RemoveModuleScopeMM !
(MM! "
stringMM" (

moduleNameMM) 3
)MM3 4
{NN 
ifOO 

(OO 
_moduleScopesOO 
.OO 
	TryRemoveOO #
(OO# $

moduleNameOO$ .
,OO. /
outOO0 3
IModuleScopeOO4 @
?OO@ A
scopeOOB G
)OOG H
)OOH I
{PP 	
scopeQQ 
.QQ 
DisposeQQ 
(QQ 
)QQ 
;QQ 
LogRR 
.RR 
InformationRR 
(RR 
$strRR C
,RRC D

moduleNameRRE O
)RRO P
;RRP Q
returnSS 
trueSS 
;SS 
}TT 	
returnVV 
falseVV 
;VV 
}WW 
publicYY 

voidYY 
DisposeYY 
(YY 
)YY 
{ZZ 
Dispose[[ 
([[ 
true[[ 
)[[ 
;[[ 
GC\\ 

.\\
 
SuppressFinalize\\ 
(\\ 
this\\  
)\\  !
;\\! "
}]] 
	protected__ 
virtual__ 
void__ 
Dispose__ "
(__" #
bool__# '
	disposing__( 1
)__1 2
{`` 
ifaa 

(aa 
	_disposedaa 
)aa 
{bb 	
returncc 
;cc 
}dd 	
ifff 

(ff 
	disposingff 
)ff 
{gg 	
foreachhh 
(hh 
KeyValuePairhh !
<hh! "
stringhh" (
,hh( )
IModuleScopehh* 6
>hh6 7
kvphh8 ;
inhh< >
_moduleScopeshh? L
)hhL M
{ii 
tryjj 
{kk 
kvpll 
.ll 
Valuell 
.ll 
Disposell %
(ll% &
)ll& '
;ll' (
}mm 
catchnn 
(nn 
	Exceptionnn  
exnn! #
)nn# $
{oo 
Logpp 
.pp 
Errorpp 
(pp 
expp  
,pp  !
$strpp" Q
,ppQ R
kvpppS V
.ppV W
KeyppW Z
)ppZ [
;pp[ \
}qq 
}rr 
_moduleScopestt 
.tt 
Cleartt 
(tt  
)tt  !
;tt! "
}uu 	
	_disposedww 
=ww 
trueww 
;ww 
}xx 
}yy §x
w/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/ModuleManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
public 
class 
ModuleManager 
: 
IModuleManager +
{ 
private 
readonly 
IModuleCatalog #
_catalog$ ,
;, -
private 
readonly 
IServiceProvider %
_serviceProvider& 6
;6 7
private 
readonly 
IModuleMessageBus &
_messageBus' 2
;2 3
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
ModuleState2 =
>= >
_moduleStates? L
=M N
newO R
(R S
)S T
;T U
public 

ModuleManager 
( 
IModuleCatalog '
catalog( /
,/ 0
IServiceProvider1 A
serviceProviderB Q
)Q R
{ 
_catalog 
= 
catalog 
; 
_serviceProvider 
= 
serviceProvider *
;* +
_messageBus 
= 
serviceProvider %
.% &

GetService& 0
<0 1
IModuleMessageBus1 B
>B C
(C D
)D E
!E F
;F G
foreach 
( 
IModule 
module 
in  "
_catalog# +
.+ ,

GetModules, 6
(6 7
)7 8
)8 9
{ 	
_moduleStates 
[ 
module  
.  !
Id! #
.# $
ToName$ *
(* +
)+ ,
], -
=. /
ModuleState0 ;
.; <
	NotLoaded< E
;E F
} 	
} 
public   

async   
Task   
<   
Option   
<   
IModule   $
>  $ %
>  % &
LoadModuleAsync  ' 6
(  6 7
string  7 =

moduleName  > H
)  H I
{!! 
Option"" 
<"" 
IModule"" 
>"" 
moduleOption"" $
=""% &
_catalog""' /
.""/ 0
	GetModule""0 9
(""9 :

moduleName"": D
)""D E
;""E F
if## 

(## 
!## 
moduleOption## 
.## 
IsSome##  
)##  !
{$$ 	
Log%% 
.%% 
Warning%% 
(%% 
$str%% D
,%%D E

moduleName%%F P
)%%P Q
;%%Q R
return&& 
Option&& 
<&& 
IModule&& !
>&&! "
.&&" #
None&&# '
;&&' (
}'' 	
IModule)) 
module)) 
=)) 
moduleOption)) %
.))% &
Value))& +
!))+ ,
;)), -
if++ 

(++ 
!++ 
_moduleStates++ 
.++ 
TryGetValue++ &
(++& '

moduleName++' 1
,++1 2
out++3 6
ModuleState++7 B
currentState++C O
)++O P
)++P Q
{,, 	
Log-- 
.-- 
Error-- 
(-- 
$str-- C
,--C D

moduleName--E O
)--O P
;--P Q
return.. 
Option.. 
<.. 
IModule.. !
>..! "
..." #
None..# '
;..' (
}// 	
if11 

(11 
currentState11 
==11 
ModuleState11 '
.11' (
Loaded11( .
)11. /
{22 	
return33 
Option33 
<33 
IModule33 !
>33! "
.33" #
Some33# '
(33' (
module33( .
)33. /
;33/ 0
}44 	
if66 

(66 
!66 
_moduleStates66 
.66 
	TryUpdate66 $
(66$ %

moduleName66% /
,66/ 0
ModuleState661 <
.66< =
Loading66= D
,66D E
currentState66F R
)66R S
)66S T
{77 	
if88 
(88 
_moduleStates88 
.88 
TryGetValue88 )
(88) *

moduleName88* 4
,884 5
out886 9
ModuleState88: E
updatedState88F R
)88R S
&&88T V
updatedState99 
==99 
ModuleState99  +
.99+ ,
Loaded99, 2
)992 3
{:: 
return;; 
Option;; 
<;; 
IModule;; %
>;;% &
.;;& '
Some;;' +
(;;+ ,
module;;, 2
);;2 3
;;;3 4
}<< 
Log>> 
.>> 
Warning>> 
(>> 
$str>> ^
,>>^ _

moduleName>>` j
)>>j k
;>>k l
return?? 
Option?? 
<?? 
IModule?? !
>??! "
.??" #
None??# '
;??' (
}@@ 	
ifBB 

(BB 
!BB 
awaitBB 
moduleBB 
.BB 
CanLoadAsyncBB &
(BB& '
)BB' (
)BB( )
{CC 	
_moduleStatesDD 
[DD 

moduleNameDD $
]DD$ %
=DD& '
ModuleStateDD( 3
.DD3 4
FailedDD4 :
;DD: ;
LogEE 
.EE 
WarningEE 
(EE 
$strEE M
,EEM N

moduleNameEEO Y
)EEY Z
;EEZ [
returnFF 
OptionFF 
<FF 
IModuleFF !
>FF! "
.FF" #
NoneFF# '
;FF' (
}GG 	
awaitII 
moduleII 
.II 
	LoadAsyncII 
(II 
_serviceProviderII /
)II/ 0
;II0 1
_moduleStatesKK 
[KK 

moduleNameKK  
]KK  !
=KK" #
ModuleStateKK$ /
.KK/ 0
LoadedKK0 6
;KK6 7
awaitMM 
moduleMM 
.MM %
SetupMessageHandlersAsyncMM .
(MM. /
_messageBusMM/ :
)MM: ;
;MM; <
returnNN 
OptionNN 
<NN 
IModuleNN 
>NN 
.NN 
SomeNN #
(NN# $
moduleNN$ *
)NN* +
;NN+ ,
}OO 
publicQQ 

asyncQQ 
TaskQQ 
LoadModulesAsyncQQ &
(QQ& '!
ModuleLoadingStrategyQQ' <
strategyQQ= E
)QQE F
{RR 
IModuleSS 
[SS 
]SS 
modulesToLoadSS 
=SS  !
_catalogSS" *
.SS* +

GetModulesSS+ 5
(SS5 6
)SS6 7
.TT 
WhereTT 
(TT 
mTT 
=>TT 
mTT 
.TT 
ManifestTT "
.TT" #
LoadingStrategyTT# 2
==TT3 5
strategyTT6 >
&&TT? A
!TTB C
IsModuleLoadedTTC Q
(TTQ R
mTTR S
.TTS T
IdTTT V
.TTV W
ToNameTTW ]
(TT] ^
)TT^ _
)TT_ `
)TT` a
.UU 
ToArrayUU 
(UU 
)UU 
;UU 
ifWW 

(WW 
modulesToLoadWW 
.WW 
LengthWW  
==WW! #
$numWW$ %
)WW% &
{XX 	
returnYY 
;YY 
}ZZ 	
foreach\\ 
(\\ 
IModule\\ 
module\\ 
in\\  "
modulesToLoad\\# 0
)\\0 1
{]] 	
await^^ 
LoadModuleAsync^^ !
(^^! "
module^^" (
.^^( )
Id^^) +
.^^+ ,
ToName^^, 2
(^^2 3
)^^3 4
)^^4 5
;^^5 6
}__ 	
}`` 
publicbb 

asyncbb 
Taskbb !
LoadEagerModulesAsyncbb +
(bb+ ,
)bb, -
{cc 
awaitdd 
LoadModulesAsyncdd 
(dd !
ModuleLoadingStrategydd 4
.dd4 5
Eagerdd5 :
)dd: ;
;dd; <
}ee 
publicgg 

asyncgg 
Taskgg 
<gg 
IReadOnlyListgg #
<gg# $
IModulegg$ +
>gg+ ,
>gg, -
LoadAllModulesAsyncgg. A
(ggA B
)ggB C
{hh 
IModuleii 
[ii 
]ii 
unloadedModulesii !
=ii" #
_catalogii$ ,
.ii, -

GetModulesii- 7
(ii7 8
)ii8 9
.jj 
Wherejj 
(jj 
mjj 
=>jj 
!jj 
IsModuleLoadedjj '
(jj' (
mjj( )
.jj) *
Idjj* ,
.jj, -
ToNamejj- 3
(jj3 4
)jj4 5
)jj5 6
)jj6 7
.kk 
ToArraykk 
(kk 
)kk 
;kk 
ifmm 

(mm 
unloadedModulesmm 
.mm 
Lengthmm "
==mm# %
$nummm& '
)mm' (
{nn 	
returnoo 
[oo 
]oo 
;oo 
}pp 	
Listrr 
<rr 
IModulerr 
>rr 
loadedModulesrr #
=rr$ %
newrr& )
(rr) *
)rr* +
;rr+ ,
foreachss 
(ss 
IModuless 
moduless 
inss  "
unloadedModulesss# 2
)ss2 3
{tt 	
Optionuu 
<uu 
IModuleuu 
>uu 
resultuu "
=uu# $
awaituu% *
LoadModuleAsyncuu+ :
(uu: ;
moduleuu; A
.uuA B
IduuB D
.uuD E
ToNameuuE K
(uuK L
)uuL M
)uuM N
;uuN O
ifvv 
(vv 
resultvv 
.vv 
IsSomevv 
)vv 
{ww 
loadedModulesxx 
.xx 
Addxx !
(xx! "
resultxx" (
.xx( )
Valuexx) .
!xx. /
)xx/ 0
;xx0 1
}yy 
}zz 	
return|| 
loadedModules|| 
;|| 
}}} 
public 

void %
StartBackgroundPreloading )
() *
)* +
{
€€ 
IModule
 
[
 
]
 
backgroundModules
 #
=
$ %
_catalog
& .
.
. /

GetModules
/ 9
(
9 :
)
: ;
.
‚‚ 
Where
‚‚ 
(
‚‚ 
m
‚‚ 
=>
‚‚ 
m
‚‚ 
.
‚‚ 
Manifest
‚‚ "
.
‚‚" #
LoadingStrategy
‚‚# 2
==
‚‚3 5#
ModuleLoadingStrategy
‚‚6 K
.
‚‚K L

Background
‚‚L V
&&
‚‚W Y
!
ƒƒ 
IsModuleLoaded
ƒƒ '
(
ƒƒ' (
m
ƒƒ( )
.
ƒƒ) *
Id
ƒƒ* ,
.
ƒƒ, -
ToName
ƒƒ- 3
(
ƒƒ3 4
)
ƒƒ4 5
)
ƒƒ5 6
)
ƒƒ6 7
.
„„ 
ToArray
„„ 
(
„„ 
)
„„ 
;
„„ 
if
†† 

(
†† 
backgroundModules
†† 
.
†† 
Length
†† $
>
††% &
$num
††' (
)
††( )
{
‡‡ 	
Task
ˆˆ 
.
ˆˆ 
Run
ˆˆ 
(
ˆˆ 
async
ˆˆ 
(
ˆˆ 
)
ˆˆ 
=>
ˆˆ  
{
‰‰ 
foreach
ŠŠ 
(
ŠŠ 
IModule
ŠŠ  
module
ŠŠ! '
in
ŠŠ( *
backgroundModules
ŠŠ+ <
)
ŠŠ< =
{
‹‹ 
await
ŒŒ 
LoadModuleAsync
ŒŒ )
(
ŒŒ) *
module
ŒŒ* 0
.
ŒŒ0 1
Id
ŒŒ1 3
.
ŒŒ3 4
ToName
ŒŒ4 :
(
ŒŒ: ;
)
ŒŒ; <
)
ŒŒ< =
;
ŒŒ= >
}
 
}
ŽŽ 
)
ŽŽ 
;
ŽŽ 
}
 	
}
 
public
’’ 

async
’’ 
Task
’’ 
UnloadModuleAsync
’’ '
(
’’' (
string
’’( .

moduleName
’’/ 9
)
’’9 :
{
““ 
Option
”” 
<
”” 
IModule
”” 
>
”” 
moduleOption
”” $
=
””% &
_catalog
””' /
.
””/ 0
	GetModule
””0 9
(
””9 :

moduleName
””: D
)
””D E
;
””E F
if
•• 

(
•• 
!
•• 
moduleOption
•• 
.
•• 
IsSome
••  
||
••! #
!
••$ %
IsModuleLoaded
••% 3
(
••3 4

moduleName
••4 >
)
••> ?
)
••? @
{
–– 	
return
—— 
;
—— 
}
˜˜ 	
IModule
šš 
module
šš 
=
šš 
moduleOption
šš %
.
šš% &
Value
šš& +
!
šš+ ,
;
šš, -
_moduleStates
œœ 
[
œœ 

moduleName
œœ  
]
œœ  !
=
œœ" #
ModuleState
œœ$ /
.
œœ/ 0
	Unloading
œœ0 9
;
œœ9 :
await
žž 
module
žž 
.
žž 
UnloadAsync
žž  
(
žž  !
)
žž! "
;
žž" #
_moduleStates
ŸŸ 
[
ŸŸ 

moduleName
ŸŸ  
]
ŸŸ  !
=
ŸŸ" #
ModuleState
ŸŸ$ /
.
ŸŸ/ 0
Unloaded
ŸŸ0 8
;
ŸŸ8 9#
ModuleResourceManager
¡¡ 
?
¡¡ 
resourceManager
¡¡ .
=
¡¡/ 0
_serviceProvider
¡¡1 A
.
¡¡A B

GetService
¡¡B L
<
¡¡L M#
ModuleResourceManager
¡¡M b
>
¡¡b c
(
¡¡c d
)
¡¡d e
;
¡¡e f
resourceManager
¢¢ 
?
¢¢ 
.
¢¢ 
RemoveModuleScope
¢¢ *
(
¢¢* +

moduleName
¢¢+ 5
)
¢¢5 6
;
¢¢6 7
}
££ 
public
¥¥ 

bool
¥¥ 
IsModuleLoaded
¥¥ 
(
¥¥ 
string
¥¥ %

moduleName
¥¥& 0
)
¥¥0 1
=>
¥¥2 4
_moduleStates
¦¦ 
.
¦¦ 
TryGetValue
¦¦ !
(
¦¦! "

moduleName
¦¦" ,
,
¦¦, -
out
¦¦. 1
ModuleState
¦¦2 =
state
¦¦> C
)
¦¦C D
&&
¦¦E G
state
¦¦H M
==
¦¦N P
ModuleState
¦¦Q \
.
¦¦\ ]
Loaded
¦¦] c
;
¦¦c d
public
¨¨ 
!
IReadOnlyDictionary
¨¨ 
<
¨¨ 
string
¨¨ %
,
¨¨% &
ModuleState
¨¨' 2
>
¨¨2 3
GetModuleStates
¨¨4 C
(
¨¨C D
)
¨¨D E
=>
¨¨F H
new
©© 

Dictionary
©© 
<
©© 
string
©© 
,
©© 
ModuleState
©© *
>
©©* +
(
©©+ ,
_moduleStates
©©, 9
)
©©9 :
;
©©: ;
}ªª É
w/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/ModuleCatalog.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
public		 
	interface		 
IModuleCatalog		 
{

 
void 
	AddModule	 
< 
TModule 
> 
( 
) 
where #
TModule$ +
:, -
class. 3
,3 4
IModule5 <
,< =
new> A
(A B
)B C
;C D
void 
	AddModule	 
( 
IModule 
module !
)! "
;" #
IReadOnlyList 
< 
IModule 
> 

GetModules %
(% &
)& '
;' (
Option 

<
 
IModule 
> 
	GetModule 
( 
string $
name% )
)) *
;* +
} 
public 
class 
ModuleCatalog 
: 
IModuleCatalog +
{ 
private 
readonly 
List 
< 
IModule !
>! "
_modules# +
=, -
[. /
]/ 0
;0 1
public 

void 
	AddModule 
< 
TModule !
>! "
(" #
)# $
where% *
TModule+ 2
:3 4
class5 :
,: ;
IModule< C
,C D
newE H
(H I
)I J
{ 
IModule 
module 
= 
new 
TModule $
($ %
)% &
;& '
	AddModule 
( 
module 
) 
; 
} 
public 

void 
	AddModule 
( 
IModule !
module" (
)( )
{ 
if 

( 
_modules 
. 
Any 
( 
m 
=> 
m 
.  
Id  "
==# %
module& ,
., -
Id- /
)/ 0
)0 1
{ 	
return   
;   
}!! 	
_modules## 
.## 
Add## 
(## 
module## 
)## 
;## 
}$$ 
public&& 

IReadOnlyList&& 
<&& 
IModule&&  
>&&  !

GetModules&&" ,
(&&, -
)&&- .
=>&&/ 1
_modules&&2 :
.&&: ;

AsReadOnly&&; E
(&&E F
)&&F G
;&&G H
public(( 

Option(( 
<(( 
IModule(( 
>(( 
	GetModule(( $
((($ %
string((% +
name((, 0
)((0 1
=>((2 4
_modules)) 
.)) 
FirstOrDefault)) 
())  
m))  !
=>))" $
string))% +
.))+ ,
Equals)), 2
())2 3
m))3 4
.))4 5
Id))5 7
.))7 8
ToName))8 >
())> ?
)))? @
,))@ A
name))B F
,))F G
StringComparison))H X
.))X Y
OrdinalIgnoreCase))Y j
)))j k
)))k l
.** 
ToOption** 
(** 
)** 
;** 
}++ ¤’
‚/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/ModuleDependencyResolver.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
public		 
class		 $
ModuleDependencyResolver		 %
{

 
public 

Task 
< 
IEnumerable 
< 
IModule #
># $
>$ %!
ResolveLoadOrderAsync& ;
(; <
IEnumerable< G
<G H
IModuleH O
>O P
modulesQ X
)X Y
{ 
List 
< 
IModule 
> 

moduleList  
=! "
modules# *
.* +
ToList+ 1
(1 2
)2 3
;3 4

Dictionary 
< 
string 
, 
IModule "
>" #
	moduleMap$ -
=. /

moduleList0 :
.: ;
ToDictionary; G
(G H
mH I
=>J L
mM N
.N O
IdO Q
.Q R
ToNameR X
(X Y
)Y Z
,Z [
m\ ]
=>^ `
ma b
)b c
;c d 
ValidateDependencies 
( 

moduleList '
,' (
	moduleMap) 2
)2 3
;3 4
return 
Task 
. 

FromResult 
( 
TopologicalSort .
(. /

moduleList/ 9
,9 :
	moduleMap; D
)D E
)E F
;F G
} 
public 

Task 
< 
IEnumerable 
< 
IModule #
># $
>$ %#
GetRequiredModulesAsync& =
(= >
string> D

moduleNameE O
,O P
IEnumerableQ \
<\ ]
IModule] d
>d e
availableModulesf v
)v w
{ 

Dictionary 
< 
string 
, 
IModule "
>" #
	moduleMap$ -
=. /
availableModules0 @
.@ A
ToDictionaryA M
(M N
mN O
=>P R
mS T
.T U
IdU W
.W X
ToNameX ^
(^ _
)_ `
,` a
mb c
=>d f
mg h
)h i
;i j
if 

( 
! 
	moduleMap 
. 
TryGetValue "
(" #

moduleName# -
,- .
out/ 2
IModule3 :
?: ;
targetModule< H
)H I
)I J
{ 	
throw 
new %
InvalidOperationException /
(/ 0
$"0 2
$str2 9
{9 :

moduleName: D
}D E
$strE O
"O P
)P Q
;Q R
} 	
HashSet 
< 
string 
> 
required  
=! "
new# &
(& '
)' (
;( )$
GetDependenciesRecursive  
(  !
targetModule! -
,- .
	moduleMap/ 8
,8 9
required: B
)B C
;C D
return!! 
Task!! 
.!! 

FromResult!! 
(!! 
required!! '
.!!' (
Select!!( .
(!!. /
name!!/ 3
=>!!4 6
	moduleMap!!7 @
[!!@ A
name!!A E
]!!E F
)!!F G
)!!G H
;!!H I
}"" 
private$$ 
void$$  
ValidateDependencies$$ %
($$% &
List$$& *
<$$* +
IModule$$+ 2
>$$2 3
modules$$4 ;
,$$; <

Dictionary$$= G
<$$G H
string$$H N
,$$N O
IModule$$P W
>$$W X
	moduleMap$$Y b
)$$b c
{%% 
(&& 	
IModule&&	 
Module&& 
,&& 
ModuleIdentifier&& )

Dependency&&* 4
)&&4 5
?&&5 6!
missingDependencyInfo&&7 L
=&&M N
modules&&O V
.'' 

SelectMany'' 
('' 
module'' 
=>'' !
module''" (
.''( )
Manifest'') 1
.''1 2
Dependencies''2 >
.(( 
Where(( 
((( 

dependency(( !
=>((" $
!((% &
	moduleMap((& /
.((/ 0
ContainsKey((0 ;
(((; <

dependency((< F
.((F G
ToName((G M
(((M N
)((N O
)((O P
)((P Q
.)) 
Select)) 
()) 

dependency)) "
=>))# %
())& '
Module))' -
:))- .
module))/ 5
,))5 6

Dependency))7 A
:))A B

dependency))C M
)))M N
)))N O
)))O P
.** 
Cast** 
<** 
(** 
IModule** 
,** 
ModuleIdentifier** ,
)**, -
?**- .
>**. /
(**/ 0
)**0 1
.++ 
FirstOrDefault++ 
(++ 
)++ 
;++ 
if-- 

(-- !
missingDependencyInfo-- !
!=--" $
null--% )
)--) *
{.. 	
throw// 
new// %
InvalidOperationException// /
(/// 0
$"00 
$str00 
{00 !
missingDependencyInfo00 0
.000 1
Value001 6
.006 7
Module007 =
.00= >
Id00> @
.00@ A
ToName00A G
(00G H
)00H I
}00I J
$str00J X
{00X Y!
missingDependencyInfo00Y n
.00n o
Value00o t
.00t u

Dependency00u 
.	00 €
ToName
00€ †
(
00† ‡
)
00‡ ˆ
}
00ˆ ‰
$str
00‰ ‘
{
00‘ ’#
missingDependencyInfo
00’ §
.
00§ ¨
Value
00¨ ­
.
00­ ®

Dependency
00® ¸
.
00¸ ¹
ToName
00¹ ¿
(
00¿ À
)
00À Á
}
00Á Â
$str
00Â Õ
"
00Õ Ö
)
00Ö ×
;
00× Ø
}11 	&
DetectCircularDependencies33 "
(33" #
modules33# *
,33* +
	moduleMap33, 5
)335 6
;336 7
}44 
private66 
void66 &
DetectCircularDependencies66 +
(66+ ,
List66, 0
<660 1
IModule661 8
>668 9
modules66: A
,66A B

Dictionary66C M
<66M N
string66N T
,66T U
IModule66V ]
>66] ^
	moduleMap66_ h
)66h i
{77 
HashSet88 
<88 
string88 
>88 
visited88 
=88  !
[88" #
]88# $
;88$ %
HashSet99 
<99 
string99 
>99 
recursionStack99 &
=99' (
[99) *
]99* +
;99+ ,
IModule;; 
?;; (
moduleWithCircularDependency;; -
=;;. /
modules;;0 7
.<< 
Where<< 
(<< 
m<< 
=><< 
!<< 
visited<<  
.<<  !
Contains<<! )
(<<) *
m<<* +
.<<+ ,
Id<<, .
.<<. /
ToName<</ 5
(<<5 6
)<<6 7
)<<7 8
)<<8 9
.== 
FirstOrDefault== 
(== 
module== "
=>==# %!
HasCircularDependency==& ;
(==; <
module==< B
.==B C
Id==C E
.==E F
ToName==F L
(==L M
)==M N
,==N O
	moduleMap==P Y
,==Y Z
visited==[ b
,==b c
recursionStack==d r
)==r s
)==s t
;==t u
if?? 

(?? (
moduleWithCircularDependency?? (
!=??) +
null??, 0
)??0 1
{@@ 	
throwAA 
newAA %
InvalidOperationExceptionAA /
(AA/ 0
$"BB 
$strBB E
{BBE F(
moduleWithCircularDependencyBBF b
.BBb c
IdBBc e
.BBe f
ToNameBBf l
(BBl m
)BBm n
}BBn o
$strBBo p
"BBp q
)BBq r
;BBr s
}CC 	
}DD 
privateFF 
boolFF !
HasCircularDependencyFF &
(FF& '
stringFF' -

moduleNameFF. 8
,FF8 9

DictionaryFF: D
<FFD E
stringFFE K
,FFK L
IModuleFFM T
>FFT U
	moduleMapFFV _
,FF_ `
HashSetGG 
<GG 
stringGG 
>GG 
visitedGG 
,GG  
HashSetGG! (
<GG( )
stringGG) /
>GG/ 0
recursionStackGG1 ?
)GG? @
{HH 
visitedII 
.II 
AddII 
(II 

moduleNameII 
)II 
;II  
recursionStackJJ 
.JJ 
AddJJ 
(JJ 

moduleNameJJ %
)JJ% &
;JJ& '
ifLL 

(LL 
	moduleMapLL 
.LL 
TryGetValueLL !
(LL! "

moduleNameLL" ,
,LL, -
outLL. 1
IModuleLL2 9
?LL9 :
moduleLL; A
)LLA B
)LLB C
{MM 	
foreachNN 
(NN 
ModuleIdentifierNN %

dependencyNN& 0
inNN1 3
moduleNN4 :
.NN: ;
ManifestNN; C
.NNC D
DependenciesNND P
)NNP Q
{OO 
stringPP 
depNamePP 
=PP  

dependencyPP! +
.PP+ ,
ToNamePP, 2
(PP2 3
)PP3 4
;PP4 5
ifRR 
(RR 
!RR 
visitedRR 
.RR 
ContainsRR %
(RR% &
depNameRR& -
)RR- .
)RR. /
{SS 
ifTT 
(TT !
HasCircularDependencyTT -
(TT- .
depNameTT. 5
,TT5 6
	moduleMapTT7 @
,TT@ A
visitedTTB I
,TTI J
recursionStackTTK Y
)TTY Z
)TTZ [
{UU 
returnVV 
trueVV #
;VV# $
}WW 
}XX 
elseYY 
ifYY 
(YY 
recursionStackYY '
.YY' (
ContainsYY( 0
(YY0 1
depNameYY1 8
)YY8 9
)YY9 :
{ZZ 
return[[ 
true[[ 
;[[  
}\\ 
}]] 
}^^ 	
recursionStack`` 
.`` 
Remove`` 
(`` 

moduleName`` (
)``( )
;``) *
returnaa 
falseaa 
;aa 
}bb 
privatedd 
staticdd 
IEnumerabledd 
<dd 
IModuledd &
>dd& '
TopologicalSortdd( 7
(dd7 8
Listdd8 <
<dd< =
IModuledd= D
>ddD E
modulesddF M
,ddM N

DictionaryddO Y
<ddY Z
stringddZ `
,dd` a
IModuleddb i
>ddi j
	moduleMapddk t
)ddt u
{ee 

Dictionaryff 
<ff 
stringff 
,ff 
intff 
>ff 
inDegreeff  (
=ff) *
modulesff+ 2
.ff2 3
ToDictionaryff3 ?
(ff? @
mff@ A
=>ffB D
mffE F
.ffF G
IdffG I
.ffI J
ToNameffJ P
(ffP Q
)ffQ R
,ffR S
_ffT U
=>ffV X
$numffY Z
)ffZ [
;ff[ \

Dictionarygg 
<gg 
stringgg 
,gg 
HashSetgg "
<gg" #
stringgg# )
>gg) *
>gg* +

dependentsgg, 6
=gg7 8
newgg9 <
(gg< =
)gg= >
;gg> ?
foreachii 
(ii 
stringii 

moduleNameii "
inii# %
modulesii& -
.ii- .
Selectii. 4
(ii4 5
moduleii5 ;
=>ii< >
moduleii? E
.iiE F
IdiiF H
.iiH I
ToNameiiI O
(iiO P
)iiP Q
)iiQ R
)iiR S
{jj 	

dependentskk 
[kk 

moduleNamekk !
]kk! "
=kk# $
[kk% &
]kk& '
;kk' (
}ll 	
foreachnn 
(nn 
IModulenn 
modulenn 
innn  "
modulesnn# *
)nn* +
{oo 	
foreachpp 
(pp 
ModuleIdentifierpp %

dependencypp& 0
inpp1 3
modulepp4 :
.pp: ;
Manifestpp; C
.ppC D
DependenciesppD P
)ppP Q
{qq 
stringrr 
depNamerr 
=rr  

dependencyrr! +
.rr+ ,
ToNamerr, 2
(rr2 3
)rr3 4
;rr4 5
ifss 
(ss 
!ss 

dependentsss 
.ss  
ContainsKeyss  +
(ss+ ,
depNamess, 3
)ss3 4
)ss4 5
{tt 
continueuu 
;uu 
}vv 

dependentsxx 
[xx 
depNamexx "
]xx" #
.xx# $
Addxx$ '
(xx' (
modulexx( .
.xx. /
Idxx/ 1
.xx1 2
ToNamexx2 8
(xx8 9
)xx9 :
)xx: ;
;xx; <
inDegreeyy 
[yy 
moduleyy 
.yy  
Idyy  "
.yy" #
ToNameyy# )
(yy) *
)yy* +
]yy+ ,
++yy, .
;yy. /
}zz 
}{{ 	
Queue}} 
<}} 
string}} 
>}} 
queue}} 
=}} 
new}} !
(}}! "
inDegree}}" *
.}}* +
Where}}+ 0
(}}0 1
kvp}}1 4
=>}}5 7
kvp}}8 ;
.}}; <
Value}}< A
==}}B D
$num}}E F
)}}F G
.}}G H
Select}}H N
(}}N O
kvp}}O R
=>}}S U
kvp}}V Y
.}}Y Z
Key}}Z ]
)}}] ^
)}}^ _
;}}_ `
List~~ 
<~~ 
IModule~~ 
>~~ 
result~~ 
=~~ 
new~~ "
(~~" #
modules~~# *
.~~* +
Count~~+ 0
)~~0 1
;~~1 2
while
€€ 
(
€€ 
queue
€€ 
.
€€ 
Count
€€ 
>
€€ 
$num
€€ 
)
€€ 
{
 	
string
‚‚ 
current
‚‚ 
=
‚‚ 
queue
‚‚ "
.
‚‚" #
Dequeue
‚‚# *
(
‚‚* +
)
‚‚+ ,
;
‚‚, -
result
ƒƒ 
.
ƒƒ 
Add
ƒƒ 
(
ƒƒ 
	moduleMap
ƒƒ  
[
ƒƒ  !
current
ƒƒ! (
]
ƒƒ( )
)
ƒƒ) *
;
ƒƒ* +
foreach
…… 
(
…… 
string
…… 
	dependent
…… %
in
……& (

dependents
……) 3
[
……3 4
current
……4 ;
]
……; <
)
……< =
{
†† 
inDegree
‡‡ 
[
‡‡ 
	dependent
‡‡ "
]
‡‡" #
--
‡‡# %
;
‡‡% &
if
ˆˆ 
(
ˆˆ 
inDegree
ˆˆ 
[
ˆˆ 
	dependent
ˆˆ &
]
ˆˆ& '
==
ˆˆ( *
$num
ˆˆ+ ,
)
ˆˆ, -
{
‰‰ 
queue
ŠŠ 
.
ŠŠ 
Enqueue
ŠŠ !
(
ŠŠ! "
	dependent
ŠŠ" +
)
ŠŠ+ ,
;
ŠŠ, -
}
‹‹ 
}
ŒŒ 
}
 	
return
 
result
 
.
 
Count
 
!=
 
modules
 &
.
& '
Count
' ,
?
 
throw
 
new
 '
InvalidOperationException
 1
(
1 2
$str
‘‘ V
)
‘‘V W
:
’’ 
result
’’ 
.
’’ 
OrderBy
’’ 
(
’’ 
m
’’ 
=>
’’ !
m
’’" #
.
’’# $
Manifest
’’$ ,
.
’’, -
Priority
’’- 5
)
’’5 6
.
’’6 7
ThenBy
’’7 =
(
’’= >
m
’’> ?
=>
’’@ B
m
’’C D
.
’’D E
Id
’’E G
.
’’G H
ToName
’’H N
(
’’N O
)
’’O P
)
’’P Q
;
’’Q R
}
““ 
private
•• 
void
•• &
GetDependenciesRecursive
•• )
(
••) *
IModule
••* 1
module
••2 8
,
••8 9

Dictionary
••: D
<
••D E
string
••E K
,
••K L
IModule
••M T
>
••T U
	moduleMap
••V _
,
••_ `
HashSet
–– 
<
–– 
string
–– 
>
–– 
required
––  
)
––  !
{
—— 
foreach
˜˜ 
(
˜˜ 
ModuleIdentifier
˜˜ !

dependency
˜˜" ,
in
˜˜- /
module
˜˜0 6
.
˜˜6 7
Manifest
˜˜7 ?
.
˜˜? @
Dependencies
˜˜@ L
)
˜˜L M
{
™™ 	
string
šš 
depName
šš 
=
šš 

dependency
šš '
.
šš' (
ToName
šš( .
(
šš. /
)
šš/ 0
;
šš0 1
if
›› 
(
›› 
!
›› 
required
›› 
.
›› 
Contains
›› "
(
››" #
depName
››# *
)
››* +
&&
››, .
	moduleMap
››/ 8
.
››8 9
TryGetValue
››9 D
(
››D E
depName
››E L
,
››L M
out
››N Q
IModule
››R Y
?
››Y Z
	depModule
››[ d
)
››d e
)
››e f
{
œœ 
required
 
.
 
Add
 
(
 
depName
 $
)
$ %
;
% &&
GetDependenciesRecursive
žž (
(
žž( )
	depModule
žž) 2
,
žž2 3
	moduleMap
žž4 =
,
žž= >
required
žž? G
)
žžG H
;
žžH I
}
ŸŸ 
}
   	
}
¡¡ 
}¢¢ ¢#
t/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/ModuleBase.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
public 
abstract 
class 

ModuleBase  
<  !
	TManifest! *
>* +
:, -
ITypedModule. :
<: ;
	TManifest; D
>D E
whereF K
	TManifestL U
:V W
IModuleManifestX g
{		 
public

 

abstract

 
ModuleIdentifier

 $
Id

% '
{

( )
get

* -
;

- .
}

/ 0
public 

abstract 
	TManifest 
Manifest &
{' (
get) ,
;, -
}. /
IModuleManifest 
IModule 
. 
Manifest $
=>% '
Manifest( 0
;0 1
public 

bool 
IsLoaded 
{ 
get 
; 
private  '
set( +
;+ ,
}- .
public 

IModuleScope 
? 
ServiceScope %
{& '
get( +
;+ ,
private- 4
set5 8
;8 9
}: ;
public 

virtual 
Task 
< 
bool 
> 
CanLoadAsync *
(* +
)+ ,
=>- /
Task0 4
.4 5

FromResult5 ?
(? @
true@ D
)D E
;E F
public 

async 
Task 
	LoadAsync 
(  
IServiceProvider  0
serviceProvider1 @
)@ A
{ 
if 

( 
IsLoaded 
) 
{ 	
return 
; 
} 	
try 
{ 	!
ModuleResourceManager !
?! "
resourceManager# 2
=3 4
serviceProvider5 D
.D E

GetServiceE O
<O P!
ModuleResourceManagerP e
>e f
(f g
)g h
;h i
if 
( 
resourceManager 
!=  "
null# '
)' (
{ 
ServiceScope 
= 
resourceManager .
.. /
CreateModuleScope/ @
(@ A
IdA C
.C D
ToNameD J
(J K
)K L
)L M
;M N
} 
await   
OnLoadAsync   
(   
)   
;    
IsLoaded"" 
="" 
true"" 
;"" 
}## 	
catch$$ 
{%% 	
ServiceScope&& 
?&& 
.&& 
Dispose&& !
(&&! "
)&&" #
;&&# $
ServiceScope'' 
='' 
null'' 
;''  
}(( 	
})) 
public++ 

async++ 
Task++ 
UnloadAsync++ !
(++! "
)++" #
{,, 
if-- 

(-- 
!-- 
IsLoaded-- 
)-- 
{.. 	
return// 
;// 
}00 	
await22 
OnUnloadAsync22 
(22 
)22 
;22 
ServiceScope44 
?44 
.44 
Dispose44 
(44 
)44 
;44  
ServiceScope55 
=55 
null55 
;55 
IsLoaded77 
=77 
false77 
;77 
}88 
public:: 

virtual:: 
Task:: %
SetupMessageHandlersAsync:: 1
(::1 2
IModuleMessageBus::2 C

messageBus::D N
)::N O
=>::P R
Task::S W
.::W X
CompletedTask::X e
;::e f
	protected<< 
virtual<< 
Task<< 
OnLoadAsync<< &
(<<& '
)<<' (
=><<) +
Task<<, 0
.<<0 1
CompletedTask<<1 >
;<<> ?
	protected>> 
virtual>> 
Task>> 
OnUnloadAsync>> (
(>>( )
)>>) *
=>>>+ -
Task>>. 2
.>>2 3
CompletedTask>>3 @
;>>@ A
}?? Æ
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Modularity/CompositeServiceScope.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 

Modularity '
;' (
internal 
class	 !
CompositeServiceScope $
:% &
IServiceScope' 4
{ 
private 
readonly 
ServiceProvider $"
_moduleServiceProvider% ;
;; <
private		 
readonly		 
IServiceScope		 "
_parentScope		# /
;		/ 0
private

 
readonly

 $
CompositeServiceProvider

 -
_serviceProvider

. >
;

> ?
private 
bool 
	_disposed 
; 
public 
!
CompositeServiceScope  
(  !
ServiceProvider! 0!
moduleServiceProvider1 F
,F G
IServiceScopeH U
parentScopeV a
)a b
{ "
_moduleServiceProvider 
=  !
moduleServiceProvider! 6
;6 7
_parentScope 
= 
parentScope "
;" #
_serviceProvider 
= 
new $
CompositeServiceProvider 7
(7 8"
_moduleServiceProvider8 N
,N O
_parentScopeP \
.\ ]
ServiceProvider] l
)l m
;m n
} 
public 

IServiceProvider 
ServiceProvider +
=>, .
_serviceProvider/ ?
;? @
public 

void 
Dispose 
( 
) 
{ 
if 

( 
	_disposed 
) 
{ 	
return 
; 
} 	
	_disposed 
= 
true 
; "
_moduleServiceProvider 
. 
Dispose &
(& '
)' (
;( )
_parentScope 
. 
Dispose 
( 
) 
; 
}   
}!! 
internal## 
class##	 $
CompositeServiceProvider## '
(##' (
IServiceProvider##( 8
moduleProvider##9 G
,##G H
IServiceProvider##I Y
mainProvider##Z f
)##f g
:$$ 
IServiceProvider$$ 
{%% 
public&& 

object&& 
?&& 

GetService&& 
(&& 
Type&& "
serviceType&&# .
)&&. /
{'' 
object(( 
?(( 
service(( 
=(( 
moduleProvider(( (
.((( )

GetService(() 3
(((3 4
serviceType((4 ?
)((? @
;((@ A
return)) 
service)) 
??)) 
mainProvider)) &
.))& '

GetService))' 1
())1 2
serviceType))2 =
)))= >
;))> ?
}** 
}++ ÷4
ˆ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Subscriptions/SubscriptionTypes.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Subscriptions' 4
;4 5
internal 
	interface	 
ISubscription  
{ 
int 
Priority 
{ 
get 
; 
} 
bool		 
IsAlive			 
{		 
get		 
;		 
}		 
bool

 
IsWeak

	 
{

 
get

 
;

 
}

 
Task 
? 	
HandleAsync
 
( 
object 
message $
)$ %
;% &
} 
internal 
sealed	 
class 
StrongSubscription (
<( )
T) *
>* +
(+ ,
Func, 0
<0 1
T1 2
,2 3
bool4 8
>8 9
filter: @
,@ A
FuncB F
<F G
TG H
,H I
TaskJ N
>N O
handlerP W
,W X
intY \
priority] e
)e f
:g h
ISubscriptioni v
where 	
T
 
: 
class 
{ 
public 

int 
Priority 
{ 
get 
; 
}  
=! "
priority# +
;+ ,
public 

bool 
IsAlive 
=> 
true 
;  
public 

bool 
IsWeak 
=> 
false 
;  
public 

Task 
HandleAsync 
( 
object "
message# *
)* +
{ 
if 

( 
message 
is 
T 
typedMessage %
&&& (
filter) /
(/ 0
typedMessage0 <
)< =
)= >
{ 	
return 
handler 
( 
typedMessage '
)' (
;( )
} 	
return 
Task 
. 
CompletedTask !
;! "
} 
} 
internal   
sealed  	 
class   
WeakSubscription   &
<  & '
T  ' (
>  ( )
(  ) *
Func  * .
<  . /
T  / 0
,  0 1
bool  2 6
>  6 7
filter  8 >
,  > ?
Func  @ D
<  D E
T  E F
,  F G
Task  H L
>  L M
handler  N U
,  U V
int  W Z
priority  [ c
)  c d
:  e f
ISubscription  g t
where!! 	
T!!
 
:!! 
class!! 
{"" 
private## 
readonly## 
WeakReference## "
<##" #
Func### '
<##' (
T##( )
,##) *
Task##+ /
>##/ 0
>##0 1
_handlerRef##2 =
=##> ?
new##@ C
(##C D
handler##D K
)##K L
;##L M
public%% 

int%% 
Priority%% 
{%% 
get%% 
;%% 
}%%  
=%%! "
priority%%# +
;%%+ ,
public&& 

bool&& 
IsWeak&& 
=>&& 
true&& 
;&& 
public'' 

bool'' 
IsAlive'' 
=>'' 
_handlerRef'' &
.''& '
TryGetTarget''' 3
(''3 4
out''4 7
_''8 9
)''9 :
;'': ;
public)) 

Task)) 
HandleAsync)) 
()) 
object)) "
message))# *
)))* +
{** 
if++ 

(++ 
message++ 
is++ 
T++ 
typedMessage++ %
&&++& (
filter,, 
(,, 
typedMessage,, 
),,  
&&,,! #
_handlerRef-- 
.-- 
TryGetTarget-- $
(--$ %
out--% (
Func--) -
<--- .
T--. /
,--/ 0
Task--1 5
>--5 6
?--6 7

handlerRef--8 B
)--B C
)--C D
{.. 	
return// 

handlerRef// 
(// 
typedMessage// *
)//* +
;//+ ,
}00 	
return11 
Task11 
.11 
CompletedTask11 !
;11! "
}22 
}33 
internal55 
sealed55	 
class55 
ScopedSubscription55 (
<55( )
T55) *
>55* +
(55+ ,
Func55, 0
<550 1
T551 2
,552 3
bool554 8
>558 9
filter55: @
,55@ A
Func55B F
<55F G
T55G H
,55H I
Task55J N
>55N O
handler55P W
,55W X
int55Y \
priority55] e
)55e f
:66 
ISubscription66 
,66 
IDisposable66  
where77 	
T77
 
:77 
class77 
{88 
private99 
bool99 
	_disposed99 
;99 
public;; 

int;; 
Priority;; 
{;; 
get;; 
;;; 
};;  
=;;! "
priority;;# +
;;;+ ,
public<< 

bool<< 
IsAlive<< 
=><< 
!<< 
	_disposed<< %
;<<% &
public== 

bool== 
IsWeak== 
=>== 
false== 
;==  
public?? 

Task?? 
HandleAsync?? 
(?? 
object?? "
message??# *
)??* +
{@@ 
ifAA 

(AA 
!AA 
	_disposedAA 
&&AA 
messageAA !
isAA" $
TAA% &
typedMessageAA' 3
&&AA4 6
filterAA7 =
(AA= >
typedMessageAA> J
)AAJ K
)AAK L
{BB 	
returnCC 
handlerCC 
(CC 
typedMessageCC '
)CC' (
;CC( )
}DD 	
returnEE 
TaskEE 
.EE 
CompletedTaskEE !
;EE! "
}FF 
publicHH 

voidHH 
DisposeHH 
(HH 
)HH 
=>HH 
	_disposedHH &
=HH' (
trueHH) -
;HH- .
}II  £
Š/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Subscriptions/SubscriptionManager.cs
	namespace		 	
Ecliptix		
 
.		 
Core		 
.		 
Core		 
.		 
	Messaging		 &
.		& '
Subscriptions		' 4
;		4 5
internal 
sealed	 
class 
SubscriptionManager )
:* +
IDisposable, 7
{ 
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
SubscriptionList2 B
>B C
_subscriptionsD R
=S T
newU X
(X Y
)Y Z
;Z [
private 
readonly 
Timer 
_cleanupTimer (
;( )
private 
readonly 
Lock 
_cleanupLock &
=' (
new) ,
(, -
)- .
;. /
private 
long 
_totalSubscriptions $
;$ %
private 
long $
_deadReferencesCleanedUp )
;) *
private 
volatile 
bool 
	_disposed #
;# $
public 

SubscriptionManager 
( 
)  
{ 
_cleanupTimer 
= 
new 
Timer !
(! "!
CleanupDeadReferences" 7
,7 8
null9 =
,= >
TimeSpan? G
.G H
FromSecondsH S
(S T
$numT V
)V W
,W X
TimeSpanY a
.a b
FromSecondsb m
(m n
$numn p
)p q
)q r
;r s
} 
public 

IDisposable 
	Subscribe  
<  !
T! "
>" #
(# $
Func 
< 
T 
, 
bool 
> 
filter 
, 
Func 
< 
T 
, 
Task 
> 
handler 
,  
SubscriptionLifetime 
lifetime %
,% &
int 
priority 
) 
where 
T 
: 
class  %
{ 
if 

( 
	_disposed 
) 
{   	
throw!! 
new!! #
ObjectDisposedException!! -
(!!- .
nameof!!. 4
(!!4 5
SubscriptionManager!!5 H
)!!H I
)!!I J
;!!J K
}"" 	
string$$ 
messageTypeKey$$ 
=$$ 
GetMessageTypeKey$$  1
<$$1 2
T$$2 3
>$$3 4
($$4 5
)$$5 6
;$$6 7
SubscriptionList%% 
list%% 
=%% 
_subscriptions%%  .
.%%. /
GetOrAdd%%/ 7
(%%7 8
messageTypeKey%%8 F
,%%F G
_%%H I
=>%%J L
new%%M P
SubscriptionList%%Q a
(%%a b
)%%b c
)%%c d
;%%d e
ISubscription'' 
subscription'' "
=''# $
lifetime''% -
switch''. 4
{(( 	 
SubscriptionLifetime))  
.))  !
Weak))! %
=>))& (
new))) ,
WeakSubscription))- =
<))= >
T))> ?
>))? @
())@ A
filter))A G
,))G H
handler))I P
,))P Q
priority))R Z
)))Z [
,))[ \ 
SubscriptionLifetime**  
.**  !
Strong**! '
=>**( *
new**+ .
StrongSubscription**/ A
<**A B
T**B C
>**C D
(**D E
filter**E K
,**K L
handler**M T
,**T U
priority**V ^
)**^ _
,**_ ` 
SubscriptionLifetime++  
.++  !
Scoped++! '
=>++( *
new+++ .
ScopedSubscription++/ A
<++A B
T++B C
>++C D
(++D E
filter++E K
,++K L
handler++M T
,++T U
priority++V ^
)++^ _
,++_ `
_,, 
=>,, 
throw,, 
new,, '
ArgumentOutOfRangeException,, 6
(,,6 7
nameof,,7 =
(,,= >
lifetime,,> F
),,F G
),,G H
}-- 	
;--	 

list// 
.// 
Add// 
(// 
subscription// 
)// 
;// 
Interlocked00 
.00 
	Increment00 
(00 
ref00 !
_totalSubscriptions00" 5
)005 6
;006 7
return22 
new22 
SubscriptionToken22 $
(22$ %
(22% &
)22& '
=>22( *
{33 	
list44 
.44 
Remove44 
(44 
subscription44 $
)44$ %
;44% &
Interlocked55 
.55 
	Decrement55 !
(55! "
ref55" %
_totalSubscriptions55& 9
)559 :
;55: ;
if77 
(77 
list77 
.77 
IsEmpty77 
)77 
{88 
_subscriptions99 
.99 
	TryRemove99 (
(99( )
messageTypeKey99) 7
,997 8
out999 <
_99= >
)99> ?
;99? @
}:: 
};; 	
);;	 

;;;
 
}<< 
public>> 

async>> 
Task>> 
PublishAsync>> "
<>>" #
T>># $
>>>$ %
(>>% &
T>>& '
message>>( /
,>>/ 0
CancellationToken>>1 B
_>>C D
)>>D E
where>>F K
T>>L M
:>>N O
class>>P U
{?? 
if@@ 

(@@ 
	_disposed@@ 
||@@ 
message@@  
==@@! #
null@@$ (
)@@( )
{AA 	
returnBB 
;BB 
}CC 	
stringEE 
messageTypeKeyEE 
=EE 
GetMessageTypeKeyEE  1
<EE1 2
TEE2 3
>EE3 4
(EE4 5
)EE5 6
;EE6 7
ifGG 

(GG 
!GG 
_subscriptionsGG 
.GG 
TryGetValueGG '
(GG' (
messageTypeKeyGG( 6
,GG6 7
outGG8 ;
SubscriptionListGG< L
?GGL M
listGGN R
)GGR S
)GGS T
{HH 	
returnII 
;II 
}JJ 	
ISubscriptionLL 
[LL 
]LL 
activeSubscriptionsLL +
=LL, -
listLL. 2
.LL2 3"
GetActiveSubscriptionsLL3 I
(LLI J
)LLJ K
;LLK L
ifMM 

(MM 
activeSubscriptionsMM 
.MM  
LengthMM  &
==MM' )
$numMM* +
)MM+ ,
{NN 	
returnOO 
;OO 
}PP 	
ifRR 

(RR 
activeSubscriptionsRR 
.RR  
LengthRR  &
>RR' (
$numRR) *
)RR* +
{SS 	
ArrayTT 
.TT 
SortTT 
(TT 
activeSubscriptionsTT *
,TT* +
(TT, -
xTT- .
,TT. /
yTT0 1
)TT1 2
=>TT3 5
yTT6 7
.TT7 8
PriorityTT8 @
.TT@ A
	CompareToTTA J
(TTJ K
xTTK L
.TTL M
PriorityTTM U
)TTU V
)TTV W
;TTW X
}UU 	
ListWW 
<WW 
TaskWW 
>WW 
handlerTasksWW 
=WW  !
newWW" %
(WW% &
activeSubscriptionsWW& 9
.WW9 :
LengthWW: @
)WW@ A
;WWA B
foreachYY 
(YY 
ISubscriptionYY 
subscriptionYY +
inYY, .
activeSubscriptionsYY/ B
)YYB C
{ZZ 	
try[[ 
{\\ 
Task]] 
?]] 
handlerTask]] !
=]]" #
subscription]]$ 0
.]]0 1
HandleAsync]]1 <
(]]< =
message]]= D
)]]D E
;]]E F
if^^ 
(^^ 
handlerTask^^ 
!=^^  "
null^^# '
)^^' (
{__ 
handlerTasks``  
.``  !
Add``! $
(``$ %
handlerTask``% 0
)``0 1
;``1 2
}aa 
}bb 
catchcc 
(cc 
	Exceptioncc 
)cc 
{dd 
}ff 
}gg 	
ifii 

(ii 
handlerTasksii 
.ii 
Countii 
>ii  
$numii! "
)ii" #
{jj 	
trykk 
{ll 
awaitmm 
Taskmm 
.mm 
WhenAllmm "
(mm" #
handlerTasksmm# /
)mm/ 0
;mm0 1
}nn 
catchoo 
(oo 
	Exceptionoo 
)oo 
{pp 
}rr 
}ss 	
}tt 
privatevv 
voidvv !
CleanupDeadReferencesvv &
(vv& '
objectvv' -
?vv- .
statevv/ 4
)vv4 5
{ww 
ifxx 

(xx 
	_disposedxx 
)xx 
{yy 	
returnzz 
;zz 
}{{ 	
lock}} 
(}} 
_cleanupLock}} 
)}} 
{~~ 	
if 
( 
	_disposed 
) 
{
€€ 
return
 
;
 
}
‚‚ 
int
„„ 
	cleanedUp
„„ 
=
„„ 
$num
„„ 
;
„„ 
List
…… 
<
…… 
string
…… 
>
…… 

emptyLists
…… #
=
……$ %
[
……& '
]
……' (
;
……( )
foreach
‡‡ 
(
‡‡ 
KeyValuePair
‡‡ !
<
‡‡! "
string
‡‡" (
,
‡‡( )
SubscriptionList
‡‡* :
>
‡‡: ;
kvp
‡‡< ?
in
‡‡@ B
_subscriptions
‡‡C Q
)
‡‡Q R
{
ˆˆ 
	cleanedUp
‰‰ 
+=
‰‰ 
kvp
‰‰  
.
‰‰  !
Value
‰‰! &
.
‰‰& '#
CleanupDeadReferences
‰‰' <
(
‰‰< =
)
‰‰= >
;
‰‰> ?
if
ŠŠ 
(
ŠŠ 
kvp
ŠŠ 
.
ŠŠ 
Value
ŠŠ 
.
ŠŠ 
IsEmpty
ŠŠ %
)
ŠŠ% &
{
‹‹ 

emptyLists
ŒŒ 
.
ŒŒ 
Add
ŒŒ "
(
ŒŒ" #
kvp
ŒŒ# &
.
ŒŒ& '
Key
ŒŒ' *
)
ŒŒ* +
;
ŒŒ+ ,
}
 
}
ŽŽ 
foreach
 
(
 
string
 
key
 
in
  "

emptyLists
# -
)
- .
{
‘‘ 
_subscriptions
’’ 
.
’’ 
	TryRemove
’’ (
(
’’( )
key
’’) ,
,
’’, -
out
’’. 1
_
’’2 3
)
’’3 4
;
’’4 5
}
““ 
Interlocked
•• 
.
•• 
Add
•• 
(
•• 
ref
•• &
_deadReferencesCleanedUp
••  8
,
••8 9
	cleanedUp
••: C
)
••C D
;
••D E
}
–– 	
}
—— 
[
™™ 

MethodImpl
™™ 
(
™™ 
MethodImplOptions
™™ !
.
™™! " 
AggressiveInlining
™™" 4
)
™™4 5
]
™™5 6
private
šš 
static
šš 
string
šš 
GetMessageTypeKey
šš +
<
šš+ ,
T
šš, -
>
šš- .
(
šš. /
)
šš/ 0
where
šš1 6
T
šš7 8
:
šš9 :
class
šš; @
{
›› 
return
œœ 
typeof
œœ 
(
œœ 
T
œœ 
)
œœ 
.
œœ 
Name
œœ 
;
œœ 
}
 
public
ŸŸ 

void
ŸŸ 
Dispose
ŸŸ 
(
ŸŸ 
)
ŸŸ 
{
   
if
¡¡ 

(
¡¡ 
!
¡¡ 
	_disposed
¡¡ 
)
¡¡ 
{
¢¢ 	
	_disposed
££ 
=
££ 
true
££ 
;
££ 
_cleanupTimer
¤¤ 
.
¤¤ 
Dispose
¤¤ !
(
¤¤! "
)
¤¤" #
;
¤¤# $
foreach
¦¦ 
(
¦¦ 
SubscriptionList
¦¦ %
list
¦¦& *
in
¦¦+ -
_subscriptions
¦¦. <
.
¦¦< =
Values
¦¦= C
)
¦¦C D
{
§§ 
list
¨¨ 
.
¨¨ 
Dispose
¨¨ 
(
¨¨ 
)
¨¨ 
;
¨¨ 
}
©© 
_subscriptions
«« 
.
«« 
Clear
««  
(
««  !
)
««! "
;
««" #
}
¬¬ 	
}
­­ 
}®® 
internal°° 
sealed
°°	 
class
°° 
SubscriptionToken
°° '
(
°°' (
Action
°°( .
disposeAction
°°/ <
)
°°< =
:
°°> ?
IDisposable
°°@ K
{±± 
private
²² 
bool
²² 
	_disposed
²² 
;
²² 
public
´´ 

void
´´ 
Dispose
´´ 
(
´´ 
)
´´ 
{
µµ 
if
¶¶ 

(
¶¶ 
!
¶¶ 
	_disposed
¶¶ 
)
¶¶ 
{
·· 	
disposeAction
¸¸ 
(
¸¸ 
)
¸¸ 
;
¸¸ 
	_disposed
¹¹ 
=
¹¹ 
true
¹¹ 
;
¹¹ 
}
ºº 	
}
»» 
}¼¼ 
internal¾¾ 
sealed
¾¾	 
class
¾¾ 
SubscriptionList
¾¾ &
:
¾¾' (
IDisposable
¾¾) 4
{¿¿ 
private
ÀÀ 
readonly
ÀÀ 
List
ÀÀ 
<
ÀÀ 
ISubscription
ÀÀ '
>
ÀÀ' (
_subscriptions
ÀÀ) 7
=
ÀÀ8 9
new
ÀÀ: =
(
ÀÀ= >
)
ÀÀ> ?
;
ÀÀ? @
private
ÁÁ 
readonly
ÁÁ "
ReaderWriterLockSlim
ÁÁ )
_lock
ÁÁ* /
=
ÁÁ0 1
new
ÁÁ2 5
(
ÁÁ5 6
)
ÁÁ6 7
;
ÁÁ7 8
private
ÂÂ 
bool
ÂÂ 
	_disposed
ÂÂ 
;
ÂÂ 
public
ÄÄ 

void
ÄÄ 
Add
ÄÄ 
(
ÄÄ 
ISubscription
ÄÄ !
subscription
ÄÄ" .
)
ÄÄ. /
{
ÅÅ 
_lock
ÆÆ 
.
ÆÆ 
EnterWriteLock
ÆÆ 
(
ÆÆ 
)
ÆÆ 
;
ÆÆ 
try
ÇÇ 
{
ÈÈ 	
if
ÉÉ 
(
ÉÉ 
!
ÉÉ 
	_disposed
ÉÉ 
)
ÉÉ 
{
ÊÊ 
_subscriptions
ËË 
.
ËË 
Add
ËË "
(
ËË" #
subscription
ËË# /
)
ËË/ 0
;
ËË0 1
}
ÌÌ 
}
ÍÍ 	
finally
ÎÎ 
{
ÏÏ 	
_lock
ÐÐ 
.
ÐÐ 
ExitWriteLock
ÐÐ 
(
ÐÐ  
)
ÐÐ  !
;
ÐÐ! "
}
ÑÑ 	
}
ÒÒ 
public
ÔÔ 

void
ÔÔ 
Remove
ÔÔ 
(
ÔÔ 
ISubscription
ÔÔ $
subscription
ÔÔ% 1
)
ÔÔ1 2
{
ÕÕ 
_lock
ÖÖ 
.
ÖÖ 
EnterWriteLock
ÖÖ 
(
ÖÖ 
)
ÖÖ 
;
ÖÖ 
try
×× 
{
ØØ 	
_subscriptions
ÙÙ 
.
ÙÙ 
Remove
ÙÙ !
(
ÙÙ! "
subscription
ÙÙ" .
)
ÙÙ. /
;
ÙÙ/ 0
}
ÚÚ 	
finally
ÛÛ 
{
ÜÜ 	
_lock
ÝÝ 
.
ÝÝ 
ExitWriteLock
ÝÝ 
(
ÝÝ  
)
ÝÝ  !
;
ÝÝ! "
}
ÞÞ 	
}
ßß 
public
áá 

ISubscription
áá 
[
áá 
]
áá $
GetActiveSubscriptions
áá 1
(
áá1 2
)
áá2 3
{
ââ 
_lock
ãã 
.
ãã 
EnterReadLock
ãã 
(
ãã 
)
ãã 
;
ãã 
try
ää 
{
åå 	
return
ææ 
_subscriptions
ææ !
.
ææ! "
Where
ææ" '
(
ææ' (
s
ææ( )
=>
ææ* ,
s
ææ- .
.
ææ. /
IsAlive
ææ/ 6
)
ææ6 7
.
ææ7 8
ToArray
ææ8 ?
(
ææ? @
)
ææ@ A
;
ææA B
}
çç 	
finally
èè 
{
éé 	
_lock
êê 
.
êê 
ExitReadLock
êê 
(
êê 
)
êê  
;
êê  !
}
ëë 	
}
ìì 
public
îî 

int
îî #
CleanupDeadReferences
îî $
(
îî$ %
)
îî% &
{
ïï 
_lock
ðð 
.
ðð 
EnterWriteLock
ðð 
(
ðð 
)
ðð 
;
ðð 
try
ññ 
{
òò 	
int
óó 
initialCount
óó 
=
óó 
_subscriptions
óó -
.
óó- .
Count
óó. 3
;
óó3 4
_subscriptions
ôô 
.
ôô 
	RemoveAll
ôô $
(
ôô$ %
s
ôô% &
=>
ôô' )
!
ôô* +
s
ôô+ ,
.
ôô, -
IsAlive
ôô- 4
)
ôô4 5
;
ôô5 6
return
õõ 
initialCount
õõ 
-
õõ  !
_subscriptions
õõ" 0
.
õõ0 1
Count
õõ1 6
;
õõ6 7
}
öö 	
finally
÷÷ 
{
øø 	
_lock
ùù 
.
ùù 
ExitWriteLock
ùù 
(
ùù  
)
ùù  !
;
ùù! "
}
úú 	
}
ûû 
public
ýý 

(
ýý 
int
ýý 
weak
ýý 
,
ýý 
int
ýý 
strong
ýý  
)
ýý  !#
GetSubscriptionCounts
ýý" 7
(
ýý7 8
)
ýý8 9
{
þþ 
_lock
ÿÿ 
.
ÿÿ 
EnterReadLock
ÿÿ 
(
ÿÿ 
)
ÿÿ 
;
ÿÿ 
try
€€ 
{
 	
int
‚‚ 
weak
‚‚ 
=
‚‚ 
$num
‚‚ 
,
‚‚ 
strong
‚‚  
=
‚‚! "
$num
‚‚# $
;
‚‚$ %
foreach
ƒƒ 
(
ƒƒ 
ISubscription
ƒƒ "
subscription
ƒƒ# /
in
ƒƒ0 2
_subscriptions
ƒƒ3 A
)
ƒƒA B
{
„„ 
if
…… 
(
…… 
subscription
……  
.
……  !
IsWeak
……! '
)
……' (
{
†† 
weak
‡‡ 
++
‡‡ 
;
‡‡ 
}
ˆˆ 
else
‰‰ 
{
ŠŠ 
strong
‹‹ 
++
‹‹ 
;
‹‹ 
}
ŒŒ 
}
 
return
ŽŽ 
(
ŽŽ 
weak
ŽŽ 
,
ŽŽ 
strong
ŽŽ  
)
ŽŽ  !
;
ŽŽ! "
}
 	
finally
 
{
‘‘ 	
_lock
’’ 
.
’’ 
ExitReadLock
’’ 
(
’’ 
)
’’  
;
’’  !
}
““ 	
}
”” 
public
–– 

bool
–– 
IsEmpty
–– 
{
—— 
get
˜˜ 
{
™™ 	
_lock
šš 
.
šš 
EnterReadLock
šš 
(
šš  
)
šš  !
;
šš! "
try
›› 
{
œœ 
return
 
_subscriptions
 %
.
% &
Count
& +
==
, .
$num
/ 0
;
0 1
}
žž 
finally
ŸŸ 
{
   
_lock
¡¡ 
.
¡¡ 
ExitReadLock
¡¡ "
(
¡¡" #
)
¡¡# $
;
¡¡$ %
}
¢¢ 
}
££ 	
}
¤¤ 
public
¦¦ 

void
¦¦ 
Dispose
¦¦ 
(
¦¦ 
)
¦¦ 
{
§§ 
if
¨¨ 

(
¨¨ 
!
¨¨ 
	_disposed
¨¨ 
)
¨¨ 
{
©© 	
_lock
ªª 
.
ªª 
EnterWriteLock
ªª  
(
ªª  !
)
ªª! "
;
ªª" #
try
«« 
{
¬¬ 
_subscriptions
­­ 
.
­­ 
Clear
­­ $
(
­­$ %
)
­­% &
;
­­& '
	_disposed
®® 
=
®® 
true
®®  
;
®®  !
}
¯¯ 
finally
°° 
{
±± 
_lock
²² 
.
²² 
ExitWriteLock
²² #
(
²²# $
)
²²$ %
;
²²% &
_lock
³³ 
.
³³ 
Dispose
³³ 
(
³³ 
)
³³ 
;
³³  
}
´´ 
}
µµ 	
}
¶¶ 
}·· þ
Š/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Services/LanguageDetectionService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Services' /
;/ 0
internal 
sealed	 
class $
LanguageDetectionService .
(. /
IMessageBus/ :

messageBus; E
)E F
:G H%
ILanguageDetectionServiceI b
,b c
IDisposabled o
{ 
private		 
bool		 
	_disposed		 
;		 
public 

async 
Task &
RequestLanguageChangeAsync 0
(0 1
string1 7
targetCulture8 E
)E F
{ 
if 

( 
	_disposed 
) 
{ 	
return 
; 
} 	(
LanguageDetectionDialogEvent $
evt% (
=) *(
LanguageDetectionDialogEvent+ G
.G H
RequestH O
(O P
targetCultureP ]
)] ^
;^ _
await 

messageBus 
. 
PublishAsync %
(% &
evt& )
)) *
;* +
} 
public 

async 
Task &
ConfirmLanguageChangeAsync 0
(0 1
string1 7
targetCulture8 E
)E F
{ 
if 

( 
	_disposed 
) 
{ 	
return 
; 
} 	(
LanguageDetectionDialogEvent $
evt% (
=) *(
LanguageDetectionDialogEvent+ G
.G H
ConfirmH O
(O P
targetCultureP ]
)] ^
;^ _
await 

messageBus 
. 
PublishAsync %
(% &
evt& )
)) *
;* +
} 
public!! 

async!! 
Task!! &
DeclineLanguageChangeAsync!! 0
(!!0 1
)!!1 2
{"" 
if## 

(## 
	_disposed## 
)## 
{$$ 	
return%% 
;%% 
}&& 	(
LanguageDetectionDialogEvent(( $
evt((% (
=(() *(
LanguageDetectionDialogEvent((+ G
.((G H
Decline((H O
(((O P
)((P Q
;((Q R
await)) 

messageBus)) 
.)) 
PublishAsync)) %
())% &
evt))& )
)))) *
;))* +
}** 
public,, 

IDisposable,, (
OnLanguageDetectionRequested,, 3
(,,3 4
Func-- 
<-- (
LanguageDetectionDialogEvent-- )
,--) *
Task--+ /
>--/ 0
handler--1 8
,--8 9 
SubscriptionLifetime.. 
lifetime.. %
=..& ' 
SubscriptionLifetime..( <
...< =
Weak..= A
)..A B
{// 
return00 

messageBus00 
.00 
	Subscribe00 #
(00# $
handler00$ +
,00+ ,
lifetime00- 5
)005 6
;006 7
}11 
public33 

void33 
Dispose33 
(33 
)33 
{44 
	_disposed55 
=55 
true55 
;55 
}66 
}77 ë	
‹/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Services/ILanguageDetectionService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Services' /
;/ 0
public 
	interface %
ILanguageDetectionService *
{ 
Task		 &
RequestLanguageChangeAsync			 #
(		# $
string		$ *
targetCulture		+ 8
)		8 9
;		9 :
Task &
ConfirmLanguageChangeAsync	 #
(# $
string$ *
targetCulture+ 8
)8 9
;9 :
Task &
DeclineLanguageChangeAsync	 #
(# $
)$ %
;% &
IDisposable (
OnLanguageDetectionRequested ,
(, -
Func 
< (
LanguageDetectionDialogEvent )
,) *
Task+ /
>/ 0
handler1 8
,8 9 
SubscriptionLifetime 
lifetime %
=& ' 
SubscriptionLifetime( <
.< =
Weak= A
)A B
;B C
} Ü
†/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Services/IConnectivityService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Services' /
;/ 0
public		 
	interface		  
IConnectivityService		 %
:		& '
IDisposable		( 3
{

  
ConnectivitySnapshot 
CurrentSnapshot (
{) *
get+ .
;. /
}0 1
IObservable 
<  
ConnectivitySnapshot $
>$ %
ConnectivityStream& 8
{9 :
get; >
;> ?
}@ A
Task 
PublishAsync	 
( 
ConnectivityIntent (
intent) /
,/ 0
CancellationToken1 B
cancellationTokenC T
=U V
defaultW ^
)^ _
;_ `
Task #
RequestManualRetryAsync	  
(  !
uint! %
?% &
	connectId' 0
=1 2
null3 7
)7 8
;8 9
IDisposable "
OnManualRetryRequested &
(& '
Func 
< %
ManualRetryRequestedEvent &
,& '
Task( ,
>, -
handler. 5
,5 6 
SubscriptionLifetime 
lifetime %
=& ' 
SubscriptionLifetime( <
.< =
Weak= A
)A B
;B C
} Ã
…/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Services/IBottomSheetService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Services' /
;/ 0
public 
	interface 
IBottomSheetService $
{		 
Task

 
	ShowAsync

	 
(

 $
BottomSheetComponentType

 +
componentType

, 9
,

9 :
UserControl

; F
?

F G
control

H O
=

P Q
null

R V
,

V W
bool

X \
	showScrim

] f
=

g h
true

i m
,

m n
bool

o s
isDismissable	

t 
=


‚ ƒ
true


„ ˆ
)


ˆ ‰
;


‰ Š
Task 
	HideAsync	 
( 
) 
; 
Task  
BottomSheetDismissed	 
( 
) 
;  
IDisposable  
OnBottomSheetChanged $
($ %
Func 
< #
BottomSheetCommandEvent $
,$ %
Task& *
>* +
handler, 3
,3 4 
SubscriptionLifetime 
lifetime %
=& ' 
SubscriptionLifetime( <
.< =
Weak= A
)A B
;B C
IDisposable 
OnBottomSheetHidden #
(# $
Func 
< "
BottomSheetHiddenEvent #
,# $
Task% )
>) *
handler+ 2
,2 3 
SubscriptionLifetime 
lifetime %
=& ' 
SubscriptionLifetime( <
.< =
Weak= A
)A B
;B C
} í$
…/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Services/ConnectivityService.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Services' /
;/ 0
internal		 
sealed			 
class		 
ConnectivityService		 )
(		) *
IMessageBus		* 5

messageBus		6 @
)		@ A
:		B C 
IConnectivityService		D X
{

 
private 
readonly !
ConnectivityPublisher *"
_connectivityPublisher+ A
=B C
newD G
(G H
)H I
;I J
private 
bool 
	_disposed 
; 
public 
 
ConnectivitySnapshot 
CurrentSnapshot  /
=>0 2"
_connectivityPublisher3 I
.I J
CurrentSnapshotJ Y
;Y Z
public 

IObservable 
<  
ConnectivitySnapshot +
>+ ,
ConnectivityStream- ?
=>@ B"
_connectivityPublisherC Y
.Y Z
ConnectivityStreamZ l
;l m
public 

Task 
PublishAsync 
( 
ConnectivityIntent /
intent0 6
,6 7
CancellationToken8 I
cancellationTokenJ [
=\ ]
default^ e
)e f
{ 
return 
	_disposed 
? 
throw 
new #
ObjectDisposedException /
(/ 0
nameof0 6
(6 7
ConnectivityService7 J
)J K
)K L
: "
_connectivityPublisher $
.$ %
PublishAsync% 1
(1 2
intent2 8
,8 9
cancellationToken: K
)K L
;L M
} 
public 

Task #
RequestManualRetryAsync '
(' (
uint( ,
?, -
	connectId. 7
=8 9
null: >
)> ?
{ 
if 

( 
! 
	_disposed 
) 
{ 	%
ManualRetryRequestedEvent %
evt& )
=* +%
ManualRetryRequestedEvent, E
.E F
NewF I
(I J
	connectIdJ S
)S T
;T U
return #
PublishManualRetryAsync *
(* +
evt+ .
). /
;/ 0
} 	
throw!! 
new!! #
ObjectDisposedException!! )
(!!) *
nameof!!* 0
(!!0 1
ConnectivityService!!1 D
)!!D E
)!!E F
;!!F G
}"" 
private$$ 
async$$ 
Task$$ #
PublishManualRetryAsync$$ .
($$. /%
ManualRetryRequestedEvent$$/ H
evt$$I L
)$$L M
{%% 
await&& 

messageBus&& 
.&& 
PublishAsync&& %
(&&% &
evt&&& )
)&&) *
.&&* +
ConfigureAwait&&+ 9
(&&9 :
false&&: ?
)&&? @
;&&@ A
await'' 
PublishAsync'' 
('' 
ConnectivityIntent'' -
.''- .
ManualRetry''. 9
(''9 :
evt'': =
.''= >
	ConnectId''> G
)''G H
)''H I
.''I J
ConfigureAwait''J X
(''X Y
false''Y ^
)''^ _
;''_ `
}(( 
public** 

IDisposable** "
OnManualRetryRequested** -
(**- .
Func++ 
<++ %
ManualRetryRequestedEvent++ &
,++& '
Task++( ,
>++, -
handler++. 5
,++5 6 
SubscriptionLifetime,, 
lifetime,, %
=,,& ' 
SubscriptionLifetime,,( <
.,,< =
Weak,,= A
),,A B
=>,,C E

messageBus-- 
.-- 
	Subscribe-- 
(-- 
handler-- $
,--$ %
lifetime--& .
)--. /
;--/ 0
public// 

void// 
Dispose// 
(// 
)// 
{00 
if11 

(11 
	_disposed11 
)11 
{22 	
return33 
;33 
}44 	
	_disposed66 
=66 
true66 
;66 "
_connectivityPublisher77 
.77 
Dispose77 &
(77& '
)77' (
;77( )
}88 
}99 Òw
„/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Services/BottomSheetService.cs
	namespace		 	
Ecliptix		
 
.		 
Core		 
.		 
Core		 
.		 
	Messaging		 &
.		& '
Services		' /
;		/ 0
internal 
sealed	 
class 
BottomSheetService (
:) *
IBottomSheetService+ >
,> ?
IDisposable@ K
{ 
private 
readonly 
IMessageBus  
_messageBus! ,
;, -
private 
readonly 
Queue 
< 
BottomSheetRequest -
>- .
_requestQueue/ <
== >
new? B
(B C
)C D
;D E
private 
readonly 
Lock 

_queueLock $
=% &
new' *
(* +
)+ ,
;, -
private 
BottomSheetRequest 
? 
_pendingRequest  /
;/ 0
private 
bool !
_isShowingBottomSheet &
;& '
private 
bool 
_isAnimating 
; 
private 
bool 
	_disposed 
; 
public 

BottomSheetService 
( 
IMessageBus )

messageBus* 4
)4 5
{ 
_messageBus 
= 

messageBus  
;  !
Log 
. 
Debug 
( 
$str 9
)9 :
;: ;
_messageBus 
. 
	Subscribe 
< -
!BottomSheetAnimationCompleteEvent ?
>? @
(@ A
asyncA F
evtG J
=>K M
{ 	
Log 
. 
Debug 
( 
$str M
,M N
evtO R
.R S
AnimationTypeS `
)` a
;a b
await #
HandleAnimationComplete )
() *
evt* -
)- .
;. /
} 	
)	 

;
 
} 
public!! 

async!! 
Task!! 
	ShowAsync!! 
(!!  $
BottomSheetComponentType!!  8
componentType!!9 F
,!!F G
UserControl!!H S
?!!S T
control!!U \
=!!] ^
null!!_ c
,!!c d
bool!!e i
	showScrim!!j s
=!!t u
true!!v z
,!!z {
bool	!!| €
isDismissable
!! Ž
=
!! 
true
!!‘ •
)
!!• –
{"" 
if## 

(## 
	_disposed## 
)## 
{$$ 	
Log%% 
.%% 
Warning%% 
(%% 
$str%% T
)%%T U
;%%U V
return&& 
;&& 
}'' 	
Log)) 
.)) 
Debug)) 
()) 
$str)) J
,))J K
componentType))L Y
)))Y Z
;))Z [
BottomSheetRequest++ 
request++ "
=++# $
new++% (
(++( )
componentType++) 6
,++6 7
control++8 ?
,++? @
	showScrim++A J
,++J K
isDismissable++L Y
)++Y Z
;++Z [
lock-- 
(-- 

_queueLock-- 
)-- 
{.. 	
_requestQueue// 
.// 
Enqueue// !
(//! "
request//" )
)//) *
;//* +
Log00 
.00 
Debug00 
(00 
$str00 U
,00U V
_requestQueue00W d
.00d e
Count00e j
)00j k
;00k l
}11 	
await33 
ProcessNextRequest33  
(33  !
)33! "
;33" #
}44 
public77 

async77 
Task77 
	HideAsync77 
(77  
)77  !
{88 
if99 

(99 
	_disposed99 
)99 
{:: 	
Log;; 
.;; 
Warning;; 
(;; 
$str;; T
);;T U
;;;U V
return<< 
;<< 
}== 	
Log?? 
.?? 
Debug?? 
(?? 
$str?? =
)??= >
;??> ?
lockAA 
(AA 

_queueLockAA 
)AA 
{BB 	
ifCC 
(CC 
!CC !
_isShowingBottomSheetCC &
||CC' )
_isAnimatingCC* 6
)CC6 7
{DD 
LogEE 
.EE 
DebugEE 
(EE 
$strEE `
)EE` a
;EEa b
returnFF 
;FF 
}GG 
_isAnimatingII 
=II 
trueII 
;II  
}JJ 	
awaitLL 
_messageBusLL 
.LL 
PublishAsyncLL &
(LL& '#
BottomSheetCommandEventLL' >
.LL> ?
HideLL? C
(LLC D
)LLD E
)LLE F
;LLF G
}MM 
publicOO 

asyncOO 
TaskOO  
BottomSheetDismissedOO *
(OO* +
)OO+ ,
{PP 
LogQQ 
.QQ 
DebugQQ 
(QQ 
$strQQ F
)QQF G
;QQG H
lockSS 
(SS 

_queueLockSS 
)SS 
{TT 	
ifUU 
(UU 
!UU !
_isShowingBottomSheetUU &
)UU& '
{VV 
returnWW 
;WW 
}XX 
}YY 	
awaitZZ 
_messageBusZZ 
.ZZ 
PublishAsyncZZ &
(ZZ& '#
BottomSheetCommandEventZZ' >
.ZZ> ?
HideZZ? C
(ZZC D
)ZZD E
)ZZE F
;ZZF G
}[[ 
private]] 
async]] 
Task]] 
ProcessNextRequest]] )
(]]) *
)]]* +
{^^ 
if__ 

(__ 
	_disposed__ 
)__ 
{`` 	
returnaa 
;aa 
}bb 	
BottomSheetRequestdd 
?dd 
requestToShowdd )
=dd* +
nulldd, 0
;dd0 1
boolee 

shouldHideee 
=ee 
falseee 
;ee  
lockgg 
(gg 

_queueLockgg 
)gg 
{hh 	
ifii 
(ii 
_isAnimatingii 
)ii 
{jj 
Logkk 
.kk 
Debugkk 
(kk 
$strkk S
)kkS T
;kkT U
returnll 
;ll 
}mm 
ifoo 
(oo 
_requestQueueoo 
.oo 
Countoo #
==oo$ &
$numoo' (
)oo( )
{pp 
Logqq 
.qq 
Debugqq 
(qq 
$strqq Q
)qqQ R
;qqR S
returnrr 
;rr 
}ss 
ifuu 
(uu !
_isShowingBottomSheetuu %
)uu% &
{vv 
_pendingRequestww 
=ww  !
_requestQueueww" /
.ww/ 0
Dequeueww0 7
(ww7 8
)ww8 9
;ww9 :
Logxx 
.xx 
Debugxx 
(xx 
$str	xx ‡
,
xx‡ ˆ
_pendingRequestyy #
.yy# $
ComponentTypeyy$ 1
,yy1 2
_requestQueueyy3 @
.yy@ A
CountyyA F
)yyF G
;yyG H

shouldHidezz 
=zz 
truezz !
;zz! "
_isAnimating{{ 
={{ 
true{{ #
;{{# $
}|| 
else}} 
{~~ 
requestToShow 
= 
_requestQueue  -
.- .
Dequeue. 5
(5 6
)6 7
;7 8
_isAnimating
€€ 
=
€€ 
true
€€ #
;
€€# $
Log
 
.
 
Debug
 
(
 
$str
 o
,
o p
requestToShow
‚‚ !
.
‚‚! "
ComponentType
‚‚" /
,
‚‚/ 0
_requestQueue
‚‚1 >
.
‚‚> ?
Count
‚‚? D
)
‚‚D E
;
‚‚E F
}
ƒƒ 
}
„„ 	
if
†† 

(
†† 

shouldHide
†† 
)
†† 
{
‡‡ 	
Log
ˆˆ 
.
ˆˆ 
Debug
ˆˆ 
(
ˆˆ 
$str
ˆˆ k
)
ˆˆk l
;
ˆˆl m
await
‰‰ 
_messageBus
‰‰ 
.
‰‰ 
PublishAsync
‰‰ *
(
‰‰* +%
BottomSheetCommandEvent
‰‰+ B
.
‰‰B C
Hide
‰‰C G
(
‰‰G H
)
‰‰H I
)
‰‰I J
;
‰‰J K
}
ŠŠ 	
else
‹‹ 
{
ŒŒ 	
await
 
_messageBus
 
.
 
PublishAsync
 *
(
* +%
BottomSheetCommandEvent
+ B
.
B C
Show
C G
(
G H
requestToShow
ŽŽ 
!
ŽŽ 
.
ŽŽ 
ComponentType
ŽŽ ,
,
ŽŽ, -
requestToShow
 
.
 
Control
 %
,
% &
requestToShow
 
.
 
	ShowScrim
 '
,
' (
requestToShow
‘‘ 
.
‘‘ 
IsDismissable
‘‘ +
)
‘‘+ ,
)
‘‘, -
;
‘‘- .
}
’’ 	
}
““ 
private
•• 
async
•• 
Task
•• %
HandleAnimationComplete
•• .
(
••. //
!BottomSheetAnimationCompleteEvent
••/ P
evt
••Q T
)
••T U
{
–– 
if
—— 

(
—— 
	_disposed
—— 
)
—— 
{
˜˜ 	
return
™™ 
;
™™ 
}
šš 	 
BottomSheetRequest
œœ 
?
œœ 
requestToShow
œœ )
=
œœ* +
null
œœ, 0
;
œœ0 1
lock
žž 
(
žž 

_queueLock
žž 
)
žž 
{
ŸŸ 	
_isAnimating
   
=
   
false
    
;
    !
if
¢¢ 
(
¢¢ 
evt
¢¢ 
.
¢¢ 
AnimationType
¢¢ !
==
¢¢" $
AnimationType
¢¢% 2
.
¢¢2 3
Show
¢¢3 7
)
¢¢7 8
{
££ #
_isShowingBottomSheet
¤¤ %
=
¤¤& '
true
¤¤( ,
;
¤¤, -
Log
¥¥ 
.
¥¥ 
Debug
¥¥ 
(
¥¥ 
$str
¥¥ ~
,
¥¥~ 
_requestQueue¥¥€ 
.¥¥ Ž
Count¥¥Ž “
)¥¥“ ”
;¥¥” •
}
¦¦ 
else
§§ 
{
¨¨ #
_isShowingBottomSheet
©© %
=
©©& '
false
©©( -
;
©©- .
Log
ªª 
.
ªª 
Debug
ªª 
(
ªª 
$str
ªª _
)
ªª_ `
;
ªª` a
if
¬¬ 
(
¬¬ 
_pendingRequest
¬¬ #
!=
¬¬$ &
null
¬¬' +
)
¬¬+ ,
{
­­ 
requestToShow
®® !
=
®®" #
_pendingRequest
®®$ 3
;
®®3 4
_pendingRequest
¯¯ #
=
¯¯$ %
null
¯¯& *
;
¯¯* +
_isAnimating
°°  
=
°°! "
true
°°# '
;
°°' (
Log
±± 
.
±± 
Debug
±± 
(
±± 
$str
±± Z
,
±±Z [
requestToShow
±±\ i
.
±±i j
ComponentType
±±j w
)
±±w x
;
±±x y
}
²² 
}
³³ 
}
´´ 	
if
¶¶ 

(
¶¶ 
requestToShow
¶¶ 
!=
¶¶ 
null
¶¶ !
)
¶¶! "
{
·· 	
await
¸¸ 
_messageBus
¸¸ 
.
¸¸ 
PublishAsync
¸¸ *
(
¸¸* +%
BottomSheetCommandEvent
¸¸+ B
.
¸¸B C
Show
¸¸C G
(
¸¸G H
requestToShow
¹¹ 
.
¹¹ 
ComponentType
¹¹ +
,
¹¹+ ,
requestToShow
ºº 
.
ºº 
Control
ºº %
,
ºº% &
requestToShow
»» 
.
»» 
	ShowScrim
»» '
,
»»' (
requestToShow
¼¼ 
.
¼¼ 
IsDismissable
¼¼ +
)
¼¼+ ,
)
¼¼, -
;
¼¼- .
}
½½ 	
else
¾¾ 
{
¿¿ 	
await
ÀÀ  
ProcessNextRequest
ÀÀ $
(
ÀÀ$ %
)
ÀÀ% &
;
ÀÀ& '
}
ÁÁ 	
}
ÂÂ 
public
ÄÄ 

IDisposable
ÄÄ "
OnBottomSheetChanged
ÄÄ +
(
ÄÄ+ ,
Func
ÄÄ, 0
<
ÄÄ0 1%
BottomSheetCommandEvent
ÄÄ1 H
,
ÄÄH I
Task
ÄÄJ N
>
ÄÄN O
handler
ÄÄP W
,
ÄÄW X"
SubscriptionLifetime
ÄÄY m
lifetime
ÄÄn v
=
ÄÄw x#
SubscriptionLifetimeÄÄy 
.ÄÄ Ž
WeakÄÄŽ ’
)ÄÄ’ “
{
ÅÅ 
return
ÆÆ 
_messageBus
ÆÆ 
.
ÆÆ 
	Subscribe
ÆÆ $
(
ÆÆ$ %
handler
ÆÆ% ,
,
ÆÆ, -
lifetime
ÆÆ. 6
)
ÆÆ6 7
;
ÆÆ7 8
}
ÇÇ 
public
ÉÉ 

IDisposable
ÉÉ !
OnBottomSheetHidden
ÉÉ *
(
ÉÉ* +
Func
ÉÉ+ /
<
ÉÉ/ 0$
BottomSheetHiddenEvent
ÉÉ0 F
,
ÉÉF G
Task
ÉÉH L
>
ÉÉL M
handler
ÉÉN U
,
ÉÉU V"
SubscriptionLifetime
ÉÉW k
lifetime
ÉÉl t
=
ÉÉu v#
SubscriptionLifetimeÉÉw ‹
.ÉÉ‹ Œ
WeakÉÉŒ 
)ÉÉ ‘
{
ÊÊ 
return
ËË 
_messageBus
ËË 
.
ËË 
	Subscribe
ËË $
(
ËË$ %
handler
ËË% ,
,
ËË, -
lifetime
ËË. 6
)
ËË6 7
;
ËË7 8
}
ÌÌ 
public
ÎÎ 

void
ÎÎ 
Dispose
ÎÎ 
(
ÎÎ 
)
ÎÎ 
{
ÏÏ 
if
ÐÐ 

(
ÐÐ 
	_disposed
ÐÐ 
)
ÐÐ 
{
ÑÑ 	
return
ÒÒ 
;
ÒÒ 
}
ÓÓ 	
Log
ÕÕ 
.
ÕÕ 
Debug
ÕÕ 
(
ÕÕ 
$str
ÕÕ ;
)
ÕÕ; <
;
ÕÕ< =
	_disposed
ÖÖ 
=
ÖÖ 
true
ÖÖ 
;
ÖÖ 
lock
ØØ 
(
ØØ 

_queueLock
ØØ 
)
ØØ 
{
ÙÙ 	
_requestQueue
ÚÚ 
.
ÚÚ 
Clear
ÚÚ 
(
ÚÚ  
)
ÚÚ  !
;
ÚÚ! "
_pendingRequest
ÛÛ 
=
ÛÛ 
null
ÛÛ "
;
ÛÛ" #
}
ÜÜ 	
}
ÝÝ 
private
ßß 
sealed
ßß 
record
ßß  
BottomSheetRequest
ßß ,
(
ßß, -&
BottomSheetComponentType
àà  
ComponentType
àà! .
,
àà. /
UserControl
áá 
?
áá 
Control
áá 
,
áá 
bool
ââ 
	ShowScrim
ââ 
,
ââ 
bool
ãã 
IsDismissable
ãã 
)
ãã 
;
ãã 
}ää È¦
s/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/MessageBus.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
;& '
public 
sealed 
class 

MessageBus 
:  
IMessageBus! ,
{ 
private 
readonly 
SubscriptionManager ( 
_subscriptionManager) =
;= >
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1
IMessageRequest2 A
>A B
_pendingRequestsC S
=T U
newV Y
(Y Z
)Z [
;[ \
private 
readonly  
ConcurrentDictionary )
<) *
Type* .
,. /"
ReactiveSubjectWrapper0 F
>F G
_reactiveSubjectsH Y
=Z [
new\ _
(_ `
)` a
;a b
private 
readonly 
Timer  
_subjectCleanupTimer /
;/ 0
private 
long #
_totalMessagesPublished (
;( )
private 
long #
_totalRequestsProcessed (
;( )
private 
bool 
	_disposed 
; 
public 

bool 

IsDisposed 
=> 
	_disposed '
;' (
public 


MessageBus 
( 
) 
{  
_subscriptionManager 
= 
new "
SubscriptionManager# 6
(6 7
)7 8
;8 9 
_subjectCleanupTimer   
=   
new   "
Timer  # (
(  ( )!
CleanupUnusedSubjects  ) >
,  > ?
null  @ D
,  D E
TimeSpan  F N
.  N O
FromMinutes  O Z
(  Z [
$num  [ \
)  \ ]
,  ] ^
TimeSpan  _ g
.  g h
FromMinutes  h s
(  s t
$num  t u
)  u v
)  v w
;  w x
}!! 
public## 

IObservable## 
<## 
TMessage## 
>##  
GetEvent##! )
<##) *
TMessage##* 2
>##2 3
(##3 4
)##4 5
where##6 ;
TMessage##< D
:##E F
class##G L
{$$ 
if%% 

(%% 
	_disposed%% 
)%% 
{&& 	
throw'' 
new'' #
ObjectDisposedException'' -
(''- .
nameof''. 4
(''4 5

MessageBus''5 ?
)''? @
)''@ A
;''A B
}(( 	"
ReactiveSubjectWrapper** 
wrapper** &
=**' (
_reactiveSubjects**) :
.**: ;
GetOrAdd**; C
(**C D
typeof++ 
(++ 
TMessage++ 
)++ 
,++ 
_,, 
=>,, 
new,, "
ReactiveSubjectWrapper,, +
(,,+ ,
new,,, /
Subject,,0 7
<,,7 8
TMessage,,8 @
>,,@ A
(,,A B
),,B C
),,C D
),,D E
;,,E F
wrapper.. 
... 
IncrementReference.. "
(.." #
)..# $
;..$ %
IObservable00 
<00 
TMessage00 
>00 

observable00 (
=00) *
(00+ ,
(00, -
Subject00- 4
<004 5
TMessage005 =
>00= >
)00> ?
wrapper00? F
.00F G
Subject00G N
)00N O
.00O P
AsObservable00P \
(00\ ]
)00] ^
;00^ _
return22 

Observable22 
.22 
Create22  
<22  !
TMessage22! )
>22) *
(22* +
observer22+ 3
=>224 6
{33 	
IDisposable44 
subscription44 $
=44% &

observable44' 1
.441 2
	Subscribe442 ;
(44; <
observer44< D
)44D E
;44E F
return55 
new55 
CompositeDisposable55 *
(55* +
subscription55+ 7
,557 8
new559 <
DisposableAction55= M
(55M N
(55N O
)55O P
=>55Q S
wrapper55T [
.55[ \
DecrementReference55\ n
(55n o
)55o p
)55p q
)55q r
;55r s
}66 	
)66	 

;66
 
}77 
public99 

void99 
Publish99 
<99 
TMessage99  
>99  !
(99! "
TMessage99" *
message99+ 2
)992 3
where994 9
TMessage99: B
:99C D
class99E J
{:: 
if;; 

(;; 
	_disposed;; 
);; 
{<< 	
return== 
;== 
}>> 	
if@@ 

(@@ 
_reactiveSubjects@@ 
.@@ 
TryGetValue@@ )
(@@) *
typeof@@* 0
(@@0 1
TMessage@@1 9
)@@9 :
,@@: ;
out@@< ?"
ReactiveSubjectWrapper@@@ V
?@@V W
wrapper@@X _
)@@_ `
)@@` a
{AA 	
(BB 
(BB 
SubjectBB 
<BB 
TMessageBB 
>BB 
)BB  
wrapperBB  '
.BB' (
SubjectBB( /
)BB/ 0
.BB0 1
OnNextBB1 7
(BB7 8
messageBB8 ?
)BB? @
;BB@ A
}CC 	
TaskEE 
.EE 
RunEE 
(EE 
asyncEE 
(EE 
)EE 
=>EE 
{FF 	
tryGG 
{HH 
awaitII  
_subscriptionManagerII *
.II* +
PublishAsyncII+ 7
(II7 8
messageII8 ?
,II? @
CancellationTokenIIA R
.IIR S
NoneIIS W
)IIW X
;IIX Y
}JJ 
catchKK 
(KK 
	ExceptionKK 
exKK 
)KK  
{LL 
SerilogMM 
.MM 
LogMM 
.MM 
ErrorMM !
(MM! "
exMM" $
,MM$ %
$str	MM& †
,
MM† ‡
typeofNN 
(NN 
TMessageNN #
)NN# $
.NN$ %
NameNN% )
)NN) *
;NN* +
}OO 
}PP 	
)PP	 

.PP
 
ContinueWithPP 
(PP 
taskQQ 
=>QQ 
{RR 
ifSS 
(SS 
taskSS 
.SS 
	IsFaultedSS "
&&SS# %
taskSS& *
.SS* +
	ExceptionSS+ 4
!=SS5 7
nullSS8 <
)SS< =
{TT 
SerilogUU 
.UU 
LogUU 
.UU  
ErrorUU  %
(UU% &
taskUU& *
.UU* +
	ExceptionUU+ 4
,UU4 5
$strUU6 p
)UUp q
;UUq r
}VV 
}WW 
,WW 
TaskSchedulerXX 
.XX 
DefaultXX !
)XX! "
;XX" #
InterlockedZZ 
.ZZ 
	IncrementZZ 
(ZZ 
refZZ !#
_totalMessagesPublishedZZ" 9
)ZZ9 :
;ZZ: ;
}[[ 
public]] 

async]] 
Task]] 
PublishAsync]] "
<]]" #
TMessage]]# +
>]]+ ,
(]], -
TMessage]]- 5
message]]6 =
,]]= >
CancellationToken]]? P
cancellationToken]]Q b
=]]c d
default]]e l
)]]l m
where^^ 
TMessage^^ 
:^^ 
class^^ 
{__ 
if`` 

(`` 
_reactiveSubjects`` 
.`` 
TryGetValue`` )
(``) *
typeof``* 0
(``0 1
TMessage``1 9
)``9 :
,``: ;
out``< ?"
ReactiveSubjectWrapper``@ V
?``V W
wrapper``X _
)``_ `
)``` a
{aa 	
(bb 
(bb 
Subjectbb 
<bb 
TMessagebb 
>bb 
)bb  
wrapperbb  '
.bb' (
Subjectbb( /
)bb/ 0
.bb0 1
OnNextbb1 7
(bb7 8
messagebb8 ?
)bb? @
;bb@ A
}cc 	
awaitee  
_subscriptionManageree "
.ee" #
PublishAsyncee# /
(ee/ 0
messageee0 7
,ee7 8
cancellationTokenee9 J
)eeJ K
;eeK L
Interlockedgg 
.gg 
	Incrementgg 
(gg 
refgg !#
_totalMessagesPublishedgg" 9
)gg9 :
;gg: ;
}hh 
publicjj 

IDisposablejj 
	Subscribejj  
<jj  !
TMessagejj! )
>jj) *
(jj* +
Funckk 
<kk 
TMessagekk 
,kk 
Taskkk 
>kk 
handlerkk $
,kk$ % 
SubscriptionLifetimell 
lifetimell %
=ll& ' 
SubscriptionLifetimell( <
.ll< =
Strongll= C
)llC D
wherellE J
TMessagellK S
:llT U
classllV [
{mm 
returnnn 
	Subscribenn 
<nn 
TMessagenn !
>nn! "
(nn" #
_nn# $
=>nn% '
truenn( ,
,nn, -
handlernn. 5
,nn5 6
lifetimenn7 ?
,nn? @
$numnnA B
)nnB C
;nnC D
}oo 
privateqq 
IDisposableqq 
	Subscribeqq !
<qq! "
TMessageqq" *
>qq* +
(qq+ ,
Funcrr 
<rr 
TMessagerr 
,rr 
boolrr 
>rr 
filterrr #
,rr# $
Funcss 
<ss 
TMessagess 
,ss 
Taskss 
>ss 
handlerss $
,ss$ % 
SubscriptionLifetimett 
lifetimett %
=tt& ' 
SubscriptionLifetimett( <
.tt< =
Strongtt= C
,ttC D
intuu 
priorityuu 
=uu 
$numuu 
)uu 
whereuu 
TMessageuu  (
:uu) *
classuu+ 0
{vv 
returnww  
_subscriptionManagerww #
.ww# $
	Subscribeww$ -
(ww- .
filterww. 4
,ww4 5
handlerww6 =
,ww= >
lifetimeww? G
,wwG H
prioritywwI Q
)wwQ R
;wwR S
}xx 
publiczz 

asynczz 
Taskzz 
<zz 
	TResponsezz 
?zz  
>zz  !
RequestAsynczz" .
<zz. /
TRequestzz/ 7
,zz7 8
	TResponsezz9 B
>zzB C
(zzC D
TRequest{{ 
request{{ 
,{{ 
TimeSpan|| 
timeout|| 
=|| 
default|| "
,||" #
CancellationToken}} 
cancellationToken}} +
=}}, -
default}}. 5
)}}5 6
where~~ 
TRequest~~ 
:~~ 
class~~ 
,~~ 
IMessageRequest~~  /
where 
	TResponse 
: 
class 
,  
IMessageResponse! 1
{
€€ 
if
 

(
 
timeout
 
==
 
TimeSpan
 
.
  
Zero
  $
)
$ %
{
‚‚ 	
timeout
ƒƒ 
=
ƒƒ 
request
ƒƒ 
.
ƒƒ 
Timeout
ƒƒ %
;
ƒƒ% &
}
„„ 	"
TaskCompletionSource
†† 
<
†† 
IMessageResponse
†† -
>
††- .
tcs
††/ 2
=
††3 4
new
††5 8
(
††8 9
)
††9 :
;
††: ;
_pendingRequests
‡‡ 
[
‡‡ 
request
‡‡  
.
‡‡  !
	MessageId
‡‡! *
]
‡‡* +
=
‡‡, -
request
‡‡. 5
;
‡‡5 6
try
‰‰ 
{
ŠŠ 	
using
‹‹ %
CancellationTokenSource
‹‹ )

timeoutCts
‹‹* 4
=
‹‹5 6%
CancellationTokenSource
ŒŒ '
.
ŒŒ' (%
CreateLinkedTokenSource
ŒŒ( ?
(
ŒŒ? @
cancellationToken
ŒŒ@ Q
)
ŒŒQ R
;
ŒŒR S

timeoutCts
 
.
 
CancelAfter
 "
(
" #
timeout
# *
)
* +
;
+ ,
IDisposable
 "
responseSubscription
 ,
=
- .
	Subscribe
/ 8
<
8 9
	TResponse
9 B
>
B C
(
C D
response
 
=>
 
response
 $
.
$ %
CORRELATION_ID
% 3
==
4 6
request
7 >
.
> ?
	MessageId
? H
,
H I
response
‘‘ 
=>
‘‘ 
{
’’ 
tcs
““ 
.
““ 
	SetResult
““ !
(
““! "
response
““" *
)
““* +
;
““+ ,
return
”” 
Task
”” 
.
””  
CompletedTask
””  -
;
””- .
}
•• 
,
•• "
SubscriptionLifetime
–– $
.
––$ %
Scoped
––% +
)
––+ ,
;
––, -
await
˜˜ 
PublishAsync
˜˜ 
(
˜˜ 
request
˜˜ &
,
˜˜& '
cancellationToken
˜˜( 9
)
˜˜9 :
;
˜˜: ;
Task
šš 
<
šš 
IMessageResponse
šš !
>
šš! "
responseTask
šš# /
=
šš0 1
tcs
šš2 5
.
šš5 6
Task
šš6 :
;
šš: ;
Task
›› 
timeoutTask
›› 
=
›› 
Task
›› #
.
››# $
Delay
››$ )
(
››) *
timeout
››* 1
,
››1 2

timeoutCts
››3 =
.
››= >
Token
››> C
)
››C D
;
››D E
Task
 
completedTask
 
=
  
await
! &
Task
' +
.
+ ,
WhenAny
, 3
(
3 4
responseTask
4 @
,
@ A
timeoutTask
B M
)
M N
;
N O"
responseSubscription
ŸŸ  
.
ŸŸ  !
Dispose
ŸŸ! (
(
ŸŸ( )
)
ŸŸ) *
;
ŸŸ* +
if
¡¡ 
(
¡¡ 
completedTask
¡¡ 
==
¡¡  
timeoutTask
¡¡! ,
)
¡¡, -
{
¢¢ 
return
££ 
null
££ 
;
££ 
}
¤¤ 
IMessageResponse
¦¦ 
response
¦¦ %
=
¦¦& '
await
¦¦( -
responseTask
¦¦. :
;
¦¦: ;
Interlocked
§§ 
.
§§ 
	Increment
§§ !
(
§§! "
ref
§§" %%
_totalRequestsProcessed
§§& =
)
§§= >
;
§§> ?
return
©© 
response
©© 
as
©© 
	TResponse
©© (
;
©©( )
}
ªª 	
finally
«« 
{
¬¬ 	
_pendingRequests
­­ 
.
­­ 
	TryRemove
­­ &
(
­­& '
request
­­' .
.
­­. /
	MessageId
­­/ 8
,
­­8 9
out
­­: =
_
­­> ?
)
­­? @
;
­­@ A
}
®® 	
}
¯¯ 
private
±± 
void
±± #
CleanupUnusedSubjects
±± &
(
±±& '
object
±±' -
?
±±- .
state
±±/ 4
)
±±4 5
{
²² 
if
³³ 

(
³³ 
	_disposed
³³ 
)
³³ 
{
´´ 	
return
µµ 
;
µµ 
}
¶¶ 	
foreach
¸¸ 
(
¸¸ 
KeyValuePair
¸¸ 
<
¸¸ 
Type
¸¸ "
,
¸¸" #$
ReactiveSubjectWrapper
¸¸$ :
>
¸¸: ;
kvp
¸¸< ?
in
¸¸@ B
_reactiveSubjects
¸¸C T
.
¸¸T U
ToArray
¸¸U \
(
¸¸\ ]
)
¸¸] ^
)
¸¸^ _
{
¹¹ 	
if
ºº 
(
ºº 
kvp
ºº 
.
ºº 
Value
ºº 
.
ºº 
ReferenceCount
ºº (
==
ºº) +
$num
ºº, -
&&
ºº. 0
kvp
ºº1 4
.
ºº4 5
Value
ºº5 :
.
ºº: ;
	IsExpired
ºº; D
&&
ººE G
_reactiveSubjects
»» !
.
»»! "
	TryRemove
»»" +
(
»»+ ,
kvp
»», /
.
»»/ 0
Key
»»0 3
,
»»3 4
out
»»5 8$
ReactiveSubjectWrapper
»»9 O
?
»»O P
removed
»»Q X
)
»»X Y
)
»»Y Z
{
¼¼ 
removed
½½ 
.
½½ 
Dispose
½½ 
(
½½  
)
½½  !
;
½½! "
}
¾¾ 
}
¿¿ 	
}
ÀÀ 
public
ÂÂ 

void
ÂÂ 
Dispose
ÂÂ 
(
ÂÂ 
)
ÂÂ 
{
ÃÃ 
if
ÄÄ 

(
ÄÄ 
!
ÄÄ 
	_disposed
ÄÄ 
)
ÄÄ 
{
ÅÅ 	
	_disposed
ÆÆ 
=
ÆÆ 
true
ÆÆ 
;
ÆÆ "
_subjectCleanupTimer
ÈÈ  
?
ÈÈ  !
.
ÈÈ! "
Dispose
ÈÈ" )
(
ÈÈ) *
)
ÈÈ* +
;
ÈÈ+ ,
foreach
ÊÊ 
(
ÊÊ $
ReactiveSubjectWrapper
ÊÊ +
wrapper
ÊÊ, 3
in
ÊÊ4 6
_reactiveSubjects
ÊÊ7 H
.
ÊÊH I
Values
ÊÊI O
)
ÊÊO P
{
ËË 
wrapper
ÌÌ 
.
ÌÌ 
Dispose
ÌÌ 
(
ÌÌ  
)
ÌÌ  !
;
ÌÌ! "
}
ÍÍ 
_reactiveSubjects
ÏÏ 
.
ÏÏ 
Clear
ÏÏ #
(
ÏÏ# $
)
ÏÏ$ %
;
ÏÏ% &"
_subscriptionManager
ÑÑ  
.
ÑÑ  !
Dispose
ÑÑ! (
(
ÑÑ( )
)
ÑÑ) *
;
ÑÑ* +
_pendingRequests
ÓÓ 
.
ÓÓ 
Clear
ÓÓ "
(
ÓÓ" #
)
ÓÓ# $
;
ÓÓ$ %
}
ÔÔ 	
}
ÕÕ 
}ÖÖ 
internalØØ 
sealed
ØØ	 
class
ØØ $
ReactiveSubjectWrapper
ØØ ,
(
ØØ, -
object
ØØ- 3
subject
ØØ4 ;
)
ØØ; <
:
ØØ= >
IDisposable
ØØ? J
{ÙÙ 
private
ÚÚ 
int
ÚÚ 
_referenceCount
ÚÚ 
;
ÚÚ  
private
ÛÛ 
readonly
ÛÛ 
DateTime
ÛÛ 

_createdAt
ÛÛ (
=
ÛÛ) *
DateTime
ÛÛ+ 3
.
ÛÛ3 4
UtcNow
ÛÛ4 :
;
ÛÛ: ;
private
ÜÜ 
bool
ÜÜ 
	_disposed
ÜÜ 
;
ÜÜ 
public
ÞÞ 

object
ÞÞ 
Subject
ÞÞ 
{
ÞÞ 
get
ÞÞ 
;
ÞÞ  
}
ÞÞ! "
=
ÞÞ# $
subject
ÞÞ% ,
;
ÞÞ, -
public
ßß 

int
ßß 
ReferenceCount
ßß 
=>
ßß  
_referenceCount
ßß! 0
;
ßß0 1
public
àà 

bool
àà 
	IsExpired
àà 
=>
àà 
DateTime
àà %
.
àà% &
UtcNow
àà& ,
-
àà- .

_createdAt
àà/ 9
>
àà: ;
TimeSpan
àà< D
.
ààD E
FromMinutes
ààE P
(
ààP Q
$num
ààQ R
)
ààR S
;
ààS T
public
ââ 

void
ââ  
IncrementReference
ââ "
(
ââ" #
)
ââ# $
{
ãã 
if
ää 

(
ää 
!
ää 
	_disposed
ää 
)
ää 
{
åå 	
Interlocked
ææ 
.
ææ 
	Increment
ææ !
(
ææ! "
ref
ææ" %
_referenceCount
ææ& 5
)
ææ5 6
;
ææ6 7
}
çç 	
}
èè 
public
êê 

void
êê  
DecrementReference
êê "
(
êê" #
)
êê# $
{
ëë 
if
ìì 

(
ìì 
!
ìì 
	_disposed
ìì 
)
ìì 
{
íí 	
Interlocked
îî 
.
îî 
	Decrement
îî !
(
îî! "
ref
îî" %
_referenceCount
îî& 5
)
îî5 6
;
îî6 7
}
ïï 	
}
ðð 
public
òò 

void
òò 
Dispose
òò 
(
òò 
)
òò 
{
óó 
if
ôô 

(
ôô 
!
ôô 
	_disposed
ôô 
)
ôô 
{
õõ 	
	_disposed
öö 
=
öö 
true
öö 
;
öö 
if
÷÷ 
(
÷÷ 
Subject
÷÷ 
is
÷÷ 
Subject
÷÷ "
<
÷÷" #
object
÷÷# )
>
÷÷) *
typedSubject
÷÷+ 7
)
÷÷7 8
{
øø 
typedSubject
ùù 
.
ùù 
OnCompleted
ùù (
(
ùù( )
)
ùù) *
;
ùù* +
typedSubject
úú 
.
úú 
Dispose
úú $
(
úú$ %
)
úú% &
;
úú& '
}
ûû 
}
üü 	
}
ýý 
}þþ Ú
t/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/IMessageBus.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
;& '
public 
	interface 
IMessageBus 
: 
IDisposable *
{ 
IObservable		 
<		 
TMessage		 
>		 
GetEvent		 "
<		" #
TMessage		# +
>		+ ,
(		, -
)		- .
where		/ 4
TMessage		5 =
:		> ?
class		@ E
;		E F
Task 
PublishAsync	 
< 
TMessage 
> 
(  
TMessage  (
message) 0
,0 1
CancellationToken2 C
cancellationTokenD U
=V W
defaultX _
)_ `
wherea f
TMessageg o
:p q
classr w
;w x
IDisposable 
	Subscribe 
< 
TMessage "
>" #
(# $
Func 
< 
TMessage 
, 
Task 
> 
handler $
,$ % 
SubscriptionLifetime 
lifetime %
=& ' 
SubscriptionLifetime( <
.< =
Strong= C
)C D
whereE J
TMessageK S
:T U
classV [
;[ \
} 
public 
enum  
SubscriptionLifetime  
{ 
Strong 

,
 
Weak 
, 	
Scoped 

} 
public 
	interface 
IMessageRequest  
{ 
string 

	MessageId 
{ 
get 
; 
} 
TimeSpan 
Timeout 
{ 
get 
; 
} 
} 
public!! 
	interface!! 
IMessageResponse!! !
{"" 
string## 

?##
 
CORRELATION_ID## 
{## 
get##  
;##  !
}##" #
}$$ Ø
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Events/NetworkEvents.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Events' -
;- .
public 
sealed 
record %
ManualRetryRequestedEvent .
{ 
public 

uint 
? 
	ConnectId 
{ 
get  
;  !
}" #
public 

DateTime 
RequestedAt 
{  !
get" %
;% &
}' (
private

 %
ManualRetryRequestedEvent

 %
(

% &
uint

& *
?

* +
	connectId

, 5
,

5 6
DateTime

7 ?
requestedAt

@ K
)

K L
{ 
	ConnectId 
= 
	connectId 
; 
RequestedAt 
= 
requestedAt !
;! "
} 
public 

static %
ManualRetryRequestedEvent +
New, /
(/ 0
uint0 4
?4 5
	connectId6 ?
=@ A
nullB F
)F G
=>H J
new 
( 
	connectId 
, 
DateTime 
.  
UtcNow  &
)& '
;' (
} ®
ˆ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Events/MembershipLoggedOutEvent.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Events' -
;- .
public 
record $
MembershipLoggedOutEvent &
(& '
string' -
MembershipId. :
,: ;
string< B
ReasonC I
)I J
;J K×
‡/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Events/LanguageDetectionEvents.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Events' -
;- .
public 
enum #
LanguageDetectionAction #
{ 
Decline 
, 
Confirm 
, 
Request		 
}

 
public 
sealed 
record (
LanguageDetectionDialogEvent 1
{ 
public 
#
LanguageDetectionAction "
Action# )
{* +
get, /
;/ 0
}1 2
public 

string 
? 
TargetCulture  
{! "
get# &
;& '
}( )
public 

DateTime 
	Timestamp 
{ 
get  #
;# $
}% &
private (
LanguageDetectionDialogEvent (
(( )#
LanguageDetectionAction) @
actionA G
,G H
stringI O
?O P
targetCultureQ ^
)^ _
{ 
Action 
= 
action 
; 
TargetCulture 
= 
targetCulture %
;% &
	Timestamp 
= 
DateTime 
. 
UtcNow #
;# $
} 
public 

static (
LanguageDetectionDialogEvent .
Decline/ 6
(6 7
)7 8
=>9 ;
new 
( #
LanguageDetectionAction #
.# $
Decline$ +
,+ ,
null- 1
)1 2
;2 3
public 

static (
LanguageDetectionDialogEvent .
Confirm/ 6
(6 7
string7 =
targetCulture> K
)K L
=>M O
new 
( #
LanguageDetectionAction #
.# $
Confirm$ +
,+ ,
targetCulture- :
): ;
;; <
public 

static (
LanguageDetectionDialogEvent .
Request/ 6
(6 7
string7 =
targetCulture> K
)K L
=>M O
new   
(   #
LanguageDetectionAction   #
.  # $
Request  $ +
,  + ,
targetCulture  - :
)  : ;
;  ; <
}!! ´/
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Events/BottomSheetEvents.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Events' -
;- .
public 
enum $
BottomSheetComponentType $
{  
DetectedLocalization 
,  
RedirectNotification		 
,		 
UserRequestError

 
,

 
Hidden 

} 
public 
enum 
AnimationType 
{ 
Show 
, 	
Hide 
} 
public 
sealed 
record #
BottomSheetCommandEvent ,
{ 
public 

AnimationType 
AnimationType &
{' (
get) ,
;, -
}. /
public 
$
BottomSheetComponentType #
ComponentType$ 1
{2 3
get4 7
;7 8
}9 :
public 

UserControl 
? 
Control 
{  !
get" %
;% &
}' (
public 

bool 
	ShowScrim 
{ 
get 
;  
}! "
public 

bool 
IsDismissable 
{ 
get  #
;# $
}% &
public 

DateTime 
	Timestamp 
{ 
get  #
;# $
}% &
private #
BottomSheetCommandEvent #
(# $
AnimationType$ 1
animationType2 ?
,? @$
BottomSheetComponentTypeA Y
componentTypeZ g
,g h
UserControli t
?t u
controlv }
,} ~
bool	 ƒ
	showScrim
„ 
,
 Ž
bool
 “
isDismissable
” ¡
)
¡ ¢
{ 
AnimationType 
= 
animationType %
;% &
ComponentType   
=   
componentType   %
;  % &
Control!! 
=!! 
control!! 
;!! 
	ShowScrim"" 
="" 
	showScrim"" 
;"" 
IsDismissable## 
=## 
isDismissable## %
;##% &
	Timestamp$$ 
=$$ 
DateTime$$ 
.$$ 
UtcNow$$ #
;$$# $
}%% 
public'' 

static'' #
BottomSheetCommandEvent'' )
Show''* .
(''. /$
BottomSheetComponentType''/ G
componentType''H U
,''U V
UserControl''W b
?''b c
control''d k
,''k l
bool''m q
	showScrim''r {
,''{ |
bool	''} 
isDismissable
''‚ 
)
'' 
=>
''‘ “
new(( 
((( 
AnimationType(( 
.(( 
Show(( 
,(( 
componentType((  -
,((- .
control((/ 6
,((6 7
	showScrim((8 A
,((A B
isDismissable((C P
)((P Q
;((Q R
public** 

static** #
BottomSheetCommandEvent** )
Hide*** .
(**. /
)**/ 0
=>**1 3
new++ 
(++ 
AnimationType++ 
.++ 
Hide++ 
,++ $
BottomSheetComponentType++  8
.++8 9
Hidden++9 ?
,++? @
null++A E
,++E F
false++G L
,++L M
true++N R
)++R S
;++S T
},, 
public.. 
sealed.. 
record.. "
BottomSheetHiddenEvent.. +
{// 
public00 

bool00 
WasDismissedByUser00 "
{00# $
get00% (
;00( )
}00* +
public11 

DateTime11 
	Timestamp11 
{11 
get11  #
;11# $
}11% &
private33 "
BottomSheetHiddenEvent33 "
(33" #
bool33# '
wasDismissedByUser33( :
)33: ;
{44 
WasDismissedByUser55 
=55 
wasDismissedByUser55 /
;55/ 0
	Timestamp66 
=66 
DateTime66 
.66 
UtcNow66 #
;66# $
}77 
public99 

static99 "
BottomSheetHiddenEvent99 (
UserDismissed99) 6
(996 7
)997 8
=>999 ;
new99< ?
(99? @
true99@ D
)99D E
;99E F
}:: 
public<< 
sealed<< 
record<< -
!BottomSheetAnimationCompleteEvent<< 6
{== 
public>> 

AnimationType>> 
AnimationType>> &
{>>' (
get>>) ,
;>>, -
}>>. /
public?? 

DateTime?? 
	Timestamp?? 
{?? 
get??  #
;??# $
}??% &
privateAA -
!BottomSheetAnimationCompleteEventAA -
(AA- .
AnimationTypeAA. ;
animationTypeAA< I
)AAI J
{BB 
AnimationTypeCC 
=CC 
animationTypeCC %
;CC% &
	TimestampDD 
=DD 
DateTimeDD 
.DD 
UtcNowDD #
;DD# $
}EE 
publicGG 

staticGG -
!BottomSheetAnimationCompleteEventGG 3
ShowCompleteGG4 @
(GG@ A
)GGA B
=>GGC E
newGGF I
(GGI J
AnimationTypeGGJ W
.GGW X
ShowGGX \
)GG\ ]
;GG] ^
publicHH 

staticHH -
!BottomSheetAnimationCompleteEventHH 3
HideCompleteHH4 @
(HH@ A
)HHA B
=>HHC E
newHHF I
(HHI J
AnimationTypeHHJ W
.HHW X
HideHHX \
)HH\ ]
;HH] ^
}II Â
ˆ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Connectivity/ConnectivitySource.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Connectivity' 3
;3 4
public 
enum 
ConnectivitySource 
{ 
System 

,
 

DataCenter 
, 
InternetProbe 
, 
ManualAction 
}		 ì
ˆ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Connectivity/ConnectivityReason.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Connectivity' 3
;3 4
public 
enum 
ConnectivityReason 
{ 
None 
, 	
HandshakeStarted 
, 
HandshakeSucceeded 
, 

RpcFailure 
, 
ManualRetry		 
,		 
Backoff

 
,

 

NoInternet 
, 
InternetRecovered 
, 
ServerShutdown 
, 
RetryLimitReached 
, 
OperationCancelled 
, 
HandshakeFailed 
, 
SecurityError 
, 
Unknown 
} ’t
|/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Controls/ModuleContentControl.cs
	namespace		 	
Ecliptix		
 
.		 
Core		 
.		 
Core		 
.		 
Controls		 %
;		% &
public 
sealed 
class  
ModuleContentControl (
:) *
ContentControl+ 9
{ 
private 
readonly 
IModuleViewFactory '
?' (
_moduleViewFactory) ;
;; <
public 

static 
readonly 
StyledProperty )
<) *
object* 0
?0 1
>1 2$
ViewModelContentProperty3 K
=L M
AvaloniaProperty 
. 
Register !
<! " 
ModuleContentControl" 6
,6 7
object8 >
?> ?
>? @
(@ A
nameofA G
(G H
ViewModelContentH X
)X Y
)Y Z
;Z [
public 

object 
? 
ViewModelContent #
{ 
get 
=> 
GetValue 
( $
ViewModelContentProperty 0
)0 1
;1 2
set 
=> 
SetValue 
( $
ViewModelContentProperty 0
,0 1
value2 7
)7 8
;8 9
} 
public 
 
ModuleContentControl 
(  
)  !
{ 
try 
{ 	
_moduleViewFactory 
=  
Locator! (
.( )
Current) 0
?0 1
.1 2

GetService2 <
<< =
IModuleViewFactory= O
>O P
(P Q
)Q R
;R S
} 	
catch 
{ 	
_moduleViewFactory   
=    
null  ! %
;  % &
}!! 	
}"" 
static$$ 
 
ModuleContentControl$$ 
($$  
)$$  !
{%% $
ViewModelContentProperty&&  
.&&  !
Changed&&! (
.&&( )
AddClassHandler&&) 8
<&&8 9 
ModuleContentControl&&9 M
>&&M N
(&&N O
(&&O P
control&&P W
,&&W X
e&&Y Z
)&&Z [
=>&&\ ^
control'' 
.'' %
OnViewModelContentChanged'' -
(''- .
e''. /
.''/ 0
NewValue''0 8
)''8 9
)''9 :
;'': ;
}(( 
private** 
void** %
OnViewModelContentChanged** *
(*** +
object**+ 1
?**1 2
newViewModel**3 ?
)**? @
{++ 
Serilog,, 
.,, 
Log,, 
.,, 
Information,, 
(,,  
$str-- f
,--f g
newViewModel.. 
?.. 
... 
GetType.. !
(..! "
).." #
...# $
Name..$ (
??..) +
$str.., 2
)..2 3
;..3 4
if// 

(// 
newViewModel// 
==// 
null//  
)//  !
{00 	
Content11 
=11 
null11 
;11 
return22 
;22 
}33 	*
TryCreateViewWithModuleFactory55 &
(55& '
newViewModel55' 3
)553 4
.66 
Or66 
(66 
(66 
)66 
=>66 )
TryCreateViewWithStaticMapper66 3
(663 4
newViewModel664 @
)66@ A
.66A B
ToOption66B J
(66J K
)66K L
)66L M
.77 
Match77 
(77 
view88 
=>88 
{99 
view:: 
.:: 
DataContext:: $
=::% &
newViewModel::' 3
;::3 4
Content;; 
=;; 
view;; "
;;;" #
Serilog<< 
.<< 
Log<< 
.<<  
Information<<  +
(<<+ ,
$str== r
,==r s
view>> 
.>> 
GetType>> $
(>>$ %
)>>% &
.>>& '
Name>>' +
,>>+ ,
newViewModel>>- 9
.>>9 :
GetType>>: A
(>>A B
)>>B C
.>>C D
Name>>D H
)>>H I
;>>I J
}?? 
,?? 
(@@ 
)@@ 
=>@@ 
{AA 
ContentBB 
=BB 
CreateFallbackViewBB 0
(BB0 1
)BB1 2
;BB2 3
SerilogCC 
.CC 
LogCC 
.CC  
WarningCC  '
(CC' (
$strCC( ~
,CC~ 
newViewModelDD $
.DD$ %
GetTypeDD% ,
(DD, -
)DD- .
.DD. /
NameDD/ 3
)DD3 4
;DD4 5
}EE 
)EE 
;EE 
}FF 
privateHH 
OptionHH 
<HH 
ControlHH 
>HH *
TryCreateViewWithModuleFactoryHH :
(HH: ;
objectHH; A
	viewModelHHB K
)HHK L
{II 
ifJJ 

(JJ 
_moduleViewFactoryJJ 
==JJ !
nullJJ" &
)JJ& '
{KK 	
returnLL 
OptionLL 
<LL 
ControlLL !
>LL! "
.LL" #
NoneLL# '
;LL' (
}MM 	
tryOO 
{PP 	
SerilogQQ 
.QQ 
LogQQ 
.QQ 
InformationQQ #
(QQ# $
$strQQ$ v
,QQv w
	viewModelRR 
.RR 
GetTypeRR !
(RR! "
)RR" #
.RR# $
FullNameRR$ ,
)RR, -
;RR- .
OptionTT 
<TT 
ControlTT 
>TT 
resultTT "
=TT# $
_moduleViewFactoryTT% 7
.TT7 8

CreateViewTT8 B
(TTB C
	viewModelTTC L
.TTL M
GetTypeTTM T
(TTT U
)TTU V
)TTV W
;TTW X
resultVV 
.VV 
MatchVV 
(VV 
viewWW 
=>WW 
SerilogWW 
.WW  
LogWW  #
.WW# $
InformationWW$ /
(WW/ 0
$strXX ^
,XX^ _
viewYY 
.YY 
GetTypeYY  
(YY  !
)YY! "
.YY" #
NameYY# '
,YY' (
	viewModelYY) 2
.YY2 3
GetTypeYY3 :
(YY: ;
)YY; <
.YY< =
NameYY= A
)YYA B
,YYB C
(ZZ 
)ZZ 
=>ZZ 
SerilogZZ 
.ZZ 
LogZZ !
.ZZ! "
DebugZZ" '
(ZZ' (
$str[[ U
,[[U V
	viewModel\\ 
.\\ 
GetType\\ %
(\\% &
)\\& '
.\\' (
Name\\( ,
)\\, -
)\\- .
;\\. /
return^^ 
result^^ 
;^^ 
}__ 	
catch`` 
(`` 
	Exception`` 
ex`` 
)`` 
{aa 	
Serilogbb 
.bb 
Logbb 
.bb 
Errorbb 
(bb 
exbb  
,bb  !
$strbb" q
,bbq r
	viewModelcc 
.cc 
GetTypecc !
(cc! "
)cc" #
.cc# $
FullNamecc$ ,
)cc, -
;cc- .
returndd 
Optiondd 
<dd 
Controldd !
>dd! "
.dd" #
Nonedd# '
;dd' (
}ee 	
}ff 
privatehh 
statichh 
Controlhh 
?hh )
TryCreateViewWithStaticMapperhh 9
(hh9 :
objecthh: @
	viewModelhhA J
)hhJ K
{ii 
Serilogjj 
.jj 
Logjj 
.jj 
Informationjj 
(jj  
$strjj  q
,jjq r
	viewModelkk 
.kk 
GetTypekk 
(kk 
)kk 
.kk  
FullNamekk  (
)kk( )
;kk) *
tryll 
{mm 	
Controlnn 
?nn 
resultnn 
=nn 
	viewModelnn '
switchnn( .
{oo 
Featurespp 
.pp 
Authenticationpp '
.pp' (

ViewModelspp( 2
.pp2 3
Hostspp3 8
.pp8 9#
AuthenticationViewModelpp9 P
=>ppQ S
newqq 
Featuresqq  
.qq  !
Authenticationqq! /
.qq/ 0
Viewsqq0 5
.qq5 6
Hostsqq6 ;
.qq; <
AuthenticationViewqq< N
(qqN O
)qqO P
,qqP Q
Featuresrr 
.rr 
Mainrr 
.rr 

ViewModelsrr (
.rr( )
MasterViewModelrr) 8
=>rr9 ;
newss 
Featuresss  
.ss  !
Mainss! %
.ss% &
Viewsss& +
.ss+ ,

MasterViewss, 6
(ss6 7
)ss7 8
,ss8 9
Featurestt 
.tt 
Authenticationtt '
.tt' (

ViewModelstt( 2
.tt2 3
SignIntt3 9
.tt9 :
SignInViewModeltt: I
=>ttJ L
StaticViewMapperttM ]
.tt] ^

CreateViewtt^ h
(tth i
typeofuu 
(uu 
Featuresuu #
.uu# $
Authenticationuu$ 2
.uu2 3

ViewModelsuu3 =
.uu= >
SignInuu> D
.uuD E
SignInViewModeluuE T
)uuT U
)uuU V
,uuV W
Featuresvv 
.vv 
Authenticationvv '
.vv' (

ViewModelsvv( 2
.vv2 3
Registrationvv3 ?
.vv? @'
MobileVerificationViewModelvv@ [
=>vv\ ^
StaticViewMapperww $
.ww$ %

CreateViewww% /
(ww/ 0
typeofxx 
(xx 
Featuresyy $
.yy$ %
Authenticationyy% 3
.yy3 4

ViewModelsyy4 >
.yy> ?
Registrationyy? K
.yyK L'
MobileVerificationViewModelyyL g
)yyg h
)yyh i
,yyi j
Featureszz 
.zz 
Authenticationzz '
.zz' (

ViewModelszz( 2
.zz2 3
Registrationzz3 ?
.zz? @
VerifyOtpViewModelzz@ R
=>zzS U
StaticViewMapper{{ $
.{{$ %

CreateView{{% /
({{/ 0
typeof|| 
(|| 
Features|| '
.||' (
Authentication||( 6
.||6 7

ViewModels||7 A
.||A B
Registration||B N
.||N O
VerifyOtpViewModel||O a
)||a b
)||b c
,||c d
Features}} 
.}} 
Authentication}} '
.}}' (

ViewModels}}( 2
.}}2 3
Registration}}3 ?
.}}? @&
SecureKeyVerifierViewModel}}@ Z
=>}}[ ]
StaticViewMapper~~ $
.~~$ %

CreateView~~% /
(~~/ 0
typeof 
( 
Features '
.' (
Authentication( 6
.6 7

ViewModels7 A
.A B
RegistrationB N
.N O(
SecureKeyVerifierViewModel
€€ 6
)
€€6 7
)
€€7 8
,
€€8 9
Features
 
.
 
Authentication
 '
.
' (

ViewModels
( 2
.
2 3
Registration
3 ?
.
? @ 
PassPhaseViewModel
@ R
=>
S U
StaticViewMapper
‚‚ $
.
‚‚$ %

CreateView
‚‚% /
(
‚‚/ 0
typeof
ƒƒ 
(
ƒƒ 
Features
ƒƒ '
.
ƒƒ' (
Authentication
ƒƒ( 6
.
ƒƒ6 7

ViewModels
ƒƒ7 A
.
ƒƒA B
Registration
ƒƒB N
.
ƒƒN O 
PassPhaseViewModel
ƒƒO a
)
ƒƒa b
)
ƒƒb c
,
ƒƒc d
Features
„„ 
.
„„ 
Authentication
„„ '
.
„„' (

ViewModels
„„( 2
.
„„2 3
Welcome
„„3 :
.
„„: ;
WelcomeViewModel
„„; K
=>
„„L N
StaticViewMapper
…… $
.
……$ %

CreateView
……% /
(
……/ 0
typeof
†† 
(
†† 
Ecliptix
†† '
.
††' (
Core
††( ,
.
††, -
Features
††- 5
.
††5 6
Authentication
††6 D
.
††D E

ViewModels
††E O
.
††O P
Welcome
††P W
.
††W X
WelcomeViewModel
††X h
)
††h i
)
††i j
,
††j k
_
‡‡ 
=>
‡‡ 
null
‡‡ 
}
ˆˆ 
;
ˆˆ 
Serilog
‰‰ 
.
‰‰ 
Log
‰‰ 
.
‰‰ 
Information
‰‰ #
(
‰‰# $
$str
ŠŠ k
,
ŠŠk l
	viewModel
‹‹ 
.
‹‹ 
GetType
‹‹ !
(
‹‹! "
)
‹‹" #
.
‹‹# $
FullName
‹‹$ ,
,
‹‹, -
result
‹‹. 4
?
‹‹4 5
.
‹‹5 6
GetType
‹‹6 =
(
‹‹= >
)
‹‹> ?
.
‹‹? @
Name
‹‹@ D
??
‹‹E G
$str
‹‹H N
)
‹‹N O
;
‹‹O P
return
ŒŒ 
result
ŒŒ 
;
ŒŒ 
}
 	
catch
ŽŽ 
(
ŽŽ 
	Exception
ŽŽ 
ex
ŽŽ 
)
ŽŽ 
{
 	
Serilog
 
.
 
Log
 
.
 
Error
 
(
 
ex
  
,
  !
$str
" p
,
p q
	viewModel
‘‘ 
.
‘‘ 
GetType
‘‘ !
(
‘‘! "
)
‘‘" #
.
‘‘# $
FullName
‘‘$ ,
)
‘‘, -
;
‘‘- .
return
’’ 
null
’’ 
;
’’ 
}
““ 	
}
”” 
private
–– 
static
–– 
Control
––  
CreateFallbackView
–– -
(
––- .
)
––. /
{
—— 
return
˜˜ 
new
˜˜ 
	TextBlock
˜˜ 
{
™™ 	
Text
šš 
=
šš 
$str
šš ?
,
šš? @!
HorizontalAlignment
›› 
=
››  !
Avalonia
››" *
.
››* +
Layout
››+ 1
.
››1 2!
HorizontalAlignment
››2 E
.
››E F
Center
››F L
,
››L M
VerticalAlignment
œœ 
=
œœ 
Avalonia
œœ  (
.
œœ( )
Layout
œœ) /
.
œœ/ 0
VerticalAlignment
œœ0 A
.
œœA B
Center
œœB H
}
 	
;
	 

}
žž 
}ŸŸ äF
ˆ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Connectivity/ConnectivityModels.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Connectivity' 3
;3 4
public 
readonly 
record 
struct  
ConnectivitySnapshot 2
(2 3
ConnectivityStatus 
Status 
, 
ConnectivityReason 
Reason 
, 
ConnectivitySource		 
Source		 
,		 
NetworkFailure

 
?

 
Failure

 
,

 
uint 
? 	
	ConnectId
 
, 
int 
? 
RetryAttempt	 
, 
TimeSpan 
? 
RetryBackoff 
, 
Guid 
CORRELATION_ID	 
, 
DateTime 

OccurredAt 
) 
{ 
public 

static 
readonly  
ConnectivitySnapshot /
Initial0 7
=8 9
new: =
(= >
ConnectivityStatus 
. 
	Connected $
,$ %
ConnectivityReason 
. 
None 
,  
ConnectivitySource 
. 
System !
,! "
null 
, 
null 
, 
null 
, 
null 
, 
Guid 
. 
Empty 
, 
DateTime 
. 
MinValue 
) 
; 
} 
public 
readonly 
record 
struct 
ConnectivityIntent 0
(0 1
ConnectivityStatus 
Status 
, 
ConnectivityReason 
Reason 
, 
ConnectivitySource   
Source   
,   
NetworkFailure!! 
?!! 
Failure!! 
=!! 
null!! "
,!!" #
uint"" 
?"" 	
	ConnectId""
 
="" 
null"" 
,"" 
int## 
?## 
RetryAttempt##	 
=## 
null## 
,## 
TimeSpan$$ 
?$$ 
RetryBackoff$$ 
=$$ 
null$$ !
,$$! "
Guid%% 
?%% 	
CORRELATION_ID%%
 
=%% 
null%% 
)%%  
{&& 
public'' 

static'' 
ConnectivityIntent'' $
	Connected''% .
(''. /
uint''/ 3
?''3 4
	connectId''5 >
=''? @
null''A E
,''E F
ConnectivityReason''G Y
reason''Z `
=''a b
ConnectivityReason''c u
.''u v
HandshakeSucceeded	''v ˆ
)
''ˆ ‰
=>
''Š Œ
new(( 
((( 
ConnectivityStatus(( 
.(( 
	Connected(( (
,((( )
reason((* 0
,((0 1
ConnectivitySource((2 D
.((D E

DataCenter((E O
,((O P
null((Q U
,((U V
	connectId((W `
)((` a
;((a b
public** 

static** 
ConnectivityIntent** $

Connecting**% /
(**/ 0
uint**0 4
?**4 5
	connectId**6 ?
=**@ A
null**B F
,**F G
ConnectivityReason**H Z
reason**[ a
=**b c
ConnectivityReason**d v
.**v w
HandshakeStarted	**w ‡
,
**‡ ˆ 
ConnectivitySource
**‰ ›
source
**œ ¢
=
**£ ¤ 
ConnectivitySource
**¥ ·
.
**· ¸

DataCenter
**¸ Â
)
**Â Ã
=>
**Ä Æ
new++ 
(++ 
ConnectivityStatus++ 
.++ 

Connecting++ )
,++) *
reason+++ 1
,++1 2
source++3 9
,++9 :
null++; ?
,++? @
	connectId++A J
)++J K
;++K L
public-- 

static-- 
ConnectivityIntent-- $
Disconnected--% 1
(--1 2
NetworkFailure--2 @
failure--A H
,--H I
uint--J N
?--N O
	connectId--P Y
=--Z [
null--\ `
,--` a
ConnectivityReason--b t
reason--u {
=--| }
ConnectivityReason	--~ 
.
-- ‘

RpcFailure
--‘ ›
,
--› œ 
ConnectivitySource
-- ¯
source
--° ¶
=
--· ¸ 
ConnectivitySource
--¹ Ë
.
--Ë Ì

DataCenter
--Ì Ö
)
--Ö ×
=>
--Ø Ú
new.. 
(.. 
ConnectivityStatus.. 
... 
Disconnected.. +
,..+ ,
reason..- 3
,..3 4
source..5 ;
,..; <
failure..= D
,..D E
	connectId..F O
)..O P
;..P Q
public00 

static00 
ConnectivityIntent00 $

Recovering00% /
(00/ 0
NetworkFailure000 >
failure00? F
,00F G
uint00H L
?00L M
	connectId00N W
=00X Y
null00Z ^
,00^ _
int00` c
?00c d
retryAttempt00e q
=00r s
null00t x
,00x y
TimeSpan	00z ‚
?
00‚ ƒ
backoff
00„ ‹
=
00Œ 
null
00Ž ’
)
00’ “
=>
00” –
new11 
(11 
ConnectivityStatus11 
.11 

Recovering11 )
,11) *
ConnectivityReason11+ =
.11= >
Backoff11> E
,11E F
ConnectivitySource11G Y
.11Y Z
System11Z `
,11` a
failure11b i
,11i j
	connectId11k t
,11t u
retryAttempt	11v ‚
,
11‚ ƒ
backoff
11„ ‹
)
11‹ Œ
;
11Œ 
public33 

static33 
ConnectivityIntent33 $
RetriesExhausted33% 5
(335 6
NetworkFailure336 D
failure33E L
,33L M
uint33N R
?33R S
	connectId33T ]
=33^ _
null33` d
,33d e
int33f i
?33i j
retries33k r
=33s t
null33u y
)33y z
=>33{ }
new44 
(44 
ConnectivityStatus44 
.44 
RetriesExhausted44 /
,44/ 0
ConnectivityReason441 C
.44C D
RetryLimitReached44D U
,44U V
ConnectivitySource44W i
.44i j
System44j p
,44p q
failure44r y
,44y z
	connectId	44{ „
,
44„ …
retries
44† 
)
44 Ž
;
44Ž 
public66 

static66 
ConnectivityIntent66 $
InternetLost66% 1
(661 2
)662 3
=>664 6
new77 
(77 
ConnectivityStatus77 
.77 
Unavailable77 *
,77* +
ConnectivityReason77, >
.77> ?

NoInternet77? I
,77I J
ConnectivitySource77K ]
.77] ^
InternetProbe77^ k
)77k l
;77l m
public99 

static99 
ConnectivityIntent99 $
InternetRecovered99% 6
(996 7
)997 8
=>999 ;
new:: 
(:: 
ConnectivityStatus:: 
.:: 

Connecting:: )
,::) *
ConnectivityReason::+ =
.::= >
InternetRecovered::> O
,::O P
ConnectivitySource::Q c
.::c d
InternetProbe::d q
)::q r
;::r s
public<< 

static<< 
ConnectivityIntent<< $
ManualRetry<<% 0
(<<0 1
uint<<1 5
?<<5 6
	connectId<<7 @
=<<A B
null<<C G
)<<G H
=><<I K
new== 
(== 
ConnectivityStatus== 
.== 

Connecting== )
,==) *
ConnectivityReason==+ =
.=== >
ManualRetry==> I
,==I J
ConnectivitySource==K ]
.==] ^
ManualAction==^ j
,==j k
null==l p
,==p q
	connectId==r {
)=={ |
;==| }
public?? 

static?? 
ConnectivityIntent?? $
ServerShutdown??% 3
(??3 4
NetworkFailure??4 B
failure??C J
)??J K
=>??L N
new@@ 
(@@ 
ConnectivityStatus@@ 
.@@ 
ShuttingDown@@ +
,@@+ ,
ConnectivityReason@@- ?
.@@? @
ServerShutdown@@@ N
,@@N O
ConnectivitySource@@P b
.@@b c

DataCenter@@c m
,@@m n
failure@@o v
)@@v w
;@@w x
}AA À
ˆ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Connectivity/ConnectivityStatus.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Connectivity' 3
;3 4
public 
enum 
ConnectivityStatus 
{ 
	Connected 
, 

Connecting 
, 
Disconnected 
, 

Recovering 
, 
Unavailable		 
,		 
ShuttingDown

 
,

 
RetriesExhausted 
} Ÿ<
‹/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Messaging/Connectivity/ConnectivityPublisher.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
	Messaging &
.& '
Connectivity' 3
;3 4
internal		 
sealed			 
class		 !
ConnectivityPublisher		 +
:		, -
IDisposable		. 9
{

 
private 
readonly 
BehaviorSubject $
<$ % 
ConnectivitySnapshot% 9
>9 :
_snapshotStream; J
;J K
private 
readonly 
SemaphoreSlim "
_publishGate# /
=0 1
new2 5
(5 6
$num6 7
,7 8
$num9 :
): ;
;; <
private  
ConnectivitySnapshot  
_currentSnapshot! 1
=2 3 
ConnectivitySnapshot4 H
.H I
InitialI P
;P Q
public 
!
ConnectivityPublisher  
(  !
)! "
{ 
_snapshotStream 
= 
new 
BehaviorSubject -
<- . 
ConnectivitySnapshot. B
>B C
(C D
_currentSnapshotD T
)T U
;U V
} 
public 
 
ConnectivitySnapshot 
CurrentSnapshot  /
=>0 2
_currentSnapshot3 C
;C D
public 

IObservable 
<  
ConnectivitySnapshot +
>+ ,
ConnectivityStream- ?
=>@ B
_snapshotStreamC R
;R S
public 

async 
Task 
PublishAsync "
(" #
ConnectivityIntent# 5
intent6 <
,< =
CancellationToken> O
cancellationTokenP a
=b c
defaultd k
)k l
{ 
await 
_publishGate 
. 
	WaitAsync $
($ %
cancellationToken% 6
)6 7
.7 8
ConfigureAwait8 F
(F G
falseG L
)L M
;M N
try 
{ 	
Guid 
correlation 
= 
intent %
.% &
CORRELATION_ID& 4
??5 7
Guid8 <
.< =
NewGuid= D
(D E
)E F
;F G
ConnectivityReason 
reason %
;% &
if   
(   
intent   
.   
Reason   
==    
ConnectivityReason  ! 3
.  3 4
None  4 8
)  8 9
{!! 
reason"" 
="" 
intent"" 
.""  
Failure""  '
is""( *
not""+ .
null""/ 3
?## $
ConnectivityReasonMapper## .
.##. /
FromNetworkFailure##/ A
(##A B
intent##B H
.##H I
Failure##I P
)##P Q
:$$ 
ConnectivityReason$$ (
.$$( )
Unknown$$) 0
;$$0 1
}%% 
else&& 
{'' 
reason(( 
=(( 
intent(( 
.((  
Reason((  &
;((& '
})) 
if++ 
(++ 
reason++ 
==++ 
ConnectivityReason++ ,
.++, -
None++- 1
)++1 2
{,, 
reason-- 
=-- 
ConnectivityReason-- +
.--+ ,
Unknown--, 3
;--3 4
}..  
ConnectivitySnapshot00  
next00! %
=00& '
new00( +
(00+ ,
intent11 
.11 
Status11 
,11 
reason22 
,22 
intent33 
.33 
Source33 
,33 
intent44 
.44 
Failure44 
,44 
intent55 
.55 
	ConnectId55  
,55  !
intent66 
.66 
RetryAttempt66 #
,66# $
intent77 
.77 
RetryBackoff77 #
,77# $
correlation88 
,88 
DateTime99 
.99 
UtcNow99 
)99  
;99  !
_currentSnapshot;; 
=;; 
next;; #
;;;# $
_snapshotStream<< 
.<< 
OnNext<< "
(<<" #
next<<# '
)<<' (
;<<( )
}== 	
finally>> 
{?? 	
_publishGate@@ 
.@@ 
Release@@  
(@@  !
)@@! "
;@@" #
}AA 	
}BB 
publicDD 

voidDD 
DisposeDD 
(DD 
)DD 
{EE 
_snapshotStreamFF 
.FF 
DisposeFF 
(FF  
)FF  !
;FF! "
_publishGateGG 
.GG 
DisposeGG 
(GG 
)GG 
;GG 
}HH 
privateJJ 
staticJJ 
classJJ $
ConnectivityReasonMapperJJ 1
{KK 
publicLL 
staticLL 
ConnectivityReasonLL (
FromNetworkFailureLL) ;
(LL; <
NetworkFailureLL< J
?LLJ K
failureLLL S
)LLS T
{MM 	
ifNN 
(NN 
failureNN 
isNN 
nullNN 
)NN  
{OO 
returnPP 
ConnectivityReasonPP )
.PP) *
UnknownPP* 1
;PP1 2
}QQ 
returnSS 
failureSS 
.SS 
FailureTypeSS &
switchSS' -
{TT 
NetworkFailureTypeUU "
.UU" # 
DATA_CENTER_SHUTDOWNUU# 7
=>UU8 :
ConnectivityReasonUU; M
.UUM N
ServerShutdownUUN \
,UU\ ]
NetworkFailureTypeVV "
.VV" #
OPERATION_CANCELLEDVV# 6
=>VV7 9
ConnectivityReasonVV: L
.VVL M
OperationCancelledVVM _
,VV_ `
NetworkFailureTypeWW "
.WW" #+
CRITICAL_AUTHENTICATION_FAILUREWW# B
=>WWC E
ConnectivityReasonWWF X
.WWX Y
SecurityErrorWWY f
,WWf g
NetworkFailureTypeXX "
.XX" # 
INVALID_REQUEST_TYPEXX# 7
=>XX8 :
ConnectivityReasonXX; M
.XXM N
SecurityErrorXXN [
,XX[ \
NetworkFailureTypeYY "
.YY" #%
ECLIPTIX_PROTOCOL_FAILUREYY# <
=>YY= ?
ConnectivityReasonYY@ R
.YYR S
SecurityErrorYYS `
,YY` a
NetworkFailureTypeZZ "
.ZZ" #"
RSA_ENCRYPTION_FAILUREZZ# 9
=>ZZ: <
ConnectivityReasonZZ= O
.ZZO P
SecurityErrorZZP ]
,ZZ] ^
NetworkFailureType[[ "
.[[" ##
PROTOCOL_STATE_MISMATCH[[# :
=>[[; =
ConnectivityReason[[> P
.[[P Q
SecurityError[[Q ^
,[[^ _
NetworkFailureType\\ "
.\\" #
CONNECTION_FAILED\\# 4
=>\\5 7
ConnectivityReason\\8 J
.\\J K
HandshakeFailed\\K Z
,\\Z [
NetworkFailureType]] "
.]]" #&
DATA_CENTER_NOT_RESPONDING]]# =
=>]]> @
ConnectivityReason]]A S
.]]S T

RpcFailure]]T ^
,]]^ _
_^^ 
=>^^ 
ConnectivityReason^^ '
.^^' (
Unknown^^( /
}__ 
;__ 
}`` 	
}aa 
}bb Œ±
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Communication/ModuleMessageBus.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Communication *
;* +
public 
sealed 
class 
ModuleMessageBus $
:% &
IModuleMessageBus' 8
,8 9
IDisposable: E
{ 
private 
const 
int (
MAX_PROCESSING_TIMES_SAMPLES 2
=3 4
$num5 9
;9 :
private 
readonly  
ConcurrentDictionary )
<) *
Type* .
,. /
ConcurrentBag0 =
<= > 
IMessageSubscription> R
>R S
>S T
_subscriptionsU c
=d e
newf i
(i j
)j k
;k l
private 
readonly  
ConcurrentDictionary )
<) *
string* 0
,0 1 
TaskCompletionSource2 F
<F G
IModuleMessageG U
>U V
>V W
_pendingRequestsX h
=i j
newk n
(n o
)o p
;p q
private 
readonly 
Channel 
< 
IModuleMessage +
>+ ,
_messageChannel- <
;< =
private 
readonly 
ChannelWriter "
<" #
IModuleMessage# 1
>1 2
_messageWriter3 A
;A B
private 
readonly 
Task "
_messageProcessingTask 0
;0 1
private 
readonly #
CancellationTokenSource ,$
_cancellationTokenSource- E
=F G
newH K
(K L
)L M
;M N
private 
readonly 
ConcurrentQueue $
<$ %
double% +
>+ ,
_processingTimes- =
=> ?
new@ C
(C D
)D E
;E F
private 
long 
_totalMessagesSent #
;# $
private 
long !
_totalEventsPublished &
;& '
private 
long #
_totalRequestsProcessed (
;( )
public 

ModuleMessageBus 
( 
) 
{ 
Channel 
< 
IModuleMessage 
> 
options  '
=( )
Channel* 1
.1 2
CreateUnbounded2 A
<A B
IModuleMessageB P
>P Q
(Q R
)R S
;S T
_messageChannel 
= 
options !
;! "
_messageWriter   
=   
options    
.    !
Writer  ! '
;  ' ("
_messageProcessingTask"" 
=""   
ProcessMessagesAsync""! 5
(""5 6$
_cancellationTokenSource""6 N
.""N O
Token""O T
)""T U
;""U V
}## 
public%% 

async%% 
Task%% 
PublishAsync%% "
<%%" #
T%%# $
>%%$ %
(%%% &
T%%& '
eventMessage%%( 4
,%%4 5
CancellationToken%%6 G
cancellationToken%%H Y
=%%Z [
default%%\ c
)%%c d
where&& 
T&& 
:&& 
ModuleEvent&& 
{'' 
await(( 
_messageWriter(( 
.(( 

WriteAsync(( '
(((' (
eventMessage((( 4
,((4 5
cancellationToken((6 G
)((G H
;((H I
Interlocked)) 
.)) 
	Increment)) 
()) 
ref)) !!
_totalEventsPublished))" 7
)))7 8
;))8 9
}** 
public,, 

async,, 
Task,, 
<,, 
	TResponse,, 
?,,  
>,,  !
RequestAsync,," .
<,,. /
TRequest,,/ 7
,,,7 8
	TResponse,,9 B
>,,B C
(,,C D
TRequest-- 
request-- 
,-- 
CancellationToken.. 
cancellationToken.. +
=.., -
default... 5
)..5 6
where// 
TRequest// 
:// 
ModuleRequest// &
where00 
	TResponse00 
:00 
ModuleResponse00 (
{11  
TaskCompletionSource22 
<22 
IModuleMessage22 +
>22+ ,
tcs22- 0
=221 2
new223 6
(226 7
)227 8
;228 9
_pendingRequests33 
[33 
request33  
.33  !
	MessageId33! *
]33* +
=33, -
tcs33. 1
;331 2
try55 
{66 	
await77 
_messageWriter77  
.77  !

WriteAsync77! +
(77+ ,
request77, 3
,773 4
cancellationToken775 F
)77F G
;77G H
using99 #
CancellationTokenSource99 )

timeoutCts99* 4
=995 6#
CancellationTokenSource:: '
.::' (#
CreateLinkedTokenSource::( ?
(::? @
cancellationToken::@ Q
)::Q R
;::R S

timeoutCts;; 
.;; 
CancelAfter;; "
(;;" #
request;;# *
.;;* +
Timeout;;+ 2
);;2 3
;;;3 4
Task== 
<== 
IModuleMessage== 
>==  
responseTask==! -
===. /
tcs==0 3
.==3 4
Task==4 8
;==8 9
Task>> 
timeoutTask>> 
=>> 
Task>> #
.>># $
Delay>>$ )
(>>) *
request>>* 1
.>>1 2
Timeout>>2 9
,>>9 :

timeoutCts>>; E
.>>E F
Token>>F K
)>>K L
;>>L M
Task@@ 
completedTask@@ 
=@@  
await@@! &
Task@@' +
.@@+ ,
WhenAny@@, 3
(@@3 4
responseTask@@4 @
,@@@ A
timeoutTask@@B M
)@@M N
;@@N O
ifBB 
(BB 
completedTaskBB 
==BB  
timeoutTaskBB! ,
)BB, -
{CC 
returnDD 
nullDD 
;DD 
}EE 
IModuleMessageGG 
responseGG #
=GG$ %
awaitGG& +
responseTaskGG, 8
;GG8 9
InterlockedHH 
.HH 
	IncrementHH !
(HH! "
refHH" %#
_totalRequestsProcessedHH& =
)HH= >
;HH> ?
returnJJ 
responseJJ 
asJJ 
	TResponseJJ (
;JJ( )
}KK 	
finallyLL 
{MM 	
_pendingRequestsNN 
.NN 
	TryRemoveNN &
(NN& '
requestNN' .
.NN. /
	MessageIdNN/ 8
,NN8 9
outNN: =
_NN> ?
)NN? @
;NN@ A
}OO 	
}PP 
publicRR 

asyncRR 
TaskRR 
	SendAsyncRR 
<RR  
TRR  !
>RR! "
(RR" #
TRR# $
messageRR% ,
,RR, -
CancellationTokenRR. ?
cancellationTokenRR@ Q
=RRR S
defaultRRT [
)RR[ \
whereRR] b
TRRc d
:RRe f
IModuleMessageRRg u
{SS 
awaitTT 
_messageWriterTT 
.TT 

WriteAsyncTT '
(TT' (
messageTT( /
,TT/ 0
cancellationTokenTT1 B
)TTB C
;TTC D
InterlockedUU 
.UU 
	IncrementUU 
(UU 
refUU !
_totalMessagesSentUU" 4
)UU4 5
;UU5 6
}VV 
publicXX 

IDisposableXX 
	SubscribeXX  
<XX  !
TXX! "
>XX" #
(XX# $
FuncXX$ (
<XX( )
TXX) *
,XX* +
TaskXX, 0
>XX0 1
handlerXX2 9
)XX9 :
whereXX; @
TXXA B
:XXC D
IModuleMessageXXE S
{YY 
returnZZ 
	SubscribeZZ 
(ZZ 
_ZZ 
=>ZZ 
trueZZ "
,ZZ" #
handlerZZ$ +
)ZZ+ ,
;ZZ, -
}[[ 
public]] 

IDisposable]] 
	Subscribe]]  
<]]  !
T]]! "
>]]" #
(]]# $
Func]]$ (
<]]( )
T]]) *
,]]* +
bool]], 0
>]]0 1
filter]]2 8
,]]8 9
Func]]: >
<]]> ?
T]]? @
,]]@ A
Task]]B F
>]]F G
handler]]H O
)]]O P
where]]Q V
T]]W X
:]]Y Z
IModuleMessage]][ i
{^^ 
Type__ 
messageType__ 
=__ 
typeof__ !
(__! "
T__" #
)__# $
;__$ %
MessageSubscription`` 
<`` 
T`` 
>`` 
subscription`` +
=``, -
new``. 1
(``1 2
filter``2 8
,``8 9
handler``: A
)``A B
;``B C
_subscriptionsbb 
.bb 
AddOrUpdatebb "
(bb" #
messageTypebb# .
,bb. /
_cc 
=>cc 
[cc 
subscriptioncc 
]cc 
,cc  
(dd 
_dd 
,dd 
existingdd 
)dd 
=>dd 
{ee 
existingff 
.ff 
Addff 
(ff 
subscriptionff )
)ff) *
;ff* +
returngg 
existinggg 
;gg  
}hh 
)hh 
;hh 
returnjj 
newjj 
DisposableActionjj #
(jj# $
(jj$ %
)jj% &
=>jj' )
{kk 	
ifll 
(ll 
!ll 
_subscriptionsll 
.ll  
TryGetValuell  +
(ll+ ,
messageTypell, 7
,ll7 8
outll9 <
ConcurrentBagll= J
<llJ K 
IMessageSubscriptionllK _
>ll_ `
?ll` a
subscriptionsllb o
)llo p
)llp q
{mm 
returnnn 
;nn 
}oo 
ConcurrentBagqq 
<qq  
IMessageSubscriptionqq .
>qq. /
newBagqq0 6
=qq7 8
[qq9 :
]qq: ;
;qq; <
foreachrr 
(rr  
IMessageSubscriptionrr )
subrr* -
inrr. 0
subscriptionsrr1 >
.rr> ?
Whererr? D
(rrD E
srrE F
=>rrG I
srrJ K
!=rrL N
subscriptionrrO [
)rr[ \
)rr\ ]
{ss 
newBagtt 
.tt 
Addtt 
(tt 
subtt 
)tt 
;tt  
}uu 
_subscriptionsww 
[ww 
messageTypeww &
]ww& '
=ww( )
newBagww* 0
;ww0 1
}xx 	
)xx	 

;xx
 
}yy 
public{{ 

MessageBusStats{{ 
GetStats{{ #
({{# $
){{$ %
{|| 
int}} 
activeSubscriptions}} 
=}}  !
_subscriptions}}" 0
.}}0 1
Values}}1 7
.}}7 8
Sum}}8 ;
(}}; <
bag}}< ?
=>}}@ B
bag}}C F
.}}F G
Count}}G L
)}}L M
;}}M N
double~~ 
avgProcessingTime~~  
=~~! "
$num~~# $
;~~$ %
if
€€ 

(
€€ 
_processingTimes
€€ 
.
€€ 
Count
€€ "
>
€€# $
$num
€€% &
)
€€& '
{
 	
avgProcessingTime
‚‚ 
=
‚‚ 
_processingTimes
‚‚  0
.
‚‚0 1
ToArray
‚‚1 8
(
‚‚8 9
)
‚‚9 :
.
‚‚: ;
Average
‚‚; B
(
‚‚B C
)
‚‚C D
;
‚‚D E
}
ƒƒ 	
return
…… 
new
…… 
MessageBusStats
…… "
{
†† 	!
ActiveSubscriptions
‡‡ 
=
‡‡  !!
activeSubscriptions
‡‡" 5
,
‡‡5 6
TotalMessagesSent
ˆˆ 
=
ˆˆ 
Interlocked
ˆˆ  +
.
ˆˆ+ ,
Read
ˆˆ, 0
(
ˆˆ0 1
ref
ˆˆ1 4 
_totalMessagesSent
ˆˆ5 G
)
ˆˆG H
,
ˆˆH I"
TotalEventsPublished
‰‰  
=
‰‰! "
Interlocked
‰‰# .
.
‰‰. /
Read
‰‰/ 3
(
‰‰3 4
ref
‰‰4 7#
_totalEventsPublished
‰‰8 M
)
‰‰M N
,
‰‰N O$
TotalRequestsProcessed
ŠŠ "
=
ŠŠ# $
Interlocked
ŠŠ% 0
.
ŠŠ0 1
Read
ŠŠ1 5
(
ŠŠ5 6
ref
ŠŠ6 9%
_totalRequestsProcessed
ŠŠ: Q
)
ŠŠQ R
,
ŠŠR S%
AverageProcessingTimeMs
‹‹ #
=
‹‹$ %
avgProcessingTime
‹‹& 7
,
‹‹7 8
PendingRequests
ŒŒ 
=
ŒŒ 
_pendingRequests
ŒŒ .
.
ŒŒ. /
Count
ŒŒ/ 4
}
 	
;
	 

}
ŽŽ 
private
 
async
 
Task
 "
ProcessMessagesAsync
 +
(
+ ,
CancellationToken
, =
cancellationToken
> O
)
O P
{
‘‘ 
await
’’ 
foreach
’’ 
(
’’ 
IModuleMessage
’’ %
message
’’& -
in
’’. 0
_messageChannel
’’1 @
.
’’@ A
Reader
’’A G
.
’’G H
ReadAllAsync
’’H T
(
’’T U
cancellationToken
’’U f
)
’’f g
)
’’g h
{
““ 	
DateTime
”” 
	startTime
”” 
=
””  
DateTime
””! )
.
””) *
UtcNow
””* 0
;
””0 1
try
–– 
{
—— 
await
˜˜ '
ProcessSingleMessageAsync
˜˜ /
(
˜˜/ 0
message
˜˜0 7
)
˜˜7 8
;
˜˜8 9
}
™™ 
catch
šš 
(
šš 
	Exception
šš 
ex
šš 
)
šš  
{
›› 
Serilog
œœ 
.
œœ 
Log
œœ 
.
œœ 
Error
œœ !
(
œœ! "
ex
œœ" $
,
œœ$ %
$str
œœ& k
,
œœk l
message
 
?
 
.
 
GetType
 $
(
$ %
)
% &
.
& '
Name
' +
??
, .
$str
/ 8
)
8 9
;
9 :
}
žž 
finally
ŸŸ 
{
   
double
¡¡ 
processingTime
¡¡ %
=
¡¡& '
(
¡¡( )
DateTime
¡¡) 1
.
¡¡1 2
UtcNow
¡¡2 8
-
¡¡9 :
	startTime
¡¡; D
)
¡¡D E
.
¡¡E F
TotalMilliseconds
¡¡F W
;
¡¡W X"
RecordProcessingTime
¢¢ $
(
¢¢$ %
processingTime
¢¢% 3
)
¢¢3 4
;
¢¢4 5
}
££ 
}
¤¤ 	
}
¥¥ 
private
§§ 
async
§§ 
Task
§§ '
ProcessSingleMessageAsync
§§ 0
(
§§0 1
IModuleMessage
§§1 ?
message
§§@ G
)
§§G H
{
¨¨ 
if
©© 

(
©© 
message
©© 
is
©© 
ModuleResponse
©© %
response
©©& .
&&
©©/ 1
!
ªª 
string
ªª 
.
ªª 
IsNullOrEmpty
ªª !
(
ªª! "
response
ªª" *
.
ªª* +
CORRELATION_ID
ªª+ 9
)
ªª9 :
&&
ªª; =
_pendingRequests
«« 
.
«« 
TryGetValue
«« (
(
««( )
response
««) 1
.
««1 2
CORRELATION_ID
««2 @
,
««@ A
out
««B E"
TaskCompletionSource
««F Z
<
««Z [
IModuleMessage
««[ i
>
««i j
?
««j k
tcs
««l o
)
««o p
)
««p q
{
¬¬ 	
tcs
­­ 
.
­­ 
	SetResult
­­ 
(
­­ 
response
­­ "
)
­­" #
;
­­# $
return
®® 
;
®® 
}
¯¯ 	
Type
±± 
messageType
±± 
=
±± 
typeof
±± !
(
±±! "
IModuleMessage
±±" 0
)
±±0 1
;
±±1 2
List
²² 
<
²² 
Task
²² 
>
²² 
handlerTasks
²² 
=
²²  !
[
²²" #
]
²²# $
;
²²$ %
if
´´ 

(
´´ 
_subscriptions
´´ 
.
´´ 
TryGetValue
´´ &
(
´´& '
messageType
´´' 2
,
´´2 3
out
´´4 7
ConcurrentBag
´´8 E
<
´´E F"
IMessageSubscription
´´F Z
>
´´Z [
?
´´[ \
subscriptions
´´] j
)
´´j k
)
´´k l
{
µµ 	
foreach
¶¶ 
(
¶¶ "
IMessageSubscription
¶¶ )
subscription
¶¶* 6
in
¶¶7 9
subscriptions
¶¶: G
)
¶¶G H
{
·· 
try
¸¸ 
{
¹¹ 
Task
ºº 
handlerTask
ºº $
=
ºº% &
subscription
ºº' 3
.
ºº3 4
HandleAsync
ºº4 ?
(
ºº? @
message
ºº@ G
)
ººG H
;
ººH I
handlerTasks
»»  
.
»»  !
Add
»»! $
(
»»$ %
handlerTask
»»% 0
)
»»0 1
;
»»1 2
}
¼¼ 
catch
½½ 
(
½½ 
	Exception
½½  
ex
½½! #
)
½½# $
{
¾¾ 
Serilog
¿¿ 
.
¿¿ 
Log
¿¿ 
.
¿¿  
Error
¿¿  %
(
¿¿% &
ex
¿¿& (
,
¿¿( )
$str¿¿* ˆ
,¿¿ˆ ‰
messageType
ÀÀ #
.
ÀÀ# $
Name
ÀÀ$ (
)
ÀÀ( )
;
ÀÀ) *
}
ÁÁ 
}
ÂÂ 
}
ÃÃ 	
if
ÅÅ 

(
ÅÅ 
handlerTasks
ÅÅ 
.
ÅÅ 
Count
ÅÅ 
>
ÅÅ  
$num
ÅÅ! "
)
ÅÅ" #
{
ÆÆ 	
await
ÇÇ 
Task
ÇÇ 
.
ÇÇ 
WhenAll
ÇÇ 
(
ÇÇ 
handlerTasks
ÇÇ +
)
ÇÇ+ ,
;
ÇÇ, -
}
ÈÈ 	
}
ÉÉ 
private
ËË 
void
ËË "
RecordProcessingTime
ËË %
(
ËË% &
double
ËË& ,
processingTimeMs
ËË- =
)
ËË= >
{
ÌÌ 
_processingTimes
ÍÍ 
.
ÍÍ 
Enqueue
ÍÍ  
(
ÍÍ  !
processingTimeMs
ÍÍ! 1
)
ÍÍ1 2
;
ÍÍ2 3
while
ÏÏ 
(
ÏÏ 
_processingTimes
ÏÏ 
.
ÏÏ  
Count
ÏÏ  %
>
ÏÏ& '*
MAX_PROCESSING_TIMES_SAMPLES
ÏÏ( D
)
ÏÏD E
{
ÐÐ 	
_processingTimes
ÑÑ 
.
ÑÑ 

TryDequeue
ÑÑ '
(
ÑÑ' (
out
ÑÑ( +
_
ÑÑ, -
)
ÑÑ- .
;
ÑÑ. /
}
ÒÒ 	
}
ÓÓ 
public
ÕÕ 

void
ÕÕ 
Dispose
ÕÕ 
(
ÕÕ 
)
ÕÕ 
{
ÖÖ &
_cancellationTokenSource
××  
.
××  !
Cancel
××! '
(
××' (
)
××( )
;
××) *
_messageWriter
ØØ 
.
ØØ 
Complete
ØØ 
(
ØØ  
)
ØØ  !
;
ØØ! "
try
ÚÚ 
{
ÛÛ 	$
_messageProcessingTask
ÜÜ "
.
ÜÜ" #
Wait
ÜÜ# '
(
ÜÜ' (
TimeSpan
ÜÜ( 0
.
ÜÜ0 1
FromSeconds
ÜÜ1 <
(
ÜÜ< =
$num
ÜÜ= >
)
ÜÜ> ?
)
ÜÜ? @
;
ÜÜ@ A
}
ÝÝ 	
catch
ÞÞ 
(
ÞÞ 
TimeoutException
ÞÞ 
ex
ÞÞ  "
)
ÞÞ" #
{
ßß 	
Serilog
àà 
.
àà 
Log
àà 
.
àà 
Warning
àà 
(
àà  
ex
àà  "
,
àà" #
$stràà$ ‚
)àà‚ ƒ
;ààƒ „
}
áá 	
catch
ââ 
(
ââ  
AggregateException
ââ !
ex
ââ" $
)
ââ$ %
when
ââ& *
(
ââ+ ,
ex
ââ, .
.
ââ. /
InnerException
ââ/ =
is
ââ> @(
OperationCanceledException
ââA [
)
ââ[ \
{
ãã 	
}
åå 	
catch
ææ 
(
ææ 
	Exception
ææ 
ex
ææ 
)
ææ 
{
çç 	
Serilog
èè 
.
èè 
Log
èè 
.
èè 
Error
èè 
(
èè 
ex
èè  
,
èè  !
$str
èè" b
)
èèb c
;
èèc d
}
éé 	&
_cancellationTokenSource
ëë  
.
ëë  !
Dispose
ëë! (
(
ëë( )
)
ëë) *
;
ëë* +
}
ìì 
}íí 
internalïï 
	interface
ïï	 "
IMessageSubscription
ïï '
{ðð 
Task
ññ 
HandleAsync
ññ	 
(
ññ 
IModuleMessage
ññ #
message
ññ$ +
)
ññ+ ,
;
ññ, -
}òò 
internalôô 
sealed
ôô	 
class
ôô !
MessageSubscription
ôô )
<
ôô) *
T
ôô* +
>
ôô+ ,
(
ôô, -
Func
ôô- 1
<
ôô1 2
T
ôô2 3
,
ôô3 4
bool
ôô5 9
>
ôô9 :
filter
ôô; A
,
ôôA B
Func
ôôC G
<
ôôG H
T
ôôH I
,
ôôI J
Task
ôôK O
>
ôôO P
handler
ôôQ X
)
ôôX Y
:
ôôZ ["
IMessageSubscription
ôô\ p
where
õõ 	
T
õõ
 
:
õõ 
IModuleMessage
õõ 
{öö 
public
÷÷ 

async
÷÷ 
Task
÷÷ 
HandleAsync
÷÷ !
(
÷÷! "
IModuleMessage
÷÷" 0
message
÷÷1 8
)
÷÷8 9
{
øø 
if
ùù 

(
ùù 
message
ùù 
is
ùù 
T
ùù 
typedMessage
ùù %
&&
ùù& (
filter
ùù) /
(
ùù/ 0
typedMessage
ùù0 <
)
ùù< =
)
ùù= >
{
úú 	
await
ûû 
handler
ûû 
(
ûû 
typedMessage
ûû &
)
ûû& '
;
ûû' (
}
üü 	
}
ýý 
}þþ ª
{/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Communication/CommonMessages.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Communication *
;* +
public 
record "
ModuleInitializedEvent $
:% &
ModuleEvent' 2
{ 
public 

override 
string 
MessageType &
=>' )
$str* >
;> ?
public 

string 

ModuleName 
{ 
get "
;" #
init$ (
;( )
}* +
=, -
string. 4
.4 5
Empty5 :
;: ;
} „
|/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/ModuleIdentifier.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
enum 
ModuleIdentifier 
{ 
Authentication 
, 
Main 
, 	
Settings		 
,		 
}

 
public 
static 
class &
ModuleIdentifierExtensions .
{ 
public 

static 
string 
ToName 
(  
this  $
ModuleIdentifier% 5

identifier6 @
)@ A
=>B D

identifierE O
switchP V
{ 
ModuleIdentifier 
. 
Authentication '
=>( *
$str+ ;
,; <
ModuleIdentifier 
. 
Main 
=>  
$str! '
,' (
ModuleIdentifier 
. 
Settings !
=>" $
$str% /
,/ 0
_ 	
=>
 
throw 
new '
ArgumentOutOfRangeException 2
(2 3
nameof3 9
(9 :

identifier: D
)D E
,E F

identifierG Q
,Q R
$strS n
)n o
} 
; 
} õ
x/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IViewLocator.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IViewLocator 
{		 
void

 
Register

	 
<

 

TViewModel

 
,

 
TView

 #
>

# $
(

$ %
)

% &
where 

TViewModel 
: 
class  
,  !
IRoutableViewModel" 4
where 
TView 
: 
class 
, 
new  
(  !
)! "
;" #
void 
RegisterFactory	 
< 

TViewModel #
># $
($ %
Func% )
<) *
object* 0
>0 1
factory2 9
)9 :
where 

TViewModel 
: 
class  
,  !
IRoutableViewModel" 4
;4 5
Option 

<
 
object 
> 
ResolveView 
< 

TViewModel )
>) *
(* +

TViewModel+ 5
?5 6
	viewModel7 @
=A B
nullC G
)G H
where 

TViewModel 
: 
class  
,  !
IRoutableViewModel" 4
;4 5
Option 

<
 
object 
> 
ResolveView 
( 
object %
?% &
	viewModel' 0
)0 1
;1 2
bool 
IsRegistered	 
< 

TViewModel  
>  !
(! "
)" #
where$ )

TViewModel* 4
:5 6
class7 <
,< =
IRoutableViewModel> P
;P Q
bool 
IsRegistered	 
( 
Type 
viewModelType (
)( )
;) *
IReadOnlyDictionary 
< 
Type 
, 
Func "
<" #
object# )
>) *
>* +
GetRegistrations, <
(< =
)= >
;> ?
} Ñ
w/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IResettable.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IResettable 
{ 
void 

ResetState	 
( 
) 
; 
} Ç
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModuleViewFactory.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModuleViewFactory #
{ 
void		 
RegisterView			 
<		 

TViewModel		  
,		  !
TView		" '
>		' (
(		( )
)		) *
where

 

TViewModel

 
:

 
class

  
where 
TView 
: 
Control 
, 
new "
(" #
)# $
;$ %
Option 

<
 
Control 
> 

CreateView 
( 
Type #
viewModelType$ 1
)1 2
;2 3
} ‡
x/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModuleScope.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModuleScope 
: 
IDisposable  +
{ 
IServiceProvider 
ServiceProvider $
{% &
get' *
;* +
}, -
string 


ModuleName 
{ 
get 
; 
} 
}		 Î
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModuleMessageBus.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModuleMessageBus "
{ 
Task 
PublishAsync	 
< 
T 
> 
( 
T 
eventMessage '
,' (
CancellationToken) :
cancellationToken; L
=M N
defaultO V
)V W
where		 
T		 
:		 
ModuleEvent		 
;		 
Task 
< 	
	TResponse	 
? 
> 
RequestAsync !
<! "
TRequest" *
,* +
	TResponse, 5
>5 6
(6 7
TRequest 
request 
, 
CancellationToken 
cancellationToken +
=, -
default. 5
)5 6
where 
TRequest 
: 
ModuleRequest &
where 
	TResponse 
: 
ModuleResponse (
;( )
Task 
	SendAsync	 
< 
T 
> 
( 
T 
message 
,  
CancellationToken! 2
cancellationToken3 D
=E F
defaultG N
)N O
where 
T 
: 
IModuleMessage  
;  !
IDisposable 
	Subscribe 
< 
T 
> 
( 
Func !
<! "
T" #
,# $
Task% )
>) *
handler+ 2
)2 3
where4 9
T: ;
:< =
IModuleMessage> L
;L M
IDisposable 
	Subscribe 
< 
T 
> 
( 
Func !
<! "
T" #
,# $
bool% )
>) *
filter+ 1
,1 2
Func3 7
<7 8
T8 9
,9 :
Task; ?
>? @
handlerA H
)H I
whereJ O
TP Q
:R S
IModuleMessageT b
;b c
MessageBusStats 
GetStats 
( 
) 
; 
} 
public 
record 
MessageBusStats 
{ 
public 

int 
ActiveSubscriptions "
{# $
get% (
;( )
init* .
;. /
}0 1
public 

long 
TotalMessagesSent !
{" #
get$ '
;' (
init) -
;- .
}/ 0
public 

long  
TotalEventsPublished $
{% &
get' *
;* +
init, 0
;0 1
}2 3
public   

long   "
TotalRequestsProcessed   &
{  ' (
get  ) ,
;  , -
init  . 2
;  2 3
}  4 5
public!! 

double!! #
AverageProcessingTimeMs!! )
{!!* +
get!!, /
;!!/ 0
init!!1 5
;!!5 6
}!!7 8
public"" 

int"" 
PendingRequests"" 
{""  
get""! $
;""$ %
init""& *
;""* +
}"", -
}## ÿ
z/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModuleMessage.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModuleMessage 
{ 
string 

	MessageId 
{ 
get 
; 
} 
string		 

SourceModule		 
{		 
get		 
;		 
}		  
string 

?
 
TargetModule 
{ 
get 
; 
}  !
DateTime 
	Timestamp 
{ 
get 
; 
} 
string 

MessageType 
{ 
get 
; 
} 
string 

?
 
CORRELATION_ID 
{ 
get  
;  !
}" #
} 
public 
abstract 
record 
ModuleMessage $
:% &
IModuleMessage' 5
{ 
public 

string 
	MessageId 
{ 
get !
;! "
init# '
;' (
}) *
=+ ,
Guid- 1
.1 2
NewGuid2 9
(9 :
): ;
.; <
ToString< D
(D E
)E F
;F G
public 

string 
SourceModule 
{  
get! $
;$ %
init& *
;* +
}, -
=. /
string0 6
.6 7
Empty7 <
;< =
public 

string 
? 
TargetModule 
{  !
get" %
;% &
init' +
;+ ,
}- .
public 

DateTime 
	Timestamp 
{ 
get  #
;# $
init% )
;) *
}+ ,
=- .
DateTime/ 7
.7 8
UtcNow8 >
;> ?
public 

abstract 
string 
MessageType &
{' (
get) ,
;, -
}. /
public 

string 
? 
CORRELATION_ID !
{" #
get$ '
;' (
init) -
;- .
}/ 0
} 
public 
abstract 
record 
ModuleRequest $
:% &
ModuleMessage' 4
{ 
public 

TimeSpan 
Timeout 
{ 
get !
;! "
init# '
;' (
}) *
=+ ,
TimeSpan- 5
.5 6
FromSeconds6 A
(A B
$numB D
)D E
;E F
}   
public!! 
abstract!! 
record!! 
ModuleResponse!! %
:!!& '
ModuleMessage!!( 5
{"" 
public$$ 

bool$$ 
	IsSuccess$$ 
{$$ 
get$$ 
;$$  
init$$! %
;$$% &
}$$' (
public&& 

string&& 
?&& 
ErrorMessage&& 
{&&  !
get&&" %
;&&% &
init&&' +
;&&+ ,
}&&- .
}'' 
public(( 
abstract(( 
record(( 
ModuleEvent(( "
:((# $
ModuleMessage((% 2
{)) 
public** 


Dictionary** 
<** 
string** 
,** 
object** $
>**$ %
	EventData**& /
{**0 1
get**2 5
;**5 6
init**7 ;
;**; <
}**= >
=**? @
new**A D
(**D E
)**E F
;**F G
}++ ¡
{/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModuleManifest.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModuleManifest  
{ 
int 
Priority 
{ 
get 
; 
} !
ModuleLoadingStrategy 
LoadingStrategy )
{* +
get, /
;/ 0
}1 2
IReadOnlyList

 
<

 
ModuleIdentifier

 "
>

" #
Dependencies

$ 0
{

1 2
get

3 6
;

6 7
}

8 9
bool 
CanLoad	 
( 
) 
; 
} 
public 
record 
ModuleManifest 
( 
int 
Priority 
, !
ModuleLoadingStrategy 
LoadingStrategy )
,) *
IReadOnlyList 
< 
ModuleIdentifier "
>" #
Dependencies$ 0
) 
: 
IModuleManifest 
{ 
public 

virtual 
bool 
CanLoad 
(  
)  !
=>" $
true% )
;) *
} Ù
z/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModuleManager.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModuleManager 
{ 
Task 
< 	
Option	 
< 
IModule 
> 
> 
LoadModuleAsync )
() *
string* 0

moduleName1 ;
); <
;< =
Task		 !
LoadEagerModulesAsync			 
(		 
)		  
;		  !
Task

 
UnloadModuleAsync

	 
(

 
string

 !

moduleName

" ,
)

, -
;

- .
} ½
s/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Core/Abstractions/IModule.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Core 
. 
Abstractions )
;) *
public 
	interface 
IModule 
{ 
ModuleIdentifier 
Id 
{ 
get 
; 
}  
IModuleManifest		 
Manifest		 
{		 
get		 "
;		" #
}		$ %
bool

 
IsLoaded

	 
{

 
get

 
;

 
}

 
IModuleScope 
? 
ServiceScope 
{  
get! $
;$ %
}& '
Task 
< 	
bool	 
> 
CanLoadAsync 
( 
) 
; 
Task 
	LoadAsync	 
( 
IServiceProvider #
serviceProvider$ 3
)3 4
;4 5
Task 
UnloadAsync	 
( 
) 
; 
Task %
SetupMessageHandlersAsync	 "
(" #
IModuleMessageBus# 4

messageBus5 ?
)? @
;@ A
} 
public 
	interface 
ITypedModule 
< 
out !
	TManifest" +
>+ ,
:- .
IModule/ 6
where7 <
	TManifest= F
:G H
IModuleManifestI X
{ 
new 
	TManifest 
Manifest 
{ 
get  
;  !
}" #
} 
public 
enum !
ModuleLoadingStrategy !
{ 
Eager 	
,	 

Lazy 
, 	

Background 
} 
public!! 
enum!! 
ModuleState!! 
{"" 
	NotLoaded## 
,## 
Loading$$ 
,$$ 
Loaded%% 

,%%
 
Failed&& 

,&&
 
	Unloading'' 
,'' 
Unloaded(( 
})) û
ƒ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/UserRequestErrorViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
;' (
public 
sealed 
class %
UserRequestErrorViewModel -
:. /
ReactiveObject0 >
,> ?!
IActivatableViewModel@ U
{		 
public

 

ViewModelActivator

 
	Activator

 '
{

( )
get

* -
;

- .
}

/ 0
=

1 2
new

3 6
(

6 7
)

7 8
;

8 9
public 
%
UserRequestErrorViewModel $
($ %
string% +
errorMessage, 8
,8 9 
ILocalizationService: N
localizationServiceO b
)b c
{ 
_ 	
=
 
localizationService 
??  "
throw# (
new) ,!
ArgumentNullException- B
(B C
nameofC I
(I J
localizationServiceJ ]
)] ^
)^ _
;_ `
ErrorMessage 
= 
string 
. 
IsNullOrWhiteSpace 0
(0 1
errorMessage1 =
)= >
? 
localizationService !
[! "
LocalizationKeys" 2
.2 3
Common3 9
.9 :
UNEXPECTED_ERROR: J
]J K
: 
errorMessage 
; 
} 
public 

string 
ErrorMessage 
{  
get! $
;$ %
}& '
} ‹
„/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/UserRequestErrorView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
;' (
public 
partial 
class  
UserRequestErrorView )
:* +
ReactiveUserControl, ?
<? @)
RedirectNotificationViewModel@ ]
>] ^
{ 
public 
 
UserRequestErrorView 
(  
)  !
{		 
AvaloniaXamlLoader

 
.

 
Load

 
(

  
this

  $
)

$ %
;

% &
} 
} ÷H
‡/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/RedirectNotificationViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
;' (
public 
sealed 
class )
RedirectNotificationViewModel 1
:2 3
ReactiveObject4 B
,B C
IDisposableD O
,O P!
IActivatableViewModelQ f
{ 
public 

ViewModelActivator 
	Activator '
{( )
get* -
;- .
}/ 0
=1 2
new3 6
(6 7
)7 8
;8 9
private 
readonly  
ILocalizationService ) 
_localizationService* >
;> ?
private 
string 
? &
_cachedRedirectingTemplate .
;. /
private 
bool 
	_disposed 
= 
false "
;" #
[ 
Reactive 
] 
public 
string 
Message $
{% &
get' *
;* +
set, /
;/ 0
}1 2
[ 
Reactive 
] 
public 
double 
Progress %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
=4 5
$num6 7
;7 8
[ 
Reactive 
] 
public 
string 
CountdownText *
{+ ,
get- 0
;0 1
set2 5
;5 6
}7 8
public 
)
RedirectNotificationViewModel (
(( )
string 
message 
, 
int 
totalSeconds 
, 
Action 

onComplete 
,  
ILocalizationService 
localizationService 0
)0 1
{  
_localizationService 
= 
localizationService 2
;2 3
Message   
=   
message   
;   
int!! 
remainingSeconds!! 
=!! 
totalSeconds!! +
;!!+ ,
Progress"" 
="" 
$num"" 
;"" 
CountdownText## 
=## $
GetCachedRedirectingText## 0
(##0 1
remainingSeconds##1 A
)##A B
;##B C
this%% 
.%% 
WhenActivated%% 
(%% 
disposables%% &
=>%%' )
{&& 	
	Stopwatch'' 
	stopwatch'' 
=''  !
	Stopwatch''" +
.''+ ,
StartNew'', 4
(''4 5
)''5 6
;''6 7
IObservable)) 
<)) 
Unit)) 
>)) 
languageTrigger)) -
=)). /

Observable))0 :
.)): ;
	FromEvent)); D
())D E
handler** 
=>**  
_localizationService** 3
.**3 4
LanguageChanged**4 C
+=**D F
handler**G N
,**N O
handler++ 
=>++  
_localizationService++ 3
.++3 4
LanguageChanged++4 C
-=++D F
handler++G N
)++N O
.,,  
DistinctUntilChanged,, %
(,,% &
),,& '
.-- 
Select-- 
(-- 
_-- 
=>-- 
Unit-- !
.--! "
Default--" )
)--) *
... 
	StartWith.. 
(.. 
Unit.. 
...  
Default..  '
)..' (
;..( )
languageTrigger00 
.11 
Skip11 
(11 
$num11 
)11 
.22 
	Subscribe22 
(22 
_22 
=>22 
ClearStringCache22  0
(220 1
)221 2
)222 3
.33 
DisposeWith33 
(33 
disposables33 (
)33( )
;33) *

Observable55 
.55 
Interval55 
(55  
TimeSpan55  (
.55( )
FromMilliseconds55) 9
(559 :
$num55: ;
)55; <
)55< =
.66 
	StartWith66 !
(66! "
$num66" #
)66# $
.77 
	ObserveOn77 !
(77! "
RxApp77" '
.77' (
MainThreadScheduler77( ;
)77; <
.88 
	Subscribe88 !
(88! "
_88" #
=>88$ &
{99 
double:: !
elapsed::" )
=::* +
	stopwatch::, 5
.::5 6
Elapsed::6 =
.::= >
TotalSeconds::> J
;::J K
Progress;; #
=;;$ %
Math;;& *
.;;* +
Min;;+ .
(;;. /
$num;;/ 4
,;;4 5
(;;6 7
elapsed;;7 >
/;;? @
totalSeconds;;A M
);;M N
*;;O P
$num;;Q V
);;V W
;;;W X
}<< 
)<< 
.== 
DisposeWith== #
(==# $
disposables==$ /
)==/ 0
;==0 1

Observable>> 
.>> 
Interval>> 
(>>  
TimeSpan>>  (
.>>( )
FromSeconds>>) 4
(>>4 5
$num>>5 6
)>>6 7
)>>7 8
.?? 
	StartWith?? 
(?? 
$num?? 
)?? 
.@@ 
	ObserveOn@@ 
(@@ 
RxApp@@  
.@@  !
MainThreadScheduler@@! 4
)@@4 5
.AA 
	SubscribeAA 
(AA 
_AA 
=>AA 
{BB 
doubleCC 
elapsedCC "
=CC# $
	stopwatchCC% .
.CC. /
ElapsedCC/ 6
.CC6 7
TotalSecondsCC7 C
;CCC D
intDD 
newRemainingDD $
=DD% &
MathDD' +
.DD+ ,
MaxDD, /
(DD/ 0
$numDD0 1
,DD1 2
(DD3 4
intDD4 7
)DD7 8
MathDD8 <
.DD< =
CeilingDD= D
(DDD E
totalSecondsDDE Q
-DDR S
elapsedDDT [
)DD[ \
)DD\ ]
;DD] ^
ifEE 
(EE 
newRemainingEE $
!=EE% '
remainingSecondsEE( 8
)EE8 9
{FF 
remainingSecondsGG (
=GG) *
newRemainingGG+ 7
;GG7 8
CountdownTextHH %
=HH& '$
GetCachedRedirectingTextHH( @
(HH@ A
remainingSecondsHHA Q
)HHQ R
;HHR S
}II 
}JJ 
)JJ 
.KK 
DisposeWithKK 
(KK 
disposablesKK (
)KK( )
;KK) *

ObservableLL 
.LL 
TimerLL 
(LL 
TimeSpanLL %
.LL% &
FromSecondsLL& 1
(LL1 2
totalSecondsLL2 >
)LL> ?
)LL? @
.MM 
	ObserveOnMM 
(MM 
RxAppMM  
.MM  !
MainThreadSchedulerMM! 4
)MM4 5
.NN 
	SubscribeNN 
(NN 
_NN 
=>NN 
{OO 
ProgressPP 
=PP 
$numPP $
;PP$ %
CountdownTextQQ !
=QQ" #$
GetCachedRedirectingTextQQ$ <
(QQ< =
$numQQ= >
)QQ> ?
;QQ? @

onCompleteRR 
(RR 
)RR  
;RR  !
}SS 
)SS 
.TT 
DisposeWithTT 
(TT 
disposablesTT (
)TT( )
;TT) *

DisposableUU 
.UU 
CreateUU 
(UU 
(UU 
)UU  
=>UU! #
	stopwatchUU$ -
.UU- .
StopUU. 2
(UU2 3
)UU3 4
)UU4 5
.UU5 6
DisposeWithUU6 A
(UUA B
disposablesUUB M
)UUM N
;UUN O
}WW 	
)WW	 

;WW
 
}XX 
privateZZ 
voidZZ 
ClearStringCacheZZ !
(ZZ! "
)ZZ" #
{[[ &
_cachedRedirectingTemplate\\ "
=\\# $
null\\% )
;\\) *
}]] 
private__ 
string__ $
GetCachedRedirectingText__ +
(__+ ,
int__, /
seconds__0 7
)__7 8
{`` &
_cachedRedirectingTemplateaa "
??=aa# & 
_localizationServiceaa' ;
[aa; <#
AuthenticationConstantsaa< S
.aaS T&
REDIRECTING_IN_SECONDS_KEYaaT n
]aan o
;aao p
returnbb 
stringbb 
.bb 
Formatbb 
(bb &
_cachedRedirectingTemplatebb 7
,bb7 8
secondsbb9 @
)bb@ A
;bbA B
}cc 
publicee 

voidee 
Disposeee 
(ee 
)ee 
{ff 
ifgg 

(gg 
	_disposedgg 
)gg 
{hh 	
returnii 
;ii 
}jj 	
	_disposedll 
=ll 
truell 
;ll 
}mm 
}nn —
ˆ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/RedirectNotificationView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
;' (
public 
partial 
class $
RedirectNotificationView -
:. /
ReactiveUserControl0 C
<C D)
RedirectNotificationViewModelD a
>a b
{ 
public 
$
RedirectNotificationView #
(# $
)$ %
{		 
AvaloniaXamlLoader

 
.

 
Load

 
(

  
this

  $
)

$ %
;

% &
} 
} ûB
‡/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/DetectLanguageDialogViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
;' (
public 
sealed 
class )
DetectLanguageDialogViewModel 1
:2 3
ReactiveObject4 B
,B C
IDisposableD O
,O P!
IActivatableViewModelQ f
{ 
private 
readonly %
ILanguageDetectionService .%
_languageDetectionService/ H
;H I
public 

ViewModelActivator 
	Activator '
{( )
get* -
;- .
}/ 0
=1 2
new3 6
(6 7
)7 8
;8 9
private 
bool 
	_disposed 
; 
public 

string 
Title 
{ 
get 
; 
}  
public 

string 

PromptText 
{ 
get "
;" #
}$ %
public 

string 
ConfirmButtonText #
{$ %
get& )
;) *
}+ ,
public 

string 
DeclineButtonText #
{$ %
get& )
;) *
}+ ,
public 

string 
FlagPath 
{ 
get  
;  !
}" #
private 
readonly 
string 
_targetCulture *
;* +
public!! 

ReactiveCommand!! 
<!! 
Unit!! 
,!!  
Unit!!! %
>!!% &
ConfirmCommand!!' 5
{!!6 7
get!!8 ;
;!!; <
}!!= >
public"" 

ReactiveCommand"" 
<"" 
Unit"" 
,""  
Unit""! %
>""% &
DeclineCommand""' 5
{""6 7
get""8 ;
;""; <
}""= >
private$$ 
static$$ 
readonly$$ 
AppCultureSettings$$ .
LanguageConfig$$/ =
=$$> ?
AppCultureSettings$$@ R
.$$R S
Default$$S Z
;$$Z [
public'' 
)
DetectLanguageDialogViewModel'' (
(''( ) 
ILocalizationService(( 
localizationService(( 0
,((0 1%
ILanguageDetectionService)) !$
languageDetectionService))" :
,)): ;
NetworkProvider** 
networkProvider** '
)++ 	
{,, %
_languageDetectionService-- !
=--" #$
languageDetectionService--$ <
;--< =
ConfirmCommand// 
=// 
ReactiveCommand// (
.//( )
CreateFromTask//) 7
(//7 8
	OnConfirm//8 A
)//A B
;//B C
DeclineCommand00 
=00 
ReactiveCommand00 (
.00( )
CreateFromTask00) 7
(007 8
	OnDecline008 A
)00A B
;00B C
string22 
country22 
=22 
networkProvider22 (
.22( )'
ApplicationInstanceSettings22) D
.22D E
Country22E L
;22L M
if44 

(44 
string44 
.44 
IsNullOrWhiteSpace44 %
(44% &
country44& -
)44- .
)44. /
{55 	
_targetCulture66 
=66 
CultureInfo66 (
.66( )
CurrentCulture66) 7
.667 8
Name668 <
;66< =
}77 	
else88 
{99 	
_targetCulture:: 
=:: 
LanguageConfig:: +
.::+ ,
GetCultureByCountry::, ?
(::? @
country::@ G
)::G H
??::I K
CultureInfo::L W
.::W X
CurrentCulture::X f
.::f g
Name::g k
;::k l
};; 	
CultureInfo== 

targetInfo== 
;== 
try>> 
{?? 	

targetInfo@@ 
=@@ 
CultureInfo@@ $
.@@$ %
GetCultureInfo@@% 3
(@@3 4
_targetCulture@@4 B
)@@B C
;@@C D
}AA 	
catchBB 
(BB $
CultureNotFoundExceptionBB '
)BB' (
{CC 	

targetInfoDD 
=DD 
CultureInfoDD $
.DD$ %
CurrentCultureDD% 3
;DD3 4
_targetCultureEE 
=EE 

targetInfoEE '
.EE' (
NameEE( ,
;EE, -
}FF 	
stringHH 
languageNameHH 
=HH 

targetInfoHH (
.HH( )
DisplayNameHH) 4
;HH4 5
intII 
parenthesisIndexII 
=II 
languageNameII +
.II+ ,
IndexOfII, 3
(II3 4
$charII4 7
)II7 8
;II8 9
ifJJ 

(JJ 
parenthesisIndexJJ 
>JJ 
$numJJ  
)JJ  !
{KK 	
languageNameLL 
=LL 
languageNameLL '
.LL' (
	SubstringLL( 1
(LL1 2
$numLL2 3
,LL3 4
parenthesisIndexLL5 E
)LLE F
.LLF G
TrimLLG K
(LLK L
)LLL M
;LLM N
}MM 	
TitleOO 
=OO 
localizationServiceOO #
?OO# $
[OO$ %
$strOO% >
]OO> ?
??OO@ B
$strOOC W
;OOW X

PromptTextPP 
=PP 
localizationServicePP (
?PP( )
.PP) *
	GetStringPP* 3
(PP3 4
$strPP4 N
,PPN O
LanguageConfigQQ 
.QQ 
GetDisplayNameQQ -
(QQ- .
languageNameQQ. :
)QQ: ;
)QQ; <
??QQ= ?
$"QQ@ B
$strQQB L
{QQL M
languageNameQQM Y
}QQY Z
$strQQZ [
"QQ[ \
;QQ\ ]
ConfirmButtonTextRR 
=RR 
localizationServiceRR /
?RR/ 0
[RR0 1
$strRR1 S
]RRS T
??RRU W
$strRRX a
;RRa b
DeclineButtonTextSS 
=SS 
localizationServiceSS /
?SS/ 0
[SS0 1
$strSS1 S
]SSS T
??SSU W
$strSSX a
;SSa b
OptionVV 
<VV 
LanguageItemVV 
>VV 
languageItemVV )
=VV* +
LanguageConfigVV, :
.VV: ;
GetLanguageByCodeVV; L
(VVL M
_targetCultureVVM [
)VV[ \
;VV\ ]
FlagPathWW 
=WW 
languageItemWW 
.WW  
SelectWW  &
(WW& '
itemWW' +
=>WW, .
itemWW/ 3
.WW3 4
FlagImagePathWW4 A
)WWA B
.XX 
GetValueOrDefaultXX 
(XX 
$strXX W
)XXW X
;XXX Y
thisZZ 
.ZZ 
WhenActivatedZZ 
(ZZ 
disposablesZZ &
=>ZZ' )
{[[ 	
ConfirmCommand\\ 
.\\ 
DisposeWith\\ &
(\\& '
disposables\\' 2
)\\2 3
;\\3 4
DeclineCommand]] 
.]] 
DisposeWith]] &
(]]& '
disposables]]' 2
)]]2 3
;]]3 4
}^^ 	
)^^	 

;^^
 
}__ 
publicaa 

voidaa 
Disposeaa 
(aa 
)aa 
{bb 
ifcc 

(cc 
	_disposedcc 
)cc 
{dd 	
returnee 
;ee 
}ff 	
	_disposedhh 
=hh 
truehh 
;hh 
}ii 
privatekk 
asynckk 
Taskkk 
	OnConfirmkk  
(kk  !
)kk! "
{ll 
awaitmm %
_languageDetectionServicemm '
.mm' (&
ConfirmLanguageChangeAsyncmm( B
(mmB C
targetCulturemmC P
:mmP Q
_targetCulturemmR `
)mm` a
;mma b
}nn 
privatepp 
asyncpp 
Taskpp 
	OnDeclinepp  
(pp  !
)pp! "
{qq 
awaitrr %
_languageDetectionServicerr '
.rr' (&
DeclineLanguageChangeAsyncrr( B
(rrB C
)rrC D
;rrD E
}ss 
}tt ×
„/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/DetectLanguageDialog.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
;' (
public		 
partial		 
class		  
DetectLanguageDialog		 )
:		* +
ReactiveUserControl		, ?
<		? @)
DetectLanguageDialogViewModel		@ ]
>		] ^
{

 
private 
static 
class 
ResourceKeys %
{ 
public 
const 
string 
BUTTON_HEIGHT )
=* +
nameof, 2
(2 3
BUTTON_HEIGHT3 @
)@ A
;A B
public 
const 
string 
TITLE_FONT_SIZE +
=, -
nameof. 4
(4 5
TITLE_FONT_SIZE5 D
)D E
;E F
public 
const 
string 
SUBTITLE_FONT_SIZE .
=/ 0
nameof1 7
(7 8
SUBTITLE_FONT_SIZE8 J
)J K
;K L
public 
const 
string &
BUTTON_TRANSITION_DURATION 6
=7 8
nameof9 ?
(? @&
BUTTON_TRANSITION_DURATION@ Z
)Z [
;[ \
} 
private 
static 
readonly 
FrozenDictionary ,
<, -
string- 3
,3 4
object5 ;
>; < 
PrecompiledResources= Q
=R S
new 

Dictionary 
< 
string 
, 
object %
>% &
{ 	
[ 
ResourceKeys 
. 
BUTTON_HEIGHT '
]' (
=) *
$num+ /
,/ 0
[ 
ResourceKeys 
. 
TITLE_FONT_SIZE )
]) *
=+ ,
$num- 1
,1 2
[ 
ResourceKeys 
. 
SUBTITLE_FONT_SIZE ,
], -
=. /
$num0 4
,4 5
[ 
ResourceKeys 
. &
BUTTON_TRANSITION_DURATION 4
]4 5
=6 7
TimeSpan8 @
.@ A
FromMillisecondsA Q
(Q R
$numR U
)U V
} 	
.	 

ToFrozenDictionary
 
( 
) 
; 
public 
 
DetectLanguageDialog 
(  
)  !
{ 
InitializeComponent 
( 
) 
; %
ApplyPrecompiledResources !
(! "
)" #
;# $
}   
private"" 
void"" 
InitializeComponent"" $
(""$ %
)""% &
{## 
AvaloniaXamlLoader$$ 
.$$ 
Load$$ 
($$  
this$$  $
)$$$ %
;$$% &
}%% 
private'' 
void'' %
ApplyPrecompiledResources'' *
(''* +
)''+ ,
{(( 
foreach)) 
()) 
()) 
string)) 
key)) 
,)) 
object)) $
value))% *
)))* +
in)), . 
PrecompiledResources))/ C
)))C D
{** 	
	Resources++ 
[++ 
key++ 
]++ 
=++ 
value++ "
;++" #
},, 	
}-- 
}// Õ
–/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/BottomSheetModal/DefaultBottomSheetVariables.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
.' (
BottomSheetModal( 8
;8 9
public 
static 
class '
DefaultBottomSheetVariables /
{ 
public 

const 
double 

MIN_HEIGHT "
=# $
$num% )
;) *
public		 

const		 
double		 

MAX_HEIGHT		 "
=		# $
$num		% *
;		* +
public

 

const

 
double

 
DEFAULT_WIDTH

 %
=

& '
$num

( -
;

- .
private 
const 
double 
CONTENT_DELAY_MS )
=* +
$num, 0
;0 1
public 

const 
double !
DEFAULT_SCRIM_OPACITY -
=. /
$num0 4
;4 5
public 

static 
readonly 
SolidColorBrush *

ScrimBrush+ 5
=6 7
new8 ;
(; <
Color< A
.A B
ParseB G
(G H
$strH Q
)Q R
)R S
;S T
public 

static 
readonly 
TimeSpan #
ContentDelay$ 0
=1 2
TimeSpan3 ;
.; <
FromMilliseconds< L
(L M
CONTENT_DELAY_MSM ]
)] ^
;^ _
public 

const 
bool 1
%DEFAULT_IS_DISMISSABLE_ON_SCRIM_CLICK ;
=< =
true> B
;B C
} ÔA
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/BottomSheetModal/BottomSheetViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
.' (
BottomSheetModal( 8
;8 9
public 
sealed 
class  
BottomSheetViewModel (
:) *
ReactiveObject+ 9
,9 :!
IActivatableViewModel; P
,P Q
IDisposableR ]
{ 
private 
readonly 
IBottomSheetService (
_bottomSheetService) <
;< =
private 
readonly 
IMessageBus  
_messageBus! ,
;, -
private 
bool 
	_disposed 
; 
private 
bool 

_isVisible 
; 
private 
bool &
_isDismissableOnScrimClick +
;+ ,
private 
bool 

_showScrim 
; 
private 
UserControl 
? 
_content !
;! "
public 

UserControl 
? 
Content 
{ 
get 
=> 
_content 
; 
set 
=> 
this 
.  
RaiseAndSetIfChanged (
(( )
ref) ,
_content- 5
,5 6
value7 <
)< =
;= >
} 
public   

bool   
	ShowScrim   
{!! 
get"" 
=>"" 

_showScrim"" 
;"" 
set## 
=>## 
this## 
.##  
RaiseAndSetIfChanged## (
(##( )
ref##) ,

_showScrim##- 7
,##7 8
value##9 >
)##> ?
;##? @
}$$ 
public&& 

bool&& 
	IsVisible&& 
{'' 
get(( 
=>(( 

_isVisible(( 
;(( 
set)) 
=>)) 
this)) 
.))  
RaiseAndSetIfChanged)) (
())( )
ref))) ,

_isVisible))- 7
,))7 8
value))9 >
)))> ?
;))? @
}** 
public,, 

bool,, %
IsDismissableOnScrimClick,, )
{-- 
get.. 
=>.. &
_isDismissableOnScrimClick.. )
;..) *
set// 
=>// 
this// 
.//  
RaiseAndSetIfChanged// (
(//( )
ref//) ,&
_isDismissableOnScrimClick//- G
,//G H
value//I N
)//N O
;//O P
}00 
public22 

ViewModelActivator22 
	Activator22 '
{22( )
get22* -
;22- .
}22/ 0
=221 2
new223 6
(226 7
)227 8
;228 9
public44 
 
BottomSheetViewModel44 
(44  
IBottomSheetService44  3
bottomSheetService444 F
,44F G
IMessageBus44H S

messageBus44T ^
)44^ _
{55 
_bottomSheetService66 
=66 
bottomSheetService66 0
;660 1
_messageBus77 
=77 

messageBus77  
;77  !
this99 
.99 
WhenActivated99 
(99 
disposables99 &
=>99' )
{:: 	
_messageBus;; 
.;; 
	Subscribe;; !
<;;! "#
BottomSheetCommandEvent;;" 9
>;;9 :
(;;: ;
async;;; @
evt;;A D
=>;;E G
{<< 
await== 
HandleCommand== #
(==# $
evt==$ '
)==' (
;==( )
}>> 
)>> 
.>> 
DisposeWith>> 
(>> 
disposables>> &
)>>& '
;>>' (
this@@ 
.@@ 
WhenAnyValue@@ 
(@@ 
x@@ 
=>@@  "
x@@# $
.@@$ %
	IsVisible@@% .
)@@. /
.AA 
SkipAA 
(AA 
$numAA 
)AA 
.BB 
	SubscribeBB 
(BB 
asyncBB  
	isVisibleBB! *
=>BB+ -
{CC 
UserControlDD 
?DD  
contentSnapshotDD! 0
=DD1 2
ContentDD3 :
;DD: ;
awaitFF 
TaskFF 
.FF 
DelayFF $
(FF$ %
	isVisibleFF% .
?GG )
BottomSheetAnimationConstantsGG 7
.GG7 8!
ShowAnimationDurationGG8 M
:HH )
BottomSheetAnimationConstantsHH 7
.HH7 8!
HideAnimationDurationHH8 M
)HHM N
;HHN O
awaitJJ 
_messageBusJJ %
.JJ% &
PublishAsyncJJ& 2
(JJ2 3
	isVisibleJJ3 <
?KK -
!BottomSheetAnimationCompleteEventKK ;
.KK; <
ShowCompleteKK< H
(KKH I
)KKI J
:LL -
!BottomSheetAnimationCompleteEventLL ;
.LL; <
HideCompleteLL< H
(LLH I
)LLI J
)LLJ K
;LLK L
ifNN 
(NN 
!NN 
	isVisibleNN "
)NN" #
{OO 
awaitPP 
TaskPP "
.PP" #
DelayPP# (
(PP( )
$numPP) +
)PP+ ,
;PP, -
awaitRR 

DispatcherRR (
.RR( )
UIThreadRR) 1
.RR1 2
InvokeAsyncRR2 =
(RR= >
(RR> ?
)RR? @
=>RRA C
{SS 
ifTT 
(TT  
ReferenceEqualsTT  /
(TT/ 0
ContentTT0 7
,TT7 8
contentSnapshotTT9 H
)TTH I
)TTI J
{UU 
ContentVV  '
=VV( )
nullVV* .
;VV. /
}WW 
}XX 
)XX 
;XX 
}YY 
}ZZ 
)ZZ 
.[[ 
DisposeWith[[ 
([[ 
disposables[[ (
)[[( )
;[[) *
}\\ 	
)\\	 

;\\
 
}]] 
private__ 
Task__ 
HandleCommand__ 
(__ #
BottomSheetCommandEvent__ 6
evt__7 :
)__: ;
{`` 
ifaa 

(aa 
	_disposedaa 
)aa 
{bb 	
returncc 
Taskcc 
.cc 
CompletedTaskcc %
;cc% &
}dd 	
ifff 

(ff 
evtff 
.ff 
AnimationTypeff 
==ff  
AnimationTypeff! .
.ff. /
Showff/ 3
)ff3 4
{gg 	
Contenthh 
=hh 
evthh 
.hh 
Controlhh !
;hh! "
	ShowScrimii 
=ii 
evtii 
.ii 
	ShowScrimii %
;ii% &%
IsDismissableOnScrimClickjj %
=jj& '
evtjj( +
.jj+ ,
IsDismissablejj, 9
;jj9 :
	IsVisiblekk 
=kk 
truekk 
;kk 
}ll 	
elsemm 
{nn 	
	IsVisibleoo 
=oo 
falseoo 
;oo 
}pp 	
returnrr 
Taskrr 
.rr 
CompletedTaskrr !
;rr! "
}ss 
publicuu 

voiduu  
BottomSheetDismisseduu $
(uu$ %
)uu% &
{vv 
Taskww 
.ww 
Runww 
(ww 
asyncww 
(ww 
)ww 
=>ww 
awaitww "
_bottomSheetServiceww# 6
.ww6 7 
BottomSheetDismissedww7 K
(wwK L
)wwL M
)wwM N
;wwN O
}xx 
publiczz 

voidzz 
Disposezz 
(zz 
)zz 
{{{ 
if|| 

(|| 
	_disposed|| 
)|| 
{}} 	
return~~ 
;~~ 
} 	
	_disposed
 
=
 
true
 
;
 
GC
‚‚ 

.
‚‚
 
SuppressFinalize
‚‚ 
(
‚‚ 
this
‚‚  
)
‚‚  !
;
‚‚! "
}
ƒƒ 
}„„ òü
“/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/BottomSheetModal/BottomSheetControl.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
.' (
BottomSheetModal( 8
;8 9
public 
sealed 
partial 
class 
BottomSheetControl .
:/ 0
ReactiveUserControl1 D
<D E 
BottomSheetViewModelE Y
>Y Z
,Z [
IDisposable\ g
{ 
public 

new 
static 
readonly 
StyledProperty -
<- .
double. 4
>4 5
MinHeightProperty6 G
=H I
AvaloniaProperty 
. 
Register !
<! "
BottomSheetControl" 4
,4 5
double6 <
>< =
(= >
nameof> D
(D E
	MinHeightE N
)N O
,O P'
DefaultBottomSheetVariablesQ l
.l m

MIN_HEIGHTm w
)w x
;x y
public 

new 
static 
readonly 
StyledProperty -
<- .
double. 4
>4 5
MaxHeightProperty6 G
=H I
AvaloniaProperty 
. 
Register !
<! "
BottomSheetControl" 4
,4 5
double6 <
>< =
(= >
nameof> D
(D E
	MaxHeightE N
)N O
,O P'
DefaultBottomSheetVariablesQ l
.l m

MAX_HEIGHTm w
)w x
;x y
public!! 

static!! 
readonly!! 
StyledProperty!! )
<!!) *
IBrush!!* 0
>!!0 1
ScrimColorProperty!!2 D
=!!E F
AvaloniaProperty"" 
."" 
Register"" !
<""! "
BottomSheetControl""" 4
,""4 5
IBrush""6 <
>""< =
(""= >
nameof""> D
(""D E

ScrimColor""E O
)""O P
,""P Q'
DefaultBottomSheetVariables## '
.##' (

ScrimBrush##( 2
)##2 3
;##3 4
public%% 

static%% 
readonly%% 
StyledProperty%% )
<%%) *
bool%%* .
>%%. /-
!IsDismissableOnScrimClickProperty%%0 Q
=%%R S
AvaloniaProperty&& 
.&& 
Register&& !
<&&! "
BottomSheetControl&&" 4
,&&4 5
bool&&6 :
>&&: ;
(&&; <
nameof&&< B
(&&B C%
IsDismissableOnScrimClick&&C \
)&&\ ]
,&&] ^'
DefaultBottomSheetVariables'' '
.''' (1
%DEFAULT_IS_DISMISSABLE_ON_SCRIM_CLICK''( M
)''M N
;''N O
public)) 

static)) 
readonly)) 
StyledProperty)) )
<))) *
IBrush))* 0
>))0 1)
DismissableScrimColorProperty))2 O
=))P Q
AvaloniaProperty** 
.** 
Register** !
<**! "
BottomSheetControl**" 4
,**4 5
IBrush**6 <
>**< =
(**= >
nameof**> D
(**D E!
DismissableScrimColor**E Z
)**Z [
,**[ \'
DefaultBottomSheetVariables++ '
.++' (

ScrimBrush++( 2
)++2 3
;++3 4
public-- 

static-- 
readonly-- 
StyledProperty-- )
<--) *
IBrush--* 0
>--0 1+
UnDismissableScrimColorProperty--2 Q
=--R S
AvaloniaProperty.. 
... 
Register.. !
<..! "
BottomSheetControl.." 4
,..4 5
IBrush..6 <
>..< =
(..= >
nameof..> D
(..D E#
UnDismissableScrimColor..E \
)..\ ]
,..] ^'
DefaultBottomSheetVariables// '
.//' (

ScrimBrush//( 2
)//2 3
;//3 4
private11 
bool11 
	_disposed11 
;11 
private22 
bool22 
_isAnimating22 
;22 
private33 
double33 
_sheetHeight33 
;33  
private55 
Border55 
?55 
_sheetBorder55  
;55  !
private66 
Border66 
?66 
_scrimBorder66  
;66  !
private77 
Grid77 
?77 
	_rootGrid77 
;77 
private88 
ContentControl88 
?88 
_contentControl88 +
;88+ ,
private:: 
	Animation:: 
?:: 
_showAnimation:: %
;::% &
private;; 
	Animation;; 
?;; 
_hideAnimation;; %
;;;% &
private<< 
	Animation<< 
?<< 
_scrimShowAnimation<< *
;<<* +
private== 
	Animation== 
?== 
_scrimHideAnimation== *
;==* +
public?? 

BottomSheetControl?? 
(?? 
)?? 
{@@ 
InitializeComponentAA 
(AA 
)AA 
;AA 
InitializeDefaultsBB 
(BB 
)BB 
;BB 
	FocusableCC 
=CC 
trueCC 
;CC 
}DD 
publicFF 

IBrushFF !
DismissableScrimColorFF '
{GG 
getHH 
=>HH 
GetValueHH 
(HH )
DismissableScrimColorPropertyHH 5
)HH5 6
;HH6 7
setII 
=>II 
SetValueII 
(II )
DismissableScrimColorPropertyII 5
,II5 6
valueII7 <
)II< =
;II= >
}JJ 
publicLL 

IBrushLL #
UnDismissableScrimColorLL )
{MM 
getNN 
=>NN 
GetValueNN 
(NN +
UnDismissableScrimColorPropertyNN 7
)NN7 8
;NN8 9
setOO 
=>OO 
SetValueOO 
(OO +
UnDismissableScrimColorPropertyOO 7
,OO7 8
valueOO9 >
)OO> ?
;OO? @
}PP 
publicRR 

newRR 
doubleRR 
	MinHeightRR 
{SS 
getTT 
=>TT 
GetValueTT 
(TT 
MinHeightPropertyTT )
)TT) *
;TT* +
setUU 
=>UU 
SetValueUU 
(UU 
MinHeightPropertyUU )
,UU) *
valueUU+ 0
)UU0 1
;UU1 2
}VV 
publicXX 

newXX 
doubleXX 
	MaxHeightXX 
{YY 
getZZ 
=>ZZ 
GetValueZZ 
(ZZ 
MaxHeightPropertyZZ )
)ZZ) *
;ZZ* +
set[[ 
=>[[ 
SetValue[[ 
([[ 
MaxHeightProperty[[ )
,[[) *
value[[+ 0
)[[0 1
;[[1 2
}\\ 
public^^ 

IBrush^^ 

ScrimColor^^ 
{__ 
get`` 
=>`` 
GetValue`` 
(`` 
ScrimColorProperty`` *
)``* +
;``+ ,
setaa 
=>aa 
SetValueaa 
(aa 
ScrimColorPropertyaa *
,aa* +
valueaa, 1
)aa1 2
;aa2 3
}bb 
publicdd 

booldd %
IsDismissableOnScrimClickdd )
{ee 
getff 
=>ff 
GetValueff 
(ff -
!IsDismissableOnScrimClickPropertyff 9
)ff9 :
;ff: ;
setgg 
=>gg 
SetValuegg 
(gg -
!IsDismissableOnScrimClickPropertygg 9
,gg9 :
valuegg; @
)gg@ A
;ggA B
}hh 
publicjj 

voidjj 
Disposejj 
(jj 
)jj 
{kk 
ifll 

(ll 
	_disposedll 
)ll 
{mm 	
returnnn 
;nn 
}oo 	
ifqq 

(qq 
	ViewModelqq 
isqq !
IActivatableViewModelqq .
activatableqq/ :
)qq: ;
{rr 	
activatabless 
.ss 
	Activatorss !
.ss! "

Deactivatess" ,
(ss, -
)ss- .
;ss. /
}tt 	
ifvv 

(vv 
	ViewModelvv 
isvv 
IDisposablevv $
disposableViewModelvv% 8
)vv8 9
{ww 	
disposableViewModelxx 
.xx  
Disposexx  '
(xx' (
)xx( )
;xx) *
}yy 	
	_disposed{{ 
={{ 
true{{ 
;{{ 
}|| 
	protected 
override 
void "
OnAttachedToVisualTree 2
(2 3)
VisualTreeAttachmentEventArgs3 P
eQ R
)R S
{
€€ 
base
 
.
 $
OnAttachedToVisualTree
 #
(
# $
e
$ %
)
% &
;
& '
KeyDown
‚‚ 
+=
‚‚ 
	OnKeyDown
‚‚ 
;
‚‚ 
}
ƒƒ 
	protected
…… 
override
…… 
void
…… &
OnDetachedFromVisualTree
…… 4
(
……4 5+
VisualTreeAttachmentEventArgs
……5 R
e
……S T
)
……T U
{
†† 
base
‡‡ 
.
‡‡ &
OnDetachedFromVisualTree
‡‡ %
(
‡‡% &
e
‡‡& '
)
‡‡' (
;
‡‡( )
KeyDown
ˆˆ 
-=
ˆˆ 
	OnKeyDown
ˆˆ 
;
ˆˆ 
Dispose
‰‰ 
(
‰‰ 
)
‰‰ 
;
‰‰ 
}
ŠŠ 
private
ŒŒ 
static
ŒŒ 
void
ŒŒ 
EnsureTransform
ŒŒ '
<
ŒŒ' (
T
ŒŒ( )
>
ŒŒ) *
(
ŒŒ* +
Visual
ŒŒ+ 1
visual
ŒŒ2 8
)
ŒŒ8 9
where
ŒŒ: ?
T
ŒŒ@ A
:
ŒŒB C
	Transform
ŒŒD M
,
ŒŒM N
new
ŒŒO R
(
ŒŒR S
)
ŒŒS T
{
 

ITransform
ŽŽ 
?
ŽŽ 
existingTransform
ŽŽ %
=
ŽŽ& '
visual
ŽŽ( .
.
ŽŽ. /
RenderTransform
ŽŽ/ >
;
ŽŽ> ?
if
 

(
 
existingTransform
 
is
  
TransformGroup
! /
existingGroup
0 =
)
= >
{
 	
if
‘‘ 
(
‘‘ 
existingGroup
‘‘ 
.
‘‘ 
Children
‘‘ &
.
‘‘& '
OfType
‘‘' -
<
‘‘- .
T
‘‘. /
>
‘‘/ 0
(
‘‘0 1
)
‘‘1 2
.
‘‘2 3
Any
‘‘3 6
(
‘‘6 7
)
‘‘7 8
)
‘‘8 9
{
’’ 
return
““ 
;
““ 
}
”” 
T
–– #
newTransformFromGroup
–– #
=
––$ %
new
––& )
(
––) *
)
––* +
;
––+ ,
existingGroup
—— 
.
—— 
Children
—— "
.
——" #
Add
——# &
(
——& '#
newTransformFromGroup
——' <
)
——< =
;
——= >
return
˜˜ 
;
˜˜ 
}
™™ 	
TransformGroup
›› 
group
›› 
=
›› 
new
›› "
(
››" #
)
››# $
;
››$ %
if
œœ 

(
œœ 
existingTransform
œœ 
is
œœ  
	Transform
œœ! *
singleTransform
œœ+ :
)
œœ: ;
{
 	
group
žž 
.
žž 
Children
žž 
.
žž 
Add
žž 
(
žž 
singleTransform
žž .
)
žž. /
;
žž/ 0
}
ŸŸ 	
T
¡¡ 	
newTransform
¡¡
 
=
¡¡ 
new
¡¡ 
(
¡¡ 
)
¡¡ 
;
¡¡ 
group
¢¢ 
.
¢¢ 
Children
¢¢ 
.
¢¢ 
Add
¢¢ 
(
¢¢ 
newTransform
¢¢ '
)
¢¢' (
;
¢¢( )
visual
££ 
.
££ 
RenderTransform
££ 
=
££  
group
££! &
;
££& '
}
¤¤ 
private
¦¦ 
void
¦¦  
InitializeDefaults
¦¦ #
(
¦¦# $
)
¦¦$ %
{
§§ 
	ViewModel
¨¨ 
=
¨¨ 
Locator
¨¨ 
.
¨¨ 
Current
¨¨ #
.
¨¨# $

GetService
¨¨$ .
<
¨¨. /"
BottomSheetViewModel
¨¨/ C
>
¨¨C D
(
¨¨D E
)
¨¨E F
;
¨¨F G'
IsDismissableOnScrimClick
©© !
=
©©" #)
DefaultBottomSheetVariables
©©$ ?
.
©©? @3
%DEFAULT_IS_DISMISSABLE_ON_SCRIM_CLICK
©©@ e
;
©©e f
if
«« 

(
«« 
	ViewModel
«« 
is
«« #
IActivatableViewModel
«« ."
activatableViewModel
««/ C
)
««C D
{
¬¬ 	"
activatableViewModel
­­  
.
­­  !
	Activator
­­! *
.
­­* +
Activate
­­+ 3
(
­­3 4
)
­­4 5
;
­­5 6
}
®® 	
}
¯¯ 
private
±± 
void
±± !
InitializeComponent
±± $
(
±±$ %
)
±±% &
{
²²  
AvaloniaXamlLoader
³³ 
.
³³ 
Load
³³ 
(
³³  
this
³³  $
)
³³$ %
;
³³% & 
InitializeControls
´´ 
(
´´ 
)
´´ 
;
´´ #
SetupReactiveBindings
µµ 
(
µµ 
)
µµ 
;
µµ  
}
¶¶ 
private
¸¸ 
void
¸¸  
InitializeControls
¸¸ #
(
¸¸# $
)
¸¸$ %
{
¹¹ 
	_rootGrid
ºº 
=
ºº 
this
ºº 
.
ºº 
FindControl
ºº $
<
ºº$ %
Grid
ºº% )
>
ºº) *
(
ºº* +
$str
ºº+ 5
)
ºº5 6
;
ºº6 7
_sheetBorder
»» 
=
»» 
this
»» 
.
»» 
FindControl
»» '
<
»»' (
Border
»»( .
>
»». /
(
»»/ 0
$str
»»0 =
)
»»= >
;
»»> ?
_scrimBorder
¼¼ 
=
¼¼ 
this
¼¼ 
.
¼¼ 
FindControl
¼¼ '
<
¼¼' (
Border
¼¼( .
>
¼¼. /
(
¼¼/ 0
$str
¼¼0 =
)
¼¼= >
;
¼¼> ?
_contentControl
½½ 
=
½½ 
this
½½ 
.
½½ 
FindControl
½½ *
<
½½* +
ContentControl
½½+ 9
>
½½9 :
(
½½: ;
$str
½½; K
)
½½K L
;
½½L M
if
¿¿ 

(
¿¿ 
_sheetBorder
¿¿ 
!=
¿¿ 
null
¿¿  
&&
¿¿! #
_scrimBorder
¿¿$ 0
!=
¿¿1 3
null
¿¿4 8
&&
¿¿9 ;
	_rootGrid
¿¿< E
!=
¿¿F H
null
¿¿I M
)
¿¿M N
{
ÀÀ 	
EnsureTransform
ÁÁ 
<
ÁÁ  
TranslateTransform
ÁÁ .
>
ÁÁ. /
(
ÁÁ/ 0
_sheetBorder
ÁÁ0 <
)
ÁÁ< =
;
ÁÁ= >
	_rootGrid
ÂÂ 
.
ÂÂ 
	IsVisible
ÂÂ 
=
ÂÂ  !
false
ÂÂ" '
;
ÂÂ' (
_sheetBorder
ÃÃ 
.
ÃÃ 
	IsVisible
ÃÃ "
=
ÃÃ# $
false
ÃÃ% *
;
ÃÃ* +
_scrimBorder
ÄÄ 
.
ÄÄ 
	IsVisible
ÄÄ "
=
ÄÄ# $
false
ÄÄ% *
;
ÄÄ* +
}
ÅÅ 	
}
ÆÆ 
private
ÈÈ 
void
ÈÈ #
SetupReactiveBindings
ÈÈ &
(
ÈÈ& '
)
ÈÈ' (
{
ÉÉ 
this
ÊÊ 
.
ÊÊ 
WhenActivated
ÊÊ 
(
ÊÊ 
disposables
ÊÊ &
=>
ÊÊ' )
{
ËË 	&
SetupDismissableBindings
ÌÌ $
(
ÌÌ$ %
disposables
ÌÌ% 0
)
ÌÌ0 1
;
ÌÌ1 2$
SetupScrimColorBinding
ÍÍ "
(
ÍÍ" #
disposables
ÍÍ# .
)
ÍÍ. /
;
ÍÍ/ 0$
SetupAnimationBindings
ÎÎ "
(
ÎÎ" #
disposables
ÎÎ# .
)
ÎÎ. /
;
ÎÎ/ 0
}
ÏÏ 	
)
ÏÏ	 

;
ÏÏ
 
}
ÐÐ 
private
ÒÒ 
void
ÒÒ $
SetupScrimColorBinding
ÒÒ '
(
ÒÒ' (!
CompositeDisposable
ÒÒ( ;
disposables
ÒÒ< G
)
ÒÒG H
{
ÓÓ 
this
ÔÔ 
.
ÔÔ 
WhenAnyValue
ÔÔ 
(
ÔÔ 
x
ÕÕ 
=>
ÕÕ 
x
ÕÕ 
.
ÕÕ '
IsDismissableOnScrimClick
ÕÕ 0
,
ÕÕ0 1
x
ÖÖ 
=>
ÖÖ 
x
ÖÖ 
.
ÖÖ #
DismissableScrimColor
ÖÖ ,
,
ÖÖ, -
x
×× 
=>
×× 
x
×× 
.
×× %
UnDismissableScrimColor
×× .
)
××. /
.
ØØ 
	Subscribe
ØØ 
(
ØØ 
tuple
ØØ 
=>
ØØ 
{
ÙÙ 
(
ÚÚ 
bool
ÚÚ 
isDismissable
ÚÚ #
,
ÚÚ# $
IBrush
ÚÚ% +
dismissableColor
ÚÚ, <
,
ÚÚ< =
IBrush
ÚÚ> D 
unDismissableColor
ÚÚE W
)
ÚÚW X
=
ÚÚY Z
tuple
ÚÚ[ `
;
ÚÚ` a

ScrimColor
ÛÛ 
=
ÛÛ 
isDismissable
ÛÛ *
?
ÛÛ+ ,
dismissableColor
ÛÛ- =
:
ÛÛ> ? 
unDismissableColor
ÛÛ@ R
;
ÛÛR S
}
ÜÜ 
)
ÜÜ 
.
ÝÝ 
DisposeWith
ÝÝ 
(
ÝÝ 
disposables
ÝÝ $
)
ÝÝ$ %
;
ÝÝ% &
}
ÞÞ 
private
àà 
void
àà &
SetupDismissableBindings
àà )
(
àà) *!
CompositeDisposable
àà* =
disposables
àà> I
)
ààI J
{
áá 
this
ââ 
.
ââ 
WhenAnyValue
ââ 
(
ââ 
x
ââ 
=>
ââ 
x
ââ  
.
ââ  !
	ViewModel
ââ! *
)
ââ* +
.
ãã 
WhereNotNull
ãã 
(
ãã 
)
ãã 
.
ää 
Take
ää 
(
ää 
$num
ää 
)
ää 
.
åå 
	Subscribe
åå 
(
åå 
	viewModel
åå  
=>
åå! #
	viewModel
åå$ -
.
åå- .'
IsDismissableOnScrimClick
åå. G
=
ååH I'
IsDismissableOnScrimClick
ååJ c
)
ååc d
.
ææ 
DisposeWith
ææ 
(
ææ 
disposables
ææ $
)
ææ$ %
;
ææ% &
this
èè 
.
èè 
WhenAnyValue
èè 
(
èè 
x
èè 
=>
èè 
x
èè  
.
èè  !
	ViewModel
èè! *
!
èè* +
.
èè+ ,'
IsDismissableOnScrimClick
èè, E
)
èèE F
.
éé 
	Subscribe
éé 
(
éé 
isDismissable
éé $
=>
éé% ''
IsDismissableOnScrimClick
éé( A
=
ééB C
isDismissable
ééD Q
)
ééQ R
.
êê 
DisposeWith
êê 
(
êê 
disposables
êê $
)
êê$ %
;
êê% &
}
ëë 
private
íí 
void
íí $
SetupAnimationBindings
íí '
(
íí' (!
CompositeDisposable
íí( ;
disposables
íí< G
)
ííG H
{
îî 
this
ïï 
.
ïï 
WhenAnyValue
ïï 
(
ïï 
x
ïï 
=>
ïï 
x
ïï  
.
ïï  !
	ViewModel
ïï! *
!
ïï* +
.
ïï+ ,
	IsVisible
ïï, 5
)
ïï5 6
.
ðð 
Skip
ðð 
(
ðð 
$num
ðð 
)
ðð 
.
ññ 
	ObserveOn
ññ 
(
ññ 
RxApp
ññ 
.
ññ !
MainThreadScheduler
ññ 0
)
ññ0 1
.
òò 
	Subscribe
òò 
(
òò 
async
òò 
void
òò !
(
òò" #
	isVisible
òò# ,
)
òò, -
=>
òò. 0
{
óó 
try
ôô 
{
õõ 
await
öö !
OnVisibilityChanged
öö -
(
öö- .
	isVisible
öö. 7
)
öö7 8
;
öö8 9
}
÷÷ 
catch
øø 
(
øø 
	Exception
øø  
e
øø! "
)
øø" #
{
ùù 
Log
úú 
.
úú 
Error
úú 
(
úú 
e
úú 
,
úú  
$str
úú! e
,
úúe f
	isVisible
úúg p
)
úúp q
;
úúq r
}
ûû 
}
üü 
)
üü 
.
ýý 
DisposeWith
ýý 
(
ýý 
disposables
ýý $
)
ýý$ %
;
ýý% &
}
þþ 
private
€€ 
IInputElement
€€ 
?
€€ %
_previousFocusedElement
€€ 2
;
€€2 3
private
 
async
 
Task
 !
OnVisibilityChanged
 *
(
* +
bool
+ /
	isVisible
0 9
)
9 :
{
‚‚ 
if
ƒƒ 

(
ƒƒ 
	_rootGrid
ƒƒ 
is
ƒƒ 
null
ƒƒ 
)
ƒƒ 
{
„„ 	
return
…… 
;
…… 
}
†† 	
await
ˆˆ -
WaitForAnimationToCompleteAsync
ˆˆ -
(
ˆˆ- .
)
ˆˆ. /
;
ˆˆ/ 0
if
ŠŠ 

(
ŠŠ 
	isVisible
ŠŠ 
)
ŠŠ 
{
‹‹ 	
await
ŒŒ +
ShowBottomSheetWithFocusAsync
ŒŒ /
(
ŒŒ/ 0
)
ŒŒ0 1
;
ŒŒ1 2
}
 	
else
ŽŽ 
{
 	
await
 2
$HideBottomSheetWithFocusRestoreAsync
 6
(
6 7
)
7 8
;
8 9
}
‘‘ 	
}
’’ 
private
”” 
async
”” 
Task
”” -
WaitForAnimationToCompleteAsync
”” 6
(
””6 7
)
””7 8
{
•• 
if
–– 

(
–– 
!
–– 
_isAnimating
–– 
)
–– 
{
—— 	
return
˜˜ 
;
˜˜ 
}
™™ 	
DateTime
›› 
timeout
›› 
=
›› 
DateTime
›› #
.
››# $
UtcNow
››$ *
.
››* +

AddSeconds
››+ 5
(
››5 6
$num
››6 7
)
››7 8
;
››8 9
while
œœ 
(
œœ 
_isAnimating
œœ 
&&
œœ 
DateTime
œœ '
.
œœ' (
UtcNow
œœ( .
<
œœ/ 0
timeout
œœ1 8
)
œœ8 9
{
 	
await
žž 
Task
žž 
.
žž 
Delay
žž 
(
žž 
$num
žž 
)
žž  
;
žž  !
}
ŸŸ 	
if
¡¡ 

(
¡¡ 
_isAnimating
¡¡ 
)
¡¡ 
{
¢¢ 	
_isAnimating
££ 
=
££ 
false
££  
;
££  !
}
¤¤ 	
}
¥¥ 
private
§§ 
async
§§ 
Task
§§ +
ShowBottomSheetWithFocusAsync
§§ 4
(
§§4 5
)
§§5 6
{
¨¨ (
SavePreviousFocusedElement
©© "
(
©©" #
)
©©# $
;
©©$ %
UpdateSheetHeight
ªª 
(
ªª 
)
ªª 
;
ªª 
await
«« 
ShowBottomSheet
«« 
(
«« 
)
«« 
;
««  
Focus
¬¬ 
(
¬¬ 
)
¬¬ 
;
¬¬ 
}
­­ 
private
¯¯ 
void
¯¯ (
SavePreviousFocusedElement
¯¯ +
(
¯¯+ ,
)
¯¯, -
{
°° 
try
±± 
{
²² 	
TopLevel
³³ 
?
³³ 

visualRoot
³³  
=
³³! "
	_rootGrid
³³# ,
?
³³, -
.
³³- .
GetVisualRoot
³³. ;
(
³³; <
)
³³< =
as
³³> @
TopLevel
³³A I
;
³³I J%
_previousFocusedElement
´´ #
=
´´$ %

visualRoot
´´& 0
?
´´0 1
.
´´1 2
FocusManager
´´2 >
?
´´> ?
.
´´? @
GetFocusedElement
´´@ Q
(
´´Q R
)
´´R S
;
´´S T
}
µµ 	
catch
¶¶ 
(
¶¶ 
	Exception
¶¶ 
)
¶¶ 
{
·· 	%
_previousFocusedElement
¸¸ #
=
¸¸$ %
null
¸¸& *
;
¸¸* +
}
¹¹ 	
}
ºº 
private
¼¼ 
async
¼¼ 
Task
¼¼ 2
$HideBottomSheetWithFocusRestoreAsync
¼¼ ;
(
¼¼; <
)
¼¼< =
{
½½ 
await
¾¾ 
HideBottomSheet
¾¾ 
(
¾¾ 
)
¾¾ 
;
¾¾  "
RestorePreviousFocus
¿¿ 
(
¿¿ 
)
¿¿ 
;
¿¿ 
}
ÀÀ 
private
ÂÂ 
void
ÂÂ "
RestorePreviousFocus
ÂÂ %
(
ÂÂ% &
)
ÂÂ& '
{
ÃÃ 
try
ÄÄ 
{
ÅÅ 	
if
ÆÆ 
(
ÆÆ %
_previousFocusedElement
ÆÆ '
is
ÆÆ( *
{
ÆÆ+ ,
}
ÆÆ- .
previous
ÆÆ/ 7
)
ÆÆ7 8
{
ÇÇ 
previous
ÈÈ 
.
ÈÈ 
Focus
ÈÈ 
(
ÈÈ 
)
ÈÈ  
;
ÈÈ  !%
_previousFocusedElement
ÉÉ '
=
ÉÉ( )
null
ÉÉ* .
;
ÉÉ. /
}
ÊÊ 
else
ËË 
if
ËË 
(
ËË 
Parent
ËË 
is
ËË 
Control
ËË &
parentControl
ËË' 4
)
ËË4 5
{
ÌÌ 
parentControl
ÍÍ 
.
ÍÍ 
Focus
ÍÍ #
(
ÍÍ# $
)
ÍÍ$ %
;
ÍÍ% &
}
ÎÎ 
}
ÏÏ 	
catch
ÐÐ 
(
ÐÐ 
	Exception
ÐÐ 
)
ÐÐ 
{
ÑÑ 	#
TryFocusParentControl
ÒÒ !
(
ÒÒ! "
)
ÒÒ" #
;
ÒÒ# $
}
ÓÓ 	
}
ÔÔ 
private
ÖÖ 
void
ÖÖ #
TryFocusParentControl
ÖÖ &
(
ÖÖ& '
)
ÖÖ' (
{
×× 
if
ØØ 

(
ØØ 
Parent
ØØ 
is
ØØ 
Control
ØØ 
fallbackParent
ØØ ,
)
ØØ, -
{
ÙÙ 	
fallbackParent
ÚÚ 
.
ÚÚ 
Focus
ÚÚ  
(
ÚÚ  !
)
ÚÚ! "
;
ÚÚ" #
}
ÛÛ 	
}
ÜÜ 
private
ÞÞ 
void
ÞÞ 
UpdateSheetHeight
ÞÞ "
(
ÞÞ" #
)
ÞÞ# $
{
ßß 
if
àà 

(
àà 
_contentControl
àà 
==
àà 
null
àà #
||
àà$ &
_sheetBorder
àà' 3
==
àà4 6
null
àà7 ;
)
àà; <
{
áá 	
_sheetHeight
ââ 
=
ââ 
	MinHeight
ââ $
;
ââ$ %
return
ãã 
;
ãã 
}
ää 	
double
ææ 

sheetWidth
ææ 
=
ææ 
_sheetBorder
ææ (
.
ææ( )
Width
ææ) .
;
ææ. /
if
çç 

(
çç 
double
çç 
.
çç 
IsNaN
çç 
(
çç 

sheetWidth
çç #
)
çç# $
||
çç% '

sheetWidth
çç( 2
<=
çç3 5
$num
çç6 7
)
çç7 8
{
èè 	

sheetWidth
éé 
=
éé )
DefaultBottomSheetVariables
éé 4
.
éé4 5
DEFAULT_WIDTH
éé5 B
;
ééB C
}
êê 	
	Thickness
ìì 
padding
ìì 
=
ìì 
_sheetBorder
ìì (
.
ìì( )
Padding
ìì) 0
;
ìì0 1
	Thickness
íí 
borderThickness
íí !
=
íí" #
_sheetBorder
íí$ 0
.
íí0 1
BorderThickness
íí1 @
;
íí@ A
double
ïï 
verticalExtras
ïï 
=
ïï 
padding
ïï  '
.
ïï' (
Top
ïï( +
+
ïï, -
padding
ïï. 5
.
ïï5 6
Bottom
ïï6 <
+
ïï= >
borderThickness
ïï? N
.
ïïN O
Top
ïïO R
+
ïïS T
borderThickness
ïïU d
.
ïïd e
Bottom
ïïe k
;
ïïk l
double
ðð 
horizontalExtras
ðð 
=
ðð  !
padding
ðð" )
.
ðð) *
Left
ðð* .
+
ðð/ 0
padding
ðð1 8
.
ðð8 9
Right
ðð9 >
+
ðð? @
borderThickness
ððA P
.
ððP Q
Left
ððQ U
+
ððV W
borderThickness
ððX g
.
ððg h
Right
ððh m
;
ððm n
double
òò 
availableWidth
òò 
=
òò 

sheetWidth
òò  *
-
òò+ ,
horizontalExtras
òò- =
;
òò= >
double
óó 
availableHeight
óó 
=
óó  
	MaxHeight
óó! *
-
óó+ ,
verticalExtras
óó- ;
;
óó; <
Size
õõ 
availableSize
õõ 
=
õõ 
new
õõ  
(
õõ  !
availableWidth
õõ! /
,
õõ/ 0
double
õõ1 7
.
õõ7 8
PositiveInfinity
õõ8 H
)
õõH I
;
õõI J
_contentControl
öö 
.
öö 
Measure
öö 
(
öö  
availableSize
öö  -
)
öö- .
;
öö. /
double
øø 
contentHeight
øø 
=
øø 
_contentControl
øø .
.
øø. /
DesiredSize
øø/ :
.
øø: ;
Height
øø; A
;
øøA B
if
úú 

(
úú 
double
úú 
.
úú 
IsNaN
úú 
(
úú 
contentHeight
úú &
)
úú& '
||
úú( *
contentHeight
úú+ 8
<=
úú9 ;
$num
úú< =
)
úú= >
{
ûû 	
contentHeight
üü 
=
üü 
	MinHeight
üü %
;
üü% &
}
ýý 	
double
ÿÿ 
maxContentHeight
ÿÿ 
=
ÿÿ  !
Math
ÿÿ" &
.
ÿÿ& '
Max
ÿÿ' *
(
ÿÿ* +
	MinHeight
ÿÿ+ 4
,
ÿÿ4 5
availableHeight
ÿÿ6 E
)
ÿÿE F
;
ÿÿF G
_sheetHeight
 
=
 
Math
 
.
 
Clamp
 !
(
! "
contentHeight
" /
,
/ 0
	MinHeight
1 :
,
: ;
maxContentHeight
< L
)
L M
;
M N
_sheetBorder
‚‚ 
.
‚‚ 
Height
‚‚ 
=
‚‚ 
_sheetHeight
‚‚ *
;
‚‚* +
}
ƒƒ 
private
…… 
async
…… 
Task
…… 
ShowBottomSheet
…… &
(
……& '
)
……' (
{
†† 
if
‡‡ 

(
‡‡ 
_sheetBorder
‡‡ 
is
‡‡ 
null
‡‡  
||
‡‡! #
	_rootGrid
‡‡$ -
is
‡‡. 0
null
‡‡1 5
)
‡‡5 6
{
ˆˆ 	
return
‰‰ 
;
‰‰ 
}
ŠŠ 	
UpdateSheetHeight
ŒŒ 
(
ŒŒ 
)
ŒŒ 
;
ŒŒ 
CreateAnimations
 
(
 
)
 
;
 
if
 

(
 
_showAnimation
 
is
 
null
 "
)
" #
{
 	
return
‘‘ 
;
‘‘ 
}
’’ 	
_isAnimating
”” 
=
”” 
true
”” 
;
”” 
_sheetBorder
•• 
.
•• 
IsHitTestVisible
•• %
=
••& '
false
••( -
;
••- .
	_rootGrid
—— 
.
—— 
	IsVisible
—— 
=
—— 
true
—— "
;
——" #
_sheetBorder
˜˜ 
.
˜˜ 
	IsVisible
˜˜ 
=
˜˜  
true
˜˜! %
;
˜˜% &
if
šš 

(
šš 
	ViewModel
šš 
?
šš 
.
šš 
	ShowScrim
šš  
is
šš! #
true
šš$ (
&&
šš) +
_scrimBorder
šš, 8
is
šš9 ;
not
šš< ?
null
šš@ D
)
ššD E
{
›› 	
_scrimBorder
œœ 
.
œœ 
	IsVisible
œœ "
=
œœ# $
true
œœ% )
;
œœ) *
}
 	
try
ŸŸ 
{
   	
List
¡¡ 
<
¡¡ 
Task
¡¡ 
>
¡¡ 
	showTasks
¡¡  
=
¡¡! "
[
¡¡# $
_showAnimation
¡¡$ 2
.
¡¡2 3
RunAsync
¡¡3 ;
(
¡¡; <
_sheetBorder
¡¡< H
,
¡¡H I
CancellationToken
¡¡J [
.
¡¡[ \
None
¡¡\ `
)
¡¡` a
]
¡¡a b
;
¡¡b c
if
££ 
(
££ 
	ViewModel
££ 
?
££ 
.
££ 
	ShowScrim
££ $
is
££% '
true
££( ,
&&
££- /!
_scrimShowAnimation
££0 C
is
££D F
not
££G J
null
££K O
&&
££P R
_scrimBorder
££S _
is
££` b
not
££c f
null
££g k
)
££k l
{
¤¤ 
	showTasks
¥¥ 
.
¥¥ 
Add
¥¥ 
(
¥¥ !
_scrimShowAnimation
¥¥ 1
.
¥¥1 2
RunAsync
¥¥2 :
(
¥¥: ;
_scrimBorder
¥¥; G
,
¥¥G H
CancellationToken
¥¥I Z
.
¥¥Z [
None
¥¥[ _
)
¥¥_ `
)
¥¥` a
;
¥¥a b
}
¦¦ 
await
¨¨ 
Task
¨¨ 
.
¨¨ 
WhenAll
¨¨ 
(
¨¨ 
	showTasks
¨¨ (
)
¨¨( )
;
¨¨) *
}
©© 	
finally
ªª 
{
«« 	
_isAnimating
¬¬ 
=
¬¬ 
false
¬¬  
;
¬¬  !
_sheetBorder
­­ 
.
­­ 
IsHitTestVisible
­­ )
=
­­* +
true
­­, 0
;
­­0 1
}
®® 	
}
¯¯ 
private
±± 
async
±± 
Task
±± 
HideBottomSheet
±± &
(
±±& '
)
±±' (
{
²² 
if
³³ 

(
³³ 
_hideAnimation
³³ 
is
³³ 
null
³³ "
||
³³# %
_sheetBorder
³³& 2
is
³³3 5
null
³³6 :
||
³³; =
	_rootGrid
³³> G
is
³³H J
null
³³K O
)
³³O P
{
´´ 	
return
µµ 
;
µµ 
}
¶¶ 	
_isAnimating
¸¸ 
=
¸¸ 
true
¸¸ 
;
¸¸ 
_sheetBorder
¹¹ 
.
¹¹ 
IsHitTestVisible
¹¹ %
=
¹¹& '
false
¹¹( -
;
¹¹- .
try
»» 
{
¼¼ 	
List
½½ 
<
½½ 
Task
½½ 
>
½½ 
	hideTasks
½½  
=
½½! "
[
½½# $
_hideAnimation
½½$ 2
.
½½2 3
RunAsync
½½3 ;
(
½½; <
_sheetBorder
½½< H
,
½½H I
CancellationToken
½½J [
.
½½[ \
None
½½\ `
)
½½` a
]
½½a b
;
½½b c
if
¿¿ 
(
¿¿ 
	ViewModel
¿¿ 
?
¿¿ 
.
¿¿ 
	ShowScrim
¿¿ $
is
¿¿% '
true
¿¿( ,
&&
¿¿- /!
_scrimHideAnimation
¿¿0 C
is
¿¿D F
not
¿¿G J
null
¿¿K O
&&
¿¿P R
_scrimBorder
¿¿S _
is
¿¿` b
not
¿¿c f
null
¿¿g k
)
¿¿k l
{
ÀÀ 
	hideTasks
ÁÁ 
.
ÁÁ 
Add
ÁÁ 
(
ÁÁ !
_scrimHideAnimation
ÁÁ 1
.
ÁÁ1 2
RunAsync
ÁÁ2 :
(
ÁÁ: ;
_scrimBorder
ÁÁ; G
,
ÁÁG H
CancellationToken
ÁÁI Z
.
ÁÁZ [
None
ÁÁ[ _
)
ÁÁ_ `
)
ÁÁ` a
;
ÁÁa b
}
ÂÂ 
await
ÄÄ 
Task
ÄÄ 
.
ÄÄ 
WhenAll
ÄÄ 
(
ÄÄ 
	hideTasks
ÄÄ (
)
ÄÄ( )
;
ÄÄ) *
_sheetBorder
ÆÆ 
.
ÆÆ 
	IsVisible
ÆÆ "
=
ÆÆ# $
false
ÆÆ% *
;
ÆÆ* +
if
ÇÇ 
(
ÇÇ 
_scrimBorder
ÇÇ 
is
ÇÇ 
not
ÇÇ  #
null
ÇÇ$ (
)
ÇÇ( )
{
ÈÈ 
_scrimBorder
ÉÉ 
.
ÉÉ 
	IsVisible
ÉÉ &
=
ÉÉ' (
false
ÉÉ) .
;
ÉÉ. /
}
ÊÊ 
	_rootGrid
ÌÌ 
.
ÌÌ 
	IsVisible
ÌÌ 
=
ÌÌ  !
false
ÌÌ" '
;
ÌÌ' (
}
ÍÍ 	
finally
ÎÎ 
{
ÏÏ 	
_isAnimating
ÐÐ 
=
ÐÐ 
false
ÐÐ  
;
ÐÐ  !
}
ÑÑ 	
}
ÒÒ 
private
ÔÔ 
void
ÔÔ 
CreateAnimations
ÔÔ !
(
ÔÔ! "
)
ÔÔ" #
{
ÕÕ 
double
ÖÖ 
hiddenPosition
ÖÖ 
=
ÖÖ 
_sheetHeight
ÖÖ  ,
;
ÖÖ, -
CubicEaseInOut
ØØ 

showEasing
ØØ !
=
ØØ" #
new
ØØ$ '
(
ØØ' (
)
ØØ( )
;
ØØ) *
CubicEaseInOut
ÙÙ 

hideEasing
ÙÙ !
=
ÙÙ" #
new
ÙÙ$ '
(
ÙÙ' (
)
ÙÙ( )
;
ÙÙ) *
_showAnimation
ÛÛ 
=
ÛÛ 
new
ÛÛ 
	Animation
ÛÛ &
{
ÜÜ 	
Duration
ÝÝ 
=
ÝÝ +
BottomSheetAnimationConstants
ÝÝ 4
.
ÝÝ4 5#
ShowAnimationDuration
ÝÝ5 J
,
ÝÝJ K
Easing
ÞÞ 
=
ÞÞ 

showEasing
ÞÞ 
,
ÞÞ  
FillMode
ßß 
=
ßß 
FillMode
ßß 
.
ßß  
Both
ßß  $
,
ßß$ %
Children
àà 
=
àà 
{
áá 
new
ââ 
KeyFrame
ââ 
{
ââ 
Cue
ââ "
=
ââ# $
new
ââ% (
Cue
ââ) ,
(
ââ, -
$num
ââ- 0
)
ââ0 1
,
ââ1 2
Setters
ââ3 :
=
ââ; <
{
ââ= >
new
ââ? B
Setter
ââC I
(
ââI J 
TranslateTransform
ââJ \
.
ââ\ ]
	YProperty
ââ] f
,
ââf g
hiddenPosition
ââh v
)
ââv w
,
ââw x
new
âây |
Setterââ} ƒ
(ââƒ „
OpacityPropertyââ„ “
,ââ“ ”
$numââ• ˜
)ââ˜ ™
}ââš ›
}ââœ 
,ââ ž
new
ãã 
KeyFrame
ãã 
{
ãã 
Cue
ãã "
=
ãã# $
new
ãã% (
Cue
ãã) ,
(
ãã, -
$num
ãã- 0
)
ãã0 1
,
ãã1 2
Setters
ãã3 :
=
ãã; <
{
ãã= >
new
ãã? B
Setter
ããC I
(
ããI J 
TranslateTransform
ããJ \
.
ãã\ ]
	YProperty
ãã] f
,
ããf g
$num
ããh k
)
ããk l
}
ããm n
}
ãão p
}
ää 
}
åå 	
;
åå	 

_hideAnimation
çç 
=
çç 
new
çç 
	Animation
çç &
{
èè 	
Duration
éé 
=
éé +
BottomSheetAnimationConstants
éé 4
.
éé4 5#
HideAnimationDuration
éé5 J
,
ééJ K
Easing
êê 
=
êê 

hideEasing
êê 
,
êê  
FillMode
ëë 
=
ëë 
FillMode
ëë 
.
ëë  
Both
ëë  $
,
ëë$ %
Children
ìì 
=
ìì 
{
íí 
new
îî 
KeyFrame
îî 
{
îî 
Cue
îî "
=
îî# $
new
îî% (
Cue
îî) ,
(
îî, -
$num
îî- 0
)
îî0 1
,
îî1 2
Setters
îî3 :
=
îî; <
{
îî= >
new
îî? B
Setter
îîC I
(
îîI J 
TranslateTransform
îîJ \
.
îî\ ]
	YProperty
îî] f
,
îîf g
$num
îîh k
)
îîk l
,
îîl m
new
îîn q
Setter
îîr x
(
îîx y
OpacityPropertyîîy ˆ
,îîˆ ‰
$numîîŠ 
)îî Ž
}îî 
}îî‘ ’
,îî’ “
new
ïï 
KeyFrame
ïï 
{
ïï 
Cue
ïï "
=
ïï# $
new
ïï% (
Cue
ïï) ,
(
ïï, -
$num
ïï- 0
)
ïï0 1
,
ïï1 2
Setters
ïï3 :
=
ïï; <
{
ïï= >
new
ïï? B
Setter
ïïC I
(
ïïI J 
TranslateTransform
ïïJ \
.
ïï\ ]
	YProperty
ïï] f
,
ïïf g
hiddenPosition
ïïh v
)
ïïv w
,
ïïw x
new
ïïy |
Setterïï} ƒ
(ïïƒ „
OpacityPropertyïï„ “
,ïï“ ”
$numïï• ˜
)ïï˜ ™
}ïïš ›
}ïïœ 
}
ðð 
}
ññ 	
;
ññ	 

if
óó 

(
óó 
	ViewModel
óó 
?
óó 
.
óó 
	ShowScrim
óó  
is
óó! #
not
óó$ '
true
óó( ,
)
óó, -
{
ôô 	
return
õõ 
;
õõ 
}
öö 	!
_scrimShowAnimation
øø 
=
øø 
new
øø !
	Animation
øø" +
{
ùù 	
Duration
úú 
=
úú +
BottomSheetAnimationConstants
úú 4
.
úú4 5#
ShowAnimationDuration
úú5 J
,
úúJ K
Easing
ûû 
=
ûû 
new
ûû 
CubicEaseInOut
ûû '
(
ûû' (
)
ûû( )
,
ûû) *
FillMode
üü 
=
üü 
FillMode
üü 
.
üü  
Both
üü  $
,
üü$ %
Children
ýý 
=
ýý 
{
þþ 
new
ÿÿ 
KeyFrame
ÿÿ 
{
ÿÿ 
Cue
ÿÿ "
=
ÿÿ# $
new
ÿÿ% (
Cue
ÿÿ) ,
(
ÿÿ, -
$num
ÿÿ- 0
)
ÿÿ0 1
,
ÿÿ1 2
Setters
ÿÿ3 :
=
ÿÿ; <
{
ÿÿ= >
new
ÿÿ? B
Setter
ÿÿC I
(
ÿÿI J
OpacityProperty
ÿÿJ Y
,
ÿÿY Z
$num
ÿÿ[ ^
)
ÿÿ^ _
}
ÿÿ` a
}
ÿÿb c
,
ÿÿc d
new
€€ 
KeyFrame
€€ 
{
€€ 
Cue
€€ "
=
€€# $
new
€€% (
Cue
€€) ,
(
€€, -
$num
€€- 0
)
€€0 1
,
€€1 2
Setters
€€3 :
=
€€; <
{
€€= >
new
€€? B
Setter
€€C I
(
€€I J
OpacityProperty
€€J Y
,
€€Y Z
$num
€€[ ^
)
€€^ _
}
€€` a
}
€€b c
}
 
}
‚‚ 	
;
‚‚	 
!
_scrimHideAnimation
„„ 
=
„„ 
new
„„ !
	Animation
„„" +
{
…… 	
Duration
†† 
=
†† +
BottomSheetAnimationConstants
†† 4
.
††4 5#
HideAnimationDuration
††5 J
,
††J K
Easing
‡‡ 
=
‡‡ 
new
‡‡ 
CubicEaseInOut
‡‡ '
(
‡‡' (
)
‡‡( )
,
‡‡) *
FillMode
ˆˆ 
=
ˆˆ 
FillMode
ˆˆ 
.
ˆˆ  
Both
ˆˆ  $
,
ˆˆ$ %
Children
‰‰ 
=
‰‰ 
{
ŠŠ 
new
‹‹ 
KeyFrame
‹‹ 
{
‹‹ 
Cue
‹‹ "
=
‹‹# $
new
‹‹% (
Cue
‹‹) ,
(
‹‹, -
$num
‹‹- 0
)
‹‹0 1
,
‹‹1 2
Setters
‹‹3 :
=
‹‹; <
{
‹‹= >
new
‹‹? B
Setter
‹‹C I
(
‹‹I J
OpacityProperty
‹‹J Y
,
‹‹Y Z
$num
‹‹[ ^
)
‹‹^ _
}
‹‹` a
}
‹‹b c
,
‹‹c d
new
ŒŒ 
KeyFrame
ŒŒ 
{
ŒŒ 
Cue
ŒŒ "
=
ŒŒ# $
new
ŒŒ% (
Cue
ŒŒ) ,
(
ŒŒ, -
$num
ŒŒ- 0
)
ŒŒ0 1
,
ŒŒ1 2
Setters
ŒŒ3 :
=
ŒŒ; <
{
ŒŒ= >
new
ŒŒ? B
Setter
ŒŒC I
(
ŒŒI J
OpacityProperty
ŒŒJ Y
,
ŒŒY Z
$num
ŒŒ[ ^
)
ŒŒ^ _
}
ŒŒ` a
}
ŒŒb c
}
 
}
ŽŽ 	
;
ŽŽ	 

}
 
private
‘‘ 
async
‘‘ 
void
‘‘ #
OnScrimPointerPressed
‘‘ ,
(
‘‘, -
object
‘‘- 3
?
‘‘3 4
sender
‘‘5 ;
,
‘‘; <%
PointerPressedEventArgs
‘‘= T
e
‘‘U V
)
‘‘V W
{
’’ 
try
““ 
{
”” 	
if
•• 
(
•• 
!
•• '
IsDismissableOnScrimClick
•• *
||
••+ -
	ViewModel
••. 7
is
••8 :
null
••; ?
||
••@ B
_isAnimating
••C O
)
••O P
{
–– 
return
—— 
;
—— 
}
˜˜ 
	ViewModel
šš 
.
šš 
	IsVisible
šš 
=
šš  !
false
šš" '
;
šš' (
await
œœ 
Task
œœ 
.
œœ 
Delay
œœ 
(
œœ +
BottomSheetAnimationConstants
œœ :
.
œœ: ;#
HideAnimationDuration
œœ; P
)
œœP Q
;
œœQ R
	ViewModel
žž 
.
žž "
BottomSheetDismissed
žž *
(
žž* +
)
žž+ ,
;
žž, -
}
ŸŸ 	
catch
   
{
¡¡ 	
}
££ 	
}
¤¤ 
private
¦¦ 
static
¦¦ 
readonly
¦¦ 
FrozenDictionary
¦¦ ,
<
¦¦, -
Key
¦¦- 0
,
¦¦0 1
Func
¦¦2 6
<
¦¦6 7 
BottomSheetControl
¦¦7 I
,
¦¦I J
bool
¦¦K O
>
¦¦O P
>
¦¦P Q
DismissKeys
¦¦R ]
=
¦¦^ _
new
§§ 

Dictionary
§§ 
<
§§ 
Key
§§ 
,
§§ 
Func
§§  
<
§§  ! 
BottomSheetControl
§§! 3
,
§§3 4
bool
§§5 9
>
§§9 :
>
§§: ;
{
¨¨ 	
{
©© 
Key
©© 
.
©© 
Enter
©© 
,
©© 
control
©©  
=>
©©! #
control
©©$ +
.
©©+ ,'
IsDismissableOnScrimClick
©©, E
}
©©F G
,
©©G H
{
ªª 
Key
ªª 
.
ªª 
Escape
ªª 
,
ªª 
control
ªª !
=>
ªª" $
control
ªª% ,
.
ªª, -'
IsDismissableOnScrimClick
ªª- F
}
ªªG H
,
ªªH I
{
«« 
Key
«« 
.
«« 
Space
«« 
,
«« 
control
««  
=>
««! #
control
««$ +
.
««+ ,'
IsDismissableOnScrimClick
««, E
}
««F G
}
¬¬ 	
.
¬¬	 
 
ToFrozenDictionary
¬¬
 
(
¬¬ 
)
¬¬ 
;
¬¬ 
private
®® 
async
®® 
void
®® 
	OnKeyDown
®®  
(
®®  !
object
®®! '
?
®®' (
sender
®®) /
,
®®/ 0
KeyEventArgs
®®1 =
e
®®> ?
)
®®? @
{
¯¯ 
if
°° 

(
°° 
DismissKeys
°° 
.
°° 
TryGetValue
°° #
(
°°# $
e
°°$ %
.
°°% &
Key
°°& )
,
°°) *
out
°°+ .
Func
°°/ 3
<
°°3 4 
BottomSheetControl
°°4 F
,
°°F G
bool
°°H L
>
°°L M
?
°°M N
shouldDismiss
°°O \
)
°°\ ]
&&
°°^ `
shouldDismiss
±± 
(
±± 
this
±± 
)
±± 
&&
±±  "
	ViewModel
²² 
is
²² 
not
²² 
null
²² !
&&
²²" $
!
³³ 
_isAnimating
³³ 
)
³³ 
{
´´ 	
	ViewModel
µµ 
.
µµ 
	IsVisible
µµ 
=
µµ  !
false
µµ" '
;
µµ' (
await
·· 
Task
·· 
.
·· 
Delay
·· 
(
·· +
BottomSheetAnimationConstants
·· :
.
··: ;#
HideAnimationDuration
··; P
)
··P Q
;
··Q R
	ViewModel
¹¹ 
.
¹¹ "
BottomSheetDismissed
¹¹ *
(
¹¹* +
)
¹¹+ ,
;
¹¹, -
e
ºº 
.
ºº 
Handled
ºº 
=
ºº 
true
ºº 
;
ºº 
}
»» 	
}
¼¼ 
}¾¾ ù
˜/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Modals/BottomSheetModal/BottomSheetAnimationConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Modals! '
.' (
BottomSheetModal( 8
;8 9
public 
static 
class )
BottomSheetAnimationConstants 1
{ 
public 

static 
readonly 
TimeSpan #!
ShowAnimationDuration$ 9
=: ;
TimeSpan< D
.D E
FromMillisecondsE U
(U V
$numV Y
)Y Z
;Z [
public 

static 
readonly 
TimeSpan #!
HideAnimationDuration$ 9
=: ;
TimeSpan< D
.D E
FromMillisecondsE U
(U V
$numV Y
)Y Z
;Z [
}		 Õe
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/LanguageSelector/LanguageSelectorViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
LanguageSelector! 1
;1 2
public 
sealed 
class %
LanguageSelectorViewModel -
:. /
ReactiveObject0 >
,> ?!
IActivatableViewModel@ U
,U V
IDisposableW b
{ 
private 
readonly  
ILocalizationService ) 
_localizationService* >
;> ?
private 
readonly -
!IApplicationSecureStorageProvider 6-
!_applicationSecureStorageProvider7 X
;X Y
private 
readonly  
IRpcMetaDataProvider ) 
_rpcMetaDataProvider* >
;> ?
private 
readonly 
CompositeDisposable (
_disposables) 5
=6 7
new8 ;
(; <
)< =
;= >
private 
LanguageItem 
_selectedLanguage *
;* +
private 
bool 
	_disposed 
; 
public 

ViewModelActivator 
	Activator '
{( )
get* -
;- .
}/ 0
=1 2
new3 6
(6 7
)7 8
;8 9
private 
static 
readonly 
AppCultureSettings .
LanguageConfig/ =
=> ?
AppCultureSettings@ R
.R S
DefaultS Z
;Z [
public!! 
 
ObservableCollection!! 
<!!  
LanguageItem!!  ,
>!!, -
AvailableLanguages!!. @
{!!A B
get!!C F
;!!F G
}!!H I
=!!J K
new"" 
("" 
LanguageConfig"" 
."" 
SupportedLanguages"" -
)""- .
;"". /
public$$ 

LanguageItem$$ 
SelectedLanguage$$ (
{%% 
get&& 
=>&& 
_selectedLanguage&&  
;&&  !
set'' 
=>'' 
this'' 
.''  
RaiseAndSetIfChanged'' (
(''( )
ref'') ,
_selectedLanguage''- >
,''> ?
value''@ E
)''E F
;''F G
}(( 
public** 

ReactiveCommand** 
<** 
Unit** 
,**  
Unit**! %
>**% &!
ToggleLanguageCommand**' <
{**= >
get**? B
;**B C
}**D E
public,, 
%
LanguageSelectorViewModel,, $
(,,$ % 
ILocalizationService,,% 9
localizationService,,: M
,,,M N-
!IApplicationSecureStorageProvider-- ),
 applicationSecureStorageProvider--* J
,--J K 
IRpcMetaDataProvider.. 
rpcMetaDataProvider.. 0
)..0 1
{//  
_localizationService00 
=00 
localizationService00 2
;002 3-
!_applicationSecureStorageProvider11 )
=11* +,
 applicationSecureStorageProvider11, L
;11L M 
_rpcMetaDataProvider22 
=22 
rpcMetaDataProvider22 2
;222 3
_selectedLanguage44 
=44 
GetLanguageByCode44 -
(44- . 
_localizationService44. B
.44B C
CurrentCultureName44C U
)44U V
??44W Y
LanguageConfig55 *
.55* +
SupportedLanguages55+ =
.55= >
First55> C
(55C D
)55D E
;55E F
IObservable77 
<77 
string77 
>77 
languageChanges77 +
=77, -$
CreateLanguageObservable77. F
(77F G
)77G H
;77H I!
ToggleLanguageCommand99 
=99 
ReactiveCommand99  /
.99/ 0
Create990 6
(996 7
ToggleLanguage997 E
)99E F
;99F G
_disposables;; 
.;; 
Add;; 
(;; !
ToggleLanguageCommand;; .
);;. /
;;;/ 0!
SetupReactiveBindings== 
(== 
languageChanges== -
)==- .
;==. /
}>> 
private@@ 
static@@ 
LanguageItem@@ 
?@@  
GetLanguageByCode@@! 2
(@@2 3
string@@3 9
cultureCode@@: E
)@@E F
=>@@G I
LanguageConfigAA 
.AA 
GetLanguageByCodeAA (
(AA( )
cultureCodeAA) 4
)AA4 5
.AA5 6

ToNullableAA6 @
(AA@ A
)AAA B
;AAB C
privateCC 
staticCC 
intCC 
GetLanguageIndexCC '
(CC' (
stringCC( .
cultureCodeCC/ :
)CC: ;
=>CC< >
LanguageConfigDD 
.DD 
GetLanguageIndexDD '
(DD' (
cultureCodeDD( 3
)DD3 4
;DD4 5
privateFF 
voidFF 
ToggleLanguageFF 
(FF  
)FF  !
{GG 
intHH 
currentIndexHH 
=HH 
GetLanguageIndexHH +
(HH+ , 
_localizationServiceHH, @
.HH@ A
CurrentCultureNameHHA S
)HHS T
;HHT U
intII 
	nextIndexII 
=II 
(II 
currentIndexII %
+II& '
$numII( )
)II) *
%II+ ,
AvailableLanguagesII- ?
.II? @
CountII@ E
;IIE F 
_localizationServiceJJ 
.JJ 

SetCultureJJ '
(JJ' (
AvailableLanguagesJJ( :
[JJ: ;
	nextIndexJJ; D
]JJD E
.JJE F
CodeJJF J
)JJJ K
;JJK L
}KK 
privateMM 
IObservableMM 
<MM 
stringMM 
>MM $
CreateLanguageObservableMM  8
(MM8 9
)MM9 :
=>MM; =

ObservableNN 
.NN 
CreateNN 
<NN 
stringNN  
>NN  !
(NN! "
observerNN" *
=>NN+ -
{OO  
_localizationServicePP $
.PP$ %
LanguageChangedPP% 4
+=PP5 7
HandlerPP8 ?
;PP? @
observerQQ 
.QQ 
OnNextQQ 
(QQ   
_localizationServiceQQ  4
.QQ4 5
CurrentCultureNameQQ5 G
)QQG H
;QQH I
returnSS 

DisposableSS !
.SS! "
CreateSS" (
(SS( )
(SS) *
)SS* +
=>SS, . 
_localizationServiceSS/ C
.SSC D
LanguageChangedSSD S
-=SST V
HandlerSSW ^
)SS^ _
;SS_ `
voidUU 
HandlerUU 
(UU 
)UU 
=>UU !
observerUU" *
.UU* +
OnNextUU+ 1
(UU1 2 
_localizationServiceUU2 F
.UUF G
CurrentCultureNameUUG Y
)UUY Z
;UUZ [
}VV 
)VV 
.WW  
DistinctUntilChangedWW !
(WW! "
)WW" #
;WW# $
privateYY 
voidYY !
SetupReactiveBindingsYY &
(YY& '
IObservableYY' 2
<YY2 3
stringYY3 9
>YY9 :
languageChangesYY; J
)YYJ K
{ZZ 
this[[ 
.[[ 
WhenActivated[[ 
([[ 
disposables[[ &
=>[[' )
{\\ 	
languageChanges]] 
.^^ 
Select^^ 
(^^ 
culture^^ 
=>^^  "
GetLanguageByCode^^# 4
(^^4 5
culture^^5 <
)^^< =
??^^> @
AvailableLanguages^^A S
[^^S T
$num^^T U
]^^U V
)^^V W
.__ 
BindTo__ 
(__ 
this__ 
,__ 
x__ 
=>__  "
x__# $
.__$ %
SelectedLanguage__% 5
)__5 6
.`` 
DisposeWith`` 
(`` 
disposables`` (
)``( )
;``) *
thisbb 
.bb 
WhenAnyValuebb 
(bb 
xbb 
=>bb  "
xbb# $
.bb$ %
SelectedLanguagebb% 5
)bb5 6
.cc 
Wherecc 
(cc 
itemcc 
=>cc 
itemcc #
.cc# $
Codecc$ (
!=cc) + 
_localizationServicecc, @
.cc@ A
CurrentCultureNameccA S
)ccS T
.dd 
	Subscribedd 
(dd 
itemdd 
=>dd  "
{ee  
_localizationServiceff (
.ff( )

SetCultureff) 3
(ff3 4
itemff4 8
.ff8 9
Codeff9 =
,ff= >
(ff? @
)ff@ A
=>ffB D
HandleCultureChangeffE X
(ffX Y
itemffY ]
.ff] ^
Codeff^ b
)ffb c
)ffc d
;ffd e
}gg 
)gg 
.hh 
DisposeWithhh 
(hh 
disposableshh (
)hh( )
;hh) *
}ii 	
)ii	 

;ii
 
}jj 
privatell 
voidll 
HandleCultureChangell $
(ll$ %
stringll% +
cultureCodell, 7
)ll7 8
{mm 
_nn 	
=nn
 &
PersistCultureSettingAsyncnn &
(nn& '
cultureCodenn' 2
)nn2 3
.nn3 4
ContinueWithnn4 @
(nn@ A
taskoo 
=>oo 
{pp 
ifqq 
(qq 
taskqq 
.qq 
	IsFaultedqq "
&&qq# %
taskqq& *
.qq* +
	Exceptionqq+ 4
!=qq5 7
nullqq8 <
)qq< =
{rr 
Serilogss 
.ss 
Logss 
.ss  
Errorss  %
(ss% &
taskss& *
.ss* +
	Exceptionss+ 4
,ss4 5
$strss6 v
)ssv w
;ssw x
}tt 
}uu 
,uu 
Systemvv 
.vv 
	Threadingvv 
.vv 
Tasksvv "
.vv" #
TaskSchedulervv# 0
.vv0 1
Defaultvv1 8
)vv8 9
;vv9 : 
_rpcMetaDataProviderxx 
.xx 

SetCulturexx '
(xx' (
cultureCodexx( 3
)xx3 4
;xx4 5
}yy 
private{{ 
async{{ 
System{{ 
.{{ 
	Threading{{ "
.{{" #
Tasks{{# (
.{{( )
Task{{) -&
PersistCultureSettingAsync{{. H
({{H I
string{{I O
cultureCode{{P [
){{[ \
{|| 
try}} 
{~~ 	
Result 
< 
	Utilities 
. 
Unit !
,! "%
InternalServiceApiFailure# <
>< =
result> D
=E F
await
€€ /
!_applicationSecureStorageProvider
€€ 7
.
 0
"SetApplicationSettingsCultureAsync
 7
(
7 8
cultureCode
8 C
)
C D
.
D E
ConfigureAwait
E S
(
S T
false
T Y
)
Y Z
;
Z [
if
ƒƒ 
(
ƒƒ 
result
ƒƒ 
.
ƒƒ 
IsErr
ƒƒ 
)
ƒƒ 
{
„„ 
Serilog
…… 
.
…… 
Log
…… 
.
…… 
Warning
…… #
(
……# $
$str
†† o
,
††o p
cultureCode
‡‡ 
,
‡‡  
result
‡‡! '
.
‡‡' (
	UnwrapErr
‡‡( 1
(
‡‡1 2
)
‡‡2 3
.
‡‡3 4
Message
‡‡4 ;
)
‡‡; <
;
‡‡< =
}
ˆˆ 
}
‰‰ 	
catch
ŠŠ 
(
ŠŠ 
	Exception
ŠŠ 
ex
ŠŠ 
)
ŠŠ 
{
‹‹ 	
Serilog
ŒŒ 
.
ŒŒ 
Log
ŒŒ 
.
ŒŒ 
Error
ŒŒ 
(
ŒŒ 
ex
ŒŒ  
,
ŒŒ  !
$str
ŒŒ" p
,
ŒŒp q
cultureCode
 
)
 
;
 
}
ŽŽ 	
}
 
public
‘‘ 

void
‘‘ 
Dispose
‘‘ 
(
‘‘ 
)
‘‘ 
{
’’ 
if
““ 

(
““ 
	_disposed
““ 
)
““ 
{
”” 	
return
•• 
;
•• 
}
–– 	#
ToggleLanguageCommand
˜˜ 
?
˜˜ 
.
˜˜ 
Dispose
˜˜ &
(
˜˜& '
)
˜˜' (
;
˜˜( )
_disposables
™™ 
.
™™ 
Dispose
™™ 
(
™™ 
)
™™ 
;
™™ 
	_disposed
›› 
=
›› 
true
›› 
;
›› 
}
œœ 
} é
Ž/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/LanguageSelector/LanguageSelectorView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
LanguageSelector! 1
;1 2
public		 
partial		 
class		  
LanguageSelectorView		 )
:		* +
ReactiveUserControl		, ?
<		? @%
LanguageSelectorViewModel		@ Y
>		Y Z
{

 
public 
 
LanguageSelectorView 
(  
)  !
{ 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
} 
public 
 
LanguageSelectorView 
(   
ILocalizationService  4
localizationService5 H
,H I-
!IApplicationSecureStorageProvider ),
 applicationSecureStorageProvider* J
,J K 
IRpcMetaDataProviderL `
rpcMetaDataProvidera t
)t u
:v w
thisx |
(| }
)} ~
{ 
DataContext 
= 
new %
LanguageSelectorViewModel 3
(3 4
localizationService4 G
,G H,
 applicationSecureStorageProviderI i
,i j
rpcMetaDataProviderk ~
)~ 
;	 €
} 
} ½
€/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/LanguageSelector/LanguageItem.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
LanguageSelector! 1
;1 2
public 
record 
LanguageItem 
( 
string !
Code" &
,& '
string( .
DisplayName/ :
,: ;
string< B
FlagImagePathC P
)P Q
;Q R
/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/EventArgs/SecureKeyCharactersRemovedEventArgs.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
	EventArgs! *
;* +
public 
class /
#SecureKeyCharactersRemovedEventArgs 0
(0 1
RoutedEvent1 <
routedEvent= H
,H I
intJ M
indexN S
,S T
intU X
countY ^
)^ _
: 
RoutedEventArgs 
( 
routedEvent !
)! "
{ 
public 

int 
Index 
{ 
get 
; 
} 
= 
index  %
;% &
public		 

int		 
Count		 
{		 
get		 
;		 
}		 
=		 
count		  %
;		% &
}

 ¡
Ž/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/EventArgs/SecureKeyCharactersAddedEventArgs.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
	EventArgs! *
;* +
public 
class -
!SecureKeyCharactersAddedEventArgs .
(. /
RoutedEvent/ :
routedEvent; F
,F G
intH K
indexL Q
,Q R
stringS Y

charactersZ d
)d e
: 
RoutedEventArgs 
( 
routedEvent !
)! "
{ 
public 

int 
Index 
{ 
get 
; 
} 
= 
index  %
;% &
public		 

string		 

Characters		 
{		 
get		 "
;		" #
}		$ %
=		& '

characters		( 2
;		2 3
}

 õ	
‡/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/EventArgs/CharacterRejectedEventArgs.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
	EventArgs! *
;* +
public 
sealed 
class &
CharacterRejectedEventArgs .
(. /
char 
rejectedCharacter	 
,  
CharacterWarningType 
warningType $
,$ %
string		 

input		 
=		 
$str		 
)		 
:

 
RoutedEventArgs

 
{ 
public 

char 
RejectedCharacter !
{" #
get$ '
;' (
}) *
=+ ,
rejectedCharacter- >
;> ?
public 
 
CharacterWarningType 
WarningType  +
{, -
get. 1
;1 2
}3 4
=5 6
warningType7 B
;B C
public 

string 
Input 
{ 
get 
; 
}  
=! "
input# (
;( )
} ç
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Core/SegmentedTextBox.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Core! %
;% &
public 
partial 
class 
SegmentedTextBox %
:& '
UserControl( 3
{ 
public 

static 
readonly 
StyledProperty )
<) *
int* -
>- . 
SegmentCountProperty/ C
=D E
AvaloniaProperty 
. 
Register !
<! "
SegmentedTextBox" 2
,2 3
int4 7
>7 8
(8 9
nameof9 ?
(? @
SegmentCount@ L
)L M
,M N%
SegmentedTextBoxConstants %
.% &!
DEFAULT_SEGMENT_COUNT& ;
,; <
validate= E
:E F
valueG L
=>M O
valueP U
>V W
$numX Y
)Y Z
;Z [
public 

static 
readonly 
StyledProperty )
<) *
bool* .
>. /$
AllowOnlyNumbersProperty0 H
=I J
AvaloniaProperty 
. 
Register !
<! "
SegmentedTextBox" 2
,2 3
bool4 8
>8 9
(9 :
nameof: @
(@ A
AllowOnlyNumbersA Q
)Q R
)R S
;S T
public 

static 
readonly 
StyledProperty )
<) *
bool* .
>. //
#IsPointerInteractionEnabledProperty0 S
=T U
AvaloniaProperty 
. 
Register !
<! "
SegmentedTextBox" 2
,2 3
bool4 8
>8 9
(9 :
nameof: @
(@ A'
IsPointerInteractionEnabledA \
)\ ]
,] ^%
SegmentedTextBoxConstants %
.% &*
IS_POINTER_INTERACTION_ENABLED& D
)D E
;E F
public   

static   
readonly   
StyledProperty   )
<  ) *
IBrush  * 0
>  0 1%
SegmentBackgroundProperty  2 K
=  L M
AvaloniaProperty!! 
.!! 
Register!! !
<!!! "
SegmentedTextBox!!" 2
,!!2 3
IBrush!!4 :
>!!: ;
(!!; <
nameof!!< B
(!!B C
SegmentBackground!!C T
)!!T U
,!!U V
Brushes!!W ^
.!!^ _
Transparent!!_ j
)!!j k
;!!k l
public## 

static## 
readonly## 
StyledProperty## )
<##) *
IBrush##* 0
>##0 1,
 ActiveSegmentBorderColorProperty##2 R
=##S T
AvaloniaProperty$$ 
.$$ 
Register$$ !
<$$! "
SegmentedTextBox$$" 2
,$$2 3
IBrush$$4 :
>$$: ;
($$; <
nameof$$< B
($$B C$
ActiveSegmentBorderColor$$C [
)$$[ \
,$$\ ]
Brushes$$^ e
.$$e f
Blue$$f j
)$$j k
;$$k l
public&& 

static&& 
readonly&& 
StyledProperty&& )
<&&) *
string&&* 0
>&&0 1
ValueProperty&&2 ?
=&&@ A
AvaloniaProperty'' 
.'' 
Register'' !
<''! "
SegmentedTextBox''" 2
,''2 3
string''4 :
>'': ;
(''; <
nameof''< B
(''B C
Value''C H
)''H I
,''I J
$str''K M
,''M N
defaultBindingMode(( 
:(( 
Avalonia((  (
.((( )
Data(() -
.((- .
BindingMode((. 9
.((9 :
TwoWay((: @
)((@ A
;((A B
public** 

static** 
readonly** 
StyledProperty** )
<**) *
bool*** .
>**. /
IsCompleteProperty**0 B
=**C D
AvaloniaProperty++ 
.++ 
Register++ !
<++! "
SegmentedTextBox++" 2
,++2 3
bool++4 8
>++8 9
(++9 :
nameof++: @
(++@ A

IsComplete++A K
)++K L
,++L M
defaultBindingMode,, 
:,, 
Avalonia,,  (
.,,( )
Data,,) -
.,,- .
BindingMode,,. 9
.,,9 :
OneWayToSource,,: H
),,H I
;,,I J
public.. 

static.. 
readonly.. 
StyledProperty.. )
<..) *
double..* 0
>..0 1"
SegmentSpacingProperty..2 H
=..I J
AvaloniaProperty// 
.// 
Register// !
<//! "
SegmentedTextBox//" 2
,//2 3
double//4 :
>//: ;
(//; <
nameof//< B
(//B C
SegmentSpacing//C Q
)//Q R
,//R S%
SegmentedTextBoxConstants00 %
.00% &#
DEFAULT_SEGMENT_SPACING00& =
)00= >
;00> ?
public22 

static22 
readonly22 
StyledProperty22 )
<22) *
double22* 0
>220 1 
SegmentWidthProperty222 F
=22G H
AvaloniaProperty33 
.33 
Register33 !
<33! "
SegmentedTextBox33" 2
,332 3
double334 :
>33: ;
(33; <
nameof33< B
(33B C
SegmentWidth33C O
)33O P
,33P Q%
SegmentedTextBoxConstants44 %
.44% &!
DEFAULT_SEGMENT_WIDTH44& ;
)44; <
;44< =
public66 

static66 
readonly66 
StyledProperty66 )
<66) *
int66* -
>66- . 
BaseTabIndexProperty66/ C
=66D E
AvaloniaProperty77 
.77 
Register77 !
<77! "
SegmentedTextBox77" 2
,772 3
int774 7
>777 8
(778 9
nameof779 ?
(77? @
BaseTabIndex77@ L
)77L M
,77M N
int77O R
.77R S
MaxValue77S [
)77[ \
;77\ ]
private99 
static99 
readonly99 
string99 "
[99" #
]99# $
DigitStrings99% 1
=992 3
new994 7
string998 >
[99> ?
$num99? A
]99A B
;99B C
private;; 
readonly;; 
List;; 
<;; 
TextBox;; !
>;;! "
	_segments;;# ,
=;;- .
[;;/ 0
];;0 1
;;;1 2
private== 
int== 
_currentActiveIndex== #
;==# $
private>> 
bool>> 
_isInternalUpdate>> "
;>>" #
static@@ 

SegmentedTextBox@@ 
(@@ 
)@@ 
{AA 
forBB 
(BB 
intBB 
iBB 
=BB 
$numBB 
;BB 
iBB 
<BB 
$numBB 
;BB 
iBB  !
++BB! #
)BB# $
{CC 	
DigitStringsDD 
[DD 
iDD 
]DD 
=DD 
iDD 
.DD  
ToStringDD  (
(DD( )
)DD) *
;DD* +
}EE 	
}FF 
publicHH 

SegmentedTextBoxHH 
(HH 
)HH 
{II 
InitializeComponentJJ 
(JJ 
)JJ 
;JJ 
}KK 
publicMM 

intMM 
BaseTabIndexMM 
{NN 
getOO 
=>OO 
GetValueOO 
(OO  
BaseTabIndexPropertyOO ,
)OO, -
;OO- .
setPP 
=>PP 
SetValuePP 
(PP  
BaseTabIndexPropertyPP ,
,PP, -
valuePP. 3
)PP3 4
;PP4 5
}QQ 
publicSS 

doubleSS 
SegmentSpacingSS  
{TT 
getUU 
=>UU 
GetValueUU 
(UU "
SegmentSpacingPropertyUU .
)UU. /
;UU/ 0
setVV 
=>VV 
SetValueVV 
(VV "
SegmentSpacingPropertyVV .
,VV. /
valueVV0 5
)VV5 6
;VV6 7
}WW 
publicYY 

doubleYY 
SegmentWidthYY 
{ZZ 
get[[ 
=>[[ 
GetValue[[ 
([[  
SegmentWidthProperty[[ ,
)[[, -
;[[- .
set\\ 
=>\\ 
SetValue\\ 
(\\  
SegmentWidthProperty\\ ,
,\\, -
value\\. 3
)\\3 4
;\\4 5
}]] 
public__ 

string__ 
Value__ 
{`` 
getaa 
=>aa 
GetValueaa 
(aa 
ValuePropertyaa %
)aa% &
;aa& '
setbb 
=>bb 
SetValuebb 
(bb 
ValuePropertybb %
,bb% &
valuebb' ,
)bb, -
;bb- .
}cc 
publicee 

IBrushee 
SegmentBackgroundee #
{ff 
getgg 
=>gg 
GetValuegg 
(gg %
SegmentBackgroundPropertygg 1
)gg1 2
;gg2 3
sethh 
=>hh 
SetValuehh 
(hh %
SegmentBackgroundPropertyhh 1
,hh1 2
valuehh3 8
)hh8 9
;hh9 :
}ii 
publickk 

IBrushkk $
ActiveSegmentBorderColorkk *
{ll 
getmm 
=>mm 
GetValuemm 
(mm ,
 ActiveSegmentBorderColorPropertymm 8
)mm8 9
;mm9 :
setnn 
=>nn 
SetValuenn 
(nn ,
 ActiveSegmentBorderColorPropertynn 8
,nn8 9
valuenn: ?
)nn? @
;nn@ A
}oo 
publicqq 

intqq 
SegmentCountqq 
{rr 
getss 
=>ss 
GetValuess 
(ss  
SegmentCountPropertyss ,
)ss, -
;ss- .
settt 
=>tt 
SetValuett 
(tt  
SegmentCountPropertytt ,
,tt, -
valuett. 3
)tt3 4
;tt4 5
}uu 
publicww 

boolww 
AllowOnlyNumbersww  
{xx 
getyy 
=>yy 
GetValueyy 
(yy $
AllowOnlyNumbersPropertyyy 0
)yy0 1
;yy1 2
setzz 
=>zz 
SetValuezz 
(zz $
AllowOnlyNumbersPropertyzz 0
,zz0 1
valuezz2 7
)zz7 8
;zz8 9
}{{ 
public}} 

bool}} '
IsPointerInteractionEnabled}} +
{~~ 
get 
=> 
GetValue 
( /
#IsPointerInteractionEnabledProperty ;
); <
;< =
set
€€ 
=>
€€ 
SetValue
€€ 
(
€€ 1
#IsPointerInteractionEnabledProperty
€€ ;
,
€€; <
value
€€= B
)
€€B C
;
€€C D
}
 
public
ƒƒ 

bool
ƒƒ 

IsComplete
ƒƒ 
{
„„ 
get
…… 
=>
…… 
GetValue
…… 
(
……  
IsCompleteProperty
…… *
)
……* +
;
……+ ,
private
†† 
set
†† 
=>
†† 
SetValue
†† 
(
††   
IsCompleteProperty
††  2
,
††2 3
value
††4 9
)
††9 :
;
††: ;
}
‡‡ 
public
‰‰ 

void
‰‰ 
ClearAllSegments
‰‰  
(
‰‰  !
)
‰‰! "
{
ŠŠ 
foreach
‹‹ 
(
‹‹ 
TextBox
‹‹ 
segment
‹‹  
in
‹‹! #
	_segments
‹‹$ -
)
‹‹- .
{
ŒŒ 	
segment
 
.
 
Text
 
=
 
string
 !
.
! "
Empty
" '
;
' (
}
ŽŽ 	
SetActiveSegment
 
(
 
$num
 
)
 
;
 
OnSegmentChanged
‘‘ 
(
‘‘ 
)
‘‘ 
;
‘‘ 
}
’’ 
	protected
”” 
override
”” 
void
”” %
OnAttachedToLogicalTree
”” 3
(
””3 4,
LogicalTreeAttachmentEventArgs
””4 R
e
””S T
)
””T U
{
•• 
base
–– 
.
–– %
OnAttachedToLogicalTree
–– $
(
––$ %
e
––% &
)
––& '
;
––' (
BuildSegments
—— 
(
—— 
)
—— 
;
—— 
}
˜˜ 
	protected
šš 
override
šš 
void
šš '
OnDetachedFromLogicalTree
šš 5
(
šš5 6,
LogicalTreeAttachmentEventArgs
šš6 T
e
ššU V
)
ššV W
{
›› 
base
œœ 
.
œœ '
OnDetachedFromLogicalTree
œœ &
(
œœ& '
e
œœ' (
)
œœ( )
;
œœ) *
CleanupSegments
 
(
 
)
 
;
 
}
žž 
	protected
   
override
   
void
   
OnPropertyChanged
   -
(
  - ..
 AvaloniaPropertyChangedEventArgs
  . N
change
  O U
)
  U V
{
¡¡ 
base
¢¢ 
.
¢¢ 
OnPropertyChanged
¢¢ 
(
¢¢ 
change
¢¢ %
)
¢¢% &
;
¢¢& '
if
¤¤ 

(
¤¤ 
change
¤¤ 
.
¤¤ 
Property
¤¤ 
==
¤¤ "
SegmentCountProperty
¤¤ 3
)
¤¤3 4
{
¥¥ 	
BuildSegments
¦¦ 
(
¦¦ 
)
¦¦ 
;
¦¦ 
}
§§ 	
if
©© 

(
©© 
change
©© 
.
©© 
Property
©© 
==
©© 
ValueProperty
©© ,
&&
©©- /
!
©©0 1
_isInternalUpdate
©©1 B
)
©©B C
{
ªª 	
string
«« 
newValue
«« 
=
«« 
change
«« $
.
««$ %
NewValue
««% -
as
««. 0
string
««1 7
??
««8 :
string
««; A
.
««A B
Empty
««B G
;
««G H
if
­­ 
(
­­ 
string
­­ 
.
­­ 
IsNullOrEmpty
­­ $
(
­­$ %
newValue
­­% -
)
­­- .
)
­­. /
{
®® 
ClearAllSegments
¯¯  
(
¯¯  !
)
¯¯! "
;
¯¯" #
}
°° 
else
±± 
{
²² %
UpdateSegmentsFromValue
³³ '
(
³³' (
newValue
³³( 0
)
³³0 1
;
³³1 2
}
´´ 
}
µµ 	
}
¶¶ 
private
¸¸ 
static
¸¸ 
string
¸¸ "
ValidateNumericInput
¸¸ .
(
¸¸. /
string
¸¸/ 5
input
¸¸6 ;
)
¸¸; <
{
¹¹ 
if
ºº 

(
ºº 
string
ºº 
.
ºº 
IsNullOrEmpty
ºº  
(
ºº  !
input
ºº! &
)
ºº& '
)
ºº' (
{
»» 	
return
¼¼ 
input
¼¼ 
;
¼¼ 
}
½½ 	
char
¿¿ 

firstDigit
¿¿ 
=
¿¿ 
input
¿¿ 
.
¿¿  
FirstOrDefault
¿¿  .
(
¿¿. /
char
¿¿/ 3
.
¿¿3 4
IsDigit
¿¿4 ;
)
¿¿; <
;
¿¿< =
if
ÀÀ 

(
ÀÀ 

firstDigit
ÀÀ 
==
ÀÀ 
$num
ÀÀ 
)
ÀÀ 
{
ÁÁ 	
return
ÂÂ 
$str
ÂÂ 
;
ÂÂ 
}
ÃÃ 	
int
ÅÅ 

digitValue
ÅÅ 
=
ÅÅ 

firstDigit
ÅÅ #
-
ÅÅ$ %
$char
ÅÅ& )
;
ÅÅ) *
return
ÆÆ 

digitValue
ÆÆ 
is
ÆÆ 
>=
ÆÆ 
$num
ÆÆ  !
and
ÆÆ" %
<=
ÆÆ& (
$num
ÆÆ) *
?
ÆÆ+ ,
DigitStrings
ÆÆ- 9
[
ÆÆ9 :

digitValue
ÆÆ: D
]
ÆÆD E
:
ÆÆF G

firstDigit
ÆÆH R
.
ÆÆR S
ToString
ÆÆS [
(
ÆÆ[ \
)
ÆÆ\ ]
;
ÆÆ] ^
}
ÇÇ 
private
ÉÉ 
void
ÉÉ %
UpdateSegmentsFromValue
ÉÉ (
(
ÉÉ( )
string
ÉÉ) /
newValue
ÉÉ0 8
)
ÉÉ8 9
{
ÊÊ 
_isInternalUpdate
ËË 
=
ËË 
true
ËË  
;
ËË  !
try
ÌÌ 
{
ÍÍ 	
foreach
ÎÎ 
(
ÎÎ 
TextBox
ÎÎ 
segment
ÎÎ $
in
ÎÎ% '
	_segments
ÎÎ( 1
)
ÎÎ1 2
{
ÏÏ 
segment
ÐÐ 
.
ÐÐ 
Text
ÐÐ 
=
ÐÐ 
string
ÐÐ %
.
ÐÐ% &
Empty
ÐÐ& +
;
ÐÐ+ ,
}
ÑÑ 
for
ÓÓ 
(
ÓÓ 
int
ÓÓ 
i
ÓÓ 
=
ÓÓ 
$num
ÓÓ 
;
ÓÓ 
i
ÓÓ 
<
ÓÓ 
	_segments
ÓÓ  )
.
ÓÓ) *
Count
ÓÓ* /
;
ÓÓ/ 0
i
ÓÓ1 2
++
ÓÓ2 4
)
ÓÓ4 5
{
ÔÔ 
if
ÕÕ 
(
ÕÕ 
i
ÕÕ 
>=
ÕÕ 
newValue
ÕÕ !
.
ÕÕ! "
Length
ÕÕ" (
)
ÕÕ( )
{
ÖÖ 
break
×× 
;
×× 
}
ØØ 
	_segments
ÚÚ 
[
ÚÚ 
i
ÚÚ 
]
ÚÚ 
.
ÚÚ 
Text
ÚÚ !
=
ÚÚ" #
newValue
ÚÚ$ ,
[
ÚÚ, -
i
ÚÚ- .
]
ÚÚ. /
.
ÚÚ/ 0
ToString
ÚÚ0 8
(
ÚÚ8 9
)
ÚÚ9 :
;
ÚÚ: ;
}
ÛÛ 
int
ÝÝ 
	nextIndex
ÝÝ 
=
ÝÝ 
Math
ÝÝ  
.
ÝÝ  !
Min
ÝÝ! $
(
ÝÝ$ %
newValue
ÝÝ% -
.
ÝÝ- .
Length
ÝÝ. 4
,
ÝÝ4 5
	_segments
ÝÝ6 ?
.
ÝÝ? @
Count
ÝÝ@ E
-
ÝÝF G
$num
ÝÝH I
)
ÝÝI J
;
ÝÝJ K
SetActiveSegment
ÞÞ 
(
ÞÞ 
	nextIndex
ÞÞ &
)
ÞÞ& '
;
ÞÞ' (
}
ßß 	
finally
àà 
{
áá 	
_isInternalUpdate
ââ 
=
ââ 
false
ââ  %
;
ââ% &
}
ãã 	
}
ää 
private
ææ 
string
ææ "
GetConcatenatedValue
ææ '
(
ææ' (
)
ææ( )
{
çç 
return
èè 
string
èè 
.
èè 
Concat
èè 
(
èè 
	_segments
èè &
.
èè& '
Select
èè' -
(
èè- .
tb
èè. 0
=>
èè1 3
tb
èè4 6
.
èè6 7
Text
èè7 ;
??
èè< >
$str
èè? A
)
èèA B
)
èèB C
;
èèC D
}
éé 
private
ëë 
void
ëë 
ProcessTextInput
ëë !
(
ëë! "
TextBox
ëë" )
textBox
ëë* 1
)
ëë1 2
{
ìì 
if
íí 

(
íí 
AllowOnlyNumbers
íí 
)
íí 
{
îî 	
string
ïï 
	inputText
ïï 
=
ïï 
textBox
ïï &
.
ïï& '
Text
ïï' +
??
ïï, .
string
ïï/ 5
.
ïï5 6
Empty
ïï6 ;
;
ïï; <
string
ðð 
	validText
ðð 
=
ðð "
ValidateNumericInput
ðð 3
(
ðð3 4
	inputText
ðð4 =
)
ðð= >
;
ðð> ?
if
ññ 
(
ññ 
	inputText
ññ 
!=
ññ 
	validText
ññ &
)
ññ& '
{
òò 
UpdateTextBoxText
óó !
(
óó! "
textBox
óó" )
,
óó) *
	validText
óó+ 4
)
óó4 5
;
óó5 6
}
ôô 
}
õõ 	
if
÷÷ 

(
÷÷ 
textBox
÷÷ 
.
÷÷ 
Text
÷÷ 
?
÷÷ 
.
÷÷ 
Length
÷÷  
==
÷÷! #
$num
÷÷$ %
&&
÷÷& (
!
÷÷) *
_isInternalUpdate
÷÷* ;
)
÷÷; <
{
øø 	
MoveToNextSegment
ùù 
(
ùù 
)
ùù 
;
ùù  
}
úú 	
}
ûû 
private
ýý 
static
ýý 
void
ýý 
UpdateTextBoxText
ýý )
(
ýý) *
TextBox
ýý* 1
textBox
ýý2 9
,
ýý9 :
string
ýý; A
newText
ýýB I
)
ýýI J
{
þþ 
int
ÿÿ 
selectionStart
ÿÿ 
=
ÿÿ 
textBox
ÿÿ $
.
ÿÿ$ %
SelectionStart
ÿÿ% 3
;
ÿÿ3 4
textBox
€€ 
.
€€ 
Text
€€ 
=
€€ 
newText
€€ 
;
€€ 
textBox
 
.
 
SelectionStart
 
=
  
Math
! %
.
% &
Min
& )
(
) *
selectionStart
* 8
,
8 9
newText
: A
.
A B
Length
B H
)
H I
;
I J
textBox
‚‚ 
.
‚‚ 
SelectionEnd
‚‚ 
=
‚‚ 
textBox
‚‚ &
.
‚‚& '
SelectionStart
‚‚' 5
;
‚‚5 6
}
ƒƒ 
private
…… 
void
…… 
BuildSegments
…… 
(
…… 
)
……  
{
†† 

StackPanel
‡‡ 
?
‡‡ 
segmentsPanel
‡‡ !
=
‡‡" #
this
‡‡$ (
.
‡‡( )
FindControl
‡‡) 4
<
‡‡4 5

StackPanel
‡‡5 ?
>
‡‡? @
(
‡‡@ A
$str
‡‡A P
)
‡‡P Q
;
‡‡Q R
if
ˆˆ 

(
ˆˆ 
segmentsPanel
ˆˆ 
==
ˆˆ 
null
ˆˆ !
)
ˆˆ! "
{
‰‰ 	
return
ŠŠ 
;
ŠŠ 
}
‹‹ 	
	_segments
 
.
 
Clear
 
(
 
)
 
;
 
segmentsPanel
ŽŽ 
.
ŽŽ 
Children
ŽŽ 
.
ŽŽ 
Clear
ŽŽ $
(
ŽŽ$ %
)
ŽŽ% &
;
ŽŽ& '
segmentsPanel
 
.
 
Spacing
 
=
 
SegmentSpacing
  .
;
. /!
_currentActiveIndex
 
=
 
$num
 
;
  
for
’’ 
(
’’ 
int
’’ 
i
’’ 
=
’’ 
$num
’’ 
;
’’ 
i
’’ 
<
’’ 
SegmentCount
’’ (
;
’’( )
i
’’* +
++
’’+ -
)
’’- .
{
““ 	
TextBox
”” 
tb
”” 
=
”” 
new
”” 
(
”” 
)
”” 
{
•• 
TabIndex
–– 
=
–– 
i
–– 
==
–– 
$num
––  !
?
––" #
$num
––$ %
:
––& '
-
––( )
$num
––) *
,
––* +
Classes
—— 
=
—— 
{
—— '
SegmentedTextBoxConstants
—— 5
.
——5 6!
SEGMENT_STYLE_CLASS
——6 I
}
——J K
,
——K L
Width
˜˜ 
=
˜˜ 
SegmentWidth
˜˜ $
,
˜˜$ %
}
™™ 
;
™™ 
tb
›› 
.
›› 

AddHandler
›› 
(
›› 
KeyDownEvent
›› &
,
››& '
Segment_KeyDown
››( 7
,
››7 8
RoutingStrategies
››9 J
.
››J K
Tunnel
››K Q
)
››Q R
;
››R S
tb
œœ 
.
œœ 
TextChanged
œœ 
+=
œœ !
Segment_TextChanged
œœ 1
;
œœ1 2
tb
 
.
 
	LostFocus
 
+=
 
Segment_LostFocus
 -
;
- .
tb
žž 
.
žž 
GotFocus
žž 
+=
žž 
Segment_GotFocus
žž +
;
žž+ ,
	_segments
ŸŸ 
.
ŸŸ 
Add
ŸŸ 
(
ŸŸ 
tb
ŸŸ 
)
ŸŸ 
;
ŸŸ 
segmentsPanel
   
.
   
Children
   "
.
  " #
Add
  # &
(
  & '
tb
  ' )
)
  ) *
;
  * +
}
¡¡ 	
UpdateTabIndexes
££ 
(
££ 
)
££ 
;
££ 
}
¤¤ 
private
¦¦ 
void
¦¦ 
CleanupSegments
¦¦  
(
¦¦  !
)
¦¦! "
{
§§ 
foreach
¨¨ 
(
¨¨ 
TextBox
¨¨ 
segment
¨¨  
in
¨¨! #
	_segments
¨¨$ -
)
¨¨- .
{
©© 	&
UnsubscribeSegmentEvents
ªª $
(
ªª$ %
segment
ªª% ,
)
ªª, -
;
ªª- .
}
«« 	
	_segments
­­ 
.
­­ 
Clear
­­ 
(
­­ 
)
­­ 
;
­­ 
}
®® 
private
°° 
void
°° &
UnsubscribeSegmentEvents
°° )
(
°°) *
TextBox
°°* 1
textBox
°°2 9
)
°°9 :
{
±± 
textBox
²² 
.
²² 
RemoveHandler
²² 
(
²² 
KeyDownEvent
²² *
,
²²* +
Segment_KeyDown
²², ;
)
²²; <
;
²²< =
textBox
³³ 
.
³³ 
TextChanged
³³ 
-=
³³ !
Segment_TextChanged
³³ 2
;
³³2 3
textBox
´´ 
.
´´ 
	LostFocus
´´ 
-=
´´ 
Segment_LostFocus
´´ .
;
´´. /
textBox
µµ 
.
µµ 
GotFocus
µµ 
-=
µµ 
Segment_GotFocus
µµ ,
;
µµ, -
}
¶¶ 
private
¸¸ 
void
¸¸ 
Segment_GotFocus
¸¸ !
(
¸¸! "
object
¸¸" (
?
¸¸( )
sender
¸¸* 0
,
¸¸0 1
RoutedEventArgs
¸¸2 A
e
¸¸B C
)
¸¸C D
{
¹¹ 
if
ºº 

(
ºº 
sender
ºº 
is
ºº 
TextBox
ºº 
tb
ºº  
)
ºº  !
{
»» 	
int
¼¼ 
index
¼¼ 
=
¼¼ 
	_segments
¼¼ !
.
¼¼! "
IndexOf
¼¼" )
(
¼¼) *
tb
¼¼* ,
)
¼¼, -
;
¼¼- .
if
½½ 
(
½½ 
index
½½ 
>=
½½ 
$num
½½ 
)
½½ 
{
¾¾ !
_currentActiveIndex
¿¿ #
=
¿¿$ %
index
¿¿& +
;
¿¿+ ,!
UpdateActiveSegment
ÀÀ #
(
ÀÀ# $
)
ÀÀ$ %
;
ÀÀ% &
}
ÁÁ 
}
ÂÂ 	
}
ÃÃ 
private
ÅÅ 
void
ÅÅ 
Segment_LostFocus
ÅÅ "
(
ÅÅ" #
object
ÅÅ# )
?
ÅÅ) *
sender
ÅÅ+ 1
,
ÅÅ1 2
RoutedEventArgs
ÅÅ3 B
e
ÅÅC D
)
ÅÅD E
{
ÆÆ 
HandleFocusChange
ÇÇ 
(
ÇÇ 
)
ÇÇ 
;
ÇÇ 
}
ÈÈ 
private
ÊÊ 
void
ÊÊ 
HandleFocusChange
ÊÊ "
(
ÊÊ" #
)
ÊÊ# $
{
ËË 

Dispatcher
ÌÌ 
.
ÌÌ 
UIThread
ÌÌ 
.
ÌÌ 
Post
ÌÌ  
(
ÌÌ  !
(
ÌÌ! "
)
ÌÌ" #
=>
ÌÌ$ &
{
ÍÍ 	
if
ÎÎ 
(
ÎÎ 
!
ÎÎ 
	_segments
ÎÎ 
.
ÎÎ 
Any
ÎÎ 
(
ÎÎ 
segment
ÎÎ &
=>
ÎÎ' )
segment
ÎÎ* 1
.
ÎÎ1 2
	IsFocused
ÎÎ2 ;
)
ÎÎ; <
)
ÎÎ< =
{
ÏÏ  
ClearActiveSegment
ÐÐ "
(
ÐÐ" #
)
ÐÐ# $
;
ÐÐ$ %
}
ÑÑ 
}
ÒÒ 	
)
ÒÒ	 

;
ÒÒ
 
}
ÓÓ 
private
ÕÕ 
void
ÕÕ  
ClearActiveSegment
ÕÕ #
(
ÕÕ# $
)
ÕÕ$ %
{
ÖÖ 
foreach
×× 
(
×× 
TextBox
×× 
tb
×× 
in
×× 
	_segments
×× (
)
××( )
{
ØØ 	
tb
ÙÙ 
.
ÙÙ 
Classes
ÙÙ 
.
ÙÙ 
Remove
ÙÙ 
(
ÙÙ '
SegmentedTextBoxConstants
ÙÙ 7
.
ÙÙ7 8 
ACTIVE_STYLE_CLASS
ÙÙ8 J
)
ÙÙJ K
;
ÙÙK L
}
ÚÚ 	
}
ÛÛ 
private
ÝÝ 
void
ÝÝ -
OverlayRectangle_PointerPressed
ÝÝ 0
(
ÝÝ0 1
object
ÝÝ1 7
?
ÝÝ7 8
sender
ÝÝ9 ?
,
ÝÝ? @%
PointerPressedEventArgs
ÝÝA X
e
ÝÝY Z
)
ÝÝZ [
{
ÞÞ 
if
ßß 

(
ßß !
_currentActiveIndex
ßß 
>=
ßß  "
$num
ßß# $
&&
ßß% '!
_currentActiveIndex
ßß( ;
<
ßß< =
	_segments
ßß> G
.
ßßG H
Count
ßßH M
)
ßßM N
{
àà 	
	_segments
áá 
[
áá !
_currentActiveIndex
áá )
]
áá) *
.
áá* +
Focus
áá+ 0
(
áá0 1
)
áá1 2
;
áá2 3
}
ââ 	
e
ää 	
.
ää	 

Handled
ää
 
=
ää 
true
ää 
;
ää 
}
åå 
private
çç 
void
çç %
OverlayRectangle_Tapped
çç (
(
çç( )
object
çç) /
?
çç/ 0
sender
çç1 7
,
çç7 8
TappedEventArgs
çç9 H
e
ççI J
)
ççJ K
{
èè 
if
éé 

(
éé !
_currentActiveIndex
éé 
>=
éé  "
$num
éé# $
&&
éé% '!
_currentActiveIndex
éé( ;
<
éé< =
	_segments
éé> G
.
ééG H
Count
ééH M
)
ééM N
{
êê 	
	_segments
ëë 
[
ëë !
_currentActiveIndex
ëë )
]
ëë) *
.
ëë* +
Focus
ëë+ 0
(
ëë0 1
)
ëë1 2
;
ëë2 3
}
ìì 	
e
îî 	
.
îî	 

Handled
îî
 
=
îî 
true
îî 
;
îî 
}
ïï 
private
ññ 
void
ññ !
Segment_TextChanged
ññ $
(
ññ$ %
object
ññ% +
?
ññ+ ,
sender
ññ- 3
,
ññ3 4"
TextChangedEventArgs
ññ5 I
e
ññJ K
)
ññK L
{
òò 
if
óó 

(
óó 
sender
óó 
is
óó 
not
óó 
TextBox
óó !
tb
óó" $
)
óó$ %
{
ôô 	
return
õõ 
;
õõ 
}
öö 	
ProcessTextInput
øø 
(
øø 
tb
øø 
)
øø 
;
øø 
OnSegmentChanged
ùù 
(
ùù 
)
ùù 
;
ùù 
}
úú 
private
üü 
void
üü 
Segment_KeyDown
üü  
(
üü  !
object
üü! '
?
üü' (
sender
üü) /
,
üü/ 0
KeyEventArgs
üü1 =
e
üü> ?
)
üü? @
{
ýý 
if
þþ 

(
þþ 
sender
þþ 
is
þþ 
not
þþ 
TextBox
þþ !
tb
þþ" $
)
þþ$ %
{
ÿÿ 	
return
€€ 
;
€€ 
}
 	
int
ƒƒ 
index
ƒƒ 
=
ƒƒ 
	_segments
ƒƒ 
.
ƒƒ 
IndexOf
ƒƒ %
(
ƒƒ% &
tb
ƒƒ& (
)
ƒƒ( )
;
ƒƒ) *
if
…… 

(
…… 
e
…… 
is
…… 
{
…… 
Key
…… 
:
…… 
Key
…… 
.
…… 
V
…… 
,
…… 
KeyModifiers
…… +
:
……+ ,
KeyModifiers
……- 9
.
……9 :
Control
……: A
}
……B C
)
……C D
{
†† 	
HandlePasteAsync
‡‡ 
(
‡‡ 
)
‡‡ 
.
‡‡ 
ContinueWith
‡‡ +
(
‡‡+ ,
task
ˆˆ 
=>
ˆˆ 
{
‰‰ 
if
ŠŠ 
(
ŠŠ 
task
ŠŠ 
is
ŠŠ 
{
ŠŠ  !
	IsFaulted
ŠŠ" +
:
ŠŠ+ ,
true
ŠŠ- 1
,
ŠŠ1 2
	Exception
ŠŠ3 <
:
ŠŠ< =
not
ŠŠ> A
null
ŠŠB F
}
ŠŠG H
)
ŠŠH I
{
‹‹ 
Log
ŒŒ 
.
ŒŒ 
Error
ŒŒ !
(
ŒŒ! "
task
ŒŒ" &
.
ŒŒ& '
	Exception
ŒŒ' 0
,
ŒŒ0 1
$str
ŒŒ2 r
)
ŒŒr s
;
ŒŒs t
}
 
}
ŽŽ 
,
ŽŽ 
TaskScheduler
 
.
 
Default
 %
)
% &
;
& '
e
 
.
 
Handled
 
=
 
true
 
;
 
return
‘‘ 
;
‘‘ 
}
’’ 	
switch
”” 
(
”” 
e
”” 
.
”” 
Key
”” 
)
”” 
{
•• 	
case
–– 
Key
–– 
.
–– 
Back
–– 
:
––  
HandleBackspaceKey
—— "
(
——" #
index
——# (
)
——( )
;
——) *
e
˜˜ 
.
˜˜ 
Handled
˜˜ 
=
˜˜ 
true
˜˜  
;
˜˜  !
OnSegmentChanged
™™  
(
™™  !
)
™™! "
;
™™" #
return
šš 
;
šš 
case
›› 
Key
›› 
.
›› 
Right
›› 
or
›› 
Key
›› !
.
››! "
Left
››" &
:
››& '
e
œœ 
.
œœ 
Handled
œœ 
=
œœ 
true
œœ  
;
œœ  !
return
 
;
 
case
žž 
Key
žž 
.
žž 
Tab
žž 
:
žž 
return
ŸŸ 
;
ŸŸ 
}
   	
if
¢¢ 

(
¢¢ 
!
¢¢ )
IsPointerInteractionEnabled
¢¢ (
&&
¢¢) +
index
¢¢, 1
!=
¢¢2 4!
_currentActiveIndex
¢¢5 H
)
¢¢H I
{
££ 	
e
¤¤ 
.
¤¤ 
Handled
¤¤ 
=
¤¤ 
true
¤¤ 
;
¤¤ 
return
¥¥ 
;
¥¥ 
}
¦¦ 	
OnSegmentChanged
¨¨ 
(
¨¨ 
)
¨¨ 
;
¨¨ 
}
©© 
private
«« 
async
«« 
Task
«« 
HandlePasteAsync
«« '
(
««' (
)
««( )
{
¬¬ 
try
­­ 
{
®® 	

IClipboard
¯¯ 
?
¯¯ 
	clipboard
¯¯ !
=
¯¯" #
TopLevel
¯¯$ ,
.
¯¯, -
GetTopLevel
¯¯- 8
(
¯¯8 9
this
¯¯9 =
)
¯¯= >
?
¯¯> ?
.
¯¯? @
	Clipboard
¯¯@ I
;
¯¯I J
if
°° 
(
°° 
	clipboard
°° 
==
°° 
null
°° !
)
°°! "
{
±± 
return
²² 
;
²² 
}
³³ 
string
µµ 
?
µµ 
clipboardText
µµ !
=
µµ" #
await
µµ$ )
	clipboard
µµ* 3
.
µµ3 4
TryGetTextAsync
µµ4 C
(
µµC D
)
µµD E
;
µµE F
if
¶¶ 
(
¶¶ 
string
¶¶ 
.
¶¶ 
IsNullOrEmpty
¶¶ $
(
¶¶$ %
clipboardText
¶¶% 2
)
¶¶2 3
)
¶¶3 4
{
·· 
return
¸¸ 
;
¸¸ 
}
¹¹ 
ProcessPastedText
»» 
(
»» 
clipboardText
»» +
)
»»+ ,
;
»», -
}
¼¼ 	
catch
½½ 
(
½½ 
	Exception
½½ 
ex
½½ 
)
½½ 
{
¾¾ 	
Log
¿¿ 
.
¿¿ 
Warning
¿¿ 
(
¿¿ 
ex
¿¿ 
,
¿¿ 
$str
¿¿ D
)
¿¿D E
;
¿¿E F
}
ÀÀ 	
}
ÁÁ 
private
ÃÃ 
void
ÃÃ 
ProcessPastedText
ÃÃ "
(
ÃÃ" #
string
ÃÃ# )

pastedText
ÃÃ* 4
)
ÃÃ4 5
{
ÄÄ 
string
ÅÅ 
	validText
ÅÅ 
=
ÅÅ 
AllowOnlyNumbers
ÅÅ +
?
ÆÆ 
new
ÆÆ 
string
ÆÆ 
(
ÆÆ 

pastedText
ÆÆ #
.
ÆÆ# $
Where
ÆÆ$ )
(
ÆÆ) *
char
ÆÆ* .
.
ÆÆ. /
IsDigit
ÆÆ/ 6
)
ÆÆ6 7
.
ÆÆ7 8
ToArray
ÆÆ8 ?
(
ÆÆ? @
)
ÆÆ@ A
)
ÆÆA B
:
ÇÇ 

pastedText
ÇÇ 
;
ÇÇ 
if
ÉÉ 

(
ÉÉ 
string
ÉÉ 
.
ÉÉ 
IsNullOrEmpty
ÉÉ  
(
ÉÉ  !
	validText
ÉÉ! *
)
ÉÉ* +
)
ÉÉ+ ,
{
ÊÊ 	
return
ËË 
;
ËË 
}
ÌÌ 	
if
ÎÎ 

(
ÎÎ 
AllowOnlyNumbers
ÎÎ 
&&
ÎÎ 
!
ÎÎ  !
	validText
ÎÎ! *
.
ÎÎ* +
All
ÎÎ+ .
(
ÎÎ. /
char
ÎÎ/ 3
.
ÎÎ3 4
IsDigit
ÎÎ4 ;
)
ÎÎ; <
)
ÎÎ< =
{
ÏÏ 	
return
ÐÐ 
;
ÐÐ 
}
ÑÑ 	
if
ÓÓ 

(
ÓÓ 
	validText
ÓÓ 
.
ÓÓ 
Length
ÓÓ 
!=
ÓÓ 
	_segments
ÓÓ  )
.
ÓÓ) *
Count
ÓÓ* /
)
ÓÓ/ 0
{
ÔÔ 	
return
ÕÕ 
;
ÕÕ 
}
ÖÖ 	%
UpdateSegmentsFromValue
ØØ 
(
ØØ  
	validText
ØØ  )
)
ØØ) *
;
ØØ* +
}
ÙÙ 
private
ÛÛ 
void
ÛÛ  
HandleBackspaceKey
ÛÛ #
(
ÛÛ# $
int
ÛÛ$ '
currentIndex
ÛÛ( 4
)
ÛÛ4 5
{
ÜÜ 
TextBox
ÝÝ 
currentTextBox
ÝÝ 
=
ÝÝ  
	_segments
ÝÝ! *
[
ÝÝ* +
currentIndex
ÝÝ+ 7
]
ÝÝ7 8
;
ÝÝ8 9
if
ßß 

(
ßß 
!
ßß 
string
ßß 
.
ßß 
IsNullOrEmpty
ßß !
(
ßß! "
currentTextBox
ßß" 0
.
ßß0 1
Text
ßß1 5
)
ßß5 6
)
ßß6 7
{
àà 	
currentTextBox
áá 
.
áá 
Text
áá 
=
áá  !
$str
áá" $
;
áá$ %
}
ââ 	
else
ãã 
if
ãã 
(
ãã 
currentIndex
ãã 
>
ãã 
$num
ãã  !
)
ãã! "
{
ää 	
int
åå 
previousIndex
åå 
=
åå 
currentIndex
åå  ,
-
åå- .
$num
åå/ 0
;
åå0 1
SetActiveSegment
ææ 
(
ææ 
previousIndex
ææ *
)
ææ* +
;
ææ+ ,
	_segments
çç 
[
çç 
previousIndex
çç #
]
çç# $
.
çç$ %
Text
çç% )
=
çç* +
$str
çç, .
;
çç. /
}
èè 	
}
éé 
private
ëë 
void
ëë 
SetActiveSegment
ëë !
(
ëë! "
int
ëë" %
index
ëë& +
)
ëë+ ,
{
ìì 
if
íí 

(
íí 
index
íí 
>=
íí 
$num
íí 
&&
íí 
index
íí 
<
íí  !
	_segments
íí" +
.
íí+ ,
Count
íí, 1
)
íí1 2
{
îî 	!
_currentActiveIndex
ïï 
=
ïï  !
index
ïï" '
;
ïï' (
UpdateTabIndexes
ðð 
(
ðð 
)
ðð 
;
ðð !
UpdateActiveSegment
ññ 
(
ññ  
)
ññ  !
;
ññ! "
}
òò 	
}
óó 
private
õõ 
void
õõ !
UpdateActiveSegment
õõ $
(
õõ$ %
)
õõ% &
{
öö 
for
÷÷ 
(
÷÷ 
int
÷÷ 
i
÷÷ 
=
÷÷ 
$num
÷÷ 
;
÷÷ 
i
÷÷ 
<
÷÷ 
	_segments
÷÷ %
.
÷÷% &
Count
÷÷& +
;
÷÷+ ,
i
÷÷- .
++
÷÷. 0
)
÷÷0 1
{
øø 	
TextBox
ùù 
tb
ùù 
=
ùù 
	_segments
ùù "
[
ùù" #
i
ùù# $
]
ùù$ %
;
ùù% &
tb
úú 
.
úú 
Classes
úú 
.
úú 
Set
úú 
(
úú '
SegmentedTextBoxConstants
úú 4
.
úú4 5 
ACTIVE_STYLE_CLASS
úú5 G
,
úúG H
i
úúI J
==
úúK M!
_currentActiveIndex
úúN a
)
úúa b
;
úúb c
}
ûû 	!
FocusCurrentSegment
ýý 
(
ýý 
)
ýý 
;
ýý 
}
þþ 
private
€€ 
void
€€ !
FocusCurrentSegment
€€ $
(
€€$ %
)
€€% &
{
 
if
‚‚ 

(
‚‚ !
_currentActiveIndex
‚‚ 
>=
‚‚  "
$num
‚‚# $
&&
‚‚% '!
_currentActiveIndex
‚‚( ;
<
‚‚< =
	_segments
‚‚> G
.
‚‚G H
Count
‚‚H M
)
‚‚M N
{
ƒƒ 	
TextBox
„„ 
currentSegment
„„ "
=
„„# $
	_segments
„„% .
[
„„. /!
_currentActiveIndex
„„/ B
]
„„B C
;
„„C D
currentSegment
…… 
.
…… 
Focus
……  
(
……  !
)
……! "
;
……" #
if
‡‡ 
(
‡‡ 
!
‡‡ 
string
‡‡ 
.
‡‡ 
IsNullOrEmpty
‡‡ %
(
‡‡% &
currentSegment
‡‡& 4
.
‡‡4 5
Text
‡‡5 9
)
‡‡9 :
)
‡‡: ;
{
ˆˆ 
currentSegment
‰‰ 
.
‰‰ 
SelectionStart
‰‰ -
=
‰‰. /
currentSegment
‰‰0 >
.
‰‰> ?
Text
‰‰? C
.
‰‰C D
Length
‰‰D J
;
‰‰J K
currentSegment
ŠŠ 
.
ŠŠ 
SelectionEnd
ŠŠ +
=
ŠŠ, -
currentSegment
ŠŠ. <
.
ŠŠ< =
Text
ŠŠ= A
.
ŠŠA B
Length
ŠŠB H
;
ŠŠH I
}
‹‹ 
}
ŒŒ 	
}
 
private
 
void
 
MoveToNextSegment
 "
(
" #
)
# $
{
 
if
‘‘ 

(
‘‘ !
_currentActiveIndex
‘‘ 
<
‘‘  !
	_segments
‘‘" +
.
‘‘+ ,
Count
‘‘, 1
-
‘‘2 3
$num
‘‘4 5
)
‘‘5 6
{
’’ 	
SetActiveSegment
““ 
(
““ !
_currentActiveIndex
““ 0
+
““1 2
$num
““3 4
)
““4 5
;
““5 6
}
”” 	
}
•• 
private
—— 
void
—— 
OnSegmentChanged
—— !
(
——! "
)
——" #
{
˜˜ 
string
™™ 
newValue
™™ 
=
™™ "
GetConcatenatedValue
™™ .
(
™™. /
)
™™/ 0
;
™™0 1
bool
šš 
newIsComplete
šš 
=
šš 
	_segments
šš &
.
šš& '
All
šš' *
(
šš* +
tb
šš+ -
=>
šš. 0
!
šš1 2
string
šš2 8
.
šš8 9
IsNullOrEmpty
šš9 F
(
ššF G
tb
ššG I
.
ššI J
Text
ššJ N
)
ššN O
)
ššO P
;
ššP Q
if
œœ 

(
œœ 
!
œœ 
_isInternalUpdate
œœ 
&&
œœ !
Value
œœ" '
!=
œœ( *
newValue
œœ+ 3
)
œœ3 4
{
 	
_isInternalUpdate
žž 
=
žž 
true
žž  $
;
žž$ %
try
ŸŸ 
{
   
SetValue
¡¡ 
(
¡¡ 
ValueProperty
¡¡ &
,
¡¡& '
newValue
¡¡( 0
)
¡¡0 1
;
¡¡1 2
}
¢¢ 
finally
££ 
{
¤¤ 
_isInternalUpdate
¥¥ !
=
¥¥" #
false
¥¥$ )
;
¥¥) *
}
¦¦ 
}
§§ 	
if
©© 

(
©© 

IsComplete
©© 
!=
©© 
newIsComplete
©© '
)
©©' (
{
ªª 	
SetValue
«« 
(
««  
IsCompleteProperty
«« '
,
««' (
newIsComplete
««) 6
)
««6 7
;
««7 8
}
¬¬ 	
}
­­ 
private
¯¯ 
void
¯¯ 
UpdateTabIndexes
¯¯ !
(
¯¯! "
)
¯¯" #
{
°° 
for
±± 
(
±± 
int
±± 
i
±± 
=
±± 
$num
±± 
;
±± 
i
±± 
<
±± 
	_segments
±± %
.
±±% &
Count
±±& +
;
±±+ ,
i
±±- .
++
±±. 0
)
±±0 1
{
²² 	
	_segments
³³ 
[
³³ 
i
³³ 
]
³³ 
.
³³ 
TabIndex
³³ !
=
³³" #
i
³³$ %
==
³³& (!
_currentActiveIndex
³³) <
?
³³= >
BaseTabIndex
³³? K
:
³³L M
-
³³N O
$num
³³O P
;
³³P Q
	_segments
´´ 
[
´´ 
i
´´ 
]
´´ 
.
´´ 
	IsTabStop
´´ "
=
´´# $
i
´´% &
==
´´' )!
_currentActiveIndex
´´* =
;
´´= >
}
µµ 	
}
¶¶ 
private
¸¸ 
void
¸¸ !
InitializeComponent
¸¸ $
(
¸¸$ %
)
¸¸% &
{
¹¹  
AvaloniaXamlLoader
ºº 
.
ºº 
Load
ºº 
(
ºº  
this
ºº  $
)
ºº$ %
;
ºº% &
}
»» 
}¼¼ ¶	
{/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Core/HintedTextBox.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Core! %
;% &
public 
sealed 
partial 
class 
HintedTextBox )
:* +
UserControl, 7
,7 8
IDisposable9 D
{ 
public 

static 
readonly 
StyledProperty )
<) *
bool* .
>. /#
IsSecureKeyModeProperty0 G
=H I
AvaloniaProperty 
. 
Register !
<! "
HintedTextBox" /
,/ 0
bool1 5
>5 6
(6 7
nameof7 =
(= >
IsSecureKeyMode> M
)M N
)N O
;O P
public 

static 
readonly 
StyledProperty )
<) *
char* .
>. /%
SecureKeyMaskCharProperty0 I
=J K
AvaloniaProperty 
. 
Register !
<! "
HintedTextBox" /
,/ 0
char1 5
>5 6
(6 7
nameof7 =
(= >
SecureKeyMaskChar> O
)O P
,P Q"
HintedTextBoxConstants   "
.  " #
DEFAULT_MASK_CHAR  # 4
)  4 5
;  5 6
public"" 

static"" 
readonly"" 
StyledProperty"" )
<"") *
string""* 0
>""0 1
TextProperty""2 >
=""? @
AvaloniaProperty## 
.## 
Register## !
<##! "
HintedTextBox##" /
,##/ 0
string##1 7
>##7 8
(##8 9
nameof##9 ?
(##? @
Text##@ D
)##D E
,##E F
string##G M
.##M N
Empty##N S
,##S T
defaultBindingMode$$ 
:$$ 
Avalonia$$  (
.$$( )
Data$$) -
.$$- .
BindingMode$$. 9
.$$9 :
TwoWay$$: @
)$$@ A
;$$A B
public&& 

static&& 
readonly&& 
StyledProperty&& )
<&&) *
string&&* 0
>&&0 1
WatermarkProperty&&2 C
=&&D E
AvaloniaProperty'' 
.'' 
Register'' !
<''! "
HintedTextBox''" /
,''/ 0
string''1 7
>''7 8
(''8 9
nameof''9 ?
(''? @
	Watermark''@ I
)''I J
,''J K
string''L R
.''R S
Empty''S X
)''X Y
;''Y Z
public)) 

static)) 
readonly)) 
StyledProperty)) )
<))) *
string))* 0
>))0 1
HintProperty))2 >
=))? @
AvaloniaProperty** 
.** 
Register** !
<**! "
HintedTextBox**" /
,**/ 0
string**1 7
>**7 8
(**8 9
nameof**9 ?
(**? @
Hint**@ D
)**D E
,**E F
string**G M
.**M N
Empty**N S
)**S T
;**T U
public,, 

static,, 
readonly,, 
StyledProperty,, )
<,,) *
IBrush,,* 0
>,,0 1$
FocusBorderBrushProperty,,2 J
=,,K L
AvaloniaProperty-- 
.-- 
Register-- !
<--! "
HintedTextBox--" /
,--/ 0
IBrush--1 7
>--7 8
(--8 9
nameof.. 
(.. 
FocusBorderBrush.. #
)..# $
,..$ %
new..& )
SolidColorBrush..* 9
(..9 :
Color..: ?
...? @
Parse..@ E
(..E F"
HintedTextBoxConstants..F \
...\ ]
FOCUS_COLOR_HEX..] l
)..l m
)..m n
)..n o
;..o p
public00 

static00 
readonly00 
StyledProperty00 )
<00) *
IBrush00* 0
>000 1"
TextForegroundProperty002 H
=00I J
AvaloniaProperty11 
.11 
Register11 !
<11! "
HintedTextBox11" /
,11/ 0
IBrush111 7
>117 8
(118 9
nameof22 
(22 
TextForeground22 !
)22! "
,22" #
new22$ '
SolidColorBrush22( 7
(227 8
Colors228 >
.22> ?
Black22? D
)22D E
)22E F
;22F G
public44 

static44 
readonly44 
StyledProperty44 )
<44) *
IBrush44* 0
>440 1"
HintForegroundProperty442 H
=44I J
AvaloniaProperty55 
.55 
Register55 !
<55! "
HintedTextBox55" /
,55/ 0
IBrush551 7
>557 8
(558 9
nameof66 
(66 
HintForeground66 !
)66! "
,66" #
new66$ '
SolidColorBrush66( 7
(667 8
Colors668 >
.66> ?
Gray66? C
)66C D
)66D E
;66E F
public88 

static88 
readonly88 
StyledProperty88 )
<88) *
DrawingImage88* 6
?886 7
>887 8%
IconRegularSourceProperty889 R
=88S T
AvaloniaProperty99 
.99 
Register99 !
<99! "
HintedTextBox99" /
,99/ 0
DrawingImage991 =
?99= >
>99> ?
(99? @
nameof99@ F
(99F G
IconRegularSource99G X
)99X Y
)99Y Z
;99Z [
public;; 

static;; 
readonly;; 
StyledProperty;; )
<;;) *
DrawingImage;;* 6
?;;6 7
>;;7 8#
IconErrorSourceProperty;;9 P
=;;Q R
AvaloniaProperty<< 
.<< 
Register<< !
<<<! "
HintedTextBox<<" /
,<</ 0
DrawingImage<<1 =
?<<= >
><<> ?
(<<? @
nameof<<@ F
(<<F G
IconErrorSource<<G V
)<<V W
)<<W X
;<<X Y
public>> 

static>> 
readonly>> 
StyledProperty>> )
<>>) *
string>>* 0
>>>0 1
ErrorTextProperty>>2 C
=>>D E
AvaloniaProperty?? 
.?? 
Register?? !
<??! "
HintedTextBox??" /
,??/ 0
string??1 7
>??7 8
(??8 9
nameof??9 ?
(??? @
	ErrorText??@ I
)??I J
,??J K
string??L R
.??R S
Empty??S X
)??X Y
;??Y Z
publicAA 

staticAA 
readonlyAA 
StyledPropertyAA )
<AA) *
doubleAA* 0
>AA0 1"
EllipseOpacityPropertyAA2 H
=AAI J
AvaloniaPropertyBB 
.BB 
RegisterBB !
<BB! "
HintedTextBoxBB" /
,BB/ 0
doubleBB1 7
>BB7 8
(BB8 9
nameofBB9 ?
(BB? @
EllipseOpacityBB@ N
)BBN O
)BBO P
;BBP Q
publicDD 

staticDD 
readonlyDD 
StyledPropertyDD )
<DD) *
boolDD* .
>DD. /
HasErrorPropertyDD0 @
=DDA B
AvaloniaPropertyEE 
.EE 
RegisterEE !
<EE! "
HintedTextBoxEE" /
,EE/ 0
boolEE1 5
>EE5 6
(EE6 7
nameofEE7 =
(EE= >
HasErrorEE> F
)EEF G
)EEG H
;EEH I
publicGG 

staticGG 
readonlyGG 
StyledPropertyGG )
<GG) *
IBrushGG* 0
>GG0 1#
MainBorderBrushPropertyGG2 I
=GGJ K
AvaloniaPropertyHH 
.HH 
RegisterHH !
<HH! "
HintedTextBoxHH" /
,HH/ 0
IBrushHH1 7
>HH7 8
(HH8 9
nameofII 
(II 
MainBorderBrushII "
)II" #
,II# $
newII% (
SolidColorBrushII) 8
(II8 9
ColorsII9 ?
.II? @
	LightGrayII@ I
)III J
)IIJ K
;IIK L
publicKK 

staticKK 
readonlyKK 
StyledPropertyKK )
<KK) *
TextWrappingKK* 6
>KK6 7 
TextWrappingPropertyKK8 L
=KKM N
AvaloniaPropertyLL 
.LL 
RegisterLL !
<LL! "
HintedTextBoxLL" /
,LL/ 0
TextWrappingLL1 =
>LL= >
(LL> ?
nameofLL? E
(LLE F
TextWrappingLLF R
)LLR S
)LLS T
;LLT U
publicNN 

staticNN 
readonlyNN 
StyledPropertyNN )
<NN) *
intNN* -
>NN- .
MaxLengthPropertyNN/ @
=NNA B
AvaloniaPropertyOO 
.OO 
RegisterOO !
<OO! "
HintedTextBoxOO" /
,OO/ 0
intOO1 4
>OO4 5
(OO5 6
nameofOO6 <
(OO< =
	MaxLengthOO= F
)OOF G
,OOG H
intOOI L
.OOL M
MaxValueOOM U
)OOU V
;OOV W
publicQQ 

staticQQ 
readonlyQQ 
StyledPropertyQQ )
<QQ) *
intQQ* -
>QQ- .'
RemainingCharactersPropertyQQ/ J
=QQK L
AvaloniaPropertyRR 
.RR 
RegisterRR !
<RR! "
HintedTextBoxRR" /
,RR/ 0
intRR1 4
>RR4 5
(RR5 6
nameofRR6 <
(RR< =
RemainingCharactersRR= P
)RRP Q
,RRQ R
intRRS V
.RRV W
MaxValueRRW _
)RR_ `
;RR` a
publicTT 

staticTT 
readonlyTT 
StyledPropertyTT )
<TT) *
boolTT* .
>TT. /(
ShowCharacterCounterPropertyTT0 L
=TTM N
AvaloniaPropertyUU 
.UU 
RegisterUU !
<UU! "
HintedTextBoxUU" /
,UU/ 0
boolUU1 5
>UU5 6
(UU6 7
nameofUU7 =
(UU= > 
ShowCharacterCounterUU> R
)UUR S
)UUS T
;UUT U
publicWW 

staticWW 
readonlyWW 
StyledPropertyWW )
<WW) *
boolWW* .
>WW. /!
IsNumericOnlyPropertyWW0 E
=WWF G
AvaloniaPropertyXX 
.XX 
RegisterXX !
<XX! "
HintedTextBoxXX" /
,XX/ 0
boolXX1 5
>XX5 6
(XX6 7
nameofXX7 =
(XX= >
IsNumericOnlyXX> K
)XXK L
)XXL M
;XXM N
publicZZ 

newZZ 
staticZZ 
readonlyZZ 
StyledPropertyZZ -
<ZZ- .
IBrushZZ. 4
>ZZ4 5
BackgroundPropertyZZ6 H
=ZZI J
AvaloniaProperty[[ 
.[[ 
Register[[ !
<[[! "
HintedTextBox[[" /
,[[/ 0
IBrush[[1 7
>[[7 8
([[8 9
nameof\\ 
(\\ 

Background\\ 
)\\ 
,\\ 
new\\  #
SolidColorBrush\\$ 3
(\\3 4
Colors\\4 :
.\\: ;
White\\; @
)\\@ A
)\\A B
;\\B C
public^^ 

new^^ 
static^^ 
readonly^^ 
StyledProperty^^ -
<^^- .
double^^. 4
>^^4 5
FontSizeProperty^^6 F
=^^G H
AvaloniaProperty__ 
.__ 
Register__ !
<__! "
HintedTextBox__" /
,__/ 0
double__1 7
>__7 8
(__8 9
nameof__9 ?
(__? @
FontSize__@ H
)__H I
,__I J"
HintedTextBoxConstants__K a
.__a b
DEFAULT_FONT_SIZE__b s
)__s t
;__t u
publicaa 

staticaa 
readonlyaa 
StyledPropertyaa )
<aa) *
doubleaa* 0
>aa0 1%
WatermarkFontSizePropertyaa2 K
=aaL M
AvaloniaPropertybb 
.bb 
Registerbb !
<bb! "
HintedTextBoxbb" /
,bb/ 0
doublebb1 7
>bb7 8
(bb8 9
nameofbb9 ?
(bb? @
WatermarkFontSizebb@ Q
)bbQ R
,bbR S"
HintedTextBoxConstantscc "
.cc" #'
DEFAULT_WATERMARK_FONT_SIZEcc# >
)cc> ?
;cc? @
publicee 

newee 
staticee 
readonlyee 
StyledPropertyee -
<ee- .

FontWeightee. 8
>ee8 9
FontWeightPropertyee: L
=eeM N
AvaloniaPropertyff 
.ff 
Registerff !
<ff! "
HintedTextBoxff" /
,ff/ 0

FontWeightff1 ;
>ff; <
(ff< =
nameofff= C
(ffC D

FontWeightffD N
)ffN O
,ffO P

FontWeightffQ [
.ff[ \
Normalff\ b
)ffb c
;ffc d
publichh 

statichh 
readonlyhh 
StyledPropertyhh )
<hh) *
boolhh* .
>hh. /+
IsSecureKeyStrengthModePropertyhh0 O
=hhP Q
AvaloniaPropertyii 
.ii 
Registerii !
<ii! "
HintedTextBoxii" /
,ii/ 0
boolii1 5
>ii5 6
(ii6 7
nameofii7 =
(ii= >#
IsSecureKeyStrengthModeii> U
)iiU V
)iiV W
;iiW X
publickk 

statickk 
readonlykk 
StyledPropertykk )
<kk) *
SecureKeyStrengthkk* ;
>kk; <%
SecureKeyStrengthPropertykk= V
=kkW X
AvaloniaPropertyll 
.ll 
Registerll !
<ll! "
HintedTextBoxll" /
,ll/ 0
SecureKeyStrengthll1 B
>llB C
(llC D
nameofllD J
(llJ K
SecureKeyStrengthllK \
)ll\ ]
,ll] ^
SecureKeyStrengthmm 
.mm 
INVALIDmm %
)mm% &
;mm& '
publicoo 

staticoo 
readonlyoo 
StyledPropertyoo )
<oo) *
stringoo* 0
>oo0 1)
SecureKeyStrengthTextPropertyoo2 O
=ooP Q
AvaloniaPropertypp 
.pp 
Registerpp !
<pp! "
HintedTextBoxpp" /
,pp/ 0
stringpp1 7
>pp7 8
(pp8 9
nameofpp9 ?
(pp? @!
SecureKeyStrengthTextpp@ U
)ppU V
,ppV W
stringppX ^
.pp^ _
Emptypp_ d
)ppd e
;ppe f
publicrr 

staticrr 
readonlyrr 
StyledPropertyrr )
<rr) *
IBrushrr* 0
>rr0 1.
"SecureKeyStrengthTextBrushPropertyrr2 T
=rrU V
AvaloniaPropertyss 
.ss 
Registerss !
<ss! "
HintedTextBoxss" /
,ss/ 0
IBrushss1 7
>ss7 8
(ss8 9
nameofss9 ?
(ss? @&
SecureKeyStrengthTextBrushss@ Z
)ssZ [
,ss[ \
newtt 
SolidColorBrushtt 
(tt  
Colorstt  &
.tt& '
Graytt' +
)tt+ ,
)tt, -
;tt- .
publicvv 

staticvv 
readonlyvv 
StyledPropertyvv )
<vv) *
IBrushvv* 0
>vv0 1.
"SecureKeyStrengthIconBrushPropertyvv2 T
=vvU V
AvaloniaPropertyww 
.ww 
Registerww !
<ww! "
HintedTextBoxww" /
,ww/ 0
IBrushww1 7
>ww7 8
(ww8 9
nameofww9 ?
(ww? @&
SecureKeyStrengthIconBrushww@ Z
)wwZ [
,ww[ \
newxx 
SolidColorBrushxx 
(xx  
Colorsxx  &
.xx& '
Grayxx' +
)xx+ ,
)xx, -
;xx- .
publiczz 

staticzz 
readonlyzz 
StyledPropertyzz )
<zz) *
stringzz* 0
>zz0 1
WarningTextPropertyzz2 E
=zzF G
AvaloniaProperty{{ 
.{{ 
Register{{ !
<{{! "
HintedTextBox{{" /
,{{/ 0
string{{1 7
>{{7 8
({{8 9
nameof{{9 ?
({{? @
WarningText{{@ K
){{K L
,{{L M
string{{N T
.{{T U
Empty{{U Z
){{Z [
;{{[ \
public}} 

static}} 
readonly}} 
StyledProperty}} )
<}}) *
bool}}* .
>}}. /
HasWarningProperty}}0 B
=}}C D
AvaloniaProperty~~ 
.~~ 
Register~~ !
<~~! "
HintedTextBox~~" /
,~~/ 0
bool~~1 5
>~~5 6
(~~6 7
nameof~~7 =
(~~= >

HasWarning~~> H
)~~H I
)~~I J
;~~J K
public
€€ 

static
€€ 
readonly
€€ 
StyledProperty
€€ )
<
€€) *
int
€€* -
>
€€- ..
 WarningDisplayDurationMsProperty
€€/ O
=
€€P Q
AvaloniaProperty
 
.
 
Register
 !
<
! "
HintedTextBox
" /
,
/ 0
int
1 4
>
4 5
(
5 6
nameof
6 <
(
< =&
WarningDisplayDurationMs
= U
)
U V
,
V W$
HintedTextBoxConstants
‚‚ "
.
‚‚" #1
#DEFAULT_WARNING_DISPLAY_DURATION_MS
‚‚# F
)
‚‚F G
;
‚‚G H
public
„„ 

static
„„ 
readonly
„„ 
RoutedEvent
„„ &
<
„„& '(
CharacterRejectedEventArgs
„„' A
>
„„A B$
CharacterRejectedEvent
„„C Y
=
„„Z [
RoutedEvent
…… 
.
…… 
Register
…… 
<
…… 
HintedTextBox
…… *
,
……* +(
CharacterRejectedEventArgs
……, F
>
……F G
(
……G H
nameof
……H N
(
……N O
CharacterRejected
……O `
)
……` a
,
……a b
RoutingStrategies
†† 
.
†† 
Bubble
†† $
)
††$ %
;
††% &
public
ˆˆ 

static
ˆˆ 
readonly
ˆˆ 
RoutedEvent
ˆˆ &
<
ˆˆ& '/
!SecureKeyCharactersAddedEventArgs
ˆˆ' H
>
ˆˆH I+
SecureKeyCharactersAddedEvent
ˆˆJ g
=
ˆˆh i
RoutedEvent
‰‰ 
.
‰‰ 
Register
‰‰ 
<
‰‰ 
HintedTextBox
‰‰ *
,
‰‰* +/
!SecureKeyCharactersAddedEventArgs
‰‰, M
>
‰‰M N
(
‰‰N O
nameof
‰‰O U
(
‰‰U V&
SecureKeyCharactersAdded
‰‰V n
)
‰‰n o
,
‰‰o p
RoutingStrategies
ŠŠ 
.
ŠŠ 
Bubble
ŠŠ $
)
ŠŠ$ %
;
ŠŠ% &
public
ŒŒ 

static
ŒŒ 
readonly
ŒŒ 
RoutedEvent
ŒŒ &
<
ŒŒ& '1
#SecureKeyCharactersRemovedEventArgs
ŒŒ' J
>
ŒŒJ K-
SecureKeyCharactersRemovedEvent
ŒŒL k
=
ŒŒl m
RoutedEvent
 
.
 
Register
 
<
 
HintedTextBox
 *
,
* +1
#SecureKeyCharactersRemovedEventArgs
, O
>
O P
(
P Q
nameof
Q W
(
W X(
SecureKeyCharactersRemoved
X r
)
r s
,
s t
RoutingStrategies
ŽŽ 
.
ŽŽ 
Bubble
ŽŽ $
)
ŽŽ$ %
;
ŽŽ% &
private
 
static
 
readonly
 

Dictionary
 &
<
& '
string
' -
,
- .
SolidColorBrush
/ >
>
> ?

BrushCache
@ J
=
K L
new
M P
(
P Q
)
Q R
;
R S
private
‘‘ 
static
‘‘ 
readonly
‘‘ 

Dictionary
‘‘ &
<
‘‘& '
string
‘‘' -
,
‘‘- .
Color
‘‘/ 4
>
‘‘4 5

ColorCache
‘‘6 @
=
‘‘A B
new
‘‘C F
(
‘‘F G
)
‘‘G H
;
‘‘H I
private
’’ 
static
’’ 
readonly
’’ 

Dictionary
’’ &
<
’’& '
string
’’' -
,
’’- .

BoxShadows
’’/ 9
>
’’9 :
ResourceCache
’’; H
=
’’I J
new
’’K N
(
’’N O
)
’’O P
;
’’P Q
private
““ 
static
““ 
readonly
““ 

Dictionary
““ &
<
““& '
string
““' -
,
““- .
int
““/ 2
>
““2 3#
TextElementCountCache
““4 I
=
““J K
new
““L O
(
““O P
StringComparer
““P ^
.
““^ _
Ordinal
““_ f
)
““f g
;
““g h
private
”” 
const
”” 
int
”” )
MAX_TEXT_ELEMENT_CACHE_SIZE
”” 1
=
””2 3
$num
””4 8
;
””8 9
private
–– 
const
–– 
int
–– %
INPUT_DEBOUNCE_DELAY_MS
–– -
=
––. /$
HintedTextBoxConstants
––0 F
.
––F G%
INPUT_DEBOUNCE_DELAY_MS
––G ^
;
––^ _
private
—— 
const
—— 
int
—— *
SECURE_KEY_DEBOUNCE_DELAY_MS
—— 2
=
——3 4
$num
——5 7
;
——7 8
private
™™ 
readonly
™™ !
CompositeDisposable
™™ (
_disposables
™™) 5
=
™™6 7
new
™™8 ;
(
™™; <
)
™™< =
;
™™= >
private
›› 
TextBox
›› 
?
›› 
_mainTextBox
›› !
;
››! "
private
œœ 
Border
œœ 
?
œœ 
_focusBorder
œœ  
;
œœ  !
private
 
Border
 
?
 
_mainBorder
 
;
  
private
žž 
Border
žž 
?
žž 
_shadowBorder
žž !
;
žž! "
private
ŸŸ 
bool
ŸŸ !
_isUpdatingFromCode
ŸŸ $
;
ŸŸ$ %
private
   
bool
   
_isDisposed
   
;
   
private
¡¡ 
bool
¡¡ #
_isControlInitialized
¡¡ &
;
¡¡& '
private
¢¢ 
DispatcherTimer
¢¢ 
?
¢¢ 
_warningTimer
¢¢ *
;
¢¢* +
private
££ 
DispatcherTimer
££ 
?
££ !
_inputDebounceTimer
££ 0
;
££0 1
private
¤¤ 
DispatcherTimer
¤¤ 
?
¤¤ %
_secureKeyDebounceTimer
¤¤ 4
;
¤¤4 5
private
¥¥ 
bool
¥¥ 
_lastIsFocused
¥¥ 
;
¥¥  
private
¦¦ 
bool
¦¦ 
_lastHasError
¦¦ 
;
¦¦ 
private
§§ 
SecureKeyStrength
§§ $
_lastSecureKeyStrength
§§ 4
=
§§5 6
SecureKeyStrength
§§7 H
.
§§H I
INVALID
§§I P
;
§§P Q
private
¨¨ 
bool
¨¨ *
_lastIsSecureKeyStrengthMode
¨¨ -
;
¨¨- .
private
©© 
string
©©  
_lastProcessedText
©© %
=
©©& '
string
©©( .
.
©©. /
Empty
©©/ 4
;
©©4 5
private
ªª 
IDisposable
ªª 
?
ªª %
_currentTypingAnimation
ªª 0
;
ªª0 1
private
«« 
int
«« ,
_lastProcessedTextElementCount
«« .
;
««. /
private
¬¬ 
volatile
¬¬ 
bool
¬¬ *
_isProcessingSecureKeyChange
¬¬ 6
;
¬¬6 7
private
­­ 
int
­­ $
_intendedCaretPosition
­­ &
;
­­& '
public
¯¯ 

HintedTextBox
¯¯ 
(
¯¯ 
)
¯¯ 
{
°° !
InitializeComponent
±± 
(
±± 
)
±± 
;
±± "
AttachedToVisualTree
²² 
+=
²² $
OnAttachedToVisualTree
²²  6
;
²²6 7
}
³³ 
public
µµ 

int
µµ &
WarningDisplayDurationMs
µµ '
{
¶¶ 
get
·· 
=>
·· 
GetValue
·· 
(
·· .
 WarningDisplayDurationMsProperty
·· 8
)
··8 9
;
··9 :
set
¸¸ 
=>
¸¸ 
SetValue
¸¸ 
(
¸¸ .
 WarningDisplayDurationMsProperty
¸¸ 8
,
¸¸8 9
value
¸¸: ?
)
¸¸? @
;
¸¸@ A
}
¹¹ 
public
»» 

bool
»» 
IsSecureKeyMode
»» 
{
¼¼ 
get
½½ 
=>
½½ 
GetValue
½½ 
(
½½ %
IsSecureKeyModeProperty
½½ /
)
½½/ 0
;
½½0 1
set
¾¾ 
{
¿¿ 	
bool
ÀÀ 
oldValue
ÀÀ 
=
ÀÀ 
GetValue
ÀÀ $
(
ÀÀ$ %%
IsSecureKeyModeProperty
ÀÀ% <
)
ÀÀ< =
;
ÀÀ= >
SetValue
ÁÁ 
(
ÁÁ %
IsSecureKeyModeProperty
ÁÁ ,
,
ÁÁ, -
value
ÁÁ. 3
)
ÁÁ3 4
;
ÁÁ4 5
if
ÂÂ 
(
ÂÂ 
oldValue
ÂÂ 
!=
ÂÂ 
value
ÂÂ !
)
ÂÂ! "
{
ÃÃ &
OnIsSecureKeyModeChanged
ÄÄ (
(
ÄÄ( )
value
ÄÄ) .
)
ÄÄ. /
;
ÄÄ/ 0
}
ÅÅ 
}
ÆÆ 	
}
ÇÇ 
public
ÉÉ 

char
ÉÉ 
SecureKeyMaskChar
ÉÉ !
{
ÊÊ 
get
ËË 
=>
ËË 
GetValue
ËË 
(
ËË '
SecureKeyMaskCharProperty
ËË 1
)
ËË1 2
;
ËË2 3
set
ÌÌ 
=>
ÌÌ 
SetValue
ÌÌ 
(
ÌÌ '
SecureKeyMaskCharProperty
ÌÌ 1
,
ÌÌ1 2
value
ÌÌ3 8
)
ÌÌ8 9
;
ÌÌ9 :
}
ÍÍ 
public
ÏÏ 

string
ÏÏ 
Text
ÏÏ 
{
ÐÐ 
get
ÑÑ 
=>
ÑÑ 
GetValue
ÑÑ 
(
ÑÑ 
TextProperty
ÑÑ $
)
ÑÑ$ %
;
ÑÑ% &
set
ÒÒ 
=>
ÒÒ 
SetValue
ÒÒ 
(
ÒÒ 
TextProperty
ÒÒ $
,
ÒÒ$ %
value
ÒÒ& +
)
ÒÒ+ ,
;
ÒÒ, -
}
ÓÓ 
public
ÕÕ 

string
ÕÕ 
	Watermark
ÕÕ 
{
ÖÖ 
get
×× 
=>
×× 
GetValue
×× 
(
×× 
WatermarkProperty
×× )
)
××) *
;
××* +
set
ØØ 
=>
ØØ 
SetValue
ØØ 
(
ØØ 
WatermarkProperty
ØØ )
,
ØØ) *
value
ØØ+ 0
)
ØØ0 1
;
ØØ1 2
}
ÙÙ 
public
ÛÛ 

string
ÛÛ 
Hint
ÛÛ 
{
ÜÜ 
get
ÝÝ 
=>
ÝÝ 
GetValue
ÝÝ 
(
ÝÝ 
HintProperty
ÝÝ $
)
ÝÝ$ %
;
ÝÝ% &
set
ÞÞ 
=>
ÞÞ 
SetValue
ÞÞ 
(
ÞÞ 
HintProperty
ÞÞ $
,
ÞÞ$ %
value
ÞÞ& +
)
ÞÞ+ ,
;
ÞÞ, -
}
ßß 
public
áá 

IBrush
áá 
FocusBorderBrush
áá "
{
ââ 
get
ãã 
=>
ãã 
GetValue
ãã 
(
ãã &
FocusBorderBrushProperty
ãã 0
)
ãã0 1
;
ãã1 2
set
ää 
=>
ää 
SetValue
ää 
(
ää &
FocusBorderBrushProperty
ää 0
,
ää0 1
value
ää2 7
)
ää7 8
;
ää8 9
}
åå 
public
çç 

IBrush
çç 
TextForeground
çç  
{
èè 
get
éé 
=>
éé 
GetValue
éé 
(
éé $
TextForegroundProperty
éé .
)
éé. /
;
éé/ 0
set
êê 
=>
êê 
SetValue
êê 
(
êê $
TextForegroundProperty
êê .
,
êê. /
value
êê0 5
)
êê5 6
;
êê6 7
}
ëë 
public
íí 

IBrush
íí 
HintForeground
íí  
{
îî 
get
ïï 
=>
ïï 
GetValue
ïï 
(
ïï $
HintForegroundProperty
ïï .
)
ïï. /
;
ïï/ 0
set
ðð 
=>
ðð 
SetValue
ðð 
(
ðð $
HintForegroundProperty
ðð .
,
ðð. /
value
ðð0 5
)
ðð5 6
;
ðð6 7
}
ññ 
public
óó 

DrawingImage
óó 
?
óó 
IconRegularSource
óó *
{
ôô 
get
õõ 
=>
õõ 
GetValue
õõ 
(
õõ '
IconRegularSourceProperty
õõ 1
)
õõ1 2
;
õõ2 3
set
öö 
=>
öö 
SetValue
öö 
(
öö '
IconRegularSourceProperty
öö 1
,
öö1 2
value
öö3 8
)
öö8 9
;
öö9 :
}
÷÷ 
public
ùù 

DrawingImage
ùù 
?
ùù 
IconErrorSource
ùù (
{
úú 
get
ûû 
=>
ûû 
GetValue
ûû 
(
ûû %
IconErrorSourceProperty
ûû /
)
ûû/ 0
;
ûû0 1
set
üü 
=>
üü 
SetValue
üü 
(
üü %
IconErrorSourceProperty
üü /
,
üü/ 0
value
üü1 6
)
üü6 7
;
üü7 8
}
ýý 
public
ÿÿ 

string
ÿÿ 
	ErrorText
ÿÿ 
{
€€ 
get
 
=>
 
GetValue
 
(
 
ErrorTextProperty
 )
)
) *
;
* +
private
‚‚ 
set
‚‚ 
{
ƒƒ 	
SetValue
„„ 
(
„„ 
ErrorTextProperty
„„ &
,
„„& '
value
„„( -
)
„„- .
;
„„. /
}
…… 	
}
†† 
public
ˆˆ 

double
ˆˆ 
EllipseOpacity
ˆˆ  
{
‰‰ 
get
ŠŠ 
=>
ŠŠ 
GetValue
ŠŠ 
(
ŠŠ $
EllipseOpacityProperty
ŠŠ .
)
ŠŠ. /
;
ŠŠ/ 0
private
‹‹ 
set
‹‹ 
=>
‹‹ 
SetValue
‹‹ 
(
‹‹  $
EllipseOpacityProperty
‹‹  6
,
‹‹6 7
value
‹‹8 =
)
‹‹= >
;
‹‹> ?
}
ŒŒ 
public
ŽŽ 

bool
ŽŽ 
HasError
ŽŽ 
{
 
get
 
=>
 
GetValue
 
(
 
HasErrorProperty
 (
)
( )
;
) *
private
‘‘ 
set
‘‘ 
=>
‘‘ 
SetValue
‘‘ 
(
‘‘  
HasErrorProperty
‘‘  0
,
‘‘0 1
value
‘‘2 7
)
‘‘7 8
;
‘‘8 9
}
’’ 
public
”” 

IBrush
”” 
MainBorderBrush
”” !
{
•• 
get
–– 
=>
–– 
GetValue
–– 
(
–– %
MainBorderBrushProperty
–– /
)
––/ 0
;
––0 1
set
—— 
=>
—— 
SetValue
—— 
(
—— %
MainBorderBrushProperty
—— /
,
——/ 0
value
——1 6
)
——6 7
;
——7 8
}
˜˜ 
public
šš 

TextWrapping
šš 
TextWrapping
šš $
{
›› 
get
œœ 
=>
œœ 
GetValue
œœ 
(
œœ "
TextWrappingProperty
œœ ,
)
œœ, -
;
œœ- .
set
 
=>
 
SetValue
 
(
 "
TextWrappingProperty
 ,
,
, -
value
. 3
)
3 4
;
4 5
}
žž 
public
   

int
   
	MaxLength
   
{
¡¡ 
get
¢¢ 
=>
¢¢ 
GetValue
¢¢ 
(
¢¢ 
MaxLengthProperty
¢¢ )
)
¢¢) *
;
¢¢* +
set
££ 
=>
££ 
SetValue
££ 
(
££ 
MaxLengthProperty
££ )
,
££) *
value
££+ 0
)
££0 1
;
££1 2
}
¤¤ 
public
¦¦ 

int
¦¦ !
RemainingCharacters
¦¦ "
{
§§ 
get
¨¨ 
=>
¨¨ 
GetValue
¨¨ 
(
¨¨ )
RemainingCharactersProperty
¨¨ 3
)
¨¨3 4
;
¨¨4 5
private
©© 
set
©© 
=>
©© 
SetValue
©© 
(
©©  )
RemainingCharactersProperty
©©  ;
,
©©; <
value
©©= B
)
©©B C
;
©©C D
}
ªª 
public
¬¬ 

bool
¬¬ "
ShowCharacterCounter
¬¬ $
{
­­ 
get
®® 
=>
®® 
GetValue
®® 
(
®® *
ShowCharacterCounterProperty
®® 4
)
®®4 5
;
®®5 6
set
¯¯ 
=>
¯¯ 
SetValue
¯¯ 
(
¯¯ *
ShowCharacterCounterProperty
¯¯ 4
,
¯¯4 5
value
¯¯6 ;
)
¯¯; <
;
¯¯< =
}
°° 
public
²² 

bool
²² 
IsNumericOnly
²² 
{
³³ 
get
´´ 
=>
´´ 
GetValue
´´ 
(
´´ #
IsNumericOnlyProperty
´´ -
)
´´- .
;
´´. /
set
µµ 
=>
µµ 
SetValue
µµ 
(
µµ #
IsNumericOnlyProperty
µµ -
,
µµ- .
value
µµ/ 4
)
µµ4 5
;
µµ5 6
}
¶¶ 
public
¸¸ 

new
¸¸ 
IBrush
¸¸ 

Background
¸¸  
{
¹¹ 
get
ºº 
=>
ºº 
GetValue
ºº 
(
ºº  
BackgroundProperty
ºº *
)
ºº* +
;
ºº+ ,
set
»» 
=>
»» 
SetValue
»» 
(
»»  
BackgroundProperty
»» *
,
»»* +
value
»», 1
)
»»1 2
;
»»2 3
}
¼¼ 
public
¾¾ 

new
¾¾ 
double
¾¾ 
FontSize
¾¾ 
{
¿¿ 
get
ÀÀ 
=>
ÀÀ 
GetValue
ÀÀ 
(
ÀÀ 
FontSizeProperty
ÀÀ (
)
ÀÀ( )
;
ÀÀ) *
set
ÁÁ 
=>
ÁÁ 
SetValue
ÁÁ 
(
ÁÁ 
FontSizeProperty
ÁÁ (
,
ÁÁ( )
value
ÁÁ* /
)
ÁÁ/ 0
;
ÁÁ0 1
}
ÂÂ 
public
ÄÄ 

double
ÄÄ 
WatermarkFontSize
ÄÄ #
{
ÅÅ 
get
ÆÆ 
=>
ÆÆ 
GetValue
ÆÆ 
(
ÆÆ '
WatermarkFontSizeProperty
ÆÆ 1
)
ÆÆ1 2
;
ÆÆ2 3
set
ÇÇ 
=>
ÇÇ 
SetValue
ÇÇ 
(
ÇÇ '
WatermarkFontSizeProperty
ÇÇ 1
,
ÇÇ1 2
value
ÇÇ3 8
)
ÇÇ8 9
;
ÇÇ9 :
}
ÈÈ 
public
ÊÊ 

new
ÊÊ 

FontWeight
ÊÊ 

FontWeight
ÊÊ $
{
ËË 
get
ÌÌ 
=>
ÌÌ 
GetValue
ÌÌ 
(
ÌÌ  
FontWeightProperty
ÌÌ *
)
ÌÌ* +
;
ÌÌ+ ,
set
ÍÍ 
=>
ÍÍ 
SetValue
ÍÍ 
(
ÍÍ  
FontWeightProperty
ÍÍ *
,
ÍÍ* +
value
ÍÍ, 1
)
ÍÍ1 2
;
ÍÍ2 3
}
ÎÎ 
public
ÐÐ 

bool
ÐÐ %
IsSecureKeyStrengthMode
ÐÐ '
{
ÑÑ 
get
ÒÒ 
=>
ÒÒ 
GetValue
ÒÒ 
(
ÒÒ -
IsSecureKeyStrengthModeProperty
ÒÒ 7
)
ÒÒ7 8
;
ÒÒ8 9
set
ÓÓ 
=>
ÓÓ 
SetValue
ÓÓ 
(
ÓÓ -
IsSecureKeyStrengthModeProperty
ÓÓ 7
,
ÓÓ7 8
value
ÓÓ9 >
)
ÓÓ> ?
;
ÓÓ? @
}
ÔÔ 
public
ÖÖ 

SecureKeyStrength
ÖÖ 
SecureKeyStrength
ÖÖ .
{
×× 
get
ØØ 
=>
ØØ 
GetValue
ØØ 
(
ØØ '
SecureKeyStrengthProperty
ØØ 1
)
ØØ1 2
;
ØØ2 3
set
ÙÙ 
=>
ÙÙ 
SetValue
ÙÙ 
(
ÙÙ '
SecureKeyStrengthProperty
ÙÙ 1
,
ÙÙ1 2
value
ÙÙ3 8
)
ÙÙ8 9
;
ÙÙ9 :
}
ÚÚ 
public
ÜÜ 

string
ÜÜ #
SecureKeyStrengthText
ÜÜ '
{
ÝÝ 
get
ÞÞ 
=>
ÞÞ 
GetValue
ÞÞ 
(
ÞÞ +
SecureKeyStrengthTextProperty
ÞÞ 5
)
ÞÞ5 6
;
ÞÞ6 7
set
ßß 
=>
ßß 
SetValue
ßß 
(
ßß +
SecureKeyStrengthTextProperty
ßß 5
,
ßß5 6
value
ßß7 <
)
ßß< =
;
ßß= >
}
àà 
public
ââ 

IBrush
ââ (
SecureKeyStrengthTextBrush
ââ ,
{
ãã 
get
ää 
=>
ää 
GetValue
ää 
(
ää 0
"SecureKeyStrengthTextBrushProperty
ää :
)
ää: ;
;
ää; <
set
åå 
=>
åå 
SetValue
åå 
(
åå 0
"SecureKeyStrengthTextBrushProperty
åå :
,
åå: ;
value
åå< A
)
ååA B
;
ååB C
}
ææ 
public
èè 

IBrush
èè (
SecureKeyStrengthIconBrush
èè ,
{
éé 
get
êê 
=>
êê 
GetValue
êê 
(
êê 0
"SecureKeyStrengthIconBrushProperty
êê :
)
êê: ;
;
êê; <
set
ëë 
=>
ëë 
SetValue
ëë 
(
ëë 0
"SecureKeyStrengthIconBrushProperty
ëë :
,
ëë: ;
value
ëë< A
)
ëëA B
;
ëëB C
}
ìì 
public
îî 

string
îî 
WarningText
îî 
{
ïï 
get
ðð 
=>
ðð 
GetValue
ðð 
(
ðð !
WarningTextProperty
ðð +
)
ðð+ ,
;
ðð, -
set
ññ 
=>
ññ 
SetValue
ññ 
(
ññ !
WarningTextProperty
ññ +
,
ññ+ ,
value
ññ- 2
)
ññ2 3
;
ññ3 4
}
òò 
public
ôô 

bool
ôô 

HasWarning
ôô 
{
õõ 
get
öö 
=>
öö 
GetValue
öö 
(
öö  
HasWarningProperty
öö *
)
öö* +
;
öö+ ,
set
÷÷ 
=>
÷÷ 
SetValue
÷÷ 
(
÷÷  
HasWarningProperty
÷÷ *
,
÷÷* +
value
÷÷, 1
)
÷÷1 2
;
÷÷2 3
}
øø 
public
úú 

event
úú 
EventHandler
úú 
<
úú (
CharacterRejectedEventArgs
úú 8
>
úú8 9
CharacterRejected
úú: K
{
ûû 
add
üü 
=>
üü 

AddHandler
üü 
(
üü $
CharacterRejectedEvent
üü 0
,
üü0 1
value
üü2 7
)
üü7 8
;
üü8 9
remove
ýý 
=>
ýý 
RemoveHandler
ýý 
(
ýý  $
CharacterRejectedEvent
ýý  6
,
ýý6 7
value
ýý8 =
)
ýý= >
;
ýý> ?
}
þþ 
public
€€ 

event
€€ 
EventHandler
€€ 
<
€€ /
!SecureKeyCharactersAddedEventArgs
€€ ?
>
€€? @&
SecureKeyCharactersAdded
€€A Y
{
 
add
‚‚ 
=>
‚‚ 

AddHandler
‚‚ 
(
‚‚ +
SecureKeyCharactersAddedEvent
‚‚ 7
,
‚‚7 8
value
‚‚9 >
)
‚‚> ?
;
‚‚? @
remove
ƒƒ 
=>
ƒƒ 
RemoveHandler
ƒƒ 
(
ƒƒ  +
SecureKeyCharactersAddedEvent
ƒƒ  =
,
ƒƒ= >
value
ƒƒ? D
)
ƒƒD E
;
ƒƒE F
}
„„ 
public
†† 

event
†† 
EventHandler
†† 
<
†† 1
#SecureKeyCharactersRemovedEventArgs
†† A
>
††A B(
SecureKeyCharactersRemoved
††C ]
{
‡‡ 
add
ˆˆ 
=>
ˆˆ 

AddHandler
ˆˆ 
(
ˆˆ -
SecureKeyCharactersRemovedEvent
ˆˆ 9
,
ˆˆ9 :
value
ˆˆ; @
)
ˆˆ@ A
;
ˆˆA B
remove
‰‰ 
=>
‰‰ 
RemoveHandler
‰‰ 
(
‰‰  -
SecureKeyCharactersRemovedEvent
‰‰  ?
,
‰‰? @
value
‰‰A F
)
‰‰F G
;
‰‰G H
}
ŠŠ 
public
ŒŒ 

void
ŒŒ  
SyncSecureKeyState
ŒŒ "
(
ŒŒ" #
int
ŒŒ# & 
newSecureKeyLength
ŒŒ' 9
)
ŒŒ9 :
{
 
if
ŽŽ 

(
ŽŽ 
_mainTextBox
ŽŽ 
==
ŽŽ 
null
ŽŽ  
)
ŽŽ  !
{
 	
return
 
;
 
}
‘‘ 	
string
““ 
maskText
““ 
=
““  
newSecureKeyLength
““ ,
>
““- .
$num
““/ 0
?
”” 
new
”” 
string
”” 
(
”” 
SecureKeyMaskChar
”” *
,
””* + 
newSecureKeyLength
””, >
)
””> ?
:
•• 
string
•• 
.
•• 
Empty
•• 
;
•• 
_mainTextBox
—— 
.
—— 
PasswordChar
—— !
=
——" #$
HintedTextBoxConstants
——$ :
.
——: ; 
NO_SECURE_KEY_CHAR
——; M
;
——M N
int
™™ 
caretPosition
™™ 
=
™™ 
Math
™™  
.
™™  !
Clamp
™™! &
(
™™& '$
_intendedCaretPosition
™™' =
,
™™= >
$num
™™? @
,
™™@ A 
newSecureKeyLength
™™B T
)
™™T U
;
™™U V
UpdateTextBox
šš 
(
šš 
maskText
šš 
,
šš 
caretPosition
šš  -
)
šš- .
;
šš. /'
UpdateRemainingCharacters
›› !
(
››! "
)
››" #
;
››# $
}
œœ 
	protected
žž 
override
žž 
void
žž &
OnDetachedFromVisualTree
žž 4
(
žž4 5+
VisualTreeAttachmentEventArgs
žž5 R
e
žžS T
)
žžT U
{
ŸŸ 
Dispose
   
(
   
)
   
;
   
base
¡¡ 
.
¡¡ &
OnDetachedFromVisualTree
¡¡ %
(
¡¡% &
e
¡¡& '
)
¡¡' (
;
¡¡( )
}
¢¢ 
public
¤¤ 

void
¤¤ 
Dispose
¤¤ 
(
¤¤ 
)
¤¤ 
{
¥¥ 
if
¦¦ 

(
¦¦ 
_isDisposed
¦¦ 
)
¦¦ 
{
§§ 	
return
¨¨ 
;
¨¨ 
}
©© 	
try
«« 
{
¬¬ 	
_isDisposed
­­ 
=
­­ 
true
­­ 
;
­­ 
if
¯¯ 
(
¯¯ !
_inputDebounceTimer
¯¯ #
!=
¯¯$ &
null
¯¯' +
)
¯¯+ ,
{
°° !
_inputDebounceTimer
±± #
.
±±# $
Stop
±±$ (
(
±±( )
)
±±) *
;
±±* +!
_inputDebounceTimer
²² #
.
²²# $
Tick
²²$ (
-=
²²) +!
OnDebounceTimerTick
²², ?
;
²²? @!
_inputDebounceTimer
³³ #
=
³³$ %
null
³³& *
;
³³* +
}
´´ 
if
¶¶ 
(
¶¶ %
_secureKeyDebounceTimer
¶¶ '
!=
¶¶( *
null
¶¶+ /
)
¶¶/ 0
{
·· %
_secureKeyDebounceTimer
¸¸ '
.
¸¸' (
Stop
¸¸( ,
(
¸¸, -
)
¸¸- .
;
¸¸. /%
_secureKeyDebounceTimer
¹¹ '
.
¹¹' (
Tick
¹¹( ,
-=
¹¹- /*
OnSecureKeyDebounceTimerTick
¹¹0 L
;
¹¹L M%
_secureKeyDebounceTimer
ºº '
=
ºº( )
null
ºº* .
;
ºº. /
}
»» 
if
½½ 
(
½½ 
_warningTimer
½½ 
!=
½½  
null
½½! %
)
½½% &
{
¾¾ 
_warningTimer
¿¿ 
.
¿¿ 
Stop
¿¿ "
(
¿¿" #
)
¿¿# $
;
¿¿$ %
_warningTimer
ÀÀ 
.
ÀÀ 
Tick
ÀÀ "
-=
ÀÀ# % 
OnWarningTimerTick
ÀÀ& 8
;
ÀÀ8 9
_warningTimer
ÁÁ 
=
ÁÁ 
null
ÁÁ  $
;
ÁÁ$ %
}
ÂÂ %
_currentTypingAnimation
ÄÄ #
?
ÄÄ# $
.
ÄÄ$ %
Dispose
ÄÄ% ,
(
ÄÄ, -
)
ÄÄ- .
;
ÄÄ. /"
AttachedToVisualTree
ÆÆ  
-=
ÆÆ! #$
OnAttachedToVisualTree
ÆÆ$ :
;
ÆÆ: ;
try
ÈÈ 
{
ÉÉ 
_disposables
ÊÊ 
.
ÊÊ 
Dispose
ÊÊ $
(
ÊÊ$ %
)
ÊÊ% &
;
ÊÊ& '
}
ËË 
catch
ÌÌ 
(
ÌÌ 
	Exception
ÌÌ 
ex
ÌÌ 
)
ÌÌ  
{
ÍÍ 
System
ÎÎ 
.
ÎÎ 
Diagnostics
ÎÎ "
.
ÎÎ" #
Debug
ÎÎ# (
.
ÎÎ( )
	WriteLine
ÎÎ) 2
(
ÎÎ2 3
$"
ÎÎ3 5
$str
ÎÎ5 T
{
ÎÎT U
ex
ÎÎU W
.
ÎÎW X
Message
ÎÎX _
}
ÎÎ_ `
"
ÎÎ` a
)
ÎÎa b
;
ÎÎb c
}
ÏÏ 
_mainTextBox
ÑÑ 
=
ÑÑ 
null
ÑÑ 
;
ÑÑ  
_focusBorder
ÒÒ 
=
ÒÒ 
null
ÒÒ 
;
ÒÒ  
_mainBorder
ÓÓ 
=
ÓÓ 
null
ÓÓ 
;
ÓÓ 
_shadowBorder
ÔÔ 
=
ÔÔ 
null
ÔÔ  
;
ÔÔ  ! 
_lastProcessedText
ÖÖ 
=
ÖÖ  
string
ÖÖ! '
.
ÖÖ' (
Empty
ÖÖ( -
;
ÖÖ- .,
_lastProcessedTextElementCount
×× *
=
××+ ,
$num
××- .
;
××. /*
_isProcessingSecureKeyChange
ØØ (
=
ØØ) *
false
ØØ+ 0
;
ØØ0 1$
_intendedCaretPosition
ÙÙ "
=
ÙÙ# $
$num
ÙÙ% &
;
ÙÙ& '
	ErrorText
ÛÛ 
=
ÛÛ 
string
ÛÛ 
.
ÛÛ 
Empty
ÛÛ $
;
ÛÛ$ %
HasError
ÜÜ 
=
ÜÜ 
false
ÜÜ 
;
ÜÜ 
}
ÝÝ 	
catch
ÞÞ 
(
ÞÞ 
	Exception
ÞÞ 
ex
ÞÞ 
)
ÞÞ 
{
ßß 	
System
àà 
.
àà 
Diagnostics
àà 
.
àà 
Debug
àà $
.
àà$ %
	WriteLine
àà% .
(
àà. /
$"
àà/ 1
$str
àà1 C
{
ààC D
ex
ààD F
.
ààF G
Message
ààG N
}
ààN O
"
ààO P
)
ààP Q
;
ààQ R
}
áá 	
}
ââ 
private
ää 
static
ää "
CharacterWarningType
ää '
GetWarningType
ää( 6
(
ää6 7
char
ää7 ;
c
ää< =
)
ää= >
{
åå 
if
ææ 

(
ææ 
char
ææ 
.
ææ 
IsLetter
ææ 
(
ææ 
c
ææ 
)
ææ 
&&
ææ 
!
ææ  !
(
ææ! "
(
ææ" #
c
ææ# $
>=
ææ% '
$char
ææ( +
&&
ææ, .
c
ææ/ 0
<=
ææ1 3
$char
ææ4 7
)
ææ7 8
||
ææ9 ;
(
ææ< =
c
ææ= >
>=
ææ? A
$char
ææB E
&&
ææF H
c
ææI J
<=
ææK M
$char
ææN Q
)
ææQ R
)
ææR S
)
ææS T
{
çç 	
return
èè "
CharacterWarningType
èè '
.
èè' (
NonLatinLetter
èè( 6
;
èè6 7
}
éé 	
return
ëë "
CharacterWarningType
ëë #
.
ëë# $
InvalidCharacter
ëë$ 4
;
ëë4 5
}
ìì 
private
îî 
static
îî 
bool
îî  
IsAllowedCharacter
îî *
(
îî* +
char
îî+ /
c
îî0 1
)
îî1 2
{
ïï 
if
ðð 

(
ðð 
char
ðð 
.
ðð 
IsDigit
ðð 
(
ðð 
c
ðð 
)
ðð 
)
ðð 
{
ññ 	
return
òò 
true
òò 
;
òò 
}
óó 	
if
õõ 

(
õõ 
(
õõ 
c
õõ 
>=
õõ 
$char
õõ 
&&
õõ 
c
õõ 
<=
õõ 
$char
õõ !
)
õõ! "
||
õõ# %
(
õõ& '
c
õõ' (
>=
õõ) +
$char
õõ, /
&&
õõ0 2
c
õõ3 4
<=
õõ5 7
$char
õõ8 ;
)
õõ; <
)
õõ< =
{
öö 	
return
÷÷ 
true
÷÷ 
;
÷÷ 
}
øø 	
if
úú 

(
úú 
!
úú 
char
úú 
.
úú 
IsLetter
úú 
(
úú 
c
úú 
)
úú 
&&
úú  
!
úú! "
char
úú" &
.
úú& '
IsDigit
úú' .
(
úú. /
c
úú/ 0
)
úú0 1
)
úú1 2
{
ûû 	
return
üü 
true
üü 
;
üü 
}
ýý 	
return
ÿÿ 
false
ÿÿ 
;
ÿÿ 
}
€€ 
private
‚‚ 
static
‚‚ 
(
‚‚ 
Color
‚‚ 
BorderColor
‚‚ %
,
‚‚% &
string
‚‚' -
	ShadowKey
‚‚. 7
,
‚‚7 8
Color
‚‚9 >
	IconColor
‚‚? H
)
‚‚H I(
GetSecureKeyStrengthColors
‚‚J d
(
‚‚d e
SecureKeyStrength
ƒƒ 
strength
ƒƒ "
)
ƒƒ" #
{
„„ 
return
…… 
strength
…… 
switch
…… 
{
†† 	
SecureKeyStrength
‡‡ 
.
‡‡ 
INVALID
‡‡ %
=>
‡‡& (
(
‡‡) *
GetCachedColor
‡‡* 8
(
‡‡8 9$
HintedTextBoxConstants
‡‡9 O
.
‡‡O P(
INVALID_STRENGTH_COLOR_HEX
‡‡P j
)
‡‡j k
,
‡‡k l$
HintedTextBoxConstants
ˆˆ &
.
ˆˆ& ')
INVALID_STRENGTH_SHADOW_KEY
ˆˆ' B
,
ˆˆB C
GetCachedColor
‰‰ 
(
‰‰ $
HintedTextBoxConstants
‰‰ 5
.
‰‰5 6(
INVALID_STRENGTH_COLOR_HEX
‰‰6 P
)
‰‰P Q
)
‰‰Q R
,
‰‰R S
SecureKeyStrength
ŠŠ 
.
ŠŠ 
	VERY_WEAK
ŠŠ '
=>
ŠŠ( *
(
ŠŠ+ ,
GetCachedColor
ŠŠ, :
(
ŠŠ: ;$
HintedTextBoxConstants
ŠŠ; Q
.
ŠŠQ R*
VERY_WEAK_STRENGTH_COLOR_HEX
ŠŠR n
)
ŠŠn o
,
ŠŠo p$
HintedTextBoxConstants
‹‹ &
.
‹‹& '+
VERY_WEAK_STRENGTH_SHADOW_KEY
‹‹' D
,
‹‹D E
GetCachedColor
ŒŒ 
(
ŒŒ $
HintedTextBoxConstants
ŒŒ 5
.
ŒŒ5 6*
VERY_WEAK_STRENGTH_COLOR_HEX
ŒŒ6 R
)
ŒŒR S
)
ŒŒS T
,
ŒŒT U
SecureKeyStrength
 
.
 
WEAK
 "
=>
# %
(
& '
GetCachedColor
' 5
(
5 6$
HintedTextBoxConstants
6 L
.
L M%
WEAK_STRENGTH_COLOR_HEX
M d
)
d e
,
e f$
HintedTextBoxConstants
ŽŽ &
.
ŽŽ& '&
WEAK_STRENGTH_SHADOW_KEY
ŽŽ' ?
,
ŽŽ? @
GetCachedColor
 
(
 $
HintedTextBoxConstants
 5
.
5 6%
WEAK_STRENGTH_COLOR_HEX
6 M
)
M N
)
N O
,
O P
SecureKeyStrength
 
.
 
GOOD
 "
=>
# %
(
& '
GetCachedColor
' 5
(
5 6$
HintedTextBoxConstants
6 L
.
L M%
GOOD_STRENGTH_COLOR_HEX
M d
)
d e
,
e f$
HintedTextBoxConstants
‘‘ &
.
‘‘& '&
GOOD_STRENGTH_SHADOW_KEY
‘‘' ?
,
‘‘? @
GetCachedColor
’’ 
(
’’ $
HintedTextBoxConstants
’’ 5
.
’’5 6%
GOOD_STRENGTH_COLOR_HEX
’’6 M
)
’’M N
)
’’N O
,
’’O P
SecureKeyStrength
““ 
.
““ 
STRONG
““ $
=>
““% '
(
““( )
GetCachedColor
““) 7
(
““7 8$
HintedTextBoxConstants
““8 N
.
““N O'
STRONG_STRENGTH_COLOR_HEX
““O h
)
““h i
,
““i j$
HintedTextBoxConstants
”” &
.
””& '(
STRONG_STRENGTH_SHADOW_KEY
””' A
,
””A B
GetCachedColor
•• 
(
•• $
HintedTextBoxConstants
•• 5
.
••5 6'
STRONG_STRENGTH_COLOR_HEX
••6 O
)
••O P
)
••P Q
,
••Q R
SecureKeyStrength
–– 
.
–– 
VERY_STRONG
–– )
=>
––* ,
(
––- .
GetCachedColor
––. <
(
––< =$
HintedTextBoxConstants
––= S
.
––S T,
VERY_STRONG_STRENGTH_COLOR_HEX
––T r
)
––r s
,
––s t$
HintedTextBoxConstants
—— &
.
——& '-
VERY_STRONG_STRENGTH_SHADOW_KEY
——' F
,
——F G
GetCachedColor
˜˜ 
(
˜˜ $
HintedTextBoxConstants
˜˜ 5
.
˜˜5 6,
VERY_STRONG_STRENGTH_COLOR_HEX
˜˜6 T
)
˜˜T U
)
˜˜U V
,
˜˜V W
_
™™ 
=>
™™ 
(
™™ 
GetCachedColor
™™  
(
™™  !$
HintedTextBoxConstants
™™! 7
.
™™7 8(
INVALID_STRENGTH_COLOR_HEX
™™8 R
)
™™R S
,
™™S T$
HintedTextBoxConstants
šš &
.
šš& ')
INVALID_STRENGTH_SHADOW_KEY
šš' B
,
ššB C
GetCachedColor
›› 
(
›› $
HintedTextBoxConstants
›› 5
.
››5 6(
INVALID_STRENGTH_COLOR_HEX
››6 P
)
››P Q
)
››Q R
}
œœ 	
;
œœ	 

}
 
private
ŸŸ 
static
ŸŸ 
int
ŸŸ !
GetTextElementCount
ŸŸ *
(
ŸŸ* +
string
ŸŸ+ 1
text
ŸŸ2 6
)
ŸŸ6 7
{
   
if
¡¡ 

(
¡¡ 
string
¡¡ 
.
¡¡ 
IsNullOrEmpty
¡¡  
(
¡¡  !
text
¡¡! %
)
¡¡% &
)
¡¡& '
{
¢¢ 	
return
££ 
$num
££ 
;
££ 
}
¤¤ 	
if
¦¦ 

(
¦¦ #
TextElementCountCache
¦¦ !
.
¦¦! "
TryGetValue
¦¦" -
(
¦¦- .
text
¦¦. 2
,
¦¦2 3
out
¦¦4 7
int
¦¦8 ;
cachedCount
¦¦< G
)
¦¦G H
)
¦¦H I
{
§§ 	
return
¨¨ 
cachedCount
¨¨ 
;
¨¨ 
}
©© 	
try
«« 
{
¬¬ 	

StringInfo
­­ 

stringInfo
­­ !
=
­­" #
new
­­$ '
(
­­' (
text
­­( ,
)
­­, -
;
­­- .
int
®® 
count
®® 
=
®® 

stringInfo
®® "
.
®®" #"
LengthInTextElements
®®# 7
;
®®7 8
switch
°° 
(
°° #
TextElementCountCache
°° )
.
°°) *
Count
°°* /
)
°°/ 0
{
±± 
case
²² 
<
²² )
MAX_TEXT_ELEMENT_CACHE_SIZE
²² 2
:
²²2 3#
TextElementCountCache
³³ )
[
³³) *
text
³³* .
]
³³. /
=
³³0 1
count
³³2 7
;
³³7 8
break
´´ 
;
´´ 
case
µµ 
>
µµ )
MAX_TEXT_ELEMENT_CACHE_SIZE
µµ 2
:
µµ2 3#
TextElementCountCache
¶¶ )
.
¶¶) *
Clear
¶¶* /
(
¶¶/ 0
)
¶¶0 1
;
¶¶1 2#
TextElementCountCache
·· )
[
··) *
text
··* .
]
··. /
=
··0 1
count
··2 7
;
··7 8
break
¸¸ 
;
¸¸ 
}
¹¹ 
return
»» 
count
»» 
;
»» 
}
¼¼ 	
catch
½½ 
(
½½ 
	Exception
½½ 
ex
½½ 
)
½½ 
{
¾¾ 	
System
¿¿ 
.
¿¿ 
Diagnostics
¿¿ 
.
¿¿ 
Debug
¿¿ $
.
¿¿$ %
	WriteLine
¿¿% .
(
¿¿. /
$"
ÀÀ 
$str
ÀÀ U
{
ÀÀU V
ex
ÀÀV X
.
ÀÀX Y
Message
ÀÀY `
}
ÀÀ` a
"
ÀÀa b
)
ÀÀb c
;
ÀÀc d
int
ÁÁ 
fallbackCount
ÁÁ 
=
ÁÁ 
text
ÁÁ  $
.
ÁÁ$ %
Length
ÁÁ% +
;
ÁÁ+ ,
if
ÂÂ 
(
ÂÂ #
TextElementCountCache
ÂÂ %
.
ÂÂ% &
Count
ÂÂ& +
<
ÂÂ, -)
MAX_TEXT_ELEMENT_CACHE_SIZE
ÂÂ. I
)
ÂÂI J
{
ÃÃ #
TextElementCountCache
ÄÄ %
[
ÄÄ% &
text
ÄÄ& *
]
ÄÄ* +
=
ÄÄ, -
fallbackCount
ÄÄ. ;
;
ÄÄ; <
}
ÅÅ 
return
ÇÇ 
fallbackCount
ÇÇ  
;
ÇÇ  !
}
ÈÈ 	
}
ÉÉ 
private
ËË 
static
ËË 
string
ËË 
SafeSubstring
ËË '
(
ËË' (
string
ËË( .
text
ËË/ 3
,
ËË3 4
int
ËË5 8

startIndex
ËË9 C
,
ËËC D
int
ËËE H
length
ËËI O
)
ËËO P
{
ÌÌ 
if
ÍÍ 

(
ÍÍ 
string
ÍÍ 
.
ÍÍ 
IsNullOrEmpty
ÍÍ  
(
ÍÍ  !
text
ÍÍ! %
)
ÍÍ% &
||
ÍÍ' )

startIndex
ÍÍ* 4
<
ÍÍ5 6
$num
ÍÍ7 8
)
ÍÍ8 9
{
ÎÎ 	
return
ÏÏ 
string
ÏÏ 
.
ÏÏ 
Empty
ÏÏ 
;
ÏÏ  
}
ÐÐ 	
try
ÒÒ 
{
ÓÓ 	

StringInfo
ÔÔ 

stringInfo
ÔÔ !
=
ÔÔ" #
new
ÔÔ$ '
(
ÔÔ' (
text
ÔÔ( ,
)
ÔÔ, -
;
ÔÔ- .
int
ÕÕ 
textElementCount
ÕÕ  
=
ÕÕ! "

stringInfo
ÕÕ# -
.
ÕÕ- ."
LengthInTextElements
ÕÕ. B
;
ÕÕB C
if
×× 
(
×× 

startIndex
×× 
>=
×× 
textElementCount
×× .
)
××. /
{
ØØ 
return
ÙÙ 
string
ÙÙ 
.
ÙÙ 
Empty
ÙÙ #
;
ÙÙ# $
}
ÚÚ 
int
ÜÜ 
actualLength
ÜÜ 
=
ÜÜ 
Math
ÜÜ #
.
ÜÜ# $
Min
ÜÜ$ '
(
ÜÜ' (
length
ÜÜ( .
,
ÜÜ. /
textElementCount
ÜÜ0 @
-
ÜÜA B

startIndex
ÜÜC M
)
ÜÜM N
;
ÜÜN O
return
ÝÝ 
actualLength
ÝÝ 
<=
ÝÝ  "
$num
ÝÝ# $
?
ÝÝ% &
string
ÝÝ' -
.
ÝÝ- .
Empty
ÝÝ. 3
:
ÝÝ4 5

stringInfo
ÝÝ6 @
.
ÝÝ@ A%
SubstringByTextElements
ÝÝA X
(
ÝÝX Y

startIndex
ÝÝY c
,
ÝÝc d
actualLength
ÝÝe q
)
ÝÝq r
;
ÝÝr s
}
ÞÞ 	
catch
ßß 
(
ßß 
	Exception
ßß 
ex
ßß 
)
ßß 
{
àà 	
System
áá 
.
áá 
Diagnostics
áá 
.
áá 
Debug
áá $
.
áá$ %
	WriteLine
áá% .
(
áá. /
$"
ââ 
$str
ââ c
{
ââc d
ex
ââd f
.
ââf g
Message
ââg n
}
âân o
"
ââo p
)
ââp q
;
ââq r
try
ãã 
{
ää 
int
åå 
	safeStart
åå 
=
åå 
Math
åå  $
.
åå$ %
Min
åå% (
(
åå( )

startIndex
åå) 3
,
åå3 4
text
åå5 9
.
åå9 :
Length
åå: @
)
åå@ A
;
ååA B
int
ææ 

safeLength
ææ 
=
ææ  
Math
ææ! %
.
ææ% &
Min
ææ& )
(
ææ) *
length
ææ* 0
,
ææ0 1
text
ææ2 6
.
ææ6 7
Length
ææ7 =
-
ææ> ?
	safeStart
ææ@ I
)
ææI J
;
ææJ K
return
çç 

safeLength
çç !
>
çç" #
$num
çç$ %
?
çç& '
text
çç( ,
.
çç, -
	Substring
çç- 6
(
çç6 7
	safeStart
çç7 @
,
çç@ A

safeLength
ççB L
)
ççL M
:
ççN O
string
ççP V
.
ççV W
Empty
ççW \
;
çç\ ]
}
èè 
catch
éé 
(
éé 
	Exception
éé 
ex2
éé  
)
éé  !
{
êê 
System
ëë 
.
ëë 
Diagnostics
ëë "
.
ëë" #
Debug
ëë# (
.
ëë( )
	WriteLine
ëë) 2
(
ëë2 3
$"
ìì 
$str
ìì M
{
ììM N
ex2
ììN Q
.
ììQ R
Message
ììR Y
}
ììY Z
"
ììZ [
)
ìì[ \
;
ìì\ ]
return
íí 
string
íí 
.
íí 
Empty
íí #
;
íí# $
}
îî 
}
ïï 	
}
ðð 
private
òò 
static
òò 
string
òò "
GetAddedTextElements
òò .
(
òò. /
string
òò/ 5
?
òò5 6
currentText
òò7 B
,
òòB C
string
òòD J
lastText
òòK S
,
òòS T
int
òòU X

caretIndex
òòY c
)
òòc d
{
óó 
if
ôô 

(
ôô 
string
ôô 
.
ôô 
IsNullOrEmpty
ôô  
(
ôô  !
currentText
ôô! ,
)
ôô, -
||
ôô. 0
string
ôô1 7
.
ôô7 8
IsNullOrEmpty
ôô8 E
(
ôôE F
lastText
ôôF N
)
ôôN O
)
ôôO P
{
õõ 	
return
öö 
currentText
öö 
??
öö !
string
öö" (
.
öö( )
Empty
öö) .
;
öö. /
}
÷÷ 	
try
ùù 
{
úú 	

StringInfo
ûû 
currentInfo
ûû "
=
ûû# $
new
ûû% (
(
ûû( )
currentText
ûû) 4
)
ûû4 5
;
ûû5 6

StringInfo
üü 
lastInfo
üü 
=
üü  !
new
üü" %
(
üü% &
lastText
üü& .
)
üü. /
;
üü/ 0
int
þþ 
currentCount
þþ 
=
þþ 
currentInfo
þþ *
.
þþ* +"
LengthInTextElements
þþ+ ?
;
þþ? @
int
ÿÿ 
	lastCount
ÿÿ 
=
ÿÿ 
lastInfo
ÿÿ $
.
ÿÿ$ %"
LengthInTextElements
ÿÿ% 9
;
ÿÿ9 :
if
 
(
 
currentCount
 
<=
 
	lastCount
  )
)
) *
{
‚‚ 
return
ƒƒ 
string
ƒƒ 
.
ƒƒ 
Empty
ƒƒ #
;
ƒƒ# $
}
„„ 
int
†† 

addedCount
†† 
=
†† 
currentCount
†† )
-
††* +
	lastCount
††, 5
;
††5 6
int
‡‡ 
	insertPos
‡‡ 
=
‡‡ 
Math
‡‡  
.
‡‡  !
Max
‡‡! $
(
‡‡$ %
$num
‡‡% &
,
‡‡& '
Math
‡‡( ,
.
‡‡, -
Min
‡‡- 0
(
‡‡0 1

caretIndex
‡‡1 ;
-
‡‡< =

addedCount
‡‡> H
,
‡‡H I
currentCount
‡‡J V
-
‡‡W X

addedCount
‡‡Y c
)
‡‡c d
)
‡‡d e
;
‡‡e f
return
‰‰ 
SafeSubstring
‰‰  
(
‰‰  !
currentText
‰‰! ,
,
‰‰, -
	insertPos
‰‰. 7
,
‰‰7 8

addedCount
‰‰9 C
)
‰‰C D
;
‰‰D E
}
ŠŠ 	
catch
‹‹ 
(
‹‹ 
	Exception
‹‹ 
ex
‹‹ 
)
‹‹ 
{
ŒŒ 	
System
 
.
 
Diagnostics
 
.
 
Debug
 $
.
$ %
	WriteLine
% .
(
. /
$"
ŽŽ 
$str
ŽŽ `
{
ŽŽ` a
ex
ŽŽa c
.
ŽŽc d
Message
ŽŽd k
}
ŽŽk l
"
ŽŽl m
)
ŽŽm n
;
ŽŽn o
int
 

addedCount
 
=
 
currentText
 (
.
( )
Length
) /
-
0 1
lastText
2 :
.
: ;
Length
; A
;
A B
if
 
(
 

addedCount
 
<=
 
$num
 
)
  
{
‘‘ 
return
’’ 
string
’’ 
.
’’ 
Empty
’’ #
;
’’# $
}
““ 
int
•• 
	insertPos
•• 
=
•• 
Math
••  
.
••  !
Max
••! $
(
••$ %
$num
••% &
,
••& '

caretIndex
••( 2
-
••3 4

addedCount
••5 ?
)
••? @
;
••@ A
return
–– 
SafeSubstring
––  
(
––  !
currentText
––! ,
,
––, -
	insertPos
––. 7
,
––7 8

addedCount
––9 C
)
––C D
;
––D E
}
—— 	
}
˜˜ 
private
šš 
static
šš 
Color
šš 
GetCachedColor
šš '
(
šš' (
string
šš( .
colorHex
šš/ 7
)
šš7 8
{
›› 
if
œœ 

(
œœ 

ColorCache
œœ 
.
œœ 
TryGetValue
œœ "
(
œœ" #
colorHex
œœ# +
,
œœ+ ,
out
œœ- 0
Color
œœ1 6
color
œœ7 <
)
œœ< =
)
œœ= >
{
 	
return
žž 
color
žž 
;
žž 
}
ŸŸ 	
color
¡¡ 
=
¡¡ 
Color
¡¡ 
.
¡¡ 
Parse
¡¡ 
(
¡¡ 
colorHex
¡¡ $
)
¡¡$ %
;
¡¡% &

ColorCache
¢¢ 
[
¢¢ 
colorHex
¢¢ 
]
¢¢ 
=
¢¢ 
color
¢¢ $
;
¢¢$ %
return
¤¤ 
color
¤¤ 
;
¤¤ 
}
¥¥ 
private
§§ 
static
§§ 
SolidColorBrush
§§ "
GetCachedBrush
§§# 1
(
§§1 2
Color
§§2 7
color
§§8 =
)
§§= >
{
¨¨ 
string
©© 
key
©© 
=
©© 
color
©© 
.
©© 
ToString
©© #
(
©©# $
)
©©$ %
;
©©% &
if
ªª 

(
ªª 

BrushCache
ªª 
.
ªª 
TryGetValue
ªª "
(
ªª" #
key
ªª# &
,
ªª& '
out
ªª( +
SolidColorBrush
ªª, ;
?
ªª; <
brush
ªª= B
)
ªªB C
)
ªªC D
{
«« 	
return
¬¬ 
brush
¬¬ 
;
¬¬ 
}
­­ 	
brush
¯¯ 
=
¯¯ 
new
¯¯ 
SolidColorBrush
¯¯ #
(
¯¯# $
color
¯¯$ )
)
¯¯) *
;
¯¯* +

BrushCache
°° 
[
°° 
key
°° 
]
°° 
=
°° 
brush
°° 
;
°°  
return
²² 
brush
²² 
;
²² 
}
³³ 
private
µµ 
void
µµ $
OnAttachedToVisualTree
µµ '
(
µµ' (
object
µµ( .
?
µµ. /
sender
µµ0 6
,
µµ6 7+
VisualTreeAttachmentEventArgs
µµ8 U
e
µµV W
)
µµW X
{
¶¶ 
if
·· 

(
·· #
_isControlInitialized
·· !
||
··" $
_isDisposed
··% 0
)
··0 1
{
¸¸ 	
return
¹¹ 
;
¹¹ 
}
ºº 	

Initialize
¼¼ 
(
¼¼ 
)
¼¼ 
;
¼¼ 
}
½½ 
private
¿¿ 
void
¿¿ 

Initialize
¿¿ 
(
¿¿ 
)
¿¿ 
{
ÀÀ 
if
ÁÁ 

(
ÁÁ #
_isControlInitialized
ÁÁ !
)
ÁÁ! "
{
ÂÂ 	
return
ÃÃ 
;
ÃÃ 
}
ÄÄ 	
FindControls
ÆÆ 
(
ÆÆ 
)
ÆÆ 
;
ÆÆ 
if
ÇÇ 

(
ÇÇ 
_mainTextBox
ÇÇ 
==
ÇÇ 
null
ÇÇ  
)
ÇÇ  !
{
ÈÈ 	
return
ÉÉ 
;
ÉÉ 
}
ÊÊ 	
_mainTextBox
ÌÌ 
.
ÌÌ 
TextChanged
ÌÌ  
+=
ÌÌ! #
OnTextChanged
ÌÌ$ 1
;
ÌÌ1 2
_mainTextBox
ÍÍ 
.
ÍÍ 
GotFocus
ÍÍ 
+=
ÍÍ  

OnGotFocus
ÍÍ! +
;
ÍÍ+ ,
_mainTextBox
ÎÎ 
.
ÎÎ 
	LostFocus
ÎÎ 
+=
ÎÎ !
OnLostFocus
ÎÎ" -
;
ÎÎ- .
if
ÐÐ 

(
ÐÐ 
IsSecureKeyMode
ÐÐ 
)
ÐÐ 
{
ÑÑ 	(
DisableClipboardOperations
ÒÒ &
(
ÒÒ& '
)
ÒÒ' (
;
ÒÒ( )
}
ÓÓ 	
_disposables
ÕÕ 
.
ÕÕ 
Add
ÕÕ 
(
ÕÕ 

Disposable
ÕÕ #
.
ÕÕ# $
Create
ÕÕ$ *
(
ÕÕ* +&
UnsubscribeTextBoxEvents
ÕÕ+ C
)
ÕÕC D
)
ÕÕD E
;
ÕÕE F#
SetupReactiveBindings
×× 
(
×× 
)
×× 
;
××  
UpdateBorderState
ØØ 
(
ØØ 
)
ØØ 
;
ØØ #
_isControlInitialized
ÙÙ 
=
ÙÙ 
true
ÙÙ  $
;
ÙÙ$ %
}
ÚÚ 
private
ÜÜ 
void
ÜÜ (
DisableClipboardOperations
ÜÜ +
(
ÜÜ+ ,
)
ÜÜ, -
{
ÝÝ 
if
ÞÞ 

(
ÞÞ 
_mainTextBox
ÞÞ 
==
ÞÞ 
null
ÞÞ  
)
ÞÞ  !
{
ßß 	
return
àà 
;
àà 
}
áá 	
_mainTextBox
ãã 
.
ãã 

AddHandler
ãã 
(
ãã  
TextInputEvent
ãã  .
,
ãã. /
OnTextInput
ãã0 ;
,
ãã; <
RoutingStrategies
ãã= N
.
ããN O
Tunnel
ããO U
)
ããU V
;
ããV W
_mainTextBox
ää 
.
ää 

AddHandler
ää 
(
ää  
KeyDownEvent
ää  ,
,
ää, -
OnPreviewKeyDown
ää. >
,
ää> ?
RoutingStrategies
ää@ Q
.
ääQ R
Tunnel
ääR X
)
ääX Y
;
ääY Z
_mainTextBox
ææ 
.
ææ 

AddHandler
ææ 
(
ææ  !
PointerPressedEvent
ææ  3
,
ææ3 4
OnPointerPressed
ææ5 E
,
ææE F
RoutingStrategies
ææG X
.
ææX Y
Tunnel
ææY _
)
ææ_ `
;
ææ` a
_mainTextBox
çç 
.
çç 

AddHandler
çç 
(
çç  
PointerMovedEvent
çç  1
,
çç1 2
OnPointerMoved
çç3 A
,
ççA B
RoutingStrategies
ççC T
.
ççT U
Tunnel
ççU [
)
çç[ \
;
çç\ ]
_mainTextBox
èè 
.
èè 

AddHandler
èè 
(
èè  "
PointerReleasedEvent
èè  4
,
èè4 5
OnPointerReleased
èè6 G
,
èèG H
RoutingStrategies
èèI Z
.
èèZ [
Tunnel
èè[ a
)
èèa b
;
èèb c
_mainTextBox
êê 
.
êê 

AddHandler
êê 
(
êê  
DragDrop
êê  (
.
êê( )
DragEnterEvent
êê) 7
,
êê7 8
OnDragEnter
êê9 D
,
êêD E
RoutingStrategies
êêF W
.
êêW X
Tunnel
êêX ^
)
êê^ _
;
êê_ `
_mainTextBox
ëë 
.
ëë 

AddHandler
ëë 
(
ëë  
DragDrop
ëë  (
.
ëë( )
DragOverEvent
ëë) 6
,
ëë6 7

OnDragOver
ëë8 B
,
ëëB C
RoutingStrategies
ëëD U
.
ëëU V
Tunnel
ëëV \
)
ëë\ ]
;
ëë] ^
_mainTextBox
ìì 
.
ìì 

AddHandler
ìì 
(
ìì  
DragDrop
ìì  (
.
ìì( )
	DropEvent
ìì) 2
,
ìì2 3
OnDrop
ìì4 :
,
ìì: ;
RoutingStrategies
ìì< M
.
ììM N
Tunnel
ììN T
)
ììT U
;
ììU V
_mainTextBox
îî 
.
îî 

AddHandler
îî 
(
îî  
Gestures
îî  (
.
îî( )
TappedEvent
îî) 4
,
îî4 5
OnTapped
îî6 >
,
îî> ?
RoutingStrategies
îî@ Q
.
îîQ R
Tunnel
îîR X
)
îîX Y
;
îîY Z
_mainTextBox
ïï 
.
ïï 

AddHandler
ïï 
(
ïï  
Gestures
ïï  (
.
ïï( )
DoubleTappedEvent
ïï) :
,
ïï: ;
OnDoubleTapped
ïï< J
,
ïïJ K
RoutingStrategies
ïïL ]
.
ïï] ^
Tunnel
ïï^ d
)
ïïd e
;
ïïe f
_mainTextBox
ðð 
.
ðð 

AddHandler
ðð 
(
ðð  
Gestures
ðð  (
.
ðð( )
HoldingEvent
ðð) 5
,
ðð5 6
	OnHolding
ðð7 @
,
ðð@ A
RoutingStrategies
ððB S
.
ððS T
Tunnel
ððT Z
)
ððZ [
;
ðð[ \
_mainTextBox
òò 
.
òò 
SelectionStart
òò #
=
òò$ %
$num
òò& '
;
òò' (
_mainTextBox
óó 
.
óó 
SelectionEnd
óó !
=
óó" #
$num
óó$ %
;
óó% &
_mainTextBox
õõ 
.
õõ 

IsReadOnly
õõ 
=
õõ  !
false
õõ" '
;
õõ' (
}
öö 
private
øø 
void
øø 
OnPointerReleased
øø "
(
øø" #
object
øø# )
?
øø) *
sender
øø+ 1
,
øø1 2&
PointerReleasedEventArgs
øø3 K
e
øøL M
)
øøM N
{
ùù 
if
úú 

(
úú 
!
úú 
IsSecureKeyMode
úú 
)
úú 
{
ûû 	
return
üü 
;
üü 
}
ýý 	
e
ÿÿ 	
.
ÿÿ	 

Handled
ÿÿ
 
=
ÿÿ 
true
ÿÿ 
;
ÿÿ 
if
€€ 

(
€€ 
_mainTextBox
€€ 
!=
€€ 
null
€€  
)
€€  !
{
 	
_mainTextBox
‚‚ 
.
‚‚ 

CaretIndex
‚‚ #
=
‚‚$ %
_mainTextBox
‚‚& 2
.
‚‚2 3
Text
‚‚3 7
?
‚‚7 8
.
‚‚8 9
Length
‚‚9 ?
??
‚‚@ B
$num
‚‚C D
;
‚‚D E$
_intendedCaretPosition
ƒƒ "
=
ƒƒ# $
_mainTextBox
ƒƒ% 1
.
ƒƒ1 2
Text
ƒƒ2 6
?
ƒƒ6 7
.
ƒƒ7 8
Length
ƒƒ8 >
??
ƒƒ? A
$num
ƒƒB C
;
ƒƒC D
}
„„ 	
}
…… 
private
‡‡ 
void
‡‡ 
OnTapped
‡‡ 
(
‡‡ 
object
‡‡  
?
‡‡  !
sender
‡‡" (
,
‡‡( )
TappedEventArgs
‡‡* 9
e
‡‡: ;
)
‡‡; <
{
ˆˆ 
if
‰‰ 

(
‰‰ 
!
‰‰ 
IsSecureKeyMode
‰‰ 
||
‰‰ 
_mainTextBox
‰‰  ,
==
‰‰- /
null
‰‰0 4
)
‰‰4 5
{
ŠŠ 	
return
‹‹ 
;
‹‹ 
}
ŒŒ 	
e
ŽŽ 	
.
ŽŽ	 

Handled
ŽŽ
 
=
ŽŽ 
true
ŽŽ 
;
ŽŽ 
_mainTextBox
 
.
 
SelectionStart
 #
=
$ %
$num
& '
;
' (
_mainTextBox
‘‘ 
.
‘‘ 
SelectionEnd
‘‘ !
=
‘‘" #
$num
‘‘$ %
;
‘‘% &
_mainTextBox
’’ 
.
’’ 

CaretIndex
’’ 
=
’’  !
_mainTextBox
’’" .
.
’’. /
Text
’’/ 3
?
’’3 4
.
’’4 5
Length
’’5 ;
??
’’< >
$num
’’? @
;
’’@ A
if
”” 

(
”” 
!
”” 
_mainTextBox
”” 
.
”” 
	IsFocused
”” #
)
””# $
{
•• 	
_mainTextBox
–– 
.
–– 
Focus
–– 
(
–– 
)
––  
;
––  !
}
—— 	
}
˜˜ 
private
›› 
void
›› 
OnDoubleTapped
›› 
(
››  
object
››  &
?
››& '
sender
››( .
,
››. /
TappedEventArgs
››0 ?
e
››@ A
)
››A B
{
œœ 
if
 

(
 
!
 
IsSecureKeyMode
 
)
 
{
žž 	
return
ŸŸ 
;
ŸŸ 
}
   	
e
¢¢ 	
.
¢¢	 

Handled
¢¢
 
=
¢¢ 
true
¢¢ 
;
¢¢ 
if
££ 

(
££ 
_mainTextBox
££ 
!=
££ 
null
££  
)
££  !
{
¤¤ 	
_mainTextBox
¥¥ 
.
¥¥ 

CaretIndex
¥¥ #
=
¥¥$ %
_mainTextBox
¥¥& 2
.
¥¥2 3
Text
¥¥3 7
?
¥¥7 8
.
¥¥8 9
Length
¥¥9 ?
??
¥¥@ B
$num
¥¥C D
;
¥¥D E
}
¦¦ 	
}
§§ 
private
©© 
void
©© 
	OnHolding
©© 
(
©© 
object
©© !
?
©©! "
sender
©©# )
,
©©) *$
HoldingRoutedEventArgs
©©+ A
e
©©B C
)
©©C D
{
ªª 
if
«« 

(
«« 
!
«« 
IsSecureKeyMode
«« 
)
«« 
{
¬¬ 	
return
­­ 
;
­­ 
}
®® 	
e
°° 	
.
°°	 

Handled
°°
 
=
°° 
true
°° 
;
°° 
}
±± 
private
³³ 
void
³³ 
OnPointerMoved
³³ 
(
³³  
object
³³  &
?
³³& '
sender
³³( .
,
³³. /
PointerEventArgs
³³0 @
e
³³A B
)
³³B C
{
´´ 
if
µµ 

(
µµ 
!
µµ 
IsSecureKeyMode
µµ 
)
µµ 
{
¶¶ 	
return
·· 
;
·· 
}
¸¸ 	
e
ºº 	
.
ºº	 

Handled
ºº
 
=
ºº 
true
ºº 
;
ºº 
}
»» 
private
½½ 
void
½½ 
OnDragEnter
½½ 
(
½½ 
object
½½ #
?
½½# $
sender
½½% +
,
½½+ ,
DragEventArgs
½½- :
e
½½; <
)
½½< =
=>
½½> @&
HandleSecureKeyDragEvent
½½A Y
(
½½Y Z
e
½½Z [
)
½½[ \
;
½½\ ]
private
¿¿ 
void
¿¿ 

OnDragOver
¿¿ 
(
¿¿ 
object
¿¿ "
?
¿¿" #
sender
¿¿$ *
,
¿¿* +
DragEventArgs
¿¿, 9
e
¿¿: ;
)
¿¿; <
=>
¿¿= ?&
HandleSecureKeyDragEvent
¿¿@ X
(
¿¿X Y
e
¿¿Y Z
)
¿¿Z [
;
¿¿[ \
private
ÁÁ 
void
ÁÁ 
OnDrop
ÁÁ 
(
ÁÁ 
object
ÁÁ 
?
ÁÁ 
sender
ÁÁ  &
,
ÁÁ& '
DragEventArgs
ÁÁ( 5
e
ÁÁ6 7
)
ÁÁ7 8
=>
ÁÁ9 ;&
HandleSecureKeyDragEvent
ÁÁ< T
(
ÁÁT U
e
ÁÁU V
)
ÁÁV W
;
ÁÁW X
private
ÃÃ 
void
ÃÃ &
HandleSecureKeyDragEvent
ÃÃ )
(
ÃÃ) *
DragEventArgs
ÃÃ* 7
e
ÃÃ8 9
)
ÃÃ9 :
{
ÄÄ 
if
ÅÅ 

(
ÅÅ 
!
ÅÅ 
IsSecureKeyMode
ÅÅ 
)
ÅÅ 
{
ÆÆ 	
return
ÇÇ 
;
ÇÇ 
}
ÈÈ 	
e
ÊÊ 	
.
ÊÊ	 

Handled
ÊÊ
 
=
ÊÊ 
true
ÊÊ 
;
ÊÊ 
}
ËË 
private
ÍÍ 
void
ÍÍ 
OnPointerPressed
ÍÍ !
(
ÍÍ! "
object
ÍÍ" (
?
ÍÍ( )
sender
ÍÍ* 0
,
ÍÍ0 1%
PointerPressedEventArgs
ÍÍ2 I
e
ÍÍJ K
)
ÍÍK L
{
ÎÎ 
if
ÏÏ 

(
ÏÏ 
!
ÏÏ 
IsSecureKeyMode
ÏÏ 
||
ÏÏ 
_mainTextBox
ÏÏ  ,
==
ÏÏ- /
null
ÏÏ0 4
)
ÏÏ4 5
{
ÐÐ 	
return
ÑÑ 
;
ÑÑ 
}
ÒÒ 	
e
ÔÔ 	
.
ÔÔ	 

Handled
ÔÔ
 
=
ÔÔ 
true
ÔÔ 
;
ÔÔ 
if
ÖÖ 

(
ÖÖ 
!
ÖÖ 
_mainTextBox
ÖÖ 
.
ÖÖ 
	IsFocused
ÖÖ #
)
ÖÖ# $
{
×× 	
_mainTextBox
ØØ 
.
ØØ 
Focus
ØØ 
(
ØØ 
)
ØØ  
;
ØØ  !
}
ÙÙ 	
_mainTextBox
ÛÛ 
.
ÛÛ 

CaretIndex
ÛÛ 
=
ÛÛ  !
_mainTextBox
ÛÛ" .
.
ÛÛ. /
Text
ÛÛ/ 3
?
ÛÛ3 4
.
ÛÛ4 5
Length
ÛÛ5 ;
??
ÛÛ< >
$num
ÛÛ? @
;
ÛÛ@ A$
_intendedCaretPosition
ÜÜ 
=
ÜÜ  
_mainTextBox
ÜÜ! -
.
ÜÜ- .
Text
ÜÜ. 2
?
ÜÜ2 3
.
ÜÜ3 4
Length
ÜÜ4 :
??
ÜÜ; =
$num
ÜÜ> ?
;
ÜÜ? @
}
ÝÝ 
private
ßß 
void
ßß 
OnTextInput
ßß 
(
ßß 
object
ßß #
?
ßß# $
sender
ßß% +
,
ßß+ , 
TextInputEventArgs
ßß- ?
e
ßß@ A
)
ßßA B
{
àà 
if
áá 

(
áá 
!
áá 
IsSecureKeyMode
áá 
)
áá 
{
ââ 	
return
ãã 
;
ãã 
}
ää 	
if
ææ 

(
ææ 
string
ææ 
.
ææ 
IsNullOrEmpty
ææ  
(
ææ  !
e
ææ! "
.
ææ" #
Text
ææ# '
)
ææ' (
)
ææ( )
{
çç 	
return
èè 
;
èè 
}
éé 	
if
ëë 

(
ëë 
e
ëë 
.
ëë 
Text
ëë 
.
ëë 
Length
ëë 
>
ëë 
$num
ëë 
)
ëë 
{
ìì 	
e
íí 
.
íí 
Handled
íí 
=
íí 
true
íí 
;
íí (
CharacterRejectedEventArgs
îî &
multiCharArgs
îî' 4
=
îî5 6
new
ïï (
CharacterRejectedEventArgs
ïï .
(
ïï. /
$char
ïï/ 3
,
ïï3 4"
CharacterWarningType
ïï5 I
.
ïïI J 
MultipleCharacters
ïïJ \
,
ïï\ ]
e
ïï^ _
.
ïï_ `
Text
ïï` d
)
ïïd e
{
ðð 
RoutedEvent
ññ 
=
ññ  !$
CharacterRejectedEvent
ññ" 8
}
òò 
;
òò 

RaiseEvent
óó 
(
óó 
multiCharArgs
óó $
)
óó$ %
;
óó% &
StartWarningTimer
ôô 
(
ôô 
)
ôô 
;
ôô  
if
öö 
(
öö 
_mainTextBox
öö 
!=
öö 
null
öö  $
)
öö$ %
{
÷÷ 
_mainTextBox
øø 
.
øø 

CaretIndex
øø '
=
øø( )
_mainTextBox
øø* 6
.
øø6 7
Text
øø7 ;
?
øø; <
.
øø< =
Length
øø= C
??
øøD F
$num
øøG H
;
øøH I
}
ùù 
return
ûû 
;
ûû 
}
üü 	
char
þþ 
	inputChar
þþ 
=
þþ 
e
þþ 
.
þþ 
Text
þþ 
[
þþ  
$num
þþ  !
]
þþ! "
;
þþ" #
if
ÿÿ 

(
ÿÿ 
!
ÿÿ  
IsAllowedCharacter
ÿÿ 
(
ÿÿ  
	inputChar
ÿÿ  )
)
ÿÿ) *
)
ÿÿ* +
{
€€ 	
e
 
.
 
Handled
 
=
 
true
 
;
 "
CharacterWarningType
‚‚  
warningType
‚‚! ,
=
‚‚- .
GetWarningType
‚‚/ =
(
‚‚= >
	inputChar
‚‚> G
)
‚‚G H
;
‚‚H I(
CharacterRejectedEventArgs
ƒƒ &
args
ƒƒ' +
=
ƒƒ, -
new
ƒƒ. 1(
CharacterRejectedEventArgs
ƒƒ2 L
(
ƒƒL M
	inputChar
ƒƒM V
,
ƒƒV W
warningType
ƒƒX c
)
ƒƒc d
{
„„ 
RoutedEvent
…… 
=
…… $
CharacterRejectedEvent
…… 4
}
†† 
;
†† 

RaiseEvent
‡‡ 
(
‡‡ 
args
‡‡ 
)
‡‡ 
;
‡‡ 
StartWarningTimer
ˆˆ 
(
ˆˆ 
)
ˆˆ 
;
ˆˆ  
if
ŠŠ 
(
ŠŠ 
_mainTextBox
ŠŠ 
!=
ŠŠ 
null
ŠŠ  $
)
ŠŠ$ %
{
‹‹ 
_mainTextBox
ŒŒ 
.
ŒŒ 

CaretIndex
ŒŒ '
=
ŒŒ( )
_mainTextBox
ŒŒ* 6
.
ŒŒ6 7
Text
ŒŒ7 ;
?
ŒŒ; <
.
ŒŒ< =
Length
ŒŒ= C
??
ŒŒD F
$num
ŒŒG H
;
ŒŒH I
}
 
}
ŽŽ 	
if
 

(
 
_mainTextBox
 
!=
 
null
  
)
  !
{
‘‘ 	
int
’’ 
currentLength
’’ 
=
’’ 
_mainTextBox
’’  ,
.
’’, -
Text
’’- 1
?
’’1 2
.
’’2 3
Length
’’3 9
??
’’: <
$num
’’= >
;
’’> ?
_mainTextBox
““ 
.
““ 

CaretIndex
““ #
=
““$ %
currentLength
““& 3
;
““3 4
}
”” 	
}
•• 
private
—— 
void
—— 
StartWarningTimer
—— "
(
——" #
)
——# $
{
˜˜ 
if
™™ 

(
™™ 
_warningTimer
™™ 
==
™™ 
null
™™ !
)
™™! "
{
šš 	
_warningTimer
›› 
=
›› 
new
›› 
DispatcherTimer
››  /
{
››0 1
Interval
››2 :
=
››; <
TimeSpan
››= E
.
››E F
FromMilliseconds
››F V
(
››V W&
WarningDisplayDurationMs
››W o
)
››o p
}
››q r
;
››r s
_warningTimer
œœ 
.
œœ 
Tick
œœ 
+=
œœ ! 
OnWarningTimerTick
œœ" 4
;
œœ4 5
}
 	
else
žž 
{
ŸŸ 	
_warningTimer
   
.
   
Interval
   "
=
  # $
TimeSpan
  % -
.
  - .
FromMilliseconds
  . >
(
  > ?&
WarningDisplayDurationMs
  ? W
)
  W X
;
  X Y
}
¡¡ 	
_warningTimer
££ 
.
££ 
Stop
££ 
(
££ 
)
££ 
;
££ 
_warningTimer
¤¤ 
.
¤¤ 
Start
¤¤ 
(
¤¤ 
)
¤¤ 
;
¤¤ 
}
¥¥ 
private
§§ 
void
§§  
OnWarningTimerTick
§§ #
(
§§# $
object
§§$ *
?
§§* +
sender
§§, 2
,
§§2 3
System
§§4 :
.
§§: ;
	EventArgs
§§; D
e
§§E F
)
§§F G
{
¨¨ 

HasWarning
©© 
=
©© 
false
©© 
;
©© 
_warningTimer
ªª 
?
ªª 
.
ªª 
Stop
ªª 
(
ªª 
)
ªª 
;
ªª 
}
«« 
private
­­ 
void
­­ 
OnPreviewKeyDown
­­ !
(
­­! "
object
­­" (
?
­­( )
sender
­­* 0
,
­­0 1
KeyEventArgs
­­2 >
e
­­? @
)
­­@ A
{
®® 
if
¯¯ 

(
¯¯ 
!
¯¯ 
IsSecureKeyMode
¯¯ 
)
¯¯ 
{
°° 	
return
±± 
;
±± 
}
²² 	
if
´´ 

(
´´ &
HandleClipboardShortcuts
´´ $
(
´´$ %
e
´´% &
)
´´& '
)
´´' (
{
µµ 	
return
¶¶ 
;
¶¶ 
}
·· 	
if
¹¹ 

(
¹¹ "
HandleNavigationKeys
¹¹  
(
¹¹  !
e
¹¹! "
)
¹¹" #
)
¹¹# $
{
ºº 	
return
»» 
;
»» 
}
¼¼ 	
if
¾¾ 

(
¾¾  
HandleBackspaceKey
¾¾ 
(
¾¾ 
e
¾¾  
)
¾¾  !
)
¾¾! "
{
¿¿ 	
return
ÀÀ 
;
ÀÀ 
}
ÁÁ 	
if
ÃÃ 

(
ÃÃ 
HandleDeleteKey
ÃÃ 
(
ÃÃ 
e
ÃÃ 
)
ÃÃ 
)
ÃÃ 
{
ÄÄ 	
return
ÅÅ 
;
ÅÅ 
}
ÆÆ 	
ResetCaretToEnd
ÈÈ 
(
ÈÈ 
)
ÈÈ 
;
ÈÈ 
}
ÉÉ 
private
ËË 
static
ËË 
bool
ËË &
HandleClipboardShortcuts
ËË 0
(
ËË0 1
KeyEventArgs
ËË1 =
e
ËË> ?
)
ËË? @
{
ÌÌ 
if
ÍÍ 

(
ÍÍ 
(
ÍÍ 
e
ÍÍ 
.
ÍÍ 
KeyModifiers
ÍÍ 
.
ÍÍ 
HasFlag
ÍÍ #
(
ÍÍ# $
KeyModifiers
ÍÍ$ 0
.
ÍÍ0 1
Control
ÍÍ1 8
)
ÍÍ8 9
||
ÍÍ: <
e
ÍÍ= >
.
ÍÍ> ?
KeyModifiers
ÍÍ? K
.
ÍÍK L
HasFlag
ÍÍL S
(
ÍÍS T
KeyModifiers
ÍÍT `
.
ÍÍ` a
Meta
ÍÍa e
)
ÍÍe f
)
ÍÍf g
&&
ÍÍh j
IsClipboardKey
ÎÎ 
(
ÎÎ 
e
ÎÎ 
.
ÎÎ 
Key
ÎÎ  
)
ÎÎ  !
)
ÎÎ! "
{
ÏÏ 	
e
ÐÐ 
.
ÐÐ 
Handled
ÐÐ 
=
ÐÐ 
true
ÐÐ 
;
ÐÐ 
return
ÑÑ 
true
ÑÑ 
;
ÑÑ 
}
ÒÒ 	
if
ÔÔ 

(
ÔÔ 
e
ÔÔ 
.
ÔÔ 
Key
ÔÔ 
==
ÔÔ 
Key
ÔÔ 
.
ÔÔ 
Insert
ÔÔ 
&&
ÔÔ  "
(
ÕÕ 
e
ÕÕ 
.
ÕÕ 
KeyModifiers
ÕÕ 
.
ÕÕ 
HasFlag
ÕÕ #
(
ÕÕ# $
KeyModifiers
ÕÕ$ 0
.
ÕÕ0 1
Shift
ÕÕ1 6
)
ÕÕ6 7
||
ÕÕ8 :
e
ÕÕ; <
.
ÕÕ< =
KeyModifiers
ÕÕ= I
.
ÕÕI J
HasFlag
ÕÕJ Q
(
ÕÕQ R
KeyModifiers
ÕÕR ^
.
ÕÕ^ _
Control
ÕÕ_ f
)
ÕÕf g
)
ÕÕg h
)
ÕÕh i
{
ÖÖ 	
e
×× 
.
×× 
Handled
×× 
=
×× 
true
×× 
;
×× 
return
ØØ 
true
ØØ 
;
ØØ 
}
ÙÙ 	
return
ÛÛ 
false
ÛÛ 
;
ÛÛ 
}
ÜÜ 
private
ÞÞ 
static
ÞÞ 
bool
ÞÞ 
IsClipboardKey
ÞÞ &
(
ÞÞ& '
Key
ÞÞ' *
key
ÞÞ+ .
)
ÞÞ. /
=>
ÞÞ0 2
key
ÞÞ3 6
is
ÞÞ7 9
Key
ÞÞ: =
.
ÞÞ= >
V
ÞÞ> ?
or
ÞÞ@ B
Key
ÞÞC F
.
ÞÞF G
C
ÞÞG H
or
ÞÞI K
Key
ÞÞL O
.
ÞÞO P
X
ÞÞP Q
or
ÞÞR T
Key
ÞÞU X
.
ÞÞX Y
Z
ÞÞY Z
or
ÞÞ[ ]
Key
ÞÞ^ a
.
ÞÞa b
Y
ÞÞb c
;
ÞÞc d
private
àà 
bool
àà "
HandleNavigationKeys
àà %
(
àà% &
KeyEventArgs
àà& 2
e
àà3 4
)
àà4 5
{
áá 
if
ââ 

(
ââ 
_mainTextBox
ââ 
==
ââ 
null
ââ  
)
ââ  !
{
ãã 	
return
ää 
false
ää 
;
ää 
}
åå 	
return
çç 
e
çç 
.
çç 
Key
çç 
switch
çç 
{
èè 	
Key
éé 
.
éé 
Back
éé 
or
éé 
Key
éé 
.
éé 
Delete
éé "
or
éé# %
Key
éé& )
.
éé) *
End
éé* -
or
éé. 0
Key
éé1 4
.
éé4 5
Home
éé5 9
=>
éé: <
false
éé= B
,
ééB C
Key
êê 
.
êê 
Left
êê 
or
êê 
Key
êê 
.
êê 
Right
êê !
or
êê" $
Key
êê% (
.
êê( )
Up
êê) +
or
êê, .
Key
êê/ 2
.
êê2 3
Down
êê3 7
=>
êê8 :
HandleArrowKey
êê; I
(
êêI J
e
êêJ K
)
êêK L
,
êêL M
_
ëë 
=>
ëë 
false
ëë 
}
ìì 	
;
ìì	 

}
íí 
private
ïï 
static
ïï 
bool
ïï 
HandleArrowKey
ïï &
(
ïï& '
KeyEventArgs
ïï' 3
e
ïï4 5
)
ïï5 6
{
ðð 
e
ññ 	
.
ññ	 

Handled
ññ
 
=
ññ 
true
ññ 
;
ññ 
return
òò 
true
òò 
;
òò 
}
óó 
private
õõ 
bool
õõ  
HandleBackspaceKey
õõ #
(
õõ# $
KeyEventArgs
õõ$ 0
e
õõ1 2
)
õõ2 3
{
öö 
if
÷÷ 

(
÷÷ 
e
÷÷ 
.
÷÷ 
Key
÷÷ 
!=
÷÷ 
Key
÷÷ 
.
÷÷ 
Back
÷÷ 
)
÷÷ 
{
øø 	
return
ùù 
false
ùù 
;
ùù 
}
úú 	
e
üü 	
.
üü	 

Handled
üü
 
=
üü 
true
üü 
;
üü !
RemoveLastCharacter
ýý 
(
ýý 
)
ýý 
;
ýý 
return
þþ 
true
þþ 
;
þþ 
}
ÿÿ 
private
 
bool
 
HandleDeleteKey
  
(
  !
KeyEventArgs
! -
e
. /
)
/ 0
{
‚‚ 
if
ƒƒ 

(
ƒƒ 
e
ƒƒ 
.
ƒƒ 
Key
ƒƒ 
!=
ƒƒ 
Key
ƒƒ 
.
ƒƒ 
Delete
ƒƒ 
)
ƒƒ  
{
„„ 	
return
…… 
false
…… 
;
…… 
}
†† 	
e
ˆˆ 	
.
ˆˆ	 

Handled
ˆˆ
 
=
ˆˆ 
true
ˆˆ 
;
ˆˆ !
RemoveLastCharacter
‰‰ 
(
‰‰ 
)
‰‰ 
;
‰‰ 
return
ŠŠ 
true
ŠŠ 
;
ŠŠ 
}
‹‹ 
private
 
void
 !
RemoveLastCharacter
 $
(
$ %
)
% &
{
ŽŽ 
if
 

(
 
_mainTextBox
 
==
 
null
  
||
! #
string
$ *
.
* +
IsNullOrEmpty
+ 8
(
8 9
_mainTextBox
9 E
.
E F
Text
F J
)
J K
)
K L
{
 	
return
‘‘ 
;
‘‘ 
}
’’ 	
string
”” 
currentText
”” 
=
”” 
_mainTextBox
”” )
.
””) *
Text
””* .
;
””. /
string
•• 
newText
•• 
=
•• 
currentText
•• $
.
••$ %
Length
••% +
>
••, -
$num
••. /
?
••0 1
currentText
••2 =
.
••= >
	Substring
••> G
(
••G H
$num
••H I
,
••I J
currentText
••K V
.
••V W
Length
••W ]
-
••^ _
$num
••` a
)
••a b
:
••c d
string
••e k
.
••k l
Empty
••l q
;
••q r!
_isUpdatingFromCode
—— 
=
—— 
true
—— "
;
——" #
_mainTextBox
˜˜ 
.
˜˜ 
Text
˜˜ 
=
˜˜ 
newText
˜˜ #
;
˜˜# $
_mainTextBox
™™ 
.
™™ 

CaretIndex
™™ 
=
™™  !
newText
™™" )
.
™™) *
Length
™™* 0
;
™™0 1!
_isUpdatingFromCode
šš 
=
šš 
false
šš #
;
šš# $$
_intendedCaretPosition
œœ 
=
œœ  
newText
œœ! (
.
œœ( )
Length
œœ) /
;
œœ/ 0
}
 
private
ŸŸ 
void
ŸŸ 
ResetCaretToEnd
ŸŸ  
(
ŸŸ  !
)
ŸŸ! "
{
   
if
¡¡ 

(
¡¡ 
_mainTextBox
¡¡ 
!=
¡¡ 
null
¡¡  
)
¡¡  !
{
¢¢ 	
_mainTextBox
££ 
.
££ 

CaretIndex
££ #
=
££$ %
_mainTextBox
££& 2
.
££2 3
Text
££3 7
?
££7 8
.
££8 9
Length
££9 ?
??
££@ B
$num
££C D
;
££D E
}
¤¤ 	
}
¥¥ 
private
§§ 
void
§§ 
OnTextChanged
§§ 
(
§§ 
object
§§ %
?
§§% &
sender
§§' -
,
§§- ."
TextChangedEventArgs
§§/ C
e
§§D E
)
§§E F
{
¨¨ 
if
©© 

(
©© !
_isUpdatingFromCode
©© 
||
©©  "
_mainTextBox
©©# /
==
©©0 2
null
©©3 7
||
©©8 :
_isDisposed
©©; F
)
©©F G
{
ªª 	
return
«« 
;
«« 
}
¬¬ 	
if
®® 

(
®® 
IsSecureKeyMode
®® 
)
®® 
{
¯¯ 	-
DebouncedProcessSecureKeyChange
°° +
(
°°+ ,
)
°°, -
;
°°- .
}
±± 	
else
²² 
{
³³ 	(
DebouncedProcessTextChange
´´ &
(
´´& '
)
´´' (
;
´´( )
}
µµ 	
}
¶¶ 
private
¸¸ 
void
¸¸ (
DebouncedProcessTextChange
¸¸ +
(
¸¸+ ,
)
¸¸, -
{
¹¹ 
if
ºº 

(
ºº !
_inputDebounceTimer
ºº 
!=
ºº  "
null
ºº# '
)
ºº' (
{
»» 	!
_inputDebounceTimer
¼¼ 
.
¼¼  
Stop
¼¼  $
(
¼¼$ %
)
¼¼% &
;
¼¼& '
}
½½ 	
if
¿¿ 

(
¿¿ !
_inputDebounceTimer
¿¿ 
==
¿¿  "
null
¿¿# '
)
¿¿' (
{
ÀÀ 	!
_inputDebounceTimer
ÁÁ 
=
ÁÁ  !
new
ÁÁ" %
DispatcherTimer
ÁÁ& 5
{
ÁÁ6 7
Interval
ÁÁ8 @
=
ÁÁA B
TimeSpan
ÁÁC K
.
ÁÁK L
FromMilliseconds
ÁÁL \
(
ÁÁ\ ]%
INPUT_DEBOUNCE_DELAY_MS
ÁÁ] t
)
ÁÁt u
}
ÁÁv w
;
ÁÁw x!
_inputDebounceTimer
ÂÂ 
.
ÂÂ  
Tick
ÂÂ  $
+=
ÂÂ% '!
OnDebounceTimerTick
ÂÂ( ;
;
ÂÂ; <
}
ÃÃ 	!
_inputDebounceTimer
ÅÅ 
.
ÅÅ 
Start
ÅÅ !
(
ÅÅ! "
)
ÅÅ" #
;
ÅÅ# $
}
ÆÆ 
private
ÈÈ 
void
ÈÈ -
DebouncedProcessSecureKeyChange
ÈÈ 0
(
ÈÈ0 1
)
ÈÈ1 2
{
ÉÉ %
_secureKeyDebounceTimer
ÊÊ 
?
ÊÊ  
.
ÊÊ  !
Stop
ÊÊ! %
(
ÊÊ% &
)
ÊÊ& '
;
ÊÊ' (
if
ÌÌ 

(
ÌÌ %
_secureKeyDebounceTimer
ÌÌ #
==
ÌÌ$ &
null
ÌÌ' +
)
ÌÌ+ ,
{
ÍÍ 	%
_secureKeyDebounceTimer
ÎÎ #
=
ÎÎ$ %
new
ÎÎ& )
DispatcherTimer
ÎÎ* 9
{
ÏÏ 
Interval
ÐÐ 
=
ÐÐ 
TimeSpan
ÐÐ #
.
ÐÐ# $
FromMilliseconds
ÐÐ$ 4
(
ÐÐ4 5*
SECURE_KEY_DEBOUNCE_DELAY_MS
ÐÐ5 Q
)
ÐÐQ R
}
ÑÑ 
;
ÑÑ %
_secureKeyDebounceTimer
ÒÒ #
.
ÒÒ# $
Tick
ÒÒ$ (
+=
ÒÒ) +*
OnSecureKeyDebounceTimerTick
ÒÒ, H
;
ÒÒH I
}
ÓÓ 	%
_secureKeyDebounceTimer
ÕÕ 
.
ÕÕ  
Start
ÕÕ  %
(
ÕÕ% &
)
ÕÕ& '
;
ÕÕ' (
}
ÖÖ 
private
ØØ 
void
ØØ *
OnSecureKeyDebounceTimerTick
ØØ -
(
ØØ- .
object
ØØ. 4
?
ØØ4 5
sender
ØØ6 <
,
ØØ< =
System
ØØ> D
.
ØØD E
	EventArgs
ØØE N
e
ØØO P
)
ØØP Q
{
ÙÙ %
_secureKeyDebounceTimer
ÚÚ 
?
ÚÚ  
.
ÚÚ  !
Stop
ÚÚ! %
(
ÚÚ% &
)
ÚÚ& '
;
ÚÚ' (
if
ÜÜ 

(
ÜÜ 
!
ÜÜ 
_isDisposed
ÜÜ 
)
ÜÜ 
{
ÝÝ 	$
ProcessSecureKeyChange
ÞÞ "
(
ÞÞ" #
)
ÞÞ# $
;
ÞÞ$ %
}
ßß 	
}
àà 
private
ââ 
void
ââ !
OnDebounceTimerTick
ââ $
(
ââ$ %
object
ââ% +
?
ââ+ ,
sender
ââ- 3
,
ââ3 4
System
ââ5 ;
.
ââ; <
	EventArgs
ââ< E
e
ââF G
)
ââG H
{
ãã !
_inputDebounceTimer
ää 
?
ää 
.
ää 
Stop
ää !
(
ää! "
)
ää" #
;
ää# $
if
ææ 

(
ææ 
!
ææ 
_isDisposed
ææ 
)
ææ 
{
çç 	
ProcessTextChange
èè 
(
èè 
)
èè 
;
èè  
}
éé 	
}
êê 
private
ìì 
void
ìì $
ProcessSecureKeyChange
ìì '
(
ìì' (
)
ìì( )
{
íí 
if
îî 

(
îî !
_isUpdatingFromCode
îî 
||
îî  "
_mainTextBox
îî# /
==
îî0 2
null
îî3 7
||
îî8 :
_isDisposed
îî; F
||
îîG I*
_isProcessingSecureKeyChange
îîJ f
)
îîf g
{
ïï 	
return
ðð 
;
ðð 
}
ññ 	*
_isProcessingSecureKeyChange
óó $
=
óó% &
true
óó' +
;
óó+ ,
try
ôô 
{
õõ 	
string
öö 
currentText
öö 
=
öö  
_mainTextBox
öö! -
.
öö- .
Text
öö. 2
??
öö3 5
string
öö6 <
.
öö< =
Empty
öö= B
;
ööB C
string
÷÷ 
lastText
÷÷ 
=
÷÷  
_lastProcessedText
÷÷ 0
;
÷÷0 1
if
ùù 
(
ùù 
currentText
ùù 
==
ùù 
lastText
ùù '
)
ùù' (
{
úú 
return
ûû 
;
ûû 
}
üü #
ProcessTextDifference
þþ !
(
þþ! "
currentText
þþ" -
,
þþ- .
lastText
þþ/ 7
)
þþ7 8
;
þþ8 9 
_lastProcessedText
€	€	 
=
€	€	  
currentText
€	€	! ,
;
€	€	, -,
_lastProcessedTextElementCount
		 *
=
		+ ,!
GetTextElementCount
		- @
(
		@ A
currentText
		A L
)
		L M
;
		M N'
UpdateRemainingCharacters
‚	‚	 %
(
‚	‚	% &
)
‚	‚	& '
;
‚	‚	' (
}
ƒ	ƒ	 	
finally
„	„	 
{
…	…	 	 
ResetCaretPosition
†	†	 
(
†	†	 
)
†	†	  
;
†	†	  !*
_isProcessingSecureKeyChange
‡	‡	 (
=
‡	‡	) *
false
‡	‡	+ 0
;
‡	‡	0 1
}
ˆ	ˆ	 	
}
‰	‰	 
private
‹	‹	 
void
‹	‹	 #
ProcessTextDifference
‹	‹	 &
(
‹	‹	& '
string
‹	‹	' -
currentText
‹	‹	. 9
,
‹	‹	9 :
string
‹	‹	; A
lastText
‹	‹	B J
)
‹	‹	J K
{
Œ	Œ	 
try
		 
{
Ž	Ž	 	-
ProcessTextDifferenceByElements
		 +
(
		+ ,
currentText
		, 7
,
		7 8
lastText
		9 A
)
		A B
;
		B C
}
		 	
catch
‘	‘	 
{
’	’	 	+
ProcessTextDifferenceByLength
“	“	 )
(
“	“	) *
currentText
“	“	* 5
,
“	“	5 6
lastText
“	“	7 ?
)
“	“	? @
;
“	“	@ A
}
”	”	 	
}
•	•	 
private
—	—	 
void
—	—	 -
ProcessTextDifferenceByElements
—	—	 0
(
—	—	0 1
string
—	—	1 7
currentText
—	—	8 C
,
—	—	C D
string
—	—	E K
lastText
—	—	L T
)
—	—	T U
{
˜	˜	 
int
™	™	 !
currentElementCount
™	™	 
=
™	™	  !!
GetTextElementCount
™	™	" 5
(
™	™	5 6
currentText
™	™	6 A
)
™	™	A B
;
™	™	B C
int
š	š	 
lastElementCount
š	š	 
=
š	š	 ,
_lastProcessedTextElementCount
š	š	 =
>
š	š	> ?
$num
š	š	@ A
?
›	›	 ,
_lastProcessedTextElementCount
›	›	 ,
:
œ	œ	 !
GetTextElementCount
œ	œ	 !
(
œ	œ	! "
lastText
œ	œ	" *
)
œ	œ	* +
;
œ	œ	+ ,
if
ž	ž	 

(
ž	ž	 !
currentElementCount
ž	ž	 
>
ž	ž	  !
lastElementCount
ž	ž	" 2
)
ž	ž	2 3
{
Ÿ	Ÿ	 	#
HandleCharactersAdded
 	 	 !
(
 	 	! "
currentText
 	 	" -
,
 	 	- .
lastText
 	 	/ 7
,
 	 	7 8!
currentElementCount
 	 	9 L
,
 	 	L M
lastElementCount
 	 	N ^
)
 	 	^ _
;
 	 	_ `
}
¡	¡	 	
else
¢	¢	 
if
¢	¢	 
(
¢	¢	 !
currentElementCount
¢	¢	 $
<
¢	¢	% &
lastElementCount
¢	¢	' 7
)
¢	¢	7 8
{
£	£	 	%
HandleCharactersRemoved
¤	¤	 #
(
¤	¤	# $!
currentElementCount
¤	¤	$ 7
,
¤	¤	7 8
lastElementCount
¤	¤	9 I
)
¤	¤	I J
;
¤	¤	J K
}
¥	¥	 	
}
¦	¦	 
private
¨	¨	 
void
¨	¨	 +
ProcessTextDifferenceByLength
¨	¨	 .
(
¨	¨	. /
string
¨	¨	/ 5
currentText
¨	¨	6 A
,
¨	¨	A B
string
¨	¨	C I
lastText
¨	¨	J R
)
¨	¨	R S
{
©	©	 
if
ª	ª	 

(
ª	ª	 
currentText
ª	ª	 
.
ª	ª	 
Length
ª	ª	 
>
ª	ª	  
lastText
ª	ª	! )
.
ª	ª	) *
Length
ª	ª	* 0
)
ª	ª	0 1
{
«	«	 	
int
¬	¬	 

addedCount
¬	¬	 
=
¬	¬	 
currentText
¬	¬	 (
.
¬	¬	( )
Length
¬	¬	) /
-
¬	¬	0 1
lastText
¬	¬	2 :
.
¬	¬	: ;
Length
¬	¬	; A
;
¬	¬	A B
int
­	­	 
	insertPos
­	­	 
=
­	­	 
Math
­	­	  
.
­	­	  !
Max
­	­	! $
(
­	­	$ %$
HintedTextBoxConstants
­	­	% ;
.
­	­	; <!
INITIAL_CARET_INDEX
­	­	< O
,
­	­	O P
_mainTextBox
­	­	Q ]
!
­	­	] ^
.
­	­	^ _

CaretIndex
­	­	_ i
-
­	­	j k

addedCount
­	­	l v
)
­	­	v w
;
­	­	w x
string
®	®	 

addedChars
®	®	 
=
®	®	 
SafeSubstring
®	®	  -
(
®	®	- .
currentText
®	®	. 9
,
®	®	9 :
	insertPos
®	®	; D
,
®	®	D E

addedCount
®	®	F P
)
®	®	P Q
;
®	®	Q R$
_intendedCaretPosition
°	°	 "
=
°	°	# $
	insertPos
°	°	% .
+
°	°	/ 0

addedCount
°	°	1 ;
;
°	°	; <
if
²	²	 
(
²	²	 
string
²	²	 
.
²	²	 
IsNullOrEmpty
²	²	 $
(
²	²	$ %

addedChars
²	²	% /
)
²	²	/ 0
)
²	²	0 1
{
³	³	 
return
´	´	 
;
´	´	 
}
µ	µ	 

RaiseEvent
·	·	 
(
·	·	 
new
·	·	 /
!SecureKeyCharactersAddedEventArgs
·	·	 <
(
·	·	< =+
SecureKeyCharactersAddedEvent
·	·	= Z
,
·	·	Z [
	insertPos
·	·	\ e
,
·	·	e f

addedChars
·	·	g q
)
·	·	q r
)
·	·	r s
;
·	·	s t$
TriggerTypingAnimation
¸	¸	 "
(
¸	¸	" #
)
¸	¸	# $
;
¸	¸	$ %
}
¹	¹	 	
else
º	º	 
if
º	º	 
(
º	º	 
currentText
º	º	 
.
º	º	 
Length
º	º	 #
<
º	º	$ %
lastText
º	º	& .
.
º	º	. /
Length
º	º	/ 5
)
º	º	5 6
{
»	»	 	
int
¼	¼	 
removedCount
¼	¼	 
=
¼	¼	 
lastText
¼	¼	 '
.
¼	¼	' (
Length
¼	¼	( .
-
¼	¼	/ 0
currentText
¼	¼	1 <
.
¼	¼	< =
Length
¼	¼	= C
;
¼	¼	C D
int
½	½	 
	removePos
½	½	 
=
½	½	 
_mainTextBox
½	½	 (
!
½	½	( )
.
½	½	) *

CaretIndex
½	½	* 4
;
½	½	4 5$
_intendedCaretPosition
¿	¿	 "
=
¿	¿	# $
	removePos
¿	¿	% .
;
¿	¿	. /

RaiseEvent
Á	Á	 
(
Á	Á	 
new
Â	Â	 1
#SecureKeyCharactersRemovedEventArgs
Â	Â	 7
(
Â	Â	7 8-
SecureKeyCharactersRemovedEvent
Â	Â	8 W
,
Â	Â	W X
	removePos
Â	Â	Y b
,
Â	Â	b c
removedCount
Â	Â	d p
)
Â	Â	p q
)
Â	Â	q r
;
Â	Â	r s
}
Ã	Ã	 	
}
Ä	Ä	 
private
Æ	Æ	 
void
Æ	Æ	 #
HandleCharactersAdded
Æ	Æ	 &
(
Æ	Æ	& '
string
Æ	Æ	' -
currentText
Æ	Æ	. 9
,
Æ	Æ	9 :
string
Æ	Æ	; A
lastText
Æ	Æ	B J
,
Æ	Æ	J K
int
Æ	Æ	L O!
currentElementCount
Æ	Æ	P c
,
Æ	Æ	c d
int
Ç	Ç	 
lastElementCount
Ç	Ç	 
)
Ç	Ç	 
{
È	È	 
int
É	É	 

addedCount
É	É	 
=
É	É	 !
currentElementCount
É	É	 ,
-
É	É	- .
lastElementCount
É	É	/ ?
;
É	É	? @
string
Ê	Ê	 

addedChars
Ê	Ê	 
=
Ê	Ê	 "
GetAddedTextElements
Ê	Ê	 0
(
Ê	Ê	0 1
currentText
Ê	Ê	1 <
,
Ê	Ê	< =
lastText
Ê	Ê	> F
,
Ê	Ê	F G
_mainTextBox
Ê	Ê	H T
!
Ê	Ê	T U
.
Ê	Ê	U V

CaretIndex
Ê	Ê	V `
)
Ê	Ê	` a
;
Ê	Ê	a b
int
Ì	Ì	 
	insertPos
Ì	Ì	 
=
Ì	Ì	 
Math
Ì	Ì	 
.
Ì	Ì	 
Max
Ì	Ì	  
(
Ì	Ì	  !$
HintedTextBoxConstants
Ì	Ì	! 7
.
Ì	Ì	7 8!
INITIAL_CARET_INDEX
Ì	Ì	8 K
,
Ì	Ì	K L
_mainTextBox
Ì	Ì	M Y
.
Ì	Ì	Y Z

CaretIndex
Ì	Ì	Z d
-
Ì	Ì	e f

addedCount
Ì	Ì	g q
)
Ì	Ì	q r
;
Ì	Ì	r s$
_intendedCaretPosition
Î	Î	 
=
Î	Î	  
	insertPos
Î	Î	! *
+
Î	Î	+ ,

addedCount
Î	Î	- 7
;
Î	Î	7 8
if
Ð	Ð	 

(
Ð	Ð	 
string
Ð	Ð	 
.
Ð	Ð	 
IsNullOrEmpty
Ð	Ð	  
(
Ð	Ð	  !

addedChars
Ð	Ð	! +
)
Ð	Ð	+ ,
)
Ð	Ð	, -
{
Ñ	Ñ	 	
return
Ò	Ò	 
;
Ò	Ò	 
}
Ó	Ó	 	

RaiseEvent
Õ	Õ	 
(
Õ	Õ	 
new
Õ	Õ	 /
!SecureKeyCharactersAddedEventArgs
Õ	Õ	 8
(
Õ	Õ	8 9+
SecureKeyCharactersAddedEvent
Õ	Õ	9 V
,
Õ	Õ	V W
	insertPos
Õ	Õ	X a
,
Õ	Õ	a b

addedChars
Õ	Õ	c m
)
Õ	Õ	m n
)
Õ	Õ	n o
;
Õ	Õ	o p$
TriggerTypingAnimation
Ö	Ö	 
(
Ö	Ö	 
)
Ö	Ö	  
;
Ö	Ö	  !
}
×	×	 
private
Ù	Ù	 
void
Ù	Ù	 %
HandleCharactersRemoved
Ù	Ù	 (
(
Ù	Ù	( )
int
Ù	Ù	) ,!
currentElementCount
Ù	Ù	- @
,
Ù	Ù	@ A
int
Ù	Ù	B E
lastElementCount
Ù	Ù	F V
)
Ù	Ù	V W
{
Ú	Ú	 
int
Û	Û	 
removedCount
Û	Û	 
=
Û	Û	 
lastElementCount
Û	Û	 +
-
Û	Û	, -!
currentElementCount
Û	Û	. A
;
Û	Û	A B$
_intendedCaretPosition
Ý	Ý	 
=
Ý	Ý	  !
currentElementCount
Ý	Ý	! 4
;
Ý	Ý	4 5

RaiseEvent
ß	ß	 
(
ß	ß	 
new
ß	ß	 1
#SecureKeyCharactersRemovedEventArgs
ß	ß	 :
(
ß	ß	: ;-
SecureKeyCharactersRemovedEvent
ß	ß	; Z
,
ß	ß	Z [!
currentElementCount
ß	ß	\ o
,
ß	ß	o p
removedCount
à	à	 
)
à	à	 
)
à	à	 
;
à	à	 
}
á	á	 
private
ã	ã	 
void
ã	ã	  
ResetCaretPosition
ã	ã	 #
(
ã	ã	# $
)
ã	ã	$ %
{
ä	ä	 

Dispatcher
å	å	 
.
å	å	 
UIThread
å	å	 
.
å	å	 
Post
å	å	  
(
å	å	  !
(
å	å	! "
)
å	å	" #
=>
å	å	$ &
{
æ	æ	 	
if
ç	ç	 
(
ç	ç	 
_mainTextBox
ç	ç	 
!=
ç	ç	 
null
ç	ç	  $
&&
ç	ç	% '
!
ç	ç	( )
_isDisposed
ç	ç	) 4
)
ç	ç	4 5
{
è	è	 
int
é	é	 

textLength
é	é	 
=
é	é	  
_mainTextBox
é	é	! -
.
é	é	- .
Text
é	é	. 2
?
é	é	2 3
.
é	é	3 4
Length
é	é	4 :
??
é	é	; =
$num
é	é	> ?
;
é	é	? @
if
ê	ê	 
(
ê	ê	 
_mainTextBox
ê	ê	  
.
ê	ê	  !

CaretIndex
ê	ê	! +
!=
ê	ê	, .

textLength
ê	ê	/ 9
)
ê	ê	9 :
{
ë	ë	 
_mainTextBox
ì	ì	  
.
ì	ì	  !

CaretIndex
ì	ì	! +
=
ì	ì	, -

textLength
ì	ì	. 8
;
ì	ì	8 9
}
í	í	 
}
î	î	 
}
ï	ï	 	
)
ï	ï		 

;
ï	ï	
 
}
ð	ð	 
private
ò	ò	 
void
ò	ò	 
ProcessTextChange
ò	ò	 "
(
ò	ò	" #
)
ò	ò	# $
{
ó	ó	 
if
ô	ô	 

(
ô	ô	 !
_isUpdatingFromCode
ô	ô	 
||
ô	ô	  "
_mainTextBox
ô	ô	# /
==
ô	ô	0 2
null
ô	ô	3 7
||
ô	ô	8 :
_isDisposed
ô	ô	; F
)
ô	ô	F G
{
õ	õ	 	
return
ö	ö	 
;
ö	ö	 
}
÷	÷	 	#
ProcessStandardChange
ù	ù	 
(
ù	ù	 
)
ù	ù	 
;
ù	ù	  
}
ú	ú	 
private
ü	ü	 
void
ü	ü	 #
ProcessStandardChange
ü	ü	 &
(
ü	ü	& '
)
ü	ü	' (
{
ý	ý	 
string
þ	þ	 
input
þ	þ	 
=
þ	þ	 
_mainTextBox
þ	þ	 #
!
þ	þ	# $
.
þ	þ	$ %
Text
þ	þ	% )
??
þ	þ	* ,
string
þ	þ	- 3
.
þ	þ	3 4
Empty
þ	þ	4 9
;
þ	þ	9 :
if
€
€
 

(
€
€
 
IsNumericOnly
€
€
 
)
€
€
 
{


 	
string
‚
‚
 
filtered
‚
‚
 
=
‚
‚
 
string
‚
‚
 $
.
‚
‚
$ %
Concat
‚
‚
% +
(
‚
‚
+ ,
input
‚
‚
, 1
.
‚
‚
1 2
Where
‚
‚
2 7
(
‚
‚
7 8
char
‚
‚
8 <
.
‚
‚
< =
IsDigit
‚
‚
= D
)
‚
‚
D E
)
‚
‚
E F
;
‚
‚
F G
if
ƒ
ƒ
 
(
ƒ
ƒ
 
input
ƒ
ƒ
 
!=
ƒ
ƒ
 
filtered
ƒ
ƒ
 !
)
ƒ
ƒ
! "
{
„
„
 
int
…
…
 
inputElementCount
…
…
 %
=
…
…
& '!
GetTextElementCount
…
…
( ;
(
…
…
; <
input
…
…
< A
)
…
…
A B
;
…
…
B C
int
†
†
 "
filteredElementCount
†
†
 (
=
†
†
) *!
GetTextElementCount
†
†
+ >
(
†
†
> ?
filtered
†
†
? G
)
†
†
G H
;
†
†
H I
int
‡
‡
 
caret
‡
‡
 
=
‡
‡
 
_mainTextBox
‡
‡
 (
.
‡
‡
( )

CaretIndex
‡
‡
) 3
-
‡
‡
4 5
(
‡
‡
6 7
inputElementCount
‡
‡
7 H
-
‡
‡
I J"
filteredElementCount
‡
‡
K _
)
‡
‡
_ `
;
‡
‡
` a
UpdateTextBox
ˆ
ˆ
 
(
ˆ
ˆ
 
filtered
ˆ
ˆ
 &
,
ˆ
ˆ
& '
Math
ˆ
ˆ
( ,
.
ˆ
ˆ
, -
Max
ˆ
ˆ
- 0
(
ˆ
ˆ
0 1
$num
ˆ
ˆ
1 2
,
ˆ
ˆ
2 3
caret
ˆ
ˆ
4 9
)
ˆ
ˆ
9 :
)
ˆ
ˆ
: ;
;
ˆ
ˆ
; <
return
‰
‰
 
;
‰
‰
 
}
Š
Š
 
}
‹
‹
 	
Text


 
=


 
input


 
;


 '
UpdateRemainingCharacters
Ž
Ž
 !
(
Ž
Ž
! "
)
Ž
Ž
" #
;
Ž
Ž
# $
if


 

(


 
!


 
IsSecureKeyMode


 
&&


 !
GetTextElementCount


  3
(


3 4
input


4 9
)


9 :
>


; <!
GetTextElementCount


= P
(


P Q
Text


Q U
)


U V
-


W X$
HintedTextBoxConstants
‘
‘
 "
.
‘
‘
" #(
TYPING_ANIMATION_THRESHOLD
‘
‘
# =
)
‘
‘
= >
{
’
’
 	$
TriggerTypingAnimation
“
“
 "
(
“
“
" #
)
“
“
# $
;
“
“
$ %
}
”
”
 	
}
•
•
 
private
—
—
 
void
—
—
 
UpdateTextBox
—
—
 
(
—
—
 
string
—
—
 %
?
—
—
% &
text
—
—
' +
,
—
—
+ ,
int
—
—
- 0

caretIndex
—
—
1 ;
)
—
—
; <
{
˜
˜
 
if
™
™
 

(
™
™
 
_mainTextBox
™
™
 
==
™
™
 
null
™
™
  
)
™
™
  !
{
š
š
 	
return
›
›
 
;
›
›
 
}
œ
œ
 	
text
ž
ž
 
??=
ž
ž
 
string
ž
ž
 
.
ž
ž
 
Empty
ž
ž
 
;
ž
ž
 !
_isUpdatingFromCode
Ÿ
Ÿ
 
=
Ÿ
Ÿ
 
true
Ÿ
Ÿ
 "
;
Ÿ
Ÿ
" #
_mainTextBox
 
 
 
.
 
 
 
Text
 
 
 
=
 
 
 
text
 
 
  
;
 
 
  !
_mainTextBox
¡
¡
 
.
¡
¡
 

CaretIndex
¡
¡
 
=
¡
¡
  !
Math
¡
¡
" &
.
¡
¡
& '
Clamp
¡
¡
' ,
(
¡
¡
, -

caretIndex
¡
¡
- 7
,
¡
¡
7 8$
HintedTextBoxConstants
¡
¡
9 O
.
¡
¡
O P!
INITIAL_CARET_INDEX
¡
¡
P c
,
¡
¡
c d
text
¡
¡
e i
.
¡
¡
i j
Length
¡
¡
j p
)
¡
¡
p q
;
¡
¡
q r!
_isUpdatingFromCode
¢
¢
 
=
¢
¢
 
false
¢
¢
 #
;
¢
¢
# $
}
£
£
 
private
¥
¥
 
void
¥
¥
 
UpdateBorderState
¥
¥
 "
(
¥
¥
" #
)
¥
¥
# $
{
¦
¦
 
if
§
§
 

(
§
§
 
_mainTextBox
§
§
 
==
§
§
 
null
§
§
  
||
§
§
! #
_focusBorder
§
§
$ 0
==
§
§
1 3
null
§
§
4 8
||
§
§
9 ;
_mainBorder
§
§
< G
==
§
§
H J
null
§
§
K O
||
§
§
P R
_shadowBorder
§
§
S `
==
§
§
a c
null
§
§
d h
)
§
§
h i
{
¨
¨
 	
return
©
©
 
;
©
©
 
}
ª
ª
 	
bool
¬
¬
 
currentHasError
¬
¬
 
=
¬
¬
 
HasError
¬
¬
 '
;
¬
¬
' (
SecureKeyStrength
­
­
 &
currentSecureKeyStrength
­
­
 2
=
­
­
3 4
SecureKeyStrength
­
­
5 F
;
­
­
F G
bool
®
®
 ,
currentIsSecureKeyStrengthMode
®
®
 +
=
®
®
, -%
IsSecureKeyStrengthMode
®
®
. E
;
®
®
E F

Dispatcher
°
°
 
.
°
°
 
UIThread
°
°
 
.
°
°
 
Post
°
°
  
(
°
°
  !
(
°
°
! "
)
°
°
" #
=>
°
°
$ &
{
±
±
 	
if
²
²
 
(
²
²
 
_isDisposed
²
²
 
)
²
²
 
{
³
³
 
return
´
´
 
;
´
´
 
}
µ
µ
 
if
·
·
 
(
·
·
 
_mainTextBox
·
·
 
==
·
·
 
null
·
·
  $
||
·
·
% '
_focusBorder
·
·
( 4
==
·
·
5 7
null
·
·
8 <
||
·
·
= ?
_mainBorder
·
·
@ K
==
·
·
L N
null
·
·
O S
||
·
·
T V
_shadowBorder
·
·
W d
==
·
·
e g
null
·
·
h l
)
·
·
l m
{
¸
¸
 
return
¹
¹
 
;
¹
¹
 
}
º
º
 
bool
¼
¼
 
	isFocused
¼
¼
 
=
¼
¼
 
_mainTextBox
¼
¼
 )
.
¼
¼
) *
	IsFocused
¼
¼
* 3
;
¼
¼
3 4
if
½
½
 
(
½
½
 
	isFocused
½
½
 
==
½
½
 
_lastIsFocused
½
½
 +
&&
¾
¾
 
currentHasError
¾
¾
 "
==
¾
¾
# %
_lastHasError
¾
¾
& 3
&&
¿
¿
 &
currentSecureKeyStrength
¿
¿
 +
==
¿
¿
, .$
_lastSecureKeyStrength
¿
¿
/ E
&&
À
À
 ,
currentIsSecureKeyStrengthMode
À
À
 1
==
À
À
2 4*
_lastIsSecureKeyStrengthMode
À
À
5 Q
)
À
À
Q R
{
Á
Á
 
return
Â
Â
 
;
Â
Â
 
}
Ã
Ã
 
_lastIsFocused
Å
Å
 
=
Å
Å
 
	isFocused
Å
Å
 &
;
Å
Å
& '
_lastHasError
Æ
Æ
 
=
Æ
Æ
 
currentHasError
Æ
Æ
 +
;
Æ
Æ
+ ,$
_lastSecureKeyStrength
Ç
Ç
 "
=
Ç
Ç
# $&
currentSecureKeyStrength
Ç
Ç
% =
;
Ç
Ç
= >*
_lastIsSecureKeyStrengthMode
È
È
 (
=
È
È
) *,
currentIsSecureKeyStrengthMode
È
È
+ I
;
È
È
I J'
UpdateBorderStateInternal
Ê
Ê
 %
(
Ê
Ê
% &
	isFocused
Ê
Ê
& /
,
Ê
Ê
/ 0
currentHasError
Ê
Ê
1 @
,
Ê
Ê
@ A&
currentSecureKeyStrength
Ê
Ê
B Z
,
Ê
Ê
Z [,
currentIsSecureKeyStrengthMode
Ë
Ë
 .
)
Ë
Ë
. /
;
Ë
Ë
/ 0
}
Ì
Ì
 	
,
Ì
Ì
	 
 
DispatcherPriority
Ì
Ì
 
.
Ì
Ì
 
Render
Ì
Ì
 $
)
Ì
Ì
$ %
;
Ì
Ì
% &
}
Í
Í
 
private
Ï
Ï
 
void
Ï
Ï
 '
UpdateBorderStateInternal
Ï
Ï
 *
(
Ï
Ï
* +
bool
Ï
Ï
+ /
	isFocused
Ï
Ï
0 9
,
Ï
Ï
9 :
bool
Ï
Ï
; ?
hasError
Ï
Ï
@ H
,
Ï
Ï
H I
SecureKeyStrength
Ï
Ï
J [
secureKeyStrength
Ï
Ï
\ m
,
Ï
Ï
m n
bool
Ð
Ð
 %
isSecureKeyStrengthMode
Ð
Ð
 $
)
Ð
Ð
$ %
{
Ñ
Ñ
 
if
Ò
Ò
 

(
Ò
Ò
 
_focusBorder
Ò
Ò
 
==
Ò
Ò
 
null
Ò
Ò
  
||
Ò
Ò
! #
_mainBorder
Ò
Ò
$ /
==
Ò
Ò
0 2
null
Ò
Ò
3 7
||
Ò
Ò
8 :
_shadowBorder
Ò
Ò
; H
==
Ò
Ò
I K
null
Ò
Ò
L P
)
Ò
Ò
P Q
{
Ó
Ó
 	
return
Ô
Ô
 
;
Ô
Ô
 
}
Õ
Õ
 	
if
×
×
 

(
×
×
 %
isSecureKeyStrengthMode
×
×
 #
)
×
×
# $
{
Ø
Ø
 	
(
Ù
Ù
 
Color
Ù
Ù
 
borderColor
Ù
Ù
 
,
Ù
Ù
 
string
Ù
Ù
  &
	shadowKey
Ù
Ù
' 0
,
Ù
Ù
0 1
Color
Ù
Ù
2 7
	iconColor
Ù
Ù
8 A
)
Ù
Ù
A B
=
Ù
Ù
C D(
GetSecureKeyStrengthColors
Ù
Ù
E _
(
Ù
Ù
_ `
secureKeyStrength
Ù
Ù
` q
)
Ù
Ù
q r
;
Ù
Ù
r s
_focusBorder
Û
Û
 
.
Û
Û
 
BorderBrush
Û
Û
 $
=
Û
Û
% &
GetCachedBrush
Û
Û
' 5
(
Û
Û
5 6
borderColor
Û
Û
6 A
)
Û
Û
A B
;
Û
Û
B C
_focusBorder
Ü
Ü
 
.
Ü
Ü
 
Opacity
Ü
Ü
  
=
Ü
Ü
! "$
HintedTextBoxConstants
Ü
Ü
# 9
.
Ü
Ü
9 :
FULL_OPACITY
Ü
Ü
: F
;
Ü
Ü
F G
_mainBorder
Ý
Ý
 
.
Ý
Ý
 
BorderBrush
Ý
Ý
 #
=
Ý
Ý
$ %
GetCachedBrush
Ý
Ý
& 4
(
Ý
Ý
4 5
Colors
Ý
Ý
5 ;
.
Ý
Ý
; <
Transparent
Ý
Ý
< G
)
Ý
Ý
G H
;
Ý
Ý
H I
_shadowBorder
Þ
Þ
 
.
Þ
Þ
 
	BoxShadow
Þ
Þ
 #
=
Þ
Þ
$ %
GetCachedResource
Þ
Þ
& 7
(
Þ
Þ
7 8
	shadowKey
Þ
Þ
8 A
)
Þ
Þ
A B
;
Þ
Þ
B C(
SecureKeyStrengthIconBrush
à
à
 &
=
à
à
' (
GetCachedBrush
à
à
) 7
(
à
à
7 8
	iconColor
à
à
8 A
)
à
à
A B
;
à
à
B C(
SecureKeyStrengthTextBrush
á
á
 &
=
á
á
' (
GetCachedBrush
á
á
) 7
(
á
á
7 8
	iconColor
á
á
8 A
)
á
á
A B
;
á
á
B C
}
â
â
 	
else
ã
ã
 
if
ã
ã
 
(
ã
ã
 
hasError
ã
ã
 
)
ã
ã
 
{
ä
ä
 	
_focusBorder
å
å
 
.
å
å
 
BorderBrush
å
å
 $
=
å
å
% &
GetCachedBrush
å
å
' 5
(
å
å
5 6
GetCachedColor
å
å
6 D
(
å
å
D E$
HintedTextBoxConstants
å
å
E [
.
å
å
[ \
ERROR_COLOR_HEX
å
å
\ k
)
å
å
k l
)
å
å
l m
;
å
å
m n
_focusBorder
æ
æ
 
.
æ
æ
 
Opacity
æ
æ
  
=
æ
æ
! "$
HintedTextBoxConstants
æ
æ
# 9
.
æ
æ
9 :
FULL_OPACITY
æ
æ
: F
;
æ
æ
F G
_mainBorder
ç
ç
 
.
ç
ç
 
BorderBrush
ç
ç
 #
=
ç
ç
$ %
GetCachedBrush
ç
ç
& 4
(
ç
ç
4 5
Colors
ç
ç
5 ;
.
ç
ç
; <
Transparent
ç
ç
< G
)
ç
ç
G H
;
ç
ç
H I
_shadowBorder
è
è
 
.
è
è
 
	BoxShadow
è
è
 #
=
è
è
$ %
GetCachedResource
è
è
& 7
(
è
è
7 8$
HintedTextBoxConstants
è
è
8 N
.
è
è
N O
ERROR_SHADOW_KEY
è
è
O _
)
è
è
_ `
;
è
è
` a
}
é
é
 	
else
ê
ê
 
if
ê
ê
 
(
ê
ê
 
	isFocused
ê
ê
 
)
ê
ê
 
{
ë
ë
 	
_focusBorder
ì
ì
 
.
ì
ì
 
BorderBrush
ì
ì
 $
=
ì
ì
% &
FocusBorderBrush
ì
ì
' 7
;
ì
ì
7 8
_focusBorder
í
í
 
.
í
í
 
Opacity
í
í
  
=
í
í
! "$
HintedTextBoxConstants
í
í
# 9
.
í
í
9 :
FULL_OPACITY
í
í
: F
;
í
í
F G
_mainBorder
î
î
 
.
î
î
 
BorderBrush
î
î
 #
=
î
î
$ %
GetCachedBrush
î
î
& 4
(
î
î
4 5
Colors
î
î
5 ;
.
î
î
; <
Transparent
î
î
< G
)
î
î
G H
;
î
î
H I
_shadowBorder
ï
ï
 
.
ï
ï
 
	BoxShadow
ï
ï
 #
=
ï
ï
$ %
GetCachedResource
ï
ï
& 7
(
ï
ï
7 8$
HintedTextBoxConstants
ï
ï
8 N
.
ï
ï
N O
FOCUS_SHADOW_KEY
ï
ï
O _
)
ï
ï
_ `
;
ï
ï
` a
}
ð
ð
 	
else
ñ
ñ
 
{
ò
ò
 	
_focusBorder
ó
ó
 
.
ó
ó
 
Opacity
ó
ó
  
=
ó
ó
! "$
HintedTextBoxConstants
ó
ó
# 9
.
ó
ó
9 :
ZERO_OPACITY
ó
ó
: F
;
ó
ó
F G
_mainBorder
ô
ô
 
.
ô
ô
 
BorderBrush
ô
ô
 #
=
ô
ô
$ %
MainBorderBrush
ô
ô
& 5
;
ô
ô
5 6
_shadowBorder
õ
õ
 
.
õ
õ
 
	BoxShadow
õ
õ
 #
=
õ
õ
$ %
GetCachedResource
õ
õ
& 7
(
õ
õ
7 8$
HintedTextBoxConstants
õ
õ
8 N
.
õ
õ
N O 
DEFAULT_SHADOW_KEY
õ
õ
O a
)
õ
õ
a b
;
õ
õ
b c
}
ö
ö
 	
}
÷
÷
 
private
ù
ù
 
void
ù
ù
 &
UnsubscribeTextBoxEvents
ù
ù
 )
(
ù
ù
) *
)
ù
ù
* +
{
ú
ú
 
if
û
û
 

(
û
û
 
_mainTextBox
û
û
 
==
û
û
 
null
û
û
  
)
û
û
  !
{
ü
ü
 	
return
ý
ý
 
;
ý
ý
 
}
þ
þ
 	
_mainTextBox
€€ 
.
€€ 
TextChanged
€€  
-=
€€! #
OnTextChanged
€€$ 1
;
€€1 2
_mainTextBox
 
.
 
GotFocus
 
-=
  

OnGotFocus
! +
;
+ ,
_mainTextBox
‚‚ 
.
‚‚ 
	LostFocus
‚‚ 
-=
‚‚ !
OnLostFocus
‚‚" -
;
‚‚- .
_mainTextBox
ƒƒ 
.
ƒƒ 
RemoveHandler
ƒƒ "
(
ƒƒ" #
TextInputEvent
ƒƒ# 1
,
ƒƒ1 2
OnTextInput
ƒƒ3 >
)
ƒƒ> ?
;
ƒƒ? @
_mainTextBox
„„ 
.
„„ 
RemoveHandler
„„ "
(
„„" #
KeyDownEvent
„„# /
,
„„/ 0
OnPreviewKeyDown
„„1 A
)
„„A B
;
„„B C
_mainTextBox
…… 
.
…… 
RemoveHandler
…… "
(
……" #!
PointerPressedEvent
……# 6
,
……6 7
OnPointerPressed
……8 H
)
……H I
;
……I J
_mainTextBox
†† 
.
†† 
RemoveHandler
†† "
(
††" #
PointerMovedEvent
††# 4
,
††4 5
OnPointerMoved
††6 D
)
††D E
;
††E F
_mainTextBox
‡‡ 
.
‡‡ 
RemoveHandler
‡‡ "
(
‡‡" #"
PointerReleasedEvent
‡‡# 7
,
‡‡7 8
OnPointerReleased
‡‡9 J
)
‡‡J K
;
‡‡K L
_mainTextBox
ˆˆ 
.
ˆˆ 
RemoveHandler
ˆˆ "
(
ˆˆ" #
DragDrop
ˆˆ# +
.
ˆˆ+ ,
DragEnterEvent
ˆˆ, :
,
ˆˆ: ;
OnDragEnter
ˆˆ< G
)
ˆˆG H
;
ˆˆH I
_mainTextBox
‰‰ 
.
‰‰ 
RemoveHandler
‰‰ "
(
‰‰" #
DragDrop
‰‰# +
.
‰‰+ ,
DragOverEvent
‰‰, 9
,
‰‰9 :

OnDragOver
‰‰; E
)
‰‰E F
;
‰‰F G
_mainTextBox
ŠŠ 
.
ŠŠ 
RemoveHandler
ŠŠ "
(
ŠŠ" #
DragDrop
ŠŠ# +
.
ŠŠ+ ,
	DropEvent
ŠŠ, 5
,
ŠŠ5 6
OnDrop
ŠŠ7 =
)
ŠŠ= >
;
ŠŠ> ?
_mainTextBox
‹‹ 
.
‹‹ 
RemoveHandler
‹‹ "
(
‹‹" #
Gestures
‹‹# +
.
‹‹+ ,
TappedEvent
‹‹, 7
,
‹‹7 8
OnTapped
‹‹9 A
)
‹‹A B
;
‹‹B C
_mainTextBox
ŒŒ 
.
ŒŒ 
RemoveHandler
ŒŒ "
(
ŒŒ" #
Gestures
ŒŒ# +
.
ŒŒ+ ,
DoubleTappedEvent
ŒŒ, =
,
ŒŒ= >
OnDoubleTapped
ŒŒ? M
)
ŒŒM N
;
ŒŒN O
_mainTextBox
 
.
 
RemoveHandler
 "
(
" #
Gestures
# +
.
+ ,
HoldingEvent
, 8
,
8 9
	OnHolding
: C
)
C D
;
D E
}
ŽŽ 
private
 
void
 
FindControls
 
(
 
)
 
{
‘‘ 
_mainTextBox
’’ 
=
’’ 
this
’’ 
.
’’ 
FindControl
’’ '
<
’’' (
TextBox
’’( /
>
’’/ 0
(
’’0 1$
HintedTextBoxConstants
’’1 G
.
’’G H 
MAIN_TEXT_BOX_NAME
’’H Z
)
’’Z [
;
’’[ \
_focusBorder
““ 
=
““ 
this
““ 
.
““ 
FindControl
““ '
<
““' (
Border
““( .
>
““. /
(
““/ 0$
HintedTextBoxConstants
““0 F
.
““F G
FOCUS_BORDER_NAME
““G X
)
““X Y
;
““Y Z
_mainBorder
”” 
=
”” 
this
”” 
.
”” 
FindControl
”” &
<
””& '
Border
””' -
>
””- .
(
””. /$
HintedTextBoxConstants
””/ E
.
””E F
MAIN_BORDER_NAME
””F V
)
””V W
;
””W X
_shadowBorder
•• 
=
•• 
this
•• 
.
•• 
FindControl
•• (
<
••( )
Border
••) /
>
••/ 0
(
••0 1$
HintedTextBoxConstants
••1 G
.
••G H 
SHADOW_BORDER_NAME
••H Z
)
••Z [
;
••[ \
}
–– 
private
˜˜ 
void
˜˜ 

OnGotFocus
˜˜ 
(
˜˜ 
object
˜˜ "
?
˜˜" #
sender
˜˜$ *
,
˜˜* +
GotFocusEventArgs
˜˜, =
e
˜˜> ?
)
˜˜? @
{
™™ 
try
šš 
{
›› 	
if
œœ 
(
œœ 
!
œœ 
_isDisposed
œœ 
)
œœ 
{
 
UpdateBorderState
žž !
(
žž! "
)
žž" #
;
žž# $
}
ŸŸ 
}
   	
catch
¡¡ 
(
¡¡ 
	Exception
¡¡ 
ex
¡¡ 
)
¡¡ 
{
¢¢ 	
System
££ 
.
££ 
Diagnostics
££ 
.
££ 
Debug
££ $
.
££$ %
	WriteLine
££% .
(
££. /
$"
££/ 1
$str
££1 F
{
££F G
ex
££G I
.
££I J
Message
££J Q
}
££Q R
"
££R S
)
££S T
;
££T U
}
¤¤ 	
}
¥¥ 
private
§§ 
void
§§ 
OnLostFocus
§§ 
(
§§ 
object
§§ #
?
§§# $
sender
§§% +
,
§§+ ,
RoutedEventArgs
§§- <
e
§§= >
)
§§> ?
{
¨¨ 
try
©© 
{
ªª 	
if
«« 
(
«« 
!
«« 
_isDisposed
«« 
)
«« 
{
¬¬ 
UpdateBorderState
­­ !
(
­­! "
)
­­" #
;
­­# $
}
®® 
}
¯¯ 	
catch
°° 
(
°° 
	Exception
°° 
ex
°° 
)
°° 
{
±± 	
System
²² 
.
²² 
Diagnostics
²² 
.
²² 
Debug
²² $
.
²²$ %
	WriteLine
²²% .
(
²². /
$"
²²/ 1
$str
²²1 G
{
²²G H
ex
²²H J
.
²²J K
Message
²²K R
}
²²R S
"
²²S T
)
²²T U
;
²²U V
}
³³ 	
}
´´ 
private
¶¶ 
void
¶¶ #
SetupReactiveBindings
¶¶ &
(
¶¶& '
)
¶¶' (
{
·· 
this
¸¸ 
.
¸¸ 
WhenAnyValue
¸¸ 
(
¸¸ 
x
¹¹ 
=>
¹¹ 
x
¹¹ 
.
¹¹ 
HasError
¹¹ 
,
¹¹  
x
ºº 
=>
ºº 
x
ºº 
.
ºº 
SecureKeyStrength
ºº (
,
ºº( )
x
»» 
=>
»» 
x
»» 
.
»» %
IsSecureKeyStrengthMode
»» .
,
»». /
(
¼¼ 
hasError
¼¼ 
,
¼¼ 
secureKeyStrength
¼¼ ,
,
¼¼, -%
isSecureKeyStrengthMode
¼¼. E
)
¼¼E F
=>
¼¼G I
(
½½ 
hasError
½½ 
,
½½ 
secureKeyStrength
½½ 0
,
½½0 1%
isSecureKeyStrengthMode
½½2 I
)
½½I J
)
½½J K
.
¾¾ "
DistinctUntilChanged
¾¾ !
(
¾¾! "
)
¾¾" #
.
¿¿ 
	Subscribe
¿¿ 
(
¿¿ 
_
¿¿ 
=>
¿¿ 
SafeExecute
¿¿ '
(
¿¿' (
UpdateBorderState
¿¿( 9
,
¿¿9 :
$str
¿¿; [
)
¿¿[ \
)
¿¿\ ]
.
ÀÀ 
DisposeWith
ÀÀ 
(
ÀÀ 
_disposables
ÀÀ %
)
ÀÀ% &
;
ÀÀ& '
this
ÂÂ 
.
ÂÂ 
WhenAnyValue
ÂÂ 
(
ÂÂ 
x
ÂÂ 
=>
ÂÂ 
x
ÂÂ  
.
ÂÂ  !
	ErrorText
ÂÂ! *
)
ÂÂ* +
.
ÃÃ "
DistinctUntilChanged
ÃÃ !
(
ÃÃ! "
)
ÃÃ" #
.
ÄÄ 
Scan
ÄÄ 
(
ÄÄ 
string
ÄÄ 
.
ÄÄ 
Empty
ÄÄ 
,
ÄÄ 
(
ÄÄ  !
previous
ÄÄ! )
,
ÄÄ) *
current
ÄÄ+ 2
)
ÄÄ2 3
=>
ÄÄ4 6
string
ÅÅ 
.
ÅÅ 
IsNullOrEmpty
ÅÅ $
(
ÅÅ$ %
current
ÅÅ% ,
)
ÅÅ, -
&&
ÅÅ. 0
!
ÅÅ1 2
string
ÅÅ2 8
.
ÅÅ8 9
IsNullOrEmpty
ÅÅ9 F
(
ÅÅF G
previous
ÅÅG O
)
ÅÅO P
?
ÅÅQ R
previous
ÅÅS [
:
ÅÅ\ ]
current
ÅÅ^ e
)
ÅÅe f
.
ÆÆ 
	Subscribe
ÆÆ 
(
ÆÆ 
accumulatedError
ÆÆ '
=>
ÆÆ( *
SafeExecute
ÆÆ+ 6
(
ÆÆ6 7
(
ÆÆ7 8
)
ÆÆ8 9
=>
ÆÆ: <
{
ÇÇ 
if
ÈÈ 
(
ÈÈ 
!
ÈÈ 
string
ÈÈ 
.
ÈÈ 
IsNullOrEmpty
ÈÈ )
(
ÈÈ) *
accumulatedError
ÈÈ* :
)
ÈÈ: ;
)
ÈÈ; <
{
ÉÉ 
SetValue
ÊÊ 
(
ÊÊ 
ErrorTextProperty
ÊÊ .
,
ÊÊ. /
accumulatedError
ÊÊ0 @
)
ÊÊ@ A
;
ÊÊA B
}
ËË 
}
ÌÌ 
,
ÌÌ 
$str
ÌÌ '
)
ÌÌ' (
)
ÌÌ( )
.
ÍÍ 
DisposeWith
ÍÍ 
(
ÍÍ 
_disposables
ÍÍ %
)
ÍÍ% &
;
ÍÍ& '
this
ÏÏ 
.
ÏÏ 
WhenAnyValue
ÏÏ 
(
ÏÏ 
x
ÏÏ 
=>
ÏÏ 
x
ÏÏ  
.
ÏÏ  !
Text
ÏÏ! %
)
ÏÏ% &
.
ÐÐ 
Where
ÐÐ 
(
ÐÐ 
text
ÐÐ 
=>
ÐÐ 
!
ÐÐ 
IsSecureKeyMode
ÐÐ +
&&
ÐÐ, .
_mainTextBox
ÐÐ/ ;
!=
ÐÐ< >
null
ÐÐ? C
&&
ÐÐD F
_mainTextBox
ÐÐG S
.
ÐÐS T
Text
ÐÐT X
!=
ÐÐY [
text
ÐÐ\ `
)
ÐÐ` a
.
ÑÑ 
	Subscribe
ÑÑ 
(
ÑÑ 
text
ÑÑ 
=>
ÑÑ 
SafeExecute
ÑÑ *
(
ÑÑ* +
(
ÑÑ+ ,
)
ÑÑ, -
=>
ÑÑ. 0
UpdateTextBox
ÑÑ1 >
(
ÑÑ> ?
text
ÑÑ? C
,
ÑÑC D
text
ÑÑE I
.
ÑÑI J
Length
ÑÑJ P
)
ÑÑP Q
,
ÑÑQ R
$str
ÑÑS f
)
ÑÑf g
)
ÑÑg h
.
ÒÒ 
DisposeWith
ÒÒ 
(
ÒÒ 
_disposables
ÒÒ %
)
ÒÒ% &
;
ÒÒ& '
this
ÔÔ 
.
ÔÔ 
WhenAnyValue
ÔÔ 
(
ÔÔ 
x
ÔÔ 
=>
ÔÔ 
x
ÔÔ  
.
ÔÔ  !
HasError
ÔÔ! )
)
ÔÔ) *
.
ÕÕ "
DistinctUntilChanged
ÕÕ !
(
ÕÕ! "
)
ÕÕ" #
.
ÖÖ 
	Subscribe
ÖÖ 
(
ÖÖ 
hasError
ÖÖ 
=>
ÖÖ  "
SafeExecute
ÖÖ# .
(
ÖÖ. /
(
ÖÖ/ 0
)
ÖÖ0 1
=>
ÖÖ2 4
{
×× 
EllipseOpacity
ØØ 
=
ØØ  
hasError
ØØ! )
?
ÙÙ $
HintedTextBoxConstants
ÙÙ ,
.
ÙÙ, --
DEFAULT_ELLIPSE_OPACITY_VISIBLE
ÙÙ- L
:
ÚÚ $
HintedTextBoxConstants
ÚÚ ,
.
ÚÚ, -,
DEFAULT_ELLIPSE_OPACITY_HIDDEN
ÚÚ- K
;
ÚÚK L
}
ÛÛ 
,
ÛÛ 
$str
ÛÛ &
)
ÛÛ& '
)
ÛÛ' (
.
ÜÜ 
DisposeWith
ÜÜ 
(
ÜÜ 
_disposables
ÜÜ %
)
ÜÜ% &
;
ÜÜ& '
}
ÝÝ 
private
ßß 
void
ßß 
SafeExecute
ßß 
(
ßß 
Action
ßß #
action
ßß$ *
,
ßß* +
string
ßß, 2
context
ßß3 :
)
ßß: ;
{
àà 
if
áá 

(
áá 
_isDisposed
áá 
)
áá 
{
ââ 	
return
ãã 
;
ãã 
}
ää 	
try
ææ 
{
çç 	
action
èè 
(
èè 
)
èè 
;
èè 
}
éé 	
catch
êê 
(
êê 
	Exception
êê 
ex
êê 
)
êê 
{
ëë 	
System
ìì 
.
ìì 
Diagnostics
ìì 
.
ìì 
Debug
ìì $
.
ìì$ %
	WriteLine
ìì% .
(
ìì. /
$"
ìì/ 1
$str
ìì1 :
{
ìì: ;
context
ìì; B
}
ììB C
$str
ììC E
{
ììE F
ex
ììF H
.
ììH I
Message
ììI P
}
ììP Q
"
ììQ R
)
ììR S
;
ììS T
}
íí 	
}
îî 
private
ðð 
void
ðð '
UpdateRemainingCharacters
ðð *
(
ðð* +
)
ðð+ ,
{
ññ 
int
òò 
currentTextLength
òò 
=
òò 
IsSecureKeyMode
òò  /
&&
òò0 2
_mainTextBox
òò3 ?
!=
òò@ B
null
òòC G
?
óó !
GetTextElementCount
óó !
(
óó! "
_mainTextBox
óó" .
.
óó. /
Text
óó/ 3
??
óó4 6
string
óó7 =
.
óó= >
Empty
óó> C
)
óóC D
:
ôô !
GetTextElementCount
ôô !
(
ôô! "
Text
ôô" &
)
ôô& '
;
ôô' (!
RemainingCharacters
õõ 
=
õõ 
	MaxLength
õõ '
-
õõ( )
currentTextLength
õõ* ;
;
õõ; <
}
öö 
private
øø 
void
øø &
OnIsSecureKeyModeChanged
øø )
(
øø) *
bool
øø* .
isSecureKeyMode
øø/ >
)
øø> ?
{
ùù 
if
úú 

(
úú 
_mainTextBox
úú 
==
úú 
null
úú  
)
úú  !
{
ûû 	
return
üü 
;
üü 
}
ýý 	
_mainTextBox
ÿÿ 
.
ÿÿ 
PasswordChar
ÿÿ !
=
ÿÿ" #$
HintedTextBoxConstants
ÿÿ$ :
.
ÿÿ: ; 
NO_SECURE_KEY_CHAR
ÿÿ; M
;
ÿÿM N
if
 

(
 
isSecureKeyMode
 
)
 
{
‚‚ 	 
_lastProcessedText
ƒƒ 
=
ƒƒ  
_mainTextBox
ƒƒ! -
.
ƒƒ- .
Text
ƒƒ. 2
??
ƒƒ3 5
string
ƒƒ6 <
.
ƒƒ< =
Empty
ƒƒ= B
;
ƒƒB C(
DisableClipboardOperations
„„ &
(
„„& '
)
„„' (
;
„„( )
}
…… 	
else
†† 
{
‡‡ 	 
_lastProcessedText
ˆˆ 
=
ˆˆ  
string
ˆˆ! '
.
ˆˆ' (
Empty
ˆˆ( -
;
ˆˆ- .'
EnableClipboardOperations
‰‰ %
(
‰‰% &
)
‰‰& '
;
‰‰' (
}
ŠŠ 	'
UpdateRemainingCharacters
ŒŒ !
(
ŒŒ! "
)
ŒŒ" #
;
ŒŒ# $
}
 
private
 
void
 '
EnableClipboardOperations
 *
(
* +
)
+ ,
{
 
if
‘‘ 

(
‘‘ 
_mainTextBox
‘‘ 
==
‘‘ 
null
‘‘  
)
‘‘  !
{
’’ 	
return
““ 
;
““ 
}
”” 	
_mainTextBox
–– 
.
–– 
RemoveHandler
–– "
(
––" #
TextInputEvent
––# 1
,
––1 2
OnTextInput
––3 >
)
––> ?
;
––? @
_mainTextBox
—— 
.
—— 
RemoveHandler
—— "
(
——" #
KeyDownEvent
——# /
,
——/ 0
OnPreviewKeyDown
——1 A
)
——A B
;
——B C
_mainTextBox
˜˜ 
.
˜˜ 
RemoveHandler
˜˜ "
(
˜˜" #!
PointerPressedEvent
˜˜# 6
,
˜˜6 7
OnPointerPressed
˜˜8 H
)
˜˜H I
;
˜˜I J
_mainTextBox
™™ 
.
™™ 
RemoveHandler
™™ "
(
™™" #
PointerMovedEvent
™™# 4
,
™™4 5
OnPointerMoved
™™6 D
)
™™D E
;
™™E F
_mainTextBox
šš 
.
šš 
RemoveHandler
šš "
(
šš" #"
PointerReleasedEvent
šš# 7
,
šš7 8
OnPointerReleased
šš9 J
)
ššJ K
;
ššK L
_mainTextBox
›› 
.
›› 
RemoveHandler
›› "
(
››" #
DragDrop
››# +
.
››+ ,
DragEnterEvent
››, :
,
››: ;
OnDragEnter
››< G
)
››G H
;
››H I
_mainTextBox
œœ 
.
œœ 
RemoveHandler
œœ "
(
œœ" #
DragDrop
œœ# +
.
œœ+ ,
DragOverEvent
œœ, 9
,
œœ9 :

OnDragOver
œœ; E
)
œœE F
;
œœF G
_mainTextBox
 
.
 
RemoveHandler
 "
(
" #
DragDrop
# +
.
+ ,
	DropEvent
, 5
,
5 6
OnDrop
7 =
)
= >
;
> ?
_mainTextBox
žž 
.
žž 
RemoveHandler
žž "
(
žž" #
Gestures
žž# +
.
žž+ ,
TappedEvent
žž, 7
,
žž7 8
OnTapped
žž9 A
)
žžA B
;
žžB C
_mainTextBox
ŸŸ 
.
ŸŸ 
RemoveHandler
ŸŸ "
(
ŸŸ" #
Gestures
ŸŸ# +
.
ŸŸ+ ,
DoubleTappedEvent
ŸŸ, =
,
ŸŸ= >
OnDoubleTapped
ŸŸ? M
)
ŸŸM N
;
ŸŸN O
_mainTextBox
   
.
   
RemoveHandler
   "
(
  " #
Gestures
  # +
.
  + ,
HoldingEvent
  , 8
,
  8 9
	OnHolding
  : C
)
  C D
;
  D E
}
¡¡ 
private
££ 
void
££ $
TriggerTypingAnimation
££ '
(
££' (
)
££( )
{
¤¤ 
if
¥¥ 

(
¥¥ 
_mainTextBox
¥¥ 
==
¥¥ 
null
¥¥  
||
¥¥! #
_isDisposed
¥¥$ /
||
¥¥0 2
_focusBorder
¥¥3 ?
==
¥¥@ B
null
¥¥C G
)
¥¥G H
{
¦¦ 	
return
§§ 
;
§§ 
}
¨¨ 	
try
ªª 
{
«« 	%
_currentTypingAnimation
¬¬ #
?
¬¬# $
.
¬¬$ %
Dispose
¬¬% ,
(
¬¬, -
)
¬¬- .
;
¬¬. /
if
®® 
(
®® 
_focusBorder
®® 
.
®® 
Opacity
®® $
<=
®®% '$
HintedTextBoxConstants
®®( >
.
®®> ?
ZERO_OPACITY
®®? K
)
®®K L
{
¯¯ 
return
°° 
;
°° 
}
±± 
	Animation
³³ 
pulseAnimation
³³ $
=
³³% &
new
³³' *
(
³³* +
)
³³+ ,
{
´´ 
Duration
µµ 
=
µµ 
TimeSpan
µµ #
.
µµ# $
FromMilliseconds
µµ$ 4
(
µµ4 5$
HintedTextBoxConstants
µµ5 K
.
µµK L*
TYPING_ANIMATION_DURATION_MS
µµL h
)
µµh i
,
µµi j
FillMode
¶¶ 
=
¶¶ 
FillMode
¶¶ #
.
¶¶# $
None
¶¶$ (
,
¶¶( )
Easing
·· 
=
·· 
new
·· 
CubicEaseOut
·· )
(
··) *
)
··* +
}
¸¸ 
;
¸¸ 
KeyFrame
ºº 

startFrame
ºº 
=
ºº  !
new
ºº" %
(
ºº% &
)
ºº& '
{
»» 
Cue
¼¼ 
=
¼¼ 
Cue
¼¼ 
.
¼¼ 
Parse
¼¼ 
(
¼¼  $
HintedTextBoxConstants
¼¼  6
.
¼¼6 7%
ANIMATION_START_PERCENT
¼¼7 N
,
¼¼N O
CultureInfo
¼¼P [
.
¼¼[ \
InvariantCulture
¼¼\ l
)
¼¼l m
,
¼¼m n
Setters
½½ 
=
½½ 
{
½½ 
new
½½ 
Setter
½½  &
{
½½' (
Property
½½) 1
=
½½2 3
OpacityProperty
½½4 C
,
½½C D
Value
½½E J
=
½½K L
_focusBorder
½½M Y
.
½½Y Z
Opacity
½½Z a
}
½½b c
}
½½d e
}
¾¾ 
;
¾¾ 
KeyFrame
ÀÀ 
brightFrame
ÀÀ  
=
ÀÀ! "
new
ÀÀ# &
(
ÀÀ& '
)
ÀÀ' (
{
ÁÁ 
Cue
ÂÂ 
=
ÂÂ 
Cue
ÂÂ 
.
ÂÂ 
Parse
ÂÂ 
(
ÂÂ  $
HintedTextBoxConstants
ÂÂ  6
.
ÂÂ6 7$
ANIMATION_PEAK_PERCENT
ÂÂ7 M
,
ÂÂM N
CultureInfo
ÂÂO Z
.
ÂÂZ [
InvariantCulture
ÂÂ[ k
)
ÂÂk l
,
ÂÂl m
Setters
ÃÃ 
=
ÃÃ 
{
ÄÄ 
new
ÅÅ 
Setter
ÅÅ 
{
ÆÆ 
Property
ÇÇ  
=
ÇÇ! "
OpacityProperty
ÇÇ# 2
,
ÇÇ2 3
Value
ÈÈ 
=
ÈÈ 
Math
ÈÈ  $
.
ÈÈ$ %
Min
ÈÈ% (
(
ÈÈ( )$
HintedTextBoxConstants
ÈÈ) ?
.
ÈÈ? @
FULL_OPACITY
ÈÈ@ L
,
ÈÈL M
_focusBorder
ÉÉ (
.
ÉÉ( )
Opacity
ÉÉ) 0
+
ÉÉ1 2$
HintedTextBoxConstants
ÉÉ3 I
.
ÉÉI J%
ANIMATION_OPACITY_BOOST
ÉÉJ a
)
ÉÉa b
}
ÊÊ 
}
ËË 
}
ÌÌ 
;
ÌÌ 
KeyFrame
ÎÎ 
endFrame
ÎÎ 
=
ÎÎ 
new
ÎÎ  #
(
ÎÎ# $
)
ÎÎ$ %
{
ÏÏ 
Cue
ÐÐ 
=
ÐÐ 
Cue
ÐÐ 
.
ÐÐ 
Parse
ÐÐ 
(
ÐÐ  $
HintedTextBoxConstants
ÐÐ  6
.
ÐÐ6 7#
ANIMATION_END_PERCENT
ÐÐ7 L
,
ÐÐL M
CultureInfo
ÐÐN Y
.
ÐÐY Z
InvariantCulture
ÐÐZ j
)
ÐÐj k
,
ÐÐk l
Setters
ÑÑ 
=
ÑÑ 
{
ÑÑ 
new
ÑÑ 
Setter
ÑÑ  &
{
ÑÑ' (
Property
ÑÑ) 1
=
ÑÑ2 3
OpacityProperty
ÑÑ4 C
,
ÑÑC D
Value
ÑÑE J
=
ÑÑK L
_focusBorder
ÑÑM Y
.
ÑÑY Z
Opacity
ÑÑZ a
}
ÑÑb c
}
ÑÑd e
}
ÒÒ 
;
ÒÒ 
pulseAnimation
ÔÔ 
.
ÔÔ 
Children
ÔÔ #
.
ÔÔ# $
Add
ÔÔ$ '
(
ÔÔ' (

startFrame
ÔÔ( 2
)
ÔÔ2 3
;
ÔÔ3 4
pulseAnimation
ÕÕ 
.
ÕÕ 
Children
ÕÕ #
.
ÕÕ# $
Add
ÕÕ$ '
(
ÕÕ' (
brightFrame
ÕÕ( 3
)
ÕÕ3 4
;
ÕÕ4 5
pulseAnimation
ÖÖ 
.
ÖÖ 
Children
ÖÖ #
.
ÖÖ# $
Add
ÖÖ$ '
(
ÖÖ' (
endFrame
ÖÖ( 0
)
ÖÖ0 1
;
ÖÖ1 2%
_currentTypingAnimation
ØØ #
=
ØØ$ %
pulseAnimation
ØØ& 4
.
ØØ4 5
RunAsync
ØØ5 =
(
ØØ= >
_focusBorder
ØØ> J
)
ØØJ K
;
ØØK L
}
ÙÙ 	
catch
ÚÚ 
(
ÚÚ 
	Exception
ÚÚ 
ex
ÚÚ 
)
ÚÚ 
{
ÛÛ 	
System
ÜÜ 
.
ÜÜ 
Diagnostics
ÜÜ 
.
ÜÜ 
Debug
ÜÜ $
.
ÜÜ$ %
	WriteLine
ÜÜ% .
(
ÜÜ. /
$"
ÜÜ/ 1
$str
ÜÜ1 R
{
ÜÜR S
ex
ÜÜS U
.
ÜÜU V
Message
ÜÜV ]
}
ÜÜ] ^
"
ÜÜ^ _
)
ÜÜ_ `
;
ÜÜ` a
}
ÝÝ 	
}
ÞÞ 
private
àà 

BoxShadows
àà 
GetCachedResource
àà (
(
àà( )
string
àà) /
resourceKey
àà0 ;
)
àà; <
{
áá 
if
ââ 

(
ââ 
ResourceCache
ââ 
.
ââ 
TryGetValue
ââ %
(
ââ% &
resourceKey
ââ& 1
,
ââ1 2
out
ââ3 6

BoxShadows
ââ7 A
shadow
ââB H
)
ââH I
)
ââI J
{
ãã 	
return
ää 
shadow
ää 
;
ää 
}
åå 	
shadow
çç 
=
çç 
this
çç 
.
çç 
FindResource
çç "
(
çç" #
resourceKey
çç# .
)
çç. /
is
çç0 2

BoxShadows
çç3 =
foundShadow
çç> I
?
ççJ K
foundShadow
ççL W
:
ççX Y
default
ççZ a
;
çça b
ResourceCache
èè 
[
èè 
resourceKey
èè !
]
èè! "
=
èè# $
shadow
èè% +
;
èè+ ,
return
êê 
shadow
êê 
;
êê 
}
ëë 
private
íí 
void
íí !
InitializeComponent
íí $
(
íí$ %
)
íí% &
{
îî  
AvaloniaXamlLoader
ïï 
.
ïï 
Load
ïï 
(
ïï  
this
ïï  $
)
ïï$ %
;
ïï% &
}
ðð 
}ññ  Ü
‰/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Core/ConnectivityNotificationViewModel.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Core! %
;% &
public 
enum %
ConnectivityIssueCategory %
{ 
InternetUnavailable   
,   
ServerUnreachable!! 
}"" 
public$$ 
enum$$ &
DetailedConnectivityStatus$$ &
{%%  
NoInternetConnection&& 
,&& &
CheckingInternetConnection'' 
,'' 
InternetRestored(( 
,(( 
ConnectingToServer)) 
,)) 
Reconnecting** 
,** 
ServerNotResponding++ 
,++ 
ServerShuttingDown,, 
,,, 
RetriesExhausted-- 
,-- 
ServerReconnected.. 
}// 
public11 
sealed11 
class11 -
!ConnectivityNotificationViewModel11 5
:116 7
ReactiveObject118 F
,11F G
IDisposable11H S
{22 
public33 
 
ILocalizationService33 
LocalizationService33  3
{334 5
get336 9
;339 :
}33; <
private55 
readonly55 
CompositeDisposable55 (
_disposables55) 5
=556 7
new558 ;
(55; <
)55< =
;55= >
private66 
readonly66 
SemaphoreSlim66 ""
_statusUpdateSemaphore66# 9
=66: ;
new66< ?
(66? @
$num66@ A
,66A B
$num66C D
)66D E
;66E F
private88 
readonly88 

Dictionary88 
<88  &
DetailedConnectivityStatus88  :
,88: ;
string88< B
>88B C
_cachedStatusTexts88D V
=88W X
new88Y \
(88\ ]
)88] ^
;88^ _
private99 
readonly99 

Dictionary99 
<99  &
DetailedConnectivityStatus99  :
,99: ;
string99< B
>99B C%
_cachedStatusDescriptions99D ]
=99^ _
new99` c
(99c d
)99d e
;99e f
private:: 
string:: 
?:: "
_cachedRetryButtonText:: *
;::* +
private<< (
ConnectivityNotificationView<< (
?<<( )
_view<<* /
;<</ 0
private== 
Border== 
?== 
_mainBorder== 
;==  
private>> 
bool>> 
	_disposed>> 
;>> 
private@@ 
static@@ 
readonly@@ 
Lazy@@  
<@@  !
	Animation@@! *
>@@* +"
_sharedAppearAnimation@@, B
=@@C D
new@@E H
(@@H I!
CreateAppearAnimation@@I ^
)@@^ _
;@@_ `
privateAA 
staticAA 
readonlyAA 
LazyAA  
<AA  !
	AnimationAA! *
>AA* +%
_sharedDisappearAnimationAA, E
=AAF G
newAAH K
(AAK L$
CreateDisappearAnimationAAL d
)AAd e
;AAe f
privateCC 
BitmapCC 
?CC *
_cachedInternetUnavailableIconCC 2
;CC2 3
privateDD 
BitmapDD 
?DD (
_cachedServerUnreachableIconDD 0
;DD0 1
privateFF 
TranslateTransformFF 
?FF %
_sharedTranslateTransformFF  9
;FF9 :
publicHH 

TimeSpanHH 
AppearDurationHH "
{HH# $
getHH% (
;HH( )
setHH* -
;HH- .
}HH/ 0
=HH1 2
TimeSpanII 
.II 
FromMillisecondsII !
(II! ""
NetworkStatusConstantsII" 8
.II8 9&
DEFAULT_APPEAR_DURATION_MSII9 S
)IIS T
;IIT U
publicKK 

TimeSpanKK 
DisappearDurationKK %
{KK& '
getKK( +
;KK+ ,
setKK- 0
;KK0 1
}KK2 3
=KK4 5
TimeSpanLL 
.LL 
FromMillisecondsLL !
(LL! ""
NetworkStatusConstantsLL" 8
.LL8 9)
DEFAULT_DISAPPEAR_DURATION_MSLL9 V
)LLV W
;LLW X
privateNN 
readonlyNN &
ObservableAsPropertyHelperNN /
<NN/ 0
stringNN0 6
>NN6 7
_retryButtonTextNN8 H
;NNH I
publicOO 

stringOO 
RetryButtonTextOO !
=>OO" $
_retryButtonTextOO% 5
.OO5 6
ValueOO6 ;
;OO; <
privateQQ 
readonlyQQ &
ObservableAsPropertyHelperQQ /
<QQ/ 0
boolQQ0 4
>QQ4 5

_isVisibleQQ6 @
;QQ@ A
publicRR 

boolRR 
	IsVisibleRR 
=>RR 

_isVisibleRR '
.RR' (
ValueRR( -
;RR- .
privateTT 
readonlyTT &
ObservableAsPropertyHelperTT /
<TT/ 0
boolTT0 4
>TT4 5
_isAnimatingTT6 B
;TTB C
publicUU 

boolUU 
IsAnimatingUU 
=>UU 
_isAnimatingUU +
.UU+ ,
ValueUU, 1
;UU1 2
privateWW 
readonlyWW &
ObservableAsPropertyHelperWW /
<WW/ 0
stringWW0 6
>WW6 7
_statusTextWW8 C
;WWC D
publicXX 

stringXX 

StatusTextXX 
=>XX 
_statusTextXX  +
.XX+ ,
ValueXX, 1
;XX1 2
privateZZ 
readonlyZZ &
ObservableAsPropertyHelperZZ /
<ZZ/ 0
stringZZ0 6
>ZZ6 7
_statusDescriptionZZ8 J
;ZZJ K
public[[ 

string[[ 
StatusDescription[[ #
=>[[$ &
_statusDescription[[' 9
.[[9 :
Value[[: ?
;[[? @
private]] 
readonly]] &
ObservableAsPropertyHelper]] /
<]]/ 0
Bitmap]]0 6
?]]6 7
>]]7 8
_statusIconSource]]9 J
;]]J K
public^^ 

Bitmap^^ 
?^^ 
StatusIconSource^^ #
=>^^$ &
_statusIconSource^^' 8
.^^8 9
Value^^9 >
;^^> ?
private`` 
readonly`` &
ObservableAsPropertyHelper`` /
<``/ 0
bool``0 4
>``4 5
_showRetryButton``6 F
;``F G
publicaa 

boolaa 
ShowRetryButtonaa 
=>aa  "
_showRetryButtonaa# 3
.aa3 4
Valueaa4 9
;aa9 :
privatecc 
readonlycc &
ObservableAsPropertyHelpercc /
<cc/ 0%
ConnectivityIssueCategorycc0 I
>ccI J
_issueCategoryccK Y
;ccY Z
publicdd 
%
ConnectivityIssueCategorydd $
IssueCategorydd% 2
=>dd3 5
_issueCategorydd6 D
.ddD E
ValueddE J
;ddJ K
privateff 
readonlyff &
ObservableAsPropertyHelperff /
<ff/ 0&
DetailedConnectivityStatusff0 J
>ffJ K
_detailedStatusffL [
;ff[ \
publicgg 
&
DetailedConnectivityStatusgg %
DetailedStatusgg& 4
=>gg5 7
_detailedStatusgg8 G
.ggG H
ValueggH M
;ggM N
publicii 

ReactiveCommandii 
<ii 
Unitii 
,ii  
Unitii! %
>ii% &
RetryCommandii' 3
{ii4 5
getii6 9
;ii9 :
}ii; <
publickk 

voidkk 
SetViewkk 
(kk (
ConnectivityNotificationViewkk 4
viewkk5 9
)kk9 :
{ll 
_viewmm 
=mm 
viewmm 
;mm 
_mainBordernn 
=nn 
viewnn 
.nn 
FindControlnn &
<nn& '
Bordernn' -
>nn- .
(nn. /
$strnn/ ;
)nn; <
;nn< =
CreateAnimationsoo 
(oo 
)oo 
;oo 
}pp 
publicrr 
-
!ConnectivityNotificationViewModelrr ,
(rr, - 
ILocalizationServicess 
localizationServicess 0
,ss0 1 
IConnectivityServicett 
connectivityServicett 0
,tt0 1"
IPendingRequestManageruu !
pendingRequestManageruu 4
)uu4 5
{vv 
LocalizationServiceww 
=ww 
localizationServiceww 1
;ww1 2
IObservableyy 
<yy 
Unityy 
>yy 
languageTriggeryy )
=yy* +

Observableyy, 6
.yy6 7
	FromEventyy7 @
(yy@ A
handlerzz 
=>zz 
LocalizationServicezz .
.zz. /
LanguageChangedzz/ >
+=zz? A
handlerzzB I
,zzI J
handler{{ 
=>{{ 
LocalizationService{{ .
.{{. /
LanguageChanged{{/ >
-={{? A
handler{{B I
){{I J
.|| 
Select|| 
(|| 
_|| 
=>|| 
Unit|| 
.|| 
Default|| %
)||% &
.}} 
	StartWith}} 
(}} 
Unit}} 
.}} 
Default}} #
)}}# $
;}}$ %
languageTrigger 
.
€€ 
Skip
€€ 
(
€€ 
$num
€€ 
)
€€ 
.
 
	Subscribe
 
(
 
_
 
=>
 
ClearStringCache
 ,
(
, -
)
- .
)
. /
.
‚‚ 
DisposeWith
‚‚ 
(
‚‚ 
_disposables
‚‚ %
)
‚‚% &
;
‚‚& '"
ConnectivitySnapshot
„„ 
initialSnapshot
„„ ,
=
„„- .!
connectivityService
„„/ B
.
„„B C
CurrentSnapshot
„„C R
;
„„R S
IObservable
†† 
<
†† "
ConnectivitySnapshot
†† (
>
††( )#
connectivitySnapshots
††* ?
=
††@ A!
connectivityService
††B U
.
††U V 
ConnectivityStream
††V h
.
‡‡ 
Publish
‡‡ 
(
‡‡ 
)
‡‡ 
.
ˆˆ 
RefCount
ˆˆ 
(
ˆˆ 
)
ˆˆ 
;
ˆˆ 
IObservable
ŠŠ 
<
ŠŠ '
ManualRetryRequestedEvent
ŠŠ -
>
ŠŠ- .
manualRetryEvents
ŠŠ/ @
=
ŠŠA B

Observable
‹‹ 
.
‹‹ 
Create
‹‹ 
<
‹‹ '
ManualRetryRequestedEvent
‹‹ 7
>
‹‹7 8
(
‹‹8 9
observer
‹‹9 A
=>
‹‹B D
{
ŒŒ 
return
 !
connectivityService
 *
.
* +$
OnManualRetryRequested
+ A
(
A B
evt
ŽŽ 
=>
ŽŽ 
{
 
observer
  
.
  !
OnNext
! '
(
' (
evt
( +
)
+ ,
;
, -
return
‘‘ 
Task
‘‘ #
.
‘‘# $
CompletedTask
‘‘$ 1
;
‘‘1 2
}
’’ 
,
’’ "
SubscriptionLifetime
““ (
.
““( )
Scoped
““) /
)
““/ 0
;
““0 1
}
”” 
)
”” 
;
”” 
IObservable
–– 
<
–– "
ConnectivitySnapshot
–– (
>
––( )
internetSnapshots
––* ;
=
––< =#
connectivitySnapshots
––> S
.
—— 
Where
—— 
(
—— 
snapshot
—— 
=>
—— 
snapshot
—— '
.
——' (
Source
——( .
==
——/ 1 
ConnectivitySource
——2 D
.
——D E
InternetProbe
——E R
)
——R S
;
——S T
IObservable
™™ 
<
™™ "
ConnectivitySnapshot
™™ (
>
™™( )
serverSnapshots
™™* 9
=
™™: ;#
connectivitySnapshots
™™< Q
.
šš 
Where
šš 
(
šš 
snapshot
šš 
=>
šš 
snapshot
šš '
.
šš' (
Source
šš( .
==
šš/ 1 
ConnectivitySource
šš2 D
.
ššD E

DataCenter
ššE O
)
ššO P
;
ššP Q
IObservable
œœ 
<
œœ (
DetailedConnectivityStatus
œœ .
?
œœ. /
>
œœ/ 0&
internetStatusObservable
œœ1 I
=
œœJ K
internetSnapshots
œœL ]
.
 
Select
 
(
 
MapInternetStatus
 %
)
% &
.
žž 
	StartWith
žž 
(
žž 
initialSnapshot
žž &
.
žž& '
Source
žž' -
==
žž. 0 
ConnectivitySource
žž1 C
.
žžC D
InternetProbe
žžD Q
?
ŸŸ 
MapInternetStatus
ŸŸ #
(
ŸŸ# $
initialSnapshot
ŸŸ$ 3
)
ŸŸ3 4
:
   
null
   
)
   
;
   
IObservable
¢¢ 
<
¢¢ (
DetailedConnectivityStatus
¢¢ .
?
¢¢. /
>
¢¢/ 0$
serverStatusObservable
¢¢1 G
=
¢¢H I
serverSnapshots
¢¢J Y
.
££ 
Select
££ 
(
££ 
MapServerStatus
££ #
)
££# $
.
¤¤ 
	StartWith
¤¤ 
(
¤¤ 
initialSnapshot
¤¤ &
.
¤¤& '
Source
¤¤' -
==
¤¤. 0 
ConnectivitySource
¤¤1 C
.
¤¤C D

DataCenter
¤¤D N
?
¥¥ 
MapServerStatus
¥¥ !
(
¥¥! "
initialSnapshot
¥¥" 1
)
¥¥1 2
:
¦¦ 
null
¦¦ 
)
¦¦ 
;
¦¦ 
IObservable
¨¨ 
<
¨¨ (
DetailedConnectivityStatus
¨¨ .
>
¨¨. /&
detailedStatusObservable
¨¨0 H
=
¨¨I J&
internetStatusObservable
¨¨K c
.
©© 
CombineLatest
©© 
(
©© $
serverStatusObservable
©© 1
,
©©1 2
(
©©3 4
internet
©©4 <
,
©©< =
server
©©> D
)
©©D E
=>
©©F H
{
ªª 
if
«« 
(
«« 
internet
«« 
==
«« (
DetailedConnectivityStatus
««  :
.
««: ;"
NoInternetConnection
««; O
||
««P R
internet
¬¬ 
==
¬¬ (
DetailedConnectivityStatus
¬¬  :
.
¬¬: ;(
CheckingInternetConnection
¬¬; U
)
¬¬U V
{
­­ 
return
®® 
internet
®® #
.
®®# $
Value
®®$ )
;
®®) *
}
¯¯ 
if
±± 
(
±± 
server
±± 
.
±± 
HasValue
±± #
)
±±# $
{
²² 
return
³³ 
server
³³ !
.
³³! "
Value
³³" '
;
³³' (
}
´´ 
return
¶¶ (
DetailedConnectivityStatus
¶¶ 1
.
¶¶1 2"
NoInternetConnection
¶¶2 F
;
¶¶F G
}
·· 
)
·· 
.
¸¸ "
DistinctUntilChanged
¸¸ !
(
¸¸! "
)
¸¸" #
;
¸¸# $
IObservable
ºº 
<
ºº '
ConnectivityIssueCategory
ºº -
>
ºº- .%
issueCategoryObservable
ºº/ F
=
ººG H&
detailedStatusObservable
ººI a
.
»» 
Select
»» 
(
»» 
status
»» 
=>
»» 
status
»» $
switch
»»% +
{
¼¼ (
DetailedConnectivityStatus
½½ *
.
½½* +"
NoInternetConnection
½½+ ?
or
½½@ B(
DetailedConnectivityStatus
¾¾ *
.
¾¾* +(
CheckingInternetConnection
¾¾+ E
or
¾¾F H(
DetailedConnectivityStatus
¿¿ *
.
¿¿* +
InternetRestored
¿¿+ ;
=>
¿¿< >'
ConnectivityIssueCategory
¿¿? X
.
¿¿X Y!
InternetUnavailable
¿¿Y l
,
¿¿l m
_
ÀÀ 
=>
ÀÀ '
ConnectivityIssueCategory
ÀÀ .
.
ÀÀ. /
ServerUnreachable
ÀÀ/ @
}
ÁÁ 
)
ÁÁ 
.
ÂÂ "
DistinctUntilChanged
ÂÂ !
(
ÂÂ! "
)
ÂÂ" #
;
ÂÂ# $
IObservable
ÄÄ 
<
ÄÄ 
string
ÄÄ 
>
ÄÄ '
retryButtonTextObservable
ÄÄ 5
=
ÄÄ6 7
languageTrigger
ÄÄ8 G
.
ÅÅ 
Select
ÅÅ 
(
ÅÅ 
_
ÅÅ 
=>
ÅÅ &
GetCachedRetryButtonText
ÅÅ 1
(
ÅÅ1 2
)
ÅÅ2 3
)
ÅÅ3 4
;
ÅÅ4 5
IObservable
ÇÇ 
<
ÇÇ 
string
ÇÇ 
>
ÇÇ "
statusTextObservable
ÇÇ 0
=
ÇÇ1 2&
detailedStatusObservable
ÇÇ3 K
.
ÈÈ 
CombineLatest
ÈÈ 
(
ÈÈ 
languageTrigger
ÈÈ *
,
ÈÈ* +
(
ÈÈ, -
status
ÈÈ- 3
,
ÈÈ3 4
_
ÈÈ5 6
)
ÈÈ6 7
=>
ÈÈ8 :
GetStatusText
ÈÈ; H
(
ÈÈH I
status
ÈÈI O
)
ÈÈO P
)
ÈÈP Q
;
ÈÈQ R
IObservable
ÊÊ 
<
ÊÊ 
string
ÊÊ 
>
ÊÊ )
statusDescriptionObservable
ÊÊ 7
=
ÊÊ8 9&
detailedStatusObservable
ÊÊ: R
.
ËË 
CombineLatest
ËË 
(
ËË 
languageTrigger
ËË *
,
ËË* +
(
ËË, -
status
ËË- 3
,
ËË3 4
_
ËË5 6
)
ËË6 7
=>
ËË8 :"
GetStatusDescription
ËË; O
(
ËËO P
status
ËËP V
)
ËËV W
)
ËËW X
;
ËËX Y
IObservable
ÍÍ 
<
ÍÍ 
Bitmap
ÍÍ 
?
ÍÍ 
>
ÍÍ "
statusIconObservable
ÍÍ 1
=
ÍÍ2 3%
issueCategoryObservable
ÍÍ4 K
.
ÎÎ 
Select
ÎÎ 
(
ÎÎ 
LoadCachedBitmap
ÎÎ $
)
ÎÎ$ %
;
ÎÎ% &
IObservable
ÐÐ 
<
ÐÐ 
bool
ÐÐ 
>
ÐÐ '
showRetryButtonObservable
ÐÐ 3
=
ÐÐ4 5

Observable
ÐÐ6 @
.
ÐÐ@ A
Merge
ÐÐA F
(
ÐÐF G#
connectivitySnapshots
ÑÑ %
.
ÒÒ 
Where
ÒÒ 
(
ÒÒ 
snapshot
ÒÒ #
=>
ÒÒ$ &
snapshot
ÒÒ' /
.
ÒÒ/ 0
Status
ÒÒ0 6
==
ÒÒ7 9 
ConnectivityStatus
ÒÒ: L
.
ÒÒL M
RetriesExhausted
ÒÒM ]
)
ÒÒ] ^
.
ÓÓ 
Do
ÓÓ 
(
ÓÓ 
_
ÓÓ 
=>
ÓÓ  
LogRetryButtonShow
ÓÓ /
(
ÓÓ/ 0
)
ÓÓ0 1
)
ÓÓ1 2
.
ÔÔ 
Select
ÔÔ 
(
ÔÔ 
_
ÔÔ 
=>
ÔÔ  
true
ÔÔ! %
)
ÔÔ% &
,
ÔÔ& '
manualRetryEvents
ÕÕ !
.
ÖÖ 
Do
ÖÖ 
(
ÖÖ 
_
ÖÖ 
=>
ÖÖ &
LogRetryButtonManualHide
ÖÖ 5
(
ÖÖ5 6
)
ÖÖ6 7
)
ÖÖ7 8
.
×× 
Select
×× 
(
×× 
_
×× 
=>
××  
false
××! &
)
××& '
,
××' (#
connectivitySnapshots
ØØ %
.
ÙÙ 
Where
ÙÙ 
(
ÙÙ 
snapshot
ÙÙ #
=>
ÙÙ$ &
snapshot
ÙÙ' /
.
ÙÙ/ 0
Status
ÙÙ0 6
==
ÙÙ7 9 
ConnectivityStatus
ÙÙ: L
.
ÙÙL M
	Connected
ÙÙM V
)
ÙÙV W
.
ÚÚ 
Do
ÚÚ 
(
ÚÚ *
LogRetryButtonConnectionHide
ÚÚ 4
)
ÚÚ4 5
.
ÛÛ 
Select
ÛÛ 
(
ÛÛ 
_
ÛÛ 
=>
ÛÛ  
false
ÛÛ! &
)
ÛÛ& '
)
ÜÜ 
.
ÝÝ 
	StartWith
ÝÝ 
(
ÝÝ 
false
ÝÝ 
)
ÝÝ 
;
ÝÝ 
IObservable
ßß 
<
ßß 
bool
ßß 
>
ßß !
isVisibleObservable
ßß -
=
ßß. /#
connectivitySnapshots
ßß0 E
.
àà 
Select
àà 
(
àà 
snapshot
àà 
=>
àà 
snapshot
àà  (
.
àà( )
Status
àà) /
switch
àà0 6
{
áá  
ConnectivityStatus
ââ "
.
ââ" #
	Connected
ââ# ,
when
ââ- 1
snapshot
ââ2 :
.
ââ: ;
Source
ââ; A
==
ââB D 
ConnectivitySource
ââE W
.
ââW X
InternetProbe
ââX e
=>
ââf h

Observable
ââi s
.
ãã 
Return
ãã 
(
ãã 
false
ãã !
)
ãã! "
,
ãã" # 
ConnectivityStatus
ää "
.
ää" #
	Connected
ää# ,
=>
ää- /

Observable
ää0 :
.
ää: ;
Return
ää; A
(
ääA B
true
ääB F
)
ääF G
.
åå 
Delay
åå 
(
åå 
TimeSpan
åå #
.
åå# $
FromMilliseconds
åå$ 4
(
åå4 5$
NetworkStatusConstants
åå5 K
.
ååK L 
AUTO_HIDE_DELAY_MS
ååL ^
)
åå^ _
)
åå_ `
.
ææ 
Select
ææ 
(
ææ 
_
ææ 
=>
ææ  
false
ææ! &
)
ææ& '
,
ææ' ( 
ConnectivityStatus
çç "
.
çç" #
RetriesExhausted
çç# 3
or
çç4 6 
ConnectivityStatus
èè &
.
èè& '
Disconnected
èè' 3
or
èè4 6 
ConnectivityStatus
éé &
.
éé& '
ShuttingDown
éé' 3
or
éé4 6 
ConnectivityStatus
êê &
.
êê& '

Recovering
êê' 1
=>
êê2 4

Observable
êê5 ?
.
êê? @
Return
êê@ F
(
êêF G
true
êêG K
)
êêK L
,
êêL M 
ConnectivityStatus
ëë "
.
ëë" #
Unavailable
ëë# .
=>
ëë/ 1

Observable
ëë2 <
.
ëë< =
Return
ëë= C
(
ëëC D
true
ëëD H
)
ëëH I
,
ëëI J 
ConnectivityStatus
ìì "
.
ìì" #

Connecting
ìì# -
when
ìì. 2
snapshot
ìì3 ;
.
ìì; <
Source
ìì< B
==
ììC E 
ConnectivitySource
ììF X
.
ììX Y
InternetProbe
ììY f
&&
íí3 5
snapshot
íí6 >
.
íí> ?
Reason
íí? E
==
ííF H 
ConnectivityReason
ííI [
.
íí[ \
InternetRecovered
íí\ m
=>
íín p

Observable
îî 
.
îî 
Return
îî %
(
îî% &
false
îî& +
)
îî+ ,
,
îî, - 
ConnectivityStatus
ïï "
.
ïï" #

Connecting
ïï# -
when
ïï. 2
snapshot
ïï3 ;
.
ïï; <
Source
ïï< B
==
ïïC E 
ConnectivitySource
ïïF X
.
ïïX Y
InternetProbe
ïïY f
=>
ïïg i

Observable
ïïj t
.
ðð 
Return
ðð 
(
ðð 
true
ðð  
)
ðð  !
,
ðð! " 
ConnectivityStatus
ññ "
.
ññ" #

Connecting
ññ# -
=>
ññ. 0

Observable
ññ1 ;
.
ññ; <
Empty
ññ< A
<
ññA B
bool
ññB F
>
ññF G
(
ññG H
)
ññH I
,
ññI J
_
òò 
=>
òò 

Observable
òò 
.
òò  
Return
òò  &
(
òò& '
false
òò' ,
)
òò, -
}
óó 
)
óó 
.
ôô 
Switch
ôô 
(
ôô 
)
ôô 
.
õõ 
	StartWith
õõ 
(
õõ 
false
õõ 
)
õõ 
;
õõ 
_issueCategory
÷÷ 
=
÷÷ %
issueCategoryObservable
÷÷ 0
.
÷÷0 1

ToProperty
÷÷1 ;
(
÷÷; <
this
÷÷< @
,
÷÷@ A
x
÷÷B C
=>
÷÷D F
x
÷÷G H
.
÷÷H I
IssueCategory
÷÷I V
)
÷÷V W
.
÷÷W X
DisposeWith
÷÷X c
(
÷÷c d
_disposables
÷÷d p
)
÷÷p q
;
÷÷q r
_detailedStatus
øø 
=
øø &
detailedStatusObservable
øø 2
.
øø2 3

ToProperty
øø3 =
(
øø= >
this
øø> B
,
øøB C
x
øøD E
=>
øøF H
x
øøI J
.
øøJ K
DetailedStatus
øøK Y
)
øøY Z
.
øøZ [
DisposeWith
øø[ f
(
øøf g
_disposables
øøg s
)
øøs t
;
øøt u
_statusText
ùù 
=
ùù "
statusTextObservable
ùù *
.
ùù* +

ToProperty
ùù+ 5
(
ùù5 6
this
ùù6 :
,
ùù: ;
x
ùù< =
=>
ùù> @
x
ùùA B
.
ùùB C

StatusText
ùùC M
)
ùùM N
.
ùùN O
DisposeWith
ùùO Z
(
ùùZ [
_disposables
ùù[ g
)
ùùg h
;
ùùh i 
_statusDescription
úú 
=
úú )
statusDescriptionObservable
úú 8
.
úú8 9

ToProperty
úú9 C
(
úúC D
this
úúD H
,
úúH I
x
úúJ K
=>
úúL N
x
úúO P
.
úúP Q
StatusDescription
úúQ b
)
úúb c
.
ûû 
DisposeWith
ûû 
(
ûû 
_disposables
ûû %
)
ûû% &
;
ûû& '
_statusIconSource
üü 
=
üü "
statusIconObservable
üü 0
.
üü0 1

ToProperty
üü1 ;
(
üü; <
this
üü< @
,
üü@ A
x
üüB C
=>
üüD F
x
üüG H
.
üüH I
StatusIconSource
üüI Y
)
üüY Z
.
üüZ [
DisposeWith
üü[ f
(
üüf g
_disposables
üüg s
)
üüs t
;
üüt u
_showRetryButton
ýý 
=
ýý '
showRetryButtonObservable
ýý 4
.
ýý4 5

ToProperty
ýý5 ?
(
ýý? @
this
ýý@ D
,
ýýD E
x
ýýF G
=>
ýýH J
x
ýýK L
.
ýýL M
ShowRetryButton
ýýM \
)
ýý\ ]
.
ýý] ^
DisposeWith
ýý^ i
(
ýýi j
_disposables
ýýj v
)
ýýv w
;
ýýw x

_isVisible
þþ 
=
þþ !
isVisibleObservable
þþ (
.
þþ( )

ToProperty
þþ) 3
(
þþ3 4
this
þþ4 8
,
þþ8 9
x
þþ: ;
=>
þþ< >
x
þþ? @
.
þþ@ A
	IsVisible
þþA J
)
þþJ K
.
þþK L
DisposeWith
þþL W
(
þþW X
_disposables
þþX d
)
þþd e
;
þþe f
_isAnimating
ÿÿ 
=
ÿÿ 

Observable
ÿÿ !
.
ÿÿ! "
Return
ÿÿ" (
(
ÿÿ( )
false
ÿÿ) .
)
ÿÿ. /
.
ÿÿ/ 0

ToProperty
ÿÿ0 :
(
ÿÿ: ;
this
ÿÿ; ?
,
ÿÿ? @
x
ÿÿA B
=>
ÿÿC E
x
ÿÿF G
.
ÿÿG H
IsAnimating
ÿÿH S
)
ÿÿS T
.
ÿÿT U
DisposeWith
ÿÿU `
(
ÿÿ` a
_disposables
ÿÿa m
)
ÿÿm n
;
ÿÿn o
_retryButtonText
€€ 
=
€€ '
retryButtonTextObservable
€€ 4
.
€€4 5

ToProperty
€€5 ?
(
€€? @
this
€€@ D
,
€€D E
x
€€F G
=>
€€H J
x
€€K L
.
€€L M
RetryButtonText
€€M \
)
€€\ ]
.
€€] ^
DisposeWith
€€^ i
(
€€i j
_disposables
€€j v
)
€€v w
;
€€w x
RetryCommand
‚‚ 
=
‚‚ 
ReactiveCommand
‚‚ &
.
‚‚& '
CreateFromTask
‚‚' 5
(
‚‚5 6
async
ƒƒ 
ct
ƒƒ 
=>
ƒƒ 
{
„„ 
try
…… 
{
†† 
Log
‡‡ 
.
‡‡ 
Information
‡‡ #
(
‡‡# $
$str
‡‡$ g
)
‡‡g h
;
‡‡h i
await
‰‰ !
connectivityService
‰‰ -
.
‰‰- .%
RequestManualRetryAsync
‰‰. E
(
‰‰E F
)
‰‰F G
;
‰‰G H
int
‹‹ 
retriedCount
‹‹ $
=
‹‹% &
await
‹‹' ,#
pendingRequestManager
‹‹- B
.
‹‹B C*
RetryAllPendingRequestsAsync
‹‹C _
(
‹‹_ `
ct
‹‹` b
)
‹‹b c
;
‹‹c d
Log
ŒŒ 
.
ŒŒ 
Information
ŒŒ #
(
ŒŒ# $
$str
ŒŒ$ f
,
ŒŒf g
retriedCount
ŒŒh t
)
ŒŒt u
;
ŒŒu v
}
 
catch
ŽŽ 
(
ŽŽ 
	Exception
ŽŽ  
ex
ŽŽ! #
)
ŽŽ# $
{
 
Log
 
.
 
Error
 
(
 
ex
  
,
  !
$str
" G
)
G H
;
H I
}
‘‘ 
}
’’ 
,
’’ '
showRetryButtonObservable
““ %
)
”” 	
.
””	 

DisposeWith
””
 
(
”” 
_disposables
”” "
)
””" #
;
””# $#
connectivitySnapshots
–– 
.
—— 
	ObserveOn
—— 
(
—— 
RxApp
—— 
.
—— 
TaskpoolScheduler
—— .
)
——. /
.
˜˜ 
	Subscribe
˜˜ 
(
˜˜ 
snapshot
˜˜ 
=>
˜˜  "
{
™™ 
LogNetworkEvent
šš 
(
šš  
snapshot
šš  (
)
šš( )
;
šš) *-
HandleConnectivityVisualEffects
›› /
(
››/ 0
snapshot
››0 8
)
››8 9
;
››9 :
}
œœ 
)
œœ 
.
 
DisposeWith
 
(
 
_disposables
 %
)
% &
;
& '!
isVisibleObservable
ŸŸ 
.
   "
DistinctUntilChanged
   !
(
  ! "
)
  " #
.
¡¡ 
	ObserveOn
¡¡ 
(
¡¡ 
RxApp
¡¡ 
.
¡¡ 
TaskpoolScheduler
¡¡ .
)
¡¡. /
.
¢¢ 
	Subscribe
¢¢ 
(
¢¢ 
visible
¢¢ 
=>
¢¢ !
{
¢¢" #)
HandleVisibilityChangeAsync
¢¢$ ?
(
¢¢? @
visible
¢¢@ G
)
¢¢G H
.
¢¢H I
ConfigureAwait
¢¢I W
(
¢¢W X
false
¢¢X ]
)
¢¢] ^
;
¢¢^ _
}
¢¢` a
)
¢¢a b
.
££ 
DisposeWith
££ 
(
££ 
_disposables
££ %
)
££% &
;
££& '
}
¤¤ 
private
¦¦ %
CancellationTokenSource
¦¦ #
?
¦¦# $-
_visibilityOperationTokenSource
¦¦% D
;
¦¦D E
private
¨¨ 
void
¨¨ 
ClearStringCache
¨¨ !
(
¨¨! "
)
¨¨" #
{
©©  
_cachedStatusTexts
ªª 
.
ªª 
Clear
ªª  
(
ªª  !
)
ªª! "
;
ªª" #'
_cachedStatusDescriptions
«« !
.
««! "
Clear
««" '
(
««' (
)
««( )
;
««) *$
_cachedRetryButtonText
¬¬ 
=
¬¬  
null
¬¬! %
;
¬¬% &
}
­­ 
private
¯¯ 
async
¯¯ 
Task
¯¯ )
HandleVisibilityChangeAsync
¯¯ 2
(
¯¯2 3
bool
¯¯3 7
visible
¯¯8 ?
)
¯¯? @
{
°° 
await
±± 

Dispatcher
±± 
.
±± 
UIThread
±± !
.
±±! "
InvokeAsync
±±" -
(
±±- .
async
±±. 3
(
±±4 5
)
±±5 6
=>
±±7 9
{
²² 	%
CancellationTokenSource
³³ #
?
³³# $!
previousTokenSource
³³% 8
=
³³9 :-
_visibilityOperationTokenSource
³³; Z
;
³³Z [%
CancellationTokenSource
´´ #
newTokenSource
´´$ 2
=
´´3 4
new
´´5 8
(
´´8 9
)
´´9 :
;
´´: ;-
_visibilityOperationTokenSource
µµ +
=
µµ, -
newTokenSource
µµ. <
;
µµ< =
try
·· 
{
¸¸ !
previousTokenSource
¹¹ #
?
¹¹# $
.
¹¹$ %
Cancel
¹¹% +
(
¹¹+ ,
)
¹¹, -
;
¹¹- .!
LogVisibilityChange
ºº #
(
ºº# $
visible
ºº$ +
)
ºº+ ,
;
ºº, -
if
¼¼ 
(
¼¼ 
visible
¼¼ 
)
¼¼ 
{
½½ 
await
¾¾ 
	ShowAsync
¾¾ #
(
¾¾# $
newTokenSource
¾¾$ 2
.
¾¾2 3
Token
¾¾3 8
)
¾¾8 9
;
¾¾9 :
}
¿¿ 
else
ÀÀ 
{
ÁÁ 
await
ÂÂ 
	HideAsync
ÂÂ #
(
ÂÂ# $
newTokenSource
ÂÂ$ 2
.
ÂÂ2 3
Token
ÂÂ3 8
)
ÂÂ8 9
;
ÂÂ9 :
}
ÃÃ 
}
ÄÄ 
catch
ÅÅ 
(
ÅÅ (
OperationCanceledException
ÅÅ -
)
ÅÅ- .
{
ÆÆ #
LogOperationCancelled
ÇÇ %
(
ÇÇ% &
)
ÇÇ& '
;
ÇÇ' (
}
ÈÈ 
catch
ÉÉ 
(
ÉÉ 
	Exception
ÉÉ 
ex
ÉÉ 
)
ÉÉ  
{
ÊÊ 
Log
ËË 
.
ËË 
Error
ËË 
(
ËË 
ex
ËË 
,
ËË 
$str
ËË F
)
ËËF G
;
ËËG H
}
ÌÌ 
finally
ÍÍ 
{
ÎÎ 
if
ÏÏ 
(
ÏÏ -
_visibilityOperationTokenSource
ÏÏ 3
==
ÏÏ4 6
newTokenSource
ÏÏ7 E
)
ÏÏE F
{
ÐÐ -
_visibilityOperationTokenSource
ÑÑ 3
=
ÑÑ4 5
null
ÑÑ6 :
;
ÑÑ: ;
}
ÒÒ 
newTokenSource
ÔÔ 
.
ÔÔ 
Dispose
ÔÔ &
(
ÔÔ& '
)
ÔÔ' (
;
ÔÔ( )!
previousTokenSource
ÕÕ #
?
ÕÕ# $
.
ÕÕ$ %
Dispose
ÕÕ% ,
(
ÕÕ, -
)
ÕÕ- .
;
ÕÕ. /
}
ÖÖ 
}
×× 	
)
××	 

;
××
 
}
ØØ 
private
ÚÚ 
void
ÚÚ -
HandleConnectivityVisualEffects
ÚÚ 0
(
ÚÚ0 1"
ConnectivitySnapshot
ÚÚ1 E
snapshot
ÚÚF N
)
ÚÚN O
{
ÛÛ 
bool
ÜÜ 
isServerIssue
ÜÜ 
=
ÜÜ 
snapshot
ÜÜ %
.
ÜÜ% &
Status
ÜÜ& ,
is
ÜÜ- / 
ConnectivityStatus
ÜÜ0 B
.
ÜÜB C
RetriesExhausted
ÜÜC S
or
ÝÝ  
ConnectivityStatus
ÝÝ !
.
ÝÝ! "
Disconnected
ÝÝ" .
or
ÞÞ  
ConnectivityStatus
ÞÞ !
.
ÞÞ! "
ShuttingDown
ÞÞ" .
;
ÞÞ. /

Dispatcher
ßß 
.
ßß 
UIThread
ßß 
.
ßß 
InvokeAsync
ßß '
(
ßß' (
(
ßß( )
)
ßß) *
=>
ßß+ -
ApplyClasses
ßß. :
(
ßß: ;
serverIssue
ßß; F
:
ßßF G
isServerIssue
ßßH U
)
ßßU V
)
ßßV W
;
ßßW X
}
àà 
private
ââ 
void
ââ 
ApplyClasses
ââ 
(
ââ 
bool
ââ "
serverIssue
ââ# .
)
ââ. /
{
ãã 
if
ää 

(
ää 
_mainBorder
ää 
==
ää 
null
ää 
)
ää  
{
åå 	
return
ææ 
;
ææ 
}
çç 	
if
éé 

(
éé 
serverIssue
éé 
)
éé 
{
êê 	
_mainBorder
ëë 
.
ëë 
Classes
ëë 
.
ëë  
Add
ëë  #
(
ëë# $
$str
ëë$ 1
)
ëë1 2
;
ëë2 3
}
ìì 	
else
íí 
{
îî 	
_mainBorder
ïï 
.
ïï 
Classes
ïï 
.
ïï  
Remove
ïï  &
(
ïï& '
$str
ïï' 4
)
ïï4 5
;
ïï5 6
}
ðð 	
_mainBorder
òò 
.
òò 
Classes
òò 
.
òò 
Remove
òò "
(
òò" #
$str
òò# -
)
òò- .
;
òò. /
}
óó 
private
õõ 
static
õõ 
	Animation
õõ #
CreateAppearAnimation
õõ 2
(
õõ2 3
)
õõ3 4
=>
õõ5 7
new
õõ8 ;
(
õõ; <
)
õõ< =
{
öö 
Duration
÷÷ 
=
÷÷ 
TimeSpan
÷÷ 
.
÷÷ 
FromMilliseconds
÷÷ ,
(
÷÷, -$
NetworkStatusConstants
÷÷- C
.
÷÷C D(
DEFAULT_APPEAR_DURATION_MS
÷÷D ^
)
÷÷^ _
,
÷÷_ `
Easing
øø 
=
øø 
new
øø 
QuadraticEaseOut
øø %
(
øø% &
)
øø& '
,
øø' (
FillMode
ùù 
=
ùù 
FillMode
ùù 
.
ùù 
Both
ùù  
,
ùù  !
Children
úú 
=
úú 
{
ûû 	
new
üü 
KeyFrame
üü 
{
ýý 
Cue
þþ 
=
þþ 
new
þþ 
Cue
þþ 
(
þþ 
$num
þþ  
)
þþ  !
,
þþ! "
Setters
ÿÿ 
=
ÿÿ 
{
ÿÿ 
new
ÿÿ 
Setter
ÿÿ  &
(
ÿÿ& '
Visual
ÿÿ' -
.
ÿÿ- .
OpacityProperty
ÿÿ. =
,
ÿÿ= >
$num
ÿÿ? A
)
ÿÿA B
,
ÿÿB C
new
ÿÿD G
Setter
ÿÿH N
(
ÿÿN O 
TranslateTransform
ÿÿO a
.
ÿÿa b
	YProperty
ÿÿb k
,
ÿÿk l
-
ÿÿm n
$num
ÿÿn q
)
ÿÿq r
}
ÿÿs t
}
€€ 
,
€€ 
new
 
KeyFrame
 
{
‚‚ 
Cue
ƒƒ 
=
ƒƒ 
new
ƒƒ 
Cue
ƒƒ 
(
ƒƒ 
$num
ƒƒ  
)
ƒƒ  !
,
ƒƒ! "
Setters
„„ 
=
„„ 
{
„„ 
new
„„ 
Setter
„„  &
(
„„& '
Visual
„„' -
.
„„- .
OpacityProperty
„„. =
,
„„= >
$num
„„? A
)
„„A B
,
„„B C
new
„„D G
Setter
„„H N
(
„„N O 
TranslateTransform
„„O a
.
„„a b
	YProperty
„„b k
,
„„k l
$num
„„m o
)
„„o p
}
„„q r
}
…… 
}
†† 	
}
‡‡ 
;
‡‡ 
private
‰‰ 
static
‰‰ 
	Animation
‰‰ &
CreateDisappearAnimation
‰‰ 5
(
‰‰5 6
)
‰‰6 7
=>
‰‰8 :
new
‰‰; >
(
‰‰> ?
)
‰‰? @
{
ŠŠ 
Duration
‹‹ 
=
‹‹ 
TimeSpan
‹‹ 
.
‹‹ 
FromMilliseconds
‹‹ ,
(
‹‹, -$
NetworkStatusConstants
‹‹- C
.
‹‹C D+
DEFAULT_DISAPPEAR_DURATION_MS
‹‹D a
)
‹‹a b
,
‹‹b c
Easing
ŒŒ 
=
ŒŒ 
new
ŒŒ 
QuadraticEaseIn
ŒŒ $
(
ŒŒ$ %
)
ŒŒ% &
,
ŒŒ& '
FillMode
 
=
 
FillMode
 
.
 
Both
  
,
  !
Children
ŽŽ 
=
ŽŽ 
{
 	
new
 
KeyFrame
 
{
‘‘ 
Cue
’’ 
=
’’ 
new
’’ 
Cue
’’ 
(
’’ 
$num
’’  
)
’’  !
,
’’! "
Setters
““ 
=
““ 
{
““ 
new
““ 
Setter
““  &
(
““& '
Visual
““' -
.
““- .
OpacityProperty
““. =
,
““= >
$num
““? A
)
““A B
,
““B C
new
““D G
Setter
““H N
(
““N O 
TranslateTransform
““O a
.
““a b
	YProperty
““b k
,
““k l
$num
““m o
)
““o p
}
““q r
}
”” 
,
”” 
new
•• 
KeyFrame
•• 
{
–– 
Cue
—— 
=
—— 
new
—— 
Cue
—— 
(
—— 
$num
——  
)
——  !
,
——! "
Setters
˜˜ 
=
˜˜ 
{
˜˜ 
new
˜˜ 
Setter
˜˜  &
(
˜˜& '
Visual
˜˜' -
.
˜˜- .
OpacityProperty
˜˜. =
,
˜˜= >
$num
˜˜? A
)
˜˜A B
,
˜˜B C
new
˜˜D G
Setter
˜˜H N
(
˜˜N O 
TranslateTransform
˜˜O a
.
˜˜a b
	YProperty
˜˜b k
,
˜˜k l
-
˜˜m n
$num
˜˜n q
)
˜˜q r
}
˜˜s t
}
™™ 
}
šš 	
}
›› 
;
›› 
private
 
void
 
CreateAnimations
 !
(
! "
)
" #
{
žž 
if
ŸŸ 

(
ŸŸ 
_view
ŸŸ 
==
ŸŸ 
null
ŸŸ 
)
ŸŸ 
{
   	
return
¡¡ 
;
¡¡ 
}
¢¢ 	'
_sharedTranslateTransform
¤¤ !
??=
¤¤" %
new
¤¤& ) 
TranslateTransform
¤¤* <
(
¤¤< =
)
¤¤= >
;
¤¤> ?
}
¥¥ 
private
§§ 
async
§§ 
Task
§§ 
	ShowAsync
§§  
(
§§  !
CancellationToken
§§! 2
token
§§3 8
)
§§8 9
{
¨¨ 
if
©© 

(
©© 
_view
©© 
==
©© 
null
©© 
)
©© 
{
ªª 	
return
«« 
;
«« 
}
¬¬ 	
try
®® 
{
¯¯ 	
_view
°° 
.
°° 
	IsVisible
°° 
=
°° 
true
°° "
;
°°" #
_view
±± 
.
±± 
RenderTransform
±± !
=
±±" #'
_sharedTranslateTransform
±±$ =
;
±±= >
CreateAnimations
²² 
(
²² 
)
²² 
;
²² 
await
³³ $
_sharedAppearAnimation
³³ (
.
³³( )
Value
³³) .
.
³³. /
RunAsync
³³/ 7
(
³³7 8
_view
³³8 =
,
³³= >
token
³³? D
)
³³D E
;
³³E F
}
´´ 	
catch
µµ 
(
µµ (
OperationCanceledException
µµ )
)
µµ) *
{
¶¶ 	
}
¸¸ 	
catch
¹¹ 
(
¹¹ 
	Exception
¹¹ 
ex
¹¹ 
)
¹¹ 
{
ºº 	
Log
»» 
.
»» 
Warning
»» 
(
»» 
ex
»» 
,
»» 
$str
»» >
)
»»> ?
;
»»? @
}
¼¼ 	
}
½½ 
private
¿¿ 
async
¿¿ 
Task
¿¿ 
	HideAsync
¿¿  
(
¿¿  !
CancellationToken
¿¿! 2
token
¿¿3 8
)
¿¿8 9
{
ÀÀ 
if
ÁÁ 

(
ÁÁ 
_view
ÁÁ 
==
ÁÁ 
null
ÁÁ 
)
ÁÁ 
{
ÂÂ 	
return
ÃÃ 
;
ÃÃ 
}
ÄÄ 	
try
ÆÆ 
{
ÇÇ 	
CreateAnimations
ÈÈ 
(
ÈÈ 
)
ÈÈ 
;
ÈÈ 
await
ÉÉ '
_sharedDisappearAnimation
ÉÉ +
.
ÉÉ+ ,
Value
ÉÉ, 1
.
ÉÉ1 2
RunAsync
ÉÉ2 :
(
ÉÉ: ;
_view
ÉÉ; @
,
ÉÉ@ A
token
ÉÉB G
)
ÉÉG H
;
ÉÉH I
_view
ÊÊ 
.
ÊÊ 
	IsVisible
ÊÊ 
=
ÊÊ 
false
ÊÊ #
;
ÊÊ# $
}
ËË 	
catch
ÌÌ 
(
ÌÌ (
OperationCanceledException
ÌÌ )
)
ÌÌ) *
{
ÍÍ 	
}
ÏÏ 	
catch
ÐÐ 
(
ÐÐ 
	Exception
ÐÐ 
ex
ÐÐ 
)
ÐÐ 
{
ÑÑ 	
Log
ÒÒ 
.
ÒÒ 
Warning
ÒÒ 
(
ÒÒ 
ex
ÒÒ 
,
ÒÒ 
$str
ÒÒ =
)
ÒÒ= >
;
ÒÒ> ?
}
ÓÓ 	
}
ÔÔ 
private
ÖÖ 
Bitmap
ÖÖ 
?
ÖÖ 
LoadCachedBitmap
ÖÖ $
(
ÖÖ$ %'
ConnectivityIssueCategory
ÖÖ% >
category
ÖÖ? G
)
ÖÖG H
{
×× 
try
ØØ 
{
ÙÙ 	
return
ÚÚ 
category
ÚÚ 
switch
ÚÚ "
{
ÛÛ '
ConnectivityIssueCategory
ÜÜ )
.
ÜÜ) *
ServerUnreachable
ÜÜ* ;
=>
ÜÜ< >*
_cachedServerUnreachableIcon
ÜÜ? [
??=
ÜÜ\ _
LoadBitmapFromUri
ÝÝ %
(
ÝÝ% &$
NetworkStatusConstants
ÝÝ& <
.
ÝÝ< =,
SERVER_NOT_RESPONDING_ICON_URI
ÝÝ= [
)
ÝÝ[ \
,
ÝÝ\ ]
_
ÞÞ 
=>
ÞÞ ,
_cachedInternetUnavailableIcon
ÞÞ 3
??=
ÞÞ4 7
LoadBitmapFromUri
ßß %
(
ßß% &$
NetworkStatusConstants
ßß& <
.
ßß< ="
NO_INTERNET_ICON_URI
ßß= Q
)
ßßQ R
}
àà 
;
àà 
}
áá 	
catch
ââ 
(
ââ 
	Exception
ââ 
ex
ââ 
)
ââ 
{
ãã 	
Log
ää 
.
ää 
Error
ää 
(
ää 
ex
ää 
,
ää 
$str
ää Q
,
ääQ R
category
ääS [
)
ää[ \
;
ää\ ]
return
åå 
null
åå 
;
åå 
}
ææ 	
}
çç 
private
éé 
static
éé 
Bitmap
éé 
LoadBitmapFromUri
éé +
(
éé+ ,
string
éé, 2
	uriString
éé3 <
)
éé< =
{
êê 
Uri
ëë 
uri
ëë 
=
ëë 
new
ëë 
(
ëë 
	uriString
ëë 
,
ëë  
UriKind
ëë! (
.
ëë( )
Absolute
ëë) 1
)
ëë1 2
;
ëë2 3
return
ìì 
new
ìì 
Bitmap
ìì 
(
ìì 
AssetLoader
ìì %
.
ìì% &
Open
ìì& *
(
ìì* +
uri
ìì+ .
)
ìì. /
)
ìì/ 0
;
ìì0 1
}
íí 
private
ïï 
string
ïï 
GetStatusText
ïï  
(
ïï  !(
DetailedConnectivityStatus
ïï! ;
status
ïï< B
)
ïïB C
{
ðð 
if
ññ 

(
ññ  
_cachedStatusTexts
ññ 
.
ññ 
TryGetValue
ññ *
(
ññ* +
status
ññ+ 1
,
ññ1 2
out
ññ3 6
string
ññ7 =
?
ññ= >
cached
ññ? E
)
ññE F
)
ññF G
{
òò 	
return
óó 
cached
óó 
;
óó 
}
ôô 	
string
öö 
key
öö 
=
öö 
status
öö 
switch
öö "
{
÷÷ 	(
DetailedConnectivityStatus
øø &
.
øø& '"
NoInternetConnection
øø' ;
=>
øø< >
$str
øø? e
,
øøe f(
DetailedConnectivityStatus
ùù &
.
ùù& '(
CheckingInternetConnection
ùù' A
=>
ùùB D
$str
ùùE q
,
ùùq r(
DetailedConnectivityStatus
úú &
.
úú& '
InternetRestored
úú' 7
=>
úú8 :
$str
úú; g
,
úúg h(
DetailedConnectivityStatus
ûû &
.
ûû& ' 
ConnectingToServer
ûû' 9
=>
ûû: <
$str
ûû= c
,
ûûc d(
DetailedConnectivityStatus
üü &
.
üü& '
Reconnecting
üü' 3
=>
üü4 6
$str
üü7 _
,
üü_ `(
DetailedConnectivityStatus
ýý &
.
ýý& '!
ServerNotResponding
ýý' :
=>
ýý; =
$str
ýý> m
,
ýým n(
DetailedConnectivityStatus
þþ &
.
þþ& ' 
ServerShuttingDown
þþ' 9
=>
þþ: <
$str
þþ= k
,
þþk l(
DetailedConnectivityStatus
ÿÿ &
.
ÿÿ& '
RetriesExhausted
ÿÿ' 7
=>
ÿÿ8 :
$str
ÿÿ; g
,
ÿÿg h(
DetailedConnectivityStatus
€€ &
.
€€& '
ServerReconnected
€€' 8
=>
€€9 ;
$str
€€< i
,
€€i j
_
 
=>
 
$str
 7
}
‚‚ 	
;
‚‚	 

string
„„ 
text
„„ 
=
„„ !
LocalizationService
„„ )
[
„„) *
key
„„* -
]
„„- .
;
„„. / 
_cachedStatusTexts
…… 
[
…… 
status
…… !
]
……! "
=
……# $
text
……% )
;
……) *
return
†† 
text
†† 
;
†† 
}
‡‡ 
private
‰‰ 
string
‰‰ "
GetStatusDescription
‰‰ '
(
‰‰' ((
DetailedConnectivityStatus
‰‰( B
status
‰‰C I
)
‰‰I J
{
ŠŠ 
if
‹‹ 

(
‹‹ '
_cachedStatusDescriptions
‹‹ %
.
‹‹% &
TryGetValue
‹‹& 1
(
‹‹1 2
status
‹‹2 8
,
‹‹8 9
out
‹‹: =
string
‹‹> D
?
‹‹D E
cached
‹‹F L
)
‹‹L M
)
‹‹M N
{
ŒŒ 	
return
 
cached
 
;
 
}
ŽŽ 	
string
 
key
 
=
 
status
 
switch
 "
{
‘‘ 	(
DetailedConnectivityStatus
’’ &
.
’’& '"
NoInternetConnection
’’' ;
=>
’’< >
$str
’’? k
,
’’k l(
DetailedConnectivityStatus
““ &
.
““& '(
CheckingInternetConnection
““' A
=>
““B D
$str
““E w
,
““w x(
DetailedConnectivityStatus
”” &
.
””& '
InternetRestored
””' 7
=>
””8 :
$str
””; m
,
””m n(
DetailedConnectivityStatus
•• &
.
••& ' 
ConnectingToServer
••' 9
=>
••: <
$str
••= i
,
••i j(
DetailedConnectivityStatus
–– &
.
––& '
Reconnecting
––' 3
=>
––4 6
$str
––7 e
,
––e f(
DetailedConnectivityStatus
—— &
.
——& '!
ServerNotResponding
——' :
=>
——; =
$str
——> s
,
——s t(
DetailedConnectivityStatus
˜˜ &
.
˜˜& ' 
ServerShuttingDown
˜˜' 9
=>
˜˜: <
$str
˜˜= q
,
˜˜q r(
DetailedConnectivityStatus
™™ &
.
™™& '
RetriesExhausted
™™' 7
=>
™™8 :
$str
™™; m
,
™™m n(
DetailedConnectivityStatus
šš &
.
šš& '
ServerReconnected
šš' 8
=>
šš9 ;
$str
šš< o
,
ššo p
_
›› 
=>
›› 
$str
›› =
}
œœ 	
;
œœ	 

string
žž 
text
žž 
=
žž !
LocalizationService
žž )
[
žž) *
key
žž* -
]
žž- .
;
žž. /'
_cachedStatusDescriptions
ŸŸ !
[
ŸŸ! "
status
ŸŸ" (
]
ŸŸ( )
=
ŸŸ* +
text
ŸŸ, 0
;
ŸŸ0 1
return
   
text
   
;
   
}
¡¡ 
private
££ 
string
££ &
GetCachedRetryButtonText
££ +
(
££+ ,
)
££, -
=>
££. 0$
_cachedRetryButtonText
¤¤ 
??=
¤¤ "!
LocalizationService
¤¤# 6
[
¤¤6 7
$str
¤¤7 Y
]
¤¤Y Z
;
¤¤Z [
private
¦¦ 
static
¦¦ (
DetailedConnectivityStatus
¦¦ -
?
¦¦- .
MapInternetStatus
¦¦/ @
(
¦¦@ A"
ConnectivitySnapshot
¦¦A U
snapshot
¦¦V ^
)
¦¦^ _
{
§§ 
return
¨¨ 
snapshot
¨¨ 
.
¨¨ 
Status
¨¨ 
switch
¨¨ %
{
©© 	 
ConnectivityStatus
ªª 
.
ªª 
Unavailable
ªª *
=>
ªª+ -(
DetailedConnectivityStatus
ªª. H
.
ªªH I"
NoInternetConnection
ªªI ]
,
ªª] ^ 
ConnectivityStatus
¬¬ 
.
¬¬ 

Connecting
¬¬ )
when
¬¬* .
snapshot
¬¬/ 7
.
¬¬7 8
Reason
¬¬8 >
==
¬¬? A 
ConnectivityReason
¬¬B T
.
¬¬T U
InternetRecovered
¬¬U f
=>
­­ (
DetailedConnectivityStatus
­­ -
.
­­- .
InternetRestored
­­. >
,
­­> ? 
ConnectivityStatus
¯¯ 
.
¯¯ 

Connecting
¯¯ )
=>
¯¯* ,(
DetailedConnectivityStatus
¯¯- G
.
¯¯G H(
CheckingInternetConnection
¯¯H b
,
¯¯b c
_
±± 
=>
±± 
null
±± 
}
²² 	
;
²²	 

}
³³ 
private
µµ 
static
µµ (
DetailedConnectivityStatus
µµ -
?
µµ- .
MapServerStatus
µµ/ >
(
µµ> ?"
ConnectivitySnapshot
µµ? S
snapshot
µµT \
)
µµ\ ]
{
¶¶ 
return
·· 
snapshot
·· 
.
·· 
Status
·· 
switch
·· %
{
¸¸ 	 
ConnectivityStatus
¹¹ 
.
¹¹ 

Connecting
¹¹ )
=>
¹¹* ,(
DetailedConnectivityStatus
¹¹- G
.
¹¹G H 
ConnectingToServer
¹¹H Z
,
¹¹Z [ 
ConnectivityStatus
»» 
.
»» 

Recovering
»» )
=>
»»* ,(
DetailedConnectivityStatus
»»- G
.
»»G H
Reconnecting
»»H T
,
»»T U 
ConnectivityStatus
½½ 
.
½½ 
RetriesExhausted
½½ /
=>
½½0 2(
DetailedConnectivityStatus
½½3 M
.
½½M N
RetriesExhausted
½½N ^
,
½½^ _ 
ConnectivityStatus
¿¿ 
.
¿¿ 
ShuttingDown
¿¿ +
=>
¿¿, .(
DetailedConnectivityStatus
¿¿/ I
.
¿¿I J 
ServerShuttingDown
¿¿J \
,
¿¿\ ] 
ConnectivityStatus
ÁÁ 
.
ÁÁ 
Disconnected
ÁÁ +
=>
ÁÁ, .(
DetailedConnectivityStatus
ÁÁ/ I
.
ÁÁI J!
ServerNotResponding
ÁÁJ ]
,
ÁÁ] ^ 
ConnectivityStatus
ÃÃ 
.
ÃÃ 
	Connected
ÃÃ (
=>
ÃÃ) +(
DetailedConnectivityStatus
ÃÃ, F
.
ÃÃF G
ServerReconnected
ÃÃG X
,
ÃÃX Y
_
ÅÅ 
=>
ÅÅ 
null
ÅÅ 
}
ÆÆ 	
;
ÆÆ	 

}
ÇÇ 
public
ÉÉ 

void
ÉÉ 
Dispose
ÉÉ 
(
ÉÉ 
)
ÉÉ 
{
ÊÊ 
if
ËË 

(
ËË 
	_disposed
ËË 
)
ËË 
{
ÌÌ 	
return
ÍÍ 
;
ÍÍ 
}
ÎÎ 	
try
ÐÐ 
{
ÑÑ 	-
_visibilityOperationTokenSource
ÒÒ +
?
ÒÒ+ ,
.
ÒÒ, -
Cancel
ÒÒ- 3
(
ÒÒ3 4
)
ÒÒ4 5
;
ÒÒ5 6
}
ÓÓ 	
catch
ÔÔ 
(
ÔÔ %
ObjectDisposedException
ÔÔ &
)
ÔÔ& '
{
ÕÕ 	
}
×× 	
finally
ØØ 
{
ÙÙ 	-
_visibilityOperationTokenSource
ÚÚ +
?
ÚÚ+ ,
.
ÚÚ, -
Dispose
ÚÚ- 4
(
ÚÚ4 5
)
ÚÚ5 6
;
ÚÚ6 7-
_visibilityOperationTokenSource
ÛÛ +
=
ÛÛ, -
null
ÛÛ. 2
;
ÛÛ2 3
}
ÜÜ 	
_disposables
ÞÞ 
.
ÞÞ 
Dispose
ÞÞ 
(
ÞÞ 
)
ÞÞ 
;
ÞÞ $
_statusUpdateSemaphore
ßß 
.
ßß 
Dispose
ßß &
(
ßß& '
)
ßß' (
;
ßß( ),
_cachedInternetUnavailableIcon
áá &
?
áá& '
.
áá' (
Dispose
áá( /
(
áá/ 0
)
áá0 1
;
áá1 2*
_cachedServerUnreachableIcon
ââ $
?
ââ$ %
.
ââ% &
Dispose
ââ& -
(
ââ- .
)
ââ. /
;
ââ/ 0,
_cachedInternetUnavailableIcon
ãã &
=
ãã' (
null
ãã) -
;
ãã- .*
_cachedServerUnreachableIcon
ää $
=
ää% &
null
ää' +
;
ää+ , 
_cachedStatusTexts
ææ 
.
ææ 
Clear
ææ  
(
ææ  !
)
ææ! "
;
ææ" #'
_cachedStatusDescriptions
çç !
.
çç! "
Clear
çç" '
(
çç' (
)
çç( )
;
çç) *
	_disposed
éé 
=
éé 
true
éé 
;
éé 
}
êê 
private
ìì 
static
ìì 
void
ìì  
LogRetryButtonShow
ìì *
(
ìì* +
)
ìì+ ,
{
íí 
if
îî 

(
îî 
Log
îî 
.
îî 
	IsEnabled
îî 
(
îî 
Serilog
îî !
.
îî! "
Events
îî" (
.
îî( )
LogEventLevel
îî) 6
.
îî6 7
Debug
îî7 <
)
îî< =
)
îî= >
{
ïï 	
Log
ðð 
.
ðð 
Debug
ðð 
(
ðð 
$str
ðð =
)
ðð= >
;
ðð> ?
}
ññ 	
}
òò 
private
ôô 
static
ôô 
void
ôô &
LogRetryButtonManualHide
ôô 0
(
ôô0 1
)
ôô1 2
{
õõ 
if
öö 

(
öö 
Log
öö 
.
öö 
	IsEnabled
öö 
(
öö 
Serilog
öö !
.
öö! "
Events
öö" (
.
öö( )
LogEventLevel
öö) 6
.
öö6 7
Debug
öö7 <
)
öö< =
)
öö= >
{
÷÷ 	
Log
øø 
.
øø 
Debug
øø 
(
øø 
$str
øø S
)
øøS T
;
øøT U
}
ùù 	
}
úú 
private
üü 
static
üü 
void
üü *
LogRetryButtonConnectionHide
üü 4
(
üü4 5"
ConnectivitySnapshot
üü5 I
snapshot
üüJ R
)
üüR S
{
ýý 
if
þþ 

(
þþ 
Log
þþ 
.
þþ 
	IsEnabled
þþ 
(
þþ 
Serilog
þþ !
.
þþ! "
Events
þþ" (
.
þþ( )
LogEventLevel
þþ) 6
.
þþ6 7
Debug
þþ7 <
)
þþ< =
)
þþ= >
{
ÿÿ 	
Log
€€ 
.
€€ 
Debug
€€ 
(
€€ 
$str
€€ _
,
€€_ `
snapshot
 
.
 
Status
 
,
  
snapshot
! )
.
) *
Reason
* 0
)
0 1
;
1 2
}
ƒƒ 	
}
„„ 
private
†† 
static
†† 
void
†† 
LogNetworkEvent
†† '
(
††' ("
ConnectivitySnapshot
††( <
snapshot
††= E
)
††E F
{
‡‡ 
if
ˆˆ 

(
ˆˆ 
Log
ˆˆ 
.
ˆˆ 
	IsEnabled
ˆˆ 
(
ˆˆ 
Serilog
ˆˆ !
.
ˆˆ! "
Events
ˆˆ" (
.
ˆˆ( )
LogEventLevel
ˆˆ) 6
.
ˆˆ6 7
Debug
ˆˆ7 <
)
ˆˆ< =
)
ˆˆ= >
{
‰‰ 	
Log
ŠŠ 
.
ŠŠ 
Debug
ŠŠ 
(
ŠŠ 
$str
ŠŠ o
,
ŠŠo p
snapshot
‹‹ 
.
‹‹ 
Status
‹‹ 
,
‹‹  
snapshot
ŒŒ 
.
ŒŒ 
Reason
ŒŒ 
,
ŒŒ  
snapshot
 
.
 
Source
 
,
  
snapshot
ŽŽ 
.
ŽŽ 
RetryAttempt
ŽŽ %
)
ŽŽ% &
;
ŽŽ& '
}
 	
}
‘‘ 
private
““ 
static
““ 
void
““ !
LogVisibilityChange
““ +
(
““+ ,
bool
““, 0
visible
““1 8
)
““8 9
{
”” 
if
•• 

(
•• 
Log
•• 
.
•• 
	IsEnabled
•• 
(
•• 
Serilog
•• !
.
••! "
Events
••" (
.
••( )
LogEventLevel
••) 6
.
••6 7
Debug
••7 <
)
••< =
)
••= >
{
–– 	
Log
—— 
.
—— 
Debug
—— 
(
—— 
$str
—— T
,
——T U
visible
——V ]
)
——] ^
;
——^ _
}
˜˜ 	
}
™™ 
private
›› 
static
›› 
void
›› #
LogOperationCancelled
›› -
(
››- .
)
››. /
{
œœ 
if
 

(
 
Log
 
.
 
	IsEnabled
 
(
 
Serilog
 !
.
! "
Events
" (
.
( )
LogEventLevel
) 6
.
6 7
Debug
7 <
)
< =
)
= >
{
žž 	
Log
ŸŸ 
.
ŸŸ 
Debug
ŸŸ 
(
ŸŸ 
$str
ŸŸ K
)
ŸŸK L
;
ŸŸL M
}
   	
}
¡¡ 
}¢¢ ˆO
Š/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Core/ConnectivityNotificationView.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Core! %
;% &
public

 
sealed

 
partial

 
class

 (
ConnectivityNotificationView

 8
:

9 :
ReactiveUserControl

; N
<

N O-
!ConnectivityNotificationViewModel

O p
>

p q
{ 
private 
const 
string "
DISCONNECTED_ICON_PATH /
=0 1
$str P
+Q R
$str	 ø
;
ø ù
public 

static 
readonly 
StyledProperty )
<) *
TimeSpan* 2
>2 3"
AppearDurationProperty4 J
=K L
AvaloniaProperty 
. 
Register !
<! "(
ConnectivityNotificationView" >
,> ?
TimeSpan@ H
>H I
(I J
nameofJ P
(P Q
AppearDurationQ _
)_ `
,` a
TimeSpan 
. 
FromMilliseconds %
(% &
$num& )
)) *
)* +
;+ ,
public 

static 
readonly 
StyledProperty )
<) *
TimeSpan* 2
>2 3%
DisappearDurationProperty4 M
=N O
AvaloniaProperty 
. 
Register !
<! "(
ConnectivityNotificationView" >
,> ?
TimeSpan@ H
>H I
(I J
nameofJ P
(P Q
DisappearDurationQ b
)b c
,c d
TimeSpan 
. 
FromMilliseconds %
(% &
$num& )
)) *
)* +
;+ ,
public 

new 
static 
readonly 
StyledProperty -
<- .
IBrush. 4
>4 5
BackgroundProperty6 H
=I J
AvaloniaProperty 
. 
Register !
<! "(
ConnectivityNotificationView" >
,> ?
IBrush@ F
>F G
(G H
nameofH N
(N O

BackgroundO Y
)Y Z
,Z [
new 
SolidColorBrush 
(  
Color  %
.% &
Parse& +
(+ ,
$str, 5
)5 6
)6 7
)7 8
;8 9
public 

static 
readonly 
StyledProperty )
<) *
IBrush* 0
>0 1 
EllipseColorProperty2 F
=G H
AvaloniaProperty 
. 
Register !
<! "(
ConnectivityNotificationView" >
,> ?
IBrush@ F
>F G
(G H
nameofH N
(N O
EllipseColorO [
)[ \
,\ ]
new 
SolidColorBrush 
(  
Color  %
.% &
Parse& +
(+ ,
$str, 5
)5 6
)6 7
)7 8
;8 9
public 

static 
readonly 
StyledProperty )
<) *
Geometry* 2
>2 3
IconDataProperty4 D
=E F
AvaloniaProperty   
.   
Register   !
<  ! "(
ConnectivityNotificationView  " >
,  > ?
Geometry  @ H
>  H I
(  I J
nameof  J P
(  P Q
IconData  Q Y
)  Y Z
)  Z [
;  [ \
public"" 

static"" 
readonly"" 
StyledProperty"" )
<"") * 
ILocalizationService""* >
>""> ?'
LocalizationServiceProperty""@ [
=""\ ]
AvaloniaProperty## 
.## 
Register## !
<##! "(
ConnectivityNotificationView##" >
,##> ? 
ILocalizationService##@ T
>##T U
(##U V
nameof##V \
(##\ ]
LocalizationService##] p
)##p q
)##q r
;##r s
public%% 
 
ILocalizationService%% 
LocalizationService%%  3
{&& 
get'' 
=>'' 
GetValue'' 
('' '
LocalizationServiceProperty'' 3
)''3 4
;''4 5
set(( 
=>(( 
SetValue(( 
((( '
LocalizationServiceProperty(( 3
,((3 4
value((5 :
)((: ;
;((; <
})) 
public++ 

new++ 
IBrush++ 

Background++  
{,, 
get-- 
=>-- 
GetValue-- 
(-- 
BackgroundProperty-- *
)--* +
;--+ ,
set.. 
=>.. 
SetValue.. 
(.. 
BackgroundProperty.. *
,..* +
value.., 1
)..1 2
;..2 3
}// 
public11 

IBrush11 
EllipseColor11 
{22 
get33 
=>33 
GetValue33 
(33  
EllipseColorProperty33 ,
)33, -
;33- .
set44 
=>44 
SetValue44 
(44  
EllipseColorProperty44 ,
,44, -
value44. 3
)443 4
;444 5
}55 
public77 

Geometry77 
IconData77 
{88 
get99 
=>99 
GetValue99 
(99 
IconDataProperty99 (
)99( )
;99) *
set:: 
=>:: 
SetValue:: 
(:: 
IconDataProperty:: (
,::( )
value::* /
)::/ 0
;::0 1
};; 
public== 

TimeSpan== 
AppearDuration== "
{>> 
get?? 
=>?? 
GetValue?? 
(?? "
AppearDurationProperty?? .
)??. /
;??/ 0
set@@ 
=>@@ 
SetValue@@ 
(@@ "
AppearDurationProperty@@ .
,@@. /
value@@0 5
)@@5 6
;@@6 7
}AA 
publicCC 

TimeSpanCC 
DisappearDurationCC %
{DD 
getEE 
=>EE 
GetValueEE 
(EE %
DisappearDurationPropertyEE 1
)EE1 2
;EE2 3
setFF 
=>FF 
SetValueFF 
(FF %
DisappearDurationPropertyFF 1
,FF1 2
valueFF3 8
)FF8 9
;FF9 :
}GG 
publicHH 
(
ConnectivityNotificationViewHH '
(HH' (
)HH( )
{II 
InitializeComponentJJ 
(JJ 
)JJ 
;JJ 
	IsVisibleKK 
=KK 
falseKK 
;KK 
SetIconLL 
(LL 
)LL 
;LL 
}MM 
privateOO 
voidOO 
SetIconOO 
(OO 
)OO 
{PP 
tryQQ 
{RR 	
IconDataSS 
=SS 
GeometrySS 
.SS  
ParseSS  %
(SS% &"
DISCONNECTED_ICON_PATHSS& <
)SS< =
;SS= >
}TT 	
catchUU 
{VV 	
IconDataWW 
=WW 
GeometryWW 
.WW  
ParseWW  %
(WW% &
$strWW& j
)WWj k
;WWk l
}XX 	
}YY 
private[[ 
void[[ 
InitializeComponent[[ $
([[$ %
)[[% &
{\\ 
AvaloniaXamlLoader]] 
.]] 
Load]] 
(]]  
this]]  $
)]]$ %
;]]% &
}^^ 
	protected`` 
override`` 
void``  
OnDataContextChanged`` 0
(``0 1
System``1 7
.``7 8
	EventArgs``8 A
e``B C
)``C D
{aa 
basebb 
.bb  
OnDataContextChangedbb !
(bb! "
ebb" #
)bb# $
;bb$ %
ifdd 

(dd 
DataContextdd 
isdd 
notdd -
!ConnectivityNotificationViewModeldd @
	viewModelddA J
)ddJ K
{ee 	
returnff 
;ff 
}gg 	
	viewModelii 
.ii 
SetViewii 
(ii 
thisii 
)ii 
;ii  
	viewModelkk 
.kk 
AppearDurationkk  
=kk! "
AppearDurationkk# 1
;kk1 2
	viewModelll 
.ll 
DisappearDurationll #
=ll$ %
DisappearDurationll& 7
;ll7 8
}mm 
	protectedoo 
overrideoo 
voidoo 
OnPropertyChangedoo -
(oo- .,
 AvaloniaPropertyChangedEventArgsoo. N
changeooO U
)ooU V
{pp 
baseqq 
.qq 
OnPropertyChangedqq 
(qq 
changeqq %
)qq% &
;qq& '
ifss 

(ss 
DataContextss 
isss -
!ConnectivityNotificationViewModelss <
	viewModelss= F
)ssF G
{tt 	
ifuu 
(uu 
changeuu 
.uu 
Propertyuu 
==uu  ""
AppearDurationPropertyuu# 9
)uu9 :
{vv 
	viewModelww 
.ww 
AppearDurationww (
=ww) *
AppearDurationww+ 9
;ww9 :
}xx 
elseyy 
ifyy 
(yy 
changeyy 
.yy 
Propertyyy $
==yy% '%
DisappearDurationPropertyyy( A
)yyA B
{zz 
	viewModel{{ 
.{{ 
DisappearDuration{{ +
={{, -
DisappearDuration{{. ?
;{{? @
}|| 
}}} 	
}~~ 
} 
†/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Constants/SegmentedTextBoxConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
	Constants! *
;* +
public 
static 
class %
SegmentedTextBoxConstants -
{ 
public 

const 
string 
SEGMENT_STYLE_CLASS +
=, -
$str. 7
;7 8
public 

const 
string 
ACTIVE_STYLE_CLASS *
=+ ,
$str- 5
;5 6
public 

const 
int !
DEFAULT_SEGMENT_COUNT *
=+ ,
$num- .
;. /
public		 

const		 
double		 #
DEFAULT_SEGMENT_SPACING		 /
=		0 1
$num		2 5
;		5 6
public

 

const

 
double

 !
DEFAULT_SEGMENT_WIDTH

 -
=

. /
$num

0 4
;

4 5
public 

const 
bool &
DEFAULT_ALLOW_ONLY_NUMBERS 0
=1 2
false3 8
;8 9
public 

const 
bool *
IS_POINTER_INTERACTION_ENABLED 4
=5 6
true7 ;
;; <
} õ
ƒ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Constants/NetworkStatusConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
	Constants! *
;* +
public 
static 
class "
NetworkStatusConstants *
{ 
public 

const 
int &
DEFAULT_APPEAR_DURATION_MS /
=0 1
$num2 5
;5 6
public 

const 
int )
DEFAULT_DISAPPEAR_DURATION_MS 2
=3 4
$num5 8
;8 9
public 

const 
int 
AUTO_HIDE_DELAY_MS '
=( )
$num* .
;. /
public		 

const		 
string		  
NO_INTERNET_ICON_URI		 ,
=		- .
$str		/ e
;		e f
public

 

const

 
string

 *
SERVER_NOT_RESPONDING_ICON_URI

 6
=

7 8
$str	

9 ƒ
;


ƒ „
} Ù-
ƒ/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Constants/HintedTextBoxConstants.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
	Constants! *
;* +
public 
static 
class "
HintedTextBoxConstants *
{ 
public 

const 
string 
FOCUS_COLOR_HEX '
=( )
$str* 3
;3 4
public 

const 
string 
ERROR_COLOR_HEX '
=( )
$str* 3
;3 4
public 

const 
string &
INVALID_STRENGTH_COLOR_HEX 2
=3 4
$str5 >
;> ?
public		 

const		 
string		 (
VERY_WEAK_STRENGTH_COLOR_HEX		 4
=		5 6
$str		7 @
;		@ A
public

 

const

 
string

 #
WEAK_STRENGTH_COLOR_HEX

 /
=

0 1
$str

2 ;
;

; <
public 

const 
string #
GOOD_STRENGTH_COLOR_HEX /
=0 1
$str2 ;
;; <
public 

const 
string %
STRONG_STRENGTH_COLOR_HEX 1
=2 3
$str4 =
;= >
public 

const 
string *
VERY_STRONG_STRENGTH_COLOR_HEX 6
=7 8
$str9 B
;B C
public 

const 
char 
DEFAULT_MASK_CHAR '
=( )
$char* -
;- .
public 

const 
char 
NO_SECURE_KEY_CHAR (
=) *
$char+ /
;/ 0
public 

const 
double +
DEFAULT_ELLIPSE_OPACITY_VISIBLE 7
=8 9
$num: =
;= >
public 

const 
double *
DEFAULT_ELLIPSE_OPACITY_HIDDEN 6
=7 8
$num9 <
;< =
public 

const 
double 
DEFAULT_FONT_SIZE )
=* +
$num, 0
;0 1
public 

const 
double '
DEFAULT_WATERMARK_FONT_SIZE 3
=4 5
$num6 :
;: ;
public 

const 
int #
INPUT_DEBOUNCE_DELAY_MS ,
=- .
$num/ 0
;0 1
public 

const 
int 
INITIAL_CARET_INDEX (
=) *
$num+ ,
;, -
public 

const 
int &
TYPING_ANIMATION_THRESHOLD /
=0 1
$num2 3
;3 4
public 

const 
int (
TYPING_ANIMATION_DURATION_MS 1
=2 3
$num4 7
;7 8
public 

const 
int /
#DEFAULT_WARNING_DISPLAY_DURATION_MS 8
=9 :
$num; ?
;? @
public 

const 
double 
FULL_OPACITY $
=% &
$num' *
;* +
public 

const 
double 
ZERO_OPACITY $
=% &
$num' *
;* +
public 

const 
double #
ANIMATION_OPACITY_BOOST /
=0 1
$num2 5
;5 6
public   

const   
string   #
ANIMATION_START_PERCENT   /
=  0 1
$str  2 6
;  6 7
public!! 

const!! 
string!! "
ANIMATION_PEAK_PERCENT!! .
=!!/ 0
$str!!1 6
;!!6 7
public"" 

const"" 
string"" !
ANIMATION_END_PERCENT"" -
="". /
$str""0 6
;""6 7
public$$ 

const$$ 
string$$ 
MAIN_TEXT_BOX_NAME$$ *
=$$+ ,
$str$$- :
;$$: ;
public%% 

const%% 
string%% 
FOCUS_BORDER_NAME%% )
=%%* +
$str%%, 9
;%%9 :
public&& 

const&& 
string&& 
MAIN_BORDER_NAME&& (
=&&) *
$str&&+ 7
;&&7 8
public'' 

const'' 
string'' 
SHADOW_BORDER_NAME'' *
=''+ ,
$str''- ;
;''; <
public)) 

const)) 
string)) 
ERROR_SHADOW_KEY)) (
=))) *
$str))+ 8
;))8 9
public** 

const** 
string** 
FOCUS_SHADOW_KEY** (
=**) *
$str**+ 8
;**8 9
public++ 

const++ 
string++ 
DEFAULT_SHADOW_KEY++ *
=+++ ,
$str++- <
;++< =
public,, 

const,, 
string,, '
INVALID_STRENGTH_SHADOW_KEY,, 3
=,,4 5
$str,,6 M
;,,M N
public-- 

const-- 
string-- )
VERY_WEAK_STRENGTH_SHADOW_KEY-- 5
=--6 7
$str--8 P
;--P Q
public.. 

const.. 
string.. $
WEAK_STRENGTH_SHADOW_KEY.. 0
=..1 2
$str..3 G
;..G H
public// 

const// 
string// $
GOOD_STRENGTH_SHADOW_KEY// 0
=//1 2
$str//3 G
;//G H
public00 

const00 
string00 &
STRONG_STRENGTH_SHADOW_KEY00 2
=003 4
$str005 K
;00K L
public11 

const11 
string11 +
VERY_STRONG_STRENGTH_SHADOW_KEY11 7
=118 9
$str11: T
;11T U
}22 û
~/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Controls/Common/CharacterWarningType.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
Controls  
.  !
Common! '
;' (
public 
enum  
CharacterWarningType  
{ 
NonLatinLetter 
, 
InvalidCharacter 
, 
MultipleCharacters 
} !
|/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/Constants/ApplicationErrorMessages.cs
	namespace 	
Ecliptix
 
. 
Core 
. 
	Constants !
;! "
public 
static 
class $
ApplicationErrorMessages ,
{ 
public 

static 
class 
ApplicationRouter )
{ 
public 
const 
string '
CANNOT_NAVIGATE_WINDOW_NULL 7
=8 9
$str: c
;c d
public 
const 
string &
FAILED_TO_LOAD_AUTH_MODULE 6
=7 8
$str9 _
;_ `
public		 
const		 
string		 2
&FAILED_TO_CREATE_MEMBERSHIP_VIEW_MODEL		 B
=		C D
$str		E o
;		o p
public

 
const

 
string

 &
FAILED_TO_LOAD_MAIN_MODULE

 6
=

7 8
$str

9 U
;

U V
public 
const 
string ,
 FAILED_TO_CREATE_MAIN_VIEW_MODEL <
== >
$str? _
;_ `
public 
const 
string 2
&FAILED_TO_LOAD_MAIN_MODULE_FROM_SPLASH B
=C D
$strE m
;m n
public 
const 
string 2
&FAILED_TO_LOAD_AUTH_MODULE_FROM_SPLASH B
=C D
$strE w
;w x
} 
public 

static 
class !
SecureStorageProvider -
{ 
public 
const 
string 4
(SECURE_STORAGE_DIRECTORY_CREATION_FAILED D
=E F
$strG w
;w x
public 
const 
string *
APPLICATION_SETTINGS_NOT_FOUND :
=; <
$str= g
;g h
public 
const 
string !
CORRUPT_SETTINGS_DATA 1
=2 3
$str4 ^
;^ _
public 
const 
string "
FAILED_TO_ENCRYPT_DATA 2
=3 4
$str5 Z
;Z [
public 
const 
string &
FAILED_TO_WRITE_TO_STORAGE 6
=7 8
$str9 ]
;] ^
public 
const 
string "
FAILED_TO_DECRYPT_DATA 2
=3 4
$str5 N
;N O
public 
const 
string $
FAILED_TO_ACCESS_STORAGE 4
=5 6
$str7 Y
;Y Z
public 
const 
string )
FAILED_TO_DELETE_FROM_STORAGE 9
=: ;
$str< c
;c d
} 
public 

static 
class &
SecureProtocolStateStorage 2
{ 
public 
const 
string 
STORAGE_DISPOSED ,
=- .
$str/ D
;D E
public 
const 
string  
STATE_FILE_NOT_FOUND 0
=1 2
$str3 I
;I J
public   
const   
string   #
TAMPERED_STATE_DETECTED   3
=  4 5
$str  6 c
;  c d
public!! 
const!! 
string!! $
ASSOCIATED_DATA_MISMATCH!! 4
=!!5 6
$str!!7 Q
;!!Q R
public"" 
const"" 
string"" $
INVALID_CONTAINER_FORMAT"" 4
=""5 6
$str""7 Q
;""Q R
public## 
const## 
string## 
UNSUPPORTED_VERSION## /
=##0 1
$str##2 L
;##L M
public$$ 
const$$ 
string$$ 
SAVE_FAILED$$ '
=$$( )
$str$$* <
;$$< =
public%% 
const%% 
string%% 
LOAD_FAILED%% '
=%%( )
$str%%* <
;%%< =
public&& 
const&& 
string&& 
DELETE_FAILED&& )
=&&* +
$str&&, @
;&&@ A
}'' 
}(( Š
f/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/AssemblyInfo.cs
[ 
assembly 	
:	 

InternalsVisibleTo 
( 
$str 5
)5 6
]6 7
[ 
assembly 	
:	 

InternalsVisibleTo 
( 
$str (
)( )
]) *æ
l/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/ApplicationStartup.cs
	namespace

 	
Ecliptix


 
.

 
Core

 
;

 
public 
class 
ApplicationStartup 
(  3
'IClassicDesktopStyleApplicationLifetime +
desktop, 3
,3 4#
IApplicationInitializer 
initializer '
,' (
IApplicationRouter 
router 
, $
IApplicationStateManager 
stateManager )
)) *
{ 
private !
SplashWindowViewModel !
?! "
_splashViewModel# 3
;3 4
public 

async 
Task 
RunAsync 
( !
DefaultSystemSettings 4!
defaultSystemSettings5 J
)J K
{ 
_ 	
=
 
Locator 
. 
Current 
. 

GetService &
<& '&
InternetConnectivityBridge' A
>A B
(B C
)C D
;D E
_splashViewModel 
= 
Locator "
." #
Current# *
.* +

GetService+ 5
<5 6!
SplashWindowViewModel6 K
>K L
(L M
)M N
!N O
;O P
SplashWindow 
splashScreen !
=" #
new$ '
(' (
)( )
{* +
DataContext, 7
=8 9
_splashViewModel: J
}K L
;L M
desktop 
. 

MainWindow 
= 
splashScreen )
;) *
splashScreen 
. 
Show 
( 
) 
; 
await 
_splashViewModel 
. 
IsSubscribed +
.+ ,
Task, 0
;0 1
bool   
success   
=   
await   
initializer   (
.  ( )
InitializeAsync  ) 8
(  8 9!
defaultSystemSettings  9 N
)  N O
;  O P
if"" 

("" 
success"" 
)"" 
{## 	
bool$$ 
isAuthenticated$$  
=$$! "
stateManager$$# /
.$$/ 0
CurrentState$$0 <
==$$= ?
ApplicationState$$@ P
.$$P Q
AUTHENTICATED$$Q ^
;$$^ _
await&& 
router&& 
.&& %
TransitionFromSplashAsync&& 2
(&&2 3
splashScreen&&3 ?
,&&? @
isAuthenticated&&A P
)&&P Q
;&&Q R
_splashViewModel(( 
?(( 
.(( 
Dispose(( %
(((% &
)((& '
;((' (
_splashViewModel)) 
=)) 
null)) #
;))# $
}** 	
else++ 
{,, 	
await-- 
_splashViewModel-- "
.--" ##
PrepareForShutdownAsync--# :
(--: ;
)--; <
;--< =
desktop.. 
... 
Shutdown.. 
(.. 
).. 
;.. 
}// 	
}00 
}11 “0
c/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Core/Ecliptix.Core/App.axaml.cs
	namespace 	
Ecliptix
 
. 
Core 
; 
public 
class 
App 
: 
Application 
{ 
public 

override 
void 

Initialize #
(# $
)$ %
{ 
RxApp 
. #
DefaultExceptionHandler %
=& '
Observer( 0
.0 1
Create1 7
<7 8
	Exception8 A
>A B
(B C
exC E
=>F H
{ 	
var 
context 
= 
new 
{ 
ExceptionType 
= 
ex  "
." #
GetType# *
(* +
)+ ,
., -
Name- 1
,1 2
InnerException 
=  
ex! #
.# $
InnerException$ 2
?2 3
.3 4
GetType4 ;
(; <
)< =
.= >
Name> B
,B C
	Timestamp 
= 
DateTime $
.$ %
UtcNow% +
} 
; 
Log 
. 
Error 
( 
ex 
, 
$str F
,F G
contextH O
)O P
;P Q
} 	
)	 

;
 
AvaloniaXamlLoader 
. 
Load 
(  
this  $
)$ %
;% &
}   
public"" 

override"" 
void"" .
"OnFrameworkInitializationCompleted"" ;
(""; <
)""< =
{## !
DefaultSystemSettings$$ !
defaultSystemSettings$$ 3
=$$4 5
Locator$$6 =
.$$= >
Current$$> E
.$$E F

GetService$$F P
<$$P Q!
DefaultSystemSettings$$Q f
>$$f g
($$g h
)$$h i
!$$i j
;$$j k
if&& 

(&& 
ApplicationLifetime&& 
is&&  "3
'IClassicDesktopStyleApplicationLifetime&&# J
desktop&&K R
)&&R S
{'' 	
Locator(( 
.(( 
CurrentMutable(( "
.((" #
RegisterConstant((# 3
(((3 4
desktop((4 ;
,((; <
typeof((= C
(((C D3
'IClassicDesktopStyleApplicationLifetime((D k
)((k l
)((l m
;((m n
Task** 
.** 
Run** 
(** 
async** 
(** 
)** 
=>**  
{++ 
try,, 
{-- 
await.. "
InitializeModulesAsync.. 0
(..0 1
)..1 2
;..2 3
Avalonia00 
.00 
	Threading00 &
.00& '

Dispatcher00' 1
.001 2
UIThread002 :
.00: ;
Post00; ?
(00? @
async00@ E
(00F G
)00G H
=>00I K
{11 
try22 
{33 
ApplicationStartup44 .
applicationStartup44/ A
=44B C
Locator44D K
.44K L
Current44L S
.44S T

GetService44T ^
<44^ _
ApplicationStartup44_ q
>44q r
(44r s
)44s t
!44t u
;44u v
await55 !
applicationStartup55" 4
.554 5
RunAsync555 =
(55= >!
defaultSystemSettings55> S
)55S T
;55T U
}66 
catch77 
(77 
	Exception77 (
ex77) +
)77+ ,
{88 
Serilog99 #
.99# $
Log99$ '
.99' (
Fatal99( -
(99- .
ex99. 0
,990 1
$str992 w
)99w x
;99x y
Environment:: '
.::' (
Exit::( ,
(::, -
$num::- .
)::. /
;::/ 0
};; 
}<< 
)<< 
;<< 
}== 
catch>> 
(>> 
	Exception>>  
ex>>! #
)>># $
{?? 
Serilog@@ 
.@@ 
Log@@ 
.@@  
Fatal@@  %
(@@% &
ex@@& (
,@@( )
$str@@* g
)@@g h
;@@h i
EnvironmentAA 
.AA  
ExitAA  $
(AA$ %
$numAA% &
)AA& '
;AA' (
}BB 
}CC 
)CC 
.CC 
ContinueWithCC 
(CC 
taskDD 
=>DD 
{EE 
ifFF 
(FF 
taskFF 
.FF 
	IsFaultedFF &
&&FF' )
taskFF* .
.FF. /
	ExceptionFF/ 8
!=FF9 ;
nullFF< @
)FF@ A
{GG 
SerilogHH 
.HH  
LogHH  #
.HH# $
FatalHH$ )
(HH) *
taskHH* .
.HH. /
	ExceptionHH/ 8
,HH8 9
$strHH: {
)HH{ |
;HH| }
EnvironmentII #
.II# $
ExitII$ (
(II( )
$numII) *
)II* +
;II+ ,
}JJ 
}KK 
,KK 
TaskSchedulerLL 
.LL 
DefaultLL %
)LL% &
;LL& '
}MM 	
baseOO 
.OO .
"OnFrameworkInitializationCompletedOO /
(OO/ 0
)OO0 1
;OO1 2
}PP 
privateRR 
staticRR 
asyncRR 
TaskRR "
InitializeModulesAsyncRR 4
(RR4 5
)RR5 6
{SS 
IModuleManagerTT 
moduleManagerTT $
=TT% &
LocatorTT' .
.TT. /
CurrentTT/ 6
.TT6 7

GetServiceTT7 A
<TTA B
IModuleManagerTTB P
>TTP Q
(TTQ R
)TTR S
!TTS T
;TTT U
awaitUU 
moduleManagerUU 
.UU !
LoadEagerModulesAsyncUU 1
(UU1 2
)UU2 3
;UU3 4
}VV 
}WW 