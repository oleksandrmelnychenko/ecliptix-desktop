òÃ
t/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Utilities/SecureStringHandler.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
	Utilities# ,
;, -
internal		 
sealed			 
class		 
SecureStringHandler		 )
:		* +
IDisposable		, 7
{

 
private 
readonly $
SodiumSecureMemoryHandle -
_handle. 5
;5 6
private 
readonly 
int 
_length  
;  !
private 
bool 
	_disposed 
; 
internal 
SecureStringHandler  
(  !$
SodiumSecureMemoryHandle! 9
handle: @
,@ A
intB E
lengthF L
)L M
{ 
_handle 
= 
handle 
; 
_length 
= 
length 
; 
} 
public 

static 
Result 
< 
SecureStringHandler ,
,, -
SodiumFailure. ;
>; <

FromString= G
(G H
stringH N
?N O
inputP U
)U V
{ 
if 

( 
string 
. 
IsNullOrEmpty  
(  !
input! &
)& '
)' (
{ 	
return 
Result 
< 
SecureStringHandler -
,- .
SodiumFailure/ <
>< =
.= >
Err> A
(A B
SodiumFailure 
. 
InvalidBufferSize /
(/ 0
$str0 V
)V W
)W X
;X Y
} 	
byte 
[ 
] 
? 
bytes 
= 
null 
; 
try 
{ 	
bytes   
=   
Encoding   
.   
UTF8   !
.  ! "
GetBytes  " *
(  * +
input  + 0
)  0 1
;  1 2
Result"" 
<"" $
SodiumSecureMemoryHandle"" +
,""+ ,
SodiumFailure""- :
>"": ;
allocResult""< G
=""H I$
SodiumSecureMemoryHandle""J b
.""b c
Allocate""c k
(""k l
bytes""l q
.""q r
Length""r x
)""x y
;""y z
if## 
(## 
allocResult## 
.## 
IsErr## !
)##! "
{$$ 
return%% 
Result%% 
<%% 
SecureStringHandler%% 1
,%%1 2
SodiumFailure%%3 @
>%%@ A
.%%A B
Err%%B E
(%%E F
allocResult%%F Q
.%%Q R
	UnwrapErr%%R [
(%%[ \
)%%\ ]
)%%] ^
;%%^ _
}&& $
SodiumSecureMemoryHandle(( $
handle((% +
=((, -
allocResult((. 9
.((9 :
Unwrap((: @
(((@ A
)((A B
;((B C
Result)) 
<)) 
Unit)) 
,)) 
SodiumFailure)) &
>))& '
writeResult))( 3
=))4 5
handle))6 <
.))< =
Write))= B
())B C
bytes))C H
)))H I
;))I J
if** 
(** 
!** 
writeResult** 
.** 
IsErr** "
)**" #
{++ 
return,, 
Result,, 
<,, 
SecureStringHandler,, 1
,,,1 2
SodiumFailure,,3 @
>,,@ A
.,,A B
Ok,,B D
(,,D E
new-- 
SecureStringHandler-- +
(--+ ,
handle--, 2
,--2 3
bytes--4 9
.--9 :
Length--: @
)--@ A
)--A B
;--B C
}.. 
handle00 
.00 
Dispose00 
(00 
)00 
;00 
return11 
Result11 
<11 
SecureStringHandler11 -
,11- .
SodiumFailure11/ <
>11< =
.11= >
Err11> A
(11A B
writeResult11B M
.11M N
	UnwrapErr11N W
(11W X
)11X Y
)11Y Z
;11Z [
}33 	
finally44 
{55 	
if66 
(66 
bytes66 
!=66 
null66 
)66 
{77 #
CryptographicOperations88 '
.88' (

ZeroMemory88( 2
(882 3
bytes883 8
)888 9
;889 :
}99 
}:: 	
};; 
public== 

Result== 
<== 
T== 
,== 
SodiumFailure== "
>==" #
UseBytes==$ ,
<==, -
T==- .
>==. /
(==/ 0
Func==0 4
<==4 5
ReadOnlySpan==5 A
<==A B
byte==B F
>==F G
,==G H
T==I J
>==J K
	operation==L U
)==U V
{>> 
if?? 

(?? 
	_disposed?? 
)?? 
{@@ 	
returnAA 
ResultAA 
<AA 
TAA 
,AA 
SodiumFailureAA *
>AA* +
.AA+ ,
ErrAA, /
(AA/ 0
SodiumFailureBB 
.BB 
NullPointerBB )
(BB) *#
ProtocolSystemConstantsBB* A
.BBA B
ErrorMessagesBBB O
.BBO P*
SECURE_STRING_HANDLER_DISPOSEDBBP n
)BBn o
)BBo p
;BBp q
}CC 	
byteEE 
[EE 
]EE 
?EE 
	tempBytesEE 
=EE 
nullEE  
;EE  !
tryFF 
{GG 	
	tempBytesHH 
=HH 
newHH 
byteHH  
[HH  !
_lengthHH! (
]HH( )
;HH) *
ResultII 
<II 
UnitII 
,II 
SodiumFailureII &
>II& '

readResultII( 2
=II3 4
_handleII5 <
.II< =
ReadII= A
(IIA B
	tempBytesIIB K
)IIK L
;IIL M
ifJJ 
(JJ 

readResultJJ 
.JJ 
IsErrJJ  
)JJ  !
{KK 
returnLL 
ResultLL 
<LL 
TLL 
,LL  
SodiumFailureLL! .
>LL. /
.LL/ 0
ErrLL0 3
(LL3 4

readResultLL4 >
.LL> ?
	UnwrapErrLL? H
(LLH I
)LLI J
)LLJ K
;LLK L
}MM 
TOO 
resultOO 
=OO 
	operationOO  
(OO  !
	tempBytesOO! *
.OO* +
AsSpanOO+ 1
(OO1 2
$numOO2 3
,OO3 4
_lengthOO5 <
)OO< =
)OO= >
;OO> ?
returnPP 
ResultPP 
<PP 
TPP 
,PP 
SodiumFailurePP *
>PP* +
.PP+ ,
OkPP, .
(PP. /
resultPP/ 5
)PP5 6
;PP6 7
}QQ 	
finallyRR 
{SS 	
ifTT 
(TT 
	tempBytesTT 
!=TT 
nullTT !
)TT! "
{UU #
CryptographicOperationsVV '
.VV' (

ZeroMemoryVV( 2
(VV2 3
	tempBytesVV3 <
)VV< =
;VV= >
}WW 
}XX 	
}YY 
public[[ 

int[[ 

ByteLength[[ 
=>[[ 
_length[[ $
;[[$ %
public]] 

void]] 
Dispose]] 
(]] 
)]] 
{^^ 
if__ 

(__ 
	_disposed__ 
)__ 
{`` 	
returnaa 
;aa 
}bb 	
	_disposeddd 
=dd 
truedd 
;dd 
_handleee 
?ee 
.ee 
Disposeee 
(ee 
)ee 
;ee 
}ff 
}gg 
internalii 
sealedii	 
classii 
SecureStringBuilderii )
:ii* +
IDisposableii, 7
{jj 
privatekk 
readonlykk 
Listkk 
<kk $
SodiumSecureMemoryHandlekk 2
>kk2 3
_chunkskk4 ;
;kk; <
privatell 
readonlyll 
intll 

_chunkSizell #
;ll# $
privatemm $
SodiumSecureMemoryHandlemm $
?mm$ %
_currentChunkmm& 3
;mm3 4
privatenn 
intnn 
_currentPositionnn  
;nn  !
privateoo 
intoo 
_totalLengthoo 
;oo 
privatepp 
boolpp 
	_disposedpp 
;pp 
publicrr 

SecureStringBuilderrr 
(rr 
intrr "
	chunkSizerr# ,
=rr- .#
ProtocolSystemConstantsrr/ F
.rrF G

MemoryPoolrrG Q
.rrQ R4
(SECURE_STRING_BUILDER_DEFAULT_CHUNK_SIZErrR z
)rrz {
{ss 
iftt 

(tt 
	chunkSizett 
<=tt 
$numtt 
)tt 
{uu 	
throwvv 
newvv 
ArgumentExceptionvv '
(vv' (#
ProtocolSystemConstantsvv( ?
.vv? @
ErrorMessagesvv@ M
.vvM N
CHUNK_SIZE_POSITIVEvvN a
,vva b
nameofvvc i
(vvi j
	chunkSizevvj s
)vvs t
)vvt u
;vvu v
}ww 	
_chunksyy 
=yy 
newyy 
Listyy 
<yy $
SodiumSecureMemoryHandleyy 3
>yy3 4
(yy4 5
)yy5 6
;yy6 7

_chunkSizezz 
=zz 
	chunkSizezz 
;zz 
_currentPosition{{ 
={{ 
$num{{ 
;{{ 
_totalLength|| 
=|| 
$num|| 
;|| 
}}} 
public 

Result 
< 
Unit 
, 
SodiumFailure %
>% &
Append' -
(- .
char. 2
c3 4
)4 5
{
ÄÄ 
if
ÅÅ 

(
ÅÅ 
	_disposed
ÅÅ 
)
ÅÅ 
{
ÇÇ 	
return
ÉÉ 
Result
ÉÉ 
<
ÉÉ 
Unit
ÉÉ 
,
ÉÉ 
SodiumFailure
ÉÉ  -
>
ÉÉ- .
.
ÉÉ. /
Err
ÉÉ/ 2
(
ÉÉ2 3
SodiumFailure
ÑÑ 
.
ÑÑ 
NullPointer
ÑÑ )
(
ÑÑ) *%
ProtocolSystemConstants
ÑÑ* A
.
ÑÑA B
ErrorMessages
ÑÑB O
.
ÑÑO P,
SECURE_STRING_BUILDER_DISPOSED
ÑÑP n
)
ÑÑn o
)
ÑÑo p
;
ÑÑp q
}
ÖÖ 	
Span
áá 
<
áá 
byte
áá 
>
áá 
bytes
áá 
=
áá 

stackalloc
áá %
byte
áá& *
[
áá* +
$num
áá+ ,
]
áá, -
;
áá- .
int
àà 
	byteCount
àà 
=
àà 
Encoding
àà  
.
àà  !
UTF8
àà! %
.
àà% &
GetBytes
àà& .
(
àà. /
new
àà/ 2
[
àà2 3
]
àà3 4
{
àà5 6
c
àà7 8
}
àà9 :
,
àà: ;
bytes
àà< A
)
ààA B
;
ààB C
return
ää 
AppendBytes
ää 
(
ää 
bytes
ää  
.
ää  !
Slice
ää! &
(
ää& '
$num
ää' (
,
ää( )
	byteCount
ää* 3
)
ää3 4
)
ää4 5
;
ää5 6
}
ãã 
public
çç 

Result
çç 
<
çç 
Unit
çç 
,
çç 
SodiumFailure
çç %
>
çç% &
Append
çç' -
(
çç- .
string
çç. 4
str
çç5 8
)
çç8 9
{
éé 
if
èè 

(
èè 
	_disposed
èè 
)
èè 
{
êê 	
return
ëë 
Result
ëë 
<
ëë 
Unit
ëë 
,
ëë 
SodiumFailure
ëë  -
>
ëë- .
.
ëë. /
Err
ëë/ 2
(
ëë2 3
SodiumFailure
íí 
.
íí 
NullPointer
íí )
(
íí) *%
ProtocolSystemConstants
íí* A
.
ííA B
ErrorMessages
ííB O
.
ííO P,
SECURE_STRING_BUILDER_DISPOSED
ííP n
)
íín o
)
íío p
;
ííp q
}
ìì 	
if
ïï 

(
ïï 
string
ïï 
.
ïï 
IsNullOrEmpty
ïï  
(
ïï  !
str
ïï! $
)
ïï$ %
)
ïï% &
{
ññ 	
return
óó 
Result
óó 
<
óó 
Unit
óó 
,
óó 
SodiumFailure
óó  -
>
óó- .
.
óó. /
Ok
óó/ 1
(
óó1 2
Unit
óó2 6
.
óó6 7
Value
óó7 <
)
óó< =
;
óó= >
}
òò 	
byte
öö 
[
öö 
]
öö 
?
öö 
bytes
öö 
=
öö 
null
öö 
;
öö 
try
õõ 
{
úú 	
bytes
ùù 
=
ùù 
Encoding
ùù 
.
ùù 
UTF8
ùù !
.
ùù! "
GetBytes
ùù" *
(
ùù* +
str
ùù+ .
)
ùù. /
;
ùù/ 0
return
ûû 
AppendBytes
ûû 
(
ûû 
bytes
ûû $
)
ûû$ %
;
ûû% &
}
üü 	
finally
†† 
{
°° 	
if
¢¢ 
(
¢¢ 
bytes
¢¢ 
!=
¢¢ 
null
¢¢ 
)
¢¢ 
{
££ %
CryptographicOperations
§§ '
.
§§' (

ZeroMemory
§§( 2
(
§§2 3
bytes
§§3 8
)
§§8 9
;
§§9 :
}
•• 
}
¶¶ 	
}
ßß 
private
©© 
Result
©© 
<
©© 
Unit
©© 
,
©© 
SodiumFailure
©© &
>
©©& '
AppendBytes
©©( 3
(
©©3 4
ReadOnlySpan
©©4 @
<
©©@ A
byte
©©A E
>
©©E F
bytes
©©G L
)
©©L M
{
™™ 
Span
´´ 
<
´´ 
byte
´´ 
>
´´ 
singleByteBuffer
´´ #
=
´´$ %

stackalloc
´´& 0
byte
´´1 5
[
´´5 6
$num
´´6 7
]
´´7 8
;
´´8 9
foreach
≠≠ 
(
≠≠ 
byte
≠≠ 
b
≠≠ 
in
≠≠ 
bytes
≠≠  
)
≠≠  !
{
ÆÆ 	
if
ØØ 
(
ØØ 
_currentChunk
ØØ 
==
ØØ  
null
ØØ! %
||
ØØ& (
_currentPosition
ØØ) 9
>=
ØØ: <

_chunkSize
ØØ= G
)
ØØG H
{
∞∞ 
Result
±± 
<
±± &
SodiumSecureMemoryHandle
±± /
,
±±/ 0
SodiumFailure
±±1 >
>
±±> ?
allocResult
±±@ K
=
±±L M&
SodiumSecureMemoryHandle
±±N f
.
±±f g
Allocate
±±g o
(
±±o p

_chunkSize
±±p z
)
±±z {
;
±±{ |
if
≤≤ 
(
≤≤ 
allocResult
≤≤ 
.
≤≤  
IsErr
≤≤  %
)
≤≤% &
{
≥≥ 
return
¥¥ 
Result
¥¥ !
<
¥¥! "
Unit
¥¥" &
,
¥¥& '
SodiumFailure
¥¥( 5
>
¥¥5 6
.
¥¥6 7
Err
¥¥7 :
(
¥¥: ;
allocResult
¥¥; F
.
¥¥F G
	UnwrapErr
¥¥G P
(
¥¥P Q
)
¥¥Q R
)
¥¥R S
;
¥¥S T
}
µµ 
_currentChunk
∑∑ 
=
∑∑ 
allocResult
∑∑  +
.
∑∑+ ,
Unwrap
∑∑, 2
(
∑∑2 3
)
∑∑3 4
;
∑∑4 5
_chunks
∏∏ 
.
∏∏ 
Add
∏∏ 
(
∏∏ 
_currentChunk
∏∏ )
)
∏∏) *
;
∏∏* +
_currentPosition
ππ  
=
ππ! "
$num
ππ# $
;
ππ$ %
}
∫∫ 
singleByteBuffer
ºº 
[
ºº 
$num
ºº 
]
ºº 
=
ºº  !
b
ºº" #
;
ºº# $
Result
ΩΩ 
<
ΩΩ 
Unit
ΩΩ 
,
ΩΩ 
SodiumFailure
ΩΩ &
>
ΩΩ& '
writeResult
ΩΩ( 3
=
ΩΩ4 5
_currentChunk
ΩΩ6 C
.
ΩΩC D
Write
ΩΩD I
(
ΩΩI J
singleByteBuffer
ΩΩJ Z
)
ΩΩZ [
;
ΩΩ[ \
if
ææ 
(
ææ 
writeResult
ææ 
.
ææ 
IsErr
ææ !
)
ææ! "
{
øø 
return
¿¿ 
Result
¿¿ 
<
¿¿ 
Unit
¿¿ "
,
¿¿" #
SodiumFailure
¿¿$ 1
>
¿¿1 2
.
¿¿2 3
Err
¿¿3 6
(
¿¿6 7
writeResult
¿¿7 B
.
¿¿B C
	UnwrapErr
¿¿C L
(
¿¿L M
)
¿¿M N
)
¿¿N O
;
¿¿O P
}
¡¡ 
_currentPosition
√√ 
++
√√ 
;
√√ 
_totalLength
ƒƒ 
++
ƒƒ 
;
ƒƒ 
}
≈≈ 	
return
«« 
Result
«« 
<
«« 
Unit
«« 
,
«« 
SodiumFailure
«« )
>
««) *
.
««* +
Ok
««+ -
(
««- .
Unit
««. 2
.
««2 3
Value
««3 8
)
««8 9
;
««9 :
}
»» 
public
   

Result
   
<
   !
SecureStringHandler
   %
,
  % &
SodiumFailure
  ' 4
>
  4 5
Build
  6 ;
(
  ; <
)
  < =
{
ÀÀ 
if
ÃÃ 

(
ÃÃ 
	_disposed
ÃÃ 
)
ÃÃ 
{
ÕÕ 	
return
ŒŒ 
Result
ŒŒ 
<
ŒŒ !
SecureStringHandler
ŒŒ -
,
ŒŒ- .
SodiumFailure
ŒŒ/ <
>
ŒŒ< =
.
ŒŒ= >
Err
ŒŒ> A
(
ŒŒA B
SodiumFailure
œœ 
.
œœ 
NullPointer
œœ )
(
œœ) *%
ProtocolSystemConstants
œœ* A
.
œœA B
ErrorMessages
œœB O
.
œœO P,
SECURE_STRING_BUILDER_DISPOSED
œœP n
)
œœn o
)
œœo p
;
œœp q
}
–– 	
if
““ 

(
““ 
_totalLength
““ 
==
““ 
$num
““ 
)
““ 
{
”” 	
return
‘‘ 
Result
‘‘ 
<
‘‘ !
SecureStringHandler
‘‘ -
,
‘‘- .
SodiumFailure
‘‘/ <
>
‘‘< =
.
‘‘= >
Err
‘‘> A
(
‘‘A B
SodiumFailure
’’ 
.
’’ 
InvalidBufferSize
’’ /
(
’’/ 0%
ProtocolSystemConstants
’’0 G
.
’’G H
ErrorMessages
’’H U
.
’’U V+
SECURE_STRING_BUILDER_NO_DATA
’’V s
)
’’s t
)
’’t u
;
’’u v
}
÷÷ 	
Result
ÿÿ 
<
ÿÿ &
SodiumSecureMemoryHandle
ÿÿ '
,
ÿÿ' (
SodiumFailure
ÿÿ) 6
>
ÿÿ6 7
allocResult
ÿÿ8 C
=
ÿÿD E&
SodiumSecureMemoryHandle
ÿÿF ^
.
ÿÿ^ _
Allocate
ÿÿ_ g
(
ÿÿg h
_totalLength
ÿÿh t
)
ÿÿt u
;
ÿÿu v
if
ŸŸ 

(
ŸŸ 
allocResult
ŸŸ 
.
ŸŸ 
IsErr
ŸŸ 
)
ŸŸ 
{
⁄⁄ 	
return
€€ 
Result
€€ 
<
€€ !
SecureStringHandler
€€ -
,
€€- .
SodiumFailure
€€/ <
>
€€< =
.
€€= >
Err
€€> A
(
€€A B
allocResult
€€B M
.
€€M N
	UnwrapErr
€€N W
(
€€W X
)
€€X Y
)
€€Y Z
;
€€Z [
}
‹‹ 	&
SodiumSecureMemoryHandle
ﬁﬁ  
finalHandle
ﬁﬁ! ,
=
ﬁﬁ- .
allocResult
ﬁﬁ/ :
.
ﬁﬁ: ;
Unwrap
ﬁﬁ; A
(
ﬁﬁA B
)
ﬁﬁB C
;
ﬁﬁC D
byte
ﬂﬂ 
[
ﬂﬂ 
]
ﬂﬂ 
?
ﬂﬂ 

tempBuffer
ﬂﬂ 
=
ﬂﬂ 
null
ﬂﬂ !
;
ﬂﬂ! "
try
·· 
{
‚‚ 	

tempBuffer
„„ 
=
„„ 
new
„„ 
byte
„„ !
[
„„! "
_totalLength
„„" .
]
„„. /
;
„„/ 0
int
‰‰ 
offset
‰‰ 
=
‰‰ 
$num
‰‰ 
;
‰‰ 
for
ÊÊ 
(
ÊÊ 
int
ÊÊ 
i
ÊÊ 
=
ÊÊ 
$num
ÊÊ 
;
ÊÊ 
i
ÊÊ 
<
ÊÊ 
_chunks
ÊÊ  '
.
ÊÊ' (
Count
ÊÊ( -
;
ÊÊ- .
i
ÊÊ/ 0
++
ÊÊ0 2
)
ÊÊ2 3
{
ÁÁ &
SodiumSecureMemoryHandle
ËË (
chunk
ËË) .
=
ËË/ 0
_chunks
ËË1 8
[
ËË8 9
i
ËË9 :
]
ËË: ;
;
ËË; <
int
ÈÈ 
bytesToRead
ÈÈ 
=
ÈÈ  !
(
ÈÈ" #
i
ÈÈ# $
==
ÈÈ% '
_chunks
ÈÈ( /
.
ÈÈ/ 0
Count
ÈÈ0 5
-
ÈÈ6 7
$num
ÈÈ8 9
)
ÈÈ9 :
?
ÈÈ; <
_currentPosition
ÍÍ $
:
ÍÍ% &

_chunkSize
ÍÍ' 1
;
ÍÍ1 2
Result
ÏÏ 
<
ÏÏ 
byte
ÏÏ 
[
ÏÏ 
]
ÏÏ 
,
ÏÏ 
SodiumFailure
ÏÏ ,
>
ÏÏ, -

readResult
ÏÏ. 8
=
ÏÏ9 :
chunk
ÏÏ; @
.
ÏÏ@ A
	ReadBytes
ÏÏA J
(
ÏÏJ K
bytesToRead
ÏÏK V
)
ÏÏV W
;
ÏÏW X
if
ÌÌ 
(
ÌÌ 

readResult
ÌÌ 
.
ÌÌ 
IsErr
ÌÌ $
)
ÌÌ$ %
{
ÓÓ 
finalHandle
ÔÔ 
.
ÔÔ  
Dispose
ÔÔ  '
(
ÔÔ' (
)
ÔÔ( )
;
ÔÔ) *
return
 
Result
 !
<
! "!
SecureStringHandler
" 5
,
5 6
SodiumFailure
7 D
>
D E
.
E F
Err
F I
(
I J

readResult
J T
.
T U
	UnwrapErr
U ^
(
^ _
)
_ `
)
` a
;
a b
}
ÒÒ 
byte
ÛÛ 
[
ÛÛ 
]
ÛÛ 
	chunkData
ÛÛ  
=
ÛÛ! "

readResult
ÛÛ# -
.
ÛÛ- .
Unwrap
ÛÛ. 4
(
ÛÛ4 5
)
ÛÛ5 6
;
ÛÛ6 7
Array
ÙÙ 
.
ÙÙ 
Copy
ÙÙ 
(
ÙÙ 
	chunkData
ÙÙ $
,
ÙÙ$ %
$num
ÙÙ& '
,
ÙÙ' (

tempBuffer
ÙÙ) 3
,
ÙÙ3 4
offset
ÙÙ5 ;
,
ÙÙ; <
bytesToRead
ÙÙ= H
)
ÙÙH I
;
ÙÙI J%
CryptographicOperations
ıı '
.
ıı' (

ZeroMemory
ıı( 2
(
ıı2 3
	chunkData
ıı3 <
)
ıı< =
;
ıı= >
offset
ˆˆ 
+=
ˆˆ 
bytesToRead
ˆˆ %
;
ˆˆ% &
}
˜˜ 
Result
˘˘ 
<
˘˘ 
Unit
˘˘ 
,
˘˘ 
SodiumFailure
˘˘ &
>
˘˘& '
writeResult
˘˘( 3
=
˘˘4 5
finalHandle
˘˘6 A
.
˘˘A B
Write
˘˘B G
(
˘˘G H

tempBuffer
˘˘H R
)
˘˘R S
;
˘˘S T
if
˙˙ 
(
˙˙ 
writeResult
˙˙ 
.
˙˙ 
IsErr
˙˙ !
)
˙˙! "
{
˚˚ 
finalHandle
¸¸ 
.
¸¸ 
Dispose
¸¸ #
(
¸¸# $
)
¸¸$ %
;
¸¸% &
return
˝˝ 
Result
˝˝ 
<
˝˝ !
SecureStringHandler
˝˝ 1
,
˝˝1 2
SodiumFailure
˝˝3 @
>
˝˝@ A
.
˝˝A B
Err
˝˝B E
(
˝˝E F
writeResult
˝˝F Q
.
˝˝Q R
	UnwrapErr
˝˝R [
(
˝˝[ \
)
˝˝\ ]
)
˝˝] ^
;
˝˝^ _
}
˛˛ 
return
ÄÄ 
Result
ÄÄ 
<
ÄÄ !
SecureStringHandler
ÄÄ -
,
ÄÄ- .
SodiumFailure
ÄÄ/ <
>
ÄÄ< =
.
ÄÄ= >
Ok
ÄÄ> @
(
ÄÄ@ A
new
ÅÅ !
SecureStringHandler
ÅÅ '
(
ÅÅ' (
finalHandle
ÅÅ( 3
,
ÅÅ3 4
_totalLength
ÅÅ5 A
)
ÅÅA B
)
ÅÅB C
;
ÅÅC D
}
ÇÇ 	
finally
ÉÉ 
{
ÑÑ 	
if
ÖÖ 
(
ÖÖ 

tempBuffer
ÖÖ 
!=
ÖÖ 
null
ÖÖ "
)
ÖÖ" #
{
ÜÜ %
CryptographicOperations
áá '
.
áá' (

ZeroMemory
áá( 2
(
áá2 3

tempBuffer
áá3 =
)
áá= >
;
áá> ?
}
àà 
}
ââ 	
}
ää 
public
åå 

void
åå 
Clear
åå 
(
åå 
)
åå 
{
çç 
foreach
éé 
(
éé &
SodiumSecureMemoryHandle
éé )
chunk
éé* /
in
éé0 2
_chunks
éé3 :
)
éé: ;
{
èè 	
chunk
êê 
.
êê 
Dispose
êê 
(
êê 
)
êê 
;
êê 
}
ëë 	
_chunks
ìì 
.
ìì 
Clear
ìì 
(
ìì 
)
ìì 
;
ìì 
_currentChunk
îî 
=
îî 
null
îî 
;
îî 
_currentPosition
ïï 
=
ïï 
$num
ïï 
;
ïï 
_totalLength
ññ 
=
ññ 
$num
ññ 
;
ññ 
}
óó 
public
ôô 

void
ôô 
Dispose
ôô 
(
ôô 
)
ôô 
{
öö 
if
õõ 

(
õõ 
	_disposed
õõ 
)
õõ 
{
úú 	
return
ùù 
;
ùù 
}
ûû 	
	_disposed
†† 
=
†† 
true
†† 
;
†† 
Clear
°° 
(
°° 
)
°° 
;
°° 
}
¢¢ 
}££ Ω
r/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Utilities/SecurePooledArray.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
	Utilities# ,
;, -
internal 
readonly	 
struct 
SecurePooledArray *
<* +
T+ ,
>, -
:. /
IDisposable0 ;
where< A
TB C
:D E
structF L
{ 
private 
readonly 
T 
[ 
] 
_array 
;  
private 
readonly 
int 
_requestedLength )
;) *
private		 
readonly		 
	ArrayPool		 
<		 
T		  
>		  !
_pool		" '
;		' (
internal 
SecurePooledArray 
( 
int "
minimumLength# 0
)0 1
{ 
_pool 
= 
	ArrayPool 
< 
T 
> 
. 
Shared #
;# $
_array 
= 
_pool 
. 
Rent 
( 
minimumLength )
)) *
;* +
_requestedLength 
= 
minimumLength (
;( )
} 
public 

Span 
< 
T 
> 
AsSpan 
( 
) 
=> 
_array %
.% &
AsSpan& ,
(, -
$num- .
,. /
_requestedLength0 @
)@ A
;A B
public 

void 
Dispose 
( 
) 
{ 
if 

( 
_array 
!= 
null 
) 
{ 	
_pool 
. 
Return 
( 
_array 
,  

clearArray! +
:+ ,
true- 1
)1 2
;2 3
} 	
} 
} é2
r/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Utilities/SecureMemoryUtils.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
	Utilities# ,
;, -
internal 
static	 
class 
SecureMemoryUtils '
{		 
private

 
static

 
readonly

 
SecureMemoryPool

 ,
DefaultPool

- 8
=

9 :
new

; >
(

> ?#
ProtocolSystemConstants

? V
.

V W

MemoryPool

W a
.

a b
DEFAULT_BUFFER_SIZE

b u
,

u v$
ProtocolSystemConstants	

w é
.


é è

MemoryPool


è ô
.


ô ö
MAX_POOL_SIZE


ö ß
)


ß ®
;


® ©
public 

static 
Result 
< 
TResult  
,  !
TError" (
>( )
WithSecureBuffer* :
<: ;
TResult; B
,B C
TErrorD J
>J K
(K L
int 
size 
, 
Func 
< 
Span 
< 
byte 
> 
, 
Result 
<  
TResult  '
,' (
TError) /
>/ 0
>0 1
	operation2 ;
); <
where 
TError 
: 
class 
{ 
using 
SecureMemoryBuffer  
buffer! '
=( )
DefaultPool* 5
.5 6
Rent6 :
(: ;
size; ?
)? @
;@ A
byte 
[ 
] 

fullBuffer 
= 
new 
byte  $
[$ %
buffer% +
.+ ,
AllocatedSize, 9
]9 :
;: ;
Result 
< 
Unit 
, 
SodiumFailure "
>" #

readResult$ .
=/ 0
buffer1 7
.7 8
Read8 <
(< =

fullBuffer= G
)G H
;H I
if 

( 

readResult 
. 
IsErr 
) 
{ 	
throw 
new %
InvalidOperationException /
(/ 0#
ProtocolSystemConstants0 G
.G H
ErrorMessagesH U
.U V(
FAILED_TO_READ_SECURE_MEMORYV r
+s t

readResultu 
.	 Ä
	UnwrapErr
Ä â
(
â ä
)
ä ã
)
ã å
;
å ç
} 	
Span 
< 
byte 
> 
span 
= 

fullBuffer $
.$ %
AsSpan% +
(+ ,
$num, -
,- .
size/ 3
)3 4
;4 5
try 
{ 	
return 
	operation 
( 
span !
)! "
;" #
} 	
finally   
{!! 	#
CryptographicOperations"" #
.""# $

ZeroMemory""$ .
("". /

fullBuffer""/ 9
)""9 :
;"": ;
}## 	
}$$ 
public&& 

static&& 
Result&& 
<&& 
TResult&&  
,&&  !
TError&&" (
>&&( )
WithSecureBuffers&&* ;
<&&; <
TResult&&< C
,&&C D
TError&&E K
>&&K L
(&&L M
int'' 
['' 
]'' 
sizes'' 
,'' 
Func(( 
<(( 
SecureMemoryBuffer(( 
[((  
]((  !
,((! "
Result((# )
<(() *
TResult((* 1
,((1 2
TError((3 9
>((9 :
>((: ;
	operation((< E
)((E F
where)) 
TError)) 
:)) 
class)) 
{** 
SecureMemoryBuffer++ 
[++ 
]++ 
buffers++ $
=++% &
new++' *
SecureMemoryBuffer+++ =
[++= >
sizes++> C
.++C D
Length++D J
]++J K
;++K L
try-- 
{.. 	
for// 
(// 
int// 
i// 
=// 
$num// 
;// 
i// 
<// 
sizes//  %
.//% &
Length//& ,
;//, -
i//. /
++/// 1
)//1 2
{00 
buffers11 
[11 
i11 
]11 
=11 
DefaultPool11 (
.11( )
Rent11) -
(11- .
sizes11. 3
[113 4
i114 5
]115 6
)116 7
;117 8
}22 
return44 
	operation44 
(44 
buffers44 $
)44$ %
;44% &
}55 	
finally66 
{77 	
foreach88 
(88 
SecureMemoryBuffer88 '
buffer88( .
in88/ 1
buffers882 9
)889 :
{99 
buffer:: 
?:: 
.:: 
Dispose:: 
(::  
)::  !
;::! "
};; 
}<< 	
}== 
[?? 

MethodImpl?? 
(?? 
MethodImplOptions?? !
.??! "

NoInlining??" ,
|??- .
MethodImplOptions??/ @
.??@ A
NoOptimization??A O
)??O P
]??P Q
public@@ 

static@@ 
bool@@ 
ConstantTimeEquals@@ )
(@@) *
ReadOnlySpan@@* 6
<@@6 7
byte@@7 ;
>@@; <
a@@= >
,@@> ?
ReadOnlySpan@@@ L
<@@L M
byte@@M Q
>@@Q R
b@@S T
)@@T U
{AA 
ifBB 

(BB 
aBB 
.BB 
LengthBB 
!=BB 
bBB 
.BB 
LengthBB  
)BB  !
{CC 	
returnDD 
falseDD 
;DD 
}EE 	
returnGG #
CryptographicOperationsGG &
.GG& '
FixedTimeEqualsGG' 6
(GG6 7
aGG7 8
,GG8 9
bGG: ;
)GG; <
;GG< =
}HH 
}II ≥5
q/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Utilities/SecureMemoryPool.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
	Utilities# ,
;, -
internal 
sealed	 
class 
SecureMemoryPool &
:' (
IDisposable) 4
{ 
private 
readonly 
ConcurrentBag "
<" #
SecureMemoryBuffer# 5
>5 6
_pool7 <
== >
new? B
(B C
)C D
;D E
private 
readonly 
int 
_defaultBufferSize +
;+ ,
private		 
readonly		 
int		 
_maxPoolSize		 %
;		% &
private

 
int

 
_currentPoolSize

  
;

  !
private 
bool 
	_disposed 
; 
public 

SecureMemoryPool 
( 
int 
defaultBufferSize  1
=2 3#
ProtocolSystemConstants4 K
.K L

MemoryPoolL V
.V W
DEFAULT_BUFFER_SIZEW j
,j k
intl o
maxPoolSizep {
=| }$
ProtocolSystemConstants	~ ï
.
ï ñ

MemoryPool
ñ †
.
† °
MAX_POOL_SIZE
° Æ
)
Æ Ø
{ 
if 

( 
defaultBufferSize 
<=  
$num! "
)" #
{ 	
throw 
new 
ArgumentException '
(' (#
ProtocolSystemConstants( ?
.? @
ErrorMessages@ M
.M N 
BUFFER_SIZE_POSITIVEN b
,b c
nameofd j
(j k
defaultBufferSizek |
)| }
)} ~
;~ 
} 	
if 

( 
maxPoolSize 
<= 
$num 
) 
{ 	
throw 
new 
ArgumentException '
(' (#
ProtocolSystemConstants( ?
.? @
ErrorMessages@ M
.M N"
MAX_POOL_SIZE_POSITIVEN d
,d e
nameoff l
(l m
maxPoolSizem x
)x y
)y z
;z {
} 	
_defaultBufferSize 
= 
defaultBufferSize .
;. /
_maxPoolSize 
= 
maxPoolSize "
;" #
} 
public 

SecureMemoryBuffer 
Rent "
(" #
int# &
minimumSize' 2
=3 4
-5 6
$num6 7
)7 8
{ 
if 

( 
	_disposed 
) 
{   	
throw!! 
new!! #
ObjectDisposedException!! -
(!!- .
nameof!!. 4
(!!4 5
SecureMemoryPool!!5 E
)!!E F
)!!F G
;!!G H
}"" 	
int$$ 
requestedSize$$ 
=$$ 
minimumSize$$ '
>$$( )
$num$$* +
?$$, -
minimumSize$$. 9
:$$: ;
_defaultBufferSize$$< N
;$$N O
int%% 
allocatedSize%% 
=%% 
minimumSize%% '
>%%( )
$num%%* +
?%%, -
Math%%. 2
.%%2 3
Max%%3 6
(%%6 7
minimumSize%%7 B
,%%B C
_defaultBufferSize%%D V
)%%V W
:%%X Y
_defaultBufferSize%%Z l
;%%l m
while'' 
('' 
_pool'' 
.'' 
TryTake'' 
('' 
out''  
SecureMemoryBuffer''! 3
?''3 4
buffer''5 ;
)''; <
)''< =
{(( 	
if)) 
()) 
!)) 
buffer)) 
.)) 

IsDisposed)) "
&&))# %
buffer))& ,
.)), -
AllocatedSize))- :
>=)); =
requestedSize))> K
)))K L
{** 
buffer++ 
.++ 
Clear++ 
(++ 
)++ 
;++ 
buffer,, 
.,, 
SetRequestedSize,, '
(,,' (
requestedSize,,( 5
),,5 6
;,,6 7
return-- 
buffer-- 
;-- 
}.. 
buffer00 
.00 
Dispose00 
(00 
)00 
;00 
Interlocked11 
.11 
	Decrement11 !
(11! "
ref11" %
_currentPoolSize11& 6
)116 7
;117 8
}22 	
return44 
new44 
SecureMemoryBuffer44 %
(44% &
requestedSize44& 3
,443 4
allocatedSize445 B
,44B C
this44D H
)44H I
;44I J
}55 
internal77 
void77 
Return77 
(77 
SecureMemoryBuffer77 +
buffer77, 2
)772 3
{88 
if99 

(99 
	_disposed99 
||99 
buffer99 
.99  

IsDisposed99  *
)99* +
{:: 	
buffer;; 
.;; 
Dispose;; 
(;; 
);; 
;;; 
return<< 
;<< 
}== 	
buffer?? 
.?? 
Clear?? 
(?? 
)?? 
;?? 
ifAA 

(AA 
_currentPoolSizeAA 
<AA 
_maxPoolSizeAA +
)AA+ ,
{BB 	
_poolCC 
.CC 
AddCC 
(CC 
bufferCC 
)CC 
;CC 
InterlockedDD 
.DD 
	IncrementDD !
(DD! "
refDD" %
_currentPoolSizeDD& 6
)DD6 7
;DD7 8
}EE 	
elseFF 
{GG 	
bufferHH 
.HH 
DisposeHH 
(HH 
)HH 
;HH 
}II 	
}JJ 
publicLL 

voidLL 
DisposeLL 
(LL 
)LL 
{MM 
ifNN 

(NN 
	_disposedNN 
)NN 
{OO 	
returnPP 
;PP 
}QQ 	
	_disposedSS 
=SS 
trueSS 
;SS 
whileTT 
(TT 
_poolTT 
.TT 
TryTakeTT 
(TT 
outTT  
SecureMemoryBufferTT! 3
?TT3 4
bufferTT5 ;
)TT; <
)TT< =
{UU 	
bufferVV 
.VV 
DisposeVV 
(VV 
)VV 
;VV 
}WW 	
}XX 
}YY ¿]
s/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Utilities/SecureMemoryBuffer.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
	Utilities# ,
;, -
internal 
sealed	 
class 
SecureMemoryBuffer (
:) *
IDisposable+ 6
{ 
private		 
readonly		 
SecureMemoryPool		 %
?		% &
_pool		' ,
;		, -
private

 
readonly

 $
SodiumSecureMemoryHandle

 -
_handle

. 5
;

5 6
private 
bool 
	_disposed 
; 
private 
int 
_requestedSize 
; 
private 
readonly 
int 
_allocatedSize '
;' (
public 

int 
Length 
=> 
_requestedSize '
;' (
public 

int 
AllocatedSize 
=> 
_allocatedSize  .
;. /
public 

bool 

IsDisposed 
=> 
	_disposed '
;' (
internal 
SecureMemoryBuffer 
(  
int  #
requestedSize$ 1
,1 2
int3 6
allocatedSize7 D
,D E
SecureMemoryPoolF V
?V W
poolX \
=] ^
null_ c
)c d
{ 
_pool 
= 
pool 
; 
_requestedSize 
= 
requestedSize &
;& '
_allocatedSize 
= 
allocatedSize &
;& '
Result 
< $
SodiumSecureMemoryHandle '
,' (
SodiumFailure) 6
>6 7
result8 >
=? @$
SodiumSecureMemoryHandleA Y
.Y Z
AllocateZ b
(b c
allocatedSizec p
)p q
;q r
if 

( 
result 
. 
IsErr 
) 
{ 	
throw 
new %
InvalidOperationException /
(/ 0#
ProtocolSystemConstants0 G
.G H
ErrorMessagesH U
.U V,
 FAILED_TO_ALLOCATE_SECURE_MEMORYV v
+w x
resulty 
.	 Ä
	UnwrapErr
Ä â
(
â ä
)
ä ã
)
ã å
;
å ç
} 	
_handle 
= 
result 
. 
Unwrap 
(  
)  !
;! "
}   
internal"" 
void"" 
SetRequestedSize"" "
(""" #
int""# &
requestedSize""' 4
)""4 5
{## 
if$$ 

($$ 
requestedSize$$ 
>$$ 
_allocatedSize$$ *
)$$* +
{%% 	
throw&& 
new&& 
ArgumentException&& '
(&&' (
string&&( .
.&&. /
Format&&/ 5
(&&5 6#
ProtocolSystemConstants&&6 M
.&&M N
ErrorMessages&&N [
.&&[ \,
 REQUESTED_SIZE_EXCEEDS_ALLOCATED&&\ |
,&&| }
requestedSize	&&~ ã
,
&&ã å
_allocatedSize
&&ç õ
)
&&õ ú
)
&&ú ù
;
&&ù û
}'' 	
_requestedSize)) 
=)) 
requestedSize)) &
;))& '
}** 
public,, 

Span,, 
<,, 
byte,, 
>,, 
GetSpan,, 
(,, 
),, 
{-- 
if.. 

(.. 
!.. 
	_disposed.. 
).. 
{// 	
using00 
SecurePooledArray00 #
<00# $
byte00$ (
>00( )

tempBuffer00* 4
=005 6
SecureArrayPool007 F
.00F G
Rent00G K
<00K L
byte00L P
>00P Q
(00Q R
AllocatedSize00R _
)00_ `
;00` a
Result11 
<11 
Unit11 
,11 
SodiumFailure11 &
>11& '

readResult11( 2
=113 4
_handle115 <
.11< =
Read11= A
(11A B

tempBuffer11B L
.11L M
AsSpan11M S
(11S T
)11T U
)11U V
;11V W
if22 
(22 

readResult22 
.22 
IsErr22  
)22  !
{33 
throw44 
new44 %
InvalidOperationException44 3
(443 4#
ProtocolSystemConstants444 K
.44K L
ErrorMessages44L Y
.44Y Z(
FAILED_TO_READ_SECURE_MEMORY44Z v
+44w x

readResult	44y É
.
44É Ñ
	UnwrapErr
44Ñ ç
(
44ç é
)
44é è
)
44è ê
;
44ê ë
}55 
byte77 
[77 
]77 
result77 
=77 
new77 
byte77  $
[77$ %
Length77% +
]77+ ,
;77, -

tempBuffer88 
.88 
AsSpan88 
(88 
)88 
[88  
..88  "
Length88" (
]88( )
.88) *
CopyTo88* 0
(880 1
result881 7
)887 8
;888 9
return99 
result99 
.99 
AsSpan99  
(99  !
$num99! "
,99" #
Length99$ *
)99* +
;99+ ,
}:: 	
throw<< 
new<< #
ObjectDisposedException<< )
(<<) *
nameof<<* 0
(<<0 1
SecureMemoryBuffer<<1 C
)<<C D
)<<D E
;<<E F
}== 
public?? 

Result?? 
<?? 
int?? 
,?? 
SodiumFailure?? $
>??$ %
ReadInto??& .
(??. /
Span??/ 3
<??3 4
byte??4 8
>??8 9
destination??: E
)??E F
{@@ 
ifAA 

(AA 
	_disposedAA 
)AA 
{BB 	
returnCC 
ResultCC 
<CC 
intCC 
,CC 
SodiumFailureCC ,
>CC, -
.CC- .
ErrCC. 1
(CC1 2
SodiumFailureDD 
.DD 
NullPointerDD )
(DD) *#
ProtocolSystemConstantsDD* A
.DDA B
ErrorMessagesDDB O
.DDO P
BUFFER_DISPOSEDDDP _
)DD_ `
)DD` a
;DDa b
}EE 	
intGG 
bytesToReadGG 
=GG 
MathGG 
.GG 
MinGG "
(GG" #
destinationGG# .
.GG. /
LengthGG/ 5
,GG5 6
LengthGG7 =
)GG= >
;GG> ?
usingHH 
SecurePooledArrayHH 
<HH  
byteHH  $
>HH$ %

tempBufferHH& 0
=HH1 2
SecureArrayPoolHH3 B
.HHB C
RentHHC G
<HHG H
byteHHH L
>HHL M
(HHM N
bytesToReadHHN Y
)HHY Z
;HHZ [
ResultJJ 
<JJ 
UnitJJ 
,JJ 
SodiumFailureJJ "
>JJ" #

readResultJJ$ .
=JJ/ 0
_handleJJ1 8
.JJ8 9
ReadJJ9 =
(JJ= >

tempBufferJJ> H
.JJH I
AsSpanJJI O
(JJO P
)JJP Q
)JJQ R
;JJR S
ifKK 

(KK 

readResultKK 
.KK 
IsErrKK 
)KK 
{LL 	
returnMM 
ResultMM 
<MM 
intMM 
,MM 
SodiumFailureMM ,
>MM, -
.MM- .
ErrMM. 1
(MM1 2

readResultMM2 <
.MM< =
	UnwrapErrMM= F
(MMF G
)MMG H
)MMH I
;MMI J
}NN 	

tempBufferPP 
.PP 
AsSpanPP 
(PP 
)PP 
[PP 
..PP 
bytesToReadPP )
]PP) *
.PP* +
CopyToPP+ 1
(PP1 2
destinationPP2 =
)PP= >
;PP> ?
returnQQ 
ResultQQ 
<QQ 
intQQ 
,QQ 
SodiumFailureQQ (
>QQ( )
.QQ) *
OkQQ* ,
(QQ, -
bytesToReadQQ- 8
)QQ8 9
;QQ9 :
}RR 
publicTT 

ResultTT 
<TT 
UnitTT 
,TT 
SodiumFailureTT %
>TT% &
ReadTT' +
(TT+ ,
SpanTT, 0
<TT0 1
byteTT1 5
>TT5 6
destinationTT7 B
)TTB C
{UU 
ifVV 

(VV 
	_disposedVV 
)VV 
{WW 	
returnXX 
ResultXX 
<XX 
UnitXX 
,XX 
SodiumFailureXX  -
>XX- .
.XX. /
ErrXX/ 2
(XX2 3
SodiumFailureYY 
.YY 
NullPointerYY )
(YY) *#
ProtocolSystemConstantsYY* A
.YYA B
ErrorMessagesYYB O
.YYO P
BUFFER_DISPOSEDYYP _
)YY_ `
)YY` a
;YYa b
}ZZ 	
return\\ 
_handle\\ 
.\\ 
Read\\ 
(\\ 
destination\\ '
)\\' (
;\\( )
}]] 
internal__ 
void__ 
Clear__ 
(__ 
)__ 
{`` 
ifaa 

(aa 
	_disposedaa 
)aa 
{bb 	
returncc 
;cc 
}dd 	
Spanff 
<ff 
byteff 
>ff 
zerosff 
=ff 

stackallocff %
byteff& *
[ff* +
Mathff+ /
.ff/ 0
Minff0 3
(ff3 4
AllocatedSizeff4 A
,ffA B#
ProtocolSystemConstantsffC Z
.ffZ [

MemoryPoolff[ e
.ffe f"
SECURE_WIPE_CHUNK_SIZEfff |
)ff| }
]ff} ~
;ff~ 
zerosgg 
.gg 
Cleargg 
(gg 
)gg 
;gg 
forii 
(ii 
intii 
offsetii 
=ii 
$numii 
;ii 
offsetii #
<ii$ %
AllocatedSizeii& 3
;ii3 4
offsetii5 ;
+=ii< >
zerosii? D
.iiD E
LengthiiE K
)iiK L
{jj 	
intkk 
	chunkSizekk 
=kk 
Mathkk  
.kk  !
Minkk! $
(kk$ %
zeroskk% *
.kk* +
Lengthkk+ 1
,kk1 2
AllocatedSizekk3 @
-kkA B
offsetkkC I
)kkI J
;kkJ K
_ll 
=ll 
_handlell 
.ll 
Writell 
(ll 
zerosll #
[ll# $
..ll$ &
	chunkSizell& /
]ll/ 0
)ll0 1
;ll1 2
}mm 	
}nn 
publicpp 

voidpp 
Disposepp 
(pp 
)pp 
{qq 
ifrr 

(rr 
	_disposedrr 
)rr 
{ss 	
returntt 
;tt 
}uu 	
	_disposedww 
=ww 
trueww 
;ww 
Clearxx 
(xx 
)xx 
;xx 
ifzz 

(zz 
_poolzz 
!=zz 
nullzz 
)zz 
{{{ 	
_pool|| 
.|| 
Return|| 
(|| 
this|| 
)|| 
;|| 
}}} 	
else~~ 
{ 	
_handle
ÄÄ 
?
ÄÄ 
.
ÄÄ 
Dispose
ÄÄ 
(
ÄÄ 
)
ÄÄ 
;
ÄÄ 
}
ÅÅ 	
}
ÇÇ 
}ÉÉ ∫2
x/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Utilities/SecureByteStringInterop.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
	Utilities# ,
;, -
internal 
static	 
class #
SecureByteStringInterop -
{		 
public

 

static

 
Result

 
<

 

ByteString

 #
,

# $
SodiumFailure

% 2
>

2 3,
 CreateByteStringFromSecureMemory

4 T
(

T U$
SodiumSecureMemoryHandle

U m
source

n t
,

t u
int

v y
length	

z Ä
)


Ä Å
{ !
ArgumentNullException 
. 
ThrowIfNull )
() *
source* 0
)0 1
;1 2
switch 
( 
length 
) 
{ 	
case 
< 
$num 
: 
return 
Result 
< 

ByteString (
,( )
SodiumFailure* 7
>7 8
.8 9
Err9 <
(< =
SodiumFailure !
.! "
InvalidBufferSize" 3
(3 4
$"4 6
$str6 Q
{Q R
lengthR X
}X Y
"Y Z
)Z [
)[ \
;\ ]
case 
$num 
: 
return 
Result 
< 

ByteString (
,( )
SodiumFailure* 7
>7 8
.8 9
Ok9 ;
(; <

ByteString< F
.F G
EmptyG L
)L M
;M N
} 	
if 

( 
length 
> 
source 
. 
Length "
)" #
{ 	
return 
Result 
< 

ByteString $
,$ %
SodiumFailure& 3
>3 4
.4 5
Err5 8
(8 9
SodiumFailure 
. 
InvalidBufferSize /
(/ 0
$"0 2
$str2 C
{C D
lengthD J
}J K
$strK b
{b c
sourcec i
.i j
Lengthj p
}p q
"q r
)r s
)s t
;t u
} 	
return 
source 
. 
WithReadAccess $
($ %
span% )
=>* ,
Result- 3
<3 4

ByteString4 >
,> ?
SodiumFailure@ M
>M N
.N O
OkO Q
(Q R

ByteStringR \
.\ ]
CopyFrom] e
(e f
spanf j
.j k
Slicek p
(p q
$numq r
,r s
lengtht z
)z {
){ |
)| }
)} ~
;~ 
} 
public   

static   
TResult    
WithByteStringAsSpan   .
<  . /
TResult  / 6
>  6 7
(  7 8

ByteString  8 B

byteString  C M
,  M N
Func  O S
<  S T
ReadOnlySpan  T `
<  ` a
byte  a e
>  e f
,  f g
TResult  h o
>  o p
	operation  q z
)  z {
{!! !
ArgumentNullException"" 
."" 
ThrowIfNull"" )
("") *

byteString""* 4
)""4 5
;""5 6!
ArgumentNullException## 
.## 
ThrowIfNull## )
(##) *
	operation##* 3
)##3 4
;##4 5
return%% 
	operation%% 
(%% 

byteString%% #
.%%# $
IsEmpty%%$ +
?%%, -
ReadOnlySpan%%. :
<%%: ;
byte%%; ?
>%%? @
.%%@ A
Empty%%A F
:%%G H

byteString%%I S
.%%S T
Span%%T X
)%%X Y
;%%Y Z
}&& 
public(( 

static(( 
void(( !
SecureCopyWithCleanup(( ,
(((, -

ByteString((- 7
source((8 >
,((> ?
out((@ C
byte((D H
[((H I
]((I J
destination((K V
)((V W
{)) 
if** 

(** 
source** 
.** 
IsEmpty** 
)** 
{++ 	
destination,, 
=,, 
[,, 
],, 
;,, 
return-- 
;-- 
}.. 	
destination00 
=00 
new00 
byte00 
[00 
source00 %
.00% &
Length00& ,
]00, -
;00- .
source11 
.11 
Span11 
.11 
CopyTo11 
(11 
destination11 &
)11& '
;11' (
}22 
public44 

static44 

ByteString44 $
CreateByteStringFromSpan44 5
(445 6
ReadOnlySpan446 B
<44B C
byte44C G
>44G H
source44I O
)44O P
{55 
return66 
source66 
.66 
IsEmpty66 
?66 

ByteString66  *
.66* +
Empty66+ 0
:661 2

ByteString663 =
.66= >
CopyFrom66> F
(66F G
source66G M
)66M N
;66N O
}77 
public99 

static99 
Result99 
<99 
Unit99 
,99 
SodiumFailure99 ,
>99, -,
 CopyFromByteStringToSecureMemory99. N
(99N O

ByteString99O Y
source99Z `
,99` a$
SodiumSecureMemoryHandle99b z
destination	99{ Ü
)
99Ü á
{:: 
return;; 
source;; 
.;; 
IsEmpty;; 
?;; 
Result;;  &
<;;& '
Unit;;' +
,;;+ ,
SodiumFailure;;- :
>;;: ;
.;;; <
Ok;;< >
(;;> ?
Unit;;? C
.;;C D
Value;;D I
);;I J
:;;K L
destination;;M X
.;;X Y
Write;;Y ^
(;;^ _
source;;_ e
.;;e f
Span;;f j
);;j k
;;;k l
}<< 
}== •
p/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Utilities/SecureArrayPool.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
	Utilities# ,
;, -
internal 
static	 
class 
SecureArrayPool %
{ 
public 

static 
SecurePooledArray #
<# $
T$ %
>% &
Rent' +
<+ ,
T, -
>- .
(. /
int/ 2
minimumLength3 @
)@ A
whereB G
TH I
:J K
structL R
{ 
return 
new 
SecurePooledArray $
<$ %
T% &
>& '
(' (
minimumLength( 5
)5 6
;6 7
} 
}		 √
}/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Utilities/ScopedSecureMemoryCollection.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
	Utilities# ,
;, -
internal 
sealed	 
class (
ScopedSecureMemoryCollection 2
:3 4
IDisposable5 @
{ 
private 
readonly 
List 
< 
IDisposable %
>% &

_resources' 1
=2 3
new4 7
(7 8
)8 9
;9 :
private 
bool 
	_disposed 
; 
public 

ScopedSecureMemory 
Allocate &
(& '
int' *
size+ /
)/ 0
{		 #
ObjectDisposedException

 
.

  
ThrowIf

  '
(

' (
	_disposed

( 1
,

1 2
this

3 7
)

7 8
;

8 9
ScopedSecureMemory 
memory !
=" #
ScopedSecureMemory$ 6
.6 7
Allocate7 ?
(? @
size@ D
)D E
;E F

_resources 
. 
Add 
( 
memory 
) 
; 
return 
memory 
; 
} 
public 

void 
Dispose 
( 
) 
{ 
if 

( 
	_disposed 
) 
{ 	
return 
; 
} 	
for 
( 
int 
i 
= 

_resources 
.  
Count  %
-& '
$num( )
;) *
i+ ,
>=- /
$num0 1
;1 2
i3 4
--4 6
)6 7
{ 	
try 
{ 

_resources 
[ 
i 
] 
. 
Dispose %
(% &
)& '
;' (
} 
catch 
( 
	Exception 
ex 
)  
{ 
Serilog   
.   
Log   
.   
Error   !
(  ! "
ex  " $
,  $ %
$str	  & è
,
  è ê
i!! 
)!! 
;!! 
}"" 
}## 	

_resources%% 
.%% 
Clear%% 
(%% 
)%% 
;%% 
	_disposed&& 
=&& 
true&& 
;&& 
}'' 
}(( §
s/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Utilities/ScopedSecureMemory.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
	Utilities# ,
;, -
internal 
sealed	 
class 
ScopedSecureMemory (
:) *
IDisposable+ 6
{ 
private 
byte 
[ 
] 
? 
_data 
; 
private 
readonly 
bool 
_clearOnDispose )
;) *
private		 
bool		 
	_disposed		 
;		 
private 
ScopedSecureMemory 
( 
byte #
[# $
]$ %
data& *
,* +
bool, 0
clearOnDispose1 ?
=@ A
trueB F
)F G
{ 
_data 
= 
data 
; 
_clearOnDispose 
= 
clearOnDispose (
;( )
} 
public 

static 
ScopedSecureMemory $
Allocate% -
(- .
int. 1
size2 6
)6 7
{ 
return 
size 
<= 
$num 
? 
throw  
new! $
ArgumentException% 6
(6 7#
ProtocolSystemConstants7 N
.N O
ErrorMessagesO \
.\ ]
SIZE_POSITIVE] j
,j k
nameofl r
(r s
sizes w
)w x
)x y
:z {
new|  
ScopedSecureMemory
Ä í
(
í ì
new
ì ñ
byte
ó õ
[
õ ú
size
ú †
]
† °
)
° ¢
;
¢ £
} 
public 

static 
ScopedSecureMemory $
Wrap% )
() *
byte* .
[. /
]/ 0
data1 5
,5 6
bool7 ;
clearOnDispose< J
=K L
trueM Q
)Q R
{ 
return 
new 
ScopedSecureMemory %
(% &
data& *
,* +
clearOnDispose, :
): ;
;; <
} 
public 

Span 
< 
byte 
> 
AsSpan 
( 
) 
{ #
ObjectDisposedException 
.  
ThrowIf  '
(' (
	_disposed( 1
,1 2
this3 7
)7 8
;8 9
return 
_data 
! 
. 
AsSpan 
( 
) 
; 
} 
public!! 

void!! 
Dispose!! 
(!! 
)!! 
{"" 
if## 

(## 
	_disposed## 
)## 
{$$ 	
return%% 
;%% 
}&& 	
if(( 

((( 
_data(( 
!=(( 
null(( 
&&(( 
_clearOnDispose(( ,
)((, -
{)) 	#
CryptographicOperations** #
.**# $

ZeroMemory**$ .
(**. /
_data**/ 4
)**4 5
;**5 6
}++ 	
_data-- 
=-- 
null-- 
;-- 
	_disposed.. 
=.. 
true.. 
;.. 
}// 
}00 ∂≥
p/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Utilities/EnvelopeBuilder.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
	Utilities# ,
;, -
internal		 
static			 
class		 
EnvelopeBuilder		 %
{

 
public 

static 
EnvelopeMetadata ""
CreateEnvelopeMetadata# 9
(9 :
uint 
	requestId 
, 

ByteString 
nonce 
, 
uint 
ratchetIndex 
, 
byte 
[ 
] 
? 
channelKeyId 
= 
null #
,# $
EnvelopeType 
envelopeType !
=" #
EnvelopeType$ 0
.0 1
Request1 8
,8 9
string 
? 
correlationId 
= 
null  $
)$ %
{ 
EnvelopeMetadata 
metadata !
=" #
new$ '
(' (
)( )
{ 	

EnvelopeId 
= 
	requestId "
." #
ToString# +
(+ ,
), -
,- .
Nonce 
= 
nonce 
, 
RatchetIndex 
= 
ratchetIndex '
,' (
EnvelopeType 
= 
envelopeType '
} 	
;	 

metadata 
. 
ChannelKeyId 
= 
channelKeyId 
is 
{ 
Length $
:$ %
>& '
$num( )
}* +
?, -

ByteString. 8
.8 9
CopyFrom9 A
(A B
channelKeyIdB N
)N O
:P Q 
GenerateChannelKeyIdR f
(f g
)g h
;h i
if 

( 
! 
string 
. 
IsNullOrEmpty !
(! "
correlationId" /
)/ 0
)0 1
{ 	
metadata   
.   
CorrelationId   "
=  # $
correlationId  % 2
;  2 3
}!! 	
return## 
metadata## 
;## 
}$$ 
public&& 

static&& 
SecureEnvelope&&   
CreateSecureEnvelope&&! 5
(&&5 6
EnvelopeMetadata'' 
metadata'' !
,''! "

ByteString(( 
encryptedPayload(( #
,((# $
	Timestamp)) 
?)) 
	timestamp)) 
=)) 
null)) #
,))# $

ByteString** 
?** 
authenticationTag** %
=**& '
null**( ,
,**, -
EnvelopeResultCode++ 

resultCode++ %
=++& '
EnvelopeResultCode++( :
.++: ;
Success++; B
,++B C

ByteString,, 
?,, 
errorDetails,,  
=,,! "
null,,# '
,,,' (

ByteString-- 
?-- 
headerNonce-- 
=--  !
null--" &
,--& '

ByteString.. 
?.. 
dhPublicKey.. 
=..  !
null.." &
)..& '
{// 
SecureEnvelope00 
envelope00 
=00  !
new00" %
(00% &
)00& '
{11 	
MetaData22 
=22 
metadata22 
.22  
ToByteString22  ,
(22, -
)22- .
,22. /
EncryptedPayload33 
=33 
encryptedPayload33 /
,33/ 0

ResultCode44 
=44 

ByteString44 #
.44# $
CopyFrom44$ ,
(44, -
BitConverter44- 9
.449 :
GetBytes44: B
(44B C
(44C D
int44D G
)44G H

resultCode44H R
)44R S
)44S T
,44T U
	Timestamp55 
=55 
	timestamp55 !
??55" $
	Timestamp55% .
.55. /
FromDateTimeOffset55/ A
(55A B
DateTimeOffset55B P
.55P Q
UtcNow55Q W
)55W X
,55X Y
HeaderNonce66 
=66 
headerNonce66 %
??66& (

ByteString66) 3
.663 4
Empty664 9
,669 :
DhPublicKey77 
=77 
dhPublicKey77 %
??77& (

ByteString77) 3
.773 4
Empty774 9
}88 	
;88	 

if:: 

(:: 
authenticationTag:: 
!=::  
null::! %
&&::& (
!::) *
authenticationTag::* ;
.::; <
IsEmpty::< C
)::C D
{;; 	
envelope<< 
.<< 
AuthenticationTag<< &
=<<' (
authenticationTag<<) :
;<<: ;
}== 	
if?? 

(?? 
errorDetails?? 
!=?? 
null??  
&&??! #
!??$ %
errorDetails??% 1
.??1 2
IsEmpty??2 9
)??9 :
{@@ 	
envelopeAA 
.AA 
ErrorDetailsAA !
=AA" #
errorDetailsAA$ 0
;AA0 1
}BB 	
returnDD 
envelopeDD 
;DD 
}EE 
publicGG 

staticGG 
ResultGG 
<GG 
EnvelopeMetadataGG )
,GG) *#
EcliptixProtocolFailureGG+ B
>GGB C!
ParseEnvelopeMetadataGGD Y
(GGY Z

ByteStringGGZ d
metaDataBytesGGe r
)GGr s
{HH 
tryII 
{JJ 	#
SecureByteStringInteropKK #
.KK# $!
SecureCopyWithCleanupKK$ 9
(KK9 :
metaDataBytesKK: G
,KKG H
outKKI L
byteKKM Q
[KKQ R
]KKR S
metaDataArrayKKT a
)KKa b
;KKb c
tryLL 
{MM 
EnvelopeMetadataNN  
metadataNN! )
=NN* +
EnvelopeMetadataNN, <
.NN< =
ParserNN= C
.NNC D
	ParseFromNND M
(NNM N
metaDataArrayNNN [
)NN[ \
;NN\ ]
returnOO 
ResultOO 
<OO 
EnvelopeMetadataOO .
,OO. /#
EcliptixProtocolFailureOO0 G
>OOG H
.OOH I
OkOOI K
(OOK L
metadataOOL T
)OOT U
;OOU V
}PP 
finallyQQ 
{RR 
ArraySS 
.SS 
ClearSS 
(SS 
metaDataArraySS )
)SS) *
;SS* +
}TT 
}UU 	
catchVV 
(VV 
	ExceptionVV 
exVV 
)VV 
{WW 	
returnXX 
ResultXX 
<XX 
EnvelopeMetadataXX *
,XX* +#
EcliptixProtocolFailureXX, C
>XXC D
.XXD E
ErrXXE H
(XXH I#
EcliptixProtocolFailureYY '
.YY' (
DecodeYY( .
(YY. /
$"YY/ 1
$strYY1 S
{YYS T
exYYT V
.YYV W
MessageYYW ^
}YY^ _
"YY_ `
,YY` a
exYYb d
)YYd e
)YYe f
;YYf g
}ZZ 	
}[[ 
public]] 

static]] 
Result]] 
<]] 
EnvelopeResultCode]] +
,]]+ ,#
EcliptixProtocolFailure]]- D
>]]D E
ParseResultCode]]F U
(]]U V

ByteString]]V `
resultCodeBytes]]a p
)]]p q
{^^ 
try__ 
{`` 	
ifaa 
(aa 
resultCodeBytesaa 
.aa  
Lengthaa  &
!=aa' )
sizeofaa* 0
(aa0 1
intaa1 4
)aa4 5
)aa5 6
{bb 
returncc 
Resultcc 
<cc 
EnvelopeResultCodecc 0
,cc0 1#
EcliptixProtocolFailurecc2 I
>ccI J
.ccJ K
ErrccK N
(ccN O#
EcliptixProtocolFailuredd +
.dd+ ,
Decodedd, 2
(dd2 3
$strdd3 O
)ddO P
)ddP Q
;ddQ R
}ee 
intgg 
resultCodeValuegg 
=gg  !
BitConvertergg" .
.gg. /
ToInt32gg/ 6
(gg6 7
resultCodeBytesgg7 F
.ggF G
SpanggG K
)ggK L
;ggL M
ifhh 
(hh 
!hh 
globalhh 
::hh 
Systemhh 
.hh  
Enumhh  $
.hh$ %
	IsDefinedhh% .
(hh. /
typeofhh/ 5
(hh5 6
EnvelopeResultCodehh6 H
)hhH I
,hhI J
resultCodeValuehhK Z
)hhZ [
)hh[ \
{ii 
returnjj 
Resultjj 
<jj 
EnvelopeResultCodejj 0
,jj0 1#
EcliptixProtocolFailurejj2 I
>jjI J
.jjJ K
ErrjjK N
(jjN O#
EcliptixProtocolFailurekk +
.kk+ ,
Decodekk, 2
(kk2 3
$"kk3 5
$strkk5 P
{kkP Q
resultCodeValuekkQ `
}kk` a
"kka b
)kkb c
)kkc d
;kkd e
}ll 
EnvelopeResultCodenn 

resultCodenn )
=nn* +
(nn, -
EnvelopeResultCodenn- ?
)nn? @
resultCodeValuenn@ O
;nnO P
returnoo 
Resultoo 
<oo 
EnvelopeResultCodeoo ,
,oo, -#
EcliptixProtocolFailureoo. E
>ooE F
.ooF G
OkooG I
(ooI J

resultCodeooJ T
)ooT U
;ooU V
}pp 	
catchqq 
(qq 
	Exceptionqq 
exqq 
)qq 
{rr 	
returnss 
Resultss 
<ss 
EnvelopeResultCodess ,
,ss, -#
EcliptixProtocolFailuress. E
>ssE F
.ssF G
ErrssG J
(ssJ K#
EcliptixProtocolFailurett '
.tt' (
Decodett( .
(tt. /
$"tt/ 1
$strtt1 N
{ttN O
exttO Q
.ttQ R
MessagettR Y
}ttY Z
"ttZ [
,tt[ \
extt] _
)tt_ `
)tt` a
;tta b
}uu 	
}vv 
publicxx 

staticxx 
uintxx *
ExtractRequestIdFromEnvelopeIdxx 5
(xx5 6
stringxx6 <

envelopeIdxx= G
)xxG H
{yy 
ifzz 

(zz 
uintzz 
.zz 
TryParsezz 
(zz 

envelopeIdzz $
,zz$ %
outzz& )
uintzz* .
	requestIdzz/ 8
)zz8 9
)zz9 :
{{{ 	
return|| 
	requestId|| 
;|| 
}}} 	
return 
Helpers 
.  
GenerateRandomUInt32 +
(+ ,
true, 0
)0 1
;1 2
}
ÄÄ 
private
ÇÇ 
static
ÇÇ 

ByteString
ÇÇ "
GenerateChannelKeyId
ÇÇ 2
(
ÇÇ2 3
)
ÇÇ3 4
{
ÉÉ 
byte
ÑÑ 
[
ÑÑ 
]
ÑÑ 
keyId
ÑÑ 
=
ÑÑ 
new
ÑÑ 
byte
ÑÑ 
[
ÑÑ  
$num
ÑÑ  "
]
ÑÑ" #
;
ÑÑ# $
global
ÖÖ 
::
ÖÖ 
System
ÖÖ 
.
ÖÖ 
Security
ÖÖ 
.
ÖÖ  
Cryptography
ÖÖ  ,
.
ÖÖ, -#
RandomNumberGenerator
ÖÖ- B
.
ÖÖB C
Fill
ÖÖC G
(
ÖÖG H
keyId
ÖÖH M
)
ÖÖM N
;
ÖÖN O
return
ÜÜ 

ByteString
ÜÜ 
.
ÜÜ 
CopyFrom
ÜÜ "
(
ÜÜ" #
keyId
ÜÜ# (
)
ÜÜ( )
;
ÜÜ) *
}
áá 
public
ââ 

static
ââ 
Result
ââ 
<
ââ 
byte
ââ 
[
ââ 
]
ââ 
,
ââ  %
EcliptixProtocolFailure
ââ! 8
>
ââ8 9
EncryptMetadata
ââ: I
(
ââI J
EnvelopeMetadata
ää 
metadata
ää !
,
ää! "
byte
ãã 
[
ãã 
]
ãã !
headerEncryptionKey
ãã "
,
ãã" #
byte
åå 
[
åå 
]
åå 
headerNonce
åå 
,
åå 
byte
çç 
[
çç 
]
çç 
associatedData
çç 
)
çç 
{
éé 
byte
èè 
[
èè 
]
èè 
?
èè 
metadataBytes
èè 
=
èè 
null
èè  $
;
èè$ %
byte
êê 
[
êê 
]
êê 
?
êê 

ciphertext
êê 
=
êê 
null
êê !
;
êê! "
byte
ëë 
[
ëë 
]
ëë 
?
ëë 
tag
ëë 
=
ëë 
null
ëë 
;
ëë 
try
íí 
{
ìì 	
metadataBytes
îî 
=
îî 
metadata
îî $
.
îî$ %
ToByteArray
îî% 0
(
îî0 1
)
îî1 2
;
îî2 3

ciphertext
ññ 
=
ññ 
new
ññ 
byte
ññ !
[
ññ! "
metadataBytes
ññ" /
.
ññ/ 0
Length
ññ0 6
]
ññ6 7
;
ññ7 8
tag
óó 
=
óó 
new
óó 
byte
óó 
[
óó 
	Constants
óó $
.
óó$ %
AES_GCM_TAG_SIZE
óó% 5
]
óó5 6
;
óó6 7
using
ôô 
(
ôô 
global
ôô 
::
ôô 
System
ôô !
.
ôô! "
Security
ôô" *
.
ôô* +
Cryptography
ôô+ 7
.
ôô7 8
AesGcm
ôô8 >
aesGcm
ôô? E
=
ôôF G
new
öö 
(
öö !
headerEncryptionKey
öö '
,
öö' (
	Constants
öö) 2
.
öö2 3
AES_GCM_TAG_SIZE
öö3 C
)
ööC D
)
ööD E
{
õõ 
aesGcm
úú 
.
úú 
Encrypt
úú 
(
úú 
headerNonce
úú *
,
úú* +
metadataBytes
úú, 9
,
úú9 :

ciphertext
úú; E
,
úúE F
tag
úúG J
,
úúJ K
associatedData
úúL Z
)
úúZ [
;
úú[ \
}
ùù 
byte
üü 
[
üü 
]
üü 
result
üü 
=
üü 
new
üü 
byte
üü  $
[
üü$ %

ciphertext
üü% /
.
üü/ 0
Length
üü0 6
+
üü7 8
tag
üü9 <
.
üü< =
Length
üü= C
]
üüC D
;
üüD E
Buffer
†† 
.
†† 
	BlockCopy
†† 
(
†† 

ciphertext
†† '
,
††' (
$num
††) *
,
††* +
result
††, 2
,
††2 3
$num
††4 5
,
††5 6

ciphertext
††7 A
.
††A B
Length
††B H
)
††H I
;
††I J
Buffer
°° 
.
°° 
	BlockCopy
°° 
(
°° 
tag
°°  
,
°°  !
$num
°°" #
,
°°# $
result
°°% +
,
°°+ ,

ciphertext
°°- 7
.
°°7 8
Length
°°8 >
,
°°> ?
tag
°°@ C
.
°°C D
Length
°°D J
)
°°J K
;
°°K L
return
££ 
Result
££ 
<
££ 
byte
££ 
[
££ 
]
££  
,
££  !%
EcliptixProtocolFailure
££" 9
>
££9 :
.
££: ;
Ok
££; =
(
££= >
result
££> D
)
££D E
;
££E F
}
§§ 	
catch
•• 
(
•• 
	Exception
•• 
ex
•• 
)
•• 
{
¶¶ 	
return
ßß 
Result
ßß 
<
ßß 
byte
ßß 
[
ßß 
]
ßß  
,
ßß  !%
EcliptixProtocolFailure
ßß" 9
>
ßß9 :
.
ßß: ;
Err
ßß; >
(
ßß> ?%
EcliptixProtocolFailure
®® '
.
®®' (
Generic
®®( /
(
®®/ 0
$str
®®0 L
,
®®L M
ex
®®N P
)
®®P Q
)
®®Q R
;
®®R S
}
©© 	
finally
™™ 
{
´´ 	
if
¨¨ 
(
¨¨ 
metadataBytes
¨¨ 
!=
¨¨  
null
¨¨! %
)
¨¨% &
{
≠≠ 
Sodium
ÆÆ 
.
ÆÆ 
SodiumInterop
ÆÆ $
.
ÆÆ$ %

SecureWipe
ÆÆ% /
(
ÆÆ/ 0
metadataBytes
ÆÆ0 =
)
ÆÆ= >
;
ÆÆ> ?
}
ØØ 
if
±± 
(
±± 

ciphertext
±± 
!=
±± 
null
±± "
)
±±" #
{
≤≤ 
Sodium
≥≥ 
.
≥≥ 
SodiumInterop
≥≥ $
.
≥≥$ %

SecureWipe
≥≥% /
(
≥≥/ 0

ciphertext
≥≥0 :
)
≥≥: ;
;
≥≥; <
}
¥¥ 
if
∂∂ 
(
∂∂ 
tag
∂∂ 
!=
∂∂ 
null
∂∂ 
)
∂∂ 
{
∑∑ 
Sodium
∏∏ 
.
∏∏ 
SodiumInterop
∏∏ $
.
∏∏$ %

SecureWipe
∏∏% /
(
∏∏/ 0
tag
∏∏0 3
)
∏∏3 4
;
∏∏4 5
}
ππ 
}
∫∫ 	
}
ªª 
public
ΩΩ 

static
ΩΩ 
Result
ΩΩ 
<
ΩΩ 
EnvelopeMetadata
ΩΩ )
,
ΩΩ) *%
EcliptixProtocolFailure
ΩΩ+ B
>
ΩΩB C
DecryptMetadata
ΩΩD S
(
ΩΩS T
byte
ææ 
[
ææ 
]
ææ 
encryptedMetadata
ææ  
,
ææ  !
byte
øø 
[
øø 
]
øø !
headerEncryptionKey
øø "
,
øø" #
byte
¿¿ 
[
¿¿ 
]
¿¿ 
headerNonce
¿¿ 
,
¿¿ 
byte
¡¡ 
[
¡¡ 
]
¡¡ 
associatedData
¡¡ 
)
¡¡ 
{
¬¬ 
byte
√√ 
[
√√ 
]
√√ 
?
√√ 
	plaintext
√√ 
=
√√ 
null
√√  
;
√√  !
try
ƒƒ 
{
≈≈ 	
int
∆∆ 
cipherLength
∆∆ 
=
∆∆ 
encryptedMetadata
∆∆ 0
.
∆∆0 1
Length
∆∆1 7
-
∆∆8 9
	Constants
∆∆: C
.
∆∆C D
AES_GCM_TAG_SIZE
∆∆D T
;
∆∆T U
if
«« 
(
«« 
cipherLength
«« 
<
«« 
$num
««  
)
««  !
{
»» 
return
…… 
Result
…… 
<
…… 
EnvelopeMetadata
…… .
,
……. /%
EcliptixProtocolFailure
……0 G
>
……G H
.
……H I
Err
……I L
(
……L M%
EcliptixProtocolFailure
   +
.
  + ,
BUFFER_TOO_SMALL
  , <
(
  < =
$str
  = [
)
  [ \
)
  \ ]
;
  ] ^
}
ÀÀ 
ReadOnlySpan
ÕÕ 
<
ÕÕ 
byte
ÕÕ 
>
ÕÕ 
ciphertextSpan
ÕÕ -
=
ÕÕ. /
encryptedMetadata
ÕÕ0 A
.
ÕÕA B
AsSpan
ÕÕB H
(
ÕÕH I
$num
ÕÕI J
,
ÕÕJ K
cipherLength
ÕÕL X
)
ÕÕX Y
;
ÕÕY Z
ReadOnlySpan
ŒŒ 
<
ŒŒ 
byte
ŒŒ 
>
ŒŒ 
tagSpan
ŒŒ &
=
ŒŒ' (
encryptedMetadata
ŒŒ) :
.
ŒŒ: ;
AsSpan
ŒŒ; A
(
ŒŒA B
cipherLength
ŒŒB N
)
ŒŒN O
;
ŒŒO P
	plaintext
–– 
=
–– 
new
–– 
byte
––  
[
––  !
cipherLength
––! -
]
––- .
;
––. /
using
““ 
(
““ 
global
““ 
::
““ 
System
““ !
.
““! "
Security
““" *
.
““* +
Cryptography
““+ 7
.
““7 8
AesGcm
““8 >
aesGcm
““? E
=
““F G
new
”” 
(
”” !
headerEncryptionKey
”” '
,
””' (
	Constants
””) 2
.
””2 3
AES_GCM_TAG_SIZE
””3 C
)
””C D
)
””D E
{
‘‘ 
aesGcm
’’ 
.
’’ 
Decrypt
’’ 
(
’’ 
headerNonce
’’ *
,
’’* +
ciphertextSpan
’’, :
,
’’: ;
tagSpan
’’< C
,
’’C D
	plaintext
’’E N
,
’’N O
associatedData
’’P ^
)
’’^ _
;
’’_ `
}
÷÷ 
EnvelopeMetadata
ÿÿ 
metadata
ÿÿ %
=
ÿÿ& '
EnvelopeMetadata
ÿÿ( 8
.
ÿÿ8 9
Parser
ÿÿ9 ?
.
ÿÿ? @
	ParseFrom
ÿÿ@ I
(
ÿÿI J
	plaintext
ÿÿJ S
)
ÿÿS T
;
ÿÿT U
return
ŸŸ 
Result
ŸŸ 
<
ŸŸ 
EnvelopeMetadata
ŸŸ *
,
ŸŸ* +%
EcliptixProtocolFailure
ŸŸ, C
>
ŸŸC D
.
ŸŸD E
Ok
ŸŸE G
(
ŸŸG H
metadata
ŸŸH P
)
ŸŸP Q
;
ŸŸQ R
}
⁄⁄ 	
catch
€€ 
(
€€ 
global
€€ 
::
€€ 
System
€€ 
.
€€ 
Security
€€ &
.
€€& '
Cryptography
€€' 3
.
€€3 4$
CryptographicException
€€4 J
cryptoEx
€€K S
)
€€S T
{
‹‹ 	
return
›› 
Result
›› 
<
›› 
EnvelopeMetadata
›› *
,
››* +%
EcliptixProtocolFailure
››, C
>
››C D
.
››D E
Err
››E H
(
››H I%
EcliptixProtocolFailure
ﬁﬁ '
.
ﬁﬁ' (
StateMismatch
ﬁﬁ( 5
(
ﬁﬁ5 6
$str
ﬁﬁ6 T
,
ﬁﬁT U
cryptoEx
ﬁﬁV ^
)
ﬁﬁ^ _
)
ﬁﬁ_ `
;
ﬁﬁ` a
}
ﬂﬂ 	
catch
‡‡ 
(
‡‡ 
	Exception
‡‡ 
ex
‡‡ 
)
‡‡ 
{
·· 	
return
‚‚ 
Result
‚‚ 
<
‚‚ 
EnvelopeMetadata
‚‚ *
,
‚‚* +%
EcliptixProtocolFailure
‚‚, C
>
‚‚C D
.
‚‚D E
Err
‚‚E H
(
‚‚H I%
EcliptixProtocolFailure
„„ '
.
„„' (
Generic
„„( /
(
„„/ 0
$str
„„0 L
,
„„L M
ex
„„N P
)
„„P Q
)
„„Q R
;
„„R S
}
‰‰ 	
finally
ÂÂ 
{
ÊÊ 	
if
ÁÁ 
(
ÁÁ 
	plaintext
ÁÁ 
!=
ÁÁ 
null
ÁÁ !
)
ÁÁ! "
{
ËË 
Sodium
ÈÈ 
.
ÈÈ 
SodiumInterop
ÈÈ $
.
ÈÈ$ %

SecureWipe
ÈÈ% /
(
ÈÈ/ 0
	plaintext
ÈÈ0 9
)
ÈÈ9 :
;
ÈÈ: ;
}
ÍÍ 
}
ÎÎ 	
}
ÏÏ 
}ÌÌ ◊ø
v/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Sodium/SodiumSecureMemoryHandle.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Sodium# )
;) *
public 
sealed 
class $
SodiumSecureMemoryHandle ,
:- .

SafeHandle/ 9
{		 
private

 
readonly

  
ReaderWriterLockSlim

 )
_lock

* /
=

0 1
new

2 5
(

5 6
)

6 7
;

7 8
private 
bool 
	_isLocked 
; 
public 

int 
Length 
{ 
get 
; 
} 
public 

override 
bool 
	IsInvalid "
=># %
handle& ,
==- /
IntPtr0 6
.6 7
Zero7 ;
;; <
private $
SodiumSecureMemoryHandle $
($ %
IntPtr% +
preexistingHandle, =
,= >
int? B
lengthC I
,I J
boolK O

ownsHandleP Z
)Z [
: 	
base
 
( 
IntPtr 
. 
Zero 
, 

ownsHandle &
)& '
{ 
	SetHandle 
( 
preexistingHandle #
)# $
;$ %
Length 
= 
length 
; 
	_isLocked 
= 
false 
; 
if 

( 
length 
> 
$num 
&& 
preexistingHandle +
!=, .
IntPtr/ 5
.5 6
Zero6 :
): ;
{ 	
TryLockMemory 
( 
) 
; 
} 	
} 
public 

static 
Result 
< $
SodiumSecureMemoryHandle 1
,1 2
SodiumFailure3 @
>@ A
AllocateB J
(J K
intK N
lengthO U
)U V
{ 
switch   
(   
length   
)   
{!! 	
case"" 
<"" 
$num"" 
:"" 
return## 
Result## 
<## $
SodiumSecureMemoryHandle## 6
,##6 7
SodiumFailure##8 E
>##E F
.##F G
Err##G J
(##J K
SodiumFailure$$ !
.$$! "
InvalidBufferSize$$" 3
($$3 4
string$$4 :
.$$: ;
Format$$; A
($$A B!
SodiumFailureMessages$$B W
.$$W X&
NEGATIVE_ALLOCATION_LENGTH$$X r
,$$r s
length%% 
)%% 
)%%  
)%%  !
;%%! "
case&& 
$num&& 
:&& 
return'' 
Result'' 
<'' $
SodiumSecureMemoryHandle'' 6
,''6 7
SodiumFailure''8 E
>''E F
.''F G
Ok''G I
(''I J
new(( $
SodiumSecureMemoryHandle(( 0
(((0 1
IntPtr((1 7
.((7 8
Zero((8 <
,((< =
$num((> ?
,((? @
true((A E
)((E F
)((F G
;((G H
})) 	
if++ 

(++ 
!++ 
SodiumInterop++ 
.++ 
IsInitialized++ (
)++( )
{,, 	
return-- 
Result-- 
<-- $
SodiumSecureMemoryHandle-- 2
,--2 3
SodiumFailure--4 A
>--A B
.--B C
Err--C F
(--F G
SodiumFailure.. 
... !
INITIALIZATION_FAILED.. 3
(..3 4!
SodiumFailureMessages..4 I
...I J"
SODIUM_NOT_INITIALIZED..J `
)..` a
)..a b
;..b c
}// 	
Result11 
<11 
IntPtr11 
,11 
SodiumFailure11 $
>11$ %
allocationResult11& 6
=117 8$
ExecuteWithErrorHandling119 Q
(11Q R
(22 
)22 
=>22 
SodiumInterop22 
.22  
sodium_malloc22  -
(22- .
(22. /
UIntPtr22/ 6
)226 7
length227 =
)22= >
,22> ?
ex33 
=>33 
SodiumFailure33 
.33  
ALLOCATION_FAILED33  1
(331 2
string44 
.44 
Format44 
(44 !
SodiumFailureMessages44 3
.443 4'
UNEXPECTED_ALLOCATION_ERROR444 O
,44O P
length44Q W
)44W X
,44X Y
ex44Z \
)44\ ]
)55 	
;55	 

if77 

(77 
allocationResult77 
.77 
IsErr77 "
)77" #
{88 	
return99 
Result99 
<99 $
SodiumSecureMemoryHandle99 2
,992 3
SodiumFailure994 A
>99A B
.99B C
Err99C F
(99F G
allocationResult99G W
.99W X
	UnwrapErr99X a
(99a b
)99b c
)99c d
;99d e
}:: 	
IntPtr<< 
ptr<< 
=<< 
allocationResult<< %
.<<% &
Unwrap<<& ,
(<<, -
)<<- .
;<<. /
if== 

(== 
ptr== 
==== 
IntPtr== 
.== 
Zero== 
)== 
{>> 	
return?? 
Result?? 
<?? $
SodiumSecureMemoryHandle?? 2
,??2 3
SodiumFailure??4 A
>??A B
.??B C
Err??C F
(??F G
SodiumFailure@@ 
.@@ 
ALLOCATION_FAILED@@ /
(@@/ 0
string@@0 6
.@@6 7
Format@@7 =
(@@= >!
SodiumFailureMessages@@> S
.@@S T
ALLOCATION_FAILED@@T e
,@@e f
lengthAA 
)AA 
)AA 
)AA 
;AA 
}BB 	
returnDD 
ResultDD 
<DD $
SodiumSecureMemoryHandleDD .
,DD. /
SodiumFailureDD0 =
>DD= >
.DD> ?
OkDD? A
(DDA B
newEE $
SodiumSecureMemoryHandleEE (
(EE( )
ptrEE) ,
,EE, -
lengthEE. 4
,EE4 5
trueEE6 :
)EE: ;
)EE; <
;EE< =
}FF 
publicHH 

ResultHH 
<HH 
UnitHH 
,HH 
SodiumFailureHH %
>HH% &
WriteHH' ,
(HH, -
ReadOnlySpanHH- 9
<HH9 :
byteHH: >
>HH> ?
dataHH@ D
)HHD E
{II 
_lockJJ 
.JJ 
EnterWriteLockJJ 
(JJ 
)JJ 
;JJ 
boolLL 
successLL 
=LL 
falseLL 
;LL 
tryNN 
{OO 	
ifPP 
(PP 
	IsInvalidPP 
||PP 
IsClosedPP %
)PP% &
{QQ 
returnRR 
ResultRR 
<RR 
UnitRR "
,RR" #
SodiumFailureRR$ 1
>RR1 2
.RR2 3
ErrRR3 6
(RR6 7
SodiumFailureSS !
.SS! "
NullPointerSS" -
(SS- .#
ProtocolSystemConstantsSS. E
.SSE F
ErrorMessagesSSF S
.SSS T
HANDLE_DISPOSEDSST c
)SSc d
)SSd e
;SSe f
}TT 
ifVV 
(VV 
dataVV 
.VV 
LengthVV 
>VV 
LengthVV $
)VV$ %
{WW 
returnXX 
ResultXX 
<XX 
UnitXX "
,XX" #
SodiumFailureXX$ 1
>XX1 2
.XX2 3
ErrXX3 6
(XX6 7
SodiumFailureYY !
.YY! "
BUFFER_TOO_LARGEYY" 2
(YY2 3
stringYY3 9
.YY9 :
FormatYY: @
(YY@ A#
ProtocolSystemConstantsYYA X
.YYX Y
ErrorMessagesYYY f
.YYf g
DATA_EXCEEDS_BUFFERYYg z
,YYz {
data	YY| Ä
.
YYÄ Å
Length
YYÅ á
,
YYá à
Length
YYâ è
)
YYè ê
)
YYê ë
)
YYë í
;
YYí ì
}ZZ 
if\\ 
(\\ 
data\\ 
.\\ 
IsEmpty\\ 
)\\ 
{]] 
return^^ 
Result^^ 
<^^ 
Unit^^ "
,^^" #
SodiumFailure^^$ 1
>^^1 2
.^^2 3
Ok^^3 5
(^^5 6
Unit^^6 :
.^^: ;
Value^^; @
)^^@ A
;^^A B
}__ 
DangerousAddRefaa 
(aa 
refaa 
successaa  '
)aa' (
;aa( )
ifbb 
(bb 
!bb 
successbb 
)bb 
{cc 
returndd 
Resultdd 
<dd 
Unitdd "
,dd" #
SodiumFailuredd$ 1
>dd1 2
.dd2 3
Errdd3 6
(dd6 7
SodiumFailureee !
.ee! "
MemoryPinningFailedee" 5
(ee5 6#
ProtocolSystemConstantsee6 M
.eeM N
ErrorMessageseeN [
.ee[ \
REF_COUNT_FAILEDee\ l
)eel m
)eem n
;een o
}ff 
unsafehh 
{ii 
Bufferjj 
.jj 

MemoryCopyjj !
(jj! "
Unsafekk 
.kk 
	AsPointerkk $
(kk$ %
refkk% (
MemoryMarshalkk) 6
.kk6 7
GetReferencekk7 C
(kkC D
datakkD H
)kkH I
)kkI J
,kkJ K
(ll 
voidll 
*ll 
)ll 
handlell !
,ll! "
Lengthmm 
,mm 
datann 
.nn 
Lengthnn 
)nn  
;nn  !
}oo 
returnqq 
Resultqq 
<qq 
Unitqq 
,qq 
SodiumFailureqq  -
>qq- .
.qq. /
Okqq/ 1
(qq1 2
Unitqq2 6
.qq6 7
Valueqq7 <
)qq< =
;qq= >
}rr 	
catchss 
(ss 
	Exceptionss 
exss 
)ss 
{tt 	
returnuu 
Resultuu 
<uu 
Unituu 
,uu 
SodiumFailureuu  -
>uu- .
.uu. /
Erruu/ 2
(uu2 3
SodiumFailurevv 
.vv "
MemoryProtectionFailedvv 4
(vv4 5#
ProtocolSystemConstantsvv5 L
.vvL M
ErrorMessagesvvM Z
.vvZ ["
UNEXPECTED_WRITE_ERRORvv[ q
,vvq r
exvvs u
)vvu v
)vvv w
;vvw x
}ww 	
finallyxx 
{yy 	
ifzz 
(zz 
successzz 
)zz 
{{{ 
DangerousRelease||  
(||  !
)||! "
;||" #
}}} 
_lock 
. 
ExitWriteLock 
(  
)  !
;! "
}
ÄÄ 	
}
ÅÅ 
public
ÉÉ 

Result
ÉÉ 
<
ÉÉ 
Unit
ÉÉ 
,
ÉÉ 
SodiumFailure
ÉÉ %
>
ÉÉ% &
Read
ÉÉ' +
(
ÉÉ+ ,
Span
ÉÉ, 0
<
ÉÉ0 1
byte
ÉÉ1 5
>
ÉÉ5 6
destination
ÉÉ7 B
)
ÉÉB C
{
ÑÑ 
if
ÖÖ 

(
ÖÖ 
	IsInvalid
ÖÖ 
||
ÖÖ 
IsClosed
ÖÖ !
)
ÖÖ! "
{
ÜÜ 	
return
áá 
Result
áá 
<
áá 
Unit
áá 
,
áá 
SodiumFailure
áá  -
>
áá- .
.
áá. /
Err
áá/ 2
(
áá2 3
SodiumFailure
àà 
.
àà 
NullPointer
àà )
(
àà) *
string
àà* 0
.
àà0 1
Format
àà1 7
(
àà7 8#
SodiumFailureMessages
àà8 M
.
ààM N
OBJECT_DISPOSED
ààN ]
,
àà] ^
nameof
ââ 
(
ââ &
SodiumSecureMemoryHandle
ââ 3
)
ââ3 4
)
ââ4 5
)
ââ5 6
)
ââ6 7
;
ââ7 8
}
ää 	
if
åå 

(
åå 
destination
åå 
.
åå 
Length
åå 
<
åå  
Length
åå! '
)
åå' (
{
çç 	
return
éé 
Result
éé 
<
éé 
Unit
éé 
,
éé 
SodiumFailure
éé  -
>
éé- .
.
éé. /
Err
éé/ 2
(
éé2 3
SodiumFailure
èè 
.
èè 
BUFFER_TOO_SMALL
èè .
(
èè. /
string
êê 
.
êê 
Format
êê !
(
êê! "#
SodiumFailureMessages
êê" 7
.
êê7 8
BUFFER_TOO_SMALL
êê8 H
,
êêH I
destination
êêJ U
.
êêU V
Length
êêV \
,
êê\ ]
Length
êê^ d
)
êêd e
)
êêe f
)
êêf g
;
êêg h
}
ëë 	
if
ìì 

(
ìì 
Length
ìì 
==
ìì 
$num
ìì 
)
ìì 
{
îî 	
return
ïï 
Result
ïï 
<
ïï 
Unit
ïï 
,
ïï 
SodiumFailure
ïï  -
>
ïï- .
.
ïï. /
Ok
ïï/ 1
(
ïï1 2
Unit
ïï2 6
.
ïï6 7
Value
ïï7 <
)
ïï< =
;
ïï= >
}
ññ 	
_lock
òò 
.
òò 
EnterReadLock
òò 
(
òò 
)
òò 
;
òò 
bool
ôô 
success
ôô 
=
ôô 
false
ôô 
;
ôô 
try
õõ 
{
úú 	
DangerousAddRef
ùù 
(
ùù 
ref
ùù 
success
ùù  '
)
ùù' (
;
ùù( )
if
ûû 
(
ûû 
!
ûû 
success
ûû 
)
ûû 
{
üü 
return
†† 
Result
†† 
<
†† 
Unit
†† "
,
††" #
SodiumFailure
††$ 1
>
††1 2
.
††2 3
Err
††3 6
(
††6 7
SodiumFailure
°° !
.
°°! "!
MemoryPinningFailed
°°" 5
(
°°5 6#
SodiumFailureMessages
°°6 K
.
°°K L$
REFERENCE_COUNT_FAILED
°°L b
)
°°b c
)
°°c d
;
°°d e
}
¢¢ 
if
§§ 
(
§§ 
	IsInvalid
§§ 
||
§§ 
IsClosed
§§ %
)
§§% &
{
•• 
return
¶¶ 
Result
¶¶ 
<
¶¶ 
Unit
¶¶ "
,
¶¶" #
SodiumFailure
¶¶$ 1
>
¶¶1 2
.
¶¶2 3
Err
¶¶3 6
(
¶¶6 7
SodiumFailure
ßß !
.
ßß! "
NullPointer
ßß" -
(
ßß- .
string
®® 
.
®® 
Format
®® %
(
®®% &#
SodiumFailureMessages
®®& ;
.
®®; <$
DISPOSED_AFTER_ADD_REF
®®< R
,
®®R S
nameof
®®T Z
(
®®Z [&
SodiumSecureMemoryHandle
®®[ s
)
®®s t
)
®®t u
)
®®u v
)
®®v w
;
®®w x
}
©© 
unsafe
´´ 
{
¨¨ 
Buffer
≠≠ 
.
≠≠ 

MemoryCopy
≠≠ !
(
≠≠! "
(
ÆÆ 
void
ÆÆ 
*
ÆÆ 
)
ÆÆ 
handle
ÆÆ !
,
ÆÆ! "
Unsafe
ØØ 
.
ØØ 
	AsPointer
ØØ $
(
ØØ$ %
ref
ØØ% (
MemoryMarshal
ØØ) 6
.
ØØ6 7
GetReference
ØØ7 C
(
ØØC D
destination
ØØD O
)
ØØO P
)
ØØP Q
,
ØØQ R
(
∞∞ 
ulong
∞∞ 
)
∞∞ 
destination
∞∞ &
.
∞∞& '
Length
∞∞' -
,
∞∞- .
(
±± 
ulong
±± 
)
±± 
Length
±± !
)
±±! "
;
±±" #
}
≤≤ 
return
¥¥ 
Result
¥¥ 
<
¥¥ 
Unit
¥¥ 
,
¥¥ 
SodiumFailure
¥¥  -
>
¥¥- .
.
¥¥. /
Ok
¥¥/ 1
(
¥¥1 2
Unit
¥¥2 6
.
¥¥6 7
Value
¥¥7 <
)
¥¥< =
;
¥¥= >
}
µµ 	
catch
∂∂ 
(
∂∂ 
	Exception
∂∂ 
ex
∂∂ 
)
∂∂ 
{
∑∑ 	
return
∏∏ 
Result
∏∏ 
<
∏∏ 
Unit
∏∏ 
,
∏∏ 
SodiumFailure
∏∏  -
>
∏∏- .
.
∏∏. /
Err
∏∏/ 2
(
∏∏2 3
SodiumFailure
ππ 
.
ππ $
MemoryProtectionFailed
ππ 4
(
ππ4 5#
SodiumFailureMessages
ππ5 J
.
ππJ K#
UNEXPECTED_READ_ERROR
ππK `
,
ππ` a
ex
ππb d
)
ππd e
)
ππe f
;
ππf g
}
∫∫ 	
finally
ªª 
{
ºº 	
if
ΩΩ 
(
ΩΩ 
success
ΩΩ 
)
ΩΩ 
{
ææ 
DangerousRelease
øø  
(
øø  !
)
øø! "
;
øø" #
}
¿¿ 
_lock
¬¬ 
.
¬¬ 
ExitReadLock
¬¬ 
(
¬¬ 
)
¬¬  
;
¬¬  !
}
√√ 	
}
ƒƒ 
public
∆∆ 

Result
∆∆ 
<
∆∆ 
byte
∆∆ 
[
∆∆ 
]
∆∆ 
,
∆∆ 
SodiumFailure
∆∆ '
>
∆∆' (
	ReadBytes
∆∆) 2
(
∆∆2 3
int
∆∆3 6
length
∆∆7 =
)
∆∆= >
{
«« 
if
»» 

(
»» 
	IsInvalid
»» 
||
»» 
IsClosed
»» !
)
»»! "
{
…… 	
return
   
Result
   
<
   
byte
   
[
   
]
    
,
    !
SodiumFailure
  " /
>
  / 0
.
  0 1
Err
  1 4
(
  4 5
SodiumFailure
ÀÀ 
.
ÀÀ 
NullPointer
ÀÀ )
(
ÀÀ) *
string
ÀÀ* 0
.
ÀÀ0 1
Format
ÀÀ1 7
(
ÀÀ7 8#
SodiumFailureMessages
ÀÀ8 M
.
ÀÀM N
OBJECT_DISPOSED
ÀÀN ]
,
ÀÀ] ^
nameof
ÃÃ 
(
ÃÃ &
SodiumSecureMemoryHandle
ÃÃ 3
)
ÃÃ3 4
)
ÃÃ4 5
)
ÃÃ5 6
)
ÃÃ6 7
;
ÃÃ7 8
}
ÕÕ 	
if
œœ 

(
œœ 
length
œœ 
<
œœ 
$num
œœ 
)
œœ 
{
–– 	
return
—— 
Result
—— 
<
—— 
byte
—— 
[
—— 
]
——  
,
——  !
SodiumFailure
——" /
>
——/ 0
.
——0 1
Err
——1 4
(
——4 5
SodiumFailure
““ 
.
““ 
InvalidBufferSize
““ /
(
““/ 0
string
““0 6
.
““6 7
Format
““7 =
(
““= >#
SodiumFailureMessages
““> S
.
““S T"
NEGATIVE_READ_LENGTH
““T h
,
““h i
length
““j p
)
““p q
)
““q r
)
““r s
;
““s t
}
”” 	
if
’’ 

(
’’ 
length
’’ 
>
’’ 
Length
’’ 
)
’’ 
{
÷÷ 	
return
◊◊ 
Result
◊◊ 
<
◊◊ 
byte
◊◊ 
[
◊◊ 
]
◊◊  
,
◊◊  !
SodiumFailure
◊◊" /
>
◊◊/ 0
.
◊◊0 1
Err
◊◊1 4
(
◊◊4 5
SodiumFailure
ÿÿ 
.
ÿÿ 
BUFFER_TOO_SMALL
ÿÿ .
(
ÿÿ. /
string
ÿÿ/ 5
.
ÿÿ5 6
Format
ÿÿ6 <
(
ÿÿ< =#
SodiumFailureMessages
ÿÿ= R
.
ÿÿR S&
READ_LENGTH_EXCEEDS_SIZE
ÿÿS k
,
ÿÿk l
length
ŸŸ 
,
ŸŸ 
Length
⁄⁄ 
)
⁄⁄ 
)
⁄⁄ 
)
⁄⁄ 
;
⁄⁄ 
}
€€ 	
if
›› 

(
›› 
length
›› 
==
›› 
$num
›› 
)
›› 
{
ﬁﬁ 	
return
ﬂﬂ 
Result
ﬂﬂ 
<
ﬂﬂ 
byte
ﬂﬂ 
[
ﬂﬂ 
]
ﬂﬂ  
,
ﬂﬂ  !
SodiumFailure
ﬂﬂ" /
>
ﬂﬂ/ 0
.
ﬂﬂ0 1
Ok
ﬂﬂ1 3
(
ﬂﬂ3 4
[
ﬂﬂ4 5
]
ﬂﬂ5 6
)
ﬂﬂ6 7
;
ﬂﬂ7 8
}
‡‡ 	
_lock
‚‚ 
.
‚‚ 
EnterReadLock
‚‚ 
(
‚‚ 
)
‚‚ 
;
‚‚ 
byte
„„ 
[
„„ 
]
„„ 
buffer
„„ 
=
„„ 
new
„„ 
byte
„„  
[
„„  !
length
„„! '
]
„„' (
;
„„( )
bool
‰‰ 
success
‰‰ 
=
‰‰ 
false
‰‰ 
;
‰‰ 
try
ÊÊ 
{
ÁÁ 	
Result
ËË 
<
ËË 
byte
ËË 
[
ËË 
]
ËË 
,
ËË 
SodiumFailure
ËË (
>
ËË( )

copyResult
ËË* 4
=
ËË5 6&
ExecuteWithErrorHandling
ËË7 O
(
ËËO P
(
ÈÈ 
)
ÈÈ 
=>
ÈÈ 
{
ÍÍ 
DangerousAddRef
ÎÎ #
(
ÎÎ# $
ref
ÎÎ$ '
success
ÎÎ( /
)
ÎÎ/ 0
;
ÎÎ0 1
if
ÏÏ 
(
ÏÏ 
!
ÏÏ 
success
ÏÏ  
)
ÏÏ  !
{
ÌÌ 
throw
ÓÓ 
new
ÓÓ !'
InvalidOperationException
ÓÓ" ;
(
ÓÓ; <#
SodiumFailureMessages
ÓÓ< Q
.
ÓÓQ R$
REFERENCE_COUNT_FAILED
ÓÓR h
)
ÓÓh i
;
ÓÓi j
}
ÔÔ 
if
ÒÒ 
(
ÒÒ 
	IsInvalid
ÒÒ !
||
ÒÒ" $
IsClosed
ÒÒ% -
)
ÒÒ- .
{
ÚÚ 
throw
ÛÛ 
new
ÛÛ !%
ObjectDisposedException
ÛÛ" 9
(
ÛÛ9 :
string
ÙÙ "
.
ÙÙ" #
Format
ÙÙ# )
(
ÙÙ) *#
SodiumFailureMessages
ÙÙ* ?
.
ÙÙ? @$
DISPOSED_AFTER_ADD_REF
ÙÙ@ V
,
ÙÙV W
nameof
ÙÙX ^
(
ÙÙ^ _&
SodiumSecureMemoryHandle
ÙÙ_ w
)
ÙÙw x
)
ÙÙx y
)
ÙÙy z
;
ÙÙz {
}
ıı 
unsafe
˜˜ 
{
¯¯ 
Buffer
˘˘ 
.
˘˘ 

MemoryCopy
˘˘ )
(
˘˘) *
(
˙˙ 
void
˙˙ !
*
˙˙! "
)
˙˙" #
handle
˙˙# )
,
˙˙) *
Unsafe
˚˚ "
.
˚˚" #
	AsPointer
˚˚# ,
(
˚˚, -
ref
˚˚- 0
MemoryMarshal
˚˚1 >
.
˚˚> ?
GetReference
˚˚? K
(
˚˚K L
buffer
˚˚L R
.
˚˚R S
AsSpan
˚˚S Y
(
˚˚Y Z
)
˚˚Z [
)
˚˚[ \
)
˚˚\ ]
,
˚˚] ^
(
¸¸ 
ulong
¸¸ "
)
¸¸" #
length
¸¸# )
,
¸¸) *
(
˝˝ 
ulong
˝˝ "
)
˝˝" #
length
˝˝# )
)
˝˝) *
;
˝˝* +
}
˛˛ 
return
ÄÄ 
buffer
ÄÄ !
;
ÄÄ! "
}
ÅÅ 
,
ÅÅ 
ex
ÇÇ 
=>
ÇÇ 
ex
ÇÇ 
switch
ÇÇ 
{
ÉÉ '
InvalidOperationException
ÑÑ -
{
ÑÑ. /
Message
ÑÑ0 7
:
ÑÑ7 8#
SodiumFailureMessages
ÑÑ9 N
.
ÑÑN O$
REFERENCE_COUNT_FAILED
ÑÑO e
}
ÑÑf g
=>
ÑÑh j
SodiumFailure
ÖÖ %
.
ÖÖ% &!
MemoryPinningFailed
ÖÖ& 9
(
ÖÖ9 :#
SodiumFailureMessages
ÖÖ: O
.
ÖÖO P$
REFERENCE_COUNT_FAILED
ÖÖP f
)
ÖÖf g
,
ÖÖg h%
ObjectDisposedException
ÜÜ +
=>
ÜÜ, .
SodiumFailure
ÜÜ/ <
.
ÜÜ< =
NullPointer
ÜÜ= H
(
ÜÜH I
string
áá 
.
áá 
Format
áá %
(
áá% &#
SodiumFailureMessages
áá& ;
.
áá; <$
DISPOSED_AFTER_ADD_REF
áá< R
,
ááR S
nameof
ááT Z
(
ááZ [&
SodiumSecureMemoryHandle
áá[ s
)
áás t
)
áát u
)
ááu v
,
ááv w
_
àà 
=>
àà 
SodiumFailure
àà &
.
àà& '$
MemoryProtectionFailed
àà' =
(
àà= >
string
ââ 
.
ââ 
Format
ââ %
(
ââ% &#
SodiumFailureMessages
ââ& ;
.
ââ; <)
UNEXPECTED_READ_BYTES_ERROR
ââ< W
,
ââW X
length
ââY _
)
ââ_ `
,
ââ` a
ex
ââb d
)
ââd e
}
ää 
)
ãã 
;
ãã 
return
çç 

copyResult
çç 
;
çç 
}
éé 	
finally
èè 
{
êê 	
if
ëë 
(
ëë 
success
ëë 
)
ëë 
{
íí 
DangerousRelease
ìì  
(
ìì  !
)
ìì! "
;
ìì" #
}
îî 
_lock
ññ 
.
ññ 
ExitReadLock
ññ 
(
ññ 
)
ññ  
;
ññ  !
}
óó 	
}
òò 
	protected
öö 
override
öö 
bool
öö 
ReleaseHandle
öö )
(
öö) *
)
öö* +
{
õõ 
try
úú 
{
ùù 	
_lock
ûû 
.
ûû 
EnterWriteLock
ûû  
(
ûû  !
)
ûû! "
;
ûû" #
}
üü 	
catch
†† 
{
°° 	
return
¢¢ 
false
¢¢ 
;
¢¢ 
}
££ 	
try
•• 
{
¶¶ 	
if
ßß 
(
ßß 
	IsInvalid
ßß 
)
ßß 
{
®® 
return
©© 
true
©© 
;
©© 
}
™™ 
if
¨¨ 
(
¨¨ 
	_isLocked
¨¨ 
)
¨¨ 
{
≠≠ 
TryUnlockMemory
ÆÆ 
(
ÆÆ  
)
ÆÆ  !
;
ÆÆ! "
}
ØØ 
SodiumInterop
±± 
.
±± 
sodium_free
±± %
(
±±% &
handle
±±& ,
)
±±, -
;
±±- . 
SetHandleAsInvalid
≤≤ 
(
≤≤ 
)
≤≤  
;
≤≤  !
return
≥≥ 
true
≥≥ 
;
≥≥ 
}
¥¥ 	
finally
µµ 
{
∂∂ 	
_lock
∑∑ 
.
∑∑ 
ExitWriteLock
∑∑ 
(
∑∑  
)
∑∑  !
;
∑∑! "
}
∏∏ 	
}
ππ 
	protected
ªª 
override
ªª 
void
ªª 
Dispose
ªª #
(
ªª# $
bool
ªª$ (
	disposing
ªª) 2
)
ªª2 3
{
ºº 
base
ΩΩ 
.
ΩΩ 
Dispose
ΩΩ 
(
ΩΩ 
	disposing
ΩΩ 
)
ΩΩ 
;
ΩΩ  
if
ææ 

(
ææ 
	disposing
ææ 
)
ææ 
{
øø 	
_lock
¿¿ 
?
¿¿ 
.
¿¿ 
Dispose
¿¿ 
(
¿¿ 
)
¿¿ 
;
¿¿ 
}
¡¡ 	
}
¬¬ 
private
ƒƒ 
void
ƒƒ 
TryLockMemory
ƒƒ 
(
ƒƒ 
)
ƒƒ  
{
≈≈ 
if
∆∆ 

(
∆∆ 
handle
∆∆ 
==
∆∆ 
IntPtr
∆∆ 
.
∆∆ 
Zero
∆∆ !
||
∆∆" $
Length
∆∆% +
<=
∆∆, .
$num
∆∆/ 0
)
∆∆0 1
{
«« 	
return
»» 
;
»» 
}
…… 	
try
ÀÀ 
{
ÃÃ 	
if
ÕÕ 
(
ÕÕ  
RuntimeInformation
ÕÕ "
.
ÕÕ" #
IsOSPlatform
ÕÕ# /
(
ÕÕ/ 0

OSPlatform
ÕÕ0 :
.
ÕÕ: ;
Windows
ÕÕ; B
)
ÕÕB C
)
ÕÕC D
{
ŒŒ 
if
œœ 
(
œœ 
VirtualLock
œœ 
(
œœ  
handle
œœ  &
,
œœ& '
(
œœ( )
UIntPtr
œœ) 0
)
œœ0 1
Length
œœ1 7
)
œœ7 8
)
œœ8 9
{
–– 
	_isLocked
—— 
=
—— 
true
——  $
;
——$ %
}
““ 
else
”” 
{
‘‘ 
Serilog
’’ 
.
’’ 
Log
’’ 
.
’’  
Warning
’’  '
(
’’' (
$str’’( Ç
,’’Ç É
handle
÷÷ 
,
÷÷ 
Length
÷÷  &
)
÷÷& '
;
÷÷' (
}
◊◊ 
}
ÿÿ 
else
ŸŸ 
if
ŸŸ 
(
ŸŸ  
RuntimeInformation
ŸŸ '
.
ŸŸ' (
IsOSPlatform
ŸŸ( 4
(
ŸŸ4 5

OSPlatform
ŸŸ5 ?
.
ŸŸ? @
Linux
ŸŸ@ E
)
ŸŸE F
||
ŸŸG I 
RuntimeInformation
⁄⁄ '
.
⁄⁄' (
IsOSPlatform
⁄⁄( 4
(
⁄⁄4 5

OSPlatform
⁄⁄5 ?
.
⁄⁄? @
OSX
⁄⁄@ C
)
⁄⁄C D
)
⁄⁄D E
{
€€ 
if
‹‹ 
(
‹‹ 
mlock
‹‹ 
(
‹‹ 
handle
‹‹  
,
‹‹  !
(
‹‹" #
UIntPtr
‹‹# *
)
‹‹* +
Length
‹‹+ 1
)
‹‹1 2
==
‹‹3 5
$num
‹‹6 7
)
‹‹7 8
{
›› 
	_isLocked
ﬁﬁ 
=
ﬁﬁ 
true
ﬁﬁ  $
;
ﬁﬁ$ %
}
ﬂﬂ 
else
‡‡ 
{
·· 
Serilog
‚‚ 
.
‚‚ 
Log
‚‚ 
.
‚‚  
Warning
‚‚  '
(
‚‚' (
$str
‚‚( |
,
‚‚| }
handle
„„ 
,
„„ 
Length
„„  &
)
„„& '
;
„„' (
}
‰‰ 
}
ÂÂ 
}
ÊÊ 	
catch
ÁÁ 
(
ÁÁ 
	Exception
ÁÁ 
ex
ÁÁ 
)
ÁÁ 
{
ËË 	
	_isLocked
ÈÈ 
=
ÈÈ 
false
ÈÈ 
;
ÈÈ 
Serilog
ÍÍ 
.
ÍÍ 
Log
ÍÍ 
.
ÍÍ 
Error
ÍÍ 
(
ÍÍ 
ex
ÍÍ  
,
ÍÍ  !
$str
ÍÍ" u
,
ÍÍu v
handle
ÎÎ 
,
ÎÎ 
Length
ÎÎ 
)
ÎÎ 
;
ÎÎ  
}
ÏÏ 	
}
ÌÌ 
private
ÔÔ 
void
ÔÔ 
TryUnlockMemory
ÔÔ  
(
ÔÔ  !
)
ÔÔ! "
{
 
if
ÒÒ 

(
ÒÒ 
handle
ÒÒ 
==
ÒÒ 
IntPtr
ÒÒ 
.
ÒÒ 
Zero
ÒÒ !
||
ÒÒ" $
Length
ÒÒ% +
<=
ÒÒ, .
$num
ÒÒ/ 0
||
ÒÒ1 3
!
ÒÒ4 5
	_isLocked
ÒÒ5 >
)
ÒÒ> ?
{
ÚÚ 	
return
ÛÛ 
;
ÛÛ 
}
ÙÙ 	
try
ˆˆ 
{
˜˜ 	
if
¯¯ 
(
¯¯  
RuntimeInformation
¯¯ "
.
¯¯" #
IsOSPlatform
¯¯# /
(
¯¯/ 0

OSPlatform
¯¯0 :
.
¯¯: ;
Windows
¯¯; B
)
¯¯B C
)
¯¯C D
{
˘˘ 
VirtualUnlock
˙˙ 
(
˙˙ 
handle
˙˙ $
,
˙˙$ %
(
˙˙& '
UIntPtr
˙˙' .
)
˙˙. /
Length
˙˙/ 5
)
˙˙5 6
;
˙˙6 7
}
˚˚ 
else
¸¸ 
if
¸¸ 
(
¸¸  
RuntimeInformation
¸¸ '
.
¸¸' (
IsOSPlatform
¸¸( 4
(
¸¸4 5

OSPlatform
¸¸5 ?
.
¸¸? @
Linux
¸¸@ E
)
¸¸E F
||
¸¸G I 
RuntimeInformation
˝˝ '
.
˝˝' (
IsOSPlatform
˝˝( 4
(
˝˝4 5

OSPlatform
˝˝5 ?
.
˝˝? @
OSX
˝˝@ C
)
˝˝C D
)
˝˝D E
{
˛˛ 
munlock
ˇˇ 
(
ˇˇ 
handle
ˇˇ 
,
ˇˇ 
(
ˇˇ  !
UIntPtr
ˇˇ! (
)
ˇˇ( )
Length
ˇˇ) /
)
ˇˇ/ 0
;
ˇˇ0 1
}
ÄÄ 
}
ÅÅ 	
catch
ÇÇ 
(
ÇÇ 
	Exception
ÇÇ 
ex
ÇÇ 
)
ÇÇ 
{
ÉÉ 	
Serilog
ÑÑ 
.
ÑÑ 
Log
ÑÑ 
.
ÑÑ 
Debug
ÑÑ 
(
ÑÑ 
ex
ÑÑ  
,
ÑÑ  !
$strÑÑ" â
,ÑÑâ ä
handle
ÖÖ 
,
ÖÖ 
Length
ÖÖ 
)
ÖÖ 
;
ÖÖ  
}
ÜÜ 	
finally
áá 
{
àà 	
	_isLocked
ââ 
=
ââ 
false
ââ 
;
ââ 
}
ää 	
}
ãã 
private
çç 
static
çç 
Result
çç 
<
çç 
T
çç 
,
çç 
SodiumFailure
çç *
>
çç* +&
ExecuteWithErrorHandling
çç, D
<
ççD E
T
ççE F
>
ççF G
(
ççG H
Func
éé 
<
éé 
T
éé 
>
éé 
action
éé 
,
éé 
Func
èè 
<
èè 
	Exception
èè 
,
èè 
SodiumFailure
èè %
>
èè% &
errorMapper
èè' 2
)
èè2 3
{
êê 
try
ëë 
{
íí 	
T
ìì 
result
ìì 
=
ìì 
action
ìì 
(
ìì 
)
ìì 
;
ìì  
return
îî 
Result
îî 
<
îî 
T
îî 
,
îî 
SodiumFailure
îî *
>
îî* +
.
îî+ ,
Ok
îî, .
(
îî. /
result
îî/ 5
)
îî5 6
;
îî6 7
}
ïï 	
catch
ññ 
(
ññ 
	Exception
ññ 
ex
ññ 
)
ññ 
{
óó 	
return
òò 
Result
òò 
<
òò 
T
òò 
,
òò 
SodiumFailure
òò *
>
òò* +
.
òò+ ,
Err
òò, /
(
òò/ 0
errorMapper
òò0 ;
(
òò; <
ex
òò< >
)
òò> ?
)
òò? @
;
òò@ A
}
ôô 	
}
öö 
public
úú 

Result
úú 
<
úú 
TResult
úú 
,
úú 
SodiumFailure
úú (
>
úú( )
WithReadAccess
úú* 8
<
úú8 9
TResult
úú9 @
>
úú@ A
(
úúA B
Func
ùù 
<
ùù 
ReadOnlySpan
ùù 
<
ùù 
byte
ùù 
>
ùù 
,
ùù  
Result
ùù! '
<
ùù' (
TResult
ùù( /
,
ùù/ 0
SodiumFailure
ùù1 >
>
ùù> ?
>
ùù? @
	operation
ùùA J
)
ùùJ K
{
ûû 
if
üü 

(
üü 
	IsInvalid
üü 
||
üü 
IsClosed
üü !
)
üü! "
{
†† 	
return
°° 
Result
°° 
<
°° 
TResult
°° !
,
°°! "
SodiumFailure
°°# 0
>
°°0 1
.
°°1 2
Err
°°2 5
(
°°5 6
SodiumFailure
¢¢ 
.
¢¢ 
NullPointer
¢¢ )
(
¢¢) *
string
¢¢* 0
.
¢¢0 1
Format
¢¢1 7
(
¢¢7 8#
SodiumFailureMessages
¢¢8 M
.
¢¢M N
OBJECT_DISPOSED
¢¢N ]
,
¢¢] ^
nameof
££ 
(
££ &
SodiumSecureMemoryHandle
££ 3
)
££3 4
)
££4 5
)
££5 6
)
££6 7
;
££7 8
}
§§ 	
_lock
¶¶ 
.
¶¶ 
EnterReadLock
¶¶ 
(
¶¶ 
)
¶¶ 
;
¶¶ 
bool
ßß 
success
ßß 
=
ßß 
false
ßß 
;
ßß 
try
©© 
{
™™ 	
DangerousAddRef
´´ 
(
´´ 
ref
´´ 
success
´´  '
)
´´' (
;
´´( )
if
¨¨ 
(
¨¨ 
!
¨¨ 
success
¨¨ 
)
¨¨ 
{
≠≠ 
return
ÆÆ 
Result
ÆÆ 
<
ÆÆ 
TResult
ÆÆ %
,
ÆÆ% &
SodiumFailure
ÆÆ' 4
>
ÆÆ4 5
.
ÆÆ5 6
Err
ÆÆ6 9
(
ÆÆ9 :
SodiumFailure
ØØ !
.
ØØ! "$
MemoryProtectionFailed
ØØ" 8
(
ØØ8 9#
SodiumFailureMessages
ØØ9 N
.
ØØN O$
REFERENCE_COUNT_FAILED
ØØO e
)
ØØe f
)
ØØf g
;
ØØg h
}
∞∞ 
if
≤≤ 
(
≤≤ 
	IsInvalid
≤≤ 
||
≤≤ 
IsClosed
≤≤ %
)
≤≤% &
{
≥≥ 
return
¥¥ 
Result
¥¥ 
<
¥¥ 
TResult
¥¥ %
,
¥¥% &
SodiumFailure
¥¥' 4
>
¥¥4 5
.
¥¥5 6
Err
¥¥6 9
(
¥¥9 :
SodiumFailure
µµ !
.
µµ! "
OBJECT_DISPOSED
µµ" 1
(
µµ1 2
string
µµ2 8
.
µµ8 9
Format
µµ9 ?
(
µµ? @#
SodiumFailureMessages
µµ@ U
.
µµU V$
DISPOSED_AFTER_ADD_REF
µµV l
,
µµl m
nameof
∂∂ 
(
∂∂ &
SodiumSecureMemoryHandle
∂∂ 7
)
∂∂7 8
)
∂∂8 9
)
∂∂9 :
)
∂∂: ;
;
∂∂; <
}
∑∑ 
unsafe
ππ 
{
∫∫ 
ReadOnlySpan
ªª 
<
ªª 
byte
ªª !
>
ªª! "
span
ªª# '
=
ªª( )
new
ªª* -
ReadOnlySpan
ªª. :
<
ªª: ;
byte
ªª; ?
>
ªª? @
(
ªª@ A
(
ªªA B
void
ªªB F
*
ªªF G
)
ªªG H
handle
ªªH N
,
ªªN O
Length
ªªP V
)
ªªV W
;
ªªW X
return
ºº 
	operation
ºº  
(
ºº  !
span
ºº! %
)
ºº% &
;
ºº& '
}
ΩΩ 
}
ææ 	
catch
øø 
(
øø 
	Exception
øø 
ex
øø 
)
øø 
{
¿¿ 	
return
¡¡ 
Result
¡¡ 
<
¡¡ 
TResult
¡¡ !
,
¡¡! "
SodiumFailure
¡¡# 0
>
¡¡0 1
.
¡¡1 2
Err
¡¡2 5
(
¡¡5 6
SodiumFailure
¬¬ 
.
¬¬ $
MemoryProtectionFailed
¬¬ 4
(
¬¬4 5#
SodiumFailureMessages
¬¬5 J
.
¬¬J K#
UNEXPECTED_READ_ERROR
¬¬K `
,
¬¬` a
ex
¬¬b d
)
¬¬d e
)
¬¬e f
;
¬¬f g
}
√√ 	
finally
ƒƒ 
{
≈≈ 	
if
∆∆ 
(
∆∆ 
success
∆∆ 
)
∆∆ 
{
«« 
DangerousRelease
»»  
(
»»  !
)
»»! "
;
»»" #
}
…… 
_lock
ÀÀ 
.
ÀÀ 
ExitReadLock
ÀÀ 
(
ÀÀ 
)
ÀÀ  
;
ÀÀ  !
}
ÃÃ 	
}
ÕÕ 
[
œœ 
	DllImport
œœ 
(
œœ %
ProtocolSystemConstants
œœ &
.
œœ& '
	Libraries
œœ' 0
.
œœ0 1
	KERNEL_32
œœ1 :
,
œœ: ;
SetLastError
œœ< H
=
œœI J
true
œœK O
)
œœO P
]
œœP Q
private
–– 
static
–– 
extern
–– 
bool
–– 
VirtualLock
–– *
(
––* +
IntPtr
––+ 1
	lpAddress
––2 ;
,
––; <
UIntPtr
––= D
dwSize
––E K
)
––K L
;
––L M
[
““ 
	DllImport
““ 
(
““ %
ProtocolSystemConstants
““ &
.
““& '
	Libraries
““' 0
.
““0 1
	KERNEL_32
““1 :
,
““: ;
SetLastError
““< H
=
““I J
true
““K O
)
““O P
]
““P Q
private
”” 
static
”” 
extern
”” 
bool
”” 
VirtualUnlock
”” ,
(
””, -
IntPtr
””- 3
	lpAddress
””4 =
,
””= >
UIntPtr
””? F
dwSize
””G M
)
””M N
;
””N O
[
’’ 
	DllImport
’’ 
(
’’ %
ProtocolSystemConstants
’’ &
.
’’& '
	Libraries
’’' 0
.
’’0 1
LIB_C
’’1 6
,
’’6 7
SetLastError
’’8 D
=
’’E F
true
’’G K
)
’’K L
]
’’L M
private
÷÷ 
static
÷÷ 
extern
÷÷ 
int
÷÷ 
mlock
÷÷ #
(
÷÷# $
IntPtr
÷÷$ *
addr
÷÷+ /
,
÷÷/ 0
UIntPtr
÷÷1 8
len
÷÷9 <
)
÷÷< =
;
÷÷= >
[
ÿÿ 
	DllImport
ÿÿ 
(
ÿÿ %
ProtocolSystemConstants
ÿÿ &
.
ÿÿ& '
	Libraries
ÿÿ' 0
.
ÿÿ0 1
LIB_C
ÿÿ1 6
,
ÿÿ6 7
SetLastError
ÿÿ8 D
=
ÿÿE F
true
ÿÿG K
)
ÿÿK L
]
ÿÿL M
private
ŸŸ 
static
ŸŸ 
extern
ŸŸ 
int
ŸŸ 
munlock
ŸŸ %
(
ŸŸ% &
IntPtr
ŸŸ& ,
addr
ŸŸ- 1
,
ŸŸ1 2
UIntPtr
ŸŸ3 :
len
ŸŸ; >
)
ŸŸ> ?
;
ŸŸ? @
}⁄⁄ ∑·
k/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Sodium/SodiumInterop.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Sodium# )
;) *
internal

 
static

	 
partial

 
class

 
SodiumInterop

 +
{ 
private 
const 
string 

LIB_SODIUM #
=$ %#
ProtocolSystemConstants& =
.= >
	Libraries> G
.G H

LIB_SODIUMH R
;R S
private 
const 
int 
MAX_BUFFER_SIZE %
=& '
$num( 5
;5 6
private 
static 
readonly 
Result "
<" #
Unit# '
,' (
SodiumFailure) 6
>6 7 
InitializationResult8 L
=M N
InitializeSodiumO _
(_ `
)` a
;a b
public 

static 
bool 
IsInitialized $
=>% ' 
InitializationResult( <
.< =
IsOk= A
;A B
[ 
LibraryImport 
( 

LIB_SODIUM 
, 

EntryPoint )
=* +
$str, 9
)9 :
]: ;
[ 
UnmanagedCallConv 
( 
	CallConvs  
=! "
[# $
typeof$ *
(* +
CallConvCdecl+ 8
)8 9
]9 :
): ;
]; <
private 
static 
partial 
int 
sodium_init *
(* +
)+ ,
;, -
[ 
LibraryImport 
( 

LIB_SODIUM 
, 

EntryPoint )
=* +
$str, ;
); <
]< =
[ 
UnmanagedCallConv 
( 
	CallConvs  
=! "
[# $
typeof$ *
(* +
CallConvCdecl+ 8
)8 9
]9 :
): ;
]; <
internal 
static 
partial 
IntPtr "
sodium_malloc# 0
(0 1
nuint1 6
size7 ;
); <
;< =
[ 
LibraryImport 
( 

LIB_SODIUM 
, 

EntryPoint )
=* +
$str, 9
)9 :
]: ;
[ 
UnmanagedCallConv 
( 
	CallConvs  
=! "
[# $
typeof$ *
(* +
CallConvCdecl+ 8
)8 9
]9 :
): ;
]; <
internal 
static 
partial 
void  
sodium_free! ,
(, -
IntPtr- 3
ptr4 7
)7 8
;8 9
[   
LibraryImport   
(   

LIB_SODIUM   
,   

EntryPoint   )
=  * +
$str  , <
)  < =
]  = >
[!! 
UnmanagedCallConv!! 
(!! 
	CallConvs!!  
=!!! "
[!!# $
typeof!!$ *
(!!* +
CallConvCdecl!!+ 8
)!!8 9
]!!9 :
)!!: ;
]!!; <
private"" 
static"" 
partial"" 
void"" 
sodium_memzero""  .
("". /
IntPtr""/ 5
ptr""6 9
,""9 :
nuint""; @
length""A G
)""G H
;""H I
[$$ 
LibraryImport$$ 
($$ 

LIB_SODIUM$$ 
,$$ 

EntryPoint$$ )
=$$* +
$str$$, ;
)$$; <
]$$< =
[%% 
UnmanagedCallConv%% 
(%% 
	CallConvs%%  
=%%! "
[%%# $
typeof%%$ *
(%%* +
CallConvCdecl%%+ 8
)%%8 9
]%%9 :
)%%: ;
]%%; <
private&& 
static&& 
partial&& 
int&& 
sodium_memcmp&& ,
(&&, -
byte&&- 1
[&&1 2
]&&2 3
b1&&4 6
,&&6 7
byte&&8 <
[&&< =
]&&= >
b2&&? A
,&&A B
nuint&&C H
length&&I O
)&&O P
;&&P Q
[(( 
LibraryImport(( 
((( 

LIB_SODIUM(( 
,(( 

EntryPoint(( )
=((* +
$str((, ;
)((; <
]((< =
[)) 
UnmanagedCallConv)) 
()) 
	CallConvs))  
=))! "
[))# $
typeof))$ *
())* +
CallConvCdecl))+ 8
)))8 9
]))9 :
))): ;
])); <
private** 
static** 
unsafe** 
partial** !
int**" %
sodium_memcmp**& 3
(**3 4
void**4 8
***8 9
b1**: <
,**< =
void**> B
***B C
b2**D F
,**F G
nuint**H M
length**N T
)**T U
;**U V
private,, 
static,, 
Result,, 
<,, 
Unit,, 
,,, 
SodiumFailure,,  -
>,,- .
InitializeSodium,,/ ?
(,,? @
),,@ A
{-- 
return.. 
Result.. 
<.. 
Unit.. 
,.. 
SodiumFailure.. )
>..) *
...* +
Try..+ .
(... /
(// 
)// 
=>// 
{00 
int11 
result11 
=11 
sodium_init11 (
(11( )
)11) *
;11* +
const22 
int22 
DLL_IMPORT_SUCCESS22 ,
=22- .#
ProtocolSystemConstants22/ F
.22F G
Numeric22G N
.22N O
DLL_IMPORT_SUCCESS22O a
;22a b
if33 
(33 
result33 
<33 
DLL_IMPORT_SUCCESS33 /
)33/ 0
{44 
throw55 
new55 %
InvalidOperationException55 7
(557 8!
SodiumFailureMessages558 M
.55M N
SODIUM_INIT_FAILED55N `
)55` a
;55a b
}66 
}77 
,77 
ex88 
=>88 
ex88 
switch88 
{99  
DllNotFoundException:: $
dllEx::% *
=>::+ -
SodiumFailure::. ;
.::; <
LibraryNotFound::< K
(::K L
string;; 
.;; 
Format;; !
(;;! "!
SodiumFailureMessages;;" 7
.;;7 8
LIBRARY_LOAD_FAILED;;8 K
,;;K L

LIB_SODIUM;;M W
);;W X
,;;X Y
dllEx;;Z _
);;_ `
,;;` a%
InvalidOperationException<< )
opEx<<* .
when<</ 3
opEx<<4 8
.<<8 9
Message<<9 @
.<<@ A
Contains<<A I
(<<I J*
SodiumExceptionMessagePatterns<<J h
.== 
SODIUM_INIT_PATTERN== ,
)==, -
=>==. 0
SodiumFailure>> !
.>>! "!
INITIALIZATION_FAILED>>" 7
(>>7 8!
SodiumFailureMessages>>8 M
.>>M N!
INITIALIZATION_FAILED>>N c
,>>c d
opEx>>e i
)>>i j
,>>j k
_?? 
=>?? 
SodiumFailure?? "
.??" #!
INITIALIZATION_FAILED??# 8
(??8 9!
SodiumFailureMessages??9 N
.??N O!
UNEXPECTED_INIT_ERROR??O d
,??d e
ex??f h
)??h i
}@@ 
)AA 	
;AA	 

}BB 
publicDD 

staticDD 
ResultDD 
<DD 
UnitDD 
,DD 
SodiumFailureDD ,
>DD, -

SecureWipeDD. 8
(DD8 9
byteDD9 =
[DD= >
]DD> ?
?DD? @
bufferDDA G
)DDG H
{EE 
ifFF 

(FF 
!FF 
IsInitializedFF 
)FF 
{GG 	
returnHH 
ResultHH 
<HH 
UnitHH 
,HH 
SodiumFailureHH  -
>HH- .
.HH. /
ErrHH/ 2
(HH2 3
SodiumFailureII 
.II !
INITIALIZATION_FAILEDII 3
(II3 4!
SodiumFailureMessagesII4 I
.III J
NOT_INITIALIZEDIIJ Y
)IIY Z
)IIZ [
;II[ \
}JJ 	
returnLL 
ResultLL 
<LL 
byteLL 
[LL 
]LL 
,LL 
SodiumFailureLL +
>LL+ ,
.MM 
	FromValueMM 
(MM 
bufferMM 
,MM 
SodiumFailureMM ,
.MM, -
BUFFER_TOO_SMALLMM- =
(MM= >!
SodiumFailureMessagesMM> S
.MMS T
BUFFER_NULLMMT _
)MM_ `
)MM` a
.NN 
BindNN 
(NN 
nonNullBufferNN 
=>NN  "
nonNullBufferNN# 0
switchNN1 7
{OO 
{PP 
LengthPP 
:PP 
$numPP 
}PP 
=>PP  
ResultPP! '
<PP' (
UnitPP( ,
,PP, -
SodiumFailurePP. ;
>PP; <
.PP< =
OkPP= ?
(PP? @
UnitPP@ D
.PPD E
ValuePPE J
)PPJ K
,PPK L
_QQ 
=>QQ 
ResultQQ 
<QQ 
byteQQ  
[QQ  !
]QQ! "
,QQ" #
SodiumFailureQQ$ 1
>QQ1 2
.QQ2 3
ValidateQQ3 ;
(QQ; <
nonNullBufferRR %
,RR% &
bufSS 
=>SS 
bufSS "
.SS" #
LengthSS# )
<=SS* ,
MAX_BUFFER_SIZESS- <
,SS< =
SodiumFailureTT %
.TT% &
BUFFER_TOO_LARGETT& 6
(TT6 7
stringUU "
.UU" #
FormatUU# )
(UU) *!
SodiumFailureMessagesUU* ?
.UU? @
BUFFER_TOO_LARGEUU@ P
,UUP Q
nonNullBufferUUR _
.UU_ `
LengthUU` f
,UUf g
MAX_BUFFER_SIZEUUh w
)UUw x
)UUx y
)UUy z
.VV 
BindVV 
(VV 
validBufferVV %
=>VV& (
validBufferVV) 4
.VV4 5
LengthVV5 ;
<=VV< >
	ConstantsVV? H
.VVH I"
SMALL_BUFFER_THRESHOLDVVI _
?WW 
WipeSmallBufferWW )
(WW) *
validBufferWW* 5
)WW5 6
:XX 
WipeLargeBufferXX )
(XX) *
validBufferXX* 5
)XX5 6
)XX6 7
}YY 
)YY 
;YY 
}ZZ 
public\\ 

static\\ 
Result\\ 
<\\ 
(\\ $
SodiumSecureMemoryHandle\\ 2
skHandle\\3 ;
,\\; <
byte\\= A
[\\A B
]\\B C
pk\\D F
)\\F G
,\\G H#
EcliptixProtocolFailure\\I `
>\\` a!
GenerateX25519KeyPair\\b w
(\\w x
string]] 

keyPurpose]] 
)]] 
{^^ $
SodiumSecureMemoryHandle__  
?__  !
skHandle__" *
=__+ ,
null__- 1
;__1 2
tryaa 
{bb 	
Resultcc 
<cc $
SodiumSecureMemoryHandlecc +
,cc+ ,
SodiumFailurecc- :
>cc: ;
allocResultcc< G
=ccH I$
SodiumSecureMemoryHandledd (
.dd( )
Allocatedd) 1
(dd1 2
	Constantsdd2 ;
.dd; <$
X_25519_PRIVATE_KEY_SIZEdd< T
)ddT U
;ddU V
ifee 
(ee 
allocResultee 
.ee 
IsErree !
)ee! "
{ff 
returngg 
Resultgg 
<gg 
(gg $
SodiumSecureMemoryHandlegg 7
,gg7 8
bytegg9 =
[gg= >
]gg> ?
)gg? @
,gg@ A#
EcliptixProtocolFailureggB Y
>ggY Z
.ggZ [
Errgg[ ^
(gg^ _
allocResultgg_ j
.ggj k
	UnwrapErrggk t
(ggt u
)ggu v
.hh %
ToEcliptixProtocolFailurehh .
(hh. /
)hh/ 0
)hh0 1
;hh1 2
}ii 
skHandlekk 
=kk 
allocResultkk "
.kk" #
Unwrapkk# )
(kk) *
)kk* +
;kk+ ,
bytemm 
[mm 
]mm 
skBytesmm 
=mm 

SodiumCoremm '
.mm' (
GetRandomBytesmm( 6
(mm6 7
	Constantsmm7 @
.mm@ A$
X_25519_PRIVATE_KEY_SIZEmmA Y
)mmY Z
;mmZ [
trynn 
{oo 
Resultpp 
<pp 
Unitpp 
,pp 
SodiumFailurepp *
>pp* +
writeResultpp, 7
=pp8 9
skHandlepp: B
.ppB C
WriteppC H
(ppH I
skBytesppI P
)ppP Q
;ppQ R
ifqq 
(qq 
writeResultqq 
.qq  
IsErrqq  %
)qq% &
{rr 
skHandless 
.ss 
Disposess $
(ss$ %
)ss% &
;ss& '
returntt 
Resulttt !
<tt! "
(tt" #$
SodiumSecureMemoryHandlett# ;
,tt; <
bytett= A
[ttA B
]ttB C
)ttC D
,ttD E#
EcliptixProtocolFailurettF ]
>tt] ^
.tt^ _
Errtt_ b
(ttb c
writeResultttc n
.ttn o
	UnwrapErrtto x
(ttx y
)tty z
.uu %
ToEcliptixProtocolFailureuu 2
(uu2 3
)uu3 4
)uu4 5
;uu5 6
}vv 
}ww 
finallyxx 
{yy 

SecureWipezz 
(zz 
skByteszz "
)zz" #
;zz# $
}{{ 
byte}} 
[}} 
]}} 
tempPrivCopy}} 
=}}  !
new}}" %
byte}}& *
[}}* +
	Constants}}+ 4
.}}4 5$
X_25519_PRIVATE_KEY_SIZE}}5 M
]}}M N
;}}N O
try~~ 
{ 
Result
ÄÄ 
<
ÄÄ 
Unit
ÄÄ 
,
ÄÄ 
SodiumFailure
ÄÄ *
>
ÄÄ* +

readResult
ÄÄ, 6
=
ÄÄ7 8
skHandle
ÄÄ9 A
.
ÄÄA B
Read
ÄÄB F
(
ÄÄF G
tempPrivCopy
ÄÄG S
)
ÄÄS T
;
ÄÄT U
if
ÅÅ 
(
ÅÅ 

readResult
ÅÅ 
.
ÅÅ 
IsErr
ÅÅ $
)
ÅÅ$ %
{
ÇÇ 
skHandle
ÉÉ 
.
ÉÉ 
Dispose
ÉÉ $
(
ÉÉ$ %
)
ÉÉ% &
;
ÉÉ& '
return
ÑÑ 
Result
ÑÑ !
<
ÑÑ! "
(
ÑÑ" #&
SodiumSecureMemoryHandle
ÑÑ# ;
,
ÑÑ; <
byte
ÑÑ= A
[
ÑÑA B
]
ÑÑB C
)
ÑÑC D
,
ÑÑD E%
EcliptixProtocolFailure
ÑÑF ]
>
ÑÑ] ^
.
ÑÑ^ _
Err
ÑÑ_ b
(
ÑÑb c

readResult
ÑÑc m
.
ÑÑm n
	UnwrapErr
ÑÑn w
(
ÑÑw x
)
ÑÑx y
.
ÖÖ '
ToEcliptixProtocolFailure
ÖÖ 2
(
ÖÖ2 3
)
ÖÖ3 4
)
ÖÖ4 5
;
ÖÖ5 6
}
ÜÜ 
Result
àà 
<
àà 
byte
àà 
[
àà 
]
àà 
,
àà %
EcliptixProtocolFailure
àà 6
>
àà6 7
deriveResult
àà8 D
=
ààE F
Result
ààG M
<
ààM N
byte
ààN R
[
ààR S
]
ààS T
,
ààT U%
EcliptixProtocolFailure
ààV m
>
ààm n
.
ààn o
Try
àào r
(
ààr s
(
ââ 
)
ââ 
=>
ââ 

ScalarMult
ââ $
.
ââ$ %
Base
ââ% )
(
ââ) *
tempPrivCopy
ââ* 6
)
ââ6 7
,
ââ7 8
ex
ää 
=>
ää %
EcliptixProtocolFailure
ää 1
.
ää1 2
	DeriveKey
ää2 ;
(
ää; <
$"
ää< >
$str
ää> O
{
ääO P

keyPurpose
ääP Z
}
ääZ [
$str
ää[ g
"
ääg h
,
ääh i
ex
ääj l
)
ääl m
)
ääm n
;
ään o
if
åå 
(
åå 
deriveResult
åå  
.
åå  !
IsErr
åå! &
)
åå& '
{
çç 
skHandle
éé 
.
éé 
Dispose
éé $
(
éé$ %
)
éé% &
;
éé& '
return
èè 
Result
èè !
<
èè! "
(
èè" #&
SodiumSecureMemoryHandle
èè# ;
,
èè; <
byte
èè= A
[
èèA B
]
èèB C
)
èèC D
,
èèD E%
EcliptixProtocolFailure
èèF ]
>
èè] ^
.
êê 
Err
êê 
(
êê 
deriveResult
êê )
.
êê) *
	UnwrapErr
êê* 3
(
êê3 4
)
êê4 5
)
êê5 6
;
êê6 7
}
ëë 
byte
ìì 
[
ìì 
]
ìì 
pkBytes
ìì 
=
ìì  
deriveResult
ìì! -
.
ìì- .
Unwrap
ìì. 4
(
ìì4 5
)
ìì5 6
;
ìì6 7
if
ïï 
(
ïï 
pkBytes
ïï 
.
ïï 
Length
ïï "
!=
ïï# %
	Constants
ïï& /
.
ïï/ 0%
X_25519_PUBLIC_KEY_SIZE
ïï0 G
)
ïïG H
{
ññ 
skHandle
óó 
.
óó 
Dispose
óó $
(
óó$ %
)
óó% &
;
óó& '

SecureWipe
òò 
(
òò 
pkBytes
òò &
)
òò& '
;
òò' (
return
ôô 
Result
ôô !
<
ôô! "
(
ôô" #&
SodiumSecureMemoryHandle
ôô# ;
,
ôô; <
byte
ôô= A
[
ôôA B
]
ôôB C
)
ôôC D
,
ôôD E%
EcliptixProtocolFailure
ôôF ]
>
ôô] ^
.
ôô^ _
Err
ôô_ b
(
ôôb c%
EcliptixProtocolFailure
öö /
.
öö/ 0
	DeriveKey
öö0 9
(
öö9 :
$"
öö: <
$str
öö< D
{
ööD E

keyPurpose
ööE O
}
ööO P
$str
ööP o
"
ööo p
)
ööp q
)
ööq r
;
öör s
}
õõ 
return
ùù 
Result
ùù 
<
ùù 
(
ùù &
SodiumSecureMemoryHandle
ùù 7
,
ùù7 8
byte
ùù9 =
[
ùù= >
]
ùù> ?
)
ùù? @
,
ùù@ A%
EcliptixProtocolFailure
ùùB Y
>
ùùY Z
.
ùùZ [
Ok
ùù[ ]
(
ùù] ^
(
ùù^ _
skHandle
ùù_ g
,
ùùg h
pkBytes
ùùi p
)
ùùp q
)
ùùq r
;
ùùr s
}
ûû 
finally
üü 
{
†† 

SecureWipe
°° 
(
°° 
tempPrivCopy
°° '
)
°°' (
;
°°( )
}
¢¢ 
}
££ 	
catch
§§ 
(
§§ 
	Exception
§§ 
ex
§§ 
)
§§ 
{
•• 	
return
¶¶ 
Result
¶¶ 
<
¶¶ 
(
¶¶ &
SodiumSecureMemoryHandle
¶¶ 3
,
¶¶3 4
byte
¶¶5 9
[
¶¶9 :
]
¶¶: ;
)
¶¶; <
,
¶¶< =%
EcliptixProtocolFailure
¶¶> U
>
¶¶U V
.
¶¶V W
Err
¶¶W Z
(
¶¶Z [%
EcliptixProtocolFailure
ßß '
.
ßß' (
KeyGeneration
ßß( 5
(
ßß5 6
$"
ßß6 8
$str
ßß8 T
{
ßßT U

keyPurpose
ßßU _
}
ßß_ `
$str
ßß` j
"
ßßj k
,
ßßk l
ex
ßßm o
)
ßßo p
)
ßßp q
;
ßßq r
}
®® 	
}
©© 
public
´´ 

static
´´ 
Result
´´ 
<
´´ 
bool
´´ 
,
´´ 
SodiumFailure
´´ ,
>
´´, - 
ConstantTimeEquals
´´. @
(
´´@ A
ReadOnlySpan
´´A M
<
´´M N
byte
´´N R
>
´´R S
a
´´T U
,
´´U V
ReadOnlySpan
´´W c
<
´´c d
byte
´´d h
>
´´h i
b
´´j k
)
´´k l
{
¨¨ 
if
≠≠ 

(
≠≠ 
a
≠≠ 
.
≠≠ 
Length
≠≠ 
!=
≠≠ 
b
≠≠ 
.
≠≠ 
Length
≠≠  
)
≠≠  !
{
ÆÆ 	
return
ØØ 
Result
ØØ 
<
ØØ 
bool
ØØ 
,
ØØ 
SodiumFailure
ØØ  -
>
ØØ- .
.
ØØ. /
Ok
ØØ/ 1
(
ØØ1 2
false
ØØ2 7
)
ØØ7 8
;
ØØ8 9
}
∞∞ 	
if
≤≤ 

(
≤≤ 
a
≤≤ 
.
≤≤ 
IsEmpty
≤≤ 
)
≤≤ 
{
≥≥ 	
return
¥¥ 
Result
¥¥ 
<
¥¥ 
bool
¥¥ 
,
¥¥ 
SodiumFailure
¥¥  -
>
¥¥- .
.
¥¥. /
Ok
¥¥/ 1
(
¥¥1 2
true
¥¥2 6
)
¥¥6 7
;
¥¥7 8
}
µµ 	
try
∑∑ 
{
∏∏ 	
unsafe
ππ 
{
∫∫ 
fixed
ªª 
(
ªª 
byte
ªª 
*
ªª 
ptrA
ªª !
=
ªª" #
a
ªª$ %
)
ªª% &
fixed
ºº 
(
ºº 
byte
ºº 
*
ºº 
ptrB
ºº !
=
ºº" #
b
ºº$ %
)
ºº% &
{
ΩΩ 
int
ææ 
result
ææ 
=
ææ  
sodium_memcmp
ææ! .
(
ææ. /
ptrA
ææ/ 3
,
ææ3 4
ptrB
ææ5 9
,
ææ9 :
(
ææ; <
nuint
ææ< A
)
ææA B
a
ææB C
.
ææC D
Length
ææD J
)
ææJ K
;
ææK L
return
øø 
Result
øø !
<
øø! "
bool
øø" &
,
øø& '
SodiumFailure
øø( 5
>
øø5 6
.
øø6 7
Ok
øø7 9
(
øø9 :
result
øø: @
==
øøA C%
ProtocolSystemConstants
øøD [
.
øø[ \
Numeric
øø\ c
.
øøc d

ZERO_VALUE
øød n
)
øøn o
;
øøo p
}
¿¿ 
}
¡¡ 
}
¬¬ 	
catch
√√ 
(
√√ 
	Exception
√√ 
ex
√√ 
)
√√ 
{
ƒƒ 	
return
≈≈ 
Result
≈≈ 
<
≈≈ 
bool
≈≈ 
,
≈≈ 
SodiumFailure
≈≈  -
>
≈≈- .
.
≈≈. /
Err
≈≈/ 2
(
≈≈2 3
SodiumFailure
∆∆ 
.
∆∆ 
ComparisonFailed
∆∆ .
(
∆∆. /%
ProtocolSystemConstants
∆∆/ F
.
∆∆F G
ErrorMessages
∆∆G T
.
∆∆T U8
*LIB_SODIUM_CONSTANT_TIME_COMPARISON_FAILED
∆∆U 
,∆∆ Ä
ex∆∆Å É
)∆∆É Ñ
)∆∆Ñ Ö
;∆∆Ö Ü
}
«« 	
}
»» 
private
   
static
   
Result
   
<
   
Unit
   
,
   
SodiumFailure
    -
>
  - .
WipeSmallBuffer
  / >
(
  > ?
byte
  ? C
[
  C D
]
  D E
buffer
  F L
)
  L M
{
ÀÀ 
return
ÃÃ 
Result
ÃÃ 
<
ÃÃ 
Unit
ÃÃ 
,
ÃÃ 
SodiumFailure
ÃÃ )
>
ÃÃ) *
.
ÃÃ* +
Try
ÃÃ+ .
(
ÃÃ. /
(
ÕÕ 
)
ÕÕ 
=>
ÕÕ 
{
ÕÕ 
Array
ÕÕ 
.
ÕÕ 
Clear
ÕÕ 
(
ÕÕ  
buffer
ÕÕ  &
,
ÕÕ& '%
ProtocolSystemConstants
ÕÕ( ?
.
ÕÕ? @
Numeric
ÕÕ@ G
.
ÕÕG H

ZERO_VALUE
ÕÕH R
,
ÕÕR S
buffer
ÕÕT Z
.
ÕÕZ [
Length
ÕÕ[ a
)
ÕÕa b
;
ÕÕb c
}
ÕÕd e
,
ÕÕe f
ex
ŒŒ 
=>
ŒŒ 
SodiumFailure
œœ 
.
œœ  
SECURE_WIPE_FAILED
œœ 0
(
œœ0 1
string
–– 
.
–– 
Format
–– !
(
––! "#
SodiumFailureMessages
––" 7
.
––7 8'
SMALL_BUFFER_CLEAR_FAILED
––8 Q
,
––Q R
buffer
––S Y
.
––Y Z
Length
––Z `
)
––` a
,
––a b
ex
––c e
)
––e f
)
––f g
;
––g h
}
—— 
private
”” 
static
”” 
Result
”” 
<
”” 
Unit
”” 
,
”” 
SodiumFailure
””  -
>
””- .
WipeLargeBuffer
””/ >
(
””> ?
byte
””? C
[
””C D
]
””D E
buffer
””F L
)
””L M
{
‘‘ 
GCHandle
’’ 
handle
’’ 
=
’’ 
default
’’ !
;
’’! "
return
÷÷ 
Result
÷÷ 
<
÷÷ 
Unit
÷÷ 
,
÷÷ 
SodiumFailure
÷÷ )
>
÷÷) *
.
÷÷* +
Try
÷÷+ .
(
÷÷. /
(
◊◊ 
)
◊◊ 
=>
◊◊ 
{
ÿÿ 
handle
ŸŸ 
=
ŸŸ 
GCHandle
ŸŸ !
.
ŸŸ! "
Alloc
ŸŸ" '
(
ŸŸ' (
buffer
ŸŸ( .
,
ŸŸ. /
GCHandleType
ŸŸ0 <
.
ŸŸ< =
Pinned
ŸŸ= C
)
ŸŸC D
;
ŸŸD E
IntPtr
⁄⁄ 
ptr
⁄⁄ 
=
⁄⁄ 
handle
⁄⁄ #
.
⁄⁄# $ 
AddrOfPinnedObject
⁄⁄$ 6
(
⁄⁄6 7
)
⁄⁄7 8
;
⁄⁄8 9
if
€€ 
(
€€ 
ptr
€€ 
==
€€ 
IntPtr
€€ !
.
€€! "
Zero
€€" &
&&
€€' )
buffer
€€* 0
.
€€0 1
Length
€€1 7
>
€€8 9%
ProtocolSystemConstants
€€: Q
.
€€Q R
Numeric
€€R Y
.
€€Y Z

ZERO_VALUE
€€Z d
)
€€d e
{
‹‹ 
throw
›› 
new
›› '
InvalidOperationException
›› 7
(
››7 8#
SodiumFailureMessages
››8 M
.
››M N-
ADDRESS_OF_PINNED_OBJECT_FAILED
››N m
)
››m n
;
››n o
}
ﬁﬁ 
sodium_memzero
‡‡ 
(
‡‡ 
ptr
‡‡ "
,
‡‡" #
(
‡‡$ %
UIntPtr
‡‡% ,
)
‡‡, -
buffer
‡‡- 3
.
‡‡3 4
Length
‡‡4 :
)
‡‡: ;
;
‡‡; <
}
·· 
,
·· 
ex
‚‚ 
=>
‚‚ 
ex
‚‚ 
switch
‚‚ 
{
„„ 
ArgumentException
‰‰ !
argEx
‰‰" '
=>
‰‰( *
SodiumFailure
‰‰+ 8
.
‰‰8 9!
MemoryPinningFailed
‰‰9 L
(
‰‰L M#
SodiumFailureMessages
ÂÂ )
.
ÂÂ) *
PINNING_FAILED
ÂÂ* 8
,
ÂÂ8 9
argEx
ÂÂ: ?
)
ÂÂ? @
,
ÂÂ@ A"
OutOfMemoryException
ÊÊ $
oomEx
ÊÊ% *
=>
ÊÊ+ -
SodiumFailure
ÊÊ. ;
.
ÊÊ; <!
MemoryPinningFailed
ÊÊ< O
(
ÊÊO P#
SodiumFailureMessages
ÁÁ )
.
ÁÁ) *!
INSUFFICIENT_MEMORY
ÁÁ* =
,
ÁÁ= >
oomEx
ÁÁ? D
)
ÁÁD E
,
ÁÁE F'
InvalidOperationException
ËË )
opEx
ËË* .
when
ËË/ 3
opEx
ËË4 8
.
ËË8 9
Message
ËË9 @
.
ËË@ A
Contains
ËËA I
(
ËËI J,
SodiumExceptionMessagePatterns
ËËJ h
.
ÈÈ +
ADDRESS_PINNED_OBJECT_PATTERN
ÈÈ 6
)
ÈÈ6 7
=>
ÈÈ8 :
SodiumFailure
ÍÍ !
.
ÍÍ! "!
MemoryPinningFailed
ÍÍ" 5
(
ÍÍ5 6#
SodiumFailureMessages
ÍÍ6 K
.
ÍÍK L'
GET_PINNED_ADDRESS_FAILED
ÍÍL e
,
ÍÍe f
opEx
ÍÍg k
)
ÍÍk l
,
ÍÍl m
_
ÎÎ 
=>
ÎÎ 
SodiumFailure
ÎÎ "
.
ÎÎ" #!
MemoryPinningFailed
ÎÎ# 6
(
ÎÎ6 7
string
ÏÏ 
.
ÏÏ 
Format
ÏÏ !
(
ÏÏ! "#
SodiumFailureMessages
ÏÏ" 7
.
ÏÏ7 8 
SECURE_WIPE_FAILED
ÏÏ8 J
,
ÏÏJ K
buffer
ÏÏL R
.
ÏÏR S
Length
ÏÏS Y
)
ÏÏY Z
,
ÏÏZ [
ex
ÏÏ\ ^
)
ÏÏ^ _
}
ÌÌ 
,
ÌÌ 
(
ÓÓ 
)
ÓÓ 
=>
ÓÓ 
{
ÔÔ 
if
 
(
 
handle
 
.
 
IsAllocated
 &
)
& '
{
ÒÒ 
handle
ÚÚ 
.
ÚÚ 
Free
ÚÚ 
(
ÚÚ  
)
ÚÚ  !
;
ÚÚ! "
}
ÛÛ 
}
ÙÙ 
)
ıı 	
;
ıı	 

}
ˆˆ 
}˜˜ ≤b
n/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/ProtocolSystemConstants.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
;" #
internal 
static	 
class #
ProtocolSystemConstants -
{ 
public 

static 
class 
Timeouts  
{ 
public 
static 
readonly 
TimeSpan '
SessionTimeout( 6
=7 8
TimeSpan9 A
.A B
	FromHoursB K
(K L
$numL N
)N O
;O P
public 
static 
readonly 
TimeSpan '(
DefaultCircuitBreakerTimeout( D
=E F
TimeSpanG O
.O P
FromSecondsP [
([ \
$num\ ^
)^ _
;_ `
public		 
static		 
readonly		 
TimeSpan		 '
NonceLifetime		( 5
=		6 7
TimeSpan		8 @
.		@ A
FromMinutes		A L
(		L M
$num		M N
)		N O
;		O P
public

 
static

 
readonly

 
TimeSpan

 '
CleanupInterval

( 7
=

8 9
TimeSpan

: B
.

B C
FromMinutes

C N
(

N O
$num

O P
)

P Q
;

Q R
public 
static 
readonly 
TimeSpan '$
WindowAdjustmentInterval( @
=A B
TimeSpanC K
.K L
FromMinutesL W
(W X
$numX Y
)Y Z
;Z [
public 
static 
readonly 
TimeSpan '
DefaultMaxChainAge( :
=; <
TimeSpan= E
.E F
	FromHoursF O
(O P
$numP Q
)Q R
;R S
} 
public 

static 
class 

MemoryPool "
{ 
public 
const 
int 
DEFAULT_BUFFER_SIZE ,
=- .
$num/ 3
;3 4
public 
const 
int 
MAX_POOL_SIZE &
=' (
$num) ,
;, -
public 
const 
int "
SECURE_WIPE_CHUNK_SIZE /
=0 1
$num2 6
;6 7
public 
const 
int 4
(SECURE_STRING_BUILDER_DEFAULT_CHUNK_SIZE A
=B C
$numD G
;G H
} 
public 

static 
class 
ErrorMessages %
{ 
public 
const 
string ,
 FAILED_TO_ALLOCATE_SECURE_MEMORY <
== >
$str? c
;c d
public 
const 
string ,
 REQUESTED_SIZE_EXCEEDS_ALLOCATED <
== >
$str? n
;n o
public 
const 
string (
FAILED_TO_READ_SECURE_MEMORY 8
=9 :
$str; [
;[ \
public 
const 
string 
BUFFER_DISPOSED +
=, -
$str. B
;B C
public 
const 
string 
HANDLE_DISPOSED +
=, -
$str. ?
;? @
public 
const 
string 
DATA_EXCEEDS_BUFFER /
=0 1
$str2 M
;M N
public 
const 
string 
REF_COUNT_FAILED ,
=- .
$str/ A
;A B
public   
const   
string   "
UNEXPECTED_WRITE_ERROR   2
=  3 4
$str  5 M
;  M N
public!! 
const!! 
string!!  
BUFFER_SIZE_POSITIVE!! 0
=!!1 2
$str!!3 Q
;!!Q R
public"" 
const"" 
string"" "
MAX_POOL_SIZE_POSITIVE"" 2
=""3 4
$str""5 U
;""U V
public## 
const## 
string## 
SIZE_POSITIVE## )
=##* +
$str##, C
;##C D
public$$ 
const$$ 
string$$ 
CHUNK_SIZE_POSITIVE$$ /
=$$0 1
$str$$2 O
;$$O P
public%% 
const%% 
string%% 6
*LIB_SODIUM_CONSTANT_TIME_COMPARISON_FAILED%% F
=%%G H
$str%%I u
;%%u v
public'' 
const'' 
string'' +
PERSONAL_PARAMETER_INVALID_SIZE'' ;
=''< =
$str	''> Ñ
;
''Ñ Ö
public(( 
const(( 
string(( '
FAILED_TO_DERIVE_MASTER_KEY(( 7
=((8 9
$str((: \
;((\ ]
public)) 
const)) 
string)) (
MARSHAL_PTR_TO_STRING_FAILED)) 8
=))9 :
$str)); `
;))` a
public** 
const** 
string** (
HASH_ALGORITHM_NOT_SUPPORTED** 8
=**9 :
$str**; ]
;**] ^
public++ 
const++ 
string++ *
SECURE_STRING_HANDLER_DISPOSED++ :
=++; <
$str++= ^
;++^ _
public,, 
const,, 
string,, *
SECURE_STRING_BUILDER_DISPOSED,, :
=,,; <
$str,,= R
;,,R S
public-- 
const-- 
string-- )
SECURE_STRING_BUILDER_NO_DATA-- 9
=--: ;
$str--< N
;--N O
}.. 
public00 

static00 
class00 
Numeric00 
{11 
public22 
const22 
int22 &
PERFORMANCE_DECIMAL_PLACES22 3
=224 5
$num226 7
;227 8
public33 
const33 
int33 $
JSON_ESCAPE_BUFFER_EXTRA33 1
=332 3
$num334 6
;336 7
public44 
const44 
int44 
DLL_IMPORT_SUCCESS44 +
=44, -
$num44. /
;44/ 0
public55 
const55 
int55 

ZERO_VALUE55 #
=55$ %
$num55& '
;55' (
}66 
public88 

static88 
class88 
Protocol88  
{99 
public:: 
const:: 
string:: %
INITIAL_SENDER_CHAIN_INFO:: 5
=::6 7
$str::8 H
;::H I
public;; 
const;; 
string;; '
INITIAL_RECEIVER_CHAIN_INFO;; 7
=;;8 9
$str;;: J
;;;J K
public<< 
const<< 
string<< 
DH_RATCHET_INFO<< +
=<<, -
$str<<. ?
;<<? @
public>> 
const>> 
long>> !
INITIAL_NONCE_COUNTER>> /
=>>0 1
$num>>2 3
;>>3 4
public?? 
const?? 
long?? 
MAX_NONCE_COUNTER?? +
=??, -
$num??. 8
;??8 9
public@@ 
const@@ 
int@@ $
RANDOM_NONCE_PREFIX_SIZE@@ 1
=@@2 3
$num@@4 5
;@@5 6
publicAA 
constAA 
uintAA 
DEFAULT_CHAIN_INDEXAA -
=AA. /
$numAA0 1
;AA1 2
publicBB 
constBB 
uintBB !
DEFAULT_MESSAGE_INDEXBB /
=BB0 1
$numBB2 3
;BB3 4
publicCC 
constCC 
intCC )
HKDF_OUTPUT_BUFFER_MULTIPLIERCC 6
=CC7 8
$numCC9 :
;CC: ;
}DD 
publicFF 

staticFF 
classFF 
RatchetRecoveryFF '
{GG 
publicHH 
constHH 
uintHH 
CLEANUP_THRESHOLDHH +
=HH, -
$numHH. 1
;HH1 2
publicII 
constII 
uintII !
INDEX_OVERFLOW_BUFFERII /
=II0 1
$numII2 7
;II7 8
}JJ 
publicLL 

staticLL 
classLL 
	ChainStepLL !
{MM 
publicNN 
constNN 
uintNN %
DEFAULT_CACHE_WINDOW_SIZENN 3
=NN4 5
$numNN6 :
;NN: ;
publicOO 
constOO 
uintOO 
INITIAL_INDEXOO '
=OO( )
$numOO* +
;OO+ ,
publicPP 
constPP 
uintPP 
INDEX_INCREMENTPP )
=PP* +
$numPP, -
;PP- .
publicQQ 
constQQ 
uintQQ 
RESET_INDEXQQ %
=QQ& '
$numQQ( )
;QQ) *
publicRR 
constRR 
uintRR $
MIN_INDEX_TO_KEEP_OFFSETRR 2
=RR3 4
$numRR5 6
;RR6 7
publicSS 
constSS 
uintSS +
VALIDATOR_ARRAY_EMPTY_THRESHOLDSS 9
=SS: ;
$numSS< =
;SS= >
}TT 
publicVV 

staticVV 
classVV 
ProtocolSystemVV &
{WW 
publicXX 
constXX 
intXX 
EMPTY_ARRAY_LENGTHXX +
=XX, -
$numXX. /
;XX/ 0
publicYY 
constYY 
intYY #
MAX_IDENTITY_KEY_LENGTHYY 0
=YY1 2
$numYY3 7
;YY7 8
publicZZ 
constZZ 
intZZ 
MAX_PAYLOAD_SIZEZZ )
=ZZ* +
$numZZ, .
*ZZ/ 0
$numZZ1 5
*ZZ6 7
$numZZ8 <
;ZZ< =
public[[ 
const[[ 
int[[ $
INTEGER_OVERFLOW_DIVISOR[[ 1
=[[2 3
$num[[4 5
;[[5 6
public\\ 
const\\ 
int\\ $
BUFFER_COPY_START_OFFSET\\ 1
=\\2 3
$num\\4 5
;\\5 6
public]] 
const]] 
int]] +
CIPHER_LENGTH_MINIMUM_THRESHOLD]] 8
=]]9 :
$num]]; <
;]]< =
public__ 
const__ 
string__ &
DH_PUBLIC_KEY_NULL_MESSAGE__ 6
=__7 8
$str__9 P
;__P Q
public`` 
const`` 
string`` !
NO_CONNECTION_MESSAGE`` 1
=``2 3
$str``4 C
;``C D
publicaa 
constaa 
stringaa %
REFLECTION_ATTACK_MESSAGEaa 5
=aa6 7
$straa8 w
;aaw x
publicbb 
constbb 
stringbb )
PARSE_PROTOBUF_FAILED_MESSAGEbb 9
=bb: ;
$strbb< s
;bbs t
publiccc 
constcc 
stringcc )
SIGNED_PRE_KEY_FAILED_MESSAGEcc 9
=cc: ;
$strcc< j
;ccj k
publicdd 
constdd 
stringdd 7
+PROTOCOL_CONNECTION_NOT_INITIALIZED_MESSAGEdd G
=ddH I
$strddJ o
;ddo p
publicee 
constee 
stringee +
IDENTITY_KEYS_TOO_LARGE_MESSAGEee ;
=ee< =
$stree> l
;eel m
publicff 
constff 
stringff $
INTEGER_OVERFLOW_MESSAGEff 4
=ff5 6
$strff7 l
;ffl m
publicgg 
constgg 
stringgg *
AES_GCM_ENCRYPT_OPERATION_NAMEgg :
=gg; <
$strgg= N
;ggN O
publichh 
consthh 
stringhh *
AES_GCM_DECRYPT_OPERATION_NAMEhh :
=hh; <
$strhh= N
;hhN O
publicii 
constii 
stringii -
!AES_GCM_ENCRYPTION_FAILED_MESSAGEii =
=ii> ?
$strii@ \
;ii\ ]
publicjj 
constjj 
stringjj (
CIPHERTEXT_TOO_SMALL_MESSAGEjj 8
=jj9 :
$str	jj; Ö
;
jjÖ Ü
publickk 
constkk 
stringkk -
!AES_GCM_DECRYPTION_FAILED_MESSAGEkk =
=kk> ?
$strkk@ z
;kkz {
}ll 
publicnn 

staticnn 
classnn 
	Librariesnn !
{oo 
publicpp 
constpp 
stringpp 

LIB_SODIUMpp &
=pp' (
$strpp) 4
;pp4 5
publicqq 
constqq 
stringqq 
	KERNEL_32qq %
=qq& '
$strqq( 6
;qq6 7
publicrr 
constrr 
stringrr 
LIB_Crr !
=rr" #
$strrr$ *
;rr* +
}ss 
}tt ò∑
l/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/ReplayProtection.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
internal 
sealed	 
class 
ReplayProtection &
:' (
IDisposable) 4
{ 
private		 
readonly		  
ConcurrentDictionary		 )
<		) *
NonceKey		* 2
,		2 3
DateTime		4 <
>		< =
_processedNonces		> N
;		N O
private

 
readonly

  
ConcurrentDictionary

 )
<

) *
ulong

* /
,

/ 0
MessageWindow

1 >
>

> ?
_messageWindows

@ O
;

O P
private 
readonly 
TimeSpan 
_nonceLifetime ,
;, -
private 
ulong  
_maxOutOfOrderWindow &
;& '
private 
readonly 
Timer 
_cleanupTimer (
;( )
private 
readonly 
Lock 
_lock 
=  !
new" %
(% &
)& '
;' (
private 
readonly 
ulong 
_baseWindow &
;& '
private 
readonly 
ulong 

_maxWindow %
;% &
private 
int 
_recentMessageCount #
;# $
private 
DateTime !
_lastWindowAdjustment *
=+ ,
DateTime- 5
.5 6
UtcNow6 <
;< =
private 
bool 
	_disposed 
; 
public 

ReplayProtection 
( 
TimeSpan 
nonceLifetime 
=  
default! (
,( )
ulong 
maxOutOfOrderWindow !
=" #
$num$ (
,( )
ulong 
	maxWindow 
= 
$num 
) 
{ 
_processedNonces 
= 
new  
ConcurrentDictionary 3
<3 4
NonceKey4 <
,< =
DateTime> F
>F G
(G H
)H I
;I J
_messageWindows 
= 
new  
ConcurrentDictionary 2
<2 3
ulong3 8
,8 9
MessageWindow: G
>G H
(H I
)I J
;J K
_nonceLifetime 
= 
nonceLifetime &
==' )
TimeSpan* 2
.2 3
Zero3 7
?8 9#
ProtocolSystemConstants: Q
.Q R
TimeoutsR Z
.Z [
NonceLifetime[ h
:i j
nonceLifetimek x
;x y
_baseWindow 
= 
maxOutOfOrderWindow )
;) * 
_maxOutOfOrderWindow 
= 
maxOutOfOrderWindow 2
;2 3

_maxWindow 
= 
	maxWindow 
; 
_cleanupTimer!! 
=!! 
new!! 
Timer!! !
(!!! "
callback"" 
:"" 
_"" 
=>"" 
{## !
CleanupExpiredEntries$$ %
($$% &
)$$& '
;$$' (
AdjustWindowSize%%  
(%%  !
)%%! "
;%%" #
}&& 
,&& 
state'' 
:'' 
null'' 
,'' 
dueTime(( 
:(( #
ProtocolSystemConstants(( ,
.((, -
Timeouts((- 5
.((5 6
CleanupInterval((6 E
,((E F
period)) 
:)) #
ProtocolSystemConstants)) +
.))+ ,
Timeouts)), 4
.))4 5
CleanupInterval))5 D
)** 	
;**	 

}++ 
public-- 

Result-- 
<-- 
Unit-- 
,-- #
EcliptixProtocolFailure-- /
>--/ 0!
CheckAndRecordMessage--1 F
(--F G
byte.. 
[.. 
].. 
nonce.. 
,.. 
ulong// 
messageIndex// 
,// 
ulong00 

chainIndex00 
=00 
$num00 
)00 
{11 
if22 

(22 
	_disposed22 
)22 
{33 	
return44 
Result44 
<44 
Unit44 
,44 #
EcliptixProtocolFailure44  7
>447 8
.448 9
Err449 <
(44< =#
EcliptixProtocolFailure55 '
.55' (
OBJECT_DISPOSED55( 7
(557 8
nameof558 >
(55> ?
ReplayProtection55? O
)55O P
)55P Q
)55Q R
;55R S
}66 	
if88 

(88 
nonce88 
.88 
Length88 
==88 
$num88 
)88 
{99 	
return:: 
Result:: 
<:: 
Unit:: 
,:: #
EcliptixProtocolFailure::  7
>::7 8
.::8 9
Err::9 <
(::< =#
EcliptixProtocolFailure;; '
.;;' (
InvalidInput;;( 4
(;;4 5+
EcliptixProtocolFailureMessages;;5 T
.;;T U
ReplayProtection;;U e
.;;e f*
NONCE_CANNOT_BE_NULL_OR_EMPTY	;;f É
)
;;É Ñ
)
;;Ñ Ö
;
;;Ö Ü
}<< 	
lock>> 
(>> 
_lock>> 
)>> 
{?? 	
NonceKey@@ 
nonceKey@@ 
=@@ 
new@@  #
(@@# $
nonce@@$ )
)@@) *
;@@* +
ifBB 
(BB 
_processedNoncesBB  
.BB  !
ContainsKeyBB! ,
(BB, -
nonceKeyBB- 5
)BB5 6
)BB6 7
{CC 
returnDD 
ResultDD 
<DD 
UnitDD "
,DD" ##
EcliptixProtocolFailureDD$ ;
>DD; <
.DD< =
ErrDD= @
(DD@ A#
EcliptixProtocolFailureEE +
.EE+ ,
GenericEE, 3
(EE3 4+
EcliptixProtocolFailureMessagesEE4 S
.EES T
ReplayProtectionEET d
.EEd e)
REPLAY_ATTACK_DETECTED_NONCE	EEe Å
)
EEÅ Ç
)
EEÇ É
;
EEÉ Ñ
}FF 
ResultHH 
<HH 
UnitHH 
,HH #
EcliptixProtocolFailureHH 0
>HH0 1
windowCheckHH2 =
=HH> ?
CheckMessageWindowHH@ R
(HHR S

chainIndexHHS ]
,HH] ^
messageIndexHH_ k
)HHk l
;HHl m
ifII 
(II 
windowCheckII 
.II 
IsErrII !
)II! "
{JJ 
returnKK 
windowCheckKK "
;KK" #
}LL 
_processedNoncesNN 
[NN 
nonceKeyNN %
]NN% &
=NN' (
DateTimeNN) 1
.NN1 2
UtcNowNN2 8
;NN8 9
UpdateMessageWindowOO 
(OO  

chainIndexOO  *
,OO* +
messageIndexOO, 8
)OO8 9
;OO9 :
_recentMessageCountPP 
++PP !
;PP! "
returnRR 
ResultRR 
<RR 
UnitRR 
,RR #
EcliptixProtocolFailureRR  7
>RR7 8
.RR8 9
OkRR9 ;
(RR; <
UnitRR< @
.RR@ A
ValueRRA F
)RRF G
;RRG H
}SS 	
}TT 
privateVV 
ResultVV 
<VV 
UnitVV 
,VV #
EcliptixProtocolFailureVV 0
>VV0 1
CheckMessageWindowVV2 D
(VVD E
ulongVVE J

chainIndexVVK U
,VVU V
ulongVVW \
messageIndexVV] i
)VVi j
{WW 
ifXX 

(XX 
!XX 
_messageWindowsXX 
.XX 
TryGetValueXX (
(XX( )

chainIndexXX) 3
,XX3 4
outXX5 8
MessageWindowXX9 F
?XXF G
windowXXH N
)XXN O
)XXO P
{YY 	
_messageWindowsZZ 
[ZZ 

chainIndexZZ &
]ZZ& '
=ZZ( )
newZZ* -
MessageWindowZZ. ;
(ZZ; <
messageIndexZZ< H
)ZZH I
;ZZI J
return[[ 
Result[[ 
<[[ 
Unit[[ 
,[[ #
EcliptixProtocolFailure[[  7
>[[7 8
.[[8 9
Ok[[9 ;
([[; <
Unit[[< @
.[[@ A
Value[[A F
)[[F G
;[[G H
}\\ 	
if^^ 

(^^ 
messageIndex^^ 
<=^^ 
window^^ "
.^^" #!
HighestProcessedIndex^^# 8
)^^8 9
{__ 	
if`` 
(`` 
window`` 
.`` 
IsProcessed`` "
(``" #
messageIndex``# /
)``/ 0
)``0 1
{aa 
returnbb 
Resultbb 
<bb 
Unitbb "
,bb" ##
EcliptixProtocolFailurebb$ ;
>bb; <
.bb< =
Errbb= @
(bb@ A#
EcliptixProtocolFailurecc +
.cc+ ,
Genericcc, 3
(cc3 4
stringcc4 :
.cc: ;
Formatcc; A
(ccA B+
EcliptixProtocolFailureMessagesccB a
.cca b
ReplayProtectionccb r
.ccr s1
$REPLAY_ATTACK_DETECTED_MESSAGE_INDEX	ccs ó
,
ccó ò
messageIndex
ccô •
,
cc• ¶

chainIndex
ccß ±
)
cc± ≤
)
cc≤ ≥
)
cc≥ ¥
;
cc¥ µ
}dd 
ulongff 
gapff 
=ff 
windowff 
.ff !
HighestProcessedIndexff 4
-ff5 6
messageIndexff7 C
;ffC D
ifgg 
(gg 
gapgg 
>gg  
_maxOutOfOrderWindowgg *
)gg* +
{hh 
returnii 
Resultii 
<ii 
Unitii "
,ii" ##
EcliptixProtocolFailureii$ ;
>ii; <
.ii< =
Errii= @
(ii@ A#
EcliptixProtocolFailurejj +
.jj+ ,
Genericjj, 3
(jj3 4
stringjj4 :
.jj: ;
Formatjj; A
(jjA B+
EcliptixProtocolFailureMessagesjjB a
.jja b
ReplayProtectionjjb r
.jjr s)
MESSAGE_INDEX_TOO_FAR_BEHIND	jjs è
,
jjè ê
messageIndex
jjë ù
,
jjù û
gap
jjü ¢
,
jj¢ £"
_maxOutOfOrderWindow
jj§ ∏
)
jj∏ π
)
jjπ ∫
)
jj∫ ª
;
jjª º
}kk 
}ll 	
returnnn 
Resultnn 
<nn 
Unitnn 
,nn #
EcliptixProtocolFailurenn 3
>nn3 4
.nn4 5
Oknn5 7
(nn7 8
Unitnn8 <
.nn< =
Valuenn= B
)nnB C
;nnC D
}oo 
privateqq 
voidqq 
UpdateMessageWindowqq $
(qq$ %
ulongqq% *

chainIndexqq+ 5
,qq5 6
ulongqq7 <
messageIndexqq= I
)qqI J
{rr 
ifss 

(ss 
_messageWindowsss 
.ss 
TryGetValuess '
(ss' (

chainIndexss( 2
,ss2 3
outss4 7
MessageWindowss8 E
?ssE F
windowssG M
)ssM N
)ssN O
{tt 	
windowuu 
.uu 
MarkProcesseduu  
(uu  !
messageIndexuu! -
)uu- .
;uu. /
}vv 	
elseww 
{xx 	
_messageWindowsyy 
[yy 

chainIndexyy &
]yy& '
=yy( )
newyy* -
MessageWindowyy. ;
(yy; <
messageIndexyy< H
)yyH I
;yyI J
}zz 	
}{{ 
private}} 
void}} !
CleanupExpiredEntries}} &
(}}& '
)}}' (
{~~ 
if 

( 
	_disposed 
) 
{
ÄÄ 	
return
ÅÅ 
;
ÅÅ 
}
ÇÇ 	
DateTime
ÑÑ 
cutoff
ÑÑ 
=
ÑÑ 
DateTime
ÑÑ "
.
ÑÑ" #
UtcNow
ÑÑ# )
-
ÑÑ* +
_nonceLifetime
ÑÑ, :
;
ÑÑ: ;
lock
ÜÜ 
(
ÜÜ 
_lock
ÜÜ 
)
ÜÜ 
{
áá 	
List
àà 
<
àà 
NonceKey
àà 
>
àà 
expiredKeys
àà &
=
àà' (
new
àà) ,
(
àà, -
_processedNonces
àà- =
.
àà= >
Count
àà> C
)
ààC D
;
ààD E
expiredKeys
ââ 
.
ââ 
AddRange
ââ  
(
ââ  !
from
ââ! %
kvp
ââ& )
in
ââ* ,
_processedNonces
ââ- =
where
ââ> C
kvp
ââD G
.
ââG H
Value
ââH M
<
ââN O
cutoff
ââP V
select
ââW ]
kvp
ââ^ a
.
ââa b
Key
ââb e
)
ââe f
;
ââf g
foreach
ãã 
(
ãã 
NonceKey
ãã 

expiredKey
ãã (
in
ãã) +
expiredKeys
ãã, 7
)
ãã7 8
{
åå 
_processedNonces
çç  
.
çç  !
	TryRemove
çç! *
(
çç* +

expiredKey
çç+ 5
,
çç5 6
out
çç7 :
_
çç; <
)
çç< =
;
çç= >
}
éé 
foreach
êê 
(
êê 
KeyValuePair
êê !
<
êê! "
ulong
êê" '
,
êê' (
MessageWindow
êê) 6
>
êê6 7
kvp
êê8 ;
in
êê< >
_messageWindows
êê? N
)
êêN O
{
ëë 
kvp
íí 
.
íí 
Value
íí 
.
íí 
CleanupOldEntries
íí +
(
íí+ ,
cutoff
íí, 2
)
íí2 3
;
íí3 4
}
ìì 
}
îî 	
}
ïï 
private
óó 
void
óó 
AdjustWindowSize
óó !
(
óó! "
)
óó" #
{
òò 
if
ôô 

(
ôô 
	_disposed
ôô 
)
ôô 
{
öö 	
return
õõ 
;
õõ 
}
úú 	
DateTime
ûû 
now
ûû 
=
ûû 
DateTime
ûû 
.
ûû  
UtcNow
ûû  &
;
ûû& '
if
üü 

(
üü 
now
üü 
-
üü #
_lastWindowAdjustment
üü '
<
üü( )%
ProtocolSystemConstants
üü* A
.
üüA B
Timeouts
üüB J
.
üüJ K&
WindowAdjustmentInterval
üüK c
)
üüc d
{
†† 	
return
°° 
;
°° 
}
¢¢ 	
lock
§§ 
(
§§ 
_lock
§§ 
)
§§ 
{
•• 	
double
¶¶ 
messageRate
¶¶ 
=
¶¶  !
_recentMessageCount
¶¶! 4
/
¶¶5 6
$num
¶¶7 :
;
¶¶: ;
if
®® 
(
®® 
messageRate
®® 
>
®® 
$num
®®  
)
®®  !
{
©© "
_maxOutOfOrderWindow
™™ $
=
™™% &
Math
™™' +
.
™™+ ,
Min
™™, /
(
™™/ 0
_baseWindow
™™0 ;
*
™™< =
$num
™™> ?
,
™™? @

_maxWindow
™™A K
)
™™K L
;
™™L M
}
´´ 
else
¨¨ 
if
¨¨ 
(
¨¨ 
messageRate
¨¨  
>
¨¨! "
$num
¨¨# %
)
¨¨% &
{
≠≠ "
_maxOutOfOrderWindow
ÆÆ $
=
ÆÆ% &
Math
ÆÆ' +
.
ÆÆ+ ,
Min
ÆÆ, /
(
ÆÆ/ 0
_baseWindow
ÆÆ0 ;
*
ÆÆ< =
$num
ÆÆ> ?
,
ÆÆ? @

_maxWindow
ÆÆA K
)
ÆÆK L
;
ÆÆL M
}
ØØ 
else
∞∞ 
{
±± "
_maxOutOfOrderWindow
≤≤ $
=
≤≤% &
_baseWindow
≤≤' 2
;
≤≤2 3
}
≥≥ !
_recentMessageCount
µµ 
=
µµ  !
$num
µµ" #
;
µµ# $#
_lastWindowAdjustment
∂∂ !
=
∂∂" #
now
∂∂$ '
;
∂∂' (
}
∑∑ 	
}
∏∏ 
public
∫∫ 

void
∫∫ 
OnRatchetRotation
∫∫ !
(
∫∫! "
)
∫∫" #
{
ªª 
if
ºº 

(
ºº 
	_disposed
ºº 
)
ºº 
{
ΩΩ 	
return
ææ 
;
ææ 
}
øø 	
lock
¡¡ 
(
¡¡ 
_lock
¡¡ 
)
¡¡ 
{
¬¬ 	
_messageWindows
√√ 
.
√√ 
Clear
√√ !
(
√√! "
)
√√" #
;
√√# $
}
ƒƒ 	
}
≈≈ 
public
«« 

void
«« 
Dispose
«« 
(
«« 
)
«« 
{
»» 
if
…… 

(
…… 
	_disposed
…… 
)
…… 
{
   	
return
ÀÀ 
;
ÀÀ 
}
ÃÃ 	
	_disposed
ŒŒ 
=
ŒŒ 
true
ŒŒ 
;
ŒŒ 
_cleanupTimer
œœ 
?
œœ 
.
œœ 
Dispose
œœ 
(
œœ 
)
œœ  
;
œœ  !
_processedNonces
–– 
.
–– 
Clear
–– 
(
–– 
)
––  
;
––  !
_messageWindows
—— 
.
—— 
Clear
—— 
(
—— 
)
—— 
;
——  
}
““ 
private
‘‘ 
sealed
‘‘ 
class
‘‘ 
MessageWindow
‘‘ &
{
’’ 
private
÷÷ 
readonly
÷÷ 
	SortedSet
÷÷ "
<
÷÷" #
ulong
÷÷# (
>
÷÷( )
_processedIndices
÷÷* ;
=
÷÷< =
[
÷÷> ?
]
÷÷? @
;
÷÷@ A
private
◊◊ 
readonly
◊◊ 
DateTime
◊◊ !

_createdAt
◊◊" ,
=
◊◊- .
DateTime
◊◊/ 7
.
◊◊7 8
UtcNow
◊◊8 >
;
◊◊> ?
public
ŸŸ 
ulong
ŸŸ #
HighestProcessedIndex
ŸŸ *
{
ŸŸ+ ,
get
ŸŸ- 0
;
ŸŸ0 1
private
ŸŸ2 9
set
ŸŸ: =
;
ŸŸ= >
}
ŸŸ? @
public
€€ 
MessageWindow
€€ 
(
€€ 
ulong
€€ "
initialIndex
€€# /
)
€€/ 0
{
‹‹ 	#
HighestProcessedIndex
›› !
=
››" #
initialIndex
››$ 0
;
››0 1
_processedIndices
ﬁﬁ 
.
ﬁﬁ 
Add
ﬁﬁ !
(
ﬁﬁ! "
initialIndex
ﬁﬁ" .
)
ﬁﬁ. /
;
ﬁﬁ/ 0
}
ﬂﬂ 	
public
·· 
bool
·· 
IsProcessed
·· 
(
··  
ulong
··  %
messageIndex
··& 2
)
··2 3
{
‚‚ 	
return
„„ 
_processedIndices
„„ $
.
„„$ %
Contains
„„% -
(
„„- .
messageIndex
„„. :
)
„„: ;
;
„„; <
}
‰‰ 	
public
ÊÊ 
void
ÊÊ 
MarkProcessed
ÊÊ !
(
ÊÊ! "
ulong
ÊÊ" '
messageIndex
ÊÊ( 4
)
ÊÊ4 5
{
ÁÁ 	
_processedIndices
ËË 
.
ËË 
Add
ËË !
(
ËË! "
messageIndex
ËË" .
)
ËË. /
;
ËË/ 0
if
ÈÈ 
(
ÈÈ 
messageIndex
ÈÈ 
>
ÈÈ #
HighestProcessedIndex
ÈÈ 4
)
ÈÈ4 5
{
ÍÍ #
HighestProcessedIndex
ÎÎ %
=
ÎÎ& '
messageIndex
ÎÎ( 4
;
ÎÎ4 5
}
ÏÏ 
}
ÌÌ 	
public
ÔÔ 
void
ÔÔ 
CleanupOldEntries
ÔÔ %
(
ÔÔ% &
DateTime
ÔÔ& .
cutoff
ÔÔ/ 5
)
ÔÔ5 6
{
 	
if
ÒÒ 
(
ÒÒ 

_createdAt
ÒÒ 
<
ÒÒ 
cutoff
ÒÒ #
)
ÒÒ# $
{
ÚÚ 
ulong
ÛÛ 
keepFromIndex
ÛÛ #
=
ÛÛ$ %#
HighestProcessedIndex
ÛÛ& ;
>
ÛÛ< =
$num
ÛÛ> B
?
ÛÛC D#
HighestProcessedIndex
ÛÛE Z
-
ÛÛ[ \
$num
ÛÛ] a
:
ÛÛb c
$num
ÛÛd e
;
ÛÛe f
_processedIndices
ÙÙ !
.
ÙÙ! "
RemoveWhere
ÙÙ" -
(
ÙÙ- .
idx
ÙÙ. 1
=>
ÙÙ2 4
idx
ÙÙ5 8
<
ÙÙ9 :
keepFromIndex
ÙÙ; H
)
ÙÙH I
;
ÙÙI J
}
ıı 
}
ˆˆ 	
}
˜˜ 
private
˘˘ 
readonly
˘˘ 
struct
˘˘ 
NonceKey
˘˘ $
:
˘˘% &

IEquatable
˘˘' 1
<
˘˘1 2
NonceKey
˘˘2 :
>
˘˘: ;
{
˙˙ 
private
˚˚ 
readonly
˚˚ 
byte
˚˚ 
[
˚˚ 
]
˚˚ 
_nonce
˚˚  &
;
˚˚& '
private
¸¸ 
readonly
¸¸ 
int
¸¸ 
	_hashCode
¸¸ &
;
¸¸& '
public
˛˛ 
NonceKey
˛˛ 
(
˛˛ 
byte
˛˛ 
[
˛˛ 
]
˛˛ 
nonce
˛˛ $
)
˛˛$ %
{
ˇˇ 	
_nonce
ÄÄ 
=
ÄÄ 
(
ÄÄ 
byte
ÄÄ 
[
ÄÄ 
]
ÄÄ 
)
ÄÄ 
nonce
ÄÄ "
.
ÄÄ" #
Clone
ÄÄ# (
(
ÄÄ( )
)
ÄÄ) *
;
ÄÄ* +
	_hashCode
ÅÅ 
=
ÅÅ 
ComputeHashCode
ÅÅ '
(
ÅÅ' (
nonce
ÅÅ( -
)
ÅÅ- .
;
ÅÅ. /
}
ÇÇ 	
private
ÑÑ 
static
ÑÑ 
int
ÑÑ 
ComputeHashCode
ÑÑ *
(
ÑÑ* +
ReadOnlySpan
ÑÑ+ 7
<
ÑÑ7 8
byte
ÑÑ8 <
>
ÑÑ< =
nonce
ÑÑ> C
)
ÑÑC D
{
ÖÖ 	
HashCode
ÜÜ 
hash
ÜÜ 
=
ÜÜ 
new
ÜÜ 
(
ÜÜ  
)
ÜÜ  !
;
ÜÜ! "
hash
áá 
.
áá 
AddBytes
áá 
(
áá 
nonce
áá 
)
áá  
;
áá  !
return
àà 
hash
àà 
.
àà 

ToHashCode
àà "
(
àà" #
)
àà# $
;
àà$ %
}
ââ 	
public
ãã 
bool
ãã 
Equals
ãã 
(
ãã 
NonceKey
ãã #
other
ãã$ )
)
ãã) *
{
åå 	
return
çç 
_nonce
çç 
.
çç 
AsSpan
çç  
(
çç  !
)
çç! "
.
çç" #
SequenceEqual
çç# 0
(
çç0 1
other
çç1 6
.
çç6 7
_nonce
çç7 =
)
çç= >
;
çç> ?
}
éé 	
public
êê 
override
êê 
bool
êê 
Equals
êê #
(
êê# $
object
êê$ *
?
êê* +
obj
êê, /
)
êê/ 0
{
ëë 	
return
íí 
obj
íí 
is
íí 
NonceKey
íí "
other
íí# (
&&
íí) +
Equals
íí, 2
(
íí2 3
other
íí3 8
)
íí8 9
;
íí9 :
}
ìì 	
public
ïï 
override
ïï 
int
ïï 
GetHashCode
ïï '
(
ïï' (
)
ïï( )
=>
ïï* ,
	_hashCode
ïï- 6
;
ïï6 7
}
ññ 
}óó ’¶
k/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/RatchetRecovery.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
internal

 
sealed

	 
class

 
RatchetRecovery

 %
(

% &
uint

& *
maxSkippedMessages

+ =
=

> ?
$num

@ D
)

D E
:

F G
IKeyProvider

H T
,

T U
IDisposable

V a
{ 
private 
readonly 

Dictionary 
<  
uint  $
,$ %$
SodiumSecureMemoryHandle& >
>> ?
_skippedMessageKeys@ S
=T U
newV Y
(Y Z
)Z [
;[ \
private 
readonly 
Lock 
_lock 
=  !
new" %
(% &
)& '
;' (
private 
bool 
	_disposed 
; 
public 

Result 
< 
T 
, #
EcliptixProtocolFailure ,
>, -
ExecuteWithKey. <
<< =
T= >
>> ?
(? @
uint@ D
keyIndexE M
,M N
FuncO S
<S T
ReadOnlySpanT `
<` a
bytea e
>e f
,f g
Resulth n
<n o
To p
,p q$
EcliptixProtocolFailure	r â
>
â ä
>
ä ã
	operation
å ï
)
ï ñ
{ 
if 

( 
	_disposed 
) 
{ 	
return 
Result 
< 
T 
, #
EcliptixProtocolFailure 4
>4 5
.5 6
Err6 9
(9 :#
EcliptixProtocolFailure '
.' (
OBJECT_DISPOSED( 7
(7 8
nameof8 >
(> ?
RatchetRecovery? N
)N O
)O P
)P Q
;Q R
} 	
lock 
( 
_lock 
) 
{ 	
if 
( 
! 
_skippedMessageKeys $
.$ %
TryGetValue% 0
(0 1
keyIndex1 9
,9 :
out; >$
SodiumSecureMemoryHandle? W
?W X
	keyHandleY b
)b c
)c d
{ 
return 
Result 
< 
T 
,  #
EcliptixProtocolFailure! 8
>8 9
.9 :
Err: =
(= >#
EcliptixProtocolFailure +
.+ ,
InvalidInput, 8
(8 9
$"9 ;
$str; R
{R S
keyIndexS [
}[ \
$str\ g
"g h
)h i
)i j
;j k
} 
Result   
<   
T   
,   
SodiumFailure   #
>  # $
sodiumResult  % 1
=  2 3
	keyHandle  4 =
.  = >
WithReadAccess  > L
(  L M
keyMaterial  M X
=>  Y [
{!! 
Result"" 
<"" 
T"" 
,"" #
EcliptixProtocolFailure"" 1
>""1 2
opResult""3 ;
=""< =
	operation""> G
(""G H
keyMaterial""H S
)""S T
;""T U
return## 
opResult## 
.##  
IsOk##  $
?$$ 
Result$$ 
<$$ 
T$$ 
,$$ 
SodiumFailure$$  -
>$$- .
.$$. /
Ok$$/ 1
($$1 2
opResult$$2 :
.$$: ;
Unwrap$$; A
($$A B
)$$B C
)$$C D
:%% 
Result%% 
<%% 
T%% 
,%% 
SodiumFailure%%  -
>%%- .
.%%. /
Err%%/ 2
(%%2 3
SodiumFailure%%3 @
.%%@ A
InvalidOperation%%A Q
(%%Q R
opResult%%R Z
.%%Z [
	UnwrapErr%%[ d
(%%d e
)%%e f
.%%f g
Message%%g n
)%%n o
)%%o p
;%%p q
}&& 
)&& 
;&& 
return(( 
sodiumResult(( 
.((  
IsOk((  $
?)) 
Result)) 
<)) 
T)) 
,)) #
EcliptixProtocolFailure)) 3
>))3 4
.))4 5
Ok))5 7
())7 8
sodiumResult))8 D
.))D E
Unwrap))E K
())K L
)))L M
)))M N
:** 
Result** 
<** 
T** 
,** #
EcliptixProtocolFailure** 3
>**3 4
.**4 5
Err**5 8
(**8 9#
EcliptixProtocolFailure**9 P
.**P Q
Generic**Q X
(**X Y
sodiumResult**Y e
.**e f
	UnwrapErr**f o
(**o p
)**p q
.**q r
Message**r y
)**y z
)**z {
;**{ |
}++ 	
},, 
public.. 

Result.. 
<.. 
Option.. 
<.. 
RatchetChainKey.. (
>..( )
,..) *#
EcliptixProtocolFailure..+ B
>..B C 
TryRecoverMessageKey..D X
(..X Y
uint..Y ]
messageIndex..^ j
)..j k
{// 
if00 

(00 
	_disposed00 
)00 
{11 	
return22 
Result22 
<22 
Option22  
<22  !
RatchetChainKey22! 0
>220 1
,221 2#
EcliptixProtocolFailure223 J
>22J K
.22K L
Err22L O
(22O P#
EcliptixProtocolFailure33 '
.33' (
OBJECT_DISPOSED33( 7
(337 8
nameof338 >
(33> ?
RatchetRecovery33? N
)33N O
)33O P
)33P Q
;33Q R
}44 	
lock66 
(66 
_lock66 
)66 
{77 	
if88 
(88 
_skippedMessageKeys88 #
.88# $
TryGetValue88$ /
(88/ 0
messageIndex880 <
,88< =
out88> A$
SodiumSecureMemoryHandle88B Z
?88Z [
_88\ ]
)88] ^
)88^ _
{99 
RatchetChainKey:: 

messageKey::  *
=::+ ,
new::- 0
(::0 1
messageIndex::1 =
,::= >
this::? C
)::C D
;::D E
return;; 
Result;; 
<;; 
Option;; $
<;;$ %
RatchetChainKey;;% 4
>;;4 5
,;;5 6#
EcliptixProtocolFailure;;7 N
>;;N O
.;;O P
Ok;;P R
(;;R S
Option<< 
<<< 
RatchetChainKey<< *
><<* +
.<<+ ,
Some<<, 0
(<<0 1

messageKey<<1 ;
)<<; <
)<<< =
;<<= >
}== 
return?? 
Result?? 
<?? 
Option??  
<??  !
RatchetChainKey??! 0
>??0 1
,??1 2#
EcliptixProtocolFailure??3 J
>??J K
.??K L
Ok??L N
(??N O
Option@@ 
<@@ 
RatchetChainKey@@ &
>@@& '
.@@' (
None@@( ,
)@@, -
;@@- .
}AA 	
}BB 
publicDD 

ResultDD 
<DD 
UnitDD 
,DD #
EcliptixProtocolFailureDD /
>DD/ 0#
StoreSkippedMessageKeysDD1 H
(DDH I
byteEE 
[EE 
]EE 
currentChainKeyEE 
,EE 
uintFF 
	fromIndexFF 
,FF 
uintGG 
toIndexGG 
)GG 
{HH 
ifII 

(II 
	_disposedII 
)II 
{JJ 	
returnKK 
ResultKK 
<KK 
UnitKK 
,KK #
EcliptixProtocolFailureKK  7
>KK7 8
.KK8 9
ErrKK9 <
(KK< =#
EcliptixProtocolFailureLL '
.LL' (
OBJECT_DISPOSEDLL( 7
(LL7 8
nameofLL8 >
(LL> ?
RatchetRecoveryLL? N
)LLN O
)LLO P
)LLP Q
;LLQ R
}MM 	
ifOO 

(OO 
toIndexOO 
<=OO 
	fromIndexOO  
)OO  !
{PP 	
returnQQ 
ResultQQ 
<QQ 
UnitQQ 
,QQ #
EcliptixProtocolFailureQQ  7
>QQ7 8
.QQ8 9
OkQQ9 ;
(QQ; <
UnitQQ< @
.QQ@ A
ValueQQA F
)QQF G
;QQG H
}RR 	
lockTT 
(TT 
_lockTT 
)TT 
{UU 	
uintVV 
skippedCountVV 
=VV 
toIndexVV  '
-VV( )
	fromIndexVV* 3
;VV3 4
ifWW 
(WW 
_skippedMessageKeysWW #
.WW# $
CountWW$ )
+WW* +
skippedCountWW, 8
>WW9 :
maxSkippedMessagesWW; M
)WWM N
{XX 
returnYY 
ResultYY 
<YY 
UnitYY "
,YY" ##
EcliptixProtocolFailureYY$ ;
>YY; <
.YY< =
ErrYY= @
(YY@ A#
EcliptixProtocolFailureZZ +
.ZZ+ ,
GenericZZ, 3
(ZZ3 4
$"[[ 
$str[[ 5
{[[5 6
_skippedMessageKeys[[6 I
.[[I J
Count[[J O
+[[P Q
skippedCount[[R ^
}[[^ _
$str[[_ b
{[[b c
maxSkippedMessages[[c u
}[[u v
"[[v w
)[[w x
)[[x y
;[[y z
}\\ 
using^^ (
ScopedSecureMemoryCollection^^ .
secureMemory^^/ ;
=^^< =
new^^> A
(^^A B
)^^B C
;^^C D
ScopedSecureMemory__ 
chainKeyMemory__ -
=__. /
secureMemory__0 <
.__< =
Allocate__= E
(__E F
	Constants__F O
.__O P
X_25519_KEY_SIZE__P `
)__` a
;__a b
currentChainKey`` 
.`` 
CopyTo`` "
(``" #
chainKeyMemory``# 1
.``1 2
AsSpan``2 8
(``8 9
)``9 :
)``: ;
;``; <
forbb 
(bb 
uintbb 
ibb 
=bb 
	fromIndexbb #
;bb# $
ibb% &
<bb' (
toIndexbb) 0
;bb0 1
ibb2 3
++bb3 5
)bb5 6
{cc 
Resultdd 
<dd $
SodiumSecureMemoryHandledd /
,dd/ 0#
EcliptixProtocolFailuredd1 H
>ddH I
msgKeyResultddJ V
=ddW X"
DeriveSecureMessageKeyee *
(ee* +
chainKeyMemoryee+ 9
.ee9 :
AsSpanee: @
(ee@ A
)eeA B
,eeB C
ieeD E
)eeE F
;eeF G
ifff 
(ff 
msgKeyResultff  
.ff  !
IsErrff! &
)ff& '
{gg 
returnhh 
Resulthh !
<hh! "
Unithh" &
,hh& '#
EcliptixProtocolFailurehh( ?
>hh? @
.hh@ A
ErrhhA D
(hhD E
msgKeyResulthhE Q
.hhQ R
	UnwrapErrhhR [
(hh[ \
)hh\ ]
)hh] ^
;hh^ _
}ii 
_skippedMessageKeyskk #
[kk# $
ikk$ %
]kk% &
=kk' (
msgKeyResultkk) 5
.kk5 6
Unwrapkk6 <
(kk< =
)kk= >
;kk> ?
Resultmm 
<mm 
Unitmm 
,mm #
EcliptixProtocolFailuremm 4
>mm4 5
advanceResultmm6 C
=mmD E
AdvanceChainKeymmF U
(mmU V
chainKeyMemorymmV d
.mmd e
AsSpanmme k
(mmk l
)mml m
)mmm n
;mmn o
ifnn 
(nn 
advanceResultnn !
.nn! "
IsErrnn" '
)nn' (
{oo 
returnpp 
Resultpp !
<pp! "
Unitpp" &
,pp& '#
EcliptixProtocolFailurepp( ?
>pp? @
.pp@ A
ErrppA D
(ppD E
advanceResultppE R
.ppR S
	UnwrapErrppS \
(pp\ ]
)pp] ^
)pp^ _
;pp_ `
}qq 
}rr 
returntt 
Resulttt 
<tt 
Unittt 
,tt #
EcliptixProtocolFailurett  7
>tt7 8
.tt8 9
Oktt9 ;
(tt; <
Unittt< @
.tt@ A
ValuettA F
)ttF G
;ttG H
}uu 	
}vv 
privatexx 
staticxx 
Resultxx 
<xx $
SodiumSecureMemoryHandlexx 2
,xx2 3#
EcliptixProtocolFailurexx4 K
>xxK L"
DeriveSecureMessageKeyxxM c
(xxc d
ReadOnlySpanxxd p
<xxp q
bytexxq u
>xxu v
chainKeyxxw 
,	xx Ä
uintyy 
messageIndexyy 
)yy 
{zz 
Result{{ 
<{{ $
SodiumSecureMemoryHandle{{ '
,{{' (
SodiumFailure{{) 6
>{{6 7
secureHandleResult{{8 J
={{K L$
SodiumSecureMemoryHandle|| $
.||$ %
Allocate||% -
(||- .
	Constants||. 7
.||7 8
X_25519_KEY_SIZE||8 H
)||H I
;||I J
if~~ 

(~~ 
secureHandleResult~~ 
.~~ 
IsErr~~ $
)~~$ %
{ 	
return
ÄÄ 
Result
ÄÄ 
<
ÄÄ &
SodiumSecureMemoryHandle
ÄÄ 2
,
ÄÄ2 3%
EcliptixProtocolFailure
ÄÄ4 K
>
ÄÄK L
.
ÄÄL M
Err
ÄÄM P
(
ÄÄP Q%
EcliptixProtocolFailure
ÅÅ '
.
ÅÅ' (
Generic
ÅÅ( /
(
ÅÅ/ 0
$"
ÅÅ0 2
$str
ÅÅ2 [
{
ÅÅ[ \
messageIndex
ÅÅ\ h
}
ÅÅh i
$str
ÅÅi j
"
ÅÅj k
)
ÅÅk l
)
ÅÅl m
;
ÅÅm n
}
ÇÇ 	&
SodiumSecureMemoryHandle
ÑÑ  
secureHandle
ÑÑ! -
=
ÑÑ. / 
secureHandleResult
ÑÑ0 B
.
ÑÑB C
Unwrap
ÑÑC I
(
ÑÑI J
)
ÑÑJ K
;
ÑÑK L
using
ÜÜ 
SecurePooledArray
ÜÜ 
<
ÜÜ  
byte
ÜÜ  $
>
ÜÜ$ %
msgKey
ÜÜ& ,
=
ÜÜ- .
SecureArrayPool
ÜÜ/ >
.
ÜÜ> ?
Rent
ÜÜ? C
<
ÜÜC D
byte
ÜÜD H
>
ÜÜH I
(
ÜÜI J
	Constants
ÜÜJ S
.
ÜÜS T
X_25519_KEY_SIZE
ÜÜT d
)
ÜÜd e
;
ÜÜe f
HKDF
àà 
.
àà 
	DeriveKey
àà 
(
àà 
HashAlgorithmName
ââ 
.
ââ 
SHA256
ââ $
,
ââ$ %
ikm
ää 
:
ää 
chainKey
ää 
,
ää 
output
ãã 
:
ãã 
msgKey
ãã 
.
ãã 
AsSpan
ãã !
(
ãã! "
)
ãã" #
,
ãã# $
salt
åå 
:
åå 
null
åå 
,
åå 
info
çç 
:
çç 
	Constants
çç 
.
çç 
MsgInfo
çç #
)
éé 	
;
éé	 

Result
êê 
<
êê 
Unit
êê 
,
êê 
SodiumFailure
êê "
>
êê" #
writeResult
êê$ /
=
êê0 1
secureHandle
êê2 >
.
êê> ?
Write
êê? D
(
êêD E
msgKey
êêE K
.
êêK L
AsSpan
êêL R
(
êêR S
)
êêS T
)
êêT U
;
êêU V
if
ëë 

(
ëë 
writeResult
ëë 
.
ëë 
IsErr
ëë 
)
ëë 
{
íí 	
secureHandle
ìì 
.
ìì 
Dispose
ìì  
(
ìì  !
)
ìì! "
;
ìì" #
return
îî 
Result
îî 
<
îî &
SodiumSecureMemoryHandle
îî 2
,
îî2 3%
EcliptixProtocolFailure
îî4 K
>
îîK L
.
îîL M
Err
îîM P
(
îîP Q
writeResult
ïï 
.
ïï 
	UnwrapErr
ïï %
(
ïï% &
)
ïï& '
.
ïï' ('
ToEcliptixProtocolFailure
ïï( A
(
ïïA B
)
ïïB C
)
ïïC D
;
ïïD E
}
ññ 	
return
òò 
Result
òò 
<
òò &
SodiumSecureMemoryHandle
òò .
,
òò. /%
EcliptixProtocolFailure
òò0 G
>
òòG H
.
òòH I
Ok
òòI K
(
òòK L
secureHandle
òòL X
)
òòX Y
;
òòY Z
}
ôô 
private
õõ 
static
õõ 
Result
õõ 
<
õõ 
Unit
õõ 
,
õõ %
EcliptixProtocolFailure
õõ  7
>
õõ7 8
AdvanceChainKey
õõ9 H
(
õõH I
Span
õõI M
<
õõM N
byte
õõN R
>
õõR S
chainKey
õõT \
)
õõ\ ]
{
úú 
using
ùù 
SecurePooledArray
ùù 
<
ùù  
byte
ùù  $
>
ùù$ %
nextChainKey
ùù& 2
=
ùù3 4
SecureArrayPool
ùù5 D
.
ùùD E
Rent
ùùE I
<
ùùI J
byte
ùùJ N
>
ùùN O
(
ùùO P
	Constants
ùùP Y
.
ùùY Z
X_25519_KEY_SIZE
ùùZ j
)
ùùj k
;
ùùk l
HKDF
üü 
.
üü 
	DeriveKey
üü 
(
üü 
HashAlgorithmName
†† 
.
†† 
SHA256
†† $
,
††$ %
ikm
°° 
:
°° 
chainKey
°° 
,
°° 
output
¢¢ 
:
¢¢ 
nextChainKey
¢¢  
.
¢¢  !
AsSpan
¢¢! '
(
¢¢' (
)
¢¢( )
,
¢¢) *
salt
££ 
:
££ 
null
££ 
,
££ 
info
§§ 
:
§§ 
	Constants
§§ 
.
§§ 
	ChainInfo
§§ %
)
•• 	
;
••	 

nextChainKey
ßß 
.
ßß 
AsSpan
ßß 
(
ßß 
)
ßß 
.
ßß 
CopyTo
ßß $
(
ßß$ %
chainKey
ßß% -
)
ßß- .
;
ßß. /
return
®® 
Result
®® 
<
®® 
Unit
®® 
,
®® %
EcliptixProtocolFailure
®® 3
>
®®3 4
.
®®4 5
Ok
®®5 7
(
®®7 8
Unit
®®8 <
.
®®< =
Value
®®= B
)
®®B C
;
®®C D
}
©© 
public
´´ 

void
´´ 
CleanupOldKeys
´´ 
(
´´ 
uint
´´ #
beforeIndex
´´$ /
)
´´/ 0
{
¨¨ 
if
≠≠ 

(
≠≠ 
	_disposed
≠≠ 
)
≠≠ 
{
ÆÆ 	
return
ØØ 
;
ØØ 
}
∞∞ 	
lock
≤≤ 
(
≤≤ 
_lock
≤≤ 
)
≤≤ 
{
≥≥ 	
List
¥¥ 
<
¥¥ 
uint
¥¥ 
>
¥¥ 
keysToRemove
¥¥ #
=
¥¥$ %!
_skippedMessageKeys
¥¥& 9
.
¥¥9 :
Keys
¥¥: >
.
¥¥> ?
Where
¥¥? D
(
¥¥D E
index
¥¥E J
=>
¥¥K M
index
¥¥N S
<
¥¥T U
beforeIndex
¥¥V a
)
¥¥a b
.
¥¥b c
ToList
¥¥c i
(
¥¥i j
)
¥¥j k
;
¥¥k l
foreach
µµ 
(
µµ 
uint
µµ 
key
µµ 
in
µµ  
keysToRemove
µµ! -
)
µµ- .
{
∂∂ 
if
∑∑ 
(
∑∑ !
_skippedMessageKeys
∑∑ '
.
∑∑' (
Remove
∑∑( .
(
∑∑. /
key
∑∑/ 2
,
∑∑2 3
out
∑∑4 7&
SodiumSecureMemoryHandle
∑∑8 P
?
∑∑P Q
removedHandle
∑∑R _
)
∑∑_ `
)
∑∑` a
{
∏∏ 
removedHandle
ππ !
.
ππ! "
Dispose
ππ" )
(
ππ) *
)
ππ* +
;
ππ+ ,
}
∫∫ 
}
ªª 
}
ºº 	
}
ΩΩ 
public
øø 

void
øø 
Dispose
øø 
(
øø 
)
øø 
{
¿¿ 
if
¡¡ 

(
¡¡ 
	_disposed
¡¡ 
)
¡¡ 
{
¬¬ 	
return
√√ 
;
√√ 
}
ƒƒ 	
lock
∆∆ 
(
∆∆ 
_lock
∆∆ 
)
∆∆ 
{
«« 	
foreach
»» 
(
»» &
SodiumSecureMemoryHandle
»» -
handle
»». 4
in
»»5 7!
_skippedMessageKeys
»»8 K
.
»»K L
Values
»»L R
)
»»R S
{
…… 
handle
   
.
   
Dispose
   
(
   
)
    
;
    !
}
ÀÀ !
_skippedMessageKeys
ÃÃ 
.
ÃÃ  
Clear
ÃÃ  %
(
ÃÃ% &
)
ÃÃ& '
;
ÃÃ' (
}
ÕÕ 	
	_disposed
œœ 
=
œœ 
true
œœ 
;
œœ 
}
–– 
}—— ¶
i/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/RatchetConfig.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
internal 
sealed	 
class 
RatchetConfig #
{ 
public 

static 
readonly 
RatchetConfig (
Default) 0
=1 2
new3 6
(6 7
)7 8
;8 9
public 

uint #
DhRatchetEveryNMessages '
{( )
get* -
;- .
init/ 3
;3 4
}5 6
=7 8
$num9 ;
;; <
public		 

bool		 #
EnablePerMessageRatchet		 '
{		( )
get		* -
;		- .
init		/ 3
;		3 4
}		5 6
=		7 8
false		9 >
;		> ?
public 

bool 
RatchetOnNewDhKey !
{" #
get$ '
;' (
init) -
;- .
}/ 0
=1 2
true3 7
;7 8
public 

TimeSpan 
MaxChainAge 
{  !
get" %
;% &
init' +
;+ ,
}- .
=/ 0#
ProtocolSystemConstants1 H
.H I
TimeoutsI Q
.Q R
DefaultMaxChainAgeR d
;d e
public 

uint %
MaxMessagesWithoutRatchet )
{* +
get, /
;/ 0
init1 5
;5 6
}7 8
=9 :
$num; ?
;? @
public 

bool 
ShouldRatchet 
( 
uint "
messageIndex# /
,/ 0
DateTime1 9
lastRatchetTime: I
,I J
boolK O
receivedNewDhKeyP `
,` a
DateTimeb j
currentTimek v
)v w
{ 
if 

( #
EnablePerMessageRatchet #
)# $
{ 	
return 
true 
; 
} 	
if 

( 
RatchetOnNewDhKey 
&&  
receivedNewDhKey! 1
)1 2
{ 	
return 
true 
; 
} 	
if 

( 
messageIndex 
> 
$num 
&& 
messageIndex  ,
%- .#
DhRatchetEveryNMessages/ F
==G I
$numJ K
)K L
{ 	
return 
true 
; 
}   	
if"" 

("" 
currentTime"" 
-"" 
lastRatchetTime"" )
>""* +
MaxChainAge"", 7
)""7 8
{## 	
return$$ 
true$$ 
;$$ 
}%% 	
if'' 

('' 
messageIndex'' 
>='' %
MaxMessagesWithoutRatchet'' 5
)''5 6
{(( 	
return)) 
true)) 
;)) 
}** 	
return,, 
false,, 
;,, 
}-- 
public// 

bool// 
ShouldRatchet// 
(// 
uint// "
messageIndex//# /
,/// 0
DateTime//1 9
lastRatchetTime//: I
,//I J
bool//K O
receivedNewDhKey//P `
)//` a
{00 
return11 
ShouldRatchet11 
(11 
messageIndex11 )
,11) *
lastRatchetTime11+ :
,11: ;
receivedNewDhKey11< L
,11L M
DateTime11N V
.11V W
UtcNow11W ]
)11] ^
;11^ _
}22 
}33 ºC
k/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/RatchetChainKey.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
internal 
	interface	 
IKeyProvider 
{ 
Result		 

<		
 
T		 
,		 #
EcliptixProtocolFailure		 %
>		% &
ExecuteWithKey		' 5
<		5 6
T		6 7
>		7 8
(		8 9
uint		9 =
keyIndex		> F
,		F G
Func		H L
<		L M
ReadOnlySpan		M Y
<		Y Z
byte		Z ^
>		^ _
,		_ `
Result		a g
<		g h
T		h i
,		i j$
EcliptixProtocolFailure			k Ç
>
		Ç É
>
		É Ñ
	operation
		Ö é
)
		é è
;
		è ê
}

 
internal 
sealed	 
class 
RatchetChainKey %
:& '

IEquatable( 2
<2 3
RatchetChainKey3 B
>B C
{ 
private 
readonly 
IKeyProvider !
_keyProvider" .
;. /
internal 
RatchetChainKey 
( 
uint !
index" '
,' (
IKeyProvider) 5
keyProvider6 A
)A B
{ 
Index 
= 
index 
; 
_keyProvider 
= 
keyProvider "
;" #
} 
public 

uint 
Index 
{ 
get 
; 
} 
public 

bool 
Equals 
( 
RatchetChainKey &
?& '
other( -
)- .
{ 
if 

( 
other 
is 
null 
) 
{ 	
return 
false 
; 
} 	
return 
Index 
== 
other 
. 
Index #
&&$ &
ReferenceEquals' 6
(6 7
_keyProvider7 C
,C D
otherE J
.J K
_keyProviderK W
)W X
;X Y
}   
public"" 

override"" 
bool"" 
Equals"" 
(""  
object""  &
?""& '
obj""( +
)""+ ,
{## 
return$$ 
obj$$ 
is$$ 
RatchetChainKey$$ %
other$$& +
&&$$, .
Equals$$/ 5
($$5 6
other$$6 ;
)$$; <
;$$< =
}%% 
public'' 

override'' 
int'' 
GetHashCode'' #
(''# $
)''$ %
{(( 
return)) 
Index)) 
.)) 
GetHashCode))  
())  !
)))! "
;))" #
}** 
public,, 

static,, 
bool,, 
operator,, 
==,,  "
(,," #
RatchetChainKey,,# 2
?,,2 3
left,,4 8
,,,8 9
RatchetChainKey,,: I
?,,I J
right,,K P
),,P Q
{-- 
if.. 

(.. 
ReferenceEquals.. 
(.. 
left..  
,..  !
right.." '
)..' (
)..( )
{// 	
return00 
true00 
;00 
}11 	
if33 

(33 
left33 
is33 
null33 
||33 
right33 !
is33" $
null33% )
)33) *
{44 	
return55 
false55 
;55 
}66 	
return88 
left88 
.88 
Equals88 
(88 
right88  
)88  !
;88! "
}99 
public;; 

static;; 
bool;; 
operator;; 
!=;;  "
(;;" #
RatchetChainKey;;# 2
?;;2 3
left;;4 8
,;;8 9
RatchetChainKey;;: I
?;;I J
right;;K P
);;P Q
{<< 
return== 
!== 
(== 
left== 
==== 
right== 
)== 
;==  
}>> 
public@@ 

static@@ 
Result@@ 
<@@ 
Unit@@ 
,@@ #
EcliptixProtocolFailure@@ 6
>@@6 7
ReadKeyMaterial@@8 G
(@@G H
RatchetChainKey@@H W
chainKey@@X `
,@@` a
Span@@b f
<@@f g
byte@@g k
>@@k l
destination@@m x
)@@x y
{AA 
ifBB 

(BB 
destinationBB 
.BB 
LengthBB 
<BB  
	ConstantsBB! *
.BB* +
X_25519_KEY_SIZEBB+ ;
)BB; <
{CC 	
returnDD 
ResultDD 
<DD 
UnitDD 
,DD #
EcliptixProtocolFailureDD  7
>DD7 8
.DD8 9
ErrDD9 <
(DD< =#
EcliptixProtocolFailureEE '
.EE' (
BUFFER_TOO_SMALLEE( 8
(EE8 9
$"FF 
$strFF :
{FF: ;
	ConstantsFF; D
.FFD E
X_25519_KEY_SIZEFFE U
}FFU V
$strFFV f
{FFf g
destinationFFg r
.FFr s
LengthFFs y
}FFy z
$strFFz {
"FF{ |
)FF| }
)FF} ~
;FF~ 
}GG 	
byteII 
[II 
]II 
bufferII 
=II 
	ArrayPoolII !
<II! "
byteII" &
>II& '
.II' (
SharedII( .
.II. /
RentII/ 3
(II3 4
	ConstantsII4 =
.II= >
X_25519_KEY_SIZEII> N
)IIN O
;IIO P
tryJJ 
{KK 	
ResultLL 
<LL 
UnitLL 
,LL #
EcliptixProtocolFailureLL 0
>LL0 1
resultLL2 8
=LL9 :
chainKeyLL; C
.LLC D
WithKeyMaterialLLD S
<LLS T
UnitLLT X
>LLX Y
(LLY Z
keyMaterialLLZ e
=>LLf h
{MM 
keyMaterialNN 
[NN 
..NN 
	ConstantsNN '
.NN' (
X_25519_KEY_SIZENN( 8
]NN8 9
.NN9 :
CopyToNN: @
(NN@ A
bufferNNA G
)NNG H
;NNH I
returnOO 
ResultOO 
<OO 
UnitOO "
,OO" ##
EcliptixProtocolFailureOO$ ;
>OO; <
.OO< =
OkOO= ?
(OO? @
UnitOO@ D
.OOD E
ValueOOE J
)OOJ K
;OOK L
}PP 
)PP 
;PP 
ifRR 
(RR 
resultRR 
.RR 
IsOkRR 
)RR 
{SS 
bufferTT 
.TT 
AsSpanTT 
(TT 
$numTT 
,TT  
	ConstantsTT! *
.TT* +
X_25519_KEY_SIZETT+ ;
)TT; <
.TT< =
CopyToTT= C
(TTC D
destinationTTD O
)TTO P
;TTP Q
}UU 
returnWW 
resultWW 
;WW 
}XX 	
finallyYY 
{ZZ 	
Array[[ 
.[[ 
Clear[[ 
([[ 
buffer[[ 
,[[ 
$num[[  !
,[[! "
	Constants[[# ,
.[[, -
X_25519_KEY_SIZE[[- =
)[[= >
;[[> ?
	ArrayPool\\ 
<\\ 
byte\\ 
>\\ 
.\\ 
Shared\\ "
.\\" #
Return\\# )
(\\) *
buffer\\* 0
)\\0 1
;\\1 2
}]] 	
}^^ 
private`` 
Result`` 
<`` 
T`` 
,`` #
EcliptixProtocolFailure`` -
>``- .
WithKeyMaterial``/ >
<``> ?
T``? @
>``@ A
(``A B
Func``B F
<``F G
ReadOnlySpan``G S
<``S T
byte``T X
>``X Y
,``Y Z
Result``[ a
<``a b
T``b c
,``c d#
EcliptixProtocolFailure``e |
>``| }
>``} ~
	operation	`` à
)
``à â
{aa 
returnbb 
_keyProviderbb 
.bb 
ExecuteWithKeybb *
(bb* +
Indexbb+ 0
,bb0 1
	operationbb2 ;
)bb; <
;bb< =
}cc 
}dd ›∑
k/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/PublicKeyBundle.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
internal		 
record			  
LocalPublicKeyBundle		 $
(		$ %
byte

 
[

 	
]

	 

IdentityEd25519

 
,

 
byte 
[ 	
]	 

IdentityX25519 
, 
uint 
SignedPreKeyId	 
, 
byte 
[ 	
]	 

SignedPreKeyPublic 
, 
byte 
[ 	
]	 
!
SignedPreKeySignature  
,  !
IReadOnlyList 
< 
OneTimePreKeyRecord %
>% &
OneTimePreKeys' 5
,5 6
byte 
[ 	
]	 

?
 
EphemeralX25519 
) 
{ 
private  
LocalPublicKeyBundle  
(  !
InternalBundleData! 3
data4 8
)8 9
:: ;
this< @
(@ A
data 
. 
IdentityEd25519 
, 
data 
. 
IdentityX25519 
, 
data 
. 
SignedPreKeyId 
, 
data 
. 
SignedPreKeyPublic 
,  
data 
. !
SignedPreKeySignature "
," #
data 
. 
OneTimePreKeys 
, 
data 
. 
EphemeralX25519 
) 
{ 
} 
public 

PublicKeyBundle 
ToProtobufExchange -
(- .
). /
{ 
PublicKeyBundle   
proto   
=   
new    #
(  # $
)  $ %
{!! 	
IdentityPublicKey"" 
="" 

ByteString""  *
.""* +
CopyFrom""+ 3
(""3 4
IdentityEd25519""4 C
)""C D
,""D E#
IdentityX25519PublicKey## #
=##$ %

ByteString##& 0
.##0 1
CopyFrom##1 9
(##9 :
IdentityX25519##: H
)##H I
,##I J
SignedPreKeyId$$ 
=$$ 
SignedPreKeyId$$ +
,$$+ ,!
SignedPreKeyPublicKey%% !
=%%" #

ByteString%%$ .
.%%. /
CopyFrom%%/ 7
(%%7 8
SignedPreKeyPublic%%8 J
)%%J K
,%%K L!
SignedPreKeySignature&& !
=&&" #

ByteString&&$ .
.&&. /
CopyFrom&&/ 7
(&&7 8!
SignedPreKeySignature&&8 M
)&&M N
}'' 	
;''	 

if)) 

()) 
EphemeralX25519)) 
!=)) 
null)) #
)))# $
{** 	
proto++ 
.++ $
EphemeralX25519PublicKey++ *
=+++ ,

ByteString++- 7
.++7 8
CopyFrom++8 @
(++@ A
EphemeralX25519++A P
)++P Q
;++Q R
},, 	
foreach.. 
(.. 
OneTimePreKeyRecord.. $
	opkRecord..% .
in../ 1
OneTimePreKeys..2 @
)..@ A
{// 	
proto00 
.00 
OneTimePreKeys00  
.00  !
Add00! $
(00$ %
new00% (
PublicKeyBundle00) 8
.008 9
Types009 >
.00> ?
OneTimePreKey00? L
{11 
PreKeyId22 
=22 
	opkRecord22 $
.22$ %
PreKeyId22% -
,22- .
	PublicKey33 
=33 

ByteString33 &
.33& '
CopyFrom33' /
(33/ 0
	opkRecord330 9
.339 :
	PublicKey33: C
)33C D
}44 
)44 
;44 
}55 	
return77 
proto77 
;77 
}88 
public:: 

static:: 
Result:: 
<::  
LocalPublicKeyBundle:: -
,::- .#
EcliptixProtocolFailure::/ F
>::F G 
FromProtobufExchange::H \
(::\ ]
PublicKeyBundle;; 
?;; 
proto;; 
);; 
{<< 
if== 

(== 
proto== 
==== 
null== 
)== 
{>> 	
return?? 
Result?? 
<??  
LocalPublicKeyBundle?? .
,??. /#
EcliptixProtocolFailure??0 G
>??G H
.??H I
Err??I L
(??L M#
EcliptixProtocolFailure@@ '
.@@' (
InvalidInput@@( 4
(@@4 5+
EcliptixProtocolFailureMessages@@5 T
.@@T U
PublicKeyBundle@@U d
.@@d e1
$INPUT_PROTOBUF_BUNDLE_CANNOT_BE_NULL	@@e â
)
@@â ä
)
@@ä ã
;
@@ã å
}AA 	
returnCC 
ResultCC 
<CC  
LocalPublicKeyBundleCC *
,CC* +#
EcliptixProtocolFailureCC, C
>CCC D
.CCD E
TryCCE H
(CCH I
(DD 
)DD 
=>DD 
{EE 
byteFF 
[FF 
]FF 
identityEd25519FF &
=FF' (-
!ExtractAndValidateIdentityEd25519FF) J
(FFJ K
protoFFK P
)FFP Q
;FFQ R
byteGG 
[GG 
]GG 
identityX25519GG %
=GG& ',
 ExtractAndValidateIdentityX25519GG( H
(GGH I
protoGGI N
)GGN O
;GGO P
byteHH 
[HH 
]HH 
signedPreKeyPublicHH )
=HH* +*
ExtractAndValidateSignedPreKeyHH, J
(HHJ K
protoHHK P
)HHP Q
;HHQ R
byteII 
[II 
]II !
signedPreKeySignatureII ,
=II- .'
ExtractAndValidateSignatureII/ J
(IIJ K
protoIIK P
)IIP Q
;IIQ R
byteJJ 
[JJ 
]JJ 
?JJ 
ephemeralX25519JJ '
=JJ( )'
ExtractAndValidateEphemeralJJ* E
(JJE F
protoJJF K
)JJK L
;JJL M
ListKK 
<KK 
OneTimePreKeyRecordKK (
>KK( )

opkRecordsKK* 4
=KK5 6,
 ExtractAndValidateOneTimePreKeysKK7 W
(KKW X
protoKKX ]
)KK] ^
;KK^ _
InternalBundleDataMM "
internalDataMM# /
=MM0 1
newMM2 5
(MM5 6
)MM6 7
{NN 
IdentityEd25519OO #
=OO$ %
identityEd25519OO& 5
,OO5 6
IdentityX25519PP "
=PP# $
identityX25519PP% 3
,PP3 4
SignedPreKeyIdQQ "
=QQ# $
protoQQ% *
.QQ* +
SignedPreKeyIdQQ+ 9
,QQ9 :
SignedPreKeyPublicRR &
=RR' (
signedPreKeyPublicRR) ;
,RR; <!
SignedPreKeySignatureSS )
=SS* +!
signedPreKeySignatureSS, A
,SSA B
OneTimePreKeysTT "
=TT# $

opkRecordsTT% /
,TT/ 0
EphemeralX25519UU #
=UU$ %
ephemeralX25519UU& 5
}VV 
;VV 
returnWW 
newWW  
LocalPublicKeyBundleWW /
(WW/ 0
internalDataWW0 <
)WW< =
;WW= >
}XX 
,XX 
exYY 
=>YY 
exYY 
switchYY 
{ZZ 
ArgumentException[[ !
argEx[[" '
=>[[( *#
EcliptixProtocolFailure[[+ B
.[[B C
Decode[[C I
([[I J
string\\ 
.\\ 
Format\\ !
(\\! "+
EcliptixProtocolFailureMessages\\" A
.\\A B
PublicKeyBundle\\B Q
.\\Q R7
+FAILED_TO_CREATE_FROM_PROTOBUF_INVALID_DATA\\R }
,\\} ~
argEx	\\ Ñ
.
\\Ñ Ö
Message
\\Ö å
)
\\å ç
,
\\ç é
argEx
\\è î
)
\\î ï
,
\\ï ñ
_]] 
=>]] #
EcliptixProtocolFailure]] ,
.]], -
Decode]]- 3
(]]3 4
string^^ 
.^^ 
Format^^ !
(^^! "+
EcliptixProtocolFailureMessages^^" A
.^^A B
PublicKeyBundle^^B Q
.^^Q R3
'UNEXPECTED_ERROR_CREATING_FROM_PROTOBUF^^R y
,^^y z
ex^^{ }
.^^} ~
Message	^^~ Ö
)
^^Ö Ü
,
^^Ü á
ex__ 
)__ 
}`` 
)aa 	
;aa	 

}bb 
privatedd 
staticdd 
bytedd 
[dd 
]dd -
!ExtractAndValidateIdentityEd25519dd ;
(dd; <
PublicKeyBundledd< K
protoddL Q
)ddQ R
{ee #
SecureByteStringInteropff 
.ff  !
SecureCopyWithCleanupff  5
(ff5 6
protoff6 ;
.ff; <
IdentityPublicKeyff< M
,ffM N
outffO R
byteffS W
[ffW X
]ffX Y
identityEd25519ffZ i
)ffi j
;ffj k
ifhh 

(hh 
identityEd25519hh 
.hh 
Lengthhh "
!=hh# %
	Constantshh& /
.hh/ 0
ED_25519_KEY_SIZEhh0 A
)hhA B
{ii 	
throwjj 
newjj 
ArgumentExceptionjj '
(jj' (
stringjj( .
.jj. /
Formatjj/ 5
(jj5 6+
EcliptixProtocolFailureMessagesjj6 U
.jjU V
PublicKeyBundlejjV e
.jje f+
IDENTITY_ED_25519_INVALID_SIZE	jjf Ñ
,
jjÑ Ö
	Constants
jjÜ è
.
jjè ê
ED_25519_KEY_SIZE
jjê °
)
jj° ¢
)
jj¢ £
;
jj£ §
}kk 	
returnmm 
identityEd25519mm 
;mm 
}nn 
privatepp 
staticpp 
bytepp 
[pp 
]pp ,
 ExtractAndValidateIdentityX25519pp :
(pp: ;
PublicKeyBundlepp; J
protoppK P
)ppP Q
{qq #
SecureByteStringInteroprr 
.rr  !
SecureCopyWithCleanuprr  5
(rr5 6
protorr6 ;
.rr; <#
IdentityX25519PublicKeyrr< S
,rrS T
outrrU X
byterrY ]
[rr] ^
]rr^ _
identityX25519rr` n
)rrn o
;rro p
iftt 

(tt 
identityX25519tt 
.tt 
Lengthtt !
!=tt" $
	Constantstt% .
.tt. /
X_25519_KEY_SIZEtt/ ?
)tt? @
{uu 	
throwvv 
newvv 
ArgumentExceptionvv '
(vv' (
stringvv( .
.vv. /
Formatvv/ 5
(vv5 6+
EcliptixProtocolFailureMessagesvv6 U
.vvU V
PublicKeyBundlevvV e
.vve f*
IDENTITY_X_25519_INVALID_SIZE	vvf É
,
vvÉ Ñ
	Constants
vvÖ é
.
vvé è
X_25519_KEY_SIZE
vvè ü
)
vvü †
)
vv† °
;
vv° ¢
}ww 	
Resultyy 
<yy 
Unityy 
,yy #
EcliptixProtocolFailureyy ,
>yy, -
validationResultyy. >
=yy? @
DhValidatoryyA L
.yyL M#
ValidateX25519PublicKeyyyM d
(yyd e
identityX25519yye s
)yys t
;yyt u
ifzz 

(zz 
validationResultzz 
.zz 
IsErrzz "
)zz" #
{{{ 	
throw|| 
new|| 
ArgumentException|| '
(||' (
string||( .
.||. /
Format||/ 5
(||5 6+
EcliptixProtocolFailureMessages||6 U
.||U V
PublicKeyBundle||V e
.||e f)
INVALID_IDENTITY_X_25519_KEY	||f Ç
,
||Ç É
validationResult
||Ñ î
.
||î ï
	UnwrapErr
||ï û
(
||û ü
)
||ü †
.
||† °
Message
||° ®
)
||® ©
)
||© ™
;
||™ ´
}}} 	
return 
identityX25519 
; 
}
ÄÄ 
private
ÇÇ 
static
ÇÇ 
byte
ÇÇ 
[
ÇÇ 
]
ÇÇ ,
ExtractAndValidateSignedPreKey
ÇÇ 8
(
ÇÇ8 9
PublicKeyBundle
ÇÇ9 H
proto
ÇÇI N
)
ÇÇN O
{
ÉÉ %
SecureByteStringInterop
ÑÑ 
.
ÑÑ  #
SecureCopyWithCleanup
ÑÑ  5
(
ÑÑ5 6
proto
ÑÑ6 ;
.
ÑÑ; <#
SignedPreKeyPublicKey
ÑÑ< Q
,
ÑÑQ R
out
ÑÑS V
byte
ÑÑW [
[
ÑÑ[ \
]
ÑÑ\ ] 
signedPreKeyPublic
ÑÑ^ p
)
ÑÑp q
;
ÑÑq r
if
ÜÜ 

(
ÜÜ  
signedPreKeyPublic
ÜÜ 
.
ÜÜ 
Length
ÜÜ %
!=
ÜÜ& (
	Constants
ÜÜ) 2
.
ÜÜ2 3
X_25519_KEY_SIZE
ÜÜ3 C
)
ÜÜC D
{
áá 	
throw
àà 
new
àà 
ArgumentException
àà '
(
àà' (
string
àà( .
.
àà. /
Format
àà/ 5
(
àà5 6-
EcliptixProtocolFailureMessages
àà6 U
.
ààU V
PublicKeyBundle
ààV e
.
ààe f1
"SIGNED_PRE_KEY_PUBLIC_INVALID_SIZEààf à
,ààà â
	Constantsààä ì
.ààì î 
X_25519_KEY_SIZEààî §
)àà§ •
)àà• ¶
;àà¶ ß
}
ââ 	
Result
ãã 
<
ãã 
Unit
ãã 
,
ãã %
EcliptixProtocolFailure
ãã ,
>
ãã, -
validationResult
ãã. >
=
ãã? @
DhValidator
ããA L
.
ããL M%
ValidateX25519PublicKey
ããM d
(
ããd e 
signedPreKeyPublic
ããe w
)
ããw x
;
ããx y
if
åå 

(
åå 
validationResult
åå 
.
åå 
IsErr
åå "
)
åå" #
{
çç 	
throw
éé 
new
éé 
ArgumentException
éé '
(
éé' (
string
éé( .
.
éé. /
Format
éé/ 5
(
éé5 6-
EcliptixProtocolFailureMessages
éé6 U
.
ééU V
PublicKeyBundle
ééV e
.
éée f0
!INVALID_SIGNED_PRE_KEY_PUBLIC_KEYééf á
,ééá à 
validationResultééâ ô
.ééô ö
	UnwrapErrééö £
(éé£ §
)éé§ •
.éé• ¶
Messageéé¶ ≠
)éé≠ Æ
)ééÆ Ø
;ééØ ∞
}
èè 	
return
ëë  
signedPreKeyPublic
ëë !
;
ëë! "
}
íí 
private
îî 
static
îî 
byte
îî 
[
îî 
]
îî )
ExtractAndValidateSignature
îî 5
(
îî5 6
PublicKeyBundle
îî6 E
proto
îîF K
)
îîK L
{
ïï %
SecureByteStringInterop
ññ 
.
ññ  #
SecureCopyWithCleanup
ññ  5
(
ññ5 6
proto
ññ6 ;
.
ññ; <#
SignedPreKeySignature
ññ< Q
,
ññQ R
out
ññS V
byte
ññW [
[
ññ[ \
]
ññ\ ]#
signedPreKeySignature
ññ^ s
)
ññs t
;
ññt u
if
òò 

(
òò #
signedPreKeySignature
òò !
.
òò! "
Length
òò" (
!=
òò) +
	Constants
òò, 5
.
òò5 6%
ED_25519_SIGNATURE_SIZE
òò6 M
)
òòM N
{
ôô 	
throw
öö 
new
öö 
ArgumentException
öö '
(
öö' (
string
öö( .
.
öö. /
Format
öö/ 5
(
öö5 6-
EcliptixProtocolFailureMessages
öö6 U
.
ööU V
PublicKeyBundle
ööV e
.
ööe f4
%SIGNED_PRE_KEY_SIGNATURE_INVALID_SIZEööf ã
,ööã å
	Constantsööç ñ
.ööñ ó'
ED_25519_SIGNATURE_SIZEööó Æ
)ööÆ Ø
)ööØ ∞
;öö∞ ±
}
õõ 	
return
ùù #
signedPreKeySignature
ùù $
;
ùù$ %
}
ûû 
private
†† 
static
†† 
byte
†† 
[
†† 
]
†† 
?
†† )
ExtractAndValidateEphemeral
†† 6
(
††6 7
PublicKeyBundle
††7 F
proto
††G L
)
††L M
{
°° 
if
¢¢ 

(
¢¢ 
proto
¢¢ 
.
¢¢ &
EphemeralX25519PublicKey
¢¢ *
.
¢¢* +
IsEmpty
¢¢+ 2
)
¢¢2 3
{
££ 	
return
§§ 
null
§§ 
;
§§ 
}
•• 	%
SecureByteStringInterop
ßß 
.
ßß  #
SecureCopyWithCleanup
ßß  5
(
ßß5 6
proto
ßß6 ;
.
ßß; <&
EphemeralX25519PublicKey
ßß< T
,
ßßT U
out
ßßV Y
byte
ßßZ ^
[
ßß^ _
]
ßß_ `
ephemeralX25519
ßßa p
)
ßßp q
;
ßßq r
if
©© 

(
©© 
ephemeralX25519
©© 
.
©© 
Length
©© "
!=
©©# %
	Constants
©©& /
.
©©/ 0
X_25519_KEY_SIZE
©©0 @
)
©©@ A
{
™™ 	
throw
´´ 
new
´´ 
ArgumentException
´´ '
(
´´' (
string
´´( .
.
´´. /
Format
´´/ 5
(
´´5 6-
EcliptixProtocolFailureMessages
´´6 U
.
´´U V
PublicKeyBundle
´´V e
.
´´e f-
EPHEMERAL_X_25519_INVALID_SIZE´´f Ñ
,´´Ñ Ö
	Constants´´Ü è
.´´è ê 
X_25519_KEY_SIZE´´ê †
)´´† °
)´´° ¢
;´´¢ £
}
¨¨ 	
Result
ÆÆ 
<
ÆÆ 
Unit
ÆÆ 
,
ÆÆ %
EcliptixProtocolFailure
ÆÆ ,
>
ÆÆ, -
validationResult
ÆÆ. >
=
ÆÆ? @
DhValidator
ÆÆA L
.
ÆÆL M%
ValidateX25519PublicKey
ÆÆM d
(
ÆÆd e
ephemeralX25519
ÆÆe t
)
ÆÆt u
;
ÆÆu v
if
ØØ 

(
ØØ 
validationResult
ØØ 
.
ØØ 
IsErr
ØØ "
)
ØØ" #
{
∞∞ 	
throw
±± 
new
±± 
ArgumentException
±± '
(
±±' (
string
±±( .
.
±±. /
Format
±±/ 5
(
±±5 6-
EcliptixProtocolFailureMessages
±±6 U
.
±±U V
PublicKeyBundle
±±V e
.
±±e f,
INVALID_EPHEMERAL_X_25519_KEY±±f É
,±±É Ñ 
validationResult±±Ö ï
.±±ï ñ
	UnwrapErr±±ñ ü
(±±ü †
)±±† °
.±±° ¢
Message±±¢ ©
)±±© ™
)±±™ ´
;±±´ ¨
}
≤≤ 	
return
¥¥ 
ephemeralX25519
¥¥ 
;
¥¥ 
}
µµ 
private
∑∑ 
static
∑∑ 
List
∑∑ 
<
∑∑ !
OneTimePreKeyRecord
∑∑ +
>
∑∑+ ,.
 ExtractAndValidateOneTimePreKeys
∑∑- M
(
∑∑M N
PublicKeyBundle
∑∑N ]
proto
∑∑^ c
)
∑∑c d
{
∏∏ 
List
ππ 
<
ππ !
OneTimePreKeyRecord
ππ  
>
ππ  !

opkRecords
ππ" ,
=
ππ- .
new
ππ/ 2
(
ππ2 3
proto
ππ3 8
.
ππ8 9
OneTimePreKeys
ππ9 G
.
ππG H
Count
ππH M
)
ππM N
;
ππN O
foreach
ªª 
(
ªª 
PublicKeyBundle
ªª  
.
ªª  !
Types
ªª! &
.
ªª& '
OneTimePreKey
ªª' 4
pOpk
ªª5 9
in
ªª: <
proto
ªª= B
.
ªªB C
OneTimePreKeys
ªªC Q
)
ªªQ R
{
ºº 	%
SecureByteStringInterop
ΩΩ #
.
ΩΩ# $#
SecureCopyWithCleanup
ΩΩ$ 9
(
ΩΩ9 :
pOpk
ΩΩ: >
.
ΩΩ> ?
	PublicKey
ΩΩ? H
,
ΩΩH I
out
ΩΩJ M
byte
ΩΩN R
[
ΩΩR S
]
ΩΩS T
opkPublicKey
ΩΩU a
)
ΩΩa b
;
ΩΩb c
Result
ææ 
<
ææ !
OneTimePreKeyRecord
ææ &
,
ææ& '%
EcliptixProtocolFailure
ææ( ?
>
ææ? @
	opkResult
ææA J
=
ææK L!
OneTimePreKeyRecord
øø #
.
øø# $
Create
øø$ *
(
øø* +
pOpk
øø+ /
.
øø/ 0
PreKeyId
øø0 8
,
øø8 9
opkPublicKey
øø: F
)
øøF G
;
øøG H
if
¡¡ 
(
¡¡ 
	opkResult
¡¡ 
.
¡¡ 
IsErr
¡¡ 
)
¡¡  
{
¬¬ 
throw
√√ 
new
√√ 
ArgumentException
√√ +
(
√√+ ,
string
√√, 2
.
√√2 3
Format
√√3 9
(
√√9 :-
EcliptixProtocolFailureMessages
√√: Y
.
√√Y Z
PublicKeyBundle
√√Z i
.
√√i j'
INVALID_ONE_TIME_PRE_KEY√√j Ç
,√√Ç É
pOpk√√Ñ à
.√√à â
PreKeyId√√â ë
,√√ë í
	opkResult√√ì ú
.√√ú ù
	UnwrapErr√√ù ¶
(√√¶ ß
)√√ß ®
.√√® ©
Message√√© ∞
)√√∞ ±
)√√± ≤
;√√≤ ≥
}
ƒƒ 

opkRecords
∆∆ 
.
∆∆ 
Add
∆∆ 
(
∆∆ 
	opkResult
∆∆ $
.
∆∆$ %
Unwrap
∆∆% +
(
∆∆+ ,
)
∆∆, -
)
∆∆- .
;
∆∆. /
}
«« 	
return
…… 

opkRecords
…… 
;
…… 
}
   
private
ÃÃ 
readonly
ÃÃ 
struct
ÃÃ  
InternalBundleData
ÃÃ .
{
ÕÕ 
public
ŒŒ 
required
ŒŒ 
byte
ŒŒ 
[
ŒŒ 
]
ŒŒ 
IdentityEd25519
ŒŒ .
{
ŒŒ/ 0
get
ŒŒ1 4
;
ŒŒ4 5
init
ŒŒ6 :
;
ŒŒ: ;
}
ŒŒ< =
public
œœ 
required
œœ 
byte
œœ 
[
œœ 
]
œœ 
IdentityX25519
œœ -
{
œœ. /
get
œœ0 3
;
œœ3 4
init
œœ5 9
;
œœ9 :
}
œœ; <
public
–– 
required
–– 
uint
–– 
SignedPreKeyId
–– +
{
––, -
get
––. 1
;
––1 2
init
––3 7
;
––7 8
}
––9 :
public
—— 
required
—— 
byte
—— 
[
—— 
]
——  
SignedPreKeyPublic
—— 1
{
——2 3
get
——4 7
;
——7 8
init
——9 =
;
——= >
}
——? @
public
““ 
required
““ 
byte
““ 
[
““ 
]
““ #
SignedPreKeySignature
““ 4
{
““5 6
get
““7 :
;
““: ;
init
““< @
;
““@ A
}
““B C
public
”” 
required
”” 
List
”” 
<
”” !
OneTimePreKeyRecord
”” 0
>
””0 1
OneTimePreKeys
””2 @
{
””A B
get
””C F
;
””F G
init
””H L
;
””L M
}
””N O
public
‘‘ 
required
‘‘ 
byte
‘‘ 
[
‘‘ 
]
‘‘ 
?
‘‘ 
EphemeralX25519
‘‘  /
{
‘‘0 1
get
‘‘2 5
;
‘‘5 6
init
‘‘7 ;
;
‘‘; <
}
‘‘= >
}
’’ 
}÷÷ “
o/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/OneTimePreKeyRecord.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
internal 
record	 
OneTimePreKeyRecord #
(# $
uint$ (
PreKeyId) 1
,1 2
byte3 7
[7 8
]8 9
	PublicKey: C
)C D
{ 
public 

static 
Result 
< 
OneTimePreKeyRecord ,
,, -#
EcliptixProtocolFailure. E
>E F
CreateG M
(M N
uintN R
preKeyIdS [
,[ \
byte] a
[a b
]b c
	publicKeyd m
)m n
{		 
if

 

(

 
	publicKey

 
.

 
Length

 
!=

 
	Constants

  )
.

) *
ED_25519_KEY_SIZE

* ;
)

; <
{ 	
return 
Result 
< 
OneTimePreKeyRecord -
,- .#
EcliptixProtocolFailure/ F
>F G
.G H
ErrH K
(K L#
EcliptixProtocolFailure '
.' (
Decode( .
(. /
$" 
$str 9
{9 :
	Constants: C
.C D
ED_25519_KEY_SIZED U
}U V
$strV ]
"] ^
)^ _
)_ `
;` a
} 	
return 
Result 
< 
OneTimePreKeyRecord )
,) *#
EcliptixProtocolFailure+ B
>B C
.C D
OkD F
(F G
newG J
OneTimePreKeyRecordK ^
(^ _
preKeyId_ g
,g h
	publicKeyi r
)r s
)s t
;t u
} 
} Å`
n/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/OneTimePreKeyLocal.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
public		 
readonly		 
struct		 
OneTimePreKeyLocal		 )
:		* +
IDisposable		, 7
{

 
private 
readonly 
byte 
[ 
] 

_publicKey &
;& '
public 

uint 
PreKeyId 
{ 
get 
; 
}  !
internal $
SodiumSecureMemoryHandle %
PrivateKeyHandle& 6
{7 8
get9 <
;< =
}> ?
public 

ReadOnlySpan 
< 
byte 
> 
PublicKeySpan +
=>, .

_publicKey/ 9
;9 :
public 

byte 
[ 
] 
GetPublicKeyCopy "
(" #
)# $
=>% '
(( )
byte) -
[- .
]. /
)/ 0

_publicKey0 :
.: ;
Clone; @
(@ A
)A B
;B C
private 
OneTimePreKeyLocal 
( 
uint #
preKeyId$ ,
,, -$
SodiumSecureMemoryHandle. F
privateKeyHandleG W
,W X
byteY ]
[] ^
]^ _
	publicKey` i
)i j
{ 
PreKeyId 
= 
preKeyId 
; 
PrivateKeyHandle 
= 
privateKeyHandle +
;+ ,

_publicKey 
= 
	publicKey 
; 
} 
public 

static 
OneTimePreKeyLocal $
CreateFromParts% 4
(4 5
uint5 9
preKeyId: B
,B C$
SodiumSecureMemoryHandleD \
privateKeyHandle] m
,m n
byte 
[ 
] 
	publicKey 
) 
{ 
return 
new 
OneTimePreKeyLocal %
(% &
preKeyId& .
,. /
privateKeyHandle0 @
,@ A
	publicKeyB K
)K L
;L M
} 
public!! 

static!! 
Result!! 
<!! 
OneTimePreKeyLocal!! +
,!!+ ,#
EcliptixProtocolFailure!!- D
>!!D E
Generate!!F N
(!!N O
uint!!O S
preKeyId!!T \
)!!\ ]
{"" $
SodiumSecureMemoryHandle##  
?##  !
securePrivateKey##" 2
=##3 4
null##5 9
;##9 :
byte$$ 
[$$ 
]$$ 
?$$ 
tempPrivateKeyBytes$$ #
=$$$ %
null$$& *
;$$* +
byte%% 
[%% 
]%% 
?%% 
tempPrivKeyCopy%% 
=%%  !
null%%" &
;%%& '
try'' 
{(( 	
Result)) 
<)) $
SodiumSecureMemoryHandle)) +
,))+ ,#
EcliptixProtocolFailure))- D
>))D E
allocResult))F Q
=))R S$
SodiumSecureMemoryHandle** (
.**( )
Allocate**) 1
(**1 2
	Constants**2 ;
.**; <$
X_25519_PRIVATE_KEY_SIZE**< T
)**T U
.++ 
MapSodiumFailure++ %
(++% &
)++& '
;++' (
if-- 
(-- 
allocResult-- 
.-- 
IsErr-- !
)--! "
{.. 
return// 
Result// 
<// 
OneTimePreKeyLocal// 0
,//0 1#
EcliptixProtocolFailure//2 I
>//I J
.//J K
Err//K N
(//N O
allocResult//O Z
.//Z [
	UnwrapErr//[ d
(//d e
)//e f
)//f g
;//g h
}00 
securePrivateKey22 
=22 
allocResult22 *
.22* +
Unwrap22+ 1
(221 2
)222 3
;223 4
tempPrivateKeyBytes44 
=44  !

SodiumCore44" ,
.44, -
GetRandomBytes44- ;
(44; <
	Constants44< E
.44E F$
X_25519_PRIVATE_KEY_SIZE44F ^
)44^ _
;44_ `
Result66 
<66 
Unit66 
,66 #
EcliptixProtocolFailure66 0
>660 1
writeResult662 =
=66> ?
securePrivateKey77  
.77  !
Write77! &
(77& '
tempPrivateKeyBytes77' :
)77: ;
.77; <
MapSodiumFailure77< L
(77L M
)77M N
;77N O
if88 
(88 
writeResult88 
.88 
IsErr88 !
)88! "
{99 
securePrivateKey::  
.::  !
Dispose::! (
(::( )
)::) *
;::* +
SodiumInterop;; 
.;; 

SecureWipe;; (
(;;( )
tempPrivateKeyBytes;;) <
);;< =
;;;= >
return<< 
Result<< 
<<< 
OneTimePreKeyLocal<< 0
,<<0 1#
EcliptixProtocolFailure<<2 I
><<I J
.<<J K
Err<<K N
(<<N O
writeResult<<O Z
.<<Z [
	UnwrapErr<<[ d
(<<d e
)<<e f
)<<f g
;<<g h
}== 
SodiumInterop?? 
.?? 

SecureWipe?? $
(??$ %
tempPrivateKeyBytes??% 8
)??8 9
;??9 :
tempPrivateKeyBytes@@ 
=@@  !
null@@" &
;@@& '
tempPrivKeyCopyBB 
=BB 
newBB !
byteBB" &
[BB& '
	ConstantsBB' 0
.BB0 1$
X_25519_PRIVATE_KEY_SIZEBB1 I
]BBI J
;BBJ K
ResultCC 
<CC 
UnitCC 
,CC #
EcliptixProtocolFailureCC 0
>CC0 1

readResultCC2 <
=CC= >
securePrivateKeyCC? O
.CCO P
ReadCCP T
(CCT U
tempPrivKeyCopyCCU d
)CCd e
.DD 
MapSodiumFailureDD !
(DD! "
)DD" #
;DD# $
ifEE 
(EE 

readResultEE 
.EE 
IsErrEE  
)EE  !
{FF 
securePrivateKeyGG  
.GG  !
DisposeGG! (
(GG( )
)GG) *
;GG* +
SodiumInteropHH 
.HH 

SecureWipeHH (
(HH( )
tempPrivKeyCopyHH) 8
)HH8 9
;HH9 :
returnII 
ResultII 
<II 
OneTimePreKeyLocalII 0
,II0 1#
EcliptixProtocolFailureII2 I
>III J
.IIJ K
ErrIIK N
(IIN O

readResultIIO Y
.IIY Z
	UnwrapErrIIZ c
(IIc d
)IId e
)IIe f
;IIf g
}JJ 
ResultLL 
<LL 
byteLL 
[LL 
]LL 
,LL #
EcliptixProtocolFailureLL 2
>LL2 3
deriveResultLL4 @
=LLA B
ResultLLC I
<LLI J
byteLLJ N
[LLN O
]LLO P
,LLP Q#
EcliptixProtocolFailureLLR i
>LLi j
.LLj k
TryLLk n
(LLn o
(MM 
)MM 
=>MM 

ScalarMultMM  
.MM  !
BaseMM! %
(MM% &
tempPrivKeyCopyMM& 5
)MM5 6
,MM6 7
exNN 
=>NN #
EcliptixProtocolFailureOO +
.OO+ ,
	DeriveKeyOO, 5
(OO5 6
$"PP 
$strPP A
{PPA B
preKeyIdPPB J
}PPJ K
$strPPK b
"PPb c
,PPc d
exQQ 
)QQ 
)RR 
;RR 
SodiumInteropTT 
.TT 

SecureWipeTT $
(TT$ %
tempPrivKeyCopyTT% 4
)TT4 5
;TT5 6
tempPrivKeyCopyUU 
=UU 
nullUU "
;UU" #
ifWW 
(WW 
deriveResultWW 
.WW 
IsErrWW "
)WW" #
{XX 
securePrivateKeyYY  
.YY  !
DisposeYY! (
(YY( )
)YY) *
;YY* +
returnZZ 
ResultZZ 
<ZZ 
OneTimePreKeyLocalZZ 0
,ZZ0 1#
EcliptixProtocolFailureZZ2 I
>ZZI J
.ZZJ K
ErrZZK N
(ZZN O
deriveResultZZO [
.ZZ[ \
	UnwrapErrZZ\ e
(ZZe f
)ZZf g
)ZZg h
;ZZh i
}[[ 
byte]] 
[]] 
]]] 
publicKeyBytes]] !
=]]" #
deriveResult]]$ 0
.]]0 1
Unwrap]]1 7
(]]7 8
)]]8 9
;]]9 :
if__ 
(__ 
publicKeyBytes__ 
.__ 
Length__ %
!=__& (
	Constants__) 2
.__2 3#
X_25519_PUBLIC_KEY_SIZE__3 J
)__J K
{`` 
securePrivateKeyaa  
.aa  !
Disposeaa! (
(aa( )
)aa) *
;aa* +
SodiumInteropbb 
.bb 

SecureWipebb (
(bb( )
publicKeyBytesbb) 7
)bb7 8
;bb8 9
returncc 
Resultcc 
<cc 
OneTimePreKeyLocalcc 0
,cc0 1#
EcliptixProtocolFailurecc2 I
>ccI J
.ccJ K
ErrccK N
(ccN O#
EcliptixProtocolFailureccO f
.ccf g
	DeriveKeyccg p
(ccp q
$"dd 
$strdd 4
{dd4 5
preKeyIddd5 =
}dd= >
$strdd> S
{ddS T
publicKeyBytesddT b
.ddb c
Lengthddc i
}ddi j
$strddj l
"ddl m
)ddm n
)ddn o
;ddo p
}ee 
OneTimePreKeyLocalgg 
opkgg "
=gg# $
newgg% (
(gg( )
preKeyIdgg) 1
,gg1 2
securePrivateKeygg3 C
,ggC D
publicKeyBytesggE S
)ggS T
;ggT U
returnhh 
Resulthh 
<hh 
OneTimePreKeyLocalhh ,
,hh, -#
EcliptixProtocolFailurehh. E
>hhE F
.hhF G
OkhhG I
(hhI J
opkhhJ M
)hhM N
;hhN O
}ii 	
catchjj 
(jj 
	Exceptionjj 
exjj 
)jj 
{kk 	
securePrivateKeyll 
?ll 
.ll 
Disposell %
(ll% &
)ll& '
;ll' (
ifmm 
(mm 
tempPrivateKeyBytesmm #
!=mm$ &
nullmm' +
)mm+ ,
{nn 
SodiumInteropoo 
.oo 

SecureWipeoo (
(oo( )
tempPrivateKeyBytesoo) <
)oo< =
;oo= >
}pp 
ifrr 
(rr 
tempPrivKeyCopyrr 
!=rr  "
nullrr# '
)rr' (
{ss 
SodiumInteroptt 
.tt 

SecureWipett (
(tt( )
tempPrivKeyCopytt) 8
)tt8 9
;tt9 :
}uu 
returnww 
Resultww 
<ww 
OneTimePreKeyLocalww ,
,ww, -#
EcliptixProtocolFailureww. E
>wwE F
.wwF G
ErrwwG J
(wwJ K#
EcliptixProtocolFailurexx '
.xx' (
Genericxx( /
(xx/ 0
$"xx0 2
$strxx2 b
{xxb c
preKeyIdxxc k
}xxk l
$strxxl m
"xxm n
,xxn o
exxxp r
)xxr s
)yy 
;yy 
}zz 	
}{{ 
public}} 

void}} 
Dispose}} 
(}} 
)}} 
{~~ 
if 

( 
PrivateKeyHandle 
is 
{  !
	IsInvalid" +
:+ ,
false- 2
}3 4
)4 5
{
ÄÄ 	
PrivateKeyHandle
ÅÅ 
.
ÅÅ 
Dispose
ÅÅ $
(
ÅÅ$ %
)
ÅÅ% &
;
ÅÅ& '
}
ÇÇ 	
}
ÉÉ 
}ÑÑ Ø≈
o/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/MasterKeyDerivation.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
internal 
static	 
class 
MasterKeyDerivation )
{ 
private 
const 
int 
KEY_SIZE 
=  
$num! #
;# $
private 
const 
int 
CURRENT_VERSION %
=& '
$num( )
;) *
private 
static 
readonly 
byte  
[  !
]! "
CachedDomainBytes# 4
=5 6
Encoding7 ?
.? @
UTF8@ D
.D E
GetBytesE M
(M N
StorageKeyConstantsN a
.a b
SessionContextb p
.p q
DOMAIN_CONTEXTq 
)	 Ä
;
Ä Å
private 
static 
readonly 
byte  
[  !
]! "!
CachedMasterSaltBytes# 8
=9 :
Encoding; C
.C D
UTF8D H
.H I
GetBytesI Q
(Q R
StorageKeyConstantsR e
.e f
SessionContextf t
.t u
MASTER_SALT	u Ä
)
Ä Å
;
Å Ç
private 
static 
readonly 
byte  
[  !
]! "%
CachedEd25519ContextBytes# <
== >
Encoding? G
.G H
UTF8H L
.L M
GetBytesM U
(U V
StorageKeyConstantsV i
.i j
SessionContextj x
.x y
ED_25519_CONTEXT	y â
)
â ä
;
ä ã
private 
static 
readonly 
byte  
[  !
]! "$
CachedX25519ContextBytes# ;
=< =
Encoding> F
.F G
UTF8G K
.K L
GetBytesL T
(T U
StorageKeyConstantsU h
.h i
SessionContexti w
.w x
X_25519_CONTEXT	x á
)
á à
;
à â
private 
static 
readonly 
byte  
[  !
]! "*
CachedSignedPreKeyContextBytes# A
=B C
EncodingD L
.L M
UTF8M Q
.Q R
GetBytesR Z
(Z [
StorageKeyConstants[ n
.n o
SessionContexto }
.} ~#
SIGNED_PRE_KEY_CONTEXT	~ î
)
î ï
;
ï ñ
public 

static 
byte 
[ 
] 
DeriveMasterKey (
(( )
byte) -
[- .
]. /
	exportKey0 9
,9 :

ByteString; E
membershipIdF R
)R S
{ 
Span 
< 
byte 
> 
membershipBytes "
=# $
membershipId% 1
.1 2
Length2 8
<=9 ;
$num< ?
? 

stackalloc 
byte 
[ 
membershipId *
.* +
Length+ 1
]1 2
: 
new 
byte 
[ 
membershipId #
.# $
Length$ *
]* +
;+ ,
byte 
[ 
] 
membershipArray 
=  
membershipId! -
.- .
ToByteArray. 9
(9 :
): ;
;; <
membershipArray 
. 
CopyTo 
( 
membershipBytes .
). /
;/ 0
Span!! 
<!! 
byte!! 
>!! 
versionBytes!! 
=!!  !

stackalloc!!" ,
byte!!- 1
[!!1 2
sizeof!!2 8
(!!8 9
int!!9 <
)!!< =
]!!= >
;!!> ?
BitConverter"" 
."" 
TryWriteBytes"" "
(""" #
versionBytes""# /
,""/ 0
CURRENT_VERSION""1 @
)""@ A
;""A B
ReadOnlySpan$$ 
<$$ 
byte$$ 
>$$ 
domainBytes$$ &
=$$' (
CachedDomainBytes$$) :
;$$: ;
byte&& 
[&& 
]&& 
	argonSalt&& 
=&& 
CreateArgonSalt&& *
(&&* +
membershipBytes&&+ :
,&&: ;
versionBytes&&< H
,&&H I
domainBytes&&J U
)&&U V
;&&V W
byte'' 
['' 
]'' 
?'' 
stretchedKey'' 
='' 
null'' #
;''# $
ReadOnlySpan)) 
<)) 
byte)) 
>)) 
masterSaltBytes)) *
=))+ ,!
CachedMasterSaltBytes))- B
;))B C
try++ 
{,, 	
stretchedKey-- 
=-- 
DeriveWithArgon2Id-- -
(--- .
	exportKey--. 7
,--7 8
	argonSalt--9 B
)--B C
;--C D
byte// 
[// 
]// 
salt16// 
=// 
masterSaltBytes// +
.//+ ,
ToArray//, 3
(//3 4
)//4 5
;//5 6
byte00 
[00 
]00 

personal1600 
=00 
membershipBytes00  /
.00/ 0
ToArray000 7
(007 8
)008 9
;009 :
if22 
(22 
salt1622 
.22 
Length22 
!=22  "
CryptographicConstants22! 7
.227 8
BLAKE_2_B_SALT_SIZE228 K
)22K L
{33 
byte44 
[44 
]44 
adjustedSalt44 #
=44$ %
new44& )
byte44* .
[44. /"
CryptographicConstants44/ E
.44E F
BLAKE_2_B_SALT_SIZE44F Y
]44Y Z
;44Z [
int55 

copyLength55 
=55  
Math55! %
.55% &
Min55& )
(55) *
salt1655* 0
.550 1
Length551 7
,557 8"
CryptographicConstants559 O
.55O P
BLAKE_2_B_SALT_SIZE55P c
)55c d
;55d e
Array66 
.66 
Copy66 
(66 
salt1666 !
,66! "
$num66# $
,66$ %
adjustedSalt66& 2
,662 3
$num664 5
,665 6

copyLength667 A
)66A B
;66B C
salt1677 
=77 
adjustedSalt77 %
;77% &
}88 
if:: 
(:: 

personal16:: 
.:: 
Length:: !
!=::" $"
CryptographicConstants::% ;
.::; <#
BLAKE_2_B_PERSONAL_SIZE::< S
)::S T
{;; 
throw<< 
new<< %
InvalidOperationException<< 3
(<<3 4
string<<4 :
.<<: ;
Format<<; A
(<<A B#
ProtocolSystemConstants<<B Y
.<<Y Z
ErrorMessages<<Z g
.<<g h,
PERSONAL_PARAMETER_INVALID_SIZE	<<h á
,
<<á à$
CryptographicConstants
<<â ü
.
<<ü †%
BLAKE_2_B_PERSONAL_SIZE
<<† ∑
,
<<∑ ∏

personal16
<<π √
.
<<√ ƒ
Length
<<ƒ  
)
<<  À
)
<<À Ã
;
<<Ã Õ
}== 
byte?? 
[?? 
]?? 
	masterKey?? 
=?? 
GenericHash?? *
.??* +
HashSaltPersonal??+ ;
(??; <
message@@ 
:@@ 
stretchedKey@@ %
,@@% &
keyAA 
:AA 
nullAA 
,AA 
saltBB 
:BB 
salt16BB 
,BB 
personalCC 
:CC 

personal16CC $
,CC$ %
bytesDD 
:DD 
KEY_SIZEDD 
)EE 
;EE 
returnGG 
	masterKeyGG 
;GG 
}HH 	
finallyII 
{JJ 	
ifKK 
(KK 
stretchedKeyKK 
!=KK 
nullKK  $
)KK$ %
{LL #
CryptographicOperationsMM '
.MM' (

ZeroMemoryMM( 2
(MM2 3
stretchedKeyMM3 ?
)MM? @
;MM@ A
}NN #
CryptographicOperationsPP #
.PP# $

ZeroMemoryPP$ .
(PP. /
	argonSaltPP/ 8
)PP8 9
;PP9 :#
CryptographicOperationsQQ #
.QQ# $

ZeroMemoryQQ$ .
(QQ. /
membershipArrayQQ/ >
)QQ> ?
;QQ? @#
CryptographicOperationsRR #
.RR# $

ZeroMemoryRR$ .
(RR. /
membershipBytesRR/ >
)RR> ?
;RR? @#
CryptographicOperationsSS #
.SS# $

ZeroMemorySS$ .
(SS. /
versionBytesSS/ ;
)SS; <
;SS< =
}TT 	
}UU 
publicWW 

staticWW 
ResultWW 
<WW $
SodiumSecureMemoryHandleWW 1
,WW1 2
SodiumFailureWW3 @
>WW@ A!
DeriveMasterKeyHandleWWB W
(WWW X$
SodiumSecureMemoryHandleWWX p
exportKeyHandle	WWq Ä
,
WWÄ Å

ByteString
WWÇ å
membershipId
WWç ô
)
WWô ö
{XX 
returnYY 
exportKeyHandleYY 
.YY 
WithReadAccessYY -
(YY- .
exportKeySpanYY. ;
=>YY< >
{ZZ 	
Span[[ 
<[[ 
byte[[ 
>[[ 
membershipBytes[[ &
=[[' (
membershipId[[) 5
.[[5 6
Length[[6 <
<=[[= ?
$num[[@ C
?\\ 

stackalloc\\ 
byte\\ !
[\\! "
membershipId\\" .
.\\. /
Length\\/ 5
]\\5 6
:]] 
new]] 
byte]] 
[]] 
membershipId]] '
.]]' (
Length]]( .
]]]. /
;]]/ 0
byte__ 
[__ 
]__ 
membershipArray__ "
=__# $
membershipId__% 1
.__1 2
ToByteArray__2 =
(__= >
)__> ?
;__? @
membershipArray`` 
.`` 
CopyTo`` "
(``" #
membershipBytes``# 2
)``2 3
;``3 4
Spanbb 
<bb 
bytebb 
>bb 
versionBytesbb #
=bb$ %

stackallocbb& 0
bytebb1 5
[bb5 6
sizeofbb6 <
(bb< =
intbb= @
)bb@ A
]bbA B
;bbB C
BitConvertercc 
.cc 
TryWriteBytescc &
(cc& '
versionBytescc' 3
,cc3 4
CURRENT_VERSIONcc5 D
)ccD E
;ccE F
ReadOnlySpanee 
<ee 
byteee 
>ee 
domainBytesee *
=ee+ ,
CachedDomainBytesee- >
;ee> ?
bytegg 
[gg 
]gg 
	argonSaltgg 
=gg 
CreateArgonSaltgg .
(gg. /
membershipBytesgg/ >
,gg> ?
versionBytesgg@ L
,ggL M
domainBytesggN Y
)ggY Z
;ggZ [
bytehh 
[hh 
]hh 
?hh 
stretchedKeyhh  
=hh! "
nullhh# '
;hh' (
ReadOnlySpanjj 
<jj 
bytejj 
>jj 
masterSaltBytesjj .
=jj/ 0!
CachedMasterSaltBytesjj1 F
;jjF G
tryll 
{mm 
stretchedKeynn 
=nn 
DeriveWithArgon2Idnn 1
(nn1 2
exportKeySpannn2 ?
,nn? @
	argonSaltnnA J
)nnJ K
;nnK L
bytepp 
[pp 
]pp 
salt16pp 
=pp 
masterSaltBytespp  /
.pp/ 0
ToArraypp0 7
(pp7 8
)pp8 9
;pp9 :
byteqq 
[qq 
]qq 

personal16qq !
=qq" #
membershipBytesqq$ 3
.qq3 4
ToArrayqq4 ;
(qq; <
)qq< =
;qq= >
ifss 
(ss 
salt16ss 
.ss 
Lengthss !
!=ss" $"
CryptographicConstantsss% ;
.ss; <
BLAKE_2_B_SALT_SIZEss< O
)ssO P
{tt 
byteuu 
[uu 
]uu 
adjustedSaltuu '
=uu( )
newuu* -
byteuu. 2
[uu2 3"
CryptographicConstantsuu3 I
.uuI J
BLAKE_2_B_SALT_SIZEuuJ ]
]uu] ^
;uu^ _
intvv 

copyLengthvv "
=vv# $
Mathvv% )
.vv) *
Minvv* -
(vv- .
salt16vv. 4
.vv4 5
Lengthvv5 ;
,vv; <"
CryptographicConstantsvv= S
.vvS T
BLAKE_2_B_SALT_SIZEvvT g
)vvg h
;vvh i
Arrayww 
.ww 
Copyww 
(ww 
salt16ww %
,ww% &
$numww' (
,ww( )
adjustedSaltww* 6
,ww6 7
$numww8 9
,ww9 :

copyLengthww; E
)wwE F
;wwF G
salt16xx 
=xx 
adjustedSaltxx )
;xx) *
}yy 
if{{ 
({{ 

personal16{{ 
.{{ 
Length{{ %
!={{& ("
CryptographicConstants{{) ?
.{{? @#
BLAKE_2_B_PERSONAL_SIZE{{@ W
){{W X
{|| 
return}} 
Result}} !
<}}! "$
SodiumSecureMemoryHandle}}" :
,}}: ;
SodiumFailure}}< I
>}}I J
.}}J K
Err}}K N
(}}N O
SodiumFailure~~ %
.~~% &
InvalidOperation~~& 6
(~~6 7
string~~7 =
.~~= >
Format~~> D
(~~D E#
ProtocolSystemConstants~~E \
.~~\ ]
ErrorMessages~~] j
.~~j k,
PERSONAL_PARAMETER_INVALID_SIZE	~~k ä
,
~~ä ã$
CryptographicConstants
~~å ¢
.
~~¢ £%
BLAKE_2_B_PERSONAL_SIZE
~~£ ∫
,
~~∫ ª

personal16
~~º ∆
.
~~∆ «
Length
~~« Õ
)
~~Õ Œ
)
~~Œ œ
)
~~œ –
;
~~– —
} 
byte
ÅÅ 
[
ÅÅ 
]
ÅÅ 
masterKeyBytes
ÅÅ %
=
ÅÅ& '
GenericHash
ÅÅ( 3
.
ÅÅ3 4
HashSaltPersonal
ÅÅ4 D
(
ÅÅD E
message
ÇÇ 
:
ÇÇ 
stretchedKey
ÇÇ )
,
ÇÇ) *
key
ÉÉ 
:
ÉÉ 
null
ÉÉ 
,
ÉÉ 
salt
ÑÑ 
:
ÑÑ 
salt16
ÑÑ  
,
ÑÑ  !
personal
ÖÖ 
:
ÖÖ 

personal16
ÖÖ (
,
ÖÖ( )
bytes
ÜÜ 
:
ÜÜ 
KEY_SIZE
ÜÜ #
)
áá 
;
áá 
Result
ââ 
<
ââ &
SodiumSecureMemoryHandle
ââ /
,
ââ/ 0
SodiumFailure
ââ1 >
>
ââ> ?
allocResult
ââ@ K
=
ââL M&
SodiumSecureMemoryHandle
ââN f
.
ââf g
Allocate
ââg o
(
ââo p
KEY_SIZE
ââp x
)
ââx y
;
âây z
if
ää 
(
ää 
allocResult
ää 
.
ää  
IsErr
ää  %
)
ää% &
{
ãã %
CryptographicOperations
åå +
.
åå+ ,

ZeroMemory
åå, 6
(
åå6 7
masterKeyBytes
åå7 E
)
ååE F
;
ååF G
return
çç 
allocResult
çç &
;
çç& '
}
éé &
SodiumSecureMemoryHandle
êê (
masterKeyHandle
êê) 8
=
êê9 :
allocResult
êê; F
.
êêF G
Unwrap
êêG M
(
êêM N
)
êêN O
;
êêO P
Result
ëë 
<
ëë 
Unit
ëë 
,
ëë 
SodiumFailure
ëë *
>
ëë* +
writeResult
ëë, 7
=
ëë8 9
masterKeyHandle
ëë: I
.
ëëI J
Write
ëëJ O
(
ëëO P
masterKeyBytes
ëëP ^
)
ëë^ _
;
ëë_ `%
CryptographicOperations
ìì '
.
ìì' (

ZeroMemory
ìì( 2
(
ìì2 3
masterKeyBytes
ìì3 A
)
ììA B
;
ììB C
if
ïï 
(
ïï 
writeResult
ïï 
.
ïï  
IsErr
ïï  %
)
ïï% &
{
ññ 
masterKeyHandle
óó #
.
óó# $
Dispose
óó$ +
(
óó+ ,
)
óó, -
;
óó- .
return
òò 
Result
òò !
<
òò! "&
SodiumSecureMemoryHandle
òò" :
,
òò: ;
SodiumFailure
òò< I
>
òòI J
.
òòJ K
Err
òòK N
(
òòN O
writeResult
òòO Z
.
òòZ [
	UnwrapErr
òò[ d
(
òòd e
)
òòe f
)
òòf g
;
òòg h
}
ôô 
return
õõ 
Result
õõ 
<
õõ &
SodiumSecureMemoryHandle
õõ 6
,
õõ6 7
SodiumFailure
õõ8 E
>
õõE F
.
õõF G
Ok
õõG I
(
õõI J
masterKeyHandle
õõJ Y
)
õõY Z
;
õõZ [
}
úú 
catch
ùù 
(
ùù 
	Exception
ùù 
ex
ùù 
)
ùù  
{
ûû 
return
üü 
Result
üü 
<
üü &
SodiumSecureMemoryHandle
üü 6
,
üü6 7
SodiumFailure
üü8 E
>
üüE F
.
üüF G
Err
üüG J
(
üüJ K
SodiumFailure
†† !
.
††! "
InvalidOperation
††" 2
(
††2 3
string
††3 9
.
††9 :
Format
††: @
(
††@ A%
ProtocolSystemConstants
††A X
.
††X Y
ErrorMessages
††Y f
.
††f g*
FAILED_TO_DERIVE_MASTER_KEY††g Ç
,††Ç É
ex††Ñ Ü
.††Ü á
Message††á é
)††é è
)††è ê
)††ê ë
;††ë í
}
°° 
finally
¢¢ 
{
££ 
if
§§ 
(
§§ 
stretchedKey
§§  
!=
§§! #
null
§§$ (
)
§§( )
{
•• %
CryptographicOperations
¶¶ +
.
¶¶+ ,

ZeroMemory
¶¶, 6
(
¶¶6 7
stretchedKey
¶¶7 C
)
¶¶C D
;
¶¶D E
}
ßß %
CryptographicOperations
©© '
.
©©' (

ZeroMemory
©©( 2
(
©©2 3
	argonSalt
©©3 <
)
©©< =
;
©©= >%
CryptographicOperations
™™ '
.
™™' (

ZeroMemory
™™( 2
(
™™2 3
membershipArray
™™3 B
)
™™B C
;
™™C D%
CryptographicOperations
´´ '
.
´´' (

ZeroMemory
´´( 2
(
´´2 3
membershipBytes
´´3 B
)
´´B C
;
´´C D%
CryptographicOperations
¨¨ '
.
¨¨' (

ZeroMemory
¨¨( 2
(
¨¨2 3
versionBytes
¨¨3 ?
)
¨¨? @
;
¨¨@ A
}
≠≠ 
}
ÆÆ 	
)
ÆÆ	 

;
ÆÆ
 
}
ØØ 
private
±± 
static
±± 
byte
±± 
[
±± 
]
±± 
CreateArgonSalt
±± )
(
±±) *
ReadOnlySpan
±±* 6
<
±±6 7
byte
±±7 ;
>
±±; <
membershipBytes
±±= L
,
±±L M
ReadOnlySpan
±±N Z
<
±±Z [
byte
±±[ _
>
±±_ `
versionBytes
±±a m
,
±±m n
ReadOnlySpan
±±o {
<
±±{ |
byte±±| Ä
>±±Ä Å
domainBytes±±Ç ç
)±±ç é
{
≤≤ 
int
≥≥ 
totalLength
≥≥ 
=
≥≥ 
membershipBytes
≥≥ )
.
≥≥) *
Length
≥≥* 0
+
≥≥1 2
versionBytes
≥≥3 ?
.
≥≥? @
Length
≥≥@ F
+
≥≥G H
domainBytes
≥≥I T
.
≥≥T U
Length
≥≥U [
;
≥≥[ \
Span
µµ 
<
µµ 
byte
µµ 
>
µµ 
combinedInput
µµ  
=
µµ! "
totalLength
µµ# .
<=
µµ/ 1
$num
µµ2 5
?
∂∂ 

stackalloc
∂∂ 
byte
∂∂ 
[
∂∂ 
totalLength
∂∂ )
]
∂∂) *
:
∑∑ 
new
∑∑ 
byte
∑∑ 
[
∑∑ 
totalLength
∑∑ "
]
∑∑" #
;
∑∑# $
try
ππ 
{
∫∫ 	
int
ªª 
offset
ªª 
=
ªª 
$num
ªª 
;
ªª 
membershipBytes
ºº 
.
ºº 
CopyTo
ºº "
(
ºº" #
combinedInput
ºº# 0
[
ºº0 1
offset
ºº1 7
..
ºº7 9
]
ºº9 :
)
ºº: ;
;
ºº; <
offset
ΩΩ 
+=
ΩΩ 
membershipBytes
ΩΩ %
.
ΩΩ% &
Length
ΩΩ& ,
;
ΩΩ, -
versionBytes
øø 
.
øø 
CopyTo
øø 
(
øø  
combinedInput
øø  -
[
øø- .
offset
øø. 4
..
øø4 6
]
øø6 7
)
øø7 8
;
øø8 9
offset
¿¿ 
+=
¿¿ 
versionBytes
¿¿ "
.
¿¿" #
Length
¿¿# )
;
¿¿) *
domainBytes
¬¬ 
.
¬¬ 
CopyTo
¬¬ 
(
¬¬ 
combinedInput
¬¬ ,
[
¬¬, -
offset
¬¬- 3
..
¬¬3 5
]
¬¬5 6
)
¬¬6 7
;
¬¬7 8
byte
ƒƒ 
[
ƒƒ 
]
ƒƒ 
salt
ƒƒ 
=
ƒƒ !
ComputeHashFromSpan
ƒƒ -
(
ƒƒ- .
combinedInput
ƒƒ. ;
)
ƒƒ; <
;
ƒƒ< =
return
∆∆ 
salt
∆∆ 
;
∆∆ 
}
«« 	
finally
»» 
{
…… 	%
CryptographicOperations
   #
.
  # $

ZeroMemory
  $ .
(
  . /
combinedInput
  / <
)
  < =
;
  = >
}
ÀÀ 	
}
ÃÃ 
private
ŒŒ 
static
ŒŒ 
byte
ŒŒ 
[
ŒŒ 
]
ŒŒ  
DeriveWithArgon2Id
ŒŒ ,
(
ŒŒ, -
byte
ŒŒ- 1
[
ŒŒ1 2
]
ŒŒ2 3
	exportKey
ŒŒ4 =
,
ŒŒ= >
byte
ŒŒ? C
[
ŒŒC D
]
ŒŒD E
salt
ŒŒF J
)
ŒŒJ K
{
œœ 
using
–– 
Argon2id
–– 
argon2
–– 
=
–– 
new
––  #
(
––# $
	exportKey
––$ -
)
––- .
{
—— 	
Salt
““ 
=
““ 
salt
““ 
,
““ !
DegreeOfParallelism
”” 
=
””  !$
CryptographicConstants
””" 8
.
””8 9
Argon2
””9 ?
.
””? @!
DEFAULT_PARALLELISM
””@ S
,
””S T

Iterations
‘‘ 
=
‘‘ $
CryptographicConstants
‘‘ /
.
‘‘/ 0
Argon2
‘‘0 6
.
‘‘6 7 
DEFAULT_ITERATIONS
‘‘7 I
,
‘‘I J

MemorySize
’’ 
=
’’ $
CryptographicConstants
’’ /
.
’’/ 0
Argon2
’’0 6
.
’’6 7!
DEFAULT_MEMORY_SIZE
’’7 J
}
÷÷ 	
;
÷÷	 

return
ÿÿ 
argon2
ÿÿ 
.
ÿÿ 
GetBytes
ÿÿ 
(
ÿÿ 
KEY_SIZE
ÿÿ '
)
ÿÿ' (
;
ÿÿ( )
}
ŸŸ 
private
€€ 
static
€€ 
byte
€€ 
[
€€ 
]
€€  
DeriveWithArgon2Id
€€ ,
(
€€, -
ReadOnlySpan
€€- 9
<
€€9 :
byte
€€: >
>
€€> ?
exportKeySpan
€€@ M
,
€€M N
byte
€€O S
[
€€S T
]
€€T U
salt
€€V Z
)
€€Z [
{
‹‹ 
byte
›› 
[
›› 
]
›› 
exportKeyBuffer
›› 
=
››  
	ArrayPool
››! *
<
››* +
byte
››+ /
>
››/ 0
.
››0 1
Shared
››1 7
.
››7 8
Rent
››8 <
(
››< =
exportKeySpan
››= J
.
››J K
Length
››K Q
)
››Q R
;
››R S
try
ﬁﬁ 
{
ﬂﬂ 	
exportKeySpan
‡‡ 
.
‡‡ 
CopyTo
‡‡  
(
‡‡  !
exportKeyBuffer
‡‡! 0
.
‡‡0 1
AsSpan
‡‡1 7
(
‡‡7 8
$num
‡‡8 9
,
‡‡9 :
exportKeySpan
‡‡; H
.
‡‡H I
Length
‡‡I O
)
‡‡O P
)
‡‡P Q
;
‡‡Q R
using
‚‚ 
Argon2id
‚‚ 
argon2
‚‚ !
=
‚‚" #
new
‚‚$ '
(
‚‚' (
exportKeyBuffer
‚‚( 7
.
‚‚7 8
AsSpan
‚‚8 >
(
‚‚> ?
$num
‚‚? @
,
‚‚@ A
exportKeySpan
‚‚B O
.
‚‚O P
Length
‚‚P V
)
‚‚V W
.
‚‚W X
ToArray
‚‚X _
(
‚‚_ `
)
‚‚` a
)
‚‚a b
{
„„ 
Salt
‰‰ 
=
‰‰ 
salt
‰‰ 
,
‰‰ !
DegreeOfParallelism
ÂÂ #
=
ÂÂ$ %$
CryptographicConstants
ÂÂ& <
.
ÂÂ< =
Argon2
ÂÂ= C
.
ÂÂC D!
DEFAULT_PARALLELISM
ÂÂD W
,
ÂÂW X

Iterations
ÊÊ 
=
ÊÊ $
CryptographicConstants
ÊÊ 3
.
ÊÊ3 4
Argon2
ÊÊ4 :
.
ÊÊ: ; 
DEFAULT_ITERATIONS
ÊÊ; M
,
ÊÊM N

MemorySize
ÁÁ 
=
ÁÁ $
CryptographicConstants
ÁÁ 3
.
ÁÁ3 4
Argon2
ÁÁ4 :
.
ÁÁ: ;!
DEFAULT_MEMORY_SIZE
ÁÁ; N
}
ËË 
;
ËË 
return
ÍÍ 
argon2
ÍÍ 
.
ÍÍ 
GetBytes
ÍÍ "
(
ÍÍ" #
KEY_SIZE
ÍÍ# +
)
ÍÍ+ ,
;
ÍÍ, -
}
ÎÎ 	
finally
ÏÏ 
{
ÌÌ 	%
CryptographicOperations
ÓÓ #
.
ÓÓ# $

ZeroMemory
ÓÓ$ .
(
ÓÓ. /
exportKeyBuffer
ÓÓ/ >
.
ÓÓ> ?
AsSpan
ÓÓ? E
(
ÓÓE F
$num
ÓÓF G
,
ÓÓG H
exportKeySpan
ÓÓI V
.
ÓÓV W
Length
ÓÓW ]
)
ÓÓ] ^
)
ÓÓ^ _
;
ÓÓ_ `
	ArrayPool
ÔÔ 
<
ÔÔ 
byte
ÔÔ 
>
ÔÔ 
.
ÔÔ 
Shared
ÔÔ "
.
ÔÔ" #
Return
ÔÔ# )
(
ÔÔ) *
exportKeyBuffer
ÔÔ* 9
,
ÔÔ9 :

clearArray
ÔÔ; E
:
ÔÔE F
false
ÔÔG L
)
ÔÔL M
;
ÔÔM N
}
 	
}
ÒÒ 
public
ÛÛ 

static
ÛÛ 
byte
ÛÛ 
[
ÛÛ 
]
ÛÛ 
DeriveEd25519Seed
ÛÛ *
(
ÛÛ* +
byte
ÛÛ+ /
[
ÛÛ/ 0
]
ÛÛ0 1
	masterKey
ÛÛ2 ;
,
ÛÛ; <
string
ÛÛ= C
membershipId
ÛÛD P
)
ÛÛP Q
{
ÙÙ 
Span
ıı 
<
ıı 
byte
ıı 
>
ıı 
versionBytes
ıı 
=
ıı  !

stackalloc
ıı" ,
byte
ıı- 1
[
ıı1 2
sizeof
ıı2 8
(
ıı8 9
int
ıı9 <
)
ıı< =
]
ıı= >
;
ıı> ?
BitConverter
ˆˆ 
.
ˆˆ 
TryWriteBytes
ˆˆ "
(
ˆˆ" #
versionBytes
ˆˆ# /
,
ˆˆ/ 0
CURRENT_VERSION
ˆˆ1 @
)
ˆˆ@ A
;
ˆˆA B
ReadOnlySpan
¯¯ 
<
¯¯ 
byte
¯¯ 
>
¯¯ 
contextBytes
¯¯ '
=
¯¯( )'
CachedEd25519ContextBytes
¯¯* C
;
¯¯C D
int
˙˙ 
memberBytesLength
˙˙ 
=
˙˙ 
Encoding
˙˙  (
.
˙˙( )
UTF8
˙˙) -
.
˙˙- .
GetByteCount
˙˙. :
(
˙˙: ;
membershipId
˙˙; G
)
˙˙G H
;
˙˙H I
Span
˚˚ 
<
˚˚ 
byte
˚˚ 
>
˚˚ 
memberBytes
˚˚ 
=
˚˚  
memberBytesLength
˚˚! 2
<=
˚˚3 5
$num
˚˚6 9
?
¸¸ 

stackalloc
¸¸ 
byte
¸¸ 
[
¸¸ 
memberBytesLength
¸¸ /
]
¸¸/ 0
:
˝˝ 
new
˝˝ 
byte
˝˝ 
[
˝˝ 
memberBytesLength
˝˝ (
]
˝˝( )
;
˝˝) *
Encoding
˛˛ 
.
˛˛ 
UTF8
˛˛ 
.
˛˛ 
GetBytes
˛˛ 
(
˛˛ 
membershipId
˛˛ +
,
˛˛+ ,
memberBytes
˛˛- 8
)
˛˛8 9
;
˛˛9 :
int
ÄÄ 
totalLength
ÄÄ 
=
ÄÄ 
versionBytes
ÄÄ &
.
ÄÄ& '
Length
ÄÄ' -
+
ÄÄ. /
contextBytes
ÄÄ0 <
.
ÄÄ< =
Length
ÄÄ= C
+
ÄÄD E
memberBytes
ÄÄF Q
.
ÄÄQ R
Length
ÄÄR X
;
ÄÄX Y
Span
ÅÅ 
<
ÅÅ 
byte
ÅÅ 
>
ÅÅ 
combinedContext
ÅÅ "
=
ÅÅ# $
totalLength
ÅÅ% 0
<=
ÅÅ1 3
$num
ÅÅ4 7
?
ÇÇ 

stackalloc
ÇÇ 
byte
ÇÇ 
[
ÇÇ 
totalLength
ÇÇ )
]
ÇÇ) *
:
ÉÉ 
new
ÉÉ 
byte
ÉÉ 
[
ÉÉ 
totalLength
ÉÉ "
]
ÉÉ" #
;
ÉÉ# $
try
ÖÖ 
{
ÜÜ 	
int
áá 
offset
áá 
=
áá 
$num
áá 
;
áá 
versionBytes
àà 
.
àà 
CopyTo
àà 
(
àà  
combinedContext
àà  /
[
àà/ 0
offset
àà0 6
..
àà6 8
]
àà8 9
)
àà9 :
;
àà: ;
offset
ââ 
+=
ââ 
versionBytes
ââ "
.
ââ" #
Length
ââ# )
;
ââ) *
contextBytes
ãã 
.
ãã 
CopyTo
ãã 
(
ãã  
combinedContext
ãã  /
[
ãã/ 0
offset
ãã0 6
..
ãã6 8
]
ãã8 9
)
ãã9 :
;
ãã: ;
offset
åå 
+=
åå 
contextBytes
åå "
.
åå" #
Length
åå# )
;
åå) *
memberBytes
éé 
.
éé 
CopyTo
éé 
(
éé 
combinedContext
éé .
[
éé. /
offset
éé/ 5
..
éé5 7
]
éé7 8
)
éé8 9
;
éé9 :
return
êê )
HashWithGenericHashFromSpan
êê .
(
êê. /
	masterKey
êê/ 8
,
êê8 9
combinedContext
êê: I
,
êêI J
KEY_SIZE
êêK S
)
êêS T
;
êêT U
}
ëë 	
finally
íí 
{
ìì 	%
CryptographicOperations
îî #
.
îî# $

ZeroMemory
îî$ .
(
îî. /
versionBytes
îî/ ;
)
îî; <
;
îî< =%
CryptographicOperations
ïï #
.
ïï# $

ZeroMemory
ïï$ .
(
ïï. /
memberBytes
ïï/ :
)
ïï: ;
;
ïï; <%
CryptographicOperations
ññ #
.
ññ# $

ZeroMemory
ññ$ .
(
ññ. /
combinedContext
ññ/ >
)
ññ> ?
;
ññ? @
}
óó 	
}
òò 
public
öö 

static
öö 
byte
öö 
[
öö 
]
öö 
DeriveX25519Seed
öö )
(
öö) *
byte
öö* .
[
öö. /
]
öö/ 0
	masterKey
öö1 :
,
öö: ;
string
öö< B
membershipId
ööC O
)
ööO P
{
õõ 
Span
úú 
<
úú 
byte
úú 
>
úú 
versionBytes
úú 
=
úú  !

stackalloc
úú" ,
byte
úú- 1
[
úú1 2
sizeof
úú2 8
(
úú8 9
int
úú9 <
)
úú< =
]
úú= >
;
úú> ?
BitConverter
ùù 
.
ùù 
TryWriteBytes
ùù "
(
ùù" #
versionBytes
ùù# /
,
ùù/ 0
CURRENT_VERSION
ùù1 @
)
ùù@ A
;
ùùA B
ReadOnlySpan
üü 
<
üü 
byte
üü 
>
üü 
contextBytes
üü '
=
üü( )&
CachedX25519ContextBytes
üü* B
;
üüB C
int
°° 
memberBytesLength
°° 
=
°° 
Encoding
°°  (
.
°°( )
UTF8
°°) -
.
°°- .
GetByteCount
°°. :
(
°°: ;
membershipId
°°; G
)
°°G H
;
°°H I
Span
¢¢ 
<
¢¢ 
byte
¢¢ 
>
¢¢ 
memberBytes
¢¢ 
=
¢¢  
memberBytesLength
¢¢! 2
<=
¢¢3 5
$num
¢¢6 9
?
££ 

stackalloc
££ 
byte
££ 
[
££ 
memberBytesLength
££ /
]
££/ 0
:
§§ 
new
§§ 
byte
§§ 
[
§§ 
memberBytesLength
§§ (
]
§§( )
;
§§) *
Encoding
•• 
.
•• 
UTF8
•• 
.
•• 
GetBytes
•• 
(
•• 
membershipId
•• +
,
••+ ,
memberBytes
••- 8
)
••8 9
;
••9 :
int
ßß 
totalLength
ßß 
=
ßß 
versionBytes
ßß &
.
ßß& '
Length
ßß' -
+
ßß. /
contextBytes
ßß0 <
.
ßß< =
Length
ßß= C
+
ßßD E
memberBytes
ßßF Q
.
ßßQ R
Length
ßßR X
;
ßßX Y
Span
®® 
<
®® 
byte
®® 
>
®® 
combinedContext
®® "
=
®®# $
totalLength
®®% 0
<=
®®1 3
$num
®®4 7
?
©© 

stackalloc
©© 
byte
©© 
[
©© 
totalLength
©© )
]
©©) *
:
™™ 
new
™™ 
byte
™™ 
[
™™ 
totalLength
™™ "
]
™™" #
;
™™# $
try
¨¨ 
{
≠≠ 	
int
ÆÆ 
offset
ÆÆ 
=
ÆÆ 
$num
ÆÆ 
;
ÆÆ 
versionBytes
ØØ 
.
ØØ 
CopyTo
ØØ 
(
ØØ  
combinedContext
ØØ  /
[
ØØ/ 0
offset
ØØ0 6
..
ØØ6 8
]
ØØ8 9
)
ØØ9 :
;
ØØ: ;
offset
∞∞ 
+=
∞∞ 
versionBytes
∞∞ "
.
∞∞" #
Length
∞∞# )
;
∞∞) *
contextBytes
≤≤ 
.
≤≤ 
CopyTo
≤≤ 
(
≤≤  
combinedContext
≤≤  /
[
≤≤/ 0
offset
≤≤0 6
..
≤≤6 8
]
≤≤8 9
)
≤≤9 :
;
≤≤: ;
offset
≥≥ 
+=
≥≥ 
contextBytes
≥≥ "
.
≥≥" #
Length
≥≥# )
;
≥≥) *
memberBytes
µµ 
.
µµ 
CopyTo
µµ 
(
µµ 
combinedContext
µµ .
[
µµ. /
offset
µµ/ 5
..
µµ5 7
]
µµ7 8
)
µµ8 9
;
µµ9 :
return
∑∑ )
HashWithGenericHashFromSpan
∑∑ .
(
∑∑. /
	masterKey
∑∑/ 8
,
∑∑8 9
combinedContext
∑∑: I
,
∑∑I J
KEY_SIZE
∑∑K S
)
∑∑S T
;
∑∑T U
}
∏∏ 	
finally
ππ 
{
∫∫ 	%
CryptographicOperations
ªª #
.
ªª# $

ZeroMemory
ªª$ .
(
ªª. /
versionBytes
ªª/ ;
)
ªª; <
;
ªª< =%
CryptographicOperations
ºº #
.
ºº# $

ZeroMemory
ºº$ .
(
ºº. /
memberBytes
ºº/ :
)
ºº: ;
;
ºº; <%
CryptographicOperations
ΩΩ #
.
ΩΩ# $

ZeroMemory
ΩΩ$ .
(
ΩΩ. /
combinedContext
ΩΩ/ >
)
ΩΩ> ?
;
ΩΩ? @
}
ææ 	
}
øø 
public
¡¡ 

static
¡¡ 
byte
¡¡ 
[
¡¡ 
]
¡¡ $
DeriveSignedPreKeySeed
¡¡ /
(
¡¡/ 0
byte
¡¡0 4
[
¡¡4 5
]
¡¡5 6
	masterKey
¡¡7 @
,
¡¡@ A
string
¡¡B H
membershipId
¡¡I U
)
¡¡U V
{
¬¬ 
Span
√√ 
<
√√ 
byte
√√ 
>
√√ 
versionBytes
√√ 
=
√√  !

stackalloc
√√" ,
byte
√√- 1
[
√√1 2
sizeof
√√2 8
(
√√8 9
int
√√9 <
)
√√< =
]
√√= >
;
√√> ?
BitConverter
ƒƒ 
.
ƒƒ 
TryWriteBytes
ƒƒ "
(
ƒƒ" #
versionBytes
ƒƒ# /
,
ƒƒ/ 0
CURRENT_VERSION
ƒƒ1 @
)
ƒƒ@ A
;
ƒƒA B
ReadOnlySpan
∆∆ 
<
∆∆ 
byte
∆∆ 
>
∆∆ 
contextBytes
∆∆ '
=
∆∆( ),
CachedSignedPreKeyContextBytes
∆∆* H
;
∆∆H I
int
»» 
memberBytesLength
»» 
=
»» 
Encoding
»»  (
.
»»( )
UTF8
»») -
.
»»- .
GetByteCount
»». :
(
»»: ;
membershipId
»»; G
)
»»G H
;
»»H I
Span
…… 
<
…… 
byte
…… 
>
…… 
memberBytes
…… 
=
……  
memberBytesLength
……! 2
<=
……3 5
$num
……6 9
?
   

stackalloc
   
byte
   
[
   
memberBytesLength
   /
]
  / 0
:
ÀÀ 
new
ÀÀ 
byte
ÀÀ 
[
ÀÀ 
memberBytesLength
ÀÀ (
]
ÀÀ( )
;
ÀÀ) *
Encoding
ÃÃ 
.
ÃÃ 
UTF8
ÃÃ 
.
ÃÃ 
GetBytes
ÃÃ 
(
ÃÃ 
membershipId
ÃÃ +
,
ÃÃ+ ,
memberBytes
ÃÃ- 8
)
ÃÃ8 9
;
ÃÃ9 :
int
ŒŒ 
totalLength
ŒŒ 
=
ŒŒ 
versionBytes
ŒŒ &
.
ŒŒ& '
Length
ŒŒ' -
+
ŒŒ. /
contextBytes
ŒŒ0 <
.
ŒŒ< =
Length
ŒŒ= C
+
ŒŒD E
memberBytes
ŒŒF Q
.
ŒŒQ R
Length
ŒŒR X
;
ŒŒX Y
Span
œœ 
<
œœ 
byte
œœ 
>
œœ 
combinedContext
œœ "
=
œœ# $
totalLength
œœ% 0
<=
œœ1 3
$num
œœ4 7
?
–– 

stackalloc
–– 
byte
–– 
[
–– 
totalLength
–– )
]
––) *
:
—— 
new
—— 
byte
—— 
[
—— 
totalLength
—— "
]
——" #
;
——# $
try
”” 
{
‘‘ 	
int
’’ 
offset
’’ 
=
’’ 
$num
’’ 
;
’’ 
versionBytes
÷÷ 
.
÷÷ 
CopyTo
÷÷ 
(
÷÷  
combinedContext
÷÷  /
[
÷÷/ 0
offset
÷÷0 6
..
÷÷6 8
]
÷÷8 9
)
÷÷9 :
;
÷÷: ;
offset
◊◊ 
+=
◊◊ 
versionBytes
◊◊ "
.
◊◊" #
Length
◊◊# )
;
◊◊) *
contextBytes
ŸŸ 
.
ŸŸ 
CopyTo
ŸŸ 
(
ŸŸ  
combinedContext
ŸŸ  /
[
ŸŸ/ 0
offset
ŸŸ0 6
..
ŸŸ6 8
]
ŸŸ8 9
)
ŸŸ9 :
;
ŸŸ: ;
offset
⁄⁄ 
+=
⁄⁄ 
contextBytes
⁄⁄ "
.
⁄⁄" #
Length
⁄⁄# )
;
⁄⁄) *
memberBytes
‹‹ 
.
‹‹ 
CopyTo
‹‹ 
(
‹‹ 
combinedContext
‹‹ .
[
‹‹. /
offset
‹‹/ 5
..
‹‹5 7
]
‹‹7 8
)
‹‹8 9
;
‹‹9 :
return
ﬁﬁ )
HashWithGenericHashFromSpan
ﬁﬁ .
(
ﬁﬁ. /
	masterKey
ﬁﬁ/ 8
,
ﬁﬁ8 9
combinedContext
ﬁﬁ: I
,
ﬁﬁI J
KEY_SIZE
ﬁﬁK S
)
ﬁﬁS T
;
ﬁﬁT U
}
ﬂﬂ 	
finally
‡‡ 
{
·· 	%
CryptographicOperations
‚‚ #
.
‚‚# $

ZeroMemory
‚‚$ .
(
‚‚. /
versionBytes
‚‚/ ;
)
‚‚; <
;
‚‚< =%
CryptographicOperations
„„ #
.
„„# $

ZeroMemory
„„$ .
(
„„. /
memberBytes
„„/ :
)
„„: ;
;
„„; <%
CryptographicOperations
‰‰ #
.
‰‰# $

ZeroMemory
‰‰$ .
(
‰‰. /
combinedContext
‰‰/ >
)
‰‰> ?
;
‰‰? @
}
ÂÂ 	
}
ÊÊ 
private
ËË 
static
ËË 
byte
ËË 
[
ËË 
]
ËË !
ComputeHashFromSpan
ËË -
(
ËË- .
ReadOnlySpan
ËË. :
<
ËË: ;
byte
ËË; ?
>
ËË? @
data
ËËA E
)
ËËE F
{
ÈÈ 
return
ÍÍ 
SHA256
ÍÍ 
.
ÍÍ 
HashData
ÍÍ 
(
ÍÍ 
data
ÍÍ #
)
ÍÍ# $
;
ÍÍ$ %
}
ÎÎ 
private
ÌÌ 
static
ÌÌ 
byte
ÌÌ 
[
ÌÌ 
]
ÌÌ )
HashWithGenericHashFromSpan
ÌÌ 5
(
ÌÌ5 6
byte
ÌÌ6 :
[
ÌÌ: ;
]
ÌÌ; <
key
ÌÌ= @
,
ÌÌ@ A
ReadOnlySpan
ÌÌB N
<
ÌÌN O
byte
ÌÌO S
>
ÌÌS T
data
ÌÌU Y
,
ÌÌY Z
int
ÌÌ[ ^

outputSize
ÌÌ_ i
)
ÌÌi j
{
ÓÓ 
return
ÔÔ 
GenericHash
ÔÔ 
.
ÔÔ 
Hash
ÔÔ 
(
ÔÔ  
key
ÔÔ  #
,
ÔÔ# $
data
ÔÔ% )
.
ÔÔ) *
ToArray
ÔÔ* 1
(
ÔÔ1 2
)
ÔÔ2 3
,
ÔÔ3 4

outputSize
ÔÔ5 ?
)
ÔÔ? @
;
ÔÔ@ A
}
 
}ÚÚ Ûj
o/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/LogoutKeyDerivation.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
public

 
static

 
class

 
LogoutKeyDerivation

 '
{ 
private 
const 
int 
KEY_SIZE 
=  
$num! #
;# $
private 
const 
int 
	HMAC_SIZE 
=  !
$num" $
;$ %
private 
const 
string  
LOGOUT_HMAC_KEY_INFO -
=. /
$str0 I
;I J
private 
const 
string !
LOGOUT_PROOF_KEY_INFO .
=/ 0
$str1 K
;K L
private 
const 
string #
LOG_TAG_LOGOUT_HMAC_KEY 0
=1 2
$str3 F
;F G
private 
const 
string $
LOG_TAG_LOGOUT_PROOF_KEY 1
=2 3
$str4 H
;H I
private 
const 
string (
LOG_MESSAGE_HMAC_KEY_DERIVED 5
=6 7
$str8 |
;| }
private 
const 
string )
LOG_MESSAGE_PROOF_KEY_DERIVED 6
=7 8
$str9 ~
;~ 
private 
const 
string 0
$ERROR_MESSAGE_MASTER_KEY_READ_FAILED =
=> ?
$str@ a
;a b
private 
const 
string 0
$ERROR_MESSAGE_HKDF_DERIVATION_FAILED =
=> ?
$str@ \
;\ ]
public 

static 
Result 
< 
byte 
[ 
] 
,  
SodiumFailure! .
>. /
DeriveLogoutHmacKey0 C
(C D$
SodiumSecureMemoryHandleD \
masterKeyHandle] l
)l m
{ 
byte 
[ 
] 
? 
masterKeyBytes 
=  
null! %
;% &
byte 
[ 
] 
? 
hmacKey 
= 
null 
; 
try   
{!! 	
Result"" 
<"" 
byte"" 
["" 
]"" 
,"" 
SodiumFailure"" (
>""( )

readResult""* 4
=""5 6
masterKeyHandle""7 F
.""F G
	ReadBytes""G P
(""P Q
KEY_SIZE""Q Y
)""Y Z
;""Z [
if## 
(## 

readResult## 
.## 
IsErr##  
)##  !
{$$ 
return%% 
Result%% 
<%% 
byte%% "
[%%" #
]%%# $
,%%$ %
SodiumFailure%%& 3
>%%3 4
.%%4 5
Err%%5 8
(%%8 9
SodiumFailure&& !
.&&! "
InvalidOperation&&" 2
(&&2 3
$"&&3 5
{&&5 60
$ERROR_MESSAGE_MASTER_KEY_READ_FAILED&&6 Z
}&&Z [
$str&&[ ]
{&&] ^

readResult&&^ h
.&&h i
	UnwrapErr&&i r
(&&r s
)&&s t
.&&t u
Message&&u |
}&&| }
"&&} ~
)&&~ 
)	&& Ä
;
&&Ä Å
}'' 
masterKeyBytes)) 
=)) 

readResult)) '
.))' (
Unwrap))( .
()). /
)))/ 0
;))0 1
hmacKey** 
=** 
new** 
byte** 
[** 
KEY_SIZE** '
]**' (
;**( )
try,, 
{-- 
HKDF.. 
... 
	DeriveKey.. 
(.. 
HashAlgorithmName// %
.//% &
SHA256//& ,
,//, -
ikm00 
:00 
masterKeyBytes00 '
,00' (
output11 
:11 
hmacKey11 #
,11# $
salt22 
:22 
null22 
,22 
info33 
:33 
Encoding33 "
.33" #
UTF833# '
.33' (
GetBytes33( 0
(330 1 
LOGOUT_HMAC_KEY_INFO331 E
)33E F
)44 
;44 
string66 
keyFingerprint66 %
=66& ' 
CryptographicHelpers66( <
.66< =$
ComputeSha256Fingerprint66= U
(66U V
hmacKey66V ]
)66] ^
;66^ _
Log77 
.77 
Debug77 
(77 (
LOG_MESSAGE_HMAC_KEY_DERIVED77 6
,776 7#
LOG_TAG_LOGOUT_HMAC_KEY778 O
,77O P
keyFingerprint77Q _
)77_ `
;77` a
byte99 
[99 
]99 
result99 
=99 
hmacKey99  '
;99' (
hmacKey:: 
=:: 
null:: 
;:: 
return;; 
Result;; 
<;; 
byte;; "
[;;" #
];;# $
,;;$ %
SodiumFailure;;& 3
>;;3 4
.;;4 5
Ok;;5 7
(;;7 8
result;;8 >
);;> ?
;;;? @
}<< 
catch== 
(== "
CryptographicException== )
ex==* ,
)==, -
{>> 
return?? 
Result?? 
<?? 
byte?? "
[??" #
]??# $
,??$ %
SodiumFailure??& 3
>??3 4
.??4 5
Err??5 8
(??8 9
SodiumFailure@@ !
.@@! "
InvalidOperation@@" 2
(@@2 3
$"@@3 5
{@@5 60
$ERROR_MESSAGE_HKDF_DERIVATION_FAILED@@6 Z
}@@Z [
$str@@[ ]
{@@] ^
ex@@^ `
.@@` a
Message@@a h
}@@h i
"@@i j
)@@j k
)@@k l
;@@l m
}AA 
}BB 	
finallyCC 
{DD 	
ifEE 
(EE 
masterKeyBytesEE 
!=EE !
nullEE" &
)EE& '
{FF #
CryptographicOperationsGG '
.GG' (

ZeroMemoryGG( 2
(GG2 3
masterKeyBytesGG3 A
)GGA B
;GGB C
}HH 
ifJJ 
(JJ 
hmacKeyJJ 
!=JJ 
nullJJ 
)JJ  
{KK #
CryptographicOperationsLL '
.LL' (

ZeroMemoryLL( 2
(LL2 3
hmacKeyLL3 :
)LL: ;
;LL; <
}MM 
}NN 	
}OO 
publicQQ 

staticQQ 
ResultQQ 
<QQ 
byteQQ 
[QQ 
]QQ 
,QQ  
SodiumFailureQQ! .
>QQ. / 
DeriveLogoutProofKeyQQ0 D
(QQD E$
SodiumSecureMemoryHandleQQE ]
masterKeyHandleQQ^ m
)QQm n
{RR 
byteSS 
[SS 
]SS 
?SS 
masterKeyBytesSS 
=SS  
nullSS! %
;SS% &
byteTT 
[TT 
]TT 
?TT 
proofKeyTT 
=TT 
nullTT 
;TT  
tryVV 
{WW 	
ResultXX 
<XX 
byteXX 
[XX 
]XX 
,XX 
SodiumFailureXX (
>XX( )

readResultXX* 4
=XX5 6
masterKeyHandleXX7 F
.XXF G
	ReadBytesXXG P
(XXP Q
KEY_SIZEXXQ Y
)XXY Z
;XXZ [
ifYY 
(YY 

readResultYY 
.YY 
IsErrYY  
)YY  !
{ZZ 
return[[ 
Result[[ 
<[[ 
byte[[ "
[[[" #
][[# $
,[[$ %
SodiumFailure[[& 3
>[[3 4
.[[4 5
Err[[5 8
([[8 9
SodiumFailure\\ !
.\\! "
InvalidOperation\\" 2
(\\2 3
$"\\3 5
{\\5 60
$ERROR_MESSAGE_MASTER_KEY_READ_FAILED\\6 Z
}\\Z [
$str\\[ ]
{\\] ^

readResult\\^ h
.\\h i
	UnwrapErr\\i r
(\\r s
)\\s t
.\\t u
Message\\u |
}\\| }
"\\} ~
)\\~ 
)	\\ Ä
;
\\Ä Å
}]] 
masterKeyBytes__ 
=__ 

readResult__ '
.__' (
Unwrap__( .
(__. /
)__/ 0
;__0 1
proofKey`` 
=`` 
new`` 
byte`` 
[``  
KEY_SIZE``  (
]``( )
;``) *
trybb 
{cc 
HKDFdd 
.dd 
	DeriveKeydd 
(dd 
HashAlgorithmNameee %
.ee% &
SHA256ee& ,
,ee, -
ikmff 
:ff 
masterKeyBytesff '
,ff' (
outputgg 
:gg 
proofKeygg $
,gg$ %
salthh 
:hh 
nullhh 
,hh 
infoii 
:ii 
Encodingii "
.ii" #
UTF8ii# '
.ii' (
GetBytesii( 0
(ii0 1!
LOGOUT_PROOF_KEY_INFOii1 F
)iiF G
)jj 
;jj 
stringll 
keyFingerprintll %
=ll& ' 
CryptographicHelpersll( <
.ll< =$
ComputeSha256Fingerprintll= U
(llU V
proofKeyllV ^
)ll^ _
;ll_ `
Logmm 
.mm 
Debugmm 
(mm )
LOG_MESSAGE_PROOF_KEY_DERIVEDmm 7
,mm7 8$
LOG_TAG_LOGOUT_PROOF_KEYmm9 Q
,mmQ R
keyFingerprintmmS a
)mma b
;mmb c
byteoo 
[oo 
]oo 
resultoo 
=oo 
proofKeyoo  (
;oo( )
proofKeypp 
=pp 
nullpp 
;pp  
returnqq 
Resultqq 
<qq 
byteqq "
[qq" #
]qq# $
,qq$ %
SodiumFailureqq& 3
>qq3 4
.qq4 5
Okqq5 7
(qq7 8
resultqq8 >
)qq> ?
;qq? @
}rr 
catchss 
(ss "
CryptographicExceptionss )
exss* ,
)ss, -
{tt 
returnuu 
Resultuu 
<uu 
byteuu "
[uu" #
]uu# $
,uu$ %
SodiumFailureuu& 3
>uu3 4
.uu4 5
Erruu5 8
(uu8 9
SodiumFailurevv !
.vv! "
InvalidOperationvv" 2
(vv2 3
$"vv3 5
{vv5 60
$ERROR_MESSAGE_HKDF_DERIVATION_FAILEDvv6 Z
}vvZ [
$strvv[ ]
{vv] ^
exvv^ `
.vv` a
Messagevva h
}vvh i
"vvi j
)vvj k
)vvk l
;vvl m
}ww 
}xx 	
finallyyy 
{zz 	
if{{ 
({{ 
masterKeyBytes{{ 
!={{ !
null{{" &
){{& '
{|| #
CryptographicOperations}} '
.}}' (

ZeroMemory}}( 2
(}}2 3
masterKeyBytes}}3 A
)}}A B
;}}B C
}~~ 
if
ÄÄ 
(
ÄÄ 
proofKey
ÄÄ 
!=
ÄÄ 
null
ÄÄ  
)
ÄÄ  !
{
ÅÅ %
CryptographicOperations
ÇÇ '
.
ÇÇ' (

ZeroMemory
ÇÇ( 2
(
ÇÇ2 3
proofKey
ÇÇ3 ;
)
ÇÇ; <
;
ÇÇ< =
}
ÉÉ 
}
ÑÑ 	
}
ÖÖ 
public
áá 

static
áá 
byte
áá 
[
áá 
]
áá 
ComputeHmac
áá $
(
áá$ %
byte
áá% )
[
áá) *
]
áá* +
key
áá, /
,
áá/ 0
byte
áá1 5
[
áá5 6
]
áá6 7
data
áá8 <
)
áá< =
{
àà 
using
ââ 

HMACSHA256
ââ 
hmac
ââ 
=
ââ 
new
ââ  #

HMACSHA256
ââ$ .
(
ââ. /
key
ââ/ 2
)
ââ2 3
;
ââ3 4
return
ää 
hmac
ää 
.
ää 
ComputeHash
ää 
(
ää  
data
ää  $
)
ää$ %
;
ää% &
}
ãã 
public
çç 

static
çç 
bool
çç 

VerifyHmac
çç !
(
çç! "
byte
çç" &
[
çç& '
]
çç' (
key
çç) ,
,
çç, -
byte
çç. 2
[
çç2 3
]
çç3 4
data
çç5 9
,
çç9 :
byte
çç; ?
[
çç? @
]
çç@ A
expectedHmac
ççB N
)
ççN O
{
éé 
if
èè 

(
èè 
expectedHmac
èè 
.
èè 
Length
èè 
!=
èè  "
	HMAC_SIZE
èè# ,
)
èè, -
{
êê 	
return
ëë 
false
ëë 
;
ëë 
}
íí 	
byte
îî 
[
îî 
]
îî 
computedHmac
îî 
=
îî 
ComputeHmac
îî )
(
îî) *
key
îî* -
,
îî- .
data
îî/ 3
)
îî3 4
;
îî4 5
try
ïï 
{
ññ 	
return
óó %
CryptographicOperations
óó *
.
óó* +
FixedTimeEquals
óó+ :
(
óó: ;
computedHmac
óó; G
,
óóG H
expectedHmac
óóI U
)
óóU V
;
óóV W
}
òò 	
finally
ôô 
{
öö 	%
CryptographicOperations
õõ #
.
õõ# $

ZeroMemory
õõ$ .
(
õõ. /
computedHmac
õõ/ ;
)
õõ; <
;
õõ< =
}
úú 	
}
ùù 
}ûû ä
q/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/IProtocolEventHandler.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
internal 
	interface	 !
IProtocolEventHandler (
{ 
void "
OnProtocolStateChanged	 
(  
uint  $
	connectId% .
). /
;/ 0
} Ô”
v/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/EcliptixSystemIdentityKeys.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
public 
sealed 
class &
EcliptixSystemIdentityKeys .
:/ 0
IDisposable1 <
{ 
private 
readonly 
byte 
[ 
] 
_ed25519PublicKey -
;- .
private 
readonly $
SodiumSecureMemoryHandle -#
_ed25519SecretKeyHandle. E
;E F
private 
readonly $
SodiumSecureMemoryHandle -*
_identityX25519SecretKeyHandle. L
;L M
private 
readonly 
byte 
[ 
] $
_identityX25519PublicKey 4
;4 5
private 
readonly 
uint 
_signedPreKeyId )
;) *
private 
readonly 
byte 
[ 
] 
_signedPreKeyPublic /
;/ 0
private 
readonly $
SodiumSecureMemoryHandle -(
_signedPreKeySecretKeyHandle. J
;J K
private 
readonly 
byte 
[ 
] "
_signedPreKeySignature 2
;2 3
private 
bool 
	_disposed 
; 
private $
SodiumSecureMemoryHandle $
?$ %%
_ephemeralSecretKeyHandle& ?
;? @
private 
byte 
[ 
] 
? %
_ephemeralX25519PublicKey -
;- .
private 
List 
< 
OneTimePreKeyLocal #
># $#
_oneTimePreKeysInternal% <
;< =
private &
EcliptixSystemIdentityKeys &
(& '$
SodiumSecureMemoryHandle  
edSk! %
,% &
byte' +
[+ ,
], -
edPk. 2
,2 3$
SodiumSecureMemoryHandle  
idSk! %
,% &
byte' +
[+ ,
], -
idPk. 2
,2 3
uint 
spkId 
, $
SodiumSecureMemoryHandle ,
spkSk- 2
,2 3
byte4 8
[8 9
]9 :
spkPk; @
,@ A
byteB F
[F G
]G H
spkSigI O
,O P
List   
<   
OneTimePreKeyLocal   
>    
opks  ! %
)  % &
{!! #
_ed25519SecretKeyHandle"" 
=""  !
edSk""" &
;""& '
_ed25519PublicKey## 
=## 
edPk##  
;##  !*
_identityX25519SecretKeyHandle$$ &
=$$' (
idSk$$) -
;$$- .$
_identityX25519PublicKey%%  
=%%! "
idPk%%# '
;%%' (
_signedPreKeyId&& 
=&& 
spkId&& 
;&&  (
_signedPreKeySecretKeyHandle'' $
=''% &
spkSk''' ,
;'', -
_signedPreKeyPublic(( 
=(( 
spkPk(( #
;((# $"
_signedPreKeySignature)) 
=))  
spkSig))! '
;))' (#
_oneTimePreKeysInternal** 
=**  !
opks**" &
;**& '
	_disposed++ 
=++ 
false++ 
;++ 
},, 
public.. 

ReadOnlySpan.. 
<.. 
byte.. 
>.. '
IdentityX25519PublicKeySpan.. 9
=>..: <$
_identityX25519PublicKey..= U
;..U V
public00 

byte00 
[00 
]00 *
GetIdentityX25519PublicKeyCopy00 0
(000 1
)001 2
=>003 5
(006 7
byte007 ;
[00; <
]00< =
)00= >$
_identityX25519PublicKey00> V
.00V W
Clone00W \
(00\ ]
)00] ^
;00^ _
public22 

void22 
Dispose22 
(22 
)22 
{33 
Dispose44 
(44 
true44 
)44 
;44 
GC55 

.55
 
SuppressFinalize55 
(55 
this55  
)55  !
;55! "
}66 
public88 

Result88 
<88 
IdentityKeysState88 #
,88# $#
EcliptixProtocolFailure88% <
>88< =
ToProtoState88> J
(88J K
)88K L
{99 
if:: 

(:: 
	_disposed:: 
):: 
{;; 	
return<< 
Result<< 
<<< 
IdentityKeysState<< +
,<<+ ,#
EcliptixProtocolFailure<<- D
><<D E
.<<E F
Err<<F I
(<<I J#
EcliptixProtocolFailure== '
.==' (
OBJECT_DISPOSED==( 7
(==7 8
nameof==8 >
(==> ?&
EcliptixSystemIdentityKeys==? Y
)==Y Z
)==Z [
)==[ \
;==\ ]
}>> 	
try@@ 
{AA 	
ListBB 
<BB 
OneTimePreKeySecretBB $
>BB$ %
	opkProtosBB& /
=BB0 1
[BB2 3
]BB3 4
;BB4 5
foreachCC 
(CC 
OneTimePreKeyLocalCC '
opkCC( +
inCC, .#
_oneTimePreKeysInternalCC/ F
)CCF G
{DD 
ResultEE 
<EE 

ByteStringEE !
,EE! "
SodiumFailureEE# 0
>EE0 1
privateKeyResultEE2 B
=EEC D#
SecureByteStringInteropFF +
.FF+ ,,
 CreateByteStringFromSecureMemoryFF, L
(FFL M
opkFFM P
.FFP Q
PrivateKeyHandleFFQ a
,FFa b
	ConstantsGG !
.GG! "$
X_25519_PRIVATE_KEY_SIZEGG" :
)GG: ;
;GG; <
ifHH 
(HH 
privateKeyResultHH $
.HH$ %
IsErrHH% *
)HH* +
{II 
returnJJ 
ResultJJ !
<JJ! "
IdentityKeysStateJJ" 3
,JJ3 4#
EcliptixProtocolFailureJJ5 L
>JJL M
.JJM N
ErrJJN Q
(JJQ R#
EcliptixProtocolFailureKK /
.KK/ 0
GenericKK0 7
(KK7 8
stringLL "
.LL" #
FormatLL# )
(LL) *+
EcliptixProtocolFailureMessagesLL* I
.LLI J
IdentityKeysLLJ V
.LLV W*
FAILED_TO_READ_OPK_PRIVATE_KEYLLW u
,LLu v
privateKeyResult	LLw á
.
LLá à
	UnwrapErr
LLà ë
(
LLë í
)
LLí ì
.
LLì î
Message
LLî õ
)
LLõ ú
)
LLú ù
)
LLù û
;
LLû ü
}MM 
	opkProtosOO 
.OO 
AddOO 
(OO 
newOO !
OneTimePreKeySecretOO" 5
{PP 
PreKeyIdQQ 
=QQ 
opkQQ "
.QQ" #
PreKeyIdQQ# +
,QQ+ ,

PrivateKeyRR 
=RR  
privateKeyResultRR! 1
.RR1 2
UnwrapRR2 8
(RR8 9
)RR9 :
,RR: ;
	PublicKeySS 
=SS #
SecureByteStringInteropSS  7
.SS7 8$
CreateByteStringFromSpanSS8 P
(SSP Q
opkSSQ T
.SST U
PublicKeySpanSSU b
)SSb c
}TT 
)TT 
;TT 
}UU 
ResultWW 
<WW 

ByteStringWW 
,WW 
SodiumFailureWW ,
>WW, -
ed25519SecretResultWW. A
=WWB C#
SecureByteStringInteropXX '
.XX' (,
 CreateByteStringFromSecureMemoryXX( H
(XXH I#
_ed25519SecretKeyHandleXXI `
,XX` a
	ConstantsYY 
.YY $
ED_25519_SECRET_KEY_SIZEYY 6
)YY6 7
;YY7 8
ifZZ 
(ZZ 
ed25519SecretResultZZ #
.ZZ# $
IsErrZZ$ )
)ZZ) *
{[[ 
return\\ 
Result\\ 
<\\ 
IdentityKeysState\\ /
,\\/ 0#
EcliptixProtocolFailure\\1 H
>\\H I
.\\I J
Err\\J M
(\\M N#
EcliptixProtocolFailure]] +
.]]+ ,
Generic]], 3
(]]3 4
string^^ 
.^^ 
Format^^ %
(^^% &+
EcliptixProtocolFailureMessages^^& E
.^^E F
IdentityKeys^^F R
.^^R S.
"FAILED_TO_READ_ED_25519_SECRET_KEY^^S u
,^^u v 
ed25519SecretResult	^^w ä
.
^^ä ã
	UnwrapErr
^^ã î
(
^^î ï
)
^^ï ñ
.
^^ñ ó
Message
^^ó û
)
^^û ü
)
^^ü †
)
^^† °
;
^^° ¢
}__ 
Resultaa 
<aa 

ByteStringaa 
,aa 
SodiumFailureaa ,
>aa, -&
identityX25519SecretResultaa. H
=aaI J#
SecureByteStringInteropbb '
.bb' (,
 CreateByteStringFromSecureMemorybb( H
(bbH I*
_identityX25519SecretKeyHandlebbI g
,bbg h
	Constantscc 
.cc $
X_25519_PRIVATE_KEY_SIZEcc 6
)cc6 7
;cc7 8
ifdd 
(dd &
identityX25519SecretResultdd *
.dd* +
IsErrdd+ 0
)dd0 1
{ee 
returnff 
Resultff 
<ff 
IdentityKeysStateff /
,ff/ 0#
EcliptixProtocolFailureff1 H
>ffH I
.ffI J
ErrffJ M
(ffM N#
EcliptixProtocolFailuregg +
.gg+ ,
Genericgg, 3
(gg3 4
stringhh 
.hh 
Formathh %
(hh% &+
EcliptixProtocolFailureMessageshh& E
.hhE F
IdentityKeyshhF R
.hhR S6
*FAILED_TO_READ_IDENTITY_X_25519_SECRET_KEYhhS }
,hh} ~'
identityX25519SecretResult	hh ô
.
hhô ö
	UnwrapErr
hhö £
(
hh£ §
)
hh§ •
.
hh• ¶
Message
hh¶ ≠
)
hh≠ Æ
)
hhÆ Ø
)
hhØ ∞
;
hh∞ ±
}ii 
Resultkk 
<kk 

ByteStringkk 
,kk 
SodiumFailurekk ,
>kk, -$
signedPreKeySecretResultkk. F
=kkG H#
SecureByteStringInteropll '
.ll' (,
 CreateByteStringFromSecureMemoryll( H
(llH I(
_signedPreKeySecretKeyHandlellI e
,lle f
	Constantsmm 
.mm $
X_25519_PRIVATE_KEY_SIZEmm 6
)mm6 7
;mm7 8
ifnn 
(nn $
signedPreKeySecretResultnn (
.nn( )
IsErrnn) .
)nn. /
{oo 
returnpp 
Resultpp 
<pp 
IdentityKeysStatepp /
,pp/ 0#
EcliptixProtocolFailurepp1 H
>ppH I
.ppI J
ErrppJ M
(ppM N#
EcliptixProtocolFailureqq +
.qq+ ,
Genericqq, 3
(qq3 4
stringrr 
.rr 
Formatrr %
(rr% &+
EcliptixProtocolFailureMessagesrr& E
.rrE F
IdentityKeysrrF R
.rrR S0
$FAILED_TO_READ_SIGNED_PRE_KEY_SECRETrrS w
,rrw x%
signedPreKeySecretResult	rry ë
.
rrë í
	UnwrapErr
rrí õ
(
rrõ ú
)
rrú ù
.
rrù û
Message
rrû •
)
rr• ¶
)
rr¶ ß
)
rrß ®
;
rr® ©
}ss 
IdentityKeysStateuu 
protouu #
=uu$ %
newuu& )
(uu) *
)uu* +
{vv 
Ed25519SecretKeyww  
=ww! "
ed25519SecretResultww# 6
.ww6 7
Unwrapww7 =
(ww= >
)ww> ?
,ww? @#
IdentityX25519SecretKeyxx '
=xx( )&
identityX25519SecretResultxx* D
.xxD E
UnwrapxxE K
(xxK L
)xxL M
,xxM N
SignedPreKeySecretyy "
=yy# $$
signedPreKeySecretResultyy% =
.yy= >
Unwrapyy> D
(yyD E
)yyE F
,yyF G
Ed25519PublicKeyzz  
=zz! "#
SecureByteStringInteropzz# :
.zz: ;$
CreateByteStringFromSpanzz; S
(zzS T
_ed25519PublicKeyzzT e
)zze f
,zzf g#
IdentityX25519PublicKey{{ '
={{( )#
SecureByteStringInterop{{* A
.{{A B$
CreateByteStringFromSpan{{B Z
({{Z ['
IdentityX25519PublicKeySpan{{[ v
){{v w
,{{w x
SignedPreKeyId|| 
=||  
_signedPreKeyId||! 0
,||0 1
SignedPreKeyPublic}} "
=}}# $#
SecureByteStringInterop}}% <
.}}< =$
CreateByteStringFromSpan}}= U
(}}U V
_signedPreKeyPublic}}V i
)}}i j
,}}j k!
SignedPreKeySignature~~ %
=~~& '#
SecureByteStringInterop~~( ?
.~~? @$
CreateByteStringFromSpan~~@ X
(~~X Y"
_signedPreKeySignature~~Y o
)~~o p
} 
; 
proto
ÄÄ 
.
ÄÄ 
OneTimePreKeys
ÄÄ  
.
ÄÄ  !
AddRange
ÄÄ! )
(
ÄÄ) *
	opkProtos
ÄÄ* 3
)
ÄÄ3 4
;
ÄÄ4 5
return
ÇÇ 
Result
ÇÇ 
<
ÇÇ 
IdentityKeysState
ÇÇ +
,
ÇÇ+ ,%
EcliptixProtocolFailure
ÇÇ- D
>
ÇÇD E
.
ÇÇE F
Ok
ÇÇF H
(
ÇÇH I
proto
ÇÇI N
)
ÇÇN O
;
ÇÇO P
}
ÉÉ 	
catch
ÑÑ 
(
ÑÑ 
	Exception
ÑÑ 
ex
ÑÑ 
)
ÑÑ 
{
ÖÖ 	
return
ÜÜ 
Result
ÜÜ 
<
ÜÜ 
IdentityKeysState
ÜÜ +
,
ÜÜ+ ,%
EcliptixProtocolFailure
ÜÜ- D
>
ÜÜD E
.
ÜÜE F
Err
ÜÜF I
(
ÜÜI J%
EcliptixProtocolFailure
áá '
.
áá' (
Generic
áá( /
(
áá/ 0-
EcliptixProtocolFailureMessages
áá0 O
.
ááO P
IdentityKeys
ááP \
.
áá\ ]6
'FAILED_TO_EXPORT_IDENTITY_KEYS_TO_PROTOáá] Ñ
,ááÑ Ö
exááÜ à
)ááà â
)ááâ ä
;ááä ã
}
àà 	
}
ââ 
public
ãã 

static
ãã 
Result
ãã 
<
ãã (
EcliptixSystemIdentityKeys
ãã 3
,
ãã3 4%
EcliptixProtocolFailure
ãã5 L
>
ããL M
FromProtoState
ããN \
(
ãã\ ]
IdentityKeysState
ãã] n
proto
ãão t
)
ããt u
{
åå &
SodiumSecureMemoryHandle
çç  
?
çç  !

edSkHandle
çç" ,
=
çç- .
null
çç/ 3
;
çç3 4&
SodiumSecureMemoryHandle
éé  
?
éé  !
idXSkHandle
éé" -
=
éé. /
null
éé0 4
;
éé4 5&
SodiumSecureMemoryHandle
èè  
?
èè  !
spkSkHandle
èè" -
=
èè. /
null
èè0 4
;
èè4 5
List
êê 
<
êê  
OneTimePreKeyLocal
êê 
>
êê  
?
êê  !
opks
êê" &
=
êê' (
[
êê) *
]
êê* +
;
êê+ ,
List
íí 
<
íí 
byte
íí 
[
íí 
]
íí 
>
íí 
opkPkBytesList
íí #
=
íí$ %
[
íí& '
]
íí' (
;
íí( )
try
îî 
{
ïï 	

edSkHandle
ññ 
=
ññ &
SodiumSecureMemoryHandle
ññ 1
.
ññ1 2
Allocate
ññ2 :
(
ññ: ;
proto
ññ; @
.
ññ@ A
Ed25519SecretKey
ññA Q
.
ññQ R
Length
ññR X
)
ññX Y
.
ññY Z
Unwrap
ññZ `
(
ññ` a
)
ñña b
;
ññb c%
SecureByteStringInterop
óó #
.
óó# $.
 CopyFromByteStringToSecureMemory
óó$ D
(
óóD E
proto
óóE J
.
óóJ K
Ed25519SecretKey
óóK [
,
óó[ \

edSkHandle
óó] g
)
óóg h
.
óóh i
Unwrap
óói o
(
óóo p
)
óóp q
;
óóq r
idXSkHandle
ôô 
=
ôô &
SodiumSecureMemoryHandle
ôô 2
.
ôô2 3
Allocate
ôô3 ;
(
ôô; <
proto
ôô< A
.
ôôA B%
IdentityX25519SecretKey
ôôB Y
.
ôôY Z
Length
ôôZ `
)
ôô` a
.
ôôa b
Unwrap
ôôb h
(
ôôh i
)
ôôi j
;
ôôj k%
SecureByteStringInterop
öö #
.
öö# $.
 CopyFromByteStringToSecureMemory
öö$ D
(
ööD E
proto
ööE J
.
ööJ K%
IdentityX25519SecretKey
ööK b
,
ööb c
idXSkHandle
ööd o
)
ööo p
.
õõ 
Unwrap
õõ 
(
õõ 
)
õõ 
;
õõ 
spkSkHandle
ùù 
=
ùù &
SodiumSecureMemoryHandle
ùù 2
.
ùù2 3
Allocate
ùù3 ;
(
ùù; <
proto
ùù< A
.
ùùA B 
SignedPreKeySecret
ùùB T
.
ùùT U
Length
ùùU [
)
ùù[ \
.
ùù\ ]
Unwrap
ùù] c
(
ùùc d
)
ùùd e
;
ùùe f%
SecureByteStringInterop
ûû #
.
ûû# $.
 CopyFromByteStringToSecureMemory
ûû$ D
(
ûûD E
proto
ûûE J
.
ûûJ K 
SignedPreKeySecret
ûûK ]
,
ûû] ^
spkSkHandle
ûû_ j
)
ûûj k
.
ûûk l
Unwrap
ûûl r
(
ûûr s
)
ûûs t
;
ûût u%
SecureByteStringInterop
†† #
.
††# $#
SecureCopyWithCleanup
††$ 9
(
††9 :
proto
††: ?
.
††? @
Ed25519PublicKey
††@ P
,
††P Q
out
††R U
byte
††V Z
[
††Z [
]
††[ \
?
††\ ]
edPk
††^ b
)
††b c
;
††c d%
SecureByteStringInterop
°° #
.
°°# $#
SecureCopyWithCleanup
°°$ 9
(
°°9 :
proto
°°: ?
.
°°? @%
IdentityX25519PublicKey
°°@ W
,
°°W X
out
°°Y \
byte
°°] a
[
°°a b
]
°°b c
?
°°c d
idXPk
°°e j
)
°°j k
;
°°k l%
SecureByteStringInterop
¢¢ #
.
¢¢# $#
SecureCopyWithCleanup
¢¢$ 9
(
¢¢9 :
proto
¢¢: ?
.
¢¢? @ 
SignedPreKeyPublic
¢¢@ R
,
¢¢R S
out
¢¢T W
byte
¢¢X \
[
¢¢\ ]
]
¢¢] ^
?
¢¢^ _
spkPk
¢¢` e
)
¢¢e f
;
¢¢f g%
SecureByteStringInterop
££ #
.
££# $#
SecureCopyWithCleanup
££$ 9
(
££9 :
proto
££: ?
.
££? @#
SignedPreKeySignature
££@ U
,
££U V
out
££W Z
byte
££[ _
[
££_ `
]
££` a
?
££a b
spkSig
££c i
)
££i j
;
££j k
foreach
•• 
(
•• !
OneTimePreKeySecret
•• (
opkProto
••) 1
in
••2 4
proto
••5 :
.
••: ;
OneTimePreKeys
••; I
)
••I J
{
¶¶ &
SodiumSecureMemoryHandle
ßß (
skHandle
ßß) 1
=
ßß2 3&
SodiumSecureMemoryHandle
®® ,
.
®®, -
Allocate
®®- 5
(
®®5 6
opkProto
®®6 >
.
®®> ?

PrivateKey
®®? I
.
®®I J
Length
®®J P
)
®®P Q
.
®®Q R
Unwrap
®®R X
(
®®X Y
)
®®Y Z
;
®®Z [%
SecureByteStringInterop
©© '
.
©©' (.
 CopyFromByteStringToSecureMemory
©©( H
(
©©H I
opkProto
©©I Q
.
©©Q R

PrivateKey
©©R \
,
©©\ ]
skHandle
©©^ f
)
©©f g
.
©©g h
Unwrap
©©h n
(
©©n o
)
©©o p
;
©©p q%
SecureByteStringInterop
´´ '
.
´´' (#
SecureCopyWithCleanup
´´( =
(
´´= >
opkProto
´´> F
.
´´F G
	PublicKey
´´G P
,
´´P Q
out
´´R U
byte
´´V Z
[
´´Z [
]
´´[ \

opkPkBytes
´´] g
)
´´g h
;
´´h i
opkPkBytesList
¨¨ 
.
¨¨ 
Add
¨¨ "
(
¨¨" #

opkPkBytes
¨¨# -
)
¨¨- .
;
¨¨. / 
OneTimePreKeyLocal
ÆÆ "
opk
ÆÆ# &
=
ÆÆ' ( 
OneTimePreKeyLocal
ÆÆ) ;
.
ÆÆ; <
CreateFromParts
ÆÆ< K
(
ÆÆK L
opkProto
ÆÆL T
.
ÆÆT U
PreKeyId
ÆÆU ]
,
ÆÆ] ^
skHandle
ÆÆ_ g
,
ÆÆg h

opkPkBytes
ÆÆi s
)
ÆÆs t
;
ÆÆt u
opks
ØØ 
.
ØØ 
Add
ØØ 
(
ØØ 
opk
ØØ 
)
ØØ 
;
ØØ 
}
∞∞ (
EcliptixSystemIdentityKeys
≤≤ &
keys
≤≤' +
=
≤≤, -
new
≤≤. 1
(
≤≤1 2

edSkHandle
≥≥ 
,
≥≥ 
edPk
≥≥  
,
≥≥  !
idXSkHandle
¥¥ 
,
¥¥ 
idXPk
¥¥ "
,
¥¥" #
proto
µµ 
.
µµ 
SignedPreKeyId
µµ $
,
µµ$ %
spkSkHandle
µµ& 1
,
µµ1 2
spkPk
µµ3 8
,
µµ8 9
spkSig
µµ: @
,
µµ@ A
opks
∂∂ 
)
∂∂ 
;
∂∂ 

edSkHandle
∏∏ 
=
∏∏ 
null
∏∏ 
;
∏∏ 
idXSkHandle
ππ 
=
ππ 
null
ππ 
;
ππ 
spkSkHandle
∫∫ 
=
∫∫ 
null
∫∫ 
;
∫∫ 
opks
ªª 
=
ªª 
null
ªª 
;
ªª 
return
ΩΩ 
Result
ΩΩ 
<
ΩΩ (
EcliptixSystemIdentityKeys
ΩΩ 4
,
ΩΩ4 5%
EcliptixProtocolFailure
ΩΩ6 M
>
ΩΩM N
.
ΩΩN O
Ok
ΩΩO Q
(
ΩΩQ R
keys
ΩΩR V
)
ΩΩV W
;
ΩΩW X
}
ææ 	
catch
øø 
(
øø 
	Exception
øø 
ex
øø 
)
øø 
{
¿¿ 	

edSkHandle
¡¡ 
?
¡¡ 
.
¡¡ 
Dispose
¡¡ 
(
¡¡  
)
¡¡  !
;
¡¡! "
idXSkHandle
¬¬ 
?
¬¬ 
.
¬¬ 
Dispose
¬¬  
(
¬¬  !
)
¬¬! "
;
¬¬" #
spkSkHandle
√√ 
?
√√ 
.
√√ 
Dispose
√√  
(
√√  !
)
√√! "
;
√√" #
if
ƒƒ 
(
ƒƒ 
opks
ƒƒ 
==
ƒƒ 
null
ƒƒ 
)
ƒƒ 
{
≈≈ 
return
∆∆ 
Result
∆∆ 
<
∆∆ (
EcliptixSystemIdentityKeys
∆∆ 8
,
∆∆8 9%
EcliptixProtocolFailure
∆∆: Q
>
∆∆Q R
.
∆∆R S
Err
∆∆S V
(
∆∆V W%
EcliptixProtocolFailure
«« +
.
««+ ,
Generic
««, 3
(
««3 4-
EcliptixProtocolFailureMessages
««4 S
.
««S T
IdentityKeys
««T `
.
««` a,
FAILED_TO_REHYDRATE_FROM_PROTO
««a 
,«« Ä
ex««Å É
)««É Ñ
)««Ñ Ö
;««Ö Ü
}
»» 
foreach
   
(
    
OneTimePreKeyLocal
   '
k
  ( )
in
  * ,
opks
  - 1
)
  1 2
{
ÀÀ 
k
ÃÃ 
.
ÃÃ 
Dispose
ÃÃ 
(
ÃÃ 
)
ÃÃ 
;
ÃÃ 
}
ÕÕ 
return
œœ 
Result
œœ 
<
œœ (
EcliptixSystemIdentityKeys
œœ 4
,
œœ4 5%
EcliptixProtocolFailure
œœ6 M
>
œœM N
.
œœN O
Err
œœO R
(
œœR S%
EcliptixProtocolFailure
–– '
.
––' (
Generic
––( /
(
––/ 0-
EcliptixProtocolFailureMessages
––0 O
.
––O P
IdentityKeys
––P \
.
––\ ],
FAILED_TO_REHYDRATE_FROM_PROTO
––] {
,
––{ |
ex
––} 
)–– Ä
)––Ä Å
;––Å Ç
}
—— 	
finally
““ 
{
”” 	
foreach
‘‘ 
(
‘‘ 
byte
‘‘ 
[
‘‘ 
]
‘‘ 
pkBytes
‘‘ #
in
‘‘$ &
opkPkBytesList
‘‘' 5
)
‘‘5 6
{
’’ 
SodiumInterop
÷÷ 
.
÷÷ 

SecureWipe
÷÷ (
(
÷÷( )
pkBytes
÷÷) 0
)
÷÷0 1
;
÷÷1 2
}
◊◊ 
}
ÿÿ 	
}
ŸŸ 
public
€€ 

static
€€ 
Result
€€ 
<
€€ (
EcliptixSystemIdentityKeys
€€ 3
,
€€3 4%
EcliptixProtocolFailure
€€5 L
>
€€L M
Create
€€N T
(
€€T U
uint
€€U Y
oneTimeKeyCount
€€Z i
)
€€i j
{
‹‹ 
if
›› 

(
›› 
oneTimeKeyCount
›› 
>
›› 
int
›› !
.
››! "
MaxValue
››" *
)
››* +
{
ﬁﬁ 	
return
ﬂﬂ 
Result
ﬂﬂ 
<
ﬂﬂ (
EcliptixSystemIdentityKeys
ﬂﬂ 4
,
ﬂﬂ4 5%
EcliptixProtocolFailure
ﬂﬂ6 M
>
ﬂﬂM N
.
ﬂﬂN O
Err
ﬂﬂO R
(
ﬂﬂR S%
EcliptixProtocolFailure
‡‡ '
.
‡‡' (
InvalidInput
‡‡( 4
(
‡‡4 5-
EcliptixProtocolFailureMessages
‡‡5 T
.
‡‡T U
IdentityKeys
‡‡U a
.
‡‡a b0
!ONE_TIME_KEY_COUNT_EXCEEDS_LIMITS‡‡b É
)‡‡É Ñ
)‡‡Ñ Ö
;‡‡Ö Ü
}
·· 	&
SodiumSecureMemoryHandle
„„  
?
„„  !

edSkHandle
„„" ,
=
„„- .
null
„„/ 3
;
„„3 4&
SodiumSecureMemoryHandle
‰‰  
?
‰‰  !
idXSkHandle
‰‰" -
=
‰‰. /
null
‰‰0 4
;
‰‰4 5&
SodiumSecureMemoryHandle
ÂÂ  
?
ÂÂ  !
spkSkHandle
ÂÂ" -
=
ÂÂ. /
null
ÂÂ0 4
;
ÂÂ4 5
List
ÊÊ 
<
ÊÊ  
OneTimePreKeyLocal
ÊÊ 
>
ÊÊ  
?
ÊÊ  !
opks
ÊÊ" &
=
ÊÊ' (
null
ÊÊ) -
;
ÊÊ- .
try
ËË 
{
ÈÈ 	
Result
ÍÍ 
<
ÍÍ 
(
ÍÍ &
SodiumSecureMemoryHandle
ÍÍ ,
skHandle
ÍÍ- 5
,
ÍÍ5 6
byte
ÍÍ7 ;
[
ÍÍ; <
]
ÍÍ< =
pk
ÍÍ> @
)
ÍÍ@ A
,
ÍÍA B%
EcliptixProtocolFailure
ÍÍC Z
>
ÍÍZ [
edKeysResult
ÍÍ\ h
=
ÍÍi j!
GenerateEd25519Keys
ÎÎ #
(
ÎÎ# $
)
ÎÎ$ %
;
ÎÎ% &
if
ÏÏ 
(
ÏÏ 
edKeysResult
ÏÏ 
.
ÏÏ 
IsErr
ÏÏ "
)
ÏÏ" #
{
ÌÌ 
return
ÓÓ 
Result
ÓÓ 
<
ÓÓ (
EcliptixSystemIdentityKeys
ÓÓ 8
,
ÓÓ8 9%
EcliptixProtocolFailure
ÓÓ: Q
>
ÓÓQ R
.
ÓÓR S
Err
ÓÓS V
(
ÓÓV W
edKeysResult
ÓÓW c
.
ÓÓc d
	UnwrapErr
ÓÓd m
(
ÓÓm n
)
ÓÓn o
)
ÓÓo p
;
ÓÓp q
}
ÔÔ 
(
ÒÒ 

edSkHandle
ÒÒ 
,
ÒÒ 
byte
ÒÒ 
[
ÒÒ 
]
ÒÒ 
edPk
ÒÒ  $
)
ÒÒ$ %
=
ÒÒ& '
edKeysResult
ÒÒ( 4
.
ÒÒ4 5
Unwrap
ÒÒ5 ;
(
ÒÒ; <
)
ÒÒ< =
;
ÒÒ= >
Result
ÛÛ 
<
ÛÛ 
(
ÛÛ &
SodiumSecureMemoryHandle
ÛÛ ,
skHandle
ÛÛ- 5
,
ÛÛ5 6
byte
ÛÛ7 ;
[
ÛÛ; <
]
ÛÛ< =
pk
ÛÛ> @
)
ÛÛ@ A
,
ÛÛA B%
EcliptixProtocolFailure
ÛÛC Z
>
ÛÛZ [
idKeysResult
ÛÛ\ h
=
ÛÛi j(
GenerateX25519IdentityKeys
ÙÙ *
(
ÙÙ* +
)
ÙÙ+ ,
;
ÙÙ, -
if
ıı 
(
ıı 
idKeysResult
ıı 
.
ıı 
IsErr
ıı "
)
ıı" #
{
ˆˆ 

edSkHandle
˜˜ 
.
˜˜ 
Dispose
˜˜ "
(
˜˜" #
)
˜˜# $
;
˜˜$ %
return
¯¯ 
Result
¯¯ 
<
¯¯ (
EcliptixSystemIdentityKeys
¯¯ 8
,
¯¯8 9%
EcliptixProtocolFailure
¯¯: Q
>
¯¯Q R
.
¯¯R S
Err
¯¯S V
(
¯¯V W
idKeysResult
¯¯W c
.
¯¯c d
	UnwrapErr
¯¯d m
(
¯¯m n
)
¯¯n o
)
¯¯o p
;
¯¯p q
}
˘˘ 
(
˚˚ 
idXSkHandle
˚˚ 
,
˚˚ 
byte
˚˚ 
[
˚˚ 
]
˚˚  
idXPk
˚˚! &
)
˚˚& '
=
˚˚( )
idKeysResult
˚˚* 6
.
˚˚6 7
Unwrap
˚˚7 =
(
˚˚= >
)
˚˚> ?
;
˚˚? @
uint
˝˝ 
spkId
˝˝ 
=
˝˝ 
Helpers
˝˝  
.
˝˝  !"
GenerateRandomUInt32
˝˝! 5
(
˝˝5 6
)
˝˝6 7
;
˝˝7 8
Result
˛˛ 
<
˛˛ 
(
˛˛ &
SodiumSecureMemoryHandle
˛˛ ,
skHandle
˛˛- 5
,
˛˛5 6
byte
˛˛7 ;
[
˛˛; <
]
˛˛< =
pk
˛˛> @
)
˛˛@ A
,
˛˛A B%
EcliptixProtocolFailure
˛˛C Z
>
˛˛Z [
spkKeysResult
˛˛\ i
=
˛˛j k(
GenerateX25519SignedPreKey
ˇˇ *
(
ˇˇ* +
spkId
ˇˇ+ 0
)
ˇˇ0 1
;
ˇˇ1 2
if
ÄÄ 
(
ÄÄ 
spkKeysResult
ÄÄ 
.
ÄÄ 
IsErr
ÄÄ #
)
ÄÄ# $
{
ÅÅ 

edSkHandle
ÇÇ 
.
ÇÇ 
Dispose
ÇÇ "
(
ÇÇ" #
)
ÇÇ# $
;
ÇÇ$ %
idXSkHandle
ÉÉ 
.
ÉÉ 
Dispose
ÉÉ #
(
ÉÉ# $
)
ÉÉ$ %
;
ÉÉ% &
return
ÑÑ 
Result
ÑÑ 
<
ÑÑ (
EcliptixSystemIdentityKeys
ÑÑ 8
,
ÑÑ8 9%
EcliptixProtocolFailure
ÑÑ: Q
>
ÑÑQ R
.
ÑÑR S
Err
ÑÑS V
(
ÑÑV W
spkKeysResult
ÑÑW d
.
ÑÑd e
	UnwrapErr
ÑÑe n
(
ÑÑn o
)
ÑÑo p
)
ÑÑp q
;
ÑÑq r
}
ÖÖ 
(
áá 
spkSkHandle
áá 
,
áá 
byte
áá 
[
áá 
]
áá  
spkPk
áá! &
)
áá& '
=
áá( )
spkKeysResult
áá* 7
.
áá7 8
Unwrap
áá8 >
(
áá> ?
)
áá? @
;
áá@ A
Result
ââ 
<
ââ 
byte
ââ 
[
ââ 
]
ââ 
,
ââ %
EcliptixProtocolFailure
ââ 2
>
ââ2 3
signatureResult
ââ4 C
=
ââD E
SignSignedPreKey
ââF V
(
ââV W

edSkHandle
ââW a
!
ââa b
,
ââb c
spkPk
ââd i
!
ââi j
)
ââj k
;
ââk l
if
ää 
(
ää 
signatureResult
ää 
.
ää  
IsErr
ää  %
)
ää% &
{
ãã 

edSkHandle
åå 
.
åå 
Dispose
åå "
(
åå" #
)
åå# $
;
åå$ %
idXSkHandle
çç 
.
çç 
Dispose
çç #
(
çç# $
)
çç$ %
;
çç% &
spkSkHandle
éé 
.
éé 
Dispose
éé #
(
éé# $
)
éé$ %
;
éé% &
return
èè 
Result
èè 
<
èè (
EcliptixSystemIdentityKeys
èè 8
,
èè8 9%
EcliptixProtocolFailure
èè: Q
>
èèQ R
.
èèR S
Err
èèS V
(
èèV W
signatureResult
èèW f
.
èèf g
	UnwrapErr
èèg p
(
èèp q
)
èèq r
)
èèr s
;
èès t
}
êê 
byte
íí 
[
íí 
]
íí 
?
íí 
spkSig
íí 
=
íí 
signatureResult
íí ,
.
íí, -
Unwrap
íí- 3
(
íí3 4
)
íí4 5
;
íí5 6
Result
îî 
<
îî 
List
îî 
<
îî  
OneTimePreKeyLocal
îî *
>
îî* +
,
îî+ ,%
EcliptixProtocolFailure
îî- D
>
îîD E

opksResult
îîF P
=
îîQ R$
GenerateOneTimePreKeys
ïï &
(
ïï& '
oneTimeKeyCount
ïï' 6
)
ïï6 7
;
ïï7 8
if
ññ 
(
ññ 

opksResult
ññ 
.
ññ 
IsErr
ññ  
)
ññ  !
{
óó 

edSkHandle
òò 
.
òò 
Dispose
òò "
(
òò" #
)
òò# $
;
òò$ %
idXSkHandle
ôô 
.
ôô 
Dispose
ôô #
(
ôô# $
)
ôô$ %
;
ôô% &
spkSkHandle
öö 
.
öö 
Dispose
öö #
(
öö# $
)
öö$ %
;
öö% &
return
õõ 
Result
õõ 
<
õõ (
EcliptixSystemIdentityKeys
õõ 8
,
õõ8 9%
EcliptixProtocolFailure
õõ: Q
>
õõQ R
.
õõR S
Err
õõS V
(
õõV W

opksResult
õõW a
.
õõa b
	UnwrapErr
õõb k
(
õõk l
)
õõl m
)
õõm n
;
õõn o
}
úú 
opks
ûû 
=
ûû 

opksResult
ûû 
.
ûû 
Unwrap
ûû $
(
ûû$ %
)
ûû% &
;
ûû& '(
EcliptixSystemIdentityKeys
†† &
material
††' /
=
††0 1
new
††2 5
(
††5 6

edSkHandle
††6 @
,
††@ A
edPk
††B F
,
††F G
idXSkHandle
††H S
,
††S T
idXPk
††U Z
,
††Z [
spkId
††\ a
,
††a b
spkSkHandle
°° 
,
°° 
spkPk
°° "
,
°°" #
spkSig
°°$ *
,
°°* +
opks
°°, 0
)
°°0 1
;
°°1 2

edSkHandle
¢¢ 
=
¢¢ 
null
¢¢ 
;
¢¢ 
idXSkHandle
££ 
=
££ 
null
££ 
;
££ 
spkSkHandle
§§ 
=
§§ 
null
§§ 
;
§§ 
opks
•• 
=
•• 
null
•• 
;
•• 
return
ßß 
Result
ßß 
<
ßß (
EcliptixSystemIdentityKeys
ßß 4
,
ßß4 5%
EcliptixProtocolFailure
ßß6 M
>
ßßM N
.
ßßN O
Ok
ßßO Q
(
ßßQ R
material
ßßR Z
)
ßßZ [
;
ßß[ \
}
®® 	
catch
©© 
(
©© 
	Exception
©© 
ex
©© 
)
©© 
{
™™ 	

edSkHandle
´´ 
?
´´ 
.
´´ 
Dispose
´´ 
(
´´  
)
´´  !
;
´´! "
idXSkHandle
¨¨ 
?
¨¨ 
.
¨¨ 
Dispose
¨¨  
(
¨¨  !
)
¨¨! "
;
¨¨" #
spkSkHandle
≠≠ 
?
≠≠ 
.
≠≠ 
Dispose
≠≠  
(
≠≠  !
)
≠≠! "
;
≠≠" #
if
ÆÆ 
(
ÆÆ 
opks
ÆÆ 
==
ÆÆ 
null
ÆÆ 
)
ÆÆ 
{
ØØ 
return
∞∞ 
Result
∞∞ 
<
∞∞ (
EcliptixSystemIdentityKeys
∞∞ 8
,
∞∞8 9%
EcliptixProtocolFailure
∞∞: Q
>
∞∞Q R
.
∞∞R S
Err
∞∞S V
(
∞∞V W%
EcliptixProtocolFailure
±± +
.
±±+ ,
Generic
±±, 3
(
±±3 4
string
±±4 :
.
±±: ;
Format
±±; A
(
±±A B-
EcliptixProtocolFailureMessages
±±B a
.
±±a b
IdentityKeys
±±b n
.
±±n o?
0UNEXPECTED_ERROR_INITIALIZING_LOCAL_KEY_MATERIAL±±o ü
,±±ü †
ex±±° £
.±±£ §
Message±±§ ´
)±±´ ¨
,±±¨ ≠
ex
≤≤ 
)
≤≤ 
)
≤≤ 
;
≤≤ 
}
≥≥ 
foreach
µµ 
(
µµ  
OneTimePreKeyLocal
µµ '
opk
µµ( +
in
µµ, .
opks
µµ/ 3
)
µµ3 4
{
∂∂ 
opk
∑∑ 
.
∑∑ 
Dispose
∑∑ 
(
∑∑ 
)
∑∑ 
;
∑∑ 
}
∏∏ 
return
∫∫ 
Result
∫∫ 
<
∫∫ (
EcliptixSystemIdentityKeys
∫∫ 4
,
∫∫4 5%
EcliptixProtocolFailure
∫∫6 M
>
∫∫M N
.
∫∫N O
Err
∫∫O R
(
∫∫R S%
EcliptixProtocolFailure
ªª '
.
ªª' (
Generic
ªª( /
(
ªª/ 0
string
ªª0 6
.
ªª6 7
Format
ªª7 =
(
ªª= >-
EcliptixProtocolFailureMessages
ªª> ]
.
ªª] ^
IdentityKeys
ªª^ j
.
ªªj k?
0UNEXPECTED_ERROR_INITIALIZING_LOCAL_KEY_MATERIALªªk õ
,ªªõ ú
exªªù ü
.ªªü †
Messageªª† ß
)ªªß ®
,ªª® ©
exªª™ ¨
)ªª¨ ≠
)ªª≠ Æ
;ªªÆ Ø
}
ºº 	
}
ΩΩ 
public
øø 

static
øø 
Result
øø 
<
øø (
EcliptixSystemIdentityKeys
øø 3
,
øø3 4%
EcliptixProtocolFailure
øø5 L
>
øøL M!
CreateFromMasterKey
¿¿ 
(
¿¿ 
byte
¿¿  
[
¿¿  !
]
¿¿! "
	masterKey
¿¿# ,
,
¿¿, -
string
¿¿. 4
membershipId
¿¿5 A
,
¿¿A B
uint
¿¿C G
oneTimeKeyCount
¿¿H W
)
¿¿W X
{
¡¡ &
SodiumSecureMemoryHandle
¬¬  
?
¬¬  !

edSkHandle
¬¬" ,
=
¬¬- .
null
¬¬/ 3
;
¬¬3 4&
SodiumSecureMemoryHandle
√√  
?
√√  !
idXSkHandle
√√" -
=
√√. /
null
√√0 4
;
√√4 5&
SodiumSecureMemoryHandle
ƒƒ  
?
ƒƒ  !
spkSkHandle
ƒƒ" -
=
ƒƒ. /
null
ƒƒ0 4
;
ƒƒ4 5
List
≈≈ 
<
≈≈  
OneTimePreKeyLocal
≈≈ 
>
≈≈  
?
≈≈  !
opks
≈≈" &
=
≈≈' (
null
≈≈) -
;
≈≈- .
byte
∆∆ 
[
∆∆ 
]
∆∆ 
?
∆∆ 
ed25519Seed
∆∆ 
=
∆∆ 
null
∆∆ "
;
∆∆" #
byte
«« 
[
«« 
]
«« 
?
«« 

x25519Seed
«« 
=
«« 
null
«« !
;
««! "
try
…… 
{
   	
ed25519Seed
ÀÀ 
=
ÀÀ !
MasterKeyDerivation
ÀÀ -
.
ÀÀ- .
DeriveEd25519Seed
ÀÀ. ?
(
ÀÀ? @
	masterKey
ÀÀ@ I
,
ÀÀI J
membershipId
ÀÀK W
)
ÀÀW X
;
ÀÀX Y
KeyPair
ÃÃ 
	edKeyPair
ÃÃ 
=
ÃÃ 
PublicKeyAuth
ÃÃ  -
.
ÃÃ- .
GenerateKeyPair
ÃÃ. =
(
ÃÃ= >
ed25519Seed
ÃÃ> I
)
ÃÃI J
;
ÃÃJ K

edSkHandle
ŒŒ 
=
ŒŒ &
SodiumSecureMemoryHandle
ŒŒ 1
.
ŒŒ1 2
Allocate
ŒŒ2 :
(
ŒŒ: ;
	Constants
ŒŒ; D
.
ŒŒD E&
ED_25519_SECRET_KEY_SIZE
ŒŒE ]
)
ŒŒ] ^
.
ŒŒ^ _
Unwrap
ŒŒ_ e
(
ŒŒe f
)
ŒŒf g
;
ŒŒg h

edSkHandle
œœ 
.
œœ 
Write
œœ 
(
œœ 
	edKeyPair
œœ &
.
œœ& '

PrivateKey
œœ' 1
)
œœ1 2
.
œœ2 3
Unwrap
œœ3 9
(
œœ9 :
)
œœ: ;
;
œœ; <
SodiumInterop
–– 
.
–– 

SecureWipe
–– $
(
––$ %
	edKeyPair
––% .
.
––. /

PrivateKey
––/ 9
)
––9 :
;
––: ;

x25519Seed
““ 
=
““ !
MasterKeyDerivation
““ ,
.
““, -
DeriveX25519Seed
““- =
(
““= >
	masterKey
““> G
,
““G H
membershipId
““I U
)
““U V
;
““V W
idXSkHandle
”” 
=
”” &
SodiumSecureMemoryHandle
”” 2
.
””2 3
Allocate
””3 ;
(
””; <
	Constants
””< E
.
””E F&
X_25519_PRIVATE_KEY_SIZE
””F ^
)
””^ _
.
””_ `
Unwrap
””` f
(
””f g
)
””g h
;
””h i
idXSkHandle
‘‘ 
.
‘‘ 
Write
‘‘ 
(
‘‘ 

x25519Seed
‘‘ (
)
‘‘( )
.
‘‘) *
Unwrap
‘‘* 0
(
‘‘0 1
)
‘‘1 2
;
‘‘2 3
byte
÷÷ 
[
÷÷ 
]
÷÷ 
x25519PublicKey
÷÷ "
=
÷÷# $

ScalarMult
÷÷% /
.
÷÷/ 0
Base
÷÷0 4
(
÷÷4 5

x25519Seed
÷÷5 ?
)
÷÷? @
;
÷÷@ A
byte
ÿÿ 
[
ÿÿ 
]
ÿÿ 
spkSeed
ÿÿ 
=
ÿÿ !
MasterKeyDerivation
ÿÿ 0
.
ÿÿ0 1$
DeriveSignedPreKeySeed
ÿÿ1 G
(
ÿÿG H
	masterKey
ÿÿH Q
,
ÿÿQ R
membershipId
ÿÿS _
)
ÿÿ_ `
;
ÿÿ` a
uint
ŸŸ 
spkId
ŸŸ 
=
ŸŸ 
BitConverter
ŸŸ %
.
ŸŸ% &
ToUInt32
ŸŸ& .
(
ŸŸ. /
spkSeed
ŸŸ/ 6
,
ŸŸ6 7
$num
ŸŸ8 9
)
ŸŸ9 :
;
ŸŸ: ;
byte
⁄⁄ 
[
⁄⁄ 
]
⁄⁄ 
spkPrivateKey
⁄⁄  
=
⁄⁄! "
new
⁄⁄# &
byte
⁄⁄' +
[
⁄⁄+ ,
	Constants
⁄⁄, 5
.
⁄⁄5 6&
X_25519_PRIVATE_KEY_SIZE
⁄⁄6 N
]
⁄⁄N O
;
⁄⁄O P
Array
€€ 
.
€€ 
Copy
€€ 
(
€€ 
spkSeed
€€ 
,
€€ 
$num
€€  !
,
€€! "
spkPrivateKey
€€# 0
,
€€0 1
$num
€€2 3
,
€€3 4
	Constants
€€5 >
.
€€> ?&
X_25519_PRIVATE_KEY_SIZE
€€? W
)
€€W X
;
€€X Y
byte
‹‹ 
[
‹‹ 
]
‹‹ 
spkPk
‹‹ 
=
‹‹ 

ScalarMult
‹‹ %
.
‹‹% &
Base
‹‹& *
(
‹‹* +
spkPrivateKey
‹‹+ 8
)
‹‹8 9
;
‹‹9 :
spkSkHandle
ﬁﬁ 
=
ﬁﬁ &
SodiumSecureMemoryHandle
ﬁﬁ 2
.
ﬁﬁ2 3
Allocate
ﬁﬁ3 ;
(
ﬁﬁ; <
	Constants
ﬁﬁ< E
.
ﬁﬁE F&
X_25519_PRIVATE_KEY_SIZE
ﬁﬁF ^
)
ﬁﬁ^ _
.
ﬁﬁ_ `
Unwrap
ﬁﬁ` f
(
ﬁﬁf g
)
ﬁﬁg h
;
ﬁﬁh i
spkSkHandle
ﬂﬂ 
.
ﬂﬂ 
Write
ﬂﬂ 
(
ﬂﬂ 
spkPrivateKey
ﬂﬂ +
)
ﬂﬂ+ ,
.
ﬂﬂ, -
Unwrap
ﬂﬂ- 3
(
ﬂﬂ3 4
)
ﬂﬂ4 5
;
ﬂﬂ5 6
SodiumInterop
‡‡ 
.
‡‡ 

SecureWipe
‡‡ $
(
‡‡$ %
spkPrivateKey
‡‡% 2
)
‡‡2 3
;
‡‡3 4
SodiumInterop
·· 
.
·· 

SecureWipe
·· $
(
··$ %
spkSeed
··% ,
)
··, -
;
··- .
Result
„„ 
<
„„ 
byte
„„ 
[
„„ 
]
„„ 
,
„„ %
EcliptixProtocolFailure
„„ 2
>
„„2 3
signatureResult
„„4 C
=
„„D E
SignSignedPreKey
„„F V
(
„„V W

edSkHandle
„„W a
,
„„a b
spkPk
„„c h
)
„„h i
;
„„i j
if
‰‰ 
(
‰‰ 
signatureResult
‰‰ 
.
‰‰  
IsErr
‰‰  %
)
‰‰% &
{
ÂÂ 

edSkHandle
ÊÊ 
.
ÊÊ 
Dispose
ÊÊ "
(
ÊÊ" #
)
ÊÊ# $
;
ÊÊ$ %
idXSkHandle
ÁÁ 
.
ÁÁ 
Dispose
ÁÁ #
(
ÁÁ# $
)
ÁÁ$ %
;
ÁÁ% &
spkSkHandle
ËË 
.
ËË 
Dispose
ËË #
(
ËË# $
)
ËË$ %
;
ËË% &
return
ÈÈ 
Result
ÈÈ 
<
ÈÈ (
EcliptixSystemIdentityKeys
ÈÈ 8
,
ÈÈ8 9%
EcliptixProtocolFailure
ÈÈ: Q
>
ÈÈQ R
.
ÈÈR S
Err
ÈÈS V
(
ÈÈV W
signatureResult
ÈÈW f
.
ÈÈf g
	UnwrapErr
ÈÈg p
(
ÈÈp q
)
ÈÈq r
)
ÈÈr s
;
ÈÈs t
}
ÍÍ 
byte
ÏÏ 
[
ÏÏ 
]
ÏÏ 
spkSig
ÏÏ 
=
ÏÏ 
signatureResult
ÏÏ +
.
ÏÏ+ ,
Unwrap
ÏÏ, 2
(
ÏÏ2 3
)
ÏÏ3 4
;
ÏÏ4 5
Result
ÓÓ 
<
ÓÓ 
List
ÓÓ 
<
ÓÓ  
OneTimePreKeyLocal
ÓÓ *
>
ÓÓ* +
,
ÓÓ+ ,%
EcliptixProtocolFailure
ÓÓ- D
>
ÓÓD E

opksResult
ÓÓF P
=
ÓÓQ R$
GenerateOneTimePreKeys
ÔÔ &
(
ÔÔ& '
oneTimeKeyCount
ÔÔ' 6
)
ÔÔ6 7
;
ÔÔ7 8
if
 
(
 

opksResult
 
.
 
IsErr
  
)
  !
{
ÒÒ 

edSkHandle
ÚÚ 
.
ÚÚ 
Dispose
ÚÚ "
(
ÚÚ" #
)
ÚÚ# $
;
ÚÚ$ %
idXSkHandle
ÛÛ 
.
ÛÛ 
Dispose
ÛÛ #
(
ÛÛ# $
)
ÛÛ$ %
;
ÛÛ% &
spkSkHandle
ÙÙ 
.
ÙÙ 
Dispose
ÙÙ #
(
ÙÙ# $
)
ÙÙ$ %
;
ÙÙ% &
return
ıı 
Result
ıı 
<
ıı (
EcliptixSystemIdentityKeys
ıı 8
,
ıı8 9%
EcliptixProtocolFailure
ıı: Q
>
ııQ R
.
ııR S
Err
ııS V
(
ııV W

opksResult
ııW a
.
ııa b
	UnwrapErr
ııb k
(
ıık l
)
ııl m
)
ıım n
;
ıın o
}
ˆˆ 
opks
¯¯ 
=
¯¯ 

opksResult
¯¯ 
.
¯¯ 
Unwrap
¯¯ $
(
¯¯$ %
)
¯¯% &
;
¯¯& '(
EcliptixSystemIdentityKeys
˙˙ &
keys
˙˙' +
=
˙˙, -
new
˙˙. 1
(
˙˙1 2

edSkHandle
˚˚ 
,
˚˚ 
	edKeyPair
˚˚ %
.
˚˚% &
	PublicKey
˚˚& /
,
˚˚/ 0
idXSkHandle
¸¸ 
,
¸¸ 
x25519PublicKey
¸¸ ,
,
¸¸, -
spkId
˝˝ 
,
˝˝ 
spkSkHandle
˝˝ "
,
˝˝" #
spkPk
˝˝$ )
,
˝˝) *
spkSig
˝˝+ 1
,
˝˝1 2
opks
˛˛ 
)
ˇˇ 
;
ˇˇ 

edSkHandle
ÅÅ 
=
ÅÅ 
null
ÅÅ 
;
ÅÅ 
idXSkHandle
ÇÇ 
=
ÇÇ 
null
ÇÇ 
;
ÇÇ 
spkSkHandle
ÉÉ 
=
ÉÉ 
null
ÉÉ 
;
ÉÉ 
opks
ÑÑ 
=
ÑÑ 
null
ÑÑ 
;
ÑÑ 
return
ÜÜ 
Result
ÜÜ 
<
ÜÜ (
EcliptixSystemIdentityKeys
ÜÜ 4
,
ÜÜ4 5%
EcliptixProtocolFailure
ÜÜ6 M
>
ÜÜM N
.
ÜÜN O
Ok
ÜÜO Q
(
ÜÜQ R
keys
ÜÜR V
)
ÜÜV W
;
ÜÜW X
}
áá 	
finally
àà 
{
ââ 	
if
ää 
(
ää 
ed25519Seed
ää 
!=
ää 
null
ää #
)
ää# $
{
ãã 
SodiumInterop
åå 
.
åå 

SecureWipe
åå (
(
åå( )
ed25519Seed
åå) 4
)
åå4 5
;
åå5 6
}
çç 
if
èè 
(
èè 

x25519Seed
èè 
!=
èè 
null
èè "
)
èè" #
{
êê 
SodiumInterop
ëë 
.
ëë 

SecureWipe
ëë (
(
ëë( )

x25519Seed
ëë) 3
)
ëë3 4
;
ëë4 5
}
íí 

edSkHandle
îî 
?
îî 
.
îî 
Dispose
îî 
(
îî  
)
îî  !
;
îî! "
idXSkHandle
ïï 
?
ïï 
.
ïï 
Dispose
ïï  
(
ïï  !
)
ïï! "
;
ïï" #
spkSkHandle
ññ 
?
ññ 
.
ññ 
Dispose
ññ  
(
ññ  !
)
ññ! "
;
ññ" #
if
óó 
(
óó 
opks
óó 
!=
óó 
null
óó 
)
óó 
{
òò 
foreach
ôô 
(
ôô  
OneTimePreKeyLocal
ôô +
opk
ôô, /
in
ôô0 2
opks
ôô3 7
)
ôô7 8
{
öö 
opk
õõ 
.
õõ 
Dispose
õõ 
(
õõ  
)
õõ  !
;
õõ! "
}
úú 
}
ùù 
}
ûû 	
}
üü 
private
°° 
static
°° 
Result
°° 
<
°° 
(
°° &
SodiumSecureMemoryHandle
°° 3
skHandle
°°4 <
,
°°< =
byte
°°> B
[
°°B C
]
°°C D
pk
°°E G
)
°°G H
,
°°H I%
EcliptixProtocolFailure
°°J a
>
°°a b!
GenerateEd25519Keys
°°c v
(
°°v w
)
°°w x
{
¢¢ &
SodiumSecureMemoryHandle
££  
?
££  !
skHandle
££" *
;
££* +
byte
§§ 
[
§§ 
]
§§ 
?
§§ 
skBytes
§§ 
=
§§ 
null
§§ 
;
§§ 
try
•• 
{
¶¶ 	
return
ßß 
Result
ßß 
<
ßß 
(
ßß &
SodiumSecureMemoryHandle
ßß 3
,
ßß3 4
byte
ßß5 9
[
ßß9 :
]
ßß: ;
)
ßß; <
,
ßß< =%
EcliptixProtocolFailure
ßß> U
>
ßßU V
.
ßßV W
Try
ßßW Z
(
ßßZ [
(
ßß[ \
)
ßß\ ]
=>
ßß^ `
{
®® 
KeyPair
©© 
	edKeyPair
©© !
=
©©" #
PublicKeyAuth
©©$ 1
.
©©1 2
GenerateKeyPair
©©2 A
(
©©A B
)
©©B C
;
©©C D
skBytes
™™ 
=
™™ 
	edKeyPair
™™ #
.
™™# $

PrivateKey
™™$ .
;
™™. /
byte
´´ 
[
´´ 
]
´´ 
pkBytes
´´ 
=
´´  
	edKeyPair
´´! *
.
´´* +
	PublicKey
´´+ 4
;
´´4 5
skHandle
≠≠ 
=
≠≠ &
SodiumSecureMemoryHandle
≠≠ 3
.
≠≠3 4
Allocate
≠≠4 <
(
≠≠< =
	Constants
≠≠= F
.
≠≠F G&
ED_25519_SECRET_KEY_SIZE
≠≠G _
)
≠≠_ `
.
≠≠` a
Unwrap
≠≠a g
(
≠≠g h
)
≠≠h i
;
≠≠i j
skHandle
ÆÆ 
.
ÆÆ 
Write
ÆÆ 
(
ÆÆ 
skBytes
ÆÆ &
)
ÆÆ& '
.
ÆÆ' (
Unwrap
ÆÆ( .
(
ÆÆ. /
)
ÆÆ/ 0
;
ÆÆ0 1
return
∞∞ 
(
∞∞ 
skHandle
∞∞  
,
∞∞  !
pkBytes
∞∞" )
)
∞∞) *
;
∞∞* +
}
±± 
,
±± 
ex
±± 
=>
±± %
EcliptixProtocolFailure
±± ,
.
±±, -
KeyGeneration
±±- :
(
±±: ;-
EcliptixProtocolFailureMessages
±±; Z
.
±±Z [
IdentityKeys
±±[ g
.
±±g h3
$FAILED_TO_GENERATE_ED_25519_KEY_PAIR±±h å
,±±å ç
ex±±é ê
)±±ê ë
)±±ë í
;±±í ì
}
≤≤ 	
finally
≥≥ 
{
¥¥ 	
if
µµ 
(
µµ 
skBytes
µµ 
!=
µµ 
null
µµ 
)
µµ  
{
∂∂ 
SodiumInterop
∑∑ 
.
∑∑ 

SecureWipe
∑∑ (
(
∑∑( )
skBytes
∑∑) 0
)
∑∑0 1
;
∑∑1 2
}
∏∏ 
}
ππ 	
}
∫∫ 
private
ºº 
static
ºº 
Result
ºº 
<
ºº 
(
ºº &
SodiumSecureMemoryHandle
ºº 3
skHandle
ºº4 <
,
ºº< =
byte
ºº> B
[
ººB C
]
ººC D
pk
ººE G
)
ººG H
,
ººH I%
EcliptixProtocolFailure
ººJ a
>
ººa b(
GenerateX25519IdentityKeys
ΩΩ "
(
ΩΩ" #
)
ΩΩ# $
{
ææ 
return
øø 
SodiumInterop
øø 
.
øø #
GenerateX25519KeyPair
øø 2
(
øø2 3-
EcliptixProtocolFailureMessages
øø3 R
.
øøR S
IdentityKeys
øøS _
.
øø_ `'
IDENTITY_KEY_PAIR_PURPOSE
øø` y
)
øøy z
;
øøz {
}
¿¿ 
private
¬¬ 
static
¬¬ 
Result
¬¬ 
<
¬¬ 
(
¬¬ &
SodiumSecureMemoryHandle
¬¬ 3
skHandle
¬¬4 <
,
¬¬< =
byte
¬¬> B
[
¬¬B C
]
¬¬C D
pk
¬¬E G
)
¬¬G H
,
¬¬H I%
EcliptixProtocolFailure
¬¬J a
>
¬¬a b(
GenerateX25519SignedPreKey
√√ "
(
√√" #
uint
√√# '
id
√√( *
)
√√* +
{
ƒƒ 
return
≈≈ 
SodiumInterop
≈≈ 
.
≈≈ #
GenerateX25519KeyPair
≈≈ 2
(
≈≈2 3
string
≈≈3 9
.
≈≈9 :
Format
≈≈: @
(
≈≈@ A-
EcliptixProtocolFailureMessages
≈≈A `
.
≈≈` a
IdentityKeys
≈≈a m
.
≈≈m n*
SIGNED_PRE_KEY_PAIR_PURPOSE≈≈n â
,≈≈â ä
id≈≈ã ç
)≈≈ç é
)≈≈é è
;≈≈è ê
}
∆∆ 
private
»» 
static
»» 
Result
»» 
<
»» 
byte
»» 
[
»» 
]
»»  
,
»»  !%
EcliptixProtocolFailure
»»" 9
>
»»9 :
SignSignedPreKey
»»; K
(
»»K L&
SodiumSecureMemoryHandle
»»L d

edSkHandle
»»e o
,
»»o p
byte
…… 
[
…… 
]
…… 
spkPk
…… 
)
…… 
{
   
byte
ÀÀ 
[
ÀÀ 
]
ÀÀ 
?
ÀÀ 
tempEdSignKeyCopy
ÀÀ !
=
ÀÀ" #
null
ÀÀ$ (
;
ÀÀ( )
try
ÃÃ 
{
ÕÕ 	
Result
ŒŒ 
<
ŒŒ 
byte
ŒŒ 
[
ŒŒ 
]
ŒŒ 
,
ŒŒ %
EcliptixProtocolFailure
ŒŒ 2
>
ŒŒ2 3

readResult
ŒŒ4 >
=
ŒŒ? @

edSkHandle
œœ 
.
œœ 
	ReadBytes
œœ $
(
œœ$ %
	Constants
œœ% .
.
œœ. /&
ED_25519_SECRET_KEY_SIZE
œœ/ G
)
œœG H
.
œœH I
MapSodiumFailure
œœI Y
(
œœY Z
)
œœZ [
;
œœ[ \
if
–– 
(
–– 

readResult
–– 
.
–– 
IsErr
––  
)
––  !
{
—— 
return
““ 
Result
““ 
<
““ 
byte
““ "
[
““" #
]
““# $
,
““$ %%
EcliptixProtocolFailure
““& =
>
““= >
.
““> ?
Err
““? B
(
““B C

readResult
““C M
.
““M N
	UnwrapErr
““N W
(
““W X
)
““X Y
)
““Y Z
;
““Z [
}
”” 
tempEdSignKeyCopy
’’ 
=
’’ 

readResult
’’  *
.
’’* +
Unwrap
’’+ 1
(
’’1 2
)
’’2 3
;
’’3 4
Result
◊◊ 
<
◊◊ 
byte
◊◊ 
[
◊◊ 
]
◊◊ 
,
◊◊ %
EcliptixProtocolFailure
◊◊ 2
>
◊◊2 3

signResult
◊◊4 >
=
◊◊? @
Result
◊◊A G
<
◊◊G H
byte
◊◊H L
[
◊◊L M
]
◊◊M N
,
◊◊N O%
EcliptixProtocolFailure
◊◊P g
>
◊◊g h
.
◊◊h i
Try
◊◊i l
(
◊◊l m
(
ÿÿ 
)
ÿÿ 
=>
ÿÿ 
PublicKeyAuth
ÿÿ #
.
ÿÿ# $
SignDetached
ÿÿ$ 0
(
ÿÿ0 1
spkPk
ÿÿ1 6
,
ÿÿ6 7
tempEdSignKeyCopy
ÿÿ8 I
)
ÿÿI J
,
ÿÿJ K
ex
ŸŸ 
=>
ŸŸ %
EcliptixProtocolFailure
ŸŸ -
.
ŸŸ- .
Generic
ŸŸ. 5
(
ŸŸ5 6-
EcliptixProtocolFailureMessages
ŸŸ6 U
.
ŸŸU V
IdentityKeys
ŸŸV b
.
ŸŸb c0
!FAILED_TO_SIGN_PRE_KEY_PUBLIC_KEYŸŸc Ñ
,ŸŸÑ Ö
exŸŸÜ à
)ŸŸà â
)ŸŸâ ä
;ŸŸä ã
if
€€ 
(
€€ 

signResult
€€ 
.
€€ 
IsErr
€€  
)
€€  !
{
‹‹ 
return
›› 

signResult
›› !
;
››! "
}
ﬁﬁ 
byte
‡‡ 
[
‡‡ 
]
‡‡ 
	signature
‡‡ 
=
‡‡ 

signResult
‡‡ )
.
‡‡) *
Unwrap
‡‡* 0
(
‡‡0 1
)
‡‡1 2
;
‡‡2 3
if
·· 
(
·· 
	signature
·· 
.
·· 
Length
··  
==
··! #
	Constants
··$ -
.
··- .%
ED_25519_SIGNATURE_SIZE
··. E
)
··E F
{
‚‚ 
return
„„ 
Result
„„ 
<
„„ 
byte
„„ "
[
„„" #
]
„„# $
,
„„$ %%
EcliptixProtocolFailure
„„& =
>
„„= >
.
„„> ?
Ok
„„? A
(
„„A B
	signature
„„B K
)
„„K L
;
„„L M
}
‰‰ 
SodiumInterop
ÊÊ 
.
ÊÊ 

SecureWipe
ÊÊ $
(
ÊÊ$ %
	signature
ÊÊ% .
)
ÊÊ. /
;
ÊÊ/ 0
return
ÁÁ 
Result
ÁÁ 
<
ÁÁ 
byte
ÁÁ 
[
ÁÁ 
]
ÁÁ  
,
ÁÁ  !%
EcliptixProtocolFailure
ÁÁ" 9
>
ÁÁ9 :
.
ÁÁ: ;
Err
ÁÁ; >
(
ÁÁ> ?%
EcliptixProtocolFailure
ËË '
.
ËË' (
Generic
ËË( /
(
ËË/ 0
string
ÈÈ 
.
ÈÈ 
Format
ÈÈ !
(
ÈÈ! "-
EcliptixProtocolFailureMessages
ÈÈ" A
.
ÈÈA B
IdentityKeys
ÈÈB N
.
ÈÈN O4
&GENERATED_SPK_SIGNATURE_INCORRECT_SIZE
ÈÈO u
,
ÈÈu v
	signatureÈÈw Ä
.ÈÈÄ Å
LengthÈÈÅ á
)ÈÈá à
)ÈÈà â
)ÈÈâ ä
;ÈÈä ã
}
ÍÍ 	
finally
ÎÎ 
{
ÏÏ 	
if
ÌÌ 
(
ÌÌ 
tempEdSignKeyCopy
ÌÌ !
!=
ÌÌ" $
null
ÌÌ% )
)
ÌÌ) *
{
ÓÓ 
SodiumInterop
ÔÔ 
.
ÔÔ 

SecureWipe
ÔÔ (
(
ÔÔ( )
tempEdSignKeyCopy
ÔÔ) :
)
ÔÔ: ;
;
ÔÔ; <
}
 
}
ÒÒ 	
}
ÚÚ 
private
ÙÙ 
static
ÙÙ 
Result
ÙÙ 
<
ÙÙ 
List
ÙÙ 
<
ÙÙ  
OneTimePreKeyLocal
ÙÙ 1
>
ÙÙ1 2
,
ÙÙ2 3%
EcliptixProtocolFailure
ÙÙ4 K
>
ÙÙK L$
GenerateOneTimePreKeys
ÙÙM c
(
ÙÙc d
uint
ÙÙd h
count
ÙÙi n
)
ÙÙn o
{
ıı 
if
ˆˆ 

(
ˆˆ 
count
ˆˆ 
==
ˆˆ 
$num
ˆˆ 
)
ˆˆ 
{
˜˜ 	
return
¯¯ 
Result
¯¯ 
<
¯¯ 
List
¯¯ 
<
¯¯  
OneTimePreKeyLocal
¯¯ 1
>
¯¯1 2
,
¯¯2 3%
EcliptixProtocolFailure
¯¯4 K
>
¯¯K L
.
¯¯L M
Ok
¯¯M O
(
¯¯O P
[
¯¯P Q
]
¯¯Q R
)
¯¯R S
;
¯¯S T
}
˘˘ 	
List
˚˚ 
<
˚˚  
OneTimePreKeyLocal
˚˚ 
>
˚˚  
opks
˚˚! %
=
˚˚& '
new
˚˚( +
(
˚˚+ ,
(
˚˚, -
int
˚˚- 0
)
˚˚0 1
count
˚˚1 6
)
˚˚6 7
;
˚˚7 8
HashSet
¸¸ 
<
¸¸ 
uint
¸¸ 
>
¸¸ 
usedIds
¸¸ 
=
¸¸ 
new
¸¸  #
(
¸¸# $
(
¸¸$ %
int
¸¸% (
)
¸¸( )
count
¸¸) .
)
¸¸. /
;
¸¸/ 0
uint
˝˝ 
	idCounter
˝˝ 
=
˝˝ 
$num
˝˝ 
;
˝˝ 
try
ˇˇ 
{
ÄÄ 	
for
ÅÅ 
(
ÅÅ 
int
ÅÅ 
i
ÅÅ 
=
ÅÅ 
$num
ÅÅ 
;
ÅÅ 
i
ÅÅ 
<
ÅÅ 
count
ÅÅ  %
;
ÅÅ% &
i
ÅÅ' (
++
ÅÅ( *
)
ÅÅ* +
{
ÇÇ 
uint
ÉÉ 
id
ÉÉ 
=
ÉÉ 
	idCounter
ÉÉ #
++
ÉÉ# %
;
ÉÉ% &
while
ÑÑ 
(
ÑÑ 
usedIds
ÑÑ 
.
ÑÑ 
Contains
ÑÑ '
(
ÑÑ' (
id
ÑÑ( *
)
ÑÑ* +
)
ÑÑ+ ,
{
ÖÖ 
id
ÜÜ 
=
ÜÜ 
Helpers
ÜÜ  
.
ÜÜ  !"
GenerateRandomUInt32
ÜÜ! 5
(
ÜÜ5 6
)
ÜÜ6 7
;
ÜÜ7 8
}
áá 
usedIds
ââ 
.
ââ 
Add
ââ 
(
ââ 
id
ââ 
)
ââ 
;
ââ  
Result
ãã 
<
ãã  
OneTimePreKeyLocal
ãã )
,
ãã) *%
EcliptixProtocolFailure
ãã+ B
>
ããB C
	opkResult
ããD M
=
ããN O 
OneTimePreKeyLocal
ããP b
.
ããb c
Generate
ããc k
(
ããk l
id
ããl n
)
ããn o
;
ãão p
if
åå 
(
åå 
	opkResult
åå 
.
åå 
IsErr
åå #
)
åå# $
{
çç 
foreach
éé 
(
éé  
OneTimePreKeyLocal
éé /
generatedOpk
éé0 <
in
éé= ?
opks
éé@ D
)
ééD E
{
èè 
generatedOpk
êê $
.
êê$ %
Dispose
êê% ,
(
êê, -
)
êê- .
;
êê. /
}
ëë 
return
ìì 
Result
ìì !
<
ìì! "
List
ìì" &
<
ìì& ' 
OneTimePreKeyLocal
ìì' 9
>
ìì9 :
,
ìì: ;%
EcliptixProtocolFailure
ìì< S
>
ììS T
.
ììT U
Err
ììU X
(
ììX Y
	opkResult
ììY b
.
ììb c
	UnwrapErr
ììc l
(
ììl m
)
ììm n
)
ììn o
;
ììo p
}
îî  
OneTimePreKeyLocal
ññ "
opk
ññ# &
=
ññ' (
	opkResult
ññ) 2
.
ññ2 3
Unwrap
ññ3 9
(
ññ9 :
)
ññ: ;
;
ññ; <
opks
òò 
.
òò 
Add
òò 
(
òò 
opk
òò 
)
òò 
;
òò 
}
ôô 
return
õõ 
Result
õõ 
<
õõ 
List
õõ 
<
õõ  
OneTimePreKeyLocal
õõ 1
>
õõ1 2
,
õõ2 3%
EcliptixProtocolFailure
õõ4 K
>
õõK L
.
õõL M
Ok
õõM O
(
õõO P
opks
õõP T
)
õõT U
;
õõU V
}
úú 	
catch
ùù 
(
ùù 
	Exception
ùù 
ex
ùù 
)
ùù 
{
ûû 	
foreach
üü 
(
üü  
OneTimePreKeyLocal
üü '
generatedOpk
üü( 4
in
üü5 7
opks
üü8 <
)
üü< =
{
†† 
generatedOpk
°° 
.
°° 
Dispose
°° $
(
°°$ %
)
°°% &
;
°°& '
}
¢¢ 
return
§§ 
Result
§§ 
<
§§ 
List
§§ 
<
§§  
OneTimePreKeyLocal
§§ 1
>
§§1 2
,
§§2 3%
EcliptixProtocolFailure
§§4 K
>
§§K L
.
§§L M
Err
§§M P
(
§§P Q%
EcliptixProtocolFailure
•• '
.
••' (
KeyGeneration
••( 5
(
••5 6-
EcliptixProtocolFailureMessages
••6 U
.
••U V
IdentityKeys
••V b
.
••b c;
,UNEXPECTED_ERROR_GENERATING_ONE_TIME_PREKEYS••c è
,••è ê
ex••ë ì
)••ì î
)••î ï
;••ï ñ
}
¶¶ 	
}
ßß 
internal
™™ 
Result
™™ 
<
™™ "
LocalPublicKeyBundle
™™ (
,
™™( )%
EcliptixProtocolFailure
™™* A
>
™™A B 
CreatePublicBundle
™™C U
(
™™U V
)
™™V W
{
´´ 
if
¨¨ 

(
¨¨ 
	_disposed
¨¨ 
)
¨¨ 
{
≠≠ 	
return
ÆÆ 
Result
ÆÆ 
<
ÆÆ "
LocalPublicKeyBundle
ÆÆ .
,
ÆÆ. /%
EcliptixProtocolFailure
ÆÆ0 G
>
ÆÆG H
.
ÆÆH I
Err
ÆÆI L
(
ÆÆL M%
EcliptixProtocolFailure
ØØ '
.
ØØ' (
OBJECT_DISPOSED
ØØ( 7
(
ØØ7 8
nameof
ØØ8 >
(
ØØ> ?(
EcliptixSystemIdentityKeys
ØØ? Y
)
ØØY Z
)
ØØZ [
)
ØØ[ \
;
ØØ\ ]
}
∞∞ 	
try
≤≤ 
{
≥≥ 	
List
¥¥ 
<
¥¥ !
OneTimePreKeyRecord
¥¥ $
>
¥¥$ %

opkRecords
¥¥& 0
=
¥¥1 2
[
¥¥3 4
]
¥¥4 5
;
¥¥5 6

opkRecords
µµ 
.
µµ 
AddRange
µµ 
(
µµ  %
_oneTimePreKeysInternal
µµ  7
.
µµ7 8
Select
µµ8 >
(
µµ> ?
opkLocal
µµ? G
=>
µµH J
new
∂∂ !
OneTimePreKeyRecord
∂∂ '
(
∂∂' (
opkLocal
∂∂( 0
.
∂∂0 1
PreKeyId
∂∂1 9
,
∂∂9 :
opkLocal
∂∂; C
.
∂∂C D
GetPublicKeyCopy
∂∂D T
(
∂∂T U
)
∂∂U V
)
∂∂V W
)
∂∂W X
)
∂∂X Y
;
∂∂Y Z"
LocalPublicKeyBundle
∏∏  
bundle
∏∏! '
=
∏∏( )
new
∏∏* -
(
∏∏- .
_ed25519PublicKey
ππ !
,
ππ! ",
GetIdentityX25519PublicKeyCopy
∫∫ .
(
∫∫. /
)
∫∫/ 0
,
∫∫0 1
_signedPreKeyId
ªª 
,
ªª  !
_signedPreKeyPublic
ºº #
,
ºº# $$
_signedPreKeySignature
ΩΩ &
,
ΩΩ& '

opkRecords
ææ 
,
ææ '
_ephemeralX25519PublicKey
øø )
)
øø) *
;
øø* +
return
¡¡ 
Result
¡¡ 
<
¡¡ "
LocalPublicKeyBundle
¡¡ .
,
¡¡. /%
EcliptixProtocolFailure
¡¡0 G
>
¡¡G H
.
¡¡H I
Ok
¡¡I K
(
¡¡K L
bundle
¡¡L R
)
¡¡R S
;
¡¡S T
}
¬¬ 	
catch
√√ 
(
√√ 
	Exception
√√ 
ex
√√ 
)
√√ 
{
ƒƒ 	
return
≈≈ 
Result
≈≈ 
<
≈≈ "
LocalPublicKeyBundle
≈≈ .
,
≈≈. /%
EcliptixProtocolFailure
≈≈0 G
>
≈≈G H
.
≈≈H I
Err
≈≈I L
(
≈≈L M%
EcliptixProtocolFailure
∆∆ '
.
∆∆' (
Generic
∆∆( /
(
∆∆/ 0-
EcliptixProtocolFailureMessages
∆∆0 O
.
∆∆O P
IdentityKeys
∆∆P \
.
∆∆\ ]0
"FAILED_TO_CREATE_PUBLIC_KEY_BUNDLE
∆∆] 
,∆∆ Ä
ex∆∆Å É
)∆∆É Ñ
)∆∆Ñ Ö
;∆∆Ö Ü
}
«« 	
}
»» 
public
   

void
   &
GenerateEphemeralKeyPair
   (
(
  ( )
)
  ) *
{
ÀÀ 
if
ÃÃ 

(
ÃÃ 
	_disposed
ÃÃ 
)
ÃÃ 
{
ÕÕ 	
Result
ŒŒ 
<
ŒŒ 
Unit
ŒŒ 
,
ŒŒ %
EcliptixProtocolFailure
ŒŒ 0
>
ŒŒ0 1
.
ŒŒ1 2
Err
ŒŒ2 5
(
ŒŒ5 6%
EcliptixProtocolFailure
œœ '
.
œœ' (
OBJECT_DISPOSED
œœ( 7
(
œœ7 8
nameof
œœ8 >
(
œœ> ?(
EcliptixSystemIdentityKeys
œœ? Y
)
œœY Z
)
œœZ [
)
œœ[ \
;
œœ\ ]
return
–– 
;
–– 
}
—— 	'
_ephemeralSecretKeyHandle
”” !
?
””! "
.
””" #
Dispose
””# *
(
””* +
)
””+ ,
;
””, -
if
‘‘ 

(
‘‘ '
_ephemeralX25519PublicKey
‘‘ %
!=
‘‘& (
null
‘‘) -
)
‘‘- .
{
’’ 	
SodiumInterop
÷÷ 
.
÷÷ 

SecureWipe
÷÷ $
(
÷÷$ %'
_ephemeralX25519PublicKey
÷÷% >
)
÷÷> ?
;
÷÷? @
}
◊◊ 	
Result
ŸŸ 
<
ŸŸ 
(
ŸŸ &
SodiumSecureMemoryHandle
ŸŸ (
skHandle
ŸŸ) 1
,
ŸŸ1 2
byte
ŸŸ3 7
[
ŸŸ7 8
]
ŸŸ8 9
pk
ŸŸ: <
)
ŸŸ< =
,
ŸŸ= >%
EcliptixProtocolFailure
ŸŸ? V
>
ŸŸV W
generationResult
ŸŸX h
=
ŸŸi j
SodiumInterop
⁄⁄ 
.
⁄⁄ #
GenerateX25519KeyPair
⁄⁄ /
(
⁄⁄/ 0-
EcliptixProtocolFailureMessages
⁄⁄0 O
.
⁄⁄O P
IdentityKeys
⁄⁄P \
.
⁄⁄\ ](
EPHEMERAL_KEY_PAIR_PURPOSE
⁄⁄] w
)
⁄⁄w x
;
⁄⁄x y
if
‹‹ 

(
‹‹ 
generationResult
‹‹ 
.
‹‹ 
IsOk
‹‹ !
)
‹‹! "
{
›› 	
(
ﬁﬁ &
SodiumSecureMemoryHandle
ﬁﬁ %
skHandle
ﬁﬁ& .
,
ﬁﬁ. /
byte
ﬁﬁ0 4
[
ﬁﬁ4 5
]
ﬁﬁ5 6
pk
ﬁﬁ7 9
)
ﬁﬁ9 :
keys
ﬁﬁ; ?
=
ﬁﬁ@ A
generationResult
ﬁﬁB R
.
ﬁﬁR S
Unwrap
ﬁﬁS Y
(
ﬁﬁY Z
)
ﬁﬁZ [
;
ﬁﬁ[ \'
_ephemeralSecretKeyHandle
ﬂﬂ %
=
ﬂﬂ& '
keys
ﬂﬂ( ,
.
ﬂﬂ, -
skHandle
ﬂﬂ- 5
;
ﬂﬂ5 6'
_ephemeralX25519PublicKey
‡‡ %
=
‡‡& '
keys
‡‡( ,
.
‡‡, -
pk
‡‡- /
;
‡‡/ 0
}
·· 	
else
‚‚ 
{
„„ 	'
_ephemeralSecretKeyHandle
‰‰ %
=
‰‰& '
null
‰‰( ,
;
‰‰, -'
_ephemeralX25519PublicKey
ÂÂ %
=
ÂÂ& '
null
ÂÂ( ,
;
ÂÂ, -
}
ÊÊ 	
}
ÁÁ 
internal
ÈÈ 
Result
ÈÈ 
<
ÈÈ &
SodiumSecureMemoryHandle
ÈÈ ,
,
ÈÈ, -%
EcliptixProtocolFailure
ÈÈ. E
>
ÈÈE F$
X3dhDeriveSharedSecret
ÈÈG ]
(
ÈÈ] ^"
LocalPublicKeyBundle
ÍÍ 
remoteBundle
ÍÍ )
,
ÍÍ) *
ReadOnlySpan
ÍÍ+ 7
<
ÍÍ7 8
byte
ÍÍ8 <
>
ÍÍ< =
info
ÍÍ> B
)
ÍÍB C
{
ÎÎ &
SodiumSecureMemoryHandle
ÏÏ  
?
ÏÏ  !!
ephemeralHandleUsed
ÏÏ" 5
=
ÏÏ6 7
null
ÏÏ8 <
;
ÏÏ< =&
SodiumSecureMemoryHandle
ÌÌ  
?
ÌÌ  ! 
secureOutputHandle
ÌÌ" 4
=
ÌÌ5 6
null
ÌÌ7 ;
;
ÌÌ; <
try
ÔÔ 
{
 	
Result
ÒÒ 
<
ÒÒ 
Unit
ÒÒ 
,
ÒÒ %
EcliptixProtocolFailure
ÒÒ 0
>
ÒÒ0 1&
hkdfInfoValidationResult
ÒÒ2 J
=
ÒÒK L
ValidateHkdfInfo
ÒÒM ]
(
ÒÒ] ^
info
ÒÒ^ b
)
ÒÒb c
;
ÒÒc d
if
ÚÚ 
(
ÚÚ &
hkdfInfoValidationResult
ÚÚ (
.
ÚÚ( )
IsErr
ÚÚ) .
)
ÚÚ. /
{
ÛÛ 
return
ÙÙ 
Result
ÙÙ 
<
ÙÙ &
SodiumSecureMemoryHandle
ÙÙ 6
,
ÙÙ6 7%
EcliptixProtocolFailure
ÙÙ8 O
>
ÙÙO P
.
ÙÙP Q
Err
ÙÙQ T
(
ÙÙT U&
hkdfInfoValidationResult
ıı ,
.
ıı, -
	UnwrapErr
ıı- 6
(
ıı6 7
)
ıı7 8
)
ıı8 9
;
ıı9 :
}
ˆˆ 
Result
¯¯ 
<
¯¯ 
Unit
¯¯ 
,
¯¯ %
EcliptixProtocolFailure
¯¯ 0
>
¯¯0 1
disposedCheck
¯¯2 ?
=
¯¯@ A
CheckDisposed
¯¯B O
(
¯¯O P
)
¯¯P Q
;
¯¯Q R
if
˘˘ 
(
˘˘ 
disposedCheck
˘˘ 
.
˘˘ 
IsErr
˘˘ #
)
˘˘# $
{
˙˙ 
return
˚˚ 
Result
˚˚ 
<
˚˚ &
SodiumSecureMemoryHandle
˚˚ 6
,
˚˚6 7%
EcliptixProtocolFailure
˚˚8 O
>
˚˚O P
.
˚˚P Q
Err
˚˚Q T
(
˚˚T U
disposedCheck
˚˚U b
.
˚˚b c
	UnwrapErr
˚˚c l
(
˚˚l m
)
˚˚m n
)
˚˚n o
;
˚˚o p
}
¸¸ 
Result
˛˛ 
<
˛˛ 
Unit
˛˛ 
,
˛˛ %
EcliptixProtocolFailure
˛˛ 0
>
˛˛0 1
bundleValidation
˛˛2 B
=
˛˛C D"
ValidateRemoteBundle
˛˛E Y
(
˛˛Y Z
remoteBundle
˛˛Z f
)
˛˛f g
;
˛˛g h
if
ˇˇ 
(
ˇˇ 
bundleValidation
ˇˇ  
.
ˇˇ  !
IsErr
ˇˇ! &
)
ˇˇ& '
{
ÄÄ 
return
ÅÅ 
Result
ÅÅ 
<
ÅÅ &
SodiumSecureMemoryHandle
ÅÅ 6
,
ÅÅ6 7%
EcliptixProtocolFailure
ÅÅ8 O
>
ÅÅO P
.
ÅÅP Q
Err
ÅÅQ T
(
ÅÅT U
bundleValidation
ÅÅU e
.
ÅÅe f
	UnwrapErr
ÅÅf o
(
ÅÅo p
)
ÅÅp q
)
ÅÅq r
;
ÅÅr s
}
ÇÇ 
Result
ÑÑ 
<
ÑÑ 
Unit
ÑÑ 
,
ÑÑ %
EcliptixProtocolFailure
ÑÑ 0
>
ÑÑ0 1!
localKeysValidation
ÑÑ2 E
=
ÑÑF G"
EnsureLocalKeysValid
ÑÑH \
(
ÑÑ\ ]
)
ÑÑ] ^
;
ÑÑ^ _
if
ÖÖ 
(
ÖÖ !
localKeysValidation
ÖÖ #
.
ÖÖ# $
IsErr
ÖÖ$ )
)
ÖÖ) *
{
ÜÜ 
return
áá 
Result
áá 
<
áá &
SodiumSecureMemoryHandle
áá 6
,
áá6 7%
EcliptixProtocolFailure
áá8 O
>
ááO P
.
ááP Q
Err
ááQ T
(
ááT U!
localKeysValidation
ááU h
.
ááh i
	UnwrapErr
áái r
(
áár s
)
áás t
)
áát u
;
ááu v
}
àà 
byte
ää 
[
ää 
]
ää 
	infoArray
ää 
=
ää 
info
ää #
.
ää# $
ToArray
ää$ +
(
ää+ ,
)
ää, -
;
ää- .
return
åå 
SecureMemoryUtils
åå $
.
åå$ %
WithSecureBuffers
åå% 6
(
åå6 7
[
çç 
	Constants
éé 
.
éé &
X_25519_PRIVATE_KEY_SIZE
éé 6
,
éé6 7
	Constants
éé8 A
.
ééA B&
X_25519_PRIVATE_KEY_SIZE
ééB Z
,
ééZ [
	Constants
éé\ e
.
éée f
X_25519_KEY_SIZE
ééf v
*
ééw x
$num
ééy z
,
ééz {
	Constants
èè 
.
èè 
X_25519_KEY_SIZE
èè .
*
èè/ 0
$num
èè1 2
,
èè2 3
	Constants
èè4 =
.
èè= >
X_25519_KEY_SIZE
èè> N
]
êê 
,
êê 
buffers
ëë 
=>
ëë 
{
íí 
Span
ìì 
<
ìì 
byte
ìì 
>
ìì !
ephemeralSecretSpan
ìì 2
=
ìì3 4
buffers
ìì5 <
[
ìì< =
$num
ìì= >
]
ìì> ?
.
ìì? @
GetSpan
ìì@ G
(
ììG H
)
ììH I
[
ììI J
..
ììJ L
	Constants
ììL U
.
ììU V&
X_25519_PRIVATE_KEY_SIZE
ììV n
]
ììn o
;
ììo p
Span
îî 
<
îî 
byte
îî 
>
îî  
identitySecretSpan
îî 1
=
îî2 3
buffers
îî4 ;
[
îî; <
$num
îî< =
]
îî= >
.
îî> ?
GetSpan
îî? F
(
îîF G
)
îîG H
[
îîH I
..
îîI K
	Constants
îîK T
.
îîT U&
X_25519_PRIVATE_KEY_SIZE
îîU m
]
îîm n
;
îîn o
Span
ïï 
<
ïï 
byte
ïï 
>
ïï 
dhResultsSpan
ïï ,
=
ïï- .
buffers
ïï/ 6
[
ïï6 7
$num
ïï7 8
]
ïï8 9
.
ïï9 :
GetSpan
ïï: A
(
ïïA B
)
ïïB C
[
ïïC D
..
ïïD F
(
ïïF G
	Constants
ïïG P
.
ïïP Q
X_25519_KEY_SIZE
ïïQ a
*
ïïb c
$num
ïïd e
)
ïïe f
]
ïïf g
;
ïïg h
Span
ññ 
<
ññ 
byte
ññ 
>
ññ 
ikmSpan
ññ &
=
ññ' (
buffers
ññ) 0
[
ññ0 1
$num
ññ1 2
]
ññ2 3
.
ññ3 4
GetSpan
ññ4 ;
(
ññ; <
)
ññ< =
[
ññ= >
..
ññ> @
(
ññ@ A
	Constants
ññA J
.
ññJ K
X_25519_KEY_SIZE
ññK [
*
ññ\ ]
$num
ññ^ _
)
ññ_ `
]
ññ` a
;
ñña b
Span
óó 
<
óó 
byte
óó 
>
óó 
hkdfOutputSpan
óó -
=
óó. /
buffers
óó0 7
[
óó7 8
$num
óó8 9
]
óó9 :
.
óó: ;
GetSpan
óó; B
(
óóB C
)
óóC D
[
óóD E
..
óóE G
	Constants
óóG P
.
óóP Q
X_25519_KEY_SIZE
óóQ a
]
óóa b
;
óób c
Result
ôô 
<
ôô 
byte
ôô 
[
ôô  
]
ôô  !
,
ôô! "%
EcliptixProtocolFailure
ôô# :
>
ôô: ;
readEphResult
ôô< I
=
ôôJ K'
_ephemeralSecretKeyHandle
ôôL e
!
ôôe f
.
öö 
	ReadBytes
öö "
(
öö" #
	Constants
öö# ,
.
öö, -&
X_25519_PRIVATE_KEY_SIZE
öö- E
)
ööE F
.
ööF G
MapSodiumFailure
ööG W
(
ööW X
)
ööX Y
;
ööY Z
if
õõ 
(
õõ 
readEphResult
õõ %
.
õõ% &
IsErr
õõ& +
)
õõ+ ,
{
úú 
return
ùù 
Result
ùù %
<
ùù% &&
SodiumSecureMemoryHandle
ùù& >
,
ùù> ?%
EcliptixProtocolFailure
ùù@ W
>
ùùW X
.
ùùX Y
Err
ùùY \
(
ùù\ ]
readEphResult
ùù] j
.
ùùj k
	UnwrapErr
ùùk t
(
ùùt u
)
ùùu v
)
ùùv w
;
ùùw x
}
ûû 
byte
†† 
[
†† 
]
†† "
ephemeralSecretBytes
†† /
=
††0 1
readEphResult
††2 ?
.
††? @
Unwrap
††@ F
(
††F G
)
††G H
;
††H I"
ephemeralSecretBytes
°° (
.
°°( )
CopyTo
°°) /
(
°°/ 0!
ephemeralSecretSpan
°°0 C
)
°°C D
;
°°D E
SodiumInterop
¢¢ !
.
¢¢! "

SecureWipe
¢¢" ,
(
¢¢, -"
ephemeralSecretBytes
¢¢- A
)
¢¢A B
;
¢¢B C
Result
§§ 
<
§§ 
byte
§§ 
[
§§  
]
§§  !
,
§§! "%
EcliptixProtocolFailure
§§# :
>
§§: ;
readIdResult
§§< H
=
§§I J,
_identityX25519SecretKeyHandle
§§K i
!
§§i j
.
•• 
	ReadBytes
•• "
(
••" #
	Constants
••# ,
.
••, -&
X_25519_PRIVATE_KEY_SIZE
••- E
)
••E F
.
••F G
MapSodiumFailure
••G W
(
••W X
)
••X Y
;
••Y Z
if
¶¶ 
(
¶¶ 
readIdResult
¶¶ $
.
¶¶$ %
IsErr
¶¶% *
)
¶¶* +
{
ßß 
return
®® 
Result
®® %
<
®®% &&
SodiumSecureMemoryHandle
®®& >
,
®®> ?%
EcliptixProtocolFailure
®®@ W
>
®®W X
.
®®X Y
Err
®®Y \
(
®®\ ]
readIdResult
®®] i
.
®®i j
	UnwrapErr
®®j s
(
®®s t
)
®®t u
)
®®u v
;
®®v w
}
©© 
byte
´´ 
[
´´ 
]
´´ !
identitySecretBytes
´´ .
=
´´/ 0
readIdResult
´´1 =
.
´´= >
Unwrap
´´> D
(
´´D E
)
´´E F
;
´´F G!
identitySecretBytes
¨¨ '
.
¨¨' (
CopyTo
¨¨( .
(
¨¨. / 
identitySecretSpan
¨¨/ A
)
¨¨A B
;
¨¨B C
SodiumInterop
≠≠ !
.
≠≠! "

SecureWipe
≠≠" ,
(
≠≠, -!
identitySecretBytes
≠≠- @
)
≠≠@ A
;
≠≠A B!
ephemeralHandleUsed
ØØ '
=
ØØ( )'
_ephemeralSecretKeyHandle
ØØ* C
;
ØØC D'
_ephemeralSecretKeyHandle
∞∞ -
=
∞∞. /
null
∞∞0 4
;
∞∞4 5
bool
≤≤ 
useOpk
≤≤ 
=
≤≤  !
remoteBundle
≤≤" .
.
≤≤. /
OneTimePreKeys
≤≤/ =
.
≤≤= >
FirstOrDefault
≤≤> L
(
≤≤L M
)
≤≤M N
?
≤≤N O
.
≤≤O P
	PublicKey
≤≤P Y
is
≤≤Z \
{
≥≥ 
Length
≥≥ 
:
≥≥ 
	Constants
≥≥ '
.
≥≥' (%
X_25519_PUBLIC_KEY_SIZE
≥≥( ?
}
≥≥@ A
;
≥≥A B
byte
µµ 
[
µµ 
]
µµ 
?
µµ "
ephemeralSecretArray
µµ 0
=
µµ1 2
null
µµ3 7
;
µµ7 8
byte
∂∂ 
[
∂∂ 
]
∂∂ 
?
∂∂ !
identitySecretArray
∂∂ /
=
∂∂0 1
null
∂∂2 6
;
∂∂6 7
byte
∑∑ 
[
∑∑ 
]
∑∑ 
?
∑∑ 
dh1
∑∑ 
=
∑∑  !
null
∑∑" &
;
∑∑& '
byte
∏∏ 
[
∏∏ 
]
∏∏ 
?
∏∏ 
dh2
∏∏ 
=
∏∏  !
null
∏∏" &
;
∏∏& '
byte
ππ 
[
ππ 
]
ππ 
?
ππ 
dh3
ππ 
=
ππ  !
null
ππ" &
;
ππ& '
int
∫∫ 
dhOffset
∫∫  
=
∫∫! "
$num
∫∫# $
;
∫∫$ %
try
ºº 
{
ΩΩ "
ephemeralSecretArray
ææ ,
=
ææ- .!
ephemeralSecretSpan
ææ/ B
.
ææB C
ToArray
ææC J
(
ææJ K
)
ææK L
;
ææL M!
identitySecretArray
øø +
=
øø, - 
identitySecretSpan
øø. @
.
øø@ A
ToArray
øøA H
(
øøH I
)
øøI J
;
øøJ K
byte
¡¡ 
[
¡¡ 
]
¡¡ 
dhTemp1
¡¡ &
=
¡¡' (

ScalarMult
¬¬ &
.
¬¬& '
Mult
¬¬' +
(
¬¬+ ,!
identitySecretArray
¬¬, ?
,
¬¬? @
remoteBundle
√√  ,
.
√√, - 
SignedPreKeyPublic
√√- ?
)
√√? @
;
√√@ A
byte
ƒƒ 
[
ƒƒ 
]
ƒƒ 
dhTemp2
ƒƒ &
=
ƒƒ' (

ScalarMult
≈≈ &
.
≈≈& '
Mult
≈≈' +
(
≈≈+ ,"
ephemeralSecretArray
≈≈, @
,
≈≈@ A
remoteBundle
≈≈B N
.
≈≈N O
IdentityX25519
≈≈O ]
)
≈≈] ^
;
≈≈^ _
byte
∆∆ 
[
∆∆ 
]
∆∆ 
dhTemp3
∆∆ &
=
∆∆' (

ScalarMult
«« &
.
««& '
Mult
««' +
(
««+ ,"
ephemeralSecretArray
««, @
,
««@ A
remoteBundle
»»  ,
.
»», - 
SignedPreKeyPublic
»»- ?
)
»»? @
;
»»@ A
dh1
   
=
   
dhTemp1
   %
;
  % &
dh2
ÀÀ 
=
ÀÀ 
dhTemp2
ÀÀ %
;
ÀÀ% &
dh3
ÃÃ 
=
ÃÃ 
dhTemp3
ÃÃ %
;
ÃÃ% &
dh1
œœ 
.
œœ 
AsSpan
œœ "
(
œœ" #
)
œœ# $
.
œœ$ %
CopyTo
œœ% +
(
œœ+ ,
dhResultsSpan
œœ, 9
[
œœ9 :
dhOffset
œœ: B
..
œœB D
(
œœD E
dhOffset
œœE M
+
œœN O
	Constants
œœP Y
.
œœY Z
X_25519_KEY_SIZE
œœZ j
)
œœj k
]
œœk l
)
œœl m
;
œœm n
dhOffset
––  
+=
––! #
	Constants
––$ -
.
––- .
X_25519_KEY_SIZE
––. >
;
––> ?
dh2
—— 
.
—— 
AsSpan
—— "
(
——" #
)
——# $
.
——$ %
CopyTo
——% +
(
——+ ,
dhResultsSpan
——, 9
[
——9 :
dhOffset
——: B
..
——B D
(
——D E
dhOffset
——E M
+
——N O
	Constants
——P Y
.
——Y Z
X_25519_KEY_SIZE
——Z j
)
——j k
]
——k l
)
——l m
;
——m n
dhOffset
““  
+=
““! #
	Constants
““$ -
.
““- .
X_25519_KEY_SIZE
““. >
;
““> ?
dh3
”” 
.
”” 
AsSpan
”” "
(
””" #
)
””# $
.
””$ %
CopyTo
””% +
(
””+ ,
dhResultsSpan
””, 9
[
””9 :
dhOffset
””: B
..
””B D
(
””D E
dhOffset
””E M
+
””N O
	Constants
””P Y
.
””Y Z
X_25519_KEY_SIZE
””Z j
)
””j k
]
””k l
)
””l m
;
””m n
dhOffset
‘‘  
+=
‘‘! #
	Constants
‘‘$ -
.
‘‘- .
X_25519_KEY_SIZE
‘‘. >
;
‘‘> ?
if
÷÷ 
(
÷÷ 
useOpk
÷÷ "
&&
÷÷# %
remoteBundle
÷÷& 2
.
÷÷2 3
OneTimePreKeys
÷÷3 A
.
÷÷A B
Count
÷÷B G
>
÷÷H I
$num
÷÷J K
)
÷÷K L
{
◊◊ 
byte
ÿÿ  
[
ÿÿ  !
]
ÿÿ! "
?
ÿÿ" #
dh4
ÿÿ$ '
=
ÿÿ( )
null
ÿÿ* .
;
ÿÿ. /
try
ŸŸ 
{
⁄⁄ 
dh4
€€  #
=
€€$ %

ScalarMult
€€& 0
.
€€0 1
Mult
€€1 5
(
€€5 6"
ephemeralSecretArray
€€6 J
,
€€J K
remoteBundle
€€L X
.
€€X Y
OneTimePreKeys
€€Y g
[
€€g h
$num
€€h i
]
€€i j
.
€€j k
	PublicKey
€€k t
)
€€t u
;
€€u v
dh4
‹‹  #
.
‹‹# $
AsSpan
‹‹$ *
(
‹‹* +
)
‹‹+ ,
.
‹‹, -
CopyTo
‹‹- 3
(
‹‹3 4
dhResultsSpan
‹‹4 A
[
‹‹A B
dhOffset
‹‹B J
..
‹‹J L
(
‹‹L M
dhOffset
‹‹M U
+
‹‹V W
	Constants
‹‹X a
.
‹‹a b
X_25519_KEY_SIZE
‹‹b r
)
‹‹r s
]
‹‹s t
)
‹‹t u
;
‹‹u v
dhOffset
››  (
+=
››) +
	Constants
››, 5
.
››5 6
X_25519_KEY_SIZE
››6 F
;
››F G
}
ﬁﬁ 
finally
ﬂﬂ #
{
‡‡ 
if
··  "
(
··# $
dh4
··$ '
!=
··( *
null
··+ /
)
··/ 0
{
‚‚  !
SodiumInterop
„„$ 1
.
„„1 2

SecureWipe
„„2 <
(
„„< =
dh4
„„= @
)
„„@ A
;
„„A B
}
‰‰  !
}
ÂÂ 
}
ÊÊ 
}
ÁÁ 
finally
ËË 
{
ÈÈ 
if
ÍÍ 
(
ÍÍ "
ephemeralSecretArray
ÍÍ 0
!=
ÍÍ1 3
null
ÍÍ4 8
)
ÍÍ8 9
{
ÎÎ 
SodiumInterop
ÏÏ )
.
ÏÏ) *

SecureWipe
ÏÏ* 4
(
ÏÏ4 5"
ephemeralSecretArray
ÏÏ5 I
)
ÏÏI J
;
ÏÏJ K
}
ÌÌ 
if
ÔÔ 
(
ÔÔ !
identitySecretArray
ÔÔ /
!=
ÔÔ0 2
null
ÔÔ3 7
)
ÔÔ7 8
{
 
SodiumInterop
ÒÒ )
.
ÒÒ) *

SecureWipe
ÒÒ* 4
(
ÒÒ4 5!
identitySecretArray
ÒÒ5 H
)
ÒÒH I
;
ÒÒI J
}
ÚÚ 
if
ÙÙ 
(
ÙÙ 
dh1
ÙÙ 
!=
ÙÙ  "
null
ÙÙ# '
)
ÙÙ' (
{
ıı 
SodiumInterop
ˆˆ )
.
ˆˆ) *

SecureWipe
ˆˆ* 4
(
ˆˆ4 5
dh1
ˆˆ5 8
)
ˆˆ8 9
;
ˆˆ9 :
}
˜˜ 
if
˘˘ 
(
˘˘ 
dh2
˘˘ 
!=
˘˘  "
null
˘˘# '
)
˘˘' (
{
˙˙ 
SodiumInterop
˚˚ )
.
˚˚) *

SecureWipe
˚˚* 4
(
˚˚4 5
dh2
˚˚5 8
)
˚˚8 9
;
˚˚9 :
}
¸¸ 
if
˛˛ 
(
˛˛ 
dh3
˛˛ 
!=
˛˛  "
null
˛˛# '
)
˛˛' (
{
ˇˇ 
SodiumInterop
ÄÄ )
.
ÄÄ) *

SecureWipe
ÄÄ* 4
(
ÄÄ4 5
dh3
ÄÄ5 8
)
ÄÄ8 9
;
ÄÄ9 :
}
ÅÅ 
}
ÇÇ 
Span
ÑÑ 
<
ÑÑ 
byte
ÑÑ 
>
ÑÑ 
ikmBuildSpan
ÑÑ +
=
ÑÑ, -
ikmSpan
ÑÑ. 5
[
ÑÑ5 6
..
ÑÑ6 8
(
ÑÑ8 9
	Constants
ÑÑ9 B
.
ÑÑB C
X_25519_KEY_SIZE
ÑÑC S
+
ÑÑT U
dhOffset
ÑÑV ^
)
ÑÑ^ _
]
ÑÑ_ `
;
ÑÑ` a
ikmBuildSpan
ÖÖ  
[
ÖÖ  !
..
ÖÖ! #
	Constants
ÖÖ# ,
.
ÖÖ, -
X_25519_KEY_SIZE
ÖÖ- =
]
ÖÖ= >
.
ÖÖ> ?
Fill
ÖÖ? C
(
ÖÖC D
$num
ÖÖD H
)
ÖÖH I
;
ÖÖI J
dhResultsSpan
ÜÜ !
[
ÜÜ! "
..
ÜÜ" $
dhOffset
ÜÜ$ ,
]
ÜÜ, -
.
ÜÜ- .
CopyTo
ÜÜ. 4
(
ÜÜ4 5
ikmBuildSpan
ÜÜ5 A
[
ÜÜA B
	Constants
ÜÜB K
.
ÜÜK L
X_25519_KEY_SIZE
ÜÜL \
..
ÜÜ\ ^
]
ÜÜ^ _
)
ÜÜ_ `
;
ÜÜ` a
byte
àà 
[
àà 
]
àà 
?
àà 
ikmArray
àà $
=
àà% &
null
àà' +
;
àà+ ,
try
ââ 
{
ää 
ikmArray
ãã  
=
ãã! "
ikmBuildSpan
ãã# /
.
ãã/ 0
ToArray
ãã0 7
(
ãã7 8
)
ãã8 9
;
ãã9 :
HKDF
çç 
.
çç 
	DeriveKey
çç &
(
çç& '
HashAlgorithmName
éé -
.
éé- .
SHA256
éé. 4
,
éé4 5
ikm
èè 
:
èè  
ikmArray
èè! )
,
èè) *
output
êê "
:
êê" #
hkdfOutputSpan
êê$ 2
,
êê2 3
salt
ëë  
:
ëë  !
null
ëë" &
,
ëë& '
info
íí  
:
íí  !
	infoArray
íí" +
)
ìì 
;
ìì 
}
ïï 
finally
ññ 
{
óó 
if
òò 
(
òò 
ikmArray
òò $
!=
òò% '
null
òò( ,
)
òò, -
{
ôô 
SodiumInterop
öö )
.
öö) *

SecureWipe
öö* 4
(
öö4 5
ikmArray
öö5 =
)
öö= >
;
öö> ?
}
õõ 
}
úú 
Result
ûû 
<
ûû &
SodiumSecureMemoryHandle
ûû 3
,
ûû3 4%
EcliptixProtocolFailure
ûû5 L
>
ûûL M
allocResult
ûûN Y
=
ûûZ [&
SodiumSecureMemoryHandle
üü 0
.
üü0 1
Allocate
üü1 9
(
üü9 :
	Constants
üü: C
.
üüC D
X_25519_KEY_SIZE
üüD T
)
üüT U
.
üüU V
MapSodiumFailure
üüV f
(
üüf g
)
üüg h
;
üüh i
if
†† 
(
†† 
allocResult
†† #
.
††# $
IsErr
††$ )
)
††) *
{
°° 
return
¢¢ 
Result
¢¢ %
<
¢¢% &&
SodiumSecureMemoryHandle
¢¢& >
,
¢¢> ?%
EcliptixProtocolFailure
¢¢@ W
>
¢¢W X
.
¢¢X Y
Err
¢¢Y \
(
¢¢\ ]
allocResult
¢¢] h
.
¢¢h i
	UnwrapErr
¢¢i r
(
¢¢r s
)
¢¢s t
)
¢¢t u
;
¢¢u v
}
££  
secureOutputHandle
•• &
=
••' (
allocResult
••) 4
.
••4 5
Unwrap
••5 ;
(
••; <
)
••< =
;
••= >
Result
¶¶ 
<
¶¶ 
Unit
¶¶ 
,
¶¶  %
EcliptixProtocolFailure
¶¶! 8
>
¶¶8 9
writeResult
¶¶: E
=
¶¶F G 
secureOutputHandle
ßß *
.
ßß* +
Write
ßß+ 0
(
ßß0 1
hkdfOutputSpan
ßß1 ?
)
ßß? @
.
ßß@ A
MapSodiumFailure
ßßA Q
(
ßßQ R
)
ßßR S
;
ßßS T
if
®® 
(
®® 
writeResult
®® #
.
®®# $
IsErr
®®$ )
)
®®) *
{
©©  
secureOutputHandle
™™ *
.
™™* +
Dispose
™™+ 2
(
™™2 3
)
™™3 4
;
™™4 5
return
´´ 
Result
´´ %
<
´´% &&
SodiumSecureMemoryHandle
´´& >
,
´´> ?%
EcliptixProtocolFailure
´´@ W
>
´´W X
.
´´X Y
Err
´´Y \
(
´´\ ]
writeResult
´´] h
.
´´h i
	UnwrapErr
´´i r
(
´´r s
)
´´s t
)
´´t u
;
´´u v
}
¨¨ &
SodiumSecureMemoryHandle
ÆÆ ,
returnHandle
ÆÆ- 9
=
ÆÆ: ; 
secureOutputHandle
ÆÆ< N
;
ÆÆN O 
secureOutputHandle
ØØ &
=
ØØ' (
null
ØØ) -
;
ØØ- .
return
∞∞ 
Result
∞∞ !
<
∞∞! "&
SodiumSecureMemoryHandle
∞∞" :
,
∞∞: ;%
EcliptixProtocolFailure
∞∞< S
>
∞∞S T
.
∞∞T U
Ok
∞∞U W
(
∞∞W X
returnHandle
∞∞X d
)
∞∞d e
;
∞∞e f
}
±± 
)
±± 
;
±± 
}
≤≤ 	
catch
≥≥ 
(
≥≥ 
	Exception
≥≥ 
ex
≥≥ 
)
≥≥ 
{
¥¥ 	
return
µµ 
Result
µµ 
<
µµ &
SodiumSecureMemoryHandle
µµ 2
,
µµ2 3%
EcliptixProtocolFailure
µµ4 K
>
µµK L
.
µµL M
Err
µµM P
(
µµP Q%
EcliptixProtocolFailure
∂∂ '
.
∂∂' (
	DeriveKey
∂∂( 1
(
∂∂1 2-
EcliptixProtocolFailureMessages
∂∂2 Q
.
∂∂Q R
IdentityKeys
∂∂R ^
.
∂∂^ _7
(UNEXPECTED_ERROR_DURING_X_3DH_DERIVATION∂∂_ á
,∂∂á à
ex
∑∑ 
)
∑∑ 
)
∑∑ 
;
∑∑ 
}
∏∏ 	
finally
ππ 
{
∫∫ 	!
ephemeralHandleUsed
ªª 
?
ªª  
.
ªª  !
Dispose
ªª! (
(
ªª( )
)
ªª) *
;
ªª* + 
secureOutputHandle
ºº 
?
ºº 
.
ºº  
Dispose
ºº  '
(
ºº' (
)
ºº( )
;
ºº) *
}
ΩΩ 	
}
ææ 
public
¿¿ 

Result
¿¿ 
<
¿¿ &
SodiumSecureMemoryHandle
¿¿ *
,
¿¿* +%
EcliptixProtocolFailure
¿¿, C
>
¿¿C D.
 CalculateSharedSecretAsRecipient
¿¿E e
(
¿¿e f
ReadOnlySpan
¡¡ 
<
¡¡ 
byte
¡¡ 
>
¡¡ &
remoteIdentityPublicKeyX
¡¡ 3
,
¡¡3 4
ReadOnlySpan
¡¡5 A
<
¡¡A B
byte
¡¡B F
>
¡¡F G'
remoteEphemeralPublicKeyX
¡¡H a
,
¡¡a b
uint
¬¬ 
?
¬¬ 
usedLocalOpkId
¬¬ 
,
¬¬ 
ReadOnlySpan
¬¬ *
<
¬¬* +
byte
¬¬+ /
>
¬¬/ 0
info
¬¬1 5
)
¬¬5 6
{
√√ &
SodiumSecureMemoryHandle
ƒƒ  
?
ƒƒ  ! 
secureOutputHandle
ƒƒ" 4
=
ƒƒ5 6
null
ƒƒ7 ;
;
ƒƒ; <&
SodiumSecureMemoryHandle
≈≈  
?
≈≈  !
opkSecretHandle
≈≈" 1
=
≈≈2 3
null
≈≈4 8
;
≈≈8 9
try
«« 
{
»» 	
Result
…… 
<
…… 
Unit
…… 
,
…… %
EcliptixProtocolFailure
…… 0
>
……0 1&
hkdfInfoValidationResult
……2 J
=
……K L
ValidateHkdfInfo
……M ]
(
……] ^
info
……^ b
)
……b c
;
……c d
if
   
(
   &
hkdfInfoValidationResult
   (
.
  ( )
IsErr
  ) .
)
  . /
{
ÀÀ 
return
ÃÃ 
Result
ÃÃ 
<
ÃÃ &
SodiumSecureMemoryHandle
ÃÃ 6
,
ÃÃ6 7%
EcliptixProtocolFailure
ÃÃ8 O
>
ÃÃO P
.
ÃÃP Q
Err
ÃÃQ T
(
ÃÃT U&
hkdfInfoValidationResult
ÕÕ ,
.
ÕÕ, -
	UnwrapErr
ÕÕ- 6
(
ÕÕ6 7
)
ÕÕ7 8
)
ÕÕ8 9
;
ÕÕ9 :
}
ŒŒ 
Result
–– 
<
–– 
Unit
–– 
,
–– %
EcliptixProtocolFailure
–– 0
>
––0 11
#remoteRecipientKeysValidationResult
––2 U
=
––V W)
ValidateRemoteRecipientKeys
—— +
(
——+ ,&
remoteIdentityPublicKeyX
——, D
,
——D E'
remoteEphemeralPublicKeyX
——F _
)
——_ `
;
——` a
if
““ 
(
““ 1
#remoteRecipientKeysValidationResult
““ 3
.
““3 4
IsErr
““4 9
)
““9 :
{
”” 
return
‘‘ 
Result
‘‘ 
<
‘‘ &
SodiumSecureMemoryHandle
‘‘ 6
,
‘‘6 7%
EcliptixProtocolFailure
‘‘8 O
>
‘‘O P
.
‘‘P Q
Err
‘‘Q T
(
‘‘T U1
#remoteRecipientKeysValidationResult
’’ 7
.
’’7 8
	UnwrapErr
’’8 A
(
’’A B
)
’’B C
)
’’C D
;
’’D E
}
÷÷ 
if
ÿÿ 
(
ÿÿ 
usedLocalOpkId
ÿÿ 
.
ÿÿ 
HasValue
ÿÿ '
)
ÿÿ' (
{
ŸŸ 
Result
⁄⁄ 
<
⁄⁄ &
SodiumSecureMemoryHandle
⁄⁄ /
?
⁄⁄/ 0
,
⁄⁄0 1%
EcliptixProtocolFailure
⁄⁄2 I
>
⁄⁄I J
findOpkResult
⁄⁄K X
=
⁄⁄Y Z 
FindLocalOpkHandle
€€ &
(
€€& '
usedLocalOpkId
€€' 5
.
€€5 6
Value
€€6 ;
)
€€; <
;
€€< =
if
‹‹ 
(
‹‹ 
findOpkResult
‹‹ !
.
‹‹! "
IsErr
‹‹" '
)
‹‹' (
{
›› 
return
ﬁﬁ 
Result
ﬁﬁ !
<
ﬁﬁ! "&
SodiumSecureMemoryHandle
ﬁﬁ" :
,
ﬁﬁ: ;%
EcliptixProtocolFailure
ﬁﬁ< S
>
ﬁﬁS T
.
ﬁﬁT U
Err
ﬁﬁU X
(
ﬁﬁX Y
findOpkResult
ﬁﬁY f
.
ﬁﬁf g
	UnwrapErr
ﬁﬁg p
(
ﬁﬁp q
)
ﬁﬁq r
)
ﬁﬁr s
;
ﬁﬁs t
}
ﬂﬂ 
opkSecretHandle
·· 
=
··  !
findOpkResult
··" /
.
··/ 0
Unwrap
··0 6
(
··6 7
)
··7 8
;
··8 9
}
‚‚ 
byte
‰‰ 
[
‰‰ 
]
‰‰ !
remoteIdentityArray
‰‰ &
=
‰‰' (&
remoteIdentityPublicKeyX
‰‰) A
.
‰‰A B
ToArray
‰‰B I
(
‰‰I J
)
‰‰J K
;
‰‰K L
byte
ÂÂ 
[
ÂÂ 
]
ÂÂ "
remoteEphemeralArray
ÂÂ '
=
ÂÂ( )'
remoteEphemeralPublicKeyX
ÂÂ* C
.
ÂÂC D
ToArray
ÂÂD K
(
ÂÂK L
)
ÂÂL M
;
ÂÂM N
byte
ÊÊ 
[
ÊÊ 
]
ÊÊ 
	infoArray
ÊÊ 
=
ÊÊ 
info
ÊÊ #
.
ÊÊ# $
ToArray
ÊÊ$ +
(
ÊÊ+ ,
)
ÊÊ, -
;
ÊÊ- .
int
ËË 
totalDhLength
ËË 
=
ËË 
	Constants
ËË  )
.
ËË) *
X_25519_KEY_SIZE
ËË* :
*
ËË; <
$num
ËË= >
+
ËË? @
(
ËËA B
opkSecretHandle
ËËB Q
!=
ËËR T
null
ËËU Y
?
ËËZ [
	Constants
ËË\ e
.
ËËe f
X_25519_KEY_SIZE
ËËf v
:
ËËw x
$num
ËËy z
)
ËËz {
;
ËË{ |
return
ÈÈ 
SecureMemoryUtils
ÈÈ $
.
ÈÈ$ %
WithSecureBuffers
ÈÈ% 6
(
ÈÈ6 7
[
ÍÍ 
	Constants
ÎÎ 
.
ÎÎ &
X_25519_PRIVATE_KEY_SIZE
ÎÎ 6
,
ÎÎ6 7
	Constants
ÎÎ8 A
.
ÎÎA B&
X_25519_PRIVATE_KEY_SIZE
ÎÎB Z
,
ÎÎZ [
	Constants
ÎÎ\ e
.
ÎÎe f&
X_25519_PRIVATE_KEY_SIZE
ÎÎf ~
,
ÎÎ~ 
	Constants
ÏÏ 
.
ÏÏ 
X_25519_KEY_SIZE
ÏÏ .
*
ÏÏ/ 0
$num
ÏÏ1 2
,
ÏÏ2 3
	Constants
ÏÏ4 =
.
ÏÏ= >
X_25519_KEY_SIZE
ÏÏ> N
+
ÏÏO P
totalDhLength
ÏÏQ ^
,
ÏÏ^ _
	Constants
ÏÏ` i
.
ÏÏi j
X_25519_KEY_SIZE
ÏÏj z
]
ÌÌ 
,
ÌÌ 
buffers
ÓÓ 
=>
ÓÓ 
{
ÔÔ 
Span
 
<
 
byte
 
>
  
identitySecretSpan
 1
=
2 3
buffers
4 ;
[
; <
$num
< =
]
= >
.
> ?
GetSpan
? F
(
F G
)
G H
[
H I
..
I K
	Constants
K T
.
T U&
X_25519_PRIVATE_KEY_SIZE
U m
]
m n
;
n o
Span
ÒÒ 
<
ÒÒ 
byte
ÒÒ 
>
ÒÒ $
signedPreKeySecretSpan
ÒÒ 5
=
ÒÒ6 7
buffers
ÒÒ8 ?
[
ÒÒ? @
$num
ÒÒ@ A
]
ÒÒA B
.
ÒÒB C
GetSpan
ÒÒC J
(
ÒÒJ K
)
ÒÒK L
[
ÒÒL M
..
ÒÒM O
	Constants
ÒÒO X
.
ÒÒX Y&
X_25519_PRIVATE_KEY_SIZE
ÒÒY q
]
ÒÒq r
;
ÒÒr s
Span
ÚÚ 
<
ÚÚ 
byte
ÚÚ 
>
ÚÚ %
oneTimePreKeySecretSpan
ÚÚ 6
=
ÚÚ7 8
buffers
ÚÚ9 @
[
ÚÚ@ A
$num
ÚÚA B
]
ÚÚB C
.
ÚÚC D
GetSpan
ÚÚD K
(
ÚÚK L
)
ÚÚL M
[
ÚÚM N
..
ÚÚN P
	Constants
ÚÚP Y
.
ÚÚY Z&
X_25519_PRIVATE_KEY_SIZE
ÚÚZ r
]
ÚÚr s
;
ÚÚs t
Span
ÛÛ 
<
ÛÛ 
byte
ÛÛ 
>
ÛÛ 
dhResultsSpan
ÛÛ ,
=
ÛÛ- .
buffers
ÛÛ/ 6
[
ÛÛ6 7
$num
ÛÛ7 8
]
ÛÛ8 9
.
ÛÛ9 :
GetSpan
ÛÛ: A
(
ÛÛA B
)
ÛÛB C
[
ÛÛC D
..
ÛÛD F
(
ÛÛF G
	Constants
ÛÛG P
.
ÛÛP Q
X_25519_KEY_SIZE
ÛÛQ a
*
ÛÛb c
$num
ÛÛd e
)
ÛÛe f
]
ÛÛf g
;
ÛÛg h
Span
ÙÙ 
<
ÙÙ 
byte
ÙÙ 
>
ÙÙ 
ikmSpan
ÙÙ &
=
ÙÙ' (
buffers
ÙÙ) 0
[
ÙÙ0 1
$num
ÙÙ1 2
]
ÙÙ2 3
.
ÙÙ3 4
GetSpan
ÙÙ4 ;
(
ÙÙ; <
)
ÙÙ< =
[
ÙÙ= >
..
ÙÙ> @
(
ÙÙ@ A
	Constants
ÙÙA J
.
ÙÙJ K
X_25519_KEY_SIZE
ÙÙK [
+
ÙÙ\ ]
totalDhLength
ÙÙ^ k
)
ÙÙk l
]
ÙÙl m
;
ÙÙm n
Span
ıı 
<
ıı 
byte
ıı 
>
ıı 
hkdfOutputSpan
ıı -
=
ıı. /
buffers
ıı0 7
[
ıı7 8
$num
ıı8 9
]
ıı9 :
.
ıı: ;
GetSpan
ıı; B
(
ııB C
)
ııC D
[
ııD E
..
ııE G
	Constants
ııG P
.
ııP Q
X_25519_KEY_SIZE
ııQ a
]
ııa b
;
ııb c
Result
˜˜ 
<
˜˜ 
byte
˜˜ 
[
˜˜  
]
˜˜  !
,
˜˜! "%
EcliptixProtocolFailure
˜˜# :
>
˜˜: ;
readIdResult
˜˜< H
=
˜˜I J,
_identityX25519SecretKeyHandle
˜˜K i
.
¯¯ 
	ReadBytes
¯¯ "
(
¯¯" #
	Constants
¯¯# ,
.
¯¯, -&
X_25519_PRIVATE_KEY_SIZE
¯¯- E
)
¯¯E F
.
˘˘ 
MapSodiumFailure
˘˘ )
(
˘˘) *
)
˘˘* +
;
˘˘+ ,
if
˙˙ 
(
˙˙ 
readIdResult
˙˙ $
.
˙˙$ %
IsErr
˙˙% *
)
˙˙* +
{
˚˚ 
return
¸¸ 
Result
¸¸ %
<
¸¸% &&
SodiumSecureMemoryHandle
¸¸& >
,
¸¸> ?%
EcliptixProtocolFailure
¸¸@ W
>
¸¸W X
.
¸¸X Y
Err
¸¸Y \
(
¸¸\ ]
readIdResult
¸¸] i
.
¸¸i j
	UnwrapErr
¸¸j s
(
¸¸s t
)
¸¸t u
)
¸¸u v
;
¸¸v w
}
˝˝ 
byte
ˇˇ 
[
ˇˇ 
]
ˇˇ !
identitySecretBytes
ˇˇ .
=
ˇˇ/ 0
readIdResult
ˇˇ1 =
.
ˇˇ= >
Unwrap
ˇˇ> D
(
ˇˇD E
)
ˇˇE F
;
ˇˇF G!
identitySecretBytes
ÄÄ '
.
ÄÄ' (
CopyTo
ÄÄ( .
(
ÄÄ. / 
identitySecretSpan
ÄÄ/ A
)
ÄÄA B
;
ÄÄB C
SodiumInterop
ÅÅ !
.
ÅÅ! "

SecureWipe
ÅÅ" ,
(
ÅÅ, -!
identitySecretBytes
ÅÅ- @
)
ÅÅ@ A
;
ÅÅA B
Result
ÉÉ 
<
ÉÉ 
byte
ÉÉ 
[
ÉÉ  
]
ÉÉ  !
,
ÉÉ! "%
EcliptixProtocolFailure
ÉÉ# :
>
ÉÉ: ;
readSpkResult
ÉÉ< I
=
ÉÉJ K*
_signedPreKeySecretKeyHandle
ÉÉL h
.
ÑÑ 
	ReadBytes
ÑÑ "
(
ÑÑ" #
	Constants
ÑÑ# ,
.
ÑÑ, -&
X_25519_PRIVATE_KEY_SIZE
ÑÑ- E
)
ÑÑE F
.
ÖÖ 
MapSodiumFailure
ÖÖ )
(
ÖÖ) *
)
ÖÖ* +
;
ÖÖ+ ,
if
ÜÜ 
(
ÜÜ 
readSpkResult
ÜÜ %
.
ÜÜ% &
IsErr
ÜÜ& +
)
ÜÜ+ ,
{
áá 
return
àà 
Result
àà %
<
àà% &&
SodiumSecureMemoryHandle
àà& >
,
àà> ?%
EcliptixProtocolFailure
àà@ W
>
ààW X
.
ààX Y
Err
ààY \
(
àà\ ]
readSpkResult
àà] j
.
ààj k
	UnwrapErr
ààk t
(
ààt u
)
ààu v
)
ààv w
;
ààw x
}
ââ 
byte
ãã 
[
ãã 
]
ãã %
signedPreKeySecretBytes
ãã 2
=
ãã3 4
readSpkResult
ãã5 B
.
ããB C
Unwrap
ããC I
(
ããI J
)
ããJ K
;
ããK L%
signedPreKeySecretBytes
åå +
.
åå+ ,
CopyTo
åå, 2
(
åå2 3$
signedPreKeySecretSpan
åå3 I
)
ååI J
;
ååJ K
SodiumInterop
çç !
.
çç! "

SecureWipe
çç" ,
(
çç, -%
signedPreKeySecretBytes
çç- D
)
ççD E
;
ççE F
bool
èè 
useOpk
èè 
=
èè  !
opkSecretHandle
èè" 1
!=
èè2 4
null
èè5 9
;
èè9 :
if
êê 
(
êê 
useOpk
êê 
)
êê 
{
ëë 
Result
íí 
<
íí 
byte
íí #
[
íí# $
]
íí$ %
,
íí% &%
EcliptixProtocolFailure
íí' >
>
íí> ?
readOpkResult
íí@ M
=
ííN O
opkSecretHandle
ííP _
!
íí_ `
.
ìì 
	ReadBytes
ìì &
(
ìì& '
	Constants
ìì' 0
.
ìì0 1&
X_25519_PRIVATE_KEY_SIZE
ìì1 I
)
ììI J
.
îî 
MapSodiumFailure
îî -
(
îî- .
)
îî. /
;
îî/ 0
if
ïï 
(
ïï 
readOpkResult
ïï )
.
ïï) *
IsErr
ïï* /
)
ïï/ 0
{
ññ 
return
óó "
Result
óó# )
<
óó) *&
SodiumSecureMemoryHandle
óó* B
,
óóB C%
EcliptixProtocolFailure
óóD [
>
óó[ \
.
óó\ ]
Err
óó] `
(
óó` a
readOpkResult
òò  -
.
òò- .
	UnwrapErr
òò. 7
(
òò7 8
)
òò8 9
)
òò9 :
;
òò: ;
}
ôô 
byte
õõ 
[
õõ 
]
õõ &
oneTimePreKeySecretBytes
õõ 7
=
õõ8 9
readOpkResult
õõ: G
.
õõG H
Unwrap
õõH N
(
õõN O
)
õõO P
;
õõP Q&
oneTimePreKeySecretBytes
úú 0
.
úú0 1
CopyTo
úú1 7
(
úú7 8%
oneTimePreKeySecretSpan
úú8 O
)
úúO P
;
úúP Q
SodiumInterop
ùù %
.
ùù% &

SecureWipe
ùù& 0
(
ùù0 1&
oneTimePreKeySecretBytes
ùù1 I
)
ùùI J
;
ùùJ K
}
ûû 
byte
†† 
[
†† 
]
†† 
?
†† !
identitySecretArray
†† /
=
††0 1
null
††2 6
;
††6 7
byte
°° 
[
°° 
]
°° 
?
°° %
signedPreKeySecretArray
°° 3
=
°°4 5
null
°°6 :
;
°°: ;
byte
¢¢ 
[
¢¢ 
]
¢¢ 
?
¢¢ &
oneTimePreKeySecretArray
¢¢ 4
=
¢¢5 6
null
¢¢7 ;
;
¢¢; <
byte
££ 
[
££ 
]
££ 
?
££ 
dh1
££ 
=
££  !
null
££" &
;
££& '
byte
§§ 
[
§§ 
]
§§ 
?
§§ 
dh2
§§ 
=
§§  !
null
§§" &
;
§§& '
byte
•• 
[
•• 
]
•• 
?
•• 
dh3
•• 
=
••  !
null
••" &
;
••& '
int
¶¶ 
dhOffset
¶¶  
=
¶¶! "
$num
¶¶# $
;
¶¶$ %
try
®® 
{
©© !
identitySecretArray
™™ +
=
™™, - 
identitySecretSpan
™™. @
.
™™@ A
ToArray
™™A H
(
™™H I
)
™™I J
;
™™J K%
signedPreKeySecretArray
´´ /
=
´´0 1$
signedPreKeySecretSpan
´´2 H
.
´´H I
ToArray
´´I P
(
´´P Q
)
´´Q R
;
´´R S
if
¨¨ 
(
¨¨ 
useOpk
¨¨ "
)
¨¨" #
{
≠≠ &
oneTimePreKeySecretArray
ÆÆ 4
=
ÆÆ5 6%
oneTimePreKeySecretSpan
ÆÆ7 N
.
ÆÆN O
ToArray
ÆÆO V
(
ÆÆV W
)
ÆÆW X
;
ÆÆX Y
}
ØØ 
dh1
±± 
=
±± 

ScalarMult
±± (
.
±±( )
Mult
±±) -
(
±±- .!
identitySecretArray
±±. A
,
±±A B"
remoteEphemeralArray
±±C W
)
±±W X
;
±±X Y
dh2
≤≤ 
=
≤≤ 

ScalarMult
≤≤ (
.
≤≤( )
Mult
≤≤) -
(
≤≤- .%
signedPreKeySecretArray
≤≤. E
,
≤≤E F"
remoteEphemeralArray
≤≤G [
)
≤≤[ \
;
≤≤\ ]
dh3
≥≥ 
=
≥≥ 

ScalarMult
≥≥ (
.
≥≥( )
Mult
≥≥) -
(
≥≥- .%
signedPreKeySecretArray
≥≥. E
,
≥≥E F!
remoteIdentityArray
≥≥G Z
)
≥≥Z [
;
≥≥[ \
dh3
¥¥ 
.
¥¥ 
AsSpan
¥¥ "
(
¥¥" #
)
¥¥# $
.
¥¥$ %
CopyTo
¥¥% +
(
¥¥+ ,
dhResultsSpan
¥¥, 9
[
¥¥9 :
dhOffset
¥¥: B
..
¥¥B D
(
¥¥D E
dhOffset
¥¥E M
+
¥¥N O
	Constants
¥¥P Y
.
¥¥Y Z
X_25519_KEY_SIZE
¥¥Z j
)
¥¥j k
]
¥¥k l
)
¥¥l m
;
¥¥m n
dhOffset
µµ  
+=
µµ! #
	Constants
µµ$ -
.
µµ- .
X_25519_KEY_SIZE
µµ. >
;
µµ> ?
dh1
∂∂ 
.
∂∂ 
AsSpan
∂∂ "
(
∂∂" #
)
∂∂# $
.
∂∂$ %
CopyTo
∂∂% +
(
∂∂+ ,
dhResultsSpan
∂∂, 9
[
∂∂9 :
dhOffset
∂∂: B
..
∂∂B D
(
∂∂D E
dhOffset
∂∂E M
+
∂∂N O
	Constants
∂∂P Y
.
∂∂Y Z
X_25519_KEY_SIZE
∂∂Z j
)
∂∂j k
]
∂∂k l
)
∂∂l m
;
∂∂m n
dhOffset
∑∑  
+=
∑∑! #
	Constants
∑∑$ -
.
∑∑- .
X_25519_KEY_SIZE
∑∑. >
;
∑∑> ?
dh2
∏∏ 
.
∏∏ 
AsSpan
∏∏ "
(
∏∏" #
)
∏∏# $
.
∏∏$ %
CopyTo
∏∏% +
(
∏∏+ ,
dhResultsSpan
∏∏, 9
[
∏∏9 :
dhOffset
∏∏: B
..
∏∏B D
(
∏∏D E
dhOffset
∏∏E M
+
∏∏N O
	Constants
∏∏P Y
.
∏∏Y Z
X_25519_KEY_SIZE
∏∏Z j
)
∏∏j k
]
∏∏k l
)
∏∏l m
;
∏∏m n
dhOffset
ππ  
+=
ππ! #
	Constants
ππ$ -
.
ππ- .
X_25519_KEY_SIZE
ππ. >
;
ππ> ?
if
ªª 
(
ªª 
useOpk
ªª "
)
ªª" #
{
ºº 
byte
ΩΩ  
[
ΩΩ  !
]
ΩΩ! "
?
ΩΩ" #
dh4
ΩΩ$ '
=
ΩΩ( )
null
ΩΩ* .
;
ΩΩ. /
try
ææ 
{
øø 
dh4
¿¿  #
=
¿¿$ %

ScalarMult
¿¿& 0
.
¿¿0 1
Mult
¿¿1 5
(
¿¿5 6&
oneTimePreKeySecretArray
¿¿6 N
!
¿¿N O
,
¿¿O P"
remoteEphemeralArray
¿¿Q e
)
¿¿e f
;
¿¿f g
dh4
¡¡  #
.
¡¡# $
AsSpan
¡¡$ *
(
¡¡* +
)
¡¡+ ,
.
¡¡, -
CopyTo
¡¡- 3
(
¡¡3 4
dhResultsSpan
¡¡4 A
[
¡¡A B
dhOffset
¡¡B J
..
¡¡J L
(
¡¡L M
dhOffset
¡¡M U
+
¡¡V W
	Constants
¡¡X a
.
¡¡a b
X_25519_KEY_SIZE
¡¡b r
)
¡¡r s
]
¡¡s t
)
¡¡t u
;
¡¡u v
dhOffset
¬¬  (
+=
¬¬) +
	Constants
¬¬, 5
.
¬¬5 6
X_25519_KEY_SIZE
¬¬6 F
;
¬¬F G
}
√√ 
finally
ƒƒ #
{
≈≈ 
if
∆∆  "
(
∆∆# $
dh4
∆∆$ '
!=
∆∆( *
null
∆∆+ /
)
∆∆/ 0
{
««  !
SodiumInterop
»»$ 1
.
»»1 2

SecureWipe
»»2 <
(
»»< =
dh4
»»= @
)
»»@ A
;
»»A B
}
……  !
}
   
}
ÀÀ 
}
ÃÃ 
finally
ÕÕ 
{
ŒŒ 
if
œœ 
(
œœ !
identitySecretArray
œœ /
!=
œœ0 2
null
œœ3 7
)
œœ7 8
{
–– 
SodiumInterop
—— )
.
——) *

SecureWipe
——* 4
(
——4 5!
identitySecretArray
——5 H
)
——H I
;
——I J
}
““ 
if
‘‘ 
(
‘‘ %
signedPreKeySecretArray
‘‘ 3
!=
‘‘4 6
null
‘‘7 ;
)
‘‘; <
{
’’ 
SodiumInterop
÷÷ )
.
÷÷) *

SecureWipe
÷÷* 4
(
÷÷4 5%
signedPreKeySecretArray
÷÷5 L
)
÷÷L M
;
÷÷M N
}
◊◊ 
if
ŸŸ 
(
ŸŸ &
oneTimePreKeySecretArray
ŸŸ 4
!=
ŸŸ5 7
null
ŸŸ8 <
)
ŸŸ< =
{
⁄⁄ 
SodiumInterop
€€ )
.
€€) *

SecureWipe
€€* 4
(
€€4 5&
oneTimePreKeySecretArray
€€5 M
)
€€M N
;
€€N O
}
‹‹ 
if
ﬁﬁ 
(
ﬁﬁ 
dh1
ﬁﬁ 
!=
ﬁﬁ  "
null
ﬁﬁ# '
)
ﬁﬁ' (
{
ﬂﬂ 
SodiumInterop
‡‡ )
.
‡‡) *

SecureWipe
‡‡* 4
(
‡‡4 5
dh1
‡‡5 8
)
‡‡8 9
;
‡‡9 :
}
·· 
if
„„ 
(
„„ 
dh2
„„ 
!=
„„  "
null
„„# '
)
„„' (
{
‰‰ 
SodiumInterop
ÂÂ )
.
ÂÂ) *

SecureWipe
ÂÂ* 4
(
ÂÂ4 5
dh2
ÂÂ5 8
)
ÂÂ8 9
;
ÂÂ9 :
}
ÊÊ 
if
ËË 
(
ËË 
dh3
ËË 
!=
ËË  "
null
ËË# '
)
ËË' (
{
ÈÈ 
SodiumInterop
ÍÍ )
.
ÍÍ) *

SecureWipe
ÍÍ* 4
(
ÍÍ4 5
dh3
ÍÍ5 8
)
ÍÍ8 9
;
ÍÍ9 :
}
ÎÎ 
}
ÏÏ 
Span
ÓÓ 
<
ÓÓ 
byte
ÓÓ 
>
ÓÓ 
ikmBuildSpan
ÓÓ +
=
ÓÓ, -
ikmSpan
ÓÓ. 5
[
ÓÓ5 6
..
ÓÓ6 8
(
ÓÓ8 9
	Constants
ÓÓ9 B
.
ÓÓB C
X_25519_KEY_SIZE
ÓÓC S
+
ÓÓT U
dhOffset
ÓÓV ^
)
ÓÓ^ _
]
ÓÓ_ `
;
ÓÓ` a
ikmBuildSpan
ÔÔ  
[
ÔÔ  !
..
ÔÔ! #
	Constants
ÔÔ# ,
.
ÔÔ, -
X_25519_KEY_SIZE
ÔÔ- =
]
ÔÔ= >
.
ÔÔ> ?
Fill
ÔÔ? C
(
ÔÔC D
$num
ÔÔD H
)
ÔÔH I
;
ÔÔI J
dhResultsSpan
 !
[
! "
..
" $
dhOffset
$ ,
]
, -
.
- .
CopyTo
. 4
(
4 5
ikmBuildSpan
5 A
[
A B
	Constants
B K
.
K L
X_25519_KEY_SIZE
L \
..
\ ^
]
^ _
)
_ `
;
` a
byte
ÚÚ 
[
ÚÚ 
]
ÚÚ 
?
ÚÚ 
ikmArray
ÚÚ $
=
ÚÚ% &
null
ÚÚ' +
;
ÚÚ+ ,
try
ÛÛ 
{
ÙÙ 
ikmArray
ıı  
=
ıı! "
ikmBuildSpan
ıı# /
.
ıı/ 0
ToArray
ıı0 7
(
ıı7 8
)
ıı8 9
;
ıı9 :
HKDF
˜˜ 
.
˜˜ 
	DeriveKey
˜˜ &
(
˜˜& '
global
¯¯ "
::
¯¯" $
System
¯¯$ *
.
¯¯* +
Security
¯¯+ 3
.
¯¯3 4
Cryptography
¯¯4 @
.
¯¯@ A
HashAlgorithmName
¯¯A R
.
¯¯R S
SHA256
¯¯S Y
,
¯¯Y Z
ikm
˘˘ 
:
˘˘  
ikmArray
˘˘! )
,
˘˘) *
output
˙˙ "
:
˙˙" #
hkdfOutputSpan
˙˙$ 2
,
˙˙2 3
salt
˚˚  
:
˚˚  !
null
˚˚" &
,
˚˚& '
info
¸¸  
:
¸¸  !
	infoArray
¸¸" +
)
˝˝ 
;
˝˝ 
}
ˇˇ 
finally
ÄÄ 
{
ÅÅ 
if
ÇÇ 
(
ÇÇ 
ikmArray
ÇÇ $
!=
ÇÇ% '
null
ÇÇ( ,
)
ÇÇ, -
{
ÉÉ 
SodiumInterop
ÑÑ )
.
ÑÑ) *

SecureWipe
ÑÑ* 4
(
ÑÑ4 5
ikmArray
ÑÑ5 =
)
ÑÑ= >
;
ÑÑ> ?
}
ÖÖ 
}
ÜÜ 
Result
àà 
<
àà &
SodiumSecureMemoryHandle
àà 3
,
àà3 4%
EcliptixProtocolFailure
àà5 L
>
ààL M
allocResult
ààN Y
=
ààZ [&
SodiumSecureMemoryHandle
ââ 0
.
ââ0 1
Allocate
ââ1 9
(
ââ9 :
	Constants
ââ: C
.
ââC D
X_25519_KEY_SIZE
ââD T
)
ââT U
.
ââU V
MapSodiumFailure
ââV f
(
ââf g
)
ââg h
;
ââh i
if
ää 
(
ää 
allocResult
ää #
.
ää# $
IsErr
ää$ )
)
ää) *
{
ãã 
return
åå 
Result
åå %
<
åå% &&
SodiumSecureMemoryHandle
åå& >
,
åå> ?%
EcliptixProtocolFailure
åå@ W
>
ååW X
.
ååX Y
Err
ååY \
(
åå\ ]
allocResult
åå] h
.
ååh i
	UnwrapErr
ååi r
(
åår s
)
åås t
)
ååt u
;
ååu v
}
çç  
secureOutputHandle
èè &
=
èè' (
allocResult
èè) 4
.
èè4 5
Unwrap
èè5 ;
(
èè; <
)
èè< =
;
èè= >
Result
êê 
<
êê 
Unit
êê 
,
êê  %
EcliptixProtocolFailure
êê! 8
>
êê8 9
writeResult
êê: E
=
êêF G 
secureOutputHandle
ëë *
.
ëë* +
Write
ëë+ 0
(
ëë0 1
hkdfOutputSpan
ëë1 ?
)
ëë? @
.
ëë@ A
MapSodiumFailure
ëëA Q
(
ëëQ R
)
ëëR S
;
ëëS T
if
íí 
(
íí 
writeResult
íí #
.
íí# $
IsErr
íí$ )
)
íí) *
{
ìì  
secureOutputHandle
îî *
.
îî* +
Dispose
îî+ 2
(
îî2 3
)
îî3 4
;
îî4 5
return
ïï 
Result
ïï %
<
ïï% &&
SodiumSecureMemoryHandle
ïï& >
,
ïï> ?%
EcliptixProtocolFailure
ïï@ W
>
ïïW X
.
ïïX Y
Err
ïïY \
(
ïï\ ]
writeResult
ïï] h
.
ïïh i
	UnwrapErr
ïïi r
(
ïïr s
)
ïïs t
)
ïït u
;
ïïu v
}
ññ &
SodiumSecureMemoryHandle
òò ,
?
òò, -
returnHandle
òò. :
=
òò; < 
secureOutputHandle
òò= O
;
òòO P 
secureOutputHandle
ôô &
=
ôô' (
null
ôô) -
;
ôô- .
return
öö 
Result
öö !
<
öö! "&
SodiumSecureMemoryHandle
öö" :
,
öö: ;%
EcliptixProtocolFailure
öö< S
>
ööS T
.
ööT U
Ok
ööU W
(
ööW X
returnHandle
ööX d
)
ööd e
;
ööe f
}
õõ 
)
õõ 
;
õõ 
}
úú 	
catch
ùù 
(
ùù 
	Exception
ùù 
ex
ùù 
)
ùù 
{
ûû 	
return
üü 
Result
üü 
<
üü &
SodiumSecureMemoryHandle
üü 2
,
üü2 3%
EcliptixProtocolFailure
üü4 K
>
üüK L
.
üüL M
Err
üüM P
(
üüP Q%
EcliptixProtocolFailure
†† '
.
††' (
	DeriveKey
††( 1
(
††1 2-
EcliptixProtocolFailureMessages
°° 3
.
°°3 4
IdentityKeys
°°4 @
.
°°@ A:
,UNEXPECTED_ERROR_DURING_RECIPIENT_DERIVATION
°°A m
,
°°m n
ex
°°o q
)
°°q r
)
°°r s
;
°°s t
}
¢¢ 	
finally
££ 
{
§§ 	 
secureOutputHandle
•• 
?
•• 
.
••  
Dispose
••  '
(
••' (
)
••( )
;
••) *
}
¶¶ 	
}
ßß 
public
©© 

static
©© 
Result
©© 
<
©© 
bool
©© 
,
©© %
EcliptixProtocolFailure
©© 6
>
©©6 7&
VerifyRemoteSpkSignature
©©8 P
(
©©P Q
ReadOnlySpan
™™ 
<
™™ 
byte
™™ 
>
™™ #
remoteIdentityEd25519
™™ 0
,
™™0 1
ReadOnlySpan
™™2 >
<
™™> ?
byte
™™? C
>
™™C D
remoteSpkPublic
™™E T
,
™™T U
ReadOnlySpan
´´ 
<
´´ 
byte
´´ 
>
´´  
remoteSpkSignature
´´ -
)
´´- .
{
¨¨ 
if
≠≠ 

(
≠≠ #
remoteIdentityEd25519
≠≠ !
.
≠≠! "
Length
≠≠" (
!=
≠≠) +
	Constants
≠≠, 5
.
≠≠5 6&
ED_25519_PUBLIC_KEY_SIZE
≠≠6 N
||
≠≠O Q
remoteSpkPublic
ÆÆ 
.
ÆÆ 
Length
ÆÆ "
!=
ÆÆ# %
	Constants
ÆÆ& /
.
ÆÆ/ 0%
X_25519_PUBLIC_KEY_SIZE
ÆÆ0 G
||
ÆÆH J 
remoteSpkSignature
ØØ 
.
ØØ 
Length
ØØ %
!=
ØØ& (
	Constants
ØØ) 2
.
ØØ2 3%
ED_25519_SIGNATURE_SIZE
ØØ3 J
)
ØØJ K
{
∞∞ 	
return
±± 
Result
±± 
<
±± 
bool
±± 
,
±± %
EcliptixProtocolFailure
±±  7
>
±±7 8
.
±±8 9
Err
±±9 <
(
±±< =%
EcliptixProtocolFailure
≤≤ '
.
≤≤' (
InvalidInput
≤≤( 4
(
≤≤4 5-
EcliptixProtocolFailureMessages
≤≤5 T
.
≤≤T U
IdentityKeys
≤≤U a
.
≤≤a bC
4INVALID_KEY_OR_SIGNATURE_LENGTH_FOR_SPK_VERIFICATION≤≤b ñ
)≤≤ñ ó
)≤≤ó ò
;≤≤ò ô
}
≥≥ 	
byte
µµ 
[
µµ 
]
µµ 
?
µµ 
signatureArray
µµ 
=
µµ  
null
µµ! %
;
µµ% &
byte
∂∂ 
[
∂∂ 
]
∂∂ 
?
∂∂ 
spkPublicArray
∂∂ 
=
∂∂  
null
∂∂! %
;
∂∂% &
byte
∑∑ 
[
∑∑ 
]
∑∑ 
?
∑∑ 
identityArray
∑∑ 
=
∑∑ 
null
∑∑  $
;
∑∑$ %
try
ππ 
{
∫∫ 	
signatureArray
ªª 
=
ªª  
remoteSpkSignature
ªª /
.
ªª/ 0
ToArray
ªª0 7
(
ªª7 8
)
ªª8 9
;
ªª9 :
spkPublicArray
ºº 
=
ºº 
remoteSpkPublic
ºº ,
.
ºº, -
ToArray
ºº- 4
(
ºº4 5
)
ºº5 6
;
ºº6 7
identityArray
ΩΩ 
=
ΩΩ #
remoteIdentityEd25519
ΩΩ 1
.
ΩΩ1 2
ToArray
ΩΩ2 9
(
ΩΩ9 :
)
ΩΩ: ;
;
ΩΩ; <
bool
øø  
verificationResult
øø #
=
øø$ %
PublicKeyAuth
øø& 3
.
øø3 4
VerifyDetached
øø4 B
(
øøB C
signatureArray
øøC Q
,
øøQ R
spkPublicArray
øøS a
,
øøa b
identityArray
øøc p
)
øøp q
;
øøq r
return
¡¡  
verificationResult
¡¡ %
?
¬¬ 
Result
¬¬ 
<
¬¬ 
bool
¬¬ 
,
¬¬ %
EcliptixProtocolFailure
¬¬ 6
>
¬¬6 7
.
¬¬7 8
Ok
¬¬8 :
(
¬¬: ;
true
¬¬; ?
)
¬¬? @
:
√√ 
Result
√√ 
<
√√ 
bool
√√ 
,
√√ %
EcliptixProtocolFailure
√√ 6
>
√√6 7
.
√√7 8
Err
√√8 ;
(
√√; <%
EcliptixProtocolFailure
ƒƒ +
.
ƒƒ+ ,
	Handshake
ƒƒ, 5
(
ƒƒ5 6-
EcliptixProtocolFailureMessages
ƒƒ6 U
.
ƒƒU V
IdentityKeys
ƒƒV b
.
ƒƒb c7
(REMOTE_SPK_SIGNATURE_VERIFICATION_FAILEDƒƒc ã
)ƒƒã å
)ƒƒå ç
;ƒƒç é
}
≈≈ 	
finally
∆∆ 
{
«« 	
if
»» 
(
»» 
signatureArray
»» 
!=
»» !
null
»»" &
)
»»& '
{
…… 
SodiumInterop
   
.
   

SecureWipe
   (
(
  ( )
signatureArray
  ) 7
)
  7 8
;
  8 9
}
ÀÀ 
if
ÕÕ 
(
ÕÕ 
spkPublicArray
ÕÕ 
!=
ÕÕ !
null
ÕÕ" &
)
ÕÕ& '
{
ŒŒ 
SodiumInterop
œœ 
.
œœ 

SecureWipe
œœ (
(
œœ( )
spkPublicArray
œœ) 7
)
œœ7 8
;
œœ8 9
}
–– 
if
““ 
(
““ 
identityArray
““ 
!=
““  
null
““! %
)
““% &
{
”” 
SodiumInterop
‘‘ 
.
‘‘ 

SecureWipe
‘‘ (
(
‘‘( )
identityArray
‘‘) 6
)
‘‘6 7
;
‘‘7 8
}
’’ 
}
÷÷ 	
}
◊◊ 
private
ŸŸ 
Result
ŸŸ 
<
ŸŸ 
Unit
ŸŸ 
,
ŸŸ %
EcliptixProtocolFailure
ŸŸ 0
>
ŸŸ0 1
CheckDisposed
ŸŸ2 ?
(
ŸŸ? @
)
ŸŸ@ A
{
⁄⁄ 
return
€€ 
	_disposed
€€ 
?
‹‹ 
Result
‹‹ 
<
‹‹ 
Unit
‹‹ 
,
‹‹ %
EcliptixProtocolFailure
‹‹ 2
>
‹‹2 3
.
‹‹3 4
Err
‹‹4 7
(
‹‹7 8%
EcliptixProtocolFailure
›› '
.
››' (
OBJECT_DISPOSED
››( 7
(
››7 8
nameof
››8 >
(
››> ?(
EcliptixSystemIdentityKeys
››? Y
)
››Y Z
)
››Z [
)
››[ \
:
ﬁﬁ 
Result
ﬁﬁ 
<
ﬁﬁ 
Unit
ﬁﬁ 
,
ﬁﬁ %
EcliptixProtocolFailure
ﬁﬁ 2
>
ﬁﬁ2 3
.
ﬁﬁ3 4
Ok
ﬁﬁ4 6
(
ﬁﬁ6 7
Unit
ﬁﬁ7 ;
.
ﬁﬁ; <
Value
ﬁﬁ< A
)
ﬁﬁA B
;
ﬁﬁB C
}
ﬂﬂ 
private
·· 
static
·· 
Result
·· 
<
·· 
Unit
·· 
,
·· %
EcliptixProtocolFailure
··  7
>
··7 8
ValidateHkdfInfo
··9 I
(
··I J
ReadOnlySpan
··J V
<
··V W
byte
··W [
>
··[ \
info
··] a
)
··a b
{
‚‚ 
return
„„ 
info
„„ 
.
„„ 
IsEmpty
„„ 
?
‰‰ 
Result
‰‰ 
<
‰‰ 
Unit
‰‰ 
,
‰‰ %
EcliptixProtocolFailure
‰‰ 2
>
‰‰2 3
.
‰‰3 4
Err
‰‰4 7
(
‰‰7 8%
EcliptixProtocolFailure
‰‰8 O
.
‰‰O P
	DeriveKey
‰‰P Y
(
‰‰Y Z-
EcliptixProtocolFailureMessages
‰‰Z y
.
‰‰y z
IdentityKeys‰‰z Ü
.‰‰Ü á)
HKDF_INFO_CANNOT_BE_EMPTY‰‰á †
)‰‰† °
)‰‰° ¢
:
ÂÂ 
Result
ÂÂ 
<
ÂÂ 
Unit
ÂÂ 
,
ÂÂ %
EcliptixProtocolFailure
ÂÂ 2
>
ÂÂ2 3
.
ÂÂ3 4
Ok
ÂÂ4 6
(
ÂÂ6 7
Unit
ÂÂ7 ;
.
ÂÂ; <
Value
ÂÂ< A
)
ÂÂA B
;
ÂÂB C
}
ÊÊ 
private
ËË 
static
ËË 
Result
ËË 
<
ËË 
Unit
ËË 
,
ËË %
EcliptixProtocolFailure
ËË  7
>
ËË7 8"
ValidateRemoteBundle
ËË9 M
(
ËËM N"
LocalPublicKeyBundle
ËËN b
?
ËËb c
remoteBundle
ËËd p
)
ËËp q
{
ÈÈ 
if
ÍÍ 

(
ÍÍ 
remoteBundle
ÍÍ 
==
ÍÍ 
null
ÍÍ  
)
ÍÍ  !
{
ÎÎ 	
return
ÏÏ 
Result
ÏÏ 
<
ÏÏ 
Unit
ÏÏ 
,
ÏÏ %
EcliptixProtocolFailure
ÏÏ  7
>
ÏÏ7 8
.
ÏÏ8 9
Err
ÏÏ9 <
(
ÏÏ< =%
EcliptixProtocolFailure
ÌÌ '
.
ÌÌ' (
InvalidInput
ÌÌ( 4
(
ÌÌ4 5-
EcliptixProtocolFailureMessages
ÌÌ5 T
.
ÌÌT U
IdentityKeys
ÌÌU a
.
ÌÌa b*
REMOTE_BUNDLE_CANNOT_BE_NULL
ÌÌb ~
)
ÌÌ~ 
)ÌÌ Ä
;ÌÌÄ Å
}
ÓÓ 	
if
 

(
 
remoteBundle
 
.
 
IdentityX25519
 '
is
( *
not
+ .
{
/ 0
Length
1 7
:
7 8
	Constants
9 B
.
B C%
X_25519_PUBLIC_KEY_SIZE
C Z
}
[ \
)
\ ]
{
ÒÒ 	
return
ÚÚ 
Result
ÚÚ 
<
ÚÚ 
Unit
ÚÚ 
,
ÚÚ %
EcliptixProtocolFailure
ÚÚ  7
>
ÚÚ7 8
.
ÚÚ8 9
Err
ÚÚ9 <
(
ÚÚ< =%
EcliptixProtocolFailure
ÛÛ '
.
ÛÛ' (

PeerPubKey
ÛÛ( 2
(
ÛÛ2 3-
EcliptixProtocolFailureMessages
ÛÛ3 R
.
ÛÛR S
IdentityKeys
ÛÛS _
.
ÛÛ_ `2
#INVALID_REMOTE_IDENTITY_X_25519_KEYÛÛ` É
)ÛÛÉ Ñ
)ÛÛÑ Ö
;ÛÛÖ Ü
}
ÙÙ 	
if
ˆˆ 

(
ˆˆ 
remoteBundle
ˆˆ 
.
ˆˆ  
SignedPreKeyPublic
ˆˆ +
is
ˆˆ, .
not
ˆˆ/ 2
{
ˆˆ3 4
Length
ˆˆ5 ;
:
ˆˆ; <
	Constants
ˆˆ= F
.
ˆˆF G%
X_25519_PUBLIC_KEY_SIZE
ˆˆG ^
}
ˆˆ_ `
)
ˆˆ` a
{
˜˜ 	
return
¯¯ 
Result
¯¯ 
<
¯¯ 
Unit
¯¯ 
,
¯¯ %
EcliptixProtocolFailure
¯¯  7
>
¯¯7 8
.
¯¯8 9
Err
¯¯9 <
(
¯¯< =%
EcliptixProtocolFailure
˘˘ '
.
˘˘' (

PeerPubKey
˘˘( 2
(
˘˘2 3-
EcliptixProtocolFailureMessages
˘˘3 R
.
˘˘R S
IdentityKeys
˘˘S _
.
˘˘_ `7
(INVALID_REMOTE_SIGNED_PRE_KEY_PUBLIC_KEY˘˘` à
)˘˘à â
)˘˘â ä
;˘˘ä ã
}
˙˙ 	
return
¸¸ 
Result
¸¸ 
<
¸¸ 
Unit
¸¸ 
,
¸¸ %
EcliptixProtocolFailure
¸¸ 3
>
¸¸3 4
.
¸¸4 5
Ok
¸¸5 7
(
¸¸7 8
Unit
¸¸8 <
.
¸¸< =
Value
¸¸= B
)
¸¸B C
;
¸¸C D
}
˝˝ 
private
ˇˇ 
Result
ˇˇ 
<
ˇˇ 
Unit
ˇˇ 
,
ˇˇ %
EcliptixProtocolFailure
ˇˇ 0
>
ˇˇ0 1"
EnsureLocalKeysValid
ˇˇ2 F
(
ˇˇF G
)
ˇˇG H
{
Ä	Ä	 
if
Å	Å	 

(
Å	Å	 '
_ephemeralSecretKeyHandle
Å	Å	 %
==
Å	Å	& (
null
Å	Å	) -
||
Å	Å	. 0'
_ephemeralSecretKeyHandle
Å	Å	1 J
.
Å	Å	J K
	IsInvalid
Å	Å	K T
)
Å	Å	T U
{
Ç	Ç	 	
return
É	É	 
Result
É	É	 
<
É	É	 
Unit
É	É	 
,
É	É	 %
EcliptixProtocolFailure
É	É	  7
>
É	É	7 8
.
É	É	8 9
Err
É	É	9 <
(
É	É	< =%
EcliptixProtocolFailure
Ñ	Ñ	 '
.
Ñ	Ñ	' (
PrepareLocal
Ñ	Ñ	( 4
(
Ñ	Ñ	4 5-
EcliptixProtocolFailureMessages
Ñ	Ñ	5 T
.
Ñ	Ñ	T U
IdentityKeys
Ñ	Ñ	U a
.
Ñ	Ñ	a b5
&LOCAL_EPHEMERAL_KEY_MISSING_OR_INVALIDÑ	Ñ	b à
)Ñ	Ñ	à â
)Ñ	Ñ	â ä
;Ñ	Ñ	ä ã
}
Ö	Ö	 	
if
á	á	 

(
á	á	 ,
_identityX25519SecretKeyHandle
á	á	 *
.
á	á	* +
	IsInvalid
á	á	+ 4
)
á	á	4 5
{
à	à	 	
return
â	â	 
Result
â	â	 
<
â	â	 
Unit
â	â	 
,
â	â	 %
EcliptixProtocolFailure
â	â	  7
>
â	â	7 8
.
â	â	8 9
Err
â	â	9 <
(
â	â	< =%
EcliptixProtocolFailure
ä	ä	 '
.
ä	ä	' (
PrepareLocal
ä	ä	( 4
(
ä	ä	4 5-
EcliptixProtocolFailureMessages
ä	ä	5 T
.
ä	ä	T U
IdentityKeys
ä	ä	U a
.
ä	ä	a b4
%LOCAL_IDENTITY_KEY_MISSING_OR_INVALIDä	ä	b á
)ä	ä	á à
)ä	ä	à â
;ä	ä	â ä
}
ã	ã	 	
return
ç	ç	 
Result
ç	ç	 
<
ç	ç	 
Unit
ç	ç	 
,
ç	ç	 %
EcliptixProtocolFailure
ç	ç	 3
>
ç	ç	3 4
.
ç	ç	4 5
Ok
ç	ç	5 7
(
ç	ç	7 8
Unit
ç	ç	8 <
.
ç	ç	< =
Value
ç	ç	= B
)
ç	ç	B C
;
ç	ç	C D
}
é	é	 
private
ê	ê	 
static
ê	ê	 
Result
ê	ê	 
<
ê	ê	 
Unit
ê	ê	 
,
ê	ê	 %
EcliptixProtocolFailure
ê	ê	  7
>
ê	ê	7 8)
ValidateRemoteRecipientKeys
ê	ê	9 T
(
ê	ê	T U
ReadOnlySpan
ë	ë	 
<
ë	ë	 
byte
ë	ë	 
>
ë	ë	 &
remoteIdentityPublicKeyX
ë	ë	 3
,
ë	ë	3 4
ReadOnlySpan
ë	ë	5 A
<
ë	ë	A B
byte
ë	ë	B F
>
ë	ë	F G'
remoteEphemeralPublicKeyX
ë	ë	H a
)
ë	ë	a b
{
í	í	 
if
ì	ì	 

(
ì	ì	 &
remoteIdentityPublicKeyX
ì	ì	 $
.
ì	ì	$ %
Length
ì	ì	% +
!=
ì	ì	, .
	Constants
ì	ì	/ 8
.
ì	ì	8 9%
X_25519_PUBLIC_KEY_SIZE
ì	ì	9 P
)
ì	ì	P Q
{
î	î	 	
return
ï	ï	 
Result
ï	ï	 
<
ï	ï	 
Unit
ï	ï	 
,
ï	ï	 %
EcliptixProtocolFailure
ï	ï	  7
>
ï	ï	7 8
.
ï	ï	8 9
Err
ï	ï	9 <
(
ï	ï	< =%
EcliptixProtocolFailure
ñ	ñ	 '
.
ñ	ñ	' (

PeerPubKey
ñ	ñ	( 2
(
ñ	ñ	2 3-
EcliptixProtocolFailureMessages
ñ	ñ	3 R
.
ñ	ñ	R S
IdentityKeys
ñ	ñ	S _
.
ñ	ñ	_ `1
"INVALID_REMOTE_IDENTITY_KEY_LENGTHñ	ñ	` Ç
)ñ	ñ	Ç É
)ñ	ñ	É Ñ
;ñ	ñ	Ñ Ö
}
ó	ó	 	
if
ô	ô	 

(
ô	ô	 '
remoteEphemeralPublicKeyX
ô	ô	 %
.
ô	ô	% &
Length
ô	ô	& ,
!=
ô	ô	- /
	Constants
ô	ô	0 9
.
ô	ô	9 :%
X_25519_PUBLIC_KEY_SIZE
ô	ô	: Q
)
ô	ô	Q R
{
ö	ö	 	
return
õ	õ	 
Result
õ	õ	 
<
õ	õ	 
Unit
õ	õ	 
,
õ	õ	 %
EcliptixProtocolFailure
õ	õ	  7
>
õ	õ	7 8
.
õ	õ	8 9
Err
õ	õ	9 <
(
õ	õ	< =%
EcliptixProtocolFailure
ú	ú	 '
.
ú	ú	' (

PeerPubKey
ú	ú	( 2
(
ú	ú	2 3-
EcliptixProtocolFailureMessages
ú	ú	3 R
.
ú	ú	R S
IdentityKeys
ú	ú	S _
.
ú	ú	_ `2
#INVALID_REMOTE_EPHEMERAL_KEY_LENGTHú	ú	` É
)ú	ú	É Ñ
)ú	ú	Ñ Ö
;ú	ú	Ö Ü
}
ù	ù	 	
return
ü	ü	 
Result
ü	ü	 
<
ü	ü	 
Unit
ü	ü	 
,
ü	ü	 %
EcliptixProtocolFailure
ü	ü	 3
>
ü	ü	3 4
.
ü	ü	4 5
Ok
ü	ü	5 7
(
ü	ü	7 8
Unit
ü	ü	8 <
.
ü	ü	< =
Value
ü	ü	= B
)
ü	ü	B C
;
ü	ü	C D
}
†	†	 
private
¢	¢	 
Result
¢	¢	 
<
¢	¢	 &
SodiumSecureMemoryHandle
¢	¢	 +
?
¢	¢	+ ,
,
¢	¢	, -%
EcliptixProtocolFailure
¢	¢	. E
>
¢	¢	E F 
FindLocalOpkHandle
¢	¢	G Y
(
¢	¢	Y Z
uint
¢	¢	Z ^
opkId
¢	¢	_ d
)
¢	¢	d e
{
£	£	 
foreach
§	§	 
(
§	§	  
OneTimePreKeyLocal
§	§	 #
opk
§	§	$ '
in
§	§	( *%
_oneTimePreKeysInternal
§	§	+ B
.
§	§	B C
Where
§	§	C H
(
§	§	H I
opk
§	§	I L
=>
§	§	M O
opk
§	§	P S
.
§	§	S T
PreKeyId
§	§	T \
==
§	§	] _
opkId
§	§	` e
)
§	§	e f
)
§	§	f g
{
•	•	 	
if
¶	¶	 
(
¶	¶	 
opk
¶	¶	 
.
¶	¶	 
PrivateKeyHandle
¶	¶	 $
.
¶	¶	$ %
	IsInvalid
¶	¶	% .
)
¶	¶	. /
{
ß	ß	 
return
®	®	 
Result
®	®	 
<
®	®	 &
SodiumSecureMemoryHandle
®	®	 6
?
®	®	6 7
,
®	®	7 8%
EcliptixProtocolFailure
®	®	9 P
>
®	®	P Q
.
®	®	Q R
Err
®	®	R U
(
®	®	U V%
EcliptixProtocolFailure
©	©	 +
.
©	©	+ ,
PrepareLocal
©	©	, 8
(
©	©	8 9
string
©	©	9 ?
.
©	©	? @
Format
©	©	@ F
(
©	©	F G-
EcliptixProtocolFailureMessages
©	©	G f
.
©	©	f g
IdentityKeys
©	©	g s
.
©	©	s t'
LOCAL_OPK_HANDLE_INVALID©	©	t å
,©	©	å ç
opkId©	©	é ì
)©	©	ì î
)©	©	î ï
)©	©	ï ñ
;©	©	ñ ó
}
™	™	 
return
¨	¨	 
Result
¨	¨	 
<
¨	¨	 &
SodiumSecureMemoryHandle
¨	¨	 2
?
¨	¨	2 3
,
¨	¨	3 4%
EcliptixProtocolFailure
¨	¨	5 L
>
¨	¨	L M
.
¨	¨	M N
Ok
¨	¨	N P
(
¨	¨	P Q
opk
¨	¨	Q T
.
¨	¨	T U
PrivateKeyHandle
¨	¨	U e
)
¨	¨	e f
;
¨	¨	f g
}
≠	≠	 	
return
Ø	Ø	 
Result
Ø	Ø	 
<
Ø	Ø	 &
SodiumSecureMemoryHandle
Ø	Ø	 .
?
Ø	Ø	. /
,
Ø	Ø	/ 0%
EcliptixProtocolFailure
Ø	Ø	1 H
>
Ø	Ø	H I
.
Ø	Ø	I J
Err
Ø	Ø	J M
(
Ø	Ø	M N%
EcliptixProtocolFailure
∞	∞	 #
.
∞	∞	# $
	Handshake
∞	∞	$ -
(
∞	∞	- .
string
∞	∞	. 4
.
∞	∞	4 5
Format
∞	∞	5 ;
(
∞	∞	; <-
EcliptixProtocolFailureMessages
∞	∞	< [
.
∞	∞	[ \
IdentityKeys
∞	∞	\ h
.
∞	∞	h i!
LOCAL_OPK_NOT_FOUND
∞	∞	i |
,
∞	∞	| }
opkId∞	∞	~ É
)∞	∞	É Ñ
)∞	∞	Ñ Ö
)∞	∞	Ö Ü
;∞	∞	Ü á
}
±	±	 
private
≥	≥	 
void
≥	≥	 
Dispose
≥	≥	 
(
≥	≥	 
bool
≥	≥	 
	disposing
≥	≥	 '
)
≥	≥	' (
{
¥	¥	 
if
µ	µ	 

(
µ	µ	 
	_disposed
µ	µ	 
)
µ	µ	 
{
∂	∂	 	
return
∑	∑	 
;
∑	∑	 
}
∏	∏	 	
if
∫	∫	 

(
∫	∫	 
	disposing
∫	∫	 
)
∫	∫	 
{
ª	ª	 	 
SecureCleanupLogic
º	º	 
(
º	º	 
)
º	º	  
;
º	º	  !
}
Ω	Ω	 	
	_disposed
ø	ø	 
=
ø	ø	 
true
ø	ø	 
;
ø	ø	 
}
¿	¿	 
private
¬	¬	 
void
¬	¬	  
SecureCleanupLogic
¬	¬	 #
(
¬	¬	# $
)
¬	¬	$ %
{
√	√	 %
_ed25519SecretKeyHandle
ƒ	ƒ	 
?
ƒ	ƒ	  
.
ƒ	ƒ	  !
Dispose
ƒ	ƒ	! (
(
ƒ	ƒ	( )
)
ƒ	ƒ	) *
;
ƒ	ƒ	* +,
_identityX25519SecretKeyHandle
≈	≈	 &
?
≈	≈	& '
.
≈	≈	' (
Dispose
≈	≈	( /
(
≈	≈	/ 0
)
≈	≈	0 1
;
≈	≈	1 2*
_signedPreKeySecretKeyHandle
∆	∆	 $
?
∆	∆	$ %
.
∆	∆	% &
Dispose
∆	∆	& -
(
∆	∆	- .
)
∆	∆	. /
;
∆	∆	/ 0'
_ephemeralSecretKeyHandle
«	«	 !
?
«	«	! "
.
«	«	" #
Dispose
«	«	# *
(
«	«	* +
)
«	«	+ ,
;
«	«	, -
foreach
»	»	 
(
»	»	  
OneTimePreKeyLocal
»	»	 #
opk
»	»	$ '
in
»	»	( *%
_oneTimePreKeysInternal
»	»	+ B
)
»	»	B C
{
…	…	 	
opk
 	 	 
.
 	 	 
Dispose
 	 	 
(
 	 	 
)
 	 	 
;
 	 	 
}
À	À	 	%
_oneTimePreKeysInternal
Õ	Õ	 
.
Õ	Õ	  
Clear
Õ	Õ	  %
(
Õ	Õ	% &
)
Õ	Õ	& '
;
Õ	Õ	' (%
_oneTimePreKeysInternal
Œ	Œ	 
=
Œ	Œ	  !
null
Œ	Œ	" &
!
Œ	Œ	& '
;
Œ	Œ	' ('
_ephemeralSecretKeyHandle
–	–	 !
=
–	–	" #
null
–	–	$ (
;
–	–	( )
}
—	—	 
~
”	”	 (
EcliptixSystemIdentityKeys
”	”	 
(
”	”	  
)
”	”	  !
{
‘	‘	 
Dispose
’	’	 
(
’	’	 
false
’	’	 
)
’	’	 
;
’	’	 
}
÷	÷	 
}◊	◊	 ¥Œ
r/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/EcliptixProtocolSystem.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
internal 
sealed	 
class "
EcliptixProtocolSystem ,
(, -&
EcliptixSystemIdentityKeys- G&
ecliptixSystemIdentityKeysH b
)b c
: 
IDisposable 
{ 
private 
readonly 
Lock 
_lock 
=  !
new" %
(% &
)& '
;' (
private &
EcliptixProtocolConnection &
?& '
_protocolConnection( ;
;; <
private !
IProtocolEventHandler !
?! "
_eventHandler# 0
;0 1
public 
&
EcliptixSystemIdentityKeys %
GetIdentityKeys& 5
(5 6
)6 7
=>8 :&
ecliptixSystemIdentityKeys; U
;U V
public 

void 
SetEventHandler 
(  !
IProtocolEventHandler  5
?5 6
handler7 >
)> ?
{ &
EcliptixProtocolConnection "
?" #
connectionToUpdate$ 6
;6 7
lock 
( 
_lock 
) 
{ 	
_eventHandler 
= 
handler #
;# $
connectionToUpdate 
=  
_protocolConnection! 4
;4 5
}   	
connectionToUpdate"" 
?"" 
."" 
SetEventHandler"" +
(""+ ,
handler"", 3
)""3 4
;""4 5
}## 
public%% 

void%% 
Dispose%% 
(%% 
)%% 
{&& &
EcliptixProtocolConnection'' "
?''" #
connectionToDispose''$ 7
;''7 8
lock)) 
()) 
_lock)) 
))) 
{** 	
connectionToDispose++ 
=++  !
_protocolConnection++" 5
;++5 6
_protocolConnection,, 
=,,  !
null,," &
;,,& '
}-- 	
connectionToDispose// 
?// 
.// 
Dispose// $
(//$ %
)//% &
;//& '
}00 
private22 &
EcliptixProtocolConnection22 &
?22& '
GetConnectionSafe22( 9
(229 :
)22: ;
{33 
lock44 
(44 
_lock44 
)44 
{55 	
return66 
_protocolConnection66 &
;66& '
}77 	
}88 
private:: 
static:: 
	Timestamp:: 
GetProtoTimestamp:: .
(::. /
)::/ 0
{;; 
return<< 
	Timestamp<< 
.<< 
FromDateTimeOffset<< +
(<<+ ,
DateTimeOffset<<, :
.<<: ;
UtcNow<<; A
)<<A B
;<<B C
}== 
public?? 

Result?? 
<?? 
PubKeyExchange??  
,??  !#
EcliptixProtocolFailure??" 9
>??9 :)
BeginDataCenterPubKeyExchange??; X
(??X Y
uint@@ 
	connectId@@ 
,@@ 
PubKeyExchangeTypeAA 
EXCHANGE_TYPEAA (
)AA( )
{BB &
ecliptixSystemIdentityKeysCC "
.CC" #$
GenerateEphemeralKeyPairCC# ;
(CC; <
)CC< =
;CC= >
ResultEE 
<EE  
LocalPublicKeyBundleEE #
,EE# $#
EcliptixProtocolFailureEE% <
>EE< =
bundleResultEE> J
=EEK L&
ecliptixSystemIdentityKeysFF &
.FF& '
CreatePublicBundleFF' 9
(FF9 :
)FF: ;
;FF; <
ifGG 

(GG 
bundleResultGG 
.GG 
IsErrGG 
)GG 
{HH 	
returnII 
ResultII 
<II 
PubKeyExchangeII (
,II( )#
EcliptixProtocolFailureII* A
>IIA B
.IIB C
ErrIIC F
(IIF G
bundleResultIIG S
.IIS T
	UnwrapErrIIT ]
(II] ^
)II^ _
)II_ `
;II` a
}JJ 	 
LocalPublicKeyBundleLL 
bundleLL #
=LL$ %
bundleResultLL& 2
.LL2 3
UnwrapLL3 9
(LL9 :
)LL: ;
;LL; <
ResultNN 
<NN &
EcliptixProtocolConnectionNN )
,NN) *#
EcliptixProtocolFailureNN+ B
>NNB C
sessionResultNND Q
=NNR S&
EcliptixProtocolConnectionOO &
.OO& '
CreateOO' -
(OO- .
	connectIdOO. 7
,OO7 8
trueOO9 =
,OO= >
RatchetConfigOO? L
.OOL M
DefaultOOM T
,OOT U
EXCHANGE_TYPEOOV c
)OOc d
;OOd e
ifPP 

(PP 
sessionResultPP 
.PP 
IsErrPP 
)PP  
{QQ 	
returnRR 
ResultRR 
<RR 
PubKeyExchangeRR (
,RR( )#
EcliptixProtocolFailureRR* A
>RRA B
.RRB C
ErrRRC F
(RRF G
sessionResultRRG T
.RRT U
	UnwrapErrRRU ^
(RR^ _
)RR_ `
)RR` a
;RRa b
}SS 	&
EcliptixProtocolConnectionUU "
sessionUU# *
=UU+ ,
sessionResultUU- :
.UU: ;
UnwrapUU; A
(UUA B
)UUB C
;UUC D!
IProtocolEventHandlerWW 
?WW 
currentHandlerWW -
;WW- .
lockXX 
(XX 
_lockXX 
)XX 
{YY 	
_protocolConnectionZZ 
=ZZ  !
sessionZZ" )
;ZZ) *
currentHandler[[ 
=[[ 
_eventHandler[[ *
;[[* +
}\\ 	
session^^ 
.^^ 
SetEventHandler^^ 
(^^  
currentHandler^^  .
)^^. /
;^^/ 0
Result`` 
<`` 
byte`` 
[`` 
]`` 
?`` 
,`` #
EcliptixProtocolFailure`` /
>``/ 0
dhKeyResult``1 <
=``= >
session``? F
.``F G'
GetCurrentSenderDhPublicKey``G b
(``b c
)``c d
;``d e
ifaa 

(aa 
dhKeyResultaa 
.aa 
IsErraa 
)aa 
{bb 	
returncc 
Resultcc 
<cc 
PubKeyExchangecc (
,cc( )#
EcliptixProtocolFailurecc* A
>ccA B
.ccB C
ErrccC F
(ccF G
dhKeyResultccG R
.ccR S
	UnwrapErrccS \
(cc\ ]
)cc] ^
)cc^ _
;cc_ `
}dd 	
byteff 
[ff 
]ff 
?ff 
dhPublicKeyff 
=ff 
dhKeyResultff )
.ff) *
Unwrapff* 0
(ff0 1
)ff1 2
;ff2 3
ifgg 

(gg 
dhPublicKeygg 
==gg 
nullgg 
)gg  
{hh 	
returnii 
Resultii 
<ii 
PubKeyExchangeii (
,ii( )#
EcliptixProtocolFailureii* A
>iiA B
.iiB C
ErriiC F
(iiF G#
EcliptixProtocolFailurejj '
.jj' (
PrepareLocaljj( 4
(jj4 5#
ProtocolSystemConstantsjj5 L
.jjL M
ProtocolSystemjjM [
.jj[ \&
DH_PUBLIC_KEY_NULL_MESSAGEjj\ v
)jjv w
)jjw x
;jjx y
}kk 	
PubKeyExchangemm 
pubKeyExchangemm %
=mm& '
newmm( +
(mm+ ,
)mm, -
{nn 	
Stateoo 
=oo 
PubKeyExchangeStateoo '
.oo' (
Initoo( ,
,oo, -
OfTypepp 
=pp 
EXCHANGE_TYPEpp "
,pp" #
Payloadqq 
=qq 
bundleqq 
.qq 
ToProtobufExchangeqq /
(qq/ 0
)qq0 1
.qq1 2
ToByteStringqq2 >
(qq> ?
)qq? @
,qq@ A
InitialDhPublicKeyrr 
=rr  

ByteStringrr! +
.rr+ ,
CopyFromrr, 4
(rr4 5
dhPublicKeyrr5 @
)rr@ A
}ss 	
;ss	 

returnuu 
Resultuu 
<uu 
PubKeyExchangeuu $
,uu$ %#
EcliptixProtocolFailureuu& =
>uu= >
.uu> ?
Okuu? A
(uuA B
pubKeyExchangeuuB P
)uuP Q
;uuQ R
}vv 
publicxx 

Resultxx 
<xx 
Unitxx 
,xx #
EcliptixProtocolFailurexx /
>xx/ 0/
#CompleteAuthenticatedPubKeyExchangexx1 T
(xxT U
PubKeyExchangexxU c
peerMessagexxd o
,xxo p
byteyy 
[yy 
]yy 
rootKeyyy 
)yy 
{zz 
Result{{ 
<{{ 
byte{{ 
[{{ 
]{{ 
?{{ 
,{{ #
EcliptixProtocolFailure{{ /
>{{/ 0
ourDhKeyResult{{1 ?
={{@ A
_protocolConnection{{B U
?{{U V
.{{V W'
GetCurrentSenderDhPublicKey{{W r
({{r s
){{s t
??{{u w
Result||B H
<||H I
byte||I M
[||M N
]||N O
?||O P
,||P Q#
EcliptixProtocolFailure||R i
>||i j
.||j k
Err||k n
(||n o#
EcliptixProtocolFailure}}F ]
.}}] ^
Generic}}^ e
(}}e f#
ProtocolSystemConstants~~J a
.~~a b
ProtocolSystem~~b p
.N O!
NO_CONNECTION_MESSAGEO d
)d e
)e f
;f g
if
ÄÄ 

(
ÄÄ 
ourDhKeyResult
ÄÄ 
.
ÄÄ 
IsOk
ÄÄ 
)
ÄÄ  
{
ÅÅ 	
byte
ÇÇ 
[
ÇÇ 
]
ÇÇ 
?
ÇÇ 
ourDhKey
ÇÇ 
=
ÇÇ 
ourDhKeyResult
ÇÇ -
.
ÇÇ- .
Unwrap
ÇÇ. 4
(
ÇÇ4 5
)
ÇÇ5 6
;
ÇÇ6 7
if
ÉÉ 
(
ÉÉ 
ourDhKey
ÉÉ 
!=
ÉÉ 
null
ÉÉ  
)
ÉÉ  !
{
ÑÑ 
Result
ÖÖ 
<
ÖÖ 
bool
ÖÖ 
,
ÖÖ 
SodiumFailure
ÖÖ *
>
ÖÖ* +
comparisonResult
ÖÖ, <
=
ÖÖ= >
SodiumInterop
ÜÜ !
.
ÜÜ! " 
ConstantTimeEquals
ÜÜ" 4
(
ÜÜ4 5
peerMessage
ÜÜ5 @
.
ÜÜ@ A 
InitialDhPublicKey
ÜÜA S
.
ÜÜS T
Span
ÜÜT X
,
ÜÜX Y
ourDhKey
ÜÜZ b
)
ÜÜb c
;
ÜÜc d
if
áá 
(
áá 
comparisonResult
áá $
.
áá$ %
IsOk
áá% )
&&
áá* ,
comparisonResult
áá- =
.
áá= >
Unwrap
áá> D
(
ááD E
)
ááE F
)
ááF G
{
àà 
return
ââ 
Result
ââ !
<
ââ! "
Unit
ââ" &
,
ââ& '%
EcliptixProtocolFailure
ââ( ?
>
ââ? @
.
ââ@ A
Err
ââA D
(
ââD E%
EcliptixProtocolFailure
ää /
.
ää/ 0
Generic
ää0 7
(
ää7 8%
ProtocolSystemConstants
ää8 O
.
ääO P
ProtocolSystem
ääP ^
.
ãã '
REFLECTION_ATTACK_MESSAGE
ãã 6
)
ãã6 7
)
ãã7 8
;
ãã8 9
}
åå 
}
çç 
}
éé 	
Result
êê 
<
êê 
PublicKeyBundle
êê 
,
êê %
EcliptixProtocolFailure
êê  7
>
êê7 8
parseResult
êê9 D
=
êêE F
Result
ëë 
<
ëë 
PublicKeyBundle
ëë "
,
ëë" #%
EcliptixProtocolFailure
ëë$ ;
>
ëë; <
.
ëë< =
Try
ëë= @
(
ëë@ A
(
íí 
)
íí 
=>
íí 
{
ìì %
SecureByteStringInterop
îî +
.
îî+ ,#
SecureCopyWithCleanup
îî, A
(
îîA B
peerMessage
îîB M
.
îîM N
Payload
îîN U
,
îîU V
out
îîW Z
byte
îî[ _
[
îî_ `
]
îî` a
payloadBytes
îîb n
)
îîn o
;
îîo p
try
ïï 
{
ññ 
return
óó 
Helpers
óó &
.
óó& '
ParseFromBytes
óó' 5
<
óó5 6
PublicKeyBundle
óó6 E
>
óóE F
(
óóF G
payloadBytes
óóG S
)
óóS T
;
óóT U
}
òò 
finally
ôô 
{
öö 
SodiumInterop
õõ %
.
õõ% &

SecureWipe
õõ& 0
(
õõ0 1
payloadBytes
õõ1 =
)
õõ= >
;
õõ> ?
}
úú 
}
ùù 
,
ùù 
ex
ûû 
=>
ûû %
EcliptixProtocolFailure
ûû -
.
ûû- .
Decode
ûû. 4
(
ûû4 5%
ProtocolSystemConstants
ûû5 L
.
ûûL M
ProtocolSystem
ûûM [
.
ûû[ \+
PARSE_PROTOBUF_FAILED_MESSAGE
ûû\ y
,
ûûy z
ex
üü 
)
üü 
)
üü 
;
üü 
if
°° 

(
°° 
parseResult
°° 
.
°° 
IsErr
°° 
)
°° 
{
¢¢ 	
return
££ 
Result
££ 
<
££ 
Unit
££ 
,
££ %
EcliptixProtocolFailure
££  7
>
££7 8
.
££8 9
Err
££9 <
(
££< =
parseResult
££= H
.
££H I
	UnwrapErr
££I R
(
££R S
)
££S T
)
££T U
;
££U V
}
§§ 	
PublicKeyBundle
¶¶ 
protobufBundle
¶¶ &
=
¶¶' (
parseResult
¶¶) 4
.
¶¶4 5
Unwrap
¶¶5 ;
(
¶¶; <
)
¶¶< =
;
¶¶= >
Result
®® 
<
®® "
LocalPublicKeyBundle
®® #
,
®®# $%
EcliptixProtocolFailure
®®% <
>
®®< =
bundleResult
®®> J
=
®®K L"
LocalPublicKeyBundle
©©  
.
©©  !"
FromProtobufExchange
©©! 5
(
©©5 6
protobufBundle
©©6 D
)
©©D E
;
©©E F
if
™™ 

(
™™ 
bundleResult
™™ 
.
™™ 
IsErr
™™ 
)
™™ 
{
´´ 	
return
¨¨ 
Result
¨¨ 
<
¨¨ 
Unit
¨¨ 
,
¨¨ %
EcliptixProtocolFailure
¨¨  7
>
¨¨7 8
.
¨¨8 9
Err
¨¨9 <
(
¨¨< =
bundleResult
¨¨= I
.
¨¨I J
	UnwrapErr
¨¨J S
(
¨¨S T
)
¨¨T U
)
¨¨U V
;
¨¨V W
}
≠≠ 	"
LocalPublicKeyBundle
ØØ 

peerBundle
ØØ '
=
ØØ( )
bundleResult
ØØ* 6
.
ØØ6 7
Unwrap
ØØ7 =
(
ØØ= >
)
ØØ> ?
;
ØØ? @
Result
±± 
<
±± 
bool
±± 
,
±± %
EcliptixProtocolFailure
±± ,
>
±±, -
signatureResult
±±. =
=
±±> ?(
EcliptixSystemIdentityKeys
±±@ Z
.
±±Z [&
VerifyRemoteSpkSignature
±±[ s
(
±±s t

peerBundle
≤≤ 
.
≤≤ 
IdentityEd25519
≤≤ &
,
≤≤& '

peerBundle
≤≤( 2
.
≤≤2 3 
SignedPreKeyPublic
≤≤3 E
,
≤≤E F

peerBundle
≤≤G Q
.
≤≤Q R#
SignedPreKeySignature
≤≤R g
)
≤≤g h
;
≤≤h i
if
≥≥ 

(
≥≥ 
signatureResult
≥≥ 
.
≥≥ 
IsErr
≥≥ !
)
≥≥! "
{
¥¥ 	
return
µµ 
Result
µµ 
<
µµ 
Unit
µµ 
,
µµ %
EcliptixProtocolFailure
µµ  7
>
µµ7 8
.
µµ8 9
Err
µµ9 <
(
µµ< =
signatureResult
µµ= L
.
µµL M
	UnwrapErr
µµM V
(
µµV W
)
µµW X
)
µµX Y
;
µµY Z
}
∂∂ 	
bool
∏∏ 
spkValid
∏∏ 
=
∏∏ 
signatureResult
∏∏ '
.
∏∏' (
Unwrap
∏∏( .
(
∏∏. /
)
∏∏/ 0
;
∏∏0 1
if
ππ 

(
ππ 
!
ππ 
spkValid
ππ 
)
ππ 
{
∫∫ 	
return
ªª 
Result
ªª 
<
ªª 
Unit
ªª 
,
ªª %
EcliptixProtocolFailure
ªª  7
>
ªª7 8
.
ªª8 9
Err
ªª9 <
(
ªª< =%
EcliptixProtocolFailure
ºº '
.
ºº' (
Generic
ºº( /
(
ºº/ 0%
ProtocolSystemConstants
ºº0 G
.
ººG H
ProtocolSystem
ººH V
.
ººV W+
SIGNED_PRE_KEY_FAILED_MESSAGE
ººW t
)
ººt u
)
ººu v
;
ººv w
}
ΩΩ 	
byte
øø 
[
øø 
]
øø 
?
øø 

dhKeyBytes
øø 
=
øø 
null
øø !
;
øø! "
try
¿¿ 
{
¡¡ 	%
SecureByteStringInterop
¬¬ #
.
¬¬# $#
SecureCopyWithCleanup
¬¬$ 9
(
¬¬9 :
peerMessage
¬¬: E
.
¬¬E F 
InitialDhPublicKey
¬¬F X
,
¬¬X Y
out
¬¬Z ]

dhKeyBytes
¬¬^ h
)
¬¬h i
;
¬¬i j
Result
ƒƒ 
<
ƒƒ 
Unit
ƒƒ 
,
ƒƒ %
EcliptixProtocolFailure
ƒƒ 0
>
ƒƒ0 1 
dhValidationResult
ƒƒ2 D
=
ƒƒE F
DhValidator
≈≈ 
.
≈≈ %
ValidateX25519PublicKey
≈≈ 3
(
≈≈3 4

dhKeyBytes
≈≈4 >
)
≈≈> ?
;
≈≈? @
if
∆∆ 
(
∆∆  
dhValidationResult
∆∆ "
.
∆∆" #
IsErr
∆∆# (
)
∆∆( )
{
«« 
return
»» 
Result
»» 
<
»» 
Unit
»» "
,
»»" #%
EcliptixProtocolFailure
»»$ ;
>
»»; <
.
»»< =
Err
»»= @
(
»»@ A 
dhValidationResult
»»A S
.
»»S T
	UnwrapErr
»»T ]
(
»»] ^
)
»»^ _
)
»»_ `
;
»»` a
}
…… 
Result
ÀÀ 
<
ÀÀ 
Unit
ÀÀ 
,
ÀÀ %
EcliptixProtocolFailure
ÀÀ 0
>
ÀÀ0 1
finalizeResult
ÀÀ2 @
=
ÀÀA B!
_protocolConnection
ÃÃ #
?
ÃÃ# $
.
ÃÃ$ %$
FinalizeChainAndDhKeys
ÃÃ% ;
(
ÃÃ; <
rootKey
ÃÃ< C
,
ÃÃC D

dhKeyBytes
ÃÃE O
)
ÃÃO P
??
ÕÕ 
Result
ÕÕ 
<
ÕÕ 
Unit
ÕÕ 
,
ÕÕ %
EcliptixProtocolFailure
ÕÕ  7
>
ÕÕ7 8
.
ÕÕ8 9
Err
ÕÕ9 <
(
ÕÕ< =%
EcliptixProtocolFailure
ŒŒ +
.
ŒŒ+ ,
Generic
ŒŒ, 3
(
ŒŒ3 4%
ProtocolSystemConstants
ŒŒ4 K
.
ŒŒK L
ProtocolSystem
ŒŒL Z
.
œœ 9
+PROTOCOL_CONNECTION_NOT_INITIALIZED_MESSAGE
œœ D
)
œœD E
)
œœE F
;
œœF G
if
–– 
(
–– 
finalizeResult
–– 
.
–– 
IsErr
–– $
)
––$ %
{
—— 
return
““ 
Result
““ 
<
““ 
Unit
““ "
,
““" #%
EcliptixProtocolFailure
““$ ;
>
““; <
.
““< =
Err
““= @
(
““@ A
finalizeResult
““A O
.
““O P
	UnwrapErr
““P Y
(
““Y Z
)
““Z [
)
““[ \
;
““\ ]
}
”” 
Result
’’ 
<
’’ 
Unit
’’ 
,
’’ %
EcliptixProtocolFailure
’’ 0
>
’’0 1
setPeerResult
’’2 ?
=
’’@ A!
_protocolConnection
’’B U
?
’’U V
.
’’V W
SetPeerBundle
’’W d
(
’’d e

peerBundle
’’e o
)
’’o p
??
÷÷B D
Result
÷÷E K
<
÷÷K L
Unit
÷÷L P
,
÷÷P Q%
EcliptixProtocolFailure
÷÷R i
>
÷÷i j
.
÷÷j k
Err
÷÷k n
(
÷÷n o%
EcliptixProtocolFailure
◊◊F ]
.
◊◊] ^
Generic
◊◊^ e
(
◊◊e f%
ProtocolSystemConstants
ÿÿJ a
.
ÿÿa b
ProtocolSystem
ÿÿb p
.
ŸŸN O9
+PROTOCOL_CONNECTION_NOT_INITIALIZED_MESSAGE
ŸŸO z
)
ŸŸz {
)
ŸŸ{ |
;
ŸŸ| }
return
⁄⁄ 
setPeerResult
⁄⁄  
.
⁄⁄  !
IsErr
⁄⁄! &
?
€€ 
Result
€€ 
<
€€ 
Unit
€€ 
,
€€ %
EcliptixProtocolFailure
€€ 6
>
€€6 7
.
€€7 8
Err
€€8 ;
(
€€; <
setPeerResult
€€< I
.
€€I J
	UnwrapErr
€€J S
(
€€S T
)
€€T U
)
€€U V
:
‹‹ 
Result
‹‹ 
<
‹‹ 
Unit
‹‹ 
,
‹‹ %
EcliptixProtocolFailure
‹‹ 6
>
‹‹6 7
.
‹‹7 8
Ok
‹‹8 :
(
‹‹: ;
Unit
‹‹; ?
.
‹‹? @
Value
‹‹@ E
)
‹‹E F
;
‹‹F G
}
›› 	
finally
ﬁﬁ 
{
ﬂﬂ 	
SodiumInterop
‡‡ 
.
‡‡ 

SecureWipe
‡‡ $
(
‡‡$ %

dhKeyBytes
‡‡% /
)
‡‡/ 0
;
‡‡0 1
}
·· 	
}
‚‚ 
public
‰‰ 

Result
‰‰ 
<
‰‰ 
Unit
‰‰ 
,
‰‰ %
EcliptixProtocolFailure
‰‰ /
>
‰‰/ 0.
 CompleteDataCenterPubKeyExchange
‰‰1 Q
(
‰‰Q R
PubKeyExchange
‰‰R `
peerMessage
‰‰a l
)
‰‰l m
{
ÂÂ 
Result
ÊÊ 
<
ÊÊ 
Unit
ÊÊ 
,
ÊÊ %
EcliptixProtocolFailure
ÊÊ ,
>
ÊÊ, -
reflectionCheck
ÊÊ. =
=
ÊÊ> ?#
CheckReflectionAttack
ÊÊ@ U
(
ÊÊU V
peerMessage
ÊÊV a
)
ÊÊa b
;
ÊÊb c
if
ÁÁ 

(
ÁÁ 
reflectionCheck
ÁÁ 
.
ÁÁ 
IsErr
ÁÁ !
)
ÁÁ! "
{
ËË 	
return
ÈÈ 
reflectionCheck
ÈÈ "
;
ÈÈ" #
}
ÍÍ 	&
SodiumSecureMemoryHandle
ÏÏ  
?
ÏÏ  !
rootKeyHandle
ÏÏ" /
=
ÏÏ0 1
null
ÏÏ2 6
;
ÏÏ6 7
try
ÌÌ 
{
ÓÓ 	
Result
ÔÔ 
<
ÔÔ "
LocalPublicKeyBundle
ÔÔ '
,
ÔÔ' (%
EcliptixProtocolFailure
ÔÔ) @
>
ÔÔ@ A
peerBundleResult
ÔÔB R
=
ÔÔS T(
ParseAndValidatePeerBundle
ÔÔU o
(
ÔÔo p
peerMessage
ÔÔp {
)
ÔÔ{ |
;
ÔÔ| }
if
 
(
 
peerBundleResult
  
.
  !
IsErr
! &
)
& '
{
ÒÒ 
return
ÚÚ 
Result
ÚÚ 
<
ÚÚ 
Unit
ÚÚ "
,
ÚÚ" #%
EcliptixProtocolFailure
ÚÚ$ ;
>
ÚÚ; <
.
ÚÚ< =
Err
ÚÚ= @
(
ÚÚ@ A
peerBundleResult
ÚÚA Q
.
ÚÚQ R
	UnwrapErr
ÚÚR [
(
ÚÚ[ \
)
ÚÚ\ ]
)
ÚÚ] ^
;
ÚÚ^ _
}
ÛÛ "
LocalPublicKeyBundle
ıı  

peerBundle
ıı! +
=
ıı, -
peerBundleResult
ıı. >
.
ıı> ?
Unwrap
ıı? E
(
ııE F
)
ııF G
;
ııG H
Result
˜˜ 
<
˜˜ &
SodiumSecureMemoryHandle
˜˜ +
,
˜˜+ ,%
EcliptixProtocolFailure
˜˜- D
>
˜˜D E
secretResult
˜˜F R
=
˜˜S T#
DeriveSharedSecretKey
˜˜U j
(
˜˜j k

peerBundle
˜˜k u
)
˜˜u v
;
˜˜v w
if
¯¯ 
(
¯¯ 
secretResult
¯¯ 
.
¯¯ 
IsErr
¯¯ "
)
¯¯" #
{
˘˘ 
return
˙˙ 
Result
˙˙ 
<
˙˙ 
Unit
˙˙ "
,
˙˙" #%
EcliptixProtocolFailure
˙˙$ ;
>
˙˙; <
.
˙˙< =
Err
˙˙= @
(
˙˙@ A
secretResult
˙˙A M
.
˙˙M N
	UnwrapErr
˙˙N W
(
˙˙W X
)
˙˙X Y
)
˙˙Y Z
;
˙˙Z [
}
˚˚ 
rootKeyHandle
˝˝ 
=
˝˝ 
secretResult
˝˝ (
.
˝˝( )
Unwrap
˝˝) /
(
˝˝/ 0
)
˝˝0 1
;
˝˝1 2
return
ˇˇ 
FinalizeExchange
ˇˇ #
(
ˇˇ# $
rootKeyHandle
ˇˇ$ 1
,
ˇˇ1 2
peerMessage
ˇˇ3 >
.
ˇˇ> ? 
InitialDhPublicKey
ˇˇ? Q
,
ˇˇQ R

peerBundle
ˇˇS ]
)
ˇˇ] ^
;
ˇˇ^ _
}
ÄÄ 	
finally
ÅÅ 
{
ÇÇ 	
rootKeyHandle
ÉÉ 
?
ÉÉ 
.
ÉÉ 
Dispose
ÉÉ "
(
ÉÉ" #
)
ÉÉ# $
;
ÉÉ$ %
}
ÑÑ 	
}
ÖÖ 
private
áá 
Result
áá 
<
áá 
Unit
áá 
,
áá %
EcliptixProtocolFailure
áá 0
>
áá0 1#
CheckReflectionAttack
áá2 G
(
ááG H
PubKeyExchange
ááH V
peerMessage
ááW b
)
ááb c
{
àà 
Result
ââ 
<
ââ 
byte
ââ 
[
ââ 
]
ââ 
?
ââ 
,
ââ %
EcliptixProtocolFailure
ââ /
>
ââ/ 0
ourDhKeyResult
ââ1 ?
=
ââ@ A!
_protocolConnection
ââB U
?
ââU V
.
ââV W)
GetCurrentSenderDhPublicKey
ââW r
(
ââr s
)
ââs t
??
ââu w
Result
ääB H
<
ääH I
byte
ääI M
[
ääM N
]
ääN O
?
ääO P
,
ääP Q%
EcliptixProtocolFailure
ääR i
>
ääi j
.
ääj k
Err
ääk n
(
ään o%
EcliptixProtocolFailure
ããF ]
.
ãã] ^
Generic
ãã^ e
(
ããe f%
ProtocolSystemConstants
ååJ a
.
ååa b
ProtocolSystem
ååb p
.
ççN O#
NO_CONNECTION_MESSAGE
ççO d
)
ççd e
)
ççe f
;
ççf g
if
éé 

(
éé 
!
éé 
ourDhKeyResult
éé 
.
éé 
IsOk
éé  
)
éé  !
{
èè 	
return
êê 
Result
êê 
<
êê 
Unit
êê 
,
êê %
EcliptixProtocolFailure
êê  7
>
êê7 8
.
êê8 9
Ok
êê9 ;
(
êê; <
Unit
êê< @
.
êê@ A
Value
êêA F
)
êêF G
;
êêG H
}
ëë 	
byte
ìì 
[
ìì 
]
ìì 
?
ìì 
ourDhKey
ìì 
=
ìì 
ourDhKeyResult
ìì )
.
ìì) *
Unwrap
ìì* 0
(
ìì0 1
)
ìì1 2
;
ìì2 3
if
îî 

(
îî 
ourDhKey
îî 
==
îî 
null
îî 
)
îî 
{
ïï 	
return
ññ 
Result
ññ 
<
ññ 
Unit
ññ 
,
ññ %
EcliptixProtocolFailure
ññ  7
>
ññ7 8
.
ññ8 9
Ok
ññ9 ;
(
ññ; <
Unit
ññ< @
.
ññ@ A
Value
ññA F
)
ññF G
;
ññG H
}
óó 	
Result
ôô 
<
ôô 
bool
ôô 
,
ôô 
SodiumFailure
ôô "
>
ôô" #
comparisonResult
ôô$ 4
=
ôô5 6
SodiumInterop
öö 
.
öö  
ConstantTimeEquals
öö ,
(
öö, -
peerMessage
öö- 8
.
öö8 9 
InitialDhPublicKey
öö9 K
.
ööK L
Span
ööL P
,
ööP Q
ourDhKey
ööR Z
)
ööZ [
;
öö[ \
if
úú 

(
úú 
comparisonResult
úú 
.
úú 
IsOk
úú !
&&
úú" $
comparisonResult
úú% 5
.
úú5 6
Unwrap
úú6 <
(
úú< =
)
úú= >
)
úú> ?
{
ùù 	
return
ûû 
Result
ûû 
<
ûû 
Unit
ûû 
,
ûû %
EcliptixProtocolFailure
ûû  7
>
ûû7 8
.
ûû8 9
Err
ûû9 <
(
ûû< =%
EcliptixProtocolFailure
üü '
.
üü' (
Generic
üü( /
(
üü/ 0%
ProtocolSystemConstants
üü0 G
.
üüG H
ProtocolSystem
üüH V
.
üüV W'
REFLECTION_ATTACK_MESSAGE
üüW p
)
üüp q
)
üüq r
;
üür s
}
†† 	
return
¢¢ 
Result
¢¢ 
<
¢¢ 
Unit
¢¢ 
,
¢¢ %
EcliptixProtocolFailure
¢¢ 3
>
¢¢3 4
.
¢¢4 5
Ok
¢¢5 7
(
¢¢7 8
Unit
¢¢8 <
.
¢¢< =
Value
¢¢= B
)
¢¢B C
;
¢¢C D
}
££ 
private
•• 
static
•• 
Result
•• 
<
•• "
LocalPublicKeyBundle
•• .
,
••. /%
EcliptixProtocolFailure
••0 G
>
••G H(
ParseAndValidatePeerBundle
••I c
(
••c d
PubKeyExchange
••d r
peerMessage
••s ~
)
••~ 
{
¶¶ 
Result
ßß 
<
ßß 
PublicKeyBundle
ßß 
,
ßß %
EcliptixProtocolFailure
ßß  7
>
ßß7 8
parseResult
ßß9 D
=
ßßE F
Result
®® 
<
®® 
PublicKeyBundle
®® "
,
®®" #%
EcliptixProtocolFailure
®®$ ;
>
®®; <
.
®®< =
Try
®®= @
(
®®@ A
(
©© 
)
©© 
=>
©© 
{
™™ %
SecureByteStringInterop
´´ +
.
´´+ ,#
SecureCopyWithCleanup
´´, A
(
´´A B
peerMessage
´´B M
.
´´M N
Payload
´´N U
,
´´U V
out
´´W Z
byte
´´[ _
[
´´_ `
]
´´` a
payloadBytes
´´b n
)
´´n o
;
´´o p
try
¨¨ 
{
≠≠ 
return
ÆÆ 
Helpers
ÆÆ &
.
ÆÆ& '
ParseFromBytes
ÆÆ' 5
<
ÆÆ5 6
PublicKeyBundle
ÆÆ6 E
>
ÆÆE F
(
ÆÆF G
payloadBytes
ÆÆG S
)
ÆÆS T
;
ÆÆT U
}
ØØ 
finally
∞∞ 
{
±± 
SodiumInterop
≤≤ %
.
≤≤% &

SecureWipe
≤≤& 0
(
≤≤0 1
payloadBytes
≤≤1 =
)
≤≤= >
;
≤≤> ?
}
≥≥ 
}
¥¥ 
,
¥¥ 
ex
µµ 
=>
µµ %
EcliptixProtocolFailure
µµ -
.
µµ- .
Decode
µµ. 4
(
µµ4 5%
ProtocolSystemConstants
∂∂ +
.
∂∂+ ,
ProtocolSystem
∂∂, :
.
∂∂: ;+
PARSE_PROTOBUF_FAILED_MESSAGE
∂∂; X
,
∂∂X Y
ex
∂∂Z \
)
∂∂\ ]
)
∂∂] ^
;
∂∂^ _
if
∏∏ 

(
∏∏ 
parseResult
∏∏ 
.
∏∏ 
IsErr
∏∏ 
)
∏∏ 
{
ππ 	
return
∫∫ 
Result
∫∫ 
<
∫∫ "
LocalPublicKeyBundle
∫∫ .
,
∫∫. /%
EcliptixProtocolFailure
∫∫0 G
>
∫∫G H
.
∫∫H I
Err
∫∫I L
(
∫∫L M
parseResult
∫∫M X
.
∫∫X Y
	UnwrapErr
∫∫Y b
(
∫∫b c
)
∫∫c d
)
∫∫d e
;
∫∫e f
}
ªª 	
PublicKeyBundle
ΩΩ 
protobufBundle
ΩΩ &
=
ΩΩ' (
parseResult
ΩΩ) 4
.
ΩΩ4 5
Unwrap
ΩΩ5 ;
(
ΩΩ; <
)
ΩΩ< =
;
ΩΩ= >
Result
øø 
<
øø "
LocalPublicKeyBundle
øø #
,
øø# $%
EcliptixProtocolFailure
øø% <
>
øø< =
bundleResult
øø> J
=
øøK L"
LocalPublicKeyBundle
¿¿  
.
¿¿  !"
FromProtobufExchange
¿¿! 5
(
¿¿5 6
protobufBundle
¿¿6 D
)
¿¿D E
;
¿¿E F
if
¡¡ 

(
¡¡ 
bundleResult
¡¡ 
.
¡¡ 
IsErr
¡¡ 
)
¡¡ 
{
¬¬ 	
return
√√ 
bundleResult
√√ 
;
√√  
}
ƒƒ 	"
LocalPublicKeyBundle
∆∆ 

peerBundle
∆∆ '
=
∆∆( )
bundleResult
∆∆* 6
.
∆∆6 7
Unwrap
∆∆7 =
(
∆∆= >
)
∆∆> ?
;
∆∆? @
Result
»» 
<
»» 
bool
»» 
,
»» %
EcliptixProtocolFailure
»» ,
>
»», -
signatureResult
»». =
=
»»> ?(
EcliptixSystemIdentityKeys
»»@ Z
.
»»Z [&
VerifyRemoteSpkSignature
»»[ s
(
»»s t

peerBundle
…… 
.
…… 
IdentityEd25519
…… &
,
……& '

peerBundle
……( 2
.
……2 3 
SignedPreKeyPublic
……3 E
,
……E F

peerBundle
……G Q
.
……Q R#
SignedPreKeySignature
……R g
)
……g h
;
……h i
if
   

(
   
signatureResult
   
.
   
IsErr
   !
)
  ! "
{
ÀÀ 	
return
ÃÃ 
Result
ÃÃ 
<
ÃÃ "
LocalPublicKeyBundle
ÃÃ .
,
ÃÃ. /%
EcliptixProtocolFailure
ÃÃ0 G
>
ÃÃG H
.
ÃÃH I
Err
ÃÃI L
(
ÃÃL M
signatureResult
ÃÃM \
.
ÃÃ\ ]
	UnwrapErr
ÃÃ] f
(
ÃÃf g
)
ÃÃg h
)
ÃÃh i
;
ÃÃi j
}
ÕÕ 	
bool
œœ 
spkValid
œœ 
=
œœ 
signatureResult
œœ '
.
œœ' (
Unwrap
œœ( .
(
œœ. /
)
œœ/ 0
;
œœ0 1
if
–– 

(
–– 
!
–– 
spkValid
–– 
)
–– 
{
—— 	
return
““ 
Result
““ 
<
““ "
LocalPublicKeyBundle
““ .
,
““. /%
EcliptixProtocolFailure
““0 G
>
““G H
.
““H I
Err
““I L
(
““L M%
EcliptixProtocolFailure
”” '
.
””' (
Generic
””( /
(
””/ 0%
ProtocolSystemConstants
””0 G
.
””G H
ProtocolSystem
””H V
.
””V W+
SIGNED_PRE_KEY_FAILED_MESSAGE
””W t
)
””t u
)
””u v
;
””v w
}
‘‘ 	
return
÷÷ 
Result
÷÷ 
<
÷÷ "
LocalPublicKeyBundle
÷÷ *
,
÷÷* +%
EcliptixProtocolFailure
÷÷, C
>
÷÷C D
.
÷÷D E
Ok
÷÷E G
(
÷÷G H

peerBundle
÷÷H R
)
÷÷R S
;
÷÷S T
}
◊◊ 
private
ŸŸ 
Result
ŸŸ 
<
ŸŸ &
SodiumSecureMemoryHandle
ŸŸ +
,
ŸŸ+ ,%
EcliptixProtocolFailure
ŸŸ- D
>
ŸŸD E#
DeriveSharedSecretKey
ŸŸF [
(
ŸŸ[ \"
LocalPublicKeyBundle
ŸŸ\ p

peerBundle
ŸŸq {
)
ŸŸ{ |
{
⁄⁄ 
return
€€ (
ecliptixSystemIdentityKeys
€€ )
.
€€) *$
X3dhDeriveSharedSecret
€€* @
(
€€@ A

peerBundle
€€A K
,
€€K L
	Constants
€€M V
.
€€V W

X_3DH_INFO
€€W a
)
€€a b
;
€€b c
}
‹‹ 
private
ﬁﬁ 
Result
ﬁﬁ 
<
ﬁﬁ 
Unit
ﬁﬁ 
,
ﬁﬁ %
EcliptixProtocolFailure
ﬁﬁ 0
>
ﬁﬁ0 1
FinalizeExchange
ﬁﬁ2 B
(
ﬁﬁB C&
SodiumSecureMemoryHandle
ﬂﬂ  
derivedKeyHandle
ﬂﬂ! 1
,
ﬂﬂ1 2

ByteString
‡‡ 
peerDhPublicKey
‡‡ "
,
‡‡" #"
LocalPublicKeyBundle
·· 

peerBundle
·· '
)
··' (
{
‚‚ 
byte
„„ 
[
„„ 
]
„„ 
rootKeyBytes
„„ 
=
„„ 
new
„„ !
byte
„„" &
[
„„& '
	Constants
„„' 0
.
„„0 1
X_25519_KEY_SIZE
„„1 A
]
„„A B
;
„„B C
byte
‰‰ 
[
‰‰ 
]
‰‰ 
?
‰‰ 

dhKeyBytes
‰‰ 
=
‰‰ 
null
‰‰ !
;
‰‰! "
try
ÊÊ 
{
ÁÁ 	
Result
ËË 
<
ËË 
Unit
ËË 
,
ËË %
EcliptixProtocolFailure
ËË 0
>
ËË0 1

readResult
ËË2 <
=
ËË= >
derivedKeyHandle
ÈÈ  
.
ÈÈ  !
Read
ÈÈ! %
(
ÈÈ% &
rootKeyBytes
ÈÈ& 2
)
ÈÈ2 3
.
ÈÈ3 4
MapSodiumFailure
ÈÈ4 D
(
ÈÈD E
)
ÈÈE F
;
ÈÈF G
if
ÍÍ 
(
ÍÍ 

readResult
ÍÍ 
.
ÍÍ 
IsErr
ÍÍ  
)
ÍÍ  !
{
ÎÎ 
return
ÏÏ 

readResult
ÏÏ !
;
ÏÏ! "
}
ÌÌ %
SecureByteStringInterop
ÔÔ #
.
ÔÔ# $#
SecureCopyWithCleanup
ÔÔ$ 9
(
ÔÔ9 :
peerDhPublicKey
ÔÔ: I
,
ÔÔI J
out
ÔÔK N

dhKeyBytes
ÔÔO Y
)
ÔÔY Z
;
ÔÔZ [
Result
ÒÒ 
<
ÒÒ 
Unit
ÒÒ 
,
ÒÒ %
EcliptixProtocolFailure
ÒÒ 0
>
ÒÒ0 1 
dhValidationResult
ÒÒ2 D
=
ÒÒE F
DhValidator
ÚÚ 
.
ÚÚ %
ValidateX25519PublicKey
ÚÚ 3
(
ÚÚ3 4

dhKeyBytes
ÚÚ4 >
)
ÚÚ> ?
;
ÚÚ? @
if
ÛÛ 
(
ÛÛ  
dhValidationResult
ÛÛ "
.
ÛÛ" #
IsErr
ÛÛ# (
)
ÛÛ( )
{
ÙÙ 
return
ıı  
dhValidationResult
ıı )
;
ıı) *
}
ˆˆ 
Result
¯¯ 
<
¯¯ 
Unit
¯¯ 
,
¯¯ %
EcliptixProtocolFailure
¯¯ 0
>
¯¯0 1
finalizeResult
¯¯2 @
=
¯¯A B!
_protocolConnection
˘˘ #
?
˘˘# $
.
˘˘$ %$
FinalizeChainAndDhKeys
˘˘% ;
(
˘˘; <
rootKeyBytes
˘˘< H
,
˘˘H I

dhKeyBytes
˘˘J T
)
˘˘T U
??
˙˙ 
Result
˙˙ 
<
˙˙ 
Unit
˙˙ 
,
˙˙ %
EcliptixProtocolFailure
˙˙  7
>
˙˙7 8
.
˙˙8 9
Err
˙˙9 <
(
˙˙< =%
EcliptixProtocolFailure
˚˚ +
.
˚˚+ ,
Generic
˚˚, 3
(
˚˚3 4%
ProtocolSystemConstants
˚˚4 K
.
˚˚K L
ProtocolSystem
˚˚L Z
.
¸¸ 9
+PROTOCOL_CONNECTION_NOT_INITIALIZED_MESSAGE
¸¸ D
)
¸¸D E
)
¸¸E F
;
¸¸F G
if
˝˝ 
(
˝˝ 
finalizeResult
˝˝ 
.
˝˝ 
IsErr
˝˝ $
)
˝˝$ %
{
˛˛ 
return
ˇˇ 
finalizeResult
ˇˇ %
;
ˇˇ% &
}
ÄÄ 
Result
ÇÇ 
<
ÇÇ 
Unit
ÇÇ 
,
ÇÇ %
EcliptixProtocolFailure
ÇÇ 0
>
ÇÇ0 1
setPeerResult
ÇÇ2 ?
=
ÇÇ@ A!
_protocolConnection
ÇÇB U
?
ÇÇU V
.
ÇÇV W
SetPeerBundle
ÇÇW d
(
ÇÇd e

peerBundle
ÇÇe o
)
ÇÇo p
??
ÉÉB D
Result
ÉÉE K
<
ÉÉK L
Unit
ÉÉL P
,
ÉÉP Q%
EcliptixProtocolFailure
ÉÉR i
>
ÉÉi j
.
ÉÉj k
Err
ÉÉk n
(
ÉÉn o%
EcliptixProtocolFailure
ÑÑF ]
.
ÑÑ] ^
Generic
ÑÑ^ e
(
ÑÑe f%
ProtocolSystemConstants
ÖÖJ a
.
ÖÖa b
ProtocolSystem
ÖÖb p
.
ÜÜN O9
+PROTOCOL_CONNECTION_NOT_INITIALIZED_MESSAGE
ÜÜO z
)
ÜÜz {
)
ÜÜ{ |
;
ÜÜ| }
return
àà 
setPeerResult
àà  
.
àà  !
IsErr
àà! &
?
ââ 
setPeerResult
ââ 
:
ää 
Result
ää 
<
ää 
Unit
ää 
,
ää %
EcliptixProtocolFailure
ää 6
>
ää6 7
.
ää7 8
Ok
ää8 :
(
ää: ;
Unit
ää; ?
.
ää? @
Value
ää@ E
)
ääE F
;
ääF G
}
ãã 	
finally
åå 
{
çç 	
SodiumInterop
éé 
.
éé 

SecureWipe
éé $
(
éé$ %
rootKeyBytes
éé% 1
)
éé1 2
;
éé2 3
SodiumInterop
èè 
.
èè 

SecureWipe
èè $
(
èè$ %

dhKeyBytes
èè% /
)
èè/ 0
;
èè0 1
}
êê 	
}
ëë 
public
ìì 

Result
ìì 
<
ìì 
SecureEnvelope
ìì  
,
ìì  !%
EcliptixProtocolFailure
ìì" 9
>
ìì9 :%
ProduceOutboundEnvelope
ìì; R
(
ììR S
byte
ììS W
[
ììW X
]
ììX Y
plainPayload
ììZ f
)
ììf g
{
îî 
if
ïï 

(
ïï 
plainPayload
ïï 
.
ïï 
Length
ïï 
>
ïï  !%
ProtocolSystemConstants
ïï" 9
.
ïï9 :
ProtocolSystem
ïï: H
.
ïïH I
MAX_PAYLOAD_SIZE
ïïI Y
)
ïïY Z
{
ññ 	
return
óó 
Result
óó 
<
óó 
SecureEnvelope
óó (
,
óó( )%
EcliptixProtocolFailure
óó* A
>
óóA B
.
óóB C
Err
óóC F
(
óóF G%
EcliptixProtocolFailure
òò '
.
òò' (
InvalidInput
òò( 4
(
òò4 5
$"
ôô 
$str
ôô $
{
ôô$ %
plainPayload
ôô% 1
.
ôô1 2
Length
ôô2 8
}
ôô8 9
$str
ôô9 Z
{
ôôZ [%
ProtocolSystemConstants
ôô[ r
.
ôôr s
ProtocolSystemôôs Å
.ôôÅ Ç 
MAX_PAYLOAD_SIZEôôÇ í
}ôôí ì
$strôôì ö
"ôôö õ
)ôôõ ú
)ôôú ù
;ôôù û
}
öö 	(
EcliptixProtocolConnection
úú "
?
úú" #

connection
úú$ .
=
úú/ 0
GetConnectionSafe
úú1 B
(
úúB C
)
úúC D
;
úúD E
if
ùù 

(
ùù 

connection
ùù 
==
ùù 
null
ùù 
)
ùù 
{
ûû 	
return
üü 
Result
üü 
<
üü 
SecureEnvelope
üü (
,
üü( )%
EcliptixProtocolFailure
üü* A
>
üüA B
.
üüB C
Err
üüC F
(
üüF G%
EcliptixProtocolFailure
†† '
.
††' (
Generic
††( /
(
††/ 0%
ProtocolSystemConstants
††0 G
.
††G H
ProtocolSystem
††H V
.
°° 9
+PROTOCOL_CONNECTION_NOT_INITIALIZED_MESSAGE
°° @
)
°°@ A
)
°°A B
;
°°B C
}
¢¢ 	
return
§§ #
ProduceSingleEnvelope
§§ $
(
§§$ %
plainPayload
§§% 1
,
§§1 2

connection
§§3 =
)
§§= >
;
§§> ?
}
•• 
private
ßß 
Result
ßß 
<
ßß 
SecureEnvelope
ßß !
,
ßß! "%
EcliptixProtocolFailure
ßß# :
>
ßß: ;#
ProduceSingleEnvelope
ßß< Q
(
ßßQ R
byte
ßßR V
[
ßßV W
]
ßßW X
plainPayload
ßßY e
,
ßße f(
EcliptixProtocolConnection
®® "

connection
®®# -
)
®®- .
{
©© 
byte
™™ 
[
™™ 
]
™™ 
?
™™ 
nonce
™™ 
=
™™ 
null
™™ 
;
™™ 
byte
´´ 
[
´´ 
]
´´ 
?
´´ 
ad
´´ 
=
´´ 
null
´´ 
;
´´ 
byte
¨¨ 
[
¨¨ 
]
¨¨ 
?
¨¨ 
	encrypted
¨¨ 
=
¨¨ 
null
¨¨  
;
¨¨  !
byte
≠≠ 
[
≠≠ 
]
≠≠ 
?
≠≠ "
newSenderDhPublicKey
≠≠ $
=
≠≠% &
null
≠≠' +
;
≠≠+ ,
byte
ÆÆ 
[
ÆÆ 
]
ÆÆ 
?
ÆÆ 
metadataKey
ÆÆ 
=
ÆÆ 
null
ÆÆ "
;
ÆÆ" #
byte
ØØ 
[
ØØ 
]
ØØ 
?
ØØ 
encryptedMetadata
ØØ !
=
ØØ" #
null
ØØ$ (
;
ØØ( )
try
∞∞ 
{
±± 	
Result
≤≤ 
<
≤≤ 
(
≤≤ 
RatchetChainKey
≤≤ #

RatchetKey
≤≤$ .
,
≤≤. /
bool
≤≤0 4
IncludeDhKey
≤≤5 A
)
≤≤A B
,
≤≤B C%
EcliptixProtocolFailure
≤≤D [
>
≤≤[ \

prepResult
≤≤] g
=
≤≤h i

connection
≥≥ 
.
≥≥ $
PrepareNextSendMessage
≥≥ 1
(
≥≥1 2
)
≥≥2 3
;
≥≥3 4
if
¥¥ 
(
¥¥ 

prepResult
¥¥ 
.
¥¥ 
IsErr
¥¥  
)
¥¥  !
{
µµ 
return
∂∂ 
Result
∂∂ 
<
∂∂ 
SecureEnvelope
∂∂ ,
,
∂∂, -%
EcliptixProtocolFailure
∂∂. E
>
∂∂E F
.
∂∂F G
Err
∂∂G J
(
∂∂J K

prepResult
∂∂K U
.
∂∂U V
	UnwrapErr
∂∂V _
(
∂∂_ `
)
∂∂` a
)
∂∂a b
;
∂∂b c
}
∑∑ 
(
ππ 
RatchetChainKey
ππ 

RatchetKey
ππ '
,
ππ' (
bool
ππ) -
IncludeDhKey
ππ. :
)
ππ: ;
prep
ππ< @
=
ππA B

prepResult
ππC M
.
ππM N
Unwrap
ππN T
(
ππT U
)
ππU V
;
ππV W
Result
ªª 
<
ªª 
byte
ªª 
[
ªª 
]
ªª 
,
ªª %
EcliptixProtocolFailure
ªª 2
>
ªª2 3
nonceResult
ªª4 ?
=
ªª@ A

connection
ªªB L
.
ªªL M
GenerateNextNonce
ªªM ^
(
ªª^ _
)
ªª_ `
;
ªª` a
if
ºº 
(
ºº 
nonceResult
ºº 
.
ºº 
IsErr
ºº !
)
ºº! "
{
ΩΩ 
return
ææ 
Result
ææ 
<
ææ 
SecureEnvelope
ææ ,
,
ææ, -%
EcliptixProtocolFailure
ææ. E
>
ææE F
.
ææF G
Err
ææG J
(
ææJ K
nonceResult
ææK V
.
ææV W
	UnwrapErr
ææW `
(
ææ` a
)
ææa b
)
ææb c
;
ææc d
}
øø 
nonce
¡¡ 
=
¡¡ 
nonceResult
¡¡ 
.
¡¡  
Unwrap
¡¡  &
(
¡¡& '
)
¡¡' (
;
¡¡( )
Result
√√ 
<
√√ 
byte
√√ 
[
√√ 
]
√√ 
,
√√ %
EcliptixProtocolFailure
√√ 2
>
√√2 3
dhKeyResult
√√4 ?
=
√√@ A$
GetOptionalSenderDhKey
√√B X
(
√√X Y
prep
√√Y ]
.
√√] ^
IncludeDhKey
√√^ j
)
√√j k
;
√√k l
if
ƒƒ 
(
ƒƒ 
dhKeyResult
ƒƒ 
.
ƒƒ 
IsErr
ƒƒ !
)
ƒƒ! "
{
≈≈ 
return
∆∆ 
Result
∆∆ 
<
∆∆ 
SecureEnvelope
∆∆ ,
,
∆∆, -%
EcliptixProtocolFailure
∆∆. E
>
∆∆E F
.
∆∆F G
Err
∆∆G J
(
∆∆J K
dhKeyResult
∆∆K V
.
∆∆V W
	UnwrapErr
∆∆W `
(
∆∆` a
)
∆∆a b
)
∆∆b c
;
∆∆c d
}
«« "
newSenderDhPublicKey
……  
=
……! "
dhKeyResult
……# .
.
……. /
Unwrap
……/ 5
(
……5 6
)
……6 7
;
……7 8
RatchetChainKey
ÀÀ 
?
ÀÀ 

messageKey
ÀÀ '
=
ÀÀ( )
prep
ÀÀ* .
.
ÀÀ. /

RatchetKey
ÀÀ/ 9
;
ÀÀ9 :
Result
ÕÕ 
<
ÕÕ "
LocalPublicKeyBundle
ÕÕ '
,
ÕÕ' (%
EcliptixProtocolFailure
ÕÕ) @
>
ÕÕ@ A
peerBundleResult
ÕÕB R
=
ÕÕS T

connection
ÕÕU _
.
ÕÕ_ `
GetPeerBundle
ÕÕ` m
(
ÕÕm n
)
ÕÕn o
;
ÕÕo p
if
ŒŒ 
(
ŒŒ 
peerBundleResult
ŒŒ  
.
ŒŒ  !
IsErr
ŒŒ! &
)
ŒŒ& '
{
œœ 
return
–– 
Result
–– 
<
–– 
SecureEnvelope
–– ,
,
––, -%
EcliptixProtocolFailure
––. E
>
––E F
.
––F G
Err
––G J
(
––J K
peerBundleResult
––K [
.
––[ \
	UnwrapErr
––\ e
(
––e f
)
––f g
)
––g h
;
––h i
}
—— "
LocalPublicKeyBundle
””  

peerBundle
””! +
=
””, -
peerBundleResult
””. >
.
””> ?
Unwrap
””? E
(
””E F
)
””F G
;
””G H
bool
’’ #
connectionIsInitiator
’’ &
=
’’' (

connection
’’) 3
.
’’3 4
IsInitiator
’’4 ?
(
’’? @
)
’’@ A
;
’’A B
ad
÷÷ 
=
÷÷ #
connectionIsInitiator
÷÷ &
?
◊◊ "
CreateAssociatedData
◊◊ &
(
◊◊& '(
ecliptixSystemIdentityKeys
◊◊' A
.
◊◊A B,
GetIdentityX25519PublicKeyCopy
◊◊B `
(
◊◊` a
)
◊◊a b
,
◊◊b c

peerBundle
ÿÿ 
.
ÿÿ 
IdentityX25519
ÿÿ -
)
ÿÿ- .
:
ŸŸ "
CreateAssociatedData
ŸŸ &
(
ŸŸ& '

peerBundle
ŸŸ' 1
.
ŸŸ1 2
IdentityX25519
ŸŸ2 @
,
ŸŸ@ A(
ecliptixSystemIdentityKeys
⁄⁄ .
.
⁄⁄. /,
GetIdentityX25519PublicKeyCopy
⁄⁄/ M
(
⁄⁄M N
)
⁄⁄N O
)
⁄⁄O P
;
⁄⁄P Q
Result
‹‹ 
<
‹‹ 
byte
‹‹ 
[
‹‹ 
]
‹‹ 
,
‹‹ %
EcliptixProtocolFailure
‹‹ 2
>
‹‹2 3
encryptResult
‹‹4 A
=
‹‹B C
Encrypt
›› 
(
›› 

messageKey
›› "
!
››" #
,
››# $
nonce
››% *
,
››* +
plainPayload
››, 8
,
››8 9
ad
››: <
)
››< =
;
››= >
if
ﬁﬁ 
(
ﬁﬁ 
encryptResult
ﬁﬁ 
.
ﬁﬁ 
IsErr
ﬁﬁ #
)
ﬁﬁ# $
{
ﬂﬂ 
return
‡‡ 
Result
‡‡ 
<
‡‡ 
SecureEnvelope
‡‡ ,
,
‡‡, -%
EcliptixProtocolFailure
‡‡. E
>
‡‡E F
.
‡‡F G
Err
‡‡G J
(
‡‡J K
encryptResult
‡‡K X
.
‡‡X Y
	UnwrapErr
‡‡Y b
(
‡‡b c
)
‡‡c d
)
‡‡d e
;
‡‡e f
}
·· 
	encrypted
„„ 
=
„„ 
encryptResult
„„ %
.
„„% &
Unwrap
„„& ,
(
„„, -
)
„„- .
;
„„. /
uint
ÂÂ 
	requestId
ÂÂ 
=
ÂÂ 
Helpers
ÂÂ $
.
ÂÂ$ %"
GenerateRandomUInt32
ÂÂ% 9
(
ÂÂ9 :
true
ÂÂ: >
)
ÂÂ> ?
;
ÂÂ? @
EnvelopeMetadata
ÁÁ 
metadata
ÁÁ %
=
ÁÁ& '
EnvelopeBuilder
ÁÁ( 7
.
ÁÁ7 8$
CreateEnvelopeMetadata
ÁÁ8 N
(
ÁÁN O
	requestId
ËË 
,
ËË 

ByteString
ÈÈ 
.
ÈÈ 
CopyFrom
ÈÈ #
(
ÈÈ# $
nonce
ÈÈ$ )
)
ÈÈ) *
,
ÈÈ* +

messageKey
ÍÍ 
!
ÍÍ 
.
ÍÍ 
Index
ÍÍ !
)
ÍÍ! "
;
ÍÍ" #
Result
ÏÏ 
<
ÏÏ 
byte
ÏÏ 
[
ÏÏ 
]
ÏÏ 
,
ÏÏ %
EcliptixProtocolFailure
ÏÏ 2
>
ÏÏ2 3
metadataKeyResult
ÏÏ4 E
=
ÏÏF G

connection
ÏÏH R
.
ÏÏR S&
GetMetadataEncryptionKey
ÏÏS k
(
ÏÏk l
)
ÏÏl m
;
ÏÏm n
if
ÌÌ 
(
ÌÌ 
metadataKeyResult
ÌÌ !
.
ÌÌ! "
IsErr
ÌÌ" '
)
ÌÌ' (
{
ÓÓ 
return
ÔÔ 
Result
ÔÔ 
<
ÔÔ 
SecureEnvelope
ÔÔ ,
,
ÔÔ, -%
EcliptixProtocolFailure
ÔÔ. E
>
ÔÔE F
.
ÔÔF G
Err
ÔÔG J
(
ÔÔJ K
metadataKeyResult
ÔÔK \
.
ÔÔ\ ]
	UnwrapErr
ÔÔ] f
(
ÔÔf g
)
ÔÔg h
)
ÔÔh i
;
ÔÔi j
}
 
metadataKey
ÚÚ 
=
ÚÚ 
metadataKeyResult
ÚÚ +
.
ÚÚ+ ,
Unwrap
ÚÚ, 2
(
ÚÚ2 3
)
ÚÚ3 4
;
ÚÚ4 5
byte
ÙÙ 
[
ÙÙ 
]
ÙÙ 
metadataNonce
ÙÙ  
=
ÙÙ! "
new
ÙÙ# &
byte
ÙÙ' +
[
ÙÙ+ ,
	Constants
ÙÙ, 5
.
ÙÙ5 6 
AES_GCM_NONCE_SIZE
ÙÙ6 H
]
ÙÙH I
;
ÙÙI J#
RandomNumberGenerator
ıı !
.
ıı! "
Fill
ıı" &
(
ıı& '
metadataNonce
ıı' 4
)
ıı4 5
;
ıı5 6
Result
˜˜ 
<
˜˜ 
byte
˜˜ 
[
˜˜ 
]
˜˜ 
,
˜˜ %
EcliptixProtocolFailure
˜˜ 2
>
˜˜2 3#
encryptMetadataResult
˜˜4 I
=
˜˜J K
EnvelopeBuilder
¯¯ 
.
¯¯  
EncryptMetadata
¯¯  /
(
¯¯/ 0
metadata
¯¯0 8
,
¯¯8 9
metadataKey
¯¯: E
,
¯¯E F
metadataNonce
¯¯G T
,
¯¯T U
ad
¯¯V X
)
¯¯X Y
;
¯¯Y Z
if
˘˘ 
(
˘˘ #
encryptMetadataResult
˘˘ %
.
˘˘% &
IsErr
˘˘& +
)
˘˘+ ,
{
˙˙ 
return
˚˚ 
Result
˚˚ 
<
˚˚ 
SecureEnvelope
˚˚ ,
,
˚˚, -%
EcliptixProtocolFailure
˚˚. E
>
˚˚E F
.
˚˚F G
Err
˚˚G J
(
˚˚J K#
encryptMetadataResult
˚˚K `
.
˚˚` a
	UnwrapErr
˚˚a j
(
˚˚j k
)
˚˚k l
)
˚˚l m
;
˚˚m n
}
¸¸ 
encryptedMetadata
˛˛ 
=
˛˛ #
encryptMetadataResult
˛˛  5
.
˛˛5 6
Unwrap
˛˛6 <
(
˛˛< =
)
˛˛= >
;
˛˛> ?
SecureEnvelope
ÄÄ 
envelope
ÄÄ #
=
ÄÄ$ %
new
ÄÄ& )
(
ÄÄ) *
)
ÄÄ* +
{
ÅÅ 
MetaData
ÇÇ 
=
ÇÇ 

ByteString
ÇÇ %
.
ÇÇ% &
CopyFrom
ÇÇ& .
(
ÇÇ. /
encryptedMetadata
ÇÇ/ @
)
ÇÇ@ A
,
ÇÇA B
EncryptedPayload
ÉÉ  
=
ÉÉ! "

ByteString
ÉÉ# -
.
ÉÉ- .
CopyFrom
ÉÉ. 6
(
ÉÉ6 7
	encrypted
ÉÉ7 @
)
ÉÉ@ A
,
ÉÉA B
HeaderNonce
ÑÑ 
=
ÑÑ 

ByteString
ÑÑ (
.
ÑÑ( )
CopyFrom
ÑÑ) 1
(
ÑÑ1 2
metadataNonce
ÑÑ2 ?
)
ÑÑ? @
,
ÑÑ@ A
	Timestamp
ÖÖ 
=
ÖÖ 
GetProtoTimestamp
ÖÖ -
(
ÖÖ- .
)
ÖÖ. /
,
ÖÖ/ 0

ResultCode
ÜÜ 
=
ÜÜ 

ByteString
ÜÜ '
.
ÜÜ' (
CopyFrom
ÜÜ( 0
(
ÜÜ0 1
BitConverter
ÜÜ1 =
.
ÜÜ= >
GetBytes
ÜÜ> F
(
ÜÜF G
(
ÜÜG H
int
ÜÜH K
)
ÜÜK L 
EnvelopeResultCode
ÜÜL ^
.
ÜÜ^ _
Success
ÜÜ_ f
)
ÜÜf g
)
ÜÜg h
,
ÜÜh i
DhPublicKey
áá 
=
áá "
newSenderDhPublicKey
áá 2
is
áá3 5
{
àà 
Length
àà 
:
àà 
>
àà %
ProtocolSystemConstants
àà 3
.
àà3 4
ProtocolSystem
àà4 B
.
ààB C 
EMPTY_ARRAY_LENGTH
ààC U
}
ààV W
?
ââ 

ByteString
ââ  
.
ââ  !
CopyFrom
ââ! )
(
ââ) *"
newSenderDhPublicKey
ââ* >
)
ââ> ?
:
ää 

ByteString
ää  
.
ää  !
Empty
ää! &
}
ãã 
;
ãã 
return
çç 
Result
çç 
<
çç 
SecureEnvelope
çç (
,
çç( )%
EcliptixProtocolFailure
çç* A
>
ççA B
.
ççB C
Ok
ççC E
(
ççE F
envelope
ççF N
)
ççN O
;
ççO P
}
éé 	
finally
èè 
{
êê 	
if
ëë 
(
ëë 
nonce
ëë 
!=
ëë 
null
ëë 
)
ëë 
{
íí 
SodiumInterop
ìì 
.
ìì 

SecureWipe
ìì (
(
ìì( )
nonce
ìì) .
)
ìì. /
;
ìì/ 0
}
îî 
if
ññ 
(
ññ 
ad
ññ 
!=
ññ 
null
ññ 
)
ññ 
{
óó 
SodiumInterop
òò 
.
òò 

SecureWipe
òò (
(
òò( )
ad
òò) +
)
òò+ ,
;
òò, -
}
ôô 
if
õõ 
(
õõ 
	encrypted
õõ 
!=
õõ 
null
õõ !
)
õõ! "
{
úú 
SodiumInterop
ùù 
.
ùù 

SecureWipe
ùù (
(
ùù( )
	encrypted
ùù) 2
)
ùù2 3
;
ùù3 4
}
ûû 
if
†† 
(
†† "
newSenderDhPublicKey
†† $
!=
††% '
null
††( ,
)
††, -
{
°° 
SodiumInterop
¢¢ 
.
¢¢ 

SecureWipe
¢¢ (
(
¢¢( )"
newSenderDhPublicKey
¢¢) =
)
¢¢= >
;
¢¢> ?
}
££ 
if
•• 
(
•• 
metadataKey
•• 
!=
•• 
null
•• #
)
••# $
{
¶¶ 
SodiumInterop
ßß 
.
ßß 

SecureWipe
ßß (
(
ßß( )
metadataKey
ßß) 4
)
ßß4 5
;
ßß5 6
}
®® 
if
™™ 
(
™™ 
encryptedMetadata
™™ !
!=
™™" $
null
™™% )
)
™™) *
{
´´ 
Array
¨¨ 
.
¨¨ 
Clear
¨¨ 
(
¨¨ 
encryptedMetadata
¨¨ -
)
¨¨- .
;
¨¨. /
}
≠≠ 
}
ÆÆ 	
}
ØØ 
public
±± 

Result
±± 
<
±± 
byte
±± 
[
±± 
]
±± 
,
±± %
EcliptixProtocolFailure
±± 1
>
±±1 2$
ProcessInboundEnvelope
±±3 I
(
±±I J
SecureEnvelope
±±J X
secureEnvelope
±±Y g
)
±±g h
{
≤≤ (
EcliptixProtocolConnection
≥≥ "
?
≥≥" #

connection
≥≥$ .
=
≥≥/ 0
GetConnectionSafe
≥≥1 B
(
≥≥B C
)
≥≥C D
;
≥≥D E
if
¥¥ 

(
¥¥ 

connection
¥¥ 
==
¥¥ 
null
¥¥ 
)
¥¥ 
{
µµ 	
return
∂∂ 
Result
∂∂ 
<
∂∂ 
byte
∂∂ 
[
∂∂ 
]
∂∂  
,
∂∂  !%
EcliptixProtocolFailure
∂∂" 9
>
∂∂9 :
.
∂∂: ;
Err
∂∂; >
(
∂∂> ?%
EcliptixProtocolFailure
∑∑ '
.
∑∑' (
Generic
∑∑( /
(
∑∑/ 0%
ProtocolSystemConstants
∑∑0 G
.
∑∑G H
ProtocolSystem
∑∑H V
.
∏∏ 9
+PROTOCOL_CONNECTION_NOT_INITIALIZED_MESSAGE
∏∏ @
)
∏∏@ A
)
∏∏A B
;
∏∏B C
}
ππ 	
return
ªª ,
ProcessInboundEnvelopeInternal
ªª -
(
ªª- .
secureEnvelope
ªª. <
,
ªª< =

connection
ªª> H
)
ªªH I
;
ªªI J
}
ºº 
private
ææ 
Result
ææ 
<
ææ 
byte
ææ 
[
ææ 
]
ææ 
,
ææ %
EcliptixProtocolFailure
ææ 2
>
ææ2 3,
ProcessInboundEnvelopeInternal
ææ4 R
(
ææR S
SecureEnvelope
ææS a
secureEnvelope
ææb p
,
ææp q(
EcliptixProtocolConnection
øø "

connection
øø# -
)
øø- .
{
¿¿ 
byte
¡¡ 
[
¡¡ 
]
¡¡ 
?
¡¡ 
dhPublicKey
¡¡ 
=
¡¡ 
null
¡¡ "
;
¡¡" #
byte
¬¬ 
[
¬¬ 
]
¬¬ 
?
¬¬ 
headerNonce
¬¬ 
=
¬¬ 
null
¬¬ "
;
¬¬" #
byte
√√ 
[
√√ 
]
√√ 
?
√√ 
metadataKey
√√ 
=
√√ 
null
√√ "
;
√√" #
byte
ƒƒ 
[
ƒƒ 
]
ƒƒ 
?
ƒƒ 
ad
ƒƒ 
=
ƒƒ 
null
ƒƒ 
;
ƒƒ 
byte
≈≈ 
[
≈≈ 
]
≈≈ 
?
≈≈ 
encryptedMetadata
≈≈ !
=
≈≈" #
null
≈≈$ (
;
≈≈( )
try
∆∆ 
{
«« 	
Result
»» 
<
»» 
Unit
»» 
,
»» %
EcliptixProtocolFailure
»» 0
>
»»0 1
ratchetResult
»»2 ?
=
»»@ A
HandleDhRatchet
»»B Q
(
»»Q R
secureEnvelope
»»R `
,
»»` a
out
»»b e
dhPublicKey
»»f q
)
»»q r
;
»»r s
if
…… 
(
…… 
ratchetResult
…… 
.
…… 
IsErr
…… #
)
……# $
{
   
return
ÀÀ 
Result
ÀÀ 
<
ÀÀ 
byte
ÀÀ "
[
ÀÀ" #
]
ÀÀ# $
,
ÀÀ$ %%
EcliptixProtocolFailure
ÀÀ& =
>
ÀÀ= >
.
ÀÀ> ?
Err
ÀÀ? B
(
ÀÀB C
ratchetResult
ÀÀC P
.
ÀÀP Q
	UnwrapErr
ÀÀQ Z
(
ÀÀZ [
)
ÀÀ[ \
)
ÀÀ\ ]
;
ÀÀ] ^
}
ÃÃ 
Result
ŒŒ 
<
ŒŒ !
DecryptionMaterials
ŒŒ &
,
ŒŒ& '%
EcliptixProtocolFailure
ŒŒ( ?
>
ŒŒ? @
materialsResult
ŒŒA P
=
ŒŒQ R(
ExtractDecryptionMaterials
œœ *
(
œœ* +
secureEnvelope
œœ+ 9
,
œœ9 :

connection
œœ; E
,
œœE F
out
œœG J
headerNonce
œœK V
,
œœV W
out
œœX [
metadataKey
œœ\ g
,
œœg h
out
œœi l
ad
œœm o
,
œœo p
out
œœq t 
encryptedMetadataœœu Ü
)œœÜ á
;œœá à
if
–– 
(
–– 
materialsResult
–– 
.
––  
IsErr
––  %
)
––% &
{
—— 
return
““ 
Result
““ 
<
““ 
byte
““ "
[
““" #
]
““# $
,
““$ %%
EcliptixProtocolFailure
““& =
>
““= >
.
““> ?
Err
““? B
(
““B C
materialsResult
““C R
.
““R S
	UnwrapErr
““S \
(
““\ ]
)
““] ^
)
““^ _
;
““_ `
}
”” 
Result
’’ 
<
’’ 
EnvelopeMetadata
’’ #
,
’’# $%
EcliptixProtocolFailure
’’% <
>
’’< =
metadataResult
’’> L
=
’’M N
EnvelopeBuilder
÷÷ 
.
÷÷  
DecryptMetadata
÷÷  /
(
÷÷/ 0
encryptedMetadata
÷÷0 A
!
÷÷A B
,
÷÷B C
metadataKey
÷÷D O
!
÷÷O P
,
÷÷P Q
headerNonce
÷÷R ]
!
÷÷] ^
,
÷÷^ _
ad
÷÷` b
!
÷÷b c
)
÷÷c d
;
÷÷d e
if
◊◊ 
(
◊◊ 
metadataResult
◊◊ 
.
◊◊ 
IsErr
◊◊ $
)
◊◊$ %
{
ÿÿ 
return
ŸŸ 
Result
ŸŸ 
<
ŸŸ 
byte
ŸŸ "
[
ŸŸ" #
]
ŸŸ# $
,
ŸŸ$ %%
EcliptixProtocolFailure
ŸŸ& =
>
ŸŸ= >
.
ŸŸ> ?
Err
ŸŸ? B
(
ŸŸB C
metadataResult
ŸŸC Q
.
ŸŸQ R
	UnwrapErr
ŸŸR [
(
ŸŸ[ \
)
ŸŸ\ ]
)
ŸŸ] ^
;
ŸŸ^ _
}
⁄⁄ 
EnvelopeMetadata
‹‹ 
metadata
‹‹ %
=
‹‹& '
metadataResult
‹‹( 6
.
‹‹6 7
Unwrap
‹‹7 =
(
‹‹= >
)
‹‹> ?
;
‹‹? @
byte
›› 
[
›› 
]
›› 
encryptedPayload
›› #
=
››$ %
secureEnvelope
››& 4
.
››4 5
EncryptedPayload
››5 E
.
››E F
ToByteArray
››F Q
(
››Q R
)
››R S
;
››S T
return
ﬂﬂ 1
#ProcessInboundEnvelopeFromMaterials
ﬂﬂ 6
(
ﬂﬂ6 7
metadata
ﬂﬂ7 ?
,
ﬂﬂ? @
encryptedPayload
ﬂﬂA Q
,
ﬂﬂQ R

connection
ﬂﬂS ]
)
ﬂﬂ] ^
;
ﬂﬂ^ _
}
‡‡ 	
finally
·· 
{
‚‚ 	(
CleanupDecryptionMaterials
„„ &
(
„„& '
dhPublicKey
„„' 2
,
„„2 3
headerNonce
„„4 ?
,
„„? @
metadataKey
„„A L
,
„„L M
ad
„„N P
,
„„P Q
encryptedMetadata
„„R c
)
„„c d
;
„„d e
}
‰‰ 	
}
ÂÂ 
private
ÁÁ 
Result
ÁÁ 
<
ÁÁ 
Unit
ÁÁ 
,
ÁÁ %
EcliptixProtocolFailure
ÁÁ 0
>
ÁÁ0 1
HandleDhRatchet
ÁÁ2 A
(
ÁÁA B
SecureEnvelope
ÁÁB P
secureEnvelope
ÁÁQ _
,
ÁÁ_ `
out
ÁÁa d
byte
ÁÁe i
[
ÁÁi j
]
ÁÁj k
?
ÁÁk l
dhPublicKey
ÁÁm x
)
ÁÁx y
{
ËË 
dhPublicKey
ÈÈ 
=
ÈÈ 
null
ÈÈ 
;
ÈÈ 
if
ÎÎ 

(
ÎÎ 
secureEnvelope
ÎÎ 
.
ÎÎ 
DhPublicKey
ÎÎ &
==
ÎÎ' )
null
ÎÎ* .
||
ÎÎ/ 1
secureEnvelope
ÎÎ2 @
.
ÎÎ@ A
DhPublicKey
ÎÎA L
.
ÎÎL M
IsEmpty
ÎÎM T
)
ÎÎT U
{
ÏÏ 	
return
ÌÌ 
Result
ÌÌ 
<
ÌÌ 
Unit
ÌÌ 
,
ÌÌ %
EcliptixProtocolFailure
ÌÌ  7
>
ÌÌ7 8
.
ÌÌ8 9
Ok
ÌÌ9 ;
(
ÌÌ; <
Unit
ÌÌ< @
.
ÌÌ@ A
Value
ÌÌA F
)
ÌÌF G
;
ÌÌG H
}
ÓÓ 	
dhPublicKey
 
=
 
secureEnvelope
 $
.
$ %
DhPublicKey
% 0
.
0 1
ToByteArray
1 <
(
< =
)
= >
;
> ?
Result
ÒÒ 
<
ÒÒ 
Unit
ÒÒ 
,
ÒÒ %
EcliptixProtocolFailure
ÒÒ ,
>
ÒÒ, -
ratchetResult
ÒÒ. ;
=
ÒÒ< =$
PerformRatchetIfNeeded
ÒÒ> T
(
ÒÒT U
dhPublicKey
ÒÒU `
)
ÒÒ` a
;
ÒÒa b
return
ÛÛ 
ratchetResult
ÛÛ 
.
ÛÛ 
IsErr
ÛÛ "
?
ÙÙ 
Result
ÙÙ 
<
ÙÙ 
Unit
ÙÙ 
,
ÙÙ %
EcliptixProtocolFailure
ÙÙ 2
>
ÙÙ2 3
.
ÙÙ3 4
Err
ÙÙ4 7
(
ÙÙ7 8
ratchetResult
ÙÙ8 E
.
ÙÙE F
	UnwrapErr
ÙÙF O
(
ÙÙO P
)
ÙÙP Q
)
ÙÙQ R
:
ıı 
Result
ıı 
<
ıı 
Unit
ıı 
,
ıı %
EcliptixProtocolFailure
ıı 2
>
ıı2 3
.
ıı3 4
Ok
ıı4 6
(
ıı6 7
Unit
ıı7 ;
.
ıı; <
Value
ıı< A
)
ııA B
;
ııB C
}
ˆˆ 
private
¯¯ 
readonly
¯¯ 
record
¯¯ 
struct
¯¯ "!
DecryptionMaterials
¯¯# 6
(
¯¯6 7
byte
¯¯7 ;
[
¯¯; <
]
¯¯< =
MetadataKey
¯¯> I
,
¯¯I J
byte
¯¯K O
[
¯¯O P
]
¯¯P Q
Ad
¯¯R T
)
¯¯T U
;
¯¯U V
private
˙˙ 
Result
˙˙ 
<
˙˙ !
DecryptionMaterials
˙˙ &
,
˙˙& '%
EcliptixProtocolFailure
˙˙( ?
>
˙˙? @(
ExtractDecryptionMaterials
˙˙A [
(
˙˙[ \
SecureEnvelope
˚˚ 
secureEnvelope
˚˚ %
,
˚˚% &(
EcliptixProtocolConnection
¸¸ "

connection
¸¸# -
,
¸¸- .
out
˝˝ 
byte
˝˝ 
[
˝˝ 
]
˝˝ 
?
˝˝ 
headerNonce
˝˝ 
,
˝˝  
out
˛˛ 
byte
˛˛ 
[
˛˛ 
]
˛˛ 
?
˛˛ 
metadataKey
˛˛ 
,
˛˛  
out
ˇˇ 
byte
ˇˇ 
[
ˇˇ 
]
ˇˇ 
?
ˇˇ 
ad
ˇˇ 
,
ˇˇ 
out
ÄÄ 
byte
ÄÄ 
[
ÄÄ 
]
ÄÄ 
?
ÄÄ 
encryptedMetadata
ÄÄ %
)
ÄÄ% &
{
ÅÅ 
headerNonce
ÇÇ 
=
ÇÇ 
null
ÇÇ 
;
ÇÇ 
metadataKey
ÉÉ 
=
ÉÉ 
null
ÉÉ 
;
ÉÉ 
ad
ÑÑ 

=
ÑÑ 
null
ÑÑ 
;
ÑÑ 
encryptedMetadata
ÖÖ 
=
ÖÖ 
null
ÖÖ  
;
ÖÖ  !
if
áá 

(
áá 
secureEnvelope
áá 
.
áá 
HeaderNonce
áá &
==
áá' )
null
áá* .
||
áá/ 1
secureEnvelope
áá2 @
.
áá@ A
HeaderNonce
ááA L
.
ááL M
IsEmpty
ááM T
||
ááU W
secureEnvelope
àà 
.
àà 
HeaderNonce
àà &
.
àà& '
Length
àà' -
!=
àà. 0
	Constants
àà1 :
.
àà: ; 
AES_GCM_NONCE_SIZE
àà; M
)
ààM N
{
ââ 	
return
ää 
Result
ää 
<
ää !
DecryptionMaterials
ää -
,
ää- .%
EcliptixProtocolFailure
ää/ F
>
ääF G
.
ääG H
Err
ääH K
(
ääK L%
EcliptixProtocolFailure
ãã '
.
ãã' (
Decode
ãã( .
(
ãã. /
$str
ãã/ h
)
ããh i
)
ããi j
;
ããj k
}
åå 	
headerNonce
éé 
=
éé 
secureEnvelope
éé $
.
éé$ %
HeaderNonce
éé% 0
.
éé0 1
ToByteArray
éé1 <
(
éé< =
)
éé= >
;
éé> ?
Result
êê 
<
êê 
byte
êê 
[
êê 
]
êê 
,
êê %
EcliptixProtocolFailure
êê .
>
êê. /
metadataKeyResult
êê0 A
=
êêB C

connection
êêD N
.
êêN O&
GetMetadataEncryptionKey
êêO g
(
êêg h
)
êêh i
;
êêi j
if
ëë 

(
ëë 
metadataKeyResult
ëë 
.
ëë 
IsErr
ëë #
)
ëë# $
{
íí 	
return
ìì 
Result
ìì 
<
ìì !
DecryptionMaterials
ìì -
,
ìì- .%
EcliptixProtocolFailure
ìì/ F
>
ììF G
.
ììG H
Err
ììH K
(
ììK L
metadataKeyResult
ììL ]
.
ìì] ^
	UnwrapErr
ìì^ g
(
ììg h
)
ììh i
)
ììi j
;
ììj k
}
îî 	
metadataKey
ññ 
=
ññ 
metadataKeyResult
ññ '
.
ññ' (
Unwrap
ññ( .
(
ññ. /
)
ññ/ 0
;
ññ0 1
Result
òò 
<
òò "
LocalPublicKeyBundle
òò #
,
òò# $%
EcliptixProtocolFailure
òò% <
>
òò< =
peerBundleResult
òò> N
=
òòO P

connection
òòQ [
.
òò[ \
GetPeerBundle
òò\ i
(
òòi j
)
òòj k
;
òòk l
if
ôô 

(
ôô 
peerBundleResult
ôô 
.
ôô 
IsErr
ôô "
)
ôô" #
{
öö 	
return
õõ 
Result
õõ 
<
õõ !
DecryptionMaterials
õõ -
,
õõ- .%
EcliptixProtocolFailure
õõ/ F
>
õõF G
.
õõG H
Err
õõH K
(
õõK L
peerBundleResult
õõL \
.
õõ\ ]
	UnwrapErr
õõ] f
(
õõf g
)
õõg h
)
õõh i
;
õõi j
}
úú 	"
LocalPublicKeyBundle
ûû 

peerBundle
ûû '
=
ûû( )
peerBundleResult
ûû* :
.
ûû: ;
Unwrap
ûû; A
(
ûûA B
)
ûûB C
;
ûûC D
bool
†† #
connectionIsInitiator
†† "
=
††# $

connection
††% /
.
††/ 0
IsInitiator
††0 ;
(
††; <
)
††< =
;
††= >
ad
°° 

=
°° #
connectionIsInitiator
°° "
?
¢¢ "
CreateAssociatedData
¢¢ "
(
¢¢" #(
ecliptixSystemIdentityKeys
¢¢# =
.
¢¢= >,
GetIdentityX25519PublicKeyCopy
¢¢> \
(
¢¢\ ]
)
¢¢] ^
,
¢¢^ _

peerBundle
¢¢` j
.
¢¢j k
IdentityX25519
¢¢k y
)
¢¢y z
:
££ "
CreateAssociatedData
££ "
(
££" #

peerBundle
££# -
.
££- .
IdentityX25519
££. <
,
££< =(
ecliptixSystemIdentityKeys
££> X
.
££X Y,
GetIdentityX25519PublicKeyCopy
££Y w
(
££w x
)
££x y
)
££y z
;
££z {
encryptedMetadata
•• 
=
•• 
secureEnvelope
•• *
.
••* +
MetaData
••+ 3
.
••3 4
ToByteArray
••4 ?
(
••? @
)
••@ A
;
••A B
return
ßß 
Result
ßß 
<
ßß !
DecryptionMaterials
ßß )
,
ßß) *%
EcliptixProtocolFailure
ßß+ B
>
ßßB C
.
ßßC D
Ok
ßßD F
(
ßßF G
new
ßßG J!
DecryptionMaterials
ßßK ^
(
ßß^ _
metadataKey
ßß_ j
,
ßßj k
ad
ßßl n
)
ßßn o
)
ßßo p
;
ßßp q
}
®® 
private
™™ 
static
™™ 
void
™™ (
CleanupDecryptionMaterials
™™ 2
(
™™2 3
byte
™™3 7
[
™™7 8
]
™™8 9
?
™™9 :
dhPublicKey
™™; F
,
™™F G
byte
™™H L
[
™™L M
]
™™M N
?
™™N O
headerNonce
™™P [
,
™™[ \
byte
™™] a
[
™™a b
]
™™b c
?
™™c d
metadataKey
™™e p
,
™™p q
byte
™™r v
[
™™v w
]
™™w x
?
™™x y
ad
™™z |
,
™™| }
byte™™~ Ç
[™™Ç É
]™™É Ñ
?™™Ñ Ö!
encryptedMetadata™™Ü ó
)™™ó ò
{
´´ 
if
¨¨ 

(
¨¨ 
dhPublicKey
¨¨ 
!=
¨¨ 
null
¨¨ 
)
¨¨  
{
≠≠ 	
SodiumInterop
ÆÆ 
.
ÆÆ 

SecureWipe
ÆÆ $
(
ÆÆ$ %
dhPublicKey
ÆÆ% 0
)
ÆÆ0 1
;
ÆÆ1 2
}
ØØ 	
if
±± 

(
±± 
headerNonce
±± 
!=
±± 
null
±± 
)
±±  
{
≤≤ 	
SodiumInterop
≥≥ 
.
≥≥ 

SecureWipe
≥≥ $
(
≥≥$ %
headerNonce
≥≥% 0
)
≥≥0 1
;
≥≥1 2
}
¥¥ 	
if
∂∂ 

(
∂∂ 
metadataKey
∂∂ 
!=
∂∂ 
null
∂∂ 
)
∂∂  
{
∑∑ 	
SodiumInterop
∏∏ 
.
∏∏ 

SecureWipe
∏∏ $
(
∏∏$ %
metadataKey
∏∏% 0
)
∏∏0 1
;
∏∏1 2
}
ππ 	
if
ªª 

(
ªª 
ad
ªª 
!=
ªª 
null
ªª 
)
ªª 
{
ºº 	
SodiumInterop
ΩΩ 
.
ΩΩ 

SecureWipe
ΩΩ $
(
ΩΩ$ %
ad
ΩΩ% '
)
ΩΩ' (
;
ΩΩ( )
}
ææ 	
if
¿¿ 

(
¿¿ 
encryptedMetadata
¿¿ 
!=
¿¿  
null
¿¿! %
)
¿¿% &
{
¡¡ 	
Array
¬¬ 
.
¬¬ 
Clear
¬¬ 
(
¬¬ 
encryptedMetadata
¬¬ )
)
¬¬) *
;
¬¬* +
}
√√ 	
}
ƒƒ 
private
∆∆ 
Result
∆∆ 
<
∆∆ 
Unit
∆∆ 
,
∆∆ %
EcliptixProtocolFailure
∆∆ 0
>
∆∆0 1$
PerformRatchetIfNeeded
∆∆2 H
(
∆∆H I
byte
∆∆I M
[
∆∆M N
]
∆∆N O
?
∆∆O P
receivedDhKey
∆∆Q ^
)
∆∆^ _
{
«« (
EcliptixProtocolConnection
»» "
?
»»" #

connection
»»$ .
=
»»/ 0
GetConnectionSafe
»»1 B
(
»»B C
)
»»C D
;
»»D E
if
…… 

(
…… 
receivedDhKey
…… 
==
…… 
null
…… !
||
……" $

connection
……% /
==
……0 2
null
……3 7
)
……7 8
{
   	
return
ÀÀ 
Result
ÀÀ 
<
ÀÀ 
Unit
ÀÀ 
,
ÀÀ %
EcliptixProtocolFailure
ÀÀ  7
>
ÀÀ7 8
.
ÀÀ8 9
Ok
ÀÀ9 ;
(
ÀÀ; <
Unit
ÀÀ< @
.
ÀÀ@ A
Value
ÀÀA F
)
ÀÀF G
;
ÀÀG H
}
ÃÃ 	
Result
ŒŒ 
<
ŒŒ 
byte
ŒŒ 
[
ŒŒ 
]
ŒŒ 
?
ŒŒ 
,
ŒŒ %
EcliptixProtocolFailure
ŒŒ /
>
ŒŒ/ 0
currentKeyResult
ŒŒ1 A
=
ŒŒB C

connection
ŒŒD N
.
ŒŒN O'
GetCurrentPeerDhPublicKey
ŒŒO h
(
ŒŒh i
)
ŒŒi j
;
ŒŒj k
if
œœ 

(
œœ 
currentKeyResult
œœ 
.
œœ 
IsErr
œœ "
)
œœ" #
{
–– 	
return
—— 
Result
—— 
<
—— 
Unit
—— 
,
—— %
EcliptixProtocolFailure
——  7
>
——7 8
.
——8 9
Err
——9 <
(
——< =
currentKeyResult
——= M
.
——M N
	UnwrapErr
——N W
(
——W X
)
——X Y
)
——Y Z
;
——Z [
}
““ 	
byte
‘‘ 
[
‘‘ 
]
‘‘ 
?
‘‘ 
currentPeerDhKey
‘‘  
=
‘‘! "
currentKeyResult
‘‘# 3
.
‘‘3 4
Unwrap
‘‘4 :
(
‘‘: ;
)
‘‘; <
;
‘‘< =
if
÷÷ 

(
÷÷ 
currentPeerDhKey
÷÷ 
!=
÷÷ 
null
÷÷  $
)
÷÷$ %
{
◊◊ 	
Result
ÿÿ 
<
ÿÿ 
bool
ÿÿ 
,
ÿÿ 
SodiumFailure
ÿÿ &
>
ÿÿ& '
comparisonResult
ÿÿ( 8
=
ÿÿ9 :
SodiumInterop
ŸŸ 
.
ŸŸ  
ConstantTimeEquals
ŸŸ 0
(
ŸŸ0 1
receivedDhKey
ŸŸ1 >
.
ŸŸ> ?
AsSpan
ŸŸ? E
(
ŸŸE F
)
ŸŸF G
,
ŸŸG H
currentPeerDhKey
ŸŸI Y
)
ŸŸY Z
;
ŸŸZ [
if
⁄⁄ 
(
⁄⁄ 
comparisonResult
⁄⁄  
.
⁄⁄  !
IsOk
⁄⁄! %
&&
⁄⁄& (
comparisonResult
⁄⁄) 9
.
⁄⁄9 :
Unwrap
⁄⁄: @
(
⁄⁄@ A
)
⁄⁄A B
)
⁄⁄B C
{
€€ 
return
‹‹ 
Result
‹‹ 
<
‹‹ 
Unit
‹‹ "
,
‹‹" #%
EcliptixProtocolFailure
‹‹$ ;
>
‹‹; <
.
‹‹< =
Ok
‹‹= ?
(
‹‹? @
Unit
‹‹@ D
.
‹‹D E
Value
‹‹E J
)
‹‹J K
;
‹‹K L
}
›› 
}
ﬁﬁ 	
return
‡‡ "
PerformAtomicRatchet
‡‡ #
(
‡‡# $
receivedDhKey
‡‡$ 1
)
‡‡1 2
;
‡‡2 3
}
·· 
private
„„ 
Result
„„ 
<
„„ 
Unit
„„ 
,
„„ %
EcliptixProtocolFailure
„„ 0
>
„„0 1"
PerformAtomicRatchet
„„2 F
(
„„F G
byte
„„G K
[
„„K L
]
„„L M
receivedDhKey
„„N [
)
„„[ \
{
‰‰ (
EcliptixProtocolConnection
ÂÂ "
?
ÂÂ" #

connection
ÂÂ$ .
=
ÂÂ/ 0
GetConnectionSafe
ÂÂ1 B
(
ÂÂB C
)
ÂÂC D
;
ÂÂD E
if
ÊÊ 

(
ÊÊ 

connection
ÊÊ 
==
ÊÊ 
null
ÊÊ 
)
ÊÊ 
{
ÁÁ 	
return
ËË 
Result
ËË 
<
ËË 
Unit
ËË 
,
ËË %
EcliptixProtocolFailure
ËË  7
>
ËË7 8
.
ËË8 9
Err
ËË9 <
(
ËË< =%
EcliptixProtocolFailure
ÈÈ '
.
ÈÈ' (
Generic
ÈÈ( /
(
ÈÈ/ 0%
ProtocolSystemConstants
ÈÈ0 G
.
ÈÈG H
ProtocolSystem
ÈÈH V
.
ÍÍ 9
+PROTOCOL_CONNECTION_NOT_INITIALIZED_MESSAGE
ÍÍ @
)
ÍÍ@ A
)
ÍÍA B
;
ÍÍB C
}
ÎÎ 	

connection
ÌÌ 
.
ÌÌ #
NotifyRatchetRotation
ÌÌ (
(
ÌÌ( )
)
ÌÌ) *
;
ÌÌ* +
Result
ÔÔ 
<
ÔÔ 
Unit
ÔÔ 
,
ÔÔ %
EcliptixProtocolFailure
ÔÔ ,
>
ÔÔ, -
ratchetResult
ÔÔ. ;
=
ÔÔ< =

connection
ÔÔ> H
.
ÔÔH I%
PerformReceivingRatchet
ÔÔI `
(
ÔÔ` a
receivedDhKey
ÔÔa n
)
ÔÔn o
;
ÔÔo p
if
 

(
 
ratchetResult
 
.
 
IsErr
 
)
  
{
ÒÒ 	
return
ÚÚ 
ratchetResult
ÚÚ  
;
ÚÚ  !
}
ÛÛ 	

connection
ıı 
.
ıı #
NotifyRatchetRotation
ıı (
(
ıı( )
)
ıı) *
;
ıı* +
return
ˆˆ 
Result
ˆˆ 
<
ˆˆ 
Unit
ˆˆ 
,
ˆˆ %
EcliptixProtocolFailure
ˆˆ 3
>
ˆˆ3 4
.
ˆˆ4 5
Ok
ˆˆ5 7
(
ˆˆ7 8
Unit
ˆˆ8 <
.
ˆˆ< =
Value
ˆˆ= B
)
ˆˆB C
;
ˆˆC D
}
˜˜ 
private
˘˘ 
Result
˘˘ 
<
˘˘ 
byte
˘˘ 
[
˘˘ 
]
˘˘ 
,
˘˘ %
EcliptixProtocolFailure
˘˘ 2
>
˘˘2 3$
GetOptionalSenderDhKey
˘˘4 J
(
˘˘J K
bool
˘˘K O
include
˘˘P W
)
˘˘W X
{
˙˙ (
EcliptixProtocolConnection
˚˚ "
?
˚˚" #

connection
˚˚$ .
=
˚˚/ 0
GetConnectionSafe
˚˚1 B
(
˚˚B C
)
˚˚C D
;
˚˚D E
if
˝˝ 

(
˝˝ 
!
˝˝ 
include
˝˝ 
||
˝˝ 

connection
˝˝ "
==
˝˝# %
null
˝˝& *
)
˝˝* +
{
˛˛ 	
return
ˇˇ 
Result
ˇˇ 
<
ˇˇ 
byte
ˇˇ 
[
ˇˇ 
]
ˇˇ  
,
ˇˇ  !%
EcliptixProtocolFailure
ˇˇ" 9
>
ˇˇ9 :
.
ˇˇ: ;
Ok
ˇˇ; =
(
ˇˇ= >
[
ˇˇ> ?
]
ˇˇ? @
)
ˇˇ@ A
;
ˇˇA B
}
ÄÄ 	
Result
ÇÇ 
<
ÇÇ 
byte
ÇÇ 
[
ÇÇ 
]
ÇÇ 
?
ÇÇ 
,
ÇÇ %
EcliptixProtocolFailure
ÇÇ /
>
ÇÇ/ 0
	keyResult
ÇÇ1 :
=
ÇÇ; <

connection
ÇÇ= G
.
ÇÇG H)
GetCurrentSenderDhPublicKey
ÇÇH c
(
ÇÇc d
)
ÇÇd e
;
ÇÇe f
if
ÉÉ 

(
ÉÉ 
	keyResult
ÉÉ 
.
ÉÉ 
IsErr
ÉÉ 
)
ÉÉ 
{
ÑÑ 	
return
ÖÖ 
Result
ÖÖ 
<
ÖÖ 
byte
ÖÖ 
[
ÖÖ 
]
ÖÖ  
,
ÖÖ  !%
EcliptixProtocolFailure
ÖÖ" 9
>
ÖÖ9 :
.
ÖÖ: ;
Err
ÖÖ; >
(
ÖÖ> ?
	keyResult
ÖÖ? H
.
ÖÖH I
	UnwrapErr
ÖÖI R
(
ÖÖR S
)
ÖÖS T
)
ÖÖT U
;
ÖÖU V
}
ÜÜ 	
byte
àà 
[
àà 
]
àà 
?
àà 
key
àà 
=
àà 
	keyResult
àà 
.
àà  
Unwrap
àà  &
(
àà& '
)
àà' (
;
àà( )
return
ää 
Result
ää 
<
ää 
byte
ää 
[
ää 
]
ää 
,
ää %
EcliptixProtocolFailure
ää 5
>
ää5 6
.
ää6 7
Ok
ää7 9
(
ää9 :
key
ää: =
??
ää> @
[
ääA B
]
ääB C
)
ääC D
;
ääD E
}
ãã 
private
çç 
static
çç 
byte
çç 
[
çç 
]
çç "
CreateAssociatedData
çç .
(
çç. /
byte
çç/ 3
[
çç3 4
]
çç4 5
id1
çç6 9
,
çç9 :
byte
çç; ?
[
çç? @
]
çç@ A
id2
ççB E
)
ççE F
{
éé 
int
èè 
maxIdLength
èè 
=
èè %
ProtocolSystemConstants
èè 1
.
èè1 2
ProtocolSystem
èè2 @
.
èè@ A%
MAX_IDENTITY_KEY_LENGTH
èèA X
;
èèX Y
if
êê 

(
êê 
id1
êê 
.
êê 
Length
êê 
>
êê 
maxIdLength
êê $
||
êê% '
id2
êê( +
.
êê+ ,
Length
êê, 2
>
êê3 4
maxIdLength
êê5 @
)
êê@ A
{
ëë 	
throw
íí 
new
íí 
ArgumentException
íí '
(
íí' (
string
ìì 
.
ìì 
Format
ìì 
(
ìì %
ProtocolSystemConstants
ìì 5
.
ìì5 6
ProtocolSystem
ìì6 D
.
ììD E-
IDENTITY_KEYS_TOO_LARGE_MESSAGE
ììE d
,
ììd e
maxIdLength
ììf q
)
ììq r
)
ììr s
;
ììs t
}
îî 	
if
ññ 

(
ññ 
id1
ññ 
.
ññ 
Length
ññ 
+
ññ 
id2
ññ 
.
ññ 
Length
ññ #
>
ññ$ %
int
ññ& )
.
ññ) *
MaxValue
ññ* 2
/
ññ3 4%
ProtocolSystemConstants
ññ5 L
.
ññL M
ProtocolSystem
ññM [
.
ññ[ \&
INTEGER_OVERFLOW_DIVISOR
ññ\ t
)
ññt u
{
óó 	
throw
òò 
new
òò 
ArgumentException
òò '
(
òò' (%
ProtocolSystemConstants
òò( ?
.
òò? @
ProtocolSystem
òò@ N
.
òòN O&
INTEGER_OVERFLOW_MESSAGE
òòO g
)
òòg h
;
òòh i
}
ôô 	
byte
õõ 
[
õõ 
]
õõ 
ad
õõ 
=
õõ 
new
õõ 
byte
õõ 
[
õõ 
id1
õõ  
.
õõ  !
Length
õõ! '
+
õõ( )
id2
õõ* -
.
õõ- .
Length
õõ. 4
]
õõ4 5
;
õõ5 6
Buffer
úú 
.
úú 
	BlockCopy
úú 
(
úú 
id1
úú 
,
úú %
ProtocolSystemConstants
úú 5
.
úú5 6
ProtocolSystem
úú6 D
.
úúD E&
BUFFER_COPY_START_OFFSET
úúE ]
,
úú] ^
ad
úú_ a
,
úúa b%
ProtocolSystemConstants
ùù #
.
ùù# $
ProtocolSystem
ùù$ 2
.
ùù2 3&
BUFFER_COPY_START_OFFSET
ùù3 K
,
ùùK L
id1
ùùM P
.
ùùP Q
Length
ùùQ W
)
ùùW X
;
ùùX Y
Buffer
ûû 
.
ûû 
	BlockCopy
ûû 
(
ûû 
id2
ûû 
,
ûû %
ProtocolSystemConstants
ûû 5
.
ûû5 6
ProtocolSystem
ûû6 D
.
ûûD E&
BUFFER_COPY_START_OFFSET
ûûE ]
,
ûû] ^
ad
ûû_ a
,
ûûa b
id1
ûûc f
.
ûûf g
Length
ûûg m
,
ûûm n
id2
ûûo r
.
ûûr s
Length
ûûs y
)
ûûy z
;
ûûz {
return
üü 
ad
üü 
;
üü 
}
†† 
private
¢¢ 
static
¢¢ 
Result
¢¢ 
<
¢¢ 
byte
¢¢ 
[
¢¢ 
]
¢¢  
,
¢¢  !%
EcliptixProtocolFailure
¢¢" 9
>
¢¢9 :
Encrypt
¢¢; B
(
¢¢B C
RatchetChainKey
¢¢C R
key
¢¢S V
,
¢¢V W
byte
¢¢X \
[
¢¢\ ]
]
¢¢] ^
nonce
¢¢_ d
,
¢¢d e
byte
££ 
[
££ 
]
££ 
	plaintext
££ 
,
££ 
byte
££ 
[
££ 
]
££  
ad
££! #
)
££# $
{
§§ 
using
•• 
SecurePooledArray
•• 
<
••  
byte
••  $
>
••$ %
keyMaterial
••& 1
=
••2 3
SecureArrayPool
••4 C
.
••C D
Rent
••D H
<
••H I
byte
••I M
>
••M N
(
••N O
	Constants
••O X
.
••X Y
AES_KEY_SIZE
••Y e
)
••e f
;
••f g
byte
¶¶ 
[
¶¶ 
]
¶¶ 
?
¶¶ 

ciphertext
¶¶ 
=
¶¶ 
null
¶¶ !
;
¶¶! "
try
ßß 
{
®® 	
Span
©© 
<
©© 
byte
©© 
>
©© 
keySpan
©© 
=
©©  
keyMaterial
©©! ,
.
©©, -
AsSpan
©©- 3
(
©©3 4
)
©©4 5
;
©©5 6
Result
™™ 
<
™™ 
Unit
™™ 
,
™™ %
EcliptixProtocolFailure
™™ 0
>
™™0 1

readResult
™™2 <
=
™™= >
RatchetChainKey
™™? N
.
™™N O
ReadKeyMaterial
™™O ^
(
™™^ _
key
™™_ b
,
™™b c
keySpan
™™d k
)
™™k l
;
™™l m
if
´´ 
(
´´ 

readResult
´´ 
.
´´ 
IsErr
´´  
)
´´  !
{
¨¨ 
return
≠≠ 
Result
≠≠ 
<
≠≠ 
byte
≠≠ "
[
≠≠" #
]
≠≠# $
,
≠≠$ %%
EcliptixProtocolFailure
≠≠& =
>
≠≠= >
.
≠≠> ?
Err
≠≠? B
(
≠≠B C

readResult
≠≠C M
.
≠≠M N
	UnwrapErr
≠≠N W
(
≠≠W X
)
≠≠X Y
)
≠≠Y Z
;
≠≠Z [
}
ÆÆ 

ciphertext
∞∞ 
=
∞∞ 
new
∞∞ 
byte
∞∞ !
[
∞∞! "
	plaintext
∞∞" +
.
∞∞+ ,
Length
∞∞, 2
]
∞∞2 3
;
∞∞3 4
Span
±± 
<
±± 
byte
±± 
>
±± 
tag
±± 
=
±± 

stackalloc
±± '
byte
±±( ,
[
±±, -
	Constants
±±- 6
.
±±6 7
AES_GCM_TAG_SIZE
±±7 G
]
±±G H
;
±±H I
using
≥≥ 
(
≥≥ 
AesGcm
≥≥ 
aesGcm
≥≥  
=
≥≥! "
new
≥≥# &
(
≥≥& '
keySpan
≥≥' .
,
≥≥. /
	Constants
≥≥0 9
.
≥≥9 :
AES_GCM_TAG_SIZE
≥≥: J
)
≥≥J K
)
≥≥K L
{
¥¥ 
aesGcm
µµ 
.
µµ 
Encrypt
µµ 
(
µµ 
nonce
µµ $
,
µµ$ %
	plaintext
µµ& /
,
µµ/ 0

ciphertext
µµ1 ;
,
µµ; <
tag
µµ= @
,
µµ@ A
ad
µµB D
)
µµD E
;
µµE F
}
∂∂ 
byte
∏∏ 
[
∏∏ 
]
∏∏ 
result
∏∏ 
=
∏∏ 
new
∏∏ 
byte
∏∏  $
[
∏∏$ %

ciphertext
∏∏% /
.
∏∏/ 0
Length
∏∏0 6
+
∏∏7 8
tag
∏∏9 <
.
∏∏< =
Length
∏∏= C
]
∏∏C D
;
∏∏D E
Buffer
ππ 
.
ππ 
	BlockCopy
ππ 
(
ππ 

ciphertext
ππ '
,
ππ' (%
ProtocolSystemConstants
ππ) @
.
ππ@ A
ProtocolSystem
ππA O
.
ππO P&
BUFFER_COPY_START_OFFSET
ππP h
,
ππh i
result
ππj p
,
ππp q%
ProtocolSystemConstants
∫∫ '
.
∫∫' (
ProtocolSystem
∫∫( 6
.
∫∫6 7&
BUFFER_COPY_START_OFFSET
∫∫7 O
,
∫∫O P

ciphertext
∫∫Q [
.
∫∫[ \
Length
∫∫\ b
)
∫∫b c
;
∫∫c d
tag
ªª 
.
ªª 
CopyTo
ªª 
(
ªª 
result
ªª 
.
ªª 
AsSpan
ªª $
(
ªª$ %

ciphertext
ªª% /
.
ªª/ 0
Length
ªª0 6
)
ªª6 7
)
ªª7 8
;
ªª8 9
return
ΩΩ 
Result
ΩΩ 
<
ΩΩ 
byte
ΩΩ 
[
ΩΩ 
]
ΩΩ  
,
ΩΩ  !%
EcliptixProtocolFailure
ΩΩ" 9
>
ΩΩ9 :
.
ΩΩ: ;
Ok
ΩΩ; =
(
ΩΩ= >
result
ΩΩ> D
)
ΩΩD E
;
ΩΩE F
}
ææ 	
catch
øø 
(
øø 
	Exception
øø 
ex
øø 
)
øø 
{
¿¿ 	
if
¡¡ 
(
¡¡ 

ciphertext
¡¡ 
!=
¡¡ 
null
¡¡ "
)
¡¡" #
{
¬¬ 
SodiumInterop
√√ 
.
√√ 

SecureWipe
√√ (
(
√√( )

ciphertext
√√) 3
)
√√3 4
;
√√4 5
}
ƒƒ 
return
∆∆ 
Result
∆∆ 
<
∆∆ 
byte
∆∆ 
[
∆∆ 
]
∆∆  
,
∆∆  !%
EcliptixProtocolFailure
∆∆" 9
>
∆∆9 :
.
∆∆: ;
Err
∆∆; >
(
∆∆> ?%
EcliptixProtocolFailure
«« '
.
««' (
Generic
««( /
(
««/ 0%
ProtocolSystemConstants
««0 G
.
««G H
ProtocolSystem
««H V
.
««V W/
!AES_GCM_ENCRYPTION_FAILED_MESSAGE
««W x
,
««x y
ex
»» 
)
»» 
)
»» 
;
»» 
}
…… 	
}
   
public
ÃÃ 

static
ÃÃ 
Result
ÃÃ 
<
ÃÃ $
EcliptixProtocolSystem
ÃÃ /
,
ÃÃ/ 0%
EcliptixProtocolFailure
ÃÃ1 H
>
ÃÃH I

CreateFrom
ÃÃJ T
(
ÃÃT U(
EcliptixSystemIdentityKeys
ÃÃU o
keys
ÃÃp t
,
ÃÃt u(
EcliptixProtocolConnection
ÕÕ "

connection
ÕÕ# -
)
ÕÕ- .
{
ŒŒ $
EcliptixProtocolSystem
œœ 
system
œœ %
=
œœ& '
new
œœ( +
(
œœ+ ,
keys
œœ, 0
)
œœ0 1
{
œœ2 3!
_protocolConnection
œœ4 G
=
œœH I

connection
œœJ T
}
œœU V
;
œœV W
return
–– 
Result
–– 
<
–– $
EcliptixProtocolSystem
–– ,
,
––, -%
EcliptixProtocolFailure
––. E
>
––E F
.
––F G
Ok
––G I
(
––I J
system
––J P
)
––P Q
;
––Q R
}
—— 
public
”” 
(
EcliptixProtocolConnection
”” %
?
””% &
GetConnection
””' 4
(
””4 5
)
””5 6
=>
””7 9
GetConnectionSafe
””: K
(
””K L
)
””L M
;
””M N
private
’’ 
Result
’’ 
<
’’ 
byte
’’ 
[
’’ 
]
’’ 
,
’’ %
EcliptixProtocolFailure
’’ 2
>
’’2 31
#ProcessInboundEnvelopeFromMaterials
’’4 W
(
’’W X
EnvelopeMetadata
’’X h
metadata
’’i q
,
’’q r
byte
÷÷ 
[
÷÷ 
]
÷÷ 
encryptedPayload
÷÷ 
,
÷÷  (
EcliptixProtocolConnection
◊◊ "

connection
◊◊# -
)
◊◊- .
{
ÿÿ 
byte
ŸŸ 
[
ŸŸ 
]
ŸŸ 
?
ŸŸ 
ad
ŸŸ 
=
ŸŸ 
null
ŸŸ 
;
ŸŸ 
try
⁄⁄ 
{
€€ 	
Result
‹‹ 
<
‹‹ 
Unit
‹‹ 
,
‹‹ %
EcliptixProtocolFailure
‹‹ 0
>
‹‹0 1
replayCheck
‹‹2 =
=
‹‹> ?

connection
‹‹@ J
.
‹‹J K#
CheckReplayProtection
‹‹K `
(
‹‹` a
[
›› 
..
›› 
metadata
›› 
.
›› 
Nonce
›› "
]
››" #
,
››# $
metadata
ﬁﬁ 
.
ﬁﬁ 
RatchetIndex
ﬁﬁ %
)
ﬁﬁ% &
;
ﬁﬁ& '
if
ﬂﬂ 
(
ﬂﬂ 
replayCheck
ﬂﬂ 
.
ﬂﬂ 
IsErr
ﬂﬂ !
)
ﬂﬂ! "
{
‡‡ 
return
·· 
Result
·· 
<
·· 
byte
·· "
[
··" #
]
··# $
,
··$ %%
EcliptixProtocolFailure
··& =
>
··= >
.
··> ?
Err
··? B
(
··B C
replayCheck
··C N
.
··N O
	UnwrapErr
··O X
(
··X Y
)
··Y Z
)
··Z [
;
··[ \
}
‚‚ 
Result
‰‰ 
<
‰‰ 
RatchetChainKey
‰‰ "
,
‰‰" #%
EcliptixProtocolFailure
‰‰$ ;
>
‰‰; <
messageResult
‰‰= J
=
‰‰K L

connection
ÂÂ 
.
ÂÂ $
ProcessReceivedMessage
ÂÂ 1
(
ÂÂ1 2
metadata
ÂÂ2 :
.
ÂÂ: ;
RatchetIndex
ÂÂ; G
)
ÂÂG H
;
ÂÂH I
if
ÊÊ 
(
ÊÊ 
messageResult
ÊÊ 
.
ÊÊ 
IsErr
ÊÊ #
)
ÊÊ# $
{
ÁÁ 
return
ËË 
Result
ËË 
<
ËË 
byte
ËË "
[
ËË" #
]
ËË# $
,
ËË$ %%
EcliptixProtocolFailure
ËË& =
>
ËË= >
.
ËË> ?
Err
ËË? B
(
ËËB C
messageResult
ËËC P
.
ËËP Q
	UnwrapErr
ËËQ Z
(
ËËZ [
)
ËË[ \
)
ËË\ ]
;
ËË] ^
}
ÈÈ 
RatchetChainKey
ÎÎ 

messageKey
ÎÎ &
=
ÎÎ' (
messageResult
ÎÎ) 6
.
ÎÎ6 7
Unwrap
ÎÎ7 =
(
ÎÎ= >
)
ÎÎ> ?
;
ÎÎ? @
Result
ÌÌ 
<
ÌÌ "
LocalPublicKeyBundle
ÌÌ '
,
ÌÌ' (%
EcliptixProtocolFailure
ÌÌ) @
>
ÌÌ@ A
peerBundleResult
ÌÌB R
=
ÌÌS T

connection
ÌÌU _
.
ÌÌ_ `
GetPeerBundle
ÌÌ` m
(
ÌÌm n
)
ÌÌn o
;
ÌÌo p
if
ÓÓ 
(
ÓÓ 
peerBundleResult
ÓÓ  
.
ÓÓ  !
IsErr
ÓÓ! &
)
ÓÓ& '
{
ÔÔ 
return
 
Result
 
<
 
byte
 "
[
" #
]
# $
,
$ %%
EcliptixProtocolFailure
& =
>
= >
.
> ?
Err
? B
(
B C
peerBundleResult
C S
.
S T
	UnwrapErr
T ]
(
] ^
)
^ _
)
_ `
;
` a
}
ÒÒ "
LocalPublicKeyBundle
ÛÛ  

peerBundle
ÛÛ! +
=
ÛÛ, -
peerBundleResult
ÛÛ. >
.
ÛÛ> ?
Unwrap
ÛÛ? E
(
ÛÛE F
)
ÛÛF G
;
ÛÛG H
bool
ıı 
isInitiator
ıı 
=
ıı 

connection
ıı )
.
ıı) *
IsInitiator
ıı* 5
(
ıı5 6
)
ıı6 7
;
ıı7 8
ad
ˆˆ 
=
ˆˆ 
isInitiator
ˆˆ 
?
˜˜ "
CreateAssociatedData
˜˜ &
(
˜˜& '(
ecliptixSystemIdentityKeys
˜˜' A
.
˜˜A B,
GetIdentityX25519PublicKeyCopy
˜˜B `
(
˜˜` a
)
˜˜a b
,
˜˜b c

peerBundle
¯¯ 
.
¯¯ 
IdentityX25519
¯¯ -
)
¯¯- .
:
˘˘ "
CreateAssociatedData
˘˘ &
(
˘˘& '

peerBundle
˘˘' 1
.
˘˘1 2
IdentityX25519
˘˘2 @
,
˘˘@ A(
ecliptixSystemIdentityKeys
˙˙ .
.
˙˙. /,
GetIdentityX25519PublicKeyCopy
˙˙/ M
(
˙˙M N
)
˙˙N O
)
˙˙O P
;
˙˙P Q
Result
¸¸ 
<
¸¸ 
byte
¸¸ 
[
¸¸ 
]
¸¸ 
,
¸¸ %
EcliptixProtocolFailure
¸¸ 2
>
¸¸2 3
result
¸¸4 :
=
¸¸; <"
DecryptFromMaterials
˝˝ $
(
˝˝$ %

messageKey
˝˝% /
,
˝˝/ 0
metadata
˝˝1 9
,
˝˝9 :
encryptedPayload
˝˝; K
,
˝˝K L
ad
˝˝M O
)
˝˝O P
;
˝˝P Q
return
ˇˇ 
result
ˇˇ 
;
ˇˇ 
}
ÄÄ 	
finally
ÅÅ 
{
ÇÇ 	
SodiumInterop
ÉÉ 
.
ÉÉ 

SecureWipe
ÉÉ $
(
ÉÉ$ %
ad
ÉÉ% '
)
ÉÉ' (
;
ÉÉ( )
}
ÑÑ 	
}
ÖÖ 
private
áá 
static
áá 
Result
áá 
<
áá 
byte
áá 
[
áá 
]
áá  
,
áá  !%
EcliptixProtocolFailure
áá" 9
>
áá9 :"
DecryptFromMaterials
áá; O
(
ááO P
RatchetChainKey
ááP _
key
áá` c
,
áác d
EnvelopeMetadata
àà 
metadata
àà !
,
àà! "
byte
ââ 
[
ââ 
]
ââ 
encryptedPayload
ââ 
,
ââ  
byte
ââ! %
[
ââ% &
]
ââ& '
ad
ââ( *
)
ââ* +
{
ää 
ReadOnlySpan
ãã 
<
ãã 
byte
ãã 
>
ãã 
fullCipherSpan
ãã )
=
ãã* +
encryptedPayload
ãã, <
.
ãã< =
AsSpan
ãã= C
(
ããC D
)
ããD E
;
ããE F
const
åå 
int
åå 
TAG_SIZE
åå 
=
åå 
	Constants
åå &
.
åå& '
AES_GCM_TAG_SIZE
åå' 7
;
åå7 8
int
çç 
cipherLength
çç 
=
çç 
fullCipherSpan
çç )
.
çç) *
Length
çç* 0
-
çç1 2
TAG_SIZE
çç3 ;
;
çç; <
if
èè 

(
èè 
cipherLength
èè 
<
èè %
ProtocolSystemConstants
èè 2
.
èè2 3
ProtocolSystem
èè3 A
.
èèA B-
CIPHER_LENGTH_MINIMUM_THRESHOLD
èèB a
)
èèa b
{
êê 	
return
ëë 
Result
ëë 
<
ëë 
byte
ëë 
[
ëë 
]
ëë  
,
ëë  !%
EcliptixProtocolFailure
ëë" 9
>
ëë9 :
.
ëë: ;
Err
ëë; >
(
ëë> ?%
EcliptixProtocolFailure
ëë? V
.
ëëV W
BUFFER_TOO_SMALL
ëëW g
(
ëëg h
string
íí 
.
íí 
Format
íí 
(
íí %
ProtocolSystemConstants
íí 5
.
íí5 6
ProtocolSystem
íí6 D
.
ííD E*
CIPHERTEXT_TOO_SMALL_MESSAGE
ííE a
,
íía b
fullCipherSpan
ííc q
.
ííq r
Length
íír x
,
ííx y
TAG_SIZE
ìì 
)
ìì 
)
ìì 
)
ìì 
;
ìì  
}
îî 	
using
ññ 
SecurePooledArray
ññ 
<
ññ  
byte
ññ  $
>
ññ$ %
keyMaterial
ññ& 1
=
ññ2 3
SecureArrayPool
ññ4 C
.
ññC D
Rent
ññD H
<
ññH I
byte
ññI M
>
ññM N
(
ññN O
	Constants
ññO X
.
ññX Y
AES_KEY_SIZE
ññY e
)
ññe f
;
ññf g
byte
óó 
[
óó 
]
óó 
?
óó 
	plaintext
óó 
=
óó 
null
óó  
;
óó  !
byte
òò 
[
òò 
]
òò 
?
òò 
nonce
òò 
=
òò 
null
òò 
;
òò 
try
öö 
{
õõ 	
Span
úú 
<
úú 
byte
úú 
>
úú 
keySpan
úú 
=
úú  
keyMaterial
úú! ,
.
úú, -
AsSpan
úú- 3
(
úú3 4
)
úú4 5
;
úú5 6
Result
ùù 
<
ùù 
Unit
ùù 
,
ùù %
EcliptixProtocolFailure
ùù 0
>
ùù0 1

readResult
ùù2 <
=
ùù= >
RatchetChainKey
ùù? N
.
ùùN O
ReadKeyMaterial
ùùO ^
(
ùù^ _
key
ùù_ b
,
ùùb c
keySpan
ùùd k
)
ùùk l
;
ùùl m
if
ûû 
(
ûû 

readResult
ûû 
.
ûû 
IsErr
ûû  
)
ûû  !
{
üü 
return
†† 
Result
†† 
<
†† 
byte
†† "
[
††" #
]
††# $
,
††$ %%
EcliptixProtocolFailure
††& =
>
††= >
.
††> ?
Err
††? B
(
††B C

readResult
††C M
.
††M N
	UnwrapErr
††N W
(
††W X
)
††X Y
)
††Y Z
;
††Z [
}
°° 
ReadOnlySpan
££ 
<
££ 
byte
££ 
>
££ 
ciphertextSpan
££ -
=
££. /
fullCipherSpan
££0 >
[
££> ?
..
££? A
cipherLength
££A M
]
££M N
;
££N O
ReadOnlySpan
§§ 
<
§§ 
byte
§§ 
>
§§ 
tagSpan
§§ &
=
§§' (
fullCipherSpan
§§) 7
[
§§7 8
cipherLength
§§8 D
..
§§D F
]
§§F G
;
§§G H%
SecureByteStringInterop
¶¶ #
.
¶¶# $#
SecureCopyWithCleanup
¶¶$ 9
(
¶¶9 :
metadata
¶¶: B
.
¶¶B C
Nonce
¶¶C H
,
¶¶H I
out
¶¶J M
nonce
¶¶N S
)
¶¶S T
;
¶¶T U
	plaintext
®® 
=
®® 
new
®® 
byte
®®  
[
®®  !
cipherLength
®®! -
]
®®- .
;
®®. /
using
™™ 
(
™™ 
AesGcm
™™ 
aesGcm
™™  
=
™™! "
new
™™# &
(
™™& '
keySpan
™™' .
,
™™. /
	Constants
™™0 9
.
™™9 :
AES_GCM_TAG_SIZE
™™: J
)
™™J K
)
™™K L
{
´´ 
aesGcm
¨¨ 
.
¨¨ 
Decrypt
¨¨ 
(
¨¨ 
nonce
¨¨ $
,
¨¨$ %
ciphertextSpan
¨¨& 4
,
¨¨4 5
tagSpan
¨¨6 =
,
¨¨= >
	plaintext
¨¨? H
,
¨¨H I
ad
¨¨J L
)
¨¨L M
;
¨¨M N
}
≠≠ 
byte
ØØ 
[
ØØ 
]
ØØ 
result
ØØ 
=
ØØ 
new
ØØ 
byte
ØØ  $
[
ØØ$ %
	plaintext
ØØ% .
.
ØØ. /
Length
ØØ/ 5
]
ØØ5 6
;
ØØ6 7
	plaintext
∞∞ 
.
∞∞ 
CopyTo
∞∞ 
(
∞∞ 
result
∞∞ #
,
∞∞# $
$num
∞∞% &
)
∞∞& '
;
∞∞' (
return
≤≤ 
Result
≤≤ 
<
≤≤ 
byte
≤≤ 
[
≤≤ 
]
≤≤  
,
≤≤  !%
EcliptixProtocolFailure
≤≤" 9
>
≤≤9 :
.
≤≤: ;
Ok
≤≤; =
(
≤≤= >
result
≤≤> D
)
≤≤D E
;
≤≤E F
}
≥≥ 	
catch
¥¥ 
(
¥¥ 
	Exception
¥¥ 
ex
¥¥ 
)
¥¥ 
{
µµ 	
return
∂∂ 
Result
∂∂ 
<
∂∂ 
byte
∂∂ 
[
∂∂ 
]
∂∂  
,
∂∂  !%
EcliptixProtocolFailure
∂∂" 9
>
∂∂9 :
.
∂∂: ;
Err
∂∂; >
(
∂∂> ?%
EcliptixProtocolFailure
∑∑ '
.
∑∑' (
Generic
∑∑( /
(
∑∑/ 0%
ProtocolSystemConstants
∑∑0 G
.
∑∑G H
ProtocolSystem
∑∑H V
.
∑∑V W/
!AES_GCM_DECRYPTION_FAILED_MESSAGE
∑∑W x
,
∑∑x y
ex
∏∏ 
)
∏∏ 
)
∏∏ 
;
∏∏ 
}
ππ 	
finally
∫∫ 
{
ªª 	
if
ºº 
(
ºº 
	plaintext
ºº 
!=
ºº 
null
ºº !
)
ºº! "
{
ΩΩ 
SodiumInterop
ææ 
.
ææ 

SecureWipe
ææ (
(
ææ( )
	plaintext
ææ) 2
)
ææ2 3
;
ææ3 4
}
øø 
if
¡¡ 
(
¡¡ 
nonce
¡¡ 
!=
¡¡ 
null
¡¡ 
)
¡¡ 
{
¬¬ 
SodiumInterop
√√ 
.
√√ 

SecureWipe
√√ (
(
√√( )
nonce
√√) .
)
√√. /
;
√√/ 0
}
ƒƒ 
}
≈≈ 	
}
∆∆ 
}«« Î⁄	
v/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/EcliptixProtocolConnection.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
internal 
sealed	 
class &
EcliptixProtocolConnection 0
:1 2
IDisposable3 >
{ 
private 
static 
readonly 
TimeSpan $
SessionTimeout% 3
=4 5#
ProtocolSystemConstants6 M
.M N
TimeoutsN V
.V W
SessionTimeoutW e
;e f
private 
static 
ReadOnlySpan 
<  
byte  $
>$ %"
InitialSenderChainInfo& <
=>= ?
Encoding 
. 
UTF8 
. 
GetBytes 
( #
ProtocolSystemConstants 6
.6 7
Protocol7 ?
.? @%
INITIAL_SENDER_CHAIN_INFO@ Y
)Y Z
;Z [
private 
static 
ReadOnlySpan 
<  
byte  $
>$ %$
InitialReceiverChainInfo& >
=>? A
Encoding 
. 
UTF8 
. 
GetBytes 
( #
ProtocolSystemConstants 6
.6 7
Protocol7 ?
.? @'
INITIAL_RECEIVER_CHAIN_INFO@ [
)[ \
;\ ]
private 
static 
ReadOnlySpan 
<  
byte  $
>$ %
DhRatchetInfo& 3
=>4 6
Encoding 
. 
UTF8 
. 
GetBytes 
( #
ProtocolSystemConstants 6
.6 7
Protocol7 ?
.? @
DH_RATCHET_INFO@ O
)O P
;P Q
private 
readonly 
Lock 
_lock 
=  !
new" %
(% &
)& '
;' (
private 
readonly 
ReplayProtection %
_replayProtection& 7
=8 9
new: =
(= >
)> ?
;? @
private   
readonly   
RatchetConfig   "
_ratchetConfig  # 1
;  1 2
private!! 
readonly!! 
RatchetRecovery!! $
_ratchetRecovery!!% 5
=!!6 7
new!!8 ;
(!!; <
)!!< =
;!!= >
private## 
readonly## 
DateTimeOffset## #

_createdAt##$ .
;##. /
private$$ 
readonly$$ 
uint$$ 
_id$$ 
;$$ 
private%% 
long%% !
_lastRatchetTimeTicks%% &
=%%' (
DateTime%%) 1
.%%1 2
UtcNow%%2 8
.%%8 9
Ticks%%9 >
;%%> ?
private&& 
volatile&& 
bool&& $
_isFirstReceivingRatchet&& 2
;&&2 3
private'' 
readonly'' 
bool'' 
_isInitiator'' &
;''& '
private(( 
readonly(( %
EcliptixProtocolChainStep(( .
_sendingStep((/ ;
;((; <
private)) $
SodiumSecureMemoryHandle)) $
?))$ %-
!_currentSendingDhPrivateKeyHandle))& G
;))G H
private** 
volatile** 
bool** 
	_disposed** #
;**# $
private++ 
readonly++ $
SodiumSecureMemoryHandle++ -
?++- .-
!_initialSendingDhPrivateKeyHandle++/ P
;++P Q
private,, 
long,, 
_nonceCounter,, 
;,, 
private--  
LocalPublicKeyBundle--  
?--  !
_peerBundle--" -
;--- .
private.. 
byte.. 
[.. 
].. 
?.. 
_peerDhPublicKey.. $
;..$ %
private// 
readonly// $
SodiumSecureMemoryHandle// -
?//- .)
_persistentDhPrivateKeyHandle/// L
;//L M
private00 
readonly00 
byte00 
[00 
]00 
?00 "
_persistentDhPublicKey00 3
;003 4
private11 
volatile11 
bool11 
_receivedNewDhKey11 +
;11+ ,
private22 %
EcliptixProtocolChainStep22 %
?22% &
_receivingStep22' 5
;225 6
private33 $
SodiumSecureMemoryHandle33 $
?33$ %
_rootKeyHandle33& 4
;334 5
private44 $
SodiumSecureMemoryHandle44 $
?44$ %(
_metadataEncryptionKeyHandle44& B
;44B C
private55 !
IProtocolEventHandler55 !
?55! "
_eventHandler55# 0
;550 1
private66 
readonly66 
PubKeyExchangeType66 '
_exchangeType66( 5
;665 6
public88 

PubKeyExchangeType88 
ExchangeType88 *
=>88+ -
_exchangeType88. ;
;88; <
private:: &
EcliptixProtocolConnection:: &
(::& '
uint::' +
id::, .
,::. /
bool::0 4
isInitiator::5 @
,::@ A$
SodiumSecureMemoryHandle::B Z
initialSendingDh::[ k
,::k l%
EcliptixProtocolChainStep;; !
sendingStep;;" -
,;;- .$
SodiumSecureMemoryHandle;;/ G
persistentDh;;H T
,;;T U
byte;;V Z
[;;Z [
];;[ \
persistentDhPublic;;] o
,;;o p
RatchetConfig<< 
ratchetConfig<< #
,<<# $
PubKeyExchangeType<<% 7
exchangeType<<8 D
)<<D E
{== 
_id>> 
=>> 
id>> 
;>> 
_isInitiator?? 
=?? 
isInitiator?? "
;??" #-
!_initialSendingDhPrivateKeyHandle@@ )
=@@* +
initialSendingDh@@, <
;@@< =-
!_currentSendingDhPrivateKeyHandleAA )
=AA* +
initialSendingDhAA, <
;AA< =
_sendingStepBB 
=BB 
sendingStepBB "
;BB" #)
_persistentDhPrivateKeyHandleCC %
=CC& '
persistentDhCC( 4
;CC4 5"
_persistentDhPublicKeyDD 
=DD  
persistentDhPublicDD! 3
;DD3 4
_ratchetConfigEE 
=EE 
ratchetConfigEE &
;EE& '
_exchangeTypeFF 
=FF 
exchangeTypeFF $
;FF$ %
_peerBundleGG 
=GG 
nullGG 
;GG 
_receivingStepHH 
=HH 
nullHH 
;HH 
_rootKeyHandleII 
=II 
nullII 
;II 
_nonceCounterJJ 
=JJ #
ProtocolSystemConstantsJJ /
.JJ/ 0
ProtocolJJ0 8
.JJ8 9!
INITIAL_NONCE_COUNTERJJ9 N
;JJN O

_createdAtKK 
=KK 
DateTimeOffsetKK #
.KK# $
UtcNowKK$ *
;KK* +
_peerDhPublicKeyLL 
=LL 
nullLL 
;LL  
_receivedNewDhKeyMM 
=MM 
falseMM !
;MM! "
	_disposedNN 
=NN 
falseNN 
;NN 
}OO 
privateQQ &
EcliptixProtocolConnectionQQ &
(QQ& '
uintQQ' +
idQQ, .
,QQ. /
RatchetStateQQ0 <
protoQQ= B
,QQB C%
EcliptixProtocolChainStepQQD ]
sendingStepQQ^ i
,QQi j%
EcliptixProtocolChainStepRR !
?RR! "
receivingStepRR# 0
,RR0 1$
SodiumSecureMemoryHandleRR2 J
rootKeyHandleRRK X
,RRX Y
RatchetConfigRRZ g
ratchetConfigRRh u
,RRu v
PubKeyExchangeTypeSS 
exchangeTypeSS '
)SS' (
{TT 
_idUU 
=UU 
idUU 
;UU 
_isInitiatorVV 
=VV 
protoVV 
.VV 
IsInitiatorVV (
;VV( )

_createdAtWW 
=WW 
protoWW 
.WW 
	CreatedAtWW $
.WW$ %
ToDateTimeOffsetWW% 5
(WW5 6
)WW6 7
;WW7 8
_nonceCounterXX 
=XX 
(XX 
longXX 
)XX 
protoXX #
.XX# $
NonceCounterXX$ 0
;XX0 1
_peerBundleYY 
=YY  
LocalPublicKeyBundleYY *
.YY* + 
FromProtobufExchangeYY+ ?
(YY? @
protoYY@ E
.YYE F

PeerBundleYYF P
)YYP Q
.YYQ R
UnwrapYYR X
(YYX Y
)YYY Z
;YYZ [
ifZZ 

(ZZ 
!ZZ 
protoZZ 
.ZZ 
PeerDhPublicKeyZZ "
.ZZ" #
IsEmptyZZ# *
)ZZ* +
{[[ 	#
SecureByteStringInterop\\ #
.\\# $!
SecureCopyWithCleanup\\$ 9
(\\9 :
proto\\: ?
.\\? @
PeerDhPublicKey\\@ O
,\\O P
out\\Q T
byte\\U Y
[\\Y Z
]\\Z [
	peerDhKey\\\ e
)\\e f
;\\f g
_peerDhPublicKey]] 
=]] 
	peerDhKey]] (
;]]( )
}^^ 	
else__ 
{`` 	
_peerDhPublicKeyaa 
=aa 
nullaa #
;aa# $
}bb 	$
_isFirstReceivingRatchetdd  
=dd! "
protodd# (
.dd( )#
IsFirstReceivingRatchetdd) @
;dd@ A
_rootKeyHandleee 
=ee 
rootKeyHandleee &
;ee& '
_sendingStepff 
=ff 
sendingStepff "
;ff" #
_receivingStepgg 
=gg 
receivingStepgg &
;gg& '-
!_currentSendingDhPrivateKeyHandlehh )
=hh* +
sendingStephh, 7
.hh7 8!
GetDhPrivateKeyHandlehh8 M
(hhM N
)hhN O
;hhO P-
!_initialSendingDhPrivateKeyHandleii )
=ii* +
nullii, 0
;ii0 1)
_persistentDhPrivateKeyHandlejj %
=jj& '
nulljj( ,
;jj, -"
_persistentDhPublicKeykk 
=kk  
nullkk! %
;kk% &
_ratchetConfigll 
=ll 
ratchetConfigll &
;ll& '
_exchangeTypemm 
=mm 
exchangeTypemm $
;mm$ %
_receivedNewDhKeynn 
=nn 
falsenn !
;nn! "
	_disposedoo 
=oo 
falseoo 
;oo 
_lockpp 
=pp 
newpp 
Lockpp 
(pp 
)pp 
;pp 
}qq 
publicss 

voidss 
SetEventHandlerss 
(ss  !
IProtocolEventHandlerss  5
?ss5 6
handlerss7 >
)ss> ?
=>ss@ B
_eventHandlerssC P
=ssQ R
handlerssS Z
;ssZ [
publicuu 

voiduu 
Disposeuu 
(uu 
)uu 
{vv 
Disposeww 
(ww 
trueww 
)ww 
;ww 
GCxx 

.xx
 
SuppressFinalizexx 
(xx 
thisxx  
)xx  !
;xx! "
}yy 
public{{ 

static{{ 
Result{{ 
<{{ &
EcliptixProtocolConnection{{ 3
,{{3 4#
EcliptixProtocolFailure{{5 L
>{{L M
Create{{N T
({{T U
uint{{U Y
	connectId{{Z c
,{{c d
bool{{e i
isInitiator{{j u
){{u v
{|| 
return}} 
Create}} 
(}} 
	connectId}} 
,}}  
isInitiator}}! ,
,}}, -
RatchetConfig}}. ;
.}}; <
Default}}< C
,}}C D
PubKeyExchangeType}}E W
.}}W X
InitialHandshake}}X h
)}}h i
;}}i j
}~~ 
public
ÄÄ 

static
ÄÄ 
Result
ÄÄ 
<
ÄÄ (
EcliptixProtocolConnection
ÄÄ 3
,
ÄÄ3 4%
EcliptixProtocolFailure
ÄÄ5 L
>
ÄÄL M
Create
ÄÄN T
(
ÄÄT U
uint
ÅÅ 
	connectId
ÅÅ 
,
ÅÅ 
bool
ÇÇ 
isInitiator
ÇÇ 
,
ÇÇ 
RatchetConfig
ÉÉ 
ratchetConfig
ÉÉ #
,
ÉÉ# $ 
PubKeyExchangeType
ÑÑ 
exchangeType
ÑÑ '
)
ÑÑ' (
{
ÖÖ &
SodiumSecureMemoryHandle
ÜÜ  
?
ÜÜ  !.
 initialSendingDhPrivateKeyHandle
ÜÜ" B
=
ÜÜC D
null
ÜÜE I
;
ÜÜI J
byte
áá 
[
áá 
]
áá 
?
áá -
initialSendingDhPrivateKeyBytes
áá /
=
áá0 1
null
áá2 6
;
áá6 7'
EcliptixProtocolChainStep
àà !
?
àà! "
sendingStep
àà# .
=
àà/ 0
null
àà1 5
;
àà5 6&
SodiumSecureMemoryHandle
ââ  
?
ââ  !*
persistentDhPrivateKeyHandle
ââ" >
=
ââ? @
null
ââA E
;
ââE F
try
ãã 
{
åå 	
Result
çç 
<
çç 
(
çç &
SodiumSecureMemoryHandle
çç ,
,
çç, -
byte
çç. 2
[
çç2 3
]
çç3 4
)
çç4 5
,
çç5 6%
EcliptixProtocolFailure
çç7 N
>
ççN O
initialKeysResult
ççP a
=
ççb c
SodiumInterop
éé 
.
éé #
GenerateX25519KeyPair
éé 3
(
éé3 4-
EcliptixProtocolFailureMessages
éé4 S
.
ééS T,
INITIAL_SENDING_DH_KEY_PURPOSE
ééT r
)
éér s
;
éés t
if
èè 
(
èè 
initialKeysResult
èè !
.
èè! "
IsErr
èè" '
)
èè' (
{
êê 
return
ëë 
Result
ëë 
<
ëë (
EcliptixProtocolConnection
ëë 8
,
ëë8 9%
EcliptixProtocolFailure
ëë: Q
>
ëëQ R
.
ëëR S
Err
ëëS V
(
ëëV W
initialKeysResult
ëëW h
.
ëëh i
	UnwrapErr
ëëi r
(
ëër s
)
ëës t
)
ëët u
;
ëëu v
}
íí 
(
îî .
 initialSendingDhPrivateKeyHandle
îî -
,
îî- .
byte
îî/ 3
[
îî3 4
]
îî4 5'
initialSendingDhPublicKey
îî6 O
)
îîO P
=
îîQ R
initialKeysResult
îîS d
.
îîd e
Unwrap
îîe k
(
îîk l
)
îîl m
;
îîm n
Result
ññ 
<
ññ 
byte
ññ 
[
ññ 
]
ññ 
,
ññ 
SodiumFailure
ññ (
>
ññ( )
readBytesResult
ññ* 9
=
ññ: ;.
 initialSendingDhPrivateKeyHandle
óó 0
.
óó0 1
	ReadBytes
óó1 :
(
óó: ;
	Constants
óó; D
.
óóD E&
X_25519_PRIVATE_KEY_SIZE
óóE ]
)
óó] ^
;
óó^ _
if
òò 
(
òò 
readBytesResult
òò 
.
òò  
IsErr
òò  %
)
òò% &
{
ôô .
 initialSendingDhPrivateKeyHandle
öö 0
.
öö0 1
Dispose
öö1 8
(
öö8 9
)
öö9 :
;
öö: ;
return
õõ 
Result
õõ 
<
õõ (
EcliptixProtocolConnection
õõ 8
,
õõ8 9%
EcliptixProtocolFailure
õõ: Q
>
õõQ R
.
õõR S
Err
õõS V
(
õõV W
readBytesResult
úú #
.
úú# $
	UnwrapErr
úú$ -
(
úú- .
)
úú. /
.
úú/ 0'
ToEcliptixProtocolFailure
úú0 I
(
úúI J
)
úúJ K
)
úúK L
;
úúL M
}
ùù -
initialSendingDhPrivateKeyBytes
üü +
=
üü, -
readBytesResult
üü. =
.
üü= >
Unwrap
üü> D
(
üüD E
)
üüE F
;
üüF G
Result
°° 
<
°° 
(
°° &
SodiumSecureMemoryHandle
°° ,
,
°°, -
byte
°°. 2
[
°°2 3
]
°°3 4
)
°°4 5
,
°°5 6%
EcliptixProtocolFailure
°°7 N
>
°°N O"
persistentKeysResult
°°P d
=
°°e f
SodiumInterop
¢¢ 
.
¢¢ #
GenerateX25519KeyPair
¢¢ 3
(
¢¢3 4-
EcliptixProtocolFailureMessages
¢¢4 S
.
¢¢S T'
PERSISTENT_DH_KEY_PURPOSE
¢¢T m
)
¢¢m n
;
¢¢n o
if
££ 
(
££ "
persistentKeysResult
££ $
.
££$ %
IsErr
££% *
)
££* +
{
§§ .
 initialSendingDhPrivateKeyHandle
•• 0
.
••0 1
Dispose
••1 8
(
••8 9
)
••9 :
;
••: ;
WipeIfNotNull
¶¶ 
(
¶¶ -
initialSendingDhPrivateKeyBytes
¶¶ =
)
¶¶= >
;
¶¶> ?
return
ßß 
Result
ßß 
<
ßß (
EcliptixProtocolConnection
ßß 8
,
ßß8 9%
EcliptixProtocolFailure
ßß: Q
>
ßßQ R
.
ßßR S
Err
ßßS V
(
ßßV W"
persistentKeysResult
ßßW k
.
®® 
	UnwrapErr
®® 
(
®® 
)
®®  
)
®®  !
;
®®! "
}
©© 
(
´´ *
persistentDhPrivateKeyHandle
´´ )
,
´´) *
byte
´´+ /
[
´´/ 0
]
´´0 1#
persistentDhPublicKey
´´2 G
)
´´G H
=
´´I J"
persistentKeysResult
´´K _
.
´´_ `
Unwrap
´´` f
(
´´f g
)
´´g h
;
´´h i
byte
≠≠ 
[
≠≠ 
]
≠≠ 
tempChainKey
≠≠ 
=
≠≠  !
new
≠≠" %
byte
≠≠& *
[
≠≠* +
	Constants
≠≠+ 4
.
≠≠4 5
X_25519_KEY_SIZE
≠≠5 E
]
≠≠E F
;
≠≠F G
Result
ÆÆ 
<
ÆÆ '
EcliptixProtocolChainStep
ÆÆ ,
,
ÆÆ, -%
EcliptixProtocolFailure
ÆÆ. E
>
ÆÆE F

stepResult
ÆÆG Q
=
ÆÆR S'
EcliptixProtocolChainStep
ØØ )
.
ØØ) *
Create
ØØ* 0
(
ØØ0 1
ChainStepType
ØØ1 >
.
ØØ> ?
Sender
ØØ? E
,
ØØE F
tempChainKey
ØØG S
,
ØØS T-
initialSendingDhPrivateKeyBytes
∞∞ 3
,
∞∞3 4'
initialSendingDhPublicKey
∞∞5 N
)
∞∞N O
;
∞∞O P
WipeIfNotNull
±± 
(
±± 
tempChainKey
±± &
)
±±& '
;
±±' (
WipeIfNotNull
≤≤ 
(
≤≤ -
initialSendingDhPrivateKeyBytes
≤≤ 9
)
≤≤9 :
;
≤≤: ;-
initialSendingDhPrivateKeyBytes
≥≥ +
=
≥≥, -
null
≥≥. 2
;
≥≥2 3
if
µµ 
(
µµ 

stepResult
µµ 
.
µµ 
IsErr
µµ  
)
µµ  !
{
∂∂ .
 initialSendingDhPrivateKeyHandle
∑∑ 0
.
∑∑0 1
Dispose
∑∑1 8
(
∑∑8 9
)
∑∑9 :
;
∑∑: ;*
persistentDhPrivateKeyHandle
∏∏ ,
.
∏∏, -
Dispose
∏∏- 4
(
∏∏4 5
)
∏∏5 6
;
∏∏6 7
return
ππ 
Result
ππ 
<
ππ (
EcliptixProtocolConnection
ππ 8
,
ππ8 9%
EcliptixProtocolFailure
ππ: Q
>
ππQ R
.
ππR S
Err
ππS V
(
ππV W

stepResult
ππW a
.
ππa b
	UnwrapErr
ππb k
(
ππk l
)
ππl m
)
ππm n
;
ππn o
}
∫∫ 
sendingStep
ºº 
=
ºº 

stepResult
ºº $
.
ºº$ %
Unwrap
ºº% +
(
ºº+ ,
)
ºº, -
;
ºº- .(
EcliptixProtocolConnection
ΩΩ &

connection
ΩΩ' 1
=
ΩΩ2 3
new
ΩΩ4 7
(
ΩΩ7 8
	connectId
ΩΩ8 A
,
ΩΩA B
isInitiator
ΩΩC N
,
ΩΩN O.
 initialSendingDhPrivateKeyHandle
ææ 0
,
ææ0 1
sendingStep
ææ2 =
,
ææ= >*
persistentDhPrivateKeyHandle
ææ? [
,
ææ[ \#
persistentDhPublicKey
øø %
,
øø% &
ratchetConfig
øø' 4
,
øø4 5
exchangeType
øø6 B
)
øøB C
;
øøC D.
 initialSendingDhPrivateKeyHandle
¿¿ ,
=
¿¿- .
null
¿¿/ 3
;
¿¿3 4*
persistentDhPrivateKeyHandle
¡¡ (
=
¡¡) *
null
¡¡+ /
;
¡¡/ 0
sendingStep
¬¬ 
=
¬¬ 
null
¬¬ 
;
¬¬ 
return
√√ 
Result
√√ 
<
√√ (
EcliptixProtocolConnection
√√ 4
,
√√4 5%
EcliptixProtocolFailure
√√6 M
>
√√M N
.
√√N O
Ok
√√O Q
(
√√Q R

connection
√√R \
)
√√\ ]
;
√√] ^
}
ƒƒ 	
catch
≈≈ 
(
≈≈ 
	Exception
≈≈ 
ex
≈≈ 
)
≈≈ 
{
∆∆ 	.
 initialSendingDhPrivateKeyHandle
«« ,
?
««, -
.
««- .
Dispose
««. 5
(
««5 6
)
««6 7
;
««7 8
sendingStep
»» 
?
»» 
.
»» 
Dispose
»»  
(
»»  !
)
»»! "
;
»»" #*
persistentDhPrivateKeyHandle
…… (
?
……( )
.
……) *
Dispose
……* 1
(
……1 2
)
……2 3
;
……3 4
WipeIfNotNull
   
(
   -
initialSendingDhPrivateKeyBytes
   9
)
  9 :
;
  : ;
return
ÀÀ 
Result
ÀÀ 
<
ÀÀ (
EcliptixProtocolConnection
ÀÀ 4
,
ÀÀ4 5%
EcliptixProtocolFailure
ÀÀ6 M
>
ÀÀM N
.
ÀÀN O
Err
ÀÀO R
(
ÀÀR S%
EcliptixProtocolFailure
ÃÃ '
.
ÃÃ' (
Generic
ÃÃ( /
(
ÃÃ/ 0
string
ÕÕ 
.
ÕÕ 
Format
ÕÕ !
(
ÕÕ! "-
EcliptixProtocolFailureMessages
ÕÕ" A
.
ÕÕA B/
!UNEXPECTED_ERROR_CREATING_SESSION
ÕÕB c
,
ÕÕc d
	connectId
ÕÕe n
)
ÕÕn o
,
ÕÕo p
ex
ÕÕq s
)
ÕÕs t
)
ÕÕt u
;
ÕÕu v
}
ŒŒ 	
}
œœ 
public
—— 

Result
—— 
<
—— 
RatchetState
—— 
,
—— %
EcliptixProtocolFailure
——  7
>
——7 8
ToProtoState
——9 E
(
——E F
)
——F G
{
““ 
lock
”” 
(
”” 
_lock
”” 
)
”” 
{
‘‘ 	
if
’’ 
(
’’ 
	_disposed
’’ 
)
’’ 
{
÷÷ 
return
◊◊ 
Result
◊◊ 
<
◊◊ 
RatchetState
◊◊ *
,
◊◊* +%
EcliptixProtocolFailure
◊◊, C
>
◊◊C D
.
◊◊D E
Err
◊◊E H
(
◊◊H I%
EcliptixProtocolFailure
ÿÿ +
.
ÿÿ+ ,
OBJECT_DISPOSED
ÿÿ, ;
(
ÿÿ; <
nameof
ÿÿ< B
(
ÿÿB C(
EcliptixProtocolConnection
ÿÿC ]
)
ÿÿ] ^
)
ÿÿ^ _
)
ÿÿ_ `
;
ÿÿ` a
}
ŸŸ 
if
€€ 
(
€€ 
_exchangeType
€€ 
==
€€   
PubKeyExchangeType
€€! 3
.
€€3 4
ServerStreaming
€€4 C
)
€€C D
{
‹‹ 
return
›› 
Result
›› 
<
›› 
RatchetState
›› *
,
››* +%
EcliptixProtocolFailure
››, C
>
››C D
.
››D E
Err
››E H
(
››H I%
EcliptixProtocolFailure
ﬁﬁ +
.
ﬁﬁ+ ,
Generic
ﬁﬁ, 3
(
ﬁﬁ3 4-
EcliptixProtocolFailureMessages
ﬁﬁ4 S
.
ﬁﬁS T,
SERVER_STREAMING_NOT_PERSISTED
ﬁﬁT r
)
ﬁﬁr s
)
ﬁﬁs t
;
ﬁﬁt u
}
ﬂﬂ 
try
·· 
{
‚‚ 
Result
„„ 
<
„„ 
ChainStepState
„„ %
,
„„% &%
EcliptixProtocolFailure
„„' >
>
„„> ?$
sendingStepStateResult
„„@ V
=
„„W X
_sendingStep
„„Y e
.
„„e f
ToProtoState
„„f r
(
„„r s
)
„„s t
;
„„t u
if
‰‰ 
(
‰‰ $
sendingStepStateResult
‰‰ *
.
‰‰* +
IsErr
‰‰+ 0
)
‰‰0 1
{
ÂÂ 
return
ÊÊ 
Result
ÊÊ !
<
ÊÊ! "
RatchetState
ÊÊ" .
,
ÊÊ. /%
EcliptixProtocolFailure
ÊÊ0 G
>
ÊÊG H
.
ÊÊH I
Err
ÊÊI L
(
ÊÊL M$
sendingStepStateResult
ÊÊM c
.
ÊÊc d
	UnwrapErr
ÊÊd m
(
ÊÊm n
)
ÊÊn o
)
ÊÊo p
;
ÊÊp q
}
ÁÁ 
Result
ÈÈ 
<
ÈÈ 
byte
ÈÈ 
[
ÈÈ 
]
ÈÈ 
,
ÈÈ 
SodiumFailure
ÈÈ ,
>
ÈÈ, -
rootKeyReadResult
ÈÈ. ?
=
ÈÈ@ A
_rootKeyHandle
ÍÍ "
!
ÍÍ" #
.
ÍÍ# $
	ReadBytes
ÍÍ$ -
(
ÍÍ- .
	Constants
ÍÍ. 7
.
ÍÍ7 8
X_25519_KEY_SIZE
ÍÍ8 H
)
ÍÍH I
;
ÍÍI J
if
ÎÎ 
(
ÎÎ 
rootKeyReadResult
ÎÎ %
.
ÎÎ% &
IsErr
ÎÎ& +
)
ÎÎ+ ,
{
ÏÏ 
return
ÌÌ 
Result
ÌÌ !
<
ÌÌ! "
RatchetState
ÌÌ" .
,
ÌÌ. /%
EcliptixProtocolFailure
ÌÌ0 G
>
ÌÌG H
.
ÌÌH I
Err
ÌÌI L
(
ÌÌL M
rootKeyReadResult
ÓÓ )
.
ÓÓ) *
	UnwrapErr
ÓÓ* 3
(
ÓÓ3 4
)
ÓÓ4 5
.
ÓÓ5 6'
ToEcliptixProtocolFailure
ÓÓ6 O
(
ÓÓO P
)
ÓÓP Q
)
ÓÓQ R
;
ÓÓR S
}
ÔÔ 
byte
ÒÒ 
[
ÒÒ 
]
ÒÒ 
rootKeyBytes
ÒÒ #
=
ÒÒ$ %
rootKeyReadResult
ÒÒ& 7
.
ÒÒ7 8
Unwrap
ÒÒ8 >
(
ÒÒ> ?
)
ÒÒ? @
;
ÒÒ@ A
RatchetState
ÛÛ 
proto
ÛÛ "
=
ÛÛ# $
new
ÛÛ% (
(
ÛÛ( )
)
ÛÛ) *
{
ÙÙ 
IsInitiator
ıı 
=
ıı  !
_isInitiator
ıı" .
,
ıı. /
	CreatedAt
ˆˆ 
=
ˆˆ 
	Timestamp
ˆˆ  )
.
ˆˆ) * 
FromDateTimeOffset
ˆˆ* <
(
ˆˆ< =

_createdAt
ˆˆ= G
)
ˆˆG H
,
ˆˆH I
NonceCounter
˜˜  
=
˜˜! "
(
˜˜# $
ulong
˜˜$ )
)
˜˜) *
_nonceCounter
˜˜* 7
,
˜˜7 8

PeerBundle
¯¯ 
=
¯¯  
_peerBundle
¯¯! ,
!
¯¯, -
.
¯¯- . 
ToProtobufExchange
¯¯. @
(
¯¯@ A
)
¯¯A B
,
¯¯B C
PeerDhPublicKey
˘˘ #
=
˘˘$ %

ByteString
˘˘& 0
.
˘˘0 1
CopyFrom
˘˘1 9
(
˘˘9 :
_peerDhPublicKey
˘˘: J
??
˘˘K M
[
˘˘N O
]
˘˘O P
)
˘˘P Q
,
˘˘Q R%
IsFirstReceivingRatchet
˙˙ +
=
˙˙, -&
_isFirstReceivingRatchet
˙˙. F
,
˙˙F G
RootKey
˚˚ 
=
˚˚ 

ByteString
˚˚ (
.
˚˚( )
CopyFrom
˚˚) 1
(
˚˚1 2
rootKeyBytes
˚˚2 >
)
˚˚> ?
,
˚˚? @
SendingStep
¸¸ 
=
¸¸  !$
sendingStepStateResult
¸¸" 8
.
¸¸8 9
Unwrap
¸¸9 ?
(
¸¸? @
)
¸¸@ A
}
˝˝ 
;
˝˝ 
if
ˇˇ 
(
ˇˇ 
_receivingStep
ˇˇ "
==
ˇˇ# %
null
ˇˇ& *
)
ˇˇ* +
{
ÄÄ 
return
ÅÅ 
Result
ÅÅ !
<
ÅÅ! "
RatchetState
ÅÅ" .
,
ÅÅ. /%
EcliptixProtocolFailure
ÅÅ0 G
>
ÅÅG H
.
ÅÅH I
Ok
ÅÅI K
(
ÅÅK L
proto
ÅÅL Q
)
ÅÅQ R
;
ÅÅR S
}
ÇÇ 
Result
ÑÑ 
<
ÑÑ 
ChainStepState
ÑÑ %
,
ÑÑ% &%
EcliptixProtocolFailure
ÑÑ' >
>
ÑÑ> ?&
receivingStepStateResult
ÑÑ@ X
=
ÑÑY Z
_receivingStep
ÖÖ "
.
ÖÖ" #
ToProtoState
ÖÖ# /
(
ÖÖ/ 0
)
ÖÖ0 1
;
ÖÖ1 2
if
ÜÜ 
(
ÜÜ &
receivingStepStateResult
ÜÜ ,
.
ÜÜ, -
IsErr
ÜÜ- 2
)
ÜÜ2 3
{
áá 
return
àà 
Result
àà !
<
àà! "
RatchetState
àà" .
,
àà. /%
EcliptixProtocolFailure
àà0 G
>
ààG H
.
ààH I
Err
ààI L
(
ààL M&
receivingStepStateResult
ààM e
.
ààe f
	UnwrapErr
ààf o
(
àào p
)
ààp q
)
ààq r
;
ààr s
}
ââ 
proto
ãã 
.
ãã 
ReceivingStep
ãã #
=
ãã$ %&
receivingStepStateResult
ãã& >
.
ãã> ?
Unwrap
ãã? E
(
ããE F
)
ããF G
;
ããG H
return
çç 
Result
çç 
<
çç 
RatchetState
çç *
,
çç* +%
EcliptixProtocolFailure
çç, C
>
ççC D
.
ççD E
Ok
ççE G
(
ççG H
proto
ççH M
)
ççM N
;
ççN O
}
éé 
catch
èè 
(
èè 
	Exception
èè 
ex
èè 
)
èè  
{
êê 
return
ëë 
Result
ëë 
<
ëë 
RatchetState
ëë *
,
ëë* +%
EcliptixProtocolFailure
ëë, C
>
ëëC D
.
ëëD E
Err
ëëE H
(
ëëH I%
EcliptixProtocolFailure
íí +
.
íí+ ,
Generic
íí, 3
(
íí3 4-
EcliptixProtocolFailureMessages
íí4 S
.
ííS T*
FAILED_TO_EXPORT_PROTO_STATE
ííT p
,
ííp q
ex
íír t
)
íít u
)
ííu v
;
íív w
}
ìì 
}
îî 	
}
ïï 
public
óó 

static
óó 
Result
óó 
<
óó (
EcliptixProtocolConnection
óó 3
,
óó3 4%
EcliptixProtocolFailure
óó5 L
>
óóL M
FromProtoState
óóN \
(
óó\ ]
uint
óó] a
	connectId
óób k
,
óók l
RatchetState
òò 
proto
òò 
,
òò 
RatchetConfig
òò )
ratchetConfig
òò* 7
,
òò7 8 
PubKeyExchangeType
òò9 K
exchangeType
òòL X
)
òòX Y
{
ôô '
EcliptixProtocolChainStep
öö !
?
öö! "
sendingStep
öö# .
=
öö/ 0
null
öö1 5
;
öö5 6'
EcliptixProtocolChainStep
õõ !
?
õõ! "
receivingStep
õõ# 0
=
õõ1 2
null
õõ3 7
;
õõ7 8&
SodiumSecureMemoryHandle
úú  
?
úú  !
rootKeyHandle
úú" /
=
úú0 1
null
úú2 6
;
úú6 7
try
ûû 
{
üü 	
Result
†† 
<
†† '
EcliptixProtocolChainStep
†† ,
,
††, -%
EcliptixProtocolFailure
††. E
>
††E F
sendingStepResult
††G X
=
††Y Z'
EcliptixProtocolChainStep
°° )
.
°°) *
FromProtoState
°°* 8
(
°°8 9
ChainStepType
°°9 F
.
°°F G
Sender
°°G M
,
°°M N
proto
°°O T
.
°°T U
SendingStep
°°U `
)
°°` a
;
°°a b
if
¢¢ 
(
¢¢ 
sendingStepResult
¢¢ !
.
¢¢! "
IsErr
¢¢" '
)
¢¢' (
{
££ 
return
§§ 
Result
§§ 
<
§§ (
EcliptixProtocolConnection
§§ 8
,
§§8 9%
EcliptixProtocolFailure
§§: Q
>
§§Q R
.
§§R S
Err
§§S V
(
§§V W
sendingStepResult
§§W h
.
§§h i
	UnwrapErr
§§i r
(
§§r s
)
§§s t
)
§§t u
;
§§u v
}
•• 
sendingStep
ßß 
=
ßß 
sendingStepResult
ßß +
.
ßß+ ,
Unwrap
ßß, 2
(
ßß2 3
)
ßß3 4
;
ßß4 5
Result
©© 
<
©© '
EcliptixProtocolChainStep
©© ,
,
©©, -%
EcliptixProtocolFailure
©©. E
>
©©E F!
receivingStepResult
©©G Z
=
©©[ \'
EcliptixProtocolChainStep
™™ )
.
™™) *
FromProtoState
™™* 8
(
™™8 9
ChainStepType
™™9 F
.
™™F G
Receiver
™™G O
,
™™O P
proto
™™Q V
.
™™V W
ReceivingStep
™™W d
)
™™d e
;
™™e f
if
´´ 
(
´´ !
receivingStepResult
´´ #
.
´´# $
IsErr
´´$ )
)
´´) *
{
¨¨ 
return
≠≠ 
Result
≠≠ 
<
≠≠ (
EcliptixProtocolConnection
≠≠ 8
,
≠≠8 9%
EcliptixProtocolFailure
≠≠: Q
>
≠≠Q R
.
≠≠R S
Err
≠≠S V
(
≠≠V W!
receivingStepResult
≠≠W j
.
≠≠j k
	UnwrapErr
≠≠k t
(
≠≠t u
)
≠≠u v
)
≠≠v w
;
≠≠w x
}
ÆÆ 
receivingStep
∞∞ 
=
∞∞ !
receivingStepResult
∞∞ /
.
∞∞/ 0
Unwrap
∞∞0 6
(
∞∞6 7
)
∞∞7 8
;
∞∞8 9
Result
≤≤ 
<
≤≤ &
SodiumSecureMemoryHandle
≤≤ +
,
≤≤+ ,
SodiumFailure
≤≤- :
>
≤≤: ; 
rootKeyAllocResult
≤≤< N
=
≤≤O P&
SodiumSecureMemoryHandle
≥≥ (
.
≥≥( )
Allocate
≥≥) 1
(
≥≥1 2
proto
≥≥2 7
.
≥≥7 8
RootKey
≥≥8 ?
.
≥≥? @
Length
≥≥@ F
)
≥≥F G
;
≥≥G H
if
¥¥ 
(
¥¥  
rootKeyAllocResult
¥¥ "
.
¥¥" #
IsErr
¥¥# (
)
¥¥( )
{
µµ 
return
∂∂ 
Result
∂∂ 
<
∂∂ (
EcliptixProtocolConnection
∂∂ 8
,
∂∂8 9%
EcliptixProtocolFailure
∂∂: Q
>
∂∂Q R
.
∂∂R S
Err
∂∂S V
(
∂∂V W 
rootKeyAllocResult
∑∑ &
.
∑∑& '
	UnwrapErr
∑∑' 0
(
∑∑0 1
)
∑∑1 2
.
∑∑2 3'
ToEcliptixProtocolFailure
∑∑3 L
(
∑∑L M
)
∑∑M N
)
∑∑N O
;
∑∑O P
}
∏∏ 
rootKeyHandle
∫∫ 
=
∫∫  
rootKeyAllocResult
∫∫ .
.
∫∫. /
Unwrap
∫∫/ 5
(
∫∫5 6
)
∫∫6 7
;
∫∫7 8
Result
ºº 
<
ºº 
Unit
ºº 
,
ºº 
SodiumFailure
ºº &
>
ºº& '

copyResult
ºº( 2
=
ºº3 4%
SecureByteStringInterop
ΩΩ '
.
ΩΩ' (.
 CopyFromByteStringToSecureMemory
ΩΩ( H
(
ΩΩH I
proto
ΩΩI N
.
ΩΩN O
RootKey
ΩΩO V
,
ΩΩV W
rootKeyHandle
ΩΩX e
)
ΩΩe f
;
ΩΩf g
if
ææ 
(
ææ 

copyResult
ææ 
.
ææ 
IsErr
ææ  
)
ææ  !
{
øø 
rootKeyHandle
¿¿ 
.
¿¿ 
Dispose
¿¿ %
(
¿¿% &
)
¿¿& '
;
¿¿' (
return
¡¡ 
Result
¡¡ 
<
¡¡ (
EcliptixProtocolConnection
¡¡ 8
,
¡¡8 9%
EcliptixProtocolFailure
¡¡: Q
>
¡¡Q R
.
¡¡R S
Err
¡¡S V
(
¡¡V W

copyResult
¬¬ 
.
¬¬ 
	UnwrapErr
¬¬ (
(
¬¬( )
)
¬¬) *
.
¬¬* +'
ToEcliptixProtocolFailure
¬¬+ D
(
¬¬D E
)
¬¬E F
)
¬¬F G
;
¬¬G H
}
√√ (
EcliptixProtocolConnection
≈≈ &

connection
≈≈' 1
=
≈≈2 3
new
≈≈4 7
(
≈≈7 8
	connectId
≈≈8 A
,
≈≈A B
proto
≈≈C H
,
≈≈H I
sendingStep
≈≈J U
,
≈≈U V
receivingStep
≈≈W d
,
≈≈d e
rootKeyHandle
≈≈f s
,
≈≈s t
ratchetConfig
∆∆ 
,
∆∆ 
exchangeType
∆∆ +
)
∆∆+ ,
;
∆∆, -
sendingStep
»» 
=
»» 
null
»» 
;
»» 
receivingStep
…… 
=
…… 
null
……  
;
……  !
rootKeyHandle
   
=
   
null
    
;
    !
Result
ÃÃ 
<
ÃÃ 
Unit
ÃÃ 
,
ÃÃ %
EcliptixProtocolFailure
ÃÃ 0
>
ÃÃ0 1
metadataKeyResult
ÃÃ2 C
=
ÃÃD E

connection
ÃÃF P
.
ÃÃP Q)
DeriveMetadataEncryptionKey
ÃÃQ l
(
ÃÃl m
)
ÃÃm n
;
ÃÃn o
return
ÕÕ 
metadataKeyResult
ÕÕ $
.
ÕÕ$ %
IsErr
ÕÕ% *
?
ŒŒ 
Result
ŒŒ 
<
ŒŒ (
EcliptixProtocolConnection
ŒŒ 3
,
ŒŒ3 4%
EcliptixProtocolFailure
ŒŒ5 L
>
ŒŒL M
.
ŒŒM N
Err
ŒŒN Q
(
ŒŒQ R
metadataKeyResult
ŒŒR c
.
ŒŒc d
	UnwrapErr
ŒŒd m
(
ŒŒm n
)
ŒŒn o
)
ŒŒo p
:
œœ 
Result
œœ 
<
œœ (
EcliptixProtocolConnection
œœ 3
,
œœ3 4%
EcliptixProtocolFailure
œœ5 L
>
œœL M
.
œœM N
Ok
œœN P
(
œœP Q

connection
œœQ [
)
œœ[ \
;
œœ\ ]
}
–– 	
catch
—— 
(
—— 
	Exception
—— 
ex
—— 
)
—— 
{
““ 	
sendingStep
”” 
?
”” 
.
”” 
Dispose
””  
(
””  !
)
””! "
;
””" #
receivingStep
‘‘ 
?
‘‘ 
.
‘‘ 
Dispose
‘‘ "
(
‘‘" #
)
‘‘# $
;
‘‘$ %
rootKeyHandle
’’ 
?
’’ 
.
’’ 
Dispose
’’ "
(
’’" #
)
’’# $
;
’’$ %
return
÷÷ 
Result
÷÷ 
<
÷÷ (
EcliptixProtocolConnection
÷÷ 4
,
÷÷4 5%
EcliptixProtocolFailure
÷÷6 M
>
÷÷M N
.
÷÷N O
Err
÷÷O R
(
÷÷R S%
EcliptixProtocolFailure
◊◊ '
.
◊◊' (
Generic
◊◊( /
(
◊◊/ 0-
EcliptixProtocolFailureMessages
◊◊0 O
.
◊◊O P2
$FAILED_TO_REHYDRATE_FROM_PROTO_STATE
◊◊P t
,
◊◊t u
ex
ÿÿ 
)
ÿÿ 
)
ÿÿ 
;
ÿÿ 
}
ŸŸ 	
}
⁄⁄ 
public
‹‹ 

Result
‹‹ 
<
‹‹ "
LocalPublicKeyBundle
‹‹ &
,
‹‹& '%
EcliptixProtocolFailure
‹‹( ?
>
‹‹? @
GetPeerBundle
‹‹A N
(
‹‹N O
)
‹‹O P
{
›› 
lock
ﬁﬁ 
(
ﬁﬁ 
_lock
ﬁﬁ 
)
ﬁﬁ 
{
ﬂﬂ 	
Result
‡‡ 
<
‡‡ 
Unit
‡‡ 
,
‡‡ %
EcliptixProtocolFailure
‡‡ 0
>
‡‡0 1
disposedCheck
‡‡2 ?
=
‡‡@ A
CheckDisposed
‡‡B O
(
‡‡O P
)
‡‡P Q
;
‡‡Q R
if
·· 
(
·· 
disposedCheck
·· 
.
·· 
IsErr
·· #
)
··# $
{
‚‚ 
return
„„ 
Result
„„ 
<
„„ "
LocalPublicKeyBundle
„„ 2
,
„„2 3%
EcliptixProtocolFailure
„„4 K
>
„„K L
.
„„L M
Err
„„M P
(
„„P Q
disposedCheck
„„Q ^
.
„„^ _
	UnwrapErr
„„_ h
(
„„h i
)
„„i j
)
„„j k
;
„„k l
}
‰‰ 
if
ÊÊ 
(
ÊÊ 
_peerBundle
ÊÊ 
!=
ÊÊ 
null
ÊÊ #
)
ÊÊ# $
{
ÁÁ 
return
ËË 
Result
ËË 
<
ËË "
LocalPublicKeyBundle
ËË 2
,
ËË2 3%
EcliptixProtocolFailure
ËË4 K
>
ËËK L
.
ËËL M
Ok
ËËM O
(
ËËO P
_peerBundle
ËËP [
)
ËË[ \
;
ËË\ ]
}
ÈÈ 
return
ÎÎ 
Result
ÎÎ 
<
ÎÎ "
LocalPublicKeyBundle
ÎÎ .
,
ÎÎ. /%
EcliptixProtocolFailure
ÎÎ0 G
>
ÎÎG H
.
ÎÎH I
Err
ÎÎI L
(
ÎÎL M%
EcliptixProtocolFailure
ÏÏ '
.
ÏÏ' (
Generic
ÏÏ( /
(
ÏÏ/ 0-
EcliptixProtocolFailureMessages
ÏÏ0 O
.
ÏÏO P!
PEER_BUNDLE_NOT_SET
ÏÏP c
)
ÏÏc d
)
ÏÏd e
;
ÏÏe f
}
ÌÌ 	
}
ÓÓ 
public
 

bool
 
IsInitiator
 
(
 
)
 
{
ÒÒ 
return
ÚÚ 
_isInitiator
ÚÚ 
;
ÚÚ 
}
ÛÛ 
internal
ıı 
Result
ıı 
<
ıı 
Unit
ıı 
,
ıı %
EcliptixProtocolFailure
ıı 1
>
ıı1 2
SetPeerBundle
ıı3 @
(
ıı@ A"
LocalPublicKeyBundle
ııA U

peerBundle
ııV `
)
ıı` a
{
ˆˆ 
lock
˜˜ 
(
˜˜ 
_lock
˜˜ 
)
˜˜ 
{
¯¯ 	
Result
˘˘ 
<
˘˘ 
Unit
˘˘ 
,
˘˘ %
EcliptixProtocolFailure
˘˘ 0
>
˘˘0 1
disposedCheck
˘˘2 ?
=
˘˘@ A
CheckDisposed
˘˘B O
(
˘˘O P
)
˘˘P Q
;
˘˘Q R
if
˙˙ 
(
˙˙ 
disposedCheck
˙˙ 
.
˙˙ 
IsErr
˙˙ #
)
˙˙# $
{
˚˚ 
return
¸¸ 
disposedCheck
¸¸ $
;
¸¸$ %
}
˝˝ 
_peerBundle
ˇˇ 
=
ˇˇ 

peerBundle
ˇˇ $
;
ˇˇ$ %
return
ÄÄ 
Result
ÄÄ 
<
ÄÄ 
Unit
ÄÄ 
,
ÄÄ %
EcliptixProtocolFailure
ÄÄ  7
>
ÄÄ7 8
.
ÄÄ8 9
Ok
ÄÄ9 ;
(
ÄÄ; <
Unit
ÄÄ< @
.
ÄÄ@ A
Value
ÄÄA F
)
ÄÄF G
;
ÄÄG H
}
ÅÅ 	
}
ÇÇ 
internal
ÑÑ 
Result
ÑÑ 
<
ÑÑ 
Unit
ÑÑ 
,
ÑÑ %
EcliptixProtocolFailure
ÑÑ 1
>
ÑÑ1 2$
FinalizeChainAndDhKeys
ÑÑ3 I
(
ÑÑI J
byte
ÑÑJ N
[
ÑÑN O
]
ÑÑO P
initialRootKey
ÑÑQ _
,
ÑÑ_ `
byte
ÖÖ 
[
ÖÖ 
]
ÖÖ $
initialPeerDhPublicKey
ÖÖ %
)
ÖÖ% &
{
ÜÜ 
lock
áá 
(
áá 
_lock
áá 
)
áá 
{
àà 	
byte
ââ 
[
ââ 
]
ââ 
?
ââ $
persistentPrivKeyBytes
ââ *
=
ââ+ ,
null
ââ- 1
;
ââ1 2
byte
ää 
[
ää 
]
ää 
?
ää 
peerDhPublicCopy
ää $
=
ää% &
null
ää' +
;
ää+ ,
byte
ãã 
[
ãã 
]
ãã 
?
ãã 
senderChainKey
ãã "
=
ãã# $
null
ãã% )
;
ãã) *
byte
åå 
[
åå 
]
åå 
?
åå 
receiverChainKey
åå $
=
åå% &
null
åå' +
;
åå+ ,
try
éé 
{
èè 
Result
êê 
<
êê 
Unit
êê 
,
êê %
EcliptixProtocolFailure
êê 4
>
êê4 5
disposedCheck
êê6 C
=
êêD E
CheckDisposed
êêF S
(
êêS T
)
êêT U
;
êêU V
if
ëë 
(
ëë 
disposedCheck
ëë !
.
ëë! "
IsErr
ëë" '
)
ëë' (
{
íí 
return
ìì 
disposedCheck
ìì (
;
ìì( )
}
îî 
Result
ññ 
<
ññ 
Unit
ññ 
,
ññ %
EcliptixProtocolFailure
ññ 4
>
ññ4 5
finalizedCheck
ññ6 D
=
ññE F!
CheckIfNotFinalized
ññG Z
(
ññZ [
)
ññ[ \
;
ññ\ ]
if
óó 
(
óó 
finalizedCheck
óó "
.
óó" #
IsErr
óó# (
)
óó( )
{
òò 
return
ôô 
finalizedCheck
ôô )
;
ôô) *
}
öö 
Result
úú 
<
úú 
Unit
úú 
,
úú %
EcliptixProtocolFailure
úú 4
>
úú4 5
keyValidation
úú6 C
=
úúD E!
ValidateInitialKeys
ùù '
(
ùù' (
initialRootKey
ùù( 6
,
ùù6 7$
initialPeerDhPublicKey
ùù8 N
)
ùùN O
;
ùùO P
if
ûû 
(
ûû 
keyValidation
ûû !
.
ûû! "
IsErr
ûû" '
)
ûû' (
{
üü 
return
†† 
keyValidation
†† (
;
††( )
}
°° 
peerDhPublicCopy
££  
=
££! "
(
££# $
byte
££$ (
[
££( )
]
££) *
)
££* +$
initialPeerDhPublicKey
££+ A
.
££A B
Clone
££B G
(
££G H
)
££H I
;
££I J
Result
§§ 
<
§§ &
SodiumSecureMemoryHandle
§§ /
,
§§/ 0
SodiumFailure
§§1 >
>
§§> ?
allocResult
§§@ K
=
§§L M&
SodiumSecureMemoryHandle
•• ,
.
••, -
Allocate
••- 5
(
••5 6
	Constants
••6 ?
.
••? @
X_25519_KEY_SIZE
••@ P
)
••P Q
;
••Q R
if
¶¶ 
(
¶¶ 
allocResult
¶¶ 
.
¶¶  
IsErr
¶¶  %
)
¶¶% &
{
ßß 
WipeIfNotNull
®® !
(
®®! "
peerDhPublicCopy
®®" 2
)
®®2 3
;
®®3 4
return
©© 
Result
©© !
<
©©! "
Unit
©©" &
,
©©& '%
EcliptixProtocolFailure
©©( ?
>
©©? @
.
©©@ A
Err
©©A D
(
©©D E
allocResult
™™ #
.
™™# $
	UnwrapErr
™™$ -
(
™™- .
)
™™. /
.
™™/ 0'
ToEcliptixProtocolFailure
™™0 I
(
™™I J
)
™™J K
)
™™K L
;
™™L M
}
´´ 
Result
≠≠ 
<
≠≠ 
byte
≠≠ 
[
≠≠ 
]
≠≠ 
,
≠≠ 
SodiumFailure
≠≠ ,
>
≠≠, -"
initialKeyReadResult
≠≠. B
=
≠≠C D/
!_initialSendingDhPrivateKeyHandle
ÆÆ 5
!
ÆÆ5 6
.
ÆÆ6 7
	ReadBytes
ÆÆ7 @
(
ÆÆ@ A
	Constants
ÆÆA J
.
ÆÆJ K&
X_25519_PRIVATE_KEY_SIZE
ÆÆK c
)
ÆÆc d
;
ÆÆd e
if
ØØ 
(
ØØ "
initialKeyReadResult
ØØ (
.
ØØ( )
IsErr
ØØ) .
)
ØØ. /
{
∞∞ 
WipeIfNotNull
±± !
(
±±! "
peerDhPublicCopy
±±" 2
)
±±2 3
;
±±3 4
return
≤≤ 
Result
≤≤ !
<
≤≤! "
Unit
≤≤" &
,
≤≤& '%
EcliptixProtocolFailure
≤≤( ?
>
≤≤? @
.
≤≤@ A
Err
≤≤A D
(
≤≤D E"
initialKeyReadResult
≥≥ ,
.
≥≥, -
	UnwrapErr
≥≥- 6
(
≥≥6 7
)
≥≥7 8
.
≥≥8 9'
ToEcliptixProtocolFailure
≥≥9 R
(
≥≥R S
)
≥≥S T
)
≥≥T U
;
≥≥U V
}
¥¥ $
persistentPrivKeyBytes
∂∂ &
=
∂∂' ("
initialKeyReadResult
∂∂) =
.
∂∂= >
Unwrap
∂∂> D
(
∂∂D E
)
∂∂E F
;
∂∂F G
byte
∑∑ 
[
∑∑ 
]
∑∑ 
?
∑∑ 
dhSecret
∑∑  
=
∑∑! "
null
∑∑# '
;
∑∑' (
byte
∏∏ 
[
∏∏ 
]
∏∏ 
?
∏∏ 

newRootKey
∏∏ "
=
∏∏# $
null
∏∏% )
;
∏∏) *
try
∫∫ 
{
ªª 
dhSecret
ºº 
=
ºº 

ScalarMult
ºº )
.
ºº) *
Mult
ºº* .
(
ºº. /$
persistentPrivKeyBytes
ºº/ E
,
ººE F
peerDhPublicCopy
ººG W
)
ººW X
;
ººX Y
}
ΩΩ 
catch
ææ 
(
ææ 
	Exception
ææ  
ex
ææ! #
)
ææ# $
{
øø 
WipeIfNotNull
¿¿ !
(
¿¿! "
peerDhPublicCopy
¿¿" 2
)
¿¿2 3
;
¿¿3 4
WipeIfNotNull
¡¡ !
(
¡¡! "
dhSecret
¡¡" *
)
¡¡* +
;
¡¡+ ,
return
¬¬ 
Result
¬¬ !
<
¬¬! "
Unit
¬¬" &
,
¬¬& '%
EcliptixProtocolFailure
¬¬( ?
>
¬¬? @
.
¬¬@ A
Err
¬¬A D
(
¬¬D E%
EcliptixProtocolFailure
√√ /
.
√√/ 0
	DeriveKey
√√0 9
(
√√9 :
$str
ƒƒ Z
,
ƒƒZ [
ex
ƒƒ\ ^
)
ƒƒ^ _
)
ƒƒ_ `
;
ƒƒ` a
}
≈≈ &
SodiumSecureMemoryHandle
«« (
?
««( )
tempRootHandle
««* 8
=
««9 :
allocResult
««; F
.
««F G
Unwrap
««G M
(
««M N
)
««N O
;
««O P
try
…… 
{
   
using
ÀÀ 
SecurePooledArray
ÀÀ +
<
ÀÀ+ ,
byte
ÀÀ, 0
>
ÀÀ0 1
hkdfOutputBuffer
ÀÀ2 B
=
ÀÀC D
SecureArrayPool
ÃÃ '
.
ÃÃ' (
Rent
ÃÃ( ,
<
ÃÃ, -
byte
ÃÃ- 1
>
ÃÃ1 2
(
ÃÃ2 3
	Constants
ÃÃ3 <
.
ÃÃ< =
X_25519_KEY_SIZE
ÃÃ= M
*
ÃÃN O%
ProtocolSystemConstants
ÕÕ3 J
.
ÕÕJ K
Protocol
ÕÕK S
.
ÕÕS T+
HKDF_OUTPUT_BUFFER_MULTIPLIER
ÕÕT q
)
ÕÕq r
;
ÕÕr s
Span
ŒŒ 
<
ŒŒ 
byte
ŒŒ 
>
ŒŒ 
hkdfOutputSpan
ŒŒ -
=
ŒŒ. /
hkdfOutputBuffer
ŒŒ0 @
.
ŒŒ@ A
AsSpan
ŒŒA G
(
ŒŒG H
)
ŒŒH I
;
ŒŒI J
HKDF
œœ 
.
œœ 
	DeriveKey
œœ "
(
œœ" #
HashAlgorithmName
–– )
.
––) *
SHA256
––* 0
,
––0 1
ikm
—— 
:
—— 
dhSecret
—— %
!
——% &
,
——& '
output
““ 
:
““ 
hkdfOutputSpan
““  .
,
““. /
salt
”” 
:
”” 
initialRootKey
”” ,
,
””, -
info
‘‘ 
:
‘‘ 
DhRatchetInfo
‘‘ +
)
’’ 
;
’’ 

newRootKey
◊◊ 
=
◊◊  
hkdfOutputSpan
◊◊! /
[
◊◊/ 0
..
◊◊0 2
	Constants
◊◊2 ;
.
◊◊; <
X_25519_KEY_SIZE
◊◊< L
]
◊◊L M
.
◊◊M N
ToArray
◊◊N U
(
◊◊U V
)
◊◊V W
;
◊◊W X
Result
ÿÿ 
<
ÿÿ 
Unit
ÿÿ 
,
ÿÿ  
SodiumFailure
ÿÿ! .
>
ÿÿ. /
writeResult
ÿÿ0 ;
=
ÿÿ< =
tempRootHandle
ÿÿ> L
.
ÿÿL M
Write
ÿÿM R
(
ÿÿR S

newRootKey
ÿÿS ]
)
ÿÿ] ^
;
ÿÿ^ _
if
ŸŸ 
(
ŸŸ 
writeResult
ŸŸ #
.
ŸŸ# $
IsErr
ŸŸ$ )
)
ŸŸ) *
{
⁄⁄ 
tempRootHandle
€€ &
.
€€& '
Dispose
€€' .
(
€€. /
)
€€/ 0
;
€€0 1
WipeIfNotNull
‹‹ %
(
‹‹% &
peerDhPublicCopy
‹‹& 6
)
‹‹6 7
;
‹‹7 8
WipeIfNotNull
›› %
(
››% &
dhSecret
››& .
)
››. /
;
››/ 0
WipeIfNotNull
ﬁﬁ %
(
ﬁﬁ% &

newRootKey
ﬁﬁ& 0
)
ﬁﬁ0 1
;
ﬁﬁ1 2
return
ﬂﬂ 
Result
ﬂﬂ %
<
ﬂﬂ% &
Unit
ﬂﬂ& *
,
ﬂﬂ* +%
EcliptixProtocolFailure
ﬂﬂ, C
>
ﬂﬂC D
.
ﬂﬂD E
Err
ﬂﬂE H
(
ﬂﬂH I
writeResult
‡‡ '
.
‡‡' (
	UnwrapErr
‡‡( 1
(
‡‡1 2
)
‡‡2 3
.
‡‡3 4'
ToEcliptixProtocolFailure
‡‡4 M
(
‡‡M N
)
‡‡N O
)
‡‡O P
;
‡‡P Q
}
·· 
Span
„„ 
<
„„ 
byte
„„ 
>
„„ 
sendSpan
„„ '
=
„„( )

stackalloc
„„* 4
byte
„„5 9
[
„„9 :
	Constants
„„: C
.
„„C D
X_25519_KEY_SIZE
„„D T
]
„„T U
;
„„U V
Span
‰‰ 
<
‰‰ 
byte
‰‰ 
>
‰‰ 
recvSpan
‰‰ '
=
‰‰( )

stackalloc
‰‰* 4
byte
‰‰5 9
[
‰‰9 :
	Constants
‰‰: C
.
‰‰C D
X_25519_KEY_SIZE
‰‰D T
]
‰‰T U
;
‰‰U V
HKDF
ÊÊ 
.
ÊÊ 
	DeriveKey
ÊÊ "
(
ÊÊ" #
HashAlgorithmName
ÁÁ )
.
ÁÁ) *
SHA256
ÁÁ* 0
,
ÁÁ0 1
ikm
ËË 
:
ËË 

newRootKey
ËË '
,
ËË' (
output
ÈÈ 
:
ÈÈ 
sendSpan
ÈÈ  (
,
ÈÈ( )
salt
ÍÍ 
:
ÍÍ 
null
ÍÍ "
,
ÍÍ" #
info
ÎÎ 
:
ÎÎ $
InitialSenderChainInfo
ÎÎ 4
)
ÏÏ 
;
ÏÏ 
HKDF
ÓÓ 
.
ÓÓ 
	DeriveKey
ÓÓ "
(
ÓÓ" #
HashAlgorithmName
ÔÔ )
.
ÔÔ) *
SHA256
ÔÔ* 0
,
ÔÔ0 1
ikm
 
:
 

newRootKey
 '
,
' (
output
ÒÒ 
:
ÒÒ 
recvSpan
ÒÒ  (
,
ÒÒ( )
salt
ÚÚ 
:
ÚÚ 
null
ÚÚ "
,
ÚÚ" #
info
ÛÛ 
:
ÛÛ &
InitialReceiverChainInfo
ÛÛ 6
)
ÙÙ 
;
ÙÙ 
if
ˆˆ 
(
ˆˆ 
_isInitiator
ˆˆ $
)
ˆˆ$ %
{
˜˜ 
senderChainKey
¯¯ &
=
¯¯' (
sendSpan
¯¯) 1
.
¯¯1 2
ToArray
¯¯2 9
(
¯¯9 :
)
¯¯: ;
;
¯¯; <
receiverChainKey
˘˘ (
=
˘˘) *
recvSpan
˘˘+ 3
.
˘˘3 4
ToArray
˘˘4 ;
(
˘˘; <
)
˘˘< =
;
˘˘= >
}
˙˙ 
else
˚˚ 
{
¸¸ 
senderChainKey
˝˝ &
=
˝˝' (
recvSpan
˝˝) 1
.
˝˝1 2
ToArray
˝˝2 9
(
˝˝9 :
)
˝˝: ;
;
˝˝; <
receiverChainKey
˛˛ (
=
˛˛) *
sendSpan
˛˛+ 3
.
˛˛3 4
ToArray
˛˛4 ;
(
˛˛; <
)
˛˛< =
;
˛˛= >
}
ˇˇ 
}
ÄÄ 
catch
ÅÅ 
(
ÅÅ 
	Exception
ÅÅ  
ex
ÅÅ! #
)
ÅÅ# $
{
ÇÇ 
tempRootHandle
ÉÉ "
.
ÉÉ" #
Dispose
ÉÉ# *
(
ÉÉ* +
)
ÉÉ+ ,
;
ÉÉ, -
WipeIfNotNull
ÑÑ !
(
ÑÑ! "
peerDhPublicCopy
ÑÑ" 2
)
ÑÑ2 3
;
ÑÑ3 4
WipeIfNotNull
ÖÖ !
(
ÖÖ! "
dhSecret
ÖÖ" *
)
ÖÖ* +
;
ÖÖ+ ,
WipeIfNotNull
ÜÜ !
(
ÜÜ! "

newRootKey
ÜÜ" ,
)
ÜÜ, -
;
ÜÜ- .
return
áá 
Result
áá !
<
áá! "
Unit
áá" &
,
áá& '%
EcliptixProtocolFailure
áá( ?
>
áá? @
.
áá@ A
Err
ááA D
(
ááD E%
EcliptixProtocolFailure
àà /
.
àà/ 0
	DeriveKey
àà0 9
(
àà9 :-
EcliptixProtocolFailureMessages
ââ ;
.
ââ; <1
#FAILED_TO_DERIVE_INITIAL_CHAIN_KEYS
ââ< _
,
ââ_ `
ex
ââa c
)
ââc d
)
ââd e
;
ââe f
}
ää 
finally
ãã 
{
åå 
WipeIfNotNull
çç !
(
çç! "
dhSecret
çç" *
)
çç* +
;
çç+ ,
WipeIfNotNull
éé !
(
éé! "

newRootKey
éé" ,
)
éé, -
;
éé- .
}
èè 
Result
ëë 
<
ëë 
Unit
ëë 
,
ëë %
EcliptixProtocolFailure
ëë 4
>
ëë4 5
updateResult
ëë6 B
=
ëëC D
_sendingStep
íí  
.
íí  !&
UpdateKeysAfterDhRatchet
íí! 9
(
íí9 :
senderChainKey
íí: H
)
ííH I
;
ííI J
if
ìì 
(
ìì 
updateResult
ìì  
.
ìì  !
IsErr
ìì! &
)
ìì& '
{
îî 
tempRootHandle
ïï "
.
ïï" #
Dispose
ïï# *
(
ïï* +
)
ïï+ ,
;
ïï, -
WipeIfNotNull
ññ !
(
ññ! "
peerDhPublicCopy
ññ" 2
)
ññ2 3
;
ññ3 4
return
óó 
updateResult
óó '
;
óó' (
}
òò 
Result
öö 
<
öö '
EcliptixProtocolChainStep
öö 0
,
öö0 1%
EcliptixProtocolFailure
öö2 I
>
ööI J
createResult
ööK W
=
ööX Y'
EcliptixProtocolChainStep
õõ -
.
õõ- .
Create
õõ. 4
(
õõ4 5
ChainStepType
õõ5 B
.
õõB C
Receiver
õõC K
,
õõK L
receiverChainKey
úú (
,
úú( )$
persistentPrivKeyBytes
úú* @
,
úú@ A$
_persistentDhPublicKey
úúB X
)
úúX Y
;
úúY Z
if
ùù 
(
ùù 
createResult
ùù  
.
ùù  !
IsErr
ùù! &
)
ùù& '
{
ûû 
tempRootHandle
üü "
?
üü" #
.
üü# $
Dispose
üü$ +
(
üü+ ,
)
üü, -
;
üü- .
WipeIfNotNull
†† !
(
††! "
peerDhPublicCopy
††" 2
)
††2 3
;
††3 4
return
°° 
Result
°° !
<
°°! "
Unit
°°" &
,
°°& '%
EcliptixProtocolFailure
°°( ?
>
°°? @
.
°°@ A
Err
°°A D
(
°°D E
createResult
°°E Q
.
°°Q R
	UnwrapErr
°°R [
(
°°[ \
)
°°\ ]
)
°°] ^
;
°°^ _
}
¢¢ 
_rootKeyHandle
§§ 
=
§§  
tempRootHandle
§§! /
;
§§/ 0
_receivingStep
•• 
=
••  
createResult
••! -
.
••- .
Unwrap
••. 4
(
••4 5
)
••5 6
;
••6 7
_peerDhPublicKey
¶¶  
=
¶¶! "
peerDhPublicCopy
¶¶# 3
;
¶¶3 4
peerDhPublicCopy
ßß  
=
ßß! "
null
ßß# '
;
ßß' (
Result
©© 
<
©© 
Unit
©© 
,
©© %
EcliptixProtocolFailure
©© 4
>
©©4 5
metadataKeyResult
©©6 G
=
©©H I)
DeriveMetadataEncryptionKey
©©J e
(
©©e f
)
©©f g
;
©©g h
if
™™ 
(
™™ 
metadataKeyResult
™™ %
.
™™% &
IsErr
™™& +
)
™™+ ,
{
´´ 
return
¨¨ 
metadataKeyResult
¨¨ ,
;
¨¨, -
}
≠≠ 
return
ØØ 
Result
ØØ 
<
ØØ 
Unit
ØØ "
,
ØØ" #%
EcliptixProtocolFailure
ØØ$ ;
>
ØØ; <
.
ØØ< =
Ok
ØØ= ?
(
ØØ? @
Unit
ØØ@ D
.
ØØD E
Value
ØØE J
)
ØØJ K
;
ØØK L
}
∞∞ 
finally
±± 
{
≤≤ 
WipeIfNotNull
≥≥ 
(
≥≥ $
persistentPrivKeyBytes
≥≥ 4
)
≥≥4 5
;
≥≥5 6
WipeIfNotNull
¥¥ 
(
¥¥ 
peerDhPublicCopy
¥¥ .
)
¥¥. /
;
¥¥/ 0
WipeIfNotNull
µµ 
(
µµ 
senderChainKey
µµ ,
)
µµ, -
;
µµ- .
WipeIfNotNull
∂∂ 
(
∂∂ 
receiverChainKey
∂∂ .
)
∂∂. /
;
∂∂/ 0
}
∑∑ 
}
∏∏ 	
}
ππ 
internal
ªª 
Result
ªª 
<
ªª 
(
ªª 
RatchetChainKey
ªª $

RatchetKey
ªª% /
,
ªª/ 0
bool
ªª1 5
IncludeDhKey
ªª6 B
)
ªªB C
,
ªªC D%
EcliptixProtocolFailure
ªªE \
>
ªª\ ]$
PrepareNextSendMessage
ªª^ t
(
ªªt u
)
ªªu v
{
ºº 
lock
ΩΩ 
(
ΩΩ 
_lock
ΩΩ 
)
ΩΩ 
{
ææ 	
Result
øø 
<
øø 
Unit
øø 
,
øø %
EcliptixProtocolFailure
øø 0
>
øø0 1
disposedCheck
øø2 ?
=
øø@ A
CheckDisposed
øøB O
(
øøO P
)
øøP Q
;
øøQ R
if
¿¿ 
(
¿¿ 
disposedCheck
¿¿ 
.
¿¿ 
IsErr
¿¿ #
)
¿¿# $
{
¡¡ 
return
¬¬ 
Result
¬¬ 
<
¬¬ 
(
¬¬ 
RatchetChainKey
¬¬ .
,
¬¬. /
bool
¬¬0 4
)
¬¬4 5
,
¬¬5 6%
EcliptixProtocolFailure
¬¬7 N
>
¬¬N O
.
¬¬O P
Err
¬¬P S
(
¬¬S T
disposedCheck
¬¬T a
.
¬¬a b
	UnwrapErr
¬¬b k
(
¬¬k l
)
¬¬l m
)
¬¬m n
;
¬¬n o
}
√√ 
Result
≈≈ 
<
≈≈ 
Unit
≈≈ 
,
≈≈ %
EcliptixProtocolFailure
≈≈ 0
>
≈≈0 1
expiredCheck
≈≈2 >
=
≈≈? @
EnsureNotExpired
≈≈A Q
(
≈≈Q R
)
≈≈R S
;
≈≈S T
if
∆∆ 
(
∆∆ 
expiredCheck
∆∆ 
.
∆∆ 
IsErr
∆∆ "
)
∆∆" #
{
«« 
return
»» 
Result
»» 
<
»» 
(
»» 
RatchetChainKey
»» .
,
»». /
bool
»»0 4
)
»»4 5
,
»»5 6%
EcliptixProtocolFailure
»»7 N
>
»»N O
.
»»O P
Err
»»P S
(
»»S T
expiredCheck
»»T `
.
»»` a
	UnwrapErr
»»a j
(
»»j k
)
»»k l
)
»»l m
;
»»m n
}
…… 
Result
ÀÀ 
<
ÀÀ '
EcliptixProtocolChainStep
ÀÀ ,
,
ÀÀ, -%
EcliptixProtocolFailure
ÀÀ. E
>
ÀÀE F
sendingStepResult
ÀÀG X
=
ÀÀY Z*
EnsureSendingStepInitialized
ÃÃ ,
(
ÃÃ, -
)
ÃÃ- .
;
ÃÃ. /
if
ÕÕ 
(
ÕÕ 
sendingStepResult
ÕÕ !
.
ÕÕ! "
IsErr
ÕÕ" '
)
ÕÕ' (
{
ŒŒ 
return
œœ 
Result
œœ 
<
œœ 
(
œœ 
RatchetChainKey
œœ .
,
œœ. /
bool
œœ0 4
)
œœ4 5
,
œœ5 6%
EcliptixProtocolFailure
œœ7 N
>
œœN O
.
œœO P
Err
œœP S
(
œœS T
sendingStepResult
œœT e
.
œœe f
	UnwrapErr
œœf o
(
œœo p
)
œœp q
)
œœq r
;
œœr s
}
–– '
EcliptixProtocolChainStep
““ %
sendingStep
““& 1
=
““2 3
sendingStepResult
““4 E
.
““E F
Unwrap
““F L
(
““L M
)
““M N
;
““N O
Result
‘‘ 
<
‘‘ 
bool
‘‘ 
,
‘‘ %
EcliptixProtocolFailure
‘‘ 0
>
‘‘0 1
ratchetResult
‘‘2 ?
=
‘‘@ A*
MaybePerformSendingDhRatchet
‘‘B ^
(
‘‘^ _
sendingStep
‘‘_ j
)
‘‘j k
;
‘‘k l
if
’’ 
(
’’ 
ratchetResult
’’ 
.
’’ 
IsErr
’’ #
)
’’# $
{
÷÷ 
return
◊◊ 
Result
◊◊ 
<
◊◊ 
(
◊◊ 
RatchetChainKey
◊◊ .
,
◊◊. /
bool
◊◊0 4
)
◊◊4 5
,
◊◊5 6%
EcliptixProtocolFailure
◊◊7 N
>
◊◊N O
.
◊◊O P
Err
◊◊P S
(
◊◊S T
ratchetResult
◊◊T a
.
◊◊a b
	UnwrapErr
◊◊b k
(
◊◊k l
)
◊◊l m
)
◊◊m n
;
◊◊n o
}
ÿÿ 
bool
⁄⁄ 
includeDhKey
⁄⁄ 
=
⁄⁄ 
ratchetResult
⁄⁄  -
.
⁄⁄- .
Unwrap
⁄⁄. 4
(
⁄⁄4 5
)
⁄⁄5 6
;
⁄⁄6 7
Result
‹‹ 
<
‹‹ 
uint
‹‹ 
,
‹‹ %
EcliptixProtocolFailure
‹‹ 0
>
‹‹0 1 
currentIndexResult
‹‹2 D
=
‹‹E F
sendingStep
‹‹G R
.
‹‹R S
GetCurrentIndex
‹‹S b
(
‹‹b c
)
‹‹c d
;
‹‹d e
if
›› 
(
››  
currentIndexResult
›› "
.
››" #
IsErr
››# (
)
››( )
{
ﬁﬁ 
return
ﬂﬂ 
Result
ﬂﬂ 
<
ﬂﬂ 
(
ﬂﬂ 
RatchetChainKey
ﬂﬂ .
,
ﬂﬂ. /
bool
ﬂﬂ0 4
)
ﬂﬂ4 5
,
ﬂﬂ5 6%
EcliptixProtocolFailure
ﬂﬂ7 N
>
ﬂﬂN O
.
ﬂﬂO P
Err
ﬂﬂP S
(
ﬂﬂS T 
currentIndexResult
ﬂﬂT f
.
ﬂﬂf g
	UnwrapErr
ﬂﬂg p
(
ﬂﬂp q
)
ﬂﬂq r
)
ﬂﬂr s
;
ﬂﬂs t
}
‡‡ 
uint
‚‚ 
currentIndex
‚‚ 
=
‚‚  
currentIndexResult
‚‚  2
.
‚‚2 3
Unwrap
‚‚3 9
(
‚‚9 :
)
‚‚: ;
;
‚‚; <
Result
‰‰ 
<
‰‰ 
RatchetChainKey
‰‰ "
,
‰‰" #%
EcliptixProtocolFailure
‰‰$ ;
>
‰‰; <
derivedKeyResult
‰‰= M
=
‰‰N O
sendingStep
ÂÂ 
.
ÂÂ 
GetOrDeriveKeyFor
ÂÂ -
(
ÂÂ- .
currentIndex
ÂÂ. :
+
ÂÂ; <
$num
ÂÂ= >
)
ÂÂ> ?
;
ÂÂ? @
if
ÊÊ 
(
ÊÊ 
derivedKeyResult
ÊÊ  
.
ÊÊ  !
IsErr
ÊÊ! &
)
ÊÊ& '
{
ÁÁ 
return
ËË 
Result
ËË 
<
ËË 
(
ËË 
RatchetChainKey
ËË .
,
ËË. /
bool
ËË0 4
)
ËË4 5
,
ËË5 6%
EcliptixProtocolFailure
ËË7 N
>
ËËN O
.
ËËO P
Err
ËËP S
(
ËËS T
derivedKeyResult
ËËT d
.
ËËd e
	UnwrapErr
ËËe n
(
ËËn o
)
ËËo p
)
ËËp q
;
ËËq r
}
ÈÈ 
RatchetChainKey
ÎÎ 

derivedKey
ÎÎ &
=
ÎÎ' (
derivedKeyResult
ÎÎ) 9
.
ÎÎ9 :
Unwrap
ÎÎ: @
(
ÎÎ@ A
)
ÎÎA B
;
ÎÎB C
Result
ÌÌ 
<
ÌÌ 
Unit
ÌÌ 
,
ÌÌ %
EcliptixProtocolFailure
ÌÌ 0
>
ÌÌ0 1
setIndexResult
ÌÌ2 @
=
ÌÌA B
sendingStep
ÌÌC N
.
ÌÌN O
SetCurrentIndex
ÌÌO ^
(
ÌÌ^ _
currentIndex
ÌÌ_ k
+
ÌÌl m
$num
ÌÌn o
)
ÌÌo p
;
ÌÌp q
if
ÓÓ 
(
ÓÓ 
setIndexResult
ÓÓ 
.
ÓÓ 
IsErr
ÓÓ $
)
ÓÓ$ %
{
ÔÔ 
return
 
Result
 
<
 
(
 
RatchetChainKey
 .
,
. /
bool
0 4
)
4 5
,
5 6%
EcliptixProtocolFailure
7 N
>
N O
.
O P
Err
P S
(
S T
setIndexResult
T b
.
b c
	UnwrapErr
c l
(
l m
)
m n
)
n o
;
o p
}
ÒÒ 
_sendingStep
ÛÛ 
.
ÛÛ 
PruneOldKeys
ÛÛ %
(
ÛÛ% &
)
ÛÛ& '
;
ÛÛ' (
return
ÙÙ 
Result
ÙÙ 
<
ÙÙ 
(
ÙÙ 
RatchetChainKey
ÙÙ *
,
ÙÙ* +
bool
ÙÙ, 0
)
ÙÙ0 1
,
ÙÙ1 2%
EcliptixProtocolFailure
ÙÙ3 J
>
ÙÙJ K
.
ÙÙK L
Ok
ÙÙL N
(
ÙÙN O
(
ıı 

derivedKey
ıı 
,
ıı 
includeDhKey
ıı )
)
ıı) *
)
ıı* +
;
ıı+ ,
}
ˆˆ 	
}
˜˜ 
internal
˘˘ 
Result
˘˘ 
<
˘˘ 
RatchetChainKey
˘˘ #
,
˘˘# $%
EcliptixProtocolFailure
˘˘% <
>
˘˘< =$
ProcessReceivedMessage
˘˘> T
(
˘˘T U
uint
˘˘U Y
receivedIndex
˘˘Z g
)
˘˘g h
{
˙˙ 
lock
˚˚ 
(
˚˚ 
_lock
˚˚ 
)
˚˚ 
{
¸¸ 	
Result
˝˝ 
<
˝˝ 
Unit
˝˝ 
,
˝˝ %
EcliptixProtocolFailure
˝˝ 0
>
˝˝0 1
disposedCheck
˝˝2 ?
=
˝˝@ A
CheckDisposed
˝˝B O
(
˝˝O P
)
˝˝P Q
;
˝˝Q R
if
˛˛ 
(
˛˛ 
disposedCheck
˛˛ 
.
˛˛ 
IsErr
˛˛ #
)
˛˛# $
{
ˇˇ 
return
ÄÄ 
Result
ÄÄ 
<
ÄÄ 
RatchetChainKey
ÄÄ -
,
ÄÄ- .%
EcliptixProtocolFailure
ÄÄ/ F
>
ÄÄF G
.
ÄÄG H
Err
ÄÄH K
(
ÄÄK L
disposedCheck
ÄÄL Y
.
ÄÄY Z
	UnwrapErr
ÄÄZ c
(
ÄÄc d
)
ÄÄd e
)
ÄÄe f
;
ÄÄf g
}
ÅÅ 
Result
ÉÉ 
<
ÉÉ 
Unit
ÉÉ 
,
ÉÉ %
EcliptixProtocolFailure
ÉÉ 0
>
ÉÉ0 1
expiredCheck
ÉÉ2 >
=
ÉÉ? @
EnsureNotExpired
ÉÉA Q
(
ÉÉQ R
)
ÉÉR S
;
ÉÉS T
if
ÑÑ 
(
ÑÑ 
expiredCheck
ÑÑ 
.
ÑÑ 
IsErr
ÑÑ "
)
ÑÑ" #
{
ÖÖ 
return
ÜÜ 
Result
ÜÜ 
<
ÜÜ 
RatchetChainKey
ÜÜ -
,
ÜÜ- .%
EcliptixProtocolFailure
ÜÜ/ F
>
ÜÜF G
.
ÜÜG H
Err
ÜÜH K
(
ÜÜK L
expiredCheck
ÜÜL X
.
ÜÜX Y
	UnwrapErr
ÜÜY b
(
ÜÜb c
)
ÜÜc d
)
ÜÜd e
;
ÜÜe f
}
áá 
if
ââ 
(
ââ 
receivedIndex
ââ 
>
ââ 
uint
ââ  $
.
ââ$ %
MaxValue
ââ% -
-
ââ. /%
ProtocolSystemConstants
ââ0 G
.
ââG H
RatchetRecovery
ââH W
.
ââW X#
INDEX_OVERFLOW_BUFFER
ââX m
)
ââm n
{
ää 
return
ãã 
Result
ãã 
<
ãã 
RatchetChainKey
ãã -
,
ãã- .%
EcliptixProtocolFailure
ãã/ F
>
ããF G
.
ããG H
Err
ããH K
(
ããK L%
EcliptixProtocolFailure
åå +
.
åå+ ,
Generic
åå, 3
(
åå3 4
string
åå4 :
.
åå: ;
Format
åå; A
(
ååA B-
EcliptixProtocolFailureMessages
çç 7
.
çç7 8&
RECEIVED_INDEX_TOO_LARGE
çç8 P
,
ççP Q
receivedIndex
éé %
)
éé% &
)
éé& '
)
éé' (
;
éé( )
}
èè 
Result
ëë 
<
ëë '
EcliptixProtocolChainStep
ëë ,
,
ëë, -%
EcliptixProtocolFailure
ëë. E
>
ëëE F!
receivingStepResult
ëëG Z
=
ëë[ \,
EnsureReceivingStepInitialized
íí .
(
íí. /
)
íí/ 0
;
íí0 1
if
ìì 
(
ìì !
receivingStepResult
ìì #
.
ìì# $
IsErr
ìì$ )
)
ìì) *
{
îî 
return
ïï 
Result
ïï 
<
ïï 
RatchetChainKey
ïï -
,
ïï- .%
EcliptixProtocolFailure
ïï/ F
>
ïïF G
.
ïïG H
Err
ïïH K
(
ïïK L!
receivingStepResult
ïïL _
.
ïï_ `
	UnwrapErr
ïï` i
(
ïïi j
)
ïïj k
)
ïïk l
;
ïïl m
}
ññ '
EcliptixProtocolChainStep
òò %
receivingStep
òò& 3
=
òò4 5!
receivingStepResult
òò6 I
.
òòI J
Unwrap
òòJ P
(
òòP Q
)
òòQ R
;
òòR S
Result
öö 
<
öö 
Option
öö 
<
öö 
RatchetChainKey
öö )
>
öö) *
,
öö* +%
EcliptixProtocolFailure
öö, C
>
ööC D
recoveryResult
ööE S
=
ööT U
_ratchetRecovery
õõ  
.
õõ  !"
TryRecoverMessageKey
õõ! 5
(
õõ5 6
receivedIndex
õõ6 C
)
õõC D
;
õõD E
if
úú 
(
úú 
recoveryResult
úú 
.
úú 
IsErr
úú $
)
úú$ %
{
ùù 
return
ûû 
Result
ûû 
<
ûû 
RatchetChainKey
ûû -
,
ûû- .%
EcliptixProtocolFailure
ûû/ F
>
ûûF G
.
ûûG H
Err
ûûH K
(
ûûK L
recoveryResult
ûûL Z
.
ûûZ [
	UnwrapErr
ûû[ d
(
ûûd e
)
ûûe f
)
ûûf g
;
ûûg h
}
üü 
if
°° 
(
°° 
recoveryResult
°° 
.
°° 
Unwrap
°° %
(
°°% &
)
°°& '
.
°°' (
IsSome
°°( .
)
°°. /
{
¢¢ 
return
££ 
Result
££ 
<
££ 
RatchetChainKey
££ -
,
££- .%
EcliptixProtocolFailure
££/ F
>
££F G
.
££G H
Ok
££H J
(
££J K
recoveryResult
££K Y
.
££Y Z
Unwrap
££Z `
(
££` a
)
££a b
.
££b c
Value
££c h
!
££h i
)
££i j
;
££j k
}
§§ 
Result
¶¶ 
<
¶¶ 
uint
¶¶ 
,
¶¶ %
EcliptixProtocolFailure
¶¶ 0
>
¶¶0 1 
currentIndexResult
¶¶2 D
=
¶¶E F
receivingStep
¶¶G T
.
¶¶T U
GetCurrentIndex
¶¶U d
(
¶¶d e
)
¶¶e f
;
¶¶f g
if
ßß 
(
ßß  
currentIndexResult
ßß "
.
ßß" #
IsErr
ßß# (
)
ßß( )
{
®® 
return
©© 
Result
©© 
<
©© 
RatchetChainKey
©© -
,
©©- .%
EcliptixProtocolFailure
©©/ F
>
©©F G
.
©©G H
Err
©©H K
(
©©K L 
currentIndexResult
©©L ^
.
©©^ _
	UnwrapErr
©©_ h
(
©©h i
)
©©i j
)
©©j k
;
©©k l
}
™™ 
uint
¨¨ 
currentIndex
¨¨ 
=
¨¨  
currentIndexResult
¨¨  2
.
¨¨2 3
Unwrap
¨¨3 9
(
¨¨9 :
)
¨¨: ;
;
¨¨; <
Result
ÆÆ 
<
ÆÆ 
bool
ÆÆ 
,
ÆÆ %
EcliptixProtocolFailure
ÆÆ 0
>
ÆÆ0 1

skipResult
ÆÆ2 <
=
ÆÆ= >
HandleSkippedKeys
ØØ !
(
ØØ! "
receivingStep
ØØ" /
,
ØØ/ 0
currentIndex
ØØ1 =
,
ØØ= >
receivedIndex
ØØ? L
)
ØØL M
;
ØØM N
if
∞∞ 
(
∞∞ 

skipResult
∞∞ 
.
∞∞ 
IsErr
∞∞  
)
∞∞  !
{
±± 
return
≤≤ 
Result
≤≤ 
<
≤≤ 
RatchetChainKey
≤≤ -
,
≤≤- .%
EcliptixProtocolFailure
≤≤/ F
>
≤≤F G
.
≤≤G H
Err
≤≤H K
(
≤≤K L

skipResult
≤≤L V
.
≤≤V W
	UnwrapErr
≤≤W `
(
≤≤` a
)
≤≤a b
)
≤≤b c
;
≤≤c d
}
≥≥ 
Result
µµ 
<
µµ 
RatchetChainKey
µµ "
,
µµ" #%
EcliptixProtocolFailure
µµ$ ;
>
µµ; <
derivedKeyResult
µµ= M
=
µµN O
receivingStep
∂∂ 
.
∂∂ 
GetOrDeriveKeyFor
∂∂ /
(
∂∂/ 0
receivedIndex
∂∂0 =
)
∂∂= >
;
∂∂> ?
if
∑∑ 
(
∑∑ 
derivedKeyResult
∑∑  
.
∑∑  !
IsErr
∑∑! &
)
∑∑& '
{
∏∏ 
return
ππ 
derivedKeyResult
ππ '
;
ππ' (
}
∫∫ 
RatchetChainKey
ºº 

derivedKey
ºº &
=
ºº' (
derivedKeyResult
ºº) 9
.
ºº9 :
Unwrap
ºº: @
(
ºº@ A
)
ººA B
;
ººB C
Result
ææ 
<
ææ 
Unit
ææ 
,
ææ %
EcliptixProtocolFailure
ææ 0
>
ææ0 1
setIndexResult
ææ2 @
=
ææA B
receivingStep
ææC P
.
ææP Q
SetCurrentIndex
ææQ `
(
ææ` a

derivedKey
ææa k
.
ææk l
Index
ææl q
)
ææq r
;
æær s
if
øø 
(
øø 
setIndexResult
øø 
.
øø 
IsErr
øø $
)
øø$ %
{
¿¿ 
return
¡¡ 
Result
¡¡ 
<
¡¡ 
RatchetChainKey
¡¡ -
,
¡¡- .%
EcliptixProtocolFailure
¡¡/ F
>
¡¡F G
.
¡¡G H
Err
¡¡H K
(
¡¡K L
setIndexResult
¡¡L Z
.
¡¡Z [
	UnwrapErr
¡¡[ d
(
¡¡d e
)
¡¡e f
)
¡¡f g
;
¡¡g h
}
¬¬ $
PerformCleanupIfNeeded
ƒƒ "
(
ƒƒ" #
receivedIndex
ƒƒ# 0
)
ƒƒ0 1
;
ƒƒ1 2
return
∆∆ 
Result
∆∆ 
<
∆∆ 
RatchetChainKey
∆∆ )
,
∆∆) *%
EcliptixProtocolFailure
∆∆+ B
>
∆∆B C
.
∆∆C D
Ok
∆∆D F
(
∆∆F G

derivedKey
∆∆G Q
)
∆∆Q R
;
∆∆R S
}
«« 	
}
»» 
private
   
Result
   
<
   
bool
   
,
   %
EcliptixProtocolFailure
   0
>
  0 1
HandleSkippedKeys
  2 C
(
  C D'
EcliptixProtocolChainStep
ÀÀ !
receivingStep
ÀÀ" /
,
ÀÀ/ 0
uint
ÃÃ 
currentIndex
ÃÃ 
,
ÃÃ 
uint
ÕÕ 
receivedIndex
ÕÕ 
)
ÕÕ 
{
ŒŒ 
if
œœ 

(
œœ 
receivedIndex
œœ 
<=
œœ 
currentIndex
œœ )
+
œœ* +
$num
œœ, -
)
œœ- .
{
–– 	
return
—— 
Result
—— 
<
—— 
bool
—— 
,
—— %
EcliptixProtocolFailure
——  7
>
——7 8
.
——8 9
Ok
——9 ;
(
——; <
false
——< A
)
——A B
;
——B C
}
““ 	
Result
‘‘ 
<
‘‘ 
byte
‘‘ 
[
‘‘ 
]
‘‘ 
,
‘‘ %
EcliptixProtocolFailure
‘‘ .
>
‘‘. /
chainKeyResult
‘‘0 >
=
‘‘? @
receivingStep
‘‘A N
.
‘‘N O 
GetCurrentChainKey
‘‘O a
(
‘‘a b
)
‘‘b c
;
‘‘c d
if
’’ 

(
’’ 
chainKeyResult
’’ 
.
’’ 
IsErr
’’  
)
’’  !
{
÷÷ 	
return
◊◊ 
Result
◊◊ 
<
◊◊ 
bool
◊◊ 
,
◊◊ %
EcliptixProtocolFailure
◊◊  7
>
◊◊7 8
.
◊◊8 9
Ok
◊◊9 ;
(
◊◊; <
false
◊◊< A
)
◊◊A B
;
◊◊B C
}
ÿÿ 	
byte
⁄⁄ 
[
⁄⁄ 
]
⁄⁄ 
currentChainKey
⁄⁄ 
=
⁄⁄  
chainKeyResult
⁄⁄! /
.
⁄⁄/ 0
Unwrap
⁄⁄0 6
(
⁄⁄6 7
)
⁄⁄7 8
;
⁄⁄8 9
try
€€ 
{
‹‹ 	
Result
›› 
<
›› 
Unit
›› 
,
›› %
EcliptixProtocolFailure
›› 0
>
››0 1
storeResult
››2 =
=
››> ?
_ratchetRecovery
››@ P
.
››P Q%
StoreSkippedMessageKeys
››Q h
(
››h i
currentChainKey
ﬁﬁ 
,
ﬁﬁ  
currentIndex
ﬂﬂ 
+
ﬂﬂ 
$num
ﬂﬂ  
,
ﬂﬂ  !
receivedIndex
‡‡ 
)
·· 
;
·· 
return
„„ 
storeResult
„„ 
.
„„ 
IsErr
„„ $
?
‰‰ 
Result
‰‰ 
<
‰‰ 
bool
‰‰ 
,
‰‰ %
EcliptixProtocolFailure
‰‰ 6
>
‰‰6 7
.
‰‰7 8
Err
‰‰8 ;
(
‰‰; <
storeResult
‰‰< G
.
‰‰G H
	UnwrapErr
‰‰H Q
(
‰‰Q R
)
‰‰R S
)
‰‰S T
:
ÂÂ 
Result
ÂÂ 
<
ÂÂ 
bool
ÂÂ 
,
ÂÂ %
EcliptixProtocolFailure
ÂÂ 6
>
ÂÂ6 7
.
ÂÂ7 8
Ok
ÂÂ8 :
(
ÂÂ: ;
true
ÂÂ; ?
)
ÂÂ? @
;
ÂÂ@ A
}
ÊÊ 	
finally
ÁÁ 
{
ËË 	
SodiumInterop
ÈÈ 
.
ÈÈ 

SecureWipe
ÈÈ $
(
ÈÈ$ %
currentChainKey
ÈÈ% 4
)
ÈÈ4 5
;
ÈÈ5 6
}
ÍÍ 	
}
ÎÎ 
private
ÌÌ 
void
ÌÌ $
PerformCleanupIfNeeded
ÌÌ '
(
ÌÌ' (
uint
ÌÌ( ,
receivedIndex
ÌÌ- :
)
ÌÌ: ;
{
ÓÓ 
if
ÔÔ 

(
ÔÔ 
receivedIndex
ÔÔ 
>
ÔÔ %
ProtocolSystemConstants
ÔÔ 3
.
ÔÔ3 4
RatchetRecovery
ÔÔ4 C
.
ÔÔC D
CLEANUP_THRESHOLD
ÔÔD U
)
ÔÔU V
{
 	
_ratchetRecovery
ÒÒ 
.
ÒÒ 
CleanupOldKeys
ÒÒ +
(
ÒÒ+ ,
receivedIndex
ÒÒ, 9
-
ÒÒ: ;%
ProtocolSystemConstants
ÒÒ< S
.
ÒÒS T
RatchetRecovery
ÒÒT c
.
ÒÒc d
CLEANUP_THRESHOLD
ÒÒd u
)
ÒÒu v
;
ÒÒv w
}
ÚÚ 	
_receivingStep
ÙÙ 
!
ÙÙ 
.
ÙÙ 
PruneOldKeys
ÙÙ $
(
ÙÙ$ %
)
ÙÙ% &
;
ÙÙ& '
}
ıı 
public
˜˜ 

Result
˜˜ 
<
˜˜ 
Unit
˜˜ 
,
˜˜ %
EcliptixProtocolFailure
˜˜ /
>
˜˜/ 0%
PerformReceivingRatchet
˜˜1 H
(
˜˜H I
byte
˜˜I M
[
˜˜M N
]
˜˜N O
receivedDhKey
˜˜P ]
)
˜˜] ^
{
¯¯ 
lock
˘˘ 
(
˘˘ 
_lock
˘˘ 
)
˘˘ 
{
˙˙ 	
Result
˚˚ 
<
˚˚ 
Unit
˚˚ 
,
˚˚ %
EcliptixProtocolFailure
˚˚ 0
>
˚˚0 1
disposedCheck
˚˚2 ?
=
˚˚@ A
CheckDisposed
˚˚B O
(
˚˚O P
)
˚˚P Q
;
˚˚Q R
if
¸¸ 
(
¸¸ 
disposedCheck
¸¸ 
.
¸¸ 
IsErr
¸¸ #
)
¸¸# $
{
˝˝ 
return
˛˛ 
disposedCheck
˛˛ $
;
˛˛$ %
}
ˇˇ 
Result
ÅÅ 
<
ÅÅ '
EcliptixProtocolChainStep
ÅÅ ,
,
ÅÅ, -%
EcliptixProtocolFailure
ÅÅ. E
>
ÅÅE F!
receivingStepResult
ÅÅG Z
=
ÅÅ[ \,
EnsureReceivingStepInitialized
ÇÇ .
(
ÇÇ. /
)
ÇÇ/ 0
;
ÇÇ0 1
if
ÉÉ 
(
ÉÉ !
receivingStepResult
ÉÉ #
.
ÉÉ# $
IsErr
ÉÉ$ )
)
ÉÉ) *
{
ÑÑ 
return
ÖÖ 
Result
ÖÖ 
<
ÖÖ 
Unit
ÖÖ "
,
ÖÖ" #%
EcliptixProtocolFailure
ÖÖ$ ;
>
ÖÖ; <
.
ÖÖ< =
Err
ÖÖ= @
(
ÖÖ@ A!
receivingStepResult
ÖÖA T
.
ÖÖT U
	UnwrapErr
ÖÖU ^
(
ÖÖ^ _
)
ÖÖ_ `
)
ÖÖ` a
;
ÖÖa b
}
ÜÜ '
EcliptixProtocolChainStep
àà %
receivingStep
àà& 3
=
àà4 5!
receivingStepResult
àà6 I
.
ààI J
Unwrap
ààJ P
(
ààP Q
)
ààQ R
;
ààR S
Result
ää 
<
ää 
uint
ää 
,
ää %
EcliptixProtocolFailure
ää 0
>
ää0 1 
currentIndexResult
ää2 D
=
ääE F
receivingStep
ääG T
.
ääT U
GetCurrentIndex
ääU d
(
ääd e
)
ääe f
;
ääf g
if
ãã 
(
ãã  
currentIndexResult
ãã "
.
ãã" #
IsErr
ãã# (
)
ãã( )
{
åå 
return
çç 
Result
çç 
<
çç 
Unit
çç "
,
çç" #%
EcliptixProtocolFailure
çç$ ;
>
çç; <
.
çç< =
Err
çç= @
(
çç@ A 
currentIndexResult
ççA S
.
ççS T
	UnwrapErr
ççT ]
(
çç] ^
)
çç^ _
)
çç_ `
;
çç` a
}
éé 
uint
êê 
currentIndex
êê 
=
êê  
currentIndexResult
êê  2
.
êê2 3
Unwrap
êê3 9
(
êê9 :
)
êê: ;
;
êê; <
DateTime
ëë 
lastRatchetTime
ëë $
=
ëë% &
new
ëë' *
DateTime
ëë+ 3
(
ëë3 4
Interlocked
ëë4 ?
.
ëë? @
Read
ëë@ D
(
ëëD E
ref
ëëE H#
_lastRatchetTimeTicks
ëëI ^
)
ëë^ _
,
ëë_ `
DateTimeKind
ëëa m
.
ëëm n
Utc
ëën q
)
ëëq r
;
ëër s
bool
íí 
shouldRatchetNow
íí !
=
íí" #&
_isFirstReceivingRatchet
íí$ <
||
íí= ?
_ratchetConfig
ìì$ 2
.
ìì2 3
ShouldRatchet
ìì3 @
(
ìì@ A
currentIndex
ììA M
+
ììN O
$num
ììP Q
,
ììQ R
lastRatchetTime
ììS b
,
ììb c
_receivedNewDhKey
ììd u
)
ììu v
;
ììv w
if
ïï 
(
ïï 
!
ïï 
shouldRatchetNow
ïï !
)
ïï! "
{
ññ 
return
óó 
Result
óó 
<
óó 
Unit
óó "
,
óó" #%
EcliptixProtocolFailure
óó$ ;
>
óó; <
.
óó< =
Ok
óó= ?
(
óó? @
Unit
óó@ D
.
óóD E
Value
óóE J
)
óóJ K
;
óóK L
}
òò &
_isFirstReceivingRatchet
öö $
=
öö% &
false
öö' ,
;
öö, -
return
õõ 
PerformDhRatchet
õõ #
(
õõ# $
isSender
õõ$ ,
:
õõ, -
false
õõ. 3
,
õõ3 4&
receivedDhPublicKeyBytes
õõ5 M
:
õõM N
receivedDhKey
õõO \
)
õõ\ ]
;
õõ] ^
}
úú 	
}
ùù 
private
üü 
Result
üü 
<
üü 
Unit
üü 
,
üü %
EcliptixProtocolFailure
üü 0
>
üü0 1
PerformDhRatchet
üü2 B
(
üüB C
bool
üüC G
isSender
üüH P
,
üüP Q
byte
†† 
[
†† 
]
†† 
?
†† &
receivedDhPublicKeyBytes
†† (
=
††) *
null
††+ /
)
††/ 0
{
°° 
DhRatchetContext
¢¢ 
context
¢¢  
=
¢¢! "
new
¢¢# &
(
¢¢& '
)
¢¢' (
;
¢¢( )
try
§§ 
{
•• 	
Result
¶¶ 
<
¶¶ 
Unit
¶¶ 
,
¶¶ %
EcliptixProtocolFailure
¶¶ 0
>
¶¶0 1
validationResult
¶¶2 B
=
¶¶C D,
ValidateDhRatchetPreConditions
ßß .
(
ßß. /&
receivedDhPublicKeyBytes
ßß/ G
)
ßßG H
;
ßßH I
if
®® 
(
®® 
validationResult
®®  
.
®®  !
IsErr
®®! &
)
®®& '
{
©© 
return
™™ 
validationResult
™™ '
;
™™' (
}
´´ 
Result
≠≠ 
<
≠≠ 
byte
≠≠ 
[
≠≠ 
]
≠≠ 
,
≠≠ %
EcliptixProtocolFailure
≠≠ 2
>
≠≠2 3
dhSecretResult
≠≠4 B
=
≠≠C D
ComputeDhSecret
ÆÆ 
(
ÆÆ  
isSender
ÆÆ  (
,
ÆÆ( )&
receivedDhPublicKeyBytes
ÆÆ* B
,
ÆÆB C
context
ÆÆD K
)
ÆÆK L
;
ÆÆL M
if
ØØ 
(
ØØ 
dhSecretResult
ØØ 
.
ØØ 
IsErr
ØØ $
)
ØØ$ %
{
∞∞ 
return
±± 
Result
±± 
<
±± 
Unit
±± "
,
±±" #%
EcliptixProtocolFailure
±±$ ;
>
±±; <
.
±±< =
Err
±±= @
(
±±@ A
dhSecretResult
±±A O
.
±±O P
	UnwrapErr
±±P Y
(
±±Y Z
)
±±Z [
)
±±[ \
;
±±\ ]
}
≤≤ 
context
¥¥ 
.
¥¥ 
DhSecret
¥¥ 
=
¥¥ 
dhSecretResult
¥¥ -
.
¥¥- .
Unwrap
¥¥. 4
(
¥¥4 5
)
¥¥5 6
;
¥¥6 7
Result
∂∂ 
<
∂∂ 
(
∂∂ 
byte
∂∂ 
[
∂∂ 
]
∂∂ 
,
∂∂ 
byte
∂∂  
[
∂∂  !
]
∂∂! "
)
∂∂" #
,
∂∂# $%
EcliptixProtocolFailure
∂∂% <
>
∂∂< =

keysResult
∂∂> H
=
∂∂I J
DeriveRatchetKeys
∑∑ !
(
∑∑! "
context
∑∑" )
.
∑∑) *
DhSecret
∑∑* 2
)
∑∑2 3
;
∑∑3 4
if
∏∏ 
(
∏∏ 

keysResult
∏∏ 
.
∏∏ 
IsErr
∏∏  
)
∏∏  !
{
ππ 
return
∫∫ 
Result
∫∫ 
<
∫∫ 
Unit
∫∫ "
,
∫∫" #%
EcliptixProtocolFailure
∫∫$ ;
>
∫∫; <
.
∫∫< =
Err
∫∫= @
(
∫∫@ A

keysResult
∫∫A K
.
∫∫K L
	UnwrapErr
∫∫L U
(
∫∫U V
)
∫∫V W
)
∫∫W X
;
∫∫X Y
}
ªª 
(
ΩΩ 
context
ΩΩ 
.
ΩΩ 

NewRootKey
ΩΩ 
,
ΩΩ  
context
ΩΩ! (
.
ΩΩ( )
NewChainKey
ΩΩ) 4
)
ΩΩ4 5
=
ΩΩ6 7

keysResult
ΩΩ8 B
.
ΩΩB C
Unwrap
ΩΩC I
(
ΩΩI J
)
ΩΩJ K
;
ΩΩK L
Result
øø 
<
øø 
Unit
øø 
,
øø 
SodiumFailure
øø &
>
øø& '
writeResult
øø( 3
=
øø4 5
_rootKeyHandle
øø6 D
!
øøD E
.
øøE F
Write
øøF K
(
øøK L
context
øøL S
.
øøS T

NewRootKey
øøT ^
)
øø^ _
;
øø_ `
if
¿¿ 
(
¿¿ 
writeResult
¿¿ 
.
¿¿ 
IsErr
¿¿ !
)
¿¿! "
{
¡¡ 
return
¬¬ 
Result
¬¬ 
<
¬¬ 
Unit
¬¬ "
,
¬¬" #%
EcliptixProtocolFailure
¬¬$ ;
>
¬¬; <
.
¬¬< =
Err
¬¬= @
(
¬¬@ A
writeResult
√√ 
.
√√  
	UnwrapErr
√√  )
(
√√) *
)
√√* +
.
√√+ ,'
ToEcliptixProtocolFailure
√√, E
(
√√E F
)
√√F G
)
√√G H
;
√√H I
}
ƒƒ 
Result
∆∆ 
<
∆∆ 
Unit
∆∆ 
,
∆∆ %
EcliptixProtocolFailure
∆∆ 0
>
∆∆0 1
updateResult
∆∆2 >
=
∆∆? @)
UpdateChainStepAfterRatchet
«« +
(
««+ ,
isSender
««, 4
,
««4 5
context
««6 =
,
««= >&
receivedDhPublicKeyBytes
««? W
)
««W X
;
««X Y
if
»» 
(
»» 
updateResult
»» 
.
»» 
IsErr
»» "
)
»»" #
{
…… 
return
   
updateResult
   #
;
  # $
}
ÀÀ 
FinalizeRatchet
ÕÕ 
(
ÕÕ 
)
ÕÕ 
;
ÕÕ 
return
œœ 
Result
œœ 
<
œœ 
Unit
œœ 
,
œœ %
EcliptixProtocolFailure
œœ  7
>
œœ7 8
.
œœ8 9
Ok
œœ9 ;
(
œœ; <
Unit
œœ< @
.
œœ@ A
Value
œœA F
)
œœF G
;
œœG H
}
–– 	
finally
—— 
{
““ 	
context
”” 
.
”” 
Dispose
”” 
(
”” 
)
”” 
;
”” 
}
‘‘ 	
}
’’ 
private
◊◊ 
Result
◊◊ 
<
◊◊ 
Unit
◊◊ 
,
◊◊ %
EcliptixProtocolFailure
◊◊ 0
>
◊◊0 1,
ValidateDhRatchetPreConditions
◊◊2 P
(
◊◊P Q
byte
◊◊Q U
[
◊◊U V
]
◊◊V W
?
◊◊W X&
receivedDhPublicKeyBytes
◊◊Y q
)
◊◊q r
{
ÿÿ 
Result
ŸŸ 
<
ŸŸ 
Unit
ŸŸ 
,
ŸŸ %
EcliptixProtocolFailure
ŸŸ ,
>
ŸŸ, -
disposedCheck
ŸŸ. ;
=
ŸŸ< =
CheckDisposed
ŸŸ> K
(
ŸŸK L
)
ŸŸL M
;
ŸŸM N
if
⁄⁄ 

(
⁄⁄ 
disposedCheck
⁄⁄ 
.
⁄⁄ 
IsErr
⁄⁄ 
)
⁄⁄  
{
€€ 	
return
‹‹ 
disposedCheck
‹‹  
;
‹‹  !
}
›› 	
if
ﬂﬂ 

(
ﬂﬂ &
receivedDhPublicKeyBytes
ﬂﬂ $
!=
ﬂﬂ% '
null
ﬂﬂ( ,
)
ﬂﬂ, -
{
‡‡ 	
Result
·· 
<
·· 
Unit
·· 
,
·· %
EcliptixProtocolFailure
·· 0
>
··0 1 
dhValidationResult
··2 D
=
··E F
DhValidator
‚‚ 
.
‚‚ %
ValidateX25519PublicKey
‚‚ 3
(
‚‚3 4&
receivedDhPublicKeyBytes
‚‚4 L
)
‚‚L M
;
‚‚M N
if
„„ 
(
„„  
dhValidationResult
„„ "
.
„„" #
IsErr
„„# (
)
„„( )
{
‰‰ 
return
ÂÂ  
dhValidationResult
ÂÂ )
;
ÂÂ) *
}
ÊÊ 
}
ÁÁ 	
return
ÈÈ 
_rootKeyHandle
ÈÈ 
is
ÈÈ  
not
ÈÈ! $
{
ÈÈ% &
	IsInvalid
ÈÈ' 0
:
ÈÈ0 1
false
ÈÈ2 7
}
ÈÈ8 9
?
ÍÍ 
Result
ÍÍ 
<
ÍÍ 
Unit
ÍÍ 
,
ÍÍ %
EcliptixProtocolFailure
ÍÍ 2
>
ÍÍ2 3
.
ÍÍ3 4
Err
ÍÍ4 7
(
ÍÍ7 8%
EcliptixProtocolFailure
ÎÎ '
.
ÎÎ' (
Generic
ÎÎ( /
(
ÎÎ/ 0-
EcliptixProtocolFailureMessages
ÎÎ0 O
.
ÎÎO P-
ROOT_KEY_HANDLE_NOT_INITIALIZED
ÎÎP o
)
ÎÎo p
)
ÎÎp q
:
ÏÏ 
Result
ÏÏ 
<
ÏÏ 
Unit
ÏÏ 
,
ÏÏ %
EcliptixProtocolFailure
ÏÏ 2
>
ÏÏ2 3
.
ÏÏ3 4
Ok
ÏÏ4 6
(
ÏÏ6 7
Unit
ÏÏ7 ;
.
ÏÏ; <
Value
ÏÏ< A
)
ÏÏA B
;
ÏÏB C
}
ÌÌ 
private
ÔÔ 
Result
ÔÔ 
<
ÔÔ 
byte
ÔÔ 
[
ÔÔ 
]
ÔÔ 
,
ÔÔ %
EcliptixProtocolFailure
ÔÔ 2
>
ÔÔ2 3
ComputeDhSecret
ÔÔ4 C
(
ÔÔC D
bool
 
isSender
 
,
 
byte
ÒÒ 
[
ÒÒ 
]
ÒÒ 
?
ÒÒ &
receivedDhPublicKeyBytes
ÒÒ (
,
ÒÒ( )
DhRatchetContext
ÚÚ 
context
ÚÚ  
)
ÚÚ  !
{
ÛÛ 
try
ÙÙ 
{
ıı 	
return
ˆˆ 
isSender
ˆˆ 
?
˜˜ #
ComputeSenderDhSecret
˜˜ '
(
˜˜' (
context
˜˜( /
)
˜˜/ 0
:
¯¯ %
ComputeReceiverDhSecret
¯¯ )
(
¯¯) *&
receivedDhPublicKeyBytes
¯¯* B
,
¯¯B C
context
¯¯D K
)
¯¯K L
;
¯¯L M
}
˘˘ 	
catch
˙˙ 
(
˙˙ 
	Exception
˙˙ 
ex
˙˙ 
)
˙˙ 
{
˚˚ 	
return
¸¸ 
Result
¸¸ 
<
¸¸ 
byte
¸¸ 
[
¸¸ 
]
¸¸  
,
¸¸  !%
EcliptixProtocolFailure
¸¸" 9
>
¸¸9 :
.
¸¸: ;
Err
¸¸; >
(
¸¸> ?%
EcliptixProtocolFailure
˝˝ '
.
˝˝' (
	DeriveKey
˝˝( 1
(
˝˝1 2-
EcliptixProtocolFailureMessages
˝˝2 Q
.
˝˝Q R2
$DH_CALCULATION_FAILED_DURING_RATCHET
˝˝R v
,
˝˝v w
ex
˛˛ 
)
˛˛ 
)
˛˛ 
;
˛˛ 
}
ˇˇ 	
}
ÄÄ 
private
ÇÇ 
Result
ÇÇ 
<
ÇÇ 
byte
ÇÇ 
[
ÇÇ 
]
ÇÇ 
,
ÇÇ %
EcliptixProtocolFailure
ÇÇ 2
>
ÇÇ2 3#
ComputeSenderDhSecret
ÇÇ4 I
(
ÇÇI J
DhRatchetContext
ÇÇJ Z
context
ÇÇ[ b
)
ÇÇb c
{
ÉÉ 
if
ÑÑ 

(
ÑÑ 
_peerDhPublicKey
ÑÑ 
==
ÑÑ 
null
ÑÑ  $
)
ÑÑ$ %
{
ÖÖ 	
return
ÜÜ 
Result
ÜÜ 
<
ÜÜ 
byte
ÜÜ 
[
ÜÜ 
]
ÜÜ  
,
ÜÜ  !%
EcliptixProtocolFailure
ÜÜ" 9
>
ÜÜ9 :
.
ÜÜ: ;
Err
ÜÜ; >
(
ÜÜ> ?%
EcliptixProtocolFailure
áá '
.
áá' (
	DeriveKey
áá( 1
(
áá1 2-
EcliptixProtocolFailureMessages
áá2 Q
.
àà 3
%SENDER_RATCHET_PRE_CONDITIONS_NOT_MET
àà :
)
àà: ;
)
àà; <
;
àà< =
}
ââ 	
Result
ãã 
<
ãã 
(
ãã &
SodiumSecureMemoryHandle
ãã (
,
ãã( )
byte
ãã* .
[
ãã. /
]
ãã/ 0
)
ãã0 1
,
ãã1 2%
EcliptixProtocolFailure
ãã3 J
>
ããJ K
	ephResult
ããL U
=
ããV W
SodiumInterop
åå 
.
åå #
GenerateX25519KeyPair
åå /
(
åå/ 0-
EcliptixProtocolFailureMessages
åå0 O
.
ååO P.
 EPHEMERAL_DH_RATCHET_KEY_PURPOSE
ååP p
)
ååp q
;
ååq r
if
çç 

(
çç 
	ephResult
çç 
.
çç 
IsErr
çç 
)
çç 
{
éé 	
return
èè 
Result
èè 
<
èè 
byte
èè 
[
èè 
]
èè  
,
èè  !%
EcliptixProtocolFailure
èè" 9
>
èè9 :
.
èè: ;
Err
èè; >
(
èè> ?
	ephResult
èè? H
.
èèH I
	UnwrapErr
èèI R
(
èèR S
)
èèS T
)
èèT U
;
èèU V
}
êê 	
(
íí 	
context
íí	 
.
íí "
NewEphemeralSkHandle
íí %
,
íí% &
context
íí' .
.
íí. /#
NewEphemeralPublicKey
íí/ D
)
ííD E
=
ííF G
	ephResult
ííH Q
.
ííQ R
Unwrap
ííR X
(
ííX Y
)
ííY Z
;
ííZ [
Result
îî 
<
îî 
byte
îî 
[
îî 
]
îî 
,
îî 
SodiumFailure
îî $
>
îî$ %"
privateKeyReadResult
îî& :
=
îî; <
context
ïï 
.
ïï "
NewEphemeralSkHandle
ïï (
.
ïï( )
	ReadBytes
ïï) 2
(
ïï2 3
	Constants
ïï3 <
.
ïï< =&
X_25519_PRIVATE_KEY_SIZE
ïï= U
)
ïïU V
;
ïïV W
if
ññ 

(
ññ "
privateKeyReadResult
ññ  
.
ññ  !
IsErr
ññ! &
)
ññ& '
{
óó 	
return
òò 
Result
òò 
<
òò 
byte
òò 
[
òò 
]
òò  
,
òò  !%
EcliptixProtocolFailure
òò" 9
>
òò9 :
.
òò: ;
Err
òò; >
(
òò> ?"
privateKeyReadResult
ôô $
.
ôô$ %
	UnwrapErr
ôô% .
(
ôô. /
)
ôô/ 0
.
ôô0 1'
ToEcliptixProtocolFailure
ôô1 J
(
ôôJ K
)
ôôK L
)
ôôL M
;
ôôM N
}
öö 	
context
úú 
.
úú "
LocalPrivateKeyBytes
úú $
=
úú% &"
privateKeyReadResult
úú' ;
.
úú; <
Unwrap
úú< B
(
úúB C
)
úúC D
;
úúD E
byte
ûû 
[
ûû 
]
ûû 
dhSecret
ûû 
=
ûû 

ScalarMult
ûû $
.
ûû$ %
Mult
ûû% )
(
ûû) *
context
ûû* 1
.
ûû1 2"
LocalPrivateKeyBytes
ûû2 F
,
ûûF G
_peerDhPublicKey
ûûH X
)
ûûX Y
;
ûûY Z
return
üü 
Result
üü 
<
üü 
byte
üü 
[
üü 
]
üü 
,
üü %
EcliptixProtocolFailure
üü 5
>
üü5 6
.
üü6 7
Ok
üü7 9
(
üü9 :
dhSecret
üü: B
)
üüB C
;
üüC D
}
†† 
private
¢¢ 
Result
¢¢ 
<
¢¢ 
byte
¢¢ 
[
¢¢ 
]
¢¢ 
,
¢¢ %
EcliptixProtocolFailure
¢¢ 2
>
¢¢2 3%
ComputeReceiverDhSecret
¢¢4 K
(
¢¢K L
byte
££ 
[
££ 
]
££ 
?
££ &
receivedDhPublicKeyBytes
££ (
,
££( )
DhRatchetContext
§§ 
context
§§  
)
§§  !
{
•• 
if
¶¶ 

(
¶¶ 
_receivingStep
¶¶ 
==
¶¶ 
null
¶¶ "
||
¶¶# %&
receivedDhPublicKeyBytes
¶¶& >
is
¶¶? A
not
¶¶B E
{
¶¶F G
Length
¶¶H N
:
¶¶N O
	Constants
¶¶P Y
.
¶¶Y Z%
X_25519_PUBLIC_KEY_SIZE
¶¶Z q
}
¶¶r s
)
¶¶s t
{
ßß 	
return
®® 
Result
®® 
<
®® 
byte
®® 
[
®® 
]
®®  
,
®®  !%
EcliptixProtocolFailure
®®" 9
>
®®9 :
.
®®: ;
Err
®®; >
(
®®> ?%
EcliptixProtocolFailure
©© '
.
©©' (
	DeriveKey
©©( 1
(
©©1 2-
EcliptixProtocolFailureMessages
©©2 Q
.
™™ 5
'RECEIVER_RATCHET_PRE_CONDITIONS_NOT_MET
™™ <
)
™™< =
)
™™= >
;
™™> ?
}
´´ 	
Result
≠≠ 
<
≠≠ 
byte
≠≠ 
[
≠≠ 
]
≠≠ 
,
≠≠ 
SodiumFailure
≠≠ $
>
≠≠$ %"
privateKeyReadResult
≠≠& :
=
≠≠; </
!_currentSendingDhPrivateKeyHandle
ÆÆ -
!
ÆÆ- .
.
ÆÆ. /
	ReadBytes
ÆÆ/ 8
(
ÆÆ8 9
	Constants
ÆÆ9 B
.
ÆÆB C&
X_25519_PRIVATE_KEY_SIZE
ÆÆC [
)
ÆÆ[ \
;
ÆÆ\ ]
if
ØØ 

(
ØØ "
privateKeyReadResult
ØØ  
.
ØØ  !
IsErr
ØØ! &
)
ØØ& '
{
∞∞ 	
return
±± 
Result
±± 
<
±± 
byte
±± 
[
±± 
]
±±  
,
±±  !%
EcliptixProtocolFailure
±±" 9
>
±±9 :
.
±±: ;
Err
±±; >
(
±±> ?"
privateKeyReadResult
≤≤ $
.
≤≤$ %
	UnwrapErr
≤≤% .
(
≤≤. /
)
≤≤/ 0
.
≤≤0 1'
ToEcliptixProtocolFailure
≤≤1 J
(
≤≤J K
)
≤≤K L
)
≤≤L M
;
≤≤M N
}
≥≥ 	
context
µµ 
.
µµ "
LocalPrivateKeyBytes
µµ $
=
µµ% &"
privateKeyReadResult
µµ' ;
.
µµ; <
Unwrap
µµ< B
(
µµB C
)
µµC D
;
µµD E
byte
∑∑ 
[
∑∑ 
]
∑∑ 
dhSecret
∑∑ 
=
∑∑ 

ScalarMult
∑∑ $
.
∑∑$ %
Mult
∑∑% )
(
∑∑) *
context
∑∑* 1
.
∑∑1 2"
LocalPrivateKeyBytes
∑∑2 F
,
∑∑F G&
receivedDhPublicKeyBytes
∑∑H `
)
∑∑` a
;
∑∑a b
return
∏∏ 
Result
∏∏ 
<
∏∏ 
byte
∏∏ 
[
∏∏ 
]
∏∏ 
,
∏∏ %
EcliptixProtocolFailure
∏∏ 5
>
∏∏5 6
.
∏∏6 7
Ok
∏∏7 9
(
∏∏9 :
dhSecret
∏∏: B
)
∏∏B C
;
∏∏C D
}
ππ 
private
ªª 
Result
ªª 
<
ªª 
(
ªª 
byte
ªª 
[
ªª 
]
ªª 
,
ªª 
byte
ªª  
[
ªª  !
]
ªª! "
)
ªª" #
,
ªª# $%
EcliptixProtocolFailure
ªª% <
>
ªª< =
DeriveRatchetKeys
ªª> O
(
ªªO P
byte
ªªP T
[
ªªT U
]
ªªU V
dhSecret
ªªW _
)
ªª_ `
{
ºº 
Result
ΩΩ 
<
ΩΩ 
byte
ΩΩ 
[
ΩΩ 
]
ΩΩ 
,
ΩΩ 
SodiumFailure
ΩΩ $
>
ΩΩ$ %
rootKeyReadResult
ΩΩ& 7
=
ΩΩ8 9
_rootKeyHandle
ΩΩ: H
!
ΩΩH I
.
ΩΩI J
	ReadBytes
ΩΩJ S
(
ΩΩS T
	Constants
ΩΩT ]
.
ΩΩ] ^
X_25519_KEY_SIZE
ΩΩ^ n
)
ΩΩn o
;
ΩΩo p
if
ææ 

(
ææ 
rootKeyReadResult
ææ 
.
ææ 
IsErr
ææ #
)
ææ# $
{
øø 	
return
¿¿ 
Result
¿¿ 
<
¿¿ 
(
¿¿ 
byte
¿¿ 
[
¿¿  
]
¿¿  !
,
¿¿! "
byte
¿¿# '
[
¿¿' (
]
¿¿( )
)
¿¿) *
,
¿¿* +%
EcliptixProtocolFailure
¿¿, C
>
¿¿C D
.
¿¿D E
Err
¿¿E H
(
¿¿H I
rootKeyReadResult
¡¡ !
.
¡¡! "
	UnwrapErr
¡¡" +
(
¡¡+ ,
)
¡¡, -
.
¡¡- .'
ToEcliptixProtocolFailure
¡¡. G
(
¡¡G H
)
¡¡H I
)
¡¡I J
;
¡¡J K
}
¬¬ 	
byte
ƒƒ 
[
ƒƒ 
]
ƒƒ 
currentRootKey
ƒƒ 
=
ƒƒ 
rootKeyReadResult
ƒƒ  1
.
ƒƒ1 2
Unwrap
ƒƒ2 8
(
ƒƒ8 9
)
ƒƒ9 :
;
ƒƒ: ;
try
∆∆ 
{
«« 	
using
»» 
SecurePooledArray
»» #
<
»»# $
byte
»»$ (
>
»»( )
hkdfOutputBuffer
»»* :
=
»»; <
SecureArrayPool
…… 
.
……  
Rent
……  $
<
……$ %
byte
……% )
>
……) *
(
……* +
	Constants
……+ 4
.
……4 5
X_25519_KEY_SIZE
……5 E
*
……F G%
ProtocolSystemConstants
  + B
.
  B C
Protocol
  C K
.
  K L+
HKDF_OUTPUT_BUFFER_MULTIPLIER
  L i
)
  i j
;
  j k
Span
ÀÀ 
<
ÀÀ 
byte
ÀÀ 
>
ÀÀ 
hkdfOutputSpan
ÀÀ %
=
ÀÀ& '
hkdfOutputBuffer
ÀÀ( 8
.
ÀÀ8 9
AsSpan
ÀÀ9 ?
(
ÀÀ? @
)
ÀÀ@ A
;
ÀÀA B
HKDF
ÕÕ 
.
ÕÕ 
	DeriveKey
ÕÕ 
(
ÕÕ 
HashAlgorithmName
ŒŒ !
.
ŒŒ! "
SHA256
ŒŒ" (
,
ŒŒ( )
ikm
œœ 
:
œœ 
dhSecret
œœ 
,
œœ 
output
–– 
:
–– 
hkdfOutputSpan
–– &
,
––& '
salt
—— 
:
—— 
currentRootKey
—— $
,
——$ %
info
““ 
:
““ 
DhRatchetInfo
““ #
)
”” 
;
”” 
byte
’’ 
[
’’ 
]
’’ 

newRootKey
’’ 
=
’’ 
hkdfOutputSpan
’’  .
[
’’. /
..
’’/ 1
	Constants
’’1 :
.
’’: ;
X_25519_KEY_SIZE
’’; K
]
’’K L
.
’’L M
ToArray
’’M T
(
’’T U
)
’’U V
;
’’V W
byte
÷÷ 
[
÷÷ 
]
÷÷ 
newChainKey
÷÷ 
=
÷÷  
hkdfOutputSpan
÷÷! /
[
÷÷/ 0
	Constants
÷÷0 9
.
÷÷9 :
X_25519_KEY_SIZE
÷÷: J
..
÷÷J L
]
÷÷L M
.
÷÷M N
ToArray
÷÷N U
(
÷÷U V
)
÷÷V W
;
÷÷W X
return
ÿÿ 
Result
ÿÿ 
<
ÿÿ 
(
ÿÿ 
byte
ÿÿ 
[
ÿÿ  
]
ÿÿ  !
,
ÿÿ! "
byte
ÿÿ# '
[
ÿÿ' (
]
ÿÿ( )
)
ÿÿ) *
,
ÿÿ* +%
EcliptixProtocolFailure
ÿÿ, C
>
ÿÿC D
.
ÿÿD E
Ok
ÿÿE G
(
ÿÿG H
(
ÿÿH I

newRootKey
ÿÿI S
,
ÿÿS T
newChainKey
ÿÿU `
)
ÿÿ` a
)
ÿÿa b
;
ÿÿb c
}
ŸŸ 	
finally
⁄⁄ 
{
€€ 	
SodiumInterop
‹‹ 
.
‹‹ 

SecureWipe
‹‹ $
(
‹‹$ %
currentRootKey
‹‹% 3
)
‹‹3 4
;
‹‹4 5
}
›› 	
}
ﬁﬁ 
private
‡‡ 
Result
‡‡ 
<
‡‡ 
Unit
‡‡ 
,
‡‡ %
EcliptixProtocolFailure
‡‡ 0
>
‡‡0 1)
UpdateChainStepAfterRatchet
‡‡2 M
(
‡‡M N
bool
·· 
isSender
·· 
,
·· 
DhRatchetContext
‚‚ 
context
‚‚  
,
‚‚  !
byte
„„ 
[
„„ 
]
„„ 
?
„„ &
receivedDhPublicKeyBytes
„„ (
)
„„( )
{
‰‰ 
return
ÂÂ 
isSender
ÂÂ 
?
ÊÊ $
UpdateSendingChainStep
ÊÊ $
(
ÊÊ$ %
context
ÊÊ% ,
)
ÊÊ, -
:
ÁÁ &
UpdateReceivingChainStep
ÁÁ &
(
ÁÁ& '
context
ÁÁ' .
,
ÁÁ. /&
receivedDhPublicKeyBytes
ÁÁ0 H
)
ÁÁH I
;
ÁÁI J
}
ËË 
private
ÍÍ 
Result
ÍÍ 
<
ÍÍ 
Unit
ÍÍ 
,
ÍÍ %
EcliptixProtocolFailure
ÍÍ 0
>
ÍÍ0 1$
UpdateSendingChainStep
ÍÍ2 H
(
ÍÍH I
DhRatchetContext
ÍÍI Y
context
ÍÍZ a
)
ÍÍa b
{
ÎÎ 
Result
ÏÏ 
<
ÏÏ 
byte
ÏÏ 
[
ÏÏ 
]
ÏÏ 
,
ÏÏ 
SodiumFailure
ÏÏ $
>
ÏÏ$ %#
newDhPrivateKeyResult
ÏÏ& ;
=
ÏÏ< =
context
ÌÌ 
.
ÌÌ "
NewEphemeralSkHandle
ÌÌ (
!
ÌÌ( )
.
ÌÌ) *
	ReadBytes
ÌÌ* 3
(
ÌÌ3 4
	Constants
ÌÌ4 =
.
ÌÌ= >&
X_25519_PRIVATE_KEY_SIZE
ÌÌ> V
)
ÌÌV W
;
ÌÌW X
if
ÓÓ 

(
ÓÓ #
newDhPrivateKeyResult
ÓÓ !
.
ÓÓ! "
IsErr
ÓÓ" '
)
ÓÓ' (
{
ÔÔ 	
return
 
Result
 
<
 
Unit
 
,
 %
EcliptixProtocolFailure
  7
>
7 8
.
8 9
Err
9 <
(
< =#
newDhPrivateKeyResult
ÒÒ %
.
ÒÒ% &
	UnwrapErr
ÒÒ& /
(
ÒÒ/ 0
)
ÒÒ0 1
.
ÒÒ1 2'
ToEcliptixProtocolFailure
ÒÒ2 K
(
ÒÒK L
)
ÒÒL M
)
ÒÒM N
;
ÒÒN O
}
ÚÚ 	
context
ÙÙ 
.
ÙÙ "
NewDhPrivateKeyBytes
ÙÙ $
=
ÙÙ% &#
newDhPrivateKeyResult
ÙÙ' <
.
ÙÙ< =
Unwrap
ÙÙ= C
(
ÙÙC D
)
ÙÙD E
;
ÙÙE F/
!_currentSendingDhPrivateKeyHandle
ˆˆ )
?
ˆˆ) *
.
ˆˆ* +
Dispose
ˆˆ+ 2
(
ˆˆ2 3
)
ˆˆ3 4
;
ˆˆ4 5/
!_currentSendingDhPrivateKeyHandle
˜˜ )
=
˜˜* +
context
˜˜, 3
.
˜˜3 4"
NewEphemeralSkHandle
˜˜4 H
;
˜˜H I
context
¯¯ 
.
¯¯ "
NewEphemeralSkHandle
¯¯ $
=
¯¯% &
null
¯¯' +
;
¯¯+ ,
return
˙˙ 
_sendingStep
˙˙ 
.
˙˙ &
UpdateKeysAfterDhRatchet
˙˙ 4
(
˙˙4 5
context
˚˚ 
.
˚˚ 
NewChainKey
˚˚ 
!
˚˚  
,
˚˚  !
context
¸¸ 
.
¸¸ "
NewDhPrivateKeyBytes
¸¸ (
,
¸¸( )
context
˝˝ 
.
˝˝ #
NewEphemeralPublicKey
˝˝ )
)
˝˝) *
;
˝˝* +
}
˛˛ 
private
ÄÄ 
Result
ÄÄ 
<
ÄÄ 
Unit
ÄÄ 
,
ÄÄ %
EcliptixProtocolFailure
ÄÄ 0
>
ÄÄ0 1&
UpdateReceivingChainStep
ÄÄ2 J
(
ÄÄJ K
DhRatchetContext
ÅÅ 
context
ÅÅ  
,
ÅÅ  !
byte
ÇÇ 
[
ÇÇ 
]
ÇÇ 
?
ÇÇ &
receivedDhPublicKeyBytes
ÇÇ (
)
ÇÇ( )
{
ÉÉ 
Result
ÑÑ 
<
ÑÑ 
Unit
ÑÑ 
,
ÑÑ %
EcliptixProtocolFailure
ÑÑ ,
>
ÑÑ, -
updateResult
ÑÑ. :
=
ÑÑ; <
_receivingStep
ÖÖ 
!
ÖÖ 
.
ÖÖ &
UpdateKeysAfterDhRatchet
ÖÖ 4
(
ÖÖ4 5
context
ÖÖ5 <
.
ÖÖ< =
NewChainKey
ÖÖ= H
!
ÖÖH I
)
ÖÖI J
;
ÖÖJ K
if
áá 

(
áá 
updateResult
áá 
.
áá 
IsOk
áá 
)
áá 
{
àà 	
WipeIfNotNull
ââ 
(
ââ 
_peerDhPublicKey
ââ *
)
ââ* +
;
ââ+ ,
_peerDhPublicKey
ää 
=
ää 
(
ää  
byte
ää  $
[
ää$ %
]
ää% &
)
ää& '&
receivedDhPublicKeyBytes
ää' ?
!
ää? @
.
ää@ A
Clone
ääA F
(
ääF G
)
ääG H
;
ääH I
}
ãã 	
return
çç 
updateResult
çç 
;
çç 
}
éé 
private
êê 
void
êê 
FinalizeRatchet
êê  
(
êê  !
)
êê! "
{
ëë 
_replayProtection
íí 
.
íí 
OnRatchetRotation
íí +
(
íí+ ,
)
íí, -
;
íí- .
_receivedNewDhKey
ìì 
=
ìì 
false
ìì !
;
ìì! "
Interlocked
îî 
.
îî 
Exchange
îî 
(
îî 
ref
îî  #
_lastRatchetTimeTicks
îî! 6
,
îî6 7
DateTime
îî8 @
.
îî@ A
UtcNow
îîA G
.
îîG H
Ticks
îîH M
)
îîM N
;
îîN O
Result
ññ 
<
ññ 
Unit
ññ 
,
ññ %
EcliptixProtocolFailure
ññ ,
>
ññ, -
metadataKeyResult
ññ. ?
=
ññ@ A)
DeriveMetadataEncryptionKey
ññB ]
(
ññ] ^
)
ññ^ _
;
ññ_ `
if
óó 

(
óó 
metadataKeyResult
óó 
.
óó 
IsErr
óó #
)
óó# $
{
òò 	
return
ôô 
;
ôô 
}
öö 	
_eventHandler
úú 
?
úú 
.
úú $
OnProtocolStateChanged
úú -
(
úú- .
_id
úú. 1
)
úú1 2
;
úú2 3
}
ùù 
private
üü 
sealed
üü 
class
üü 
DhRatchetContext
üü )
:
üü* +
IDisposable
üü, 7
{
†† 
public
°° 
byte
°° 
[
°° 
]
°° 
?
°° 
DhSecret
°° 
;
°°  
public
¢¢ 
byte
¢¢ 
[
¢¢ 
]
¢¢ 
?
¢¢ 

NewRootKey
¢¢ !
;
¢¢! "
public
££ 
byte
££ 
[
££ 
]
££ 
?
££ 
NewChainKey
££ "
;
££" #
public
§§ 
byte
§§ 
[
§§ 
]
§§ 
?
§§ #
NewEphemeralPublicKey
§§ ,
;
§§, -
public
•• 
byte
•• 
[
•• 
]
•• 
?
•• "
LocalPrivateKeyBytes
•• +
;
••+ ,
public
¶¶ 
byte
¶¶ 
[
¶¶ 
]
¶¶ 
?
¶¶ "
NewDhPrivateKeyBytes
¶¶ +
;
¶¶+ ,
public
ßß &
SodiumSecureMemoryHandle
ßß '
?
ßß' ("
NewEphemeralSkHandle
ßß) =
;
ßß= >
public
©© 
void
©© 
Dispose
©© 
(
©© 
)
©© 
{
™™ 	
WipeIfNotNull
´´ 
(
´´ 
DhSecret
´´ "
)
´´" #
;
´´# $
WipeIfNotNull
¨¨ 
(
¨¨ 

NewRootKey
¨¨ $
)
¨¨$ %
;
¨¨% &
WipeIfNotNull
≠≠ 
(
≠≠ 
NewChainKey
≠≠ %
)
≠≠% &
;
≠≠& '
WipeIfNotNull
ÆÆ 
(
ÆÆ #
NewEphemeralPublicKey
ÆÆ /
)
ÆÆ/ 0
;
ÆÆ0 1
WipeIfNotNull
ØØ 
(
ØØ "
LocalPrivateKeyBytes
ØØ .
)
ØØ. /
;
ØØ/ 0
WipeIfNotNull
∞∞ 
(
∞∞ "
NewDhPrivateKeyBytes
∞∞ .
)
∞∞. /
;
∞∞/ 0"
NewEphemeralSkHandle
±±  
?
±±  !
.
±±! "
Dispose
±±" )
(
±±) *
)
±±* +
;
±±+ ,
}
≤≤ 	
}
ªª 
internal
ΩΩ 
Result
ΩΩ 
<
ΩΩ 
byte
ΩΩ 
[
ΩΩ 
]
ΩΩ 
,
ΩΩ %
EcliptixProtocolFailure
ΩΩ 3
>
ΩΩ3 4
GenerateNextNonce
ΩΩ5 F
(
ΩΩF G
)
ΩΩG H
{
ææ 
if
øø 

(
øø 
	_disposed
øø 
)
øø 
{
¿¿ 	
return
¡¡ 
Result
¡¡ 
<
¡¡ 
byte
¡¡ 
[
¡¡ 
]
¡¡  
,
¡¡  !%
EcliptixProtocolFailure
¡¡" 9
>
¡¡9 :
.
¡¡: ;
Err
¡¡; >
(
¡¡> ?%
EcliptixProtocolFailure
¬¬ '
.
¬¬' (
OBJECT_DISPOSED
¬¬( 7
(
¬¬7 8
nameof
¬¬8 >
(
¬¬> ?(
EcliptixProtocolConnection
¬¬? Y
)
¬¬Y Z
)
¬¬Z [
)
¬¬[ \
;
¬¬\ ]
}
√√ 	
long
≈≈ 
currentCounter
≈≈ 
=
≈≈ 
Volatile
≈≈ &
.
≈≈& '
Read
≈≈' +
(
≈≈+ ,
ref
≈≈, /
_nonceCounter
≈≈0 =
)
≈≈= >
;
≈≈> ?
if
∆∆ 

(
∆∆ 
currentCounter
∆∆ 
>=
∆∆ %
ProtocolSystemConstants
∆∆ 5
.
∆∆5 6
Protocol
∆∆6 >
.
∆∆> ?
MAX_NONCE_COUNTER
∆∆? P
)
∆∆P Q
{
«« 	
return
»» 
Result
»» 
<
»» 
byte
»» 
[
»» 
]
»»  
,
»»  !%
EcliptixProtocolFailure
»»" 9
>
»»9 :
.
»»: ;
Err
»»; >
(
»»> ?%
EcliptixProtocolFailure
…… '
.
……' (
Generic
……( /
(
……/ 0-
EcliptixProtocolFailureMessages
……0 O
.
……O P$
NONCE_COUNTER_OVERFLOW
……P f
)
……f g
)
……g h
;
……h i
}
   	
using
ÃÃ 
SecurePooledArray
ÃÃ 
<
ÃÃ  
byte
ÃÃ  $
>
ÃÃ$ %
pooledNonce
ÃÃ& 1
=
ÃÃ2 3
SecureArrayPool
ÃÃ4 C
.
ÃÃC D
Rent
ÃÃD H
<
ÃÃH I
byte
ÃÃI M
>
ÃÃM N
(
ÃÃN O
	Constants
ÃÃO X
.
ÃÃX Y 
AES_GCM_NONCE_SIZE
ÃÃY k
)
ÃÃk l
;
ÃÃl m
Span
ÕÕ 
<
ÕÕ 
byte
ÕÕ 
>
ÕÕ 
nonceBuffer
ÕÕ 
=
ÕÕ  
pooledNonce
ÕÕ! ,
.
ÕÕ, -
AsSpan
ÕÕ- 3
(
ÕÕ3 4
)
ÕÕ4 5
;
ÕÕ5 6#
RandomNumberGenerator
œœ 
.
œœ 
Fill
œœ "
(
œœ" #
nonceBuffer
œœ# .
[
œœ. /
..
œœ/ 1%
ProtocolSystemConstants
œœ1 H
.
œœH I
Protocol
œœI Q
.
œœQ R&
RANDOM_NONCE_PREFIX_SIZE
œœR j
]
œœj k
)
œœk l
;
œœl m
long
–– 
nextCounter
–– 
=
–– 
Interlocked
–– &
.
––& '
	Increment
––' 0
(
––0 1
ref
––1 4
_nonceCounter
––5 B
)
––B C
;
––C D
if
—— 

(
—— 
nextCounter
—— 
>
—— %
ProtocolSystemConstants
—— 1
.
——1 2
Protocol
——2 :
.
——: ;
MAX_NONCE_COUNTER
——; L
)
——L M
{
““ 	
return
”” 
Result
”” 
<
”” 
byte
”” 
[
”” 
]
””  
,
””  !%
EcliptixProtocolFailure
””" 9
>
””9 :
.
””: ;
Err
””; >
(
””> ?%
EcliptixProtocolFailure
‘‘ '
.
‘‘' (
Generic
‘‘( /
(
‘‘/ 0-
EcliptixProtocolFailureMessages
‘‘0 O
.
‘‘O P$
NONCE_COUNTER_OVERFLOW
‘‘P f
)
‘‘f g
)
‘‘g h
;
‘‘h i
}
’’ 	
uint
◊◊ 
currentNonce
◊◊ 
=
◊◊ 
(
◊◊ 
uint
◊◊ !
)
◊◊! "
nextCounter
◊◊" -
;
◊◊- .
BinaryPrimitives
ÿÿ 
.
ÿÿ %
WriteUInt32LittleEndian
ÿÿ 0
(
ÿÿ0 1
nonceBuffer
ÿÿ1 <
[
ÿÿ< =
	Constants
ÿÿ= F
.
ÿÿF G+
U_INT_32_LITTLE_ENDIAN_OFFSET
ÿÿG d
..
ÿÿd f
]
ÿÿf g
,
ÿÿg h
currentNonce
ÿÿi u
)
ÿÿu v
;
ÿÿv w
return
⁄⁄ 
Result
⁄⁄ 
<
⁄⁄ 
byte
⁄⁄ 
[
⁄⁄ 
]
⁄⁄ 
,
⁄⁄ %
EcliptixProtocolFailure
⁄⁄ 5
>
⁄⁄5 6
.
⁄⁄6 7
Ok
⁄⁄7 9
(
⁄⁄9 :
nonceBuffer
⁄⁄: E
.
⁄⁄E F
ToArray
⁄⁄F M
(
⁄⁄M N
)
⁄⁄N O
)
⁄⁄O P
;
⁄⁄P Q
}
€€ 
public
›› 

Result
›› 
<
›› 
byte
›› 
[
›› 
]
›› 
?
›› 
,
›› %
EcliptixProtocolFailure
›› 2
>
››2 3'
GetCurrentPeerDhPublicKey
››4 M
(
››M N
)
››N O
{
ﬁﬁ 
lock
ﬂﬂ 
(
ﬂﬂ 
_lock
ﬂﬂ 
)
ﬂﬂ 
{
‡‡ 	
Result
·· 
<
·· 
Unit
·· 
,
·· %
EcliptixProtocolFailure
·· 0
>
··0 1
disposedCheck
··2 ?
=
··@ A
CheckDisposed
··B O
(
··O P
)
··P Q
;
··Q R
if
‚‚ 
(
‚‚ 
disposedCheck
‚‚ 
.
‚‚ 
IsErr
‚‚ #
)
‚‚# $
{
„„ 
return
‰‰ 
Result
‰‰ 
<
‰‰ 
byte
‰‰ "
[
‰‰" #
]
‰‰# $
?
‰‰$ %
,
‰‰% &%
EcliptixProtocolFailure
‰‰' >
>
‰‰> ?
.
‰‰? @
Err
‰‰@ C
(
‰‰C D
disposedCheck
‰‰D Q
.
‰‰Q R
	UnwrapErr
‰‰R [
(
‰‰[ \
)
‰‰\ ]
)
‰‰] ^
;
‰‰^ _
}
ÂÂ 
byte
ÁÁ 
[
ÁÁ 
]
ÁÁ 
?
ÁÁ 
result
ÁÁ 
=
ÁÁ 
_peerDhPublicKey
ÁÁ -
!=
ÁÁ. 0
null
ÁÁ1 5
?
ÁÁ6 7
(
ÁÁ8 9
byte
ÁÁ9 =
[
ÁÁ= >
]
ÁÁ> ?
)
ÁÁ? @
_peerDhPublicKey
ÁÁ@ P
.
ÁÁP Q
Clone
ÁÁQ V
(
ÁÁV W
)
ÁÁW X
:
ÁÁY Z
null
ÁÁ[ _
;
ÁÁ_ `
return
ËË 
Result
ËË 
<
ËË 
byte
ËË 
[
ËË 
]
ËË  
?
ËË  !
,
ËË! "%
EcliptixProtocolFailure
ËË# :
>
ËË: ;
.
ËË; <
Ok
ËË< >
(
ËË> ?
result
ËË? E
)
ËËE F
;
ËËF G
}
ÈÈ 	
}
ÍÍ 
public
ÏÏ 

Result
ÏÏ 
<
ÏÏ 
byte
ÏÏ 
[
ÏÏ 
]
ÏÏ 
?
ÏÏ 
,
ÏÏ %
EcliptixProtocolFailure
ÏÏ 2
>
ÏÏ2 3)
GetCurrentSenderDhPublicKey
ÏÏ4 O
(
ÏÏO P
)
ÏÏP Q
{
ÌÌ 
lock
ÓÓ 
(
ÓÓ 
_lock
ÓÓ 
)
ÓÓ 
{
ÔÔ 	
Result
 
<
 
Unit
 
,
 %
EcliptixProtocolFailure
 0
>
0 1
disposedCheck
2 ?
=
@ A
CheckDisposed
B O
(
O P
)
P Q
;
Q R
if
ÒÒ 
(
ÒÒ 
disposedCheck
ÒÒ 
.
ÒÒ 
IsErr
ÒÒ #
)
ÒÒ# $
{
ÚÚ 
return
ÛÛ 
Result
ÛÛ 
<
ÛÛ 
byte
ÛÛ "
[
ÛÛ" #
]
ÛÛ# $
?
ÛÛ$ %
,
ÛÛ% &%
EcliptixProtocolFailure
ÛÛ' >
>
ÛÛ> ?
.
ÛÛ? @
Err
ÛÛ@ C
(
ÛÛC D
disposedCheck
ÛÛD Q
.
ÛÛQ R
	UnwrapErr
ÛÛR [
(
ÛÛ[ \
)
ÛÛ\ ]
)
ÛÛ] ^
;
ÛÛ^ _
}
ÙÙ 
Result
ˆˆ 
<
ˆˆ '
EcliptixProtocolChainStep
ˆˆ ,
,
ˆˆ, -%
EcliptixProtocolFailure
ˆˆ. E
>
ˆˆE F

stepResult
ˆˆG Q
=
ˆˆR S*
EnsureSendingStepInitialized
ˆˆT p
(
ˆˆp q
)
ˆˆq r
;
ˆˆr s
if
˜˜ 
(
˜˜ 

stepResult
˜˜ 
.
˜˜ 
IsErr
˜˜  
)
˜˜  !
{
¯¯ 
return
˘˘ 
Result
˘˘ 
<
˘˘ 
byte
˘˘ "
[
˘˘" #
]
˘˘# $
?
˘˘$ %
,
˘˘% &%
EcliptixProtocolFailure
˘˘' >
>
˘˘> ?
.
˘˘? @
Err
˘˘@ C
(
˘˘C D

stepResult
˘˘D N
.
˘˘N O
	UnwrapErr
˘˘O X
(
˘˘X Y
)
˘˘Y Z
)
˘˘Z [
;
˘˘[ \
}
˙˙ 
Result
¸¸ 
<
¸¸ 
byte
¸¸ 
[
¸¸ 
]
¸¸ 
?
¸¸ 
,
¸¸ %
EcliptixProtocolFailure
¸¸ 3
>
¸¸3 4
	keyResult
¸¸5 >
=
¸¸? @

stepResult
¸¸A K
.
¸¸K L
Unwrap
¸¸L R
(
¸¸R S
)
¸¸S T
.
¸¸T U
ReadDhPublicKey
¸¸U d
(
¸¸d e
)
¸¸e f
;
¸¸f g
return
˛˛ 
	keyResult
˛˛ 
;
˛˛ 
}
ˇˇ 	
}
Ä	Ä	 
private
Ç	Ç	 
Result
Ç	Ç	 
<
Ç	Ç	 
Unit
Ç	Ç	 
,
Ç	Ç	 %
EcliptixProtocolFailure
Ç	Ç	 0
>
Ç	Ç	0 1)
DeriveMetadataEncryptionKey
Ç	Ç	2 M
(
Ç	Ç	M N
)
Ç	Ç	N O
{
É	É	 
if
Ñ	Ñ	 

(
Ñ	Ñ	 
_rootKeyHandle
Ñ	Ñ	 
is
Ñ	Ñ	 
not
Ñ	Ñ	 !
{
Ñ	Ñ	" #
	IsInvalid
Ñ	Ñ	$ -
:
Ñ	Ñ	- .
false
Ñ	Ñ	/ 4
}
Ñ	Ñ	5 6
)
Ñ	Ñ	6 7
{
Ö	Ö	 	
return
Ü	Ü	 
Result
Ü	Ü	 
<
Ü	Ü	 
Unit
Ü	Ü	 
,
Ü	Ü	 %
EcliptixProtocolFailure
Ü	Ü	  7
>
Ü	Ü	7 8
.
Ü	Ü	8 9
Err
Ü	Ü	9 <
(
Ü	Ü	< =%
EcliptixProtocolFailure
á	á	 '
.
á	á	' (
Generic
á	á	( /
(
á	á	/ 0
$str
á	á	0 m
)
á	á	m n
)
á	á	n o
;
á	á	o p
}
à	à	 	
byte
ä	ä	 
[
ä	ä	 
]
ä	ä	 
?
ä	ä	 
rootKeyBytes
ä	ä	 
=
ä	ä	 
null
ä	ä	 #
;
ä	ä	# $
byte
ã	ã	 
[
ã	ã	 
]
ã	ã	 
?
ã	ã	 
metadataKeyBytes
ã	ã	  
=
ã	ã	! "
null
ã	ã	# '
;
ã	ã	' (
try
å	å	 
{
ç	ç	 	
Result
é	é	 
<
é	é	 
byte
é	é	 
[
é	é	 
]
é	é	 
,
é	é	 
SodiumFailure
é	é	 (
>
é	é	( )

readResult
é	é	* 4
=
é	é	5 6
_rootKeyHandle
è	è	 
.
è	è	 
	ReadBytes
è	è	 (
(
è	è	( )
	Constants
è	è	) 2
.
è	è	2 3
X_25519_KEY_SIZE
è	è	3 C
)
è	è	C D
;
è	è	D E
if
ê	ê	 
(
ê	ê	 

readResult
ê	ê	 
.
ê	ê	 
IsErr
ê	ê	  
)
ê	ê	  !
{
ë	ë	 
return
í	í	 
Result
í	í	 
<
í	í	 
Unit
í	í	 "
,
í	í	" #%
EcliptixProtocolFailure
í	í	$ ;
>
í	í	; <
.
í	í	< =
Err
í	í	= @
(
í	í	@ A

readResult
í	í	A K
.
í	í	K L
	UnwrapErr
í	í	L U
(
í	í	U V
)
í	í	V W
.
í	í	W X'
ToEcliptixProtocolFailure
í	í	X q
(
í	í	q r
)
í	í	r s
)
í	í	s t
;
í	í	t u
}
ì	ì	 
rootKeyBytes
ï	ï	 
=
ï	ï	 

readResult
ï	ï	 %
.
ï	ï	% &
Unwrap
ï	ï	& ,
(
ï	ï	, -
)
ï	ï	- .
;
ï	ï	. /
metadataKeyBytes
ó	ó	 
=
ó	ó	 
new
ó	ó	 "
byte
ó	ó	# '
[
ó	ó	' (
	Constants
ó	ó	( 1
.
ó	ó	1 2
AES_KEY_SIZE
ó	ó	2 >
]
ó	ó	> ?
;
ó	ó	? @
ReadOnlySpan
ò	ò	 
<
ò	ò	 
byte
ò	ò	 
>
ò	ò	 
info
ò	ò	 #
=
ò	ò	$ %
Encoding
ò	ò	& .
.
ò	ò	. /
UTF8
ò	ò	/ 3
.
ò	ò	3 4
GetBytes
ò	ò	4 <
(
ò	ò	< =
$str
ò	ò	= S
)
ò	ò	S T
;
ò	ò	T U
HKDF
ö	ö	 
.
ö	ö	 
	DeriveKey
ö	ö	 
(
ö	ö	 
HashAlgorithmName
õ	õ	 !
.
õ	õ	! "
SHA256
õ	õ	" (
,
õ	õ	( )
ikm
ú	ú	 
:
ú	ú	 
rootKeyBytes
ú	ú	 !
,
ú	ú	! "
output
ù	ù	 
:
ù	ù	 
metadataKeyBytes
ù	ù	 (
.
ù	ù	( )
AsSpan
ù	ù	) /
(
ù	ù	/ 0
)
ù	ù	0 1
,
ù	ù	1 2
salt
û	û	 
:
û	û	 
null
û	û	 
,
û	û	 
info
ü	ü	 
:
ü	ü	 
info
ü	ü	 
)
†	†	 
;
†	†	 *
_metadataEncryptionKeyHandle
¢	¢	 (
?
¢	¢	( )
.
¢	¢	) *
Dispose
¢	¢	* 1
(
¢	¢	1 2
)
¢	¢	2 3
;
¢	¢	3 4
Result
£	£	 
<
£	£	 &
SodiumSecureMemoryHandle
£	£	 +
,
£	£	+ ,
SodiumFailure
£	£	- :
>
£	£	: ;
allocResult
£	£	< G
=
£	£	H I&
SodiumSecureMemoryHandle
§	§	 (
.
§	§	( )
Allocate
§	§	) 1
(
§	§	1 2
	Constants
§	§	2 ;
.
§	§	; <
AES_KEY_SIZE
§	§	< H
)
§	§	H I
;
§	§	I J
if
•	•	 
(
•	•	 
allocResult
•	•	 
.
•	•	 
IsErr
•	•	 !
)
•	•	! "
{
¶	¶	 
return
ß	ß	 
Result
ß	ß	 
<
ß	ß	 
Unit
ß	ß	 "
,
ß	ß	" #%
EcliptixProtocolFailure
ß	ß	$ ;
>
ß	ß	; <
.
ß	ß	< =
Err
ß	ß	= @
(
ß	ß	@ A
allocResult
ß	ß	A L
.
ß	ß	L M
	UnwrapErr
ß	ß	M V
(
ß	ß	V W
)
ß	ß	W X
.
ß	ß	X Y'
ToEcliptixProtocolFailure
ß	ß	Y r
(
ß	ß	r s
)
ß	ß	s t
)
ß	ß	t u
;
ß	ß	u v
}
®	®	 *
_metadataEncryptionKeyHandle
™	™	 (
=
™	™	) *
allocResult
™	™	+ 6
.
™	™	6 7
Unwrap
™	™	7 =
(
™	™	= >
)
™	™	> ?
;
™	™	? @
Result
´	´	 
<
´	´	 
Unit
´	´	 
,
´	´	 
SodiumFailure
´	´	 &
>
´	´	& '
writeResult
´	´	( 3
=
´	´	4 5*
_metadataEncryptionKeyHandle
´	´	6 R
.
´	´	R S
Write
´	´	S X
(
´	´	X Y
metadataKeyBytes
´	´	Y i
)
´	´	i j
;
´	´	j k
if
¨	¨	 
(
¨	¨	 
writeResult
¨	¨	 
.
¨	¨	 
IsErr
¨	¨	 !
)
¨	¨	! "
{
≠	≠	 
return
Æ	Æ	 
Result
Æ	Æ	 
<
Æ	Æ	 
Unit
Æ	Æ	 "
,
Æ	Æ	" #%
EcliptixProtocolFailure
Æ	Æ	$ ;
>
Æ	Æ	; <
.
Æ	Æ	< =
Err
Æ	Æ	= @
(
Æ	Æ	@ A
writeResult
Æ	Æ	A L
.
Æ	Æ	L M
	UnwrapErr
Æ	Æ	M V
(
Æ	Æ	V W
)
Æ	Æ	W X
.
Æ	Æ	X Y'
ToEcliptixProtocolFailure
Æ	Æ	Y r
(
Æ	Æ	r s
)
Æ	Æ	s t
)
Æ	Æ	t u
;
Æ	Æ	u v
}
Ø	Ø	 
return
±	±	 
Result
±	±	 
<
±	±	 
Unit
±	±	 
,
±	±	 %
EcliptixProtocolFailure
±	±	  7
>
±	±	7 8
.
±	±	8 9
Ok
±	±	9 ;
(
±	±	; <
Unit
±	±	< @
.
±	±	@ A
Value
±	±	A F
)
±	±	F G
;
±	±	G H
}
≤	≤	 	
catch
≥	≥	 
(
≥	≥	 
	Exception
≥	≥	 
ex
≥	≥	 
)
≥	≥	 
{
¥	¥	 	
return
µ	µ	 
Result
µ	µ	 
<
µ	µ	 
Unit
µ	µ	 
,
µ	µ	 %
EcliptixProtocolFailure
µ	µ	  7
>
µ	µ	7 8
.
µ	µ	8 9
Err
µ	µ	9 <
(
µ	µ	< =%
EcliptixProtocolFailure
∂	∂	 '
.
∂	∂	' (
	DeriveKey
∂	∂	( 1
(
∂	∂	1 2
$str
∂	∂	2 \
,
∂	∂	\ ]
ex
∂	∂	^ `
)
∂	∂	` a
)
∂	∂	a b
;
∂	∂	b c
}
∑	∑	 	
finally
∏	∏	 
{
π	π	 	
if
∫	∫	 
(
∫	∫	 
rootKeyBytes
∫	∫	 
!=
∫	∫	 
null
∫	∫	  $
)
∫	∫	$ %
{
ª	ª	 
SodiumInterop
º	º	 
.
º	º	 

SecureWipe
º	º	 (
(
º	º	( )
rootKeyBytes
º	º	) 5
)
º	º	5 6
;
º	º	6 7
}
Ω	Ω	 
if
ø	ø	 
(
ø	ø	 
metadataKeyBytes
ø	ø	  
!=
ø	ø	! #
null
ø	ø	$ (
)
ø	ø	( )
{
¿	¿	 
SodiumInterop
¡	¡	 
.
¡	¡	 

SecureWipe
¡	¡	 (
(
¡	¡	( )
metadataKeyBytes
¡	¡	) 9
)
¡	¡	9 :
;
¡	¡	: ;
}
¬	¬	 
}
√	√	 	
}
ƒ	ƒ	 
public
∆	∆	 

Result
∆	∆	 
<
∆	∆	 
byte
∆	∆	 
[
∆	∆	 
]
∆	∆	 
,
∆	∆	 %
EcliptixProtocolFailure
∆	∆	 1
>
∆	∆	1 2&
GetMetadataEncryptionKey
∆	∆	3 K
(
∆	∆	K L
)
∆	∆	L M
{
«	«	 
if
»	»	 

(
»	»	 *
_metadataEncryptionKeyHandle
»	»	 (
is
»	»	) +
not
»	»	, /
{
»	»	0 1
	IsInvalid
»	»	2 ;
:
»	»	; <
false
»	»	= B
}
»	»	C D
)
»	»	D E
{
…	…	 	
return
 	 	 
Result
 	 	 
<
 	 	 
byte
 	 	 
[
 	 	 
]
 	 	  
,
 	 	  !%
EcliptixProtocolFailure
 	 	" 9
>
 	 	9 :
.
 	 	: ;
Err
 	 	; >
(
 	 	> ?%
EcliptixProtocolFailure
À	À	 '
.
À	À	' (
Generic
À	À	( /
(
À	À	/ 0
$str
À	À	0 Y
)
À	À	Y Z
)
À	À	Z [
;
À	À	[ \
}
Ã	Ã	 	
Result
Œ	Œ	 
<
Œ	Œ	 
byte
Œ	Œ	 
[
Œ	Œ	 
]
Œ	Œ	 
,
Œ	Œ	 
SodiumFailure
Œ	Œ	 $
>
Œ	Œ	$ %

readResult
Œ	Œ	& 0
=
Œ	Œ	1 2*
_metadataEncryptionKeyHandle
Œ	Œ	3 O
.
Œ	Œ	O P
	ReadBytes
Œ	Œ	P Y
(
Œ	Œ	Y Z
	Constants
Œ	Œ	Z c
.
Œ	Œ	c d
AES_KEY_SIZE
Œ	Œ	d p
)
Œ	Œ	p q
;
Œ	Œ	q r
return
œ	œ	 

readResult
œ	œ	 
.
œ	œ	 
IsOk
œ	œ	 
?
–	–	 
Result
–	–	 
<
–	–	 
byte
–	–	 
[
–	–	 
]
–	–	 
,
–	–	 %
EcliptixProtocolFailure
–	–	 4
>
–	–	4 5
.
–	–	5 6
Ok
–	–	6 8
(
–	–	8 9

readResult
–	–	9 C
.
–	–	C D
Unwrap
–	–	D J
(
–	–	J K
)
–	–	K L
)
–	–	L M
:
—	—	 
Result
—	—	 
<
—	—	 
byte
—	—	 
[
—	—	 
]
—	—	 
,
—	—	 %
EcliptixProtocolFailure
—	—	 4
>
—	—	4 5
.
—	—	5 6
Err
—	—	6 9
(
—	—	9 :

readResult
—	—	: D
.
—	—	D E
	UnwrapErr
—	—	E N
(
—	—	N O
)
—	—	O P
.
—	—	P Q'
ToEcliptixProtocolFailure
—	—	Q j
(
—	—	j k
)
—	—	k l
)
—	—	l m
;
—	—	m n
}
“	“	 
private
‘	‘	 
void
‘	‘	 
Dispose
‘	‘	 
(
‘	‘	 
bool
‘	‘	 
	disposing
‘	‘	 '
)
‘	‘	' (
{
’	’	 
lock
÷	÷	 
(
÷	÷	 
_lock
÷	÷	 
)
÷	÷	 
{
◊	◊	 	
if
ÿ	ÿ	 
(
ÿ	ÿ	 
	_disposed
ÿ	ÿ	 
)
ÿ	ÿ	 
{
Ÿ	Ÿ	 
return
⁄	⁄	 
;
⁄	⁄	 
}
€	€	 
	_disposed
›	›	 
=
›	›	 
true
›	›	 
;
›	›	 
if
ﬁ	ﬁ	 
(
ﬁ	ﬁ	 
	disposing
ﬁ	ﬁ	 
)
ﬁ	ﬁ	 
{
ﬂ	ﬂ	  
SecureCleanupLogic
‡	‡	 "
(
‡	‡	" #
)
‡	‡	# $
;
‡	‡	$ %
}
·	·	 
}
‚	‚	 	
}
„	„	 
public
Â	Â	 

Result
Â	Â	 
<
Â	Â	 
Unit
Â	Â	 
,
Â	Â	 %
EcliptixProtocolFailure
Â	Â	 /
>
Â	Â	/ 0!
SyncWithRemoteState
Â	Â	1 D
(
Â	Â	D E
uint
Â	Â	E I&
remoteSendingChainLength
Â	Â	J b
,
Â	Â	b c
uint
Ê	Ê	 (
remoteReceivingChainLength
Ê	Ê	 '
)
Ê	Ê	' (
{
Á	Á	 
lock
Ë	Ë	 
(
Ë	Ë	 
_lock
Ë	Ë	 
)
Ë	Ë	 
{
È	È	 	
Result
Í	Í	 
<
Í	Í	 
Unit
Í	Í	 
,
Í	Í	 %
EcliptixProtocolFailure
Í	Í	 0
>
Í	Í	0 1
disposedCheck
Í	Í	2 ?
=
Í	Í	@ A
CheckDisposed
Í	Í	B O
(
Í	Í	O P
)
Í	Í	P Q
;
Í	Í	Q R
if
Î	Î	 
(
Î	Î	 
disposedCheck
Î	Î	 
.
Î	Î	 
IsErr
Î	Î	 #
)
Î	Î	# $
{
Ï	Ï	 
return
Ì	Ì	 
disposedCheck
Ì	Ì	 $
;
Ì	Ì	$ %
}
Ó	Ó	 
Result
		 
<
		 '
EcliptixProtocolChainStep
		 ,
,
		, -%
EcliptixProtocolFailure
		. E
>
		E F!
receivingStepResult
		G Z
=
		[ \,
EnsureReceivingStepInitialized
Ò	Ò	 .
(
Ò	Ò	. /
)
Ò	Ò	/ 0
;
Ò	Ò	0 1
if
Ú	Ú	 
(
Ú	Ú	 !
receivingStepResult
Ú	Ú	 #
.
Ú	Ú	# $
IsErr
Ú	Ú	$ )
)
Ú	Ú	) *
{
Û	Û	 
return
Ù	Ù	 
Result
Ù	Ù	 
<
Ù	Ù	 
Unit
Ù	Ù	 "
,
Ù	Ù	" #%
EcliptixProtocolFailure
Ù	Ù	$ ;
>
Ù	Ù	; <
.
Ù	Ù	< =
Err
Ù	Ù	= @
(
Ù	Ù	@ A!
receivingStepResult
Ù	Ù	A T
.
Ù	Ù	T U
	UnwrapErr
Ù	Ù	U ^
(
Ù	Ù	^ _
)
Ù	Ù	_ `
)
Ù	Ù	` a
;
Ù	Ù	a b
}
ı	ı	 
Result
˜	˜	 
<
˜	˜	 
Unit
˜	˜	 
,
˜	˜	 %
EcliptixProtocolFailure
˜	˜	 0
>
˜	˜	0 1!
receivingSkipResult
˜	˜	2 E
=
˜	˜	F G!
receivingStepResult
¯	¯	 #
.
¯	¯	# $
Unwrap
¯	¯	$ *
(
¯	¯	* +
)
¯	¯	+ ,
.
¯	¯	, -
SkipKeysUntil
¯	¯	- :
(
¯	¯	: ;&
remoteSendingChainLength
¯	¯	; S
)
¯	¯	S T
;
¯	¯	T U
if
˘	˘	 
(
˘	˘	 !
receivingSkipResult
˘	˘	 #
.
˘	˘	# $
IsErr
˘	˘	$ )
)
˘	˘	) *
{
˙	˙	 
return
˚	˚	 !
receivingSkipResult
˚	˚	 *
;
˚	˚	* +
}
¸	¸	 
Result
˛	˛	 
<
˛	˛	 '
EcliptixProtocolChainStep
˛	˛	 ,
,
˛	˛	, -%
EcliptixProtocolFailure
˛	˛	. E
>
˛	˛	E F
sendingStepResult
˛	˛	G X
=
˛	˛	Y Z*
EnsureSendingStepInitialized
ˇ	ˇ	 ,
(
ˇ	ˇ	, -
)
ˇ	ˇ	- .
;
ˇ	ˇ	. /
if
Ä
Ä
 
(
Ä
Ä
 
sendingStepResult
Ä
Ä
 !
.
Ä
Ä
! "
IsErr
Ä
Ä
" '
)
Ä
Ä
' (
{
Å
Å
 
return
Ç
Ç
 
Result
Ç
Ç
 
<
Ç
Ç
 
Unit
Ç
Ç
 "
,
Ç
Ç
" #%
EcliptixProtocolFailure
Ç
Ç
$ ;
>
Ç
Ç
; <
.
Ç
Ç
< =
Err
Ç
Ç
= @
(
Ç
Ç
@ A
sendingStepResult
Ç
Ç
A R
.
Ç
Ç
R S
	UnwrapErr
Ç
Ç
S \
(
Ç
Ç
\ ]
)
Ç
Ç
] ^
)
Ç
Ç
^ _
;
Ç
Ç
_ `
}
É
É
 
Result
Ö
Ö
 
<
Ö
Ö
 
Unit
Ö
Ö
 
,
Ö
Ö
 %
EcliptixProtocolFailure
Ö
Ö
 0
>
Ö
Ö
0 1
sendingSkipResult
Ö
Ö
2 C
=
Ö
Ö
D E
sendingStepResult
Ü
Ü
 !
.
Ü
Ü
! "
Unwrap
Ü
Ü
" (
(
Ü
Ü
( )
)
Ü
Ü
) *
.
Ü
Ü
* +
SkipKeysUntil
Ü
Ü
+ 8
(
Ü
Ü
8 9(
remoteReceivingChainLength
Ü
Ü
9 S
)
Ü
Ü
S T
;
Ü
Ü
T U
if
á
á
 
(
á
á
 
sendingSkipResult
á
á
 !
.
á
á
! "
IsErr
á
á
" '
)
á
á
' (
{
à
à
 
return
â
â
 
sendingSkipResult
â
â
 (
;
â
â
( )
}
ä
ä
 
_eventHandler
å
å
 
?
å
å
 
.
å
å
 $
OnProtocolStateChanged
å
å
 1
(
å
å
1 2
_id
å
å
2 5
)
å
å
5 6
;
å
å
6 7
return
é
é
 
Result
é
é
 
<
é
é
 
Unit
é
é
 
,
é
é
 %
EcliptixProtocolFailure
é
é
  7
>
é
é
7 8
.
é
é
8 9
Ok
é
é
9 ;
(
é
é
; <
Unit
é
é
< @
.
é
é
@ A
Value
é
é
A F
)
é
é
F G
;
é
é
G H
}
è
è
 	
}
ê
ê
 
public
í
í
 

void
í
í
 #
NotifyRatchetRotation
í
í
 %
(
í
í
% &
)
í
í
& '
{
ì
ì
 
_replayProtection
î
î
 
.
î
î
 
OnRatchetRotation
î
î
 +
(
î
î
+ ,
)
î
î
, -
;
î
î
- .
}
ï
ï
 
~
ó
ó
 (
EcliptixProtocolConnection
ó
ó
 
(
ó
ó
  
)
ó
ó
  !
{
ò
ò
 
Dispose
ô
ô
 
(
ô
ô
 
false
ô
ô
 
)
ô
ô
 
;
ô
ô
 
}
ö
ö
 
internal
ú
ú
 
Result
ú
ú
 
<
ú
ú
 
Unit
ú
ú
 
,
ú
ú
 %
EcliptixProtocolFailure
ú
ú
 1
>
ú
ú
1 2#
CheckReplayProtection
ú
ú
3 H
(
ú
ú
H I
byte
ú
ú
I M
[
ú
ú
M N
]
ú
ú
N O
nonce
ú
ú
P U
,
ú
ú
U V
ulong
ú
ú
W \
messageIndex
ú
ú
] i
)
ú
ú
i j
{
ù
ù
 
return
û
û
 
_replayProtection
û
û
  
.
û
û
  !#
CheckAndRecordMessage
û
û
! 6
(
û
û
6 7
nonce
û
û
7 <
,
û
û
< =
messageIndex
û
û
> J
,
û
û
J K

chainIndex
ü
ü
 
:
ü
ü
 %
ProtocolSystemConstants
ü
ü
 /
.
ü
ü
/ 0
Protocol
ü
ü
0 8
.
ü
ü
8 9!
DEFAULT_CHAIN_INDEX
ü
ü
9 L
)
ü
ü
L M
;
ü
ü
M N
}
†
†
 
private
¢
¢
 
void
¢
¢
  
SecureCleanupLogic
¢
¢
 #
(
¢
¢
# $
)
¢
¢
$ %
{
£
£
 
_replayProtection
§
§
 
.
§
§
 
Dispose
§
§
 !
(
§
§
! "
)
§
§
" #
;
§
§
# $
_ratchetRecovery
•
•
 
.
•
•
 
Dispose
•
•
  
(
•
•
  !
)
•
•
! "
;
•
•
" #
_rootKeyHandle
¶
¶
 
?
¶
¶
 
.
¶
¶
 
Dispose
¶
¶
 
(
¶
¶
  
)
¶
¶
  !
;
¶
¶
! "*
_metadataEncryptionKeyHandle
ß
ß
 $
?
ß
ß
$ %
.
ß
ß
% &
Dispose
ß
ß
& -
(
ß
ß
- .
)
ß
ß
. /
;
ß
ß
/ 0
_sendingStep
®
®
 
.
®
®
 
Dispose
®
®
 
(
®
®
 
)
®
®
 
;
®
®
 
_receivingStep
©
©
 
?
©
©
 
.
©
©
 
Dispose
©
©
 
(
©
©
  
)
©
©
  !
;
©
©
! "+
_persistentDhPrivateKeyHandle
™
™
 %
?
™
™
% &
.
™
™
& '
Dispose
™
™
' .
(
™
™
. /
)
™
™
/ 0
;
™
™
0 1
if
´
´
 

(
´
´
 /
!_currentSendingDhPrivateKeyHandle
´
´
 -
!=
´
´
. 0/
!_initialSendingDhPrivateKeyHandle
´
´
1 R
)
´
´
R S
{
¨
¨
 	/
!_currentSendingDhPrivateKeyHandle
≠
≠
 -
?
≠
≠
- .
.
≠
≠
. /
Dispose
≠
≠
/ 6
(
≠
≠
6 7
)
≠
≠
7 8
;
≠
≠
8 9
}
Æ
Æ
 	/
!_initialSendingDhPrivateKeyHandle
∞
∞
 )
?
∞
∞
) *
.
∞
∞
* +
Dispose
∞
∞
+ 2
(
∞
∞
2 3
)
∞
∞
3 4
;
∞
∞
4 5
WipeIfNotNull
±
±
 
(
±
±
 
_peerDhPublicKey
±
±
 &
)
±
±
& '
;
±
±
' (
WipeIfNotNull
≤
≤
 
(
≤
≤
 $
_persistentDhPublicKey
≤
≤
 ,
)
≤
≤
, -
;
≤
≤
- .
}
≥
≥
 
private
µ
µ
 
Result
µ
µ
 
<
µ
µ
 
Unit
µ
µ
 
,
µ
µ
 %
EcliptixProtocolFailure
µ
µ
 0
>
µ
µ
0 1
CheckDisposed
µ
µ
2 ?
(
µ
µ
? @
)
µ
µ
@ A
{
∂
∂
 
return
∑
∑
 
	_disposed
∑
∑
 
?
∏
∏
 
Result
∏
∏
 
<
∏
∏
 
Unit
∏
∏
 
,
∏
∏
 %
EcliptixProtocolFailure
∏
∏
 2
>
∏
∏
2 3
.
∏
∏
3 4
Err
∏
∏
4 7
(
∏
∏
7 8%
EcliptixProtocolFailure
π
π
 '
.
π
π
' (
OBJECT_DISPOSED
π
π
( 7
(
π
π
7 8
nameof
π
π
8 >
(
π
π
> ?(
EcliptixProtocolConnection
π
π
? Y
)
π
π
Y Z
)
π
π
Z [
)
π
π
[ \
:
∫
∫
 
Result
∫
∫
 
<
∫
∫
 
Unit
∫
∫
 
,
∫
∫
 %
EcliptixProtocolFailure
∫
∫
 2
>
∫
∫
2 3
.
∫
∫
3 4
Ok
∫
∫
4 6
(
∫
∫
6 7
Unit
∫
∫
7 ;
.
∫
∫
; <
Value
∫
∫
< A
)
∫
∫
A B
;
∫
∫
B C
}
ª
ª
 
private
Ω
Ω
 
static
Ω
Ω
 
void
Ω
Ω
 
WipeIfNotNull
Ω
Ω
 %
(
Ω
Ω
% &
byte
Ω
Ω
& *
[
Ω
Ω
* +
]
Ω
Ω
+ ,
?
Ω
Ω
, -
data
Ω
Ω
. 2
)
Ω
Ω
2 3
{
æ
æ
 
if
ø
ø
 

(
ø
ø
 
data
ø
ø
 
is
ø
ø
 
not
ø
ø
 
null
ø
ø
 
)
ø
ø
 
{
¿
¿
 	
SodiumInterop
¡
¡
 
.
¡
¡
 

SecureWipe
¡
¡
 $
(
¡
¡
$ %
data
¡
¡
% )
)
¡
¡
) *
;
¡
¡
* +
}
¬
¬
 	
}
√
√
 
private
≈
≈
 
Result
≈
≈
 
<
≈
≈
 
Unit
≈
≈
 
,
≈
≈
 %
EcliptixProtocolFailure
≈
≈
 0
>
≈
≈
0 1
EnsureNotExpired
≈
≈
2 B
(
≈
≈
B C
)
≈
≈
C D
{
∆
∆
 
Result
«
«
 
<
«
«
 
Unit
«
«
 
,
«
«
 %
EcliptixProtocolFailure
«
«
 ,
>
«
«
, -
disposedCheck
«
«
. ;
=
«
«
< =
CheckDisposed
«
«
> K
(
«
«
K L
)
«
«
L M
;
«
«
M N
if
»
»
 

(
»
»
 
disposedCheck
»
»
 
.
»
»
 
IsErr
»
»
 
)
»
»
  
{
…
…
 	
return
 
 
 
disposedCheck
 
 
  
;
 
 
  !
}
À
À
 	
if
Õ
Õ
 

(
Õ
Õ
 
DateTimeOffset
Õ
Õ
 
.
Õ
Õ
 
UtcNow
Õ
Õ
 !
-
Õ
Õ
" #

_createdAt
Õ
Õ
$ .
>
Õ
Õ
/ 0
SessionTimeout
Õ
Õ
1 ?
)
Õ
Õ
? @
{
Œ
Œ
 	
return
œ
œ
 
Result
œ
œ
 
<
œ
œ
 
Unit
œ
œ
 
,
œ
œ
 %
EcliptixProtocolFailure
œ
œ
  7
>
œ
œ
7 8
.
œ
œ
8 9
Err
œ
œ
9 <
(
œ
œ
< =%
EcliptixProtocolFailure
–
–
 '
.
–
–
' (
Generic
–
–
( /
(
–
–
/ 0
string
–
–
0 6
.
–
–
6 7
Format
–
–
7 =
(
–
–
= >-
EcliptixProtocolFailureMessages
–
–
> ]
.
–
–
] ^
SESSION_EXPIRED
–
–
^ m
,
–
–
m n
_id
–
–
o r
)
–
–
r s
)
–
–
s t
)
–
–
t u
;
–
–
u v
}
—
—
 	
return
”
”
 
Result
”
”
 
<
”
”
 
Unit
”
”
 
,
”
”
 %
EcliptixProtocolFailure
”
”
 3
>
”
”
3 4
.
”
”
4 5
Ok
”
”
5 7
(
”
”
7 8
Unit
”
”
8 <
.
”
”
< =
Value
”
”
= B
)
”
”
B C
;
”
”
C D
}
‘
‘
 
private
÷
÷
 
Result
÷
÷
 
<
÷
÷
 '
EcliptixProtocolChainStep
÷
÷
 ,
,
÷
÷
, -%
EcliptixProtocolFailure
÷
÷
. E
>
÷
÷
E F*
EnsureSendingStepInitialized
÷
÷
G c
(
÷
÷
c d
)
÷
÷
d e
{
◊
◊
 
Result
ÿ
ÿ
 
<
ÿ
ÿ
 
Unit
ÿ
ÿ
 
,
ÿ
ÿ
 %
EcliptixProtocolFailure
ÿ
ÿ
 ,
>
ÿ
ÿ
, -
disposedCheck
ÿ
ÿ
. ;
=
ÿ
ÿ
< =
CheckDisposed
ÿ
ÿ
> K
(
ÿ
ÿ
K L
)
ÿ
ÿ
L M
;
ÿ
ÿ
M N
if
Ÿ
Ÿ
 

(
Ÿ
Ÿ
 
disposedCheck
Ÿ
Ÿ
 
.
Ÿ
Ÿ
 
IsErr
Ÿ
Ÿ
 
)
Ÿ
Ÿ
  
{
⁄
⁄
 	
return
€
€
 
Result
€
€
 
<
€
€
 '
EcliptixProtocolChainStep
€
€
 3
,
€
€
3 4%
EcliptixProtocolFailure
€
€
5 L
>
€
€
L M
.
€
€
M N
Err
€
€
N Q
(
€
€
Q R
disposedCheck
€
€
R _
.
€
€
_ `
	UnwrapErr
€
€
` i
(
€
€
i j
)
€
€
j k
)
€
€
k l
;
€
€
l m
}
‹
‹
 	
if
ﬁ
ﬁ
 

(
ﬁ
ﬁ
 
_sendingStep
ﬁ
ﬁ
 
!=
ﬁ
ﬁ
 
null
ﬁ
ﬁ
  
)
ﬁ
ﬁ
  !
{
ﬂ
ﬂ
 	
return
‡
‡
 
Result
‡
‡
 
<
‡
‡
 '
EcliptixProtocolChainStep
‡
‡
 3
,
‡
‡
3 4%
EcliptixProtocolFailure
‡
‡
5 L
>
‡
‡
L M
.
‡
‡
M N
Ok
‡
‡
N P
(
‡
‡
P Q
_sendingStep
‡
‡
Q ]
)
‡
‡
] ^
;
‡
‡
^ _
}
·
·
 	
return
„
„
 
Result
„
„
 
<
„
„
 '
EcliptixProtocolChainStep
„
„
 /
,
„
„
/ 0%
EcliptixProtocolFailure
„
„
1 H
>
„
„
H I
.
„
„
I J
Err
„
„
J M
(
„
„
M N%
EcliptixProtocolFailure
‰
‰
 #
.
‰
‰
# $
Generic
‰
‰
$ +
(
‰
‰
+ ,-
EcliptixProtocolFailureMessages
‰
‰
, K
.
‰
‰
K L0
"SENDING_CHAIN_STEP_NOT_INITIALIZED
‰
‰
L n
)
‰
‰
n o
)
‰
‰
o p
;
‰
‰
p q
}
Â
Â
 
private
Á
Á
 
Result
Á
Á
 
<
Á
Á
 '
EcliptixProtocolChainStep
Á
Á
 ,
,
Á
Á
, -%
EcliptixProtocolFailure
Á
Á
. E
>
Á
Á
E F,
EnsureReceivingStepInitialized
Á
Á
G e
(
Á
Á
e f
)
Á
Á
f g
{
Ë
Ë
 
Result
È
È
 
<
È
È
 
Unit
È
È
 
,
È
È
 %
EcliptixProtocolFailure
È
È
 ,
>
È
È
, -
disposedCheck
È
È
. ;
=
È
È
< =
CheckDisposed
È
È
> K
(
È
È
K L
)
È
È
L M
;
È
È
M N
if
Í
Í
 

(
Í
Í
 
disposedCheck
Í
Í
 
.
Í
Í
 
IsErr
Í
Í
 
)
Í
Í
  
{
Î
Î
 	
return
Ï
Ï
 
Result
Ï
Ï
 
<
Ï
Ï
 '
EcliptixProtocolChainStep
Ï
Ï
 3
,
Ï
Ï
3 4%
EcliptixProtocolFailure
Ï
Ï
5 L
>
Ï
Ï
L M
.
Ï
Ï
M N
Err
Ï
Ï
N Q
(
Ï
Ï
Q R
disposedCheck
Ï
Ï
R _
.
Ï
Ï
_ `
	UnwrapErr
Ï
Ï
` i
(
Ï
Ï
i j
)
Ï
Ï
j k
)
Ï
Ï
k l
;
Ï
Ï
l m
}
Ì
Ì
 	
if
Ô
Ô
 

(
Ô
Ô
 
_receivingStep
Ô
Ô
 
!=
Ô
Ô
 
null
Ô
Ô
 "
)
Ô
Ô
" #
{


 	
return
Ò
Ò
 
Result
Ò
Ò
 
<
Ò
Ò
 '
EcliptixProtocolChainStep
Ò
Ò
 3
,
Ò
Ò
3 4%
EcliptixProtocolFailure
Ò
Ò
5 L
>
Ò
Ò
L M
.
Ò
Ò
M N
Ok
Ò
Ò
N P
(
Ò
Ò
P Q
_receivingStep
Ò
Ò
Q _
)
Ò
Ò
_ `
;
Ò
Ò
` a
}
Ú
Ú
 	
return
Ù
Ù
 
Result
Ù
Ù
 
<
Ù
Ù
 '
EcliptixProtocolChainStep
Ù
Ù
 /
,
Ù
Ù
/ 0%
EcliptixProtocolFailure
Ù
Ù
1 H
>
Ù
Ù
H I
.
Ù
Ù
I J
Err
Ù
Ù
J M
(
Ù
Ù
M N%
EcliptixProtocolFailure
ı
ı
 #
.
ı
ı
# $
Generic
ı
ı
$ +
(
ı
ı
+ ,-
EcliptixProtocolFailureMessages
ı
ı
, K
.
ı
ı
K L2
$RECEIVING_CHAIN_STEP_NOT_INITIALIZED
ı
ı
L p
)
ı
ı
p q
)
ı
ı
q r
;
ı
ı
r s
}
ˆ
ˆ
 
private
¯
¯
 
Result
¯
¯
 
<
¯
¯
 
Unit
¯
¯
 
,
¯
¯
 %
EcliptixProtocolFailure
¯
¯
 0
>
¯
¯
0 1!
CheckIfNotFinalized
¯
¯
2 E
(
¯
¯
E F
)
¯
¯
F G
{
˘
˘
 
Result
˙
˙
 
<
˙
˙
 
Unit
˙
˙
 
,
˙
˙
 %
EcliptixProtocolFailure
˙
˙
 ,
>
˙
˙
, -
disposedCheck
˙
˙
. ;
=
˙
˙
< =
CheckDisposed
˙
˙
> K
(
˙
˙
K L
)
˙
˙
L M
;
˙
˙
M N
if
˚
˚
 

(
˚
˚
 
disposedCheck
˚
˚
 
.
˚
˚
 
IsErr
˚
˚
 
)
˚
˚
  
{
¸
¸
 	
return
˝
˝
 
disposedCheck
˝
˝
  
;
˝
˝
  !
}
˛
˛
 	
if
ÄÄ 

(
ÄÄ 
_rootKeyHandle
ÄÄ 
!=
ÄÄ 
null
ÄÄ "
||
ÄÄ# %
_receivingStep
ÄÄ& 4
!=
ÄÄ5 7
null
ÄÄ8 <
)
ÄÄ< =
{
ÅÅ 	
return
ÇÇ 
Result
ÇÇ 
<
ÇÇ 
Unit
ÇÇ 
,
ÇÇ %
EcliptixProtocolFailure
ÇÇ  7
>
ÇÇ7 8
.
ÇÇ8 9
Err
ÇÇ9 <
(
ÇÇ< =%
EcliptixProtocolFailure
ÉÉ '
.
ÉÉ' (
Generic
ÉÉ( /
(
ÉÉ/ 0-
EcliptixProtocolFailureMessages
ÉÉ0 O
.
ÉÉO P'
SESSION_ALREADY_FINALIZED
ÉÉP i
)
ÉÉi j
)
ÉÉj k
;
ÉÉk l
}
ÑÑ 	
return
ÜÜ 
Result
ÜÜ 
<
ÜÜ 
Unit
ÜÜ 
,
ÜÜ %
EcliptixProtocolFailure
ÜÜ 3
>
ÜÜ3 4
.
ÜÜ4 5
Ok
ÜÜ5 7
(
ÜÜ7 8
Unit
ÜÜ8 <
.
ÜÜ< =
Value
ÜÜ= B
)
ÜÜB C
;
ÜÜC D
}
áá 
private
ââ 
static
ââ 
Result
ââ 
<
ââ 
Unit
ââ 
,
ââ %
EcliptixProtocolFailure
ââ  7
>
ââ7 8!
ValidateInitialKeys
ââ9 L
(
ââL M
byte
ââM Q
[
ââQ R
]
ââR S
rootKey
ââT [
,
ââ[ \
byte
ââ] a
[
ââa b
]
ââb c
	peerDhKey
ââd m
)
ââm n
{
ää 
if
ãã 

(
ãã 
rootKey
ãã 
.
ãã 
Length
ãã 
!=
ãã 
	Constants
ãã '
.
ãã' (
X_25519_KEY_SIZE
ãã( 8
)
ãã8 9
{
åå 	
return
çç 
Result
çç 
<
çç 
Unit
çç 
,
çç %
EcliptixProtocolFailure
çç  7
>
çç7 8
.
çç8 9
Err
çç9 <
(
çç< =%
EcliptixProtocolFailure
éé '
.
éé' (
InvalidInput
éé( 4
(
éé4 5
string
èè 
.
èè 
Format
èè !
(
èè! "-
EcliptixProtocolFailureMessages
èè" A
.
èèA B+
INITIAL_ROOT_KEY_INVALID_SIZE
èèB _
,
èè_ `
	Constants
êê !
.
êê! "
X_25519_KEY_SIZE
êê" 2
)
êê2 3
)
êê3 4
)
êê4 5
;
êê5 6
}
ëë 	
if
ìì 

(
ìì 
	peerDhKey
ìì 
.
ìì 
Length
ìì 
!=
ìì 
	Constants
ìì  )
.
ìì) *%
X_25519_PUBLIC_KEY_SIZE
ìì* A
)
ììA B
{
îî 	
return
ïï 
Result
ïï 
<
ïï 
Unit
ïï 
,
ïï %
EcliptixProtocolFailure
ïï  7
>
ïï7 8
.
ïï8 9
Err
ïï9 <
(
ïï< =%
EcliptixProtocolFailure
ññ '
.
ññ' (
InvalidInput
ññ( 4
(
ññ4 5
string
óó 
.
óó 
Format
óó !
(
óó! "-
EcliptixProtocolFailureMessages
óó" A
.
óóA B5
'INITIAL_PEER_DH_PUBLIC_KEY_INVALID_SIZE
óóB i
,
óói j
	Constants
òò !
.
òò! "%
X_25519_PUBLIC_KEY_SIZE
òò" 9
)
òò9 :
)
òò: ;
)
òò; <
;
òò< =
}
ôô 	
return
õõ 
Result
õõ 
<
õõ 
Unit
õõ 
,
õõ %
EcliptixProtocolFailure
õõ 3
>
õõ3 4
.
õõ4 5
Ok
õõ5 7
(
õõ7 8
Unit
õõ8 <
.
õõ< =
Value
õõ= B
)
õõB C
;
õõC D
}
úú 
private
ûû 
Result
ûû 
<
ûû 
bool
ûû 
,
ûû %
EcliptixProtocolFailure
ûû 0
>
ûû0 1*
MaybePerformSendingDhRatchet
ûû2 N
(
ûûN O'
EcliptixProtocolChainStep
ûûO h
sendingStep
ûûi t
)
ûût u
{
üü 
Result
†† 
<
†† 
uint
†† 
,
†† %
EcliptixProtocolFailure
†† ,
>
††, - 
currentIndexResult
††. @
=
††A B
sendingStep
††C N
.
††N O
GetCurrentIndex
††O ^
(
††^ _
)
††_ `
;
††` a
if
°° 

(
°°  
currentIndexResult
°° 
.
°° 
IsErr
°° $
)
°°$ %
{
¢¢ 	
return
££ 
Result
££ 
<
££ 
bool
££ 
,
££ %
EcliptixProtocolFailure
££  7
>
££7 8
.
££8 9
Err
££9 <
(
££< = 
currentIndexResult
££= O
.
££O P
	UnwrapErr
££P Y
(
££Y Z
)
££Z [
)
££[ \
;
££\ ]
}
§§ 	
uint
¶¶ 
currentIndex
¶¶ 
=
¶¶  
currentIndexResult
¶¶ .
.
¶¶. /
Unwrap
¶¶/ 5
(
¶¶5 6
)
¶¶6 7
;
¶¶7 8
DateTime
ßß 
lastRatchetTime
ßß  
=
ßß! "
new
ßß# &
DateTime
ßß' /
(
ßß/ 0
Interlocked
ßß0 ;
.
ßß; <
Read
ßß< @
(
ßß@ A
ref
ßßA D#
_lastRatchetTimeTicks
ßßE Z
)
ßßZ [
,
ßß[ \
DateTimeKind
ßß] i
.
ßßi j
Utc
ßßj m
)
ßßm n
;
ßßn o
bool
®® 
shouldRatchet
®® 
=
®® 
_ratchetConfig
®® +
.
®®+ ,
ShouldRatchet
®®, 9
(
®®9 :
currentIndex
®®: F
+
®®G H
$num
®®I J
,
®®J K
lastRatchetTime
®®L [
,
®®[ \
_receivedNewDhKey
®®] n
)
®®n o
;
®®o p
if
´´ 

(
´´ 
!
´´ 
shouldRatchet
´´ 
)
´´ 
{
¨¨ 	
return
≠≠ 
Result
≠≠ 
<
≠≠ 
bool
≠≠ 
,
≠≠ %
EcliptixProtocolFailure
≠≠  7
>
≠≠7 8
.
≠≠8 9
Ok
≠≠9 ;
(
≠≠; <
false
≠≠< A
)
≠≠A B
;
≠≠B C
}
ÆÆ 	
Result
±± 
<
±± 
Unit
±± 
,
±± %
EcliptixProtocolFailure
±± ,
>
±±, -
ratchetResult
±±. ;
=
±±< =
PerformDhRatchet
±±> N
(
±±N O
true
±±O S
)
±±S T
;
±±T U
if
≤≤ 

(
≤≤ 
ratchetResult
≤≤ 
.
≤≤ 
IsErr
≤≤ 
)
≤≤  
{
≥≥ 	
return
¥¥ 
Result
¥¥ 
<
¥¥ 
bool
¥¥ 
,
¥¥ %
EcliptixProtocolFailure
¥¥  7
>
¥¥7 8
.
¥¥8 9
Err
¥¥9 <
(
¥¥< =
ratchetResult
¥¥= J
.
¥¥J K
	UnwrapErr
¥¥K T
(
¥¥T U
)
¥¥U V
)
¥¥V W
;
¥¥W X
}
µµ 	
_receivedNewDhKey
∏∏ 
=
∏∏ 
false
∏∏ !
;
∏∏! "
return
ππ 
Result
ππ 
<
ππ 
bool
ππ 
,
ππ %
EcliptixProtocolFailure
ππ 3
>
ππ3 4
.
ππ4 5
Ok
ππ5 7
(
ππ7 8
true
ππ8 <
)
ππ< =
;
ππ= >
}
∫∫ 
}ªª Éü
u/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/EcliptixProtocolChainStep.cs
	namespace

 	
Ecliptix


 
.

 
Protocol

 
.

 
System

 "
.

" #
Core

# '
;

' (
internal 
sealed	 
class %
EcliptixProtocolChainStep /
:0 1
IKeyProvider2 >
,> ?
IDisposable@ K
{ 
private 
const 
uint %
DEFAULT_CACHE_WINDOW_SIZE 0
=1 2#
ProtocolSystemConstants3 J
.J K
	ChainStepK T
.T U%
DEFAULT_CACHE_WINDOW_SIZEU n
;n o
private 
static 
readonly 
Result "
<" #
Unit# '
,' (#
EcliptixProtocolFailure) @
>@ A
OkResultB J
=K L
Result 
< 
Unit 
, #
EcliptixProtocolFailure ,
>, -
.- .
Ok. 0
(0 1
Unit1 5
.5 6
Value6 ;
); <
;< =
private 
readonly 
uint 
_cacheWindow &
;& '
private 
readonly 
ChainStepType "
	_stepType# ,
;, -
private $
SodiumSecureMemoryHandle $
_chainKeyHandle% 4
;4 5
private 
readonly 
SortedDictionary %
<% &
uint& *
,* +$
SodiumSecureMemoryHandle, D
>D E
_messageKeysF R
;R S
private 
uint 
_currentIndex 
; 
private $
SodiumSecureMemoryHandle $
?$ %
_dhPrivateKeyHandle& 9
;9 :
private 
byte 
[ 
] 
? 
_dhPublicKey  
;  !
private!! 
bool!! 
	_disposed!! 
;!! 
private## %
EcliptixProtocolChainStep## %
(##% &
ChainStepType$$ 
stepType$$ 
,$$ $
SodiumSecureMemoryHandle%%  
chainKeyHandle%%! /
,%%/ 0$
SodiumSecureMemoryHandle&&  
?&&  !
dhPrivateKeyHandle&&" 4
,&&4 5
byte'' 
['' 
]'' 
?'' 
dhPublicKey'' 
,'' 
uint(( 
cacheWindowSize(( 
)(( 
{)) 
	_stepType** 
=** 
stepType** 
;** 
_chainKeyHandle++ 
=++ 
chainKeyHandle++ (
;++( )
_dhPrivateKeyHandle,, 
=,, 
dhPrivateKeyHandle,, 0
;,,0 1
_dhPublicKey-- 
=-- 
dhPublicKey-- "
;--" #
_cacheWindow.. 
=.. 
cacheWindowSize.. &
;..& '
_currentIndex// 
=// #
ProtocolSystemConstants// /
./// 0
	ChainStep//0 9
.//9 :
INITIAL_INDEX//: G
;//G H
	_disposed00 
=00 
false00 
;00 
_messageKeys11 
=11 
[11 
]11 
;11 
}22 
public44 

Result44 
<44 
T44 
,44 #
EcliptixProtocolFailure44 ,
>44, -
ExecuteWithKey44. <
<44< =
T44= >
>44> ?
(44? @
uint44@ D
keyIndex44E M
,44M N
Func55 
<55 
ReadOnlySpan55 
<55 
byte55 
>55 
,55  
Result55! '
<55' (
T55( )
,55) *#
EcliptixProtocolFailure55+ B
>55B C
>55C D
	operation55E N
)55N O
{66 
if77 

(77 
	_disposed77 
)77 
{88 	
return99 
Result99 
<99 
T99 
,99 #
EcliptixProtocolFailure99 4
>994 5
.995 6
Err996 9
(999 :#
EcliptixProtocolFailure:: '
.::' (
OBJECT_DISPOSED::( 7
(::7 8
nameof::8 >
(::> ?%
EcliptixProtocolChainStep::? X
)::X Y
)::Y Z
)::Z [
;::[ \
};; 	
if== 

(== 
!== 
_messageKeys== 
.== 
TryGetValue== %
(==% &
keyIndex==& .
,==. /
out==0 3$
SodiumSecureMemoryHandle==4 L
?==L M
	keyHandle==N W
)==W X
)==X Y
{>> 	
return?? 
Result?? 
<?? 
T?? 
,?? #
EcliptixProtocolFailure?? 4
>??4 5
.??5 6
Err??6 9
(??9 :#
EcliptixProtocolFailure@@ '
.@@' (
InvalidInput@@( 4
(@@4 5
stringAA 
.AA 
FormatAA !
(AA! "+
EcliptixProtocolFailureMessagesAA" A
.AAA B
	ChainStepAAB K
.AAK L$
KEY_WITH_INDEX_NOT_FOUNDAAL d
,AAd e
keyIndexAAf n
)AAn o
)AAo p
)AAp q
;AAq r
}BB 	
ResultDD 
<DD 
TDD 
,DD 
SodiumFailureDD 
>DD  
sodiumResultDD! -
=DD. /
	keyHandleDD0 9
.DD9 :
WithReadAccessDD: H
(DDH I
keyMaterialDDI T
=>DDU W
{EE 	
ResultFF 
<FF 
TFF 
,FF #
EcliptixProtocolFailureFF -
>FF- .
opResultFF/ 7
=FF8 9
	operationFF: C
(FFC D
keyMaterialFFD O
)FFO P
;FFP Q
returnGG 
opResultGG 
.GG 
IsOkGG  
?HH 
ResultHH 
<HH 
THH 
,HH 
SodiumFailureHH )
>HH) *
.HH* +
OkHH+ -
(HH- .
opResultHH. 6
.HH6 7
UnwrapHH7 =
(HH= >
)HH> ?
)HH? @
:II 
ResultII 
<II 
TII 
,II 
SodiumFailureII )
>II) *
.II* +
ErrII+ .
(II. /
SodiumFailureII/ <
.II< =
InvalidOperationII= M
(IIM N
opResultIIN V
.IIV W
	UnwrapErrIIW `
(II` a
)IIa b
.IIb c
MessageIIc j
)IIj k
)IIk l
;IIl m
}JJ 	
)JJ	 

;JJ
 
returnLL 
sodiumResultLL 
.LL 
IsOkLL  
?MM 
ResultMM 
<MM 
TMM 
,MM #
EcliptixProtocolFailureMM /
>MM/ 0
.MM0 1
OkMM1 3
(MM3 4
sodiumResultMM4 @
.MM@ A
UnwrapMMA G
(MMG H
)MMH I
)MMI J
:NN 
ResultNN 
<NN 
TNN 
,NN #
EcliptixProtocolFailureNN /
>NN/ 0
.NN0 1
ErrNN1 4
(NN4 5#
EcliptixProtocolFailureNN5 L
.NNL M
GenericNNM T
(NNT U
sodiumResultNNU a
.NNa b
	UnwrapErrNNb k
(NNk l
)NNl m
.NNm n
MessageNNn u
)NNu v
)NNv w
;NNw x
}OO 
publicQQ 

voidQQ 
DisposeQQ 
(QQ 
)QQ 
{RR 
ifSS 

(SS 
	_disposedSS 
)SS 
{TT 	
returnUU 
;UU 
}VV 	
	_disposedXX 
=XX 
trueXX 
;XX 
foreachZZ 
(ZZ $
SodiumSecureMemoryHandleZZ )
handleZZ* 0
inZZ1 3
_messageKeysZZ4 @
.ZZ@ A
ValuesZZA G
)ZZG H
{[[ 	
handle\\ 
.\\ 
Dispose\\ 
(\\ 
)\\ 
;\\ 
}]] 	
_messageKeys__ 
.__ 
Clear__ 
(__ 
)__ 
;__ 
_chainKeyHandleaa 
.aa 
Disposeaa 
(aa  
)aa  !
;aa! "
_dhPrivateKeyHandlebb 
?bb 
.bb 
Disposebb $
(bb$ %
)bb% &
;bb& '
ifcc 

(cc 
_dhPublicKeycc 
!=cc 
nullcc  
)cc  !
{dd 	
SodiumInteropee 
.ee 

SecureWipeee $
(ee$ %
_dhPublicKeyee% 1
)ee1 2
;ee2 3
}ff 	
_chainKeyHandlehh 
=hh 
nullhh 
!hh 
;hh  
_dhPrivateKeyHandleii 
=ii 
nullii "
;ii" #
_dhPublicKeyjj 
=jj 
nulljj 
;jj 
}kk 
publicmm 

Resultmm 
<mm 
uintmm 
,mm #
EcliptixProtocolFailuremm /
>mm/ 0
GetCurrentIndexmm1 @
(mm@ A
)mmA B
{nn 
returnoo 
	_disposedoo 
?pp 
Resultpp 
<pp 
uintpp 
,pp #
EcliptixProtocolFailurepp 2
>pp2 3
.pp3 4
Errpp4 7
(pp7 8#
EcliptixProtocolFailureqq '
.qq' (
OBJECT_DISPOSEDqq( 7
(qq7 8
nameofqq8 >
(qq> ?%
EcliptixProtocolChainStepqq? X
)qqX Y
)qqY Z
)qqZ [
:rr 
Resultrr 
<rr 
uintrr 
,rr #
EcliptixProtocolFailurerr 2
>rr2 3
.rr3 4
Okrr4 6
(rr6 7
_currentIndexrr7 D
)rrD E
;rrE F
}ss 
internaluu 
Resultuu 
<uu 
byteuu 
[uu 
]uu 
,uu #
EcliptixProtocolFailureuu 3
>uu3 4
GetCurrentChainKeyuu5 G
(uuG H
)uuH I
{vv 
ifww 

(ww 
	_disposedww 
)ww 
{xx 	
returnyy 
Resultyy 
<yy 
byteyy 
[yy 
]yy  
,yy  !#
EcliptixProtocolFailureyy" 9
>yy9 :
.yy: ;
Erryy; >
(yy> ?#
EcliptixProtocolFailurezz '
.zz' (
OBJECT_DISPOSEDzz( 7
(zz7 8
nameofzz8 >
(zz> ?%
EcliptixProtocolChainStepzz? X
)zzX Y
)zzY Z
)zzZ [
;zz[ \
}{{ 	
return}} 
_chainKeyHandle}} 
.}} 
	ReadBytes}} (
(}}( )
	Constants}}) 2
.}}2 3
X_25519_KEY_SIZE}}3 C
)}}C D
.~~ 
MapSodiumFailure~~ 
(~~ 
)~~ 
;~~  
} 
internal
ÅÅ 
Result
ÅÅ 
<
ÅÅ 
Unit
ÅÅ 
,
ÅÅ %
EcliptixProtocolFailure
ÅÅ 1
>
ÅÅ1 2
SetCurrentIndex
ÅÅ3 B
(
ÅÅB C
uint
ÅÅC G
value
ÅÅH M
)
ÅÅM N
{
ÇÇ 
if
ÉÉ 

(
ÉÉ 
	_disposed
ÉÉ 
)
ÉÉ 
{
ÑÑ 	
return
ÖÖ 
Result
ÖÖ 
<
ÖÖ 
Unit
ÖÖ 
,
ÖÖ %
EcliptixProtocolFailure
ÖÖ  7
>
ÖÖ7 8
.
ÖÖ8 9
Err
ÖÖ9 <
(
ÖÖ< =%
EcliptixProtocolFailure
ÜÜ '
.
ÜÜ' (
OBJECT_DISPOSED
ÜÜ( 7
(
ÜÜ7 8
nameof
ÜÜ8 >
(
ÜÜ> ?'
EcliptixProtocolChainStep
ÜÜ? X
)
ÜÜX Y
)
ÜÜY Z
)
ÜÜZ [
;
ÜÜ[ \
}
áá 	
_currentIndex
ââ 
=
ââ 
value
ââ 
;
ââ 
return
ãã 
Result
ãã 
<
ãã 
Unit
ãã 
,
ãã %
EcliptixProtocolFailure
ãã 3
>
ãã3 4
.
ãã4 5
Ok
ãã5 7
(
ãã7 8
Unit
ãã8 <
.
ãã< =
Value
ãã= B
)
ããB C
;
ããC D
}
åå 
public
éé 

static
éé 
Result
éé 
<
éé '
EcliptixProtocolChainStep
éé 2
,
éé2 3%
EcliptixProtocolFailure
éé4 K
>
ééK L
Create
ééM S
(
ééS T
ChainStepType
èè 
stepType
èè 
,
èè 
byte
êê 
[
êê 
]
êê 
initialChainKey
êê 
,
êê 
byte
ëë 
[
ëë 
]
ëë 
?
ëë !
initialDhPrivateKey
ëë #
,
ëë# $
byte
íí 
[
íí 
]
íí 
?
íí  
initialDhPublicKey
íí "
,
íí" #
uint
ìì 
cacheWindowSize
ìì 
=
ìì '
DEFAULT_CACHE_WINDOW_SIZE
ìì 8
)
ìì8 9
{
îî 
Result
ïï 
<
ïï 
Unit
ïï 
,
ïï %
EcliptixProtocolFailure
ïï ,
>
ïï, -
keyValidation
ïï. ;
=
ïï< =%
ValidateInitialChainKey
ïï> U
(
ïïU V
initialChainKey
ïïV e
)
ïïe f
;
ïïf g
if
ññ 

(
ññ 
keyValidation
ññ 
.
ññ 
IsErr
ññ 
)
ññ  
{
óó 	
return
òò 
Result
òò 
<
òò '
EcliptixProtocolChainStep
òò 3
,
òò3 4%
EcliptixProtocolFailure
òò5 L
>
òòL M
.
òòM N
Err
òòN Q
(
òòQ R
keyValidation
òòR _
.
òò_ `
	UnwrapErr
òò` i
(
òòi j
)
òòj k
)
òòk l
;
òòl m
}
ôô 	
Result
õõ 
<
õõ 
(
õõ &
SodiumSecureMemoryHandle
õõ (
?
õõ( ) 
dhPrivateKeyHandle
õõ* <
,
õõ< =
byte
õõ> B
[
õõB C
]
õõC D
?
õõD E
dhPublicKeyCloned
õõF W
)
õõW X
,
õõX Y%
EcliptixProtocolFailure
õõZ q
>
õõq r
dhKeysResult
úú 
=
úú &
ValidateAndPrepareDhKeys
ùù (
(
ùù( )!
initialDhPrivateKey
ùù) <
,
ùù< = 
initialDhPublicKey
ùù> P
)
ùùP Q
;
ùùQ R
if
ûû 

(
ûû 
dhKeysResult
ûû 
.
ûû 
IsErr
ûû 
)
ûû 
{
üü 	
return
†† 
Result
†† 
<
†† '
EcliptixProtocolChainStep
†† 3
,
††3 4%
EcliptixProtocolFailure
††5 L
>
††L M
.
††M N
Err
††N Q
(
††Q R
dhKeysResult
††R ^
.
††^ _
	UnwrapErr
††_ h
(
††h i
)
††i j
)
††j k
;
††k l
}
°° 	
(
££ 	&
SodiumSecureMemoryHandle
££	 !
?
££! " 
dhPrivateKeyHandle
££# 5
,
££5 6
byte
££7 ;
[
££; <
]
££< =
?
££= >
dhPublicKeyCloned
££? P
)
££P Q
dhInfo
££R X
=
££Y Z
dhKeysResult
££[ g
.
££g h
Unwrap
££h n
(
££n o
)
££o p
;
££p q
Result
•• 
<
•• &
SodiumSecureMemoryHandle
•• '
,
••' (%
EcliptixProtocolFailure
••) @
>
••@ A
chainKeyResult
••B P
=
••Q R&
AllocateAndWriteChainKey
¶¶ $
(
¶¶$ %
initialChainKey
¶¶% 4
)
¶¶4 5
;
¶¶5 6
if
ßß 

(
ßß 
chainKeyResult
ßß 
.
ßß 
IsErr
ßß  
)
ßß  !
{
®® 	
dhInfo
©© 
.
©©  
dhPrivateKeyHandle
©© %
?
©©% &
.
©©& '
Dispose
©©' .
(
©©. /
)
©©/ 0
;
©©0 1
if
™™ 
(
™™ 
dhInfo
™™ 
.
™™ 
dhPublicKeyCloned
™™ (
!=
™™) +
null
™™, 0
)
™™0 1
{
´´ 
SodiumInterop
¨¨ 
.
¨¨ 

SecureWipe
¨¨ (
(
¨¨( )
dhInfo
¨¨) /
.
¨¨/ 0
dhPublicKeyCloned
¨¨0 A
)
¨¨A B
;
¨¨B C
}
≠≠ 
return
ØØ 
Result
ØØ 
<
ØØ '
EcliptixProtocolChainStep
ØØ 3
,
ØØ3 4%
EcliptixProtocolFailure
ØØ5 L
>
ØØL M
.
ØØM N
Err
ØØN Q
(
ØØQ R
chainKeyResult
ØØR `
.
ØØ` a
	UnwrapErr
ØØa j
(
ØØj k
)
ØØk l
)
ØØl m
;
ØØm n
}
∞∞ 	&
SodiumSecureMemoryHandle
≤≤  
chainKeyHandle
≤≤! /
=
≤≤0 1
chainKeyResult
≤≤2 @
.
≤≤@ A
Unwrap
≤≤A G
(
≤≤G H
)
≤≤H I
;
≤≤I J
uint
≥≥ 
actualCacheWindow
≥≥ 
=
≥≥  
cacheWindowSize
≥≥! 0
>
≥≥1 2%
ProtocolSystemConstants
≥≥3 J
.
≥≥J K
	ChainStep
≥≥K T
.
≥≥T U-
VALIDATOR_ARRAY_EMPTY_THRESHOLD
≥≥U t
?
¥¥ 
cacheWindowSize
¥¥ 
:
µµ '
DEFAULT_CACHE_WINDOW_SIZE
µµ '
;
µµ' ('
EcliptixProtocolChainStep
∂∂ !
step
∂∂" &
=
∂∂' (
new
∂∂) ,
(
∂∂, -
stepType
∑∑ 
,
∑∑ 
chainKeyHandle
∏∏ 
,
∏∏ 
dhInfo
ππ 
.
ππ  
dhPrivateKeyHandle
ππ %
,
ππ% &
dhInfo
∫∫ 
.
∫∫ 
dhPublicKeyCloned
∫∫ $
,
∫∫$ %
actualCacheWindow
ªª 
)
ªª 
;
ªª 
return
ΩΩ 
Result
ΩΩ 
<
ΩΩ '
EcliptixProtocolChainStep
ΩΩ /
,
ΩΩ/ 0%
EcliptixProtocolFailure
ΩΩ1 H
>
ΩΩH I
.
ΩΩI J
Ok
ΩΩJ L
(
ΩΩL M
step
ΩΩM Q
)
ΩΩQ R
;
ΩΩR S
}
ææ 
private
¿¿ 
static
¿¿ 
Result
¿¿ 
<
¿¿ 
Unit
¿¿ 
,
¿¿ %
EcliptixProtocolFailure
¿¿  7
>
¿¿7 8%
ValidateInitialChainKey
¿¿9 P
(
¿¿P Q
byte
¿¿Q U
[
¿¿U V
]
¿¿V W
initialChainKey
¿¿X g
)
¿¿g h
{
¡¡ 
return
¬¬ 
initialChainKey
¬¬ 
.
¬¬ 
Length
¬¬ %
==
¬¬& (
	Constants
¬¬) 2
.
¬¬2 3
X_25519_KEY_SIZE
¬¬3 C
?
√√ 
Result
√√ 
<
√√ 
Unit
√√ 
,
√√ %
EcliptixProtocolFailure
√√ 2
>
√√2 3
.
√√3 4
Ok
√√4 6
(
√√6 7
Unit
√√7 ;
.
√√; <
Value
√√< A
)
√√A B
:
ƒƒ 
Result
ƒƒ 
<
ƒƒ 
Unit
ƒƒ 
,
ƒƒ %
EcliptixProtocolFailure
ƒƒ 2
>
ƒƒ2 3
.
ƒƒ3 4
Err
ƒƒ4 7
(
ƒƒ7 8%
EcliptixProtocolFailure
≈≈ '
.
≈≈' (
InvalidInput
≈≈( 4
(
≈≈4 5
string
≈≈5 ;
.
≈≈; <
Format
≈≈< B
(
≈≈B C-
EcliptixProtocolFailureMessages
∆∆ 3
.
∆∆3 4
	ChainStep
∆∆4 =
.
∆∆= >,
INITIAL_CHAIN_KEY_INVALID_SIZE
∆∆> \
,
∆∆\ ]
	Constants
∆∆^ g
.
∆∆g h
X_25519_KEY_SIZE
∆∆h x
)
∆∆x y
)
∆∆y z
)
∆∆z {
;
∆∆{ |
}
«« 
private
…… 
static
…… 
Result
…… 
<
…… 
(
…… &
SodiumSecureMemoryHandle
…… 3
?
……3 4 
dhPrivateKeyHandle
……5 G
,
……G H
byte
……I M
[
……M N
]
……N O
?
……O P
dhPublicKeyCloned
……Q b
)
……b c
,
……c d%
EcliptixProtocolFailure
   #
>
  # $&
ValidateAndPrepareDhKeys
ÀÀ  
(
ÀÀ  !
byte
ÀÀ! %
[
ÀÀ% &
]
ÀÀ& '
?
ÀÀ' (!
initialDhPrivateKey
ÀÀ) <
,
ÀÀ< =
byte
ÀÀ> B
[
ÀÀB C
]
ÀÀC D
?
ÀÀD E 
initialDhPublicKey
ÀÀF X
)
ÀÀX Y
{
ÃÃ 
if
ÕÕ 

(
ÕÕ !
initialDhPrivateKey
ÕÕ 
==
ÕÕ  "
null
ÕÕ# '
&&
ÕÕ( * 
initialDhPublicKey
ÕÕ+ =
==
ÕÕ> @
null
ÕÕA E
)
ÕÕE F
{
ŒŒ 	
return
œœ 
Result
œœ 
<
œœ 
(
œœ &
SodiumSecureMemoryHandle
œœ 3
?
œœ3 4
,
œœ4 5
byte
œœ6 :
[
œœ: ;
]
œœ; <
?
œœ< =
)
œœ= >
,
œœ> ?%
EcliptixProtocolFailure
œœ@ W
>
œœW X
.
œœX Y
Ok
œœY [
(
œœ[ \
(
œœ\ ]
null
œœ] a
,
œœa b
null
œœc g
)
œœg h
)
œœh i
;
œœi j
}
–– 	
if
““ 

(
““ !
initialDhPrivateKey
““ 
==
““  "
null
““# '
||
““( * 
initialDhPublicKey
““+ =
==
““> @
null
““A E
)
““E F
{
”” 	
return
‘‘ 
Result
‘‘ 
<
‘‘ 
(
‘‘ &
SodiumSecureMemoryHandle
‘‘ 3
?
‘‘3 4
,
‘‘4 5
byte
‘‘6 :
[
‘‘: ;
]
‘‘; <
?
‘‘< =
)
‘‘= >
,
‘‘> ?%
EcliptixProtocolFailure
‘‘@ W
>
‘‘W X
.
‘‘X Y
Err
‘‘Y \
(
‘‘\ ]%
EcliptixProtocolFailure
’’ '
.
’’' (
InvalidInput
’’( 4
(
’’4 5-
EcliptixProtocolFailureMessages
’’5 T
.
’’T U
	ChainStep
’’U ^
.
÷÷ )
DH_KEYS_PROVIDED_OR_NEITHER
÷÷ 0
)
÷÷0 1
)
÷÷1 2
;
÷÷2 3
}
◊◊ 	
if
ŸŸ 

(
ŸŸ !
initialDhPrivateKey
ŸŸ 
.
ŸŸ  
Length
ŸŸ  &
!=
ŸŸ' )
	Constants
ŸŸ* 3
.
ŸŸ3 4&
X_25519_PRIVATE_KEY_SIZE
ŸŸ4 L
)
ŸŸL M
{
⁄⁄ 	
return
€€ 
Result
€€ 
<
€€ 
(
€€ &
SodiumSecureMemoryHandle
€€ 3
?
€€3 4
,
€€4 5
byte
€€6 :
[
€€: ;
]
€€; <
?
€€< =
)
€€= >
,
€€> ?%
EcliptixProtocolFailure
€€@ W
>
€€W X
.
€€X Y
Err
€€Y \
(
€€\ ]%
EcliptixProtocolFailure
‹‹ '
.
‹‹' (
InvalidInput
‹‹( 4
(
‹‹4 5
string
›› 
.
›› 
Format
›› !
(
››! "-
EcliptixProtocolFailureMessages
››" A
.
››A B
	ChainStep
››B K
.
››K L1
#INITIAL_DH_PRIVATE_KEY_INVALID_SIZE
››L o
,
››o p
	Constants
ﬁﬁ !
.
ﬁﬁ! "&
X_25519_PRIVATE_KEY_SIZE
ﬁﬁ" :
)
ﬁﬁ: ;
)
ﬁﬁ; <
)
ﬁﬁ< =
;
ﬁﬁ= >
}
ﬂﬂ 	
if
·· 

(
··  
initialDhPublicKey
·· 
.
·· 
Length
·· %
!=
··& (
	Constants
··) 2
.
··2 3
X_25519_KEY_SIZE
··3 C
)
··C D
{
‚‚ 	
return
„„ 
Result
„„ 
<
„„ 
(
„„ &
SodiumSecureMemoryHandle
„„ 3
?
„„3 4
,
„„4 5
byte
„„6 :
[
„„: ;
]
„„; <
?
„„< =
)
„„= >
,
„„> ?%
EcliptixProtocolFailure
„„@ W
>
„„W X
.
„„X Y
Err
„„Y \
(
„„\ ]%
EcliptixProtocolFailure
‰‰ '
.
‰‰' (
InvalidInput
‰‰( 4
(
‰‰4 5
string
ÂÂ 
.
ÂÂ 
Format
ÂÂ !
(
ÂÂ! "-
EcliptixProtocolFailureMessages
ÂÂ" A
.
ÂÂA B
	ChainStep
ÂÂB K
.
ÂÂK L0
"INITIAL_DH_PUBLIC_KEY_INVALID_SIZE
ÂÂL n
,
ÂÂn o
	Constants
ÊÊ !
.
ÊÊ! "
X_25519_KEY_SIZE
ÊÊ" 2
)
ÊÊ2 3
)
ÊÊ3 4
)
ÊÊ4 5
;
ÊÊ5 6
}
ÁÁ 	&
SodiumSecureMemoryHandle
ÈÈ  
?
ÈÈ  ! 
dhPrivateKeyHandle
ÈÈ" 4
=
ÈÈ5 6
null
ÈÈ7 ;
;
ÈÈ; <
try
ÍÍ 
{
ÎÎ 	
Result
ÏÏ 
<
ÏÏ &
SodiumSecureMemoryHandle
ÏÏ +
,
ÏÏ+ ,
SodiumFailure
ÏÏ- :
>
ÏÏ: ;
allocResult
ÏÏ< G
=
ÏÏH I&
SodiumSecureMemoryHandle
ÌÌ (
.
ÌÌ( )
Allocate
ÌÌ) 1
(
ÌÌ1 2
	Constants
ÌÌ2 ;
.
ÌÌ; <&
X_25519_PRIVATE_KEY_SIZE
ÌÌ< T
)
ÌÌT U
;
ÌÌU V
if
ÓÓ 
(
ÓÓ 
allocResult
ÓÓ 
.
ÓÓ 
IsErr
ÓÓ !
)
ÓÓ! "
{
ÔÔ 
return
 
Result
 
<
 
(
 &
SodiumSecureMemoryHandle
 7
?
7 8
,
8 9
byte
: >
[
> ?
]
? @
?
@ A
)
A B
,
B C%
EcliptixProtocolFailure
D [
>
[ \
.
\ ]
Err
] `
(
` a
allocResult
ÒÒ 
.
ÒÒ  
	UnwrapErr
ÒÒ  )
(
ÒÒ) *
)
ÒÒ* +
.
ÒÒ+ ,'
ToEcliptixProtocolFailure
ÒÒ, E
(
ÒÒE F
)
ÒÒF G
)
ÒÒG H
;
ÒÒH I
}
ÚÚ  
dhPrivateKeyHandle
ÙÙ 
=
ÙÙ  
allocResult
ÙÙ! ,
.
ÙÙ, -
Unwrap
ÙÙ- 3
(
ÙÙ3 4
)
ÙÙ4 5
;
ÙÙ5 6
Result
ıı 
<
ıı 
Unit
ıı 
,
ıı 
SodiumFailure
ıı &
>
ıı& '
writeResult
ıı( 3
=
ıı4 5 
dhPrivateKeyHandle
ıı6 H
.
ııH I
Write
ııI N
(
ııN O!
initialDhPrivateKey
ııO b
)
ııb c
;
ııc d
if
ˆˆ 
(
ˆˆ 
writeResult
ˆˆ 
.
ˆˆ 
IsErr
ˆˆ !
)
ˆˆ! "
{
˜˜  
dhPrivateKeyHandle
¯¯ "
.
¯¯" #
Dispose
¯¯# *
(
¯¯* +
)
¯¯+ ,
;
¯¯, - 
dhPrivateKeyHandle
˘˘ "
=
˘˘# $
null
˘˘% )
;
˘˘) *
return
˙˙ 
Result
˙˙ 
<
˙˙ 
(
˙˙ &
SodiumSecureMemoryHandle
˙˙ 7
?
˙˙7 8
,
˙˙8 9
byte
˙˙: >
[
˙˙> ?
]
˙˙? @
?
˙˙@ A
)
˙˙A B
,
˙˙B C%
EcliptixProtocolFailure
˙˙D [
>
˙˙[ \
.
˙˙\ ]
Err
˙˙] `
(
˙˙` a
writeResult
˚˚ 
.
˚˚  
	UnwrapErr
˚˚  )
(
˚˚) *
)
˚˚* +
.
˚˚+ ,'
ToEcliptixProtocolFailure
˚˚, E
(
˚˚E F
)
˚˚F G
)
˚˚G H
;
˚˚H I
}
¸¸ 
byte
˛˛ 
[
˛˛ 
]
˛˛ 
dhPublicKeyCloned
˛˛ $
=
˛˛% &
(
˛˛' (
byte
˛˛( ,
[
˛˛, -
]
˛˛- .
)
˛˛. / 
initialDhPublicKey
˛˛/ A
.
˛˛A B
Clone
˛˛B G
(
˛˛G H
)
˛˛H I
;
˛˛I J
return
ˇˇ 
Result
ˇˇ 
<
ˇˇ 
(
ˇˇ &
SodiumSecureMemoryHandle
ˇˇ 3
?
ˇˇ3 4
,
ˇˇ4 5
byte
ˇˇ6 :
[
ˇˇ: ;
]
ˇˇ; <
?
ˇˇ< =
)
ˇˇ= >
,
ˇˇ> ?%
EcliptixProtocolFailure
ˇˇ@ W
>
ˇˇW X
.
ˇˇX Y
Ok
ˇˇY [
(
ˇˇ[ \
(
ÄÄ  
dhPrivateKeyHandle
ÄÄ #
,
ÄÄ# $
dhPublicKeyCloned
ÄÄ% 6
)
ÄÄ6 7
)
ÄÄ7 8
;
ÄÄ8 9
}
ÅÅ 	
catch
ÇÇ 
(
ÇÇ 
	Exception
ÇÇ 
ex
ÇÇ 
)
ÇÇ 
{
ÉÉ 	 
dhPrivateKeyHandle
ÑÑ 
?
ÑÑ 
.
ÑÑ  
Dispose
ÑÑ  '
(
ÑÑ' (
)
ÑÑ( )
;
ÑÑ) *
return
ÖÖ 
Result
ÖÖ 
<
ÖÖ 
(
ÖÖ &
SodiumSecureMemoryHandle
ÖÖ 3
?
ÖÖ3 4
,
ÖÖ4 5
byte
ÖÖ6 :
[
ÖÖ: ;
]
ÖÖ; <
?
ÖÖ< =
)
ÖÖ= >
,
ÖÖ> ?%
EcliptixProtocolFailure
ÖÖ@ W
>
ÖÖW X
.
ÖÖX Y
Err
ÖÖY \
(
ÖÖ\ ]%
EcliptixProtocolFailure
ÜÜ '
.
ÜÜ' (
Generic
ÜÜ( /
(
ÜÜ/ 0-
EcliptixProtocolFailureMessages
áá 3
.
áá3 4
	ChainStep
áá4 =
.
áá= >0
"UNEXPECTED_ERROR_PREPARING_DH_KEYS
áá> `
,
áá` a
ex
ááb d
)
áád e
)
ááe f
;
ááf g
}
àà 	
}
ââ 
private
ãã 
static
ãã 
Result
ãã 
<
ãã &
SodiumSecureMemoryHandle
ãã 2
,
ãã2 3%
EcliptixProtocolFailure
ãã4 K
>
ããK L&
AllocateAndWriteChainKey
ããM e
(
ããe f
byte
åå 
[
åå 
]
åå 
initialChainKey
åå 
)
åå 
{
çç 
Result
éé 
<
éé &
SodiumSecureMemoryHandle
éé '
,
éé' (
SodiumFailure
éé) 6
>
éé6 7
allocResult
éé8 C
=
ééD E&
SodiumSecureMemoryHandle
èè $
.
èè$ %
Allocate
èè% -
(
èè- .
	Constants
èè. 7
.
èè7 8
X_25519_KEY_SIZE
èè8 H
)
èèH I
;
èèI J
if
êê 

(
êê 
allocResult
êê 
.
êê 
IsErr
êê 
)
êê 
{
ëë 	
return
íí 
Result
íí 
<
íí &
SodiumSecureMemoryHandle
íí 2
,
íí2 3%
EcliptixProtocolFailure
íí4 K
>
ííK L
.
ííL M
Err
ííM P
(
ííP Q
allocResult
ìì 
.
ìì 
	UnwrapErr
ìì %
(
ìì% &
)
ìì& '
.
ìì' ('
ToEcliptixProtocolFailure
ìì( A
(
ììA B
)
ììB C
)
ììC D
;
ììD E
}
îî 	&
SodiumSecureMemoryHandle
ññ  
chainKeyHandle
ññ! /
=
ññ0 1
allocResult
ññ2 =
.
ññ= >
Unwrap
ññ> D
(
ññD E
)
ññE F
;
ññF G
Result
óó 
<
óó 
Unit
óó 
,
óó 
SodiumFailure
óó "
>
óó" #
writeResult
óó$ /
=
óó0 1
chainKeyHandle
óó2 @
.
óó@ A
Write
óóA F
(
óóF G
initialChainKey
óóG V
)
óóV W
;
óóW X
if
òò 

(
òò 
!
òò 
writeResult
òò 
.
òò 
IsErr
òò 
)
òò 
{
ôô 	
return
öö 
Result
öö 
<
öö &
SodiumSecureMemoryHandle
öö 2
,
öö2 3%
EcliptixProtocolFailure
öö4 K
>
ööK L
.
ööL M
Ok
ööM O
(
ööO P
chainKeyHandle
ööP ^
)
öö^ _
;
öö_ `
}
õõ 	
chainKeyHandle
ùù 
.
ùù 
Dispose
ùù 
(
ùù 
)
ùù  
;
ùù  !
return
ûû 
Result
ûû 
<
ûû &
SodiumSecureMemoryHandle
ûû .
,
ûû. /%
EcliptixProtocolFailure
ûû0 G
>
ûûG H
.
ûûH I
Err
ûûI L
(
ûûL M
writeResult
üü 
.
üü 
	UnwrapErr
üü !
(
üü! "
)
üü" #
.
üü# $'
ToEcliptixProtocolFailure
üü$ =
(
üü= >
)
üü> ?
)
üü? @
;
üü@ A
}
†† 
internal
¢¢ 
Result
¢¢ 
<
¢¢ 
RatchetChainKey
¢¢ #
,
¢¢# $%
EcliptixProtocolFailure
¢¢% <
>
¢¢< =
GetOrDeriveKeyFor
¢¢> O
(
¢¢O P
uint
¢¢P T
targetIndex
¢¢U `
)
¢¢` a
{
££ 
if
§§ 

(
§§ 
	_disposed
§§ 
)
§§ 
{
•• 	
return
¶¶ 
Result
¶¶ 
<
¶¶ 
RatchetChainKey
¶¶ )
,
¶¶) *%
EcliptixProtocolFailure
¶¶+ B
>
¶¶B C
.
¶¶C D
Err
¶¶D G
(
¶¶G H%
EcliptixProtocolFailure
ßß '
.
ßß' (
OBJECT_DISPOSED
ßß( 7
(
ßß7 8
nameof
ßß8 >
(
ßß> ?'
EcliptixProtocolChainStep
ßß? X
)
ßßX Y
)
ßßY Z
)
ßßZ [
;
ßß[ \
}
®® 	
if
™™ 

(
™™ 
_messageKeys
™™ 
.
™™ 
ContainsKey
™™ $
(
™™$ %
targetIndex
™™% 0
)
™™0 1
)
™™1 2
{
´´ 	
return
¨¨ 
Result
¨¨ 
<
¨¨ 
RatchetChainKey
¨¨ )
,
¨¨) *%
EcliptixProtocolFailure
¨¨+ B
>
¨¨B C
.
¨¨C D
Ok
¨¨D F
(
¨¨F G
new
¨¨G J
RatchetChainKey
¨¨K Z
(
¨¨Z [
targetIndex
¨¨[ f
,
¨¨f g
this
¨¨h l
)
¨¨l m
)
¨¨m n
;
¨¨n o
}
≠≠ 	
Result
ØØ 
<
ØØ 
uint
ØØ 
,
ØØ %
EcliptixProtocolFailure
ØØ ,
>
ØØ, - 
currentIndexResult
ØØ. @
=
ØØA B
GetCurrentIndex
ØØC R
(
ØØR S
)
ØØS T
;
ØØT U
if
∞∞ 

(
∞∞  
currentIndexResult
∞∞ 
.
∞∞ 
IsErr
∞∞ $
)
∞∞$ %
{
±± 	
return
≤≤ 
Result
≤≤ 
<
≤≤ 
RatchetChainKey
≤≤ )
,
≤≤) *%
EcliptixProtocolFailure
≤≤+ B
>
≤≤B C
.
≤≤C D
Err
≤≤D G
(
≤≤G H 
currentIndexResult
≤≤H Z
.
≤≤Z [
	UnwrapErr
≤≤[ d
(
≤≤d e
)
≤≤e f
)
≤≤f g
;
≤≤g h
}
≥≥ 	
uint
µµ 
currentIndex
µµ 
=
µµ  
currentIndexResult
µµ .
.
µµ. /
Unwrap
µµ/ 5
(
µµ5 6
)
µµ6 7
;
µµ7 8
if
∑∑ 

(
∑∑ 
targetIndex
∑∑ 
<=
∑∑ 
currentIndex
∑∑ '
)
∑∑' (
{
∏∏ 	
return
ππ 
Result
ππ 
<
ππ 
RatchetChainKey
ππ )
,
ππ) *%
EcliptixProtocolFailure
ππ+ B
>
ππB C
.
ππC D
Err
ππD G
(
ππG H%
EcliptixProtocolFailure
∫∫ '
.
∫∫' (
InvalidInput
∫∫( 4
(
∫∫4 5
string
ªª 
.
ªª 
Format
ªª !
(
ªª! "-
EcliptixProtocolFailureMessages
ªª" A
.
ªªA B
	ChainStep
ªªB K
.
ªªK L(
REQUESTED_INDEX_NOT_FUTURE
ªªL f
,
ªªf g
	_stepType
ªªh q
,
ªªq r
targetIndex
ºº #
,
ºº# $
currentIndex
ºº% 1
)
ºº1 2
)
ºº2 3
)
ºº3 4
;
ºº4 5
}
ΩΩ 	
Result
øø 
<
øø 
byte
øø 
[
øø 
]
øø 
,
øø %
EcliptixProtocolFailure
øø .
>
øø. /
chainKeyResult
øø0 >
=
øø? @
_chainKeyHandle
øøA P
.
øøP Q
	ReadBytes
øøQ Z
(
øøZ [
	Constants
øø[ d
.
øød e
X_25519_KEY_SIZE
øøe u
)
øøu v
.
¿¿ 
MapSodiumFailure
¿¿ 
(
¿¿ 
)
¿¿ 
;
¿¿  
if
¡¡ 

(
¡¡ 
chainKeyResult
¡¡ 
.
¡¡ 
IsErr
¡¡  
)
¡¡  !
{
¬¬ 	
return
√√ 
Result
√√ 
<
√√ 
RatchetChainKey
√√ )
,
√√) *%
EcliptixProtocolFailure
√√+ B
>
√√B C
.
√√C D
Err
√√D G
(
√√G H
chainKeyResult
√√H V
.
√√V W
	UnwrapErr
√√W `
(
√√` a
)
√√a b
)
√√b c
;
√√c d
}
ƒƒ 	
byte
∆∆ 
[
∆∆ 
]
∆∆ 
chainKey
∆∆ 
=
∆∆ 
chainKeyResult
∆∆ (
.
∆∆( )
Unwrap
∆∆) /
(
∆∆/ 0
)
∆∆0 1
;
∆∆1 2
try
»» 
{
…… 	
Result
   
<
   
Unit
   
,
   %
EcliptixProtocolFailure
   0
>
  0 1
deriveResult
ÀÀ 
=
ÀÀ  
DeriveKeysToTarget
ÀÀ 1
(
ÀÀ1 2
chainKey
ÀÀ2 :
,
ÀÀ: ;
currentIndex
ÀÀ< H
,
ÀÀH I
targetIndex
ÀÀJ U
)
ÀÀU V
;
ÀÀV W
if
ÃÃ 
(
ÃÃ 
deriveResult
ÃÃ 
.
ÃÃ 
IsErr
ÃÃ "
)
ÃÃ" #
{
ÕÕ 
return
ŒŒ 
Result
ŒŒ 
<
ŒŒ 
RatchetChainKey
ŒŒ -
,
ŒŒ- .%
EcliptixProtocolFailure
ŒŒ/ F
>
ŒŒF G
.
ŒŒG H
Err
ŒŒH K
(
ŒŒK L
deriveResult
ŒŒL X
.
ŒŒX Y
	UnwrapErr
ŒŒY b
(
ŒŒb c
)
ŒŒc d
)
ŒŒd e
;
ŒŒe f
}
œœ 
Result
—— 
<
—— 
Unit
—— 
,
—— %
EcliptixProtocolFailure
—— 0
>
——0 1
setIndexResult
——2 @
=
——A B
SetCurrentIndex
——C R
(
——R S
targetIndex
——S ^
)
——^ _
;
——_ `
if
““ 
(
““ 
setIndexResult
““ 
.
““ 
IsErr
““ $
)
““$ %
{
”” 
return
‘‘ 
Result
‘‘ 
<
‘‘ 
RatchetChainKey
‘‘ -
,
‘‘- .%
EcliptixProtocolFailure
‘‘/ F
>
‘‘F G
.
‘‘G H
Err
‘‘H K
(
‘‘K L
setIndexResult
‘‘L Z
.
‘‘Z [
	UnwrapErr
‘‘[ d
(
‘‘d e
)
‘‘e f
)
‘‘f g
;
‘‘g h
}
’’ 
PruneOldKeys
◊◊ 
(
◊◊ 
)
◊◊ 
;
◊◊ 
return
ŸŸ 
_messageKeys
ŸŸ 
.
ŸŸ  
ContainsKey
ŸŸ  +
(
ŸŸ+ ,
targetIndex
ŸŸ, 7
)
ŸŸ7 8
?
⁄⁄ 
Result
⁄⁄ 
<
⁄⁄ 
RatchetChainKey
⁄⁄ (
,
⁄⁄( )%
EcliptixProtocolFailure
⁄⁄* A
>
⁄⁄A B
.
⁄⁄B C
Ok
⁄⁄C E
(
⁄⁄E F
new
⁄⁄F I
RatchetChainKey
⁄⁄J Y
(
⁄⁄Y Z
targetIndex
⁄⁄Z e
,
⁄⁄e f
this
⁄⁄g k
)
⁄⁄k l
)
⁄⁄l m
:
€€ 
Result
€€ 
<
€€ 
RatchetChainKey
€€ (
,
€€( )%
EcliptixProtocolFailure
€€* A
>
€€A B
.
€€B C
Err
€€C F
(
€€F G%
EcliptixProtocolFailure
‹‹ +
.
‹‹+ ,
Generic
‹‹, 3
(
‹‹3 4
string
›› 
.
›› 
Format
›› %
(
››% &-
EcliptixProtocolFailureMessages
››& E
.
››E F
	ChainStep
››F O
.
››O P,
DERIVED_KEY_MISSING_AFTER_LOOP
››P n
,
››n o
targetIndex
ﬁﬁ '
)
ﬁﬁ' (
)
ﬁﬁ( )
)
ﬁﬁ) *
;
ﬁﬁ* +
}
ﬂﬂ 	
finally
‡‡ 
{
·· 	
SodiumInterop
‚‚ 
.
‚‚ 

SecureWipe
‚‚ $
(
‚‚$ %
chainKey
‚‚% -
)
‚‚- .
;
‚‚. /
}
„„ 	
}
‰‰ 
private
ÊÊ 
Result
ÊÊ 
<
ÊÊ 
Unit
ÊÊ 
,
ÊÊ %
EcliptixProtocolFailure
ÊÊ 0
>
ÊÊ0 1 
DeriveKeysToTarget
ÊÊ2 D
(
ÊÊD E
byte
ÊÊE I
[
ÊÊI J
]
ÊÊJ K
chainKey
ÊÊL T
,
ÊÊT U
uint
ÊÊV Z
currentIndex
ÊÊ[ g
,
ÊÊg h
uint
ÁÁ 
targetIndex
ÁÁ 
)
ÁÁ 
{
ËË 
Span
ÈÈ 
<
ÈÈ 
byte
ÈÈ 
>
ÈÈ 
currentChainKey
ÈÈ "
=
ÈÈ# $

stackalloc
ÈÈ% /
byte
ÈÈ0 4
[
ÈÈ4 5
	Constants
ÈÈ5 >
.
ÈÈ> ?
X_25519_KEY_SIZE
ÈÈ? O
]
ÈÈO P
;
ÈÈP Q
Span
ÍÍ 
<
ÍÍ 
byte
ÍÍ 
>
ÍÍ 
nextChainKey
ÍÍ 
=
ÍÍ  !

stackalloc
ÍÍ" ,
byte
ÍÍ- 1
[
ÍÍ1 2
	Constants
ÍÍ2 ;
.
ÍÍ; <
X_25519_KEY_SIZE
ÍÍ< L
]
ÍÍL M
;
ÍÍM N
Span
ÎÎ 
<
ÎÎ 
byte
ÎÎ 
>
ÎÎ 
msgKey
ÎÎ 
=
ÎÎ 

stackalloc
ÎÎ &
byte
ÎÎ' +
[
ÎÎ+ ,
	Constants
ÎÎ, 5
.
ÎÎ5 6
AES_KEY_SIZE
ÎÎ6 B
]
ÎÎB C
;
ÎÎC D
chainKey
ÌÌ 
.
ÌÌ 
CopyTo
ÌÌ 
(
ÌÌ 
currentChainKey
ÌÌ '
)
ÌÌ' (
;
ÌÌ( )
for
ÔÔ 
(
ÔÔ 
uint
ÔÔ 
idx
ÔÔ 
=
ÔÔ 
currentIndex
ÔÔ $
+
ÔÔ% &%
ProtocolSystemConstants
ÔÔ' >
.
ÔÔ> ?
	ChainStep
ÔÔ? H
.
ÔÔH I
INDEX_INCREMENT
ÔÔI X
;
ÔÔX Y
idx
ÔÔZ ]
<=
ÔÔ^ `
targetIndex
ÔÔa l
;
ÔÔl m
idx
ÔÔn q
++
ÔÔq s
)
ÔÔs t
{
 	
Result
ÒÒ 
<
ÒÒ 
Unit
ÒÒ 
,
ÒÒ %
EcliptixProtocolFailure
ÒÒ 0
>
ÒÒ0 1
deriveResult
ÒÒ2 >
=
ÒÒ? @!
DeriveNextChainKeys
ÚÚ #
(
ÚÚ# $
currentChainKey
ÚÚ$ 3
,
ÚÚ3 4
nextChainKey
ÚÚ5 A
,
ÚÚA B
msgKey
ÚÚC I
,
ÚÚI J
idx
ÚÚK N
)
ÚÚN O
;
ÚÚO P
if
ÛÛ 
(
ÛÛ 
deriveResult
ÛÛ 
.
ÛÛ 
IsErr
ÛÛ "
)
ÛÛ" #
{
ÙÙ 
return
ıı 
deriveResult
ıı #
;
ıı# $
}
ˆˆ 
Result
¯¯ 
<
¯¯ 
Unit
¯¯ 
,
¯¯ %
EcliptixProtocolFailure
¯¯ 0
>
¯¯0 1
storeResult
¯¯2 =
=
¯¯> ?
StoreMessageKey
¯¯@ O
(
¯¯O P
msgKey
¯¯P V
,
¯¯V W
nextChainKey
¯¯X d
,
¯¯d e
idx
¯¯f i
)
¯¯i j
;
¯¯j k
if
˘˘ 
(
˘˘ 
storeResult
˘˘ 
.
˘˘ 
IsErr
˘˘ !
)
˘˘! "
{
˙˙ 
return
˚˚ 
storeResult
˚˚ "
;
˚˚" #
}
¸¸ 
nextChainKey
˛˛ 
.
˛˛ 
CopyTo
˛˛ 
(
˛˛  
currentChainKey
˛˛  /
)
˛˛/ 0
;
˛˛0 1
}
ˇˇ 	
return
ÅÅ 
Result
ÅÅ 
<
ÅÅ 
Unit
ÅÅ 
,
ÅÅ %
EcliptixProtocolFailure
ÅÅ 3
>
ÅÅ3 4
.
ÅÅ4 5
Ok
ÅÅ5 7
(
ÅÅ7 8
Unit
ÅÅ8 <
.
ÅÅ< =
Value
ÅÅ= B
)
ÅÅB C
;
ÅÅC D
}
ÇÇ 
private
ÑÑ 
static
ÑÑ 
Result
ÑÑ 
<
ÑÑ 
Unit
ÑÑ 
,
ÑÑ %
EcliptixProtocolFailure
ÑÑ  7
>
ÑÑ7 8!
DeriveNextChainKeys
ÑÑ9 L
(
ÑÑL M
Span
ÖÖ 
<
ÖÖ 
byte
ÖÖ 
>
ÖÖ 
currentChainKey
ÖÖ "
,
ÖÖ" #
Span
ÜÜ 
<
ÜÜ 
byte
ÜÜ 
>
ÜÜ 
nextChainKey
ÜÜ 
,
ÜÜ  
Span
áá 
<
áá 
byte
áá 
>
áá 
msgKey
áá 
,
áá 
uint
àà 
idx
àà 
)
àà 
{
ââ 
try
ää 
{
ãã 	
HKDF
åå 
.
åå 
	DeriveKey
åå 
(
åå 
HashAlgorithmName
çç !
.
çç! "
SHA256
çç" (
,
çç( )
ikm
éé 
:
éé 
currentChainKey
éé $
,
éé$ %
output
èè 
:
èè 
msgKey
èè 
,
èè 
salt
êê 
:
êê 
null
êê 
,
êê 
info
ëë 
:
ëë 
	Constants
ëë 
.
ëë  
MsgInfo
ëë  '
)
íí 
;
íí 
HKDF
îî 
.
îî 
	DeriveKey
îî 
(
îî 
HashAlgorithmName
ïï !
.
ïï! "
SHA256
ïï" (
,
ïï( )
ikm
ññ 
:
ññ 
currentChainKey
ññ $
,
ññ$ %
output
óó 
:
óó 
nextChainKey
óó $
,
óó$ %
salt
òò 
:
òò 
null
òò 
,
òò 
info
ôô 
:
ôô 
	Constants
ôô 
.
ôô  
	ChainInfo
ôô  )
)
öö 
;
öö 
return
úú 
Result
úú 
<
úú 
Unit
úú 
,
úú %
EcliptixProtocolFailure
úú  7
>
úú7 8
.
úú8 9
Ok
úú9 ;
(
úú; <
Unit
úú< @
.
úú@ A
Value
úúA F
)
úúF G
;
úúG H
}
ùù 	
catch
ûû 
(
ûû 
	Exception
ûû 
ex
ûû 
)
ûû 
{
üü 	
return
†† 
Result
†† 
<
†† 
Unit
†† 
,
†† %
EcliptixProtocolFailure
††  7
>
††7 8
.
††8 9
Err
††9 <
(
††< =%
EcliptixProtocolFailure
°° '
.
°°' (
	DeriveKey
°°( 1
(
°°1 2
string
¢¢ 
.
¢¢ 
Format
¢¢ !
(
¢¢! "-
EcliptixProtocolFailureMessages
¢¢" A
.
¢¢A B
	ChainStep
¢¢B K
.
¢¢K L+
HKDF_FAILED_DURING_DERIVATION
¢¢L i
,
¢¢i j
idx
¢¢k n
)
¢¢n o
,
¢¢o p
ex
¢¢q s
)
¢¢s t
)
¢¢t u
;
¢¢u v
}
££ 	
}
§§ 
private
¶¶ 
Result
¶¶ 
<
¶¶ 
Unit
¶¶ 
,
¶¶ %
EcliptixProtocolFailure
¶¶ 0
>
¶¶0 1
StoreMessageKey
¶¶2 A
(
¶¶A B
Span
¶¶B F
<
¶¶F G
byte
¶¶G K
>
¶¶K L
msgKey
¶¶M S
,
¶¶S T
Span
¶¶U Y
<
¶¶Y Z
byte
¶¶Z ^
>
¶¶^ _
nextChainKey
¶¶` l
,
¶¶l m
uint
¶¶n r
idx
¶¶s v
)
¶¶v w
{
ßß 
Result
®® 
<
®® &
SodiumSecureMemoryHandle
®® '
,
®®' (
SodiumFailure
®®) 6
>
®®6 7 
secureHandleResult
®®8 J
=
®®K L&
SodiumSecureMemoryHandle
©© $
.
©©$ %
Allocate
©©% -
(
©©- .
	Constants
©©. 7
.
©©7 8
X_25519_KEY_SIZE
©©8 H
)
©©H I
;
©©I J
if
´´ 

(
´´  
secureHandleResult
´´ 
.
´´ 
IsErr
´´ $
)
´´$ %
{
¨¨ 	
return
≠≠ 
Result
≠≠ 
<
≠≠ 
Unit
≠≠ 
,
≠≠ %
EcliptixProtocolFailure
≠≠  7
>
≠≠7 8
.
≠≠8 9
Err
≠≠9 <
(
≠≠< =%
EcliptixProtocolFailure
ÆÆ '
.
ÆÆ' (
Generic
ÆÆ( /
(
ÆÆ/ 0
string
ØØ 
.
ØØ 
Format
ØØ !
(
ØØ! "-
EcliptixProtocolFailureMessages
ØØ" A
.
ØØA B
	ChainStep
ØØB K
.
ØØK L.
 FAILED_TO_ALLOCATE_SECURE_MEMORY
ØØL l
,
ØØl m
idx
ØØn q
)
ØØq r
)
ØØr s
)
ØØs t
;
ØØt u
}
∞∞ 	&
SodiumSecureMemoryHandle
≤≤  
secureHandle
≤≤! -
=
≤≤. / 
secureHandleResult
≤≤0 B
.
≤≤B C
Unwrap
≤≤C I
(
≤≤I J
)
≤≤J K
;
≤≤K L
Result
≥≥ 
<
≥≥ 
Unit
≥≥ 
,
≥≥ 
SodiumFailure
≥≥ "
>
≥≥" #
writeResult
≥≥$ /
=
≥≥0 1
secureHandle
≥≥2 >
.
≥≥> ?
Write
≥≥? D
(
≥≥D E
msgKey
≥≥E K
)
≥≥K L
;
≥≥L M
if
¥¥ 

(
¥¥ 
writeResult
¥¥ 
.
¥¥ 
IsErr
¥¥ 
)
¥¥ 
{
µµ 	
secureHandle
∂∂ 
.
∂∂ 
Dispose
∂∂  
(
∂∂  !
)
∂∂! "
;
∂∂" #
return
∑∑ 
Result
∑∑ 
<
∑∑ 
Unit
∑∑ 
,
∑∑ %
EcliptixProtocolFailure
∑∑  7
>
∑∑7 8
.
∑∑8 9
Err
∑∑9 <
(
∑∑< =
writeResult
∏∏ 
.
∏∏ 
	UnwrapErr
∏∏ %
(
∏∏% &
)
∏∏& '
.
∏∏' ('
ToEcliptixProtocolFailure
∏∏( A
(
∏∏A B
)
∏∏B C
)
∏∏C D
;
∏∏D E
}
ππ 	
if
ªª 

(
ªª 
!
ªª 
_messageKeys
ªª 
.
ªª 
TryAdd
ªª  
(
ªª  !
idx
ªª! $
,
ªª$ %
secureHandle
ªª& 2
)
ªª2 3
)
ªª3 4
{
ºº 	
secureHandle
ΩΩ 
.
ΩΩ 
Dispose
ΩΩ  
(
ΩΩ  !
)
ΩΩ! "
;
ΩΩ" #
return
ææ 
Result
ææ 
<
ææ 
Unit
ææ 
,
ææ %
EcliptixProtocolFailure
ææ  7
>
ææ7 8
.
ææ8 9
Err
ææ9 <
(
ææ< =%
EcliptixProtocolFailure
øø '
.
øø' (
Generic
øø( /
(
øø/ 0
string
¿¿ 
.
¿¿ 
Format
¿¿ !
(
¿¿! "-
EcliptixProtocolFailureMessages
¿¿" A
.
¿¿A B
	ChainStep
¿¿B K
.
¿¿K L'
KEY_UNEXPECTEDLY_APPEARED
¿¿L e
,
¿¿e f
idx
¿¿g j
)
¿¿j k
)
¿¿k l
)
¿¿l m
;
¿¿m n
}
¡¡ 	
Result
√√ 
<
√√ 
Unit
√√ 
,
√√ %
EcliptixProtocolFailure
√√ ,
>
√√, -
chainWriteResult
√√. >
=
√√? @
_chainKeyHandle
ƒƒ 
.
ƒƒ 
Write
ƒƒ !
(
ƒƒ! "
nextChainKey
ƒƒ" .
)
ƒƒ. /
.
ƒƒ/ 0
MapSodiumFailure
ƒƒ0 @
(
ƒƒ@ A
)
ƒƒA B
;
ƒƒB C
if
≈≈ 

(
≈≈ 
chainWriteResult
≈≈ 
.
≈≈ 
IsErr
≈≈ "
)
≈≈" #
{
∆∆ 	
_messageKeys
«« 
.
«« 
Remove
«« 
(
««  
idx
««  #
,
««# $
out
««% (&
SodiumSecureMemoryHandle
««) A
?
««A B
removedHandle
««C P
)
««P Q
;
««Q R
removedHandle
»» 
?
»» 
.
»» 
Dispose
»» "
(
»»" #
)
»»# $
;
»»$ %
return
…… 
Result
…… 
<
…… 
Unit
…… 
,
…… %
EcliptixProtocolFailure
……  7
>
……7 8
.
……8 9
Err
……9 <
(
……< =
chainWriteResult
……= M
.
……M N
	UnwrapErr
……N W
(
……W X
)
……X Y
)
……Y Z
;
……Z [
}
   	
return
ÃÃ 
Result
ÃÃ 
<
ÃÃ 
Unit
ÃÃ 
,
ÃÃ %
EcliptixProtocolFailure
ÃÃ 3
>
ÃÃ3 4
.
ÃÃ4 5
Ok
ÃÃ5 7
(
ÃÃ7 8
Unit
ÃÃ8 <
.
ÃÃ< =
Value
ÃÃ= B
)
ÃÃB C
;
ÃÃC D
}
ÕÕ 
public
œœ 

Result
œœ 
<
œœ 
Unit
œœ 
,
œœ %
EcliptixProtocolFailure
œœ /
>
œœ/ 0
SkipKeysUntil
œœ1 >
(
œœ> ?
uint
œœ? C
targetIndex
œœD O
)
œœO P
{
–– 
if
—— 

(
—— 
_currentIndex
—— 
>=
—— 
targetIndex
—— (
)
——( )
{
““ 	
return
”” 
Result
”” 
<
”” 
Unit
”” 
,
”” %
EcliptixProtocolFailure
””  7
>
””7 8
.
””8 9
Ok
””9 ;
(
””; <
Unit
””< @
.
””@ A
Value
””A F
)
””F G
;
””G H
}
‘‘ 	
for
÷÷ 
(
÷÷ 
uint
÷÷ 
i
÷÷ 
=
÷÷ 
_currentIndex
÷÷ #
+
÷÷$ %%
ProtocolSystemConstants
÷÷& =
.
÷÷= >
	ChainStep
÷÷> G
.
÷÷G H
INDEX_INCREMENT
÷÷H W
;
÷÷W X
i
÷÷Y Z
<=
÷÷[ ]
targetIndex
÷÷^ i
;
÷÷i j
i
÷÷k l
++
÷÷l n
)
÷÷n o
{
◊◊ 	
Result
ÿÿ 
<
ÿÿ 
RatchetChainKey
ÿÿ "
,
ÿÿ" #%
EcliptixProtocolFailure
ÿÿ$ ;
>
ÿÿ; <
	keyResult
ÿÿ= F
=
ÿÿG H
GetOrDeriveKeyFor
ÿÿI Z
(
ÿÿZ [
i
ÿÿ[ \
)
ÿÿ\ ]
;
ÿÿ] ^
if
ŸŸ 
(
ŸŸ 
	keyResult
ŸŸ 
.
ŸŸ 
IsErr
ŸŸ 
)
ŸŸ  
{
⁄⁄ 
return
€€ 
Result
€€ 
<
€€ 
Unit
€€ "
,
€€" #%
EcliptixProtocolFailure
€€$ ;
>
€€; <
.
€€< =
Err
€€= @
(
€€@ A
	keyResult
€€A J
.
€€J K
	UnwrapErr
€€K T
(
€€T U
)
€€U V
)
€€V W
;
€€W X
}
‹‹ 
}
›› 	
return
ﬂﬂ 
SetCurrentIndex
ﬂﬂ 
(
ﬂﬂ 
targetIndex
ﬂﬂ *
)
ﬂﬂ* +
;
ﬂﬂ+ ,
}
‡‡ 
internal
‚‚ &
SodiumSecureMemoryHandle
‚‚ %
?
‚‚% &#
GetDhPrivateKeyHandle
‚‚' <
(
‚‚< =
)
‚‚= >
{
„„ 
return
‰‰ !
_dhPrivateKeyHandle
‰‰ "
;
‰‰" #
}
ÂÂ 
public
ÁÁ 

Result
ÁÁ 
<
ÁÁ 
ChainStepState
ÁÁ  
,
ÁÁ  !%
EcliptixProtocolFailure
ÁÁ" 9
>
ÁÁ9 :
ToProtoState
ÁÁ; G
(
ÁÁG H
)
ÁÁH I
{
ËË 
if
ÈÈ 

(
ÈÈ 
	_disposed
ÈÈ 
)
ÈÈ 
{
ÍÍ 	
return
ÎÎ 
Result
ÎÎ 
<
ÎÎ 
ChainStepState
ÎÎ (
,
ÎÎ( )%
EcliptixProtocolFailure
ÎÎ* A
>
ÎÎA B
.
ÎÎB C
Err
ÎÎC F
(
ÎÎF G%
EcliptixProtocolFailure
ÏÏ '
.
ÏÏ' (
OBJECT_DISPOSED
ÏÏ( 7
(
ÏÏ7 8
nameof
ÏÏ8 >
(
ÏÏ> ?'
EcliptixProtocolChainStep
ÏÏ? X
)
ÏÏX Y
)
ÏÏY Z
)
ÏÏZ [
;
ÏÏ[ \
}
ÌÌ 	
try
ÔÔ 
{
 	
byte
ÒÒ 
[
ÒÒ 
]
ÒÒ 
chainKey
ÒÒ 
=
ÒÒ 
_chainKeyHandle
ÒÒ -
.
ÒÒ- .
	ReadBytes
ÒÒ. 7
(
ÒÒ7 8
	Constants
ÒÒ8 A
.
ÒÒA B
X_25519_KEY_SIZE
ÒÒB R
)
ÒÒR S
.
ÒÒS T
Unwrap
ÒÒT Z
(
ÒÒZ [
)
ÒÒ[ \
;
ÒÒ\ ]
byte
ÚÚ 
[
ÚÚ 
]
ÚÚ 
?
ÚÚ 
	dhPrivKey
ÚÚ 
=
ÚÚ !
_dhPrivateKeyHandle
ÚÚ  3
?
ÚÚ3 4
.
ÚÚ4 5
	ReadBytes
ÚÚ5 >
(
ÚÚ> ?
	Constants
ÚÚ? H
.
ÚÚH I&
X_25519_PRIVATE_KEY_SIZE
ÚÚI a
)
ÚÚa b
.
ÚÚb c
Unwrap
ÚÚc i
(
ÚÚi j
)
ÚÚj k
;
ÚÚk l
ChainStepState
ÙÙ 
proto
ÙÙ  
=
ÙÙ! "
new
ÙÙ# &
(
ÙÙ& '
)
ÙÙ' (
{
ÙÙ) *
CurrentIndex
ÙÙ+ 7
=
ÙÙ8 9
_currentIndex
ÙÙ: G
,
ÙÙG H
ChainKey
ÙÙI Q
=
ÙÙR S

ByteString
ÙÙT ^
.
ÙÙ^ _
CopyFrom
ÙÙ_ g
(
ÙÙg h
chainKey
ÙÙh p
)
ÙÙp q
,
ÙÙq r
}
ÙÙs t
;
ÙÙt u
if
ˆˆ 
(
ˆˆ 
	dhPrivKey
ˆˆ 
!=
ˆˆ 
null
ˆˆ !
)
ˆˆ! "
{
˜˜ 
proto
¯¯ 
.
¯¯ 
DhPrivateKey
¯¯ "
=
¯¯# $

ByteString
¯¯% /
.
¯¯/ 0
CopyFrom
¯¯0 8
(
¯¯8 9
	dhPrivKey
¯¯9 B
)
¯¯B C
;
¯¯C D
}
˘˘ 
if
˚˚ 
(
˚˚ 
_dhPublicKey
˚˚ 
!=
˚˚ 
null
˚˚  $
)
˚˚$ %
{
¸¸ 
proto
˝˝ 
.
˝˝ 
DhPublicKey
˝˝ !
=
˝˝" #

ByteString
˝˝$ .
.
˝˝. /
CopyFrom
˝˝/ 7
(
˝˝7 8
_dhPublicKey
˝˝8 D
)
˝˝D E
;
˝˝E F
}
˛˛ 
return
ÄÄ 
Result
ÄÄ 
<
ÄÄ 
ChainStepState
ÄÄ (
,
ÄÄ( )%
EcliptixProtocolFailure
ÄÄ* A
>
ÄÄA B
.
ÄÄB C
Ok
ÄÄC E
(
ÄÄE F
proto
ÄÄF K
)
ÄÄK L
;
ÄÄL M
}
ÅÅ 	
catch
ÇÇ 
(
ÇÇ 
	Exception
ÇÇ 
ex
ÇÇ 
)
ÇÇ 
{
ÉÉ 	
return
ÑÑ 
Result
ÑÑ 
<
ÑÑ 
ChainStepState
ÑÑ (
,
ÑÑ( )%
EcliptixProtocolFailure
ÑÑ* A
>
ÑÑA B
.
ÑÑB C
Err
ÑÑC F
(
ÑÑF G%
EcliptixProtocolFailure
ÖÖ '
.
ÖÖ' (
Generic
ÖÖ( /
(
ÖÖ/ 0-
EcliptixProtocolFailureMessages
ÖÖ0 O
.
ÖÖO P
	ChainStep
ÖÖP Y
.
ÖÖY Z/
!FAILED_TO_EXPORT_CHAIN_STEP_STATE
ÖÖZ {
,
ÖÖ{ |
ex
ÜÜ 
)
ÜÜ 
)
ÜÜ 
;
ÜÜ 
}
áá 	
}
àà 
public
ää 

static
ää 
Result
ää 
<
ää '
EcliptixProtocolChainStep
ää 2
,
ää2 3%
EcliptixProtocolFailure
ää4 K
>
ääK L
FromProtoState
ääM [
(
ää[ \
ChainStepType
ää\ i
stepType
ääj r
,
äär s
ChainStepState
ãã 
proto
ãã 
)
ãã 
{
åå 
byte
çç 
[
çç 
]
çç 
?
çç 
chainKeyBytes
çç 
=
çç 
null
çç  $
;
çç$ %
byte
éé 
[
éé 
]
éé 
?
éé 
dhPrivKeyBytes
éé 
=
éé  
null
éé! %
;
éé% &
byte
èè 
[
èè 
]
èè 
?
èè 
dhPubKeyBytes
èè 
=
èè 
null
èè  $
;
èè$ %
try
ëë 
{
íí 	%
SecureByteStringInterop
ìì #
.
ìì# $#
SecureCopyWithCleanup
ìì$ 9
(
ìì9 :
proto
ìì: ?
.
ìì? @
ChainKey
ìì@ H
,
ììH I
out
ììJ M
chainKeyBytes
ììN [
)
ìì[ \
;
ìì\ ]
if
ïï 
(
ïï 
!
ïï 
proto
ïï 
.
ïï 
DhPrivateKey
ïï #
.
ïï# $
IsEmpty
ïï$ +
)
ïï+ ,
{
ññ %
SecureByteStringInterop
óó '
.
óó' (#
SecureCopyWithCleanup
óó( =
(
óó= >
proto
óó> C
.
óóC D
DhPrivateKey
óóD P
,
óóP Q
out
óóR U
dhPrivKeyBytes
óóV d
)
óód e
;
óóe f
}
òò 
if
öö 
(
öö 
!
öö 
proto
öö 
.
öö 
DhPublicKey
öö "
.
öö" #
IsEmpty
öö# *
)
öö* +
{
õõ %
SecureByteStringInterop
úú '
.
úú' (#
SecureCopyWithCleanup
úú( =
(
úú= >
proto
úú> C
.
úúC D
DhPublicKey
úúD O
,
úúO P
out
úúQ T
dhPubKeyBytes
úúU b
)
úúb c
;
úúc d
}
ùù 
Result
üü 
<
üü '
EcliptixProtocolChainStep
üü ,
,
üü, -%
EcliptixProtocolFailure
üü. E
>
üüE F
createResult
üüG S
=
üüT U
Create
†† 
(
†† 
stepType
†† 
,
††  
chainKeyBytes
††! .
,
††. /
dhPrivKeyBytes
††0 >
,
††> ?
dhPubKeyBytes
††@ M
)
††M N
;
††N O
if
°° 
(
°° 
createResult
°° 
.
°° 
IsErr
°° "
)
°°" #
{
¢¢ 
return
££ 
createResult
££ #
;
££# $
}
§§ '
EcliptixProtocolChainStep
¶¶ %
	chainStep
¶¶& /
=
¶¶0 1
createResult
¶¶2 >
.
¶¶> ?
Unwrap
¶¶? E
(
¶¶E F
)
¶¶F G
;
¶¶G H
	chainStep
ßß 
.
ßß 
SetCurrentIndex
ßß %
(
ßß% &
proto
ßß& +
.
ßß+ ,
CurrentIndex
ßß, 8
)
ßß8 9
.
®® 
Unwrap
®® 
(
®® 
)
®® 
;
®® 
return
™™ 
Result
™™ 
<
™™ '
EcliptixProtocolChainStep
™™ 3
,
™™3 4%
EcliptixProtocolFailure
™™5 L
>
™™L M
.
™™M N
Ok
™™N P
(
™™P Q
	chainStep
™™Q Z
)
™™Z [
;
™™[ \
}
´´ 	
finally
¨¨ 
{
≠≠ 	
SodiumInterop
ÆÆ 
.
ÆÆ 

SecureWipe
ÆÆ $
(
ÆÆ$ %
chainKeyBytes
ÆÆ% 2
)
ÆÆ2 3
;
ÆÆ3 4
if
∞∞ 
(
∞∞ 
dhPrivKeyBytes
∞∞ 
!=
∞∞ !
null
∞∞" &
)
∞∞& '
{
±± 
SodiumInterop
≤≤ 
.
≤≤ 

SecureWipe
≤≤ (
(
≤≤( )
dhPrivKeyBytes
≤≤) 7
)
≤≤7 8
;
≤≤8 9
}
≥≥ 
if
µµ 
(
µµ 
dhPubKeyBytes
µµ 
!=
µµ  
null
µµ! %
)
µµ% &
{
∂∂ 
SodiumInterop
∑∑ 
.
∑∑ 

SecureWipe
∑∑ (
(
∑∑( )
dhPubKeyBytes
∑∑) 6
)
∑∑6 7
;
∑∑7 8
}
∏∏ 
}
ππ 	
}
∫∫ 
internal
ºº 
Result
ºº 
<
ºº 
Unit
ºº 
,
ºº %
EcliptixProtocolFailure
ºº 1
>
ºº1 2&
UpdateKeysAfterDhRatchet
ºº3 K
(
ººK L
byte
ººL P
[
ººP Q
]
ººQ R
newChainKey
ººS ^
,
ºº^ _
byte
ΩΩ 
[
ΩΩ 
]
ΩΩ 
?
ΩΩ 
newDhPrivateKey
ΩΩ 
=
ΩΩ  !
null
ΩΩ" &
,
ΩΩ& '
byte
ææ 
[
ææ 
]
ææ 
?
ææ 
newDhPublicKey
ææ 
=
ææ  
null
ææ! %
)
ææ% &
{
øø 
Result
¿¿ 
<
¿¿ 
Unit
¿¿ 
,
¿¿ %
EcliptixProtocolFailure
¿¿ ,
>
¿¿, -
disposedCheck
¿¿. ;
=
¿¿< =
CheckDisposed
¿¿> K
(
¿¿K L
)
¿¿L M
;
¿¿M N
if
¡¡ 

(
¡¡ 
disposedCheck
¡¡ 
.
¡¡ 
IsErr
¡¡ 
)
¡¡  
{
¬¬ 	
return
√√ 
disposedCheck
√√  
;
√√  !
}
ƒƒ 	
Result
∆∆ 
<
∆∆ 
Unit
∆∆ 
,
∆∆ %
EcliptixProtocolFailure
∆∆ ,
>
∆∆, -
keyValidation
∆∆. ;
=
∆∆< =!
ValidateNewChainKey
∆∆> Q
(
∆∆Q R
newChainKey
∆∆R ]
)
∆∆] ^
;
∆∆^ _
if
«« 

(
«« 
keyValidation
«« 
.
«« 
IsErr
«« 
)
««  
{
»» 	
return
…… 
keyValidation
……  
;
……  !
}
   	
Result
ÃÃ 
<
ÃÃ 
Unit
ÃÃ 
,
ÃÃ %
EcliptixProtocolFailure
ÃÃ ,
>
ÃÃ, -
writeResult
ÃÃ. 9
=
ÃÃ: ;
_chainKeyHandle
ÃÃ< K
.
ÃÃK L
Write
ÃÃL Q
(
ÃÃQ R
newChainKey
ÃÃR ]
)
ÃÃ] ^
.
ÃÃ^ _
MapSodiumFailure
ÃÃ_ o
(
ÃÃo p
)
ÃÃp q
;
ÃÃq r
if
ÕÕ 

(
ÕÕ 
writeResult
ÕÕ 
.
ÕÕ 
IsErr
ÕÕ 
)
ÕÕ 
{
ŒŒ 	
return
œœ 
writeResult
œœ 
;
œœ 
}
–– 	
Result
““ 
<
““ 
Unit
““ 
,
““ %
EcliptixProtocolFailure
““ ,
>
““, -
indexResult
““. 9
=
““: ;
SetCurrentIndex
”” 
(
”” %
ProtocolSystemConstants
”” 3
.
””3 4
	ChainStep
””4 =
.
””= >
RESET_INDEX
””> I
)
””I J
;
””J K
if
‘‘ 

(
‘‘ 
indexResult
‘‘ 
.
‘‘ 
IsErr
‘‘ 
)
‘‘ 
{
’’ 	
return
÷÷ 
indexResult
÷÷ 
;
÷÷ 
}
◊◊ 	
Result
ŸŸ 
<
ŸŸ 
Unit
ŸŸ 
,
ŸŸ %
EcliptixProtocolFailure
ŸŸ ,
>
ŸŸ, -
dhUpdateResult
ŸŸ. <
=
ŸŸ= >
HandleDhKeyUpdate
ŸŸ? P
(
ŸŸP Q
newDhPrivateKey
ŸŸQ `
,
ŸŸ` a
newDhPublicKey
ŸŸb p
)
ŸŸp q
;
ŸŸq r
if
⁄⁄ 

(
⁄⁄ 
dhUpdateResult
⁄⁄ 
.
⁄⁄ 
IsErr
⁄⁄  
)
⁄⁄  !
{
€€ 	
return
‹‹ 
dhUpdateResult
‹‹ !
;
‹‹! "
}
›› 	
return
ﬂﬂ 
Result
ﬂﬂ 
<
ﬂﬂ 
Unit
ﬂﬂ 
,
ﬂﬂ %
EcliptixProtocolFailure
ﬂﬂ 3
>
ﬂﬂ3 4
.
ﬂﬂ4 5
Ok
ﬂﬂ5 7
(
ﬂﬂ7 8
Unit
ﬂﬂ8 <
.
ﬂﬂ< =
Value
ﬂﬂ= B
)
ﬂﬂB C
;
ﬂﬂC D
}
‡‡ 
private
‚‚ 
Result
‚‚ 
<
‚‚ 
Unit
‚‚ 
,
‚‚ %
EcliptixProtocolFailure
‚‚ 0
>
‚‚0 1
CheckDisposed
‚‚2 ?
(
‚‚? @
)
‚‚@ A
{
„„ 
if
‰‰ 

(
‰‰ 
	_disposed
‰‰ 
)
‰‰ 
{
ÂÂ 	
return
ÊÊ 
Result
ÊÊ 
<
ÊÊ 
Unit
ÊÊ 
,
ÊÊ %
EcliptixProtocolFailure
ÊÊ  7
>
ÊÊ7 8
.
ÊÊ8 9
Err
ÊÊ9 <
(
ÊÊ< =%
EcliptixProtocolFailure
ÁÁ '
.
ÁÁ' (
OBJECT_DISPOSED
ÁÁ( 7
(
ÁÁ7 8
nameof
ÁÁ8 >
(
ÁÁ> ?'
EcliptixProtocolChainStep
ÁÁ? X
)
ÁÁX Y
)
ÁÁY Z
)
ÁÁZ [
;
ÁÁ[ \
}
ËË 	
return
ÍÍ 
Result
ÍÍ 
<
ÍÍ 
Unit
ÍÍ 
,
ÍÍ %
EcliptixProtocolFailure
ÍÍ 3
>
ÍÍ3 4
.
ÍÍ4 5
Ok
ÍÍ5 7
(
ÍÍ7 8
Unit
ÍÍ8 <
.
ÍÍ< =
Value
ÍÍ= B
)
ÍÍB C
;
ÍÍC D
}
ÎÎ 
private
ÌÌ 
static
ÌÌ 
Result
ÌÌ 
<
ÌÌ 
Unit
ÌÌ 
,
ÌÌ %
EcliptixProtocolFailure
ÌÌ  7
>
ÌÌ7 8!
ValidateNewChainKey
ÌÌ9 L
(
ÌÌL M
byte
ÌÌM Q
[
ÌÌQ R
]
ÌÌR S
newChainKey
ÌÌT _
)
ÌÌ_ `
{
ÓÓ 
if
ÔÔ 

(
ÔÔ 
newChainKey
ÔÔ 
.
ÔÔ 
Length
ÔÔ 
==
ÔÔ !
	Constants
ÔÔ" +
.
ÔÔ+ ,
X_25519_KEY_SIZE
ÔÔ, <
)
ÔÔ< =
{
 	
return
ÒÒ 
Result
ÒÒ 
<
ÒÒ 
Unit
ÒÒ 
,
ÒÒ %
EcliptixProtocolFailure
ÒÒ  7
>
ÒÒ7 8
.
ÒÒ8 9
Ok
ÒÒ9 ;
(
ÒÒ; <
Unit
ÒÒ< @
.
ÒÒ@ A
Value
ÒÒA F
)
ÒÒF G
;
ÒÒG H
}
ÚÚ 	
return
ÙÙ 
Result
ÙÙ 
<
ÙÙ 
Unit
ÙÙ 
,
ÙÙ %
EcliptixProtocolFailure
ÙÙ 3
>
ÙÙ3 4
.
ÙÙ4 5
Err
ÙÙ5 8
(
ÙÙ8 9%
EcliptixProtocolFailure
ıı #
.
ıı# $
InvalidInput
ıı$ 0
(
ıı0 1
string
ˆˆ 
.
ˆˆ 
Format
ˆˆ 
(
ˆˆ -
EcliptixProtocolFailureMessages
ˆˆ =
.
ˆˆ= >
	ChainStep
ˆˆ> G
.
ˆˆG H(
NEW_CHAIN_KEY_INVALID_SIZE
ˆˆH b
,
ˆˆb c
	Constants
˜˜ 
.
˜˜ 
X_25519_KEY_SIZE
˜˜ .
)
˜˜. /
)
˜˜/ 0
)
˜˜0 1
;
˜˜1 2
}
¯¯ 
private
˙˙ 
Result
˙˙ 
<
˙˙ 
Unit
˙˙ 
,
˙˙ %
EcliptixProtocolFailure
˙˙ 0
>
˙˙0 1
HandleDhKeyUpdate
˙˙2 C
(
˙˙C D
byte
˙˙D H
[
˙˙H I
]
˙˙I J
?
˙˙J K
newDhPrivateKey
˙˙L [
,
˙˙[ \
byte
˙˙] a
[
˙˙a b
]
˙˙b c
?
˙˙c d
newDhPublicKey
˙˙e s
)
˙˙s t
{
˚˚ 
_messageKeys
¸¸ 
.
¸¸ 
Clear
¸¸ 
(
¸¸ 
)
¸¸ 
;
¸¸ 
if
˛˛ 

(
˛˛ 
newDhPrivateKey
˛˛ 
==
˛˛ 
null
˛˛ #
&&
˛˛$ &
newDhPublicKey
˛˛' 5
==
˛˛6 8
null
˛˛9 =
)
˛˛= >
{
ˇˇ 	
return
ÄÄ 
OkResult
ÄÄ 
;
ÄÄ 
}
ÅÅ 	
Result
ÉÉ 
<
ÉÉ 
Unit
ÉÉ 
,
ÉÉ %
EcliptixProtocolFailure
ÉÉ ,
>
ÉÉ, -
validationResult
ÉÉ. >
=
ÉÉ? @
ValidateAll
ÉÉA L
(
ÉÉL M
(
ÑÑ 
)
ÑÑ 
=>
ÑÑ #
ValidateDhKeysNotNull
ÑÑ '
(
ÑÑ' (
newDhPrivateKey
ÑÑ( 7
,
ÑÑ7 8
newDhPublicKey
ÑÑ9 G
)
ÑÑG H
,
ÑÑH I
(
ÖÖ 
)
ÖÖ 
=>
ÖÖ &
ValidateDhPrivateKeySize
ÖÖ *
(
ÖÖ* +
newDhPrivateKey
ÖÖ+ :
)
ÖÖ: ;
,
ÖÖ; <
(
ÜÜ 
)
ÜÜ 
=>
ÜÜ %
ValidateDhPublicKeySize
ÜÜ )
(
ÜÜ) *
newDhPublicKey
ÜÜ* 8
)
ÜÜ8 9
)
áá 	
;
áá	 

if
àà 

(
àà 
validationResult
àà 
.
àà 
IsErr
àà "
)
àà" #
{
ââ 	
return
ää 
validationResult
ää #
;
ää# $
}
ãã 	
Result
çç 
<
çç &
SodiumSecureMemoryHandle
çç '
,
çç' (
SodiumFailure
çç) 6
>
çç6 7
allocResult
çç8 C
=
ççD E&
SodiumSecureMemoryHandle
éé $
.
éé$ %
Allocate
éé% -
(
éé- .
	Constants
éé. 7
.
éé7 8&
X_25519_PRIVATE_KEY_SIZE
éé8 P
)
ééP Q
;
ééQ R
if
èè 

(
èè 
allocResult
èè 
.
èè 
IsErr
èè 
)
èè 
{
êê 	
return
ëë 
Result
ëë 
<
ëë 
Unit
ëë 
,
ëë %
EcliptixProtocolFailure
ëë  7
>
ëë7 8
.
ëë8 9
Err
ëë9 <
(
ëë< =
allocResult
ëë= H
.
ëëH I
	UnwrapErr
ëëI R
(
ëëR S
)
ëëS T
.
ëëT U'
ToEcliptixProtocolFailure
ëëU n
(
ëën o
)
ëëo p
)
ëëp q
;
ëëq r
}
íí 	&
SodiumSecureMemoryHandle
îî  
handle
îî! '
=
îî( )
allocResult
îî* 5
.
îî5 6
Unwrap
îî6 <
(
îî< =
)
îî= >
;
îî> ?
Result
ïï 
<
ïï 
Unit
ïï 
,
ïï 
SodiumFailure
ïï "
>
ïï" #
writeResult
ïï$ /
=
ïï0 1
handle
ïï2 8
.
ïï8 9
Write
ïï9 >
(
ïï> ?
newDhPrivateKey
ïï? N
!
ïïN O
.
ïïO P
AsSpan
ïïP V
(
ïïV W
)
ïïW X
)
ïïX Y
;
ïïY Z
if
ññ 

(
ññ 
writeResult
ññ 
.
ññ 
IsErr
ññ 
)
ññ 
{
óó 	
handle
òò 
.
òò 
Dispose
òò 
(
òò 
)
òò 
;
òò 
return
ôô 
Result
ôô 
<
ôô 
Unit
ôô 
,
ôô %
EcliptixProtocolFailure
ôô  7
>
ôô7 8
.
ôô8 9
Err
ôô9 <
(
ôô< =
writeResult
ôô= H
.
ôôH I
	UnwrapErr
ôôI R
(
ôôR S
)
ôôS T
.
ôôT U'
ToEcliptixProtocolFailure
ôôU n
(
ôôn o
)
ôôo p
)
ôôp q
;
ôôq r
}
öö 	!
_dhPrivateKeyHandle
úú 
?
úú 
.
úú 
Dispose
úú $
(
úú$ %
)
úú% &
;
úú& '!
_dhPrivateKeyHandle
ùù 
=
ùù 
handle
ùù $
;
ùù$ %
if
üü 

(
üü 
_dhPublicKey
üü 
!=
üü 
null
üü  
)
üü  !
{
†† 	
SodiumInterop
°° 
.
°° 

SecureWipe
°° $
(
°°$ %
_dhPublicKey
°°% 1
)
°°1 2
;
°°2 3
}
¢¢ 	
_dhPublicKey
§§ 
=
§§ 
(
§§ 
byte
§§ 
[
§§ 
]
§§ 
)
§§ 
newDhPublicKey
§§ -
!
§§- .
.
§§. /
Clone
§§/ 4
(
§§4 5
)
§§5 6
;
§§6 7
return
¶¶ 
OkResult
¶¶ 
;
¶¶ 
}
ßß 
private
©© 
static
©© 
Result
©© 
<
©© 
Unit
©© 
,
©© %
EcliptixProtocolFailure
©©  7
>
©©7 8
ValidateAll
©©9 D
(
©©D E
params
™™ 
Func
™™ 
<
™™ 
Result
™™ 
<
™™ 
Unit
™™ 
,
™™  %
EcliptixProtocolFailure
™™! 8
>
™™8 9
>
™™9 :
[
™™: ;
]
™™; <
?
™™< =

validators
™™> H
)
™™H I
{
´´ 
if
¨¨ 

(
¨¨ 

validators
¨¨ 
is
¨¨ 
null
¨¨ 
||
¨¨ !

validators
¨¨" ,
.
¨¨, -
Length
¨¨- 3
==
¨¨4 6%
ProtocolSystemConstants
¨¨7 N
.
¨¨N O
	ChainStep
¨¨O X
.
¨¨X Y-
VALIDATOR_ARRAY_EMPTY_THRESHOLD
¨¨Y x
)
¨¨x y
{
≠≠ 	
return
ÆÆ 
OkResult
ÆÆ 
;
ÆÆ 
}
ØØ 	
foreach
±± 
(
±± 
Func
±± 
<
±± 
Result
±± 
<
±± 
Unit
±± !
,
±±! "%
EcliptixProtocolFailure
±±# :
>
±±: ;
>
±±; <
validate
±±= E
in
±±F H

validators
±±I S
)
±±S T
{
≤≤ 	
Result
≥≥ 
<
≥≥ 
Unit
≥≥ 
,
≥≥ %
EcliptixProtocolFailure
≥≥ 0
>
≥≥0 1
result
≥≥2 8
=
≥≥9 :
validate
≥≥; C
(
≥≥C D
)
≥≥D E
;
≥≥E F
if
¥¥ 
(
¥¥ 
result
¥¥ 
.
¥¥ 
IsErr
¥¥ 
)
¥¥ 
{
µµ 
return
∂∂ 
result
∂∂ 
;
∂∂ 
}
∑∑ 
}
∏∏ 	
return
∫∫ 
OkResult
∫∫ 
;
∫∫ 
}
ªª 
private
ΩΩ 
static
ΩΩ 
Result
ΩΩ 
<
ΩΩ 
Unit
ΩΩ 
,
ΩΩ %
EcliptixProtocolFailure
ΩΩ  7
>
ΩΩ7 8#
ValidateDhKeysNotNull
ΩΩ9 N
(
ΩΩN O
byte
ΩΩO S
[
ΩΩS T
]
ΩΩT U
?
ΩΩU V

privateKey
ΩΩW a
,
ΩΩa b
byte
ΩΩc g
[
ΩΩg h
]
ΩΩh i
?
ΩΩi j
	publicKey
ΩΩk t
)
ΩΩt u
{
ææ 
if
øø 

(
øø 

privateKey
øø 
==
øø 
null
øø 
&&
øø !
	publicKey
øø" +
==
øø, .
null
øø/ 3
)
øø3 4
{
¿¿ 	
return
¡¡ 
OkResult
¡¡ 
;
¡¡ 
}
¬¬ 	
if
ƒƒ 

(
ƒƒ 

privateKey
ƒƒ 
==
ƒƒ 
null
ƒƒ 
||
ƒƒ !
	publicKey
ƒƒ" +
==
ƒƒ, .
null
ƒƒ/ 3
)
ƒƒ3 4
{
≈≈ 	
return
∆∆ 
Result
∆∆ 
<
∆∆ 
Unit
∆∆ 
,
∆∆ %
EcliptixProtocolFailure
∆∆  7
>
∆∆7 8
.
∆∆8 9
Err
∆∆9 <
(
∆∆< =%
EcliptixProtocolFailure
«« '
.
««' (
InvalidInput
««( 4
(
««4 5-
EcliptixProtocolFailureMessages
««5 T
.
««T U
	ChainStep
««U ^
.
««^ _'
DH_KEYS_PROVIDED_TOGETHER
««_ x
)
««x y
)
««y z
;
««z {
}
»» 	
return
   
OkResult
   
;
   
}
ÀÀ 
private
ÕÕ 
static
ÕÕ 
Result
ÕÕ 
<
ÕÕ 
Unit
ÕÕ 
,
ÕÕ %
EcliptixProtocolFailure
ÕÕ  7
>
ÕÕ7 8&
ValidateDhPrivateKeySize
ÕÕ9 Q
(
ÕÕQ R
byte
ÕÕR V
[
ÕÕV W
]
ÕÕW X
?
ÕÕX Y

privateKey
ÕÕZ d
)
ÕÕd e
{
ŒŒ 
if
œœ 

(
œœ 

privateKey
œœ 
==
œœ 
null
œœ 
)
œœ 
{
–– 	
return
—— 
OkResult
—— 
;
—— 
}
““ 	
return
‘‘ 

privateKey
‘‘ 
.
‘‘ 
Length
‘‘  
==
‘‘! #
	Constants
‘‘$ -
.
‘‘- .&
X_25519_PRIVATE_KEY_SIZE
‘‘. F
?
’’ 
OkResult
’’ 
:
÷÷ 
Result
÷÷ 
<
÷÷ 
Unit
÷÷ 
,
÷÷ %
EcliptixProtocolFailure
÷÷ 2
>
÷÷2 3
.
÷÷3 4
Err
÷÷4 7
(
÷÷7 8%
EcliptixProtocolFailure
◊◊ '
.
◊◊' (
InvalidInput
◊◊( 4
(
◊◊4 5
string
ÿÿ 
.
ÿÿ 
Format
ÿÿ !
(
ÿÿ! "-
EcliptixProtocolFailureMessages
ÿÿ" A
.
ÿÿA B
	ChainStep
ÿÿB K
.
ÿÿK L)
DH_PRIVATE_KEY_INVALID_SIZE
ÿÿL g
,
ÿÿg h
	Constants
ŸŸ !
.
ŸŸ! "&
X_25519_PRIVATE_KEY_SIZE
ŸŸ" :
)
ŸŸ: ;
)
ŸŸ; <
)
ŸŸ< =
;
ŸŸ= >
}
⁄⁄ 
private
‹‹ 
static
‹‹ 
Result
‹‹ 
<
‹‹ 
Unit
‹‹ 
,
‹‹ %
EcliptixProtocolFailure
‹‹  7
>
‹‹7 8%
ValidateDhPublicKeySize
‹‹9 P
(
‹‹P Q
byte
‹‹Q U
[
‹‹U V
]
‹‹V W
?
‹‹W X
	publicKey
‹‹Y b
)
‹‹b c
{
›› 
if
ﬁﬁ 

(
ﬁﬁ 
	publicKey
ﬁﬁ 
==
ﬁﬁ 
null
ﬁﬁ 
)
ﬁﬁ 
{
ﬂﬂ 	
return
‡‡ 
OkResult
‡‡ 
;
‡‡ 
}
·· 	
return
„„ 
	publicKey
„„ 
.
„„ 
Length
„„ 
==
„„  "
	Constants
„„# ,
.
„„, -
X_25519_KEY_SIZE
„„- =
?
‰‰ 
OkResult
‰‰ 
:
ÂÂ 
Result
ÂÂ 
<
ÂÂ 
Unit
ÂÂ 
,
ÂÂ %
EcliptixProtocolFailure
ÂÂ 2
>
ÂÂ2 3
.
ÂÂ3 4
Err
ÂÂ4 7
(
ÂÂ7 8%
EcliptixProtocolFailure
ÊÊ '
.
ÊÊ' (
InvalidInput
ÊÊ( 4
(
ÊÊ4 5
string
ÊÊ5 ;
.
ÊÊ; <
Format
ÊÊ< B
(
ÊÊB C-
EcliptixProtocolFailureMessages
ÁÁ 3
.
ÁÁ3 4
	ChainStep
ÁÁ4 =
.
ÁÁ= >(
DH_PUBLIC_KEY_INVALID_SIZE
ÁÁ> X
,
ÁÁX Y
	Constants
ÁÁZ c
.
ÁÁc d
X_25519_KEY_SIZE
ÁÁd t
)
ÁÁt u
)
ÁÁu v
)
ÁÁv w
;
ÁÁw x
}
ËË 
internal
ÍÍ 
Result
ÍÍ 
<
ÍÍ 
byte
ÍÍ 
[
ÍÍ 
]
ÍÍ 
?
ÍÍ 
,
ÍÍ %
EcliptixProtocolFailure
ÍÍ 4
>
ÍÍ4 5
ReadDhPublicKey
ÍÍ6 E
(
ÍÍE F
)
ÍÍF G
{
ÎÎ 
Result
ÏÏ 
<
ÏÏ 
Unit
ÏÏ 
,
ÏÏ %
EcliptixProtocolFailure
ÏÏ ,
>
ÏÏ, -
disposedCheck
ÏÏ. ;
=
ÏÏ< =
CheckDisposed
ÏÏ> K
(
ÏÏK L
)
ÏÏL M
;
ÏÏM N
if
ÌÌ 

(
ÌÌ 
disposedCheck
ÌÌ 
.
ÌÌ 
IsErr
ÌÌ 
)
ÌÌ  
{
ÓÓ 	
return
ÔÔ 
Result
ÔÔ 
<
ÔÔ 
byte
ÔÔ 
[
ÔÔ 
]
ÔÔ  
?
ÔÔ  !
,
ÔÔ! "%
EcliptixProtocolFailure
ÔÔ# :
>
ÔÔ: ;
.
ÔÔ; <
Err
ÔÔ< ?
(
ÔÔ? @
disposedCheck
ÔÔ@ M
.
ÔÔM N
	UnwrapErr
ÔÔN W
(
ÔÔW X
)
ÔÔX Y
)
ÔÔY Z
;
ÔÔZ [
}
 	
byte
ÚÚ 
[
ÚÚ 
]
ÚÚ 
?
ÚÚ 
dbPublicKeyClone
ÚÚ  
=
ÚÚ! "
null
ÚÚ# '
;
ÚÚ' (
if
ÛÛ 

(
ÛÛ 
_dhPublicKey
ÛÛ 
!=
ÛÛ 
null
ÛÛ  
)
ÛÛ  !
{
ÙÙ 	
dbPublicKeyClone
ıı 
=
ıı 
(
ıı  
byte
ıı  $
[
ıı$ %
]
ıı% &
)
ıı& '
_dhPublicKey
ıı' 3
.
ıı3 4
Clone
ıı4 9
(
ıı9 :
)
ıı: ;
;
ıı; <
}
ˆˆ 	
return
¯¯ 
Result
¯¯ 
<
¯¯ 
byte
¯¯ 
[
¯¯ 
]
¯¯ 
?
¯¯ 
,
¯¯ %
EcliptixProtocolFailure
¯¯ 6
>
¯¯6 7
.
¯¯7 8
Ok
¯¯8 :
(
¯¯: ;
dbPublicKeyClone
¯¯; K
)
¯¯K L
;
¯¯L M
}
˘˘ 
internal
˚˚ 
void
˚˚ 
PruneOldKeys
˚˚ 
(
˚˚ 
)
˚˚  
{
¸¸ 
if
˝˝ 

(
˝˝ 
	_disposed
˝˝ 
||
˝˝ 
_cacheWindow
˝˝ %
==
˝˝& (%
ProtocolSystemConstants
˝˝) @
.
˝˝@ A
	ChainStep
˝˝A J
.
˝˝J K-
VALIDATOR_ARRAY_EMPTY_THRESHOLD
˝˝K j
||
˝˝k m
_messageKeys
˛˛ 
.
˛˛ 
Count
˛˛ 
==
˛˛ !%
ProtocolSystemConstants
˛˛" 9
.
˛˛9 :
	ChainStep
˛˛: C
.
˛˛C D-
VALIDATOR_ARRAY_EMPTY_THRESHOLD
˛˛D c
)
˛˛c d
{
ˇˇ 	
return
ÄÄ 
;
ÄÄ 
}
ÅÅ 	
Result
ÉÉ 
<
ÉÉ 
uint
ÉÉ 
,
ÉÉ %
EcliptixProtocolFailure
ÉÉ ,
>
ÉÉ, - 
currentIndexResult
ÉÉ. @
=
ÉÉA B
GetCurrentIndex
ÉÉC R
(
ÉÉR S
)
ÉÉS T
;
ÉÉT U
if
ÑÑ 

(
ÑÑ  
currentIndexResult
ÑÑ 
.
ÑÑ 
IsErr
ÑÑ $
)
ÑÑ$ %
{
ÖÖ 	
return
ÜÜ 
;
ÜÜ 
}
áá 	
uint
ââ !
indexToPruneAgainst
ââ  
=
ââ! " 
currentIndexResult
ââ# 5
.
ââ5 6
Unwrap
ââ6 <
(
ââ< =
)
ââ= >
;
ââ> ?
uint
ãã 
minIndexToKeep
ãã 
=
ãã !
indexToPruneAgainst
ãã 1
>=
ãã2 4
_cacheWindow
ãã5 A
?
åå !
indexToPruneAgainst
åå !
-
åå" #
_cacheWindow
åå$ 0
+
åå1 2%
ProtocolSystemConstants
åå3 J
.
ååJ K
	ChainStep
ååK T
.
ååT U&
MIN_INDEX_TO_KEEP_OFFSET
ååU m
:
çç %
ProtocolSystemConstants
çç %
.
çç% &
	ChainStep
çç& /
.
çç/ 0-
VALIDATOR_ARRAY_EMPTY_THRESHOLD
çç0 O
;
ççO P
List
èè 
<
èè 
uint
èè 
>
èè 
keysToRemove
èè 
=
èè  !
[
èè" #
]
èè# $
;
èè$ %
keysToRemove
êê 
.
êê 
AddRange
êê 
(
êê 
_messageKeys
êê *
.
êê* +
Keys
êê+ /
.
êê/ 0
Where
êê0 5
(
êê5 6
key
êê6 9
=>
êê: <
key
êê= @
<
êêA B
minIndexToKeep
êêC Q
)
êêQ R
)
êêR S
;
êêS T
if
ëë 

(
ëë 
keysToRemove
ëë 
.
ëë 
Count
ëë 
==
ëë !%
ProtocolSystemConstants
ëë" 9
.
ëë9 :
	ChainStep
ëë: C
.
ëëC D-
VALIDATOR_ARRAY_EMPTY_THRESHOLD
ëëD c
)
ëëc d
{
íí 	
return
ìì 
;
ìì 
}
îî 	
foreach
ññ 
(
ññ 
uint
ññ 
keyIndex
ññ 
in
ññ !
keysToRemove
ññ" .
)
ññ. /
{
óó 	
if
òò 
(
òò 
_messageKeys
òò 
.
òò 
Remove
òò #
(
òò# $
keyIndex
òò$ ,
,
òò, -
out
òò. 1&
SodiumSecureMemoryHandle
òò2 J
?
òòJ K
removedHandle
òòL Y
)
òòY Z
)
òòZ [
{
ôô 
removedHandle
öö 
.
öö 
Dispose
öö %
(
öö% &
)
öö& '
;
öö' (
}
õõ 
}
úú 	
}
ùù 
}ûû Ωï
g/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/DhValidator.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
internal 
static	 
class 
DhValidator !
{ 
public 

static 
Result 
< 
Unit 
, #
EcliptixProtocolFailure 6
>6 7#
ValidateX25519PublicKey8 O
(O P
byteP T
[T U
]U V
	publicKeyW `
)` a
{		 
if

 

(

 
	publicKey

 
.

 
Length

 
!=

 
	Constants

  )
.

) *#
X_25519_PUBLIC_KEY_SIZE

* A
)

A B
{ 	
return 
Result 
< 
Unit 
, #
EcliptixProtocolFailure  7
>7 8
.8 9
Err9 <
(< =#
EcliptixProtocolFailure '
.' (
InvalidInput( 4
(4 5
string 
. 
Format !
(! "+
EcliptixProtocolFailureMessages" A
.A B
DhValidatorB M
.M N#
INVALID_PUBLIC_KEY_SIZEN e
,e f
	Constantsg p
.p q$
X_25519_PUBLIC_KEY_SIZE	q à
,
à â
	publicKey
ä ì
.
ì î
Length
î ö
)
ö õ
)
õ ú
)
ú ù
;
ù û
} 	
if 

( 
HasSmallOrder 
( 
	publicKey #
)# $
)$ %
{ 	
return 
Result 
< 
Unit 
, #
EcliptixProtocolFailure  7
>7 8
.8 9
Err9 <
(< =#
EcliptixProtocolFailure '
.' (
InvalidInput( 4
(4 5+
EcliptixProtocolFailureMessages5 T
.T U
DhValidatorU `
.` a&
PUBLIC_KEY_HAS_SMALL_ORDERa {
){ |
)| }
;} ~
} 	
if 

( 
! "
IsValidCurve25519Point #
(# $
	publicKey$ -
)- .
). /
{ 	
return 
Result 
< 
Unit 
, #
EcliptixProtocolFailure  7
>7 8
.8 9
Err9 <
(< =#
EcliptixProtocolFailure '
.' (
InvalidInput( 4
(4 5+
EcliptixProtocolFailureMessages5 T
.T U
DhValidatorU `
.` a3
&PUBLIC_KEY_NOT_VALID_CURVE_25519_POINT	a á
)
á à
)
à â
;
â ä
} 	
return 
Result 
< 
Unit 
, #
EcliptixProtocolFailure 3
>3 4
.4 5
Ok5 7
(7 8
Unit8 <
.< =
Value= B
)B C
;C D
} 
private   
static   
bool   "
IsValidCurve25519Point   .
(  . /
ReadOnlySpan  / ;
<  ; <
byte  < @
>  @ A
	publicKey  B K
)  K L
{!! 
if"" 

("" 
	publicKey"" 
."" 
Length"" 
!="" 
	Constants""  )
."") **
CURVE_25519_FIELD_ELEMENT_SIZE""* H
)""H I
{## 	
return$$ 
false$$ 
;$$ 
}%% 	
return'' 
IsValidFieldElement'' "
(''" #
	publicKey''# ,
)'', -
&&''. 0
!''1 2
HasSmallOrder''2 ?
(''? @
	publicKey''@ I
)''I J
;''J K
}(( 
private** 
static** 
bool** 
IsValidFieldElement** +
(**+ ,
ReadOnlySpan**, 8
<**8 9
byte**9 =
>**= >
element**? F
)**F G
{++ 
Span,, 
<,, 
byte,, 
>,, 
reduced,, 
=,, 

stackalloc,, '
byte,,( ,
[,,, -
	Constants,,- 6
.,,6 7*
CURVE_25519_FIELD_ELEMENT_SIZE,,7 U
],,U V
;,,V W
element-- 
.-- 
CopyTo-- 
(-- 
reduced-- 
)-- 
;--  
Span// 
<// 
uint// 
>// 
words// 
=// 

stackalloc// %
uint//& *
[//* +
	Constants//+ 4
.//4 5 
FIELD_256_WORD_COUNT//5 I
]//I J
;//J K
for00 
(00 
int00 
i00 
=00 
$num00 
;00 
i00 
<00 
	Constants00 %
.00% & 
FIELD_256_WORD_COUNT00& :
;00: ;
i00< =
++00= ?
)00? @
{11 	
words22 
[22 
i22 
]22 
=22 
(22 
uint22 
)22 
(22 
reduced22 %
[22% &
i22& '
*22( )
	Constants22* 3
.223 4
	WORD_SIZE224 =
]22= >
|22? @
(33 
reduced33 &
[33& '
i33' (
*33) *
	Constants33+ 4
.334 5
	WORD_SIZE335 >
+33? @
$num33A B
]33B C
<<33D F
$num33G H
)33H I
|33J K
(44 
reduced44 &
[44& '
i44' (
*44) *
	Constants44+ 4
.444 5
	WORD_SIZE445 >
+44? @
$num44A B
]44B C
<<44D F
$num44G I
)44I J
|44K L
(55 
reduced55 &
[55& '
i55' (
*55) *
	Constants55+ 4
.554 5
	WORD_SIZE555 >
+55? @
$num55A B
]55B C
<<55D F
$num55G I
)55I J
)55J K
;55K L
}66 	
words88 
[88 
$num88 
]88 
&=88 
	Constants88 
.88 
FIELD_ELEMENT_MASK88 0
;880 1
return:: 
CompareToFieldPrime:: "
(::" #
words::# (
)::( )
<::* +
$num::, -
;::- .
};; 
private== 
static== 
int== 
CompareToFieldPrime== *
(==* +
ReadOnlySpan==+ 7
<==7 8
uint==8 <
>==< =
element==> E
)==E F
{>> 
ReadOnlySpan?? 
<?? 
uint?? 
>?? 
p?? 
=?? 
[@@ 	
$numAA 
,AA 
$numAA "
,AA" #
$numAA$ .
,AA. /
$numAA0 :
,AA: ;
$numBB 
,BB 
$numBB "
,BB" #
$numBB$ .
,BB. /
$numBB0 :
]CC 	
;CC	 

forEE 
(EE 
intEE 
iEE 
=EE 
$numEE 
;EE 
iEE 
>=EE 
$numEE 
;EE 
iEE  !
--EE! #
)EE# $
{FF 	
ifGG 
(GG 
elementGG 
[GG 
iGG 
]GG 
<GG 
pGG 
[GG 
iGG  
]GG  !
)GG! "
{HH 
returnII 
-II 
$numII 
;II 
}JJ 
ifLL 
(LL 
elementLL 
[LL 
iLL 
]LL 
>LL 
pLL 
[LL 
iLL  
]LL  !
)LL! "
{MM 
returnNN 
$numNN 
;NN 
}OO 
}PP 	
returnRR 
$numRR 
;RR 
}SS 
privateUU 
staticUU 
readonlyUU 
byteUU  
[UU  !
]UU! "
[UU" #
]UU# $
SmallOrderPointsUU% 5
=UU6 7
[VV 
[WW 	
$numXX 
,XX 
$numXX 
,XX 
$numXX 
,XX 
$numXX "
,XX" #
$numXX$ (
,XX( )
$numXX* .
,XX. /
$numXX0 4
,XX4 5
$numXX6 :
,XX: ;
$numXX< @
,XX@ A
$numXXB F
,XXF G
$numXXH L
,XXL M
$numXXN R
,XXR S
$numXXT X
,XXX Y
$numXXZ ^
,XX^ _
$numXX` d
,XXd e
$numXXf j
,XXj k
$numXXl p
,XXp q
$numXXr v
,XXv w
$numYY 
,YY 
$numYY 
,YY 
$numYY 
,YY 
$numYY "
,YY" #
$numYY$ (
,YY( )
$numYY* .
,YY. /
$numYY0 4
,YY4 5
$numYY6 :
,YY: ;
$numYY< @
,YY@ A
$numYYB F
,YYF G
$numYYH L
,YYL M
$numYYN R
,YYR S
$numYYT X
,YYX Y
$numYYZ ^
]ZZ 	
,ZZ	 

[[[ 	
$num\\ 
,\\ 
$num\\ 
,\\ 
$num\\ 
,\\ 
$num\\ "
,\\" #
$num\\$ (
,\\( )
$num\\* .
,\\. /
$num\\0 4
,\\4 5
$num\\6 :
,\\: ;
$num\\< @
,\\@ A
$num\\B F
,\\F G
$num\\H L
,\\L M
$num\\N R
,\\R S
$num\\T X
,\\X Y
$num\\Z ^
,\\^ _
$num\\` d
,\\d e
$num\\f j
,\\j k
$num\\l p
,\\p q
$num\\r v
,\\v w
$num]] 
,]] 
$num]] 
,]] 
$num]] 
,]] 
$num]] "
,]]" #
$num]]$ (
,]]( )
$num]]* .
,]]. /
$num]]0 4
,]]4 5
$num]]6 :
,]]: ;
$num]]< @
,]]@ A
$num]]B F
,]]F G
$num]]H L
,]]L M
$num]]N R
,]]R S
$num]]T X
,]]X Y
$num]]Z ^
]^^ 	
,^^	 

[__ 	
$num`` 
,`` 
$num`` 
,`` 
$num`` 
,`` 
$num`` "
,``" #
$num``$ (
,``( )
$num``* .
,``. /
$num``0 4
,``4 5
$num``6 :
,``: ;
$num``< @
,``@ A
$num``B F
,``F G
$num``H L
,``L M
$num``N R
,``R S
$num``T X
,``X Y
$num``Z ^
,``^ _
$num``` d
,``d e
$num``f j
,``j k
$num``l p
,``p q
$num``r v
,``v w
$numaa 
,aa 
$numaa 
,aa 
$numaa 
,aa 
$numaa "
,aa" #
$numaa$ (
,aa( )
$numaa* .
,aa. /
$numaa0 4
,aa4 5
$numaa6 :
,aa: ;
$numaa< @
,aa@ A
$numaaB F
,aaF G
$numaaH L
,aaL M
$numaaN R
,aaR S
$numaaT X
,aaX Y
$numaaZ ^
]bb 	
,bb	 

[cc 	
$numdd 
,dd 
$numdd 
,dd 
$numdd 
,dd 
$numdd "
,dd" #
$numdd$ (
,dd( )
$numdd* .
,dd. /
$numdd0 4
,dd4 5
$numdd6 :
,dd: ;
$numdd< @
,dd@ A
$numddB F
,ddF G
$numddH L
,ddL M
$numddN R
,ddR S
$numddT X
,ddX Y
$numddZ ^
,dd^ _
$numdd` d
,ddd e
$numddf j
,ddj k
$numddl p
,ddp q
$numddr v
,ddv w
$numee 
,ee 
$numee 
,ee 
$numee 
,ee 
$numee "
,ee" #
$numee$ (
,ee( )
$numee* .
,ee. /
$numee0 4
,ee4 5
$numee6 :
,ee: ;
$numee< @
,ee@ A
$numeeB F
,eeF G
$numeeH L
,eeL M
$numeeN R
,eeR S
$numeeT X
,eeX Y
$numeeZ ^
]ff 	
,ff	 

[gg 	
$numhh 
,hh 
$numhh 
,hh 
$numhh 
,hh 
$numhh "
,hh" #
$numhh$ (
,hh( )
$numhh* .
,hh. /
$numhh0 4
,hh4 5
$numhh6 :
,hh: ;
$numhh< @
,hh@ A
$numhhB F
,hhF G
$numhhH L
,hhL M
$numhhN R
,hhR S
$numhhT X
,hhX Y
$numhhZ ^
,hh^ _
$numhh` d
,hhd e
$numhhf j
,hhj k
$numhhl p
,hhp q
$numhhr v
,hhv w
$numii 
,ii 
$numii 
,ii 
$numii 
,ii 
$numii "
,ii" #
$numii$ (
,ii( )
$numii* .
,ii. /
$numii0 4
,ii4 5
$numii6 :
,ii: ;
$numii< @
,ii@ A
$numiiB F
,iiF G
$numiiH L
,iiL M
$numiiN R
,iiR S
$numiiT X
,iiX Y
$numiiZ ^
]jj 	
,jj	 

[kk 	
$numll 
,ll 
$numll 
,ll 
$numll 
,ll 
$numll "
,ll" #
$numll$ (
,ll( )
$numll* .
,ll. /
$numll0 4
,ll4 5
$numll6 :
,ll: ;
$numll< @
,ll@ A
$numllB F
,llF G
$numllH L
,llL M
$numllN R
,llR S
$numllT X
,llX Y
$numllZ ^
,ll^ _
$numll` d
,lld e
$numllf j
,llj k
$numlll p
,llp q
$numllr v
,llv w
$nummm 
,mm 
$nummm 
,mm 
$nummm 
,mm 
$nummm "
,mm" #
$nummm$ (
,mm( )
$nummm* .
,mm. /
$nummm0 4
,mm4 5
$nummm6 :
,mm: ;
$nummm< @
,mm@ A
$nummmB F
,mmF G
$nummmH L
,mmL M
$nummmN R
,mmR S
$nummmT X
,mmX Y
$nummmZ ^
]nn 	
,nn	 

[oo 	
$numpp 
,pp 
$numpp 
,pp 
$numpp 
,pp 
$numpp "
,pp" #
$numpp$ (
,pp( )
$numpp* .
,pp. /
$numpp0 4
,pp4 5
$numpp6 :
,pp: ;
$numpp< @
,pp@ A
$numppB F
,ppF G
$numppH L
,ppL M
$numppN R
,ppR S
$numppT X
,ppX Y
$numppZ ^
,pp^ _
$numpp` d
,ppd e
$numppf j
,ppj k
$numppl p
,ppp q
$numppr v
,ppv w
$numqq 
,qq 
$numqq 
,qq 
$numqq 
,qq 
$numqq "
,qq" #
$numqq$ (
,qq( )
$numqq* .
,qq. /
$numqq0 4
,qq4 5
$numqq6 :
,qq: ;
$numqq< @
,qq@ A
$numqqB F
,qqF G
$numqqH L
,qqL M
$numqqN R
,qqR S
$numqqT X
,qqX Y
$numqqZ ^
]rr 	
,rr	 

[ss 	
$numtt 
,tt 
$numtt 
,tt 
$numtt 
,tt 
$numtt "
,tt" #
$numtt$ (
,tt( )
$numtt* .
,tt. /
$numtt0 4
,tt4 5
$numtt6 :
,tt: ;
$numtt< @
,tt@ A
$numttB F
,ttF G
$numttH L
,ttL M
$numttN R
,ttR S
$numttT X
,ttX Y
$numttZ ^
,tt^ _
$numtt` d
,ttd e
$numttf j
,ttj k
$numttl p
,ttp q
$numttr v
,ttv w
$numuu 
,uu 
$numuu 
,uu 
$numuu 
,uu 
$numuu "
,uu" #
$numuu$ (
,uu( )
$numuu* .
,uu. /
$numuu0 4
,uu4 5
$numuu6 :
,uu: ;
$numuu< @
,uu@ A
$numuuB F
,uuF G
$numuuH L
,uuL M
$numuuN R
,uuR S
$numuuT X
,uuX Y
$numuuZ ^
]vv 	
]ww 
;ww 
privateyy 
staticyy 
boolyy 
HasSmallOrderyy %
(yy% &
ReadOnlySpanyy& 2
<yy2 3
byteyy3 7
>yy7 8
pointyy9 >
)yy> ?
{zz 
foreach{{ 
({{ 
byte{{ 
[{{ 
]{{ 
smallOrderPoint{{ '
in{{( *
SmallOrderPoints{{+ ;
){{; <
{|| 	
if}} 
(}} 
ConstantTimeEquals}} "
(}}" #
point}}# (
,}}( )
smallOrderPoint}}* 9
)}}9 :
)}}: ;
{~~ 
return 
true 
; 
}
ÄÄ 
}
ÅÅ 	
return
ÉÉ 
false
ÉÉ 
;
ÉÉ 
}
ÑÑ 
private
ÜÜ 
static
ÜÜ 
bool
ÜÜ  
ConstantTimeEquals
ÜÜ *
(
ÜÜ* +
ReadOnlySpan
ÜÜ+ 7
<
ÜÜ7 8
byte
ÜÜ8 <
>
ÜÜ< =
a
ÜÜ> ?
,
ÜÜ? @
ReadOnlySpan
ÜÜA M
<
ÜÜM N
byte
ÜÜN R
>
ÜÜR S
b
ÜÜT U
)
ÜÜU V
{
áá 
if
àà 

(
àà 
a
àà 
.
àà 
Length
àà 
!=
àà 
b
àà 
.
àà 
Length
àà  
)
àà  !
{
ââ 	
return
ää 
false
ää 
;
ää 
}
ãã 	
int
çç 
result
çç 
=
çç 
$num
çç 
;
çç 
for
éé 
(
éé 
int
éé 
i
éé 
=
éé 
$num
éé 
;
éé 
i
éé 
<
éé 
a
éé 
.
éé 
Length
éé $
;
éé$ %
i
éé& '
++
éé' )
)
éé) *
{
èè 	
result
êê 
|=
êê 
a
êê 
[
êê 
i
êê 
]
êê 
^
êê 
b
êê 
[
êê 
i
êê  
]
êê  !
;
êê! "
}
ëë 	
return
ìì 
result
ìì 
==
ìì 
$num
ìì 
;
ìì 
}
îî 
}ïï ¢
i/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/Core/ChainStepType.cs
	namespace 	
Ecliptix
 
. 
Protocol 
. 
System "
." #
Core# '
;' (
internal 
enum	 
ChainStepType 
{ 
Sender 

,
 
Receiver 
} á
c/Users/oleksandrmelnychenko/RiderProjects/ecliptix-desktop/Ecliptix.Protocol.System/AssemblyInfo.cs
[ 
assembly 	
:	 

InternalsVisibleTo 
( 
$str -
)- .
]. /
[ 
assembly 	
:	 

InternalsVisibleTo 
( 
$str 5
)5 6
]6 7